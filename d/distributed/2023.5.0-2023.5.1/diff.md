# Comparing `tmp/distributed-2023.5.0.tar.gz` & `tmp/distributed-2023.5.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2023.5.0.tar", last modified: Fri May 12 15:53:52 2023, max compression
+gzip compressed data, was "distributed-2023.5.1.tar", last modified: Fri May 26 20:09:35 2023, max compression
```

## Comparing `distributed-2023.5.0.tar` & `distributed-2023.5.1.tar`

### file list

```diff
@@ -1,295 +1,295 @@
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.962293 distributed-2023.5.0/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      104 2019-09-09 13:11:44.000000 distributed-2023.5.0/AUTHORS.md
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1533 2022-08-02 08:55:18.000000 distributed-2023.5.0/LICENSE.txt
--rw-r--r--   0 jtomlinson   (502) staff       (20)      633 2023-05-12 15:12:44.000000 distributed-2023.5.0/MANIFEST.in
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2882 2023-05-12 15:53:52.961881 distributed-2023.5.0/PKG-INFO
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1801 2022-08-02 08:55:18.000000 distributed-2023.5.0/README.rst
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.962784 distributed-2023.5.0/distributed/
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3836 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5528 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1297 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/_signals.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1372 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/_stories.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      500 2023-05-12 15:53:52.962880 distributed-2023.5.0/distributed/_version.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    29277 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/active_memory_manager.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    10649 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/actor.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7347 2022-08-17 10:33:17.000000 distributed-2023.5.0/distributed/batched.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      121 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/bokeh.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5742 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/cfexecutor.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1947 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/chaos.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.703605 distributed-2023.5.0/distributed/cli/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2019-09-09 13:13:25.000000 distributed-2023.5.0/distributed/cli/__init__.py
--rwxr-xr-x   0 jtomlinson   (502) staff       (20)     7077 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/cli/dask_scheduler.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1269 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/cli/dask_spec.py
--rwxr-xr-x   0 jtomlinson   (502) staff       (20)     5468 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 jtomlinson   (502) staff       (20)    15948 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/cli/dask_worker.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1092 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/cli/utils.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)   201985 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/client.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    10985 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/cluster_dump.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6717 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/collections.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.724113 distributed-2023.5.0/distributed/comm/
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1285 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/comm/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8597 2022-08-17 10:33:17.000000 distributed-2023.5.0/distributed/comm/addressing.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    37224 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/comm/asyncio_tcp.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    13369 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/comm/core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    10321 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/comm/inproc.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2815 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/comm/registry.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    24495 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/comm/tcp.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    22962 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/comm/ucx.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4220 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/comm/utils.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    14868 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/comm/ws.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7959 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/compatibility.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7357 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/config.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    58993 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2146 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/counter.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.731410 distributed-2023.5.0/distributed/dashboard/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/dashboard/__init__.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.740536 distributed-2023.5.0/distributed/dashboard/components/
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1550 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/dashboard/components/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5818 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/dashboard/components/nvml.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7055 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/dashboard/components/rmm.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)   146950 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    19467 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/dashboard/components/shared.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    15424 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/dashboard/components/worker.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1786 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/dashboard/core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2313 2019-09-09 13:13:25.000000 distributed-2023.5.0/distributed/dashboard/export_tool.js
--rw-r--r--   0 jtomlinson   (502) staff       (20)      763 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/dashboard/export_tool.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5717 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.742124 distributed-2023.5.0/distributed/dashboard/templates/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/dashboard/templates/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      241 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      199 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/dashboard/theme.yaml
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1668 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/dashboard/utils.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      840 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/dashboard/worker.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.809759 distributed-2023.5.0/distributed/deploy/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      466 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/deploy/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6702 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/deploy/adaptive.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7802 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/deploy/adaptive_core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    21498 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/deploy/cluster.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    10434 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/deploy/local.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    15514 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/deploy/old_ssh.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    23732 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/deploy/spec.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    15265 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/deploy/ssh.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7656 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/deploy/subprocess.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      888 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/deploy/utils.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.826585 distributed-2023.5.0/distributed/diagnostics/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      221 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/diagnostics/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1302 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2190 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/diagnostics/eventstream.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4994 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6972 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    10781 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/diagnostics/nvml.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    28172 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/diagnostics/plugin.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    12565 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/diagnostics/progress.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6063 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    14665 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/diagnostics/progressbar.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1124 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/diagnostics/rmm.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5677 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/diagnostics/task_stream.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2434 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/diagnostics/websocket.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     9172 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/diskutils.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    46226 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/distributed-schema.yaml
--rw-r--r--   0 jtomlinson   (502) staff       (20)    14146 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/distributed.yaml
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8536 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/event.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      586 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/exceptions.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.837097 distributed-2023.5.0/distributed/http/
--rw-r--r--   0 jtomlinson   (502) staff       (20)       84 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      258 2022-08-02 08:32:00.000000 distributed-2023.5.0/distributed/http/health.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1480 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/http/prometheus.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4377 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/proxy.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2548 2022-08-02 15:50:17.000000 distributed-2023.5.0/distributed/http/routing.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.841936 distributed-2023.5.0/distributed/http/scheduler/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/scheduler/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2899 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/scheduler/api.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6926 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/scheduler/info.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2159 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/scheduler/json.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      625 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.847537 distributed-2023.5.0/distributed/http/scheduler/prometheus/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      291 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7049 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3514 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1617 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.849140 distributed-2023.5.0/distributed/http/static/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/static/__init__.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.855940 distributed-2023.5.0/distributed/http/static/css/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/static/css/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2260 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/http/static/css/base.css
--rw-r--r--   0 jtomlinson   (502) staff       (20)      250 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/static/css/gpu.css
--rw-r--r--   0 jtomlinson   (502) staff       (20)      840 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1012 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/static/css/status.css
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.864971 distributed-2023.5.0/distributed/http/static/images/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/static/images/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1607 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 jtomlinson   (502) staff       (20)      552 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 jtomlinson   (502) staff       (20)    15086 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/static/images/favicon.ico
--rw-r--r--   0 jtomlinson   (502) staff       (20)    11002 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 jtomlinson   (502) staff       (20)    18663 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/static/images/numpy.png
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1213 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/static/images/pandas.png
--rw-r--r--   0 jtomlinson   (502) staff       (20)   830916 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/static/images/python.png
--rw-r--r--   0 jtomlinson   (502) staff       (20)      667 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.871436 distributed-2023.5.0/distributed/http/static/js/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/static/js/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    17271 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/static/js/anime.min.js
--rw-r--r--   0 jtomlinson   (502) staff       (20)     9337 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3276 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 jtomlinson   (502) staff       (20)      223 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/statics.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.883706 distributed-2023.5.0/distributed/http/templates/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/templates/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2930 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/http/templates/base.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      388 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/call-stack.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1351 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/templates/exceptions.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      404 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/templates/gpu.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      276 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/json-index.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      116 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/logs.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      369 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/main.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)       95 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/simple.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      635 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/http/templates/status.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5672 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/templates/task.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1405 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/worker-table.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2024 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/templates/worker.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)      457 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/templates/workers.html
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1184 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/http/utils.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.884639 distributed-2023.5.0/distributed/http/worker/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2021-06-02 14:34:47.000000 distributed-2023.5.0/distributed/http/worker/__init__.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.886190 distributed-2023.5.0/distributed/http/worker/prometheus/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      288 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     9973 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5599 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/lock.py
--rwxr-xr-x   0 jtomlinson   (502) staff       (20)    12252 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/metrics.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8044 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/multi_lock.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    33721 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/nanny.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6710 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/node.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1449 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/objects.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7513 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/preloading.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    12887 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/process.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      931 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/proctitle.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    16141 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/profile.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.901586 distributed-2023.5.0/distributed/protocol/
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3363 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/protocol/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1336 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/arrow.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6671 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/protocol/compression.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5964 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/core.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1181 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/cuda.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2788 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/cupy.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      836 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/h5py.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1127 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/keras.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1466 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/netcdf4.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2139 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/numba.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6664 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/protocol/numpy.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3043 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/protocol/pickle.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1507 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/rmm.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      800 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/scipy.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    29121 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/protocol/serialize.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      955 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/protocol/sparse.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1993 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/torch.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6102 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/protocol/utils.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3733 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/publish.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    15652 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/pubsub.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2022-08-02 08:32:00.000000 distributed-2023.5.0/distributed/py.typed
--rw-r--r--   0 jtomlinson   (502) staff       (20)    10082 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/queues.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7620 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/recreate_tasks.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)   302091 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/scheduler.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    13825 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/security.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    20568 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/semaphore.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.910990 distributed-2023.5.0/distributed/shuffle/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      692 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/shuffle/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2948 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/shuffle/_arrow.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     9212 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/shuffle/_buffer.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2499 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/shuffle/_comms.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3550 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/shuffle/_disk.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2361 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/shuffle/_limiter.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    11854 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/shuffle/_merge.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5030 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/shuffle/_rechunk.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    12834 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/shuffle/_scheduler_extension.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8218 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/shuffle/_shuffle.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    33686 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/shuffle/_worker_extension.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)      607 2022-08-02 08:55:18.000000 distributed-2023.5.0/distributed/sizeof.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    13597 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/spill.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    19859 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/stealing.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1883 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/system.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8532 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/system_monitor.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7104 2022-08-02 08:55:19.000000 distributed-2023.5.0/distributed/threadpoolexecutor.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    55458 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/utils.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    13992 2023-03-16 13:18:33.000000 distributed-2023.5.0/distributed/utils_comm.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8050 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/utils_perf.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    80577 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/utils_test.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8463 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/variable.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5194 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/versions.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.912022 distributed-2023.5.0/distributed/widgets/
--rw-r--r--   0 jtomlinson   (502) staff       (20)      267 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/widgets/__init__.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.925695 distributed-2023.5.0/distributed/widgets/templates/
--rw-r--r--   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/widgets/templates/__init__.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2265 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1589 2022-08-02 08:27:54.000000 distributed-2023.5.0/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1270 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      518 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      544 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      234 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      636 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      168 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1290 2022-08-02 08:27:54.000000 distributed-2023.5.0/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      317 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6705 2022-11-28 16:53:03.000000 distributed-2023.5.0/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      407 2022-08-02 08:27:54.000000 distributed-2023.5.0/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      448 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      295 2022-08-02 08:25:26.000000 distributed-2023.5.0/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)      407 2022-08-02 08:32:00.000000 distributed-2023.5.0/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 jtomlinson   (502) staff       (20)   124811 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/worker.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2276 2023-02-09 17:00:24.000000 distributed-2023.5.0/distributed/worker_client.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)    21367 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/worker_memory.py
--rw-r--r--   0 jtomlinson   (502) staff       (20)   141533 2023-05-12 15:12:44.000000 distributed-2023.5.0/distributed/worker_state_machine.py
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.688453 distributed-2023.5.0/distributed.egg-info/
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2882 2023-05-12 15:53:52.000000 distributed-2023.5.0/distributed.egg-info/PKG-INFO
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8573 2023-05-12 15:53:52.000000 distributed-2023.5.0/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 jtomlinson   (502) staff       (20)        1 2023-05-12 15:53:52.000000 distributed-2023.5.0/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 jtomlinson   (502) staff       (20)      335 2023-05-12 15:53:52.000000 distributed-2023.5.0/distributed.egg-info/entry_points.txt
--rw-r--r--   0 jtomlinson   (502) staff       (20)        1 2023-05-12 15:53:51.000000 distributed-2023.5.0/distributed.egg-info/not-zip-safe
--rw-r--r--   0 jtomlinson   (502) staff       (20)      227 2023-05-12 15:53:52.000000 distributed-2023.5.0/distributed.egg-info/requires.txt
--rw-r--r--   0 jtomlinson   (502) staff       (20)       12 2023-05-12 15:53:52.000000 distributed-2023.5.0/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.587384 distributed-2023.5.0/docs/
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.960296 distributed-2023.5.0/docs/source/
--rw-r--r--   0 jtomlinson   (502) staff       (20)    11754 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/active_memory_manager.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8000 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/actors.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4113 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/api.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3519 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/asynchronous.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)   254647 2023-05-12 15:39:49.000000 distributed-2023.5.0/docs/source/changelog.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7084 2022-08-02 08:25:26.000000 distributed-2023.5.0/docs/source/client.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3770 2021-06-02 14:34:47.000000 distributed-2023.5.0/docs/source/communications.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7048 2022-08-02 08:32:00.000000 distributed-2023.5.0/docs/source/develop.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6823 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/diagnosing-performance.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3392 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/efficiency.rst
-drwxr-xr-x   0 jtomlinson   (502) staff       (20)        0 2023-05-12 15:53:52.960998 distributed-2023.5.0/docs/source/examples/
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8953 2022-08-02 08:55:19.000000 distributed-2023.5.0/docs/source/examples/word-count.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)       75 2019-09-09 13:13:25.000000 distributed-2023.5.0/docs/source/examples-overview.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4228 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/faq.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4613 2022-08-02 08:55:19.000000 distributed-2023.5.0/docs/source/foundations.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4016 2022-08-02 08:55:19.000000 distributed-2023.5.0/docs/source/http_services.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4423 2023-02-09 17:00:24.000000 distributed-2023.5.0/docs/source/index.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1182 2022-08-02 08:32:00.000000 distributed-2023.5.0/docs/source/install.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7293 2021-06-02 14:34:47.000000 distributed-2023.5.0/docs/source/journey.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6470 2023-05-12 15:12:44.000000 distributed-2023.5.0/docs/source/killed.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     1828 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/limitations.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6458 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/locality.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2807 2022-01-14 14:33:02.000000 distributed-2023.5.0/docs/source/logging.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6546 2019-09-18 12:29:39.000000 distributed-2023.5.0/docs/source/manage-computation.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8550 2022-08-02 08:55:19.000000 distributed-2023.5.0/docs/source/memory.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4100 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/plugins.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3265 2022-08-02 08:25:26.000000 distributed-2023.5.0/docs/source/priority.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     7481 2023-05-12 15:12:44.000000 distributed-2023.5.0/docs/source/prometheus.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)    11199 2022-08-02 08:55:19.000000 distributed-2023.5.0/docs/source/protocol.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3107 2019-09-09 13:13:25.000000 distributed-2023.5.0/docs/source/publish.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)      402 2023-05-12 15:12:44.000000 distributed-2023.5.0/docs/source/queues.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     2942 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/quickstart.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8773 2022-08-02 08:55:19.000000 distributed-2023.5.0/docs/source/related-work.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3418 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/resilience.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6049 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/resources.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)    16084 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/scheduling-policies.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)    16901 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/scheduling-state.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     6518 2021-06-02 14:34:47.000000 distributed-2023.5.0/docs/source/serialization.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     8343 2022-08-02 08:27:54.000000 distributed-2023.5.0/docs/source/task-launch.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     4190 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/tls.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     5557 2019-09-18 12:29:43.000000 distributed-2023.5.0/docs/source/work-stealing.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)    13489 2023-02-09 17:00:24.000000 distributed-2023.5.0/docs/source/worker-memory.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)    22542 2023-05-12 15:12:44.000000 distributed-2023.5.0/docs/source/worker-state.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     3467 2022-11-28 16:53:03.000000 distributed-2023.5.0/docs/source/worker.rst
--rw-r--r--   0 jtomlinson   (502) staff       (20)     9049 2023-05-12 15:29:23.000000 distributed-2023.5.0/pyproject.toml
--rw-r--r--   0 jtomlinson   (502) staff       (20)       38 2023-05-12 15:53:52.962408 distributed-2023.5.0/setup.cfg
--rw-r--r--   0 jtomlinson   (502) staff       (20)      171 2023-05-12 15:12:44.000000 distributed-2023.5.0/setup.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.757368 distributed-2023.5.1/
+-rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.5.1/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.5.1/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-04-26 17:04:39.000000 distributed-2023.5.1/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-05-26 20:09:35.756573 distributed-2023.5.1/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.5.1/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.758180 distributed-2023.5.1/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     4219 2023-05-24 16:57:27.000000 distributed-2023.5.1/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1399 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2023-05-26 20:09:35.758339 distributed-2023.5.1/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29243 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)    10564 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.560457 distributed-2023.5.1/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.5.1/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     1269 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   202329 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10960 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     6673 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.568374 distributed-2023.5.1/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    37224 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/comm/asyncio_tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    13369 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10321 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.5.1/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    24054 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    22962 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14868 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)     7416 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     7357 2023-04-26 17:04:43.000000 distributed-2023.5.1/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    59300 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.577285 distributed-2023.5.1/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.5.1/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.581170 distributed-2023.5.1/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7055 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   158511 2023-05-19 17:56:01.000000 distributed-2023.5.1/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1786 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.5.1/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5834 2023-05-19 17:56:01.000000 distributed-2023.5.1/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.582298 distributed-2023.5.1/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/dashboard/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.5.1/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1668 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.588305 distributed-2023.5.1/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    21248 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23732 2023-04-26 17:04:43.000000 distributed-2023.5.1/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     7656 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.597620 distributed-2023.5.1/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     4994 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     6972 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    28172 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    12565 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.5.1/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2434 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    46226 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    14146 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/event.py
+-rw-r--r--   0 james      (501) staff       (20)      586 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/exceptions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.601567 distributed-2023.5.1/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.604606 distributed-2023.5.1/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2899 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.606899 distributed-2023.5.1/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.607854 distributed-2023.5.1/distributed/http/static/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.613916 distributed-2023.5.1/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/css/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.5.1/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.624224 distributed-2023.5.1/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/images/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.630625 distributed-2023.5.1/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/js/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.645655 distributed-2023.5.1/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.5.1/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.5.1/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.646769 distributed-2023.5.1/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.647758 distributed-2023.5.1/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     9973 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    12252 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    33721 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.659565 distributed-2023.5.1/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3363 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6671 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2945 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3043 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    29121 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   302645 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.666310 distributed-2023.5.1/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      692 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2948 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9206 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2526 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)    11881 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     6012 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    12861 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_scheduler_extension.py
+-rw-r--r--   0 james      (501) staff       (20)     8209 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    34047 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_worker_extension.py
+-rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    13519 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19859 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.5.1/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8532 2023-04-28 16:00:56.000000 distributed-2023.5.1/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    55458 2023-04-26 17:04:43.000000 distributed-2023.5.1/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    80577 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.5.1/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5165 2023-05-19 17:56:01.000000 distributed-2023.5.1/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.668135 distributed-2023.5.1/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.680771 distributed-2023.5.1/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/widgets/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.5.1/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   124896 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2276 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21215 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   141499 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.556642 distributed-2023.5.1/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8573 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-05-26 20:09:33.000000 distributed-2023.5.1/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.491740 distributed-2023.5.1/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.753828 distributed-2023.5.1/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.5.1/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   256075 2023-05-26 19:56:59.000000 distributed-2023.5.1/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.5.1/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-05-26 15:20:04.000000 distributed-2023.5.1/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.755231 distributed-2023.5.1/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.5.1/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4423 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.5.1/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.5.1/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.5.1/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.5.1/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7481 2023-04-26 17:04:39.000000 distributed-2023.5.1/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.5.1/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.5.1/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)     8925 2023-05-26 19:52:47.000000 distributed-2023.5.1/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2023-05-26 20:09:35.757557 distributed-2023.5.1/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-04-26 17:04:39.000000 distributed-2023.5.1/setup.py
```

### Comparing `distributed-2023.5.0/LICENSE.txt` & `distributed-2023.5.1/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/MANIFEST.in` & `distributed-2023.5.1/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/PKG-INFO` & `distributed-2023.5.1/PKG-INFO`

 * *Files 5% similar despite different names*

```diff
@@ -1,30 +1,29 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.5.0
+Version: 2023.5.1
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
 Classifier: Intended Audience :: Science/Research
 Classifier: License :: OSI Approved :: BSD License
 Classifier: Operating System :: OS Independent
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3 :: Only
-Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
 Classifier: Topic :: Scientific/Engineering
 Classifier: Topic :: System :: Distributed Computing
-Requires-Python: >=3.8
+Requires-Python: >=3.9
 Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 
 Distributed
 ===========
```

### Comparing `distributed-2023.5.0/README.rst` & `distributed-2023.5.1/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/__init__.py` & `distributed-2023.5.1/distributed/__init__.py`

 * *Files 8% similar despite different names*

```diff
@@ -3,15 +3,23 @@
 # isort: off
 from distributed import config  # load distributed configuration first
 from distributed import widgets  # load distributed widgets second
 
 # isort: on
 
 import atexit
+import weakref
 
+# This finalizer registers an atexit handler that has to happen before
+# distributed registers its handlers, otherwise we observe hangs on
+# cluster shutdown when using the UCX comms backend. See
+# https://github.com/dask/distributed/issues/7726 for more discussion
+# of the problem and the search for long term solutions
+
+weakref.finalize(lambda: None, lambda: None)
 import dask
 from dask.config import config  # type: ignore
 
 from distributed._version import get_versions
 from distributed.actor import Actor, ActorFuture, BaseActorFuture
 from distributed.client import (
     Client,
```

### Comparing `distributed-2023.5.0/distributed/_concurrent_futures_thread.py` & `distributed-2023.5.1/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/_signals.py` & `distributed-2023.5.1/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/_stories.py` & `distributed-2023.5.1/distributed/_stories.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 from __future__ import annotations
 
-from typing import TYPE_CHECKING, Iterable
+from collections.abc import Iterable
+from typing import TYPE_CHECKING
 
 if TYPE_CHECKING:
     # Circular import
     from distributed.scheduler import Transition
 
 
 def scheduler_story(
```

### Comparing `distributed-2023.5.0/distributed/active_memory_manager.py` & `distributed-2023.5.1/distributed/active_memory_manager.py`

 * *Files 0% similar despite different names*

```diff
@@ -6,15 +6,15 @@
 """
 from __future__ import annotations
 
 import abc
 import logging
 from collections import defaultdict
 from collections.abc import Generator
-from typing import TYPE_CHECKING, Any, Literal, NamedTuple
+from typing import TYPE_CHECKING, Any, Literal, NamedTuple, Union
 
 import dask
 from dask.utils import parse_timedelta
 
 # Needed to avoid Sphinx WARNING: more than one target found for cross-reference 'TaskState' and 'WorkerState'"
 # https://github.com/agronholm/sphinx-autodoc-typehints#dealing-with-circular-imports
 from distributed import client
@@ -430,18 +430,17 @@
     candidates: set[scheduler_module.WorkerState] | None = None
 
 
 if TYPE_CHECKING:
     # TODO import from typing (requires Python >=3.10)
     from typing_extensions import TypeAlias
 
-# TODO remove quotes (requires Python >=3.9)
-SuggestionGenerator: TypeAlias = (
-    "Generator[Suggestion, scheduler_module.WorkerState | None, None]"
-)
+SuggestionGenerator: TypeAlias = Generator[
+    Suggestion, Union["scheduler_module.WorkerState", None], None
+]
 
 
 class ActiveMemoryManagerPolicy(abc.ABC):
     """Abstract parent class"""
 
     __slots__ = ("manager",)
```

### Comparing `distributed-2023.5.0/distributed/actor.py` & `distributed-2023.5.1/distributed/actor.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,32 +1,29 @@
 from __future__ import annotations
 
 import abc
 import asyncio
 import functools
 import sys
 import threading
+from collections.abc import Awaitable, Generator
 from dataclasses import dataclass
 from datetime import timedelta
 from typing import Generic, Literal, NoReturn, TypeVar
 
 from tornado.ioloop import IOLoop
 
 from distributed.client import Future
 from distributed.protocol import to_serialize
 from distributed.utils import iscoroutinefunction, sync, thread_state
 from distributed.utils_comm import WrappedKey
 from distributed.worker import get_client, get_worker
 
 _T = TypeVar("_T")
 
-if sys.version_info >= (3, 9):
-    from collections.abc import Awaitable, Generator
-else:
-    from typing import Awaitable, Generator
 
 if sys.version_info >= (3, 10):
     from asyncio import Event as _LateLoopEvent
 else:
     # In python 3.10 asyncio.Lock and other primitives no longer support
     # passing a loop kwarg to bind to a loop running in another thread
     # e.g. calling from Client(asynchronous=False). Instead the loop is bound
```

### Comparing `distributed-2023.5.0/distributed/batched.py` & `distributed-2023.5.1/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/cfexecutor.py` & `distributed-2023.5.1/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/chaos.py` & `distributed-2023.5.1/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/cli/dask_scheduler.py` & `distributed-2023.5.1/distributed/cli/dask_scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/cli/dask_spec.py` & `distributed-2023.5.1/distributed/cli/dask_spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/cli/dask_ssh.py` & `distributed-2023.5.1/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/cli/dask_worker.py` & `distributed-2023.5.1/distributed/cli/dask_worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/cli/utils.py` & `distributed-2023.5.1/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/client.py` & `distributed-2023.5.1/distributed/client.py`

 * *Files 0% similar despite different names*

```diff
@@ -12,24 +12,24 @@
 import sys
 import threading
 import traceback
 import uuid
 import warnings
 import weakref
 from collections import defaultdict
-from collections.abc import Collection, Iterator
+from collections.abc import Collection, Coroutine, Iterator, Sequence
 from concurrent.futures import ThreadPoolExecutor
 from concurrent.futures._base import DoneAndNotDoneFutures
 from contextlib import asynccontextmanager, contextmanager, suppress
 from contextvars import ContextVar
 from functools import partial
 from importlib.metadata import PackageNotFoundError, version
 from numbers import Number
 from queue import Queue as pyQueue
-from typing import Any, ClassVar, Coroutine, Literal, Sequence, TypedDict
+from typing import Any, ClassVar, Literal, TypedDict
 
 from packaging.version import parse as parse_version
 from tlz import first, groupby, keymap, merge, partition_all, valmap
 
 import dask
 from dask.base import collections_to_dsk, normalize_token, tokenize
 from dask.core import flatten
@@ -3009,52 +3009,53 @@
             "distributed.diagnostics.computations.ignore-modules"
         )
         if not isinstance(ignore_modules, list):
             raise TypeError(
                 "Ignored modules must be a list. Instead got "
                 f"({type(ignore_modules)}, {ignore_modules})"
             )
+        pattern: re.Pattern | None = None
         if stacklevel is None:
-            pattern: re.Pattern | None
             if ignore_modules:
                 pattern = re.compile("|".join([f"(?:{mod})" for mod in ignore_modules]))
-            else:
-                pattern = None
         else:
             # stacklevel 0 or less - shows dask internals which likely isn't helpful
             stacklevel = stacklevel if stacklevel > 0 else 1
 
         code: list[str] = []
         for i, (fr, _) in enumerate(traceback.walk_stack(sys._getframe().f_back), 1):
             if len(code) >= nframes:
                 break
-            if stacklevel is not None:
-                if i != stacklevel:
-                    continue
+            elif stacklevel is not None and i != stacklevel:
+                continue
             elif pattern is not None and (
                 pattern.match(fr.f_globals.get("__name__", ""))
                 or fr.f_code.co_name in ("<listcomp>", "<dictcomp>")
             ):
                 continue
             try:
                 code.append(inspect.getsource(fr))
             except OSError:
-                # Try to fine the source if we are in %%time or %%timeit magic.
-                if (
-                    fr.f_code.co_filename in {"<timed exec>", "<magic-timeit>"}
-                    and "IPython" in sys.modules
-                ):
+                try:
                     from IPython import get_ipython
 
                     ip = get_ipython()
                     if ip is not None:
                         # The current cell
                         code.append(ip.history_manager._i00)
+                except ImportError:
+                    pass  # No IPython
+
                 break
 
+            # Ignore IPython related wrapping functions to user code
+            if hasattr(fr.f_back, "f_globals"):
+                module_name = sys.modules[fr.f_back.f_globals["__name__"]].__name__  # type: ignore
+                if module_name.endswith("interactiveshell"):
+                    break
         return tuple(reversed(code))
 
     def _graph_to_futures(
         self,
         dsk,
         keys,
         workers=None,
@@ -5720,45 +5721,52 @@
     stacklevel: int, optional
         The code execution frame utilized for populating the Calling Code section
         of the report. Defaults to `1` which is the frame calling ``performance_report``
 
     mode: str, optional
         Mode parameter to pass to :func:`bokeh.io.output.output_file`. Defaults to ``None``.
 
+    storage_options: dict, optional
+         Any additional arguments to :func:`fsspec.open` when writing to a URL.
+
     Examples
     --------
     >>> with performance_report(filename="myfile.html", stacklevel=1):
     ...     x.compute()
-
-    $ python -m http.server
-    $ open myfile.html
     """
 
-    def __init__(self, filename="dask-report.html", stacklevel=1, mode=None):
+    def __init__(
+        self, filename="dask-report.html", stacklevel=1, mode=None, storage_options=None
+    ):
         self.filename = filename
         # stacklevel 0 or less - shows dask internals which likely isn't helpful
         self._stacklevel = stacklevel if stacklevel > 0 else 1
         self.mode = mode
+        self.storage_options = storage_options or {}
 
     async def __aenter__(self):
         self.start = time()
         self.last_count = await get_client().run_on_scheduler(
             lambda dask_scheduler: dask_scheduler.monitor.count
         )
         await get_client().get_task_stream(start=0, stop=0)  # ensure plugin
 
     async def __aexit__(self, exc_type, exc_value, traceback, code=None):
+        import fsspec
+
         client = get_client()
         if code is None:
             frames = client._get_computation_code(self._stacklevel + 1, nframes=1)
             code = frames[0] if frames else "<Code not available>"
         data = await client.scheduler.performance_report(
             start=self.start, last_count=self.last_count, code=code, mode=self.mode
         )
-        with open(self.filename, "w") as f:
+        with fsspec.open(
+            self.filename, mode="w", compression="infer", **self.storage_options
+        ) as f:
             f.write(data)
 
     def __enter__(self):
         get_client().sync(self.__aenter__)
 
     def __exit__(self, exc_type, exc_value, traceback):
         client = get_client()
```

### Comparing `distributed-2023.5.0/distributed/cluster_dump.py` & `distributed-2023.5.1/distributed/cluster_dump.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,21 +1,21 @@
 "Utilities for generating and analyzing cluster dumps"
 
 from __future__ import annotations
 
+import asyncio
 from collections import defaultdict
-from collections.abc import Mapping
+from collections.abc import Awaitable, Callable, Collection, Mapping
 from pathlib import Path
-from typing import IO, Any, Awaitable, Callable, Collection, Literal
+from typing import IO, Any, Literal
 
 import msgpack
 
 from distributed._stories import scheduler_story as _scheduler_story
 from distributed._stories import worker_story as _worker_story
-from distributed.compatibility import to_thread
 
 DEFAULT_CLUSTER_DUMP_FORMAT: Literal["msgpack" | "yaml"] = "msgpack"
 DEFAULT_CLUSTER_DUMP_EXCLUDE: Collection[str] = ("run_spec",)
 
 
 def _tuple_to_list(node):
     if isinstance(node, (list, tuple)):
@@ -63,15 +63,15 @@
     # heavy import. Do lazy import to reduce import time
     import fsspec
 
     with fsspec.open(url, mode, compression="infer", **storage_options) as f:
         state = await get_state()
         # Write from a thread so we don't block the event loop quite as badly
         # (the writer will still hold the GIL a lot though).
-        await to_thread(writer, state, f)
+        await asyncio.to_thread(writer, state, f)
 
 
 def load_cluster_dump(url: str, **kwargs: Any) -> dict:
     """Loads a cluster dump from a disk artefact
 
     Parameters
     ----------
```

### Comparing `distributed-2023.5.0/distributed/collections.py` & `distributed-2023.5.1/distributed/collections.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,35 +1,35 @@
 from __future__ import annotations
 
 import heapq
 import itertools
 import weakref
 from collections import OrderedDict, UserDict
-from collections.abc import Callable, Hashable, Iterator
-from typing import MutableSet  # TODO move to collections.abc (requires Python >=3.9)
+from collections.abc import Callable, Hashable, Iterator, MutableSet
 from typing import Any, TypeVar, cast
 
 T = TypeVar("T", bound=Hashable)
+K = TypeVar("K", bound=Hashable)
+V = TypeVar("V")
 
 
-# TODO change to UserDict[K, V] (requires Python >=3.9)
-class LRU(UserDict):
+class LRU(UserDict[K, V]):
     """Limited size mapping, evicting the least recently looked-up key when full"""
 
-    def __init__(self, maxsize: float):
+    def __init__(self, maxsize: float) -> None:
         super().__init__()
         self.data = OrderedDict()
         self.maxsize = maxsize
 
-    def __getitem__(self, key):
+    def __getitem__(self, key: K) -> V:
         value = super().__getitem__(key)
         cast(OrderedDict, self.data).move_to_end(key)
         return value
 
-    def __setitem__(self, key, value):
+    def __setitem__(self, key: K, value: V) -> None:
         if len(self) >= self.maxsize:
             cast(OrderedDict, self.data).popitem(last=False)
         super().__setitem__(key, value)
 
 
 class HeapSet(MutableSet[T]):
     """A set-like where the `pop` method returns the smallest item, as sorted by an
```

### Comparing `distributed-2023.5.0/distributed/comm/__init__.py` & `distributed-2023.5.1/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/addressing.py` & `distributed-2023.5.1/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/asyncio_tcp.py` & `distributed-2023.5.1/distributed/comm/asyncio_tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/core.py` & `distributed-2023.5.1/distributed/comm/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/inproc.py` & `distributed-2023.5.1/distributed/comm/inproc.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/registry.py` & `distributed-2023.5.1/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/tcp.py` & `distributed-2023.5.1/distributed/comm/tcp.py`

 * *Files 1% similar despite different names*

```diff
@@ -416,37 +416,30 @@
             )
 
 
 _NUMERIC_ONLY = socket.AI_NUMERICHOST | socket.AI_NUMERICSERV
 
 
 async def _getaddrinfo(host, port, *, family, type=socket.SOCK_STREAM):
-    # On Python3.8 we are observing problems, particularly on slow systems
-    # For additional info, see
-    # https://github.com/dask/distributed/pull/6847#issuecomment-1208179864
-    # https://github.com/dask/distributed/pull/6847
-    # https://github.com/dask/distributed/issues/6896
-    # https://github.com/dask/distributed/issues/6846
-    if sys.version_info >= (3, 9):
-        # If host and port are numeric, then getaddrinfo doesn't block and we
-        # can skip get_running_loop().getaddrinfo which is implemented by
-        # running in a ThreadPoolExecutor. So we try first with the
-        # _NUMERIC_ONLY flags set, and then only use the threadpool if that
-        # fails with EAI_NONAME:
-        try:
-            return socket.getaddrinfo(
-                host,
-                port,
-                family=family,
-                type=type,
-                flags=_NUMERIC_ONLY,
-            )
-        except socket.gaierror as e:
-            if e.errno != socket.EAI_NONAME:
-                raise
+    # If host and port are numeric, then getaddrinfo doesn't block and we
+    # can skip get_running_loop().getaddrinfo which is implemented by
+    # running in a ThreadPoolExecutor. So we try first with the
+    # _NUMERIC_ONLY flags set, and then only use the threadpool if that
+    # fails with EAI_NONAME:
+    try:
+        return socket.getaddrinfo(
+            host,
+            port,
+            family=family,
+            type=type,
+            flags=_NUMERIC_ONLY,
+        )
+    except socket.gaierror as e:
+        if e.errno != socket.EAI_NONAME:
+            raise
 
     # That failed; it's a real hostname. We better use a thread.
     return await asyncio.get_running_loop().getaddrinfo(
         host, port, family=family, type=socket.SOCK_STREAM
     )
```

### Comparing `distributed-2023.5.0/distributed/comm/ucx.py` & `distributed-2023.5.1/distributed/comm/ucx.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/utils.py` & `distributed-2023.5.1/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/comm/ws.py` & `distributed-2023.5.1/distributed/comm/ws.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/compatibility.py` & `distributed-2023.5.1/distributed/compatibility.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,71 +1,59 @@
 from __future__ import annotations
 
+import asyncio
 import logging
+import random
 import sys
+import warnings
 
 import tornado
 
+__all__ = ["logging_names", "PeriodicCallback", "to_thread", "randbytes"]
+
 logging_names: dict[str | int, int | str] = {}
 logging_names.update(logging._levelToName)  # type: ignore
 logging_names.update(logging._nameToLevel)  # type: ignore
 
 LINUX = sys.platform == "linux"
 MACOS = sys.platform == "darwin"
 WINDOWS = sys.platform == "win32"
 
 
-if sys.version_info >= (3, 9):
-    from asyncio import to_thread
-else:
-    import contextvars
-    import functools
-    from asyncio import events
-
-    async def to_thread(func, /, *args, **kwargs):
-        """Asynchronously run function *func* in a separate thread.
-        Any *args and **kwargs supplied for this function are directly passed
-        to *func*. Also, the current :class:`contextvars.Context` is propagated,
-        allowing context variables from the main thread to be accessed in the
-        separate thread.
-
-        Return a coroutine that can be awaited to get the eventual result of *func*.
-
-        backport from
-        https://github.com/python/cpython/blob/3f1ea163ea54513e00e0e9d5442fee1b639825cc/Lib/asyncio/threads.py#L12-L25
-        """
-        loop = events.get_running_loop()
-        ctx = contextvars.copy_context()
-        func_call = functools.partial(ctx.run, func, *args, **kwargs)
-        return await loop.run_in_executor(None, func_call)
-
-
-if sys.version_info >= (3, 9):
-    from random import randbytes
-else:
-    from random import getrandbits
-
-    def randbytes(size):
-        return getrandbits(size * 8).to_bytes(size, "little")
+def to_thread(*args, **kwargs):
+    warnings.warn(
+        "to_thread is deprecated and will be removed in a future release; use asyncio.to_thread instead.",
+        DeprecationWarning,
+        stacklevel=2,
+    )
+    return asyncio.to_thread(*args, **kwargs)
+
+
+def randbytes(*args, **kwargs):
+    warnings.warn(
+        "randbytes is deprecated and will be removed in a future release; use random.randbytes instead.",
+        DeprecationWarning,
+        stacklevel=2,
+    )
+    return random.randbytes(*args, **kwargs)
 
 
 if tornado.version_info >= (6, 2, 0, 0):
     from tornado.ioloop import PeriodicCallback
 else:
     # Backport from https://github.com/tornadoweb/tornado/blob/a4f08a31a348445094d1efa17880ed5472db9f7d/tornado/ioloop.py#L838-L962
     # License https://github.com/tornadoweb/tornado/blob/v6.2.0/LICENSE
     # Includes minor modifications to source code to pass linting
 
     # This backport ensures that async callbacks are not overlapping if a run
     # takes longer than the interval
     import datetime
     import math
-    import random
+    from collections.abc import Awaitable, Callable
     from inspect import isawaitable
-    from typing import Awaitable, Callable
 
     from tornado.ioloop import IOLoop
     from tornado.log import app_log
 
     class PeriodicCallback:  # type: ignore[no-redef]
         """Schedules the given callback to be called periodically.
```

### Comparing `distributed-2023.5.0/distributed/config.py` & `distributed-2023.5.1/distributed/config.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/core.py` & `distributed-2023.5.1/distributed/core.py`

 * *Files 1% similar despite different names*

```diff
@@ -60,15 +60,15 @@
 
     P = ParamSpec("P")
     R = TypeVar("R")
     T = TypeVar("T")
     Coro = Coroutine[Any, Any, T]
 
 
-cache_loads = LRU(maxsize=100)
+cache_loads: LRU[bytes, Callable[..., Any]] = LRU(maxsize=100)
 
 
 def loads_function(bytes_object):
     """Load a function from bytes, cache bytes"""
     if len(bytes_object) < 100000:
         try:
             result = cache_loads[bytes_object]
@@ -368,16 +368,18 @@
                 self._workdir = None
                 self.local_directory = self._workspace.base_dir
             else:
                 name = type(self).__name__.lower()
                 self._workdir = self._workspace.new_work_dir(prefix=f"{name}-")
                 self.local_directory = self._workdir.dir_path
 
+        self._updated_sys_path = False
         if self.local_directory not in sys.path:
             sys.path.insert(0, self.local_directory)
+            self._updated_sys_path = True
 
         if io_loop is not None:
             warnings.warn(
                 "The io_loop kwarg to Server is ignored and will be deprecated",
                 DeprecationWarning,
                 stacklevel=2,
             )
@@ -1039,14 +1041,18 @@
                     await asyncio.gather(*_stops)
 
             # TODO: Deal with exceptions
             await self._ongoing_background_tasks.stop()
 
             await self.rpc.close()
             await asyncio.gather(*[comm.close() for comm in list(self._comms)])
+
+            # Remove scratch directory from global sys.path
+            if self._updated_sys_path and sys.path[0] == self.local_directory:
+                sys.path.remove(self.local_directory)
         finally:
             self._event_finished.set()
 
     def digest_metric(self, name: Hashable, value: float) -> None:
         # Granular data (requires crick)
         if self.digests is not None:
             self.digests[name].add(value)
```

### Comparing `distributed-2023.5.0/distributed/counter.py` & `distributed-2023.5.1/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/components/__init__.py` & `distributed-2023.5.1/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/components/nvml.py` & `distributed-2023.5.1/distributed/dashboard/components/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/components/rmm.py` & `distributed-2023.5.1/distributed/dashboard/components/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/components/scheduler.py` & `distributed-2023.5.1/distributed/dashboard/components/scheduler.py`

 * *Files 7% similar despite different names*

```diff
@@ -6,9180 +6,9902 @@
 00000050: 6d70 6f72 7420 6f73 0a66 726f 6d20 636f  mport os.from co
 00000060: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
 00000070: 204f 7264 6572 6564 4469 6374 2c20 6465   OrderedDict, de
 00000080: 6661 756c 7464 6963 740a 6672 6f6d 2063  faultdict.from c
 00000090: 6f6c 6c65 6374 696f 6e73 2e61 6263 2069  ollections.abc i
 000000a0: 6d70 6f72 7420 4974 6572 6162 6c65 0a66  mport Iterable.f
 000000b0: 726f 6d20 6461 7465 7469 6d65 2069 6d70  rom datetime imp
-000000c0: 6f72 7420 6461 7465 7469 6d65 0a66 726f  ort datetime.fro
-000000d0: 6d20 6e75 6d62 6572 7320 696d 706f 7274  m numbers import
-000000e0: 204e 756d 6265 720a 6672 6f6d 2074 7970   Number.from typ
-000000f0: 696e 6720 696d 706f 7274 2041 6e79 2c20  ing import Any, 
-00000100: 5479 7065 5661 720a 0a69 6d70 6f72 7420  TypeVar..import 
-00000110: 6e75 6d70 7920 6173 206e 700a 6672 6f6d  numpy as np.from
-00000120: 2062 6f6b 6568 2e63 6f72 652e 7072 6f70   bokeh.core.prop
-00000130: 6572 7469 6573 2069 6d70 6f72 7420 7661  erties import va
-00000140: 6c75 652c 2077 6974 686f 7574 5f70 726f  lue, without_pro
-00000150: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-00000160: 0a66 726f 6d20 626f 6b65 682e 696f 2069  .from bokeh.io i
-00000170: 6d70 6f72 7420 6375 7264 6f63 0a66 726f  mport curdoc.fro
-00000180: 6d20 626f 6b65 682e 6c61 796f 7574 7320  m bokeh.layouts 
-00000190: 696d 706f 7274 2063 6f6c 756d 6e2c 2072  import column, r
-000001a0: 6f77 0a66 726f 6d20 626f 6b65 682e 6d6f  ow.from bokeh.mo
-000001b0: 6465 6c73 2069 6d70 6f72 7420 280a 2020  dels import (.  
-000001c0: 2020 4164 6170 7469 7665 5469 636b 6572    AdaptiveTicker
-000001d0: 2c0a 2020 2020 4172 726f 772c 0a20 2020  ,.    Arrow,.   
-000001e0: 2042 6173 6963 5469 636b 6572 2c0a 2020   BasicTicker,.  
-000001f0: 2020 426f 7853 656c 6563 7454 6f6f 6c2c    BoxSelectTool,
-00000200: 0a20 2020 2042 6f78 5a6f 6f6d 546f 6f6c  .    BoxZoomTool
-00000210: 2c0a 2020 2020 4344 5356 6965 772c 0a20  ,.    CDSView,. 
-00000220: 2020 2043 6f6c 6f72 4261 722c 0a20 2020     ColorBar,.   
-00000230: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
-00000240: 652c 0a20 2020 2043 7573 746f 6d4a 5348  e,.    CustomJSH
-00000250: 6f76 6572 2c0a 2020 2020 4461 7461 5261  over,.    DataRa
-00000260: 6e67 6531 642c 0a20 2020 2046 6163 746f  nge1d,.    Facto
-00000270: 7252 616e 6765 2c0a 2020 2020 4772 6f75  rRange,.    Grou
-00000280: 7046 696c 7465 722c 0a20 2020 2048 656c  pFilter,.    Hel
-00000290: 7054 6f6f 6c2c 0a20 2020 2048 6f76 6572  pTool,.    Hover
-000002a0: 546f 6f6c 2c0a 2020 2020 4854 4d4c 5465  Tool,.    HTMLTe
-000002b0: 6d70 6c61 7465 466f 726d 6174 7465 722c  mplateFormatter,
-000002c0: 0a20 2020 204e 756d 6265 7246 6f72 6d61  .    NumberForma
-000002d0: 7474 6572 2c0a 2020 2020 4e75 6d65 7261  tter,.    Numera
-000002e0: 6c54 6963 6b46 6f72 6d61 7474 6572 2c0a  lTickFormatter,.
-000002f0: 2020 2020 4f70 656e 5552 4c2c 0a20 2020      OpenURL,.   
-00000300: 2050 616e 546f 6f6c 2c0a 2020 2020 5261   PanTool,.    Ra
-00000310: 6e67 6531 642c 0a20 2020 2052 6573 6574  nge1d,.    Reset
-00000320: 546f 6f6c 2c0a 2020 2020 5461 6273 2c0a  Tool,.    Tabs,.
-00000330: 2020 2020 5461 7054 6f6f 6c2c 0a20 2020      TapTool,.   
-00000340: 2054 6974 6c65 2c0a 2020 2020 5665 6548   Title,.    VeeH
-00000350: 6561 642c 0a20 2020 2057 6865 656c 5a6f  ead,.    WheelZo
-00000360: 6f6d 546f 6f6c 2c0a 290a 6672 6f6d 2062  omTool,.).from b
-00000370: 6f6b 6568 2e6d 6f64 656c 732e 7769 6467  okeh.models.widg
-00000380: 6574 7320 696d 706f 7274 2044 6174 6154  ets import DataT
-00000390: 6162 6c65 2c20 5461 626c 6543 6f6c 756d  able, TableColum
-000003a0: 6e0a 6672 6f6d 2062 6f6b 6568 2e6d 6f64  n.from bokeh.mod
-000003b0: 656c 732e 7769 6467 6574 732e 6d61 726b  els.widgets.mark
-000003c0: 7570 7320 696d 706f 7274 2044 6976 0a66  ups import Div.f
-000003d0: 726f 6d20 626f 6b65 682e 7061 6c65 7474  rom bokeh.palett
-000003e0: 6573 2069 6d70 6f72 7420 5669 7269 6469  es import Viridi
-000003f0: 7331 310a 6672 6f6d 2062 6f6b 6568 2e70  s11.from bokeh.p
-00000400: 6c6f 7474 696e 6720 696d 706f 7274 2066  lotting import f
-00000410: 6967 7572 650a 6672 6f6d 2062 6f6b 6568  igure.from bokeh
-00000420: 2e74 6865 6d65 7320 696d 706f 7274 2054  .themes import T
-00000430: 6865 6d65 0a66 726f 6d20 626f 6b65 682e  heme.from bokeh.
-00000440: 7472 616e 7366 6f72 6d20 696d 706f 7274  transform import
-00000450: 2063 756d 7375 6d2c 2066 6163 746f 725f   cumsum, factor_
-00000460: 636d 6170 2c20 6c69 6e65 6172 5f63 6d61  cmap, linear_cma
-00000470: 702c 2073 7461 636b 0a66 726f 6d20 6a69  p, stack.from ji
-00000480: 6e6a 6132 2069 6d70 6f72 7420 456e 7669  nja2 import Envi
-00000490: 726f 6e6d 656e 742c 2046 696c 6553 7973  ronment, FileSys
-000004a0: 7465 6d4c 6f61 6465 720a 6672 6f6d 2074  temLoader.from t
-000004b0: 6c7a 2069 6d70 6f72 7420 6375 7272 792c  lz import curry,
-000004c0: 2070 6970 652c 2076 616c 6d61 700a 6672   pipe, valmap.fr
-000004d0: 6f6d 2074 6c7a 2e63 7572 7269 6564 2069  om tlz.curried i
-000004e0: 6d70 6f72 7420 636f 6e63 6174 2c20 6772  mport concat, gr
-000004f0: 6f75 7062 792c 206d 6170 0a66 726f 6d20  oupby, map.from 
-00000500: 746f 726e 6164 6f20 696d 706f 7274 2065  tornado import e
-00000510: 7363 6170 650a 0a69 6d70 6f72 7420 6461  scape..import da
-00000520: 736b 0a66 726f 6d20 6461 736b 2069 6d70  sk.from dask imp
-00000530: 6f72 7420 636f 6e66 6967 0a66 726f 6d20  ort config.from 
-00000540: 6461 736b 2e75 7469 6c73 2069 6d70 6f72  dask.utils impor
-00000550: 7420 280a 2020 2020 666f 726d 6174 5f62  t (.    format_b
-00000560: 7974 6573 2c0a 2020 2020 666f 726d 6174  ytes,.    format
-00000570: 5f74 696d 652c 0a20 2020 2066 756e 636e  _time,.    funcn
-00000580: 616d 652c 0a20 2020 206b 6579 5f73 706c  ame,.    key_spl
-00000590: 6974 2c0a 2020 2020 7061 7273 655f 6279  it,.    parse_by
-000005a0: 7465 732c 0a20 2020 2070 6172 7365 5f74  tes,.    parse_t
-000005b0: 696d 6564 656c 7461 2c0a 290a 0a66 726f  imedelta,.)..fro
-000005c0: 6d20 6469 7374 7269 6275 7465 642e 636f  m distributed.co
-000005d0: 7265 2069 6d70 6f72 7420 5374 6174 7573  re import Status
-000005e0: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-000005f0: 642e 6461 7368 626f 6172 642e 636f 6d70  d.dashboard.comp
-00000600: 6f6e 656e 7473 2069 6d70 6f72 7420 6164  onents import ad
-00000610: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
-00000620: 6163 6b0a 6672 6f6d 2064 6973 7472 6962  ack.from distrib
-00000630: 7574 6564 2e64 6173 6862 6f61 7264 2e63  uted.dashboard.c
-00000640: 6f6d 706f 6e65 6e74 732e 7368 6172 6564  omponents.shared
-00000650: 2069 6d70 6f72 7420 280a 2020 2020 4461   import (.    Da
-00000660: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-00000670: 2c0a 2020 2020 5072 6f66 696c 6553 6572  ,.    ProfileSer
-00000680: 7665 722c 0a20 2020 2050 726f 6669 6c65  ver,.    Profile
-00000690: 5469 6d65 506c 6f74 2c0a 2020 2020 5379  TimePlot,.    Sy
-000006a0: 7374 656d 4d6f 6e69 746f 722c 0a29 0a66  stemMonitor,.).f
-000006b0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000006c0: 6461 7368 626f 6172 642e 636f 7265 2069  dashboard.core i
-000006d0: 6d70 6f72 7420 5461 6250 616e 656c 0a66  mport TabPanel.f
-000006e0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000006f0: 6461 7368 626f 6172 642e 7574 696c 7320  dashboard.utils 
-00000700: 696d 706f 7274 2028 0a20 2020 205f 4441  import (.    _DA
-00000710: 5441 5441 424c 455f 5354 594c 4553 4845  TATABLE_STYLESHE
-00000720: 4554 535f 4b57 4152 4753 2c0a 2020 2020  ETS_KWARGS,.    
-00000730: 424f 4b45 485f 5645 5253 494f 4e2c 0a20  BOKEH_VERSION,. 
-00000740: 2020 2050 524f 4649 4c49 4e47 2c0a 2020     PROFILING,.  
-00000750: 2020 7472 616e 7370 6f73 652c 0a20 2020    transpose,.   
-00000760: 2075 7064 6174 652c 0a29 0a66 726f 6d20   update,.).from 
-00000770: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
-00000780: 6e6f 7374 6963 732e 6772 6170 685f 6c61  nostics.graph_la
-00000790: 796f 7574 2069 6d70 6f72 7420 4772 6170  yout import Grap
-000007a0: 684c 6179 6f75 740a 6672 6f6d 2064 6973  hLayout.from dis
-000007b0: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
-000007c0: 7469 6373 2e70 726f 6772 6573 7320 696d  tics.progress im
-000007d0: 706f 7274 2047 726f 7570 5469 6d69 6e67  port GroupTiming
-000007e0: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-000007f0: 642e 6469 6167 6e6f 7374 6963 732e 7072  d.diagnostics.pr
-00000800: 6f67 7265 7373 5f73 7472 6561 6d20 696d  ogress_stream im
-00000810: 706f 7274 2063 6f6c 6f72 5f6f 662c 2070  port color_of, p
-00000820: 726f 6772 6573 735f 7175 6164 730a 6672  rogress_quads.fr
-00000830: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
-00000840: 6961 676e 6f73 7469 6373 2e74 6173 6b5f  iagnostics.task_
-00000850: 7374 7265 616d 2069 6d70 6f72 7420 5461  stream import Ta
-00000860: 736b 5374 7265 616d 506c 7567 696e 0a66  skStreamPlugin.f
-00000870: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00000880: 6469 6167 6e6f 7374 6963 732e 7461 736b  diagnostics.task
-00000890: 5f73 7472 6561 6d20 696d 706f 7274 2063  _stream import c
-000008a0: 6f6c 6f72 5f6f 6620 6173 2074 735f 636f  olor_of as ts_co
-000008b0: 6c6f 725f 6f66 0a66 726f 6d20 6469 7374  lor_of.from dist
-000008c0: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
-000008d0: 6963 732e 7461 736b 5f73 7472 6561 6d20  ics.task_stream 
-000008e0: 696d 706f 7274 2063 6f6c 6f72 7320 6173  import colors as
-000008f0: 2074 735f 636f 6c6f 725f 6c6f 6f6b 7570   ts_color_lookup
-00000900: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000910: 642e 6d65 7472 6963 7320 696d 706f 7274  d.metrics import
-00000920: 2074 696d 650a 6672 6f6d 2064 6973 7472   time.from distr
-00000930: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-00000940: 2069 6d70 6f72 7420 5363 6865 6475 6c65   import Schedule
-00000950: 720a 6672 6f6d 2064 6973 7472 6962 7574  r.from distribut
-00000960: 6564 2e75 7469 6c73 2069 6d70 6f72 7420  ed.utils import 
-00000970: 4c6f 672c 206c 6f67 5f65 7272 6f72 730a  Log, log_errors.
-00000980: 0a69 6620 6461 736b 2e63 6f6e 6669 672e  .if dask.config.
-00000990: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-000009a0: 2e64 6173 6862 6f61 7264 2e65 7870 6f72  .dashboard.expor
-000009b0: 742d 746f 6f6c 2229 3a0a 2020 2020 6672  t-tool"):.    fr
-000009c0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
-000009d0: 6173 6862 6f61 7264 2e65 7870 6f72 745f  ashboard.export_
-000009e0: 746f 6f6c 2069 6d70 6f72 7420 4578 706f  tool import Expo
-000009f0: 7274 546f 6f6c 0a65 6c73 653a 0a20 2020  rtTool.else:.   
-00000a00: 2045 7870 6f72 7454 6f6f 6c20 3d20 4e6f   ExportTool = No
-00000a10: 6e65 2020 2320 7479 7065 3a20 6967 6e6f  ne  # type: igno
-00000a20: 7265 0a0a 5420 3d20 5479 7065 5661 7228  re..T = TypeVar(
-00000a30: 2254 2229 0a0a 6c6f 6767 6572 203d 206c  "T")..logger = l
-00000a40: 6f67 6769 6e67 2e67 6574 4c6f 6767 6572  ogging.getLogger
-00000a50: 285f 5f6e 616d 655f 5f29 0a0a 656e 7620  (__name__)..env 
-00000a60: 3d20 456e 7669 726f 6e6d 656e 7428 0a20  = Environment(. 
-00000a70: 2020 206c 6f61 6465 723d 4669 6c65 5379     loader=FileSy
-00000a80: 7374 656d 4c6f 6164 6572 280a 2020 2020  stemLoader(.    
-00000a90: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
-00000aa0: 286f 732e 7061 7468 2e64 6972 6e61 6d65  (os.path.dirname
-00000ab0: 285f 5f66 696c 655f 5f29 2c20 222e 2e22  (__file__), ".."
-00000ac0: 2c20 222e 2e22 2c20 2268 7474 7022 2c20  , "..", "http", 
-00000ad0: 2274 656d 706c 6174 6573 2229 0a20 2020  "templates").   
-00000ae0: 2029 0a29 0a0a 424f 4b45 485f 5448 454d   ).)..BOKEH_THEM
-00000af0: 4520 3d20 5468 656d 6528 0a20 2020 2066  E = Theme(.    f
-00000b00: 696c 656e 616d 653d 6f73 2e70 6174 682e  ilename=os.path.
-00000b10: 6a6f 696e 286f 732e 7061 7468 2e64 6972  join(os.path.dir
-00000b20: 6e61 6d65 285f 5f66 696c 655f 5f29 2c20  name(__file__), 
-00000b30: 222e 2e22 2c20 2274 6865 6d65 2e79 616d  "..", "theme.yam
-00000b40: 6c22 290a 290a 5449 434b 535f 3130 3234  l").).TICKS_1024
-00000b50: 203d 207b 2262 6173 6522 3a20 3130 3234   = {"base": 1024
-00000b60: 2c20 226d 616e 7469 7373 6173 223a 205b  , "mantissas": [
-00000b70: 312c 2032 2c20 342c 2038 2c20 3136 2c20  1, 2, 4, 8, 16, 
-00000b80: 3332 2c20 3634 2c20 3132 382c 2032 3536  32, 64, 128, 256
-00000b90: 2c20 3531 325d 7d0a 584c 4142 454c 5f4f  , 512]}.XLABEL_O
-00000ba0: 5249 454e 5441 5449 4f4e 203d 202d 6d61  RIENTATION = -ma
-00000bb0: 7468 2e70 6920 2f20 3920 2023 2073 6c61  th.pi / 9  # sla
-00000bc0: 6e74 6564 2064 6f77 6e77 6172 6473 2032  nted downwards 2
-00000bd0: 3020 6465 6772 6565 730a 0a0a 6c6f 676f  0 degrees...logo
-00000be0: 735f 6469 6374 203d 207b 0a20 2020 2022  s_dict = {.    "
-00000bf0: 6e75 6d70 7922 3a20 2273 7461 7469 6373  numpy": "statics
-00000c00: 2f69 6d61 6765 732f 6e75 6d70 792e 706e  /images/numpy.pn
-00000c10: 6722 2c0a 2020 2020 2270 616e 6461 7322  g",.    "pandas"
-00000c20: 3a20 2273 7461 7469 6373 2f69 6d61 6765  : "statics/image
-00000c30: 732f 7061 6e64 6173 2e70 6e67 222c 0a20  s/pandas.png",. 
-00000c40: 2020 2022 6275 696c 7469 6e73 223a 2022     "builtins": "
-00000c50: 7374 6174 6963 732f 696d 6167 6573 2f70  statics/images/p
-00000c60: 7974 686f 6e2e 706e 6722 2c0a 7d0a 0a0a  ython.png",.}...
-00000c70: 636c 6173 7320 4f63 6375 7061 6e63 7928  class Occupancy(
-00000c80: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-00000c90: 6e74 293a 0a20 2020 2022 2222 4f63 6375  nt):.    """Occu
-00000ca0: 7061 6e63 7920 2869 6e20 7469 6d65 2920  pancy (in time) 
-00000cb0: 7065 7220 776f 726b 6572 2222 220a 0a20  per worker""".. 
-00000cc0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-00000cd0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00000ce0: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
-00000cf0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00000d00: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
-00000d10: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
-00000d20: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-00000d30: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-00000d40: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
-00000d50: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00000d60: 2020 2020 2022 6f63 6375 7061 6e63 7922       "occupancy"
-00000d70: 3a20 5b30 2c20 305d 2c0a 2020 2020 2020  : [0, 0],.      
-00000d80: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-00000d90: 7222 3a20 5b22 6122 2c20 2262 225d 2c0a  r": ["a", "b"],.
-00000da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000db0: 2278 223a 205b 302e 302c 2030 2e31 5d2c  "x": [0.0, 0.1],
-00000dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000dd0: 2022 7922 3a20 5b31 2c20 325d 2c0a 2020   "y": [1, 2],.  
-00000de0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00000df0: 7322 3a20 5b31 2c20 325d 2c0a 2020 2020  s": [1, 2],.    
-00000e00: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-00000e10: 6f72 223a 205b 2272 6564 222c 2022 626c  or": ["red", "bl
-00000e20: 7565 225d 2c0a 2020 2020 2020 2020 2020  ue"],.          
-00000e30: 2020 2020 2020 2265 7363 6170 6564 5f77        "escaped_w
-00000e40: 6f72 6b65 7222 3a20 5b22 6122 2c20 2262  orker": ["a", "b
-00000e50: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00000e60: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
-00000e70: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
-00000e80: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-00000e90: 2020 2020 2074 6974 6c65 3d22 4f63 6375       title="Occu
-00000ea0: 7061 6e63 7922 2c0a 2020 2020 2020 2020  pancy",.        
-00000eb0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
-00000ec0: 2020 2020 2020 2020 2020 746f 6f6c 6261            toolba
-00000ed0: 725f 6c6f 6361 7469 6f6e 3d22 6162 6f76  r_location="abov
-00000ee0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00000ef0: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
-00000f00: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
-00000f10: 2020 2020 6d69 6e5f 626f 7264 6572 5f62      min_border_b
-00000f20: 6f74 746f 6d3d 3530 2c0a 2020 2020 2020  ottom=50,.      
-00000f30: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-00000f40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00000f50: 2020 7265 6374 203d 2073 656c 662e 726f    rect = self.ro
-00000f60: 6f74 2e72 6563 7428 0a20 2020 2020 2020  ot.rect(.       
-00000f70: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00000f80: 2e73 6f75 7263 652c 2078 3d22 7822 2c20  .source, x="x", 
-00000f90: 7769 6474 683d 226d 7322 2c20 793d 2279  width="ms", y="y
-00000fa0: 222c 2068 6569 6768 743d 302e 392c 2063  ", height=0.9, c
-00000fb0: 6f6c 6f72 3d22 636f 6c6f 7222 0a20 2020  olor="color".   
-00000fc0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00000fd0: 6563 742e 6e6f 6e73 656c 6563 7469 6f6e  ect.nonselection
-00000fe0: 5f67 6c79 7068 203d 204e 6f6e 650a 0a20  _glyph = None.. 
-00000ff0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00001000: 2e78 6178 6973 2e6d 696e 6f72 5f74 6963  .xaxis.minor_tic
-00001010: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
-00001020: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00001030: 6f74 2e79 6178 6973 2e76 6973 6962 6c65  ot.yaxis.visible
-00001040: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00001050: 2073 656c 662e 726f 6f74 2e79 6772 6964   self.root.ygrid
-00001060: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-00001070: 0a20 2020 2020 2020 2023 2066 6967 2e78  .        # fig.x
-00001080: 6178 6973 5b30 5d2e 666f 726d 6174 7465  axis[0].formatte
-00001090: 7220 3d20 4e75 6d65 7261 6c54 6963 6b46  r = NumeralTickF
-000010a0: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-000010b0: 2730 2e30 7327 290a 2020 2020 2020 2020  '0.0s').        
-000010c0: 7365 6c66 2e72 6f6f 742e 785f 7261 6e67  self.root.x_rang
-000010d0: 652e 7374 6172 7420 3d20 300a 0a20 2020  e.start = 0..   
-000010e0: 2020 2020 2074 6170 203d 2054 6170 546f       tap = TapTo
-000010f0: 6f6c 2863 616c 6c62 6163 6b3d 4f70 656e  ol(callback=Open
-00001100: 5552 4c28 7572 6c3d 222e 2f69 6e66 6f2f  URL(url="./info/
-00001110: 776f 726b 6572 2f40 6573 6361 7065 645f  worker/@escaped_
-00001120: 776f 726b 6572 2e68 746d 6c22 2929 0a0a  worker.html"))..
-00001130: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
-00001140: 486f 7665 7254 6f6f 6c28 290a 2020 2020  HoverTool().    
-00001150: 2020 2020 686f 7665 722e 746f 6f6c 7469      hover.toolti
-00001160: 7073 203d 2022 4077 6f72 6b65 7220 3a20  ps = "@worker : 
-00001170: 406f 6363 7570 616e 6379 2073 2e22 0a20  @occupancy s.". 
-00001180: 2020 2020 2020 2068 6f76 6572 2e70 6f69         hover.poi
-00001190: 6e74 5f70 6f6c 6963 7920 3d20 2266 6f6c  nt_policy = "fol
-000011a0: 6c6f 775f 6d6f 7573 6522 0a20 2020 2020  low_mouse".     
-000011b0: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
-000011c0: 5f74 6f6f 6c73 2868 6f76 6572 2c20 7461  _tools(hover, ta
-000011d0: 7029 0a0a 2020 2020 4077 6974 686f 7574  p)..    @without
-000011e0: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
-000011f0: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
-00001200: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
-00001210: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
-00001220: 2020 2077 6f72 6b65 7273 203d 2073 656c     workers = sel
-00001230: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-00001240: 6572 732e 7661 6c75 6573 2829 0a0a 2020  ers.values()..  
-00001250: 2020 2020 2020 7920 3d20 6c69 7374 2872        y = list(r
-00001260: 616e 6765 286c 656e 2877 6f72 6b65 7273  ange(len(workers
-00001270: 2929 290a 2020 2020 2020 2020 6f63 6375  ))).        occu
-00001280: 7061 6e63 7920 3d20 5b77 732e 6f63 6375  pancy = [ws.occu
-00001290: 7061 6e63 7920 666f 7220 7773 2069 6e20  pancy for ws in 
-000012a0: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
-000012b0: 206d 7320 3d20 5b6f 6363 202a 2031 3030   ms = [occ * 100
-000012c0: 3020 666f 7220 6f63 6320 696e 206f 6363  0 for occ in occ
-000012d0: 7570 616e 6379 5d0a 2020 2020 2020 2020  upancy].        
-000012e0: 7820 3d20 5b6f 6363 202f 2035 3030 2066  x = [occ / 500 f
-000012f0: 6f72 206f 6363 2069 6e20 6f63 6375 7061  or occ in occupa
-00001300: 6e63 795d 0a20 2020 2020 2020 2074 6f74  ncy].        tot
-00001310: 616c 203d 2073 756d 286f 6363 7570 616e  al = sum(occupan
-00001320: 6379 290a 2020 2020 2020 2020 636f 6c6f  cy).        colo
-00001330: 7220 3d20 5b5d 0a20 2020 2020 2020 2066  r = [].        f
-00001340: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
-00001350: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00001360: 2077 7320 696e 2073 656c 662e 7363 6865   ws in self.sche
-00001370: 6475 6c65 722e 6964 6c65 3a0a 2020 2020  duler.idle:.    
-00001380: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00001390: 722e 6170 7065 6e64 2822 7265 6422 290a  r.append("red").
-000013a0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-000013b0: 2077 7320 696e 2073 656c 662e 7363 6865   ws in self.sche
-000013c0: 6475 6c65 722e 7361 7475 7261 7465 643a  duler.saturated:
-000013d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000013e0: 2063 6f6c 6f72 2e61 7070 656e 6428 2267   color.append("g
-000013f0: 7265 656e 2229 0a20 2020 2020 2020 2020  reen").         
-00001400: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000000c0: 6f72 7420 6461 7465 7469 6d65 2c20 7469  ort datetime, ti
+000000d0: 6d65 6465 6c74 610a 6672 6f6d 206e 756d  medelta.from num
+000000e0: 6265 7273 2069 6d70 6f72 7420 4e75 6d62  bers import Numb
+000000f0: 6572 0a66 726f 6d20 7479 7069 6e67 2069  er.from typing i
+00000100: 6d70 6f72 7420 416e 792c 2054 7970 6556  mport Any, TypeV
+00000110: 6172 0a0a 696d 706f 7274 206e 756d 7079  ar..import numpy
+00000120: 2061 7320 6e70 0a66 726f 6d20 626f 6b65   as np.from boke
+00000130: 682e 636f 7265 2e70 726f 7065 7274 6965  h.core.propertie
+00000140: 7320 696d 706f 7274 2076 616c 7565 2c20  s import value, 
+00000150: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+00000160: 5f76 616c 6964 6174 696f 6e0a 6672 6f6d  _validation.from
+00000170: 2062 6f6b 6568 2e69 6f20 696d 706f 7274   bokeh.io import
+00000180: 2063 7572 646f 630a 6672 6f6d 2062 6f6b   curdoc.from bok
+00000190: 6568 2e6c 6179 6f75 7473 2069 6d70 6f72  eh.layouts impor
+000001a0: 7420 636f 6c75 6d6e 2c20 726f 770a 6672  t column, row.fr
+000001b0: 6f6d 2062 6f6b 6568 2e6d 6f64 656c 7320  om bokeh.models 
+000001c0: 696d 706f 7274 2028 0a20 2020 2041 6461  import (.    Ada
+000001d0: 7074 6976 6554 6963 6b65 722c 0a20 2020  ptiveTicker,.   
+000001e0: 2041 7272 6f77 2c0a 2020 2020 4261 7369   Arrow,.    Basi
+000001f0: 6354 6963 6b65 722c 0a20 2020 2042 6f78  cTicker,.    Box
+00000200: 5365 6c65 6374 546f 6f6c 2c0a 2020 2020  SelectTool,.    
+00000210: 426f 785a 6f6f 6d54 6f6f 6c2c 0a20 2020  BoxZoomTool,.   
+00000220: 2043 4453 5669 6577 2c0a 2020 2020 436f   CDSView,.    Co
+00000230: 6c6f 7242 6172 2c0a 2020 2020 436f 6c75  lorBar,.    Colu
+00000240: 6d6e 4461 7461 536f 7572 6365 2c0a 2020  mnDataSource,.  
+00000250: 2020 4375 7374 6f6d 4a53 486f 7665 722c    CustomJSHover,
+00000260: 0a20 2020 2044 6174 6152 616e 6765 3164  .    DataRange1d
+00000270: 2c0a 2020 2020 4661 6374 6f72 5261 6e67  ,.    FactorRang
+00000280: 652c 0a20 2020 2047 726f 7570 4669 6c74  e,.    GroupFilt
+00000290: 6572 2c0a 2020 2020 4865 6c70 546f 6f6c  er,.    HelpTool
+000002a0: 2c0a 2020 2020 486f 7665 7254 6f6f 6c2c  ,.    HoverTool,
+000002b0: 0a20 2020 2048 544d 4c54 656d 706c 6174  .    HTMLTemplat
+000002c0: 6546 6f72 6d61 7474 6572 2c0a 2020 2020  eFormatter,.    
+000002d0: 4d75 6c74 6943 686f 6963 652c 0a20 2020  MultiChoice,.   
+000002e0: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
+000002f0: 2c0a 2020 2020 4e75 6d65 7261 6c54 6963  ,.    NumeralTic
+00000300: 6b46 6f72 6d61 7474 6572 2c0a 2020 2020  kFormatter,.    
+00000310: 4f70 656e 5552 4c2c 0a20 2020 2050 616e  OpenURL,.    Pan
+00000320: 546f 6f6c 2c0a 2020 2020 5261 6e67 6531  Tool,.    Range1
+00000330: 642c 0a20 2020 2052 6573 6574 546f 6f6c  d,.    ResetTool
+00000340: 2c0a 2020 2020 5365 6c65 6374 2c0a 2020  ,.    Select,.  
+00000350: 2020 5461 6273 2c0a 2020 2020 5461 7054    Tabs,.    TapT
+00000360: 6f6f 6c2c 0a20 2020 2054 6974 6c65 2c0a  ool,.    Title,.
+00000370: 2020 2020 5665 6548 6561 642c 0a20 2020      VeeHead,.   
+00000380: 2057 6865 656c 5a6f 6f6d 546f 6f6c 2c0a   WheelZoomTool,.
+00000390: 290a 6672 6f6d 2062 6f6b 6568 2e6d 6f64  ).from bokeh.mod
+000003a0: 656c 732e 7769 6467 6574 7320 696d 706f  els.widgets impo
+000003b0: 7274 2044 6174 6154 6162 6c65 2c20 5461  rt DataTable, Ta
+000003c0: 626c 6543 6f6c 756d 6e0a 6672 6f6d 2062  bleColumn.from b
+000003d0: 6f6b 6568 2e6d 6f64 656c 732e 7769 6467  okeh.models.widg
+000003e0: 6574 732e 6d61 726b 7570 7320 696d 706f  ets.markups impo
+000003f0: 7274 2044 6976 0a66 726f 6d20 626f 6b65  rt Div.from boke
+00000400: 682e 7061 6c65 7474 6573 2069 6d70 6f72  h.palettes impor
+00000410: 7420 5669 7269 6469 7331 312c 2073 6d61  t Viridis11, sma
+00000420: 6c6c 5f70 616c 6574 7465 730a 6672 6f6d  ll_palettes.from
+00000430: 2062 6f6b 6568 2e70 6c6f 7474 696e 6720   bokeh.plotting 
+00000440: 696d 706f 7274 2066 6967 7572 650a 6672  import figure.fr
+00000450: 6f6d 2062 6f6b 6568 2e74 6865 6d65 7320  om bokeh.themes 
+00000460: 696d 706f 7274 2054 6865 6d65 0a66 726f  import Theme.fro
+00000470: 6d20 626f 6b65 682e 7472 616e 7366 6f72  m bokeh.transfor
+00000480: 6d20 696d 706f 7274 2063 756d 7375 6d2c  m import cumsum,
+00000490: 2066 6163 746f 725f 636d 6170 2c20 6c69   factor_cmap, li
+000004a0: 6e65 6172 5f63 6d61 702c 2073 7461 636b  near_cmap, stack
+000004b0: 0a66 726f 6d20 6a69 6e6a 6132 2069 6d70  .from jinja2 imp
+000004c0: 6f72 7420 456e 7669 726f 6e6d 656e 742c  ort Environment,
+000004d0: 2046 696c 6553 7973 7465 6d4c 6f61 6465   FileSystemLoade
+000004e0: 720a 6672 6f6d 2074 6c7a 2069 6d70 6f72  r.from tlz impor
+000004f0: 7420 6375 7272 792c 2070 6970 652c 2076  t curry, pipe, v
+00000500: 616c 6d61 700a 6672 6f6d 2074 6c7a 2e63  almap.from tlz.c
+00000510: 7572 7269 6564 2069 6d70 6f72 7420 636f  urried import co
+00000520: 6e63 6174 2c20 6772 6f75 7062 792c 206d  ncat, groupby, m
+00000530: 6170 0a66 726f 6d20 746f 726e 6164 6f20  ap.from tornado 
+00000540: 696d 706f 7274 2065 7363 6170 650a 0a69  import escape..i
+00000550: 6d70 6f72 7420 6461 736b 0a66 726f 6d20  mport dask.from 
+00000560: 6461 736b 2069 6d70 6f72 7420 636f 6e66  dask import conf
+00000570: 6967 0a66 726f 6d20 6461 736b 2e75 7469  ig.from dask.uti
+00000580: 6c73 2069 6d70 6f72 7420 280a 2020 2020  ls import (.    
+00000590: 666f 726d 6174 5f62 7974 6573 2c0a 2020  format_bytes,.  
+000005a0: 2020 666f 726d 6174 5f74 696d 652c 0a20    format_time,. 
+000005b0: 2020 2066 756e 636e 616d 652c 0a20 2020     funcname,.   
+000005c0: 206b 6579 5f73 706c 6974 2c0a 2020 2020   key_split,.    
+000005d0: 7061 7273 655f 6279 7465 732c 0a20 2020  parse_bytes,.   
+000005e0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+000005f0: 2c0a 290a 0a66 726f 6d20 6469 7374 7269  ,.)..from distri
+00000600: 6275 7465 642e 636f 7265 2069 6d70 6f72  buted.core impor
+00000610: 7420 5374 6174 7573 0a66 726f 6d20 6469  t Status.from di
+00000620: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
+00000630: 6172 642e 636f 6d70 6f6e 656e 7473 2069  ard.components i
+00000640: 6d70 6f72 7420 6164 645f 7065 7269 6f64  mport add_period
+00000650: 6963 5f63 616c 6c62 6163 6b0a 6672 6f6d  ic_callback.from
+00000660: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00000670: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+00000680: 732e 7368 6172 6564 2069 6d70 6f72 7420  s.shared import 
+00000690: 280a 2020 2020 4461 7368 626f 6172 6443  (.    DashboardC
+000006a0: 6f6d 706f 6e65 6e74 2c0a 2020 2020 5072  omponent,.    Pr
+000006b0: 6f66 696c 6553 6572 7665 722c 0a20 2020  ofileServer,.   
+000006c0: 2050 726f 6669 6c65 5469 6d65 506c 6f74   ProfileTimePlot
+000006d0: 2c0a 2020 2020 5379 7374 656d 4d6f 6e69  ,.    SystemMoni
+000006e0: 746f 722c 0a29 0a66 726f 6d20 6469 7374  tor,.).from dist
+000006f0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
+00000700: 642e 636f 7265 2069 6d70 6f72 7420 5461  d.core import Ta
+00000710: 6250 616e 656c 0a66 726f 6d20 6469 7374  bPanel.from dist
+00000720: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
+00000730: 642e 7574 696c 7320 696d 706f 7274 2028  d.utils import (
+00000740: 0a20 2020 205f 4441 5441 5441 424c 455f  .    _DATATABLE_
+00000750: 5354 594c 4553 4845 4554 535f 4b57 4152  STYLESHEETS_KWAR
+00000760: 4753 2c0a 2020 2020 424f 4b45 485f 5645  GS,.    BOKEH_VE
+00000770: 5253 494f 4e2c 0a20 2020 2050 524f 4649  RSION,.    PROFI
+00000780: 4c49 4e47 2c0a 2020 2020 7472 616e 7370  LING,.    transp
+00000790: 6f73 652c 0a20 2020 2075 7064 6174 652c  ose,.    update,
+000007a0: 0a29 0a66 726f 6d20 6469 7374 7269 6275  .).from distribu
+000007b0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
+000007c0: 6772 6170 685f 6c61 796f 7574 2069 6d70  graph_layout imp
+000007d0: 6f72 7420 4772 6170 684c 6179 6f75 740a  ort GraphLayout.
+000007e0: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+000007f0: 2e64 6961 676e 6f73 7469 6373 2e70 726f  .diagnostics.pro
+00000800: 6772 6573 7320 696d 706f 7274 2047 726f  gress import Gro
+00000810: 7570 5469 6d69 6e67 0a66 726f 6d20 6469  upTiming.from di
+00000820: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
+00000830: 7374 6963 732e 7072 6f67 7265 7373 5f73  stics.progress_s
+00000840: 7472 6561 6d20 696d 706f 7274 2063 6f6c  tream import col
+00000850: 6f72 5f6f 662c 2070 726f 6772 6573 735f  or_of, progress_
+00000860: 7175 6164 730a 6672 6f6d 2064 6973 7472  quads.from distr
+00000870: 6962 7574 6564 2e64 6961 676e 6f73 7469  ibuted.diagnosti
+00000880: 6373 2e74 6173 6b5f 7374 7265 616d 2069  cs.task_stream i
+00000890: 6d70 6f72 7420 5461 736b 5374 7265 616d  mport TaskStream
+000008a0: 506c 7567 696e 0a66 726f 6d20 6469 7374  Plugin.from dist
+000008b0: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
+000008c0: 6963 732e 7461 736b 5f73 7472 6561 6d20  ics.task_stream 
+000008d0: 696d 706f 7274 2063 6f6c 6f72 5f6f 6620  import color_of 
+000008e0: 6173 2074 735f 636f 6c6f 725f 6f66 0a66  as ts_color_of.f
+000008f0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+00000900: 6469 6167 6e6f 7374 6963 732e 7461 736b  diagnostics.task
+00000910: 5f73 7472 6561 6d20 696d 706f 7274 2063  _stream import c
+00000920: 6f6c 6f72 7320 6173 2074 735f 636f 6c6f  olors as ts_colo
+00000930: 725f 6c6f 6f6b 7570 0a66 726f 6d20 6469  r_lookup.from di
+00000940: 7374 7269 6275 7465 642e 6d65 7472 6963  stributed.metric
+00000950: 7320 696d 706f 7274 2074 696d 650a 6672  s import time.fr
+00000960: 6f6d 2064 6973 7472 6962 7574 6564 2e73  om distributed.s
+00000970: 6368 6564 756c 6572 2069 6d70 6f72 7420  cheduler import 
+00000980: 5363 6865 6475 6c65 720a 6672 6f6d 2064  Scheduler.from d
+00000990: 6973 7472 6962 7574 6564 2e75 7469 6c73  istributed.utils
+000009a0: 2069 6d70 6f72 7420 4c6f 672c 206c 6f67   import Log, log
+000009b0: 5f65 7272 6f72 730a 0a69 6620 6461 736b  _errors..if dask
+000009c0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+000009d0: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
+000009e0: 7264 2e65 7870 6f72 742d 746f 6f6c 2229  rd.export-tool")
+000009f0: 3a0a 2020 2020 6672 6f6d 2064 6973 7472  :.    from distr
+00000a00: 6962 7574 6564 2e64 6173 6862 6f61 7264  ibuted.dashboard
+00000a10: 2e65 7870 6f72 745f 746f 6f6c 2069 6d70  .export_tool imp
+00000a20: 6f72 7420 4578 706f 7274 546f 6f6c 0a65  ort ExportTool.e
+00000a30: 6c73 653a 0a20 2020 2045 7870 6f72 7454  lse:.    ExportT
+00000a40: 6f6f 6c20 3d20 4e6f 6e65 2020 2320 7479  ool = None  # ty
+00000a50: 7065 3a20 6967 6e6f 7265 0a0a 5420 3d20  pe: ignore..T = 
+00000a60: 5479 7065 5661 7228 2254 2229 0a0a 6c6f  TypeVar("T")..lo
+00000a70: 6767 6572 203d 206c 6f67 6769 6e67 2e67  gger = logging.g
+00000a80: 6574 4c6f 6767 6572 285f 5f6e 616d 655f  etLogger(__name_
+00000a90: 5f29 0a0a 656e 7620 3d20 456e 7669 726f  _)..env = Enviro
+00000aa0: 6e6d 656e 7428 0a20 2020 206c 6f61 6465  nment(.    loade
+00000ab0: 723d 4669 6c65 5379 7374 656d 4c6f 6164  r=FileSystemLoad
+00000ac0: 6572 280a 2020 2020 2020 2020 6f73 2e70  er(.        os.p
+00000ad0: 6174 682e 6a6f 696e 286f 732e 7061 7468  ath.join(os.path
+00000ae0: 2e64 6972 6e61 6d65 285f 5f66 696c 655f  .dirname(__file_
+00000af0: 5f29 2c20 222e 2e22 2c20 222e 2e22 2c20  _), "..", "..", 
+00000b00: 2268 7474 7022 2c20 2274 656d 706c 6174  "http", "templat
+00000b10: 6573 2229 0a20 2020 2029 0a29 0a0a 424f  es").    ).)..BO
+00000b20: 4b45 485f 5448 454d 4520 3d20 5468 656d  KEH_THEME = Them
+00000b30: 6528 0a20 2020 2066 696c 656e 616d 653d  e(.    filename=
+00000b40: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
+00000b50: 7061 7468 2e64 6972 6e61 6d65 285f 5f66  path.dirname(__f
+00000b60: 696c 655f 5f29 2c20 222e 2e22 2c20 2274  ile__), "..", "t
+00000b70: 6865 6d65 2e79 616d 6c22 290a 290a 5449  heme.yaml").).TI
+00000b80: 434b 535f 3130 3234 203d 207b 2262 6173  CKS_1024 = {"bas
+00000b90: 6522 3a20 3130 3234 2c20 226d 616e 7469  e": 1024, "manti
+00000ba0: 7373 6173 223a 205b 312c 2032 2c20 342c  ssas": [1, 2, 4,
+00000bb0: 2038 2c20 3136 2c20 3332 2c20 3634 2c20   8, 16, 32, 64, 
+00000bc0: 3132 382c 2032 3536 2c20 3531 325d 7d0a  128, 256, 512]}.
+00000bd0: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
+00000be0: 4f4e 203d 202d 6d61 7468 2e70 6920 2f20  ON = -math.pi / 
+00000bf0: 3920 2023 2073 6c61 6e74 6564 2064 6f77  9  # slanted dow
+00000c00: 6e77 6172 6473 2032 3020 6465 6772 6565  nwards 20 degree
+00000c10: 730a 0a0a 6c6f 676f 735f 6469 6374 203d  s...logos_dict =
+00000c20: 207b 0a20 2020 2022 6e75 6d70 7922 3a20   {.    "numpy": 
+00000c30: 2273 7461 7469 6373 2f69 6d61 6765 732f  "statics/images/
+00000c40: 6e75 6d70 792e 706e 6722 2c0a 2020 2020  numpy.png",.    
+00000c50: 2270 616e 6461 7322 3a20 2273 7461 7469  "pandas": "stati
+00000c60: 6373 2f69 6d61 6765 732f 7061 6e64 6173  cs/images/pandas
+00000c70: 2e70 6e67 222c 0a20 2020 2022 6275 696c  .png",.    "buil
+00000c80: 7469 6e73 223a 2022 7374 6174 6963 732f  tins": "statics/
+00000c90: 696d 6167 6573 2f70 7974 686f 6e2e 706e  images/python.pn
+00000ca0: 6722 2c0a 7d0a 0a0a 636c 6173 7320 4f63  g",.}...class Oc
+00000cb0: 6375 7061 6e63 7928 4461 7368 626f 6172  cupancy(Dashboar
+00000cc0: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+00000cd0: 2022 2222 4f63 6375 7061 6e63 7920 2869   """Occupancy (i
+00000ce0: 6e20 7469 6d65 2920 7065 7220 776f 726b  n time) per work
+00000cf0: 6572 2222 220a 0a20 2020 2040 6c6f 675f  er"""..    @log_
+00000d00: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
+00000d10: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+00000d20: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
+00000d30: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+00000d40: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+00000d50: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+00000d60: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+00000d70: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
+00000d80: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00000d90: 2020 2020 2020 2020 2020 2020 2022 6f63               "oc
+00000da0: 6375 7061 6e63 7922 3a20 5b30 2c20 305d  cupancy": [0, 0]
+00000db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00000dc0: 2020 2277 6f72 6b65 7222 3a20 5b22 6122    "worker": ["a"
+00000dd0: 2c20 2262 225d 2c0a 2020 2020 2020 2020  , "b"],.        
+00000de0: 2020 2020 2020 2020 2278 223a 205b 302e          "x": [0.
+00000df0: 302c 2030 2e31 5d2c 0a20 2020 2020 2020  0, 0.1],.       
+00000e00: 2020 2020 2020 2020 2022 7922 3a20 5b31           "y": [1
+00000e10: 2c20 325d 2c0a 2020 2020 2020 2020 2020  , 2],.          
+00000e20: 2020 2020 2020 226d 7322 3a20 5b31 2c20        "ms": [1, 
+00000e30: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
+00000e40: 2020 2020 2263 6f6c 6f72 223a 205b 2272      "color": ["r
+00000e50: 6564 222c 2022 626c 7565 225d 2c0a 2020  ed", "blue"],.  
+00000e60: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+00000e70: 7363 6170 6564 5f77 6f72 6b65 7222 3a20  scaped_worker": 
+00000e80: 5b22 6122 2c20 2262 225d 2c0a 2020 2020  ["a", "b"],.    
+00000e90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00000ea0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00000eb0: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
+00000ec0: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00000ed0: 6c65 3d22 4f63 6375 7061 6e63 7922 2c0a  le="Occupancy",.
+00000ee0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00000ef0: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
+00000f00: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
+00000f10: 6f6e 3d22 6162 6f76 6522 2c0a 2020 2020  on="above",.    
+00000f20: 2020 2020 2020 2020 785f 6178 6973 5f74          x_axis_t
+00000f30: 7970 653d 2264 6174 6574 696d 6522 2c0a  ype="datetime",.
+00000f40: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+00000f50: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
+00000f60: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00000f70: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00000f80: 290a 2020 2020 2020 2020 7265 6374 203d  ).        rect =
+00000f90: 2073 656c 662e 726f 6f74 2e72 6563 7428   self.root.rect(
+00000fa0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00000fb0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+00000fc0: 2078 3d22 7822 2c20 7769 6474 683d 226d   x="x", width="m
+00000fd0: 7322 2c20 793d 2279 222c 2068 6569 6768  s", y="y", heigh
+00000fe0: 743d 302e 392c 2063 6f6c 6f72 3d22 636f  t=0.9, color="co
+00000ff0: 6c6f 7222 0a20 2020 2020 2020 2029 0a20  lor".        ). 
+00001000: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
+00001010: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
+00001020: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
+00001030: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
+00001040: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
+00001050: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
+00001060: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+00001070: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+00001080: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00001090: 6f74 2e79 6772 6964 2e76 6973 6962 6c65  ot.ygrid.visible
+000010a0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+000010b0: 2023 2066 6967 2e78 6178 6973 5b30 5d2e   # fig.xaxis[0].
+000010c0: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
+000010d0: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
+000010e0: 2866 6f72 6d61 743d 2730 2e30 7327 290a  (format='0.0s').
+000010f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00001100: 742e 785f 7261 6e67 652e 7374 6172 7420  t.x_range.start 
+00001110: 3d20 300a 0a20 2020 2020 2020 2074 6170  = 0..        tap
+00001120: 203d 2054 6170 546f 6f6c 2863 616c 6c62   = TapTool(callb
+00001130: 6163 6b3d 4f70 656e 5552 4c28 7572 6c3d  ack=OpenURL(url=
+00001140: 222e 2f69 6e66 6f2f 776f 726b 6572 2f40  "./info/worker/@
+00001150: 6573 6361 7065 645f 776f 726b 6572 2e68  escaped_worker.h
+00001160: 746d 6c22 2929 0a0a 2020 2020 2020 2020  tml"))..        
+00001170: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
+00001180: 6c28 290a 2020 2020 2020 2020 686f 7665  l().        hove
+00001190: 722e 746f 6f6c 7469 7073 203d 2022 4077  r.tooltips = "@w
+000011a0: 6f72 6b65 7220 3a20 406f 6363 7570 616e  orker : @occupan
+000011b0: 6379 2073 2e22 0a20 2020 2020 2020 2068  cy s.".        h
+000011c0: 6f76 6572 2e70 6f69 6e74 5f70 6f6c 6963  over.point_polic
+000011d0: 7920 3d20 2266 6f6c 6c6f 775f 6d6f 7573  y = "follow_mous
+000011e0: 6522 0a20 2020 2020 2020 2073 656c 662e  e".        self.
+000011f0: 726f 6f74 2e61 6464 5f74 6f6f 6c73 2868  root.add_tools(h
+00001200: 6f76 6572 2c20 7461 7029 0a0a 2020 2020  over, tap)..    
+00001210: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+00001220: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+00001230: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00001240: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+00001250: 293a 0a20 2020 2020 2020 2077 6f72 6b65  ):.        worke
+00001260: 7273 203d 2073 656c 662e 7363 6865 6475  rs = self.schedu
+00001270: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+00001280: 6573 2829 0a0a 2020 2020 2020 2020 7920  es()..        y 
+00001290: 3d20 6c69 7374 2872 616e 6765 286c 656e  = list(range(len
+000012a0: 2877 6f72 6b65 7273 2929 290a 2020 2020  (workers))).    
+000012b0: 2020 2020 6f63 6375 7061 6e63 7920 3d20      occupancy = 
+000012c0: 5b77 732e 6f63 6375 7061 6e63 7920 666f  [ws.occupancy fo
+000012d0: 7220 7773 2069 6e20 776f 726b 6572 735d  r ws in workers]
+000012e0: 0a20 2020 2020 2020 206d 7320 3d20 5b6f  .        ms = [o
+000012f0: 6363 202a 2031 3030 3020 666f 7220 6f63  cc * 1000 for oc
+00001300: 6320 696e 206f 6363 7570 616e 6379 5d0a  c in occupancy].
+00001310: 2020 2020 2020 2020 7820 3d20 5b6f 6363          x = [occ
+00001320: 202f 2035 3030 2066 6f72 206f 6363 2069   / 500 for occ i
+00001330: 6e20 6f63 6375 7061 6e63 795d 0a20 2020  n occupancy].   
+00001340: 2020 2020 2074 6f74 616c 203d 2073 756d       total = sum
+00001350: 286f 6363 7570 616e 6379 290a 2020 2020  (occupancy).    
+00001360: 2020 2020 636f 6c6f 7220 3d20 5b5d 0a20      color = []. 
+00001370: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+00001380: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
+00001390: 2020 2020 2020 6966 2077 7320 696e 2073        if ws in s
+000013a0: 656c 662e 7363 6865 6475 6c65 722e 6964  elf.scheduler.id
+000013b0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+000013c0: 2020 2020 636f 6c6f 722e 6170 7065 6e64      color.append
+000013d0: 2822 7265 6422 290a 2020 2020 2020 2020  ("red").        
+000013e0: 2020 2020 656c 6966 2077 7320 696e 2073      elif ws in s
+000013f0: 656c 662e 7363 6865 6475 6c65 722e 7361  elf.scheduler.sa
+00001400: 7475 7261 7465 643a 0a20 2020 2020 2020  turated:.       
 00001410: 2020 2020 2020 2020 2063 6f6c 6f72 2e61           color.a
-00001420: 7070 656e 6428 2262 6c75 6522 290a 0a20  ppend("blue").. 
-00001430: 2020 2020 2020 2069 6620 746f 7461 6c3a         if total:
-00001440: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001450: 662e 726f 6f74 2e74 6974 6c65 2e74 6578  f.root.title.tex
-00001460: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-00001470: 2020 2020 2020 6622 4f63 6375 7061 6e63        f"Occupanc
-00001480: 7920 2d2d 2074 6f74 616c 2074 696d 653a  y -- total time:
-00001490: 207b 666f 726d 6174 5f74 696d 6528 746f   {format_time(to
-000014a0: 7461 6c29 7d20 220a 2020 2020 2020 2020  tal)} ".        
-000014b0: 2020 2020 2020 2020 6622 7761 6c6c 2074          f"wall t
-000014c0: 696d 653a 207b 666f 726d 6174 5f74 696d  ime: {format_tim
-000014d0: 6528 746f 7461 6c20 2f20 7365 6c66 2e73  e(total / self.s
-000014e0: 6368 6564 756c 6572 2e74 6f74 616c 5f6e  cheduler.total_n
-000014f0: 7468 7265 6164 7329 7d22 0a20 2020 2020  threads)}".     
-00001500: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00001510: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00001520: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
-00001530: 6c65 2e74 6578 7420 3d20 224f 6363 7570  le.text = "Occup
-00001540: 616e 6379 220a 0a20 2020 2020 2020 2069  ancy"..        i
-00001550: 6620 6f63 6375 7061 6e63 793a 0a20 2020  f occupancy:.   
-00001560: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00001570: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00001580: 2020 2020 226f 6363 7570 616e 6379 223a      "occupancy":
-00001590: 206f 6363 7570 616e 6379 2c0a 2020 2020   occupancy,.    
-000015a0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-000015b0: 6b65 7222 3a20 5b77 732e 6164 6472 6573  ker": [ws.addres
-000015c0: 7320 666f 7220 7773 2069 6e20 776f 726b  s for ws in work
-000015d0: 6572 735d 2c0a 2020 2020 2020 2020 2020  ers],.          
-000015e0: 2020 2020 2020 226d 7322 3a20 6d73 2c0a        "ms": ms,.
-000015f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001600: 2263 6f6c 6f72 223a 2063 6f6c 6f72 2c0a  "color": color,.
-00001610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001620: 2265 7363 6170 6564 5f77 6f72 6b65 7222  "escaped_worker"
-00001630: 3a20 5b65 7363 6170 652e 7572 6c5f 6573  : [escape.url_es
-00001640: 6361 7065 2877 732e 6164 6472 6573 7329  cape(ws.address)
-00001650: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
-00001660: 7273 5d2c 0a20 2020 2020 2020 2020 2020  rs],.           
-00001670: 2020 2020 2022 7822 3a20 782c 0a20 2020       "x": x,.   
-00001680: 2020 2020 2020 2020 2020 2020 2022 7922               "y"
-00001690: 3a20 792c 0a20 2020 2020 2020 2020 2020  : y,.           
-000016a0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-000016b0: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
-000016c0: 6365 2c20 7265 7375 6c74 290a 0a0a 636c  ce, result)...cl
-000016d0: 6173 7320 5072 6f63 6573 7369 6e67 4869  ass ProcessingHi
-000016e0: 7374 6f67 7261 6d28 4461 7368 626f 6172  stogram(Dashboar
-000016f0: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-00001700: 2022 2222 486f 7720 6d61 6e79 2074 6173   """How many tas
-00001710: 6b73 2061 7265 206f 6e20 6561 6368 2077  ks are on each w
-00001720: 6f72 6b65 7222 2222 0a0a 2020 2020 406c  orker"""..    @l
-00001730: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-00001740: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00001750: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
-00001760: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-00001770: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
-00001780: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00001790: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-000017a0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-000017b0: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-000017c0: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
-000017d0: 2020 2020 7b22 6c65 6674 223a 205b 312c      {"left": [1,
-000017e0: 2032 5d2c 2022 7269 6768 7422 3a20 5b31   2], "right": [1
-000017f0: 302c 2031 305d 2c20 2274 6f70 223a 205b  0, 10], "top": [
-00001800: 302c 2030 5d7d 0a20 2020 2020 2020 2029  0, 0]}.        )
-00001810: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00001820: 6f6f 7420 3d20 6669 6775 7265 280a 2020  oot = figure(.  
-00001830: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-00001840: 2254 6173 6b73 2050 726f 6365 7373 696e  "Tasks Processin
-00001850: 6720 2863 6f75 6e74 2922 2c0a 2020 2020  g (count)",.    
-00001860: 2020 2020 2020 2020 6e61 6d65 3d22 7072          name="pr
-00001870: 6f63 6573 7369 6e67 222c 0a20 2020 2020  ocessing",.     
-00001880: 2020 2020 2020 2079 5f61 7869 735f 6c61         y_axis_la
-00001890: 6265 6c3d 2266 7265 7175 656e 6379 222c  bel="frequency",
-000018a0: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-000018b0: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
-000018c0: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-000018d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000018e0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-000018f0: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
-00001900: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-00001910: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
-00001920: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
-00001930: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-00001940: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
-00001950: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
-00001960: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00001970: 7175 6164 280a 2020 2020 2020 2020 2020  quad(.          
-00001980: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-00001990: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-000019a0: 2020 6c65 6674 3d22 6c65 6674 222c 0a20    left="left",. 
-000019b0: 2020 2020 2020 2020 2020 2072 6967 6874             right
-000019c0: 3d22 7269 6768 7422 2c0a 2020 2020 2020  ="right",.      
-000019d0: 2020 2020 2020 626f 7474 6f6d 3d30 2c0a        bottom=0,.
-000019e0: 2020 2020 2020 2020 2020 2020 746f 703d              top=
-000019f0: 2274 6f70 222c 0a20 2020 2020 2020 2020  "top",.         
-00001a00: 2020 2063 6f6c 6f72 3d22 6465 6570 736b     color="deepsk
-00001a10: 7962 6c75 6522 2c0a 2020 2020 2020 2020  yblue",.        
-00001a20: 2020 2020 6669 6c6c 5f61 6c70 6861 3d30      fill_alpha=0
-00001a30: 2e35 2c0a 2020 2020 2020 2020 290a 0a20  .5,.        ).. 
-00001a40: 2020 2040 7769 7468 6f75 745f 7072 6f70     @without_prop
-00001a50: 6572 7479 5f76 616c 6964 6174 696f 6e0a  erty_validation.
-00001a60: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
-00001a70: 656c 6629 3a0a 2020 2020 2020 2020 4c20  elf):.        L 
-00001a80: 3d20 5b6c 656e 2877 732e 7072 6f63 6573  = [len(ws.proces
-00001a90: 7369 6e67 2920 666f 7220 7773 2069 6e20  sing) for ws in 
-00001aa0: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-00001ab0: 6f72 6b65 7273 2e76 616c 7565 7328 295d  orkers.values()]
-00001ac0: 0a20 2020 2020 2020 2063 6f75 6e74 732c  .        counts,
-00001ad0: 2078 203d 206e 702e 6869 7374 6f67 7261   x = np.histogra
-00001ae0: 6d28 4c2c 2062 696e 733d 3430 290a 2020  m(L, bins=40).  
-00001af0: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
-00001b00: 652e 6461 7461 2e75 7064 6174 6528 7b22  e.data.update({"
-00001b10: 6c65 6674 223a 2078 5b3a 2d31 5d2c 2022  left": x[:-1], "
-00001b20: 7269 6768 7422 3a20 785b 313a 5d2c 2022  right": x[1:], "
-00001b30: 746f 7022 3a20 636f 756e 7473 7d29 0a0a  top": counts})..
-00001b40: 0a63 6c61 7373 204d 656d 6f72 7943 6f6c  .class MemoryCol
-00001b50: 6f72 3a0a 2020 2020 2222 2243 6861 6e67  or:.    """Chang
-00001b60: 6520 7468 6520 636f 6c6f 7220 6f66 2074  e the color of t
-00001b70: 6865 206d 656d 6f72 7920 6261 7273 2066  he memory bars f
-00001b80: 726f 6d20 626c 7565 2074 6f20 6f72 616e  rom blue to oran
-00001b90: 6765 2077 6865 6e20 7072 6f63 6573 7320  ge when process 
-00001ba0: 6d65 6d6f 7279 2067 6f65 730a 2020 2020  memory goes.    
-00001bb0: 6162 6f76 6520 7468 6520 6060 7461 7267  above the ``targ
-00001bc0: 6574 6060 2074 6872 6573 686f 6c64 2061  et`` threshold a
-00001bd0: 6e64 2074 6f20 7265 6420 7768 656e 2074  nd to red when t
-00001be0: 6865 2077 6f72 6b65 7220 7061 7573 6573  he worker pauses
-00001bf0: 2e0a 2020 2020 576f 726b 6572 7320 696e  ..    Workers in
-00001c00: 2060 6063 6c6f 7369 6e67 5f67 7261 6365   ``closing_grace
-00001c10: 6675 6c6c 7960 6020 7374 6174 6520 7769  fully`` state wi
-00001c20: 6c6c 2061 6c73 6f20 6265 206f 7261 6e67  ll also be orang
-00001c30: 652e 0a0a 2020 2020 4966 2060 6074 6172  e...    If ``tar
-00001c40: 6765 7460 6020 6973 2064 6973 6162 6c65  get`` is disable
-00001c50: 642c 2063 6861 6e67 6520 746f 206f 7261  d, change to ora
-00001c60: 6e67 6520 6f6e 2060 6073 7069 6c6c 6060  nge on ``spill``
-00001c70: 2069 6e73 7465 6164 2e0a 2020 2020 4966   instead..    If
-00001c80: 2073 7069 6c6c 696e 6720 6973 2063 6f6d   spilling is com
-00001c90: 706c 6574 656c 7920 6469 7361 626c 6564  pletely disabled
-00001ca0: 2c20 6e65 7665 7220 7475 726e 206f 7261  , never turn ora
-00001cb0: 6e67 652e 0a0a 2020 2020 4966 2070 6175  nge...    If pau
-00001cc0: 7369 6e67 2069 7320 6469 7361 626c 6564  sing is disabled
-00001cd0: 2c20 6368 616e 6765 2074 6f20 7265 6420  , change to red 
-00001ce0: 7768 656e 2070 6173 7369 6e67 2074 6865  when passing the
-00001cf0: 2060 6074 6572 6d69 6e61 7465 6060 2074   ``terminate`` t
-00001d00: 6872 6573 686f 6c64 0a20 2020 2069 6e73  hreshold.    ins
-00001d10: 7465 6164 2e20 4966 2062 6f74 6820 7061  tead. If both pa
-00001d20: 7573 6520 616e 6420 7465 726d 696e 6174  use and terminat
-00001d30: 6520 6172 6520 6469 7361 626c 6564 2c20  e are disabled, 
-00001d40: 7475 726e 2072 6564 2077 6865 6e20 7061  turn red when pa
-00001d50: 7373 696e 670a 2020 2020 6060 6d65 6d6f  ssing.    ``memo
-00001d60: 7279 5f6c 696d 6974 6060 2e0a 0a20 2020  ry_limit``...   
-00001d70: 204e 6f74 650a 2020 2020 2d2d 2d2d 0a20   Note.    ----. 
-00001d80: 2020 2041 2077 6f72 6b65 7220 7769 6c6c     A worker will
-00001d90: 2073 7461 7274 2073 7069 6c6c 696e 6720   start spilling 
-00001da0: 7768 656e 206d 616e 6167 6564 206d 656d  when managed mem
-00001db0: 6f72 7920 616c 6f6e 6520 7061 7373 6573  ory alone passes
-00001dc0: 2074 6865 2074 6172 6765 7420 7468 7265   the target thre
-00001dd0: 7368 6f6c 642e 0a20 2020 2048 6f77 6576  shold..    Howev
-00001de0: 6572 2c20 6865 7265 2077 6527 7265 2073  er, here we're s
-00001df0: 7769 7463 6869 6e67 2074 6f20 6f72 616e  witching to oran
-00001e00: 6765 2077 6865 6e20 7468 6520 7072 6f63  ge when the proc
-00001e10: 6573 7320 6d65 6d6f 7279 2067 6f65 7320  ess memory goes 
-00001e20: 6265 796f 6e64 2074 6172 6765 742c 0a20  beyond target,. 
-00001e30: 2020 2077 6869 6368 2069 7320 7573 7561     which is usua
-00001e40: 6c6c 7920 6561 726c 6965 722e 0a20 2020  lly earlier..   
-00001e50: 2054 6869 7320 6973 2064 656c 6962 6572   This is deliber
-00001e60: 6174 6520 666f 7220 7468 6520 7361 6b65  ate for the sake
-00001e70: 206f 6620 7369 6d70 6c69 6369 7479 2061   of simplicity a
-00001e80: 6e64 2061 6c73 6f20 6265 6361 7573 652c  nd also because,
-00001e90: 2077 6865 6e20 7468 6520 7072 6f63 6573   when the proces
-00001ea0: 730a 2020 2020 6d65 6d6f 7279 2070 6173  s.    memory pas
-00001eb0: 7365 7320 7468 6520 7370 696c 6c20 7468  ses the spill th
-00001ec0: 7265 7368 6f6c 642c 2069 7420 7769 6c6c  reshold, it will
-00001ed0: 206b 6565 7020 7370 696c 6c69 6e67 2075   keep spilling u
-00001ee0: 6e74 696c 2069 7420 6661 6c6c 7320 6265  ntil it falls be
-00001ef0: 6c6f 7720 7468 650a 2020 2020 7461 7267  low the.    targ
-00001f00: 6574 2074 6872 6573 686f 6c64 202d 2073  et threshold - s
-00001f10: 6f20 6974 2773 206e 6f74 2063 6f6d 706c  o it's not compl
-00001f20: 6574 656c 7920 7772 6f6e 672e 2041 6761  etely wrong. Aga
-00001f30: 696e 2c20 7765 2064 6f6e 2774 2077 616e  in, we don't wan
-00001f40: 7420 746f 2074 7261 636b 0a20 2020 2074  t to track.    t
-00001f50: 6865 2068 7973 7465 7265 7369 7320 6379  he hysteresis cy
-00001f60: 636c 6520 6f66 2074 6865 2073 7069 6c6c  cle of the spill
-00001f70: 2073 7973 7465 6d20 6865 7265 2066 6f72   system here for
-00001f80: 2074 6865 2073 616b 6520 6f66 2073 696d   the sake of sim
-00001f90: 706c 6963 6974 792e 0a0a 2020 2020 496e  plicity...    In
-00001fa0: 2073 686f 7274 2c20 6f72 616e 6765 2073   short, orange s
-00001fb0: 686f 756c 6420 6265 2074 7265 6174 6564  hould be treated
-00001fc0: 2061 7320 2274 6865 2077 6f72 6b65 7220   as "the worker 
-00001fd0: 2a6d 6179 2a20 6265 2073 7069 6c6c 696e  *may* be spillin
-00001fe0: 6722 2e0a 2020 2020 2222 220a 0a20 2020  g"..    """..   
-00001ff0: 206f 7261 6e67 653a 2066 6c6f 6174 0a20   orange: float. 
-00002000: 2020 2072 6564 3a20 666c 6f61 740a 0a20     red: float.. 
-00002010: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00002020: 7365 6c66 293a 0a20 2020 2020 2020 2074  self):.        t
-00002030: 6172 6765 7420 3d20 6461 736b 2e63 6f6e  arget = dask.con
-00002040: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-00002050: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-00002060: 7279 2e74 6172 6765 7422 290a 2020 2020  ry.target").    
-00002070: 2020 2020 7370 696c 6c20 3d20 6461 736b      spill = dask
-00002080: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-00002090: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-000020a0: 6d65 6d6f 7279 2e73 7069 6c6c 2229 0a20  memory.spill"). 
-000020b0: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
-000020c0: 203d 2064 6173 6b2e 636f 6e66 6967 2e67   = dask.config.g
-000020d0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-000020e0: 776f 726b 6572 2e6d 656d 6f72 792e 7465  worker.memory.te
-000020f0: 726d 696e 6174 6522 290a 2020 2020 2020  rminate").      
-00002100: 2020 2320 5468 6573 6520 7661 6c75 6573    # These values
-00002110: 2063 616e 2062 6520 4661 6c73 652e 2049   can be False. I
-00002120: 7427 7320 616c 736f 2063 6f6d 6d6f 6e20  t's also common 
-00002130: 746f 2063 6f6e 6669 6775 7265 2074 6865  to configure the
-00002140: 6d20 746f 2069 6d70 6f73 7369 626c 790a  m to impossibly.
-00002150: 2020 2020 2020 2020 2320 6869 6768 2076          # high v
-00002160: 616c 7565 7320 746f 2061 6368 6965 7665  alues to achieve
-00002170: 2074 6865 2073 616d 6520 6566 6665 6374   the same effect
-00002180: 2e0a 2020 2020 2020 2020 7365 6c66 2e6f  ..        self.o
-00002190: 7261 6e67 6520 3d20 6d69 6e28 7461 7267  range = min(targ
-000021a0: 6574 206f 7220 6d61 7468 2e69 6e66 2c20  et or math.inf, 
-000021b0: 7370 696c 6c20 6f72 206d 6174 682e 696e  spill or math.in
-000021c0: 6629 0a20 2020 2020 2020 2073 656c 662e  f).        self.
-000021d0: 7265 6420 3d20 6d69 6e28 7465 726d 696e  red = min(termin
-000021e0: 6174 6520 6f72 206d 6174 682e 696e 662c  ate or math.inf,
-000021f0: 2031 2e30 290a 0a20 2020 2064 6566 205f   1.0)..    def _
-00002200: 6d65 6d6f 7279 5f63 6f6c 6f72 2873 656c  memory_color(sel
-00002210: 662c 2063 7572 7265 6e74 3a20 696e 742c  f, current: int,
-00002220: 206c 696d 6974 3a20 696e 742c 2073 7461   limit: int, sta
-00002230: 7475 733a 2053 7461 7475 7329 202d 3e20  tus: Status) -> 
-00002240: 7374 723a 0a20 2020 2020 2020 2069 6620  str:.        if 
-00002250: 7374 6174 7573 2021 3d20 5374 6174 7573  status != Status
-00002260: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-00002270: 2020 2020 2020 7265 7475 726e 2022 7265        return "re
-00002280: 6422 0a20 2020 2020 2020 2069 6620 6e6f  d".        if no
-00002290: 7420 6c69 6d69 743a 0a20 2020 2020 2020  t limit:.       
-000022a0: 2020 2020 2072 6574 7572 6e20 2262 6c75       return "blu
-000022b0: 6522 0a20 2020 2020 2020 2069 6620 6375  e".        if cu
-000022c0: 7272 656e 7420 3e3d 206c 696d 6974 202a  rrent >= limit *
-000022d0: 2073 656c 662e 7265 643a 0a20 2020 2020   self.red:.     
-000022e0: 2020 2020 2020 2072 6574 7572 6e20 2272         return "r
-000022f0: 6564 220a 2020 2020 2020 2020 6966 2063  ed".        if c
-00002300: 7572 7265 6e74 203e 3d20 6c69 6d69 7420  urrent >= limit 
-00002310: 2a20 7365 6c66 2e6f 7261 6e67 653a 0a20  * self.orange:. 
-00002320: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00002330: 6e20 226f 7261 6e67 6522 0a20 2020 2020  n "orange".     
-00002340: 2020 2072 6574 7572 6e20 2262 6c75 6522     return "blue"
-00002350: 0a0a 0a63 6c61 7373 2043 6c75 7374 6572  ...class Cluster
-00002360: 4d65 6d6f 7279 2844 6173 6862 6f61 7264  Memory(Dashboard
-00002370: 436f 6d70 6f6e 656e 742c 204d 656d 6f72  Component, Memor
-00002380: 7943 6f6c 6f72 293a 0a20 2020 2022 2222  yColor):.    """
-00002390: 546f 7461 6c20 6d65 6d6f 7279 2075 7361  Total memory usa
-000023a0: 6765 206f 6e20 7468 6520 636c 7573 7465  ge on the cluste
-000023b0: 7222 2222 0a0a 2020 2020 406c 6f67 5f65  r"""..    @log_e
-000023c0: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
-000023d0: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-000023e0: 6564 756c 6572 2c20 7769 6474 683d 3630  eduler, width=60
-000023f0: 302c 202a 2a6b 7761 7267 7329 3a0a 2020  0, **kwargs):.  
-00002400: 2020 2020 2020 4461 7368 626f 6172 6443        DashboardC
-00002410: 6f6d 706f 6e65 6e74 2e5f 5f69 6e69 745f  omponent.__init_
-00002420: 5f28 7365 6c66 290a 2020 2020 2020 2020  _(self).        
-00002430: 4d65 6d6f 7279 436f 6c6f 722e 5f5f 696e  MemoryColor.__in
-00002440: 6974 5f5f 2873 656c 6629 0a0a 2020 2020  it__(self)..    
-00002450: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
-00002460: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
-00002470: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-00002480: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-00002490: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
-000024a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000024b0: 2020 2020 2022 7769 6474 6822 3a20 5b30       "width": [0
-000024c0: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
-000024d0: 2020 2020 2020 2022 7822 3a20 5b30 5d20         "x": [0] 
-000024e0: 2a20 342c 0a20 2020 2020 2020 2020 2020  * 4,.           
-000024f0: 2020 2020 2022 7922 3a20 5b30 5d20 2a20       "y": [0] * 
-00002500: 342c 0a20 2020 2020 2020 2020 2020 2020  4,.             
-00002510: 2020 2022 636f 6c6f 7222 3a20 5b22 626c     "color": ["bl
-00002520: 7565 222c 2022 626c 7565 222c 2022 626c  ue", "blue", "bl
-00002530: 7565 222c 2022 6772 6579 225d 2c0a 2020  ue", "grey"],.  
-00002540: 2020 2020 2020 2020 2020 2020 2020 2261                "a
-00002550: 6c70 6861 223a 205b 312c 2030 2e37 2c20  lpha": [1, 0.7, 
-00002560: 302e 342c 2031 5d2c 0a20 2020 2020 2020  0.4, 1],.       
-00002570: 2020 2020 2020 2020 2022 7072 6f63 5f6d           "proc_m
-00002580: 656d 6f72 7922 3a20 5b30 5d20 2a20 342c  emory": [0] * 4,
-00002590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000025a0: 2022 6d61 6e61 6765 6422 3a20 5b30 5d20   "managed": [0] 
-000025b0: 2a20 342c 0a20 2020 2020 2020 2020 2020  * 4,.           
-000025c0: 2020 2020 2022 756e 6d61 6e61 6765 645f       "unmanaged_
-000025d0: 6f6c 6422 3a20 5b30 5d20 2a20 342c 0a20  old": [0] * 4,. 
-000025e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000025f0: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
-00002600: 223a 205b 305d 202a 2034 2c0a 2020 2020  ": [0] * 4,.    
-00002610: 2020 2020 2020 2020 2020 2020 2273 7069              "spi
-00002620: 6c6c 6564 223a 205b 305d 202a 2034 2c0a  lled": [0] * 4,.
-00002630: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00002640: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00002650: 2073 656c 662e 726f 6f74 203d 2066 6967   self.root = fig
-00002660: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
-00002670: 2074 6974 6c65 3d22 4279 7465 7320 7374   title="Bytes st
-00002680: 6f72 6564 206f 6e20 636c 7573 7465 7222  ored on cluster"
-00002690: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-000026a0: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-000026b0: 2020 2020 7769 6474 683d 696e 7428 7769      width=int(wi
-000026c0: 6474 6820 2f20 3229 2c0a 2020 2020 2020  dth / 2),.      
-000026d0: 2020 2020 2020 6e61 6d65 3d22 636c 7573        name="clus
-000026e0: 7465 725f 6d65 6d6f 7279 222c 0a20 2020  ter_memory",.   
-000026f0: 2020 2020 2020 2020 206d 696e 5f62 6f72           min_bor
-00002700: 6465 725f 626f 7474 6f6d 3d35 302c 0a20  der_bottom=50,. 
-00002710: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-00002720: 7267 732c 0a20 2020 2020 2020 2029 0a20  rgs,.        ). 
-00002730: 2020 2020 2020 2072 6563 7420 3d20 7365         rect = se
-00002740: 6c66 2e72 6f6f 742e 7265 6374 280a 2020  lf.root.rect(.  
-00002750: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00002760: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-00002770: 2020 2020 2020 2020 2020 783d 2278 222c            x="x",
-00002780: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
-00002790: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-000027a0: 7769 6474 683d 2277 6964 7468 222c 0a20  width="width",. 
-000027b0: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-000027c0: 743d 302e 392c 0a20 2020 2020 2020 2020  t=0.9,.         
-000027d0: 2020 2063 6f6c 6f72 3d22 636f 6c6f 7222     color="color"
-000027e0: 2c0a 2020 2020 2020 2020 2020 2020 616c  ,.            al
-000027f0: 7068 613d 2261 6c70 6861 222c 0a20 2020  pha="alpha",.   
-00002800: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00002810: 6563 742e 6e6f 6e73 656c 6563 7469 6f6e  ect.nonselection
-00002820: 5f67 6c79 7068 203d 204e 6f6e 650a 0a20  _glyph = None.. 
-00002830: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00002840: 2e61 7869 735b 305d 2e74 6963 6b65 7220  .axis[0].ticker 
-00002850: 3d20 4261 7369 6354 6963 6b65 7228 2a2a  = BasicTicker(**
-00002860: 5449 434b 535f 3130 3234 290a 2020 2020  TICKS_1024).    
-00002870: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00002880: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-00002890: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-000028a0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-000028b0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
-000028c0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-000028d0: 6d61 6a6f 725f 6c61 6265 6c5f 6f72 6965  major_label_orie
-000028e0: 6e74 6174 696f 6e20 3d20 584c 4142 454c  ntation = XLABEL
-000028f0: 5f4f 5249 454e 5441 5449 4f4e 0a20 2020  _ORIENTATION.   
-00002900: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
-00002910: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-00002920: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-00002930: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00002940: 2e78 5f72 616e 6765 203d 2052 616e 6765  .x_range = Range
-00002950: 3164 2873 7461 7274 3d30 290a 2020 2020  1d(start=0).    
-00002960: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
-00002970: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-00002980: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00002990: 2e72 6f6f 742e 7967 7269 642e 7669 7369  .root.ygrid.visi
-000029a0: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
-000029b0: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
-000029c0: 6f6f 6c62 6172 5f6c 6f63 6174 696f 6e20  oolbar_location 
-000029d0: 3d20 2261 626f 7665 220a 2020 2020 2020  = "above".      
-000029e0: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
-000029f0: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
-00002a00: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
-00002a10: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
-00002a20: 2020 2020 2020 2020 2020 706f 696e 745f            point_
-00002a30: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
-00002a40: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
-00002a50: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
-00002a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a70: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-00002a80: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00002a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002aa0: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-00002ab0: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
-00002ac0: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
-00002ad0: 643b 223e 5072 6f63 6573 7320 6d65 6d6f  d;">Process memo
-00002ae0: 7279 2028 5253 5329 3a3c 2f73 7061 6e3e  ry (RSS):</span>
-00002af0: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
-00002b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b10: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00002b20: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00002b30: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00002b40: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-00002b50: 6163 653b 223e 4070 726f 635f 6d65 6d6f  ace;">@proc_memo
-00002b60: 7279 7b30 2e30 3020 627d 3c2f 7370 616e  ry{0.00 b}</span
-00002b70: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00002b80: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-00002b90: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-00002ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bb0: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
-00002bc0: 6769 6e2d 6c65 6674 3a20 3165 6d3b 223e  gin-left: 1em;">
-00002bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bf0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00002c00: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
-00002c10: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-00002c20: 3b22 3e4d 616e 6167 6564 3a3c 2f73 7061  ;">Managed:</spa
-00002c30: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-00002c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c50: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-00002c60: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00002c70: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-00002c80: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-00002c90: 7370 6163 653b 223e 406d 616e 6167 6564  space;">@managed
-00002ca0: 7b30 2e30 3020 627d 3c2f 7370 616e 3e0a  {0.00 b}</span>.
-00002cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002cc0: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-00002cd0: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00002ce0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00002cf0: 6469 7620 7374 796c 653d 226d 6172 6769  div style="margi
-00002d00: 6e2d 6c65 6674 3a20 3165 6d3b 223e 0a20  n-left: 1em;">. 
+00001420: 7070 656e 6428 2267 7265 656e 2229 0a20  ppend("green"). 
+00001430: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00001440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001450: 2063 6f6c 6f72 2e61 7070 656e 6428 2262   color.append("b
+00001460: 6c75 6522 290a 0a20 2020 2020 2020 2069  lue")..        i
+00001470: 6620 746f 7461 6c3a 0a20 2020 2020 2020  f total:.       
+00001480: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
+00001490: 6974 6c65 2e74 6578 7420 3d20 280a 2020  itle.text = (.  
+000014a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000014b0: 4f63 6375 7061 6e63 7920 2d2d 2074 6f74  Occupancy -- tot
+000014c0: 616c 2074 696d 653a 207b 666f 726d 6174  al time: {format
+000014d0: 5f74 696d 6528 746f 7461 6c29 7d20 220a  _time(total)} ".
+000014e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014f0: 6622 7761 6c6c 2074 696d 653a 207b 666f  f"wall time: {fo
+00001500: 726d 6174 5f74 696d 6528 746f 7461 6c20  rmat_time(total 
+00001510: 2f20 7365 6c66 2e73 6368 6564 756c 6572  / self.scheduler
+00001520: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
+00001530: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00001540: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00001550: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00001560: 726f 6f74 2e74 6974 6c65 2e74 6578 7420  root.title.text 
+00001570: 3d20 224f 6363 7570 616e 6379 220a 0a20  = "Occupancy".. 
+00001580: 2020 2020 2020 2069 6620 6f63 6375 7061         if occupa
+00001590: 6e63 793a 0a20 2020 2020 2020 2020 2020  ncy:.           
+000015a0: 2072 6573 756c 7420 3d20 7b0a 2020 2020   result = {.    
+000015b0: 2020 2020 2020 2020 2020 2020 226f 6363              "occ
+000015c0: 7570 616e 6379 223a 206f 6363 7570 616e  upancy": occupan
+000015d0: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
+000015e0: 2020 2020 2277 6f72 6b65 7222 3a20 5b77      "worker": [w
+000015f0: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
+00001600: 2069 6e20 776f 726b 6572 735d 2c0a 2020   in workers],.  
+00001610: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+00001620: 7322 3a20 6d73 2c0a 2020 2020 2020 2020  s": ms,.        
+00001630: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
+00001640: 2063 6f6c 6f72 2c0a 2020 2020 2020 2020   color,.        
+00001650: 2020 2020 2020 2020 2265 7363 6170 6564          "escaped
+00001660: 5f77 6f72 6b65 7222 3a20 5b65 7363 6170  _worker": [escap
+00001670: 652e 7572 6c5f 6573 6361 7065 2877 732e  e.url_escape(ws.
+00001680: 6164 6472 6573 7329 2066 6f72 2077 7320  address) for ws 
+00001690: 696e 2077 6f72 6b65 7273 5d2c 0a20 2020  in workers],.   
+000016a0: 2020 2020 2020 2020 2020 2020 2022 7822               "x"
+000016b0: 3a20 782c 0a20 2020 2020 2020 2020 2020  : x,.           
+000016c0: 2020 2020 2022 7922 3a20 792c 0a20 2020       "y": y,.   
+000016d0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+000016e0: 2020 2020 2020 2020 7570 6461 7465 2873          update(s
+000016f0: 656c 662e 736f 7572 6365 2c20 7265 7375  elf.source, resu
+00001700: 6c74 290a 0a0a 636c 6173 7320 5072 6f63  lt)...class Proc
+00001710: 6573 7369 6e67 4869 7374 6f67 7261 6d28  essingHistogram(
+00001720: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+00001730: 6e74 293a 0a20 2020 2022 2222 486f 7720  nt):.    """How 
+00001740: 6d61 6e79 2074 6173 6b73 2061 7265 206f  many tasks are o
+00001750: 6e20 6561 6368 2077 6f72 6b65 7222 2222  n each worker"""
+00001760: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+00001770: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
+00001780: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+00001790: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+000017a0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+000017b0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+000017c0: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+000017d0: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+000017e0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
+000017f0: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
+00001800: 2020 2020 2020 2020 2020 2020 7b22 6c65              {"le
+00001810: 6674 223a 205b 312c 2032 5d2c 2022 7269  ft": [1, 2], "ri
+00001820: 6768 7422 3a20 5b31 302c 2031 305d 2c20  ght": [10, 10], 
+00001830: 2274 6f70 223a 205b 302c 2030 5d7d 0a20  "top": [0, 0]}. 
+00001840: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00001850: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+00001860: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+00001870: 2020 7469 746c 653d 2254 6173 6b73 2050    title="Tasks P
+00001880: 726f 6365 7373 696e 6720 2863 6f75 6e74  rocessing (count
+00001890: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
+000018a0: 6e61 6d65 3d22 7072 6f63 6573 7369 6e67  name="processing
+000018b0: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+000018c0: 5f61 7869 735f 6c61 6265 6c3d 2266 7265  _axis_label="fre
+000018d0: 7175 656e 6379 222c 0a20 2020 2020 2020  quency",.       
+000018e0: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+000018f0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+00001900: 7267 732c 0a20 2020 2020 2020 2029 0a0a  rgs,.        )..
+00001910: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00001920: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
+00001930: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+00001940: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
+00001950: 6f6f 742e 7967 7269 642e 7669 7369 626c  oot.ygrid.visibl
+00001960: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+00001970: 2020 2073 656c 662e 726f 6f74 2e74 6f6f     self.root.too
+00001980: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
+00001990: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
+000019a0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+000019b0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+000019c0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+000019d0: 2020 2020 2020 2020 2020 6c65 6674 3d22            left="
+000019e0: 6c65 6674 222c 0a20 2020 2020 2020 2020  left",.         
+000019f0: 2020 2072 6967 6874 3d22 7269 6768 7422     right="right"
+00001a00: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+00001a10: 7474 6f6d 3d30 2c0a 2020 2020 2020 2020  ttom=0,.        
+00001a20: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
+00001a30: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00001a40: 3d22 6465 6570 736b 7962 6c75 6522 2c0a  ="deepskyblue",.
+00001a50: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+00001a60: 5f61 6c70 6861 3d30 2e35 2c0a 2020 2020  _alpha=0.5,.    
+00001a70: 2020 2020 290a 0a20 2020 2040 7769 7468      )..    @with
+00001a80: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
+00001a90: 6964 6174 696f 6e0a 2020 2020 6465 6620  idation.    def 
+00001aa0: 7570 6461 7465 2873 656c 6629 3a0a 2020  update(self):.  
+00001ab0: 2020 2020 2020 4c20 3d20 5b6c 656e 2877        L = [len(w
+00001ac0: 732e 7072 6f63 6573 7369 6e67 2920 666f  s.processing) fo
+00001ad0: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
+00001ae0: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
+00001af0: 616c 7565 7328 295d 0a20 2020 2020 2020  alues()].       
+00001b00: 2063 6f75 6e74 732c 2078 203d 206e 702e   counts, x = np.
+00001b10: 6869 7374 6f67 7261 6d28 4c2c 2062 696e  histogram(L, bin
+00001b20: 733d 3430 290a 2020 2020 2020 2020 7365  s=40).        se
+00001b30: 6c66 2e73 6f75 7263 652e 6461 7461 2e75  lf.source.data.u
+00001b40: 7064 6174 6528 7b22 6c65 6674 223a 2078  pdate({"left": x
+00001b50: 5b3a 2d31 5d2c 2022 7269 6768 7422 3a20  [:-1], "right": 
+00001b60: 785b 313a 5d2c 2022 746f 7022 3a20 636f  x[1:], "top": co
+00001b70: 756e 7473 7d29 0a0a 0a63 6c61 7373 204d  unts})...class M
+00001b80: 656d 6f72 7943 6f6c 6f72 3a0a 2020 2020  emoryColor:.    
+00001b90: 2222 2243 6861 6e67 6520 7468 6520 636f  """Change the co
+00001ba0: 6c6f 7220 6f66 2074 6865 206d 656d 6f72  lor of the memor
+00001bb0: 7920 6261 7273 2066 726f 6d20 626c 7565  y bars from blue
+00001bc0: 2074 6f20 6f72 616e 6765 2077 6865 6e20   to orange when 
+00001bd0: 7072 6f63 6573 7320 6d65 6d6f 7279 2067  process memory g
+00001be0: 6f65 730a 2020 2020 6162 6f76 6520 7468  oes.    above th
+00001bf0: 6520 6060 7461 7267 6574 6060 2074 6872  e ``target`` thr
+00001c00: 6573 686f 6c64 2061 6e64 2074 6f20 7265  eshold and to re
+00001c10: 6420 7768 656e 2074 6865 2077 6f72 6b65  d when the worke
+00001c20: 7220 7061 7573 6573 2e0a 2020 2020 576f  r pauses..    Wo
+00001c30: 726b 6572 7320 696e 2060 6063 6c6f 7369  rkers in ``closi
+00001c40: 6e67 5f67 7261 6365 6675 6c6c 7960 6020  ng_gracefully`` 
+00001c50: 7374 6174 6520 7769 6c6c 2061 6c73 6f20  state will also 
+00001c60: 6265 206f 7261 6e67 652e 0a0a 2020 2020  be orange...    
+00001c70: 4966 2060 6074 6172 6765 7460 6020 6973  If ``target`` is
+00001c80: 2064 6973 6162 6c65 642c 2063 6861 6e67   disabled, chang
+00001c90: 6520 746f 206f 7261 6e67 6520 6f6e 2060  e to orange on `
+00001ca0: 6073 7069 6c6c 6060 2069 6e73 7465 6164  `spill`` instead
+00001cb0: 2e0a 2020 2020 4966 2073 7069 6c6c 696e  ..    If spillin
+00001cc0: 6720 6973 2063 6f6d 706c 6574 656c 7920  g is completely 
+00001cd0: 6469 7361 626c 6564 2c20 6e65 7665 7220  disabled, never 
+00001ce0: 7475 726e 206f 7261 6e67 652e 0a0a 2020  turn orange...  
+00001cf0: 2020 4966 2070 6175 7369 6e67 2069 7320    If pausing is 
+00001d00: 6469 7361 626c 6564 2c20 6368 616e 6765  disabled, change
+00001d10: 2074 6f20 7265 6420 7768 656e 2070 6173   to red when pas
+00001d20: 7369 6e67 2074 6865 2060 6074 6572 6d69  sing the ``termi
+00001d30: 6e61 7465 6060 2074 6872 6573 686f 6c64  nate`` threshold
+00001d40: 0a20 2020 2069 6e73 7465 6164 2e20 4966  .    instead. If
+00001d50: 2062 6f74 6820 7061 7573 6520 616e 6420   both pause and 
+00001d60: 7465 726d 696e 6174 6520 6172 6520 6469  terminate are di
+00001d70: 7361 626c 6564 2c20 7475 726e 2072 6564  sabled, turn red
+00001d80: 2077 6865 6e20 7061 7373 696e 670a 2020   when passing.  
+00001d90: 2020 6060 6d65 6d6f 7279 5f6c 696d 6974    ``memory_limit
+00001da0: 6060 2e0a 0a20 2020 204e 6f74 650a 2020  ``...    Note.  
+00001db0: 2020 2d2d 2d2d 0a20 2020 2041 2077 6f72    ----.    A wor
+00001dc0: 6b65 7220 7769 6c6c 2073 7461 7274 2073  ker will start s
+00001dd0: 7069 6c6c 696e 6720 7768 656e 206d 616e  pilling when man
+00001de0: 6167 6564 206d 656d 6f72 7920 616c 6f6e  aged memory alon
+00001df0: 6520 7061 7373 6573 2074 6865 2074 6172  e passes the tar
+00001e00: 6765 7420 7468 7265 7368 6f6c 642e 0a20  get threshold.. 
+00001e10: 2020 2048 6f77 6576 6572 2c20 6865 7265     However, here
+00001e20: 2077 6527 7265 2073 7769 7463 6869 6e67   we're switching
+00001e30: 2074 6f20 6f72 616e 6765 2077 6865 6e20   to orange when 
+00001e40: 7468 6520 7072 6f63 6573 7320 6d65 6d6f  the process memo
+00001e50: 7279 2067 6f65 7320 6265 796f 6e64 2074  ry goes beyond t
+00001e60: 6172 6765 742c 0a20 2020 2077 6869 6368  arget,.    which
+00001e70: 2069 7320 7573 7561 6c6c 7920 6561 726c   is usually earl
+00001e80: 6965 722e 0a20 2020 2054 6869 7320 6973  ier..    This is
+00001e90: 2064 656c 6962 6572 6174 6520 666f 7220   deliberate for 
+00001ea0: 7468 6520 7361 6b65 206f 6620 7369 6d70  the sake of simp
+00001eb0: 6c69 6369 7479 2061 6e64 2061 6c73 6f20  licity and also 
+00001ec0: 6265 6361 7573 652c 2077 6865 6e20 7468  because, when th
+00001ed0: 6520 7072 6f63 6573 730a 2020 2020 6d65  e process.    me
+00001ee0: 6d6f 7279 2070 6173 7365 7320 7468 6520  mory passes the 
+00001ef0: 7370 696c 6c20 7468 7265 7368 6f6c 642c  spill threshold,
+00001f00: 2069 7420 7769 6c6c 206b 6565 7020 7370   it will keep sp
+00001f10: 696c 6c69 6e67 2075 6e74 696c 2069 7420  illing until it 
+00001f20: 6661 6c6c 7320 6265 6c6f 7720 7468 650a  falls below the.
+00001f30: 2020 2020 7461 7267 6574 2074 6872 6573      target thres
+00001f40: 686f 6c64 202d 2073 6f20 6974 2773 206e  hold - so it's n
+00001f50: 6f74 2063 6f6d 706c 6574 656c 7920 7772  ot completely wr
+00001f60: 6f6e 672e 2041 6761 696e 2c20 7765 2064  ong. Again, we d
+00001f70: 6f6e 2774 2077 616e 7420 746f 2074 7261  on't want to tra
+00001f80: 636b 0a20 2020 2074 6865 2068 7973 7465  ck.    the hyste
+00001f90: 7265 7369 7320 6379 636c 6520 6f66 2074  resis cycle of t
+00001fa0: 6865 2073 7069 6c6c 2073 7973 7465 6d20  he spill system 
+00001fb0: 6865 7265 2066 6f72 2074 6865 2073 616b  here for the sak
+00001fc0: 6520 6f66 2073 696d 706c 6963 6974 792e  e of simplicity.
+00001fd0: 0a0a 2020 2020 496e 2073 686f 7274 2c20  ..    In short, 
+00001fe0: 6f72 616e 6765 2073 686f 756c 6420 6265  orange should be
+00001ff0: 2074 7265 6174 6564 2061 7320 2274 6865   treated as "the
+00002000: 2077 6f72 6b65 7220 2a6d 6179 2a20 6265   worker *may* be
+00002010: 2073 7069 6c6c 696e 6722 2e0a 2020 2020   spilling"..    
+00002020: 2222 220a 0a20 2020 206f 7261 6e67 653a  """..    orange:
+00002030: 2066 6c6f 6174 0a20 2020 2072 6564 3a20   float.    red: 
+00002040: 666c 6f61 740a 0a20 2020 2064 6566 205f  float..    def _
+00002050: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00002060: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
+00002070: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+00002080: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
+00002090: 6b65 722e 6d65 6d6f 7279 2e74 6172 6765  ker.memory.targe
+000020a0: 7422 290a 2020 2020 2020 2020 7370 696c  t").        spil
+000020b0: 6c20 3d20 6461 736b 2e63 6f6e 6669 672e  l = dask.config.
+000020c0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+000020d0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e73  .worker.memory.s
+000020e0: 7069 6c6c 2229 0a20 2020 2020 2020 2074  pill").        t
+000020f0: 6572 6d69 6e61 7465 203d 2064 6173 6b2e  erminate = dask.
+00002100: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+00002110: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+00002120: 656d 6f72 792e 7465 726d 696e 6174 6522  emory.terminate"
+00002130: 290a 2020 2020 2020 2020 2320 5468 6573  ).        # Thes
+00002140: 6520 7661 6c75 6573 2063 616e 2062 6520  e values can be 
+00002150: 4661 6c73 652e 2049 7427 7320 616c 736f  False. It's also
+00002160: 2063 6f6d 6d6f 6e20 746f 2063 6f6e 6669   common to confi
+00002170: 6775 7265 2074 6865 6d20 746f 2069 6d70  gure them to imp
+00002180: 6f73 7369 626c 790a 2020 2020 2020 2020  ossibly.        
+00002190: 2320 6869 6768 2076 616c 7565 7320 746f  # high values to
+000021a0: 2061 6368 6965 7665 2074 6865 2073 616d   achieve the sam
+000021b0: 6520 6566 6665 6374 2e0a 2020 2020 2020  e effect..      
+000021c0: 2020 7365 6c66 2e6f 7261 6e67 6520 3d20    self.orange = 
+000021d0: 6d69 6e28 7461 7267 6574 206f 7220 6d61  min(target or ma
+000021e0: 7468 2e69 6e66 2c20 7370 696c 6c20 6f72  th.inf, spill or
+000021f0: 206d 6174 682e 696e 6629 0a20 2020 2020   math.inf).     
+00002200: 2020 2073 656c 662e 7265 6420 3d20 6d69     self.red = mi
+00002210: 6e28 7465 726d 696e 6174 6520 6f72 206d  n(terminate or m
+00002220: 6174 682e 696e 662c 2031 2e30 290a 0a20  ath.inf, 1.0).. 
+00002230: 2020 2064 6566 205f 6d65 6d6f 7279 5f63     def _memory_c
+00002240: 6f6c 6f72 2873 656c 662c 2063 7572 7265  olor(self, curre
+00002250: 6e74 3a20 696e 742c 206c 696d 6974 3a20  nt: int, limit: 
+00002260: 696e 742c 2073 7461 7475 733a 2053 7461  int, status: Sta
+00002270: 7475 7329 202d 3e20 7374 723a 0a20 2020  tus) -> str:.   
+00002280: 2020 2020 2069 6620 7374 6174 7573 2021       if status !
+00002290: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
+000022a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000022b0: 7475 726e 2022 7265 6422 0a20 2020 2020  turn "red".     
+000022c0: 2020 2069 6620 6e6f 7420 6c69 6d69 743a     if not limit:
+000022d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000022e0: 7572 6e20 2262 6c75 6522 0a20 2020 2020  urn "blue".     
+000022f0: 2020 2069 6620 6375 7272 656e 7420 3e3d     if current >=
+00002300: 206c 696d 6974 202a 2073 656c 662e 7265   limit * self.re
+00002310: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00002320: 6574 7572 6e20 2272 6564 220a 2020 2020  eturn "red".    
+00002330: 2020 2020 6966 2063 7572 7265 6e74 203e      if current >
+00002340: 3d20 6c69 6d69 7420 2a20 7365 6c66 2e6f  = limit * self.o
+00002350: 7261 6e67 653a 0a20 2020 2020 2020 2020  range:.         
+00002360: 2020 2072 6574 7572 6e20 226f 7261 6e67     return "orang
+00002370: 6522 0a20 2020 2020 2020 2072 6574 7572  e".        retur
+00002380: 6e20 2262 6c75 6522 0a0a 0a63 6c61 7373  n "blue"...class
+00002390: 2043 6c75 7374 6572 4d65 6d6f 7279 2844   ClusterMemory(D
+000023a0: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
+000023b0: 742c 204d 656d 6f72 7943 6f6c 6f72 293a  t, MemoryColor):
+000023c0: 0a20 2020 2022 2222 546f 7461 6c20 6d65  .    """Total me
+000023d0: 6d6f 7279 2075 7361 6765 206f 6e20 7468  mory usage on th
+000023e0: 6520 636c 7573 7465 7222 2222 0a0a 2020  e cluster"""..  
+000023f0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+00002400: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00002410: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
+00002420: 7769 6474 683d 3630 302c 202a 2a6b 7761  width=600, **kwa
+00002430: 7267 7329 3a0a 2020 2020 2020 2020 4461  rgs):.        Da
+00002440: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
+00002450: 2e5f 5f69 6e69 745f 5f28 7365 6c66 290a  .__init__(self).
+00002460: 2020 2020 2020 2020 4d65 6d6f 7279 436f          MemoryCo
+00002470: 6c6f 722e 5f5f 696e 6974 5f5f 2873 656c  lor.__init__(sel
+00002480: 6629 0a0a 2020 2020 2020 2020 7365 6c66  f)..        self
+00002490: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+000024a0: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+000024b0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+000024c0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
+000024d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000024e0: 2020 2020 2020 2020 2020 2020 2022 7769               "wi
+000024f0: 6474 6822 3a20 5b30 5d20 2a20 342c 0a20  dth": [0] * 4,. 
+00002500: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00002510: 7822 3a20 5b30 5d20 2a20 342c 0a20 2020  x": [0] * 4,.   
+00002520: 2020 2020 2020 2020 2020 2020 2022 7922               "y"
+00002530: 3a20 5b30 5d20 2a20 342c 0a20 2020 2020  : [0] * 4,.     
+00002540: 2020 2020 2020 2020 2020 2022 636f 6c6f             "colo
+00002550: 7222 3a20 5b22 626c 7565 222c 2022 626c  r": ["blue", "bl
+00002560: 7565 222c 2022 626c 7565 222c 2022 6772  ue", "blue", "gr
+00002570: 6579 225d 2c0a 2020 2020 2020 2020 2020  ey"],.          
+00002580: 2020 2020 2020 2261 6c70 6861 223a 205b        "alpha": [
+00002590: 312c 2030 2e37 2c20 302e 342c 2031 5d2c  1, 0.7, 0.4, 1],
+000025a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000025b0: 2022 7072 6f63 5f6d 656d 6f72 7922 3a20   "proc_memory": 
+000025c0: 5b30 5d20 2a20 342c 0a20 2020 2020 2020  [0] * 4,.       
+000025d0: 2020 2020 2020 2020 2022 6d61 6e61 6765           "manage
+000025e0: 6422 3a20 5b30 5d20 2a20 342c 0a20 2020  d": [0] * 4,.   
+000025f0: 2020 2020 2020 2020 2020 2020 2022 756e               "un
+00002600: 6d61 6e61 6765 645f 6f6c 6422 3a20 5b30  managed_old": [0
+00002610: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
+00002620: 2020 2020 2020 2022 756e 6d61 6e61 6765         "unmanage
+00002630: 645f 7265 6365 6e74 223a 205b 305d 202a  d_recent": [0] *
+00002640: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
+00002650: 2020 2020 2273 7069 6c6c 6564 223a 205b      "spilled": [
+00002660: 305d 202a 2034 2c0a 2020 2020 2020 2020  0] * 4,.        
+00002670: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+00002680: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00002690: 6f74 203d 2066 6967 7572 6528 0a20 2020  ot = figure(.   
+000026a0: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
+000026b0: 4279 7465 7320 7374 6f72 6564 206f 6e20  Bytes stored on 
+000026c0: 636c 7573 7465 7222 2c0a 2020 2020 2020  cluster",.      
+000026d0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+000026e0: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+000026f0: 683d 696e 7428 7769 6474 6820 2f20 3229  h=int(width / 2)
+00002700: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
+00002710: 6d65 3d22 636c 7573 7465 725f 6d65 6d6f  me="cluster_memo
+00002720: 7279 222c 0a20 2020 2020 2020 2020 2020  ry",.           
+00002730: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
+00002740: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
+00002750: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00002760: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00002770: 6563 7420 3d20 7365 6c66 2e72 6f6f 742e  ect = self.root.
+00002780: 7265 6374 280a 2020 2020 2020 2020 2020  rect(.          
+00002790: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+000027a0: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+000027b0: 2020 783d 2278 222c 0a20 2020 2020 2020    x="x",.       
+000027c0: 2020 2020 2079 3d22 7922 2c0a 2020 2020       y="y",.    
+000027d0: 2020 2020 2020 2020 7769 6474 683d 2277          width="w
+000027e0: 6964 7468 222c 0a20 2020 2020 2020 2020  idth",.         
+000027f0: 2020 2068 6569 6768 743d 302e 392c 0a20     height=0.9,. 
+00002800: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00002810: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
+00002820: 2020 2020 2020 616c 7068 613d 2261 6c70        alpha="alp
+00002830: 6861 222c 0a20 2020 2020 2020 2029 0a20  ha",.        ). 
+00002840: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
+00002850: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
+00002860: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
+00002870: 656c 662e 726f 6f74 2e61 7869 735b 305d  elf.root.axis[0]
+00002880: 2e74 6963 6b65 7220 3d20 4261 7369 6354  .ticker = BasicT
+00002890: 6963 6b65 7228 2a2a 5449 434b 535f 3130  icker(**TICKS_10
+000028a0: 3234 290a 2020 2020 2020 2020 7365 6c66  24).        self
+000028b0: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
+000028c0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
+000028d0: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
+000028e0: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
+000028f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00002900: 742e 7861 7869 732e 6d61 6a6f 725f 6c61  t.xaxis.major_la
+00002910: 6265 6c5f 6f72 6965 6e74 6174 696f 6e20  bel_orientation 
+00002920: 3d20 584c 4142 454c 5f4f 5249 454e 5441  = XLABEL_ORIENTA
+00002930: 5449 4f4e 0a20 2020 2020 2020 2073 656c  TION.        sel
+00002940: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
+00002950: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+00002960: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+00002970: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
+00002980: 203d 2052 616e 6765 3164 2873 7461 7274   = Range1d(start
+00002990: 3d30 290a 2020 2020 2020 2020 7365 6c66  =0).        self
+000029a0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
+000029b0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+000029c0: 2020 2020 7365 6c66 2e72 6f6f 742e 7967      self.root.yg
+000029d0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+000029e0: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
+000029f0: 662e 726f 6f74 2e74 6f6f 6c62 6172 5f6c  f.root.toolbar_l
+00002a00: 6f63 6174 696f 6e20 3d20 2261 626f 7665  ocation = "above
+00002a10: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
+00002a20: 6f6f 742e 7961 7869 732e 7669 7369 626c  oot.yaxis.visibl
+00002a30: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+00002a40: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
+00002a50: 546f 6f6c 280a 2020 2020 2020 2020 2020  Tool(.          
+00002a60: 2020 706f 696e 745f 706f 6c69 6379 3d22    point_policy="
+00002a70: 666f 6c6c 6f77 5f6d 6f75 7365 222c 0a20  follow_mouse",. 
+00002a80: 2020 2020 2020 2020 2020 2074 6f6f 6c74             toolt
+00002a90: 6970 733d 2222 220a 2020 2020 2020 2020  ips=""".        
+00002aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ab0: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
+00002ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ad0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00002ae0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00002af0: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
+00002b00: 6768 743a 2062 6f6c 643b 223e 5072 6f63  ght: bold;">Proc
+00002b10: 6573 7320 6d65 6d6f 7279 2028 5253 5329  ess memory (RSS)
+00002b20: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
+00002b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b40: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00002b50: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+00002b60: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
+00002b70: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
+00002b80: 2c20 6d6f 6e6f 7370 6163 653b 223e 4070  , monospace;">@p
+00002b90: 726f 635f 6d65 6d6f 7279 7b30 2e30 3020  roc_memory{0.00 
+00002ba0: 627d 3c2f 7370 616e 3e0a 2020 2020 2020  b}</span>.      
+00002bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002bc0: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+00002bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002be0: 2020 2020 2020 2020 203c 6469 7620 7374           <div st
+00002bf0: 796c 653d 226d 6172 6769 6e2d 6c65 6674  yle="margin-left
+00002c00: 3a20 3165 6d3b 223e 0a20 2020 2020 2020  : 1em;">.       
+00002c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c20: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+00002c30: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+00002c40: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
+00002c50: 6874 3a20 626f 6c64 3b22 3e4d 616e 6167  ht: bold;">Manag
+00002c60: 6564 3a3c 2f73 7061 6e3e 266e 6273 703b  ed:</span>&nbsp;
+00002c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c90: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00002ca0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+00002cb0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+00002cc0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00002cd0: 406d 616e 6167 6564 7b30 2e30 3020 627d  @managed{0.00 b}
+00002ce0: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
+00002cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d00: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
 00002d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00002d30: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00002d40: 2d73 697a 653a 2031 3270 783b 2066 6f6e  -size: 12px; fon
-00002d50: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-00002d60: 3e55 6e6d 616e 6167 6564 2028 6f6c 6429  >Unmanaged (old)
-00002d70: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-00002d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d90: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00002da0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00002db0: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-00002dc0: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-00002dd0: 2c20 6d6f 6e6f 7370 6163 653b 223e 4075  , monospace;">@u
-00002de0: 6e6d 616e 6167 6564 5f6f 6c64 7b30 2e30  nmanaged_old{0.0
-00002df0: 3020 627d 3c2f 7370 616e 3e0a 2020 2020  0 b}</span>.    
-00002e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e10: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-00002e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e30: 2020 2020 2020 2020 2020 203c 6469 7620             <div 
-00002e40: 7374 796c 653d 226d 6172 6769 6e2d 6c65  style="margin-le
-00002e50: 6674 3a20 3165 6d3b 223e 0a20 2020 2020  ft: 1em;">.     
+00002d20: 2020 2020 2020 203c 6469 7620 7374 796c         <div styl
+00002d30: 653d 226d 6172 6769 6e2d 6c65 6674 3a20  e="margin-left: 
+00002d40: 3165 6d3b 223e 0a20 2020 2020 2020 2020  1em;">.         
+00002d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d60: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00002d70: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00002d80: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
+00002d90: 3a20 626f 6c64 3b22 3e55 6e6d 616e 6167  : bold;">Unmanag
+00002da0: 6564 2028 6f6c 6429 3a3c 2f73 7061 6e3e  ed (old):</span>
+00002db0: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
+00002dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002dd0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00002de0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00002df0: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+00002e00: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+00002e10: 6163 653b 223e 4075 6e6d 616e 6167 6564  ace;">@unmanaged
+00002e20: 5f6f 6c64 7b30 2e30 3020 627d 3c2f 7370  _old{0.00 b}</sp
+00002e30: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
+00002e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e50: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
 00002e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e70: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00002e80: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00002e90: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-00002ea0: 6967 6874 3a20 626f 6c64 3b22 3e55 6e6d  ight: bold;">Unm
-00002eb0: 616e 6167 6564 2028 7265 6365 6e74 293a  anaged (recent):
-00002ec0: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
-00002ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ee0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-00002ef0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-00002f00: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-00002f10: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-00002f20: 206d 6f6e 6f73 7061 6365 3b22 3e40 756e   monospace;">@un
-00002f30: 6d61 6e61 6765 645f 7265 6365 6e74 7b30  managed_recent{0
-00002f40: 2e30 3020 627d 3c2f 7370 616e 3e0a 2020  .00 b}</span>.  
-00002f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f60: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-00002f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002f80: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-00002f90: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00002fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fb0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00002fc0: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00002fd0: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00002fe0: 6c64 3b22 3e53 7069 6c6c 6564 2074 6f20  ld;">Spilled to 
-00002ff0: 6469 736b 3a3c 2f73 7061 6e3e 266e 6273  disk:</span>&nbs
-00003000: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-00003010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003020: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00003030: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-00003040: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-00003050: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-00003060: 223e 4073 7069 6c6c 6564 7b30 2e30 3020  ">@spilled{0.00 
-00003070: 627d 3c2f 7370 616e 3e0a 2020 2020 2020  b}</span>.      
-00003080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003090: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
-000030a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030b0: 2020 2020 2020 2020 2022 2222 2c0a 2020           """,.  
-000030c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000030d0: 6865 6c70 5f20 3d20 4865 6c70 546f 6f6c  help_ = HelpTool
-000030e0: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
-000030f0: 6469 7265 6374 3d22 6874 7470 733a 2f2f  direct="https://
-00003100: 646f 6373 2e64 6173 6b2e 6f72 672f 656e  docs.dask.org/en
-00003110: 2f73 7461 626c 652f 6461 7368 626f 6172  /stable/dashboar
-00003120: 642e 6874 6d6c 2362 7974 6573 2d73 746f  d.html#bytes-sto
-00003130: 7265 642d 616e 642d 6279 7465 732d 7065  red-and-bytes-pe
-00003140: 722d 776f 726b 6572 222c 0a20 2020 2020  r-worker",.     
-00003150: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-00003160: 6f6e 3d22 4465 7363 7269 7074 696f 6e20  on="Description 
-00003170: 6f66 2062 7974 6573 2073 746f 7265 6420  of bytes stored 
-00003180: 706c 6f74 7322 2c0a 2020 2020 2020 2020  plots",.        
-00003190: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-000031a0: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
-000031b0: 7665 722c 2068 656c 705f 290a 0a20 2020  ver, help_)..   
-000031c0: 2064 6566 205f 636c 7573 7465 725f 6d65   def _cluster_me
-000031d0: 6d6f 7279 5f63 6f6c 6f72 2873 656c 6629  mory_color(self)
-000031e0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-000031f0: 2063 6f6c 6f72 7320 3d20 7b0a 2020 2020   colors = {.    
-00003200: 2020 2020 2020 2020 7365 6c66 2e5f 6d65          self._me
-00003210: 6d6f 7279 5f63 6f6c 6f72 280a 2020 2020  mory_color(.    
-00003220: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-00003230: 656e 743d 7773 2e6d 656d 6f72 792e 7072  ent=ws.memory.pr
-00003240: 6f63 6573 732c 0a20 2020 2020 2020 2020  ocess,.         
-00003250: 2020 2020 2020 206c 696d 6974 3d67 6574         limit=get
-00003260: 6174 7472 2877 732c 2022 6d65 6d6f 7279  attr(ws, "memory
-00003270: 5f6c 696d 6974 222c 2030 292c 0a20 2020  _limit", 0),.   
-00003280: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00003290: 7475 733d 7773 2e73 7461 7475 732c 0a20  tus=ws.status,. 
-000032a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000032b0: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
-000032c0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
-000032d0: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
-000032e0: 2829 0a20 2020 2020 2020 207d 0a0a 2020  ().        }..  
-000032f0: 2020 2020 2020 6173 7365 7274 2063 6f6c        assert col
-00003300: 6f72 732e 6973 7375 6273 6574 287b 2272  ors.issubset({"r
-00003310: 6564 222c 2022 6f72 616e 6765 222c 2022  ed", "orange", "
-00003320: 626c 7565 227d 290a 2020 2020 2020 2020  blue"}).        
-00003330: 6966 2022 7265 6422 2069 6e20 636f 6c6f  if "red" in colo
-00003340: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00003350: 7265 7475 726e 2022 7265 6422 0a20 2020  return "red".   
-00003360: 2020 2020 2065 6c69 6620 226f 7261 6e67       elif "orang
-00003370: 6522 2069 6e20 636f 6c6f 7273 3a0a 2020  e" in colors:.  
-00003380: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00003390: 2022 6f72 616e 6765 220a 2020 2020 2020   "orange".      
-000033a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000033b0: 2020 2020 7265 7475 726e 2022 626c 7565      return "blue
-000033c0: 220a 0a20 2020 2040 7769 7468 6f75 745f  "..    @without_
-000033d0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-000033e0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-000033f0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-00003400: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-00003410: 2020 6c69 6d69 7420 3d20 7375 6d28 7773    limit = sum(ws
-00003420: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
-00003430: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
-00003440: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
-00003450: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
-00003460: 206d 656d 696e 666f 203d 2073 656c 662e   meminfo = self.
-00003470: 7363 6865 6475 6c65 722e 6d65 6d6f 7279  scheduler.memory
-00003480: 0a20 2020 2020 2020 2063 6f6c 6f72 203d  .        color =
-00003490: 2073 656c 662e 5f63 6c75 7374 6572 5f6d   self._cluster_m
-000034a0: 656d 6f72 795f 636f 6c6f 7228 290a 0a20  emory_color().. 
-000034b0: 2020 2020 2020 2077 6964 7468 203d 205b         width = [
-000034c0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-000034d0: 696e 666f 2e6d 616e 6167 6564 2c0a 2020  info.managed,.  
-000034e0: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
-000034f0: 6f2e 756e 6d61 6e61 6765 645f 6f6c 642c  o.unmanaged_old,
-00003500: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-00003510: 696e 666f 2e75 6e6d 616e 6167 6564 5f72  info.unmanaged_r
-00003520: 6563 656e 742c 0a20 2020 2020 2020 2020  ecent,.         
-00003530: 2020 206d 656d 696e 666f 2e73 7069 6c6c     meminfo.spill
-00003540: 6564 2c0a 2020 2020 2020 2020 5d0a 0a20  ed,.        ].. 
-00003550: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00003560: 7b0a 2020 2020 2020 2020 2020 2020 2277  {.            "w
-00003570: 6964 7468 223a 2077 6964 7468 2c0a 2020  idth": width,.  
-00003580: 2020 2020 2020 2020 2020 2278 223a 205b            "x": [
-00003590: 7375 6d28 7769 6474 685b 3a69 5d29 202b  sum(width[:i]) +
-000035a0: 2077 202f 2032 2066 6f72 2069 2c20 7720   w / 2 for i, w 
-000035b0: 696e 2065 6e75 6d65 7261 7465 2877 6964  in enumerate(wid
-000035c0: 7468 295d 2c0a 2020 2020 2020 2020 2020  th)],.          
-000035d0: 2020 2263 6f6c 6f72 223a 205b 636f 6c6f    "color": [colo
-000035e0: 722c 2063 6f6c 6f72 2c20 636f 6c6f 722c  r, color, color,
-000035f0: 2022 6772 6579 225d 2c0a 2020 2020 2020   "grey"],.      
-00003600: 2020 2020 2020 2270 726f 635f 6d65 6d6f        "proc_memo
-00003610: 7279 223a 205b 6d65 6d69 6e66 6f2e 7072  ry": [meminfo.pr
-00003620: 6f63 6573 735d 202a 2034 2c0a 2020 2020  ocess] * 4,.    
-00003630: 2020 2020 2020 2020 226d 616e 6167 6564          "managed
-00003640: 223a 205b 6d65 6d69 6e66 6f2e 6d61 6e61  ": [meminfo.mana
-00003650: 6765 645d 202a 2034 2c0a 2020 2020 2020  ged] * 4,.      
-00003660: 2020 2020 2020 2275 6e6d 616e 6167 6564        "unmanaged
-00003670: 5f6f 6c64 223a 205b 6d65 6d69 6e66 6f2e  _old": [meminfo.
-00003680: 756e 6d61 6e61 6765 645f 6f6c 645d 202a  unmanaged_old] *
-00003690: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
-000036a0: 2275 6e6d 616e 6167 6564 5f72 6563 656e  "unmanaged_recen
-000036b0: 7422 3a20 5b6d 656d 696e 666f 2e75 6e6d  t": [meminfo.unm
-000036c0: 616e 6167 6564 5f72 6563 656e 745d 202a  anaged_recent] *
-000036d0: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
-000036e0: 2273 7069 6c6c 6564 223a 205b 6d65 6d69  "spilled": [memi
-000036f0: 6e66 6f2e 7370 696c 6c65 645d 202a 2034  nfo.spilled] * 4
-00003700: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-00003710: 2020 2020 2078 5f65 6e64 203d 206d 6178       x_end = max
-00003720: 286c 696d 6974 2c20 6d65 6d69 6e66 6f2e  (limit, meminfo.
-00003730: 7072 6f63 6573 7320 2b20 6d65 6d69 6e66  process + meminf
-00003740: 6f2e 7370 696c 6c65 6429 0a20 2020 2020  o.spilled).     
-00003750: 2020 2073 656c 662e 726f 6f74 2e78 5f72     self.root.x_r
-00003760: 616e 6765 2e65 6e64 203d 2078 5f65 6e64  ange.end = x_end
-00003770: 0a0a 2020 2020 2020 2020 7469 746c 6520  ..        title 
-00003780: 3d20 6622 4279 7465 7320 7374 6f72 6564  = f"Bytes stored
-00003790: 3a20 7b66 6f72 6d61 745f 6279 7465 7328  : {format_bytes(
-000037a0: 6d65 6d69 6e66 6f2e 7072 6f63 6573 7329  meminfo.process)
-000037b0: 7d22 0a20 2020 2020 2020 2069 6620 6d65  }".        if me
-000037c0: 6d69 6e66 6f2e 7370 696c 6c65 643a 0a20  minfo.spilled:. 
-000037d0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-000037e0: 202b 3d20 6622 202b 207b 666f 726d 6174   += f" + {format
-000037f0: 5f62 7974 6573 286d 656d 696e 666f 2e73  _bytes(meminfo.s
-00003800: 7069 6c6c 6564 297d 2073 7069 6c6c 6564  pilled)} spilled
-00003810: 2074 6f20 6469 736b 220a 2020 2020 2020   to disk".      
-00003820: 2020 7365 6c66 2e72 6f6f 742e 7469 746c    self.root.titl
-00003830: 652e 7465 7874 203d 2074 6974 6c65 0a0a  e.text = title..
-00003840: 2020 2020 2020 2020 7570 6461 7465 2873          update(s
-00003850: 656c 662e 736f 7572 6365 2c20 7265 7375  elf.source, resu
-00003860: 6c74 290a 0a0a 636c 6173 7320 576f 726b  lt)...class Work
-00003870: 6572 734d 656d 6f72 7928 4461 7368 626f  ersMemory(Dashbo
-00003880: 6172 6443 6f6d 706f 6e65 6e74 2c20 4d65  ardComponent, Me
-00003890: 6d6f 7279 436f 6c6f 7229 3a0a 2020 2020  moryColor):.    
-000038a0: 2222 224d 656d 6f72 7920 7573 6167 6520  """Memory usage 
-000038b0: 666f 7220 7369 6e67 6c65 2077 6f72 6b65  for single worke
-000038c0: 7273 2222 220a 0a20 2020 2040 6c6f 675f  rs"""..    @log_
-000038d0: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
-000038e0: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
-000038f0: 6865 6475 6c65 722c 2077 6964 7468 3d36  heduler, width=6
-00003900: 3030 2c20 2a2a 6b77 6172 6773 293a 0a20  00, **kwargs):. 
-00003910: 2020 2020 2020 2044 6173 6862 6f61 7264         Dashboard
-00003920: 436f 6d70 6f6e 656e 742e 5f5f 696e 6974  Component.__init
-00003930: 5f5f 2873 656c 6629 0a20 2020 2020 2020  __(self).       
-00003940: 204d 656d 6f72 7943 6f6c 6f72 2e5f 5f69   MemoryColor.__i
-00003950: 6e69 745f 5f28 7365 6c66 290a 0a20 2020  nit__(self)..   
-00003960: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00003970: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-00003980: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-00003990: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-000039a0: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
-000039b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000039c0: 2020 2020 2020 2277 6964 7468 223a 205b        "width": [
-000039d0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000039e0: 2020 2022 7822 3a20 5b5d 2c0a 2020 2020     "x": [],.    
-000039f0: 2020 2020 2020 2020 2020 2020 2279 223a              "y":
-00003a00: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00003a10: 2020 2020 2022 636f 6c6f 7222 3a20 5b5d       "color": []
-00003a20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003a30: 2020 2261 6c70 6861 223a 205b 5d2c 0a20    "alpha": [],. 
-00003a40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00003a50: 776f 726b 6572 223a 205b 5d2c 0a20 2020  worker": [],.   
-00003a60: 2020 2020 2020 2020 2020 2020 2022 6573               "es
-00003a70: 6361 7065 645f 776f 726b 6572 223a 205b  caped_worker": [
-00003a80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00003a90: 2020 2022 7072 6f63 5f6d 656d 6f72 7922     "proc_memory"
-00003aa0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00003ab0: 2020 2020 2020 226d 616e 6167 6564 223a        "managed":
-00003ac0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00003ad0: 2020 2020 2022 756e 6d61 6e61 6765 645f       "unmanaged_
-00003ae0: 6f6c 6422 3a20 5b5d 2c0a 2020 2020 2020  old": [],.      
-00003af0: 2020 2020 2020 2020 2020 2275 6e6d 616e            "unman
-00003b00: 6167 6564 5f72 6563 656e 7422 3a20 5b5d  aged_recent": []
-00003b10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003b20: 2020 2273 7069 6c6c 6564 223a 205b 5d2c    "spilled": [],
-00003b30: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00003b40: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00003b50: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-00003b60: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00003b70: 2020 7469 746c 653d 2242 7974 6573 2073    title="Bytes s
-00003b80: 746f 7265 6420 7065 7220 776f 726b 6572  tored per worker
-00003b90: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-00003ba0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-00003bb0: 2020 2020 2077 6964 7468 3d69 6e74 2877       width=int(w
-00003bc0: 6964 7468 202f 2032 292c 0a20 2020 2020  idth / 2),.     
-00003bd0: 2020 2020 2020 206e 616d 653d 2277 6f72         name="wor
-00003be0: 6b65 7273 5f6d 656d 6f72 7922 2c0a 2020  kers_memory",.  
-00003bf0: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
-00003c00: 7264 6572 5f62 6f74 746f 6d3d 3530 2c0a  rder_bottom=50,.
-00003c10: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-00003c20: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-00003c30: 2020 2020 2020 2020 7265 6374 203d 2073          rect = s
-00003c40: 656c 662e 726f 6f74 2e72 6563 7428 0a20  elf.root.rect(. 
-00003c50: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00003c60: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-00003c70: 2020 2020 2020 2020 2020 2078 3d22 7822             x="x"
-00003c80: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
-00003c90: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
-00003ca0: 2077 6964 7468 3d22 7769 6474 6822 2c0a   width="width",.
-00003cb0: 2020 2020 2020 2020 2020 2020 6865 6967              heig
-00003cc0: 6874 3d30 2e39 2c0a 2020 2020 2020 2020  ht=0.9,.        
-00003cd0: 2020 2020 636f 6c6f 723d 2263 6f6c 6f72      color="color
-00003ce0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-00003cf0: 696c 6c5f 616c 7068 613d 2261 6c70 6861  ill_alpha="alpha
-00003d00: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
-00003d10: 696e 655f 7769 6474 683d 302c 0a20 2020  ine_width=0,.   
-00003d20: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00003d30: 6563 742e 6e6f 6e73 656c 6563 7469 6f6e  ect.nonselection
-00003d40: 5f67 6c79 7068 203d 204e 6f6e 650a 0a20  _glyph = None.. 
-00003d50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00003d60: 2e61 7869 735b 305d 2e74 6963 6b65 7220  .axis[0].ticker 
-00003d70: 3d20 4261 7369 6354 6963 6b65 7228 2a2a  = BasicTicker(**
-00003d80: 5449 434b 535f 3130 3234 290a 2020 2020  TICKS_1024).    
-00003d90: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00003da0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-00003db0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-00003dc0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-00003dd0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
-00003de0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-00003df0: 6d61 6a6f 725f 6c61 6265 6c5f 6f72 6965  major_label_orie
-00003e00: 6e74 6174 696f 6e20 3d20 584c 4142 454c  ntation = XLABEL
-00003e10: 5f4f 5249 454e 5441 5449 4f4e 0a20 2020  _ORIENTATION.   
-00003e20: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
-00003e30: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-00003e40: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-00003e50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00003e60: 2e78 5f72 616e 6765 203d 2052 616e 6765  .x_range = Range
-00003e70: 3164 2873 7461 7274 3d30 290a 2020 2020  1d(start=0).    
-00003e80: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
-00003e90: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-00003ea0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00003eb0: 2e72 6f6f 742e 7967 7269 642e 7669 7369  .root.ygrid.visi
-00003ec0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00003ed0: 2020 2020 7365 6c66 2e72 6f6f 742e 746f      self.root.to
-00003ee0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 203d  olbar_location =
-00003ef0: 204e 6f6e 650a 0a20 2020 2020 2020 2074   None..        t
-00003f00: 6170 203d 2054 6170 546f 6f6c 2863 616c  ap = TapTool(cal
-00003f10: 6c62 6163 6b3d 4f70 656e 5552 4c28 7572  lback=OpenURL(ur
-00003f20: 6c3d 222e 2f69 6e66 6f2f 776f 726b 6572  l="./info/worker
-00003f30: 2f40 6573 6361 7065 645f 776f 726b 6572  /@escaped_worker
-00003f40: 2e68 746d 6c22 2929 0a20 2020 2020 2020  .html")).       
-00003f50: 2073 656c 662e 726f 6f74 2e61 6464 5f74   self.root.add_t
-00003f60: 6f6f 6c73 2874 6170 290a 0a20 2020 2020  ools(tap)..     
-00003f70: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
-00003f80: 546f 6f6c 280a 2020 2020 2020 2020 2020  Tool(.          
-00003f90: 2020 706f 696e 745f 706f 6c69 6379 3d22    point_policy="
-00003fa0: 666f 6c6c 6f77 5f6d 6f75 7365 222c 0a20  follow_mouse",. 
-00003fb0: 2020 2020 2020 2020 2020 2074 6f6f 6c74             toolt
-00003fc0: 6970 733d 2222 220a 2020 2020 2020 2020  ips=""".        
-00003fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003fe0: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
-00003ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004000: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00004010: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00004020: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
-00004030: 6768 743a 2062 6f6c 643b 223e 576f 726b  ght: bold;">Work
-00004040: 6572 3a3c 2f73 7061 6e3e 266e 6273 703b  er:</span>&nbsp;
-00004050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004070: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00004080: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-00004090: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-000040a0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-000040b0: 4077 6f72 6b65 723c 2f73 7061 6e3e 0a20  @worker</span>. 
-000040c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040d0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
-000040e0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000040f0: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
-00004100: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
-00004110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004120: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-00004130: 2266 6f6e 742d 7369 7a65 3a20 3132 7078  "font-size: 12px
-00004140: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
-00004150: 6f6c 643b 223e 5072 6f63 6573 7320 6d65  old;">Process me
-00004160: 6d6f 7279 2028 5253 5329 3a3c 2f73 7061  mory (RSS):</spa
-00004170: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-00004180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004190: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-000041a0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-000041b0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-000041c0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-000041d0: 7370 6163 653b 223e 4070 726f 635f 6d65  space;">@proc_me
-000041e0: 6d6f 7279 7b30 2e30 3020 627d 3c2f 7370  mory{0.00 b}</sp
-000041f0: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-00004200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004210: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-00004220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004230: 2020 203c 6469 7620 7374 796c 653d 226d     <div style="m
-00004240: 6172 6769 6e2d 6c65 6674 3a20 3165 6d3b  argin-left: 1em;
-00004250: 223e 0a20 2020 2020 2020 2020 2020 2020  ">.             
-00004260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004270: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00004280: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00004290: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-000042a0: 6c64 3b22 3e4d 616e 6167 6564 3a3c 2f73  ld;">Managed:</s
-000042b0: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
-000042c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042d0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-000042e0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-000042f0: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
-00004300: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
-00004310: 6e6f 7370 6163 653b 223e 406d 616e 6167  nospace;">@manag
-00004320: 6564 7b30 2e30 3020 627d 3c2f 7370 616e  ed{0.00 b}</span
-00004330: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00004340: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-00004350: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-00004360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004370: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
-00004380: 6769 6e2d 6c65 6674 3a20 3165 6d3b 223e  gin-left: 1em;">
-00004390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000043a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043b0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-000043c0: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
-000043d0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-000043e0: 3b22 3e55 6e6d 616e 6167 6564 2028 6f6c  ;">Unmanaged (ol
-000043f0: 6429 3a3c 2f73 7061 6e3e 266e 6273 703b  d):</span>&nbsp;
-00004400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004420: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00004430: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-00004440: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-00004450: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-00004460: 4075 6e6d 616e 6167 6564 5f6f 6c64 7b30  @unmanaged_old{0
-00004470: 2e30 3020 627d 3c2f 7370 616e 3e0a 2020  .00 b}</span>.  
-00004480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004490: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-000044a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000044b0: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-000044c0: 7620 7374 796c 653d 226d 6172 6769 6e2d  v style="margin-
-000044d0: 6c65 6674 3a20 3165 6d3b 223e 0a20 2020  left: 1em;">.   
+00002e70: 2020 203c 6469 7620 7374 796c 653d 226d     <div style="m
+00002e80: 6172 6769 6e2d 6c65 6674 3a20 3165 6d3b  argin-left: 1em;
+00002e90: 223e 0a20 2020 2020 2020 2020 2020 2020  ">.             
+00002ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002eb0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+00002ec0: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
+00002ed0: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
+00002ee0: 6c64 3b22 3e55 6e6d 616e 6167 6564 2028  ld;">Unmanaged (
+00002ef0: 7265 6365 6e74 293a 3c2f 7370 616e 3e26  recent):</span>&
+00002f00: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+00002f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f20: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00002f30: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+00002f40: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+00002f50: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+00002f60: 6365 3b22 3e40 756e 6d61 6e61 6765 645f  ce;">@unmanaged_
+00002f70: 7265 6365 6e74 7b30 2e30 3020 627d 3c2f  recent{0.00 b}</
+00002f80: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
+00002f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fa0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+00002fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fc0: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+00002fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fe0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00002ff0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00003000: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
+00003010: 6967 6874 3a20 626f 6c64 3b22 3e53 7069  ight: bold;">Spi
+00003020: 6c6c 6564 2074 6f20 6469 736b 3a3c 2f73  lled to disk:</s
+00003030: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
+00003040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003050: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00003060: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00003070: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+00003080: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+00003090: 6e6f 7370 6163 653b 223e 4073 7069 6c6c  nospace;">@spill
+000030a0: 6564 7b30 2e30 3020 627d 3c2f 7370 616e  ed{0.00 b}</span
+000030b0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000030c0: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
+000030d0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+000030e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030f0: 2022 2222 2c0a 2020 2020 2020 2020 290a   """,.        ).
+00003100: 2020 2020 2020 2020 6865 6c70 5f20 3d20          help_ = 
+00003110: 4865 6c70 546f 6f6c 280a 2020 2020 2020  HelpTool(.      
+00003120: 2020 2020 2020 7265 6469 7265 6374 3d22        redirect="
+00003130: 6874 7470 733a 2f2f 646f 6373 2e64 6173  https://docs.das
+00003140: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
+00003150: 6461 7368 626f 6172 642e 6874 6d6c 2362  dashboard.html#b
+00003160: 7974 6573 2d73 746f 7265 642d 616e 642d  ytes-stored-and-
+00003170: 6279 7465 732d 7065 722d 776f 726b 6572  bytes-per-worker
+00003180: 222c 0a20 2020 2020 2020 2020 2020 2064  ",.            d
+00003190: 6573 6372 6970 7469 6f6e 3d22 4465 7363  escription="Desc
+000031a0: 7269 7074 696f 6e20 6f66 2062 7974 6573  ription of bytes
+000031b0: 2073 746f 7265 6420 706c 6f74 7322 2c0a   stored plots",.
+000031c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000031d0: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+000031e0: 746f 6f6c 7328 686f 7665 722c 2068 656c  tools(hover, hel
+000031f0: 705f 290a 0a20 2020 2064 6566 205f 636c  p_)..    def _cl
+00003200: 7573 7465 725f 6d65 6d6f 7279 5f63 6f6c  uster_memory_col
+00003210: 6f72 2873 656c 6629 202d 3e20 7374 723a  or(self) -> str:
+00003220: 0a20 2020 2020 2020 2063 6f6c 6f72 7320  .        colors 
+00003230: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00003240: 7365 6c66 2e5f 6d65 6d6f 7279 5f63 6f6c  self._memory_col
+00003250: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00003260: 2020 2020 6375 7272 656e 743d 7773 2e6d      current=ws.m
+00003270: 656d 6f72 792e 7072 6f63 6573 732c 0a20  emory.process,. 
+00003280: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00003290: 696d 6974 3d67 6574 6174 7472 2877 732c  imit=getattr(ws,
+000032a0: 2022 6d65 6d6f 7279 5f6c 696d 6974 222c   "memory_limit",
+000032b0: 2030 292c 0a20 2020 2020 2020 2020 2020   0),.           
+000032c0: 2020 2020 2073 7461 7475 733d 7773 2e73       status=ws.s
+000032d0: 7461 7475 732c 0a20 2020 2020 2020 2020  tatus,.         
+000032e0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000032f0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+00003300: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+00003310: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
+00003320: 2020 207d 0a0a 2020 2020 2020 2020 6173     }..        as
+00003330: 7365 7274 2063 6f6c 6f72 732e 6973 7375  sert colors.issu
+00003340: 6273 6574 287b 2272 6564 222c 2022 6f72  bset({"red", "or
+00003350: 616e 6765 222c 2022 626c 7565 227d 290a  ange", "blue"}).
+00003360: 2020 2020 2020 2020 6966 2022 7265 6422          if "red"
+00003370: 2069 6e20 636f 6c6f 7273 3a0a 2020 2020   in colors:.    
+00003380: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+00003390: 7265 6422 0a20 2020 2020 2020 2065 6c69  red".        eli
+000033a0: 6620 226f 7261 6e67 6522 2069 6e20 636f  f "orange" in co
+000033b0: 6c6f 7273 3a0a 2020 2020 2020 2020 2020  lors:.          
+000033c0: 2020 7265 7475 726e 2022 6f72 616e 6765    return "orange
+000033d0: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
+000033e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000033f0: 726e 2022 626c 7565 220a 0a20 2020 2040  rn "blue"..    @
+00003400: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+00003410: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
+00003420: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00003430: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
+00003440: 3a0a 2020 2020 2020 2020 6c69 6d69 7420  :.        limit 
+00003450: 3d20 7375 6d28 7773 2e6d 656d 6f72 795f  = sum(ws.memory_
+00003460: 6c69 6d69 7420 666f 7220 7773 2069 6e20  limit for ws in 
+00003470: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+00003480: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
+00003490: 0a20 2020 2020 2020 206d 656d 696e 666f  .        meminfo
+000034a0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+000034b0: 722e 6d65 6d6f 7279 0a20 2020 2020 2020  r.memory.       
+000034c0: 2063 6f6c 6f72 203d 2073 656c 662e 5f63   color = self._c
+000034d0: 6c75 7374 6572 5f6d 656d 6f72 795f 636f  luster_memory_co
+000034e0: 6c6f 7228 290a 0a20 2020 2020 2020 2077  lor()..        w
+000034f0: 6964 7468 203d 205b 0a20 2020 2020 2020  idth = [.       
+00003500: 2020 2020 206d 656d 696e 666f 2e6d 616e       meminfo.man
+00003510: 6167 6564 2c0a 2020 2020 2020 2020 2020  aged,.          
+00003520: 2020 6d65 6d69 6e66 6f2e 756e 6d61 6e61    meminfo.unmana
+00003530: 6765 645f 6f6c 642c 0a20 2020 2020 2020  ged_old,.       
+00003540: 2020 2020 206d 656d 696e 666f 2e75 6e6d       meminfo.unm
+00003550: 616e 6167 6564 5f72 6563 656e 742c 0a20  anaged_recent,. 
+00003560: 2020 2020 2020 2020 2020 206d 656d 696e             memin
+00003570: 666f 2e73 7069 6c6c 6564 2c0a 2020 2020  fo.spilled,.    
+00003580: 2020 2020 5d0a 0a20 2020 2020 2020 2072      ]..        r
+00003590: 6573 756c 7420 3d20 7b0a 2020 2020 2020  esult = {.      
+000035a0: 2020 2020 2020 2277 6964 7468 223a 2077        "width": w
+000035b0: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
+000035c0: 2020 2278 223a 205b 7375 6d28 7769 6474    "x": [sum(widt
+000035d0: 685b 3a69 5d29 202b 2077 202f 2032 2066  h[:i]) + w / 2 f
+000035e0: 6f72 2069 2c20 7720 696e 2065 6e75 6d65  or i, w in enume
+000035f0: 7261 7465 2877 6964 7468 295d 2c0a 2020  rate(width)],.  
+00003600: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
+00003610: 223a 205b 636f 6c6f 722c 2063 6f6c 6f72  ": [color, color
+00003620: 2c20 636f 6c6f 722c 2022 6772 6579 225d  , color, "grey"]
+00003630: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+00003640: 726f 635f 6d65 6d6f 7279 223a 205b 6d65  roc_memory": [me
+00003650: 6d69 6e66 6f2e 7072 6f63 6573 735d 202a  minfo.process] *
+00003660: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
+00003670: 226d 616e 6167 6564 223a 205b 6d65 6d69  "managed": [memi
+00003680: 6e66 6f2e 6d61 6e61 6765 645d 202a 2034  nfo.managed] * 4
+00003690: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+000036a0: 6e6d 616e 6167 6564 5f6f 6c64 223a 205b  nmanaged_old": [
+000036b0: 6d65 6d69 6e66 6f2e 756e 6d61 6e61 6765  meminfo.unmanage
+000036c0: 645f 6f6c 645d 202a 2034 2c0a 2020 2020  d_old] * 4,.    
+000036d0: 2020 2020 2020 2020 2275 6e6d 616e 6167          "unmanag
+000036e0: 6564 5f72 6563 656e 7422 3a20 5b6d 656d  ed_recent": [mem
+000036f0: 696e 666f 2e75 6e6d 616e 6167 6564 5f72  info.unmanaged_r
+00003700: 6563 656e 745d 202a 2034 2c0a 2020 2020  ecent] * 4,.    
+00003710: 2020 2020 2020 2020 2273 7069 6c6c 6564          "spilled
+00003720: 223a 205b 6d65 6d69 6e66 6f2e 7370 696c  ": [meminfo.spil
+00003730: 6c65 645d 202a 2034 2c0a 2020 2020 2020  led] * 4,.      
+00003740: 2020 7d0a 0a20 2020 2020 2020 2078 5f65    }..        x_e
+00003750: 6e64 203d 206d 6178 286c 696d 6974 2c20  nd = max(limit, 
+00003760: 6d65 6d69 6e66 6f2e 7072 6f63 6573 7320  meminfo.process 
+00003770: 2b20 6d65 6d69 6e66 6f2e 7370 696c 6c65  + meminfo.spille
+00003780: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+00003790: 726f 6f74 2e78 5f72 616e 6765 2e65 6e64  root.x_range.end
+000037a0: 203d 2078 5f65 6e64 0a0a 2020 2020 2020   = x_end..      
+000037b0: 2020 7469 746c 6520 3d20 6622 4279 7465    title = f"Byte
+000037c0: 7320 7374 6f72 6564 3a20 7b66 6f72 6d61  s stored: {forma
+000037d0: 745f 6279 7465 7328 6d65 6d69 6e66 6f2e  t_bytes(meminfo.
+000037e0: 7072 6f63 6573 7329 7d22 0a20 2020 2020  process)}".     
+000037f0: 2020 2069 6620 6d65 6d69 6e66 6f2e 7370     if meminfo.sp
+00003800: 696c 6c65 643a 0a20 2020 2020 2020 2020  illed:.         
+00003810: 2020 2074 6974 6c65 202b 3d20 6622 202b     title += f" +
+00003820: 207b 666f 726d 6174 5f62 7974 6573 286d   {format_bytes(m
+00003830: 656d 696e 666f 2e73 7069 6c6c 6564 297d  eminfo.spilled)}
+00003840: 2073 7069 6c6c 6564 2074 6f20 6469 736b   spilled to disk
+00003850: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
+00003860: 6f6f 742e 7469 746c 652e 7465 7874 203d  oot.title.text =
+00003870: 2074 6974 6c65 0a0a 2020 2020 2020 2020   title..        
+00003880: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
+00003890: 6365 2c20 7265 7375 6c74 290a 0a0a 636c  ce, result)...cl
+000038a0: 6173 7320 576f 726b 6572 734d 656d 6f72  ass WorkersMemor
+000038b0: 7928 4461 7368 626f 6172 6443 6f6d 706f  y(DashboardCompo
+000038c0: 6e65 6e74 2c20 4d65 6d6f 7279 436f 6c6f  nent, MemoryColo
+000038d0: 7229 3a0a 2020 2020 2222 224d 656d 6f72  r):.    """Memor
+000038e0: 7920 7573 6167 6520 666f 7220 7369 6e67  y usage for sing
+000038f0: 6c65 2077 6f72 6b65 7273 2222 220a 0a20  le workers""".. 
+00003900: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+00003910: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00003920: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
+00003930: 2077 6964 7468 3d36 3030 2c20 2a2a 6b77   width=600, **kw
+00003940: 6172 6773 293a 0a20 2020 2020 2020 2044  args):.        D
+00003950: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
+00003960: 742e 5f5f 696e 6974 5f5f 2873 656c 6629  t.__init__(self)
+00003970: 0a20 2020 2020 2020 204d 656d 6f72 7943  .        MemoryC
+00003980: 6f6c 6f72 2e5f 5f69 6e69 745f 5f28 7365  olor.__init__(se
+00003990: 6c66 290a 0a20 2020 2020 2020 2073 656c  lf)..        sel
+000039a0: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+000039b0: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+000039c0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
+000039d0: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
+000039e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000039f0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
+00003a00: 6964 7468 223a 205b 5d2c 0a20 2020 2020  idth": [],.     
+00003a10: 2020 2020 2020 2020 2020 2022 7822 3a20             "x": 
+00003a20: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00003a30: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
+00003a40: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+00003a50: 6c6f 7222 3a20 5b5d 2c0a 2020 2020 2020  lor": [],.      
+00003a60: 2020 2020 2020 2020 2020 2261 6c70 6861            "alpha
+00003a70: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00003a80: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
+00003a90: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00003aa0: 2020 2020 2022 6573 6361 7065 645f 776f       "escaped_wo
+00003ab0: 726b 6572 223a 205b 5d2c 0a20 2020 2020  rker": [],.     
+00003ac0: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
+00003ad0: 5f6d 656d 6f72 7922 3a20 5b5d 2c0a 2020  _memory": [],.  
+00003ae0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+00003af0: 616e 6167 6564 223a 205b 5d2c 0a20 2020  anaged": [],.   
+00003b00: 2020 2020 2020 2020 2020 2020 2022 756e               "un
+00003b10: 6d61 6e61 6765 645f 6f6c 6422 3a20 5b5d  managed_old": []
+00003b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003b30: 2020 2275 6e6d 616e 6167 6564 5f72 6563    "unmanaged_rec
+00003b40: 656e 7422 3a20 5b5d 2c0a 2020 2020 2020  ent": [],.      
+00003b50: 2020 2020 2020 2020 2020 2273 7069 6c6c            "spill
+00003b60: 6564 223a 205b 5d2c 0a20 2020 2020 2020  ed": [],.       
+00003b70: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
+00003b80: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00003b90: 6f6f 7420 3d20 6669 6775 7265 280a 2020  oot = figure(.  
+00003ba0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+00003bb0: 2242 7974 6573 2073 746f 7265 6420 7065  "Bytes stored pe
+00003bc0: 7220 776f 726b 6572 222c 0a20 2020 2020  r worker",.     
+00003bd0: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
+00003be0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+00003bf0: 7468 3d69 6e74 2877 6964 7468 202f 2032  th=int(width / 2
+00003c00: 292c 0a20 2020 2020 2020 2020 2020 206e  ),.            n
+00003c10: 616d 653d 2277 6f72 6b65 7273 5f6d 656d  ame="workers_mem
+00003c20: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
+00003c30: 2020 6d69 6e5f 626f 7264 6572 5f62 6f74    min_border_bot
+00003c40: 746f 6d3d 3530 2c0a 2020 2020 2020 2020  tom=50,.        
+00003c50: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00003c60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00003c70: 7265 6374 203d 2073 656c 662e 726f 6f74  rect = self.root
+00003c80: 2e72 6563 7428 0a20 2020 2020 2020 2020  .rect(.         
+00003c90: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
+00003ca0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
+00003cb0: 2020 2078 3d22 7822 2c0a 2020 2020 2020     x="x",.      
+00003cc0: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
+00003cd0: 2020 2020 2020 2020 2077 6964 7468 3d22           width="
+00003ce0: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
+00003cf0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
+00003d00: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+00003d10: 723d 2263 6f6c 6f72 222c 0a20 2020 2020  r="color",.     
+00003d20: 2020 2020 2020 2066 696c 6c5f 616c 7068         fill_alph
+00003d30: 613d 2261 6c70 6861 222c 0a20 2020 2020  a="alpha",.     
+00003d40: 2020 2020 2020 206c 696e 655f 7769 6474         line_widt
+00003d50: 683d 302c 0a20 2020 2020 2020 2029 0a20  h=0,.        ). 
+00003d60: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
+00003d70: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
+00003d80: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
+00003d90: 656c 662e 726f 6f74 2e61 7869 735b 305d  elf.root.axis[0]
+00003da0: 2e74 6963 6b65 7220 3d20 4261 7369 6354  .ticker = BasicT
+00003db0: 6963 6b65 7228 2a2a 5449 434b 535f 3130  icker(**TICKS_10
+00003dc0: 3234 290a 2020 2020 2020 2020 7365 6c66  24).        self
+00003dd0: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
+00003de0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
+00003df0: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
+00003e00: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
+00003e10: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00003e20: 742e 7861 7869 732e 6d61 6a6f 725f 6c61  t.xaxis.major_la
+00003e30: 6265 6c5f 6f72 6965 6e74 6174 696f 6e20  bel_orientation 
+00003e40: 3d20 584c 4142 454c 5f4f 5249 454e 5441  = XLABEL_ORIENTA
+00003e50: 5449 4f4e 0a20 2020 2020 2020 2073 656c  TION.        sel
+00003e60: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
+00003e70: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+00003e80: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+00003e90: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
+00003ea0: 203d 2052 616e 6765 3164 2873 7461 7274   = Range1d(start
+00003eb0: 3d30 290a 2020 2020 2020 2020 7365 6c66  =0).        self
+00003ec0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
+00003ed0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+00003ee0: 2020 2020 7365 6c66 2e72 6f6f 742e 7967      self.root.yg
+00003ef0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+00003f00: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+00003f10: 2e72 6f6f 742e 746f 6f6c 6261 725f 6c6f  .root.toolbar_lo
+00003f20: 6361 7469 6f6e 203d 204e 6f6e 650a 0a20  cation = None.. 
+00003f30: 2020 2020 2020 2074 6170 203d 2054 6170         tap = Tap
+00003f40: 546f 6f6c 2863 616c 6c62 6163 6b3d 4f70  Tool(callback=Op
+00003f50: 656e 5552 4c28 7572 6c3d 222e 2f69 6e66  enURL(url="./inf
+00003f60: 6f2f 776f 726b 6572 2f40 6573 6361 7065  o/worker/@escape
+00003f70: 645f 776f 726b 6572 2e68 746d 6c22 2929  d_worker.html"))
+00003f80: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00003f90: 6f74 2e61 6464 5f74 6f6f 6c73 2874 6170  ot.add_tools(tap
+00003fa0: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
+00003fb0: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+00003fc0: 2020 2020 2020 2020 2020 706f 696e 745f            point_
+00003fd0: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
+00003fe0: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
+00003ff0: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
+00004000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004010: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00004020: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004040: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+00004050: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
+00004060: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
+00004070: 643b 223e 576f 726b 6572 3a3c 2f73 7061  d;">Worker:</spa
+00004080: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
+00004090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040a0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+000040b0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+000040c0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+000040d0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+000040e0: 7370 6163 653b 223e 4077 6f72 6b65 723c  space;">@worker<
+000040f0: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
+00004100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004110: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+00004120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004130: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00004140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004150: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00004160: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00004170: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00004180: 6569 6768 743a 2062 6f6c 643b 223e 5072  eight: bold;">Pr
+00004190: 6f63 6573 7320 6d65 6d6f 7279 2028 5253  ocess memory (RS
+000041a0: 5329 3a3c 2f73 7061 6e3e 266e 6273 703b  S):</span>&nbsp;
+000041b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000041c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041d0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+000041e0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+000041f0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+00004200: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00004210: 4070 726f 635f 6d65 6d6f 7279 7b30 2e30  @proc_memory{0.0
+00004220: 3020 627d 3c2f 7370 616e 3e0a 2020 2020  0 b}</span>.    
+00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004240: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
+00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004260: 2020 2020 2020 2020 2020 203c 6469 7620             <div 
+00004270: 7374 796c 653d 226d 6172 6769 6e2d 6c65  style="margin-le
+00004280: 6674 3a20 3165 6d3b 223e 0a20 2020 2020  ft: 1em;">.     
+00004290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042a0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+000042b0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+000042c0: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
+000042d0: 6967 6874 3a20 626f 6c64 3b22 3e4d 616e  ight: bold;">Man
+000042e0: 6167 6564 3a3c 2f73 7061 6e3e 266e 6273  aged:</span>&nbs
+000042f0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+00004300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004310: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+00004320: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+00004330: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+00004340: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+00004350: 223e 406d 616e 6167 6564 7b30 2e30 3020  ">@managed{0.00 
+00004360: 627d 3c2f 7370 616e 3e0a 2020 2020 2020  b}</span>.      
+00004370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004380: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+00004390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043a0: 2020 2020 2020 2020 203c 6469 7620 7374           <div st
+000043b0: 796c 653d 226d 6172 6769 6e2d 6c65 6674  yle="margin-left
+000043c0: 3a20 3165 6d3b 223e 0a20 2020 2020 2020  : 1em;">.       
+000043d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043e0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+000043f0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+00004400: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
+00004410: 6874 3a20 626f 6c64 3b22 3e55 6e6d 616e  ht: bold;">Unman
+00004420: 6167 6564 2028 6f6c 6429 3a3c 2f73 7061  aged (old):</spa
+00004430: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
+00004440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004450: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+00004460: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+00004470: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+00004480: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+00004490: 7370 6163 653b 223e 4075 6e6d 616e 6167  space;">@unmanag
+000044a0: 6564 5f6f 6c64 7b30 2e30 3020 627d 3c2f  ed_old{0.00 b}</
+000044b0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
+000044c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044d0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
 000044e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044f0: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-00004500: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-00004510: 697a 653a 2031 3270 783b 2066 6f6e 742d  ize: 12px; font-
-00004520: 7765 6967 6874 3a20 626f 6c64 3b22 3e55  weight: bold;">U
-00004530: 6e6d 616e 6167 6564 2028 7265 6365 6e74  nmanaged (recent
-00004540: 293a 3c2f 7370 616e 3e26 6e62 7370 3b0a  ):</span>&nbsp;.
-00004550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004570: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00004580: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
-00004590: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
-000045a0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
-000045b0: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
-000045c0: 7b30 2e30 3020 627d 3c2f 7370 616e 3e0a  {0.00 b}</span>.
-000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045e0: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-000045f0: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00004600: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00004610: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-00004620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004630: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-00004640: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
-00004650: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
-00004660: 626f 6c64 3b22 3e53 7069 6c6c 6564 2074  bold;">Spilled t
-00004670: 6f20 6469 736b 3a3c 2f73 7061 6e3e 266e  o disk:</span>&n
-00004680: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
-00004690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046a0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-000046b0: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
-000046c0: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
-000046d0: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
-000046e0: 653b 223e 4073 7069 6c6c 6564 7b30 2e30  e;">@spilled{0.0
-000046f0: 3020 627d 3c2f 7370 616e 3e0a 2020 2020  0 b}</span>.    
-00004700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004710: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-00004720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004730: 2020 2020 2020 2020 2020 2022 2222 2c0a             """,.
-00004740: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00004750: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-00004760: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
-00004770: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-00004780: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-00004790: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-000047a0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-000047b0: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
-000047c0: 2071 7561 646c 6973 7428 693a 2049 7465   quadlist(i: Ite
-000047d0: 7261 626c 655b 545d 2920 2d3e 206c 6973  rable[T]) -> lis
-000047e0: 745b 545d 3a0a 2020 2020 2020 2020 2020  t[T]:.          
-000047f0: 2020 6f75 7420 3d20 5b5d 0a20 2020 2020    out = [].     
-00004800: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
-00004810: 2069 3a0a 2020 2020 2020 2020 2020 2020   i:.            
-00004820: 2020 2020 6f75 7420 2b3d 205b 6969 2c20      out += [ii, 
-00004830: 6969 2c20 6969 2c20 6969 5d0a 2020 2020  ii, ii, ii].    
-00004840: 2020 2020 2020 2020 7265 7475 726e 206f          return o
-00004850: 7574 0a0a 2020 2020 2020 2020 776f 726b  ut..        work
-00004860: 6572 7320 3d20 7365 6c66 2e73 6368 6564  ers = self.sched
-00004870: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
-00004880: 7565 7328 290a 0a20 2020 2020 2020 2077  ues()..        w
-00004890: 6964 7468 203d 205b 5d0a 2020 2020 2020  idth = [].      
-000048a0: 2020 7820 3d20 5b5d 0a20 2020 2020 2020    x = [].       
-000048b0: 2063 6f6c 6f72 203d 205b 5d0a 2020 2020   color = [].    
-000048c0: 2020 2020 6d61 785f 6c69 6d69 7420 3d20      max_limit = 
-000048d0: 300a 2020 2020 2020 2020 7072 6f63 6d65  0.        procme
-000048e0: 6d6f 7279 203d 205b 5d0a 2020 2020 2020  mory = [].      
-000048f0: 2020 6d61 6e61 6765 6420 3d20 5b5d 0a20    managed = []. 
-00004900: 2020 2020 2020 2073 7069 6c6c 6564 203d         spilled =
-00004910: 205b 5d0a 2020 2020 2020 2020 756e 6d61   [].        unma
-00004920: 6e61 6765 645f 6f6c 6420 3d20 5b5d 0a20  naged_old = []. 
-00004930: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
-00004940: 5f72 6563 656e 7420 3d20 5b5d 0a0a 2020  _recent = []..  
-00004950: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-00004960: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-00004970: 2020 2020 206d 656d 696e 666f 203d 2077       meminfo = w
-00004980: 732e 6d65 6d6f 7279 0a20 2020 2020 2020  s.memory.       
-00004990: 2020 2020 206c 696d 6974 203d 2067 6574       limit = get
-000049a0: 6174 7472 2877 732c 2022 6d65 6d6f 7279  attr(ws, "memory
-000049b0: 5f6c 696d 6974 222c 2030 290a 2020 2020  _limit", 0).    
-000049c0: 2020 2020 2020 2020 6d61 785f 6c69 6d69          max_limi
-000049d0: 7420 3d20 6d61 7828 6d61 785f 6c69 6d69  t = max(max_limi
-000049e0: 742c 206c 696d 6974 2c20 6d65 6d69 6e66  t, limit, meminf
-000049f0: 6f2e 7072 6f63 6573 7320 2b20 6d65 6d69  o.process + memi
-00004a00: 6e66 6f2e 7370 696c 6c65 6429 0a20 2020  nfo.spilled).   
-00004a10: 2020 2020 2020 2020 2063 6f6c 6f72 5f69           color_i
-00004a20: 203d 2073 656c 662e 5f6d 656d 6f72 795f   = self._memory_
-00004a30: 636f 6c6f 7228 6d65 6d69 6e66 6f2e 7072  color(meminfo.pr
-00004a40: 6f63 6573 732c 206c 696d 6974 2c20 7773  ocess, limit, ws
-00004a50: 2e73 7461 7475 7329 0a0a 2020 2020 2020  .status)..      
-00004a60: 2020 2020 2020 7769 6474 6820 2b3d 205b        width += [
-00004a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004a80: 206d 656d 696e 666f 2e6d 616e 6167 6564   meminfo.managed
-00004a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00004aa0: 2020 6d65 6d69 6e66 6f2e 756e 6d61 6e61    meminfo.unmana
-00004ab0: 6765 645f 6f6c 642c 0a20 2020 2020 2020  ged_old,.       
-00004ac0: 2020 2020 2020 2020 206d 656d 696e 666f           meminfo
-00004ad0: 2e75 6e6d 616e 6167 6564 5f72 6563 656e  .unmanaged_recen
-00004ae0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00004af0: 2020 206d 656d 696e 666f 2e73 7069 6c6c     meminfo.spill
-00004b00: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-00004b10: 5d0a 2020 2020 2020 2020 2020 2020 7820  ].            x 
-00004b20: 2b3d 205b 7375 6d28 7769 6474 685b 2d34  += [sum(width[-4
-00004b30: 3a69 5d29 202b 2077 6964 7468 5b69 5d20  :i]) + width[i] 
-00004b40: 2f20 3220 666f 7220 6920 696e 2072 616e  / 2 for i in ran
-00004b50: 6765 282d 342c 2030 295d 0a20 2020 2020  ge(-4, 0)].     
-00004b60: 2020 2020 2020 2063 6f6c 6f72 202b 3d20         color += 
-00004b70: 5b63 6f6c 6f72 5f69 2c20 636f 6c6f 725f  [color_i, color_
-00004b80: 692c 2063 6f6c 6f72 5f69 2c20 2267 7265  i, color_i, "gre
-00004b90: 7922 5d0a 0a20 2020 2020 2020 2020 2020  y"]..           
-00004ba0: 2023 206d 656d 6f72 7920 696e 666f 0a20   # memory info. 
-00004bb0: 2020 2020 2020 2020 2020 2070 726f 636d             procm
-00004bc0: 656d 6f72 792e 6170 7065 6e64 286d 656d  emory.append(mem
-00004bd0: 696e 666f 2e70 726f 6365 7373 290a 2020  info.process).  
-00004be0: 2020 2020 2020 2020 2020 6d61 6e61 6765            manage
-00004bf0: 642e 6170 7065 6e64 286d 656d 696e 666f  d.append(meminfo
-00004c00: 2e6d 616e 6167 6564 290a 2020 2020 2020  .managed).      
-00004c10: 2020 2020 2020 756e 6d61 6e61 6765 645f        unmanaged_
-00004c20: 6f6c 642e 6170 7065 6e64 286d 656d 696e  old.append(memin
-00004c30: 666f 2e75 6e6d 616e 6167 6564 5f6f 6c64  fo.unmanaged_old
+000044f0: 2020 2020 203c 6469 7620 7374 796c 653d       <div style=
+00004500: 226d 6172 6769 6e2d 6c65 6674 3a20 3165  "margin-left: 1e
+00004510: 6d3b 223e 0a20 2020 2020 2020 2020 2020  m;">.           
+00004520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004530: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00004540: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
+00004550: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+00004560: 626f 6c64 3b22 3e55 6e6d 616e 6167 6564  bold;">Unmanaged
+00004570: 2028 7265 6365 6e74 293a 3c2f 7370 616e   (recent):</span
+00004580: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+00004590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045a0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+000045b0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+000045c0: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
+000045d0: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
+000045e0: 7061 6365 3b22 3e40 756e 6d61 6e61 6765  pace;">@unmanage
+000045f0: 645f 7265 6365 6e74 7b30 2e30 3020 627d  d_recent{0.00 b}
+00004600: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
+00004610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004620: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
+00004630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004640: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
+00004650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004660: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+00004670: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+00004680: 697a 653a 2031 3270 783b 2066 6f6e 742d  ize: 12px; font-
+00004690: 7765 6967 6874 3a20 626f 6c64 3b22 3e53  weight: bold;">S
+000046a0: 7069 6c6c 6564 2074 6f20 6469 736b 3a3c  pilled to disk:<
+000046b0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
+000046c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046d0: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+000046e0: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+000046f0: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
+00004700: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
+00004710: 6d6f 6e6f 7370 6163 653b 223e 4073 7069  monospace;">@spi
+00004720: 6c6c 6564 7b30 2e30 3020 627d 3c2f 7370  lled{0.00 b}</sp
+00004730: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
+00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004750: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+00004760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004770: 2020 2022 2222 2c0a 2020 2020 2020 2020     """,.        
+00004780: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+00004790: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
+000047a0: 7665 7229 0a0a 2020 2020 4077 6974 686f  ver)..    @witho
+000047b0: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+000047c0: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+000047d0: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+000047e0: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+000047f0: 2020 2020 2064 6566 2071 7561 646c 6973       def quadlis
+00004800: 7428 693a 2049 7465 7261 626c 655b 545d  t(i: Iterable[T]
+00004810: 2920 2d3e 206c 6973 745b 545d 3a0a 2020  ) -> list[T]:.  
+00004820: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+00004830: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00004840: 6f72 2069 6920 696e 2069 3a0a 2020 2020  or ii in i:.    
+00004850: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
+00004860: 2b3d 205b 6969 2c20 6969 2c20 6969 2c20  += [ii, ii, ii, 
+00004870: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
+00004880: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
+00004890: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
+000048a0: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
+000048b0: 6b65 7273 2e76 616c 7565 7328 290a 0a20  kers.values().. 
+000048c0: 2020 2020 2020 2077 6964 7468 203d 205b         width = [
+000048d0: 5d0a 2020 2020 2020 2020 7820 3d20 5b5d  ].        x = []
+000048e0: 0a20 2020 2020 2020 2063 6f6c 6f72 203d  .        color =
+000048f0: 205b 5d0a 2020 2020 2020 2020 6d61 785f   [].        max_
+00004900: 6c69 6d69 7420 3d20 300a 2020 2020 2020  limit = 0.      
+00004910: 2020 7072 6f63 6d65 6d6f 7279 203d 205b    procmemory = [
+00004920: 5d0a 2020 2020 2020 2020 6d61 6e61 6765  ].        manage
+00004930: 6420 3d20 5b5d 0a20 2020 2020 2020 2073  d = [].        s
+00004940: 7069 6c6c 6564 203d 205b 5d0a 2020 2020  pilled = [].    
+00004950: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
+00004960: 6420 3d20 5b5d 0a20 2020 2020 2020 2075  d = [].        u
+00004970: 6e6d 616e 6167 6564 5f72 6563 656e 7420  nmanaged_recent 
+00004980: 3d20 5b5d 0a0a 2020 2020 2020 2020 666f  = []..        fo
+00004990: 7220 7773 2069 6e20 776f 726b 6572 733a  r ws in workers:
+000049a0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+000049b0: 696e 666f 203d 2077 732e 6d65 6d6f 7279  info = ws.memory
+000049c0: 0a20 2020 2020 2020 2020 2020 206c 696d  .            lim
+000049d0: 6974 203d 2067 6574 6174 7472 2877 732c  it = getattr(ws,
+000049e0: 2022 6d65 6d6f 7279 5f6c 696d 6974 222c   "memory_limit",
+000049f0: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
+00004a00: 6d61 785f 6c69 6d69 7420 3d20 6d61 7828  max_limit = max(
+00004a10: 6d61 785f 6c69 6d69 742c 206c 696d 6974  max_limit, limit
+00004a20: 2c20 6d65 6d69 6e66 6f2e 7072 6f63 6573  , meminfo.proces
+00004a30: 7320 2b20 6d65 6d69 6e66 6f2e 7370 696c  s + meminfo.spil
+00004a40: 6c65 6429 0a20 2020 2020 2020 2020 2020  led).           
+00004a50: 2063 6f6c 6f72 5f69 203d 2073 656c 662e   color_i = self.
+00004a60: 5f6d 656d 6f72 795f 636f 6c6f 7228 6d65  _memory_color(me
+00004a70: 6d69 6e66 6f2e 7072 6f63 6573 732c 206c  minfo.process, l
+00004a80: 696d 6974 2c20 7773 2e73 7461 7475 7329  imit, ws.status)
+00004a90: 0a0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
+00004aa0: 6474 6820 2b3d 205b 0a20 2020 2020 2020  dth += [.       
+00004ab0: 2020 2020 2020 2020 206d 656d 696e 666f           meminfo
+00004ac0: 2e6d 616e 6167 6564 2c0a 2020 2020 2020  .managed,.      
+00004ad0: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
+00004ae0: 6f2e 756e 6d61 6e61 6765 645f 6f6c 642c  o.unmanaged_old,
+00004af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004b00: 206d 656d 696e 666f 2e75 6e6d 616e 6167   meminfo.unmanag
+00004b10: 6564 5f72 6563 656e 742c 0a20 2020 2020  ed_recent,.     
+00004b20: 2020 2020 2020 2020 2020 206d 656d 696e             memin
+00004b30: 666f 2e73 7069 6c6c 6564 2c0a 2020 2020  fo.spilled,.    
+00004b40: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00004b50: 2020 2020 2020 7820 2b3d 205b 7375 6d28        x += [sum(
+00004b60: 7769 6474 685b 2d34 3a69 5d29 202b 2077  width[-4:i]) + w
+00004b70: 6964 7468 5b69 5d20 2f20 3220 666f 7220  idth[i] / 2 for 
+00004b80: 6920 696e 2072 616e 6765 282d 342c 2030  i in range(-4, 0
+00004b90: 295d 0a20 2020 2020 2020 2020 2020 2063  )].            c
+00004ba0: 6f6c 6f72 202b 3d20 5b63 6f6c 6f72 5f69  olor += [color_i
+00004bb0: 2c20 636f 6c6f 725f 692c 2063 6f6c 6f72  , color_i, color
+00004bc0: 5f69 2c20 2267 7265 7922 5d0a 0a20 2020  _i, "grey"]..   
+00004bd0: 2020 2020 2020 2020 2023 206d 656d 6f72           # memor
+00004be0: 7920 696e 666f 0a20 2020 2020 2020 2020  y info.         
+00004bf0: 2020 2070 726f 636d 656d 6f72 792e 6170     procmemory.ap
+00004c00: 7065 6e64 286d 656d 696e 666f 2e70 726f  pend(meminfo.pro
+00004c10: 6365 7373 290a 2020 2020 2020 2020 2020  cess).          
+00004c20: 2020 6d61 6e61 6765 642e 6170 7065 6e64    managed.append
+00004c30: 286d 656d 696e 666f 2e6d 616e 6167 6564  (meminfo.managed
 00004c40: 290a 2020 2020 2020 2020 2020 2020 756e  ).            un
-00004c50: 6d61 6e61 6765 645f 7265 6365 6e74 2e61  managed_recent.a
-00004c60: 7070 656e 6428 6d65 6d69 6e66 6f2e 756e  ppend(meminfo.un
-00004c70: 6d61 6e61 6765 645f 7265 6365 6e74 290a  managed_recent).
-00004c80: 2020 2020 2020 2020 2020 2020 7370 696c              spil
-00004c90: 6c65 642e 6170 7065 6e64 286d 656d 696e  led.append(memin
-00004ca0: 666f 2e73 7069 6c6c 6564 290a 0a20 2020  fo.spilled)..   
-00004cb0: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
-00004cc0: 2020 2020 2020 2020 2020 2020 2277 6964              "wid
-00004cd0: 7468 223a 2077 6964 7468 2c0a 2020 2020  th": width,.    
-00004ce0: 2020 2020 2020 2020 2278 223a 2078 2c0a          "x": x,.
-00004cf0: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-00004d00: 6f72 223a 2063 6f6c 6f72 2c0a 2020 2020  or": color,.    
-00004d10: 2020 2020 2020 2020 2261 6c70 6861 223a          "alpha":
-00004d20: 205b 312c 2030 2e37 2c20 302e 342c 2031   [1, 0.7, 0.4, 1
-00004d30: 5d20 2a20 6c65 6e28 776f 726b 6572 7329  ] * len(workers)
-00004d40: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-00004d50: 6f72 6b65 7222 3a20 7175 6164 6c69 7374  orker": quadlist
-00004d60: 2877 732e 6164 6472 6573 7320 666f 7220  (ws.address for 
-00004d70: 7773 2069 6e20 776f 726b 6572 7329 2c0a  ws in workers),.
-00004d80: 2020 2020 2020 2020 2020 2020 2265 7363              "esc
-00004d90: 6170 6564 5f77 6f72 6b65 7222 3a20 7175  aped_worker": qu
-00004da0: 6164 6c69 7374 2865 7363 6170 652e 7572  adlist(escape.ur
-00004db0: 6c5f 6573 6361 7065 2877 732e 6164 6472  l_escape(ws.addr
-00004dc0: 6573 7329 2066 6f72 2077 7320 696e 2077  ess) for ws in w
-00004dd0: 6f72 6b65 7273 292c 0a20 2020 2020 2020  orkers),.       
-00004de0: 2020 2020 2022 7922 3a20 7175 6164 6c69       "y": quadli
-00004df0: 7374 2872 616e 6765 286c 656e 2877 6f72  st(range(len(wor
-00004e00: 6b65 7273 2929 292c 0a20 2020 2020 2020  kers))),.       
-00004e10: 2020 2020 2022 7072 6f63 5f6d 656d 6f72       "proc_memor
-00004e20: 7922 3a20 7175 6164 6c69 7374 2870 726f  y": quadlist(pro
-00004e30: 636d 656d 6f72 7929 2c0a 2020 2020 2020  cmemory),.      
-00004e40: 2020 2020 2020 226d 616e 6167 6564 223a        "managed":
-00004e50: 2071 7561 646c 6973 7428 6d61 6e61 6765   quadlist(manage
-00004e60: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-00004e70: 2275 6e6d 616e 6167 6564 5f6f 6c64 223a  "unmanaged_old":
-00004e80: 2071 7561 646c 6973 7428 756e 6d61 6e61   quadlist(unmana
-00004e90: 6765 645f 6f6c 6429 2c0a 2020 2020 2020  ged_old),.      
-00004ea0: 2020 2020 2020 2275 6e6d 616e 6167 6564        "unmanaged
-00004eb0: 5f72 6563 656e 7422 3a20 7175 6164 6c69  _recent": quadli
-00004ec0: 7374 2875 6e6d 616e 6167 6564 5f72 6563  st(unmanaged_rec
-00004ed0: 656e 7429 2c0a 2020 2020 2020 2020 2020  ent),.          
-00004ee0: 2020 2273 7069 6c6c 6564 223a 2071 7561    "spilled": qua
-00004ef0: 646c 6973 7428 7370 696c 6c65 6429 2c0a  dlist(spilled),.
-00004f00: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00004f10: 2020 2320 5265 6d6f 7665 2072 6563 7461    # Remove recta
-00004f20: 6e67 6c65 7320 7769 7468 2077 6964 7468  ngles with width
-00004f30: 3d30 0a20 2020 2020 2020 2072 6573 756c  =0.        resul
-00004f40: 7420 3d20 7b6b 3a20 5b76 6920 666f 7220  t = {k: [vi for 
-00004f50: 7669 2c20 7720 696e 207a 6970 2876 2c20  vi, w in zip(v, 
-00004f60: 7769 6474 6829 2069 6620 775d 2066 6f72  width) if w] for
-00004f70: 206b 2c20 7620 696e 2072 6573 756c 742e   k, v in result.
-00004f80: 6974 656d 7328 297d 0a0a 2020 2020 2020  items()}..      
-00004f90: 2020 7365 6c66 2e72 6f6f 742e 785f 7261    self.root.x_ra
-00004fa0: 6e67 652e 656e 6420 3d20 6d61 785f 6c69  nge.end = max_li
-00004fb0: 6d69 740a 2020 2020 2020 2020 7570 6461  mit.        upda
-00004fc0: 7465 2873 656c 662e 736f 7572 6365 2c20  te(self.source, 
-00004fd0: 7265 7375 6c74 290a 0a0a 636c 6173 7320  result)...class 
-00004fe0: 576f 726b 6572 734d 656d 6f72 7948 6973  WorkersMemoryHis
-00004ff0: 746f 6772 616d 2844 6173 6862 6f61 7264  togram(Dashboard
-00005000: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
-00005010: 2222 2248 6973 746f 6772 616d 206f 6620  """Histogram of 
-00005020: 6d65 6d6f 7279 2075 7361 6765 2c20 7368  memory usage, sh
-00005030: 6f77 696e 6720 686f 7720 6d61 6e79 2077  owing how many w
-00005040: 6f72 6b65 7273 2074 6865 7265 2061 7265  orkers there are
-00005050: 2069 6e20 6561 6368 2062 7563 6b65 7420   in each bucket 
-00005060: 6f66 0a20 2020 2075 7361 6765 2e20 5265  of.    usage. Re
-00005070: 706c 6163 6573 2074 6865 2070 6572 2d77  places the per-w
-00005080: 6f72 6b65 7220 6772 6170 6820 7768 656e  orker graph when
-00005090: 2074 6865 7265 2061 7265 203e 3d20 3530   there are >= 50
-000050a0: 2077 6f72 6b65 7273 2e0a 2020 2020 2222   workers..    ""
-000050b0: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
-000050c0: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-000050d0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-000050e0: 6c65 722c 202a 2a6b 7761 7267 7329 3a0a  ler, **kwargs):.
-000050f0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-00005100: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-00005110: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-00005120: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-00005130: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
-00005140: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-00005150: 0a20 2020 2020 2020 2020 2020 207b 226c  .            {"l
-00005160: 6566 7422 3a20 5b31 2c20 325d 2c20 2272  eft": [1, 2], "r
-00005170: 6967 6874 223a 205b 3130 2c20 3130 5d2c  ight": [10, 10],
-00005180: 2022 746f 7022 3a20 5b30 2c20 305d 7d0a   "top": [0, 0]}.
-00005190: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000051a0: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
-000051b0: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-000051c0: 2020 2074 6974 6c65 3d22 4279 7465 7320     title="Bytes 
-000051d0: 7374 6f72 6564 2070 6572 2077 6f72 6b65  stored per worke
-000051e0: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-000051f0: 6e61 6d65 3d22 776f 726b 6572 735f 6d65  name="workers_me
-00005200: 6d6f 7279 222c 0a20 2020 2020 2020 2020  mory",.         
-00005210: 2020 2079 5f61 7869 735f 6c61 6265 6c3d     y_axis_label=
-00005220: 2266 7265 7175 656e 6379 222c 0a20 2020  "frequency",.   
-00005230: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
-00005240: 222c 0a20 2020 2020 2020 2020 2020 202a  ",.            *
-00005250: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-00005260: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-00005270: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
-00005280: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-00005290: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-000052a0: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
-000052b0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-000052c0: 742e 7861 7869 732e 7469 636b 6572 203d  t.xaxis.ticker =
-000052d0: 2041 6461 7074 6976 6554 6963 6b65 7228   AdaptiveTicker(
-000052e0: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
-000052f0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00005300: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
-00005310: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
-00005320: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
-00005330: 4f4e 0a0a 2020 2020 2020 2020 7365 6c66  ON..        self
-00005340: 2e72 6f6f 742e 7861 7869 732e 6d69 6e6f  .root.xaxis.mino
-00005350: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
-00005360: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
-00005370: 6c66 2e72 6f6f 742e 7967 7269 642e 7669  lf.root.ygrid.vi
-00005380: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
-00005390: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-000053a0: 2e74 6f6f 6c62 6172 5f6c 6f63 6174 696f  .toolbar_locatio
-000053b0: 6e20 3d20 4e6f 6e65 0a0a 2020 2020 2020  n = None..      
-000053c0: 2020 7365 6c66 2e72 6f6f 742e 7175 6164    self.root.quad
-000053d0: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-000053e0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-000053f0: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-00005400: 6674 3d22 6c65 6674 222c 0a20 2020 2020  ft="left",.     
-00005410: 2020 2020 2020 2072 6967 6874 3d22 7269         right="ri
-00005420: 6768 7422 2c0a 2020 2020 2020 2020 2020  ght",.          
-00005430: 2020 626f 7474 6f6d 3d30 2c0a 2020 2020    bottom=0,.    
-00005440: 2020 2020 2020 2020 746f 703d 2274 6f70          top="top
-00005450: 222c 0a20 2020 2020 2020 2020 2020 2063  ",.            c
-00005460: 6f6c 6f72 3d22 6465 6570 736b 7962 6c75  olor="deepskyblu
-00005470: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00005480: 6669 6c6c 5f61 6c70 6861 3d30 2e35 2c0a  fill_alpha=0.5,.
-00005490: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-000054a0: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-000054b0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-000054c0: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-000054d0: 3a0a 2020 2020 2020 2020 6e62 7974 6573  :.        nbytes
-000054e0: 203d 206e 702e 6173 6172 7261 7928 0a20   = np.asarray(. 
-000054f0: 2020 2020 2020 2020 2020 205b 7773 2e6d             [ws.m
-00005500: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
-00005510: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-00005520: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-00005530: 732e 7661 6c75 6573 2829 5d0a 2020 2020  s.values()].    
-00005540: 2020 2020 290a 2020 2020 2020 2020 636f      ).        co
-00005550: 756e 7473 2c20 7820 3d20 6e70 2e68 6973  unts, x = np.his
-00005560: 746f 6772 616d 286e 6279 7465 732c 2062  togram(nbytes, b
-00005570: 696e 733d 3430 290a 2020 2020 2020 2020  ins=40).        
-00005580: 6420 3d20 7b22 6c65 6674 223a 2078 5b3a  d = {"left": x[:
-00005590: 2d31 5d2c 2022 7269 6768 7422 3a20 785b  -1], "right": x[
-000055a0: 313a 5d2c 2022 746f 7022 3a20 636f 756e  1:], "top": coun
-000055b0: 7473 7d0a 2020 2020 2020 2020 7570 6461  ts}.        upda
-000055c0: 7465 2873 656c 662e 736f 7572 6365 2c20  te(self.source, 
-000055d0: 6429 0a0a 0a63 6c61 7373 2057 6f72 6b65  d)...class Worke
-000055e0: 7273 5472 616e 7366 6572 4279 7465 7328  rsTransferBytes(
-000055f0: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-00005600: 6e74 293a 0a20 2020 2022 2222 5369 7a65  nt):.    """Size
-00005610: 206f 6620 6f70 656e 2064 6174 6120 7472   of open data tr
-00005620: 616e 7366 6572 7320 6672 6f6d 2f74 6f20  ansfers from/to 
-00005630: 6f74 6865 7220 776f 726b 6572 7320 7065  other workers pe
-00005640: 7220 776f 726b 6572 2222 220a 0a20 2020  r worker"""..   
-00005650: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-00005660: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00005670: 6c66 2c20 7363 6865 6475 6c65 722c 2077  lf, scheduler, w
-00005680: 6964 7468 3d36 3030 2c20 2a2a 6b77 6172  idth=600, **kwar
-00005690: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
-000056a0: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-000056b0: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-000056c0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
-000056d0: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
-000056e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000056f0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00005700: 7363 6170 6564 5f77 6f72 6b65 7222 3a20  scaped_worker": 
-00005710: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00005720: 2020 2020 2274 7261 6e73 6665 725f 696e      "transfer_in
-00005730: 636f 6d69 6e67 5f62 7974 6573 223a 205b  coming_bytes": [
-00005740: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00005750: 2020 2022 7472 616e 7366 6572 5f6f 7574     "transfer_out
-00005760: 676f 696e 675f 6279 7465 7322 3a20 5b5d  going_bytes": []
-00005770: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005780: 2020 2277 6f72 6b65 7222 3a20 5b5d 2c0a    "worker": [],.
-00005790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057a0: 2279 5f69 6e63 6f6d 696e 6722 3a20 5b5d  "y_incoming": []
-000057b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000057c0: 2020 2279 5f6f 7574 676f 696e 6722 3a20    "y_outgoing": 
-000057d0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-000057e0: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
-000057f0: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
-00005800: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-00005810: 2020 2020 2074 6974 6c65 3d66 2242 7974       title=f"Byt
-00005820: 6573 2074 7261 6e73 6665 7272 696e 673a  es transferring:
-00005830: 207b 666f 726d 6174 5f62 7974 6573 2830   {format_bytes(0
-00005840: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
-00005850: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
-00005860: 2020 2020 2020 2077 6964 7468 3d69 6e74         width=int
-00005870: 2877 6964 7468 202f 2032 292c 0a20 2020  (width / 2),.   
-00005880: 2020 2020 2020 2020 206e 616d 653d 2277           name="w
-00005890: 6f72 6b65 7273 5f74 7261 6e73 6665 725f  orkers_transfer_
-000058a0: 6279 7465 7322 2c0a 2020 2020 2020 2020  bytes",.        
-000058b0: 2020 2020 6d69 6e5f 626f 7264 6572 5f62      min_border_b
-000058c0: 6f74 746f 6d3d 3530 2c0a 2020 2020 2020  ottom=50,.      
-000058d0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-000058e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000058f0: 2020 2023 2074 7261 6e73 6665 725f 696e     # transfer_in
-00005900: 636f 6d69 6e67 5f62 7974 6573 0a20 2020  coming_bytes.   
-00005910: 2020 2020 2073 656c 662e 726f 6f74 2e68       self.root.h
-00005920: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
-00005930: 206e 616d 653d 2274 7261 6e73 6665 725f   name="transfer_
-00005940: 696e 636f 6d69 6e67 5f62 7974 6573 222c  incoming_bytes",
-00005950: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
-00005960: 795f 696e 636f 6d69 6e67 222c 0a20 2020  y_incoming",.   
-00005970: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
-00005980: 7472 616e 7366 6572 5f69 6e63 6f6d 696e  transfer_incomin
-00005990: 675f 6279 7465 7322 2c0a 2020 2020 2020  g_bytes",.      
-000059a0: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
-000059b0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-000059c0: 2020 206c 6566 743d 302c 0a20 2020 2020     left=0,.     
-000059d0: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
-000059e0: 352c 0a20 2020 2020 2020 2020 2020 2066  5,.            f
-000059f0: 696c 6c5f 636f 6c6f 723d 2272 6564 222c  ill_color="red",
-00005a00: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00005a10: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-00005a20: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00005a30: 2020 2020 2320 7472 616e 7366 6572 5f6f      # transfer_o
-00005a40: 7574 676f 696e 675f 6279 7465 730a 2020  utgoing_bytes.  
-00005a50: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00005a60: 6862 6172 280a 2020 2020 2020 2020 2020  hbar(.          
-00005a70: 2020 6e61 6d65 3d22 7472 616e 7366 6572    name="transfer
-00005a80: 5f6f 7574 676f 696e 675f 6279 7465 7322  _outgoing_bytes"
-00005a90: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
-00005aa0: 2279 5f6f 7574 676f 696e 6722 2c0a 2020  "y_outgoing",.  
-00005ab0: 2020 2020 2020 2020 2020 7269 6768 743d            right=
-00005ac0: 2274 7261 6e73 6665 725f 6f75 7467 6f69  "transfer_outgoi
-00005ad0: 6e67 5f62 7974 6573 222c 0a20 2020 2020  ng_bytes",.     
-00005ae0: 2020 2020 2020 206c 696e 655f 636f 6c6f         line_colo
-00005af0: 723d 4e6f 6e65 2c0a 2020 2020 2020 2020  r=None,.        
-00005b00: 2020 2020 6c65 6674 3d30 2c0a 2020 2020      left=0,.    
-00005b10: 2020 2020 2020 2020 6865 6967 6874 3d30          height=0
-00005b20: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-00005b30: 6669 6c6c 5f63 6f6c 6f72 3d22 626c 7565  fill_color="blue
-00005b40: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00005b50: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-00005b60: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-00005b70: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00005b80: 6178 6973 5b30 5d2e 7469 636b 6572 203d  axis[0].ticker =
-00005b90: 2042 6173 6963 5469 636b 6572 282a 2a54   BasicTicker(**T
-00005ba0: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
-00005bb0: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-00005bc0: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
-00005bd0: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
-00005be0: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00005bf0: 2e30 2062 2229 0a20 2020 2020 2020 2073  .0 b").        s
-00005c00: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
-00005c10: 616a 6f72 5f6c 6162 656c 5f6f 7269 656e  ajor_label_orien
-00005c20: 7461 7469 6f6e 203d 2058 4c41 4245 4c5f  tation = XLABEL_
-00005c30: 4f52 4945 4e54 4154 494f 4e0a 2020 2020  ORIENTATION.    
-00005c40: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00005c50: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
-00005c60: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
-00005c70: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00005c80: 785f 7261 6e67 6520 3d20 5261 6e67 6531  x_range = Range1
-00005c90: 6428 7374 6172 743d 3029 0a20 2020 2020  d(start=0).     
-00005ca0: 2020 2073 656c 662e 726f 6f74 2e79 6178     self.root.yax
-00005cb0: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-00005cc0: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
-00005cd0: 726f 6f74 2e79 6772 6964 2e76 6973 6962  root.ygrid.visib
-00005ce0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-00005cf0: 2020 2073 656c 662e 726f 6f74 2e74 6f6f     self.root.too
-00005d00: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
-00005d10: 4e6f 6e65 0a0a 2020 2020 2020 2020 7461  None..        ta
-00005d20: 7020 3d20 5461 7054 6f6f 6c28 6361 6c6c  p = TapTool(call
-00005d30: 6261 636b 3d4f 7065 6e55 524c 2875 726c  back=OpenURL(url
-00005d40: 3d22 2e2f 696e 666f 2f77 6f72 6b65 722f  ="./info/worker/
-00005d50: 4065 7363 6170 6564 5f77 6f72 6b65 722e  @escaped_worker.
-00005d60: 6874 6d6c 2229 290a 2020 2020 2020 2020  html")).        
-00005d70: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
-00005d80: 6c28 0a20 2020 2020 2020 2020 2020 2074  l(.            t
-00005d90: 6f6f 6c74 6970 733d 5b0a 2020 2020 2020  ooltips=[.      
-00005da0: 2020 2020 2020 2020 2020 2822 576f 726b            ("Work
-00005db0: 6572 222c 2022 4077 6f72 6b65 7222 292c  er", "@worker"),
-00005dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005dd0: 2028 2249 6e63 6f6d 696e 6722 2c20 2240   ("Incoming", "@
-00005de0: 7472 616e 7366 6572 5f69 6e63 6f6d 696e  transfer_incomin
-00005df0: 675f 6279 7465 737b 302e 3030 2062 7d22  g_bytes{0.00 b}"
-00005e00: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00005e10: 2020 2028 224f 7574 676f 696e 6722 2c20     ("Outgoing", 
-00005e20: 2240 7472 616e 7366 6572 5f6f 7574 676f  "@transfer_outgo
-00005e30: 696e 675f 6279 7465 737b 302e 3030 2062  ing_bytes{0.00 b
-00005e40: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
-00005e50: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-00005e60: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
-00005e70: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
-00005e80: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00005e90: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
-00005ea0: 6c73 2868 6f76 6572 2c20 7461 7029 0a0a  ls(hover, tap)..
-00005eb0: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-00005ec0: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-00005ed0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-00005ee0: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
-00005ef0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-00005f00: 7373 203d 2073 656c 662e 7363 6865 6475  ss = self.schedu
-00005f10: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-00005f20: 6573 2829 0a0a 2020 2020 2020 2020 6820  es()..        h 
-00005f30: 3d20 302e 310a 2020 2020 2020 2020 795f  = 0.1.        y_
-00005f40: 696e 636f 6d69 6e67 203d 205b 6920 2b20  incoming = [i + 
-00005f50: 302e 3735 202b 2069 202a 2068 2066 6f72  0.75 + i * h for
-00005f60: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00005f70: 7773 7329 295d 0a20 2020 2020 2020 2079  wss))].        y
-00005f80: 5f6f 7574 676f 696e 6720 3d20 5b69 202b  _outgoing = [i +
-00005f90: 2030 2e32 3520 2b20 6920 2a20 6820 666f   0.25 + i * h fo
-00005fa0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-00005fb0: 2877 7373 2929 5d0a 0a20 2020 2020 2020  (wss))]..       
-00005fc0: 2074 7261 6e73 6665 725f 696e 636f 6d69   transfer_incomi
-00005fd0: 6e67 5f62 7974 6573 203d 205b 0a20 2020  ng_bytes = [.   
-00005fe0: 2020 2020 2020 2020 2077 732e 6d65 7472           ws.metr
-00005ff0: 6963 735b 2274 7261 6e73 6665 7222 5d5b  ics["transfer"][
-00006000: 2269 6e63 6f6d 696e 675f 6279 7465 7322  "incoming_bytes"
-00006010: 5d20 666f 7220 7773 2069 6e20 7773 730a  ] for ws in wss.
-00006020: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00006030: 2020 7472 616e 7366 6572 5f6f 7574 676f    transfer_outgo
-00006040: 696e 675f 6279 7465 7320 3d20 5b0a 2020  ing_bytes = [.  
-00006050: 2020 2020 2020 2020 2020 7773 2e6d 6574            ws.met
-00006060: 7269 6373 5b22 7472 616e 7366 6572 225d  rics["transfer"]
-00006070: 5b22 6f75 7467 6f69 6e67 5f62 7974 6573  ["outgoing_bytes
-00006080: 225d 2066 6f72 2077 7320 696e 2077 7373  "] for ws in wss
-00006090: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-000060a0: 2020 2077 6f72 6b65 7273 203d 205b 7773     workers = [ws
-000060b0: 2e61 6464 7265 7373 2066 6f72 2077 7320  .address for ws 
-000060c0: 696e 2077 7373 5d0a 2020 2020 2020 2020  in wss].        
-000060d0: 6573 6361 7065 645f 776f 726b 6572 7320  escaped_workers 
-000060e0: 3d20 5b65 7363 6170 652e 7572 6c5f 6573  = [escape.url_es
-000060f0: 6361 7065 2877 6f72 6b65 7229 2066 6f72  cape(worker) for
-00006100: 2077 6f72 6b65 7220 696e 2077 6f72 6b65   worker in worke
-00006110: 7273 5d0a 0a20 2020 2020 2020 2069 6620  rs]..        if 
-00006120: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
-00006130: 2078 5f6c 696d 6974 203d 206d 6178 280a   x_limit = max(.
-00006140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006150: 6d61 7828 7472 616e 7366 6572 5f69 6e63  max(transfer_inc
-00006160: 6f6d 696e 675f 6279 7465 7329 2c0a 2020  oming_bytes),.  
-00006170: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00006180: 7828 7472 616e 7366 6572 5f6f 7574 676f  x(transfer_outgo
-00006190: 696e 675f 6279 7465 7329 2c0a 2020 2020  ing_bytes),.    
-000061a0: 2020 2020 2020 2020 2020 2020 6d61 7828              max(
-000061b0: 7773 2e6d 656d 6f72 795f 6c69 6d69 7420  ws.memory_limit 
-000061c0: 666f 7220 7773 2069 6e20 7773 7329 2c0a  for ws in wss),.
-000061d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000061e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000061f0: 2020 2020 2020 2020 785f 6c69 6d69 7420          x_limit 
-00006200: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-00006210: 2e72 6f6f 742e 785f 7261 6e67 652e 656e  .root.x_range.en
-00006220: 6420 3d20 785f 6c69 6d69 740a 0a20 2020  d = x_limit..   
-00006230: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
-00006240: 2020 2020 2020 2020 2020 2020 2265 7363              "esc
-00006250: 6170 6564 5f77 6f72 6b65 7222 3a20 6573  aped_worker": es
-00006260: 6361 7065 645f 776f 726b 6572 732c 0a20  caped_workers,. 
-00006270: 2020 2020 2020 2020 2020 2022 7472 616e             "tran
-00006280: 7366 6572 5f69 6e63 6f6d 696e 675f 6279  sfer_incoming_by
-00006290: 7465 7322 3a20 7472 616e 7366 6572 5f69  tes": transfer_i
-000062a0: 6e63 6f6d 696e 675f 6279 7465 732c 0a20  ncoming_bytes,. 
-000062b0: 2020 2020 2020 2020 2020 2022 7472 616e             "tran
-000062c0: 7366 6572 5f6f 7574 676f 696e 675f 6279  sfer_outgoing_by
-000062d0: 7465 7322 3a20 7472 616e 7366 6572 5f6f  tes": transfer_o
-000062e0: 7574 676f 696e 675f 6279 7465 732c 0a20  utgoing_bytes,. 
-000062f0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
-00006300: 6572 223a 2077 6f72 6b65 7273 2c0a 2020  er": workers,.  
-00006310: 2020 2020 2020 2020 2020 2279 5f69 6e63            "y_inc
-00006320: 6f6d 696e 6722 3a20 795f 696e 636f 6d69  oming": y_incomi
-00006330: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-00006340: 2279 5f6f 7574 676f 696e 6722 3a20 795f  "y_outgoing": y_
-00006350: 6f75 7467 6f69 6e67 2c0a 2020 2020 2020  outgoing,.      
-00006360: 2020 7d0a 2020 2020 2020 2020 7365 6c66    }.        self
-00006370: 2e72 6f6f 742e 7469 746c 652e 7465 7874  .root.title.text
-00006380: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00006390: 2066 2242 7974 6573 2074 7261 6e73 6665   f"Bytes transfe
-000063a0: 7272 696e 673a 207b 666f 726d 6174 5f62  rring: {format_b
-000063b0: 7974 6573 2873 756d 2874 7261 6e73 6665  ytes(sum(transfe
-000063c0: 725f 696e 636f 6d69 6e67 5f62 7974 6573  r_incoming_bytes
-000063d0: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
-000063e0: 2020 2020 2020 2075 7064 6174 6528 7365         update(se
-000063f0: 6c66 2e73 6f75 7263 652c 2072 6573 756c  lf.source, resul
-00006400: 7429 0a0a 0a63 6c61 7373 2048 6172 6477  t)...class Hardw
-00006410: 6172 6528 4461 7368 626f 6172 6443 6f6d  are(DashboardCom
-00006420: 706f 6e65 6e74 293a 0a20 2020 2022 2222  ponent):.    """
-00006430: 4f63 6375 7061 6e63 7920 2869 6e20 7469  Occupancy (in ti
-00006440: 6d65 2920 7065 7220 776f 726b 6572 2222  me) per worker""
-00006450: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
-00006460: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-00006470: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-00006480: 6c65 722c 202a 2a6b 7761 7267 7329 3a0a  ler, **kwargs):.
-00006490: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-000064a0: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
-000064b0: 6572 0a20 2020 2020 2020 2023 2044 6973  er.        # Dis
-000064c0: 6b0a 2020 2020 2020 2020 7365 6c66 2e64  k.        self.d
-000064d0: 6973 6b5f 736f 7572 6365 203d 2043 6f6c  isk_source = Col
-000064e0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
-000064f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00006500: 2020 2020 2020 2020 2020 2020 2022 7369               "si
-00006510: 7a65 223a 205b 5d2c 0a20 2020 2020 2020  ze": [],.       
-00006520: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
-00006530: 6474 6822 3a20 5b5d 2c0a 2020 2020 2020  dth": [],.      
-00006540: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00006550: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00006560: 6469 736b 5f66 6967 7572 6520 3d20 6669  disk_figure = fi
-00006570: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00006580: 2020 7469 746c 653d 2244 6973 6b20 4261    title="Disk Ba
-00006590: 6e64 7769 6474 6820 2d2d 2043 6f6d 7075  ndwidth -- Compu
-000065a0: 7469 6e67 202e 2e2e 222c 0a20 2020 2020  ting ...",.     
-000065b0: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-000065c0: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-000065d0: 6c62 6172 5f6c 6f63 6174 696f 6e3d 2261  lbar_location="a
-000065e0: 626f 7665 222c 0a20 2020 2020 2020 2020  bove",.         
-000065f0: 2020 2078 5f72 616e 6765 3d46 6163 746f     x_range=Facto
-00006600: 7252 616e 6765 2866 6163 746f 7273 3d5b  rRange(factors=[
-00006610: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00006620: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-00006630: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00006640: 2e64 6973 6b5f 6669 6775 7265 2e76 6261  .disk_figure.vba
-00006650: 7228 0a20 2020 2020 2020 2020 2020 2078  r(.            x
-00006660: 3d22 7369 7a65 222c 2074 6f70 3d22 6261  ="size", top="ba
-00006670: 6e64 7769 6474 6822 2c20 7769 6474 683d  ndwidth", width=
-00006680: 302e 392c 2073 6f75 7263 653d 7365 6c66  0.9, source=self
-00006690: 2e64 6973 6b5f 736f 7572 6365 0a20 2020  .disk_source.   
-000066a0: 2020 2020 2029 0a20 2020 2020 2020 2068       ).        h
-000066b0: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
-000066c0: 280a 2020 2020 2020 2020 2020 2020 6d6f  (.            mo
-000066d0: 6465 3d22 766c 696e 6522 2c20 746f 6f6c  de="vline", tool
-000066e0: 7469 7073 3d5b 2822 4261 6e64 7769 6474  tips=[("Bandwidt
-000066f0: 6822 2c20 2240 6261 6e64 7769 6474 687b  h", "@bandwidth{
-00006700: 302e 3030 2062 7d2f 7322 295d 0a20 2020  0.00 b}/s")].   
-00006710: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00006720: 656c 662e 6469 736b 5f66 6967 7572 652e  elf.disk_figure.
-00006730: 6164 645f 746f 6f6c 7328 686f 7665 7229  add_tools(hover)
-00006740: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-00006750: 736b 5f66 6967 7572 652e 7961 7869 735b  sk_figure.yaxis[
-00006760: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
-00006770: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
-00006780: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-00006790: 6222 290a 2020 2020 2020 2020 7365 6c66  b").        self
-000067a0: 2e64 6973 6b5f 6669 6775 7265 2e78 6772  .disk_figure.xgr
-000067b0: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
-000067c0: 7365 0a0a 2020 2020 2020 2020 2320 4d65  se..        # Me
-000067d0: 6d6f 7279 0a20 2020 2020 2020 2073 656c  mory.        sel
-000067e0: 662e 6d65 6d6f 7279 5f73 6f75 7263 6520  f.memory_source 
-000067f0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-00006800: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00006810: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00006820: 2020 2273 697a 6522 3a20 5b5d 2c0a 2020    "size": [],.  
-00006830: 2020 2020 2020 2020 2020 2020 2020 2262                "b
-00006840: 616e 6477 6964 7468 223a 205b 5d2c 0a20  andwidth": [],. 
-00006850: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00006860: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00006870: 7365 6c66 2e6d 656d 6f72 795f 6669 6775  self.memory_figu
-00006880: 7265 203d 2066 6967 7572 6528 0a20 2020  re = figure(.   
-00006890: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
-000068a0: 4d65 6d6f 7279 2042 616e 6477 6964 7468  Memory Bandwidth
-000068b0: 202d 2d20 436f 6d70 7574 696e 6720 2e2e   -- Computing ..
-000068c0: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
-000068d0: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-000068e0: 2020 2020 2020 746f 6f6c 6261 725f 6c6f        toolbar_lo
-000068f0: 6361 7469 6f6e 3d22 6162 6f76 6522 2c0a  cation="above",.
-00006900: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
-00006910: 6e67 653d 4661 6374 6f72 5261 6e67 6528  nge=FactorRange(
-00006920: 6661 6374 6f72 733d 5b5d 292c 0a20 2020  factors=[]),.   
-00006930: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00006940: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00006950: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
-00006960: 795f 6669 6775 7265 2e76 6261 7228 0a20  y_figure.vbar(. 
-00006970: 2020 2020 2020 2020 2020 2078 3d22 7369             x="si
-00006980: 7a65 222c 2074 6f70 3d22 6261 6e64 7769  ze", top="bandwi
-00006990: 6474 6822 2c20 7769 6474 683d 302e 392c  dth", width=0.9,
-000069a0: 2073 6f75 7263 653d 7365 6c66 2e6d 656d   source=self.mem
-000069b0: 6f72 795f 736f 7572 6365 0a20 2020 2020  ory_source.     
-000069c0: 2020 2029 0a20 2020 2020 2020 2068 6f76     ).        hov
-000069d0: 6572 203d 2048 6f76 6572 546f 6f6c 280a  er = HoverTool(.
-000069e0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-000069f0: 3d22 766c 696e 6522 2c20 746f 6f6c 7469  ="vline", toolti
-00006a00: 7073 3d5b 2822 4261 6e64 7769 6474 6822  ps=[("Bandwidth"
-00006a10: 2c20 2240 6261 6e64 7769 6474 687b 302e  , "@bandwidth{0.
-00006a20: 3030 2062 7d2f 7322 295d 0a20 2020 2020  00 b}/s")].     
-00006a30: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00006a40: 662e 6d65 6d6f 7279 5f66 6967 7572 652e  f.memory_figure.
-00006a50: 6164 645f 746f 6f6c 7328 686f 7665 7229  add_tools(hover)
-00006a60: 0a20 2020 2020 2020 2073 656c 662e 6d65  .        self.me
-00006a70: 6d6f 7279 5f66 6967 7572 652e 7961 7869  mory_figure.yaxi
-00006a80: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
-00006a90: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
-00006aa0: 6174 7465 7228 666f 726d 6174 3d22 302e  atter(format="0.
-00006ab0: 3020 6222 290a 2020 2020 2020 2020 7365  0 b").        se
-00006ac0: 6c66 2e6d 656d 6f72 795f 6669 6775 7265  lf.memory_figure
-00006ad0: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
-00006ae0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-00006af0: 2320 4e65 7477 6f72 6b0a 2020 2020 2020  # Network.      
-00006b00: 2020 7365 6c66 2e6e 6574 776f 726b 5f73    self.network_s
-00006b10: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-00006b20: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
-00006b30: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00006b40: 2020 2020 2020 2020 2273 697a 6522 3a20          "size": 
-00006b50: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00006b60: 2020 2020 2262 616e 6477 6964 7468 223a      "bandwidth":
-00006b70: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00006b80: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
-00006b90: 2020 2020 2020 7365 6c66 2e6e 6574 776f        self.netwo
-00006ba0: 726b 5f66 6967 7572 6520 3d20 6669 6775  rk_figure = figu
-00006bb0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00006bc0: 7469 746c 653d 224e 6574 776f 726b 2042  title="Network B
-00006bd0: 616e 6477 6964 7468 202d 2d20 436f 6d70  andwidth -- Comp
-00006be0: 7574 696e 6720 2e2e 2e22 2c0a 2020 2020  uting ...",.    
-00006bf0: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-00006c00: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00006c10: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
-00006c20: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
-00006c30: 2020 2020 785f 7261 6e67 653d 4661 6374      x_range=Fact
-00006c40: 6f72 5261 6e67 6528 6661 6374 6f72 733d  orRange(factors=
-00006c50: 5b5d 292c 0a20 2020 2020 2020 2020 2020  []),.           
-00006c60: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-00006c70: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00006c80: 6c66 2e6e 6574 776f 726b 5f66 6967 7572  lf.network_figur
-00006c90: 652e 7662 6172 280a 2020 2020 2020 2020  e.vbar(.        
-00006ca0: 2020 2020 783d 2273 697a 6522 2c20 746f      x="size", to
-00006cb0: 703d 2262 616e 6477 6964 7468 222c 2077  p="bandwidth", w
-00006cc0: 6964 7468 3d30 2e39 2c20 736f 7572 6365  idth=0.9, source
-00006cd0: 3d73 656c 662e 6e65 7477 6f72 6b5f 736f  =self.network_so
-00006ce0: 7572 6365 0a20 2020 2020 2020 2029 0a20  urce.        ). 
-00006cf0: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-00006d00: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
-00006d10: 2020 2020 2020 6d6f 6465 3d22 766c 696e        mode="vlin
-00006d20: 6522 2c20 746f 6f6c 7469 7073 3d5b 2822  e", tooltips=[("
-00006d30: 4261 6e64 7769 6474 6822 2c20 2240 6261  Bandwidth", "@ba
-00006d40: 6e64 7769 6474 687b 302e 3030 2062 7d2f  ndwidth{0.00 b}/
-00006d50: 7322 295d 0a20 2020 2020 2020 2029 0a20  s")].        ). 
-00006d60: 2020 2020 2020 2073 656c 662e 6e65 7477         self.netw
-00006d70: 6f72 6b5f 6669 6775 7265 2e61 6464 5f74  ork_figure.add_t
-00006d80: 6f6f 6c73 2868 6f76 6572 290a 2020 2020  ools(hover).    
-00006d90: 2020 2020 7365 6c66 2e6e 6574 776f 726b      self.network
-00006da0: 5f66 6967 7572 652e 7961 7869 735b 305d  _figure.yaxis[0]
-00006db0: 2e66 6f72 6d61 7474 6572 203d 204e 756d  .formatter = Num
-00006dc0: 6572 616c 5469 636b 466f 726d 6174 7465  eralTickFormatte
-00006dd0: 7228 666f 726d 6174 3d22 302e 3020 6222  r(format="0.0 b"
-00006de0: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
-00006df0: 6574 776f 726b 5f66 6967 7572 652e 7867  etwork_figure.xg
-00006e00: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-00006e10: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
-00006e20: 662e 726f 6f74 203d 2072 6f77 280a 2020  f.root = row(.  
-00006e30: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00006e40: 656d 6f72 795f 6669 6775 7265 2c0a 2020  emory_figure,.  
-00006e50: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00006e60: 6973 6b5f 6669 6775 7265 2c0a 2020 2020  isk_figure,.    
-00006e70: 2020 2020 2020 2020 7365 6c66 2e6e 6574          self.net
-00006e80: 776f 726b 5f66 6967 7572 652c 0a20 2020  work_figure,.   
-00006e90: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00006ea0: 7365 6c66 2e6d 656d 6f72 795f 6461 7461  self.memory_data
-00006eb0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00006ec0: 2022 7369 7a65 223a 205b 5d2c 0a20 2020   "size": [],.   
-00006ed0: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
-00006ee0: 6474 6822 3a20 5b5d 2c0a 2020 2020 2020  dth": [],.      
-00006ef0: 2020 7d0a 2020 2020 2020 2020 7365 6c66    }.        self
-00006f00: 2e64 6973 6b5f 6461 7461 203d 207b 0a20  .disk_data = {. 
-00006f10: 2020 2020 2020 2020 2020 2022 7369 7a65             "size
-00006f20: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00006f30: 2020 2022 6261 6e64 7769 6474 6822 3a20     "bandwidth": 
-00006f40: 5b5d 2c0a 2020 2020 2020 2020 7d0a 2020  [],.        }.  
-00006f50: 2020 2020 2020 7365 6c66 2e6e 6574 776f        self.netwo
-00006f60: 726b 5f64 6174 6120 3d20 7b0a 2020 2020  rk_data = {.    
-00006f70: 2020 2020 2020 2020 2273 697a 6522 3a20          "size": 
-00006f80: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00006f90: 2262 616e 6477 6964 7468 223a 205b 5d2c  "bandwidth": [],
-00006fa0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00006fb0: 2020 2020 6173 796e 6320 6465 6620 6628      async def f(
-00006fc0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00006fd0: 6573 756c 7420 3d20 6177 6169 7420 7365  esult = await se
-00006fe0: 6c66 2e73 6368 6564 756c 6572 2e62 656e  lf.scheduler.ben
-00006ff0: 6368 6d61 726b 5f68 6172 6477 6172 6528  chmark_hardware(
-00007000: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
-00007010: 6f72 2073 697a 6520 696e 2073 6f72 7465  or size in sorte
-00007020: 6428 7265 7375 6c74 5b22 6469 736b 225d  d(result["disk"]
-00007030: 2c20 6b65 793d 7061 7273 655f 6279 7465  , key=parse_byte
-00007040: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00007050: 2020 2020 6261 6e64 7769 6474 6820 3d20      bandwidth = 
-00007060: 7265 7375 6c74 5b22 6469 736b 225d 5b73  result["disk"][s
-00007070: 697a 655d 0a20 2020 2020 2020 2020 2020  ize].           
-00007080: 2020 2020 2073 656c 662e 6469 736b 5f64       self.disk_d
-00007090: 6174 615b 2273 697a 6522 5d2e 6170 7065  ata["size"].appe
-000070a0: 6e64 2873 697a 6529 0a20 2020 2020 2020  nd(size).       
-000070b0: 2020 2020 2020 2020 2073 656c 662e 6469           self.di
-000070c0: 736b 5f64 6174 615b 2262 616e 6477 6964  sk_data["bandwid
-000070d0: 7468 225d 2e61 7070 656e 6428 6261 6e64  th"].append(band
-000070e0: 7769 6474 6829 0a0a 2020 2020 2020 2020  width)..        
-000070f0: 2020 2020 666f 7220 7369 7a65 2069 6e20      for size in 
-00007100: 736f 7274 6564 2872 6573 756c 745b 226d  sorted(result["m
-00007110: 656d 6f72 7922 5d2c 206b 6579 3d70 6172  emory"], key=par
-00007120: 7365 5f62 7974 6573 293a 0a20 2020 2020  se_bytes):.     
-00007130: 2020 2020 2020 2020 2020 2062 616e 6477             bandw
-00007140: 6964 7468 203d 2072 6573 756c 745b 226d  idth = result["m
-00007150: 656d 6f72 7922 5d5b 7369 7a65 5d0a 2020  emory"][size].  
-00007160: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00007170: 6c66 2e6d 656d 6f72 795f 6461 7461 5b22  lf.memory_data["
-00007180: 7369 7a65 225d 2e61 7070 656e 6428 7369  size"].append(si
-00007190: 7a65 290a 2020 2020 2020 2020 2020 2020  ze).            
-000071a0: 2020 2020 7365 6c66 2e6d 656d 6f72 795f      self.memory_
-000071b0: 6461 7461 5b22 6261 6e64 7769 6474 6822  data["bandwidth"
-000071c0: 5d2e 6170 7065 6e64 2862 616e 6477 6964  ].append(bandwid
-000071d0: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
-000071e0: 2066 6f72 2073 697a 6520 696e 2073 6f72   for size in sor
-000071f0: 7465 6428 7265 7375 6c74 5b22 6e65 7477  ted(result["netw
-00007200: 6f72 6b22 5d2c 206b 6579 3d70 6172 7365  ork"], key=parse
-00007210: 5f62 7974 6573 293a 0a20 2020 2020 2020  _bytes):.       
-00007220: 2020 2020 2020 2020 2062 616e 6477 6964           bandwid
-00007230: 7468 203d 2072 6573 756c 745b 226e 6574  th = result["net
-00007240: 776f 726b 225d 5b73 697a 655d 0a20 2020  work"][size].   
-00007250: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00007260: 662e 6e65 7477 6f72 6b5f 6461 7461 5b22  f.network_data["
-00007270: 7369 7a65 225d 2e61 7070 656e 6428 7369  size"].append(si
-00007280: 7a65 290a 2020 2020 2020 2020 2020 2020  ze).            
-00007290: 2020 2020 7365 6c66 2e6e 6574 776f 726b      self.network
-000072a0: 5f64 6174 615b 2262 616e 6477 6964 7468  _data["bandwidth
-000072b0: 225d 2e61 7070 656e 6428 6261 6e64 7769  "].append(bandwi
-000072c0: 6474 6829 0a0a 2020 2020 2020 2020 7365  dth)..        se
-000072d0: 6c66 2e73 6368 6564 756c 6572 2e6c 6f6f  lf.scheduler.loo
-000072e0: 702e 6164 645f 6361 6c6c 6261 636b 2866  p.add_callback(f
-000072f0: 290a 0a20 2020 2064 6566 2075 7064 6174  )..    def updat
-00007300: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00007310: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-00007320: 2020 6e6f 7420 7365 6c66 2e64 6973 6b5f    not self.disk_
-00007330: 6461 7461 5b22 7369 7a65 225d 0a20 2020  data["size"].   
-00007340: 2020 2020 2020 2020 206f 7220 7365 6c66           or self
-00007350: 2e64 6973 6b5f 6669 6775 7265 2e74 6974  .disk_figure.tit
-00007360: 6c65 2e74 6578 7420 3d3d 2022 4469 736b  le.text == "Disk
-00007370: 2042 616e 6477 6964 7468 220a 2020 2020   Bandwidth".    
-00007380: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00007390: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-000073a0: 2020 2073 656c 662e 6e65 7477 6f72 6b5f     self.network_
-000073b0: 6669 6775 7265 2e78 5f72 616e 6765 2e66  figure.x_range.f
-000073c0: 6163 746f 7273 203d 2073 656c 662e 6e65  actors = self.ne
-000073d0: 7477 6f72 6b5f 6461 7461 5b22 7369 7a65  twork_data["size
-000073e0: 225d 0a20 2020 2020 2020 2073 656c 662e  "].        self.
-000073f0: 6469 736b 5f66 6967 7572 652e 785f 7261  disk_figure.x_ra
-00007400: 6e67 652e 6661 6374 6f72 7320 3d20 7365  nge.factors = se
-00007410: 6c66 2e64 6973 6b5f 6461 7461 5b22 7369  lf.disk_data["si
-00007420: 7a65 225d 0a20 2020 2020 2020 2073 656c  ze"].        sel
-00007430: 662e 6d65 6d6f 7279 5f66 6967 7572 652e  f.memory_figure.
-00007440: 785f 7261 6e67 652e 6661 6374 6f72 7320  x_range.factors 
-00007450: 3d20 7365 6c66 2e6d 656d 6f72 795f 6461  = self.memory_da
-00007460: 7461 5b22 7369 7a65 225d 0a20 2020 2020  ta["size"].     
-00007470: 2020 2075 7064 6174 6528 7365 6c66 2e64     update(self.d
-00007480: 6973 6b5f 736f 7572 6365 2c20 7365 6c66  isk_source, self
-00007490: 2e64 6973 6b5f 6461 7461 290a 2020 2020  .disk_data).    
-000074a0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-000074b0: 6d65 6d6f 7279 5f73 6f75 7263 652c 2073  memory_source, s
-000074c0: 656c 662e 6d65 6d6f 7279 5f64 6174 6129  elf.memory_data)
-000074d0: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
-000074e0: 7365 6c66 2e6e 6574 776f 726b 5f73 6f75  self.network_sou
-000074f0: 7263 652c 2073 656c 662e 6e65 7477 6f72  rce, self.networ
-00007500: 6b5f 6461 7461 290a 2020 2020 2020 2020  k_data).        
-00007510: 7365 6c66 2e6d 656d 6f72 795f 6669 6775  self.memory_figu
-00007520: 7265 2e74 6974 6c65 2e74 6578 7420 3d20  re.title.text = 
-00007530: 224d 656d 6f72 7920 4261 6e64 7769 6474  "Memory Bandwidt
-00007540: 6822 0a20 2020 2020 2020 2073 656c 662e  h".        self.
-00007550: 6469 736b 5f66 6967 7572 652e 7469 746c  disk_figure.titl
-00007560: 652e 7465 7874 203d 2022 4469 736b 2042  e.text = "Disk B
-00007570: 616e 6477 6964 7468 220a 2020 2020 2020  andwidth".      
-00007580: 2020 7365 6c66 2e6e 6574 776f 726b 5f66    self.network_f
-00007590: 6967 7572 652e 7469 746c 652e 7465 7874  igure.title.text
-000075a0: 203d 2022 4e65 7477 6f72 6b20 4261 6e64   = "Network Band
-000075b0: 7769 6474 6822 0a0a 0a63 6c61 7373 2042  width"...class B
-000075c0: 616e 6477 6964 7468 5479 7065 7328 4461  andwidthTypes(Da
-000075d0: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-000075e0: 293a 0a20 2020 2022 2222 4261 7220 6368  ):.    """Bar ch
-000075f0: 6172 7420 7368 6f77 696e 6720 6261 6e64  art showing band
-00007600: 7769 6474 6820 7065 7220 7479 7065 2222  width per type""
-00007610: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
-00007620: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-00007630: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-00007640: 6c65 722c 202a 2a6b 7761 7267 7329 3a0a  ler, **kwargs):.
-00007650: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-00007660: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-00007670: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-00007680: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-00007690: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
-000076a0: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-000076b0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000076c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000076d0: 6261 6e64 7769 6474 6822 3a20 5b31 2c20  bandwidth": [1, 
-000076e0: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
-000076f0: 2020 2020 2262 616e 6477 6964 7468 2d68      "bandwidth-h
-00007700: 616c 6622 3a20 5b30 2e35 2c20 315d 2c0a  alf": [0.5, 1],.
-00007710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007720: 2274 7970 6522 3a20 5b22 6122 2c20 2262  "type": ["a", "b
-00007730: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00007740: 2020 2020 2262 616e 6477 6964 7468 5f74      "bandwidth_t
-00007750: 6578 7422 3a20 5b22 3122 2c20 2232 225d  ext": ["1", "2"]
-00007760: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00007770: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00007780: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
-00007790: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-000077a0: 2020 2074 6974 6c65 3d22 4261 6e64 7769     title="Bandwi
-000077b0: 6474 6820 6279 2054 7970 6522 2c0a 2020  dth by Type",.  
-000077c0: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-000077d0: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-000077e0: 6e61 6d65 3d22 6261 6e64 7769 6474 685f  name="bandwidth_
-000077f0: 7479 7065 5f68 6973 746f 6772 616d 222c  type_histogram",
-00007800: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
-00007810: 616e 6765 3d5b 2261 222c 2022 6222 5d2c  ange=["a", "b"],
-00007820: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-00007830: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-00007840: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00007850: 6f74 2e78 6178 6973 2e6d 616a 6f72 5f6c  ot.xaxis.major_l
-00007860: 6162 656c 5f6f 7269 656e 7461 7469 6f6e  abel_orientation
-00007870: 203d 202d 302e 350a 2020 2020 2020 2020   = -0.5.        
-00007880: 7265 6374 203d 2073 656c 662e 726f 6f74  rect = self.root
-00007890: 2e72 6563 7428 0a20 2020 2020 2020 2020  .rect(.         
-000078a0: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
-000078b0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
-000078c0: 2020 2078 3d22 6261 6e64 7769 6474 682d     x="bandwidth-
-000078d0: 6861 6c66 222c 0a20 2020 2020 2020 2020  half",.         
-000078e0: 2020 2079 3d22 7479 7065 222c 0a20 2020     y="type",.   
-000078f0: 2020 2020 2020 2020 2077 6964 7468 3d22           width="
-00007900: 6261 6e64 7769 6474 6822 2c0a 2020 2020  bandwidth",.    
-00007910: 2020 2020 2020 2020 6865 6967 6874 3d30          height=0
-00007920: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
-00007930: 636f 6c6f 723d 2262 6c75 6522 2c0a 2020  color="blue",.  
-00007940: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00007950: 7365 6c66 2e72 6f6f 742e 785f 7261 6e67  self.root.x_rang
-00007960: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
-00007970: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00007980: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-00007990: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-000079a0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-000079b0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
-000079c0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-000079d0: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
-000079e0: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
-000079f0: 3130 3234 290a 2020 2020 2020 2020 7265  1024).        re
-00007a00: 6374 2e6e 6f6e 7365 6c65 6374 696f 6e5f  ct.nonselection_
-00007a10: 676c 7970 6820 3d20 4e6f 6e65 0a0a 2020  glyph = None..  
-00007a20: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00007a30: 7861 7869 732e 6d69 6e6f 725f 7469 636b  xaxis.minor_tick
-00007a40: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-00007a50: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00007a60: 742e 7967 7269 642e 7669 7369 626c 6520  t.ygrid.visible 
-00007a70: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
-00007a80: 2073 656c 662e 726f 6f74 2e74 6f6f 6c62   self.root.toolb
-00007a90: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
-00007aa0: 6e65 0a0a 2020 2020 2020 2020 686f 7665  ne..        hove
-00007ab0: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
-00007ac0: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
-00007ad0: 6f6c 7469 7073 203d 2022 4074 7970 653a  oltips = "@type:
-00007ae0: 2040 6261 6e64 7769 6474 685f 7465 7874   @bandwidth_text
-00007af0: 202f 2073 220a 2020 2020 2020 2020 686f   / s".        ho
-00007b00: 7665 722e 706f 696e 745f 706f 6c69 6379  ver.point_policy
-00007b10: 203d 2022 666f 6c6c 6f77 5f6d 6f75 7365   = "follow_mouse
-00007b20: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
-00007b30: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
-00007b40: 7665 7229 0a0a 2020 2020 4077 6974 686f  ver)..    @witho
-00007b50: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00007b60: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-00007b70: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-00007b80: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-00007b90: 2020 2020 2062 7720 3d20 7365 6c66 2e73       bw = self.s
-00007ba0: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
-00007bb0: 7468 5f74 7970 6573 0a20 2020 2020 2020  th_types.       
-00007bc0: 2073 656c 662e 726f 6f74 2e79 5f72 616e   self.root.y_ran
-00007bd0: 6765 2e66 6163 746f 7273 203d 206c 6973  ge.factors = lis
-00007be0: 7428 736f 7274 6564 2862 7729 290a 2020  t(sorted(bw)).  
-00007bf0: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
-00007c00: 0a20 2020 2020 2020 2020 2020 2022 6261  .            "ba
-00007c10: 6e64 7769 6474 6822 3a20 6c69 7374 2862  ndwidth": list(b
-00007c20: 772e 7661 6c75 6573 2829 292c 0a20 2020  w.values()),.   
-00007c30: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
-00007c40: 6474 682d 6861 6c66 223a 205b 6220 2f20  dth-half": [b / 
-00007c50: 3220 666f 7220 6220 696e 2062 772e 7661  2 for b in bw.va
-00007c60: 6c75 6573 2829 5d2c 0a20 2020 2020 2020  lues()],.       
-00007c70: 2020 2020 2022 7479 7065 223a 206c 6973       "type": lis
-00007c80: 7428 6277 2e6b 6579 7328 2929 2c0a 2020  t(bw.keys()),.  
-00007c90: 2020 2020 2020 2020 2020 2262 616e 6477            "bandw
-00007ca0: 6964 7468 5f74 6578 7422 3a20 5b66 6f72  idth_text": [for
-00007cb0: 6d61 745f 6279 7465 7328 7829 2066 6f72  mat_bytes(x) for
-00007cc0: 2078 2069 6e20 6277 2e76 616c 7565 7328   x in bw.values(
-00007cd0: 295d 2c0a 2020 2020 2020 2020 7d0a 2020  )],.        }.  
-00007ce0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00007cf0: 7469 746c 652e 7465 7874 203d 2022 4261  title.text = "Ba
-00007d00: 6e64 7769 6474 683a 2022 202b 2066 6f72  ndwidth: " + for
-00007d10: 6d61 745f 6279 7465 7328 7365 6c66 2e73  mat_bytes(self.s
-00007d20: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
-00007d30: 7468 290a 2020 2020 2020 2020 7570 6461  th).        upda
-00007d40: 7465 2873 656c 662e 736f 7572 6365 2c20  te(self.source, 
-00007d50: 7265 7375 6c74 290a 0a0a 636c 6173 7320  result)...class 
-00007d60: 4261 6e64 7769 6474 6857 6f72 6b65 7273  BandwidthWorkers
-00007d70: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
-00007d80: 656e 7429 3a0a 2020 2020 2222 2248 6f77  ent):.    """How
-00007d90: 206d 616e 7920 7461 736b 7320 6172 6520   many tasks are 
-00007da0: 6f6e 2065 6163 6820 776f 726b 6572 2222  on each worker""
-00007db0: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
-00007dc0: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-00007dd0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-00007de0: 6c65 722c 202a 2a6b 7761 7267 7329 3a0a  ler, **kwargs):.
-00007df0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-00007e00: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-00007e10: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-00007e20: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-00007e30: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
-00007e40: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-00007e50: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00007e60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00007e70: 6261 6e64 7769 6474 6822 3a20 5b31 2c20  bandwidth": [1, 
-00007e80: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
-00007e90: 2020 2020 2273 6f75 7263 6522 3a20 5b22      "source": ["
-00007ea0: 6122 2c20 2262 225d 2c0a 2020 2020 2020  a", "b"],.      
-00007eb0: 2020 2020 2020 2020 2020 2264 6573 7469            "desti
-00007ec0: 6e61 7469 6f6e 223a 205b 2261 222c 2022  nation": ["a", "
-00007ed0: 6222 5d2c 0a20 2020 2020 2020 2020 2020  b"],.           
-00007ee0: 2020 2020 2022 6261 6e64 7769 6474 685f       "bandwidth_
-00007ef0: 7465 7874 223a 205b 2231 222c 2022 3222  text": ["1", "2"
-00007f00: 5d2c 0a20 2020 2020 2020 2020 2020 207d  ],.            }
-00007f10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00007f20: 2020 2020 7661 6c75 6573 203d 205b 6865      values = [he
-00007f30: 7828 7829 5b32 3a5d 2066 6f72 2078 2069  x(x)[2:] for x i
-00007f40: 6e20 7261 6e67 6528 3634 2c20 3235 3629  n range(64, 256)
-00007f50: 5d5b 3a3a 2d31 5d0a 2020 2020 2020 2020  ][::-1].        
-00007f60: 6d61 7070 6572 203d 206c 696e 6561 725f  mapper = linear_
-00007f70: 636d 6170 280a 2020 2020 2020 2020 2020  cmap(.          
-00007f80: 2020 6669 656c 645f 6e61 6d65 3d22 6261    field_name="ba
-00007f90: 6e64 7769 6474 6822 2c0a 2020 2020 2020  ndwidth",.      
-00007fa0: 2020 2020 2020 7061 6c65 7474 653d 5b22        palette=["
-00007fb0: 2322 202b 2078 202b 2078 202b 2022 4646  #" + x + x + "FF
-00007fc0: 2220 666f 7220 7820 696e 2076 616c 7565  " for x in value
-00007fd0: 735d 2c0a 2020 2020 2020 2020 2020 2020  s],.            
-00007fe0: 6c6f 773d 302c 0a20 2020 2020 2020 2020  low=0,.         
-00007ff0: 2020 2068 6967 683d 312c 0a20 2020 2020     high=1,.     
-00008000: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00008010: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
-00008020: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-00008030: 746c 653d 2242 616e 6477 6964 7468 2062  tle="Bandwidth b
-00008040: 7920 576f 726b 6572 222c 0a20 2020 2020  y Worker",.     
-00008050: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-00008060: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00008070: 653d 2262 616e 6477 6964 7468 5f77 6f72  e="bandwidth_wor
-00008080: 6b65 725f 6865 6174 6d61 7022 2c0a 2020  ker_heatmap",.  
-00008090: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
-000080a0: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
-000080b0: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
-000080c0: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
-000080d0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-000080e0: 6773 2c0a 2020 2020 2020 2020 290a 2020  gs,.        ).  
-000080f0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00008100: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
-00008110: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
-00008120: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
-00008130: 4f4e 0a20 2020 2020 2020 2073 656c 662e  ON.        self.
-00008140: 726f 6f74 2e72 6563 7428 0a20 2020 2020  root.rect(.     
-00008150: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-00008160: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-00008170: 2020 2020 2020 2078 3d22 736f 7572 6365         x="source
-00008180: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-00008190: 3d22 6465 7374 696e 6174 696f 6e22 2c0a  ="destination",.
-000081a0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-000081b0: 723d 6d61 7070 6572 2c0a 2020 2020 2020  r=mapper,.      
-000081c0: 2020 2020 2020 6865 6967 6874 3d31 2c0a        height=1,.
-000081d0: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-000081e0: 683d 312c 0a20 2020 2020 2020 2029 0a0a  h=1,.        )..
-000081f0: 2020 2020 2020 2020 7365 6c66 2e63 6f6c          self.col
-00008200: 6f72 5f6d 6170 203d 206d 6170 7065 725b  or_map = mapper[
-00008210: 2274 7261 6e73 666f 726d 225d 0a20 2020  "transform"].   
-00008220: 2020 2020 2063 6f6c 6f72 5f62 6172 203d       color_bar =
-00008230: 2043 6f6c 6f72 4261 7228 0a20 2020 2020   ColorBar(.     
-00008240: 2020 2020 2020 2063 6f6c 6f72 5f6d 6170         color_map
-00008250: 7065 723d 7365 6c66 2e63 6f6c 6f72 5f6d  per=self.color_m
-00008260: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
-00008270: 6c61 6265 6c5f 7374 616e 646f 6666 3d31  label_standoff=1
-00008280: 322c 0a20 2020 2020 2020 2020 2020 2062  2,.            b
-00008290: 6f72 6465 725f 6c69 6e65 5f63 6f6c 6f72  order_line_color
-000082a0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-000082b0: 2020 206c 6f63 6174 696f 6e3d 2830 2c20     location=(0, 
-000082c0: 3029 2c0a 2020 2020 2020 2020 290a 2020  0),.        ).  
-000082d0: 2020 2020 2020 636f 6c6f 725f 6261 722e        color_bar.
-000082e0: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
-000082f0: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
-00008300: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
-00008310: 0a20 2020 2020 2020 2063 6f6c 6f72 5f62  .        color_b
-00008320: 6172 2e74 6963 6b65 7220 3d20 4164 6170  ar.ticker = Adap
-00008330: 7469 7665 5469 636b 6572 282a 2a54 4943  tiveTicker(**TIC
-00008340: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
-00008350: 2073 656c 662e 726f 6f74 2e61 6464 5f6c   self.root.add_l
-00008360: 6179 6f75 7428 636f 6c6f 725f 6261 722c  ayout(color_bar,
-00008370: 2022 7269 6768 7422 290a 0a20 2020 2020   "right")..     
-00008380: 2020 2073 656c 662e 726f 6f74 2e74 6f6f     self.root.too
-00008390: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
-000083a0: 4e6f 6e65 0a0a 2020 2020 2020 2020 686f  None..        ho
-000083b0: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
-000083c0: 290a 2020 2020 2020 2020 686f 7665 722e  ).        hover.
-000083d0: 746f 6f6c 7469 7073 203d 2022 2222 0a20  tooltips = """. 
-000083e0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-000083f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008400: 203c 703e 3c62 3e53 6f75 7263 653a 3c2f   <p><b>Source:</
-00008410: 623e 2040 736f 7572 6365 203c 2f70 3e0a  b> @source </p>.
-00008420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008430: 3c70 3e3c 623e 4465 7374 696e 6174 696f  <p><b>Destinatio
-00008440: 6e3a 3c2f 623e 2040 6465 7374 696e 6174  n:</b> @destinat
-00008450: 696f 6e20 3c2f 703e 0a20 2020 2020 2020  ion </p>.       
-00008460: 2020 2020 2020 2020 203c 703e 3c62 3e42           <p><b>B
-00008470: 616e 6477 6964 7468 3a3c 2f62 3e20 4062  andwidth:</b> @b
-00008480: 616e 6477 6964 7468 5f74 6578 7420 2f20  andwidth_text / 
-00008490: 733c 2f70 3e0a 2020 2020 2020 2020 2020  s</p>.          
-000084a0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-000084b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000084c0: 2068 6f76 6572 2e70 6f69 6e74 5f70 6f6c   hover.point_pol
-000084d0: 6963 7920 3d20 2266 6f6c 6c6f 775f 6d6f  icy = "follow_mo
-000084e0: 7573 6522 0a20 2020 2020 2020 2073 656c  use".        sel
-000084f0: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
-00008500: 2868 6f76 6572 290a 0a20 2020 2040 7769  (hover)..    @wi
-00008510: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
-00008520: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
-00008530: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-00008540: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
-00008550: 2020 2020 2020 2020 6277 203d 2073 656c          bw = sel
-00008560: 662e 7363 6865 6475 6c65 722e 6261 6e64  f.scheduler.band
-00008570: 7769 6474 685f 776f 726b 6572 730a 2020  width_workers.  
-00008580: 2020 2020 2020 6966 206e 6f74 2062 773a        if not bw:
-00008590: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000085a0: 7572 6e0a 0a20 2020 2020 2020 2064 6566  urn..        def
-000085b0: 206e 616d 6528 6164 6472 6573 7329 3a0a   name(address):.
-000085c0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000085d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000085e0: 2077 7320 3d20 7365 6c66 2e73 6368 6564   ws = self.sched
-000085f0: 756c 6572 2e77 6f72 6b65 7273 5b61 6464  uler.workers[add
-00008600: 7265 7373 5d0a 2020 2020 2020 2020 2020  ress].          
-00008610: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00008620: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00008630: 2020 2072 6574 7572 6e20 6164 6472 6573     return addres
-00008640: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-00008650: 2077 732e 6e61 6d65 2069 7320 6e6f 7420   ws.name is not 
-00008660: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00008670: 2020 2020 2020 7265 7475 726e 2073 7472        return str
-00008680: 2877 732e 6e61 6d65 290a 2020 2020 2020  (ws.name).      
-00008690: 2020 2020 2020 7265 7475 726e 2061 6464        return add
-000086a0: 7265 7373 0a0a 2020 2020 2020 2020 782c  ress..        x,
-000086b0: 2079 2c20 7661 6c75 6520 3d20 7a69 7028   y, value = zip(
-000086c0: 2a28 286e 616d 6528 6129 2c20 6e61 6d65  *((name(a), name
-000086d0: 2862 292c 2063 2920 666f 7220 2861 2c20  (b), c) for (a, 
-000086e0: 6229 2c20 6320 696e 2062 772e 6974 656d  b), c in bw.item
-000086f0: 7328 2929 290a 0a20 2020 2020 2020 2073  s()))..        s
-00008700: 656c 662e 636f 6c6f 725f 6d61 702e 6869  elf.color_map.hi
-00008710: 6768 203d 206d 6178 2876 616c 7565 290a  gh = max(value).
-00008720: 0a20 2020 2020 2020 2066 6163 746f 7273  .        factors
-00008730: 203d 206c 6973 7428 736f 7274 6564 2873   = list(sorted(s
-00008740: 6574 2878 202b 2079 2929 290a 2020 2020  et(x + y))).    
-00008750: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
-00008760: 7261 6e67 652e 6661 6374 6f72 7320 3d20  range.factors = 
-00008770: 6661 6374 6f72 730a 2020 2020 2020 2020  factors.        
-00008780: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
-00008790: 652e 6661 6374 6f72 7320 3d20 6661 6374  e.factors = fact
-000087a0: 6f72 735b 3a3a 2d31 5d0a 0a20 2020 2020  ors[::-1]..     
-000087b0: 2020 2072 6573 756c 7420 3d20 7b0a 2020     result = {.  
-000087c0: 2020 2020 2020 2020 2020 2273 6f75 7263            "sourc
-000087d0: 6522 3a20 782c 0a20 2020 2020 2020 2020  e": x,.         
-000087e0: 2020 2022 6465 7374 696e 6174 696f 6e22     "destination"
-000087f0: 3a20 792c 0a20 2020 2020 2020 2020 2020  : y,.           
-00008800: 2022 6261 6e64 7769 6474 6822 3a20 7661   "bandwidth": va
-00008810: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-00008820: 2022 6261 6e64 7769 6474 685f 7465 7874   "bandwidth_text
-00008830: 223a 206c 6973 7428 6d61 7028 666f 726d  ": list(map(form
-00008840: 6174 5f62 7974 6573 2c20 7661 6c75 6529  at_bytes, value)
-00008850: 292c 0a20 2020 2020 2020 207d 0a20 2020  ),.        }.   
-00008860: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
-00008870: 6974 6c65 2e74 6578 7420 3d20 2242 616e  itle.text = "Ban
-00008880: 6477 6964 7468 3a20 2220 2b20 666f 726d  dwidth: " + form
-00008890: 6174 5f62 7974 6573 2873 656c 662e 7363  at_bytes(self.sc
-000088a0: 6865 6475 6c65 722e 6261 6e64 7769 6474  heduler.bandwidt
-000088b0: 6829 0a20 2020 2020 2020 2075 7064 6174  h).        updat
-000088c0: 6528 7365 6c66 2e73 6f75 7263 652c 2072  e(self.source, r
-000088d0: 6573 756c 7429 0a0a 0a63 6c61 7373 2057  esult)...class W
-000088e0: 6f72 6b65 724e 6574 776f 726b 4261 6e64  orkerNetworkBand
-000088f0: 7769 6474 6828 4461 7368 626f 6172 6443  width(DashboardC
-00008900: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-00008910: 2222 576f 726b 6572 206e 6574 776f 726b  ""Worker network
-00008920: 2062 616e 6477 6964 7468 2063 6861 7274   bandwidth chart
-00008930: 0a0a 2020 2020 506c 6f74 7320 686f 7269  ..    Plots hori
-00008940: 7a6f 6e74 616c 2062 6172 7320 7769 7468  zontal bars with
-00008950: 2074 6865 2068 6f73 745f 6e65 745f 696f   the host_net_io
-00008960: 2e72 6561 645f 6270 7320 616e 6420 686f  .read_bps and ho
-00008970: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
-00008980: 6270 7320 776f 726b 6572 0a20 2020 2073  bps worker.    s
-00008990: 7461 7465 0a20 2020 2022 2222 0a0a 2020  tate.    """..  
-000089a0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-000089b0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-000089c0: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
-000089d0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-000089e0: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-000089f0: 7220 3d20 7363 6865 6475 6c65 720a 2020  r = scheduler.  
-00008a00: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
-00008a10: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
-00008a20: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
-00008a30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00008a40: 2020 2020 2279 5f72 6561 6422 3a20 5b5d      "y_read": []
-00008a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008a60: 2020 2279 5f77 7269 7465 223a 205b 5d2c    "y_write": [],
-00008a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008a80: 2022 785f 7265 6164 223a 205b 5d2c 0a20   "x_read": [],. 
-00008a90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00008aa0: 785f 7772 6974 6522 3a20 5b5d 2c0a 2020  x_write": [],.  
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2278                "x
-00008ac0: 5f72 6561 645f 6469 736b 223a 205b 5d2c  _read_disk": [],
-00008ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008ae0: 2022 785f 7772 6974 655f 6469 736b 223a   "x_write_disk":
-00008af0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00008b00: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
-00008b10: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-00008b20: 6964 7468 203d 2066 6967 7572 6528 0a20  idth = figure(. 
-00008b30: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-00008b40: 3d22 576f 726b 6572 204e 6574 776f 726b  ="Worker Network
-00008b50: 2042 616e 6477 6964 7468 222c 0a20 2020   Bandwidth",.   
-00008b60: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
-00008b70: 222c 0a20 2020 2020 2020 2020 2020 206e  ",.            n
-00008b80: 616d 653d 2277 6f72 6b65 725f 6e65 7477  ame="worker_netw
-00008b90: 6f72 6b5f 6261 6e64 7769 6474 6822 2c0a  ork_bandwidth",.
-00008ba0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-00008bb0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-00008bc0: 0a20 2020 2020 2020 2023 2068 6f73 745f  .        # host_
-00008bd0: 6e65 745f 696f 2e72 6561 645f 6270 730a  net_io.read_bps.
-00008be0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-00008bf0: 6477 6964 7468 2e68 6261 7228 0a20 2020  dwidth.hbar(.   
-00008c00: 2020 2020 2020 2020 2079 3d22 795f 7265           y="y_re
-00008c10: 6164 222c 0a20 2020 2020 2020 2020 2020  ad",.           
-00008c20: 2072 6967 6874 3d22 785f 7265 6164 222c   right="x_read",
-00008c30: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00008c40: 655f 636f 6c6f 723d 4e6f 6e65 2c0a 2020  e_color=None,.  
-00008c50: 2020 2020 2020 2020 2020 6c65 6674 3d30            left=0
-00008c60: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
-00008c70: 6967 6874 3d30 2e35 2c0a 2020 2020 2020  ight=0.5,.      
-00008c80: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
-00008c90: 3d22 7265 6422 2c0a 2020 2020 2020 2020  ="red",.        
-00008ca0: 2020 2020 6c65 6765 6e64 5f6c 6162 656c      legend_label
-00008cb0: 3d22 7265 6164 222c 0a20 2020 2020 2020  ="read",.       
-00008cc0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00008cd0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-00008ce0: 2029 0a0a 2020 2020 2020 2020 2320 686f   )..        # ho
-00008cf0: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
-00008d00: 6270 730a 2020 2020 2020 2020 7365 6c66  bps.        self
-00008d10: 2e62 616e 6477 6964 7468 2e68 6261 7228  .bandwidth.hbar(
-00008d20: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
-00008d30: 795f 7772 6974 6522 2c0a 2020 2020 2020  y_write",.      
-00008d40: 2020 2020 2020 7269 6768 743d 2278 5f77        right="x_w
-00008d50: 7269 7465 222c 0a20 2020 2020 2020 2020  rite",.         
-00008d60: 2020 206c 696e 655f 636f 6c6f 723d 4e6f     line_color=No
-00008d70: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00008d80: 6c65 6674 3d30 2c0a 2020 2020 2020 2020  left=0,.        
-00008d90: 2020 2020 6865 6967 6874 3d30 2e35 2c0a      height=0.5,.
-00008da0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00008db0: 5f63 6f6c 6f72 3d22 626c 7565 222c 0a20  _color="blue",. 
-00008dc0: 2020 2020 2020 2020 2020 206c 6567 656e             legen
-00008dd0: 645f 6c61 6265 6c3d 2277 7269 7465 222c  d_label="write",
-00008de0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00008df0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-00008e00: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00008e10: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-00008e20: 7468 2e61 7869 735b 305d 2e74 6963 6b65  th.axis[0].ticke
-00008e30: 7220 3d20 4261 7369 6354 6963 6b65 7228  r = BasicTicker(
-00008e40: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
-00008e50: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-00008e60: 6964 7468 2e78 6178 6973 5b30 5d2e 666f  idth.xaxis[0].fo
-00008e70: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
-00008e80: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
-00008e90: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
-00008ea0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-00008eb0: 7769 6474 682e 7861 7869 732e 6d61 6a6f  width.xaxis.majo
-00008ec0: 725f 6c61 6265 6c5f 6f72 6965 6e74 6174  r_label_orientat
-00008ed0: 696f 6e20 3d20 584c 4142 454c 5f4f 5249  ion = XLABEL_ORI
-00008ee0: 454e 5441 5449 4f4e 0a20 2020 2020 2020  ENTATION.       
-00008ef0: 2073 656c 662e 6261 6e64 7769 6474 682e   self.bandwidth.
-00008f00: 7861 7869 732e 6d69 6e6f 725f 7469 636b  xaxis.minor_tick
-00008f10: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-00008f20: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-00008f30: 6477 6964 7468 2e78 5f72 616e 6765 203d  dwidth.x_range =
-00008f40: 2052 616e 6765 3164 2873 7461 7274 3d30   Range1d(start=0
-00008f50: 290a 2020 2020 2020 2020 7365 6c66 2e62  ).        self.b
-00008f60: 616e 6477 6964 7468 2e79 6178 6973 2e76  andwidth.yaxis.v
-00008f70: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-00008f80: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-00008f90: 7769 6474 682e 7967 7269 642e 7669 7369  width.ygrid.visi
-00008fa0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00008fb0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-00008fc0: 7468 2e74 6f6f 6c62 6172 5f6c 6f63 6174  th.toolbar_locat
-00008fd0: 696f 6e20 3d20 4e6f 6e65 0a0a 2020 2020  ion = None..    
-00008fe0: 2020 2020 7365 6c66 2e64 6973 6b20 3d20      self.disk = 
-00008ff0: 6669 6775 7265 280a 2020 2020 2020 2020  figure(.        
-00009000: 2020 2020 7469 746c 653d 2257 6f72 6b65      title="Worke
-00009010: 7273 2044 6973 6b22 2c0a 2020 2020 2020  rs Disk",.      
-00009020: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-00009030: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00009040: 3d22 776f 726b 6572 5f64 6973 6b22 2c0a  ="worker_disk",.
-00009050: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-00009060: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-00009070: 0a20 2020 2020 2020 2023 2068 6f73 745f  .        # host_
-00009080: 6469 736b 5f69 6f2e 7265 6164 5f62 7073  disk_io.read_bps
-00009090: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-000090a0: 736b 2e68 6261 7228 0a20 2020 2020 2020  sk.hbar(.       
-000090b0: 2020 2020 2079 3d22 795f 7265 6164 222c       y="y_read",
-000090c0: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-000090d0: 6874 3d22 785f 7265 6164 5f64 6973 6b22  ht="x_read_disk"
-000090e0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-000090f0: 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20  ne_color=None,. 
-00009100: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-00009110: 302c 0a20 2020 2020 2020 2020 2020 2068  0,.            h
-00009120: 6569 6768 743d 302e 352c 0a20 2020 2020  eight=0.5,.     
-00009130: 2020 2020 2020 2066 696c 6c5f 636f 6c6f         fill_colo
-00009140: 723d 2272 6564 222c 0a20 2020 2020 2020  r="red",.       
-00009150: 2020 2020 206c 6567 656e 645f 6c61 6265       legend_labe
-00009160: 6c3d 2272 6561 6422 2c0a 2020 2020 2020  l="read",.      
-00009170: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-00009180: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-00009190: 2020 290a 0a20 2020 2020 2020 2023 2068    )..        # h
-000091a0: 6f73 745f 6469 736b 5f69 6f2e 7772 6974  ost_disk_io.writ
-000091b0: 655f 6270 730a 2020 2020 2020 2020 7365  e_bps.        se
-000091c0: 6c66 2e64 6973 6b2e 6862 6172 280a 2020  lf.disk.hbar(.  
-000091d0: 2020 2020 2020 2020 2020 793d 2279 5f77            y="y_w
-000091e0: 7269 7465 222c 0a20 2020 2020 2020 2020  rite",.         
-000091f0: 2020 2072 6967 6874 3d22 785f 7772 6974     right="x_writ
-00009200: 655f 6469 736b 222c 0a20 2020 2020 2020  e_disk",.       
-00009210: 2020 2020 206c 696e 655f 636f 6c6f 723d       line_color=
-00009220: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00009230: 2020 6c65 6674 3d30 2c0a 2020 2020 2020    left=0,.      
-00009240: 2020 2020 2020 6865 6967 6874 3d30 2e35        height=0.5
-00009250: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-00009260: 6c6c 5f63 6f6c 6f72 3d22 626c 7565 222c  ll_color="blue",
-00009270: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
-00009280: 656e 645f 6c61 6265 6c3d 2277 7269 7465  end_label="write
-00009290: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-000092a0: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-000092b0: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-000092c0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
-000092d0: 6178 6973 5b30 5d2e 7469 636b 6572 203d  axis[0].ticker =
-000092e0: 2042 6173 6963 5469 636b 6572 282a 2a54   BasicTicker(**T
-000092f0: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
-00009300: 2020 2073 656c 662e 6469 736b 2e78 6178     self.disk.xax
-00009310: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
-00009320: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
-00009330: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00009340: 2e30 2062 2229 0a20 2020 2020 2020 2073  .0 b").        s
-00009350: 656c 662e 6469 736b 2e78 6178 6973 2e6d  elf.disk.xaxis.m
-00009360: 616a 6f72 5f6c 6162 656c 5f6f 7269 656e  ajor_label_orien
-00009370: 7461 7469 6f6e 203d 2058 4c41 4245 4c5f  tation = XLABEL_
-00009380: 4f52 4945 4e54 4154 494f 4e0a 2020 2020  ORIENTATION.    
-00009390: 2020 2020 7365 6c66 2e64 6973 6b2e 7861      self.disk.xa
-000093a0: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
-000093b0: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
-000093c0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
-000093d0: 785f 7261 6e67 6520 3d20 5261 6e67 6531  x_range = Range1
-000093e0: 6428 7374 6172 743d 3029 0a20 2020 2020  d(start=0).     
-000093f0: 2020 2073 656c 662e 6469 736b 2e79 6178     self.disk.yax
-00009400: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-00009410: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
-00009420: 6469 736b 2e79 6772 6964 2e76 6973 6962  disk.ygrid.visib
-00009430: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-00009440: 2020 2073 656c 662e 6469 736b 2e74 6f6f     self.disk.too
-00009450: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
-00009460: 4e6f 6e65 0a0a 2020 2020 4077 6974 686f  None..    @witho
-00009470: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00009480: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-00009490: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-000094a0: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-000094b0: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
-000094c0: 656c 662e 7363 6865 6475 6c65 722e 776f  elf.scheduler.wo
-000094d0: 726b 6572 732e 7661 6c75 6573 2829 0a0a  rkers.values()..
-000094e0: 2020 2020 2020 2020 6820 3d20 302e 310a          h = 0.1.
-000094f0: 2020 2020 2020 2020 795f 7265 6164 203d          y_read =
-00009500: 205b 6920 2b20 302e 3735 202b 2069 202a   [i + 0.75 + i *
-00009510: 2068 2066 6f72 2069 2069 6e20 7261 6e67   h for i in rang
-00009520: 6528 6c65 6e28 776f 726b 6572 7329 295d  e(len(workers))]
-00009530: 0a20 2020 2020 2020 2079 5f77 7269 7465  .        y_write
-00009540: 203d 205b 6920 2b20 302e 3235 202b 2069   = [i + 0.25 + i
-00009550: 202a 2068 2066 6f72 2069 2069 6e20 7261   * h for i in ra
-00009560: 6e67 6528 6c65 6e28 776f 726b 6572 7329  nge(len(workers)
-00009570: 295d 0a0a 2020 2020 2020 2020 785f 7265  )]..        x_re
-00009580: 6164 203d 205b 5d0a 2020 2020 2020 2020  ad = [].        
-00009590: 785f 7772 6974 6520 3d20 5b5d 0a20 2020  x_write = [].   
-000095a0: 2020 2020 2078 5f72 6561 645f 6469 736b       x_read_disk
-000095b0: 203d 205b 5d0a 2020 2020 2020 2020 785f   = [].        x_
-000095c0: 7772 6974 655f 6469 736b 203d 205b 5d0a  write_disk = [].
-000095d0: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
-000095e0: 696e 2077 6f72 6b65 7273 3a0a 2020 2020  in workers:.    
-000095f0: 2020 2020 2020 2020 785f 7265 6164 2e61          x_read.a
-00009600: 7070 656e 6428 7773 2e6d 6574 7269 6373  ppend(ws.metrics
-00009610: 5b22 686f 7374 5f6e 6574 5f69 6f22 5d5b  ["host_net_io"][
-00009620: 2272 6561 645f 6270 7322 5d29 0a20 2020  "read_bps"]).   
-00009630: 2020 2020 2020 2020 2078 5f77 7269 7465           x_write
-00009640: 2e61 7070 656e 6428 7773 2e6d 6574 7269  .append(ws.metri
-00009650: 6373 5b22 686f 7374 5f6e 6574 5f69 6f22  cs["host_net_io"
-00009660: 5d5b 2277 7269 7465 5f62 7073 225d 290a  ]["write_bps"]).
-00009670: 2020 2020 2020 2020 2020 2020 785f 7265              x_re
-00009680: 6164 5f64 6973 6b2e 6170 7065 6e64 2877  ad_disk.append(w
-00009690: 732e 6d65 7472 6963 732e 6765 7428 2268  s.metrics.get("h
-000096a0: 6f73 745f 6469 736b 5f69 6f22 2c20 7b7d  ost_disk_io", {}
-000096b0: 292e 6765 7428 2272 6561 645f 6270 7322  ).get("read_bps"
-000096c0: 2c20 3029 290a 2020 2020 2020 2020 2020  , 0)).          
-000096d0: 2020 785f 7772 6974 655f 6469 736b 2e61    x_write_disk.a
-000096e0: 7070 656e 6428 7773 2e6d 6574 7269 6373  ppend(ws.metrics
-000096f0: 2e67 6574 2822 686f 7374 5f64 6973 6b5f  .get("host_disk_
-00009700: 696f 222c 207b 7d29 2e67 6574 2822 7772  io", {}).get("wr
-00009710: 6974 655f 6270 7322 2c20 3029 290a 0a20  ite_bps", 0)).. 
-00009720: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-00009730: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-00009740: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00009750: 6c66 2e62 616e 6477 6964 7468 2e78 5f72  lf.bandwidth.x_r
-00009760: 616e 6765 2e65 6e64 203d 206d 6178 280a  ange.end = max(.
-00009770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009780: 6d61 7828 785f 7265 6164 292c 0a20 2020  max(x_read),.   
-00009790: 2020 2020 2020 2020 2020 2020 206d 6178               max
-000097a0: 2878 5f77 7269 7465 292c 0a20 2020 2020  (x_write),.     
-000097b0: 2020 2020 2020 2020 2020 2031 3030 5f30             100_0
-000097c0: 3030 5f30 3030 2c0a 2020 2020 2020 2020  00_000,.        
-000097d0: 2020 2020 2020 2020 302e 3935 202a 2073          0.95 * s
-000097e0: 656c 662e 6261 6e64 7769 6474 682e 785f  elf.bandwidth.x_
-000097f0: 7261 6e67 652e 656e 642c 0a20 2020 2020  range.end,.     
-00009800: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00009810: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
-00009820: 785f 7261 6e67 652e 656e 6420 3d20 6d61  x_range.end = ma
-00009830: 7828 0a20 2020 2020 2020 2020 2020 2020  x(.             
-00009840: 2020 206d 6178 2878 5f72 6561 645f 6469     max(x_read_di
-00009850: 736b 292c 0a20 2020 2020 2020 2020 2020  sk),.           
-00009860: 2020 2020 206d 6178 2878 5f77 7269 7465       max(x_write
-00009870: 5f64 6973 6b29 2c0a 2020 2020 2020 2020  _disk),.        
-00009880: 2020 2020 2020 2020 3130 305f 3030 305f          100_000_
-00009890: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
-000098a0: 2020 2020 2030 2e39 3520 2a20 7365 6c66       0.95 * self
-000098b0: 2e64 6973 6b2e 785f 7261 6e67 652e 656e  .disk.x_range.en
-000098c0: 642c 0a20 2020 2020 2020 2020 2020 2029  d,.            )
-000098d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000098e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000098f0: 6261 6e64 7769 6474 682e 785f 7261 6e67  bandwidth.x_rang
-00009900: 652e 656e 6420 3d20 3130 305f 3030 305f  e.end = 100_000_
-00009910: 3030 300a 2020 2020 2020 2020 2020 2020  000.            
-00009920: 7365 6c66 2e64 6973 6b2e 785f 7261 6e67  self.disk.x_rang
-00009930: 652e 656e 6420 3d20 3130 305f 3030 305f  e.end = 100_000_
-00009940: 3030 300a 0a20 2020 2020 2020 2072 6573  000..        res
-00009950: 756c 7420 3d20 7b0a 2020 2020 2020 2020  ult = {.        
-00009960: 2020 2020 2279 5f72 6561 6422 3a20 795f      "y_read": y_
-00009970: 7265 6164 2c0a 2020 2020 2020 2020 2020  read,.          
-00009980: 2020 2279 5f77 7269 7465 223a 2079 5f77    "y_write": y_w
-00009990: 7269 7465 2c0a 2020 2020 2020 2020 2020  rite,.          
-000099a0: 2020 2278 5f72 6561 6422 3a20 785f 7265    "x_read": x_re
-000099b0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-000099c0: 2278 5f77 7269 7465 223a 2078 5f77 7269  "x_write": x_wri
-000099d0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
-000099e0: 2278 5f72 6561 645f 6469 736b 223a 2078  "x_read_disk": x
-000099f0: 5f72 6561 645f 6469 736b 2c0a 2020 2020  _read_disk,.    
-00009a00: 2020 2020 2020 2020 2278 5f77 7269 7465          "x_write
-00009a10: 5f64 6973 6b22 3a20 785f 7772 6974 655f  _disk": x_write_
-00009a20: 6469 736b 2c0a 2020 2020 2020 2020 7d0a  disk,.        }.
-00009a30: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
-00009a40: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
-00009a50: 756c 7429 0a0a 0a63 6c61 7373 2053 7973  ult)...class Sys
-00009a60: 7465 6d54 696d 6573 6572 6965 7328 4461  temTimeseries(Da
-00009a70: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-00009a80: 293a 0a20 2020 2022 2222 5469 6d65 7365  ):.    """Timese
-00009a90: 7269 6573 2066 6f72 2077 6f72 6b65 7220  ries for worker 
-00009aa0: 6e65 7477 6f72 6b20 6261 6e64 7769 6474  network bandwidt
-00009ab0: 682c 2063 7075 2c20 6d65 6d6f 7279 2061  h, cpu, memory a
-00009ac0: 6e64 2064 6973 6b2e 0a0a 2020 2020 6261  nd disk...    ba
-00009ad0: 6e64 7769 6474 680a 2020 2020 2020 2020  ndwidth.        
-00009ae0: 506c 6f74 7320 7468 6520 6176 6572 6167  Plots the averag
-00009af0: 6520 6f66 2068 6f73 745f 6e65 745f 696f  e of host_net_io
-00009b00: 2e72 6561 645f 6270 7320 616e 6420 686f  .read_bps and ho
-00009b10: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
-00009b20: 6270 7320 666f 7220 7468 650a 2020 2020  bps for the.    
-00009b30: 2020 2020 776f 726b 6572 7320 6173 2061      workers as a
-00009b40: 2066 756e 6374 696f 6e20 6f66 2074 696d   function of tim
-00009b50: 650a 2020 2020 6370 750a 2020 2020 2020  e.    cpu.      
-00009b60: 2020 506c 6f74 7320 7468 6520 6176 6572    Plots the aver
-00009b70: 6167 6520 6f66 2063 7075 2066 6f72 2074  age of cpu for t
-00009b80: 6865 2077 6f72 6b65 7273 2061 7320 6120  he workers as a 
-00009b90: 6675 6e63 7469 6f6e 206f 6620 7469 6d65  function of time
-00009ba0: 0a20 2020 206d 656d 6f72 790a 2020 2020  .    memory.    
-00009bb0: 2020 2020 506c 6f74 7320 7468 6520 6176      Plots the av
-00009bc0: 6572 6167 6520 6f66 206d 656d 6f72 7920  erage of memory 
-00009bd0: 666f 7220 7468 6520 776f 726b 6572 7320  for the workers 
-00009be0: 6173 2061 2066 756e 6374 696f 6e20 6f66  as a function of
-00009bf0: 2074 696d 650a 2020 2020 6469 736b 0a20   time.    disk. 
-00009c00: 2020 2020 2020 2050 6c6f 7473 2074 6865         Plots the
-00009c10: 2061 7665 7261 6765 206f 6620 686f 7374   average of host
-00009c20: 5f64 6973 6b5f 696f 2e72 6561 645f 6270  _disk_io.read_bp
-00009c30: 7320 616e 6420 686f 7374 5f64 6973 6b5f  s and host_disk_
-00009c40: 696f 2e77 7269 7465 5f62 7073 2066 6f72  io.write_bps for
-00009c50: 2074 6865 0a20 2020 2020 2020 2077 6f72   the.        wor
-00009c60: 6b65 7273 2061 7320 6120 6675 6e63 7469  kers as a functi
-00009c70: 6f6e 206f 6620 7469 6d65 0a0a 2020 2020  on of time..    
-00009c80: 5468 6520 6d65 7472 6963 7320 706c 6f74  The metrics plot
-00009c90: 7465 6420 636f 6d65 2066 726f 6d20 7468  ted come from th
-00009ca0: 6520 6167 6772 6567 6174 696f 6e20 6f66  e aggregation of
-00009cb0: 2066 726f 6d20 7773 2e6d 6574 7269 6373   from ws.metrics
-00009cc0: 5b6b 6579 5d20 666f 7220 7773 2069 6e0a  [key] for ws in.
-00009cd0: 2020 2020 7363 6865 6475 6c65 722e 776f      scheduler.wo
-00009ce0: 726b 6572 732e 7661 6c75 6573 2829 2064  rkers.values() d
-00009cf0: 6976 6964 6564 2062 7920 6e75 6d62 6572  ivided by number
-00009d00: 206f 6620 776f 726b 6572 732e 0a20 2020   of workers..   
-00009d10: 2022 2222 0a0a 2020 2020 406c 6f67 5f65   """..    @log_e
-00009d20: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
-00009d30: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-00009d40: 6564 756c 6572 2c20 666f 6c6c 6f77 5f69  eduler, follow_i
-00009d50: 6e74 6572 7661 6c3d 3230 3030 302c 202a  nterval=20000, *
-00009d60: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00009d70: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-00009d80: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
-00009d90: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-00009da0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-00009db0: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-00009dc0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00009dd0: 2020 2022 7469 6d65 223a 205b 5d2c 0a20     "time": [],. 
-00009de0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00009df0: 686f 7374 5f6e 6574 5f69 6f2e 7265 6164  host_net_io.read
-00009e00: 5f62 7073 223a 205b 5d2c 0a20 2020 2020  _bps": [],.     
-00009e10: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-00009e20: 5f6e 6574 5f69 6f2e 7772 6974 655f 6270  _net_io.write_bp
-00009e30: 7322 3a20 5b5d 2c0a 2020 2020 2020 2020  s": [],.        
-00009e40: 2020 2020 2020 2020 2263 7075 223a 205b          "cpu": [
-00009e50: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00009e60: 2020 2022 6d65 6d6f 7279 223a 205b 5d2c     "memory": [],
-00009e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009e80: 2022 686f 7374 5f64 6973 6b5f 696f 2e72   "host_disk_io.r
-00009e90: 6561 645f 6270 7322 3a20 5b5d 2c0a 2020  ead_bps": [],.  
-00009ea0: 2020 2020 2020 2020 2020 2020 2020 2268                "h
-00009eb0: 6f73 745f 6469 736b 5f69 6f2e 7772 6974  ost_disk_io.writ
-00009ec0: 655f 6270 7322 3a20 5b5d 2c0a 2020 2020  e_bps": [],.    
-00009ed0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00009ee0: 2020 290a 0a20 2020 2020 2020 2075 7064    )..        upd
-00009ef0: 6174 6528 7365 6c66 2e73 6f75 7263 652c  ate(self.source,
-00009f00: 2073 656c 662e 6765 745f 6461 7461 2829   self.get_data()
-00009f10: 290a 0a20 2020 2020 2020 2078 5f72 616e  )..        x_ran
-00009f20: 6765 203d 2044 6174 6152 616e 6765 3164  ge = DataRange1d
-00009f30: 280a 2020 2020 2020 2020 2020 2020 666f  (.            fo
-00009f40: 6c6c 6f77 3d22 656e 6422 2c20 666f 6c6c  llow="end", foll
-00009f50: 6f77 5f69 6e74 6572 7661 6c3d 666f 6c6c  ow_interval=foll
-00009f60: 6f77 5f69 6e74 6572 7661 6c2c 2072 616e  ow_interval, ran
-00009f70: 6765 5f70 6164 6469 6e67 3d30 0a20 2020  ge_padding=0.   
-00009f80: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-00009f90: 6f6f 6c73 203d 2022 7265 7365 742c 2078  ools = "reset, x
-00009fa0: 7061 6e2c 2078 7768 6565 6c5f 7a6f 6f6d  pan, xwheel_zoom
-00009fb0: 220a 0a20 2020 2020 2020 2073 656c 662e  "..        self.
-00009fc0: 6261 6e64 7769 6474 6820 3d20 6669 6775  bandwidth = figu
-00009fd0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00009fe0: 7469 746c 653d 2257 6f72 6b65 7220 4e65  title="Worker Ne
-00009ff0: 7477 6f72 6b20 4261 6e64 7769 6474 6820  twork Bandwidth 
-0000a000: 2861 7665 7261 6765 2922 2c0a 2020 2020  (average)",.    
-0000a010: 2020 2020 2020 2020 785f 6178 6973 5f74          x_axis_t
-0000a020: 7970 653d 2264 6174 6574 696d 6522 2c0a  ype="datetime",.
-0000a030: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-0000a040: 733d 746f 6f6c 732c 0a20 2020 2020 2020  s=tools,.       
-0000a050: 2020 2020 2078 5f72 616e 6765 3d78 5f72       x_range=x_r
-0000a060: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
-0000a070: 2020 6e61 6d65 3d22 776f 726b 6572 5f6e    name="worker_n
-0000a080: 6574 776f 726b 5f62 616e 6477 6964 7468  etwork_bandwidth
-0000a090: 2d74 696d 6573 6572 6965 7322 2c0a 2020  -timeseries",.  
-0000a0a0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-0000a0b0: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-0000a0c0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-0000a0d0: 7769 6474 682e 6c69 6e65 280a 2020 2020  width.line(.    
-0000a0e0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-0000a0f0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
-0000a100: 2020 2020 2020 2020 783d 2274 696d 6522          x="time"
-0000a110: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
-0000a120: 2268 6f73 745f 6e65 745f 696f 2e72 6561  "host_net_io.rea
-0000a130: 645f 6270 7322 2c0a 2020 2020 2020 2020  d_bps",.        
-0000a140: 2020 2020 636f 6c6f 723d 2272 6564 222c      color="red",
-0000a150: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
-0000a160: 656e 645f 6c61 6265 6c3d 2272 6561 6420  end_label="read 
-0000a170: 286d 6561 6e29 222c 0a20 2020 2020 2020  (mean)",.       
-0000a180: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0000a190: 6261 6e64 7769 6474 682e 6c69 6e65 280a  bandwidth.line(.
-0000a1a0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0000a1b0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-0000a1c0: 2020 2020 2020 2020 2020 2020 783d 2274              x="t
-0000a1d0: 696d 6522 2c0a 2020 2020 2020 2020 2020  ime",.          
-0000a1e0: 2020 793d 2268 6f73 745f 6e65 745f 696f    y="host_net_io
-0000a1f0: 2e77 7269 7465 5f62 7073 222c 0a20 2020  .write_bps",.   
-0000a200: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
-0000a210: 626c 7565 222c 0a20 2020 2020 2020 2020  blue",.         
-0000a220: 2020 206c 6567 656e 645f 6c61 6265 6c3d     legend_label=
-0000a230: 2277 7269 7465 2028 6d65 616e 2922 2c0a  "write (mean)",.
-0000a240: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000a250: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-0000a260: 682e 6c65 6765 6e64 2e6c 6f63 6174 696f  h.legend.locatio
-0000a270: 6e20 3d20 2274 6f70 5f6c 6566 7422 0a20  n = "top_left". 
-0000a280: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-0000a290: 7769 6474 682e 7961 7869 732e 6178 6973  width.yaxis.axis
-0000a2a0: 5f6c 6162 656c 203d 2022 6279 7465 7320  _label = "bytes 
-0000a2b0: 2f20 7365 636f 6e64 220a 2020 2020 2020  / second".      
-0000a2c0: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-0000a2d0: 2e79 6178 6973 5b30 5d2e 666f 726d 6174  .yaxis[0].format
-0000a2e0: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
-0000a2f0: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
-0000a300: 743d 2230 2e30 6222 290a 2020 2020 2020  t="0.0b").      
-0000a310: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-0000a320: 2e79 5f72 616e 6765 2e73 7461 7274 203d  .y_range.start =
-0000a330: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-0000a340: 6261 6e64 7769 6474 682e 7961 7869 732e  bandwidth.yaxis.
-0000a350: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
-0000a360: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-0000a370: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-0000a380: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
-0000a390: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0000a3a0: 7365 6c66 2e63 7075 203d 2066 6967 7572  self.cpu = figur
-0000a3b0: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-0000a3c0: 6974 6c65 3d22 576f 726b 6572 2043 5055  itle="Worker CPU
-0000a3d0: 2055 7469 6c69 7a61 7469 6f6e 2028 6176   Utilization (av
-0000a3e0: 6572 6167 6529 222c 0a20 2020 2020 2020  erage)",.       
-0000a3f0: 2020 2020 2078 5f61 7869 735f 7479 7065       x_axis_type
-0000a400: 3d22 6461 7465 7469 6d65 222c 0a20 2020  ="datetime",.   
-0000a410: 2020 2020 2020 2020 2074 6f6f 6c73 3d74           tools=t
-0000a420: 6f6f 6c73 2c0a 2020 2020 2020 2020 2020  ools,.          
-0000a430: 2020 785f 7261 6e67 653d 785f 7261 6e67    x_range=x_rang
-0000a440: 652c 0a20 2020 2020 2020 2020 2020 206e  e,.            n
-0000a450: 616d 653d 2277 6f72 6b65 725f 6370 752d  ame="worker_cpu-
-0000a460: 7469 6d65 7365 7269 6573 222c 0a20 2020  timeseries",.   
-0000a470: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-0000a480: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-0000a490: 2020 2020 2020 7365 6c66 2e63 7075 2e6c        self.cpu.l
-0000a4a0: 696e 6528 0a20 2020 2020 2020 2020 2020  ine(.           
-0000a4b0: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-0000a4c0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0000a4d0: 2078 3d22 7469 6d65 222c 0a20 2020 2020   x="time",.     
-0000a4e0: 2020 2020 2020 2079 3d22 6370 7522 2c0a         y="cpu",.
-0000a4f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000a500: 2020 7365 6c66 2e63 7075 2e79 6178 6973    self.cpu.yaxis
-0000a510: 2e61 7869 735f 6c61 6265 6c20 3d20 2255  .axis_label = "U
-0000a520: 7469 6c69 7a61 7469 6f6e 220a 2020 2020  tilization".    
-0000a530: 2020 2020 7365 6c66 2e63 7075 2e79 5f72      self.cpu.y_r
-0000a540: 616e 6765 2e73 7461 7274 203d 2030 0a20  ange.start = 0. 
-0000a550: 2020 2020 2020 2073 656c 662e 6370 752e         self.cpu.
-0000a560: 7961 7869 732e 6d69 6e6f 725f 7469 636b  yaxis.minor_tick
-0000a570: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-0000a580: 2020 2020 2020 2020 7365 6c66 2e63 7075          self.cpu
-0000a590: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
-0000a5a0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0000a5b0: 7365 6c66 2e6d 656d 6f72 7920 3d20 6669  self.memory = fi
-0000a5c0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-0000a5d0: 2020 7469 746c 653d 2257 6f72 6b65 7220    title="Worker 
-0000a5e0: 4d65 6d6f 7279 2055 7365 2028 6176 6572  Memory Use (aver
-0000a5f0: 6167 6529 222c 0a20 2020 2020 2020 2020  age)",.         
-0000a600: 2020 2078 5f61 7869 735f 7479 7065 3d22     x_axis_type="
-0000a610: 6461 7465 7469 6d65 222c 0a20 2020 2020  datetime",.     
-0000a620: 2020 2020 2020 2074 6f6f 6c73 3d74 6f6f         tools=too
-0000a630: 6c73 2c0a 2020 2020 2020 2020 2020 2020  ls,.            
-0000a640: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
-0000a650: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0000a660: 653d 2277 6f72 6b65 725f 6d65 6d6f 7279  e="worker_memory
-0000a670: 2d74 696d 6573 6572 6965 7322 2c0a 2020  -timeseries",.  
-0000a680: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-0000a690: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-0000a6a0: 2020 2020 2020 2073 656c 662e 6d65 6d6f         self.memo
-0000a6b0: 7279 2e6c 696e 6528 0a20 2020 2020 2020  ry.line(.       
-0000a6c0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000a6d0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-0000a6e0: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-0000a6f0: 2020 2020 2020 2020 2020 2079 3d22 6d65             y="me
-0000a700: 6d6f 7279 222c 0a20 2020 2020 2020 2029  mory",.        )
-0000a710: 0a20 2020 2020 2020 2073 656c 662e 6d65  .        self.me
-0000a720: 6d6f 7279 2e79 6178 6973 2e61 7869 735f  mory.yaxis.axis_
-0000a730: 6c61 6265 6c20 3d20 2242 7974 6573 220a  label = "Bytes".
-0000a740: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
-0000a750: 6f72 792e 7961 7869 735b 305d 2e66 6f72  ory.yaxis[0].for
-0000a760: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
-0000a770: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
-0000a780: 726d 6174 3d22 302e 3062 2229 0a20 2020  rmat="0.0b").   
-0000a790: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
-0000a7a0: 2e79 5f72 616e 6765 2e73 7461 7274 203d  .y_range.start =
-0000a7b0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-0000a7c0: 6d65 6d6f 7279 2e79 6178 6973 2e6d 696e  memory.yaxis.min
-0000a7d0: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-0000a7e0: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-0000a7f0: 656c 662e 6d65 6d6f 7279 2e78 6772 6964  elf.memory.xgrid
-0000a800: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-0000a810: 0a0a 2020 2020 2020 2020 7365 6c66 2e64  ..        self.d
-0000a820: 6973 6b20 3d20 6669 6775 7265 280a 2020  isk = figure(.  
-0000a830: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0000a840: 2257 6f72 6b65 7220 4469 736b 2042 616e  "Worker Disk Ban
-0000a850: 6477 6964 7468 2028 6176 6572 6167 6529  dwidth (average)
-0000a860: 222c 0a20 2020 2020 2020 2020 2020 2078  ",.            x
-0000a870: 5f61 7869 735f 7479 7065 3d22 6461 7465  _axis_type="date
-0000a880: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-0000a890: 2020 2074 6f6f 6c73 3d74 6f6f 6c73 2c0a     tools=tools,.
-0000a8a0: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
-0000a8b0: 6e67 653d 785f 7261 6e67 652c 0a20 2020  nge=x_range,.   
-0000a8c0: 2020 2020 2020 2020 206e 616d 653d 2277           name="w
-0000a8d0: 6f72 6b65 725f 6469 736b 2d74 696d 6573  orker_disk-times
-0000a8e0: 6572 6965 7322 2c0a 2020 2020 2020 2020  eries",.        
-0000a8f0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0000a900: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000a910: 2073 656c 662e 6469 736b 2e6c 696e 6528   self.disk.line(
-0000a920: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000a930: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0000a940: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-0000a950: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-0000a960: 2020 2079 3d22 686f 7374 5f64 6973 6b5f     y="host_disk_
-0000a970: 696f 2e72 6561 645f 6270 7322 2c0a 2020  io.read_bps",.  
-0000a980: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
-0000a990: 2272 6564 222c 0a20 2020 2020 2020 2020  "red",.         
-0000a9a0: 2020 206c 6567 656e 645f 6c61 6265 6c3d     legend_label=
-0000a9b0: 2272 6561 6420 286d 6561 6e29 222c 0a20  "read (mean)",. 
-0000a9c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000a9d0: 2073 656c 662e 6469 736b 2e6c 696e 6528   self.disk.line(
-0000a9e0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000a9f0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0000aa00: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-0000aa10: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-0000aa20: 2020 2079 3d22 686f 7374 5f64 6973 6b5f     y="host_disk_
-0000aa30: 696f 2e77 7269 7465 5f62 7073 222c 0a20  io.write_bps",. 
-0000aa40: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-0000aa50: 3d22 626c 7565 222c 0a20 2020 2020 2020  ="blue",.       
-0000aa60: 2020 2020 206c 6567 656e 645f 6c61 6265       legend_labe
-0000aa70: 6c3d 2277 7269 7465 2028 6d65 616e 2922  l="write (mean)"
-0000aa80: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0000aa90: 2020 2020 2073 656c 662e 6469 736b 2e6c       self.disk.l
-0000aaa0: 6567 656e 642e 6c6f 6361 7469 6f6e 203d  egend.location =
-0000aab0: 2022 746f 705f 6c65 6674 220a 2020 2020   "top_left".    
-0000aac0: 2020 2020 7365 6c66 2e64 6973 6b2e 7961      self.disk.ya
-0000aad0: 7869 732e 6178 6973 5f6c 6162 656c 203d  xis.axis_label =
-0000aae0: 2022 6279 7465 7320 2f20 7365 636f 6e64   "bytes / second
-0000aaf0: 220a 2020 2020 2020 2020 7365 6c66 2e64  ".        self.d
-0000ab00: 6973 6b2e 7961 7869 735b 305d 2e66 6f72  isk.yaxis[0].for
-0000ab10: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
-0000ab20: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
-0000ab30: 726d 6174 3d22 302e 3062 2229 0a20 2020  rmat="0.0b").   
-0000ab40: 2020 2020 2073 656c 662e 6469 736b 2e79       self.disk.y
-0000ab50: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
-0000ab60: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-0000ab70: 736b 2e79 6178 6973 2e6d 696e 6f72 5f74  sk.yaxis.minor_t
-0000ab80: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
-0000ab90: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-0000aba0: 6469 736b 2e78 6772 6964 2e76 6973 6962  disk.xgrid.visib
-0000abb0: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
-0000abc0: 6465 6620 6765 745f 6461 7461 2873 656c  def get_data(sel
-0000abd0: 6629 3a0a 2020 2020 2020 2020 776f 726b  f):.        work
-0000abe0: 6572 7320 3d20 7365 6c66 2e73 6368 6564  ers = self.sched
-0000abf0: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
-0000ac00: 7565 7328 290a 0a20 2020 2020 2020 206e  ues()..        n
-0000ac10: 6574 5f72 6561 645f 6270 7320 3d20 300a  et_read_bps = 0.
-0000ac20: 2020 2020 2020 2020 6e65 745f 7772 6974          net_writ
-0000ac30: 655f 6270 7320 3d20 300a 2020 2020 2020  e_bps = 0.      
-0000ac40: 2020 6370 7520 3d20 300a 2020 2020 2020    cpu = 0.      
-0000ac50: 2020 6d65 6d6f 7279 203d 2030 0a20 2020    memory = 0.   
-0000ac60: 2020 2020 2064 6973 6b5f 7265 6164 5f62       disk_read_b
-0000ac70: 7073 203d 2030 0a20 2020 2020 2020 2064  ps = 0.        d
-0000ac80: 6973 6b5f 7772 6974 655f 6270 7320 3d20  isk_write_bps = 
-0000ac90: 300a 2020 2020 2020 2020 7469 6d65 203d  0.        time =
-0000aca0: 2030 0a20 2020 2020 2020 2066 6f72 2077   0.        for w
-0000acb0: 7320 696e 2077 6f72 6b65 7273 3a0a 2020  s in workers:.  
-0000acc0: 2020 2020 2020 2020 2020 6e65 745f 7265            net_re
-0000acd0: 6164 5f62 7073 202b 3d20 7773 2e6d 6574  ad_bps += ws.met
-0000ace0: 7269 6373 5b22 686f 7374 5f6e 6574 5f69  rics["host_net_i
-0000acf0: 6f22 5d5b 2272 6561 645f 6270 7322 5d0a  o"]["read_bps"].
-0000ad00: 2020 2020 2020 2020 2020 2020 6e65 745f              net_
-0000ad10: 7772 6974 655f 6270 7320 2b3d 2077 732e  write_bps += ws.
-0000ad20: 6d65 7472 6963 735b 2268 6f73 745f 6e65  metrics["host_ne
-0000ad30: 745f 696f 225d 5b22 7772 6974 655f 6270  t_io"]["write_bp
-0000ad40: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-0000ad50: 6370 7520 2b3d 2077 732e 6d65 7472 6963  cpu += ws.metric
-0000ad60: 735b 2263 7075 225d 0a20 2020 2020 2020  s["cpu"].       
-0000ad70: 2020 2020 206d 656d 6f72 7920 2b3d 2077       memory += w
-0000ad80: 732e 6d65 7472 6963 735b 226d 656d 6f72  s.metrics["memor
-0000ad90: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
-0000ada0: 6469 736b 5f72 6561 645f 6270 7320 2b3d  disk_read_bps +=
-0000adb0: 2077 732e 6d65 7472 6963 732e 6765 7428   ws.metrics.get(
-0000adc0: 2268 6f73 745f 6469 736b 5f69 6f22 2c20  "host_disk_io", 
-0000add0: 7b7d 292e 6765 7428 2272 6561 645f 6270  {}).get("read_bp
-0000ade0: 7322 2c20 3029 0a20 2020 2020 2020 2020  s", 0).         
-0000adf0: 2020 2064 6973 6b5f 7772 6974 655f 6270     disk_write_bp
-0000ae00: 7320 2b3d 2077 732e 6d65 7472 6963 732e  s += ws.metrics.
-0000ae10: 6765 7428 2268 6f73 745f 6469 736b 5f69  get("host_disk_i
-0000ae20: 6f22 2c20 7b7d 292e 6765 7428 2277 7269  o", {}).get("wri
-0000ae30: 7465 5f62 7073 222c 2030 290a 2020 2020  te_bps", 0).    
-0000ae40: 2020 2020 2020 2020 7469 6d65 202b 3d20          time += 
-0000ae50: 7773 2e6d 6574 7269 6373 5b22 7469 6d65  ws.metrics["time
-0000ae60: 225d 0a0a 2020 2020 2020 2020 7265 7375  "]..        resu
-0000ae70: 6c74 203d 207b 0a20 2020 2020 2020 2020  lt = {.         
-0000ae80: 2020 2023 2075 7365 2060 6f72 6020 746f     # use `or` to
-0000ae90: 2061 766f 6964 205a 6572 6f44 6976 6973   avoid ZeroDivis
-0000aea0: 696f 6e20 7768 656e 206e 6f20 776f 726b  ion when no work
-0000aeb0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-0000aec0: 2274 696d 6522 3a20 5b74 696d 6520 2f20  "time": [time / 
-0000aed0: 286c 656e 2877 6f72 6b65 7273 2920 6f72  (len(workers) or
-0000aee0: 2031 2920 2a20 3130 3030 5d2c 0a20 2020   1) * 1000],.   
-0000aef0: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
-0000af00: 6574 5f69 6f2e 7265 6164 5f62 7073 223a  et_io.read_bps":
-0000af10: 205b 6e65 745f 7265 6164 5f62 7073 202f   [net_read_bps /
-0000af20: 2028 6c65 6e28 776f 726b 6572 7329 206f   (len(workers) o
-0000af30: 7220 3129 5d2c 0a20 2020 2020 2020 2020  r 1)],.         
-0000af40: 2020 2022 686f 7374 5f6e 6574 5f69 6f2e     "host_net_io.
-0000af50: 7772 6974 655f 6270 7322 3a20 5b6e 6574  write_bps": [net
-0000af60: 5f77 7269 7465 5f62 7073 202f 2028 6c65  _write_bps / (le
-0000af70: 6e28 776f 726b 6572 7329 206f 7220 3129  n(workers) or 1)
-0000af80: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0000af90: 6370 7522 3a20 5b63 7075 202f 2028 6c65  cpu": [cpu / (le
-0000afa0: 6e28 776f 726b 6572 7329 206f 7220 3129  n(workers) or 1)
-0000afb0: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0000afc0: 6d65 6d6f 7279 223a 205b 6d65 6d6f 7279  memory": [memory
-0000afd0: 202f 2028 6c65 6e28 776f 726b 6572 7329   / (len(workers)
-0000afe0: 206f 7220 3129 5d2c 0a20 2020 2020 2020   or 1)],.       
-0000aff0: 2020 2020 2022 686f 7374 5f64 6973 6b5f       "host_disk_
-0000b000: 696f 2e72 6561 645f 6270 7322 3a20 5b64  io.read_bps": [d
-0000b010: 6973 6b5f 7265 6164 5f62 7073 202f 2028  isk_read_bps / (
-0000b020: 6c65 6e28 776f 726b 6572 7329 206f 7220  len(workers) or 
-0000b030: 3129 5d2c 0a20 2020 2020 2020 2020 2020  1)],.           
-0000b040: 2022 686f 7374 5f64 6973 6b5f 696f 2e77   "host_disk_io.w
-0000b050: 7269 7465 5f62 7073 223a 205b 6469 736b  rite_bps": [disk
-0000b060: 5f77 7269 7465 5f62 7073 202f 2028 6c65  _write_bps / (le
-0000b070: 6e28 776f 726b 6572 7329 206f 7220 3129  n(workers) or 1)
-0000b080: 5d2c 0a20 2020 2020 2020 207d 0a20 2020  ],.        }.   
-0000b090: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-0000b0a0: 6c74 0a0a 2020 2020 4077 6974 686f 7574  lt..    @without
-0000b0b0: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
-0000b0c0: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
-0000b0d0: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
-0000b0e0: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
-0000b0f0: 2020 2073 656c 662e 736f 7572 6365 2e73     self.source.s
-0000b100: 7472 6561 6d28 7365 6c66 2e67 6574 5f64  tream(self.get_d
-0000b110: 6174 6128 292c 2031 3030 3029 0a0a 2020  ata(), 1000)..  
-0000b120: 2020 2020 2020 6966 2073 656c 662e 7363        if self.sc
-0000b130: 6865 6475 6c65 722e 776f 726b 6572 733a  heduler.workers:
-0000b140: 0a20 2020 2020 2020 2020 2020 2079 5f65  .            y_e
-0000b150: 6e64 5f63 7075 203d 2073 756d 280a 2020  nd_cpu = sum(.  
-0000b160: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-0000b170: 2e6e 7468 7265 6164 7320 6f72 2031 2066  .nthreads or 1 f
-0000b180: 6f72 2077 7320 696e 2073 656c 662e 7363  or ws in self.sc
-0000b190: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
-0000b1a0: 7661 6c75 6573 2829 0a20 2020 2020 2020  values().       
-0000b1b0: 2020 2020 2029 202f 206c 656e 2873 656c       ) / len(sel
-0000b1c0: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-0000b1d0: 6572 732e 7661 6c75 6573 2829 290a 2020  ers.values()).  
-0000b1e0: 2020 2020 2020 2020 2020 795f 656e 645f            y_end_
-0000b1f0: 6d65 6d20 3d20 7375 6d28 0a20 2020 2020  mem = sum(.     
-0000b200: 2020 2020 2020 2020 2020 2077 732e 6d65             ws.me
-0000b210: 6d6f 7279 5f6c 696d 6974 2066 6f72 2077  mory_limit for w
-0000b220: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
-0000b230: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-0000b240: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-0000b250: 2029 202f 206c 656e 2873 656c 662e 7363   ) / len(self.sc
-0000b260: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
-0000b270: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
-0000b280: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000b290: 2020 2020 795f 656e 645f 6370 7520 3d20      y_end_cpu = 
-0000b2a0: 310a 2020 2020 2020 2020 2020 2020 795f  1.            y_
-0000b2b0: 656e 645f 6d65 6d20 3d20 3130 305f 3030  end_mem = 100_00
-0000b2c0: 305f 3030 300a 0a20 2020 2020 2020 2073  0_000..        s
-0000b2d0: 656c 662e 6370 752e 795f 7261 6e67 652e  elf.cpu.y_range.
-0000b2e0: 656e 6420 3d20 795f 656e 645f 6370 7520  end = y_end_cpu 
-0000b2f0: 2a20 3130 300a 2020 2020 2020 2020 7365  * 100.        se
-0000b300: 6c66 2e6d 656d 6f72 792e 795f 7261 6e67  lf.memory.y_rang
-0000b310: 652e 656e 6420 3d20 795f 656e 645f 6d65  e.end = y_end_me
-0000b320: 6d0a 0a0a 636c 6173 7320 436f 6d70 7574  m...class Comput
-0000b330: 6550 6572 4b65 7928 4461 7368 626f 6172  ePerKey(Dashboar
-0000b340: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-0000b350: 2022 2222 4261 7220 6368 6172 7420 7368   """Bar chart sh
-0000b360: 6f77 696e 6720 7469 6d65 2073 7065 6e64  owing time spend
-0000b370: 2069 6e20 6163 7469 6f6e 2062 7920 6b65   in action by ke
-0000b380: 7920 7072 6566 6978 2222 220a 0a20 2020  y prefix"""..   
-0000b390: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-0000b3a0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0000b3b0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
-0000b3c0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0000b3d0: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
-0000b3e0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-0000b3f0: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
-0000b400: 6572 0a0a 2020 2020 2020 2020 6966 2054  er..        if T
-0000b410: 6173 6b53 7472 6561 6d50 6c75 6769 6e2e  askStreamPlugin.
-0000b420: 6e61 6d65 206e 6f74 2069 6e20 7365 6c66  name not in self
-0000b430: 2e73 6368 6564 756c 6572 2e70 6c75 6769  .scheduler.plugi
-0000b440: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0000b450: 7365 6c66 2e73 6368 6564 756c 6572 2e61  self.scheduler.a
-0000b460: 6464 5f70 6c75 6769 6e28 5461 736b 5374  dd_plugin(TaskSt
-0000b470: 7265 616d 506c 7567 696e 2873 656c 662e  reamPlugin(self.
-0000b480: 7363 6865 6475 6c65 7229 290a 0a20 2020  scheduler))..   
-0000b490: 2020 2020 2063 6f6d 7075 7465 5f64 6174       compute_dat
-0000b4a0: 6120 3d20 7b0a 2020 2020 2020 2020 2020  a = {.          
-0000b4b0: 2020 2274 696d 6573 223a 205b 302e 322c    "times": [0.2,
-0000b4c0: 2030 2e31 5d2c 0a20 2020 2020 2020 2020   0.1],.         
-0000b4d0: 2020 2022 666f 726d 6174 7465 645f 7469     "formatted_ti
-0000b4e0: 6d65 223a 205b 2230 2e32 206d 7322 2c20  me": ["0.2 ms", 
-0000b4f0: 2232 2e38 2075 7322 5d2c 0a20 2020 2020  "2.8 us"],.     
-0000b500: 2020 2020 2020 2022 616e 676c 6573 223a         "angles":
-0000b510: 205b 332e 3134 2c20 302e 3738 355d 2c0a   [3.14, 0.785],.
-0000b520: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-0000b530: 6f72 223a 205b 7473 5f63 6f6c 6f72 5f6c  or": [ts_color_l
-0000b540: 6f6f 6b75 705b 2274 7261 6e73 6665 7222  ookup["transfer"
-0000b550: 5d2c 2074 735f 636f 6c6f 725f 6c6f 6f6b  ], ts_color_look
-0000b560: 7570 5b22 636f 6d70 7574 6522 5d5d 2c0a  up["compute"]],.
-0000b570: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
-0000b580: 6573 223a 205b 2273 756d 222c 2022 7375  es": ["sum", "su
-0000b590: 6d5f 7061 7274 6961 6c22 5d2c 0a20 2020  m_partial"],.   
-0000b5a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0000b5b0: 7365 6c66 2e63 6f6d 7075 7465 5f73 6f75  self.compute_sou
-0000b5c0: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-0000b5d0: 536f 7572 6365 2864 6174 613d 636f 6d70  Source(data=comp
-0000b5e0: 7574 655f 6461 7461 290a 0a20 2020 2020  ute_data)..     
-0000b5f0: 2020 2066 6967 203d 2066 6967 7572 6528     fig = figure(
-0000b600: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-0000b610: 6c65 3d22 436f 6d70 7574 6520 5469 6d65  le="Compute Time
-0000b620: 2050 6572 2054 6173 6b22 2c0a 2020 2020   Per Task",.    
-0000b630: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-0000b640: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-0000b650: 6d65 3d22 636f 6d70 7574 655f 7469 6d65  me="compute_time
-0000b660: 5f70 6572 5f6b 6579 222c 0a20 2020 2020  _per_key",.     
-0000b670: 2020 2020 2020 2078 5f72 616e 6765 3d5b         x_range=[
-0000b680: 2261 222c 2022 6222 5d2c 0a20 2020 2020  "a", "b"],.     
-0000b690: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0000b6a0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000b6b0: 2020 2020 7265 6374 203d 2066 6967 2e76      rect = fig.v
-0000b6c0: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
-0000b6d0: 2073 6f75 7263 653d 7365 6c66 2e63 6f6d   source=self.com
-0000b6e0: 7075 7465 5f73 6f75 7263 652c 0a20 2020  pute_source,.   
-0000b6f0: 2020 2020 2020 2020 2078 3d22 6e61 6d65           x="name
-0000b700: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0000b710: 746f 703d 2274 696d 6573 222c 0a20 2020  top="times",.   
-0000b720: 2020 2020 2020 2020 2077 6964 7468 3d30           width=0
-0000b730: 2e37 2c0a 2020 2020 2020 2020 2020 2020  .7,.            
-0000b740: 636f 6c6f 723d 2263 6f6c 6f72 222c 0a20  color="color",. 
-0000b750: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000b760: 2020 6669 672e 795f 7261 6e67 652e 7374    fig.y_range.st
-0000b770: 6172 7420 3d20 300a 2020 2020 2020 2020  art = 0.        
-0000b780: 6669 672e 7961 7869 732e 6178 6973 5f6c  fig.yaxis.axis_l
-0000b790: 6162 656c 203d 2022 5469 6d65 2028 7329  abel = "Time (s)
-0000b7a0: 220a 2020 2020 2020 2020 6669 672e 7961  ".        fig.ya
-0000b7b0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-0000b7c0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-0000b7d0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-0000b7e0: 3022 290a 2020 2020 2020 2020 6669 672e  0").        fig.
-0000b7f0: 7961 7869 732e 7469 636b 6572 203d 2041  yaxis.ticker = A
-0000b800: 6461 7074 6976 6554 6963 6b65 7228 2a2a  daptiveTicker(**
-0000b810: 5449 434b 535f 3130 3234 290a 2020 2020  TICKS_1024).    
-0000b820: 2020 2020 6669 672e 7861 7869 732e 6d61      fig.xaxis.ma
-0000b830: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
-0000b840: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
-0000b850: 5249 454e 5441 5449 4f4e 0a20 2020 2020  RIENTATION.     
-0000b860: 2020 2072 6563 742e 6e6f 6e73 656c 6563     rect.nonselec
-0000b870: 7469 6f6e 5f67 6c79 7068 203d 204e 6f6e  tion_glyph = Non
-0000b880: 650a 0a20 2020 2020 2020 2066 6967 2e78  e..        fig.x
-0000b890: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-0000b8a0: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-0000b8b0: 2020 2020 2020 2066 6967 2e78 6772 6964         fig.xgrid
-0000b8c0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-0000b8d0: 0a0a 2020 2020 2020 2020 6669 672e 746f  ..        fig.to
-0000b8e0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 203d  olbar_location =
-0000b8f0: 204e 6f6e 650a 0a20 2020 2020 2020 2068   None..        h
-0000b900: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
-0000b910: 2829 0a20 2020 2020 2020 2068 6f76 6572  ().        hover
-0000b920: 2e74 6f6f 6c74 6970 7320 3d20 2222 220a  .tooltips = """.
-0000b930: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-0000b940: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0000b950: 2020 3c70 3e3c 623e 4e61 6d65 3a3c 2f62    <p><b>Name:</b
-0000b960: 3e20 406e 616d 6573 3c2f 703e 0a20 2020  > @names</p>.   
-0000b970: 2020 2020 2020 2020 2020 2020 203c 703e               <p>
-0000b980: 3c62 3e54 696d 653a 3c2f 623e 2040 666f  <b>Time:</b> @fo
-0000b990: 726d 6174 7465 645f 7469 6d65 3c2f 703e  rmatted_time</p>
-0000b9a0: 0a20 2020 2020 2020 2020 2020 203c 2f64  .            </d
-0000b9b0: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
-0000b9c0: 2222 220a 2020 2020 2020 2020 686f 7665  """.        hove
-0000b9d0: 722e 706f 696e 745f 706f 6c69 6379 203d  r.point_policy =
-0000b9e0: 2022 666f 6c6c 6f77 5f6d 6f75 7365 220a   "follow_mouse".
-0000b9f0: 2020 2020 2020 2020 6669 672e 6164 645f          fig.add_
-0000ba00: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
-0000ba10: 2020 2020 2020 6669 672e 6164 645f 6c61        fig.add_la
-0000ba20: 796f 7574 280a 2020 2020 2020 2020 2020  yout(.          
-0000ba30: 2020 5469 746c 6528 0a20 2020 2020 2020    Title(.       
-0000ba40: 2020 2020 2020 2020 2074 6578 743d 224e           text="N
-0000ba50: 6f74 653a 2074 6173 6b73 206c 6573 7320  ote: tasks less 
-0000ba60: 7468 616e 2032 2520 6f66 206d 6178 2061  than 2% of max a
-0000ba70: 7265 206e 6f74 2064 6973 706c 6179 6564  re not displayed
-0000ba80: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000ba90: 2020 2074 6578 745f 666f 6e74 5f73 7479     text_font_sty
-0000baa0: 6c65 3d22 6974 616c 6963 222c 0a20 2020  le="italic",.   
-0000bab0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0000bac0: 2020 2020 2020 2020 2262 656c 6f77 222c          "below",
-0000bad0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000bae0: 2020 2020 7365 6c66 2e66 6967 203d 2066      self.fig = f
-0000baf0: 6967 0a20 2020 2020 2020 2074 6162 3120  ig.        tab1 
-0000bb00: 3d20 5461 6250 616e 656c 2863 6869 6c64  = TabPanel(child
-0000bb10: 3d66 6967 2c20 7469 746c 653d 2242 6172  =fig, title="Bar
-0000bb20: 2043 6861 7274 2229 0a0a 2020 2020 2020   Chart")..      
-0000bb30: 2020 6669 6732 203d 2066 6967 7572 6528    fig2 = figure(
-0000bb40: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-0000bb50: 6c65 3d22 436f 6d70 7574 6520 5469 6d65  le="Compute Time
-0000bb60: 2050 6572 2054 6173 6b22 2c0a 2020 2020   Per Task",.    
-0000bb70: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-0000bb80: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-0000bb90: 6d65 3d22 636f 6d70 7574 655f 7469 6d65  me="compute_time
-0000bba0: 5f70 6572 5f6b 6579 2d70 6965 222c 0a20  _per_key-pie",. 
-0000bbb0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
-0000bbc0: 6765 3d28 2d30 2e35 2c20 312e 3029 2c0a  ge=(-0.5, 1.0),.
-0000bbd0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-0000bbe0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-0000bbf0: 0a20 2020 2020 2020 2066 6967 322e 7765  .        fig2.we
-0000bc00: 6467 6528 0a20 2020 2020 2020 2020 2020  dge(.           
-0000bc10: 2078 3d30 2c0a 2020 2020 2020 2020 2020   x=0,.          
-0000bc20: 2020 793d 312c 0a20 2020 2020 2020 2020    y=1,.         
-0000bc30: 2020 2072 6164 6975 733d 302e 342c 0a20     radius=0.4,. 
-0000bc40: 2020 2020 2020 2020 2020 2073 7461 7274             start
-0000bc50: 5f61 6e67 6c65 3d63 756d 7375 6d28 2261  _angle=cumsum("a
-0000bc60: 6e67 6c65 7322 2c20 696e 636c 7564 655f  ngles", include_
-0000bc70: 7a65 726f 3d54 7275 6529 2c0a 2020 2020  zero=True),.    
-0000bc80: 2020 2020 2020 2020 656e 645f 616e 676c          end_angl
-0000bc90: 653d 6375 6d73 756d 2822 616e 676c 6573  e=cumsum("angles
-0000bca0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000bcb0: 6c69 6e65 5f63 6f6c 6f72 3d22 7768 6974  line_color="whit
-0000bcc0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000bcd0: 6669 6c6c 5f63 6f6c 6f72 3d22 636f 6c6f  fill_color="colo
-0000bce0: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-0000bcf0: 6c65 6765 6e64 5f66 6965 6c64 3d22 6e61  legend_field="na
-0000bd00: 6d65 7322 2c0a 2020 2020 2020 2020 2020  mes",.          
-0000bd10: 2020 736f 7572 6365 3d73 656c 662e 636f    source=self.co
-0000bd20: 6d70 7574 655f 736f 7572 6365 2c0a 2020  mpute_source,.  
-0000bd30: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000bd40: 2066 6967 322e 6178 6973 2e61 7869 735f   fig2.axis.axis_
-0000bd50: 6c61 6265 6c20 3d20 4e6f 6e65 0a20 2020  label = None.   
-0000bd60: 2020 2020 2066 6967 322e 6178 6973 2e76       fig2.axis.v
-0000bd70: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-0000bd80: 2020 2020 2020 2066 6967 322e 6772 6964         fig2.grid
-0000bd90: 2e67 7269 645f 6c69 6e65 5f63 6f6c 6f72  .grid_line_color
-0000bda0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000bdb0: 6669 6732 2e61 6464 5f6c 6179 6f75 7428  fig2.add_layout(
-0000bdc0: 0a20 2020 2020 2020 2020 2020 2054 6974  .            Tit
-0000bdd0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0000bde0: 2020 2020 7465 7874 3d22 4e6f 7465 3a20      text="Note: 
-0000bdf0: 7461 736b 7320 6c65 7373 2074 6861 6e20  tasks less than 
-0000be00: 3225 206f 6620 6d61 7820 6172 6520 6e6f  2% of max are no
-0000be10: 7420 6469 7370 6c61 7965 6422 2c0a 2020  t displayed",.  
-0000be20: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0000be30: 7874 5f66 6f6e 745f 7374 796c 653d 2269  xt_font_style="i
-0000be40: 7461 6c69 6322 2c0a 2020 2020 2020 2020  talic",.        
-0000be50: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0000be60: 2020 2022 6265 6c6f 7722 2c0a 2020 2020     "below",.    
-0000be70: 2020 2020 290a 0a20 2020 2020 2020 2068      )..        h
-0000be80: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
-0000be90: 2829 0a20 2020 2020 2020 2068 6f76 6572  ().        hover
-0000bea0: 2e74 6f6f 6c74 6970 7320 3d20 2222 220a  .tooltips = """.
-0000beb0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-0000bec0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0000bed0: 2020 3c70 3e3c 623e 4e61 6d65 3a3c 2f62    <p><b>Name:</b
-0000bee0: 3e20 406e 616d 6573 3c2f 703e 0a20 2020  > @names</p>.   
-0000bef0: 2020 2020 2020 2020 2020 2020 203c 703e               <p>
-0000bf00: 3c62 3e54 696d 653a 3c2f 623e 2040 666f  <b>Time:</b> @fo
-0000bf10: 726d 6174 7465 645f 7469 6d65 3c2f 703e  rmatted_time</p>
-0000bf20: 0a20 2020 2020 2020 2020 2020 203c 2f64  .            </d
-0000bf30: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
-0000bf40: 2222 220a 2020 2020 2020 2020 686f 7665  """.        hove
-0000bf50: 722e 706f 696e 745f 706f 6c69 6379 203d  r.point_policy =
-0000bf60: 2022 666f 6c6c 6f77 5f6d 6f75 7365 220a   "follow_mouse".
-0000bf70: 2020 2020 2020 2020 6669 6732 2e61 6464          fig2.add
-0000bf80: 5f74 6f6f 6c73 2868 6f76 6572 290a 2020  _tools(hover).  
-0000bf90: 2020 2020 2020 7365 6c66 2e77 6564 6765        self.wedge
-0000bfa0: 5f66 6967 203d 2066 6967 320a 2020 2020  _fig = fig2.    
-0000bfb0: 2020 2020 7461 6232 203d 2054 6162 5061      tab2 = TabPa
-0000bfc0: 6e65 6c28 6368 696c 643d 6669 6732 2c20  nel(child=fig2, 
-0000bfd0: 7469 746c 653d 2250 6965 2043 6861 7274  title="Pie Chart
-0000bfe0: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
-0000bff0: 2e72 6f6f 7420 3d20 5461 6273 2874 6162  .root = Tabs(tab
-0000c000: 733d 5b74 6162 312c 2074 6162 325d 2c20  s=[tab1, tab2], 
-0000c010: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-0000c020: 6574 6368 5f62 6f74 6822 290a 0a20 2020  etch_both")..   
-0000c030: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
-0000c040: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
-0000c050: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-0000c060: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
-0000c070: 6629 3a0a 2020 2020 2020 2020 636f 6d70  f):.        comp
-0000c080: 7574 655f 7469 6d65 7320 3d20 6465 6661  ute_times = defa
-0000c090: 756c 7464 6963 7428 666c 6f61 7429 0a0a  ultdict(float)..
-0000c0a0: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-0000c0b0: 2074 7320 696e 2073 656c 662e 7363 6865   ts in self.sche
-0000c0c0: 6475 6c65 722e 7461 736b 5f70 7265 6669  duler.task_prefi
-0000c0d0: 7865 732e 6974 656d 7328 293a 0a20 2020  xes.items():.   
-0000c0e0: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
-0000c0f0: 6b65 795f 7370 6c69 7428 6b65 7929 0a20  key_split(key). 
-0000c100: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
-0000c110: 6374 696f 6e2c 2074 2069 6e20 7473 2e61  ction, t in ts.a
-0000c120: 6c6c 5f64 7572 6174 696f 6e73 2e69 7465  ll_durations.ite
-0000c130: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0000c140: 2020 2020 2020 6966 2061 6374 696f 6e20        if action 
-0000c150: 3d3d 2022 636f 6d70 7574 6522 3a0a 2020  == "compute":.  
-0000c160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c170: 2020 636f 6d70 7574 655f 7469 6d65 735b    compute_times[
-0000c180: 6e61 6d65 5d20 2b3d 2074 0a0a 2020 2020  name] += t..    
-0000c190: 2020 2020 2320 6f72 6465 7220 6279 206c      # order by l
-0000c1a0: 6172 6765 7374 2074 696d 6520 6669 7273  argest time firs
-0000c1b0: 740a 2020 2020 2020 2020 636f 6d70 7574  t.        comput
-0000c1c0: 655f 7469 6d65 7320 3d20 736f 7274 6564  e_times = sorted
-0000c1d0: 2863 6f6d 7075 7465 5f74 696d 6573 2e69  (compute_times.i
-0000c1e0: 7465 6d73 2829 2c20 6b65 793d 6c61 6d62  tems(), key=lamb
-0000c1f0: 6461 2078 3a20 785b 315d 2c20 7265 7665  da x: x[1], reve
-0000c200: 7273 653d 5472 7565 290a 0a20 2020 2020  rse=True)..     
-0000c210: 2020 2023 206b 6565 7020 6f6e 6c79 2074     # keep only t
-0000c220: 696d 6520 7768 6963 6820 6172 6520 3225  ime which are 2%
-0000c230: 206f 6620 6d61 7820 6f72 2067 7265 6174   of max or great
-0000c240: 6572 0a20 2020 2020 2020 2069 6620 636f  er.        if co
-0000c250: 6d70 7574 655f 7469 6d65 733a 0a20 2020  mpute_times:.   
-0000c260: 2020 2020 2020 2020 206d 6178 5f74 696d           max_tim
-0000c270: 6520 3d20 636f 6d70 7574 655f 7469 6d65  e = compute_time
-0000c280: 735b 305d 5b31 5d20 2a20 302e 3032 0a20  s[0][1] * 0.02. 
-0000c290: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
-0000c2a0: 7465 5f74 696d 6573 203d 205b 286e 2c20  te_times = [(n, 
-0000c2b0: 7429 2066 6f72 206e 2c20 7420 696e 2063  t) for n, t in c
-0000c2c0: 6f6d 7075 7465 5f74 696d 6573 2069 6620  ompute_times if 
-0000c2d0: 7420 3e20 6d61 785f 7469 6d65 5d0a 2020  t > max_time].  
-0000c2e0: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
-0000c2f0: 655f 636f 6c6f 7273 203d 206c 6973 7428  e_colors = list(
-0000c300: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
-0000c310: 6d70 7574 655f 6e61 6d65 7320 3d20 6c69  mpute_names = li
-0000c320: 7374 2829 0a20 2020 2020 2020 2020 2020  st().           
-0000c330: 2063 6f6d 7075 7465 5f74 696d 6520 3d20   compute_time = 
-0000c340: 6c69 7374 2829 0a20 2020 2020 2020 2020  list().         
-0000c350: 2020 2074 6f74 616c 5f74 696d 6520 3d20     total_time = 
-0000c360: 300a 2020 2020 2020 2020 2020 2020 666f  0.            fo
-0000c370: 7220 6e61 6d65 2c20 7420 696e 2063 6f6d  r name, t in com
-0000c380: 7075 7465 5f74 696d 6573 3a0a 2020 2020  pute_times:.    
-0000c390: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
-0000c3a0: 7574 655f 6e61 6d65 732e 6170 7065 6e64  ute_names.append
-0000c3b0: 286e 616d 6529 0a20 2020 2020 2020 2020  (name).         
-0000c3c0: 2020 2020 2020 2063 6f6d 7075 7465 5f63         compute_c
-0000c3d0: 6f6c 6f72 732e 6170 7065 6e64 2874 735f  olors.append(ts_
-0000c3e0: 636f 6c6f 725f 6f66 286e 616d 6529 290a  color_of(name)).
-0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c400: 636f 6d70 7574 655f 7469 6d65 2e61 7070  compute_time.app
-0000c410: 656e 6428 7429 0a20 2020 2020 2020 2020  end(t).         
-0000c420: 2020 2020 2020 2074 6f74 616c 5f74 696d         total_tim
-0000c430: 6520 2b3d 2074 0a0a 2020 2020 2020 2020  e += t..        
-0000c440: 2020 2020 616e 676c 6573 203d 205b 7420      angles = [t 
-0000c450: 2f20 746f 7461 6c5f 7469 6d65 202a 2032  / total_time * 2
-0000c460: 202a 206d 6174 682e 7069 2066 6f72 2074   * math.pi for t
-0000c470: 2069 6e20 636f 6d70 7574 655f 7469 6d65   in compute_time
-0000c480: 5d0a 0a20 2020 2020 2020 2020 2020 2073  ]..            s
-0000c490: 656c 662e 6669 672e 785f 7261 6e67 652e  elf.fig.x_range.
-0000c4a0: 6661 6374 6f72 7320 3d20 636f 6d70 7574  factors = comput
-0000c4b0: 655f 6e61 6d65 730a 0a20 2020 2020 2020  e_names..       
-0000c4c0: 2020 2020 2063 6f6d 7075 7465 5f72 6573       compute_res
-0000c4d0: 756c 7420 3d20 6469 6374 280a 2020 2020  ult = dict(.    
-0000c4e0: 2020 2020 2020 2020 2020 2020 616e 676c              angl
-0000c4f0: 6573 3d61 6e67 6c65 732c 0a20 2020 2020  es=angles,.     
-0000c500: 2020 2020 2020 2020 2020 2074 696d 6573             times
-0000c510: 3d63 6f6d 7075 7465 5f74 696d 652c 0a20  =compute_time,. 
-0000c520: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000c530: 6f6c 6f72 3d63 6f6d 7075 7465 5f63 6f6c  olor=compute_col
-0000c540: 6f72 732c 0a20 2020 2020 2020 2020 2020  ors,.           
-0000c550: 2020 2020 206e 616d 6573 3d63 6f6d 7075       names=compu
-0000c560: 7465 5f6e 616d 6573 2c0a 2020 2020 2020  te_names,.      
-0000c570: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0000c580: 7465 645f 7469 6d65 3d5b 666f 726d 6174  ted_time=[format
-0000c590: 5f74 696d 6528 7429 2066 6f72 2074 2069  _time(t) for t i
-0000c5a0: 6e20 636f 6d70 7574 655f 7469 6d65 5d2c  n compute_time],
-0000c5b0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0000c5c0: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-0000c5d0: 7465 2873 656c 662e 636f 6d70 7574 655f  te(self.compute_
-0000c5e0: 736f 7572 6365 2c20 636f 6d70 7574 655f  source, compute_
-0000c5f0: 7265 7375 6c74 290a 0a0a 636c 6173 7320  result)...class 
-0000c600: 4167 6772 6567 6174 6541 6374 696f 6e28  AggregateAction(
-0000c610: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-0000c620: 6e74 293a 0a20 2020 2022 2222 4261 7220  nt):.    """Bar 
-0000c630: 6368 6172 7420 7368 6f77 696e 6720 7469  chart showing ti
-0000c640: 6d65 2073 7065 6e64 2069 6e20 6163 7469  me spend in acti
-0000c650: 6f6e 2062 7920 6b65 7920 7072 6566 6978  on by key prefix
-0000c660: 2222 220a 0a20 2020 2040 6c6f 675f 6572  """..    @log_er
-0000c670: 726f 7273 0a20 2020 2064 6566 205f 5f69  rors.    def __i
-0000c680: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-0000c690: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
-0000c6a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e6c  :.        self.l
-0000c6b0: 6173 7420 3d20 300a 2020 2020 2020 2020  ast = 0.        
-0000c6c0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-0000c6d0: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-0000c6e0: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
-0000c6f0: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
-0000c700: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-0000c710: 6572 2e70 6c75 6769 6e73 3a0a 2020 2020  er.plugins:.    
-0000c720: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-0000c730: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
-0000c740: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
-0000c750: 696e 2873 656c 662e 7363 6865 6475 6c65  in(self.schedule
-0000c760: 7229 290a 0a20 2020 2020 2020 2061 6374  r))..        act
-0000c770: 696f 6e5f 6461 7461 203d 207b 0a20 2020  ion_data = {.   
-0000c780: 2020 2020 2020 2020 2022 7469 6d65 7322           "times"
-0000c790: 3a20 5b30 2e32 2c20 302e 315d 2c0a 2020  : [0.2, 0.1],.  
-0000c7a0: 2020 2020 2020 2020 2020 2266 6f72 6d61            "forma
-0000c7b0: 7474 6564 5f74 696d 6522 3a20 5b22 302e  tted_time": ["0.
-0000c7c0: 3220 6d73 222c 2022 322e 3820 7573 225d  2 ms", "2.8 us"]
-0000c7d0: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-0000c7e0: 6f6c 6f72 223a 205b 7473 5f63 6f6c 6f72  olor": [ts_color
-0000c7f0: 5f6c 6f6f 6b75 705b 2274 7261 6e73 6665  _lookup["transfe
-0000c800: 7222 5d2c 2074 735f 636f 6c6f 725f 6c6f  r"], ts_color_lo
-0000c810: 6f6b 7570 5b22 636f 6d70 7574 6522 5d5d  okup["compute"]]
-0000c820: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-0000c830: 616d 6573 223a 205b 2274 7261 6e73 6665  ames": ["transfe
-0000c840: 7222 2c20 2263 6f6d 7075 7465 225d 2c0a  r", "compute"],.
-0000c850: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0000c860: 2020 2073 656c 662e 6163 7469 6f6e 5f73     self.action_s
-0000c870: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-0000c880: 7461 536f 7572 6365 2864 6174 613d 6163  taSource(data=ac
-0000c890: 7469 6f6e 5f64 6174 6129 0a0a 2020 2020  tion_data)..    
-0000c8a0: 2020 2020 7365 6c66 2e72 6f6f 7420 3d20      self.root = 
-0000c8b0: 6669 6775 7265 280a 2020 2020 2020 2020  figure(.        
-0000c8c0: 2020 2020 7469 746c 653d 2241 6767 7265      title="Aggre
-0000c8d0: 6761 7465 2050 6572 2041 6374 696f 6e22  gate Per Action"
-0000c8e0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-0000c8f0: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-0000c900: 2020 2020 6e61 6d65 3d22 6167 6772 6567      name="aggreg
-0000c910: 6174 655f 7065 725f 6163 7469 6f6e 222c  ate_per_action",
-0000c920: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-0000c930: 616e 6765 3d5b 2261 222c 2022 6222 5d2c  ange=["a", "b"],
-0000c940: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-0000c950: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-0000c960: 0a0a 2020 2020 2020 2020 7265 6374 203d  ..        rect =
-0000c970: 2073 656c 662e 726f 6f74 2e76 6261 7228   self.root.vbar(
-0000c980: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000c990: 7263 653d 7365 6c66 2e61 6374 696f 6e5f  rce=self.action_
-0000c9a0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0000c9b0: 2020 2020 783d 226e 616d 6573 222c 0a20      x="names",. 
-0000c9c0: 2020 2020 2020 2020 2020 2074 6f70 3d22             top="
-0000c9d0: 7469 6d65 7322 2c0a 2020 2020 2020 2020  times",.        
-0000c9e0: 2020 2020 7769 6474 683d 302e 372c 0a20      width=0.7,. 
-0000c9f0: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-0000ca00: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
-0000ca10: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0000ca20: 662e 726f 6f74 2e79 5f72 616e 6765 2e73  f.root.y_range.s
-0000ca30: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
-0000ca40: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-0000ca50: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
-0000ca60: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
-0000ca70: 7474 6572 2866 6f72 6d61 743d 2230 2229  tter(format="0")
-0000ca80: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000ca90: 6f74 2e79 6178 6973 2e61 7869 735f 6c61  ot.yaxis.axis_la
-0000caa0: 6265 6c20 3d20 2254 696d 6520 2873 2922  bel = "Time (s)"
-0000cab0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000cac0: 6f74 2e79 6178 6973 2e74 6963 6b65 7220  ot.yaxis.ticker 
-0000cad0: 3d20 4164 6170 7469 7665 5469 636b 6572  = AdaptiveTicker
-0000cae0: 282a 2a54 4943 4b53 5f31 3032 3429 0a20  (**TICKS_1024). 
-0000caf0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0000cb00: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
-0000cb10: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
-0000cb20: 2058 4c41 4245 4c5f 4f52 4945 4e54 4154   XLABEL_ORIENTAT
-0000cb30: 494f 4e0a 2020 2020 2020 2020 7365 6c66  ION.        self
-0000cb40: 2e72 6f6f 742e 7861 7869 732e 6d61 6a6f  .root.xaxis.majo
-0000cb50: 725f 6c61 6265 6c5f 7465 7874 5f66 6f6e  r_label_text_fon
-0000cb60: 745f 7369 7a65 203d 2022 3136 7078 220a  t_size = "16px".
-0000cb70: 2020 2020 2020 2020 7265 6374 2e6e 6f6e          rect.non
-0000cb80: 7365 6c65 6374 696f 6e5f 676c 7970 6820  selection_glyph 
-0000cb90: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
-0000cba0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-0000cbb0: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
-0000cbc0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-0000cbd0: 2020 7365 6c66 2e72 6f6f 742e 7867 7269    self.root.xgri
-0000cbe0: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
-0000cbf0: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-0000cc00: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
-0000cc10: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
-0000cc20: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
-0000cc30: 7665 7254 6f6f 6c28 290a 2020 2020 2020  verTool().      
-0000cc40: 2020 686f 7665 722e 746f 6f6c 7469 7073    hover.tooltips
-0000cc50: 203d 2022 2222 0a20 2020 2020 2020 2020   = """.         
-0000cc60: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-0000cc70: 2020 2020 2020 2020 203c 703e 3c62 3e4e           <p><b>N
-0000cc80: 616d 653a 3c2f 623e 2040 6e61 6d65 733c  ame:</b> @names<
-0000cc90: 2f70 3e0a 2020 2020 2020 2020 2020 2020  /p>.            
-0000cca0: 2020 2020 3c70 3e3c 623e 5469 6d65 3a3c      <p><b>Time:<
-0000ccb0: 2f62 3e20 4066 6f72 6d61 7474 6564 5f74  /b> @formatted_t
-0000ccc0: 696d 653c 2f70 3e0a 2020 2020 2020 2020  ime</p>.        
-0000ccd0: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
-0000cce0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000ccf0: 2020 2068 6f76 6572 2e70 6f69 6e74 5f70     hover.point_p
-0000cd00: 6f6c 6963 7920 3d20 2266 6f6c 6c6f 775f  olicy = "follow_
-0000cd10: 6d6f 7573 6522 0a20 2020 2020 2020 2073  mouse".        s
-0000cd20: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
-0000cd30: 6c73 2868 6f76 6572 290a 0a20 2020 2040  ls(hover)..    @
-0000cd40: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-0000cd50: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-0000cd60: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-0000cd70: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-0000cd80: 3a0a 2020 2020 2020 2020 6167 675f 7469  :.        agg_ti
-0000cd90: 6d65 7320 3d20 6465 6661 756c 7464 6963  mes = defaultdic
-0000cda0: 7428 666c 6f61 7429 0a0a 2020 2020 2020  t(float)..      
-0000cdb0: 2020 666f 7220 7473 2069 6e20 7365 6c66    for ts in self
-0000cdc0: 2e73 6368 6564 756c 6572 2e74 6173 6b5f  .scheduler.task_
-0000cdd0: 7072 6566 6978 6573 2e76 616c 7565 7328  prefixes.values(
-0000cde0: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-0000cdf0: 6f72 2061 6374 696f 6e2c 2074 2069 6e20  or action, t in 
-0000ce00: 7473 2e61 6c6c 5f64 7572 6174 696f 6e73  ts.all_durations
-0000ce10: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0000ce20: 2020 2020 2020 2020 2020 6167 675f 7469            agg_ti
-0000ce30: 6d65 735b 6163 7469 6f6e 5d20 2b3d 2074  mes[action] += t
-0000ce40: 0a0a 2020 2020 2020 2020 2320 6f72 6465  ..        # orde
-0000ce50: 7220 6279 206c 6172 6765 7374 2074 696d  r by largest tim
-0000ce60: 6520 6669 7273 740a 2020 2020 2020 2020  e first.        
-0000ce70: 6167 675f 7469 6d65 7320 3d20 736f 7274  agg_times = sort
-0000ce80: 6564 2861 6767 5f74 696d 6573 2e69 7465  ed(agg_times.ite
-0000ce90: 6d73 2829 2c20 6b65 793d 6c61 6d62 6461  ms(), key=lambda
-0000cea0: 2078 3a20 785b 315d 2c20 7265 7665 7273   x: x[1], revers
-0000ceb0: 653d 5472 7565 290a 0a20 2020 2020 2020  e=True)..       
-0000cec0: 2061 6767 5f63 6f6c 6f72 7320 3d20 6c69   agg_colors = li
-0000ced0: 7374 2829 0a20 2020 2020 2020 2061 6767  st().        agg
-0000cee0: 5f6e 616d 6573 203d 206c 6973 7428 290a  _names = list().
-0000cef0: 2020 2020 2020 2020 6167 675f 7469 6d65          agg_time
-0000cf00: 203d 206c 6973 7428 290a 2020 2020 2020   = list().      
-0000cf10: 2020 666f 7220 6163 7469 6f6e 2c20 7420    for action, t 
-0000cf20: 696e 2061 6767 5f74 696d 6573 3a0a 2020  in agg_times:.  
-0000cf30: 2020 2020 2020 2020 2020 6167 675f 6e61            agg_na
-0000cf40: 6d65 732e 6170 7065 6e64 2861 6374 696f  mes.append(actio
-0000cf50: 6e29 0a20 2020 2020 2020 2020 2020 2069  n).            i
-0000cf60: 6620 6163 7469 6f6e 203d 3d20 2263 6f6d  f action == "com
-0000cf70: 7075 7465 223a 0a20 2020 2020 2020 2020  pute":.         
-0000cf80: 2020 2020 2020 2061 6767 5f63 6f6c 6f72         agg_color
-0000cf90: 732e 6170 7065 6e64 2822 7075 7270 6c65  s.append("purple
-0000cfa0: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
-0000cfb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000cfc0: 2020 2020 2061 6767 5f63 6f6c 6f72 732e       agg_colors.
-0000cfd0: 6170 7065 6e64 2874 735f 636f 6c6f 725f  append(ts_color_
-0000cfe0: 6c6f 6f6b 7570 5b61 6374 696f 6e5d 290a  lookup[action]).
-0000cff0: 2020 2020 2020 2020 2020 2020 6167 675f              agg_
-0000d000: 7469 6d65 2e61 7070 656e 6428 7429 0a0a  time.append(t)..
-0000d010: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000d020: 742e 785f 7261 6e67 652e 6661 6374 6f72  t.x_range.factor
-0000d030: 7320 3d20 6167 675f 6e61 6d65 730a 2020  s = agg_names.  
-0000d040: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000d050: 7469 746c 652e 7465 7874 203d 2022 4167  title.text = "Ag
-0000d060: 6772 6567 6174 6520 5469 6d65 2050 6572  gregate Time Per
-0000d070: 2041 6374 696f 6e22 0a0a 2020 2020 2020   Action"..      
-0000d080: 2020 6163 7469 6f6e 5f72 6573 756c 7420    action_result 
-0000d090: 3d20 6469 6374 280a 2020 2020 2020 2020  = dict(.        
-0000d0a0: 2020 2020 7469 6d65 733d 6167 675f 7469      times=agg_ti
-0000d0b0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-0000d0c0: 636f 6c6f 723d 6167 675f 636f 6c6f 7273  color=agg_colors
-0000d0d0: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-0000d0e0: 6d65 733d 6167 675f 6e61 6d65 732c 0a20  mes=agg_names,. 
-0000d0f0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-0000d100: 7474 6564 5f74 696d 653d 5b66 6f72 6d61  tted_time=[forma
-0000d110: 745f 7469 6d65 2874 2920 666f 7220 7420  t_time(t) for t 
-0000d120: 696e 2061 6767 5f74 696d 655d 2c0a 2020  in agg_time],.  
-0000d130: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000d140: 2075 7064 6174 6528 7365 6c66 2e61 6374   update(self.act
-0000d150: 696f 6e5f 736f 7572 6365 2c20 6163 7469  ion_source, acti
-0000d160: 6f6e 5f72 6573 756c 7429 0a0a 0a63 6c61  on_result)...cla
-0000d170: 7373 204d 656d 6f72 7942 794b 6579 2844  ss MemoryByKey(D
-0000d180: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
-0000d190: 7429 3a0a 2020 2020 2222 2242 6172 2063  t):.    """Bar c
-0000d1a0: 6861 7274 2073 686f 7769 6e67 206d 656d  hart showing mem
-0000d1b0: 6f72 7920 7573 6520 6279 206b 6579 2070  ory use by key p
-0000d1c0: 7265 6669 7822 2222 0a0a 2020 2020 406c  refix"""..    @l
-0000d1d0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0000d1e0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-0000d1f0: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
-0000d200: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-0000d210: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
-0000d220: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-0000d230: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-0000d240: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-0000d250: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-0000d260: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
-0000d270: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0000d280: 2020 2020 2020 226e 616d 6522 3a20 5b22        "name": ["
-0000d290: 6122 2c20 2262 225d 2c0a 2020 2020 2020  a", "b"],.      
-0000d2a0: 2020 2020 2020 2020 2020 226e 6279 7465            "nbyte
-0000d2b0: 7322 3a20 5b31 3030 2c20 3130 3030 5d2c  s": [100, 1000],
-0000d2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d2d0: 2022 636f 756e 7422 3a20 5b31 2c20 325d   "count": [1, 2]
-0000d2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d2f0: 2020 2263 6f6c 6f72 223a 205b 2262 6c75    "color": ["blu
-0000d300: 6522 2c20 2262 6c75 6522 5d2c 0a20 2020  e", "blue"],.   
-0000d310: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0000d320: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-0000d330: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
-0000d340: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-0000d350: 746c 653d 224d 656d 6f72 7920 5573 6522  tle="Memory Use"
-0000d360: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-0000d370: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-0000d380: 2020 2020 6e61 6d65 3d22 6d65 6d6f 7279      name="memory
-0000d390: 5f62 795f 6b65 7922 2c0a 2020 2020 2020  _by_key",.      
-0000d3a0: 2020 2020 2020 785f 7261 6e67 653d 5b22        x_range=["
-0000d3b0: 6122 2c20 2262 225d 2c0a 2020 2020 2020  a", "b"],.      
-0000d3c0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-0000d3d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000d3e0: 2020 7265 6374 203d 2073 656c 662e 726f    rect = self.ro
-0000d3f0: 6f74 2e76 6261 7228 0a20 2020 2020 2020  ot.vbar(.       
-0000d400: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000d410: 2e73 6f75 7263 652c 2078 3d22 6e61 6d65  .source, x="name
-0000d420: 222c 2074 6f70 3d22 6e62 7974 6573 222c  ", top="nbytes",
-0000d430: 2077 6964 7468 3d30 2e39 2c20 636f 6c6f   width=0.9, colo
-0000d440: 723d 2263 6f6c 6f72 220a 2020 2020 2020  r="color".      
-0000d450: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-0000d460: 2e72 6f6f 742e 7961 7869 735b 305d 2e66  .root.yaxis[0].f
-0000d470: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-0000d480: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-0000d490: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
-0000d4a0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000d4b0: 742e 7961 7869 732e 7469 636b 6572 203d  t.yaxis.ticker =
-0000d4c0: 2041 6461 7074 6976 6554 6963 6b65 7228   AdaptiveTicker(
-0000d4d0: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
-0000d4e0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000d4f0: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
-0000d500: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
-0000d510: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
-0000d520: 4f4e 0a20 2020 2020 2020 2072 6563 742e  ON.        rect.
-0000d530: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
-0000d540: 7068 203d 204e 6f6e 650a 0a20 2020 2020  ph = None..     
-0000d550: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-0000d560: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-0000d570: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-0000d580: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-0000d590: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
-0000d5a0: 616c 7365 0a0a 2020 2020 2020 2020 7365  alse..        se
-0000d5b0: 6c66 2e72 6f6f 742e 746f 6f6c 6261 725f  lf.root.toolbar_
-0000d5c0: 6c6f 6361 7469 6f6e 203d 204e 6f6e 650a  location = None.
-0000d5d0: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
-0000d5e0: 2048 6f76 6572 546f 6f6c 2829 0a20 2020   HoverTool().   
-0000d5f0: 2020 2020 2068 6f76 6572 2e74 6f6f 6c74       hover.toolt
-0000d600: 6970 7320 3d20 2240 6e61 6d65 3a20 406e  ips = "@name: @n
-0000d610: 6279 7465 735f 7465 7874 220a 2020 2020  bytes_text".    
-0000d620: 2020 2020 686f 7665 722e 746f 6f6c 7469      hover.toolti
-0000d630: 7073 203d 2022 2222 0a20 2020 2020 2020  ps = """.       
-0000d640: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-0000d650: 2020 2020 2020 2020 2020 203c 703e 3c62             <p><b
-0000d660: 3e4e 616d 653a 3c2f 623e 2040 6e61 6d65  >Name:</b> @name
-0000d670: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
-0000d680: 2020 2020 203c 703e 3c62 3e42 7974 6573       <p><b>Bytes
-0000d690: 3a3c 2f62 3e20 406e 6279 7465 735f 7465  :</b> @nbytes_te
-0000d6a0: 7874 203c 2f70 3e0a 2020 2020 2020 2020  xt </p>.        
-0000d6b0: 2020 2020 2020 2020 3c70 3e3c 623e 436f          <p><b>Co
-0000d6c0: 756e 743a 3c2f 623e 2040 636f 756e 7420  unt:</b> @count 
-0000d6d0: 6f62 6a65 6374 7320 3c2f 703e 0a20 2020  objects </p>.   
-0000d6e0: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
-0000d6f0: 2020 2020 2020 2020 2020 2020 2222 220a              """.
-0000d700: 2020 2020 2020 2020 686f 7665 722e 706f          hover.po
-0000d710: 696e 745f 706f 6c69 6379 203d 2022 666f  int_policy = "fo
-0000d720: 6c6c 6f77 5f6d 6f75 7365 220a 2020 2020  llow_mouse".    
-0000d730: 2020 2020 7365 6c66 2e72 6f6f 742e 6164      self.root.ad
-0000d740: 645f 746f 6f6c 7328 686f 7665 7229 0a0a  d_tools(hover)..
-0000d750: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-0000d760: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-0000d770: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0000d780: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
-0000d790: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
-0000d7a0: 6f75 6e74 7320 3d20 6465 6661 756c 7464  ounts = defaultd
-0000d7b0: 6963 7428 696e 7429 0a20 2020 2020 2020  ict(int).       
-0000d7c0: 206e 6279 7465 7320 3d20 6465 6661 756c   nbytes = defaul
-0000d7d0: 7464 6963 7428 696e 7429 0a20 2020 2020  tdict(int).     
-0000d7e0: 2020 2066 6f72 2077 7320 696e 2073 656c     for ws in sel
-0000d7f0: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-0000d800: 6572 732e 7661 6c75 6573 2829 3a0a 2020  ers.values():.  
-0000d810: 2020 2020 2020 2020 2020 666f 7220 7473            for ts
-0000d820: 2069 6e20 7773 2e68 6173 5f77 6861 743a   in ws.has_what:
-0000d830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d840: 206b 7320 3d20 6b65 795f 7370 6c69 7428   ks = key_split(
-0000d850: 7473 2e6b 6579 290a 2020 2020 2020 2020  ts.key).        
-0000d860: 2020 2020 2020 2020 636f 756e 7473 5b6b          counts[k
-0000d870: 735d 202b 3d20 310a 2020 2020 2020 2020  s] += 1.        
-0000d880: 2020 2020 2020 2020 6e62 7974 6573 5b6b          nbytes[k
-0000d890: 735d 202b 3d20 7473 2e6e 6279 7465 730a  s] += ts.nbytes.
-0000d8a0: 0a20 2020 2020 2020 206e 616d 6573 203d  .        names =
-0000d8b0: 206c 6973 7428 736f 7274 6564 2863 6f75   list(sorted(cou
-0000d8c0: 6e74 7329 290a 2020 2020 2020 2020 7365  nts)).        se
-0000d8d0: 6c66 2e72 6f6f 742e 785f 7261 6e67 652e  lf.root.x_range.
-0000d8e0: 6661 6374 6f72 7320 3d20 6e61 6d65 730a  factors = names.
-0000d8f0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0000d900: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-0000d910: 6e61 6d65 223a 206e 616d 6573 2c0a 2020  name": names,.  
-0000d920: 2020 2020 2020 2020 2020 2263 6f75 6e74            "count
-0000d930: 223a 205b 636f 756e 7473 5b6e 616d 655d  ": [counts[name]
-0000d940: 2066 6f72 206e 616d 6520 696e 206e 616d   for name in nam
-0000d950: 6573 5d2c 0a20 2020 2020 2020 2020 2020  es],.           
-0000d960: 2022 6e62 7974 6573 223a 205b 6e62 7974   "nbytes": [nbyt
-0000d970: 6573 5b6e 616d 655d 2066 6f72 206e 616d  es[name] for nam
+00004c50: 6d61 6e61 6765 645f 6f6c 642e 6170 7065  managed_old.appe
+00004c60: 6e64 286d 656d 696e 666f 2e75 6e6d 616e  nd(meminfo.unman
+00004c70: 6167 6564 5f6f 6c64 290a 2020 2020 2020  aged_old).      
+00004c80: 2020 2020 2020 756e 6d61 6e61 6765 645f        unmanaged_
+00004c90: 7265 6365 6e74 2e61 7070 656e 6428 6d65  recent.append(me
+00004ca0: 6d69 6e66 6f2e 756e 6d61 6e61 6765 645f  minfo.unmanaged_
+00004cb0: 7265 6365 6e74 290a 2020 2020 2020 2020  recent).        
+00004cc0: 2020 2020 7370 696c 6c65 642e 6170 7065      spilled.appe
+00004cd0: 6e64 286d 656d 696e 666f 2e73 7069 6c6c  nd(meminfo.spill
+00004ce0: 6564 290a 0a20 2020 2020 2020 2072 6573  ed)..        res
+00004cf0: 756c 7420 3d20 7b0a 2020 2020 2020 2020  ult = {.        
+00004d00: 2020 2020 2277 6964 7468 223a 2077 6964      "width": wid
+00004d10: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00004d20: 2278 223a 2078 2c0a 2020 2020 2020 2020  "x": x,.        
+00004d30: 2020 2020 2263 6f6c 6f72 223a 2063 6f6c      "color": col
+00004d40: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00004d50: 2261 6c70 6861 223a 205b 312c 2030 2e37  "alpha": [1, 0.7
+00004d60: 2c20 302e 342c 2031 5d20 2a20 6c65 6e28  , 0.4, 1] * len(
+00004d70: 776f 726b 6572 7329 2c0a 2020 2020 2020  workers),.      
+00004d80: 2020 2020 2020 2277 6f72 6b65 7222 3a20        "worker": 
+00004d90: 7175 6164 6c69 7374 2877 732e 6164 6472  quadlist(ws.addr
+00004da0: 6573 7320 666f 7220 7773 2069 6e20 776f  ess for ws in wo
+00004db0: 726b 6572 7329 2c0a 2020 2020 2020 2020  rkers),.        
+00004dc0: 2020 2020 2265 7363 6170 6564 5f77 6f72      "escaped_wor
+00004dd0: 6b65 7222 3a20 7175 6164 6c69 7374 2865  ker": quadlist(e
+00004de0: 7363 6170 652e 7572 6c5f 6573 6361 7065  scape.url_escape
+00004df0: 2877 732e 6164 6472 6573 7329 2066 6f72  (ws.address) for
+00004e00: 2077 7320 696e 2077 6f72 6b65 7273 292c   ws in workers),
+00004e10: 0a20 2020 2020 2020 2020 2020 2022 7922  .            "y"
+00004e20: 3a20 7175 6164 6c69 7374 2872 616e 6765  : quadlist(range
+00004e30: 286c 656e 2877 6f72 6b65 7273 2929 292c  (len(workers))),
+00004e40: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
+00004e50: 6f63 5f6d 656d 6f72 7922 3a20 7175 6164  oc_memory": quad
+00004e60: 6c69 7374 2870 726f 636d 656d 6f72 7929  list(procmemory)
+00004e70: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00004e80: 616e 6167 6564 223a 2071 7561 646c 6973  anaged": quadlis
+00004e90: 7428 6d61 6e61 6765 6429 2c0a 2020 2020  t(managed),.    
+00004ea0: 2020 2020 2020 2020 2275 6e6d 616e 6167          "unmanag
+00004eb0: 6564 5f6f 6c64 223a 2071 7561 646c 6973  ed_old": quadlis
+00004ec0: 7428 756e 6d61 6e61 6765 645f 6f6c 6429  t(unmanaged_old)
+00004ed0: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+00004ee0: 6e6d 616e 6167 6564 5f72 6563 656e 7422  nmanaged_recent"
+00004ef0: 3a20 7175 6164 6c69 7374 2875 6e6d 616e  : quadlist(unman
+00004f00: 6167 6564 5f72 6563 656e 7429 2c0a 2020  aged_recent),.  
+00004f10: 2020 2020 2020 2020 2020 2273 7069 6c6c            "spill
+00004f20: 6564 223a 2071 7561 646c 6973 7428 7370  ed": quadlist(sp
+00004f30: 696c 6c65 6429 2c0a 2020 2020 2020 2020  illed),.        
+00004f40: 7d0a 2020 2020 2020 2020 2320 5265 6d6f  }.        # Remo
+00004f50: 7665 2072 6563 7461 6e67 6c65 7320 7769  ve rectangles wi
+00004f60: 7468 2077 6964 7468 3d30 0a20 2020 2020  th width=0.     
+00004f70: 2020 2072 6573 756c 7420 3d20 7b6b 3a20     result = {k: 
+00004f80: 5b76 6920 666f 7220 7669 2c20 7720 696e  [vi for vi, w in
+00004f90: 207a 6970 2876 2c20 7769 6474 6829 2069   zip(v, width) i
+00004fa0: 6620 775d 2066 6f72 206b 2c20 7620 696e  f w] for k, v in
+00004fb0: 2072 6573 756c 742e 6974 656d 7328 297d   result.items()}
+00004fc0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00004fd0: 6f6f 742e 785f 7261 6e67 652e 656e 6420  oot.x_range.end 
+00004fe0: 3d20 6d61 785f 6c69 6d69 740a 2020 2020  = max_limit.    
+00004ff0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+00005000: 736f 7572 6365 2c20 7265 7375 6c74 290a  source, result).
+00005010: 0a0a 636c 6173 7320 576f 726b 6572 734d  ..class WorkersM
+00005020: 656d 6f72 7948 6973 746f 6772 616d 2844  emoryHistogram(D
+00005030: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
+00005040: 7429 3a0a 2020 2020 2222 2248 6973 746f  t):.    """Histo
+00005050: 6772 616d 206f 6620 6d65 6d6f 7279 2075  gram of memory u
+00005060: 7361 6765 2c20 7368 6f77 696e 6720 686f  sage, showing ho
+00005070: 7720 6d61 6e79 2077 6f72 6b65 7273 2074  w many workers t
+00005080: 6865 7265 2061 7265 2069 6e20 6561 6368  here are in each
+00005090: 2062 7563 6b65 7420 6f66 0a20 2020 2075   bucket of.    u
+000050a0: 7361 6765 2e20 5265 706c 6163 6573 2074  sage. Replaces t
+000050b0: 6865 2070 6572 2d77 6f72 6b65 7220 6772  he per-worker gr
+000050c0: 6170 6820 7768 656e 2074 6865 7265 2061  aph when there a
+000050d0: 7265 203e 3d20 3530 2077 6f72 6b65 7273  re >= 50 workers
+000050e0: 2e0a 2020 2020 2222 220a 0a20 2020 2040  ..    """..    @
+000050f0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+00005100: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00005110: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+00005120: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00005130: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
+00005140: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+00005150: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
+00005160: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+00005170: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+00005180: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
+00005190: 2020 2020 207b 226c 6566 7422 3a20 5b31       {"left": [1
+000051a0: 2c20 325d 2c20 2272 6967 6874 223a 205b  , 2], "right": [
+000051b0: 3130 2c20 3130 5d2c 2022 746f 7022 3a20  10, 10], "top": 
+000051c0: 5b30 2c20 305d 7d0a 2020 2020 2020 2020  [0, 0]}.        
+000051d0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000051e0: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
+000051f0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+00005200: 3d22 4279 7465 7320 7374 6f72 6564 2070  ="Bytes stored p
+00005210: 6572 2077 6f72 6b65 7222 2c0a 2020 2020  er worker",.    
+00005220: 2020 2020 2020 2020 6e61 6d65 3d22 776f          name="wo
+00005230: 726b 6572 735f 6d65 6d6f 7279 222c 0a20  rkers_memory",. 
+00005240: 2020 2020 2020 2020 2020 2079 5f61 7869             y_axi
+00005250: 735f 6c61 6265 6c3d 2266 7265 7175 656e  s_label="frequen
+00005260: 6379 222c 0a20 2020 2020 2020 2020 2020  cy",.           
+00005270: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+00005280: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+00005290: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000052a0: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
+000052b0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
+000052c0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
+000052d0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+000052e0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
+000052f0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
+00005300: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
+00005310: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
+00005320: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
+00005330: 6c66 2e72 6f6f 742e 7861 7869 732e 6d61  lf.root.xaxis.ma
+00005340: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
+00005350: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
+00005360: 5249 454e 5441 5449 4f4e 0a0a 2020 2020  RIENTATION..    
+00005370: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
+00005380: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
+00005390: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
+000053a0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+000053b0: 7967 7269 642e 7669 7369 626c 6520 3d20  ygrid.visible = 
+000053c0: 4661 6c73 650a 0a20 2020 2020 2020 2073  False..        s
+000053d0: 656c 662e 726f 6f74 2e74 6f6f 6c62 6172  elf.root.toolbar
+000053e0: 5f6c 6f63 6174 696f 6e20 3d20 4e6f 6e65  _location = None
+000053f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00005400: 6f6f 742e 7175 6164 280a 2020 2020 2020  oot.quad(.      
+00005410: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+00005420: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
+00005430: 2020 2020 2020 6c65 6674 3d22 6c65 6674        left="left
+00005440: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
+00005450: 6967 6874 3d22 7269 6768 7422 2c0a 2020  ight="right",.  
+00005460: 2020 2020 2020 2020 2020 626f 7474 6f6d            bottom
+00005470: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
+00005480: 746f 703d 2274 6f70 222c 0a20 2020 2020  top="top",.     
+00005490: 2020 2020 2020 2063 6f6c 6f72 3d22 6465         color="de
+000054a0: 6570 736b 7962 6c75 6522 2c0a 2020 2020  epskyblue",.    
+000054b0: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
+000054c0: 6861 3d30 2e35 2c0a 2020 2020 2020 2020  ha=0.5,.        
+000054d0: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+000054e0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+000054f0: 696f 6e0a 2020 2020 6465 6620 7570 6461  ion.    def upda
+00005500: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00005510: 2020 6e62 7974 6573 203d 206e 702e 6173    nbytes = np.as
+00005520: 6172 7261 7928 0a20 2020 2020 2020 2020  array(.         
+00005530: 2020 205b 7773 2e6d 6574 7269 6373 5b22     [ws.metrics["
+00005540: 6d65 6d6f 7279 225d 2066 6f72 2077 7320  memory"] for ws 
+00005550: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
+00005560: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
+00005570: 2829 5d0a 2020 2020 2020 2020 290a 2020  ()].        ).  
+00005580: 2020 2020 2020 636f 756e 7473 2c20 7820        counts, x 
+00005590: 3d20 6e70 2e68 6973 746f 6772 616d 286e  = np.histogram(n
+000055a0: 6279 7465 732c 2062 696e 733d 3430 290a  bytes, bins=40).
+000055b0: 2020 2020 2020 2020 6420 3d20 7b22 6c65          d = {"le
+000055c0: 6674 223a 2078 5b3a 2d31 5d2c 2022 7269  ft": x[:-1], "ri
+000055d0: 6768 7422 3a20 785b 313a 5d2c 2022 746f  ght": x[1:], "to
+000055e0: 7022 3a20 636f 756e 7473 7d0a 2020 2020  p": counts}.    
+000055f0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+00005600: 736f 7572 6365 2c20 6429 0a0a 0a63 6c61  source, d)...cla
+00005610: 7373 2057 6f72 6b65 7273 5472 616e 7366  ss WorkersTransf
+00005620: 6572 4279 7465 7328 4461 7368 626f 6172  erBytes(Dashboar
+00005630: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+00005640: 2022 2222 5369 7a65 206f 6620 6f70 656e   """Size of open
+00005650: 2064 6174 6120 7472 616e 7366 6572 7320   data transfers 
+00005660: 6672 6f6d 2f74 6f20 6f74 6865 7220 776f  from/to other wo
+00005670: 726b 6572 7320 7065 7220 776f 726b 6572  rkers per worker
+00005680: 2222 220a 0a20 2020 2040 6c6f 675f 6572  """..    @log_er
+00005690: 726f 7273 0a20 2020 2064 6566 205f 5f69  rors.    def __i
+000056a0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+000056b0: 6475 6c65 722c 2077 6964 7468 3d36 3030  duler, width=600
+000056c0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+000056d0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+000056e0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+000056f0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00005700: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
+00005710: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
+00005720: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00005730: 2020 2020 2020 2265 7363 6170 6564 5f77        "escaped_w
+00005740: 6f72 6b65 7222 3a20 5b5d 2c0a 2020 2020  orker": [],.    
+00005750: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+00005760: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
+00005770: 7974 6573 223a 205b 5d2c 0a20 2020 2020  ytes": [],.     
+00005780: 2020 2020 2020 2020 2020 2022 7472 616e             "tran
+00005790: 7366 6572 5f6f 7574 676f 696e 675f 6279  sfer_outgoing_by
+000057a0: 7465 7322 3a20 5b5d 2c0a 2020 2020 2020  tes": [],.      
+000057b0: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+000057c0: 7222 3a20 5b5d 2c0a 2020 2020 2020 2020  r": [],.        
+000057d0: 2020 2020 2020 2020 2279 5f69 6e63 6f6d          "y_incom
+000057e0: 696e 6722 3a20 5b5d 2c0a 2020 2020 2020  ing": [],.      
+000057f0: 2020 2020 2020 2020 2020 2279 5f6f 7574            "y_out
+00005800: 676f 696e 6722 3a20 5b5d 2c0a 2020 2020  going": [],.    
+00005810: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00005820: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00005830: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
+00005840: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00005850: 6c65 3d66 2242 7974 6573 2074 7261 6e73  le=f"Bytes trans
+00005860: 6665 7272 696e 673a 207b 666f 726d 6174  ferring: {format
+00005870: 5f62 7974 6573 2830 297d 222c 0a20 2020  _bytes(0)}",.   
+00005880: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
+00005890: 222c 0a20 2020 2020 2020 2020 2020 2077  ",.            w
+000058a0: 6964 7468 3d69 6e74 2877 6964 7468 202f  idth=int(width /
+000058b0: 2032 292c 0a20 2020 2020 2020 2020 2020   2),.           
+000058c0: 206e 616d 653d 2277 6f72 6b65 7273 5f74   name="workers_t
+000058d0: 7261 6e73 6665 725f 6279 7465 7322 2c0a  ransfer_bytes",.
+000058e0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+000058f0: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
+00005900: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00005910: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00005920: 290a 0a20 2020 2020 2020 2023 2074 7261  )..        # tra
+00005930: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
+00005940: 7974 6573 0a20 2020 2020 2020 2073 656c  ytes.        sel
+00005950: 662e 726f 6f74 2e68 6261 7228 0a20 2020  f.root.hbar(.   
+00005960: 2020 2020 2020 2020 206e 616d 653d 2274           name="t
+00005970: 7261 6e73 6665 725f 696e 636f 6d69 6e67  ransfer_incoming
+00005980: 5f62 7974 6573 222c 0a20 2020 2020 2020  _bytes",.       
+00005990: 2020 2020 2079 3d22 795f 696e 636f 6d69       y="y_incomi
+000059a0: 6e67 222c 0a20 2020 2020 2020 2020 2020  ng",.           
+000059b0: 2072 6967 6874 3d22 7472 616e 7366 6572   right="transfer
+000059c0: 5f69 6e63 6f6d 696e 675f 6279 7465 7322  _incoming_bytes"
+000059d0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+000059e0: 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20  ne_color=None,. 
+000059f0: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+00005a00: 302c 0a20 2020 2020 2020 2020 2020 2068  0,.            h
+00005a10: 6569 6768 743d 302e 352c 0a20 2020 2020  eight=0.5,.     
+00005a20: 2020 2020 2020 2066 696c 6c5f 636f 6c6f         fill_colo
+00005a30: 723d 2272 6564 222c 0a20 2020 2020 2020  r="red",.       
+00005a40: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00005a50: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+00005a60: 2029 0a0a 2020 2020 2020 2020 2320 7472   )..        # tr
+00005a70: 616e 7366 6572 5f6f 7574 676f 696e 675f  ansfer_outgoing_
+00005a80: 6279 7465 730a 2020 2020 2020 2020 7365  bytes.        se
+00005a90: 6c66 2e72 6f6f 742e 6862 6172 280a 2020  lf.root.hbar(.  
+00005aa0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
+00005ab0: 7472 616e 7366 6572 5f6f 7574 676f 696e  transfer_outgoin
+00005ac0: 675f 6279 7465 7322 2c0a 2020 2020 2020  g_bytes",.      
+00005ad0: 2020 2020 2020 793d 2279 5f6f 7574 676f        y="y_outgo
+00005ae0: 696e 6722 2c0a 2020 2020 2020 2020 2020  ing",.          
+00005af0: 2020 7269 6768 743d 2274 7261 6e73 6665    right="transfe
+00005b00: 725f 6f75 7467 6f69 6e67 5f62 7974 6573  r_outgoing_bytes
+00005b10: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
+00005b20: 696e 655f 636f 6c6f 723d 4e6f 6e65 2c0a  ine_color=None,.
+00005b30: 2020 2020 2020 2020 2020 2020 6c65 6674              left
+00005b40: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
+00005b50: 6865 6967 6874 3d30 2e35 2c0a 2020 2020  height=0.5,.    
+00005b60: 2020 2020 2020 2020 6669 6c6c 5f63 6f6c          fill_col
+00005b70: 6f72 3d22 626c 7565 222c 0a20 2020 2020  or="blue",.     
+00005b80: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+00005b90: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+00005ba0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00005bb0: 6c66 2e72 6f6f 742e 6178 6973 5b30 5d2e  lf.root.axis[0].
+00005bc0: 7469 636b 6572 203d 2042 6173 6963 5469  ticker = BasicTi
+00005bd0: 636b 6572 282a 2a54 4943 4b53 5f31 3032  cker(**TICKS_102
+00005be0: 3429 0a20 2020 2020 2020 2073 656c 662e  4).        self.
+00005bf0: 726f 6f74 2e78 6178 6973 5b30 5d2e 666f  root.xaxis[0].fo
+00005c00: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
+00005c10: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
+00005c20: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
+00005c30: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00005c40: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
+00005c50: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
+00005c60: 2058 4c41 4245 4c5f 4f52 4945 4e54 4154   XLABEL_ORIENTAT
+00005c70: 494f 4e0a 2020 2020 2020 2020 7365 6c66  ION.        self
+00005c80: 2e72 6f6f 742e 7861 7869 732e 6d69 6e6f  .root.xaxis.mino
+00005c90: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
+00005ca0: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
+00005cb0: 6c66 2e72 6f6f 742e 785f 7261 6e67 6520  lf.root.x_range 
+00005cc0: 3d20 5261 6e67 6531 6428 7374 6172 743d  = Range1d(start=
+00005cd0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+00005ce0: 726f 6f74 2e79 6178 6973 2e76 6973 6962  root.yaxis.visib
+00005cf0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
+00005d00: 2020 2073 656c 662e 726f 6f74 2e79 6772     self.root.ygr
+00005d10: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
+00005d20: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
+00005d30: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
+00005d40: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
+00005d50: 2020 2020 2020 7461 7020 3d20 5461 7054        tap = TapT
+00005d60: 6f6f 6c28 6361 6c6c 6261 636b 3d4f 7065  ool(callback=Ope
+00005d70: 6e55 524c 2875 726c 3d22 2e2f 696e 666f  nURL(url="./info
+00005d80: 2f77 6f72 6b65 722f 4065 7363 6170 6564  /worker/@escaped
+00005d90: 5f77 6f72 6b65 722e 6874 6d6c 2229 290a  _worker.html")).
+00005da0: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
+00005db0: 486f 7665 7254 6f6f 6c28 0a20 2020 2020  HoverTool(.     
+00005dc0: 2020 2020 2020 2074 6f6f 6c74 6970 733d         tooltips=
+00005dd0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00005de0: 2020 2822 576f 726b 6572 222c 2022 4077    ("Worker", "@w
+00005df0: 6f72 6b65 7222 292c 0a20 2020 2020 2020  orker"),.       
+00005e00: 2020 2020 2020 2020 2028 2249 6e63 6f6d           ("Incom
+00005e10: 696e 6722 2c20 2240 7472 616e 7366 6572  ing", "@transfer
+00005e20: 5f69 6e63 6f6d 696e 675f 6279 7465 737b  _incoming_bytes{
+00005e30: 302e 3030 2062 7d22 292c 0a20 2020 2020  0.00 b}"),.     
+00005e40: 2020 2020 2020 2020 2020 2028 224f 7574             ("Out
+00005e50: 676f 696e 6722 2c20 2240 7472 616e 7366  going", "@transf
+00005e60: 6572 5f6f 7574 676f 696e 675f 6279 7465  er_outgoing_byte
+00005e70: 737b 302e 3030 2062 7d22 292c 0a20 2020  s{0.00 b}"),.   
+00005e80: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00005e90: 2020 2020 2020 2020 706f 696e 745f 706f          point_po
+00005ea0: 6c69 6379 3d22 666f 6c6c 6f77 5f6d 6f75  licy="follow_mou
+00005eb0: 7365 222c 0a20 2020 2020 2020 2029 0a20  se",.        ). 
+00005ec0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00005ed0: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
+00005ee0: 2c20 7461 7029 0a0a 2020 2020 4077 6974  , tap)..    @wit
+00005ef0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+00005f00: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+00005f10: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+00005f20: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+00005f30: 2020 2020 2020 2077 7373 203d 2073 656c         wss = sel
+00005f40: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+00005f50: 6572 732e 7661 6c75 6573 2829 0a0a 2020  ers.values()..  
+00005f60: 2020 2020 2020 6820 3d20 302e 310a 2020        h = 0.1.  
+00005f70: 2020 2020 2020 795f 696e 636f 6d69 6e67        y_incoming
+00005f80: 203d 205b 6920 2b20 302e 3735 202b 2069   = [i + 0.75 + i
+00005f90: 202a 2068 2066 6f72 2069 2069 6e20 7261   * h for i in ra
+00005fa0: 6e67 6528 6c65 6e28 7773 7329 295d 0a20  nge(len(wss))]. 
+00005fb0: 2020 2020 2020 2079 5f6f 7574 676f 696e         y_outgoin
+00005fc0: 6720 3d20 5b69 202b 2030 2e32 3520 2b20  g = [i + 0.25 + 
+00005fd0: 6920 2a20 6820 666f 7220 6920 696e 2072  i * h for i in r
+00005fe0: 616e 6765 286c 656e 2877 7373 2929 5d0a  ange(len(wss))].
+00005ff0: 0a20 2020 2020 2020 2074 7261 6e73 6665  .        transfe
+00006000: 725f 696e 636f 6d69 6e67 5f62 7974 6573  r_incoming_bytes
+00006010: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00006020: 2077 732e 6d65 7472 6963 735b 2274 7261   ws.metrics["tra
+00006030: 6e73 6665 7222 5d5b 2269 6e63 6f6d 696e  nsfer"]["incomin
+00006040: 675f 6279 7465 7322 5d20 666f 7220 7773  g_bytes"] for ws
+00006050: 2069 6e20 7773 730a 2020 2020 2020 2020   in wss.        
+00006060: 5d0a 2020 2020 2020 2020 7472 616e 7366  ].        transf
+00006070: 6572 5f6f 7574 676f 696e 675f 6279 7465  er_outgoing_byte
+00006080: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00006090: 2020 7773 2e6d 6574 7269 6373 5b22 7472    ws.metrics["tr
+000060a0: 616e 7366 6572 225d 5b22 6f75 7467 6f69  ansfer"]["outgoi
+000060b0: 6e67 5f62 7974 6573 225d 2066 6f72 2077  ng_bytes"] for w
+000060c0: 7320 696e 2077 7373 0a20 2020 2020 2020  s in wss.       
+000060d0: 205d 0a20 2020 2020 2020 2077 6f72 6b65   ].        worke
+000060e0: 7273 203d 205b 7773 2e61 6464 7265 7373  rs = [ws.address
+000060f0: 2066 6f72 2077 7320 696e 2077 7373 5d0a   for ws in wss].
+00006100: 2020 2020 2020 2020 6573 6361 7065 645f          escaped_
+00006110: 776f 726b 6572 7320 3d20 5b65 7363 6170  workers = [escap
+00006120: 652e 7572 6c5f 6573 6361 7065 2877 6f72  e.url_escape(wor
+00006130: 6b65 7229 2066 6f72 2077 6f72 6b65 7220  ker) for worker 
+00006140: 696e 2077 6f72 6b65 7273 5d0a 0a20 2020  in workers]..   
+00006150: 2020 2020 2069 6620 7773 733a 0a20 2020       if wss:.   
+00006160: 2020 2020 2020 2020 2078 5f6c 696d 6974           x_limit
+00006170: 203d 206d 6178 280a 2020 2020 2020 2020   = max(.        
+00006180: 2020 2020 2020 2020 6d61 7828 7472 616e          max(tran
+00006190: 7366 6572 5f69 6e63 6f6d 696e 675f 6279  sfer_incoming_by
+000061a0: 7465 7329 2c0a 2020 2020 2020 2020 2020  tes),.          
+000061b0: 2020 2020 2020 6d61 7828 7472 616e 7366        max(transf
+000061c0: 6572 5f6f 7574 676f 696e 675f 6279 7465  er_outgoing_byte
+000061d0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000061e0: 2020 2020 6d61 7828 7773 2e6d 656d 6f72      max(ws.memor
+000061f0: 795f 6c69 6d69 7420 666f 7220 7773 2069  y_limit for ws i
+00006200: 6e20 7773 7329 2c0a 2020 2020 2020 2020  n wss),.        
+00006210: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00006220: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006230: 785f 6c69 6d69 7420 3d20 300a 2020 2020  x_limit = 0.    
+00006240: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
+00006250: 7261 6e67 652e 656e 6420 3d20 785f 6c69  range.end = x_li
+00006260: 6d69 740a 0a20 2020 2020 2020 2072 6573  mit..        res
+00006270: 756c 7420 3d20 7b0a 2020 2020 2020 2020  ult = {.        
+00006280: 2020 2020 2265 7363 6170 6564 5f77 6f72      "escaped_wor
+00006290: 6b65 7222 3a20 6573 6361 7065 645f 776f  ker": escaped_wo
+000062a0: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
+000062b0: 2020 2022 7472 616e 7366 6572 5f69 6e63     "transfer_inc
+000062c0: 6f6d 696e 675f 6279 7465 7322 3a20 7472  oming_bytes": tr
+000062d0: 616e 7366 6572 5f69 6e63 6f6d 696e 675f  ansfer_incoming_
+000062e0: 6279 7465 732c 0a20 2020 2020 2020 2020  bytes,.         
+000062f0: 2020 2022 7472 616e 7366 6572 5f6f 7574     "transfer_out
+00006300: 676f 696e 675f 6279 7465 7322 3a20 7472  going_bytes": tr
+00006310: 616e 7366 6572 5f6f 7574 676f 696e 675f  ansfer_outgoing_
+00006320: 6279 7465 732c 0a20 2020 2020 2020 2020  bytes,.         
+00006330: 2020 2022 776f 726b 6572 223a 2077 6f72     "worker": wor
+00006340: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+00006350: 2020 2279 5f69 6e63 6f6d 696e 6722 3a20    "y_incoming": 
+00006360: 795f 696e 636f 6d69 6e67 2c0a 2020 2020  y_incoming,.    
+00006370: 2020 2020 2020 2020 2279 5f6f 7574 676f          "y_outgo
+00006380: 696e 6722 3a20 795f 6f75 7467 6f69 6e67  ing": y_outgoing
+00006390: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+000063a0: 2020 2020 7365 6c66 2e72 6f6f 742e 7469      self.root.ti
+000063b0: 746c 652e 7465 7874 203d 2028 0a20 2020  tle.text = (.   
+000063c0: 2020 2020 2020 2020 2066 2242 7974 6573           f"Bytes
+000063d0: 2074 7261 6e73 6665 7272 696e 673a 207b   transferring: {
+000063e0: 666f 726d 6174 5f62 7974 6573 2873 756d  format_bytes(sum
+000063f0: 2874 7261 6e73 6665 725f 696e 636f 6d69  (transfer_incomi
+00006400: 6e67 5f62 7974 6573 2929 7d22 0a20 2020  ng_bytes))}".   
+00006410: 2020 2020 2029 0a20 2020 2020 2020 2075       ).        u
+00006420: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
+00006430: 652c 2072 6573 756c 7429 0a0a 0a63 6c61  e, result)...cla
+00006440: 7373 2048 6172 6477 6172 6528 4461 7368  ss Hardware(Dash
+00006450: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
+00006460: 0a20 2020 2022 2222 4f63 6375 7061 6e63  .    """Occupanc
+00006470: 7920 2869 6e20 7469 6d65 2920 7065 7220  y (in time) per 
+00006480: 776f 726b 6572 2222 220a 0a20 2020 2040  worker"""..    @
+00006490: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+000064a0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000064b0: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+000064c0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000064d0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+000064e0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+000064f0: 2020 2023 2044 6973 6b0a 2020 2020 2020     # Disk.      
+00006500: 2020 7365 6c66 2e64 6973 6b5f 736f 7572    self.disk_sour
+00006510: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+00006520: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
+00006530: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00006540: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
+00006550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006560: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
+00006570: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00006580: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00006590: 2020 2073 656c 662e 6469 736b 5f66 6967     self.disk_fig
+000065a0: 7572 6520 3d20 6669 6775 7265 280a 2020  ure = figure(.  
+000065b0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+000065c0: 2244 6973 6b20 4261 6e64 7769 6474 6820  "Disk Bandwidth 
+000065d0: 2d2d 2043 6f6d 7075 7469 6e67 202e 2e2e  -- Computing ...
+000065e0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+000065f0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
+00006600: 2020 2020 2074 6f6f 6c62 6172 5f6c 6f63       toolbar_loc
+00006610: 6174 696f 6e3d 2261 626f 7665 222c 0a20  ation="above",. 
+00006620: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+00006630: 6765 3d46 6163 746f 7252 616e 6765 2866  ge=FactorRange(f
+00006640: 6163 746f 7273 3d5b 5d29 2c0a 2020 2020  actors=[]),.    
+00006650: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00006660: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00006670: 2020 2020 7365 6c66 2e64 6973 6b5f 6669      self.disk_fi
+00006680: 6775 7265 2e76 6261 7228 0a20 2020 2020  gure.vbar(.     
+00006690: 2020 2020 2020 2078 3d22 7369 7a65 222c         x="size",
+000066a0: 2074 6f70 3d22 6261 6e64 7769 6474 6822   top="bandwidth"
+000066b0: 2c20 7769 6474 683d 302e 392c 2073 6f75  , width=0.9, sou
+000066c0: 7263 653d 7365 6c66 2e64 6973 6b5f 736f  rce=self.disk_so
+000066d0: 7572 6365 0a20 2020 2020 2020 2029 0a20  urce.        ). 
+000066e0: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+000066f0: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
+00006700: 2020 2020 2020 6d6f 6465 3d22 766c 696e        mode="vlin
+00006710: 6522 2c20 746f 6f6c 7469 7073 3d5b 2822  e", tooltips=[("
+00006720: 4261 6e64 7769 6474 6822 2c20 2240 6261  Bandwidth", "@ba
+00006730: 6e64 7769 6474 687b 302e 3030 2062 7d2f  ndwidth{0.00 b}/
+00006740: 7322 295d 0a20 2020 2020 2020 2029 0a20  s")].        ). 
+00006750: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00006760: 5f66 6967 7572 652e 6164 645f 746f 6f6c  _figure.add_tool
+00006770: 7328 686f 7665 7229 0a20 2020 2020 2020  s(hover).       
+00006780: 2073 656c 662e 6469 736b 5f66 6967 7572   self.disk_figur
+00006790: 652e 7961 7869 735b 305d 2e66 6f72 6d61  e.yaxis[0].forma
+000067a0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
+000067b0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
+000067c0: 6174 3d22 302e 3020 6222 290a 2020 2020  at="0.0 b").    
+000067d0: 2020 2020 7365 6c66 2e64 6973 6b5f 6669      self.disk_fi
+000067e0: 6775 7265 2e78 6772 6964 2e76 6973 6962  gure.xgrid.visib
+000067f0: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
+00006800: 2020 2020 2320 4d65 6d6f 7279 0a20 2020      # Memory.   
+00006810: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
+00006820: 5f73 6f75 7263 6520 3d20 436f 6c75 6d6e  _source = Column
+00006830: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
+00006840: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00006850: 2020 2020 2020 2020 2020 2273 697a 6522            "size"
+00006860: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00006870: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+00006880: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00006890: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
+000068a0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+000068b0: 6f72 795f 6669 6775 7265 203d 2066 6967  ory_figure = fig
+000068c0: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+000068d0: 2074 6974 6c65 3d22 4d65 6d6f 7279 2042   title="Memory B
+000068e0: 616e 6477 6964 7468 202d 2d20 436f 6d70  andwidth -- Comp
+000068f0: 7574 696e 6720 2e2e 2e22 2c0a 2020 2020  uting ...",.    
+00006900: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
+00006910: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00006920: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
+00006930: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
+00006940: 2020 2020 785f 7261 6e67 653d 4661 6374      x_range=Fact
+00006950: 6f72 5261 6e67 6528 6661 6374 6f72 733d  orRange(factors=
+00006960: 5b5d 292c 0a20 2020 2020 2020 2020 2020  []),.           
+00006970: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+00006980: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00006990: 6c66 2e6d 656d 6f72 795f 6669 6775 7265  lf.memory_figure
+000069a0: 2e76 6261 7228 0a20 2020 2020 2020 2020  .vbar(.         
+000069b0: 2020 2078 3d22 7369 7a65 222c 2074 6f70     x="size", top
+000069c0: 3d22 6261 6e64 7769 6474 6822 2c20 7769  ="bandwidth", wi
+000069d0: 6474 683d 302e 392c 2073 6f75 7263 653d  dth=0.9, source=
+000069e0: 7365 6c66 2e6d 656d 6f72 795f 736f 7572  self.memory_sour
+000069f0: 6365 0a20 2020 2020 2020 2029 0a20 2020  ce.        ).   
+00006a00: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
+00006a10: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
+00006a20: 2020 2020 6d6f 6465 3d22 766c 696e 6522      mode="vline"
+00006a30: 2c20 746f 6f6c 7469 7073 3d5b 2822 4261  , tooltips=[("Ba
+00006a40: 6e64 7769 6474 6822 2c20 2240 6261 6e64  ndwidth", "@band
+00006a50: 7769 6474 687b 302e 3030 2062 7d2f 7322  width{0.00 b}/s"
+00006a60: 295d 0a20 2020 2020 2020 2029 0a20 2020  )].        ).   
+00006a70: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
+00006a80: 5f66 6967 7572 652e 6164 645f 746f 6f6c  _figure.add_tool
+00006a90: 7328 686f 7665 7229 0a20 2020 2020 2020  s(hover).       
+00006aa0: 2073 656c 662e 6d65 6d6f 7279 5f66 6967   self.memory_fig
+00006ab0: 7572 652e 7961 7869 735b 305d 2e66 6f72  ure.yaxis[0].for
+00006ac0: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
+00006ad0: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
+00006ae0: 726d 6174 3d22 302e 3020 6222 290a 2020  rmat="0.0 b").  
+00006af0: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
+00006b00: 795f 6669 6775 7265 2e78 6772 6964 2e76  y_figure.xgrid.v
+00006b10: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+00006b20: 2020 2020 2020 2020 2320 4e65 7477 6f72          # Networ
+00006b30: 6b0a 2020 2020 2020 2020 7365 6c66 2e6e  k.        self.n
+00006b40: 6574 776f 726b 5f73 6f75 7263 6520 3d20  etwork_source = 
+00006b50: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+00006b60: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+00006b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b80: 2273 697a 6522 3a20 5b5d 2c0a 2020 2020  "size": [],.    
+00006b90: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00006ba0: 6477 6964 7468 223a 205b 5d2c 0a20 2020  dwidth": [],.   
+00006bb0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00006bc0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00006bd0: 6c66 2e6e 6574 776f 726b 5f66 6967 7572  lf.network_figur
+00006be0: 6520 3d20 6669 6775 7265 280a 2020 2020  e = figure(.    
+00006bf0: 2020 2020 2020 2020 7469 746c 653d 224e          title="N
+00006c00: 6574 776f 726b 2042 616e 6477 6964 7468  etwork Bandwidth
+00006c10: 202d 2d20 436f 6d70 7574 696e 6720 2e2e   -- Computing ..
+00006c20: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
+00006c30: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+00006c40: 2020 2020 2020 746f 6f6c 6261 725f 6c6f        toolbar_lo
+00006c50: 6361 7469 6f6e 3d22 6162 6f76 6522 2c0a  cation="above",.
+00006c60: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
+00006c70: 6e67 653d 4661 6374 6f72 5261 6e67 6528  nge=FactorRange(
+00006c80: 6661 6374 6f72 733d 5b5d 292c 0a20 2020  factors=[]),.   
+00006c90: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00006ca0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+00006cb0: 2020 2020 2020 7365 6c66 2e6e 6574 776f        self.netwo
+00006cc0: 726b 5f66 6967 7572 652e 7662 6172 280a  rk_figure.vbar(.
+00006cd0: 2020 2020 2020 2020 2020 2020 783d 2273              x="s
+00006ce0: 697a 6522 2c20 746f 703d 2262 616e 6477  ize", top="bandw
+00006cf0: 6964 7468 222c 2077 6964 7468 3d30 2e39  idth", width=0.9
+00006d00: 2c20 736f 7572 6365 3d73 656c 662e 6e65  , source=self.ne
+00006d10: 7477 6f72 6b5f 736f 7572 6365 0a20 2020  twork_source.   
+00006d20: 2020 2020 2029 0a20 2020 2020 2020 2068       ).        h
+00006d30: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
+00006d40: 280a 2020 2020 2020 2020 2020 2020 6d6f  (.            mo
+00006d50: 6465 3d22 766c 696e 6522 2c20 746f 6f6c  de="vline", tool
+00006d60: 7469 7073 3d5b 2822 4261 6e64 7769 6474  tips=[("Bandwidt
+00006d70: 6822 2c20 2240 6261 6e64 7769 6474 687b  h", "@bandwidth{
+00006d80: 302e 3030 2062 7d2f 7322 295d 0a20 2020  0.00 b}/s")].   
+00006d90: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00006da0: 656c 662e 6e65 7477 6f72 6b5f 6669 6775  elf.network_figu
+00006db0: 7265 2e61 6464 5f74 6f6f 6c73 2868 6f76  re.add_tools(hov
+00006dc0: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
+00006dd0: 2e6e 6574 776f 726b 5f66 6967 7572 652e  .network_figure.
+00006de0: 7961 7869 735b 305d 2e66 6f72 6d61 7474  yaxis[0].formatt
+00006df0: 6572 203d 204e 756d 6572 616c 5469 636b  er = NumeralTick
+00006e00: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+00006e10: 3d22 302e 3020 6222 290a 2020 2020 2020  ="0.0 b").      
+00006e20: 2020 7365 6c66 2e6e 6574 776f 726b 5f66    self.network_f
+00006e30: 6967 7572 652e 7867 7269 642e 7669 7369  igure.xgrid.visi
+00006e40: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
+00006e50: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
+00006e60: 2072 6f77 280a 2020 2020 2020 2020 2020   row(.          
+00006e70: 2020 7365 6c66 2e6d 656d 6f72 795f 6669    self.memory_fi
+00006e80: 6775 7265 2c0a 2020 2020 2020 2020 2020  gure,.          
+00006e90: 2020 7365 6c66 2e64 6973 6b5f 6669 6775    self.disk_figu
+00006ea0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
+00006eb0: 7365 6c66 2e6e 6574 776f 726b 5f66 6967  self.network_fig
+00006ec0: 7572 652c 0a20 2020 2020 2020 2029 0a0a  ure,.        )..
+00006ed0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+00006ee0: 6f72 795f 6461 7461 203d 207b 0a20 2020  ory_data = {.   
+00006ef0: 2020 2020 2020 2020 2022 7369 7a65 223a           "size":
+00006f00: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00006f10: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
+00006f20: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+00006f30: 2020 2020 7365 6c66 2e64 6973 6b5f 6461      self.disk_da
+00006f40: 7461 203d 207b 0a20 2020 2020 2020 2020  ta = {.         
+00006f50: 2020 2022 7369 7a65 223a 205b 5d2c 0a20     "size": [],. 
+00006f60: 2020 2020 2020 2020 2020 2022 6261 6e64             "band
+00006f70: 7769 6474 6822 3a20 5b5d 2c0a 2020 2020  width": [],.    
+00006f80: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+00006f90: 6c66 2e6e 6574 776f 726b 5f64 6174 6120  lf.network_data 
+00006fa0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00006fb0: 2273 697a 6522 3a20 5b5d 2c0a 2020 2020  "size": [],.    
+00006fc0: 2020 2020 2020 2020 2262 616e 6477 6964          "bandwid
+00006fd0: 7468 223a 205b 5d2c 0a20 2020 2020 2020  th": [],.       
+00006fe0: 207d 0a0a 2020 2020 2020 2020 6173 796e   }..        asyn
+00006ff0: 6320 6465 6620 6628 293a 0a20 2020 2020  c def f():.     
+00007000: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00007010: 6177 6169 7420 7365 6c66 2e73 6368 6564  await self.sched
+00007020: 756c 6572 2e62 656e 6368 6d61 726b 5f68  uler.benchmark_h
+00007030: 6172 6477 6172 6528 290a 0a20 2020 2020  ardware()..     
+00007040: 2020 2020 2020 2066 6f72 2073 697a 6520         for size 
+00007050: 696e 2073 6f72 7465 6428 7265 7375 6c74  in sorted(result
+00007060: 5b22 6469 736b 225d 2c20 6b65 793d 7061  ["disk"], key=pa
+00007070: 7273 655f 6279 7465 7329 3a0a 2020 2020  rse_bytes):.    
+00007080: 2020 2020 2020 2020 2020 2020 6261 6e64              band
+00007090: 7769 6474 6820 3d20 7265 7375 6c74 5b22  width = result["
+000070a0: 6469 736b 225d 5b73 697a 655d 0a20 2020  disk"][size].   
+000070b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000070c0: 662e 6469 736b 5f64 6174 615b 2273 697a  f.disk_data["siz
+000070d0: 6522 5d2e 6170 7065 6e64 2873 697a 6529  e"].append(size)
+000070e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000070f0: 2073 656c 662e 6469 736b 5f64 6174 615b   self.disk_data[
+00007100: 2262 616e 6477 6964 7468 225d 2e61 7070  "bandwidth"].app
+00007110: 656e 6428 6261 6e64 7769 6474 6829 0a0a  end(bandwidth)..
+00007120: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00007130: 7369 7a65 2069 6e20 736f 7274 6564 2872  size in sorted(r
+00007140: 6573 756c 745b 226d 656d 6f72 7922 5d2c  esult["memory"],
+00007150: 206b 6579 3d70 6172 7365 5f62 7974 6573   key=parse_bytes
+00007160: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00007170: 2020 2062 616e 6477 6964 7468 203d 2072     bandwidth = r
+00007180: 6573 756c 745b 226d 656d 6f72 7922 5d5b  esult["memory"][
+00007190: 7369 7a65 5d0a 2020 2020 2020 2020 2020  size].          
+000071a0: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
+000071b0: 795f 6461 7461 5b22 7369 7a65 225d 2e61  y_data["size"].a
+000071c0: 7070 656e 6428 7369 7a65 290a 2020 2020  ppend(size).    
+000071d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000071e0: 2e6d 656d 6f72 795f 6461 7461 5b22 6261  .memory_data["ba
+000071f0: 6e64 7769 6474 6822 5d2e 6170 7065 6e64  ndwidth"].append
+00007200: 2862 616e 6477 6964 7468 290a 0a20 2020  (bandwidth)..   
+00007210: 2020 2020 2020 2020 2066 6f72 2073 697a           for siz
+00007220: 6520 696e 2073 6f72 7465 6428 7265 7375  e in sorted(resu
+00007230: 6c74 5b22 6e65 7477 6f72 6b22 5d2c 206b  lt["network"], k
+00007240: 6579 3d70 6172 7365 5f62 7974 6573 293a  ey=parse_bytes):
+00007250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007260: 2062 616e 6477 6964 7468 203d 2072 6573   bandwidth = res
+00007270: 756c 745b 226e 6574 776f 726b 225d 5b73  ult["network"][s
+00007280: 697a 655d 0a20 2020 2020 2020 2020 2020  ize].           
+00007290: 2020 2020 2073 656c 662e 6e65 7477 6f72       self.networ
+000072a0: 6b5f 6461 7461 5b22 7369 7a65 225d 2e61  k_data["size"].a
+000072b0: 7070 656e 6428 7369 7a65 290a 2020 2020  ppend(size).    
+000072c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000072d0: 2e6e 6574 776f 726b 5f64 6174 615b 2262  .network_data["b
+000072e0: 616e 6477 6964 7468 225d 2e61 7070 656e  andwidth"].appen
+000072f0: 6428 6261 6e64 7769 6474 6829 0a0a 2020  d(bandwidth)..  
+00007300: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+00007310: 756c 6572 2e6c 6f6f 702e 6164 645f 6361  uler.loop.add_ca
+00007320: 6c6c 6261 636b 2866 290a 0a20 2020 2064  llback(f)..    d
+00007330: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
+00007340: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
+00007350: 2020 2020 2020 2020 2020 6e6f 7420 7365            not se
+00007360: 6c66 2e64 6973 6b5f 6461 7461 5b22 7369  lf.disk_data["si
+00007370: 7a65 225d 0a20 2020 2020 2020 2020 2020  ze"].           
+00007380: 206f 7220 7365 6c66 2e64 6973 6b5f 6669   or self.disk_fi
+00007390: 6775 7265 2e74 6974 6c65 2e74 6578 7420  gure.title.text 
+000073a0: 3d3d 2022 4469 736b 2042 616e 6477 6964  == "Disk Bandwid
+000073b0: 7468 220a 2020 2020 2020 2020 293a 0a20  th".        ):. 
+000073c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000073d0: 6e0a 0a20 2020 2020 2020 2073 656c 662e  n..        self.
+000073e0: 6e65 7477 6f72 6b5f 6669 6775 7265 2e78  network_figure.x
+000073f0: 5f72 616e 6765 2e66 6163 746f 7273 203d  _range.factors =
+00007400: 2073 656c 662e 6e65 7477 6f72 6b5f 6461   self.network_da
+00007410: 7461 5b22 7369 7a65 225d 0a20 2020 2020  ta["size"].     
+00007420: 2020 2073 656c 662e 6469 736b 5f66 6967     self.disk_fig
+00007430: 7572 652e 785f 7261 6e67 652e 6661 6374  ure.x_range.fact
+00007440: 6f72 7320 3d20 7365 6c66 2e64 6973 6b5f  ors = self.disk_
+00007450: 6461 7461 5b22 7369 7a65 225d 0a20 2020  data["size"].   
+00007460: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
+00007470: 5f66 6967 7572 652e 785f 7261 6e67 652e  _figure.x_range.
+00007480: 6661 6374 6f72 7320 3d20 7365 6c66 2e6d  factors = self.m
+00007490: 656d 6f72 795f 6461 7461 5b22 7369 7a65  emory_data["size
+000074a0: 225d 0a20 2020 2020 2020 2075 7064 6174  "].        updat
+000074b0: 6528 7365 6c66 2e64 6973 6b5f 736f 7572  e(self.disk_sour
+000074c0: 6365 2c20 7365 6c66 2e64 6973 6b5f 6461  ce, self.disk_da
+000074d0: 7461 290a 2020 2020 2020 2020 7570 6461  ta).        upda
+000074e0: 7465 2873 656c 662e 6d65 6d6f 7279 5f73  te(self.memory_s
+000074f0: 6f75 7263 652c 2073 656c 662e 6d65 6d6f  ource, self.memo
+00007500: 7279 5f64 6174 6129 0a20 2020 2020 2020  ry_data).       
+00007510: 2075 7064 6174 6528 7365 6c66 2e6e 6574   update(self.net
+00007520: 776f 726b 5f73 6f75 7263 652c 2073 656c  work_source, sel
+00007530: 662e 6e65 7477 6f72 6b5f 6461 7461 290a  f.network_data).
+00007540: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+00007550: 6f72 795f 6669 6775 7265 2e74 6974 6c65  ory_figure.title
+00007560: 2e74 6578 7420 3d20 224d 656d 6f72 7920  .text = "Memory 
+00007570: 4261 6e64 7769 6474 6822 0a20 2020 2020  Bandwidth".     
+00007580: 2020 2073 656c 662e 6469 736b 5f66 6967     self.disk_fig
+00007590: 7572 652e 7469 746c 652e 7465 7874 203d  ure.title.text =
+000075a0: 2022 4469 736b 2042 616e 6477 6964 7468   "Disk Bandwidth
+000075b0: 220a 2020 2020 2020 2020 7365 6c66 2e6e  ".        self.n
+000075c0: 6574 776f 726b 5f66 6967 7572 652e 7469  etwork_figure.ti
+000075d0: 746c 652e 7465 7874 203d 2022 4e65 7477  tle.text = "Netw
+000075e0: 6f72 6b20 4261 6e64 7769 6474 6822 0a0a  ork Bandwidth"..
+000075f0: 0a63 6c61 7373 2042 616e 6477 6964 7468  .class Bandwidth
+00007600: 5479 7065 7328 4461 7368 626f 6172 6443  Types(DashboardC
+00007610: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
+00007620: 2222 4261 7220 6368 6172 7420 7368 6f77  ""Bar chart show
+00007630: 696e 6720 6261 6e64 7769 6474 6820 7065  ing bandwidth pe
+00007640: 7220 7479 7065 2222 220a 0a20 2020 2040  r type"""..    @
+00007650: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+00007660: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00007670: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+00007680: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00007690: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
+000076a0: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+000076b0: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
+000076c0: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+000076d0: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+000076e0: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
+000076f0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00007700: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
+00007710: 6822 3a20 5b31 2c20 325d 2c0a 2020 2020  h": [1, 2],.    
+00007720: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00007730: 6477 6964 7468 2d68 616c 6622 3a20 5b30  dwidth-half": [0
+00007740: 2e35 2c20 315d 2c0a 2020 2020 2020 2020  .5, 1],.        
+00007750: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+00007760: 5b22 6122 2c20 2262 225d 2c0a 2020 2020  ["a", "b"],.    
+00007770: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00007780: 6477 6964 7468 5f74 6578 7422 3a20 5b22  dwidth_text": ["
+00007790: 3122 2c20 2232 225d 2c0a 2020 2020 2020  1", "2"],.      
+000077a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000077b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000077c0: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
+000077d0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+000077e0: 3d22 4261 6e64 7769 6474 6820 6279 2054  ="Bandwidth by T
+000077f0: 7970 6522 2c0a 2020 2020 2020 2020 2020  ype",.          
+00007800: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
+00007810: 2020 2020 2020 2020 6e61 6d65 3d22 6261          name="ba
+00007820: 6e64 7769 6474 685f 7479 7065 5f68 6973  ndwidth_type_his
+00007830: 746f 6772 616d 222c 0a20 2020 2020 2020  togram",.       
+00007840: 2020 2020 2079 5f72 616e 6765 3d5b 2261       y_range=["a
+00007850: 222c 2022 6222 5d2c 0a20 2020 2020 2020  ", "b"],.       
+00007860: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00007870: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00007880: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+00007890: 2e6d 616a 6f72 5f6c 6162 656c 5f6f 7269  .major_label_ori
+000078a0: 656e 7461 7469 6f6e 203d 202d 302e 350a  entation = -0.5.
+000078b0: 2020 2020 2020 2020 7265 6374 203d 2073          rect = s
+000078c0: 656c 662e 726f 6f74 2e72 6563 7428 0a20  elf.root.rect(. 
+000078d0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+000078e0: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
+000078f0: 2020 2020 2020 2020 2020 2078 3d22 6261             x="ba
+00007900: 6e64 7769 6474 682d 6861 6c66 222c 0a20  ndwidth-half",. 
+00007910: 2020 2020 2020 2020 2020 2079 3d22 7479             y="ty
+00007920: 7065 222c 0a20 2020 2020 2020 2020 2020  pe",.           
+00007930: 2077 6964 7468 3d22 6261 6e64 7769 6474   width="bandwidt
+00007940: 6822 2c0a 2020 2020 2020 2020 2020 2020  h",.            
+00007950: 6865 6967 6874 3d30 2e39 2c0a 2020 2020  height=0.9,.    
+00007960: 2020 2020 2020 2020 636f 6c6f 723d 2262          color="b
+00007970: 6c75 6522 2c0a 2020 2020 2020 2020 290a  lue",.        ).
+00007980: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00007990: 742e 785f 7261 6e67 652e 7374 6172 7420  t.x_range.start 
+000079a0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+000079b0: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
+000079c0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
+000079d0: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
+000079e0: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
+000079f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00007a00: 742e 7861 7869 732e 7469 636b 6572 203d  t.xaxis.ticker =
+00007a10: 2041 6461 7074 6976 6554 6963 6b65 7228   AdaptiveTicker(
+00007a20: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
+00007a30: 2020 2020 2020 7265 6374 2e6e 6f6e 7365        rect.nonse
+00007a40: 6c65 6374 696f 6e5f 676c 7970 6820 3d20  lection_glyph = 
+00007a50: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
+00007a60: 6c66 2e72 6f6f 742e 7861 7869 732e 6d69  lf.root.xaxis.mi
+00007a70: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
+00007a80: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+00007a90: 7365 6c66 2e72 6f6f 742e 7967 7269 642e  self.root.ygrid.
+00007aa0: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
+00007ab0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00007ac0: 6f74 2e74 6f6f 6c62 6172 5f6c 6f63 6174  ot.toolbar_locat
+00007ad0: 696f 6e20 3d20 4e6f 6e65 0a0a 2020 2020  ion = None..    
+00007ae0: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+00007af0: 7254 6f6f 6c28 290a 2020 2020 2020 2020  rTool().        
+00007b00: 686f 7665 722e 746f 6f6c 7469 7073 203d  hover.tooltips =
+00007b10: 2022 4074 7970 653a 2040 6261 6e64 7769   "@type: @bandwi
+00007b20: 6474 685f 7465 7874 202f 2073 220a 2020  dth_text / s".  
+00007b30: 2020 2020 2020 686f 7665 722e 706f 696e        hover.poin
+00007b40: 745f 706f 6c69 6379 203d 2022 666f 6c6c  t_policy = "foll
+00007b50: 6f77 5f6d 6f75 7365 220a 2020 2020 2020  ow_mouse".      
+00007b60: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+00007b70: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
+00007b80: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+00007b90: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00007ba0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+00007bb0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+00007bc0: 6c66 293a 0a20 2020 2020 2020 2062 7720  lf):.        bw 
+00007bd0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00007be0: 2e62 616e 6477 6964 7468 5f74 7970 6573  .bandwidth_types
+00007bf0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00007c00: 6f74 2e79 5f72 616e 6765 2e66 6163 746f  ot.y_range.facto
+00007c10: 7273 203d 206c 6973 7428 736f 7274 6564  rs = list(sorted
+00007c20: 2862 7729 290a 2020 2020 2020 2020 7265  (bw)).        re
+00007c30: 7375 6c74 203d 207b 0a20 2020 2020 2020  sult = {.       
+00007c40: 2020 2020 2022 6261 6e64 7769 6474 6822       "bandwidth"
+00007c50: 3a20 6c69 7374 2862 772e 7661 6c75 6573  : list(bw.values
+00007c60: 2829 292c 0a20 2020 2020 2020 2020 2020  ()),.           
+00007c70: 2022 6261 6e64 7769 6474 682d 6861 6c66   "bandwidth-half
+00007c80: 223a 205b 6220 2f20 3220 666f 7220 6220  ": [b / 2 for b 
+00007c90: 696e 2062 772e 7661 6c75 6573 2829 5d2c  in bw.values()],
+00007ca0: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
+00007cb0: 7065 223a 206c 6973 7428 6277 2e6b 6579  pe": list(bw.key
+00007cc0: 7328 2929 2c0a 2020 2020 2020 2020 2020  s()),.          
+00007cd0: 2020 2262 616e 6477 6964 7468 5f74 6578    "bandwidth_tex
+00007ce0: 7422 3a20 5b66 6f72 6d61 745f 6279 7465  t": [format_byte
+00007cf0: 7328 7829 2066 6f72 2078 2069 6e20 6277  s(x) for x in bw
+00007d00: 2e76 616c 7565 7328 295d 2c0a 2020 2020  .values()],.    
+00007d10: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+00007d20: 6c66 2e72 6f6f 742e 7469 746c 652e 7465  lf.root.title.te
+00007d30: 7874 203d 2022 4261 6e64 7769 6474 683a  xt = "Bandwidth:
+00007d40: 2022 202b 2066 6f72 6d61 745f 6279 7465   " + format_byte
+00007d50: 7328 7365 6c66 2e73 6368 6564 756c 6572  s(self.scheduler
+00007d60: 2e62 616e 6477 6964 7468 290a 2020 2020  .bandwidth).    
+00007d70: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+00007d80: 736f 7572 6365 2c20 7265 7375 6c74 290a  source, result).
+00007d90: 0a0a 636c 6173 7320 4261 6e64 7769 6474  ..class Bandwidt
+00007da0: 6857 6f72 6b65 7273 2844 6173 6862 6f61  hWorkers(Dashboa
+00007db0: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
+00007dc0: 2020 2222 2248 6f77 206d 616e 7920 7461    """How many ta
+00007dd0: 736b 7320 6172 6520 6f6e 2065 6163 6820  sks are on each 
+00007de0: 776f 726b 6572 2222 220a 0a20 2020 2040  worker"""..    @
+00007df0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+00007e00: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00007e10: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+00007e20: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00007e30: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
+00007e40: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+00007e50: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
+00007e60: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+00007e70: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+00007e80: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
+00007e90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00007ea0: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
+00007eb0: 6822 3a20 5b31 2c20 325d 2c0a 2020 2020  h": [1, 2],.    
+00007ec0: 2020 2020 2020 2020 2020 2020 2273 6f75              "sou
+00007ed0: 7263 6522 3a20 5b22 6122 2c20 2262 225d  rce": ["a", "b"]
+00007ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007ef0: 2020 2264 6573 7469 6e61 7469 6f6e 223a    "destination":
+00007f00: 205b 2261 222c 2022 6222 5d2c 0a20 2020   ["a", "b"],.   
+00007f10: 2020 2020 2020 2020 2020 2020 2022 6261               "ba
+00007f20: 6e64 7769 6474 685f 7465 7874 223a 205b  ndwidth_text": [
+00007f30: 2231 222c 2022 3222 5d2c 0a20 2020 2020  "1", "2"],.     
+00007f40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00007f50: 2029 0a0a 2020 2020 2020 2020 7661 6c75   )..        valu
+00007f60: 6573 203d 205b 6865 7828 7829 5b32 3a5d  es = [hex(x)[2:]
+00007f70: 2066 6f72 2078 2069 6e20 7261 6e67 6528   for x in range(
+00007f80: 3634 2c20 3235 3629 5d5b 3a3a 2d31 5d0a  64, 256)][::-1].
+00007f90: 2020 2020 2020 2020 6d61 7070 6572 203d          mapper =
+00007fa0: 206c 696e 6561 725f 636d 6170 280a 2020   linear_cmap(.  
+00007fb0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
+00007fc0: 6e61 6d65 3d22 6261 6e64 7769 6474 6822  name="bandwidth"
+00007fd0: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
+00007fe0: 6c65 7474 653d 5b22 2322 202b 2078 202b  lette=["#" + x +
+00007ff0: 2078 202b 2022 4646 2220 666f 7220 7820   x + "FF" for x 
+00008000: 696e 2076 616c 7565 735d 2c0a 2020 2020  in values],.    
+00008010: 2020 2020 2020 2020 6c6f 773d 302c 0a20          low=0,. 
+00008020: 2020 2020 2020 2020 2020 2068 6967 683d             high=
+00008030: 312c 0a20 2020 2020 2020 2029 0a0a 2020  1,.        )..  
+00008040: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+00008050: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+00008060: 2020 2020 2020 7469 746c 653d 2242 616e        title="Ban
+00008070: 6477 6964 7468 2062 7920 576f 726b 6572  dwidth by Worker
+00008080: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+00008090: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
+000080a0: 2020 2020 206e 616d 653d 2262 616e 6477       name="bandw
+000080b0: 6964 7468 5f77 6f72 6b65 725f 6865 6174  idth_worker_heat
+000080c0: 6d61 7022 2c0a 2020 2020 2020 2020 2020  map",.          
+000080d0: 2020 785f 7261 6e67 653d 5b22 6122 2c20    x_range=["a", 
+000080e0: 2262 225d 2c0a 2020 2020 2020 2020 2020  "b"],.          
+000080f0: 2020 795f 7261 6e67 653d 5b22 6122 2c20    y_range=["a", 
+00008100: 2262 225d 2c0a 2020 2020 2020 2020 2020  "b"],.          
+00008110: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00008120: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00008130: 6c66 2e72 6f6f 742e 7861 7869 732e 6d61  lf.root.xaxis.ma
+00008140: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
+00008150: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
+00008160: 5249 454e 5441 5449 4f4e 0a20 2020 2020  RIENTATION.     
+00008170: 2020 2073 656c 662e 726f 6f74 2e72 6563     self.root.rec
+00008180: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
+00008190: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+000081a0: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
+000081b0: 3d22 736f 7572 6365 222c 0a20 2020 2020  ="source",.     
+000081c0: 2020 2020 2020 2079 3d22 6465 7374 696e         y="destin
+000081d0: 6174 696f 6e22 2c0a 2020 2020 2020 2020  ation",.        
+000081e0: 2020 2020 636f 6c6f 723d 6d61 7070 6572      color=mapper
+000081f0: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+00008200: 6967 6874 3d31 2c0a 2020 2020 2020 2020  ight=1,.        
+00008210: 2020 2020 7769 6474 683d 312c 0a20 2020      width=1,.   
+00008220: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00008230: 7365 6c66 2e63 6f6c 6f72 5f6d 6170 203d  self.color_map =
+00008240: 206d 6170 7065 725b 2274 7261 6e73 666f   mapper["transfo
+00008250: 726d 225d 0a20 2020 2020 2020 2063 6f6c  rm"].        col
+00008260: 6f72 5f62 6172 203d 2043 6f6c 6f72 4261  or_bar = ColorBa
+00008270: 7228 0a20 2020 2020 2020 2020 2020 2063  r(.            c
+00008280: 6f6c 6f72 5f6d 6170 7065 723d 7365 6c66  olor_mapper=self
+00008290: 2e63 6f6c 6f72 5f6d 6170 2c0a 2020 2020  .color_map,.    
+000082a0: 2020 2020 2020 2020 6c61 6265 6c5f 7374          label_st
+000082b0: 616e 646f 6666 3d31 322c 0a20 2020 2020  andoff=12,.     
+000082c0: 2020 2020 2020 2062 6f72 6465 725f 6c69         border_li
+000082d0: 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20  ne_color=None,. 
+000082e0: 2020 2020 2020 2020 2020 206c 6f63 6174             locat
+000082f0: 696f 6e3d 2830 2c20 3029 2c0a 2020 2020  ion=(0, 0),.    
+00008300: 2020 2020 290a 2020 2020 2020 2020 636f      ).        co
+00008310: 6c6f 725f 6261 722e 666f 726d 6174 7465  lor_bar.formatte
+00008320: 7220 3d20 4e75 6d65 7261 6c54 6963 6b46  r = NumeralTickF
+00008330: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+00008340: 2230 2e30 2062 2229 0a20 2020 2020 2020  "0.0 b").       
+00008350: 2063 6f6c 6f72 5f62 6172 2e74 6963 6b65   color_bar.ticke
+00008360: 7220 3d20 4164 6170 7469 7665 5469 636b  r = AdaptiveTick
+00008370: 6572 282a 2a54 4943 4b53 5f31 3032 3429  er(**TICKS_1024)
+00008380: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00008390: 6f74 2e61 6464 5f6c 6179 6f75 7428 636f  ot.add_layout(co
+000083a0: 6c6f 725f 6261 722c 2022 7269 6768 7422  lor_bar, "right"
+000083b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000083c0: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
+000083d0: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
+000083e0: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
+000083f0: 7665 7254 6f6f 6c28 290a 2020 2020 2020  verTool().      
+00008400: 2020 686f 7665 722e 746f 6f6c 7469 7073    hover.tooltips
+00008410: 203d 2022 2222 0a20 2020 2020 2020 2020   = """.         
+00008420: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
+00008430: 2020 2020 2020 2020 203c 703e 3c62 3e53           <p><b>S
+00008440: 6f75 7263 653a 3c2f 623e 2040 736f 7572  ource:</b> @sour
+00008450: 6365 203c 2f70 3e0a 2020 2020 2020 2020  ce </p>.        
+00008460: 2020 2020 2020 2020 3c70 3e3c 623e 4465          <p><b>De
+00008470: 7374 696e 6174 696f 6e3a 3c2f 623e 2040  stination:</b> @
+00008480: 6465 7374 696e 6174 696f 6e20 3c2f 703e  destination </p>
+00008490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000084a0: 203c 703e 3c62 3e42 616e 6477 6964 7468   <p><b>Bandwidth
+000084b0: 3a3c 2f62 3e20 4062 616e 6477 6964 7468  :</b> @bandwidth
+000084c0: 5f74 6578 7420 2f20 733c 2f70 3e0a 2020  _text / s</p>.  
+000084d0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+000084e0: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
+000084f0: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
+00008500: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
+00008510: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
+00008520: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+00008530: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
+00008540: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+00008550: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+00008560: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+00008570: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+00008580: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00008590: 6277 203d 2073 656c 662e 7363 6865 6475  bw = self.schedu
+000085a0: 6c65 722e 6261 6e64 7769 6474 685f 776f  ler.bandwidth_wo
+000085b0: 726b 6572 730a 2020 2020 2020 2020 6966  rkers.        if
+000085c0: 206e 6f74 2062 773a 0a20 2020 2020 2020   not bw:.       
+000085d0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+000085e0: 2020 2020 2064 6566 206e 616d 6528 6164       def name(ad
+000085f0: 6472 6573 7329 3a0a 2020 2020 2020 2020  dress):.        
+00008600: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00008610: 2020 2020 2020 2020 2077 7320 3d20 7365           ws = se
+00008620: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
+00008630: 6b65 7273 5b61 6464 7265 7373 5d0a 2020  kers[address].  
+00008640: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00008650: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+00008660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00008670: 6e20 6164 6472 6573 730a 2020 2020 2020  n address.      
+00008680: 2020 2020 2020 6966 2077 732e 6e61 6d65        if ws.name
+00008690: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000086a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000086b0: 7475 726e 2073 7472 2877 732e 6e61 6d65  turn str(ws.name
+000086c0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+000086d0: 7475 726e 2061 6464 7265 7373 0a0a 2020  turn address..  
+000086e0: 2020 2020 2020 782c 2079 2c20 7661 6c75        x, y, valu
+000086f0: 6520 3d20 7a69 7028 2a28 286e 616d 6528  e = zip(*((name(
+00008700: 6129 2c20 6e61 6d65 2862 292c 2063 2920  a), name(b), c) 
+00008710: 666f 7220 2861 2c20 6229 2c20 6320 696e  for (a, b), c in
+00008720: 2062 772e 6974 656d 7328 2929 290a 0a20   bw.items())).. 
+00008730: 2020 2020 2020 2073 656c 662e 636f 6c6f         self.colo
+00008740: 725f 6d61 702e 6869 6768 203d 206d 6178  r_map.high = max
+00008750: 2876 616c 7565 290a 0a20 2020 2020 2020  (value)..       
+00008760: 2066 6163 746f 7273 203d 206c 6973 7428   factors = list(
+00008770: 736f 7274 6564 2873 6574 2878 202b 2079  sorted(set(x + y
+00008780: 2929 290a 2020 2020 2020 2020 7365 6c66  ))).        self
+00008790: 2e72 6f6f 742e 785f 7261 6e67 652e 6661  .root.x_range.fa
+000087a0: 6374 6f72 7320 3d20 6661 6374 6f72 730a  ctors = factors.
+000087b0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+000087c0: 742e 795f 7261 6e67 652e 6661 6374 6f72  t.y_range.factor
+000087d0: 7320 3d20 6661 6374 6f72 735b 3a3a 2d31  s = factors[::-1
+000087e0: 5d0a 0a20 2020 2020 2020 2072 6573 756c  ]..        resul
+000087f0: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
+00008800: 2020 2273 6f75 7263 6522 3a20 782c 0a20    "source": x,. 
+00008810: 2020 2020 2020 2020 2020 2022 6465 7374             "dest
+00008820: 696e 6174 696f 6e22 3a20 792c 0a20 2020  ination": y,.   
+00008830: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
+00008840: 6474 6822 3a20 7661 6c75 652c 0a20 2020  dth": value,.   
+00008850: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
+00008860: 6474 685f 7465 7874 223a 206c 6973 7428  dth_text": list(
+00008870: 6d61 7028 666f 726d 6174 5f62 7974 6573  map(format_bytes
+00008880: 2c20 7661 6c75 6529 292c 0a20 2020 2020  , value)),.     
+00008890: 2020 207d 0a20 2020 2020 2020 2073 656c     }.        sel
+000088a0: 662e 726f 6f74 2e74 6974 6c65 2e74 6578  f.root.title.tex
+000088b0: 7420 3d20 2242 616e 6477 6964 7468 3a20  t = "Bandwidth: 
+000088c0: 2220 2b20 666f 726d 6174 5f62 7974 6573  " + format_bytes
+000088d0: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
+000088e0: 6261 6e64 7769 6474 6829 0a20 2020 2020  bandwidth).     
+000088f0: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
+00008900: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
+00008910: 0a63 6c61 7373 2057 6f72 6b65 724e 6574  .class WorkerNet
+00008920: 776f 726b 4261 6e64 7769 6474 6828 4461  workBandwidth(Da
+00008930: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
+00008940: 293a 0a20 2020 2022 2222 576f 726b 6572  ):.    """Worker
+00008950: 206e 6574 776f 726b 2062 616e 6477 6964   network bandwid
+00008960: 7468 2063 6861 7274 0a0a 2020 2020 506c  th chart..    Pl
+00008970: 6f74 7320 686f 7269 7a6f 6e74 616c 2062  ots horizontal b
+00008980: 6172 7320 7769 7468 2074 6865 2068 6f73  ars with the hos
+00008990: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
+000089a0: 7320 616e 6420 686f 7374 5f6e 6574 5f69  s and host_net_i
+000089b0: 6f2e 7772 6974 655f 6270 7320 776f 726b  o.write_bps work
+000089c0: 6572 0a20 2020 2073 7461 7465 0a20 2020  er.    state.   
+000089d0: 2022 2222 0a0a 2020 2020 406c 6f67 5f65   """..    @log_e
+000089e0: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
+000089f0: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+00008a00: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
+00008a10: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00008a20: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
+00008a30: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
+00008a40: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
+00008a50: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
+00008a60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00008a70: 2020 2020 2020 2020 2020 2020 2279 5f72              "y_r
+00008a80: 6561 6422 3a20 5b5d 2c0a 2020 2020 2020  ead": [],.      
+00008a90: 2020 2020 2020 2020 2020 2279 5f77 7269            "y_wri
+00008aa0: 7465 223a 205b 5d2c 0a20 2020 2020 2020  te": [],.       
+00008ab0: 2020 2020 2020 2020 2022 785f 7265 6164           "x_read
+00008ac0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00008ad0: 2020 2020 2020 2022 785f 7772 6974 6522         "x_write"
+00008ae0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00008af0: 2020 2020 2020 2278 5f72 6561 645f 6469        "x_read_di
+00008b00: 736b 223a 205b 5d2c 0a20 2020 2020 2020  sk": [],.       
+00008b10: 2020 2020 2020 2020 2022 785f 7772 6974           "x_writ
+00008b20: 655f 6469 736b 223a 205b 5d2c 0a20 2020  e_disk": [],.   
+00008b30: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00008b40: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00008b50: 6c66 2e62 616e 6477 6964 7468 203d 2066  lf.bandwidth = f
+00008b60: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+00008b70: 2020 2074 6974 6c65 3d22 576f 726b 6572     title="Worker
+00008b80: 204e 6574 776f 726b 2042 616e 6477 6964   Network Bandwid
+00008b90: 7468 222c 0a20 2020 2020 2020 2020 2020  th",.           
+00008ba0: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+00008bb0: 2020 2020 2020 206e 616d 653d 2277 6f72         name="wor
+00008bc0: 6b65 725f 6e65 7477 6f72 6b5f 6261 6e64  ker_network_band
+00008bd0: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
+00008be0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00008bf0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00008c00: 2023 2068 6f73 745f 6e65 745f 696f 2e72   # host_net_io.r
+00008c10: 6561 645f 6270 730a 2020 2020 2020 2020  ead_bps.        
+00008c20: 7365 6c66 2e62 616e 6477 6964 7468 2e68  self.bandwidth.h
+00008c30: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
+00008c40: 2079 3d22 795f 7265 6164 222c 0a20 2020   y="y_read",.   
+00008c50: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
+00008c60: 785f 7265 6164 222c 0a20 2020 2020 2020  x_read",.       
+00008c70: 2020 2020 206c 696e 655f 636f 6c6f 723d       line_color=
+00008c80: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00008c90: 2020 6c65 6674 3d30 2c0a 2020 2020 2020    left=0,.      
+00008ca0: 2020 2020 2020 6865 6967 6874 3d30 2e35        height=0.5
+00008cb0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00008cc0: 6c6c 5f63 6f6c 6f72 3d22 7265 6422 2c0a  ll_color="red",.
+00008cd0: 2020 2020 2020 2020 2020 2020 6c65 6765              lege
+00008ce0: 6e64 5f6c 6162 656c 3d22 7265 6164 222c  nd_label="read",
+00008cf0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00008d00: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+00008d10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00008d20: 2020 2020 2320 686f 7374 5f6e 6574 5f69      # host_net_i
+00008d30: 6f2e 7772 6974 655f 6270 730a 2020 2020  o.write_bps.    
+00008d40: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+00008d50: 7468 2e68 6261 7228 0a20 2020 2020 2020  th.hbar(.       
+00008d60: 2020 2020 2079 3d22 795f 7772 6974 6522       y="y_write"
+00008d70: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
+00008d80: 6768 743d 2278 5f77 7269 7465 222c 0a20  ght="x_write",. 
+00008d90: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+00008da0: 636f 6c6f 723d 4e6f 6e65 2c0a 2020 2020  color=None,.    
+00008db0: 2020 2020 2020 2020 6c65 6674 3d30 2c0a          left=0,.
+00008dc0: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00008dd0: 6874 3d30 2e35 2c0a 2020 2020 2020 2020  ht=0.5,.        
+00008de0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+00008df0: 626c 7565 222c 0a20 2020 2020 2020 2020  blue",.         
+00008e00: 2020 206c 6567 656e 645f 6c61 6265 6c3d     legend_label=
+00008e10: 2277 7269 7465 222c 0a20 2020 2020 2020  "write",.       
+00008e20: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00008e30: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+00008e40: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00008e50: 2e62 616e 6477 6964 7468 2e61 7869 735b  .bandwidth.axis[
+00008e60: 305d 2e74 6963 6b65 7220 3d20 4261 7369  0].ticker = Basi
+00008e70: 6354 6963 6b65 7228 2a2a 5449 434b 535f  cTicker(**TICKS_
+00008e80: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
+00008e90: 6c66 2e62 616e 6477 6964 7468 2e78 6178  lf.bandwidth.xax
+00008ea0: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
+00008eb0: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
+00008ec0: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+00008ed0: 2e30 2062 2229 0a20 2020 2020 2020 2073  .0 b").        s
+00008ee0: 656c 662e 6261 6e64 7769 6474 682e 7861  elf.bandwidth.xa
+00008ef0: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
+00008f00: 6f72 6965 6e74 6174 696f 6e20 3d20 584c  orientation = XL
+00008f10: 4142 454c 5f4f 5249 454e 5441 5449 4f4e  ABEL_ORIENTATION
+00008f20: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00008f30: 6e64 7769 6474 682e 7861 7869 732e 6d69  ndwidth.xaxis.mi
+00008f40: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
+00008f50: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+00008f60: 7365 6c66 2e62 616e 6477 6964 7468 2e78  self.bandwidth.x
+00008f70: 5f72 616e 6765 203d 2052 616e 6765 3164  _range = Range1d
+00008f80: 2873 7461 7274 3d30 290a 2020 2020 2020  (start=0).      
+00008f90: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
+00008fa0: 2e79 6178 6973 2e76 6973 6962 6c65 203d  .yaxis.visible =
+00008fb0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+00008fc0: 656c 662e 6261 6e64 7769 6474 682e 7967  elf.bandwidth.yg
+00008fd0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+00008fe0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+00008ff0: 2e62 616e 6477 6964 7468 2e74 6f6f 6c62  .bandwidth.toolb
+00009000: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
+00009010: 6e65 0a0a 2020 2020 2020 2020 7365 6c66  ne..        self
+00009020: 2e64 6973 6b20 3d20 6669 6775 7265 280a  .disk = figure(.
+00009030: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+00009040: 653d 2257 6f72 6b65 7273 2044 6973 6b22  e="Workers Disk"
+00009050: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00009060: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
+00009070: 2020 2020 6e61 6d65 3d22 776f 726b 6572      name="worker
+00009080: 5f64 6973 6b22 2c0a 2020 2020 2020 2020  _disk",.        
+00009090: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+000090a0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000090b0: 2023 2068 6f73 745f 6469 736b 5f69 6f2e   # host_disk_io.
+000090c0: 7265 6164 5f62 7073 0a20 2020 2020 2020  read_bps.       
+000090d0: 2073 656c 662e 6469 736b 2e68 6261 7228   self.disk.hbar(
+000090e0: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
+000090f0: 795f 7265 6164 222c 0a20 2020 2020 2020  y_read",.       
+00009100: 2020 2020 2072 6967 6874 3d22 785f 7265       right="x_re
+00009110: 6164 5f64 6973 6b22 2c0a 2020 2020 2020  ad_disk",.      
+00009120: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
+00009130: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00009140: 2020 206c 6566 743d 302c 0a20 2020 2020     left=0,.     
+00009150: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
+00009160: 352c 0a20 2020 2020 2020 2020 2020 2066  5,.            f
+00009170: 696c 6c5f 636f 6c6f 723d 2272 6564 222c  ill_color="red",
+00009180: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
+00009190: 656e 645f 6c61 6265 6c3d 2272 6561 6422  end_label="read"
+000091a0: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
+000091b0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+000091c0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+000091d0: 2020 2020 2023 2068 6f73 745f 6469 736b       # host_disk
+000091e0: 5f69 6f2e 7772 6974 655f 6270 730a 2020  _io.write_bps.  
+000091f0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
+00009200: 6862 6172 280a 2020 2020 2020 2020 2020  hbar(.          
+00009210: 2020 793d 2279 5f77 7269 7465 222c 0a20    y="y_write",. 
+00009220: 2020 2020 2020 2020 2020 2072 6967 6874             right
+00009230: 3d22 785f 7772 6974 655f 6469 736b 222c  ="x_write_disk",
+00009240: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+00009250: 655f 636f 6c6f 723d 4e6f 6e65 2c0a 2020  e_color=None,.  
+00009260: 2020 2020 2020 2020 2020 6c65 6674 3d30            left=0
+00009270: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+00009280: 6967 6874 3d30 2e35 2c0a 2020 2020 2020  ight=0.5,.      
+00009290: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
+000092a0: 3d22 626c 7565 222c 0a20 2020 2020 2020  ="blue",.       
+000092b0: 2020 2020 206c 6567 656e 645f 6c61 6265       legend_labe
+000092c0: 6c3d 2277 7269 7465 222c 0a20 2020 2020  l="write",.     
+000092d0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+000092e0: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+000092f0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00009300: 6c66 2e64 6973 6b2e 6178 6973 5b30 5d2e  lf.disk.axis[0].
+00009310: 7469 636b 6572 203d 2042 6173 6963 5469  ticker = BasicTi
+00009320: 636b 6572 282a 2a54 4943 4b53 5f31 3032  cker(**TICKS_102
+00009330: 3429 0a20 2020 2020 2020 2073 656c 662e  4).        self.
+00009340: 6469 736b 2e78 6178 6973 5b30 5d2e 666f  disk.xaxis[0].fo
+00009350: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
+00009360: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
+00009370: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
+00009380: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00009390: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
+000093a0: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
+000093b0: 2058 4c41 4245 4c5f 4f52 4945 4e54 4154   XLABEL_ORIENTAT
+000093c0: 494f 4e0a 2020 2020 2020 2020 7365 6c66  ION.        self
+000093d0: 2e64 6973 6b2e 7861 7869 732e 6d69 6e6f  .disk.xaxis.mino
+000093e0: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
+000093f0: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
+00009400: 6c66 2e64 6973 6b2e 785f 7261 6e67 6520  lf.disk.x_range 
+00009410: 3d20 5261 6e67 6531 6428 7374 6172 743d  = Range1d(start=
+00009420: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+00009430: 6469 736b 2e79 6178 6973 2e76 6973 6962  disk.yaxis.visib
+00009440: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
+00009450: 2020 2073 656c 662e 6469 736b 2e79 6772     self.disk.ygr
+00009460: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
+00009470: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
+00009480: 6469 736b 2e74 6f6f 6c62 6172 5f6c 6f63  disk.toolbar_loc
+00009490: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
+000094a0: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+000094b0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+000094c0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+000094d0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+000094e0: 6c66 293a 0a20 2020 2020 2020 2077 6f72  lf):.        wor
+000094f0: 6b65 7273 203d 2073 656c 662e 7363 6865  kers = self.sche
+00009500: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
+00009510: 6c75 6573 2829 0a0a 2020 2020 2020 2020  lues()..        
+00009520: 6820 3d20 302e 310a 2020 2020 2020 2020  h = 0.1.        
+00009530: 795f 7265 6164 203d 205b 6920 2b20 302e  y_read = [i + 0.
+00009540: 3735 202b 2069 202a 2068 2066 6f72 2069  75 + i * h for i
+00009550: 2069 6e20 7261 6e67 6528 6c65 6e28 776f   in range(len(wo
+00009560: 726b 6572 7329 295d 0a20 2020 2020 2020  rkers))].       
+00009570: 2079 5f77 7269 7465 203d 205b 6920 2b20   y_write = [i + 
+00009580: 302e 3235 202b 2069 202a 2068 2066 6f72  0.25 + i * h for
+00009590: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+000095a0: 776f 726b 6572 7329 295d 0a0a 2020 2020  workers))]..    
+000095b0: 2020 2020 785f 7265 6164 203d 205b 5d0a      x_read = [].
+000095c0: 2020 2020 2020 2020 785f 7772 6974 6520          x_write 
+000095d0: 3d20 5b5d 0a20 2020 2020 2020 2078 5f72  = [].        x_r
+000095e0: 6561 645f 6469 736b 203d 205b 5d0a 2020  ead_disk = [].  
+000095f0: 2020 2020 2020 785f 7772 6974 655f 6469        x_write_di
+00009600: 736b 203d 205b 5d0a 0a20 2020 2020 2020  sk = []..       
+00009610: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
+00009620: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00009630: 785f 7265 6164 2e61 7070 656e 6428 7773  x_read.append(ws
+00009640: 2e6d 6574 7269 6373 5b22 686f 7374 5f6e  .metrics["host_n
+00009650: 6574 5f69 6f22 5d5b 2272 6561 645f 6270  et_io"]["read_bp
+00009660: 7322 5d29 0a20 2020 2020 2020 2020 2020  s"]).           
+00009670: 2078 5f77 7269 7465 2e61 7070 656e 6428   x_write.append(
+00009680: 7773 2e6d 6574 7269 6373 5b22 686f 7374  ws.metrics["host
+00009690: 5f6e 6574 5f69 6f22 5d5b 2277 7269 7465  _net_io"]["write
+000096a0: 5f62 7073 225d 290a 2020 2020 2020 2020  _bps"]).        
+000096b0: 2020 2020 785f 7265 6164 5f64 6973 6b2e      x_read_disk.
+000096c0: 6170 7065 6e64 2877 732e 6d65 7472 6963  append(ws.metric
+000096d0: 732e 6765 7428 2268 6f73 745f 6469 736b  s.get("host_disk
+000096e0: 5f69 6f22 2c20 7b7d 292e 6765 7428 2272  _io", {}).get("r
+000096f0: 6561 645f 6270 7322 2c20 3029 290a 2020  ead_bps", 0)).  
+00009700: 2020 2020 2020 2020 2020 785f 7772 6974            x_writ
+00009710: 655f 6469 736b 2e61 7070 656e 6428 7773  e_disk.append(ws
+00009720: 2e6d 6574 7269 6373 2e67 6574 2822 686f  .metrics.get("ho
+00009730: 7374 5f64 6973 6b5f 696f 222c 207b 7d29  st_disk_io", {})
+00009740: 2e67 6574 2822 7772 6974 655f 6270 7322  .get("write_bps"
+00009750: 2c20 3029 290a 0a20 2020 2020 2020 2069  , 0))..        i
+00009760: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+00009770: 2e77 6f72 6b65 7273 3a0a 2020 2020 2020  .workers:.      
+00009780: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
+00009790: 6964 7468 2e78 5f72 616e 6765 2e65 6e64  idth.x_range.end
+000097a0: 203d 206d 6178 280a 2020 2020 2020 2020   = max(.        
+000097b0: 2020 2020 2020 2020 6d61 7828 785f 7265          max(x_re
+000097c0: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
+000097d0: 2020 2020 206d 6178 2878 5f77 7269 7465       max(x_write
+000097e0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000097f0: 2020 2031 3030 5f30 3030 5f30 3030 2c0a     100_000_000,.
+00009800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009810: 302e 3935 202a 2073 656c 662e 6261 6e64  0.95 * self.band
+00009820: 7769 6474 682e 785f 7261 6e67 652e 656e  width.x_range.en
+00009830: 642c 0a20 2020 2020 2020 2020 2020 2029  d,.            )
+00009840: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00009850: 6c66 2e64 6973 6b2e 785f 7261 6e67 652e  lf.disk.x_range.
+00009860: 656e 6420 3d20 6d61 7828 0a20 2020 2020  end = max(.     
+00009870: 2020 2020 2020 2020 2020 206d 6178 2878             max(x
+00009880: 5f72 6561 645f 6469 736b 292c 0a20 2020  _read_disk),.   
+00009890: 2020 2020 2020 2020 2020 2020 206d 6178               max
+000098a0: 2878 5f77 7269 7465 5f64 6973 6b29 2c0a  (x_write_disk),.
+000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098c0: 3130 305f 3030 305f 3030 302c 0a20 2020  100_000_000,.   
+000098d0: 2020 2020 2020 2020 2020 2020 2030 2e39               0.9
+000098e0: 3520 2a20 7365 6c66 2e64 6973 6b2e 785f  5 * self.disk.x_
+000098f0: 7261 6e67 652e 656e 642c 0a20 2020 2020  range.end,.     
+00009900: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009910: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00009920: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+00009930: 682e 785f 7261 6e67 652e 656e 6420 3d20  h.x_range.end = 
+00009940: 3130 305f 3030 305f 3030 300a 2020 2020  100_000_000.    
+00009950: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+00009960: 6b2e 785f 7261 6e67 652e 656e 6420 3d20  k.x_range.end = 
+00009970: 3130 305f 3030 305f 3030 300a 0a20 2020  100_000_000..   
+00009980: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
+00009990: 2020 2020 2020 2020 2020 2020 2279 5f72              "y_r
+000099a0: 6561 6422 3a20 795f 7265 6164 2c0a 2020  ead": y_read,.  
+000099b0: 2020 2020 2020 2020 2020 2279 5f77 7269            "y_wri
+000099c0: 7465 223a 2079 5f77 7269 7465 2c0a 2020  te": y_write,.  
+000099d0: 2020 2020 2020 2020 2020 2278 5f72 6561            "x_rea
+000099e0: 6422 3a20 785f 7265 6164 2c0a 2020 2020  d": x_read,.    
+000099f0: 2020 2020 2020 2020 2278 5f77 7269 7465          "x_write
+00009a00: 223a 2078 5f77 7269 7465 2c0a 2020 2020  ": x_write,.    
+00009a10: 2020 2020 2020 2020 2278 5f72 6561 645f          "x_read_
+00009a20: 6469 736b 223a 2078 5f72 6561 645f 6469  disk": x_read_di
+00009a30: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00009a40: 2278 5f77 7269 7465 5f64 6973 6b22 3a20  "x_write_disk": 
+00009a50: 785f 7772 6974 655f 6469 736b 2c0a 2020  x_write_disk,.  
+00009a60: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00009a70: 2075 7064 6174 6528 7365 6c66 2e73 6f75   update(self.sou
+00009a80: 7263 652c 2072 6573 756c 7429 0a0a 0a63  rce, result)...c
+00009a90: 6c61 7373 2053 7973 7465 6d54 696d 6573  lass SystemTimes
+00009aa0: 6572 6965 7328 4461 7368 626f 6172 6443  eries(DashboardC
+00009ab0: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
+00009ac0: 2222 5469 6d65 7365 7269 6573 2066 6f72  ""Timeseries for
+00009ad0: 2077 6f72 6b65 7220 6e65 7477 6f72 6b20   worker network 
+00009ae0: 6261 6e64 7769 6474 682c 2063 7075 2c20  bandwidth, cpu, 
+00009af0: 6d65 6d6f 7279 2061 6e64 2064 6973 6b2e  memory and disk.
+00009b00: 0a0a 2020 2020 6261 6e64 7769 6474 680a  ..    bandwidth.
+00009b10: 2020 2020 2020 2020 506c 6f74 7320 7468          Plots th
+00009b20: 6520 6176 6572 6167 6520 6f66 2068 6f73  e average of hos
+00009b30: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
+00009b40: 7320 616e 6420 686f 7374 5f6e 6574 5f69  s and host_net_i
+00009b50: 6f2e 7772 6974 655f 6270 7320 666f 7220  o.write_bps for 
+00009b60: 7468 650a 2020 2020 2020 2020 776f 726b  the.        work
+00009b70: 6572 7320 6173 2061 2066 756e 6374 696f  ers as a functio
+00009b80: 6e20 6f66 2074 696d 650a 2020 2020 6370  n of time.    cp
+00009b90: 750a 2020 2020 2020 2020 506c 6f74 7320  u.        Plots 
+00009ba0: 7468 6520 6176 6572 6167 6520 6f66 2063  the average of c
+00009bb0: 7075 2066 6f72 2074 6865 2077 6f72 6b65  pu for the worke
+00009bc0: 7273 2061 7320 6120 6675 6e63 7469 6f6e  rs as a function
+00009bd0: 206f 6620 7469 6d65 0a20 2020 206d 656d   of time.    mem
+00009be0: 6f72 790a 2020 2020 2020 2020 506c 6f74  ory.        Plot
+00009bf0: 7320 7468 6520 6176 6572 6167 6520 6f66  s the average of
+00009c00: 206d 656d 6f72 7920 666f 7220 7468 6520   memory for the 
+00009c10: 776f 726b 6572 7320 6173 2061 2066 756e  workers as a fun
+00009c20: 6374 696f 6e20 6f66 2074 696d 650a 2020  ction of time.  
+00009c30: 2020 6469 736b 0a20 2020 2020 2020 2050    disk.        P
+00009c40: 6c6f 7473 2074 6865 2061 7665 7261 6765  lots the average
+00009c50: 206f 6620 686f 7374 5f64 6973 6b5f 696f   of host_disk_io
+00009c60: 2e72 6561 645f 6270 7320 616e 6420 686f  .read_bps and ho
+00009c70: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
+00009c80: 5f62 7073 2066 6f72 2074 6865 0a20 2020  _bps for the.   
+00009c90: 2020 2020 2077 6f72 6b65 7273 2061 7320       workers as 
+00009ca0: 6120 6675 6e63 7469 6f6e 206f 6620 7469  a function of ti
+00009cb0: 6d65 0a0a 2020 2020 5468 6520 6d65 7472  me..    The metr
+00009cc0: 6963 7320 706c 6f74 7465 6420 636f 6d65  ics plotted come
+00009cd0: 2066 726f 6d20 7468 6520 6167 6772 6567   from the aggreg
+00009ce0: 6174 696f 6e20 6f66 2066 726f 6d20 7773  ation of from ws
+00009cf0: 2e6d 6574 7269 6373 5b6b 6579 5d20 666f  .metrics[key] fo
+00009d00: 7220 7773 2069 6e0a 2020 2020 7363 6865  r ws in.    sche
+00009d10: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
+00009d20: 6c75 6573 2829 2064 6976 6964 6564 2062  lues() divided b
+00009d30: 7920 6e75 6d62 6572 206f 6620 776f 726b  y number of work
+00009d40: 6572 732e 0a20 2020 2022 2222 0a0a 2020  ers..    """..  
+00009d50: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+00009d60: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00009d70: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
+00009d80: 666f 6c6c 6f77 5f69 6e74 6572 7661 6c3d  follow_interval=
+00009d90: 3230 3030 302c 202a 2a6b 7761 7267 7329  20000, **kwargs)
+00009da0: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+00009db0: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+00009dc0: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
+00009dd0: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
+00009de0: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
+00009df0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00009e00: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
+00009e10: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00009e20: 2020 2020 2020 2022 686f 7374 5f6e 6574         "host_net
+00009e30: 5f69 6f2e 7265 6164 5f62 7073 223a 205b  _io.read_bps": [
+00009e40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00009e50: 2020 2022 686f 7374 5f6e 6574 5f69 6f2e     "host_net_io.
+00009e60: 7772 6974 655f 6270 7322 3a20 5b5d 2c0a  write_bps": [],.
+00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e80: 2263 7075 223a 205b 5d2c 0a20 2020 2020  "cpu": [],.     
+00009e90: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00009ea0: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
+00009eb0: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
+00009ec0: 6973 6b5f 696f 2e72 6561 645f 6270 7322  isk_io.read_bps"
+00009ed0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00009ee0: 2020 2020 2020 2268 6f73 745f 6469 736b        "host_disk
+00009ef0: 5f69 6f2e 7772 6974 655f 6270 7322 3a20  _io.write_bps": 
+00009f00: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00009f10: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
+00009f20: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
+00009f30: 2e73 6f75 7263 652c 2073 656c 662e 6765  .source, self.ge
+00009f40: 745f 6461 7461 2829 290a 0a20 2020 2020  t_data())..     
+00009f50: 2020 2078 5f72 616e 6765 203d 2044 6174     x_range = Dat
+00009f60: 6152 616e 6765 3164 280a 2020 2020 2020  aRange1d(.      
+00009f70: 2020 2020 2020 666f 6c6c 6f77 3d22 656e        follow="en
+00009f80: 6422 2c20 666f 6c6c 6f77 5f69 6e74 6572  d", follow_inter
+00009f90: 7661 6c3d 666f 6c6c 6f77 5f69 6e74 6572  val=follow_inter
+00009fa0: 7661 6c2c 2072 616e 6765 5f70 6164 6469  val, range_paddi
+00009fb0: 6e67 3d30 0a20 2020 2020 2020 2029 0a20  ng=0.        ). 
+00009fc0: 2020 2020 2020 2074 6f6f 6c73 203d 2022         tools = "
+00009fd0: 7265 7365 742c 2078 7061 6e2c 2078 7768  reset, xpan, xwh
+00009fe0: 6565 6c5f 7a6f 6f6d 220a 0a20 2020 2020  eel_zoom"..     
+00009ff0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+0000a000: 6820 3d20 6669 6775 7265 280a 2020 2020  h = figure(.    
+0000a010: 2020 2020 2020 2020 7469 746c 653d 2257          title="W
+0000a020: 6f72 6b65 7220 4e65 7477 6f72 6b20 4261  orker Network Ba
+0000a030: 6e64 7769 6474 6820 2861 7665 7261 6765  ndwidth (average
+0000a040: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
+0000a050: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
+0000a060: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
+0000a070: 2020 2020 746f 6f6c 733d 746f 6f6c 732c      tools=tools,
+0000a080: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
+0000a090: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
+0000a0a0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
+0000a0b0: 776f 726b 6572 5f6e 6574 776f 726b 5f62  worker_network_b
+0000a0c0: 616e 6477 6964 7468 2d74 696d 6573 6572  andwidth-timeser
+0000a0d0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+0000a0e0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0000a0f0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+0000a100: 656c 662e 6261 6e64 7769 6474 682e 6c69  elf.bandwidth.li
+0000a110: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
+0000a120: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0000a130: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000a140: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
+0000a150: 2020 2020 2020 793d 2268 6f73 745f 6e65        y="host_ne
+0000a160: 745f 696f 2e72 6561 645f 6270 7322 2c0a  t_io.read_bps",.
+0000a170: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+0000a180: 723d 2272 6564 222c 0a20 2020 2020 2020  r="red",.       
+0000a190: 2020 2020 206c 6567 656e 645f 6c61 6265       legend_labe
+0000a1a0: 6c3d 2272 6561 6420 286d 6561 6e29 222c  l="read (mean)",
+0000a1b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000a1c0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+0000a1d0: 682e 6c69 6e65 280a 2020 2020 2020 2020  h.line(.        
+0000a1e0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0000a1f0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0000a200: 2020 2020 783d 2274 696d 6522 2c0a 2020      x="time",.  
+0000a210: 2020 2020 2020 2020 2020 793d 2268 6f73            y="hos
+0000a220: 745f 6e65 745f 696f 2e77 7269 7465 5f62  t_net_io.write_b
+0000a230: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
+0000a240: 2063 6f6c 6f72 3d22 626c 7565 222c 0a20   color="blue",. 
+0000a250: 2020 2020 2020 2020 2020 206c 6567 656e             legen
+0000a260: 645f 6c61 6265 6c3d 2277 7269 7465 2028  d_label="write (
+0000a270: 6d65 616e 2922 2c0a 2020 2020 2020 2020  mean)",.        
+0000a280: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000a290: 6261 6e64 7769 6474 682e 6c65 6765 6e64  bandwidth.legend
+0000a2a0: 2e6c 6f63 6174 696f 6e20 3d20 2274 6f70  .location = "top
+0000a2b0: 5f6c 6566 7422 0a20 2020 2020 2020 2073  _left".        s
+0000a2c0: 656c 662e 6261 6e64 7769 6474 682e 7961  elf.bandwidth.ya
+0000a2d0: 7869 732e 6178 6973 5f6c 6162 656c 203d  xis.axis_label =
+0000a2e0: 2022 6279 7465 7320 2f20 7365 636f 6e64   "bytes / second
+0000a2f0: 220a 2020 2020 2020 2020 7365 6c66 2e62  ".        self.b
+0000a300: 616e 6477 6964 7468 2e79 6178 6973 5b30  andwidth.yaxis[0
+0000a310: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
+0000a320: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
+0000a330: 6572 2866 6f72 6d61 743d 2230 2e30 6222  er(format="0.0b"
+0000a340: 290a 2020 2020 2020 2020 7365 6c66 2e62  ).        self.b
+0000a350: 616e 6477 6964 7468 2e79 5f72 616e 6765  andwidth.y_range
+0000a360: 2e73 7461 7274 203d 2030 0a20 2020 2020  .start = 0.     
+0000a370: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+0000a380: 682e 7961 7869 732e 6d69 6e6f 725f 7469  h.yaxis.minor_ti
+0000a390: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+0000a3a0: 300a 2020 2020 2020 2020 7365 6c66 2e62  0.        self.b
+0000a3b0: 616e 6477 6964 7468 2e78 6772 6964 2e76  andwidth.xgrid.v
+0000a3c0: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+0000a3d0: 2020 2020 2020 2020 7365 6c66 2e63 7075          self.cpu
+0000a3e0: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+0000a3f0: 2020 2020 2020 2074 6974 6c65 3d22 576f         title="Wo
+0000a400: 726b 6572 2043 5055 2055 7469 6c69 7a61  rker CPU Utiliza
+0000a410: 7469 6f6e 2028 6176 6572 6167 6529 222c  tion (average)",
+0000a420: 0a20 2020 2020 2020 2020 2020 2078 5f61  .            x_a
+0000a430: 7869 735f 7479 7065 3d22 6461 7465 7469  xis_type="dateti
+0000a440: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+0000a450: 2074 6f6f 6c73 3d74 6f6f 6c73 2c0a 2020   tools=tools,.  
+0000a460: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
+0000a470: 653d 785f 7261 6e67 652c 0a20 2020 2020  e=x_range,.     
+0000a480: 2020 2020 2020 206e 616d 653d 2277 6f72         name="wor
+0000a490: 6b65 725f 6370 752d 7469 6d65 7365 7269  ker_cpu-timeseri
+0000a4a0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+0000a4b0: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0000a4c0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+0000a4d0: 6c66 2e63 7075 2e6c 696e 6528 0a20 2020  lf.cpu.line(.   
+0000a4e0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0000a4f0: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+0000a500: 2020 2020 2020 2020 2078 3d22 7469 6d65           x="time
+0000a510: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+0000a520: 3d22 6370 7522 2c0a 2020 2020 2020 2020  ="cpu",.        
+0000a530: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0000a540: 7075 2e79 6178 6973 2e61 7869 735f 6c61  pu.yaxis.axis_la
+0000a550: 6265 6c20 3d20 2255 7469 6c69 7a61 7469  bel = "Utilizati
+0000a560: 6f6e 220a 2020 2020 2020 2020 7365 6c66  on".        self
+0000a570: 2e63 7075 2e79 5f72 616e 6765 2e73 7461  .cpu.y_range.sta
+0000a580: 7274 203d 2030 0a20 2020 2020 2020 2073  rt = 0.        s
+0000a590: 656c 662e 6370 752e 7961 7869 732e 6d69  elf.cpu.yaxis.mi
+0000a5a0: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
+0000a5b0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+0000a5c0: 7365 6c66 2e63 7075 2e78 6772 6964 2e76  self.cpu.xgrid.v
+0000a5d0: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+0000a5e0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+0000a5f0: 6f72 7920 3d20 6669 6775 7265 280a 2020  ory = figure(.  
+0000a600: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000a610: 2257 6f72 6b65 7220 4d65 6d6f 7279 2055  "Worker Memory U
+0000a620: 7365 2028 6176 6572 6167 6529 222c 0a20  se (average)",. 
+0000a630: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
+0000a640: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
+0000a650: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+0000a660: 6f6f 6c73 3d74 6f6f 6c73 2c0a 2020 2020  ools=tools,.    
+0000a670: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+0000a680: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
+0000a690: 2020 2020 206e 616d 653d 2277 6f72 6b65       name="worke
+0000a6a0: 725f 6d65 6d6f 7279 2d74 696d 6573 6572  r_memory-timeser
+0000a6b0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+0000a6c0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0000a6d0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+0000a6e0: 656c 662e 6d65 6d6f 7279 2e6c 696e 6528  elf.memory.line(
+0000a6f0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0000a700: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+0000a710: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
+0000a720: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
+0000a730: 2020 2079 3d22 6d65 6d6f 7279 222c 0a20     y="memory",. 
+0000a740: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a750: 2073 656c 662e 6d65 6d6f 7279 2e79 6178   self.memory.yax
+0000a760: 6973 2e61 7869 735f 6c61 6265 6c20 3d20  is.axis_label = 
+0000a770: 2242 7974 6573 220a 2020 2020 2020 2020  "Bytes".        
+0000a780: 7365 6c66 2e6d 656d 6f72 792e 7961 7869  self.memory.yaxi
+0000a790: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
+0000a7a0: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
+0000a7b0: 6174 7465 7228 666f 726d 6174 3d22 302e  atter(format="0.
+0000a7c0: 3062 2229 0a20 2020 2020 2020 2073 656c  0b").        sel
+0000a7d0: 662e 6d65 6d6f 7279 2e79 5f72 616e 6765  f.memory.y_range
+0000a7e0: 2e73 7461 7274 203d 2030 0a20 2020 2020  .start = 0.     
+0000a7f0: 2020 2073 656c 662e 6d65 6d6f 7279 2e79     self.memory.y
+0000a800: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
+0000a810: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
+0000a820: 2020 2020 2020 2073 656c 662e 6d65 6d6f         self.memo
+0000a830: 7279 2e78 6772 6964 2e76 6973 6962 6c65  ry.xgrid.visible
+0000a840: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000a850: 2020 7365 6c66 2e64 6973 6b20 3d20 6669    self.disk = fi
+0000a860: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+0000a870: 2020 7469 746c 653d 2257 6f72 6b65 7220    title="Worker 
+0000a880: 4469 736b 2042 616e 6477 6964 7468 2028  Disk Bandwidth (
+0000a890: 6176 6572 6167 6529 222c 0a20 2020 2020  average)",.     
+0000a8a0: 2020 2020 2020 2078 5f61 7869 735f 7479         x_axis_ty
+0000a8b0: 7065 3d22 6461 7465 7469 6d65 222c 0a20  pe="datetime",. 
+0000a8c0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000a8d0: 3d74 6f6f 6c73 2c0a 2020 2020 2020 2020  =tools,.        
+0000a8e0: 2020 2020 785f 7261 6e67 653d 785f 7261      x_range=x_ra
+0000a8f0: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
+0000a900: 206e 616d 653d 2277 6f72 6b65 725f 6469   name="worker_di
+0000a910: 736b 2d74 696d 6573 6572 6965 7322 2c0a  sk-timeseries",.
+0000a920: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+0000a930: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+0000a940: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+0000a950: 736b 2e6c 696e 6528 0a20 2020 2020 2020  sk.line(.       
+0000a960: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0000a970: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+0000a980: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
+0000a990: 2020 2020 2020 2020 2020 2079 3d22 686f             y="ho
+0000a9a0: 7374 5f64 6973 6b5f 696f 2e72 6561 645f  st_disk_io.read_
+0000a9b0: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
+0000a9c0: 2020 636f 6c6f 723d 2272 6564 222c 0a20    color="red",. 
+0000a9d0: 2020 2020 2020 2020 2020 206c 6567 656e             legen
+0000a9e0: 645f 6c61 6265 6c3d 2272 6561 6420 286d  d_label="read (m
+0000a9f0: 6561 6e29 222c 0a20 2020 2020 2020 2029  ean)",.        )
+0000aa00: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+0000aa10: 736b 2e6c 696e 6528 0a20 2020 2020 2020  sk.line(.       
+0000aa20: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0000aa30: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+0000aa40: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
+0000aa50: 2020 2020 2020 2020 2020 2079 3d22 686f             y="ho
+0000aa60: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
+0000aa70: 5f62 7073 222c 0a20 2020 2020 2020 2020  _bps",.         
+0000aa80: 2020 2063 6f6c 6f72 3d22 626c 7565 222c     color="blue",
+0000aa90: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
+0000aaa0: 656e 645f 6c61 6265 6c3d 2277 7269 7465  end_label="write
+0000aab0: 2028 6d65 616e 2922 2c0a 2020 2020 2020   (mean)",.      
+0000aac0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+0000aad0: 662e 6469 736b 2e6c 6567 656e 642e 6c6f  f.disk.legend.lo
+0000aae0: 6361 7469 6f6e 203d 2022 746f 705f 6c65  cation = "top_le
+0000aaf0: 6674 220a 2020 2020 2020 2020 7365 6c66  ft".        self
+0000ab00: 2e64 6973 6b2e 7961 7869 732e 6178 6973  .disk.yaxis.axis
+0000ab10: 5f6c 6162 656c 203d 2022 6279 7465 7320  _label = "bytes 
+0000ab20: 2f20 7365 636f 6e64 220a 2020 2020 2020  / second".      
+0000ab30: 2020 7365 6c66 2e64 6973 6b2e 7961 7869    self.disk.yaxi
+0000ab40: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
+0000ab50: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
+0000ab60: 6174 7465 7228 666f 726d 6174 3d22 302e  atter(format="0.
+0000ab70: 3062 2229 0a20 2020 2020 2020 2073 656c  0b").        sel
+0000ab80: 662e 6469 736b 2e79 5f72 616e 6765 2e73  f.disk.y_range.s
+0000ab90: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
+0000aba0: 2073 656c 662e 6469 736b 2e79 6178 6973   self.disk.yaxis
+0000abb0: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
+0000abc0: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
+0000abd0: 2020 2073 656c 662e 6469 736b 2e78 6772     self.disk.xgr
+0000abe0: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
+0000abf0: 7365 0a0a 2020 2020 6465 6620 6765 745f  se..    def get_
+0000ac00: 6461 7461 2873 656c 6629 3a0a 2020 2020  data(self):.    
+0000ac10: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
+0000ac20: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
+0000ac30: 6b65 7273 2e76 616c 7565 7328 290a 0a20  kers.values().. 
+0000ac40: 2020 2020 2020 206e 6574 5f72 6561 645f         net_read_
+0000ac50: 6270 7320 3d20 300a 2020 2020 2020 2020  bps = 0.        
+0000ac60: 6e65 745f 7772 6974 655f 6270 7320 3d20  net_write_bps = 
+0000ac70: 300a 2020 2020 2020 2020 6370 7520 3d20  0.        cpu = 
+0000ac80: 300a 2020 2020 2020 2020 6d65 6d6f 7279  0.        memory
+0000ac90: 203d 2030 0a20 2020 2020 2020 2064 6973   = 0.        dis
+0000aca0: 6b5f 7265 6164 5f62 7073 203d 2030 0a20  k_read_bps = 0. 
+0000acb0: 2020 2020 2020 2064 6973 6b5f 7772 6974         disk_writ
+0000acc0: 655f 6270 7320 3d20 300a 2020 2020 2020  e_bps = 0.      
+0000acd0: 2020 7469 6d65 203d 2030 0a20 2020 2020    time = 0.     
+0000ace0: 2020 2066 6f72 2077 7320 696e 2077 6f72     for ws in wor
+0000acf0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+0000ad00: 2020 6e65 745f 7265 6164 5f62 7073 202b    net_read_bps +
+0000ad10: 3d20 7773 2e6d 6574 7269 6373 5b22 686f  = ws.metrics["ho
+0000ad20: 7374 5f6e 6574 5f69 6f22 5d5b 2272 6561  st_net_io"]["rea
+0000ad30: 645f 6270 7322 5d0a 2020 2020 2020 2020  d_bps"].        
+0000ad40: 2020 2020 6e65 745f 7772 6974 655f 6270      net_write_bp
+0000ad50: 7320 2b3d 2077 732e 6d65 7472 6963 735b  s += ws.metrics[
+0000ad60: 2268 6f73 745f 6e65 745f 696f 225d 5b22  "host_net_io"]["
+0000ad70: 7772 6974 655f 6270 7322 5d0a 2020 2020  write_bps"].    
+0000ad80: 2020 2020 2020 2020 6370 7520 2b3d 2077          cpu += w
+0000ad90: 732e 6d65 7472 6963 735b 2263 7075 225d  s.metrics["cpu"]
+0000ada0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+0000adb0: 6f72 7920 2b3d 2077 732e 6d65 7472 6963  ory += ws.metric
+0000adc0: 735b 226d 656d 6f72 7922 5d0a 2020 2020  s["memory"].    
+0000add0: 2020 2020 2020 2020 6469 736b 5f72 6561          disk_rea
+0000ade0: 645f 6270 7320 2b3d 2077 732e 6d65 7472  d_bps += ws.metr
+0000adf0: 6963 732e 6765 7428 2268 6f73 745f 6469  ics.get("host_di
+0000ae00: 736b 5f69 6f22 2c20 7b7d 292e 6765 7428  sk_io", {}).get(
+0000ae10: 2272 6561 645f 6270 7322 2c20 3029 0a20  "read_bps", 0). 
+0000ae20: 2020 2020 2020 2020 2020 2064 6973 6b5f             disk_
+0000ae30: 7772 6974 655f 6270 7320 2b3d 2077 732e  write_bps += ws.
+0000ae40: 6d65 7472 6963 732e 6765 7428 2268 6f73  metrics.get("hos
+0000ae50: 745f 6469 736b 5f69 6f22 2c20 7b7d 292e  t_disk_io", {}).
+0000ae60: 6765 7428 2277 7269 7465 5f62 7073 222c  get("write_bps",
+0000ae70: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
+0000ae80: 7469 6d65 202b 3d20 7773 2e6d 6574 7269  time += ws.metri
+0000ae90: 6373 5b22 7469 6d65 225d 0a0a 2020 2020  cs["time"]..    
+0000aea0: 2020 2020 7265 7375 6c74 203d 207b 0a20      result = {. 
+0000aeb0: 2020 2020 2020 2020 2020 2023 2075 7365             # use
+0000aec0: 2060 6f72 6020 746f 2061 766f 6964 205a   `or` to avoid Z
+0000aed0: 6572 6f44 6976 6973 696f 6e20 7768 656e  eroDivision when
+0000aee0: 206e 6f20 776f 726b 6572 730a 2020 2020   no workers.    
+0000aef0: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
+0000af00: 5b74 696d 6520 2f20 286c 656e 2877 6f72  [time / (len(wor
+0000af10: 6b65 7273 2920 6f72 2031 2920 2a20 3130  kers) or 1) * 10
+0000af20: 3030 5d2c 0a20 2020 2020 2020 2020 2020  00],.           
+0000af30: 2022 686f 7374 5f6e 6574 5f69 6f2e 7265   "host_net_io.re
+0000af40: 6164 5f62 7073 223a 205b 6e65 745f 7265  ad_bps": [net_re
+0000af50: 6164 5f62 7073 202f 2028 6c65 6e28 776f  ad_bps / (len(wo
+0000af60: 726b 6572 7329 206f 7220 3129 5d2c 0a20  rkers) or 1)],. 
+0000af70: 2020 2020 2020 2020 2020 2022 686f 7374             "host
+0000af80: 5f6e 6574 5f69 6f2e 7772 6974 655f 6270  _net_io.write_bp
+0000af90: 7322 3a20 5b6e 6574 5f77 7269 7465 5f62  s": [net_write_b
+0000afa0: 7073 202f 2028 6c65 6e28 776f 726b 6572  ps / (len(worker
+0000afb0: 7329 206f 7220 3129 5d2c 0a20 2020 2020  s) or 1)],.     
+0000afc0: 2020 2020 2020 2022 6370 7522 3a20 5b63         "cpu": [c
+0000afd0: 7075 202f 2028 6c65 6e28 776f 726b 6572  pu / (len(worker
+0000afe0: 7329 206f 7220 3129 5d2c 0a20 2020 2020  s) or 1)],.     
+0000aff0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
+0000b000: 205b 6d65 6d6f 7279 202f 2028 6c65 6e28   [memory / (len(
+0000b010: 776f 726b 6572 7329 206f 7220 3129 5d2c  workers) or 1)],
+0000b020: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+0000b030: 7374 5f64 6973 6b5f 696f 2e72 6561 645f  st_disk_io.read_
+0000b040: 6270 7322 3a20 5b64 6973 6b5f 7265 6164  bps": [disk_read
+0000b050: 5f62 7073 202f 2028 6c65 6e28 776f 726b  _bps / (len(work
+0000b060: 6572 7329 206f 7220 3129 5d2c 0a20 2020  ers) or 1)],.   
+0000b070: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
+0000b080: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
+0000b090: 223a 205b 6469 736b 5f77 7269 7465 5f62  ": [disk_write_b
+0000b0a0: 7073 202f 2028 6c65 6e28 776f 726b 6572  ps / (len(worker
+0000b0b0: 7329 206f 7220 3129 5d2c 0a20 2020 2020  s) or 1)],.     
+0000b0c0: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
+0000b0d0: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
+0000b0e0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+0000b0f0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+0000b100: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+0000b110: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+0000b120: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000b130: 736f 7572 6365 2e73 7472 6561 6d28 7365  source.stream(se
+0000b140: 6c66 2e67 6574 5f64 6174 6128 292c 2031  lf.get_data(), 1
+0000b150: 3030 3029 0a0a 2020 2020 2020 2020 6966  000)..        if
+0000b160: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+0000b170: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0000b180: 2020 2020 2079 5f65 6e64 5f63 7075 203d       y_end_cpu =
+0000b190: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
+0000b1a0: 2020 2020 2020 7773 2e6e 7468 7265 6164        ws.nthread
+0000b1b0: 7320 6f72 2031 2066 6f72 2077 7320 696e  s or 1 for ws in
+0000b1c0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+0000b1d0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+0000b1e0: 0a20 2020 2020 2020 2020 2020 2029 202f  .            ) /
+0000b1f0: 206c 656e 2873 656c 662e 7363 6865 6475   len(self.schedu
+0000b200: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+0000b210: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+0000b220: 2020 795f 656e 645f 6d65 6d20 3d20 7375    y_end_mem = su
+0000b230: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
+0000b240: 2020 2077 732e 6d65 6d6f 7279 5f6c 696d     ws.memory_lim
+0000b250: 6974 2066 6f72 2077 7320 696e 2073 656c  it for ws in sel
+0000b260: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+0000b270: 6572 732e 7661 6c75 6573 2829 0a20 2020  ers.values().   
+0000b280: 2020 2020 2020 2020 2029 202f 206c 656e           ) / len
+0000b290: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
+0000b2a0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+0000b2b0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000b2c0: 2020 2020 2020 2020 2020 2020 795f 656e              y_en
+0000b2d0: 645f 6370 7520 3d20 310a 2020 2020 2020  d_cpu = 1.      
+0000b2e0: 2020 2020 2020 795f 656e 645f 6d65 6d20        y_end_mem 
+0000b2f0: 3d20 3130 305f 3030 305f 3030 300a 0a20  = 100_000_000.. 
+0000b300: 2020 2020 2020 2073 656c 662e 6370 752e         self.cpu.
+0000b310: 795f 7261 6e67 652e 656e 6420 3d20 795f  y_range.end = y_
+0000b320: 656e 645f 6370 7520 2a20 3130 300a 2020  end_cpu * 100.  
+0000b330: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
+0000b340: 792e 795f 7261 6e67 652e 656e 6420 3d20  y.y_range.end = 
+0000b350: 795f 656e 645f 6d65 6d0a 0a0a 636c 6173  y_end_mem...clas
+0000b360: 7320 436f 6d70 7574 6550 6572 4b65 7928  s ComputePerKey(
+0000b370: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+0000b380: 6e74 293a 0a20 2020 2022 2222 4261 7220  nt):.    """Bar 
+0000b390: 6368 6172 7420 7368 6f77 696e 6720 7469  chart showing ti
+0000b3a0: 6d65 2073 7065 6e64 2069 6e20 6163 7469  me spend in acti
+0000b3b0: 6f6e 2062 7920 6b65 7920 7072 6566 6978  on by key prefix
+0000b3c0: 2222 220a 0a20 2020 2040 6c6f 675f 6572  """..    @log_er
+0000b3d0: 726f 7273 0a20 2020 2064 6566 205f 5f69  rors.    def __i
+0000b3e0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+0000b3f0: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
+0000b400: 3a0a 2020 2020 2020 2020 7365 6c66 2e6c  :.        self.l
+0000b410: 6173 7420 3d20 300a 2020 2020 2020 2020  ast = 0.        
+0000b420: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+0000b430: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+0000b440: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
+0000b450: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
+0000b460: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+0000b470: 6572 2e70 6c75 6769 6e73 3a0a 2020 2020  er.plugins:.    
+0000b480: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+0000b490: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
+0000b4a0: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
+0000b4b0: 696e 2873 656c 662e 7363 6865 6475 6c65  in(self.schedule
+0000b4c0: 7229 290a 0a20 2020 2020 2020 2063 6f6d  r))..        com
+0000b4d0: 7075 7465 5f64 6174 6120 3d20 7b0a 2020  pute_data = {.  
+0000b4e0: 2020 2020 2020 2020 2020 2274 696d 6573            "times
+0000b4f0: 223a 205b 302e 322c 2030 2e31 5d2c 0a20  ": [0.2, 0.1],. 
+0000b500: 2020 2020 2020 2020 2020 2022 666f 726d             "form
+0000b510: 6174 7465 645f 7469 6d65 223a 205b 2230  atted_time": ["0
+0000b520: 2e32 206d 7322 2c20 2232 2e38 2075 7322  .2 ms", "2.8 us"
+0000b530: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+0000b540: 616e 676c 6573 223a 205b 332e 3134 2c20  angles": [3.14, 
+0000b550: 302e 3738 355d 2c0a 2020 2020 2020 2020  0.785],.        
+0000b560: 2020 2020 2263 6f6c 6f72 223a 205b 7473      "color": [ts
+0000b570: 5f63 6f6c 6f72 5f6c 6f6f 6b75 705b 2274  _color_lookup["t
+0000b580: 7261 6e73 6665 7222 5d2c 2074 735f 636f  ransfer"], ts_co
+0000b590: 6c6f 725f 6c6f 6f6b 7570 5b22 636f 6d70  lor_lookup["comp
+0000b5a0: 7574 6522 5d5d 2c0a 2020 2020 2020 2020  ute"]],.        
+0000b5b0: 2020 2020 226e 616d 6573 223a 205b 2273      "names": ["s
+0000b5c0: 756d 222c 2022 7375 6d5f 7061 7274 6961  um", "sum_partia
+0000b5d0: 6c22 5d2c 0a20 2020 2020 2020 207d 0a0a  l"],.        }..
+0000b5e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+0000b5f0: 7075 7465 5f73 6f75 7263 6520 3d20 436f  pute_source = Co
+0000b600: 6c75 6d6e 4461 7461 536f 7572 6365 2864  lumnDataSource(d
+0000b610: 6174 613d 636f 6d70 7574 655f 6461 7461  ata=compute_data
+0000b620: 290a 0a20 2020 2020 2020 2066 6967 203d  )..        fig =
+0000b630: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+0000b640: 2020 2020 2074 6974 6c65 3d22 436f 6d70       title="Comp
+0000b650: 7574 6520 5469 6d65 2050 6572 2054 6173  ute Time Per Tas
+0000b660: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
+0000b670: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+0000b680: 2020 2020 2020 6e61 6d65 3d22 636f 6d70        name="comp
+0000b690: 7574 655f 7469 6d65 5f70 6572 5f6b 6579  ute_time_per_key
+0000b6a0: 222c 0a20 2020 2020 2020 2020 2020 2078  ",.            x
+0000b6b0: 5f72 616e 6765 3d5b 2261 222c 2022 6222  _range=["a", "b"
+0000b6c0: 5d2c 0a20 2020 2020 2020 2020 2020 202a  ],.            *
+0000b6d0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0000b6e0: 2029 0a0a 2020 2020 2020 2020 7265 6374   )..        rect
+0000b6f0: 203d 2066 6967 2e76 6261 7228 0a20 2020   = fig.vbar(.   
+0000b700: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0000b710: 7365 6c66 2e63 6f6d 7075 7465 5f73 6f75  self.compute_sou
+0000b720: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0000b730: 2078 3d22 6e61 6d65 7322 2c0a 2020 2020   x="names",.    
+0000b740: 2020 2020 2020 2020 746f 703d 2274 696d          top="tim
+0000b750: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+0000b760: 2077 6964 7468 3d30 2e37 2c0a 2020 2020   width=0.7,.    
+0000b770: 2020 2020 2020 2020 636f 6c6f 723d 2263          color="c
+0000b780: 6f6c 6f72 222c 0a20 2020 2020 2020 2029  olor",.        )
+0000b790: 0a0a 2020 2020 2020 2020 6669 672e 795f  ..        fig.y_
+0000b7a0: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
+0000b7b0: 2020 2020 2020 2020 6669 672e 7961 7869          fig.yaxi
+0000b7c0: 732e 6178 6973 5f6c 6162 656c 203d 2022  s.axis_label = "
+0000b7d0: 5469 6d65 2028 7329 220a 2020 2020 2020  Time (s)".      
+0000b7e0: 2020 6669 672e 7961 7869 735b 305d 2e66    fig.yaxis[0].f
+0000b7f0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
+0000b800: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
+0000b810: 666f 726d 6174 3d22 3022 290a 2020 2020  format="0").    
+0000b820: 2020 2020 6669 672e 7961 7869 732e 7469      fig.yaxis.ti
+0000b830: 636b 6572 203d 2041 6461 7074 6976 6554  cker = AdaptiveT
+0000b840: 6963 6b65 7228 2a2a 5449 434b 535f 3130  icker(**TICKS_10
+0000b850: 3234 290a 2020 2020 2020 2020 6669 672e  24).        fig.
+0000b860: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
+0000b870: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
+0000b880: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
+0000b890: 4f4e 0a20 2020 2020 2020 2072 6563 742e  ON.        rect.
+0000b8a0: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
+0000b8b0: 7068 203d 204e 6f6e 650a 0a20 2020 2020  ph = None..     
+0000b8c0: 2020 2066 6967 2e78 6178 6973 2e6d 696e     fig.xaxis.min
+0000b8d0: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+0000b8e0: 6861 203d 2030 0a20 2020 2020 2020 2066  ha = 0.        f
+0000b8f0: 6967 2e78 6772 6964 2e76 6973 6962 6c65  ig.xgrid.visible
+0000b900: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000b910: 2020 6669 672e 746f 6f6c 6261 725f 6c6f    fig.toolbar_lo
+0000b920: 6361 7469 6f6e 203d 204e 6f6e 650a 0a20  cation = None.. 
+0000b930: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0000b940: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
+0000b950: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
+0000b960: 7320 3d20 2222 220a 2020 2020 2020 2020  s = """.        
+0000b970: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
+0000b980: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
+0000b990: 4e61 6d65 3a3c 2f62 3e20 406e 616d 6573  Name:</b> @names
+0000b9a0: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
+0000b9b0: 2020 2020 203c 703e 3c62 3e54 696d 653a       <p><b>Time:
+0000b9c0: 3c2f 623e 2040 666f 726d 6174 7465 645f  </b> @formatted_
+0000b9d0: 7469 6d65 3c2f 703e 0a20 2020 2020 2020  time</p>.       
+0000b9e0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+0000b9f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000ba00: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
+0000ba10: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
+0000ba20: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
+0000ba30: 6669 672e 6164 645f 746f 6f6c 7328 686f  fig.add_tools(ho
+0000ba40: 7665 7229 0a0a 2020 2020 2020 2020 6669  ver)..        fi
+0000ba50: 672e 6164 645f 6c61 796f 7574 280a 2020  g.add_layout(.  
+0000ba60: 2020 2020 2020 2020 2020 5469 746c 6528            Title(
+0000ba70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ba80: 2074 6578 743d 224e 6f74 653a 2074 6173   text="Note: tas
+0000ba90: 6b73 206c 6573 7320 7468 616e 2032 2520  ks less than 2% 
+0000baa0: 6f66 206d 6178 2061 7265 206e 6f74 2064  of max are not d
+0000bab0: 6973 706c 6179 6564 222c 0a20 2020 2020  isplayed",.     
+0000bac0: 2020 2020 2020 2020 2020 2074 6578 745f             text_
+0000bad0: 666f 6e74 5f73 7479 6c65 3d22 6974 616c  font_style="ital
+0000bae0: 6963 222c 0a20 2020 2020 2020 2020 2020  ic",.           
+0000baf0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0000bb00: 2262 656c 6f77 222c 0a20 2020 2020 2020  "below",.       
+0000bb10: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+0000bb20: 2e66 6967 203d 2066 6967 0a20 2020 2020  .fig = fig.     
+0000bb30: 2020 2074 6162 3120 3d20 5461 6250 616e     tab1 = TabPan
+0000bb40: 656c 2863 6869 6c64 3d66 6967 2c20 7469  el(child=fig, ti
+0000bb50: 746c 653d 2242 6172 2043 6861 7274 2229  tle="Bar Chart")
+0000bb60: 0a0a 2020 2020 2020 2020 6669 6732 203d  ..        fig2 =
+0000bb70: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+0000bb80: 2020 2020 2074 6974 6c65 3d22 436f 6d70       title="Comp
+0000bb90: 7574 6520 5469 6d65 2050 6572 2054 6173  ute Time Per Tas
+0000bba0: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
+0000bbb0: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+0000bbc0: 2020 2020 2020 6e61 6d65 3d22 636f 6d70        name="comp
+0000bbd0: 7574 655f 7469 6d65 5f70 6572 5f6b 6579  ute_time_per_key
+0000bbe0: 2d70 6965 222c 0a20 2020 2020 2020 2020  -pie",.         
+0000bbf0: 2020 2078 5f72 616e 6765 3d28 2d30 2e35     x_range=(-0.5
+0000bc00: 2c20 312e 3029 2c0a 2020 2020 2020 2020  , 1.0),.        
+0000bc10: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0000bc20: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000bc30: 2066 6967 322e 7765 6467 6528 0a20 2020   fig2.wedge(.   
+0000bc40: 2020 2020 2020 2020 2078 3d30 2c0a 2020           x=0,.  
+0000bc50: 2020 2020 2020 2020 2020 793d 312c 0a20            y=1,. 
+0000bc60: 2020 2020 2020 2020 2020 2072 6164 6975             radiu
+0000bc70: 733d 302e 342c 0a20 2020 2020 2020 2020  s=0.4,.         
+0000bc80: 2020 2073 7461 7274 5f61 6e67 6c65 3d63     start_angle=c
+0000bc90: 756d 7375 6d28 2261 6e67 6c65 7322 2c20  umsum("angles", 
+0000bca0: 696e 636c 7564 655f 7a65 726f 3d54 7275  include_zero=Tru
+0000bcb0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0000bcc0: 656e 645f 616e 676c 653d 6375 6d73 756d  end_angle=cumsum
+0000bcd0: 2822 616e 676c 6573 2229 2c0a 2020 2020  ("angles"),.    
+0000bce0: 2020 2020 2020 2020 6c69 6e65 5f63 6f6c          line_col
+0000bcf0: 6f72 3d22 7768 6974 6522 2c0a 2020 2020  or="white",.    
+0000bd00: 2020 2020 2020 2020 6669 6c6c 5f63 6f6c          fill_col
+0000bd10: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
+0000bd20: 2020 2020 2020 2020 6c65 6765 6e64 5f66          legend_f
+0000bd30: 6965 6c64 3d22 6e61 6d65 7322 2c0a 2020  ield="names",.  
+0000bd40: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0000bd50: 3d73 656c 662e 636f 6d70 7574 655f 736f  =self.compute_so
+0000bd60: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
+0000bd70: 0a20 2020 2020 2020 2066 6967 322e 6178  .        fig2.ax
+0000bd80: 6973 2e61 7869 735f 6c61 6265 6c20 3d20  is.axis_label = 
+0000bd90: 4e6f 6e65 0a20 2020 2020 2020 2066 6967  None.        fig
+0000bda0: 322e 6178 6973 2e76 6973 6962 6c65 203d  2.axis.visible =
+0000bdb0: 2046 616c 7365 0a20 2020 2020 2020 2066   False.        f
+0000bdc0: 6967 322e 6772 6964 2e67 7269 645f 6c69  ig2.grid.grid_li
+0000bdd0: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
+0000bde0: 2020 2020 2020 2020 6669 6732 2e61 6464          fig2.add
+0000bdf0: 5f6c 6179 6f75 7428 0a20 2020 2020 2020  _layout(.       
+0000be00: 2020 2020 2054 6974 6c65 280a 2020 2020       Title(.    
+0000be10: 2020 2020 2020 2020 2020 2020 7465 7874              text
+0000be20: 3d22 4e6f 7465 3a20 7461 736b 7320 6c65  ="Note: tasks le
+0000be30: 7373 2074 6861 6e20 3225 206f 6620 6d61  ss than 2% of ma
+0000be40: 7820 6172 6520 6e6f 7420 6469 7370 6c61  x are not displa
+0000be50: 7965 6422 2c0a 2020 2020 2020 2020 2020  yed",.          
+0000be60: 2020 2020 2020 7465 7874 5f66 6f6e 745f        text_font_
+0000be70: 7374 796c 653d 2269 7461 6c69 6322 2c0a  style="italic",.
+0000be80: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+0000be90: 2020 2020 2020 2020 2020 2022 6265 6c6f             "belo
+0000bea0: 7722 2c0a 2020 2020 2020 2020 290a 0a20  w",.        ).. 
+0000beb0: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0000bec0: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
+0000bed0: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
+0000bee0: 7320 3d20 2222 220a 2020 2020 2020 2020  s = """.        
+0000bef0: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
+0000bf00: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
+0000bf10: 4e61 6d65 3a3c 2f62 3e20 406e 616d 6573  Name:</b> @names
+0000bf20: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
+0000bf30: 2020 2020 203c 703e 3c62 3e54 696d 653a       <p><b>Time:
+0000bf40: 3c2f 623e 2040 666f 726d 6174 7465 645f  </b> @formatted_
+0000bf50: 7469 6d65 3c2f 703e 0a20 2020 2020 2020  time</p>.       
+0000bf60: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+0000bf70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000bf80: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
+0000bf90: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
+0000bfa0: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
+0000bfb0: 6669 6732 2e61 6464 5f74 6f6f 6c73 2868  fig2.add_tools(h
+0000bfc0: 6f76 6572 290a 2020 2020 2020 2020 7365  over).        se
+0000bfd0: 6c66 2e77 6564 6765 5f66 6967 203d 2066  lf.wedge_fig = f
+0000bfe0: 6967 320a 2020 2020 2020 2020 7461 6232  ig2.        tab2
+0000bff0: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
+0000c000: 643d 6669 6732 2c20 7469 746c 653d 2250  d=fig2, title="P
+0000c010: 6965 2043 6861 7274 2229 0a0a 2020 2020  ie Chart")..    
+0000c020: 2020 2020 7365 6c66 2e72 6f6f 7420 3d20      self.root = 
+0000c030: 5461 6273 2874 6162 733d 5b74 6162 312c  Tabs(tabs=[tab1,
+0000c040: 2074 6162 325d 2c20 7369 7a69 6e67 5f6d   tab2], sizing_m
+0000c050: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+0000c060: 6822 290a 0a20 2020 2040 7769 7468 6f75  h")..    @withou
+0000c070: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
+0000c080: 6174 696f 6e0a 2020 2020 406c 6f67 5f65  ation.    @log_e
+0000c090: 7272 6f72 730a 2020 2020 6465 6620 7570  rrors.    def up
+0000c0a0: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
+0000c0b0: 2020 2020 636f 6d70 7574 655f 7469 6d65      compute_time
+0000c0c0: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
+0000c0d0: 666c 6f61 7429 0a0a 2020 2020 2020 2020  float)..        
+0000c0e0: 666f 7220 6b65 792c 2074 7320 696e 2073  for key, ts in s
+0000c0f0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+0000c100: 736b 5f70 7265 6669 7865 732e 6974 656d  sk_prefixes.item
+0000c110: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000c120: 206e 616d 6520 3d20 6b65 795f 7370 6c69   name = key_spli
+0000c130: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
+0000c140: 2020 2066 6f72 2061 6374 696f 6e2c 2074     for action, t
+0000c150: 2069 6e20 7473 2e61 6c6c 5f64 7572 6174   in ts.all_durat
+0000c160: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
+0000c170: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000c180: 2061 6374 696f 6e20 3d3d 2022 636f 6d70   action == "comp
+0000c190: 7574 6522 3a0a 2020 2020 2020 2020 2020  ute":.          
+0000c1a0: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
+0000c1b0: 655f 7469 6d65 735b 6e61 6d65 5d20 2b3d  e_times[name] +=
+0000c1c0: 2074 0a0a 2020 2020 2020 2020 2320 6f72   t..        # or
+0000c1d0: 6465 7220 6279 206c 6172 6765 7374 2074  der by largest t
+0000c1e0: 696d 6520 6669 7273 740a 2020 2020 2020  ime first.      
+0000c1f0: 2020 636f 6d70 7574 655f 7469 6d65 7320    compute_times 
+0000c200: 3d20 736f 7274 6564 2863 6f6d 7075 7465  = sorted(compute
+0000c210: 5f74 696d 6573 2e69 7465 6d73 2829 2c20  _times.items(), 
+0000c220: 6b65 793d 6c61 6d62 6461 2078 3a20 785b  key=lambda x: x[
+0000c230: 315d 2c20 7265 7665 7273 653d 5472 7565  1], reverse=True
+0000c240: 290a 0a20 2020 2020 2020 2023 206b 6565  )..        # kee
+0000c250: 7020 6f6e 6c79 2074 696d 6520 7768 6963  p only time whic
+0000c260: 6820 6172 6520 3225 206f 6620 6d61 7820  h are 2% of max 
+0000c270: 6f72 2067 7265 6174 6572 0a20 2020 2020  or greater.     
+0000c280: 2020 2069 6620 636f 6d70 7574 655f 7469     if compute_ti
+0000c290: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
+0000c2a0: 206d 6178 5f74 696d 6520 3d20 636f 6d70   max_time = comp
+0000c2b0: 7574 655f 7469 6d65 735b 305d 5b31 5d20  ute_times[0][1] 
+0000c2c0: 2a20 302e 3032 0a20 2020 2020 2020 2020  * 0.02.         
+0000c2d0: 2020 2063 6f6d 7075 7465 5f74 696d 6573     compute_times
+0000c2e0: 203d 205b 286e 2c20 7429 2066 6f72 206e   = [(n, t) for n
+0000c2f0: 2c20 7420 696e 2063 6f6d 7075 7465 5f74  , t in compute_t
+0000c300: 696d 6573 2069 6620 7420 3e20 6d61 785f  imes if t > max_
+0000c310: 7469 6d65 5d0a 2020 2020 2020 2020 2020  time].          
+0000c320: 2020 636f 6d70 7574 655f 636f 6c6f 7273    compute_colors
+0000c330: 203d 206c 6973 7428 290a 2020 2020 2020   = list().      
+0000c340: 2020 2020 2020 636f 6d70 7574 655f 6e61        compute_na
+0000c350: 6d65 7320 3d20 6c69 7374 2829 0a20 2020  mes = list().   
+0000c360: 2020 2020 2020 2020 2063 6f6d 7075 7465           compute
+0000c370: 5f74 696d 6520 3d20 6c69 7374 2829 0a20  _time = list(). 
+0000c380: 2020 2020 2020 2020 2020 2074 6f74 616c             total
+0000c390: 5f74 696d 6520 3d20 300a 2020 2020 2020  _time = 0.      
+0000c3a0: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
+0000c3b0: 7420 696e 2063 6f6d 7075 7465 5f74 696d  t in compute_tim
+0000c3c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0000c3d0: 2020 2020 636f 6d70 7574 655f 6e61 6d65      compute_name
+0000c3e0: 732e 6170 7065 6e64 286e 616d 6529 0a20  s.append(name). 
+0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000c400: 6f6d 7075 7465 5f63 6f6c 6f72 732e 6170  ompute_colors.ap
+0000c410: 7065 6e64 2874 735f 636f 6c6f 725f 6f66  pend(ts_color_of
+0000c420: 286e 616d 6529 290a 2020 2020 2020 2020  (name)).        
+0000c430: 2020 2020 2020 2020 636f 6d70 7574 655f          compute_
+0000c440: 7469 6d65 2e61 7070 656e 6428 7429 0a20  time.append(t). 
+0000c450: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000c460: 6f74 616c 5f74 696d 6520 2b3d 2074 0a0a  otal_time += t..
+0000c470: 2020 2020 2020 2020 2020 2020 616e 676c              angl
+0000c480: 6573 203d 205b 7420 2f20 746f 7461 6c5f  es = [t / total_
+0000c490: 7469 6d65 202a 2032 202a 206d 6174 682e  time * 2 * math.
+0000c4a0: 7069 2066 6f72 2074 2069 6e20 636f 6d70  pi for t in comp
+0000c4b0: 7574 655f 7469 6d65 5d0a 0a20 2020 2020  ute_time]..     
+0000c4c0: 2020 2020 2020 2073 656c 662e 6669 672e         self.fig.
+0000c4d0: 785f 7261 6e67 652e 6661 6374 6f72 7320  x_range.factors 
+0000c4e0: 3d20 636f 6d70 7574 655f 6e61 6d65 730a  = compute_names.
+0000c4f0: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+0000c500: 7075 7465 5f72 6573 756c 7420 3d20 6469  pute_result = di
+0000c510: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0000c520: 2020 2020 616e 676c 6573 3d61 6e67 6c65      angles=angle
+0000c530: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000c540: 2020 2074 696d 6573 3d63 6f6d 7075 7465     times=compute
+0000c550: 5f74 696d 652c 0a20 2020 2020 2020 2020  _time,.         
+0000c560: 2020 2020 2020 2063 6f6c 6f72 3d63 6f6d         color=com
+0000c570: 7075 7465 5f63 6f6c 6f72 732c 0a20 2020  pute_colors,.   
+0000c580: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+0000c590: 6573 3d63 6f6d 7075 7465 5f6e 616d 6573  es=compute_names
+0000c5a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c5b0: 2020 666f 726d 6174 7465 645f 7469 6d65    formatted_time
+0000c5c0: 3d5b 666f 726d 6174 5f74 696d 6528 7429  =[format_time(t)
+0000c5d0: 2066 6f72 2074 2069 6e20 636f 6d70 7574   for t in comput
+0000c5e0: 655f 7469 6d65 5d2c 0a20 2020 2020 2020  e_time],.       
+0000c5f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000c600: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+0000c610: 636f 6d70 7574 655f 736f 7572 6365 2c20  compute_source, 
+0000c620: 636f 6d70 7574 655f 7265 7375 6c74 290a  compute_result).
+0000c630: 0a0a 636c 6173 7320 4167 6772 6567 6174  ..class Aggregat
+0000c640: 6541 6374 696f 6e28 4461 7368 626f 6172  eAction(Dashboar
+0000c650: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+0000c660: 2022 2222 4261 7220 6368 6172 7420 7368   """Bar chart sh
+0000c670: 6f77 696e 6720 7469 6d65 2073 7065 6e64  owing time spend
+0000c680: 2069 6e20 6163 7469 6f6e 2062 7920 6b65   in action by ke
+0000c690: 7920 7072 6566 6978 2222 220a 0a20 2020  y prefix"""..   
+0000c6a0: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+0000c6b0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000c6c0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
+0000c6d0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0000c6e0: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
+0000c6f0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+0000c700: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+0000c710: 6572 0a0a 2020 2020 2020 2020 6966 2054  er..        if T
+0000c720: 6173 6b53 7472 6561 6d50 6c75 6769 6e2e  askStreamPlugin.
+0000c730: 6e61 6d65 206e 6f74 2069 6e20 7365 6c66  name not in self
+0000c740: 2e73 6368 6564 756c 6572 2e70 6c75 6769  .scheduler.plugi
+0000c750: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0000c760: 7365 6c66 2e73 6368 6564 756c 6572 2e61  self.scheduler.a
+0000c770: 6464 5f70 6c75 6769 6e28 5461 736b 5374  dd_plugin(TaskSt
+0000c780: 7265 616d 506c 7567 696e 2873 656c 662e  reamPlugin(self.
+0000c790: 7363 6865 6475 6c65 7229 290a 0a20 2020  scheduler))..   
+0000c7a0: 2020 2020 2061 6374 696f 6e5f 6461 7461       action_data
+0000c7b0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0000c7c0: 2022 7469 6d65 7322 3a20 5b30 2e32 2c20   "times": [0.2, 
+0000c7d0: 302e 315d 2c0a 2020 2020 2020 2020 2020  0.1],.          
+0000c7e0: 2020 2266 6f72 6d61 7474 6564 5f74 696d    "formatted_tim
+0000c7f0: 6522 3a20 5b22 302e 3220 6d73 222c 2022  e": ["0.2 ms", "
+0000c800: 322e 3820 7573 225d 2c0a 2020 2020 2020  2.8 us"],.      
+0000c810: 2020 2020 2020 2263 6f6c 6f72 223a 205b        "color": [
+0000c820: 7473 5f63 6f6c 6f72 5f6c 6f6f 6b75 705b  ts_color_lookup[
+0000c830: 2274 7261 6e73 6665 7222 5d2c 2074 735f  "transfer"], ts_
+0000c840: 636f 6c6f 725f 6c6f 6f6b 7570 5b22 636f  color_lookup["co
+0000c850: 6d70 7574 6522 5d5d 2c0a 2020 2020 2020  mpute"]],.      
+0000c860: 2020 2020 2020 226e 616d 6573 223a 205b        "names": [
+0000c870: 2274 7261 6e73 6665 7222 2c20 2263 6f6d  "transfer", "com
+0000c880: 7075 7465 225d 2c0a 2020 2020 2020 2020  pute"],.        
+0000c890: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
+0000c8a0: 6163 7469 6f6e 5f73 6f75 7263 6520 3d20  action_source = 
+0000c8b0: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+0000c8c0: 2864 6174 613d 6163 7469 6f6e 5f64 6174  (data=action_dat
+0000c8d0: 6129 0a0a 2020 2020 2020 2020 7365 6c66  a)..        self
+0000c8e0: 2e72 6f6f 7420 3d20 6669 6775 7265 280a  .root = figure(.
+0000c8f0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+0000c900: 653d 2241 6767 7265 6761 7465 2050 6572  e="Aggregate Per
+0000c910: 2041 6374 696f 6e22 2c0a 2020 2020 2020   Action",.      
+0000c920: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+0000c930: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000c940: 3d22 6167 6772 6567 6174 655f 7065 725f  ="aggregate_per_
+0000c950: 6163 7469 6f6e 222c 0a20 2020 2020 2020  action",.       
+0000c960: 2020 2020 2078 5f72 616e 6765 3d5b 2261       x_range=["a
+0000c970: 222c 2022 6222 5d2c 0a20 2020 2020 2020  ", "b"],.       
+0000c980: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+0000c990: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000c9a0: 2020 7265 6374 203d 2073 656c 662e 726f    rect = self.ro
+0000c9b0: 6f74 2e76 6261 7228 0a20 2020 2020 2020  ot.vbar(.       
+0000c9c0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0000c9d0: 2e61 6374 696f 6e5f 736f 7572 6365 2c0a  .action_source,.
+0000c9e0: 2020 2020 2020 2020 2020 2020 783d 226e              x="n
+0000c9f0: 616d 6573 222c 0a20 2020 2020 2020 2020  ames",.         
+0000ca00: 2020 2074 6f70 3d22 7469 6d65 7322 2c0a     top="times",.
+0000ca10: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+0000ca20: 683d 302e 372c 0a20 2020 2020 2020 2020  h=0.7,.         
+0000ca30: 2020 2063 6f6c 6f72 3d22 636f 6c6f 7222     color="color"
+0000ca40: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000ca50: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+0000ca60: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
+0000ca70: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000ca80: 6f74 2e79 6178 6973 5b30 5d2e 666f 726d  ot.yaxis[0].form
+0000ca90: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
+0000caa0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
+0000cab0: 6d61 743d 2230 2229 0a20 2020 2020 2020  mat="0").       
+0000cac0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+0000cad0: 2e61 7869 735f 6c61 6265 6c20 3d20 2254  .axis_label = "T
+0000cae0: 696d 6520 2873 2922 0a20 2020 2020 2020  ime (s)".       
+0000caf0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+0000cb00: 2e74 6963 6b65 7220 3d20 4164 6170 7469  .ticker = Adapti
+0000cb10: 7665 5469 636b 6572 282a 2a54 4943 4b53  veTicker(**TICKS
+0000cb20: 5f31 3032 3429 0a20 2020 2020 2020 2073  _1024).        s
+0000cb30: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
+0000cb40: 616a 6f72 5f6c 6162 656c 5f6f 7269 656e  ajor_label_orien
+0000cb50: 7461 7469 6f6e 203d 2058 4c41 4245 4c5f  tation = XLABEL_
+0000cb60: 4f52 4945 4e54 4154 494f 4e0a 2020 2020  ORIENTATION.    
+0000cb70: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
+0000cb80: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
+0000cb90: 7465 7874 5f66 6f6e 745f 7369 7a65 203d  text_font_size =
+0000cba0: 2022 3136 7078 220a 2020 2020 2020 2020   "16px".        
+0000cbb0: 7265 6374 2e6e 6f6e 7365 6c65 6374 696f  rect.nonselectio
+0000cbc0: 6e5f 676c 7970 6820 3d20 4e6f 6e65 0a0a  n_glyph = None..
+0000cbd0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0000cbe0: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
+0000cbf0: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+0000cc00: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
+0000cc10: 6f6f 742e 7867 7269 642e 7669 7369 626c  oot.xgrid.visibl
+0000cc20: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+0000cc30: 2020 2073 656c 662e 726f 6f74 2e74 6f6f     self.root.too
+0000cc40: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
+0000cc50: 4e6f 6e65 0a0a 2020 2020 2020 2020 686f  None..        ho
+0000cc60: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
+0000cc70: 290a 2020 2020 2020 2020 686f 7665 722e  ).        hover.
+0000cc80: 746f 6f6c 7469 7073 203d 2022 2222 0a20  tooltips = """. 
+0000cc90: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+0000cca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ccb0: 203c 703e 3c62 3e4e 616d 653a 3c2f 623e   <p><b>Name:</b>
+0000ccc0: 2040 6e61 6d65 733c 2f70 3e0a 2020 2020   @names</p>.    
+0000ccd0: 2020 2020 2020 2020 2020 2020 3c70 3e3c              <p><
+0000cce0: 623e 5469 6d65 3a3c 2f62 3e20 4066 6f72  b>Time:</b> @for
+0000ccf0: 6d61 7474 6564 5f74 696d 653c 2f70 3e0a  matted_time</p>.
+0000cd00: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+0000cd10: 763e 0a20 2020 2020 2020 2020 2020 2022  v>.            "
+0000cd20: 2222 0a20 2020 2020 2020 2068 6f76 6572  "".        hover
+0000cd30: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
+0000cd40: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
+0000cd50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0000cd60: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
+0000cd70: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+0000cd80: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+0000cd90: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+0000cda0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+0000cdb0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+0000cdc0: 2020 6167 675f 7469 6d65 7320 3d20 6465    agg_times = de
+0000cdd0: 6661 756c 7464 6963 7428 666c 6f61 7429  faultdict(float)
+0000cde0: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
+0000cdf0: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+0000ce00: 6572 2e74 6173 6b5f 7072 6566 6978 6573  er.task_prefixes
+0000ce10: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+0000ce20: 2020 2020 2020 2066 6f72 2061 6374 696f         for actio
+0000ce30: 6e2c 2074 2069 6e20 7473 2e61 6c6c 5f64  n, t in ts.all_d
+0000ce40: 7572 6174 696f 6e73 2e69 7465 6d73 2829  urations.items()
+0000ce50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ce60: 2020 6167 675f 7469 6d65 735b 6163 7469    agg_times[acti
+0000ce70: 6f6e 5d20 2b3d 2074 0a0a 2020 2020 2020  on] += t..      
+0000ce80: 2020 2320 6f72 6465 7220 6279 206c 6172    # order by lar
+0000ce90: 6765 7374 2074 696d 6520 6669 7273 740a  gest time first.
+0000cea0: 2020 2020 2020 2020 6167 675f 7469 6d65          agg_time
+0000ceb0: 7320 3d20 736f 7274 6564 2861 6767 5f74  s = sorted(agg_t
+0000cec0: 696d 6573 2e69 7465 6d73 2829 2c20 6b65  imes.items(), ke
+0000ced0: 793d 6c61 6d62 6461 2078 3a20 785b 315d  y=lambda x: x[1]
+0000cee0: 2c20 7265 7665 7273 653d 5472 7565 290a  , reverse=True).
+0000cef0: 0a20 2020 2020 2020 2061 6767 5f63 6f6c  .        agg_col
+0000cf00: 6f72 7320 3d20 6c69 7374 2829 0a20 2020  ors = list().   
+0000cf10: 2020 2020 2061 6767 5f6e 616d 6573 203d       agg_names =
+0000cf20: 206c 6973 7428 290a 2020 2020 2020 2020   list().        
+0000cf30: 6167 675f 7469 6d65 203d 206c 6973 7428  agg_time = list(
+0000cf40: 290a 2020 2020 2020 2020 666f 7220 6163  ).        for ac
+0000cf50: 7469 6f6e 2c20 7420 696e 2061 6767 5f74  tion, t in agg_t
+0000cf60: 696d 6573 3a0a 2020 2020 2020 2020 2020  imes:.          
+0000cf70: 2020 6167 675f 6e61 6d65 732e 6170 7065    agg_names.appe
+0000cf80: 6e64 2861 6374 696f 6e29 0a20 2020 2020  nd(action).     
+0000cf90: 2020 2020 2020 2069 6620 6163 7469 6f6e         if action
+0000cfa0: 203d 3d20 2263 6f6d 7075 7465 223a 0a20   == "compute":. 
+0000cfb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000cfc0: 6767 5f63 6f6c 6f72 732e 6170 7065 6e64  gg_colors.append
+0000cfd0: 2822 7075 7270 6c65 2229 0a20 2020 2020  ("purple").     
+0000cfe0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000cff0: 2020 2020 2020 2020 2020 2020 2061 6767               agg
+0000d000: 5f63 6f6c 6f72 732e 6170 7065 6e64 2874  _colors.append(t
+0000d010: 735f 636f 6c6f 725f 6c6f 6f6b 7570 5b61  s_color_lookup[a
+0000d020: 6374 696f 6e5d 290a 2020 2020 2020 2020  ction]).        
+0000d030: 2020 2020 6167 675f 7469 6d65 2e61 7070      agg_time.app
+0000d040: 656e 6428 7429 0a0a 2020 2020 2020 2020  end(t)..        
+0000d050: 7365 6c66 2e72 6f6f 742e 785f 7261 6e67  self.root.x_rang
+0000d060: 652e 6661 6374 6f72 7320 3d20 6167 675f  e.factors = agg_
+0000d070: 6e61 6d65 730a 2020 2020 2020 2020 7365  names.        se
+0000d080: 6c66 2e72 6f6f 742e 7469 746c 652e 7465  lf.root.title.te
+0000d090: 7874 203d 2022 4167 6772 6567 6174 6520  xt = "Aggregate 
+0000d0a0: 5469 6d65 2050 6572 2041 6374 696f 6e22  Time Per Action"
+0000d0b0: 0a0a 2020 2020 2020 2020 6163 7469 6f6e  ..        action
+0000d0c0: 5f72 6573 756c 7420 3d20 6469 6374 280a  _result = dict(.
+0000d0d0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+0000d0e0: 733d 6167 675f 7469 6d65 2c0a 2020 2020  s=agg_time,.    
+0000d0f0: 2020 2020 2020 2020 636f 6c6f 723d 6167          color=ag
+0000d100: 675f 636f 6c6f 7273 2c0a 2020 2020 2020  g_colors,.      
+0000d110: 2020 2020 2020 6e61 6d65 733d 6167 675f        names=agg_
+0000d120: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
+0000d130: 2020 2066 6f72 6d61 7474 6564 5f74 696d     formatted_tim
+0000d140: 653d 5b66 6f72 6d61 745f 7469 6d65 2874  e=[format_time(t
+0000d150: 2920 666f 7220 7420 696e 2061 6767 5f74  ) for t in agg_t
+0000d160: 696d 655d 2c0a 2020 2020 2020 2020 290a  ime],.        ).
+0000d170: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+0000d180: 7365 6c66 2e61 6374 696f 6e5f 736f 7572  self.action_sour
+0000d190: 6365 2c20 6163 7469 6f6e 5f72 6573 756c  ce, action_resul
+0000d1a0: 7429 0a0a 0a63 6c61 7373 204d 656d 6f72  t)...class Memor
+0000d1b0: 7942 794b 6579 2844 6173 6862 6f61 7264  yByKey(Dashboard
+0000d1c0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
+0000d1d0: 2222 2242 6172 2063 6861 7274 2073 686f  """Bar chart sho
+0000d1e0: 7769 6e67 206d 656d 6f72 7920 7573 6520  wing memory use 
+0000d1f0: 6279 206b 6579 2070 7265 6669 7822 2222  by key prefix"""
+0000d200: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+0000d210: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
+0000d220: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+0000d230: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+0000d240: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0000d250: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000d260: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+0000d270: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+0000d280: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
+0000d290: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
+0000d2a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0000d2b0: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+0000d2c0: 616d 6522 3a20 5b22 6122 2c20 2262 225d  ame": ["a", "b"]
+0000d2d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d2e0: 2020 226e 6279 7465 7322 3a20 5b31 3030    "nbytes": [100
+0000d2f0: 2c20 3130 3030 5d2c 0a20 2020 2020 2020  , 1000],.       
+0000d300: 2020 2020 2020 2020 2022 636f 756e 7422           "count"
+0000d310: 3a20 5b31 2c20 325d 2c0a 2020 2020 2020  : [1, 2],.      
+0000d320: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
+0000d330: 223a 205b 2262 6c75 6522 2c20 2262 6c75  ": ["blue", "blu
+0000d340: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
+0000d350: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
+0000d360: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+0000d370: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+0000d380: 2020 2020 2020 7469 746c 653d 224d 656d        title="Mem
+0000d390: 6f72 7920 5573 6522 2c0a 2020 2020 2020  ory Use",.      
+0000d3a0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+0000d3b0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000d3c0: 3d22 6d65 6d6f 7279 5f62 795f 6b65 7922  ="memory_by_key"
+0000d3d0: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+0000d3e0: 7261 6e67 653d 5b22 6122 2c20 2262 225d  range=["a", "b"]
+0000d3f0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+0000d400: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+0000d410: 290a 2020 2020 2020 2020 7265 6374 203d  ).        rect =
+0000d420: 2073 656c 662e 726f 6f74 2e76 6261 7228   self.root.vbar(
+0000d430: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0000d440: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+0000d450: 2078 3d22 6e61 6d65 222c 2074 6f70 3d22   x="name", top="
+0000d460: 6e62 7974 6573 222c 2077 6964 7468 3d30  nbytes", width=0
+0000d470: 2e39 2c20 636f 6c6f 723d 2263 6f6c 6f72  .9, color="color
+0000d480: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0000d490: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
+0000d4a0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
+0000d4b0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
+0000d4c0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+0000d4d0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
+0000d4e0: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
+0000d4f0: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
+0000d500: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
+0000d510: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
+0000d520: 6c66 2e72 6f6f 742e 7861 7869 732e 6d61  lf.root.xaxis.ma
+0000d530: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
+0000d540: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
+0000d550: 5249 454e 5441 5449 4f4e 0a20 2020 2020  RIENTATION.     
+0000d560: 2020 2072 6563 742e 6e6f 6e73 656c 6563     rect.nonselec
+0000d570: 7469 6f6e 5f67 6c79 7068 203d 204e 6f6e  tion_glyph = Non
+0000d580: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+0000d590: 726f 6f74 2e78 6178 6973 2e6d 696e 6f72  root.xaxis.minor
+0000d5a0: 5f74 6963 6b5f 6c69 6e65 5f61 6c70 6861  _tick_line_alpha
+0000d5b0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000d5c0: 662e 726f 6f74 2e79 6772 6964 2e76 6973  f.root.ygrid.vis
+0000d5d0: 6962 6c65 203d 2046 616c 7365 0a0a 2020  ible = False..  
+0000d5e0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000d5f0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+0000d600: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+0000d610: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+0000d620: 6f6c 2829 0a20 2020 2020 2020 2068 6f76  ol().        hov
+0000d630: 6572 2e74 6f6f 6c74 6970 7320 3d20 2240  er.tooltips = "@
+0000d640: 6e61 6d65 3a20 406e 6279 7465 735f 7465  name: @nbytes_te
+0000d650: 7874 220a 2020 2020 2020 2020 686f 7665  xt".        hove
+0000d660: 722e 746f 6f6c 7469 7073 203d 2022 2222  r.tooltips = """
+0000d670: 0a20 2020 2020 2020 2020 2020 203c 6469  .            <di
+0000d680: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+0000d690: 2020 203c 703e 3c62 3e4e 616d 653a 3c2f     <p><b>Name:</
+0000d6a0: 623e 2040 6e61 6d65 3c2f 703e 0a20 2020  b> @name</p>.   
+0000d6b0: 2020 2020 2020 2020 2020 2020 203c 703e               <p>
+0000d6c0: 3c62 3e42 7974 6573 3a3c 2f62 3e20 406e  <b>Bytes:</b> @n
+0000d6d0: 6279 7465 735f 7465 7874 203c 2f70 3e0a  bytes_text </p>.
+0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6f0: 3c70 3e3c 623e 436f 756e 743a 3c2f 623e  <p><b>Count:</b>
+0000d700: 2040 636f 756e 7420 6f62 6a65 6374 7320   @count objects 
+0000d710: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
+0000d720: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+0000d730: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000d740: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
+0000d750: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
+0000d760: 7365 220a 2020 2020 2020 2020 7365 6c66  se".        self
+0000d770: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
+0000d780: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
+0000d790: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+0000d7a0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+0000d7b0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+0000d7c0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+0000d7d0: 2020 2020 2020 2063 6f75 6e74 7320 3d20         counts = 
+0000d7e0: 6465 6661 756c 7464 6963 7428 696e 7429  defaultdict(int)
+0000d7f0: 0a20 2020 2020 2020 206e 6279 7465 7320  .        nbytes 
+0000d800: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
+0000d810: 7429 0a20 2020 2020 2020 2066 6f72 2077  t).        for w
+0000d820: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
+0000d830: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+0000d840: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+0000d850: 2020 666f 7220 7473 2069 6e20 7773 2e68    for ts in ws.h
+0000d860: 6173 5f77 6861 743a 0a20 2020 2020 2020  as_what:.       
+0000d870: 2020 2020 2020 2020 206b 7320 3d20 6b65           ks = ke
+0000d880: 795f 7370 6c69 7428 7473 2e6b 6579 290a  y_split(ts.key).
+0000d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8a0: 636f 756e 7473 5b6b 735d 202b 3d20 310a  counts[ks] += 1.
+0000d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8c0: 6e62 7974 6573 5b6b 735d 202b 3d20 7473  nbytes[ks] += ts
+0000d8d0: 2e6e 6279 7465 730a 0a20 2020 2020 2020  .nbytes..       
+0000d8e0: 206e 616d 6573 203d 206c 6973 7428 736f   names = list(so
+0000d8f0: 7274 6564 2863 6f75 6e74 7329 290a 2020  rted(counts)).  
+0000d900: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000d910: 785f 7261 6e67 652e 6661 6374 6f72 7320  x_range.factors 
+0000d920: 3d20 6e61 6d65 730a 2020 2020 2020 2020  = names.        
+0000d930: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
+0000d940: 2020 2020 2020 2022 6e61 6d65 223a 206e         "name": n
+0000d950: 616d 6573 2c0a 2020 2020 2020 2020 2020  ames,.          
+0000d960: 2020 2263 6f75 6e74 223a 205b 636f 756e    "count": [coun
+0000d970: 7473 5b6e 616d 655d 2066 6f72 206e 616d  ts[name] for nam
 0000d980: 6520 696e 206e 616d 6573 5d2c 0a20 2020  e in names],.   
 0000d990: 2020 2020 2020 2020 2022 6e62 7974 6573           "nbytes
-0000d9a0: 5f74 6578 7422 3a20 5b66 6f72 6d61 745f  _text": [format_
-0000d9b0: 6279 7465 7328 6e62 7974 6573 5b6e 616d  bytes(nbytes[nam
-0000d9c0: 655d 2920 666f 7220 6e61 6d65 2069 6e20  e]) for name in 
-0000d9d0: 6e61 6d65 735d 2c0a 2020 2020 2020 2020  names],.        
-0000d9e0: 2020 2020 2263 6f6c 6f72 223a 205b 636f      "color": [co
-0000d9f0: 6c6f 725f 6f66 286e 616d 6529 2066 6f72  lor_of(name) for
-0000da00: 206e 616d 6520 696e 206e 616d 6573 5d2c   name in names],
-0000da10: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-0000da20: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
-0000da30: 6c65 2e74 6578 7420 3d20 2254 6f74 616c  le.text = "Total
-0000da40: 2055 7365 3a20 2220 2b20 666f 726d 6174   Use: " + format
-0000da50: 5f62 7974 6573 2873 756d 286e 6279 7465  _bytes(sum(nbyte
-0000da60: 732e 7661 6c75 6573 2829 2929 0a0a 2020  s.values()))..  
-0000da70: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
-0000da80: 662e 736f 7572 6365 2c20 7265 7375 6c74  f.source, result
-0000da90: 290a 0a0a 636c 6173 7320 4375 7272 656e  )...class Curren
-0000daa0: 744c 6f61 6428 4461 7368 626f 6172 6443  tLoad(DashboardC
-0000dab0: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-0000dac0: 2222 5461 736b 7320 616e 6420 4350 5520  ""Tasks and CPU 
-0000dad0: 7573 6167 6520 6f6e 2065 6163 6820 776f  usage on each wo
-0000dae0: 726b 6572 2222 220a 0a20 2020 2040 6c6f  rker"""..    @lo
-0000daf0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0000db00: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0000db10: 7363 6865 6475 6c65 722c 2077 6964 7468  scheduler, width
-0000db20: 3d36 3030 2c20 2a2a 6b77 6172 6773 293a  =600, **kwargs):
-0000db30: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
-0000db40: 7374 203d 2030 0a20 2020 2020 2020 2073  st = 0.        s
-0000db50: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
-0000db60: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-0000db70: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
-0000db80: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-0000db90: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-0000dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbb0: 226e 7072 6f63 6573 7369 6e67 223a 205b  "nprocessing": [
-0000dbc0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000dbd0: 2020 2022 6e70 726f 6365 7373 696e 672d     "nprocessing-
-0000dbe0: 6861 6c66 223a 205b 5d2c 0a20 2020 2020  half": [],.     
-0000dbf0: 2020 2020 2020 2020 2020 2022 6e70 726f             "npro
-0000dc00: 6365 7373 696e 672d 636f 6c6f 7222 3a20  cessing-color": 
-0000dc10: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-0000dc20: 2020 2020 2263 7075 223a 205b 5d2c 0a20      "cpu": [],. 
-0000dc30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000dc40: 6370 752d 6861 6c66 223a 205b 5d2c 0a20  cpu-half": [],. 
-0000dc50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000dc60: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
-0000dc70: 2020 2020 2020 2020 2277 6f72 6b65 7222          "worker"
-0000dc80: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-0000dc90: 2020 2020 2020 2265 7363 6170 6564 5f77        "escaped_w
-0000dca0: 6f72 6b65 7222 3a20 5b5d 2c0a 2020 2020  orker": [],.    
-0000dcb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0000dcc0: 2020 290a 2020 2020 2020 2020 7072 6f63    ).        proc
-0000dcd0: 6573 7369 6e67 203d 2066 6967 7572 6528  essing = figure(
-0000dce0: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-0000dcf0: 6c65 3d22 5461 736b 7320 5072 6f63 6573  le="Tasks Proces
-0000dd00: 7369 6e67 222c 0a20 2020 2020 2020 2020  sing",.         
-0000dd10: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
-0000dd20: 2020 2020 2020 2020 206e 616d 653d 2270           name="p
-0000dd30: 726f 6365 7373 696e 6722 2c0a 2020 2020  rocessing",.    
-0000dd40: 2020 2020 2020 2020 7769 6474 683d 696e          width=in
-0000dd50: 7428 7769 6474 6820 2f20 3229 2c0a 2020  t(width / 2),.  
-0000dd60: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
-0000dd70: 7264 6572 5f62 6f74 746f 6d3d 3530 2c0a  rder_bottom=50,.
-0000dd80: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-0000dd90: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-0000dda0: 2020 2020 2020 2020 7265 6374 203d 2070          rect = p
-0000ddb0: 726f 6365 7373 696e 672e 7265 6374 280a  rocessing.rect(.
-0000ddc0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0000ddd0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-0000dde0: 2020 2020 2020 2020 2020 2020 783d 226e              x="n
-0000ddf0: 7072 6f63 6573 7369 6e67 2d68 616c 6622  processing-half"
-0000de00: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
-0000de10: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
-0000de20: 2077 6964 7468 3d22 6e70 726f 6365 7373   width="nprocess
-0000de30: 696e 6722 2c0a 2020 2020 2020 2020 2020  ing",.          
-0000de40: 2020 6865 6967 6874 3d30 2e39 2c0a 2020    height=0.9,.  
-0000de50: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
-0000de60: 226e 7072 6f63 6573 7369 6e67 2d63 6f6c  "nprocessing-col
-0000de70: 6f72 222c 0a20 2020 2020 2020 2029 0a20  or",.        ). 
-0000de80: 2020 2020 2020 2070 726f 6365 7373 696e         processin
-0000de90: 672e 785f 7261 6e67 652e 7374 6172 7420  g.x_range.start 
-0000dea0: 3d20 300a 2020 2020 2020 2020 7265 6374  = 0.        rect
-0000deb0: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
-0000dec0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
-0000ded0: 2020 2020 6370 7520 3d20 6669 6775 7265      cpu = figure
-0000dee0: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-0000def0: 746c 653d 2243 5055 2055 7469 6c69 7a61  tle="CPU Utiliza
-0000df00: 7469 6f6e 222c 0a20 2020 2020 2020 2020  tion",.         
-0000df10: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
-0000df20: 2020 2020 2020 2020 2077 6964 7468 3d69           width=i
-0000df30: 6e74 2877 6964 7468 202f 2032 292c 0a20  nt(width / 2),. 
-0000df40: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-0000df50: 2263 7075 5f68 6973 7422 2c0a 2020 2020  "cpu_hist",.    
-0000df60: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-0000df70: 2830 2c20 3130 3029 2c0a 2020 2020 2020  (0, 100),.      
-0000df80: 2020 2020 2020 6d69 6e5f 626f 7264 6572        min_border
-0000df90: 5f62 6f74 746f 6d3d 3530 2c0a 2020 2020  _bottom=50,.    
-0000dfa0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0000dfb0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000dfc0: 2020 2020 7265 6374 203d 2063 7075 2e72      rect = cpu.r
-0000dfd0: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-0000dfe0: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-0000dff0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0000e000: 2078 3d22 6370 752d 6861 6c66 222c 0a20   x="cpu-half",. 
-0000e010: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
-0000e020: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
-0000e030: 6474 683d 2263 7075 222c 0a20 2020 2020  dth="cpu",.     
-0000e040: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
-0000e050: 392c 0a20 2020 2020 2020 2020 2020 2063  9,.            c
-0000e060: 6f6c 6f72 3d22 626c 7565 222c 0a20 2020  olor="blue",.   
-0000e070: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0000e080: 6563 742e 6e6f 6e73 656c 6563 7469 6f6e  ect.nonselection
-0000e090: 5f67 6c79 7068 203d 204e 6f6e 650a 0a20  _glyph = None.. 
-0000e0a0: 2020 2020 2020 2066 6f72 2066 6967 2069         for fig i
-0000e0b0: 6e20 2870 726f 6365 7373 696e 672c 2063  n (processing, c
-0000e0c0: 7075 293a 0a20 2020 2020 2020 2020 2020  pu):.           
-0000e0d0: 2066 6967 2e78 6178 6973 2e6d 696e 6f72   fig.xaxis.minor
-0000e0e0: 5f74 6963 6b5f 6c69 6e65 5f61 6c70 6861  _tick_line_alpha
-0000e0f0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-0000e100: 2066 6967 2e79 6178 6973 2e76 6973 6962   fig.yaxis.visib
-0000e110: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-0000e120: 2020 2020 2020 2066 6967 2e79 6772 6964         fig.ygrid
-0000e130: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-0000e140: 0a0a 2020 2020 2020 2020 2020 2020 7461  ..            ta
-0000e150: 7020 3d20 5461 7054 6f6f 6c28 6361 6c6c  p = TapTool(call
-0000e160: 6261 636b 3d4f 7065 6e55 524c 2875 726c  back=OpenURL(url
-0000e170: 3d22 2e2f 696e 666f 2f77 6f72 6b65 722f  ="./info/worker/
-0000e180: 4065 7363 6170 6564 5f77 6f72 6b65 722e  @escaped_worker.
-0000e190: 6874 6d6c 2229 290a 2020 2020 2020 2020  html")).        
-0000e1a0: 2020 2020 6669 672e 6164 645f 746f 6f6c      fig.add_tool
-0000e1b0: 7328 7461 7029 0a0a 2020 2020 2020 2020  s(tap)..        
-0000e1c0: 2020 2020 6669 672e 746f 6f6c 6261 725f      fig.toolbar_
-0000e1d0: 6c6f 6361 7469 6f6e 203d 204e 6f6e 650a  location = None.
-0000e1e0: 2020 2020 2020 2020 2020 2020 6669 672e              fig.
-0000e1f0: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
-0000e200: 4661 6c73 650a 0a20 2020 2020 2020 2068  False..        h
-0000e210: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
-0000e220: 2829 0a20 2020 2020 2020 2068 6f76 6572  ().        hover
-0000e230: 2e74 6f6f 6c74 6970 7320 3d20 2240 776f  .tooltips = "@wo
-0000e240: 726b 6572 203a 2040 6e70 726f 6365 7373  rker : @nprocess
-0000e250: 696e 6720 7461 736b 7322 0a20 2020 2020  ing tasks".     
-0000e260: 2020 2068 6f76 6572 2e70 6f69 6e74 5f70     hover.point_p
-0000e270: 6f6c 6963 7920 3d20 2266 6f6c 6c6f 775f  olicy = "follow_
-0000e280: 6d6f 7573 6522 0a20 2020 2020 2020 2070  mouse".        p
-0000e290: 726f 6365 7373 696e 672e 6164 645f 746f  rocessing.add_to
-0000e2a0: 6f6c 7328 686f 7665 7229 0a0a 2020 2020  ols(hover)..    
-0000e2b0: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-0000e2c0: 7254 6f6f 6c28 290a 2020 2020 2020 2020  rTool().        
-0000e2d0: 686f 7665 722e 746f 6f6c 7469 7073 203d  hover.tooltips =
-0000e2e0: 2022 4077 6f72 6b65 7220 3a20 4063 7075   "@worker : @cpu
-0000e2f0: 2025 220a 2020 2020 2020 2020 686f 7665   %".        hove
-0000e300: 722e 706f 696e 745f 706f 6c69 6379 203d  r.point_policy =
-0000e310: 2022 666f 6c6c 6f77 5f6d 6f75 7365 220a   "follow_mouse".
-0000e320: 2020 2020 2020 2020 6370 752e 6164 645f          cpu.add_
-0000e330: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
-0000e340: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
-0000e350: 7373 696e 675f 6669 6775 7265 203d 2070  ssing_figure = p
-0000e360: 726f 6365 7373 696e 670a 2020 2020 2020  rocessing.      
-0000e370: 2020 7365 6c66 2e63 7075 5f66 6967 7572    self.cpu_figur
-0000e380: 6520 3d20 6370 750a 0a20 2020 2040 7769  e = cpu..    @wi
-0000e390: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
-0000e3a0: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
-0000e3b0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0000e3c0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
-0000e3d0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-0000e3e0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-0000e3f0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0000e400: 290a 2020 2020 2020 2020 6e6f 7720 3d20  ).        now = 
-0000e410: 7469 6d65 2829 0a20 2020 2020 2020 2069  time().        i
-0000e420: 6620 6e6f 7420 616e 7928 7773 2e70 726f  f not any(ws.pro
-0000e430: 6365 7373 696e 6720 666f 7220 7773 2069  cessing for ws i
-0000e440: 6e20 776f 726b 6572 7329 2061 6e64 206e  n workers) and n
-0000e450: 6f77 203c 2073 656c 662e 6c61 7374 202b  ow < self.last +
-0000e460: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000e470: 7265 7475 726e 0a20 2020 2020 2020 2073  return.        s
-0000e480: 656c 662e 6c61 7374 203d 206e 6f77 0a0a  elf.last = now..
-0000e490: 2020 2020 2020 2020 6370 7520 3d20 5b69          cpu = [i
-0000e4a0: 6e74 2877 732e 6d65 7472 6963 735b 2263  nt(ws.metrics["c
-0000e4b0: 7075 225d 2920 666f 7220 7773 2069 6e20  pu"]) for ws in 
-0000e4c0: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
-0000e4d0: 206e 7072 6f63 6573 7369 6e67 203d 205b   nprocessing = [
-0000e4e0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
-0000e4f0: 6729 2066 6f72 2077 7320 696e 2077 6f72  g) for ws in wor
-0000e500: 6b65 7273 5d0a 0a20 2020 2020 2020 206e  kers]..        n
-0000e510: 7072 6f63 6573 7369 6e67 5f63 6f6c 6f72  processing_color
-0000e520: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-0000e530: 7220 7773 2069 6e20 776f 726b 6572 733a  r ws in workers:
-0000e540: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000e550: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
-0000e560: 756c 6572 2e69 646c 653a 0a20 2020 2020  uler.idle:.     
-0000e570: 2020 2020 2020 2020 2020 206e 7072 6f63             nproc
-0000e580: 6573 7369 6e67 5f63 6f6c 6f72 2e61 7070  essing_color.app
-0000e590: 656e 6428 2272 6564 2229 0a20 2020 2020  end("red").     
-0000e5a0: 2020 2020 2020 2065 6c69 6620 7773 2069         elif ws i
-0000e5b0: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
-0000e5c0: 2e73 6174 7572 6174 6564 3a0a 2020 2020  .saturated:.    
-0000e5d0: 2020 2020 2020 2020 2020 2020 6e70 726f              npro
-0000e5e0: 6365 7373 696e 675f 636f 6c6f 722e 6170  cessing_color.ap
-0000e5f0: 7065 6e64 2822 6772 6565 6e22 290a 2020  pend("green").  
-0000e600: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e620: 6e70 726f 6365 7373 696e 675f 636f 6c6f  nprocessing_colo
-0000e630: 722e 6170 7065 6e64 2822 626c 7565 2229  r.append("blue")
-0000e640: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
-0000e650: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0000e660: 2022 6370 7522 3a20 6370 752c 0a20 2020   "cpu": cpu,.   
-0000e670: 2020 2020 2020 2020 2022 6370 752d 6861           "cpu-ha
-0000e680: 6c66 223a 205b 6320 2f20 3220 666f 7220  lf": [c / 2 for 
-0000e690: 6320 696e 2063 7075 5d2c 0a20 2020 2020  c in cpu],.     
-0000e6a0: 2020 2020 2020 2022 6e70 726f 6365 7373         "nprocess
-0000e6b0: 696e 6722 3a20 6e70 726f 6365 7373 696e  ing": nprocessin
-0000e6c0: 672c 0a20 2020 2020 2020 2020 2020 2022  g,.            "
-0000e6d0: 6e70 726f 6365 7373 696e 672d 6861 6c66  nprocessing-half
-0000e6e0: 223a 205b 6e70 202f 2032 2066 6f72 206e  ": [np / 2 for n
-0000e6f0: 7020 696e 206e 7072 6f63 6573 7369 6e67  p in nprocessing
-0000e700: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0000e710: 6e70 726f 6365 7373 696e 672d 636f 6c6f  nprocessing-colo
-0000e720: 7222 3a20 6e70 726f 6365 7373 696e 675f  r": nprocessing_
-0000e730: 636f 6c6f 722c 0a20 2020 2020 2020 2020  color,.         
-0000e740: 2020 2022 776f 726b 6572 223a 205b 7773     "worker": [ws
-0000e750: 2e61 6464 7265 7373 2066 6f72 2077 7320  .address for ws 
-0000e760: 696e 2077 6f72 6b65 7273 5d2c 0a20 2020  in workers],.   
-0000e770: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
-0000e780: 645f 776f 726b 6572 223a 205b 6573 6361  d_worker": [esca
-0000e790: 7065 2e75 726c 5f65 7363 6170 6528 7773  pe.url_escape(ws
-0000e7a0: 2e61 6464 7265 7373 2920 666f 7220 7773  .address) for ws
-0000e7b0: 2069 6e20 776f 726b 6572 735d 2c0a 2020   in workers],.  
-0000e7c0: 2020 2020 2020 2020 2020 2279 223a 206c            "y": l
-0000e7d0: 6973 7428 7261 6e67 6528 6c65 6e28 776f  ist(range(len(wo
-0000e7e0: 726b 6572 7329 2929 2c0a 2020 2020 2020  rkers))),.      
-0000e7f0: 2020 7d0a 0a20 2020 2020 2020 2069 6620    }..        if 
-0000e800: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-0000e810: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-0000e820: 2020 2020 7872 616e 6765 203d 206d 6178      xrange = max
-0000e830: 2877 732e 6e74 6872 6561 6473 206f 7220  (ws.nthreads or 
-0000e840: 3120 666f 7220 7773 2069 6e20 776f 726b  1 for ws in work
-0000e850: 6572 7329 0a20 2020 2020 2020 2065 6c73  ers).        els
-0000e860: 653a 0a20 2020 2020 2020 2020 2020 2078  e:.            x
-0000e870: 7261 6e67 6520 3d20 310a 2020 2020 2020  range = 1.      
-0000e880: 2020 7365 6c66 2e63 7075 5f66 6967 7572    self.cpu_figur
-0000e890: 652e 785f 7261 6e67 652e 656e 6420 3d20  e.x_range.end = 
-0000e8a0: 7872 616e 6765 202a 2031 3030 0a0a 2020  xrange * 100..  
-0000e8b0: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
-0000e8c0: 662e 736f 7572 6365 2c20 7265 7375 6c74  f.source, result
-0000e8d0: 290a 0a0a 636c 6173 7320 5374 6561 6c69  )...class Steali
-0000e8e0: 6e67 5469 6d65 5365 7269 6573 2844 6173  ngTimeSeries(Das
-0000e8f0: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-0000e900: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
-0000e910: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-0000e920: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-0000e930: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-0000e940: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-0000e950: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
-0000e960: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-0000e970: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
-0000e980: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0000e990: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
-0000e9a0: 5b74 696d 6528 2920 2a20 3130 3030 2c20  [time() * 1000, 
-0000e9b0: 7469 6d65 2829 202a 2031 3030 3020 2b20  time() * 1000 + 
-0000e9c0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-0000e9d0: 2020 2020 2269 646c 6522 3a20 5b30 2c20      "idle": [0, 
-0000e9e0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-0000e9f0: 2020 2020 2273 6174 7572 6174 6564 223a      "saturated":
-0000ea00: 205b 302c 2030 5d2c 0a20 2020 2020 2020   [0, 0],.       
-0000ea10: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
-0000ea20: 0a0a 2020 2020 2020 2020 785f 7261 6e67  ..        x_rang
-0000ea30: 6520 3d20 4461 7461 5261 6e67 6531 6428  e = DataRange1d(
-0000ea40: 666f 6c6c 6f77 3d22 656e 6422 2c20 666f  follow="end", fo
-0000ea50: 6c6c 6f77 5f69 6e74 6572 7661 6c3d 3230  llow_interval=20
-0000ea60: 3030 302c 2072 616e 6765 5f70 6164 6469  000, range_paddi
-0000ea70: 6e67 3d30 290a 0a20 2020 2020 2020 2073  ng=0)..        s
-0000ea80: 656c 662e 726f 6f74 203d 2066 6967 7572  elf.root = figur
-0000ea90: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-0000eaa0: 6974 6c65 3d22 4964 6c65 2061 6e64 2053  itle="Idle and S
-0000eab0: 6174 7572 6174 6564 2057 6f72 6b65 7273  aturated Workers
-0000eac0: 204f 7665 7220 5469 6d65 222c 0a20 2020   Over Time",.   
-0000ead0: 2020 2020 2020 2020 2078 5f61 7869 735f           x_axis_
-0000eae0: 7479 7065 3d22 6461 7465 7469 6d65 222c  type="datetime",
-0000eaf0: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-0000eb00: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
-0000eb10: 2020 2078 5f72 616e 6765 3d78 5f72 616e     x_range=x_ran
-0000eb20: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
-0000eb30: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-0000eb40: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-0000eb50: 2e72 6f6f 742e 6c69 6e65 2873 6f75 7263  .root.line(sourc
-0000eb60: 653d 7365 6c66 2e73 6f75 7263 652c 2078  e=self.source, x
-0000eb70: 3d22 7469 6d65 222c 2079 3d22 6964 6c65  ="time", y="idle
-0000eb80: 222c 2063 6f6c 6f72 3d22 7265 6422 290a  ", color="red").
-0000eb90: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000eba0: 742e 6c69 6e65 2873 6f75 7263 653d 7365  t.line(source=se
-0000ebb0: 6c66 2e73 6f75 7263 652c 2078 3d22 7469  lf.source, x="ti
-0000ebc0: 6d65 222c 2079 3d22 7361 7475 7261 7465  me", y="saturate
-0000ebd0: 6422 2c20 636f 6c6f 723d 2267 7265 656e  d", color="green
-0000ebe0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0000ebf0: 726f 6f74 2e79 6178 6973 2e6d 696e 6f72  root.yaxis.minor
-0000ec00: 5f74 6963 6b5f 6c69 6e65 5f63 6f6c 6f72  _tick_line_color
-0000ec10: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-0000ec20: 2073 656c 662e 726f 6f74 2e61 6464 5f74   self.root.add_t
-0000ec30: 6f6f 6c73 280a 2020 2020 2020 2020 2020  ools(.          
-0000ec40: 2020 5265 7365 7454 6f6f 6c28 292c 2050    ResetTool(), P
-0000ec50: 616e 546f 6f6c 2864 696d 656e 7369 6f6e  anTool(dimension
-0000ec60: 733d 2277 6964 7468 2229 2c20 5768 6565  s="width"), Whee
-0000ec70: 6c5a 6f6f 6d54 6f6f 6c28 6469 6d65 6e73  lZoomTool(dimens
-0000ec80: 696f 6e73 3d22 7769 6474 6822 290a 2020  ions="width").  
-0000ec90: 2020 2020 2020 290a 0a20 2020 2040 7769        )..    @wi
-0000eca0: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
-0000ecb0: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
-0000ecc0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0000ecd0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
-0000ece0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0000ecf0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-0000ed00: 7469 6d65 223a 205b 7469 6d65 2829 202a  time": [time() *
-0000ed10: 2031 3030 305d 2c0a 2020 2020 2020 2020   1000],.        
-0000ed20: 2020 2020 2269 646c 6522 3a20 5b6c 656e      "idle": [len
-0000ed30: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
-0000ed40: 6964 6c65 295d 2c0a 2020 2020 2020 2020  idle)],.        
-0000ed50: 2020 2020 2273 6174 7572 6174 6564 223a      "saturated":
-0000ed60: 205b 6c65 6e28 7365 6c66 2e73 6368 6564   [len(self.sched
-0000ed70: 756c 6572 2e73 6174 7572 6174 6564 295d  uler.saturated)]
-0000ed80: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-0000ed90: 2020 2020 6966 2050 524f 4649 4c49 4e47      if PROFILING
-0000eda0: 3a0a 2020 2020 2020 2020 2020 2020 6375  :.            cu
-0000edb0: 7264 6f63 2829 2e61 6464 5f6e 6578 745f  rdoc().add_next_
-0000edc0: 7469 636b 5f63 616c 6c62 6163 6b28 6c61  tick_callback(la
-0000edd0: 6d62 6461 3a20 7365 6c66 2e73 6f75 7263  mbda: self.sourc
-0000ede0: 652e 7374 7265 616d 2872 6573 756c 742c  e.stream(result,
-0000edf0: 2031 3030 3030 2929 0a20 2020 2020 2020   10000)).       
-0000ee00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000ee10: 2020 2073 656c 662e 736f 7572 6365 2e73     self.source.s
-0000ee20: 7472 6561 6d28 7265 7375 6c74 2c20 3130  tream(result, 10
-0000ee30: 3030 3029 0a0a 0a63 6c61 7373 2053 7465  000)...class Ste
-0000ee40: 616c 696e 6745 7665 6e74 7328 4461 7368  alingEvents(Dash
-0000ee50: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
-0000ee60: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0000ee70: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
-0000ee80: 722c 202a 2a6b 7761 7267 7329 3a0a 2020  r, **kwargs):.  
-0000ee90: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-0000eea0: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
-0000eeb0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-0000eec0: 6561 6c20 3d20 7363 6865 6475 6c65 722e  eal = scheduler.
-0000eed0: 6578 7465 6e73 696f 6e73 5b22 7374 6561  extensions["stea
-0000eee0: 6c69 6e67 225d 0a20 2020 2020 2020 2073  ling"].        s
-0000eef0: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
-0000ef00: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-0000ef10: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-0000ef20: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-0000ef30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0000ef40: 2020 2022 7469 6d65 223a 205b 7469 6d65     "time": [time
-0000ef50: 2829 202d 2036 302c 2074 696d 6528 295d  () - 60, time()]
-0000ef60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ef70: 2020 226c 6576 656c 223a 205b 302c 2031    "level": [0, 1
-0000ef80: 355d 2c0a 2020 2020 2020 2020 2020 2020  5],.            
-0000ef90: 2020 2020 2263 6f6c 6f72 223a 205b 2277      "color": ["w
-0000efa0: 6869 7465 222c 2022 7768 6974 6522 5d2c  hite", "white"],
-0000efb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000efc0: 2022 6475 7261 7469 6f6e 223a 205b 302c   "duration": [0,
-0000efd0: 2030 5d2c 0a20 2020 2020 2020 2020 2020   0],.           
-0000efe0: 2020 2020 2022 7261 6469 7573 223a 205b       "radius": [
-0000eff0: 312c 2031 5d2c 0a20 2020 2020 2020 2020  1, 1],.         
-0000f000: 2020 2020 2020 2022 636f 7374 5f66 6163         "cost_fac
-0000f010: 746f 7222 3a20 5b30 2c20 3130 5d2c 0a20  tor": [0, 10],. 
-0000f020: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f030: 636f 756e 7422 3a20 5b31 2c20 315d 2c0a  count": [1, 1],.
-0000f040: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0000f050: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000f060: 2078 5f72 616e 6765 203d 2044 6174 6152   x_range = DataR
-0000f070: 616e 6765 3164 2866 6f6c 6c6f 773d 2265  ange1d(follow="e
-0000f080: 6e64 222c 2066 6f6c 6c6f 775f 696e 7465  nd", follow_inte
-0000f090: 7276 616c 3d32 3030 3030 2c20 7261 6e67  rval=20000, rang
-0000f0a0: 655f 7061 6464 696e 673d 3029 0a0a 2020  e_padding=0)..  
-0000f0b0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-0000f0c0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-0000f0d0: 2020 2020 2020 7469 746c 653d 2253 7465        title="Ste
-0000f0e0: 616c 696e 6720 4576 656e 7473 222c 0a20  aling Events",. 
-0000f0f0: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
-0000f100: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
-0000f110: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-0000f120: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-0000f130: 2020 2020 2078 5f72 616e 6765 3d78 5f72       x_range=x_r
-0000f140: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
-0000f150: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0000f160: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-0000f170: 656c 662e 726f 6f74 2e63 6972 636c 6528  elf.root.circle(
-0000f180: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000f190: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0000f1a0: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-0000f1b0: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-0000f1c0: 2020 2079 3d22 6c65 7665 6c22 2c0a 2020     y="level",.  
-0000f1d0: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
-0000f1e0: 2263 6f6c 6f72 222c 0a20 2020 2020 2020  "color",.       
-0000f1f0: 2020 2020 2073 697a 653d 2272 6164 6975       size="radiu
-0000f200: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0000f210: 616c 7068 613d 302e 352c 0a20 2020 2020  alpha=0.5,.     
-0000f220: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0000f230: 662e 726f 6f74 2e79 6178 6973 2e61 7869  f.root.yaxis.axi
-0000f240: 735f 6c61 6265 6c20 3d20 224c 6576 656c  s_label = "Level
-0000f250: 220a 0a20 2020 2020 2020 2068 6f76 6572  "..        hover
-0000f260: 203d 2048 6f76 6572 546f 6f6c 2829 0a20   = HoverTool(). 
-0000f270: 2020 2020 2020 2068 6f76 6572 2e74 6f6f         hover.too
-0000f280: 6c74 6970 7320 3d20 224c 6576 656c 3a20  ltips = "Level: 
-0000f290: 406c 6576 656c 2c20 4475 7261 7469 6f6e  @level, Duration
-0000f2a0: 3a20 4064 7572 6174 696f 6e2c 2043 6f75  : @duration, Cou
-0000f2b0: 6e74 3a20 4063 6f75 6e74 2c20 436f 7374  nt: @count, Cost
-0000f2c0: 2066 6163 746f 723a 2040 636f 7374 5f66   factor: @cost_f
-0000f2d0: 6163 746f 7222 0a20 2020 2020 2020 2068  actor".        h
-0000f2e0: 6f76 6572 2e70 6f69 6e74 5f70 6f6c 6963  over.point_polic
-0000f2f0: 7920 3d20 2266 6f6c 6c6f 775f 6d6f 7573  y = "follow_mous
-0000f300: 6522 0a0a 2020 2020 2020 2020 7365 6c66  e"..        self
-0000f310: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
-0000f320: 0a20 2020 2020 2020 2020 2020 2068 6f76  .            hov
-0000f330: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0000f340: 5265 7365 7454 6f6f 6c28 292c 0a20 2020  ResetTool(),.   
-0000f350: 2020 2020 2020 2020 2050 616e 546f 6f6c           PanTool
-0000f360: 2864 696d 656e 7369 6f6e 733d 2277 6964  (dimensions="wid
-0000f370: 7468 2229 2c0a 2020 2020 2020 2020 2020  th"),.          
-0000f380: 2020 5768 6565 6c5a 6f6f 6d54 6f6f 6c28    WheelZoomTool(
-0000f390: 6469 6d65 6e73 696f 6e73 3d22 7769 6474  dimensions="widt
-0000f3a0: 6822 292c 0a20 2020 2020 2020 2029 0a0a  h"),.        )..
-0000f3b0: 2020 2020 6465 6620 636f 6e76 6572 7428      def convert(
-0000f3c0: 7365 6c66 2c20 6d73 6773 293a 0a20 2020  self, msgs):.   
-0000f3d0: 2020 2020 2022 2222 436f 6e76 6572 7420       """Convert 
-0000f3e0: 6120 6c6f 6720 6d65 7373 6167 6520 746f  a log message to
-0000f3f0: 2061 2067 6c79 7068 2222 220a 2020 2020   a glyph""".    
-0000f400: 2020 2020 746f 7461 6c5f 6475 7261 7469      total_durati
-0000f410: 6f6e 203d 2030 0a20 2020 2020 2020 2066  on = 0.        f
-0000f420: 6f72 206d 7367 2069 6e20 6d73 6773 3a0a  or msg in msgs:.
-0000f430: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000f440: 2c20 6c65 7665 6c2c 206b 6579 2c20 6475  , level, key, du
-0000f450: 7261 7469 6f6e 2c20 7361 742c 206f 6363  ration, sat, occ
-0000f460: 5f73 6174 2c20 6964 6c2c 206f 6363 5f69  _sat, idl, occ_i
-0000f470: 646c 203d 206d 7367 5b3a 385d 0a20 2020  dl = msg[:8].   
-0000f480: 2020 2020 2020 2020 2074 6f74 616c 5f64           total_d
-0000f490: 7572 6174 696f 6e20 2b3d 2064 7572 6174  uration += durat
-0000f4a0: 696f 6e0a 0a20 2020 2020 2020 2074 7279  ion..        try
-0000f4b0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0000f4c0: 6c6f 7220 3d20 5669 7269 6469 7331 315b  lor = Viridis11[
-0000f4d0: 6c65 7665 6c5d 0a20 2020 2020 2020 2065  level].        e
-0000f4e0: 7863 6570 7420 284b 6579 4572 726f 722c  xcept (KeyError,
-0000f4f0: 2049 6e64 6578 4572 726f 7229 3a0a 2020   IndexError):.  
-0000f500: 2020 2020 2020 2020 2020 636f 6c6f 7220            color 
-0000f510: 3d20 2262 6c61 636b 220a 0a20 2020 2020  = "black"..     
-0000f520: 2020 2072 6164 6975 7320 3d20 6d61 7468     radius = math
-0000f530: 2e73 7172 7428 6d69 6e28 746f 7461 6c5f  .sqrt(min(total_
-0000f540: 6475 7261 7469 6f6e 2c20 3130 2929 202a  duration, 10)) *
-0000f550: 2033 3020 2b20 320a 0a20 2020 2020 2020   30 + 2..       
-0000f560: 2064 203d 207b 0a20 2020 2020 2020 2020   d = {.         
-0000f570: 2020 2022 7469 6d65 223a 2074 696d 6520     "time": time 
-0000f580: 2a20 3130 3030 2c0a 2020 2020 2020 2020  * 1000,.        
-0000f590: 2020 2020 226c 6576 656c 223a 206c 6576      "level": lev
-0000f5a0: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-0000f5b0: 2263 6f75 6e74 223a 206c 656e 286d 7367  "count": len(msg
-0000f5c0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0000f5d0: 2263 6f6c 6f72 223a 2063 6f6c 6f72 2c0a  "color": color,.
-0000f5e0: 2020 2020 2020 2020 2020 2020 2264 7572              "dur
-0000f5f0: 6174 696f 6e22 3a20 746f 7461 6c5f 6475  ation": total_du
-0000f600: 7261 7469 6f6e 2c0a 2020 2020 2020 2020  ration,.        
-0000f610: 2020 2020 2272 6164 6975 7322 3a20 7261      "radius": ra
-0000f620: 6469 7573 2c0a 2020 2020 2020 2020 2020  dius,.          
-0000f630: 2020 2263 6f73 745f 6661 6374 6f72 223a    "cost_factor":
-0000f640: 2073 656c 662e 7374 6561 6c2e 636f 7374   self.steal.cost
-0000f650: 5f6d 756c 7469 706c 6965 7273 5b6c 6576  _multipliers[lev
-0000f660: 656c 5d2c 0a20 2020 2020 2020 207d 0a0a  el],.        }..
-0000f670: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-0000f680: 0a0a 2020 2020 4077 6974 686f 7574 5f70  ..    @without_p
-0000f690: 726f 7065 7274 795f 7661 6c69 6461 7469  roperty_validati
-0000f6a0: 6f6e 0a20 2020 2040 6c6f 675f 6572 726f  on.    @log_erro
-0000f6b0: 7273 0a20 2020 2064 6566 2075 7064 6174  rs.    def updat
-0000f6c0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-0000f6d0: 206c 6f67 203d 2073 656c 662e 7363 6865   log = self.sche
-0000f6e0: 6475 6c65 722e 6765 745f 6576 656e 7473  duler.get_events
-0000f6f0: 2874 6f70 6963 3d22 7374 6561 6c69 6e67  (topic="stealing
-0000f700: 2229 0a20 2020 2020 2020 2063 7572 7265  ").        curre
-0000f710: 6e74 203d 206c 656e 2873 656c 662e 7363  nt = len(self.sc
-0000f720: 6865 6475 6c65 722e 6576 656e 7473 5b22  heduler.events["
-0000f730: 7374 6561 6c69 6e67 225d 290a 2020 2020  stealing"]).    
-0000f740: 2020 2020 6e20 3d20 6375 7272 656e 7420      n = current 
-0000f750: 2d20 7365 6c66 2e6c 6173 740a 0a20 2020  - self.last..   
-0000f760: 2020 2020 206c 6f67 203d 205b 6c6f 675b       log = [log[
-0000f770: 2d69 5d5b 315d 5b31 5d20 666f 7220 6920  -i][1][1] for i 
-0000f780: 696e 2072 616e 6765 2831 2c20 6e20 2b20  in range(1, n + 
-0000f790: 3129 2069 6620 6c6f 675b 2d69 5d5b 315d  1) if log[-i][1]
-0000f7a0: 5b30 5d20 3d3d 2022 7265 7175 6573 7422  [0] == "request"
-0000f7b0: 5d0a 2020 2020 2020 2020 7365 6c66 2e6c  ].        self.l
-0000f7c0: 6173 7420 3d20 6375 7272 656e 740a 0a20  ast = current.. 
-0000f7d0: 2020 2020 2020 2069 6620 6c6f 673a 0a20         if log:. 
-0000f7e0: 2020 2020 2020 2020 2020 206e 6577 203d             new =
-0000f7f0: 2070 6970 6528 0a20 2020 2020 2020 2020   pipe(.         
-0000f800: 2020 2020 2020 206c 6f67 2c0a 2020 2020         log,.    
-0000f810: 2020 2020 2020 2020 2020 2020 6d61 7028              map(
-0000f820: 6772 6f75 7062 7928 3129 292c 0a20 2020  groupby(1)),.   
-0000f830: 2020 2020 2020 2020 2020 2020 206d 6170               map
-0000f840: 2864 6963 742e 7661 6c75 6573 292c 0a20  (dict.values),. 
-0000f850: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000f860: 6f6e 6361 742c 0a20 2020 2020 2020 2020  oncat,.         
-0000f870: 2020 2020 2020 206d 6170 2873 656c 662e         map(self.
-0000f880: 636f 6e76 6572 7429 2c0a 2020 2020 2020  convert),.      
-0000f890: 2020 2020 2020 2020 2020 6c69 7374 2c0a            list,.
-0000f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8b0: 7472 616e 7370 6f73 652c 0a20 2020 2020  transpose,.     
-0000f8c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f8d0: 2020 2020 2069 6620 5052 4f46 494c 494e       if PROFILIN
-0000f8e0: 473a 0a20 2020 2020 2020 2020 2020 2020  G:.             
-0000f8f0: 2020 2063 7572 646f 6328 292e 6164 645f     curdoc().add_
-0000f900: 6e65 7874 5f74 6963 6b5f 6361 6c6c 6261  next_tick_callba
-0000f910: 636b 286c 616d 6264 613a 2073 656c 662e  ck(lambda: self.
-0000f920: 736f 7572 6365 2e73 7472 6561 6d28 6e65  source.stream(ne
-0000f930: 772c 2031 3030 3030 2929 0a20 2020 2020  w, 10000)).     
-0000f940: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000f950: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000f960: 662e 736f 7572 6365 2e73 7472 6561 6d28  f.source.stream(
-0000f970: 6e65 772c 2031 3030 3030 290a 0a0a 636c  new, 10000)...cl
-0000f980: 6173 7320 4576 656e 7473 2844 6173 6862  ass Events(Dashb
-0000f990: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
-0000f9a0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0000f9b0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-0000f9c0: 2c20 6e61 6d65 2c20 6865 6967 6874 3d31  , name, height=1
-0000f9d0: 3530 2c20 2a2a 6b77 6172 6773 293a 0a20  50, **kwargs):. 
-0000f9e0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-0000f9f0: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-0000fa00: 720a 2020 2020 2020 2020 7365 6c66 2e61  r.        self.a
-0000fa10: 6374 696f 6e5f 7973 203d 2064 6963 7428  ction_ys = dict(
-0000fa20: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-0000fa30: 6173 7420 3d20 300a 2020 2020 2020 2020  ast = 0.        
-0000fa40: 7365 6c66 2e6e 616d 6520 3d20 6e61 6d65  self.name = name
-0000fa50: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
-0000fa60: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
-0000fa70: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
-0000fa80: 2020 2020 207b 2274 696d 6522 3a20 5b5d       {"time": []
-0000fa90: 2c20 2261 6374 696f 6e22 3a20 5b5d 2c20  , "action": [], 
-0000faa0: 2268 6f76 6572 223a 205b 5d2c 2022 7922  "hover": [], "y"
-0000fab0: 3a20 5b5d 2c20 2263 6f6c 6f72 223a 205b  : [], "color": [
-0000fac0: 5d7d 0a20 2020 2020 2020 2029 0a0a 2020  ]}.        )..  
-0000fad0: 2020 2020 2020 785f 7261 6e67 6520 3d20        x_range = 
-0000fae0: 4461 7461 5261 6e67 6531 6428 666f 6c6c  DataRange1d(foll
-0000faf0: 6f77 3d22 656e 6422 2c20 666f 6c6c 6f77  ow="end", follow
-0000fb00: 5f69 6e74 6572 7661 6c3d 3230 3030 3030  _interval=200000
-0000fb10: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000fb20: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
-0000fb30: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-0000fb40: 3d6e 616d 652c 0a20 2020 2020 2020 2020  =name,.         
-0000fb50: 2020 2078 5f61 7869 735f 7479 7065 3d22     x_axis_type="
-0000fb60: 6461 7465 7469 6d65 222c 0a20 2020 2020  datetime",.     
-0000fb70: 2020 2020 2020 2068 6569 6768 743d 6865         height=he
-0000fb80: 6967 6874 2c0a 2020 2020 2020 2020 2020  ight,.          
-0000fb90: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
-0000fba0: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-0000fbb0: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
-0000fbc0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0000fbd0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000fbe0: 2020 7365 6c66 2e72 6f6f 742e 6369 7263    self.root.circ
-0000fbf0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0000fc00: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-0000fc10: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0000fc20: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
-0000fc30: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
-0000fc40: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
-0000fc50: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
-0000fc60: 2020 2020 7369 7a65 3d35 302c 0a20 2020      size=50,.   
-0000fc70: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
-0000fc80: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-0000fc90: 6c65 6765 6e64 5f66 6965 6c64 3d22 6163  legend_field="ac
-0000fca0: 7469 6f6e 222c 0a20 2020 2020 2020 2029  tion",.        )
-0000fcb0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000fcc0: 6f74 2e79 6178 6973 2e61 7869 735f 6c61  ot.yaxis.axis_la
-0000fcd0: 6265 6c20 3d20 2241 6374 696f 6e22 0a20  bel = "Action". 
-0000fce0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0000fcf0: 2e6c 6567 656e 642e 6c6f 6361 7469 6f6e  .legend.location
-0000fd00: 203d 2022 746f 705f 6c65 6674 220a 0a20   = "top_left".. 
-0000fd10: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-0000fd20: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
-0000fd30: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
-0000fd40: 7320 3d20 2240 6163 7469 6f6e 3c62 723e  s = "@action<br>
-0000fd50: 4068 6f76 6572 220a 2020 2020 2020 2020  @hover".        
-0000fd60: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
-0000fd70: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
-0000fd80: 7365 220a 0a20 2020 2020 2020 2073 656c  se"..        sel
-0000fd90: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
-0000fda0: 280a 2020 2020 2020 2020 2020 2020 686f  (.            ho
-0000fdb0: 7665 722c 0a20 2020 2020 2020 2020 2020  ver,.           
-0000fdc0: 2052 6573 6574 546f 6f6c 2829 2c0a 2020   ResetTool(),.  
-0000fdd0: 2020 2020 2020 2020 2020 5061 6e54 6f6f            PanToo
-0000fde0: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
-0000fdf0: 6474 6822 292c 0a20 2020 2020 2020 2020  dth"),.         
-0000fe00: 2020 2057 6865 656c 5a6f 6f6d 546f 6f6c     WheelZoomTool
-0000fe10: 2864 696d 656e 7369 6f6e 733d 2277 6964  (dimensions="wid
-0000fe20: 7468 2229 2c0a 2020 2020 2020 2020 290a  th"),.        ).
-0000fe30: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-0000fe40: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-0000fe50: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
-0000fe60: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
-0000fe70: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000fe80: 6c6f 6720 3d20 7365 6c66 2e73 6368 6564  log = self.sched
-0000fe90: 756c 6572 2e65 7665 6e74 735b 7365 6c66  uler.events[self
-0000fea0: 2e6e 616d 655d 0a20 2020 2020 2020 206e  .name].        n
-0000feb0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
-0000fec0: 722e 6576 656e 745f 636f 756e 7473 5b73  r.event_counts[s
-0000fed0: 656c 662e 6e61 6d65 5d20 2d20 7365 6c66  elf.name] - self
-0000fee0: 2e6c 6173 740a 2020 2020 2020 2020 6966  .last.        if
-0000fef0: 206c 6f67 3a0a 2020 2020 2020 2020 2020   log:.          
-0000ff00: 2020 6c6f 6720 3d20 5b6c 6f67 5b2d 695d    log = [log[-i]
-0000ff10: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0000ff20: 312c 206e 202b 2031 295d 0a20 2020 2020  1, n + 1)].     
-0000ff30: 2020 2073 656c 662e 6c61 7374 203d 2073     self.last = s
-0000ff40: 656c 662e 7363 6865 6475 6c65 722e 6576  elf.scheduler.ev
-0000ff50: 656e 745f 636f 756e 7473 5b73 656c 662e  ent_counts[self.
-0000ff60: 6e61 6d65 5d0a 0a20 2020 2020 2020 2069  name]..        i
-0000ff70: 6620 6c6f 673a 0a20 2020 2020 2020 2020  f log:.         
-0000ff80: 2020 2061 6374 696f 6e73 203d 205b 5d0a     actions = [].
-0000ff90: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000ffa0: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
-0000ffb0: 2020 2068 6f76 6572 7320 3d20 5b5d 0a20     hovers = []. 
-0000ffc0: 2020 2020 2020 2020 2020 2079 7320 3d20             ys = 
-0000ffd0: 5b5d 0a20 2020 2020 2020 2020 2020 2063  [].            c
-0000ffe0: 6f6c 6f72 7320 3d20 5b5d 0a20 2020 2020  olors = [].     
-0000fff0: 2020 2020 2020 2066 6f72 206d 7367 5f74         for msg_t
-00010000: 696d 652c 206d 7367 2069 6e20 6c6f 673a  ime, msg in log:
-00010010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010020: 2074 696d 6573 2e61 7070 656e 6428 6d73   times.append(ms
-00010030: 675f 7469 6d65 202a 2031 3030 3029 0a20  g_time * 1000). 
-00010040: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010050: 6374 696f 6e20 3d20 6d73 675b 2261 6374  ction = msg["act
-00010060: 696f 6e22 5d0a 2020 2020 2020 2020 2020  ion"].          
-00010070: 2020 2020 2020 6163 7469 6f6e 732e 6170        actions.ap
-00010080: 7065 6e64 2861 6374 696f 6e29 0a20 2020  pend(action).   
-00010090: 2020 2020 2020 2020 2020 2020 2074 7279               try
-000100a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000100b0: 2020 2020 2020 7973 2e61 7070 656e 6428        ys.append(
-000100c0: 7365 6c66 2e61 6374 696f 6e5f 7973 5b61  self.action_ys[a
-000100d0: 6374 696f 6e5d 290a 2020 2020 2020 2020  ction]).        
-000100e0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-000100f0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00010100: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00010110: 662e 6163 7469 6f6e 5f79 735b 6163 7469  f.action_ys[acti
-00010120: 6f6e 5d20 3d20 6c65 6e28 7365 6c66 2e61  on] = len(self.a
-00010130: 6374 696f 6e5f 7973 290a 2020 2020 2020  ction_ys).      
-00010140: 2020 2020 2020 2020 2020 2020 2020 7973                ys
-00010150: 2e61 7070 656e 6428 7365 6c66 2e61 6374  .append(self.act
-00010160: 696f 6e5f 7973 5b61 6374 696f 6e5d 290a  ion_ys[action]).
-00010170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010180: 636f 6c6f 7273 2e61 7070 656e 6428 636f  colors.append(co
-00010190: 6c6f 725f 6f66 2861 6374 696f 6e29 290a  lor_of(action)).
-000101a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101b0: 686f 7665 7273 2e61 7070 656e 6428 2254  hovers.append("T
-000101c0: 4f44 4f22 290a 0a20 2020 2020 2020 2020  ODO")..         
-000101d0: 2020 206e 6577 203d 207b 0a20 2020 2020     new = {.     
-000101e0: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-000101f0: 223a 2074 696d 6573 2c0a 2020 2020 2020  ": times,.      
-00010200: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-00010210: 6e22 3a20 6163 7469 6f6e 732c 0a20 2020  n": actions,.   
-00010220: 2020 2020 2020 2020 2020 2020 2022 686f               "ho
-00010230: 7665 7222 3a20 686f 7665 7273 2c0a 2020  ver": hovers,.  
-00010240: 2020 2020 2020 2020 2020 2020 2020 2279                "y
-00010250: 223a 2079 732c 0a20 2020 2020 2020 2020  ": ys,.         
-00010260: 2020 2020 2020 2022 636f 6c6f 7222 3a20         "color": 
-00010270: 636f 6c6f 7273 2c0a 2020 2020 2020 2020  colors,.        
-00010280: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00010290: 2020 2069 6620 5052 4f46 494c 494e 473a     if PROFILING:
-000102a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000102b0: 2063 7572 646f 6328 292e 6164 645f 6e65   curdoc().add_ne
-000102c0: 7874 5f74 6963 6b5f 6361 6c6c 6261 636b  xt_tick_callback
-000102d0: 286c 616d 6264 613a 2073 656c 662e 736f  (lambda: self.so
-000102e0: 7572 6365 2e73 7472 6561 6d28 6e65 772c  urce.stream(new,
-000102f0: 2031 3030 3030 2929 0a20 2020 2020 2020   10000)).       
-00010300: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00010310: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010320: 736f 7572 6365 2e73 7472 6561 6d28 6e65  source.stream(ne
-00010330: 772c 2031 3030 3030 290a 0a0a 636c 6173  w, 10000)...clas
-00010340: 7320 5461 736b 5374 7265 616d 2844 6173  s TaskStream(Das
-00010350: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-00010360: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
-00010370: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-00010380: 6572 2c20 6e5f 7265 6374 616e 676c 6573  er, n_rectangles
-00010390: 3d31 3030 302c 2063 6c65 6172 5f69 6e74  =1000, clear_int
-000103a0: 6572 7661 6c3d 2232 3073 222c 202a 2a6b  erval="20s", **k
-000103b0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-000103c0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-000103d0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
-000103e0: 2020 2073 656c 662e 6f66 6673 6574 203d     self.offset =
-000103f0: 2030 0a0a 2020 2020 2020 2020 6966 2054   0..        if T
-00010400: 6173 6b53 7472 6561 6d50 6c75 6769 6e2e  askStreamPlugin.
-00010410: 6e61 6d65 206e 6f74 2069 6e20 7365 6c66  name not in self
-00010420: 2e73 6368 6564 756c 6572 2e70 6c75 6769  .scheduler.plugi
-00010430: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00010440: 7365 6c66 2e73 6368 6564 756c 6572 2e61  self.scheduler.a
-00010450: 6464 5f70 6c75 6769 6e28 5461 736b 5374  dd_plugin(TaskSt
-00010460: 7265 616d 506c 7567 696e 2873 656c 662e  reamPlugin(self.
-00010470: 7363 6865 6475 6c65 7229 290a 2020 2020  scheduler)).    
-00010480: 2020 2020 7365 6c66 2e70 6c75 6769 6e20      self.plugin 
-00010490: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-000104a0: 2e70 6c75 6769 6e73 5b54 6173 6b53 7472  .plugins[TaskStr
-000104b0: 6561 6d50 6c75 6769 6e2e 6e61 6d65 5d0a  eamPlugin.name].
-000104c0: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
-000104d0: 6465 7820 3d20 6d61 7828 302c 2073 656c  dex = max(0, sel
-000104e0: 662e 706c 7567 696e 2e69 6e64 6578 202d  f.plugin.index -
-000104f0: 206e 5f72 6563 7461 6e67 6c65 7329 0a20   n_rectangles). 
-00010500: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-00010510: 6572 7320 3d20 6469 6374 2829 0a20 2020  ers = dict().   
-00010520: 2020 2020 2073 656c 662e 6e5f 7265 6374       self.n_rect
-00010530: 616e 676c 6573 203d 206e 5f72 6563 7461  angles = n_recta
-00010540: 6e67 6c65 730a 2020 2020 2020 2020 636c  ngles.        cl
-00010550: 6561 725f 696e 7465 7276 616c 203d 2070  ear_interval = p
-00010560: 6172 7365 5f74 696d 6564 656c 7461 2863  arse_timedelta(c
-00010570: 6c65 6172 5f69 6e74 6572 7661 6c2c 2064  lear_interval, d
-00010580: 6566 6175 6c74 3d22 6d73 2229 0a20 2020  efault="ms").   
-00010590: 2020 2020 2073 656c 662e 636c 6561 725f       self.clear_
-000105a0: 696e 7465 7276 616c 203d 2063 6c65 6172  interval = clear
-000105b0: 5f69 6e74 6572 7661 6c0a 2020 2020 2020  _interval.      
-000105c0: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
-000105d0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-000105e0: 745f 7365 656e 203d 2030 0a0a 2020 2020  t_seen = 0..    
-000105f0: 2020 2020 7365 6c66 2e73 6f75 7263 652c      self.source,
-00010600: 2073 656c 662e 726f 6f74 203d 2074 6173   self.root = tas
-00010610: 6b5f 7374 7265 616d 5f66 6967 7572 6528  k_stream_figure(
-00010620: 636c 6561 725f 696e 7465 7276 616c 2c20  clear_interval, 
-00010630: 2a2a 6b77 6172 6773 290a 0a20 2020 2020  **kwargs)..     
-00010640: 2020 2023 2052 6571 7569 7265 6420 666f     # Required fo
-00010650: 7220 7570 6461 7465 2063 616c 6c62 6163  r update callbac
-00010660: 6b0a 2020 2020 2020 2020 7365 6c66 2e74  k.        self.t
-00010670: 6173 6b5f 7374 7265 616d 5f69 6e64 6578  ask_stream_index
-00010680: 203d 205b 305d 0a0a 2020 2020 4077 6974   = [0]..    @wit
-00010690: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-000106a0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-000106b0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-000106c0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-000106d0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-000106e0: 6e64 6578 203d 3d20 7365 6c66 2e70 6c75  ndex == self.plu
-000106f0: 6769 6e2e 696e 6465 783a 0a20 2020 2020  gin.index:.     
-00010700: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00010710: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00010720: 6e64 6578 2061 6e64 206c 656e 2873 656c  ndex and len(sel
-00010730: 662e 736f 7572 6365 2e64 6174 615b 2273  f.source.data["s
-00010740: 7461 7274 225d 293a 0a20 2020 2020 2020  tart"]):.       
-00010750: 2020 2020 2073 7461 7274 203d 206d 696e       start = min
-00010760: 2873 656c 662e 736f 7572 6365 2e64 6174  (self.source.dat
-00010770: 615b 2273 7461 7274 225d 290a 2020 2020  a["start"]).    
-00010780: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-00010790: 203d 206d 6178 2873 656c 662e 736f 7572   = max(self.sour
-000107a0: 6365 2e64 6174 615b 2264 7572 6174 696f  ce.data["duratio
-000107b0: 6e22 5d29 0a20 2020 2020 2020 2020 2020  n"]).           
-000107c0: 2062 6f75 6e64 6172 7920 3d20 2873 656c   boundary = (sel
-000107d0: 662e 6f66 6673 6574 202b 2073 7461 7274  f.offset + start
-000107e0: 202d 2064 7572 6174 696f 6e29 202f 2031   - duration) / 1
-000107f0: 3030 300a 2020 2020 2020 2020 656c 7365  000.        else
-00010800: 3a0a 2020 2020 2020 2020 2020 2020 626f  :.            bo
-00010810: 756e 6461 7279 203d 2073 656c 662e 6f66  undary = self.of
-00010820: 6673 6574 0a20 2020 2020 2020 2072 6563  fset.        rec
-00010830: 7461 6e67 6c65 7320 3d20 7365 6c66 2e70  tangles = self.p
-00010840: 6c75 6769 6e2e 7265 6374 616e 676c 6573  lugin.rectangles
-00010850: 280a 2020 2020 2020 2020 2020 2020 6973  (.            is
-00010860: 7461 7274 3d73 656c 662e 696e 6465 782c  tart=self.index,
-00010870: 2077 6f72 6b65 7273 3d73 656c 662e 776f   workers=self.wo
-00010880: 726b 6572 732c 2073 7461 7274 5f62 6f75  rkers, start_bou
-00010890: 6e64 6172 793d 626f 756e 6461 7279 0a20  ndary=boundary. 
-000108a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000108b0: 206e 203d 206c 656e 2872 6563 7461 6e67   n = len(rectang
-000108c0: 6c65 735b 226e 616d 6522 5d29 0a20 2020  les["name"]).   
-000108d0: 2020 2020 2073 656c 662e 696e 6465 7820       self.index 
-000108e0: 3d20 7365 6c66 2e70 6c75 6769 6e2e 696e  = self.plugin.in
-000108f0: 6465 780a 0a20 2020 2020 2020 2069 6620  dex..        if 
-00010900: 6e6f 7420 7265 6374 616e 676c 6573 5b22  not rectangles["
-00010910: 7374 6172 7422 5d3a 0a20 2020 2020 2020  start"]:.       
-00010920: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00010930: 2020 2020 2023 2049 6620 6974 2068 6173       # If it has
-00010940: 2062 6565 6e20 6120 7768 696c 6520 7369   been a while si
-00010950: 6e63 6520 7765 2776 6520 7570 6461 7465  nce we've update
-00010960: 6420 7468 6520 706c 6f74 0a20 2020 2020  d the plot.     
-00010970: 2020 2069 6620 7469 6d65 2829 203e 2073     if time() > s
-00010980: 656c 662e 6c61 7374 5f73 6565 6e20 2b20  elf.last_seen + 
-00010990: 7365 6c66 2e63 6c65 6172 5f69 6e74 6572  self.clear_inter
-000109a0: 7661 6c3a 0a20 2020 2020 2020 2020 2020  val:.           
-000109b0: 206e 6577 5f73 7461 7274 203d 206d 696e   new_start = min
-000109c0: 2872 6563 7461 6e67 6c65 735b 2273 7461  (rectangles["sta
-000109d0: 7274 225d 2920 2d20 7365 6c66 2e6f 6666  rt"]) - self.off
-000109e0: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
-000109f0: 6f6c 645f 7374 6172 7420 3d20 6d69 6e28  old_start = min(
-00010a00: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
-00010a10: 5b22 7374 6172 7422 5d29 0a20 2020 2020  ["start"]).     
-00010a20: 2020 2020 2020 206f 6c64 5f65 6e64 203d         old_end =
-00010a30: 206d 6178 280a 2020 2020 2020 2020 2020   max(.          
-00010a40: 2020 2020 2020 6d61 7028 0a20 2020 2020        map(.     
-00010a50: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00010a60: 7065 7261 746f 722e 6164 642c 0a20 2020  perator.add,.   
-00010a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a80: 2073 656c 662e 736f 7572 6365 2e64 6174   self.source.dat
-00010a90: 615b 2273 7461 7274 225d 2c0a 2020 2020  a["start"],.    
-00010aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ab0: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
-00010ac0: 5b22 6475 7261 7469 6f6e 225d 2c0a 2020  ["duration"],.  
-00010ad0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00010ae0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00010af0: 2020 2020 2020 2020 2020 2064 656e 7369             densi
-00010b00: 7479 203d 2028 0a20 2020 2020 2020 2020  ty = (.         
-00010b10: 2020 2020 2020 2073 756d 2873 656c 662e         sum(self.
-00010b20: 736f 7572 6365 2e64 6174 615b 2264 7572  source.data["dur
-00010b30: 6174 696f 6e22 5d29 0a20 2020 2020 2020  ation"]).       
-00010b40: 2020 2020 2020 2020 202f 206c 656e 2873           / len(s
-00010b50: 656c 662e 776f 726b 6572 7329 0a20 2020  elf.workers).   
-00010b60: 2020 2020 2020 2020 2020 2020 202f 2028               / (
-00010b70: 6f6c 645f 656e 6420 2d20 6f6c 645f 7374  old_end - old_st
-00010b80: 6172 7429 0a20 2020 2020 2020 2020 2020  art).           
-00010b90: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00010ba0: 2320 4966 2077 6869 7465 7370 6163 6520  # If whitespace 
-00010bb0: 6973 206d 6f72 6520 7468 616e 2033 7820  is more than 3x 
-00010bc0: 7468 6520 6f6c 6420 7769 6474 680a 2020  the old width.  
-00010bd0: 2020 2020 2020 2020 2020 6966 2028 6e65            if (ne
-00010be0: 775f 7374 6172 7420 2d20 6f6c 645f 656e  w_start - old_en
-00010bf0: 6429 203e 2028 6f6c 645f 656e 6420 2d20  d) > (old_end - 
-00010c00: 6f6c 645f 7374 6172 7429 202a 2032 206f  old_start) * 2 o
-00010c10: 7220 6465 6e73 6974 7920 3c20 302e 3035  r density < 0.05
-00010c20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010c30: 2020 7365 6c66 2e73 6f75 7263 652e 6461    self.source.da
-00010c40: 7461 2e75 7064 6174 6528 7b6b 3a20 5b5d  ta.update({k: []
-00010c50: 2066 6f72 206b 2069 6e20 7265 6374 616e   for k in rectan
-00010c60: 676c 6573 7d29 2020 2320 636c 6561 720a  gles})  # clear.
-00010c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c80: 7365 6c66 2e6f 6666 7365 7420 3d20 6d69  self.offset = mi
-00010c90: 6e28 7265 6374 616e 676c 6573 5b22 7374  n(rectangles["st
-00010ca0: 6172 7422 5d29 2020 2320 7265 6465 6669  art"])  # redefi
-00010cb0: 6e65 206f 6666 7365 740a 0a20 2020 2020  ne offset..     
-00010cc0: 2020 2072 6563 7461 6e67 6c65 735b 2273     rectangles["s
-00010cd0: 7461 7274 225d 203d 205b 7820 2d20 7365  tart"] = [x - se
-00010ce0: 6c66 2e6f 6666 7365 7420 666f 7220 7820  lf.offset for x 
-00010cf0: 696e 2072 6563 7461 6e67 6c65 735b 2273  in rectangles["s
-00010d00: 7461 7274 225d 5d0a 2020 2020 2020 2020  tart"]].        
-00010d10: 7365 6c66 2e6c 6173 745f 7365 656e 203d  self.last_seen =
-00010d20: 2074 696d 6528 290a 0a20 2020 2020 2020   time()..       
-00010d30: 2023 2043 6f6e 7665 7274 2074 6f20 6e75   # Convert to nu
-00010d40: 6d70 7920 666f 7220 7365 7269 616c 697a  mpy for serializ
-00010d50: 6174 696f 6e20 7370 6565 640a 2020 2020  ation speed.    
-00010d60: 2020 2020 6966 206e 203e 3d20 3130 2061      if n >= 10 a
-00010d70: 6e64 206e 703a 0a20 2020 2020 2020 2020  nd np:.         
-00010d80: 2020 2066 6f72 206b 2c20 7620 696e 2072     for k, v in r
-00010d90: 6563 7461 6e67 6c65 732e 6974 656d 7328  ectangles.items(
-00010da0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010db0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00010dc0: 2876 5b30 5d2c 204e 756d 6265 7229 3a0a  (v[0], Number):.
-00010dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010de0: 2020 2020 7265 6374 616e 676c 6573 5b6b      rectangles[k
-00010df0: 5d20 3d20 6e70 2e61 7272 6179 2876 290a  ] = np.array(v).
-00010e00: 0a20 2020 2020 2020 2069 6620 5052 4f46  .        if PROF
-00010e10: 494c 494e 473a 0a20 2020 2020 2020 2020  ILING:.         
-00010e20: 2020 2063 7572 646f 6328 292e 6164 645f     curdoc().add_
-00010e30: 6e65 7874 5f74 6963 6b5f 6361 6c6c 6261  next_tick_callba
-00010e40: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
-00010e50: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
-00010e60: 2e73 6f75 7263 652e 7374 7265 616d 2872  .source.stream(r
-00010e70: 6563 7461 6e67 6c65 732c 2073 656c 662e  ectangles, self.
-00010e80: 6e5f 7265 6374 616e 676c 6573 290a 2020  n_rectangles).  
-00010e90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010ea0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00010eb0: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
-00010ec0: 652e 7374 7265 616d 2872 6563 7461 6e67  e.stream(rectang
-00010ed0: 6c65 732c 2073 656c 662e 6e5f 7265 6374  les, self.n_rect
-00010ee0: 616e 676c 6573 290a 0a0a 6465 6620 7461  angles)...def ta
-00010ef0: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
-00010f00: 2863 6c65 6172 5f69 6e74 6572 7661 6c3d  (clear_interval=
-00010f10: 2232 3073 222c 202a 2a6b 7761 7267 7329  "20s", **kwargs)
-00010f20: 3a0a 2020 2020 2222 220a 2020 2020 6b77  :.    """.    kw
-00010f30: 6172 6773 2061 7265 2061 7070 6c69 6564  args are applied
-00010f40: 2074 6f20 7468 6520 626f 6b65 682e 6d6f   to the bokeh.mo
-00010f50: 6465 6c73 2e70 6c6f 7473 2e50 6c6f 7420  dels.plots.Plot 
-00010f60: 636f 6e73 7472 7563 746f 720a 2020 2020  constructor.    
-00010f70: 2222 220a 2020 2020 636c 6561 725f 696e  """.    clear_in
-00010f80: 7465 7276 616c 203d 2070 6172 7365 5f74  terval = parse_t
-00010f90: 696d 6564 656c 7461 2863 6c65 6172 5f69  imedelta(clear_i
-00010fa0: 6e74 6572 7661 6c2c 2064 6566 6175 6c74  nterval, default
-00010fb0: 3d22 6d73 2229 0a0a 2020 2020 736f 7572  ="ms")..    sour
-00010fc0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-00010fd0: 6f75 7263 6528 0a20 2020 2020 2020 2064  ource(.        d
-00010fe0: 6174 613d 6469 6374 280a 2020 2020 2020  ata=dict(.      
-00010ff0: 2020 2020 2020 7374 6172 743d 5b74 696d        start=[tim
-00011000: 6528 2920 2d20 636c 6561 725f 696e 7465  e() - clear_inte
-00011010: 7276 616c 5d2c 0a20 2020 2020 2020 2020  rval],.         
-00011020: 2020 2064 7572 6174 696f 6e3d 5b30 2e31     duration=[0.1
-00011030: 5d2c 0a20 2020 2020 2020 2020 2020 206b  ],.            k
-00011040: 6579 3d5b 2273 7461 7274 225d 2c0a 2020  ey=["start"],.  
-00011050: 2020 2020 2020 2020 2020 6e61 6d65 3d5b            name=[
-00011060: 2273 7461 7274 225d 2c0a 2020 2020 2020  "start"],.      
-00011070: 2020 2020 2020 636f 6c6f 723d 5b22 7768        color=["wh
-00011080: 6974 6522 5d2c 0a20 2020 2020 2020 2020  ite"],.         
-00011090: 2020 2064 7572 6174 696f 6e5f 7465 7874     duration_text
-000110a0: 3d5b 2231 3030 206d 7322 5d2c 0a20 2020  =["100 ms"],.   
-000110b0: 2020 2020 2020 2020 2077 6f72 6b65 723d           worker=
-000110c0: 5b22 666f 6f22 5d2c 0a20 2020 2020 2020  ["foo"],.       
-000110d0: 2020 2020 2079 3d5b 305d 2c0a 2020 2020       y=[0],.    
-000110e0: 2020 2020 2020 2020 776f 726b 6572 5f74          worker_t
-000110f0: 6872 6561 643d 5b31 5d2c 0a20 2020 2020  hread=[1],.     
-00011100: 2020 2020 2020 2061 6c70 6861 3d5b 302e         alpha=[0.
-00011110: 305d 2c0a 2020 2020 2020 2020 290a 2020  0],.        ).  
-00011120: 2020 290a 0a20 2020 2078 5f72 616e 6765    )..    x_range
-00011130: 203d 2044 6174 6152 616e 6765 3164 2872   = DataRange1d(r
-00011140: 616e 6765 5f70 6164 6469 6e67 3d30 290a  ange_padding=0).
-00011150: 2020 2020 795f 7261 6e67 6520 3d20 4461      y_range = Da
-00011160: 7461 5261 6e67 6531 6428 7261 6e67 655f  taRange1d(range_
-00011170: 7061 6464 696e 673d 3029 0a0a 2020 2020  padding=0)..    
-00011180: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
-00011190: 2020 2020 2020 206e 616d 653d 2274 6173         name="tas
-000111a0: 6b5f 7374 7265 616d 222c 0a20 2020 2020  k_stream",.     
-000111b0: 2020 2074 6974 6c65 3d22 5461 736b 2053     title="Task S
-000111c0: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
-000111d0: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
-000111e0: 0a20 2020 2020 2020 2079 5f72 616e 6765  .        y_range
-000111f0: 3d79 5f72 616e 6765 2c0a 2020 2020 2020  =y_range,.      
-00011200: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
-00011210: 6f6e 3d22 6162 6f76 6522 2c0a 2020 2020  on="above",.    
-00011220: 2020 2020 785f 6178 6973 5f74 7970 653d      x_axis_type=
-00011230: 2264 6174 6574 696d 6522 2c0a 2020 2020  "datetime",.    
-00011240: 2020 2020 795f 6178 6973 5f6c 6f63 6174      y_axis_locat
-00011250: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
-00011260: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
-00011270: 2020 2020 6d69 6e5f 626f 7264 6572 5f62      min_border_b
-00011280: 6f74 746f 6d3d 3530 2c0a 2020 2020 2020  ottom=50,.      
-00011290: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-000112a0: 290a 0a20 2020 2072 6563 7420 3d20 726f  )..    rect = ro
-000112b0: 6f74 2e72 6563 7428 0a20 2020 2020 2020  ot.rect(.       
-000112c0: 2073 6f75 7263 653d 736f 7572 6365 2c0a   source=source,.
-000112d0: 2020 2020 2020 2020 783d 2273 7461 7274          x="start
-000112e0: 222c 0a20 2020 2020 2020 2079 3d22 7922  ",.        y="y"
-000112f0: 2c0a 2020 2020 2020 2020 7769 6474 683d  ,.        width=
-00011300: 2264 7572 6174 696f 6e22 2c0a 2020 2020  "duration",.    
-00011310: 2020 2020 6865 6967 6874 3d30 2e34 2c0a      height=0.4,.
-00011320: 2020 2020 2020 2020 6669 6c6c 5f63 6f6c          fill_col
-00011330: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
-00011340: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
-00011350: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
-00011360: 6c69 6e65 5f61 6c70 6861 3d30 2e36 2c0a  line_alpha=0.6,.
-00011370: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
-00011380: 6861 3d22 616c 7068 6122 2c0a 2020 2020  ha="alpha",.    
-00011390: 2020 2020 6c69 6e65 5f77 6964 7468 3d33      line_width=3
-000113a0: 2c0a 2020 2020 290a 2020 2020 7265 6374  ,.    ).    rect
-000113b0: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
-000113c0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
-000113d0: 726f 6f74 2e79 6178 6973 2e6d 616a 6f72  root.yaxis.major
-000113e0: 5f6c 6162 656c 5f74 6578 745f 616c 7068  _label_text_alph
-000113f0: 6120 3d20 300a 2020 2020 726f 6f74 2e79  a = 0.    root.y
-00011400: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-00011410: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-00011420: 2020 2072 6f6f 742e 7961 7869 732e 6d61     root.yaxis.ma
-00011430: 6a6f 725f 7469 636b 5f6c 696e 655f 616c  jor_tick_line_al
-00011440: 7068 6120 3d20 300a 2020 2020 726f 6f74  pha = 0.    root
-00011450: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
-00011460: 2046 616c 7365 0a0a 2020 2020 686f 7665   False..    hove
-00011470: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
-00011480: 2020 2020 2020 2070 6f69 6e74 5f70 6f6c         point_pol
-00011490: 6963 793d 2266 6f6c 6c6f 775f 6d6f 7573  icy="follow_mous
-000114a0: 6522 2c0a 2020 2020 2020 2020 746f 6f6c  e",.        tool
-000114b0: 7469 7073 3d22 2222 0a20 2020 2020 2020  tips=""".       
-000114c0: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-000114d0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-000114e0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-000114f0: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-00011500: 6967 6874 3a20 626f 6c64 3b22 3e40 6e61  ight: bold;">@na
-00011510: 6d65 3a3c 2f73 7061 6e3e 266e 6273 703b  me:</span>&nbsp;
-00011520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011530: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00011540: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-00011550: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-00011560: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-00011570: 4064 7572 6174 696f 6e5f 7465 7874 3c2f  @duration_text</
-00011580: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-00011590: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-000115a0: 2020 2020 2022 2222 2c0a 2020 2020 290a       """,.    ).
-000115b0: 0a20 2020 2074 6170 203d 2054 6170 546f  .    tap = TapTo
-000115c0: 6f6c 2863 616c 6c62 6163 6b3d 4f70 656e  ol(callback=Open
-000115d0: 5552 4c28 7572 6c3d 222e 2f70 726f 6669  URL(url="./profi
-000115e0: 6c65 3f6b 6579 3d40 6e61 6d65 2229 290a  le?key=@name")).
-000115f0: 2020 2020 6865 6c70 5f20 3d20 4865 6c70      help_ = Help
-00011600: 546f 6f6c 280a 2020 2020 2020 2020 7265  Tool(.        re
-00011610: 6469 7265 6374 3d22 6874 7470 733a 2f2f  direct="https://
-00011620: 646f 6373 2e64 6173 6b2e 6f72 672f 656e  docs.dask.org/en
-00011630: 2f73 7461 626c 652f 6461 7368 626f 6172  /stable/dashboar
-00011640: 642e 6874 6d6c 2374 6173 6b2d 7374 7265  d.html#task-stre
-00011650: 616d 222c 0a20 2020 2020 2020 2064 6573  am",.        des
-00011660: 6372 6970 7469 6f6e 3d22 4120 6465 7363  cription="A desc
-00011670: 7269 7074 696f 6e20 6f66 2074 6865 2054  ription of the T
-00011680: 6173 6b53 7472 6561 6d20 616e 6420 6974  askStream and it
-00011690: 7320 636f 6c6f 7220 7061 6c65 7474 652e  s color palette.
-000116a0: 222c 0a20 2020 2029 0a20 2020 2072 6f6f  ",.    ).    roo
-000116b0: 742e 6164 645f 746f 6f6c 7328 0a20 2020  t.add_tools(.   
-000116c0: 2020 2020 2068 6f76 6572 2c0a 2020 2020       hover,.    
-000116d0: 2020 2020 7461 702c 0a20 2020 2020 2020      tap,.       
-000116e0: 2042 6f78 5a6f 6f6d 546f 6f6c 2829 2c0a   BoxZoomTool(),.
-000116f0: 2020 2020 2020 2020 5265 7365 7454 6f6f          ResetToo
-00011700: 6c28 292c 0a20 2020 2020 2020 2050 616e  l(),.        Pan
-00011710: 546f 6f6c 2864 696d 656e 7369 6f6e 733d  Tool(dimensions=
-00011720: 2277 6964 7468 2229 2c0a 2020 2020 2020  "width"),.      
-00011730: 2020 5768 6565 6c5a 6f6f 6d54 6f6f 6c28    WheelZoomTool(
-00011740: 6469 6d65 6e73 696f 6e73 3d22 7769 6474  dimensions="widt
-00011750: 6822 292c 0a20 2020 2020 2020 2068 656c  h"),.        hel
-00011760: 705f 2c0a 2020 2020 290a 2020 2020 6966  p_,.    ).    if
-00011770: 2045 7870 6f72 7454 6f6f 6c3a 2020 2320   ExportTool:  # 
-00011780: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00011790: 2020 2020 2065 7870 6f72 7420 3d20 4578       export = Ex
-000117a0: 706f 7274 546f 6f6c 2829 0a20 2020 2020  portTool().     
-000117b0: 2020 2065 7870 6f72 742e 7265 6769 7374     export.regist
-000117c0: 6572 5f70 6c6f 7428 726f 6f74 290a 2020  er_plot(root).  
-000117d0: 2020 2020 2020 726f 6f74 2e61 6464 5f74        root.add_t
-000117e0: 6f6f 6c73 2865 7870 6f72 7429 0a0a 2020  ools(export)..  
-000117f0: 2020 7265 7475 726e 2073 6f75 7263 652c    return source,
-00011800: 2072 6f6f 740a 0a0a 636c 6173 7320 5461   root...class Ta
-00011810: 736b 4772 6170 6828 4461 7368 626f 6172  skGraph(Dashboar
-00011820: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-00011830: 2022 2222 0a20 2020 2041 2064 796e 616d   """.    A dynam
-00011840: 6963 206e 6f64 652d 6c69 6e6b 2064 6961  ic node-link dia
-00011850: 6772 616d 2066 6f72 2074 6865 2074 6173  gram for the tas
-00011860: 6b20 6772 6170 6820 6f6e 2074 6865 2073  k graph on the s
-00011870: 6368 6564 756c 6572 0a0a 2020 2020 5365  cheduler..    Se
-00011880: 6520 616c 736f 2074 6865 2047 7261 7068  e also the Graph
-00011890: 4c61 796f 7574 2064 6961 676e 6f73 7469  Layout diagnosti
-000118a0: 6320 6174 0a20 2020 2064 6973 7472 6962  c at.    distrib
-000118b0: 7574 6564 2f64 6961 676e 6f73 7469 6373  uted/diagnostics
-000118c0: 2f67 7261 7068 5f6c 6179 6f75 742e 7079  /graph_layout.py
-000118d0: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-000118e0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-000118f0: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
-00011900: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-00011910: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
-00011920: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-00011930: 2020 7365 6c66 2e6c 6179 6f75 7420 3d20    self.layout = 
-00011940: 4772 6170 684c 6179 6f75 7428 7363 6865  GraphLayout(sche
-00011950: 6475 6c65 7229 0a20 2020 2020 2020 2073  duler).        s
-00011960: 6368 6564 756c 6572 2e61 6464 5f70 6c75  cheduler.add_plu
-00011970: 6769 6e28 7365 6c66 2e6c 6179 6f75 7429  gin(self.layout)
-00011980: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
-00011990: 7669 7369 626c 655f 636f 756e 7420 3d20  visible_count = 
-000119a0: 3020 2023 206e 756d 6265 7220 6f66 2069  0  # number of i
-000119b0: 6e76 6973 6962 6c65 206e 6f64 6573 0a0a  nvisible nodes..
-000119c0: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
-000119d0: 655f 736f 7572 6365 203d 2043 6f6c 756d  e_source = Colum
-000119e0: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
-000119f0: 2020 2020 2020 2020 207b 2278 223a 205b           {"x": [
-00011a00: 5d2c 2022 7922 3a20 5b5d 2c20 226e 616d  ], "y": [], "nam
-00011a10: 6522 3a20 5b5d 2c20 2273 7461 7465 223a  e": [], "state":
-00011a20: 205b 5d2c 2022 7669 7369 626c 6522 3a20   [], "visible": 
-00011a30: 5b5d 2c20 226b 6579 223a 205b 5d7d 0a20  [], "key": []}. 
-00011a40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00011a50: 2073 656c 662e 6564 6765 5f73 6f75 7263   self.edge_sourc
-00011a60: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
-00011a70: 7572 6365 287b 2278 223a 205b 5d2c 2022  urce({"x": [], "
-00011a80: 7922 3a20 5b5d 2c20 2276 6973 6962 6c65  y": [], "visible
-00011a90: 223a 205b 5d7d 290a 0a20 2020 2020 2020  ": []})..       
-00011aa0: 2066 696c 7465 7220 3d20 4772 6f75 7046   filter = GroupF
-00011ab0: 696c 7465 7228 636f 6c75 6d6e 5f6e 616d  ilter(column_nam
-00011ac0: 653d 2276 6973 6962 6c65 222c 2067 726f  e="visible", gro
-00011ad0: 7570 3d22 5472 7565 2229 0a20 2020 2020  up="True").     
-00011ae0: 2020 2069 6620 424f 4b45 485f 5645 5253     if BOKEH_VERS
-00011af0: 494f 4e2e 6d61 6a6f 7220 3c20 333a 0a20  ION.major < 3:. 
-00011b00: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00011b10: 725f 6b77 6172 6773 203d 207b 2266 696c  r_kwargs = {"fil
-00011b20: 7465 7273 223a 205b 6669 6c74 6572 5d7d  ters": [filter]}
-00011b30: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00011b40: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00011b50: 725f 6b77 6172 6773 203d 207b 2266 696c  r_kwargs = {"fil
-00011b60: 7465 7222 3a20 6669 6c74 6572 7d0a 2020  ter": filter}.  
-00011b70: 2020 2020 2020 6e6f 6465 5f76 6965 7720        node_view 
-00011b80: 3d20 4344 5356 6965 7728 2a2a 6669 6c74  = CDSView(**filt
-00011b90: 6572 5f6b 7761 7267 7329 0a20 2020 2020  er_kwargs).     
-00011ba0: 2020 2065 6467 655f 7669 6577 203d 2043     edge_view = C
-00011bb0: 4453 5669 6577 282a 2a66 696c 7465 725f  DSView(**filter_
-00011bc0: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
-00011bd0: 2023 2042 6f6b 6568 203e 3d20 332e 3020   # Bokeh >= 3.0 
-00011be0: 6175 746f 6d61 7469 6361 6c6c 7920 696e  automatically in
-00011bf0: 6665 7273 2074 6865 2073 6f75 7263 6520  fers the source 
-00011c00: 746f 2075 7365 0a20 2020 2020 2020 2069  to use.        i
-00011c10: 6620 424f 4b45 485f 5645 5253 494f 4e2e  f BOKEH_VERSION.
-00011c20: 6d61 6a6f 7220 3c20 333a 0a20 2020 2020  major < 3:.     
-00011c30: 2020 2020 2020 206e 6f64 655f 7669 6577         node_view
-00011c40: 2e73 6f75 7263 6520 3d20 7365 6c66 2e6e  .source = self.n
-00011c50: 6f64 655f 736f 7572 6365 0a20 2020 2020  ode_source.     
-00011c60: 2020 2020 2020 2065 6467 655f 7669 6577         edge_view
-00011c70: 2e73 6f75 7263 6520 3d20 7365 6c66 2e65  .source = self.e
-00011c80: 6467 655f 736f 7572 6365 0a0a 2020 2020  dge_source..    
-00011c90: 2020 2020 6e6f 6465 5f63 6f6c 6f72 7320      node_colors 
-00011ca0: 3d20 6661 6374 6f72 5f63 6d61 7028 0a20  = factor_cmap(. 
-00011cb0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00011cc0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00011cd0: 6661 6374 6f72 733d 5b22 7761 6974 696e  factors=["waitin
-00011ce0: 6722 2c20 2271 7565 7565 6422 2c20 2270  g", "queued", "p
-00011cf0: 726f 6365 7373 696e 6722 2c20 226d 656d  rocessing", "mem
-00011d00: 6f72 7922 2c20 2272 656c 6561 7365 6422  ory", "released"
-00011d10: 2c20 2265 7272 6564 225d 2c0a 2020 2020  , "erred"],.    
-00011d20: 2020 2020 2020 2020 7061 6c65 7474 653d          palette=
-00011d30: 5b22 6772 6179 222c 2022 7965 6c6c 6f77  ["gray", "yellow
-00011d40: 222c 2022 6772 6565 6e22 2c20 2272 6564  ", "green", "red
-00011d50: 222c 2022 626c 7565 222c 2022 626c 6163  ", "blue", "blac
-00011d60: 6b22 5d2c 0a20 2020 2020 2020 2029 0a0a  k"],.        )..
-00011d70: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00011d80: 7420 3d20 6669 6775 7265 2874 6974 6c65  t = figure(title
-00011d90: 3d22 5461 736b 2047 7261 7068 222c 202a  ="Task Graph", *
-00011da0: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-00011db0: 2073 656c 662e 7375 6274 6974 6c65 203d   self.subtitle =
-00011dc0: 2054 6974 6c65 2874 6578 743d 2220 222c   Title(text=" ",
-00011dd0: 2074 6578 745f 666f 6e74 5f73 7479 6c65   text_font_style
-00011de0: 3d22 6974 616c 6963 2229 0a20 2020 2020  ="italic").     
-00011df0: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
-00011e00: 5f6c 6179 6f75 7428 7365 6c66 2e73 7562  _layout(self.sub
-00011e10: 7469 746c 652c 2022 6162 6f76 6522 290a  title, "above").
-00011e20: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00011e30: 6f74 2e6d 756c 7469 5f6c 696e 6528 0a20  ot.multi_line(. 
-00011e40: 2020 2020 2020 2020 2020 2078 733d 2278             xs="x
-00011e50: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-00011e60: 733d 2279 222c 0a20 2020 2020 2020 2020  s="y",.         
-00011e70: 2020 2073 6f75 7263 653d 7365 6c66 2e65     source=self.e
-00011e80: 6467 655f 736f 7572 6365 2c0a 2020 2020  dge_source,.    
-00011e90: 2020 2020 2020 2020 6c69 6e65 5f77 6964          line_wid
-00011ea0: 7468 3d31 2c0a 2020 2020 2020 2020 2020  th=1,.          
-00011eb0: 2020 7669 6577 3d65 6467 655f 7669 6577    view=edge_view
-00011ec0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-00011ed0: 6c6f 723d 2262 6c61 636b 222c 0a20 2020  lor="black",.   
-00011ee0: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
-00011ef0: 2e33 2c0a 2020 2020 2020 2020 290a 2020  .3,.        ).  
-00011f00: 2020 2020 2020 7265 6374 203d 2073 656c        rect = sel
-00011f10: 662e 726f 6f74 2e73 7175 6172 6528 0a20  f.root.square(. 
-00011f20: 2020 2020 2020 2020 2020 2078 3d22 7822             x="x"
-00011f30: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
-00011f40: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
-00011f50: 2073 697a 653d 3130 2c0a 2020 2020 2020   size=10,.      
-00011f60: 2020 2020 2020 636f 6c6f 723d 6e6f 6465        color=node
-00011f70: 5f63 6f6c 6f72 732c 0a20 2020 2020 2020  _colors,.       
-00011f80: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00011f90: 2e6e 6f64 655f 736f 7572 6365 2c0a 2020  .node_source,.  
-00011fa0: 2020 2020 2020 2020 2020 7669 6577 3d6e            view=n
-00011fb0: 6f64 655f 7669 6577 2c0a 2020 2020 2020  ode_view,.      
-00011fc0: 2020 2020 2020 6c65 6765 6e64 5f66 6965        legend_fie
-00011fd0: 6c64 3d22 7374 6174 6522 2c0a 2020 2020  ld="state",.    
-00011fe0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00011ff0: 6c66 2e72 6f6f 742e 7867 7269 642e 6772  lf.root.xgrid.gr
-00012000: 6964 5f6c 696e 655f 636f 6c6f 7220 3d20  id_line_color = 
-00012010: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-00012020: 662e 726f 6f74 2e79 6772 6964 2e67 7269  f.root.ygrid.gri
-00012030: 645f 6c69 6e65 5f63 6f6c 6f72 203d 204e  d_line_color = N
-00012040: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-00012050: 2e72 6f6f 742e 7861 7869 732e 7669 7369  .root.xaxis.visi
-00012060: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00012070: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
-00012080: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-00012090: 6c73 650a 0a20 2020 2020 2020 2068 6f76  lse..        hov
-000120a0: 6572 203d 2048 6f76 6572 546f 6f6c 280a  er = HoverTool(.
-000120b0: 2020 2020 2020 2020 2020 2020 706f 696e              poin
-000120c0: 745f 706f 6c69 6379 3d22 666f 6c6c 6f77  t_policy="follow
-000120d0: 5f6d 6f75 7365 222c 0a20 2020 2020 2020  _mouse",.       
-000120e0: 2020 2020 2074 6f6f 6c74 6970 733d 223c       tooltips="<
-000120f0: 623e 406e 616d 653c 2f62 3e3a 2040 7374  b>@name</b>: @st
-00012100: 6174 6522 2c0a 2020 2020 2020 2020 2020  ate",.          
-00012110: 2020 7265 6e64 6572 6572 733d 5b72 6563    renderers=[rec
-00012120: 745d 2c0a 2020 2020 2020 2020 290a 2020  t],.        ).  
-00012130: 2020 2020 2020 7461 7020 3d20 5461 7054        tap = TapT
-00012140: 6f6f 6c28 6361 6c6c 6261 636b 3d4f 7065  ool(callback=Ope
-00012150: 6e55 524c 2875 726c 3d22 696e 666f 2f74  nURL(url="info/t
-00012160: 6173 6b2f 406b 6579 2e68 746d 6c22 292c  ask/@key.html"),
-00012170: 2072 656e 6465 7265 7273 3d5b 7265 6374   renderers=[rect
-00012180: 5d29 0a20 2020 2020 2020 2072 6563 742e  ]).        rect.
-00012190: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
-000121a0: 7068 203d 204e 6f6e 650a 2020 2020 2020  ph = None.      
-000121b0: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-000121c0: 746f 6f6c 7328 686f 7665 722c 2074 6170  tools(hover, tap
-000121d0: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
-000121e0: 6178 5f69 7465 6d73 203d 2063 6f6e 6669  ax_items = confi
-000121f0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-00012200: 6564 2e64 6173 6862 6f61 7264 2e67 7261  ed.dashboard.gra
-00012210: 7068 2d6d 6178 2d69 7465 6d73 222c 2035  ph-max-items", 5
-00012220: 3030 3029 0a0a 2020 2020 4077 6974 686f  000)..    @witho
-00012230: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00012240: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-00012250: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-00012260: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-00012270: 2020 2020 2023 2049 6620 7468 6572 6520       # If there 
-00012280: 6172 6520 746f 6f20 6d61 6e79 2074 6173  are too many tas
-00012290: 6b73 2069 6e20 7468 6520 7363 6865 6475  ks in the schedu
-000122a0: 6c65 7220 7765 276c 6c20 6469 7361 626c  ler we'll disabl
-000122b0: 6520 7468 6973 0a20 2020 2020 2020 2023  e this.        #
-000122c0: 2063 6f6d 706f 6f6e 656e 7473 2074 6f20   compoonents to 
-000122d0: 6e6f 7420 6f76 6572 6c6f 6164 2073 6368  not overload sch
-000122e0: 6564 756c 6572 206f 7220 636c 6965 6e74  eduler or client
-000122f0: 2e20 4f6e 6365 2077 6520 6472 6f70 0a20  . Once we drop. 
-00012300: 2020 2020 2020 2023 2062 656c 6f77 2074         # below t
-00012310: 6865 2074 6872 6573 686f 6c64 2c20 7468  he threshold, th
-00012320: 6520 6461 7461 2069 7320 6669 6c6c 6564  e data is filled
-00012330: 2075 7020 6167 6169 6e20 6173 2075 7375   up again as usu
-00012340: 616c 0a20 2020 2020 2020 2069 6620 6c65  al.        if le
-00012350: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
-00012360: 2e74 6173 6b73 2920 3e20 7365 6c66 2e6d  .tasks) > self.m
-00012370: 6178 5f69 7465 6d73 3a0a 2020 2020 2020  ax_items:.      
-00012380: 2020 2020 2020 7365 6c66 2e73 7562 7469        self.subti
-00012390: 746c 652e 7465 7874 203d 2022 5363 6865  tle.text = "Sche
-000123a0: 6475 6c65 7220 6861 7320 746f 6f20 6d61  duler has too ma
-000123b0: 6e79 2074 6173 6b73 2074 6f20 6469 7370  ny tasks to disp
-000123c0: 6c61 792e 220a 2020 2020 2020 2020 2020  lay.".          
-000123d0: 2020 666f 7220 636f 6e74 6169 6e65 7220    for container 
-000123e0: 696e 205b 7365 6c66 2e6e 6f64 655f 736f  in [self.node_so
-000123f0: 7572 6365 2c20 7365 6c66 2e65 6467 655f  urce, self.edge_
-00012400: 736f 7572 6365 5d3a 0a20 2020 2020 2020  source]:.       
-00012410: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
-00012420: 6572 2e64 6174 6120 3d20 7b63 6f6c 3a20  er.data = {col: 
-00012430: 5b5d 2066 6f72 2063 6f6c 2069 6e20 636f  [] for col in co
-00012440: 6e74 6169 6e65 722e 636f 6c75 6d6e 5f6e  ntainer.column_n
-00012450: 616d 6573 7d0a 2020 2020 2020 2020 656c  ames}.        el
-00012460: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012470: 2320 6f63 6361 7369 6f6e 616c 6c79 2072  # occasionally r
-00012480: 6573 6574 2074 6865 2063 6f6c 756d 6e20  eset the column 
-00012490: 6461 7461 2073 6f75 7263 6520 746f 2072  data source to r
-000124a0: 656d 6f76 6520 6f6c 6420 6e6f 6465 730a  emove old nodes.
-000124b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000124c0: 656c 662e 696e 7669 7369 626c 655f 636f  elf.invisible_co
-000124d0: 756e 7420 3e20 6c65 6e28 7365 6c66 2e6e  unt > len(self.n
-000124e0: 6f64 655f 736f 7572 6365 2e64 6174 615b  ode_source.data[
-000124f0: 2278 225d 2920 2f20 323a 0a20 2020 2020  "x"]) / 2:.     
-00012500: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00012510: 6c61 796f 7574 2e72 6573 6574 5f69 6e64  layout.reset_ind
-00012520: 6578 2829 0a20 2020 2020 2020 2020 2020  ex().           
-00012530: 2020 2020 2073 656c 662e 696e 7669 7369       self.invisi
-00012540: 626c 655f 636f 756e 7420 3d20 300a 2020  ble_count = 0.  
-00012550: 2020 2020 2020 2020 2020 2020 2020 7570                up
-00012560: 6461 7465 203d 2054 7275 650a 2020 2020  date = True.    
-00012570: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00012580: 2020 2020 2020 2020 2020 2020 2020 7570                up
-00012590: 6461 7465 203d 2046 616c 7365 0a0a 2020  date = False..  
-000125a0: 2020 2020 2020 2020 2020 6e65 772c 2073            new, s
-000125b0: 656c 662e 6c61 796f 7574 2e6e 6577 203d  elf.layout.new =
-000125c0: 2073 656c 662e 6c61 796f 7574 2e6e 6577   self.layout.new
-000125d0: 2c20 5b5d 0a20 2020 2020 2020 2020 2020  , [].           
-000125e0: 206e 6577 5f65 6467 6573 203d 2073 656c   new_edges = sel
-000125f0: 662e 6c61 796f 7574 2e6e 6577 5f65 6467  f.layout.new_edg
-00012600: 6573 0a20 2020 2020 2020 2020 2020 2073  es.            s
-00012610: 656c 662e 6c61 796f 7574 2e6e 6577 5f65  elf.layout.new_e
-00012620: 6467 6573 203d 205b 5d0a 0a20 2020 2020  dges = []..     
-00012630: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-00012640: 6e65 775f 6e6f 6465 735f 6564 6765 7328  new_nodes_edges(
-00012650: 6e65 772c 206e 6577 5f65 6467 6573 2c20  new, new_edges, 
-00012660: 7570 6461 7465 3d75 7064 6174 6529 0a0a  update=update)..
-00012670: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012680: 2e70 6174 6368 5f75 7064 6174 6573 2829  .patch_updates()
-00012690: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-000126a0: 206c 656e 2873 656c 662e 7363 6865 6475   len(self.schedu
-000126b0: 6c65 722e 7461 736b 7329 203d 3d20 303a  ler.tasks) == 0:
-000126c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000126d0: 2073 656c 662e 7375 6274 6974 6c65 2e74   self.subtitle.t
-000126e0: 6578 7420 3d20 2253 6368 6564 756c 6572  ext = "Scheduler
-000126f0: 2069 7320 656d 7074 792e 220a 2020 2020   is empty.".    
-00012700: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00012710: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00012720: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
-00012730: 203d 2022 2022 0a0a 2020 2020 4077 6974   = " "..    @wit
-00012740: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-00012750: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
-00012760: 2061 6464 5f6e 6577 5f6e 6f64 6573 5f65   add_new_nodes_e
-00012770: 6467 6573 2873 656c 662c 206e 6577 2c20  dges(self, new, 
-00012780: 6e65 775f 6564 6765 732c 2075 7064 6174  new_edges, updat
-00012790: 653d 4661 6c73 6529 3a0a 2020 2020 2020  e=False):.      
-000127a0: 2020 6966 206e 6577 206f 7220 7570 6461    if new or upda
-000127b0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-000127c0: 6e6f 6465 5f6b 6579 203d 205b 5d0a 2020  node_key = [].  
-000127d0: 2020 2020 2020 2020 2020 6e6f 6465 5f78            node_x
-000127e0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-000127f0: 2020 6e6f 6465 5f79 203d 205b 5d0a 2020    node_y = [].  
-00012800: 2020 2020 2020 2020 2020 6e6f 6465 5f73            node_s
-00012810: 7461 7465 203d 205b 5d0a 2020 2020 2020  tate = [].      
-00012820: 2020 2020 2020 6e6f 6465 5f6e 616d 6520        node_name 
-00012830: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00012840: 2065 6467 655f 7820 3d20 5b5d 0a20 2020   edge_x = [].   
-00012850: 2020 2020 2020 2020 2065 6467 655f 7920           edge_y 
-00012860: 3d20 5b5d 0a0a 2020 2020 2020 2020 2020  = []..          
-00012870: 2020 7820 3d20 7365 6c66 2e6c 6179 6f75    x = self.layou
-00012880: 742e 780a 2020 2020 2020 2020 2020 2020  t.x.            
-00012890: 7920 3d20 7365 6c66 2e6c 6179 6f75 742e  y = self.layout.
-000128a0: 790a 0a20 2020 2020 2020 2020 2020 2074  y..            t
-000128b0: 6173 6b73 203d 2073 656c 662e 7363 6865  asks = self.sche
-000128c0: 6475 6c65 722e 7461 736b 730a 2020 2020  duler.tasks.    
-000128d0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-000128e0: 696e 206e 6577 3a0a 2020 2020 2020 2020  in new:.        
-000128f0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00012900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012910: 2074 6173 6b20 3d20 7461 736b 735b 6b65   task = tasks[ke
-00012920: 795d 0a20 2020 2020 2020 2020 2020 2020  y].             
-00012930: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-00012940: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00012950: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00012960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012970: 2078 7820 3d20 785b 6b65 795d 0a20 2020   xx = x[key].   
-00012980: 2020 2020 2020 2020 2020 2020 2079 7920               yy 
-00012990: 3d20 795b 6b65 795d 0a20 2020 2020 2020  = y[key].       
-000129a0: 2020 2020 2020 2020 206e 6f64 655f 6b65           node_ke
-000129b0: 792e 6170 7065 6e64 2865 7363 6170 652e  y.append(escape.
-000129c0: 7572 6c5f 6573 6361 7065 286b 6579 2929  url_escape(key))
+0000d9a0: 223a 205b 6e62 7974 6573 5b6e 616d 655d  ": [nbytes[name]
+0000d9b0: 2066 6f72 206e 616d 6520 696e 206e 616d   for name in nam
+0000d9c0: 6573 5d2c 0a20 2020 2020 2020 2020 2020  es],.           
+0000d9d0: 2022 6e62 7974 6573 5f74 6578 7422 3a20   "nbytes_text": 
+0000d9e0: 5b66 6f72 6d61 745f 6279 7465 7328 6e62  [format_bytes(nb
+0000d9f0: 7974 6573 5b6e 616d 655d 2920 666f 7220  ytes[name]) for 
+0000da00: 6e61 6d65 2069 6e20 6e61 6d65 735d 2c0a  name in names],.
+0000da10: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
+0000da20: 6f72 223a 205b 636f 6c6f 725f 6f66 286e  or": [color_of(n
+0000da30: 616d 6529 2066 6f72 206e 616d 6520 696e  ame) for name in
+0000da40: 206e 616d 6573 5d2c 0a20 2020 2020 2020   names],.       
+0000da50: 207d 0a20 2020 2020 2020 2073 656c 662e   }.        self.
+0000da60: 726f 6f74 2e74 6974 6c65 2e74 6578 7420  root.title.text 
+0000da70: 3d20 2254 6f74 616c 2055 7365 3a20 2220  = "Total Use: " 
+0000da80: 2b20 666f 726d 6174 5f62 7974 6573 2873  + format_bytes(s
+0000da90: 756d 286e 6279 7465 732e 7661 6c75 6573  um(nbytes.values
+0000daa0: 2829 2929 0a0a 2020 2020 2020 2020 7570  ()))..        up
+0000dab0: 6461 7465 2873 656c 662e 736f 7572 6365  date(self.source
+0000dac0: 2c20 7265 7375 6c74 290a 0a0a 636c 6173  , result)...clas
+0000dad0: 7320 4375 7272 656e 744c 6f61 6428 4461  s CurrentLoad(Da
+0000dae0: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
+0000daf0: 293a 0a20 2020 2022 2222 5461 736b 7320  ):.    """Tasks 
+0000db00: 616e 6420 4350 5520 7573 6167 6520 6f6e  and CPU usage on
+0000db10: 2065 6163 6820 776f 726b 6572 2222 220a   each worker""".
+0000db20: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+0000db30: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000db40: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+0000db50: 722c 2077 6964 7468 3d36 3030 2c20 2a2a  r, width=600, **
+0000db60: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0000db70: 2073 656c 662e 6c61 7374 203d 2030 0a20   self.last = 0. 
+0000db80: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+0000db90: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+0000dba0: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
+0000dbb0: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+0000dbc0: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
+0000dbd0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0000dbe0: 2020 2020 2020 2020 226e 7072 6f63 6573          "nproces
+0000dbf0: 7369 6e67 223a 205b 5d2c 0a20 2020 2020  sing": [],.     
+0000dc00: 2020 2020 2020 2020 2020 2022 6e70 726f             "npro
+0000dc10: 6365 7373 696e 672d 6861 6c66 223a 205b  cessing-half": [
+0000dc20: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000dc30: 2020 2022 6e70 726f 6365 7373 696e 672d     "nprocessing-
+0000dc40: 636f 6c6f 7222 3a20 5b5d 2c0a 2020 2020  color": [],.    
+0000dc50: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
+0000dc60: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+0000dc70: 2020 2020 2020 2022 6370 752d 6861 6c66         "cpu-half
+0000dc80: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+0000dc90: 2020 2020 2020 2022 7922 3a20 5b5d 2c0a         "y": [],.
+0000dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dcb0: 2277 6f72 6b65 7222 3a20 5b5d 2c0a 2020  "worker": [],.  
+0000dcc0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+0000dcd0: 7363 6170 6564 5f77 6f72 6b65 7222 3a20  scaped_worker": 
+0000dce0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+0000dcf0: 7d0a 2020 2020 2020 2020 290a 2020 2020  }.        ).    
+0000dd00: 2020 2020 7072 6f63 6573 7369 6e67 203d      processing =
+0000dd10: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+0000dd20: 2020 2020 2074 6974 6c65 3d22 5461 736b       title="Task
+0000dd30: 7320 5072 6f63 6573 7369 6e67 222c 0a20  s Processing",. 
+0000dd40: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000dd50: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+0000dd60: 206e 616d 653d 2270 726f 6365 7373 696e   name="processin
+0000dd70: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+0000dd80: 7769 6474 683d 696e 7428 7769 6474 6820  width=int(width 
+0000dd90: 2f20 3229 2c0a 2020 2020 2020 2020 2020  / 2),.          
+0000dda0: 2020 6d69 6e5f 626f 7264 6572 5f62 6f74    min_border_bot
+0000ddb0: 746f 6d3d 3530 2c0a 2020 2020 2020 2020  tom=50,.        
+0000ddc0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0000ddd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000dde0: 7265 6374 203d 2070 726f 6365 7373 696e  rect = processin
+0000ddf0: 672e 7265 6374 280a 2020 2020 2020 2020  g.rect(.        
+0000de00: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0000de10: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0000de20: 2020 2020 783d 226e 7072 6f63 6573 7369      x="nprocessi
+0000de30: 6e67 2d68 616c 6622 2c0a 2020 2020 2020  ng-half",.      
+0000de40: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
+0000de50: 2020 2020 2020 2020 2077 6964 7468 3d22           width="
+0000de60: 6e70 726f 6365 7373 696e 6722 2c0a 2020  nprocessing",.  
+0000de70: 2020 2020 2020 2020 2020 6865 6967 6874            height
+0000de80: 3d30 2e39 2c0a 2020 2020 2020 2020 2020  =0.9,.          
+0000de90: 2020 636f 6c6f 723d 226e 7072 6f63 6573    color="nproces
+0000dea0: 7369 6e67 2d63 6f6c 6f72 222c 0a20 2020  sing-color",.   
+0000deb0: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
+0000dec0: 726f 6365 7373 696e 672e 785f 7261 6e67  rocessing.x_rang
+0000ded0: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
+0000dee0: 2020 2020 7265 6374 2e6e 6f6e 7365 6c65      rect.nonsele
+0000def0: 6374 696f 6e5f 676c 7970 6820 3d20 4e6f  ction_glyph = No
+0000df00: 6e65 0a0a 2020 2020 2020 2020 6370 7520  ne..        cpu 
+0000df10: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+0000df20: 2020 2020 2020 7469 746c 653d 2243 5055        title="CPU
+0000df30: 2055 7469 6c69 7a61 7469 6f6e 222c 0a20   Utilization",. 
+0000df40: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000df50: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+0000df60: 2077 6964 7468 3d69 6e74 2877 6964 7468   width=int(width
+0000df70: 202f 2032 292c 0a20 2020 2020 2020 2020   / 2),.         
+0000df80: 2020 206e 616d 653d 2263 7075 5f68 6973     name="cpu_his
+0000df90: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0000dfa0: 785f 7261 6e67 653d 2830 2c20 3130 3029  x_range=(0, 100)
+0000dfb0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
+0000dfc0: 6e5f 626f 7264 6572 5f62 6f74 746f 6d3d  n_border_bottom=
+0000dfd0: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
+0000dfe0: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+0000dff0: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
+0000e000: 203d 2063 7075 2e72 6563 7428 0a20 2020   = cpu.rect(.   
+0000e010: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0000e020: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+0000e030: 2020 2020 2020 2020 2078 3d22 6370 752d           x="cpu-
+0000e040: 6861 6c66 222c 0a20 2020 2020 2020 2020  half",.         
+0000e050: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
+0000e060: 2020 2020 2020 7769 6474 683d 2263 7075        width="cpu
+0000e070: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+0000e080: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
+0000e090: 2020 2020 2020 2063 6f6c 6f72 3d22 626c         color="bl
+0000e0a0: 7565 222c 0a20 2020 2020 2020 2029 0a20  ue",.        ). 
+0000e0b0: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
+0000e0c0: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
+0000e0d0: 204e 6f6e 650a 0a20 2020 2020 2020 2066   None..        f
+0000e0e0: 6f72 2066 6967 2069 6e20 2870 726f 6365  or fig in (proce
+0000e0f0: 7373 696e 672c 2063 7075 293a 0a20 2020  ssing, cpu):.   
+0000e100: 2020 2020 2020 2020 2066 6967 2e78 6178           fig.xax
+0000e110: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+0000e120: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+0000e130: 2020 2020 2020 2020 2066 6967 2e79 6178           fig.yax
+0000e140: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
+0000e150: 7365 0a20 2020 2020 2020 2020 2020 2066  se.            f
+0000e160: 6967 2e79 6772 6964 2e76 6973 6962 6c65  ig.ygrid.visible
+0000e170: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000e180: 2020 2020 2020 7461 7020 3d20 5461 7054        tap = TapT
+0000e190: 6f6f 6c28 6361 6c6c 6261 636b 3d4f 7065  ool(callback=Ope
+0000e1a0: 6e55 524c 2875 726c 3d22 2e2f 696e 666f  nURL(url="./info
+0000e1b0: 2f77 6f72 6b65 722f 4065 7363 6170 6564  /worker/@escaped
+0000e1c0: 5f77 6f72 6b65 722e 6874 6d6c 2229 290a  _worker.html")).
+0000e1d0: 2020 2020 2020 2020 2020 2020 6669 672e              fig.
+0000e1e0: 6164 645f 746f 6f6c 7328 7461 7029 0a0a  add_tools(tap)..
+0000e1f0: 2020 2020 2020 2020 2020 2020 6669 672e              fig.
+0000e200: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+0000e210: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0000e220: 2020 2020 6669 672e 7961 7869 732e 7669      fig.yaxis.vi
+0000e230: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0000e240: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0000e250: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
+0000e260: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
+0000e270: 7320 3d20 2240 776f 726b 6572 203a 2040  s = "@worker : @
+0000e280: 6e70 726f 6365 7373 696e 6720 7461 736b  nprocessing task
+0000e290: 7322 0a20 2020 2020 2020 2068 6f76 6572  s".        hover
+0000e2a0: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
+0000e2b0: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
+0000e2c0: 2020 2020 2020 2070 726f 6365 7373 696e         processin
+0000e2d0: 672e 6164 645f 746f 6f6c 7328 686f 7665  g.add_tools(hove
+0000e2e0: 7229 0a0a 2020 2020 2020 2020 686f 7665  r)..        hove
+0000e2f0: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
+0000e300: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
+0000e310: 6f6c 7469 7073 203d 2022 4077 6f72 6b65  oltips = "@worke
+0000e320: 7220 3a20 4063 7075 2025 220a 2020 2020  r : @cpu %".    
+0000e330: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
+0000e340: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
+0000e350: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
+0000e360: 6370 752e 6164 645f 746f 6f6c 7328 686f  cpu.add_tools(ho
+0000e370: 7665 7229 0a0a 2020 2020 2020 2020 7365  ver)..        se
+0000e380: 6c66 2e70 726f 6365 7373 696e 675f 6669  lf.processing_fi
+0000e390: 6775 7265 203d 2070 726f 6365 7373 696e  gure = processin
+0000e3a0: 670a 2020 2020 2020 2020 7365 6c66 2e63  g.        self.c
+0000e3b0: 7075 5f66 6967 7572 6520 3d20 6370 750a  pu_figure = cpu.
+0000e3c0: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+0000e3d0: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+0000e3e0: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+0000e3f0: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+0000e400: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000e410: 776f 726b 6572 7320 3d20 7365 6c66 2e73  workers = self.s
+0000e420: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0000e430: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
+0000e440: 2020 6e6f 7720 3d20 7469 6d65 2829 0a20    now = time(). 
+0000e450: 2020 2020 2020 2069 6620 6e6f 7420 616e         if not an
+0000e460: 7928 7773 2e70 726f 6365 7373 696e 6720  y(ws.processing 
+0000e470: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
+0000e480: 7329 2061 6e64 206e 6f77 203c 2073 656c  s) and now < sel
+0000e490: 662e 6c61 7374 202b 2031 3a0a 2020 2020  f.last + 1:.    
+0000e4a0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0000e4b0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0000e4c0: 203d 206e 6f77 0a0a 2020 2020 2020 2020   = now..        
+0000e4d0: 6370 7520 3d20 5b69 6e74 2877 732e 6d65  cpu = [int(ws.me
+0000e4e0: 7472 6963 735b 2263 7075 225d 2920 666f  trics["cpu"]) fo
+0000e4f0: 7220 7773 2069 6e20 776f 726b 6572 735d  r ws in workers]
+0000e500: 0a20 2020 2020 2020 206e 7072 6f63 6573  .        nproces
+0000e510: 7369 6e67 203d 205b 6c65 6e28 7773 2e70  sing = [len(ws.p
+0000e520: 726f 6365 7373 696e 6729 2066 6f72 2077  rocessing) for w
+0000e530: 7320 696e 2077 6f72 6b65 7273 5d0a 0a20  s in workers].. 
+0000e540: 2020 2020 2020 206e 7072 6f63 6573 7369         nprocessi
+0000e550: 6e67 5f63 6f6c 6f72 203d 205b 5d0a 2020  ng_color = [].  
+0000e560: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0000e570: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0000e580: 2020 2020 2069 6620 7773 2069 6e20 7365       if ws in se
+0000e590: 6c66 2e73 6368 6564 756c 6572 2e69 646c  lf.scheduler.idl
+0000e5a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e5b0: 2020 206e 7072 6f63 6573 7369 6e67 5f63     nprocessing_c
+0000e5c0: 6f6c 6f72 2e61 7070 656e 6428 2272 6564  olor.append("red
+0000e5d0: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
+0000e5e0: 6c69 6620 7773 2069 6e20 7365 6c66 2e73  lif ws in self.s
+0000e5f0: 6368 6564 756c 6572 2e73 6174 7572 6174  cheduler.saturat
+0000e600: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+0000e610: 2020 2020 6e70 726f 6365 7373 696e 675f      nprocessing_
+0000e620: 636f 6c6f 722e 6170 7065 6e64 2822 6772  color.append("gr
+0000e630: 6565 6e22 290a 2020 2020 2020 2020 2020  een").          
+0000e640: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000e650: 2020 2020 2020 2020 6e70 726f 6365 7373          nprocess
+0000e660: 696e 675f 636f 6c6f 722e 6170 7065 6e64  ing_color.append
+0000e670: 2822 626c 7565 2229 0a0a 2020 2020 2020  ("blue")..      
+0000e680: 2020 7265 7375 6c74 203d 207b 0a20 2020    result = {.   
+0000e690: 2020 2020 2020 2020 2022 6370 7522 3a20           "cpu": 
+0000e6a0: 6370 752c 0a20 2020 2020 2020 2020 2020  cpu,.           
+0000e6b0: 2022 6370 752d 6861 6c66 223a 205b 6320   "cpu-half": [c 
+0000e6c0: 2f20 3220 666f 7220 6320 696e 2063 7075  / 2 for c in cpu
+0000e6d0: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+0000e6e0: 6e70 726f 6365 7373 696e 6722 3a20 6e70  nprocessing": np
+0000e6f0: 726f 6365 7373 696e 672c 0a20 2020 2020  rocessing,.     
+0000e700: 2020 2020 2020 2022 6e70 726f 6365 7373         "nprocess
+0000e710: 696e 672d 6861 6c66 223a 205b 6e70 202f  ing-half": [np /
+0000e720: 2032 2066 6f72 206e 7020 696e 206e 7072   2 for np in npr
+0000e730: 6f63 6573 7369 6e67 5d2c 0a20 2020 2020  ocessing],.     
+0000e740: 2020 2020 2020 2022 6e70 726f 6365 7373         "nprocess
+0000e750: 696e 672d 636f 6c6f 7222 3a20 6e70 726f  ing-color": npro
+0000e760: 6365 7373 696e 675f 636f 6c6f 722c 0a20  cessing_color,. 
+0000e770: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+0000e780: 6572 223a 205b 7773 2e61 6464 7265 7373  er": [ws.address
+0000e790: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
+0000e7a0: 7273 5d2c 0a20 2020 2020 2020 2020 2020  rs],.           
+0000e7b0: 2022 6573 6361 7065 645f 776f 726b 6572   "escaped_worker
+0000e7c0: 223a 205b 6573 6361 7065 2e75 726c 5f65  ": [escape.url_e
+0000e7d0: 7363 6170 6528 7773 2e61 6464 7265 7373  scape(ws.address
+0000e7e0: 2920 666f 7220 7773 2069 6e20 776f 726b  ) for ws in work
+0000e7f0: 6572 735d 2c0a 2020 2020 2020 2020 2020  ers],.          
+0000e800: 2020 2279 223a 206c 6973 7428 7261 6e67    "y": list(rang
+0000e810: 6528 6c65 6e28 776f 726b 6572 7329 2929  e(len(workers)))
+0000e820: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+0000e830: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
+0000e840: 6564 756c 6572 2e77 6f72 6b65 7273 3a0a  eduler.workers:.
+0000e850: 2020 2020 2020 2020 2020 2020 7872 616e              xran
+0000e860: 6765 203d 206d 6178 2877 732e 6e74 6872  ge = max(ws.nthr
+0000e870: 6561 6473 206f 7220 3120 666f 7220 7773  eads or 1 for ws
+0000e880: 2069 6e20 776f 726b 6572 7329 0a20 2020   in workers).   
+0000e890: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000e8a0: 2020 2020 2020 2078 7261 6e67 6520 3d20         xrange = 
+0000e8b0: 310a 2020 2020 2020 2020 7365 6c66 2e63  1.        self.c
+0000e8c0: 7075 5f66 6967 7572 652e 785f 7261 6e67  pu_figure.x_rang
+0000e8d0: 652e 656e 6420 3d20 7872 616e 6765 202a  e.end = xrange *
+0000e8e0: 2031 3030 0a0a 2020 2020 2020 2020 7570   100..        up
+0000e8f0: 6461 7465 2873 656c 662e 736f 7572 6365  date(self.source
+0000e900: 2c20 7265 7375 6c74 290a 0a0a 636c 6173  , result)...clas
+0000e910: 7320 5374 6561 6c69 6e67 5469 6d65 5365  s StealingTimeSe
+0000e920: 7269 6573 2844 6173 6862 6f61 7264 436f  ries(DashboardCo
+0000e930: 6d70 6f6e 656e 7429 3a0a 2020 2020 6465  mponent):.    de
+0000e940: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+0000e950: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
+0000e960: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
+0000e970: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
+0000e980: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+0000e990: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
+0000e9a0: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+0000e9b0: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+0000e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9d0: 2274 696d 6522 3a20 5b74 696d 6528 2920  "time": [time() 
+0000e9e0: 2a20 3130 3030 2c20 7469 6d65 2829 202a  * 1000, time() *
+0000e9f0: 2031 3030 3020 2b20 315d 2c0a 2020 2020   1000 + 1],.    
+0000ea00: 2020 2020 2020 2020 2020 2020 2269 646c              "idl
+0000ea10: 6522 3a20 5b30 2c20 305d 2c0a 2020 2020  e": [0, 0],.    
+0000ea20: 2020 2020 2020 2020 2020 2020 2273 6174              "sat
+0000ea30: 7572 6174 6564 223a 205b 302c 2030 5d2c  urated": [0, 0],
+0000ea40: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0000ea50: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000ea60: 2020 785f 7261 6e67 6520 3d20 4461 7461    x_range = Data
+0000ea70: 5261 6e67 6531 6428 666f 6c6c 6f77 3d22  Range1d(follow="
+0000ea80: 656e 6422 2c20 666f 6c6c 6f77 5f69 6e74  end", follow_int
+0000ea90: 6572 7661 6c3d 3230 3030 302c 2072 616e  erval=20000, ran
+0000eaa0: 6765 5f70 6164 6469 6e67 3d30 290a 0a20  ge_padding=0).. 
+0000eab0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0000eac0: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+0000ead0: 2020 2020 2020 2074 6974 6c65 3d22 4964         title="Id
+0000eae0: 6c65 2061 6e64 2053 6174 7572 6174 6564  le and Saturated
+0000eaf0: 2057 6f72 6b65 7273 204f 7665 7220 5469   Workers Over Ti
+0000eb00: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+0000eb10: 2078 5f61 7869 735f 7479 7065 3d22 6461   x_axis_type="da
+0000eb20: 7465 7469 6d65 222c 0a20 2020 2020 2020  tetime",.       
+0000eb30: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+0000eb40: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+0000eb50: 6765 3d78 5f72 616e 6765 2c0a 2020 2020  ge=x_range,.    
+0000eb60: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0000eb70: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0000eb80: 2020 2020 7365 6c66 2e72 6f6f 742e 6c69      self.root.li
+0000eb90: 6e65 2873 6f75 7263 653d 7365 6c66 2e73  ne(source=self.s
+0000eba0: 6f75 7263 652c 2078 3d22 7469 6d65 222c  ource, x="time",
+0000ebb0: 2079 3d22 6964 6c65 222c 2063 6f6c 6f72   y="idle", color
+0000ebc0: 3d22 7265 6422 290a 2020 2020 2020 2020  ="red").        
+0000ebd0: 7365 6c66 2e72 6f6f 742e 6c69 6e65 2873  self.root.line(s
+0000ebe0: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+0000ebf0: 652c 2078 3d22 7469 6d65 222c 2079 3d22  e, x="time", y="
+0000ec00: 7361 7475 7261 7465 6422 2c20 636f 6c6f  saturated", colo
+0000ec10: 723d 2267 7265 656e 2229 0a20 2020 2020  r="green").     
+0000ec20: 2020 2073 656c 662e 726f 6f74 2e79 6178     self.root.yax
+0000ec30: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+0000ec40: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
+0000ec50: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000ec60: 6f74 2e61 6464 5f74 6f6f 6c73 280a 2020  ot.add_tools(.  
+0000ec70: 2020 2020 2020 2020 2020 5265 7365 7454            ResetT
+0000ec80: 6f6f 6c28 292c 2050 616e 546f 6f6c 2864  ool(), PanTool(d
+0000ec90: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
+0000eca0: 2229 2c20 5768 6565 6c5a 6f6f 6d54 6f6f  "), WheelZoomToo
+0000ecb0: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
+0000ecc0: 6474 6822 290a 2020 2020 2020 2020 290a  dth").        ).
+0000ecd0: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+0000ece0: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+0000ecf0: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+0000ed00: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+0000ed10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000ed20: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
+0000ed30: 2020 2020 2020 2022 7469 6d65 223a 205b         "time": [
+0000ed40: 7469 6d65 2829 202a 2031 3030 305d 2c0a  time() * 1000],.
+0000ed50: 2020 2020 2020 2020 2020 2020 2269 646c              "idl
+0000ed60: 6522 3a20 5b6c 656e 2873 656c 662e 7363  e": [len(self.sc
+0000ed70: 6865 6475 6c65 722e 6964 6c65 295d 2c0a  heduler.idle)],.
+0000ed80: 2020 2020 2020 2020 2020 2020 2273 6174              "sat
+0000ed90: 7572 6174 6564 223a 205b 6c65 6e28 7365  urated": [len(se
+0000eda0: 6c66 2e73 6368 6564 756c 6572 2e73 6174  lf.scheduler.sat
+0000edb0: 7572 6174 6564 295d 2c0a 2020 2020 2020  urated)],.      
+0000edc0: 2020 7d0a 2020 2020 2020 2020 6966 2050    }.        if P
+0000edd0: 524f 4649 4c49 4e47 3a0a 2020 2020 2020  ROFILING:.      
+0000ede0: 2020 2020 2020 6375 7264 6f63 2829 2e61        curdoc().a
+0000edf0: 6464 5f6e 6578 745f 7469 636b 5f63 616c  dd_next_tick_cal
+0000ee00: 6c62 6163 6b28 6c61 6d62 6461 3a20 7365  lback(lambda: se
+0000ee10: 6c66 2e73 6f75 7263 652e 7374 7265 616d  lf.source.stream
+0000ee20: 2872 6573 756c 742c 2031 3030 3030 2929  (result, 10000))
+0000ee30: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000ee40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000ee50: 736f 7572 6365 2e73 7472 6561 6d28 7265  source.stream(re
+0000ee60: 7375 6c74 2c20 3130 3030 3029 0a0a 0a63  sult, 10000)...c
+0000ee70: 6c61 7373 2053 7465 616c 696e 6745 7665  lass StealingEve
+0000ee80: 6e74 7328 4461 7368 626f 6172 6443 6f6d  nts(DashboardCom
+0000ee90: 706f 6e65 6e74 293a 0a20 2020 2064 6566  ponent):.    def
+0000eea0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0000eeb0: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
+0000eec0: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
+0000eed0: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
+0000eee0: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
+0000eef0: 2073 656c 662e 7374 6561 6c20 3d20 7363   self.steal = sc
+0000ef00: 6865 6475 6c65 722e 6578 7465 6e73 696f  heduler.extensio
+0000ef10: 6e73 5b22 7374 6561 6c69 6e67 225d 0a20  ns["stealing"]. 
+0000ef20: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0000ef30: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000ef40: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
+0000ef50: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
+0000ef60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0000ef70: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
+0000ef80: 223a 205b 7469 6d65 2829 202d 2036 302c  ": [time() - 60,
+0000ef90: 2074 696d 6528 295d 2c0a 2020 2020 2020   time()],.      
+0000efa0: 2020 2020 2020 2020 2020 226c 6576 656c            "level
+0000efb0: 223a 205b 302c 2031 355d 2c0a 2020 2020  ": [0, 15],.    
+0000efc0: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
+0000efd0: 6f72 223a 205b 2277 6869 7465 222c 2022  or": ["white", "
+0000efe0: 7768 6974 6522 5d2c 0a20 2020 2020 2020  white"],.       
+0000eff0: 2020 2020 2020 2020 2022 6475 7261 7469           "durati
+0000f000: 6f6e 223a 205b 302c 2030 5d2c 0a20 2020  on": [0, 0],.   
+0000f010: 2020 2020 2020 2020 2020 2020 2022 7261               "ra
+0000f020: 6469 7573 223a 205b 312c 2031 5d2c 0a20  dius": [1, 1],. 
+0000f030: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000f040: 636f 7374 5f66 6163 746f 7222 3a20 5b30  cost_factor": [0
+0000f050: 2c20 3130 5d2c 0a20 2020 2020 2020 2020  , 10],.         
+0000f060: 2020 2020 2020 2022 636f 756e 7422 3a20         "count": 
+0000f070: 5b31 2c20 315d 2c0a 2020 2020 2020 2020  [1, 1],.        
+0000f080: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+0000f090: 0a20 2020 2020 2020 2078 5f72 616e 6765  .        x_range
+0000f0a0: 203d 2044 6174 6152 616e 6765 3164 2866   = DataRange1d(f
+0000f0b0: 6f6c 6c6f 773d 2265 6e64 222c 2066 6f6c  ollow="end", fol
+0000f0c0: 6c6f 775f 696e 7465 7276 616c 3d32 3030  low_interval=200
+0000f0d0: 3030 2c20 7261 6e67 655f 7061 6464 696e  00, range_paddin
+0000f0e0: 673d 3029 0a0a 2020 2020 2020 2020 7365  g=0)..        se
+0000f0f0: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
+0000f100: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
+0000f110: 746c 653d 2253 7465 616c 696e 6720 4576  tle="Stealing Ev
+0000f120: 656e 7473 222c 0a20 2020 2020 2020 2020  ents",.         
+0000f130: 2020 2078 5f61 7869 735f 7479 7065 3d22     x_axis_type="
+0000f140: 6461 7465 7469 6d65 222c 0a20 2020 2020  datetime",.     
+0000f150: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
+0000f160: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
+0000f170: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
+0000f180: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+0000f190: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
+0000f1a0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0000f1b0: 2e63 6972 636c 6528 0a20 2020 2020 2020  .circle(.       
+0000f1c0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0000f1d0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+0000f1e0: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
+0000f1f0: 2020 2020 2020 2020 2020 2079 3d22 6c65             y="le
+0000f200: 7665 6c22 2c0a 2020 2020 2020 2020 2020  vel",.          
+0000f210: 2020 636f 6c6f 723d 2263 6f6c 6f72 222c    color="color",
+0000f220: 0a20 2020 2020 2020 2020 2020 2073 697a  .            siz
+0000f230: 653d 2272 6164 6975 7322 2c0a 2020 2020  e="radius",.    
+0000f240: 2020 2020 2020 2020 616c 7068 613d 302e          alpha=0.
+0000f250: 352c 0a20 2020 2020 2020 2029 0a20 2020  5,.        ).   
+0000f260: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+0000f270: 6178 6973 2e61 7869 735f 6c61 6265 6c20  axis.axis_label 
+0000f280: 3d20 224c 6576 656c 220a 0a20 2020 2020  = "Level"..     
+0000f290: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
+0000f2a0: 546f 6f6c 2829 0a20 2020 2020 2020 2068  Tool().        h
+0000f2b0: 6f76 6572 2e74 6f6f 6c74 6970 7320 3d20  over.tooltips = 
+0000f2c0: 224c 6576 656c 3a20 406c 6576 656c 2c20  "Level: @level, 
+0000f2d0: 4475 7261 7469 6f6e 3a20 4064 7572 6174  Duration: @durat
+0000f2e0: 696f 6e2c 2043 6f75 6e74 3a20 4063 6f75  ion, Count: @cou
+0000f2f0: 6e74 2c20 436f 7374 2066 6163 746f 723a  nt, Cost factor:
+0000f300: 2040 636f 7374 5f66 6163 746f 7222 0a20   @cost_factor". 
+0000f310: 2020 2020 2020 2068 6f76 6572 2e70 6f69         hover.poi
+0000f320: 6e74 5f70 6f6c 6963 7920 3d20 2266 6f6c  nt_policy = "fol
+0000f330: 6c6f 775f 6d6f 7573 6522 0a0a 2020 2020  low_mouse"..    
+0000f340: 2020 2020 7365 6c66 2e72 6f6f 742e 6164      self.root.ad
+0000f350: 645f 746f 6f6c 7328 0a20 2020 2020 2020  d_tools(.       
+0000f360: 2020 2020 2068 6f76 6572 2c0a 2020 2020       hover,.    
+0000f370: 2020 2020 2020 2020 5265 7365 7454 6f6f          ResetToo
+0000f380: 6c28 292c 0a20 2020 2020 2020 2020 2020  l(),.           
+0000f390: 2050 616e 546f 6f6c 2864 696d 656e 7369   PanTool(dimensi
+0000f3a0: 6f6e 733d 2277 6964 7468 2229 2c0a 2020  ons="width"),.  
+0000f3b0: 2020 2020 2020 2020 2020 5768 6565 6c5a            WheelZ
+0000f3c0: 6f6f 6d54 6f6f 6c28 6469 6d65 6e73 696f  oomTool(dimensio
+0000f3d0: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
+0000f3e0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0000f3f0: 636f 6e76 6572 7428 7365 6c66 2c20 6d73  convert(self, ms
+0000f400: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
+0000f410: 436f 6e76 6572 7420 6120 6c6f 6720 6d65  Convert a log me
+0000f420: 7373 6167 6520 746f 2061 2067 6c79 7068  ssage to a glyph
+0000f430: 2222 220a 2020 2020 2020 2020 746f 7461  """.        tota
+0000f440: 6c5f 6475 7261 7469 6f6e 203d 2030 0a20  l_duration = 0. 
+0000f450: 2020 2020 2020 2066 6f72 206d 7367 2069         for msg i
+0000f460: 6e20 6d73 6773 3a0a 2020 2020 2020 2020  n msgs:.        
+0000f470: 2020 2020 7469 6d65 2c20 6c65 7665 6c2c      time, level,
+0000f480: 206b 6579 2c20 6475 7261 7469 6f6e 2c20   key, duration, 
+0000f490: 7361 742c 206f 6363 5f73 6174 2c20 6964  sat, occ_sat, id
+0000f4a0: 6c2c 206f 6363 5f69 646c 203d 206d 7367  l, occ_idl = msg
+0000f4b0: 5b3a 385d 0a20 2020 2020 2020 2020 2020  [:8].           
+0000f4c0: 2074 6f74 616c 5f64 7572 6174 696f 6e20   total_duration 
+0000f4d0: 2b3d 2064 7572 6174 696f 6e0a 0a20 2020  += duration..   
+0000f4e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000f4f0: 2020 2020 2020 636f 6c6f 7220 3d20 5669        color = Vi
+0000f500: 7269 6469 7331 315b 6c65 7665 6c5d 0a20  ridis11[level]. 
+0000f510: 2020 2020 2020 2065 7863 6570 7420 284b         except (K
+0000f520: 6579 4572 726f 722c 2049 6e64 6578 4572  eyError, IndexEr
+0000f530: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000f540: 2020 636f 6c6f 7220 3d20 2262 6c61 636b    color = "black
+0000f550: 220a 0a20 2020 2020 2020 2072 6164 6975  "..        radiu
+0000f560: 7320 3d20 6d61 7468 2e73 7172 7428 6d69  s = math.sqrt(mi
+0000f570: 6e28 746f 7461 6c5f 6475 7261 7469 6f6e  n(total_duration
+0000f580: 2c20 3130 2929 202a 2033 3020 2b20 320a  , 10)) * 30 + 2.
+0000f590: 0a20 2020 2020 2020 2064 203d 207b 0a20  .        d = {. 
+0000f5a0: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
+0000f5b0: 223a 2074 696d 6520 2a20 3130 3030 2c0a  ": time * 1000,.
+0000f5c0: 2020 2020 2020 2020 2020 2020 226c 6576              "lev
+0000f5d0: 656c 223a 206c 6576 656c 2c0a 2020 2020  el": level,.    
+0000f5e0: 2020 2020 2020 2020 2263 6f75 6e74 223a          "count":
+0000f5f0: 206c 656e 286d 7367 7329 2c0a 2020 2020   len(msgs),.    
+0000f600: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
+0000f610: 2063 6f6c 6f72 2c0a 2020 2020 2020 2020   color,.        
+0000f620: 2020 2020 2264 7572 6174 696f 6e22 3a20      "duration": 
+0000f630: 746f 7461 6c5f 6475 7261 7469 6f6e 2c0a  total_duration,.
+0000f640: 2020 2020 2020 2020 2020 2020 2272 6164              "rad
+0000f650: 6975 7322 3a20 7261 6469 7573 2c0a 2020  ius": radius,.  
+0000f660: 2020 2020 2020 2020 2020 2263 6f73 745f            "cost_
+0000f670: 6661 6374 6f72 223a 2073 656c 662e 7374  factor": self.st
+0000f680: 6561 6c2e 636f 7374 5f6d 756c 7469 706c  eal.cost_multipl
+0000f690: 6965 7273 5b6c 6576 656c 5d2c 0a20 2020  iers[level],.   
+0000f6a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0000f6b0: 7265 7475 726e 2064 0a0a 2020 2020 4077  return d..    @w
+0000f6c0: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
+0000f6d0: 7661 6c69 6461 7469 6f6e 0a20 2020 2040  validation.    @
+0000f6e0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+0000f6f0: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
+0000f700: 0a20 2020 2020 2020 206c 6f67 203d 2073  .        log = s
+0000f710: 656c 662e 7363 6865 6475 6c65 722e 6765  elf.scheduler.ge
+0000f720: 745f 6576 656e 7473 2874 6f70 6963 3d22  t_events(topic="
+0000f730: 7374 6561 6c69 6e67 2229 0a20 2020 2020  stealing").     
+0000f740: 2020 2063 7572 7265 6e74 203d 206c 656e     current = len
+0000f750: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
+0000f760: 6576 656e 7473 5b22 7374 6561 6c69 6e67  events["stealing
+0000f770: 225d 290a 2020 2020 2020 2020 6e20 3d20  "]).        n = 
+0000f780: 6375 7272 656e 7420 2d20 7365 6c66 2e6c  current - self.l
+0000f790: 6173 740a 0a20 2020 2020 2020 206c 6f67  ast..        log
+0000f7a0: 203d 205b 6c6f 675b 2d69 5d5b 315d 5b31   = [log[-i][1][1
+0000f7b0: 5d20 666f 7220 6920 696e 2072 616e 6765  ] for i in range
+0000f7c0: 2831 2c20 6e20 2b20 3129 2069 6620 6c6f  (1, n + 1) if lo
+0000f7d0: 675b 2d69 5d5b 315d 5b30 5d20 3d3d 2022  g[-i][1][0] == "
+0000f7e0: 7265 7175 6573 7422 5d0a 2020 2020 2020  request"].      
+0000f7f0: 2020 7365 6c66 2e6c 6173 7420 3d20 6375    self.last = cu
+0000f800: 7272 656e 740a 0a20 2020 2020 2020 2069  rrent..        i
+0000f810: 6620 6c6f 673a 0a20 2020 2020 2020 2020  f log:.         
+0000f820: 2020 206e 6577 203d 2070 6970 6528 0a20     new = pipe(. 
+0000f830: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000f840: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
+0000f850: 2020 2020 6d61 7028 6772 6f75 7062 7928      map(groupby(
+0000f860: 3129 292c 0a20 2020 2020 2020 2020 2020  1)),.           
+0000f870: 2020 2020 206d 6170 2864 6963 742e 7661       map(dict.va
+0000f880: 6c75 6573 292c 0a20 2020 2020 2020 2020  lues),.         
+0000f890: 2020 2020 2020 2063 6f6e 6361 742c 0a20         concat,. 
+0000f8a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000f8b0: 6170 2873 656c 662e 636f 6e76 6572 7429  ap(self.convert)
+0000f8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f8d0: 2020 6c69 7374 2c0a 2020 2020 2020 2020    list,.        
+0000f8e0: 2020 2020 2020 2020 7472 616e 7370 6f73          transpos
+0000f8f0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+0000f900: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000f910: 5052 4f46 494c 494e 473a 0a20 2020 2020  PROFILING:.     
+0000f920: 2020 2020 2020 2020 2020 2063 7572 646f             curdo
+0000f930: 6328 292e 6164 645f 6e65 7874 5f74 6963  c().add_next_tic
+0000f940: 6b5f 6361 6c6c 6261 636b 286c 616d 6264  k_callback(lambd
+0000f950: 613a 2073 656c 662e 736f 7572 6365 2e73  a: self.source.s
+0000f960: 7472 6561 6d28 6e65 772c 2031 3030 3030  tream(new, 10000
+0000f970: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+0000f980: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000f990: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
+0000f9a0: 2e73 7472 6561 6d28 6e65 772c 2031 3030  .stream(new, 100
+0000f9b0: 3030 290a 0a0a 636c 6173 7320 4576 656e  00)...class Even
+0000f9c0: 7473 2844 6173 6862 6f61 7264 436f 6d70  ts(DashboardComp
+0000f9d0: 6f6e 656e 7429 3a0a 2020 2020 6465 6620  onent):.    def 
+0000f9e0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
+0000f9f0: 6368 6564 756c 6572 2c20 6e61 6d65 2c20  cheduler, name, 
+0000fa00: 6865 6967 6874 3d31 3530 2c20 2a2a 6b77  height=150, **kw
+0000fa10: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
+0000fa20: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
+0000fa30: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+0000fa40: 2020 7365 6c66 2e61 6374 696f 6e5f 7973    self.action_ys
+0000fa50: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+0000fa60: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
+0000fa70: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
+0000fa80: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
+0000fa90: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
+0000faa0: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
+0000fab0: 0a20 2020 2020 2020 2020 2020 207b 2274  .            {"t
+0000fac0: 696d 6522 3a20 5b5d 2c20 2261 6374 696f  ime": [], "actio
+0000fad0: 6e22 3a20 5b5d 2c20 2268 6f76 6572 223a  n": [], "hover":
+0000fae0: 205b 5d2c 2022 7922 3a20 5b5d 2c20 2263   [], "y": [], "c
+0000faf0: 6f6c 6f72 223a 205b 5d7d 0a20 2020 2020  olor": []}.     
+0000fb00: 2020 2029 0a0a 2020 2020 2020 2020 785f     )..        x_
+0000fb10: 7261 6e67 6520 3d20 4461 7461 5261 6e67  range = DataRang
+0000fb20: 6531 6428 666f 6c6c 6f77 3d22 656e 6422  e1d(follow="end"
+0000fb30: 2c20 666f 6c6c 6f77 5f69 6e74 6572 7661  , follow_interva
+0000fb40: 6c3d 3230 3030 3030 290a 0a20 2020 2020  l=200000)..     
+0000fb50: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
+0000fb60: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+0000fb70: 2020 2074 6974 6c65 3d6e 616d 652c 0a20     title=name,. 
+0000fb80: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
+0000fb90: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
+0000fba0: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+0000fbb0: 6569 6768 743d 6865 6967 6874 2c0a 2020  eight=height,.  
+0000fbc0: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+0000fbd0: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+0000fbe0: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
+0000fbf0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+0000fc00: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+0000fc10: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+0000fc20: 6f6f 742e 6369 7263 6c65 280a 2020 2020  oot.circle(.    
+0000fc30: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0000fc40: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+0000fc50: 2020 2020 2020 2020 783d 2274 696d 6522          x="time"
+0000fc60: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
+0000fc70: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
+0000fc80: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
+0000fc90: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+0000fca0: 3d35 302c 0a20 2020 2020 2020 2020 2020  =50,.           
+0000fcb0: 2061 6c70 6861 3d30 2e35 2c0a 2020 2020   alpha=0.5,.    
+0000fcc0: 2020 2020 2020 2020 6c65 6765 6e64 5f66          legend_f
+0000fcd0: 6965 6c64 3d22 6163 7469 6f6e 222c 0a20  ield="action",. 
+0000fce0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000fcf0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+0000fd00: 2e61 7869 735f 6c61 6265 6c20 3d20 2241  .axis_label = "A
+0000fd10: 6374 696f 6e22 0a20 2020 2020 2020 2073  ction".        s
+0000fd20: 656c 662e 726f 6f74 2e6c 6567 656e 642e  elf.root.legend.
+0000fd30: 6c6f 6361 7469 6f6e 203d 2022 746f 705f  location = "top_
+0000fd40: 6c65 6674 220a 0a20 2020 2020 2020 2068  left"..        h
+0000fd50: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
+0000fd60: 2829 0a20 2020 2020 2020 2068 6f76 6572  ().        hover
+0000fd70: 2e74 6f6f 6c74 6970 7320 3d20 2240 6163  .tooltips = "@ac
+0000fd80: 7469 6f6e 3c62 723e 4068 6f76 6572 220a  tion<br>@hover".
+0000fd90: 2020 2020 2020 2020 686f 7665 722e 706f          hover.po
+0000fda0: 696e 745f 706f 6c69 6379 203d 2022 666f  int_policy = "fo
+0000fdb0: 6c6c 6f77 5f6d 6f75 7365 220a 0a20 2020  llow_mouse"..   
+0000fdc0: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+0000fdd0: 6464 5f74 6f6f 6c73 280a 2020 2020 2020  dd_tools(.      
+0000fde0: 2020 2020 2020 686f 7665 722c 0a20 2020        hover,.   
+0000fdf0: 2020 2020 2020 2020 2052 6573 6574 546f           ResetTo
+0000fe00: 6f6c 2829 2c0a 2020 2020 2020 2020 2020  ol(),.          
+0000fe10: 2020 5061 6e54 6f6f 6c28 6469 6d65 6e73    PanTool(dimens
+0000fe20: 696f 6e73 3d22 7769 6474 6822 292c 0a20  ions="width"),. 
+0000fe30: 2020 2020 2020 2020 2020 2057 6865 656c             Wheel
+0000fe40: 5a6f 6f6d 546f 6f6c 2864 696d 656e 7369  ZoomTool(dimensi
+0000fe50: 6f6e 733d 2277 6964 7468 2229 2c0a 2020  ons="width"),.  
+0000fe60: 2020 2020 2020 290a 0a20 2020 2040 7769        )..    @wi
+0000fe70: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
+0000fe80: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
+0000fe90: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+0000fea0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
+0000feb0: 2020 2020 2020 2020 6c6f 6720 3d20 7365          log = se
+0000fec0: 6c66 2e73 6368 6564 756c 6572 2e65 7665  lf.scheduler.eve
+0000fed0: 6e74 735b 7365 6c66 2e6e 616d 655d 0a20  nts[self.name]. 
+0000fee0: 2020 2020 2020 206e 203d 2073 656c 662e         n = self.
+0000fef0: 7363 6865 6475 6c65 722e 6576 656e 745f  scheduler.event_
+0000ff00: 636f 756e 7473 5b73 656c 662e 6e61 6d65  counts[self.name
+0000ff10: 5d20 2d20 7365 6c66 2e6c 6173 740a 2020  ] - self.last.  
+0000ff20: 2020 2020 2020 6966 206c 6f67 3a0a 2020        if log:.  
+0000ff30: 2020 2020 2020 2020 2020 6c6f 6720 3d20            log = 
+0000ff40: 5b6c 6f67 5b2d 695d 2066 6f72 2069 2069  [log[-i] for i i
+0000ff50: 6e20 7261 6e67 6528 312c 206e 202b 2031  n range(1, n + 1
+0000ff60: 295d 0a20 2020 2020 2020 2073 656c 662e  )].        self.
+0000ff70: 6c61 7374 203d 2073 656c 662e 7363 6865  last = self.sche
+0000ff80: 6475 6c65 722e 6576 656e 745f 636f 756e  duler.event_coun
+0000ff90: 7473 5b73 656c 662e 6e61 6d65 5d0a 0a20  ts[self.name].. 
+0000ffa0: 2020 2020 2020 2069 6620 6c6f 673a 0a20         if log:. 
+0000ffb0: 2020 2020 2020 2020 2020 2061 6374 696f             actio
+0000ffc0: 6e73 203d 205b 5d0a 2020 2020 2020 2020  ns = [].        
+0000ffd0: 2020 2020 7469 6d65 7320 3d20 5b5d 0a20      times = []. 
+0000ffe0: 2020 2020 2020 2020 2020 2068 6f76 6572             hover
+0000fff0: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+00010000: 2020 2079 7320 3d20 5b5d 0a20 2020 2020     ys = [].     
+00010010: 2020 2020 2020 2063 6f6c 6f72 7320 3d20         colors = 
+00010020: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00010030: 6f72 206d 7367 5f74 696d 652c 206d 7367  or msg_time, msg
+00010040: 2069 6e20 6c6f 673a 0a20 2020 2020 2020   in log:.       
+00010050: 2020 2020 2020 2020 2074 696d 6573 2e61           times.a
+00010060: 7070 656e 6428 6d73 675f 7469 6d65 202a  ppend(msg_time *
+00010070: 2031 3030 3029 0a20 2020 2020 2020 2020   1000).         
+00010080: 2020 2020 2020 2061 6374 696f 6e20 3d20         action = 
+00010090: 6d73 675b 2261 6374 696f 6e22 5d0a 2020  msg["action"].  
+000100a0: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+000100b0: 7469 6f6e 732e 6170 7065 6e64 2861 6374  tions.append(act
+000100c0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+000100d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000100e0: 2020 2020 2020 2020 2020 2020 2020 7973                ys
+000100f0: 2e61 7070 656e 6428 7365 6c66 2e61 6374  .append(self.act
+00010100: 696f 6e5f 7973 5b61 6374 696f 6e5d 290a  ion_ys[action]).
+00010110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010120: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+00010130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010140: 2020 2020 2073 656c 662e 6163 7469 6f6e       self.action
+00010150: 5f79 735b 6163 7469 6f6e 5d20 3d20 6c65  _ys[action] = le
+00010160: 6e28 7365 6c66 2e61 6374 696f 6e5f 7973  n(self.action_ys
+00010170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010180: 2020 2020 2020 7973 2e61 7070 656e 6428        ys.append(
+00010190: 7365 6c66 2e61 6374 696f 6e5f 7973 5b61  self.action_ys[a
+000101a0: 6374 696f 6e5d 290a 2020 2020 2020 2020  ction]).        
+000101b0: 2020 2020 2020 2020 636f 6c6f 7273 2e61          colors.a
+000101c0: 7070 656e 6428 636f 6c6f 725f 6f66 2861  ppend(color_of(a
+000101d0: 6374 696f 6e29 290a 2020 2020 2020 2020  ction)).        
+000101e0: 2020 2020 2020 2020 686f 7665 7273 2e61          hovers.a
+000101f0: 7070 656e 6428 2254 4f44 4f22 290a 0a20  ppend("TODO").. 
+00010200: 2020 2020 2020 2020 2020 206e 6577 203d             new =
+00010210: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00010220: 2020 2022 7469 6d65 223a 2074 696d 6573     "time": times
+00010230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010240: 2020 2261 6374 696f 6e22 3a20 6163 7469    "action": acti
+00010250: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00010260: 2020 2020 2022 686f 7665 7222 3a20 686f       "hover": ho
+00010270: 7665 7273 2c0a 2020 2020 2020 2020 2020  vers,.          
+00010280: 2020 2020 2020 2279 223a 2079 732c 0a20        "y": ys,. 
+00010290: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000102a0: 636f 6c6f 7222 3a20 636f 6c6f 7273 2c0a  color": colors,.
+000102b0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+000102c0: 2020 2020 2020 2020 2020 2069 6620 5052             if PR
+000102d0: 4f46 494c 494e 473a 0a20 2020 2020 2020  OFILING:.       
+000102e0: 2020 2020 2020 2020 2063 7572 646f 6328           curdoc(
+000102f0: 292e 6164 645f 6e65 7874 5f74 6963 6b5f  ).add_next_tick_
+00010300: 6361 6c6c 6261 636b 286c 616d 6264 613a  callback(lambda:
+00010310: 2073 656c 662e 736f 7572 6365 2e73 7472   self.source.str
+00010320: 6561 6d28 6e65 772c 2031 3030 3030 2929  eam(new, 10000))
+00010330: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00010340: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00010350: 2020 2073 656c 662e 736f 7572 6365 2e73     self.source.s
+00010360: 7472 6561 6d28 6e65 772c 2031 3030 3030  tream(new, 10000
+00010370: 290a 0a0a 636c 6173 7320 5461 736b 5374  )...class TaskSt
+00010380: 7265 616d 2844 6173 6862 6f61 7264 436f  ream(DashboardCo
+00010390: 6d70 6f6e 656e 7429 3a0a 2020 2020 6465  mponent):.    de
+000103a0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+000103b0: 2073 6368 6564 756c 6572 2c20 6e5f 7265   scheduler, n_re
+000103c0: 6374 616e 676c 6573 3d31 3030 302c 2063  ctangles=1000, c
+000103d0: 6c65 6172 5f69 6e74 6572 7661 6c3d 2232  lear_interval="2
+000103e0: 3073 222c 202a 2a6b 7761 7267 7329 3a0a  0s", **kwargs):.
+000103f0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00010400: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+00010410: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+00010420: 6f66 6673 6574 203d 2030 0a0a 2020 2020  offset = 0..    
+00010430: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
+00010440: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
+00010450: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+00010460: 6572 2e70 6c75 6769 6e73 3a0a 2020 2020  er.plugins:.    
+00010470: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00010480: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
+00010490: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
+000104a0: 696e 2873 656c 662e 7363 6865 6475 6c65  in(self.schedule
+000104b0: 7229 290a 2020 2020 2020 2020 7365 6c66  r)).        self
+000104c0: 2e70 6c75 6769 6e20 3d20 7365 6c66 2e73  .plugin = self.s
+000104d0: 6368 6564 756c 6572 2e70 6c75 6769 6e73  cheduler.plugins
+000104e0: 5b54 6173 6b53 7472 6561 6d50 6c75 6769  [TaskStreamPlugi
+000104f0: 6e2e 6e61 6d65 5d0a 0a20 2020 2020 2020  n.name]..       
+00010500: 2073 656c 662e 696e 6465 7820 3d20 6d61   self.index = ma
+00010510: 7828 302c 2073 656c 662e 706c 7567 696e  x(0, self.plugin
+00010520: 2e69 6e64 6578 202d 206e 5f72 6563 7461  .index - n_recta
+00010530: 6e67 6c65 7329 0a20 2020 2020 2020 2073  ngles).        s
+00010540: 656c 662e 776f 726b 6572 7320 3d20 6469  elf.workers = di
+00010550: 6374 2829 0a20 2020 2020 2020 2073 656c  ct().        sel
+00010560: 662e 6e5f 7265 6374 616e 676c 6573 203d  f.n_rectangles =
+00010570: 206e 5f72 6563 7461 6e67 6c65 730a 2020   n_rectangles.  
+00010580: 2020 2020 2020 636c 6561 725f 696e 7465        clear_inte
+00010590: 7276 616c 203d 2070 6172 7365 5f74 696d  rval = parse_tim
+000105a0: 6564 656c 7461 2863 6c65 6172 5f69 6e74  edelta(clear_int
+000105b0: 6572 7661 6c2c 2064 6566 6175 6c74 3d22  erval, default="
+000105c0: 6d73 2229 0a20 2020 2020 2020 2073 656c  ms").        sel
+000105d0: 662e 636c 6561 725f 696e 7465 7276 616c  f.clear_interval
+000105e0: 203d 2063 6c65 6172 5f69 6e74 6572 7661   = clear_interva
+000105f0: 6c0a 2020 2020 2020 2020 7365 6c66 2e6c  l.        self.l
+00010600: 6173 7420 3d20 300a 2020 2020 2020 2020  ast = 0.        
+00010610: 7365 6c66 2e6c 6173 745f 7365 656e 203d  self.last_seen =
+00010620: 2030 0a0a 2020 2020 2020 2020 7365 6c66   0..        self
+00010630: 2e73 6f75 7263 652c 2073 656c 662e 726f  .source, self.ro
+00010640: 6f74 203d 2074 6173 6b5f 7374 7265 616d  ot = task_stream
+00010650: 5f66 6967 7572 6528 636c 6561 725f 696e  _figure(clear_in
+00010660: 7465 7276 616c 2c20 2a2a 6b77 6172 6773  terval, **kwargs
+00010670: 290a 0a20 2020 2020 2020 2023 2052 6571  )..        # Req
+00010680: 7569 7265 6420 666f 7220 7570 6461 7465  uired for update
+00010690: 2063 616c 6c62 6163 6b0a 2020 2020 2020   callback.      
+000106a0: 2020 7365 6c66 2e74 6173 6b5f 7374 7265    self.task_stre
+000106b0: 616d 5f69 6e64 6578 203d 205b 305d 0a0a  am_index = [0]..
+000106c0: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
+000106d0: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+000106e0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+000106f0: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
+00010700: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
+00010710: 6620 7365 6c66 2e69 6e64 6578 203d 3d20  f self.index == 
+00010720: 7365 6c66 2e70 6c75 6769 6e2e 696e 6465  self.plugin.inde
+00010730: 783a 0a20 2020 2020 2020 2020 2020 2072  x:.            r
+00010740: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
+00010750: 6620 7365 6c66 2e69 6e64 6578 2061 6e64  f self.index and
+00010760: 206c 656e 2873 656c 662e 736f 7572 6365   len(self.source
+00010770: 2e64 6174 615b 2273 7461 7274 225d 293a  .data["start"]):
+00010780: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00010790: 7274 203d 206d 696e 2873 656c 662e 736f  rt = min(self.so
+000107a0: 7572 6365 2e64 6174 615b 2273 7461 7274  urce.data["start
+000107b0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+000107c0: 6475 7261 7469 6f6e 203d 206d 6178 2873  duration = max(s
+000107d0: 656c 662e 736f 7572 6365 2e64 6174 615b  elf.source.data[
+000107e0: 2264 7572 6174 696f 6e22 5d29 0a20 2020  "duration"]).   
+000107f0: 2020 2020 2020 2020 2062 6f75 6e64 6172           boundar
+00010800: 7920 3d20 2873 656c 662e 6f66 6673 6574  y = (self.offset
+00010810: 202b 2073 7461 7274 202d 2064 7572 6174   + start - durat
+00010820: 696f 6e29 202f 2031 3030 300a 2020 2020  ion) / 1000.    
+00010830: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010840: 2020 2020 2020 626f 756e 6461 7279 203d        boundary =
+00010850: 2073 656c 662e 6f66 6673 6574 0a20 2020   self.offset.   
+00010860: 2020 2020 2072 6563 7461 6e67 6c65 7320       rectangles 
+00010870: 3d20 7365 6c66 2e70 6c75 6769 6e2e 7265  = self.plugin.re
+00010880: 6374 616e 676c 6573 280a 2020 2020 2020  ctangles(.      
+00010890: 2020 2020 2020 6973 7461 7274 3d73 656c        istart=sel
+000108a0: 662e 696e 6465 782c 2077 6f72 6b65 7273  f.index, workers
+000108b0: 3d73 656c 662e 776f 726b 6572 732c 2073  =self.workers, s
+000108c0: 7461 7274 5f62 6f75 6e64 6172 793d 626f  tart_boundary=bo
+000108d0: 756e 6461 7279 0a20 2020 2020 2020 2029  undary.        )
+000108e0: 0a20 2020 2020 2020 206e 203d 206c 656e  .        n = len
+000108f0: 2872 6563 7461 6e67 6c65 735b 226e 616d  (rectangles["nam
+00010900: 6522 5d29 0a20 2020 2020 2020 2073 656c  e"]).        sel
+00010910: 662e 696e 6465 7820 3d20 7365 6c66 2e70  f.index = self.p
+00010920: 6c75 6769 6e2e 696e 6465 780a 0a20 2020  lugin.index..   
+00010930: 2020 2020 2069 6620 6e6f 7420 7265 6374       if not rect
+00010940: 616e 676c 6573 5b22 7374 6172 7422 5d3a  angles["start"]:
+00010950: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010960: 7572 6e0a 0a20 2020 2020 2020 2023 2049  urn..        # I
+00010970: 6620 6974 2068 6173 2062 6565 6e20 6120  f it has been a 
+00010980: 7768 696c 6520 7369 6e63 6520 7765 2776  while since we'v
+00010990: 6520 7570 6461 7465 6420 7468 6520 706c  e updated the pl
+000109a0: 6f74 0a20 2020 2020 2020 2069 6620 7469  ot.        if ti
+000109b0: 6d65 2829 203e 2073 656c 662e 6c61 7374  me() > self.last
+000109c0: 5f73 6565 6e20 2b20 7365 6c66 2e63 6c65  _seen + self.cle
+000109d0: 6172 5f69 6e74 6572 7661 6c3a 0a20 2020  ar_interval:.   
+000109e0: 2020 2020 2020 2020 206e 6577 5f73 7461           new_sta
+000109f0: 7274 203d 206d 696e 2872 6563 7461 6e67  rt = min(rectang
+00010a00: 6c65 735b 2273 7461 7274 225d 2920 2d20  les["start"]) - 
+00010a10: 7365 6c66 2e6f 6666 7365 740a 2020 2020  self.offset.    
+00010a20: 2020 2020 2020 2020 6f6c 645f 7374 6172          old_star
+00010a30: 7420 3d20 6d69 6e28 7365 6c66 2e73 6f75  t = min(self.sou
+00010a40: 7263 652e 6461 7461 5b22 7374 6172 7422  rce.data["start"
+00010a50: 5d29 0a20 2020 2020 2020 2020 2020 206f  ]).            o
+00010a60: 6c64 5f65 6e64 203d 206d 6178 280a 2020  ld_end = max(.  
+00010a70: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00010a80: 7028 0a20 2020 2020 2020 2020 2020 2020  p(.             
+00010a90: 2020 2020 2020 206f 7065 7261 746f 722e         operator.
+00010aa0: 6164 642c 0a20 2020 2020 2020 2020 2020  add,.           
+00010ab0: 2020 2020 2020 2020 2073 656c 662e 736f           self.so
+00010ac0: 7572 6365 2e64 6174 615b 2273 7461 7274  urce.data["start
+00010ad0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00010ae0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00010af0: 7263 652e 6461 7461 5b22 6475 7261 7469  rce.data["durati
+00010b00: 6f6e 225d 2c0a 2020 2020 2020 2020 2020  on"],.          
+00010b10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010b20: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00010b30: 2020 2064 656e 7369 7479 203d 2028 0a20     density = (. 
+00010b40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010b50: 756d 2873 656c 662e 736f 7572 6365 2e64  um(self.source.d
+00010b60: 6174 615b 2264 7572 6174 696f 6e22 5d29  ata["duration"])
+00010b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010b80: 202f 206c 656e 2873 656c 662e 776f 726b   / len(self.work
+00010b90: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
+00010ba0: 2020 2020 202f 2028 6f6c 645f 656e 6420       / (old_end 
+00010bb0: 2d20 6f6c 645f 7374 6172 7429 0a20 2020  - old_start).   
+00010bc0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00010bd0: 2020 2020 2020 2020 2320 4966 2077 6869          # If whi
+00010be0: 7465 7370 6163 6520 6973 206d 6f72 6520  tespace is more 
+00010bf0: 7468 616e 2033 7820 7468 6520 6f6c 6420  than 3x the old 
+00010c00: 7769 6474 680a 2020 2020 2020 2020 2020  width.          
+00010c10: 2020 6966 2028 6e65 775f 7374 6172 7420    if (new_start 
+00010c20: 2d20 6f6c 645f 656e 6429 203e 2028 6f6c  - old_end) > (ol
+00010c30: 645f 656e 6420 2d20 6f6c 645f 7374 6172  d_end - old_star
+00010c40: 7429 202a 2032 206f 7220 6465 6e73 6974  t) * 2 or densit
+00010c50: 7920 3c20 302e 3035 3a0a 2020 2020 2020  y < 0.05:.      
+00010c60: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00010c70: 6f75 7263 652e 6461 7461 2e75 7064 6174  ource.data.updat
+00010c80: 6528 7b6b 3a20 5b5d 2066 6f72 206b 2069  e({k: [] for k i
+00010c90: 6e20 7265 6374 616e 676c 6573 7d29 2020  n rectangles})  
+00010ca0: 2320 636c 6561 720a 2020 2020 2020 2020  # clear.        
+00010cb0: 2020 2020 2020 2020 7365 6c66 2e6f 6666          self.off
+00010cc0: 7365 7420 3d20 6d69 6e28 7265 6374 616e  set = min(rectan
+00010cd0: 676c 6573 5b22 7374 6172 7422 5d29 2020  gles["start"])  
+00010ce0: 2320 7265 6465 6669 6e65 206f 6666 7365  # redefine offse
+00010cf0: 740a 0a20 2020 2020 2020 2072 6563 7461  t..        recta
+00010d00: 6e67 6c65 735b 2273 7461 7274 225d 203d  ngles["start"] =
+00010d10: 205b 7820 2d20 7365 6c66 2e6f 6666 7365   [x - self.offse
+00010d20: 7420 666f 7220 7820 696e 2072 6563 7461  t for x in recta
+00010d30: 6e67 6c65 735b 2273 7461 7274 225d 5d0a  ngles["start"]].
+00010d40: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
+00010d50: 745f 7365 656e 203d 2074 696d 6528 290a  t_seen = time().
+00010d60: 0a20 2020 2020 2020 2023 2043 6f6e 7665  .        # Conve
+00010d70: 7274 2074 6f20 6e75 6d70 7920 666f 7220  rt to numpy for 
+00010d80: 7365 7269 616c 697a 6174 696f 6e20 7370  serialization sp
+00010d90: 6565 640a 2020 2020 2020 2020 6966 206e  eed.        if n
+00010da0: 203e 3d20 3130 2061 6e64 206e 703a 0a20   >= 10 and np:. 
+00010db0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00010dc0: 2c20 7620 696e 2072 6563 7461 6e67 6c65  , v in rectangle
+00010dd0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00010de0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00010df0: 696e 7374 616e 6365 2876 5b30 5d2c 204e  instance(v[0], N
+00010e00: 756d 6265 7229 3a0a 2020 2020 2020 2020  umber):.        
+00010e10: 2020 2020 2020 2020 2020 2020 7265 6374              rect
+00010e20: 616e 676c 6573 5b6b 5d20 3d20 6e70 2e61  angles[k] = np.a
+00010e30: 7272 6179 2876 290a 0a20 2020 2020 2020  rray(v)..       
+00010e40: 2069 6620 5052 4f46 494c 494e 473a 0a20   if PROFILING:. 
+00010e50: 2020 2020 2020 2020 2020 2063 7572 646f             curdo
+00010e60: 6328 292e 6164 645f 6e65 7874 5f74 6963  c().add_next_tic
+00010e70: 6b5f 6361 6c6c 6261 636b 280a 2020 2020  k_callback(.    
+00010e80: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+00010e90: 6461 3a20 7365 6c66 2e73 6f75 7263 652e  da: self.source.
+00010ea0: 7374 7265 616d 2872 6563 7461 6e67 6c65  stream(rectangle
+00010eb0: 732c 2073 656c 662e 6e5f 7265 6374 616e  s, self.n_rectan
+00010ec0: 676c 6573 290a 2020 2020 2020 2020 2020  gles).          
+00010ed0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+00010ee0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00010ef0: 6c66 2e73 6f75 7263 652e 7374 7265 616d  lf.source.stream
+00010f00: 2872 6563 7461 6e67 6c65 732c 2073 656c  (rectangles, sel
+00010f10: 662e 6e5f 7265 6374 616e 676c 6573 290a  f.n_rectangles).
+00010f20: 0a0a 6465 6620 7461 736b 5f73 7472 6561  ..def task_strea
+00010f30: 6d5f 6669 6775 7265 2863 6c65 6172 5f69  m_figure(clear_i
+00010f40: 6e74 6572 7661 6c3d 2232 3073 222c 202a  nterval="20s", *
+00010f50: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+00010f60: 220a 2020 2020 6b77 6172 6773 2061 7265  ".    kwargs are
+00010f70: 2061 7070 6c69 6564 2074 6f20 7468 6520   applied to the 
+00010f80: 626f 6b65 682e 6d6f 6465 6c73 2e70 6c6f  bokeh.models.plo
+00010f90: 7473 2e50 6c6f 7420 636f 6e73 7472 7563  ts.Plot construc
+00010fa0: 746f 720a 2020 2020 2222 220a 2020 2020  tor.    """.    
+00010fb0: 636c 6561 725f 696e 7465 7276 616c 203d  clear_interval =
+00010fc0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+00010fd0: 2863 6c65 6172 5f69 6e74 6572 7661 6c2c  (clear_interval,
+00010fe0: 2064 6566 6175 6c74 3d22 6d73 2229 0a0a   default="ms")..
+00010ff0: 2020 2020 736f 7572 6365 203d 2043 6f6c      source = Col
+00011000: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
+00011010: 2020 2020 2020 2064 6174 613d 6469 6374         data=dict
+00011020: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00011030: 6172 743d 5b74 696d 6528 2920 2d20 636c  art=[time() - cl
+00011040: 6561 725f 696e 7465 7276 616c 5d2c 0a20  ear_interval],. 
+00011050: 2020 2020 2020 2020 2020 2064 7572 6174             durat
+00011060: 696f 6e3d 5b30 2e31 5d2c 0a20 2020 2020  ion=[0.1],.     
+00011070: 2020 2020 2020 206b 6579 3d5b 2273 7461         key=["sta
+00011080: 7274 225d 2c0a 2020 2020 2020 2020 2020  rt"],.          
+00011090: 2020 6e61 6d65 3d5b 2273 7461 7274 225d    name=["start"]
+000110a0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+000110b0: 6c6f 723d 5b22 7768 6974 6522 5d2c 0a20  lor=["white"],. 
+000110c0: 2020 2020 2020 2020 2020 2064 7572 6174             durat
+000110d0: 696f 6e5f 7465 7874 3d5b 2231 3030 206d  ion_text=["100 m
+000110e0: 7322 5d2c 0a20 2020 2020 2020 2020 2020  s"],.           
+000110f0: 2077 6f72 6b65 723d 5b22 666f 6f22 5d2c   worker=["foo"],
+00011100: 0a20 2020 2020 2020 2020 2020 2079 3d5b  .            y=[
+00011110: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00011120: 776f 726b 6572 5f74 6872 6561 643d 5b31  worker_thread=[1
+00011130: 5d2c 0a20 2020 2020 2020 2020 2020 2061  ],.            a
+00011140: 6c70 6861 3d5b 302e 305d 2c0a 2020 2020  lpha=[0.0],.    
+00011150: 2020 2020 290a 2020 2020 290a 0a20 2020      ).    )..   
+00011160: 2078 5f72 616e 6765 203d 2044 6174 6152   x_range = DataR
+00011170: 616e 6765 3164 2872 616e 6765 5f70 6164  ange1d(range_pad
+00011180: 6469 6e67 3d30 290a 2020 2020 795f 7261  ding=0).    y_ra
+00011190: 6e67 6520 3d20 4461 7461 5261 6e67 6531  nge = DataRange1
+000111a0: 6428 7261 6e67 655f 7061 6464 696e 673d  d(range_padding=
+000111b0: 3029 0a0a 2020 2020 726f 6f74 203d 2066  0)..    root = f
+000111c0: 6967 7572 6528 0a20 2020 2020 2020 206e  igure(.        n
+000111d0: 616d 653d 2274 6173 6b5f 7374 7265 616d  ame="task_stream
+000111e0: 222c 0a20 2020 2020 2020 2074 6974 6c65  ",.        title
+000111f0: 3d22 5461 736b 2053 7472 6561 6d22 2c0a  ="Task Stream",.
+00011200: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+00011210: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
+00011220: 2079 5f72 616e 6765 3d79 5f72 616e 6765   y_range=y_range
+00011230: 2c0a 2020 2020 2020 2020 746f 6f6c 6261  ,.        toolba
+00011240: 725f 6c6f 6361 7469 6f6e 3d22 6162 6f76  r_location="abov
+00011250: 6522 2c0a 2020 2020 2020 2020 785f 6178  e",.        x_ax
+00011260: 6973 5f74 7970 653d 2264 6174 6574 696d  is_type="datetim
+00011270: 6522 2c0a 2020 2020 2020 2020 795f 6178  e",.        y_ax
+00011280: 6973 5f6c 6f63 6174 696f 6e3d 4e6f 6e65  is_location=None
+00011290: 2c0a 2020 2020 2020 2020 746f 6f6c 733d  ,.        tools=
+000112a0: 2222 2c0a 2020 2020 2020 2020 6d69 6e5f  "",.        min_
+000112b0: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
+000112c0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+000112d0: 6773 2c0a 2020 2020 290a 0a20 2020 2072  gs,.    )..    r
+000112e0: 6563 7420 3d20 726f 6f74 2e72 6563 7428  ect = root.rect(
+000112f0: 0a20 2020 2020 2020 2073 6f75 7263 653d  .        source=
+00011300: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+00011310: 783d 2273 7461 7274 222c 0a20 2020 2020  x="start",.     
+00011320: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
+00011330: 2020 7769 6474 683d 2264 7572 6174 696f    width="duratio
+00011340: 6e22 2c0a 2020 2020 2020 2020 6865 6967  n",.        heig
+00011350: 6874 3d30 2e34 2c0a 2020 2020 2020 2020  ht=0.4,.        
+00011360: 6669 6c6c 5f63 6f6c 6f72 3d22 636f 6c6f  fill_color="colo
+00011370: 7222 2c0a 2020 2020 2020 2020 6c69 6e65  r",.        line
+00011380: 5f63 6f6c 6f72 3d22 636f 6c6f 7222 2c0a  _color="color",.
+00011390: 2020 2020 2020 2020 6c69 6e65 5f61 6c70          line_alp
+000113a0: 6861 3d30 2e36 2c0a 2020 2020 2020 2020  ha=0.6,.        
+000113b0: 6669 6c6c 5f61 6c70 6861 3d22 616c 7068  fill_alpha="alph
+000113c0: 6122 2c0a 2020 2020 2020 2020 6c69 6e65  a",.        line
+000113d0: 5f77 6964 7468 3d33 2c0a 2020 2020 290a  _width=3,.    ).
+000113e0: 2020 2020 7265 6374 2e6e 6f6e 7365 6c65      rect.nonsele
+000113f0: 6374 696f 6e5f 676c 7970 6820 3d20 4e6f  ction_glyph = No
+00011400: 6e65 0a0a 2020 2020 726f 6f74 2e79 6178  ne..    root.yax
+00011410: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f74  is.major_label_t
+00011420: 6578 745f 616c 7068 6120 3d20 300a 2020  ext_alpha = 0.  
+00011430: 2020 726f 6f74 2e79 6178 6973 2e6d 696e    root.yaxis.min
+00011440: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+00011450: 6861 203d 2030 0a20 2020 2072 6f6f 742e  ha = 0.    root.
+00011460: 7961 7869 732e 6d61 6a6f 725f 7469 636b  yaxis.major_tick
+00011470: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
+00011480: 2020 2020 726f 6f74 2e78 6772 6964 2e76      root.xgrid.v
+00011490: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+000114a0: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+000114b0: 7254 6f6f 6c28 0a20 2020 2020 2020 2070  rTool(.        p
+000114c0: 6f69 6e74 5f70 6f6c 6963 793d 2266 6f6c  oint_policy="fol
+000114d0: 6c6f 775f 6d6f 7573 6522 2c0a 2020 2020  low_mouse",.    
+000114e0: 2020 2020 746f 6f6c 7469 7073 3d22 2222      tooltips="""
+000114f0: 0a20 2020 2020 2020 2020 2020 203c 6469  .            <di
+00011500: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+00011510: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+00011520: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
+00011530: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
+00011540: 6c64 3b22 3e40 6e61 6d65 3a3c 2f73 7061  ld;">@name:</spa
+00011550: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
+00011560: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+00011570: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+00011580: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+00011590: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+000115a0: 7370 6163 653b 223e 4064 7572 6174 696f  space;">@duratio
+000115b0: 6e5f 7465 7874 3c2f 7370 616e 3e0a 2020  n_text</span>.  
+000115c0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+000115d0: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
+000115e0: 2c0a 2020 2020 290a 0a20 2020 2074 6170  ,.    )..    tap
+000115f0: 203d 2054 6170 546f 6f6c 2863 616c 6c62   = TapTool(callb
+00011600: 6163 6b3d 4f70 656e 5552 4c28 7572 6c3d  ack=OpenURL(url=
+00011610: 222e 2f70 726f 6669 6c65 3f6b 6579 3d40  "./profile?key=@
+00011620: 6e61 6d65 2229 290a 2020 2020 6865 6c70  name")).    help
+00011630: 5f20 3d20 4865 6c70 546f 6f6c 280a 2020  _ = HelpTool(.  
+00011640: 2020 2020 2020 7265 6469 7265 6374 3d22        redirect="
+00011650: 6874 7470 733a 2f2f 646f 6373 2e64 6173  https://docs.das
+00011660: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
+00011670: 6461 7368 626f 6172 642e 6874 6d6c 2374  dashboard.html#t
+00011680: 6173 6b2d 7374 7265 616d 222c 0a20 2020  ask-stream",.   
+00011690: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
+000116a0: 3d22 4120 6465 7363 7269 7074 696f 6e20  ="A description 
+000116b0: 6f66 2074 6865 2054 6173 6b53 7472 6561  of the TaskStrea
+000116c0: 6d20 616e 6420 6974 7320 636f 6c6f 7220  m and its color 
+000116d0: 7061 6c65 7474 652e 222c 0a20 2020 2029  palette.",.    )
+000116e0: 0a20 2020 2072 6f6f 742e 6164 645f 746f  .    root.add_to
+000116f0: 6f6c 7328 0a20 2020 2020 2020 2068 6f76  ols(.        hov
+00011700: 6572 2c0a 2020 2020 2020 2020 7461 702c  er,.        tap,
+00011710: 0a20 2020 2020 2020 2042 6f78 5a6f 6f6d  .        BoxZoom
+00011720: 546f 6f6c 2829 2c0a 2020 2020 2020 2020  Tool(),.        
+00011730: 5265 7365 7454 6f6f 6c28 292c 0a20 2020  ResetTool(),.   
+00011740: 2020 2020 2050 616e 546f 6f6c 2864 696d       PanTool(dim
+00011750: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
+00011760: 2c0a 2020 2020 2020 2020 5768 6565 6c5a  ,.        WheelZ
+00011770: 6f6f 6d54 6f6f 6c28 6469 6d65 6e73 696f  oomTool(dimensio
+00011780: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
+00011790: 2020 2020 2068 656c 705f 2c0a 2020 2020       help_,.    
+000117a0: 290a 2020 2020 6966 2045 7870 6f72 7454  ).    if ExportT
+000117b0: 6f6f 6c3a 2020 2320 7479 7065 3a20 6967  ool:  # type: ig
+000117c0: 6e6f 7265 0a20 2020 2020 2020 2065 7870  nore.        exp
+000117d0: 6f72 7420 3d20 4578 706f 7274 546f 6f6c  ort = ExportTool
+000117e0: 2829 0a20 2020 2020 2020 2065 7870 6f72  ().        expor
+000117f0: 742e 7265 6769 7374 6572 5f70 6c6f 7428  t.register_plot(
+00011800: 726f 6f74 290a 2020 2020 2020 2020 726f  root).        ro
+00011810: 6f74 2e61 6464 5f74 6f6f 6c73 2865 7870  ot.add_tools(exp
+00011820: 6f72 7429 0a0a 2020 2020 7265 7475 726e  ort)..    return
+00011830: 2073 6f75 7263 652c 2072 6f6f 740a 0a0a   source, root...
+00011840: 636c 6173 7320 5461 736b 4772 6170 6828  class TaskGraph(
+00011850: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+00011860: 6e74 293a 0a20 2020 2022 2222 0a20 2020  nt):.    """.   
+00011870: 2041 2064 796e 616d 6963 206e 6f64 652d   A dynamic node-
+00011880: 6c69 6e6b 2064 6961 6772 616d 2066 6f72  link diagram for
+00011890: 2074 6865 2074 6173 6b20 6772 6170 6820   the task graph 
+000118a0: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
+000118b0: 0a0a 2020 2020 5365 6520 616c 736f 2074  ..    See also t
+000118c0: 6865 2047 7261 7068 4c61 796f 7574 2064  he GraphLayout d
+000118d0: 6961 676e 6f73 7469 6320 6174 0a20 2020  iagnostic at.   
+000118e0: 2064 6973 7472 6962 7574 6564 2f64 6961   distributed/dia
+000118f0: 676e 6f73 7469 6373 2f67 7261 7068 5f6c  gnostics/graph_l
+00011900: 6179 6f75 742e 7079 0a20 2020 2022 2222  ayout.py.    """
+00011910: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00011920: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+00011930: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+00011940: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+00011950: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+00011960: 720a 2020 2020 2020 2020 7365 6c66 2e6c  r.        self.l
+00011970: 6179 6f75 7420 3d20 4772 6170 684c 6179  ayout = GraphLay
+00011980: 6f75 7428 7363 6865 6475 6c65 7229 0a20  out(scheduler). 
+00011990: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+000119a0: 2e61 6464 5f70 6c75 6769 6e28 7365 6c66  .add_plugin(self
+000119b0: 2e6c 6179 6f75 7429 0a20 2020 2020 2020  .layout).       
+000119c0: 2073 656c 662e 696e 7669 7369 626c 655f   self.invisible_
+000119d0: 636f 756e 7420 3d20 3020 2023 206e 756d  count = 0  # num
+000119e0: 6265 7220 6f66 2069 6e76 6973 6962 6c65  ber of invisible
+000119f0: 206e 6f64 6573 0a0a 2020 2020 2020 2020   nodes..        
+00011a00: 7365 6c66 2e6e 6f64 655f 736f 7572 6365  self.node_source
+00011a10: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+00011a20: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
+00011a30: 207b 2278 223a 205b 5d2c 2022 7922 3a20   {"x": [], "y": 
+00011a40: 5b5d 2c20 226e 616d 6522 3a20 5b5d 2c20  [], "name": [], 
+00011a50: 2273 7461 7465 223a 205b 5d2c 2022 7669  "state": [], "vi
+00011a60: 7369 626c 6522 3a20 5b5d 2c20 226b 6579  sible": [], "key
+00011a70: 223a 205b 5d7d 0a20 2020 2020 2020 2029  ": []}.        )
+00011a80: 0a20 2020 2020 2020 2073 656c 662e 6564  .        self.ed
+00011a90: 6765 5f73 6f75 7263 6520 3d20 436f 6c75  ge_source = Colu
+00011aa0: 6d6e 4461 7461 536f 7572 6365 287b 2278  mnDataSource({"x
+00011ab0: 223a 205b 5d2c 2022 7922 3a20 5b5d 2c20  ": [], "y": [], 
+00011ac0: 2276 6973 6962 6c65 223a 205b 5d7d 290a  "visible": []}).
+00011ad0: 0a20 2020 2020 2020 2066 696c 7465 7220  .        filter 
+00011ae0: 3d20 4772 6f75 7046 696c 7465 7228 636f  = GroupFilter(co
+00011af0: 6c75 6d6e 5f6e 616d 653d 2276 6973 6962  lumn_name="visib
+00011b00: 6c65 222c 2067 726f 7570 3d22 5472 7565  le", group="True
+00011b10: 2229 0a20 2020 2020 2020 2069 6620 424f  ").        if BO
+00011b20: 4b45 485f 5645 5253 494f 4e2e 6d61 6a6f  KEH_VERSION.majo
+00011b30: 7220 3c20 333a 0a20 2020 2020 2020 2020  r < 3:.         
+00011b40: 2020 2066 696c 7465 725f 6b77 6172 6773     filter_kwargs
+00011b50: 203d 207b 2266 696c 7465 7273 223a 205b   = {"filters": [
+00011b60: 6669 6c74 6572 5d7d 0a20 2020 2020 2020  filter]}.       
+00011b70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00011b80: 2020 2066 696c 7465 725f 6b77 6172 6773     filter_kwargs
+00011b90: 203d 207b 2266 696c 7465 7222 3a20 6669   = {"filter": fi
+00011ba0: 6c74 6572 7d0a 2020 2020 2020 2020 6e6f  lter}.        no
+00011bb0: 6465 5f76 6965 7720 3d20 4344 5356 6965  de_view = CDSVie
+00011bc0: 7728 2a2a 6669 6c74 6572 5f6b 7761 7267  w(**filter_kwarg
+00011bd0: 7329 0a20 2020 2020 2020 2065 6467 655f  s).        edge_
+00011be0: 7669 6577 203d 2043 4453 5669 6577 282a  view = CDSView(*
+00011bf0: 2a66 696c 7465 725f 6b77 6172 6773 290a  *filter_kwargs).
+00011c00: 0a20 2020 2020 2020 2023 2042 6f6b 6568  .        # Bokeh
+00011c10: 203e 3d20 332e 3020 6175 746f 6d61 7469   >= 3.0 automati
+00011c20: 6361 6c6c 7920 696e 6665 7273 2074 6865  cally infers the
+00011c30: 2073 6f75 7263 6520 746f 2075 7365 0a20   source to use. 
+00011c40: 2020 2020 2020 2069 6620 424f 4b45 485f         if BOKEH_
+00011c50: 5645 5253 494f 4e2e 6d61 6a6f 7220 3c20  VERSION.major < 
+00011c60: 333a 0a20 2020 2020 2020 2020 2020 206e  3:.            n
+00011c70: 6f64 655f 7669 6577 2e73 6f75 7263 6520  ode_view.source 
+00011c80: 3d20 7365 6c66 2e6e 6f64 655f 736f 7572  = self.node_sour
+00011c90: 6365 0a20 2020 2020 2020 2020 2020 2065  ce.            e
+00011ca0: 6467 655f 7669 6577 2e73 6f75 7263 6520  dge_view.source 
+00011cb0: 3d20 7365 6c66 2e65 6467 655f 736f 7572  = self.edge_sour
+00011cc0: 6365 0a0a 2020 2020 2020 2020 6e6f 6465  ce..        node
+00011cd0: 5f63 6f6c 6f72 7320 3d20 6661 6374 6f72  _colors = factor
+00011ce0: 5f63 6d61 7028 0a20 2020 2020 2020 2020  _cmap(.         
+00011cf0: 2020 2022 7374 6174 6522 2c0a 2020 2020     "state",.    
+00011d00: 2020 2020 2020 2020 6661 6374 6f72 733d          factors=
+00011d10: 5b22 7761 6974 696e 6722 2c20 2271 7565  ["waiting", "que
+00011d20: 7565 6422 2c20 2270 726f 6365 7373 696e  ued", "processin
+00011d30: 6722 2c20 226d 656d 6f72 7922 2c20 2272  g", "memory", "r
+00011d40: 656c 6561 7365 6422 2c20 2265 7272 6564  eleased", "erred
+00011d50: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00011d60: 7061 6c65 7474 653d 5b22 6772 6179 222c  palette=["gray",
+00011d70: 2022 7965 6c6c 6f77 222c 2022 6772 6565   "yellow", "gree
+00011d80: 6e22 2c20 2272 6564 222c 2022 626c 7565  n", "red", "blue
+00011d90: 222c 2022 626c 6163 6b22 5d2c 0a20 2020  ", "black"],.   
+00011da0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00011db0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
+00011dc0: 7265 2874 6974 6c65 3d22 5461 736b 2047  re(title="Task G
+00011dd0: 7261 7068 222c 202a 2a6b 7761 7267 7329  raph", **kwargs)
+00011de0: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
+00011df0: 6274 6974 6c65 203d 2054 6974 6c65 2874  btitle = Title(t
+00011e00: 6578 743d 2220 222c 2074 6578 745f 666f  ext=" ", text_fo
+00011e10: 6e74 5f73 7479 6c65 3d22 6974 616c 6963  nt_style="italic
+00011e20: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00011e30: 726f 6f74 2e61 6464 5f6c 6179 6f75 7428  root.add_layout(
+00011e40: 7365 6c66 2e73 7562 7469 746c 652c 2022  self.subtitle, "
+00011e50: 6162 6f76 6522 290a 0a20 2020 2020 2020  above")..       
+00011e60: 2073 656c 662e 726f 6f74 2e6d 756c 7469   self.root.multi
+00011e70: 5f6c 696e 6528 0a20 2020 2020 2020 2020  _line(.         
+00011e80: 2020 2078 733d 2278 222c 0a20 2020 2020     xs="x",.     
+00011e90: 2020 2020 2020 2079 733d 2279 222c 0a20         ys="y",. 
+00011ea0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+00011eb0: 653d 7365 6c66 2e65 6467 655f 736f 7572  e=self.edge_sour
+00011ec0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00011ed0: 6c69 6e65 5f77 6964 7468 3d31 2c0a 2020  line_width=1,.  
+00011ee0: 2020 2020 2020 2020 2020 7669 6577 3d65            view=e
+00011ef0: 6467 655f 7669 6577 2c0a 2020 2020 2020  dge_view,.      
+00011f00: 2020 2020 2020 636f 6c6f 723d 2262 6c61        color="bla
+00011f10: 636b 222c 0a20 2020 2020 2020 2020 2020  ck",.           
+00011f20: 2061 6c70 6861 3d30 2e33 2c0a 2020 2020   alpha=0.3,.    
+00011f30: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00011f40: 6374 203d 2073 656c 662e 726f 6f74 2e73  ct = self.root.s
+00011f50: 7175 6172 6528 0a20 2020 2020 2020 2020  quare(.         
+00011f60: 2020 2078 3d22 7822 2c0a 2020 2020 2020     x="x",.      
+00011f70: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
+00011f80: 2020 2020 2020 2020 2073 697a 653d 3130           size=10
+00011f90: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00011fa0: 6c6f 723d 6e6f 6465 5f63 6f6c 6f72 732c  lor=node_colors,
+00011fb0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00011fc0: 7263 653d 7365 6c66 2e6e 6f64 655f 736f  rce=self.node_so
+00011fd0: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+00011fe0: 2020 7669 6577 3d6e 6f64 655f 7669 6577    view=node_view
+00011ff0: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+00012000: 6765 6e64 5f66 6965 6c64 3d22 7374 6174  gend_field="stat
+00012010: 6522 2c0a 2020 2020 2020 2020 290a 2020  e",.        ).  
+00012020: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00012030: 7867 7269 642e 6772 6964 5f6c 696e 655f  xgrid.grid_line_
+00012040: 636f 6c6f 7220 3d20 4e6f 6e65 0a20 2020  color = None.   
+00012050: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00012060: 6772 6964 2e67 7269 645f 6c69 6e65 5f63  grid.grid_line_c
+00012070: 6f6c 6f72 203d 204e 6f6e 650a 2020 2020  olor = None.    
+00012080: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
+00012090: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
+000120a0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+000120b0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
+000120c0: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
+000120d0: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
+000120e0: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
+000120f0: 2020 2020 706f 696e 745f 706f 6c69 6379      point_policy
+00012100: 3d22 666f 6c6c 6f77 5f6d 6f75 7365 222c  ="follow_mouse",
+00012110: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00012120: 6c74 6970 733d 223c 623e 406e 616d 653c  ltips="<b>@name<
+00012130: 2f62 3e3a 2040 7374 6174 6522 2c0a 2020  /b>: @state",.  
+00012140: 2020 2020 2020 2020 2020 7265 6e64 6572            render
+00012150: 6572 733d 5b72 6563 745d 2c0a 2020 2020  ers=[rect],.    
+00012160: 2020 2020 290a 2020 2020 2020 2020 7461      ).        ta
+00012170: 7020 3d20 5461 7054 6f6f 6c28 6361 6c6c  p = TapTool(call
+00012180: 6261 636b 3d4f 7065 6e55 524c 2875 726c  back=OpenURL(url
+00012190: 3d22 696e 666f 2f74 6173 6b2f 406b 6579  ="info/task/@key
+000121a0: 2e68 746d 6c22 292c 2072 656e 6465 7265  .html"), rendere
+000121b0: 7273 3d5b 7265 6374 5d29 0a20 2020 2020  rs=[rect]).     
+000121c0: 2020 2072 6563 742e 6e6f 6e73 656c 6563     rect.nonselec
+000121d0: 7469 6f6e 5f67 6c79 7068 203d 204e 6f6e  tion_glyph = Non
+000121e0: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
+000121f0: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
+00012200: 7665 722c 2074 6170 290a 2020 2020 2020  ver, tap).      
+00012210: 2020 7365 6c66 2e6d 6178 5f69 7465 6d73    self.max_items
+00012220: 203d 2063 6f6e 6669 672e 6765 7428 2264   = config.get("d
+00012230: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
+00012240: 6f61 7264 2e67 7261 7068 2d6d 6178 2d69  oard.graph-max-i
+00012250: 7465 6d73 222c 2035 3030 3029 0a0a 2020  tems", 5000)..  
+00012260: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+00012270: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00012280: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+00012290: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+000122a0: 6c66 293a 0a20 2020 2020 2020 2023 2049  lf):.        # I
+000122b0: 6620 7468 6572 6520 6172 6520 746f 6f20  f there are too 
+000122c0: 6d61 6e79 2074 6173 6b73 2069 6e20 7468  many tasks in th
+000122d0: 6520 7363 6865 6475 6c65 7220 7765 276c  e scheduler we'l
+000122e0: 6c20 6469 7361 626c 6520 7468 6973 0a20  l disable this. 
+000122f0: 2020 2020 2020 2023 2063 6f6d 706f 6f6e         # compoon
+00012300: 656e 7473 2074 6f20 6e6f 7420 6f76 6572  ents to not over
+00012310: 6c6f 6164 2073 6368 6564 756c 6572 206f  load scheduler o
+00012320: 7220 636c 6965 6e74 2e20 4f6e 6365 2077  r client. Once w
+00012330: 6520 6472 6f70 0a20 2020 2020 2020 2023  e drop.        #
+00012340: 2062 656c 6f77 2074 6865 2074 6872 6573   below the thres
+00012350: 686f 6c64 2c20 7468 6520 6461 7461 2069  hold, the data i
+00012360: 7320 6669 6c6c 6564 2075 7020 6167 6169  s filled up agai
+00012370: 6e20 6173 2075 7375 616c 0a20 2020 2020  n as usual.     
+00012380: 2020 2069 6620 6c65 6e28 7365 6c66 2e73     if len(self.s
+00012390: 6368 6564 756c 6572 2e74 6173 6b73 2920  cheduler.tasks) 
+000123a0: 3e20 7365 6c66 2e6d 6178 5f69 7465 6d73  > self.max_items
+000123b0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000123c0: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
+000123d0: 203d 2022 5363 6865 6475 6c65 7220 6861   = "Scheduler ha
+000123e0: 7320 746f 6f20 6d61 6e79 2074 6173 6b73  s too many tasks
+000123f0: 2074 6f20 6469 7370 6c61 792e 220a 2020   to display.".  
+00012400: 2020 2020 2020 2020 2020 666f 7220 636f            for co
+00012410: 6e74 6169 6e65 7220 696e 205b 7365 6c66  ntainer in [self
+00012420: 2e6e 6f64 655f 736f 7572 6365 2c20 7365  .node_source, se
+00012430: 6c66 2e65 6467 655f 736f 7572 6365 5d3a  lf.edge_source]:
+00012440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012450: 2063 6f6e 7461 696e 6572 2e64 6174 6120   container.data 
+00012460: 3d20 7b63 6f6c 3a20 5b5d 2066 6f72 2063  = {col: [] for c
+00012470: 6f6c 2069 6e20 636f 6e74 6169 6e65 722e  ol in container.
+00012480: 636f 6c75 6d6e 5f6e 616d 6573 7d0a 2020  column_names}.  
+00012490: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000124a0: 2020 2020 2020 2020 2320 6f63 6361 7369          # occasi
+000124b0: 6f6e 616c 6c79 2072 6573 6574 2074 6865  onally reset the
+000124c0: 2063 6f6c 756d 6e20 6461 7461 2073 6f75   column data sou
+000124d0: 7263 6520 746f 2072 656d 6f76 6520 6f6c  rce to remove ol
+000124e0: 6420 6e6f 6465 730a 2020 2020 2020 2020  d nodes.        
+000124f0: 2020 2020 6966 2073 656c 662e 696e 7669      if self.invi
+00012500: 7369 626c 655f 636f 756e 7420 3e20 6c65  sible_count > le
+00012510: 6e28 7365 6c66 2e6e 6f64 655f 736f 7572  n(self.node_sour
+00012520: 6365 2e64 6174 615b 2278 225d 2920 2f20  ce.data["x"]) / 
+00012530: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00012540: 2020 2073 656c 662e 6c61 796f 7574 2e72     self.layout.r
+00012550: 6573 6574 5f69 6e64 6578 2829 0a20 2020  eset_index().   
+00012560: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00012570: 662e 696e 7669 7369 626c 655f 636f 756e  f.invisible_coun
+00012580: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
+00012590: 2020 2020 2020 7570 6461 7465 203d 2054        update = T
+000125a0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+000125b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000125c0: 2020 2020 2020 7570 6461 7465 203d 2046        update = F
+000125d0: 616c 7365 0a0a 2020 2020 2020 2020 2020  alse..          
+000125e0: 2020 6e65 772c 2073 656c 662e 6c61 796f    new, self.layo
+000125f0: 7574 2e6e 6577 203d 2073 656c 662e 6c61  ut.new = self.la
+00012600: 796f 7574 2e6e 6577 2c20 5b5d 0a20 2020  yout.new, [].   
+00012610: 2020 2020 2020 2020 206e 6577 5f65 6467           new_edg
+00012620: 6573 203d 2073 656c 662e 6c61 796f 7574  es = self.layout
+00012630: 2e6e 6577 5f65 6467 6573 0a20 2020 2020  .new_edges.     
+00012640: 2020 2020 2020 2073 656c 662e 6c61 796f         self.layo
+00012650: 7574 2e6e 6577 5f65 6467 6573 203d 205b  ut.new_edges = [
+00012660: 5d0a 0a20 2020 2020 2020 2020 2020 2073  ]..            s
+00012670: 656c 662e 6164 645f 6e65 775f 6e6f 6465  elf.add_new_node
+00012680: 735f 6564 6765 7328 6e65 772c 206e 6577  s_edges(new, new
+00012690: 5f65 6467 6573 2c20 7570 6461 7465 3d75  _edges, update=u
+000126a0: 7064 6174 6529 0a0a 2020 2020 2020 2020  pdate)..        
+000126b0: 2020 2020 7365 6c66 2e70 6174 6368 5f75      self.patch_u
+000126c0: 7064 6174 6573 2829 0a0a 2020 2020 2020  pdates()..      
+000126d0: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
+000126e0: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
+000126f0: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
+00012700: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
+00012710: 6274 6974 6c65 2e74 6578 7420 3d20 2253  btitle.text = "S
+00012720: 6368 6564 756c 6572 2069 7320 656d 7074  cheduler is empt
+00012730: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
+00012740: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012750: 2020 2020 2020 7365 6c66 2e73 7562 7469        self.subti
+00012760: 746c 652e 7465 7874 203d 2022 2022 0a0a  tle.text = " "..
+00012770: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
+00012780: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+00012790: 0a20 2020 2064 6566 2061 6464 5f6e 6577  .    def add_new
+000127a0: 5f6e 6f64 6573 5f65 6467 6573 2873 656c  _nodes_edges(sel
+000127b0: 662c 206e 6577 2c20 6e65 775f 6564 6765  f, new, new_edge
+000127c0: 732c 2075 7064 6174 653d 4661 6c73 6529  s, update=False)
+000127d0: 3a0a 2020 2020 2020 2020 6966 206e 6577  :.        if new
+000127e0: 206f 7220 7570 6461 7465 3a0a 2020 2020   or update:.    
+000127f0: 2020 2020 2020 2020 6e6f 6465 5f6b 6579          node_key
+00012800: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00012810: 2020 6e6f 6465 5f78 203d 205b 5d0a 2020    node_x = [].  
+00012820: 2020 2020 2020 2020 2020 6e6f 6465 5f79            node_y
+00012830: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00012840: 2020 6e6f 6465 5f73 7461 7465 203d 205b    node_state = [
+00012850: 5d0a 2020 2020 2020 2020 2020 2020 6e6f  ].            no
+00012860: 6465 5f6e 616d 6520 3d20 5b5d 0a20 2020  de_name = [].   
+00012870: 2020 2020 2020 2020 2065 6467 655f 7820           edge_x 
+00012880: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00012890: 2065 6467 655f 7920 3d20 5b5d 0a0a 2020   edge_y = []..  
+000128a0: 2020 2020 2020 2020 2020 7820 3d20 7365            x = se
+000128b0: 6c66 2e6c 6179 6f75 742e 780a 2020 2020  lf.layout.x.    
+000128c0: 2020 2020 2020 2020 7920 3d20 7365 6c66          y = self
+000128d0: 2e6c 6179 6f75 742e 790a 0a20 2020 2020  .layout.y..     
+000128e0: 2020 2020 2020 2074 6173 6b73 203d 2073         tasks = s
+000128f0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+00012900: 736b 730a 2020 2020 2020 2020 2020 2020  sks.            
+00012910: 666f 7220 6b65 7920 696e 206e 6577 3a0a  for key in new:.
+00012920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012930: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00012940: 2020 2020 2020 2020 2074 6173 6b20 3d20           task = 
+00012950: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+00012960: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00012970: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012990: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+000129a0: 2020 2020 2020 2020 2078 7820 3d20 785b           xx = x[
+000129b0: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
+000129c0: 2020 2020 2079 7920 3d20 795b 6b65 795d       yy = y[key]
 000129d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000129e0: 206e 6f64 655f 782e 6170 7065 6e64 2878   node_x.append(x
-000129f0: 7829 0a20 2020 2020 2020 2020 2020 2020  x).             
-00012a00: 2020 206e 6f64 655f 792e 6170 7065 6e64     node_y.append
-00012a10: 2879 7929 0a20 2020 2020 2020 2020 2020  (yy).           
-00012a20: 2020 2020 206e 6f64 655f 7374 6174 652e       node_state.
-00012a30: 6170 7065 6e64 2874 6173 6b2e 7374 6174  append(task.stat
-00012a40: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00012a50: 2020 206e 6f64 655f 6e61 6d65 2e61 7070     node_name.app
-00012a60: 656e 6428 7461 736b 2e70 7265 6669 782e  end(task.prefix.
-00012a70: 6e61 6d65 290a 0a20 2020 2020 2020 2020  name)..         
-00012a80: 2020 2066 6f72 2061 2c20 6220 696e 206e     for a, b in n
-00012a90: 6577 5f65 6467 6573 3a0a 2020 2020 2020  ew_edges:.      
-00012aa0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00012ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ac0: 2020 2065 6467 655f 782e 6170 7065 6e64     edge_x.append
-00012ad0: 285b 785b 615d 2c20 785b 625d 5d29 0a20  ([x[a], x[b]]). 
-00012ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012af0: 2020 2065 6467 655f 792e 6170 7065 6e64     edge_y.append
-00012b00: 285b 795b 615d 2c20 795b 625d 5d29 0a20  ([y[a], y[b]]). 
-00012b10: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012b20: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-00012b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b40: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
-00012b50: 2020 2020 2020 6e6f 6465 203d 207b 0a20        node = {. 
-00012b60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00012b70: 7822 3a20 6e6f 6465 5f78 2c0a 2020 2020  x": node_x,.    
-00012b80: 2020 2020 2020 2020 2020 2020 2279 223a              "y":
-00012b90: 206e 6f64 655f 792c 0a20 2020 2020 2020   node_y,.       
-00012ba0: 2020 2020 2020 2020 2022 7374 6174 6522           "state"
-00012bb0: 3a20 6e6f 6465 5f73 7461 7465 2c0a 2020  : node_state,.  
-00012bc0: 2020 2020 2020 2020 2020 2020 2020 226e                "n
-00012bd0: 616d 6522 3a20 6e6f 6465 5f6e 616d 652c  ame": node_name,
-00012be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012bf0: 2022 6b65 7922 3a20 6e6f 6465 5f6b 6579   "key": node_key
-00012c00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012c10: 2020 2276 6973 6962 6c65 223a 205b 2254    "visible": ["T
-00012c20: 7275 6522 5d20 2a20 6c65 6e28 6e6f 6465  rue"] * len(node
-00012c30: 5f78 292c 0a20 2020 2020 2020 2020 2020  _x),.           
-00012c40: 207d 0a20 2020 2020 2020 2020 2020 2065   }.            e
-00012c50: 6467 6520 3d20 7b22 7822 3a20 6564 6765  dge = {"x": edge
-00012c60: 5f78 2c20 2279 223a 2065 6467 655f 792c  _x, "y": edge_y,
-00012c70: 2022 7669 7369 626c 6522 3a20 5b22 5472   "visible": ["Tr
-00012c80: 7565 225d 202a 206c 656e 2865 6467 655f  ue"] * len(edge_
-00012c90: 7829 7d0a 0a20 2020 2020 2020 2020 2020  x)}..           
-00012ca0: 2069 6620 7570 6461 7465 206f 7220 6e6f   if update or no
-00012cb0: 7420 6c65 6e28 7365 6c66 2e6e 6f64 655f  t len(self.node_
-00012cc0: 736f 7572 6365 2e64 6174 615b 2278 225d  source.data["x"]
-00012cd0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012ce0: 2020 2023 2073 6565 2068 7474 7073 3a2f     # see https:/
-00012cf0: 2f67 6974 6875 622e 636f 6d2f 626f 6b65  /github.com/boke
-00012d00: 682f 626f 6b65 682f 6973 7375 6573 2f37  h/bokeh/issues/7
-00012d10: 3532 330a 2020 2020 2020 2020 2020 2020  523.            
-00012d20: 2020 2020 7365 6c66 2e6e 6f64 655f 736f      self.node_so
-00012d30: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
-00012d40: 286e 6f64 6529 0a20 2020 2020 2020 2020  (node).         
-00012d50: 2020 2020 2020 2073 656c 662e 6564 6765         self.edge
-00012d60: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
-00012d70: 6174 6528 6564 6765 290a 2020 2020 2020  ate(edge).      
-00012d80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00012d90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012da0: 2e6e 6f64 655f 736f 7572 6365 2e73 7472  .node_source.str
-00012db0: 6561 6d28 6e6f 6465 290a 2020 2020 2020  eam(node).      
-00012dc0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-00012dd0: 6467 655f 736f 7572 6365 2e73 7472 6561  dge_source.strea
-00012de0: 6d28 6564 6765 290a 0a20 2020 2040 7769  m(edge)..    @wi
-00012df0: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
-00012e00: 616c 6964 6174 696f 6e0a 2020 2020 6465  alidation.    de
-00012e10: 6620 7061 7463 685f 7570 6461 7465 7328  f patch_updates(
-00012e20: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
-00012e30: 2222 0a20 2020 2020 2020 2053 6d61 6c6c  "".        Small
-00012e40: 2075 7064 6174 6573 206c 696b 6520 636f   updates like co
-00012e50: 6c6f 7220 6368 616e 6765 7320 6f72 206c  lor changes or l
-00012e60: 6f73 7420 6e6f 6465 7320 6672 6f6d 2074  ost nodes from t
-00012e70: 6173 6b20 7472 616e 7369 7469 6f6e 730a  ask transitions.
-00012e80: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00012e90: 2020 2020 6e20 3d20 6c65 6e28 7365 6c66      n = len(self
-00012ea0: 2e6e 6f64 655f 736f 7572 6365 2e64 6174  .node_source.dat
-00012eb0: 615b 2278 225d 290a 2020 2020 2020 2020  a["x"]).        
-00012ec0: 6d20 3d20 6c65 6e28 7365 6c66 2e65 6467  m = len(self.edg
-00012ed0: 655f 736f 7572 6365 2e64 6174 615b 2278  e_source.data["x
-00012ee0: 225d 290a 0a20 2020 2020 2020 2069 6620  "])..        if 
-00012ef0: 7365 6c66 2e6c 6179 6f75 742e 7374 6174  self.layout.stat
-00012f00: 655f 7570 6461 7465 733a 0a20 2020 2020  e_updates:.     
-00012f10: 2020 2020 2020 2073 7461 7465 5f75 7064         state_upd
-00012f20: 6174 6573 203d 2073 656c 662e 6c61 796f  ates = self.layo
-00012f30: 7574 2e73 7461 7465 5f75 7064 6174 6573  ut.state_updates
-00012f40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012f50: 662e 6c61 796f 7574 2e73 7461 7465 5f75  f.layout.state_u
-00012f60: 7064 6174 6573 203d 205b 5d0a 2020 2020  pdates = [].    
-00012f70: 2020 2020 2020 2020 7570 6461 7465 7320          updates 
-00012f80: 3d20 5b28 692c 2063 2920 666f 7220 692c  = [(i, c) for i,
-00012f90: 2063 2069 6e20 7374 6174 655f 7570 6461   c in state_upda
-00012fa0: 7465 7320 6966 2069 203c 206e 5d0a 2020  tes if i < n].  
-00012fb0: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
-00012fc0: 6f64 655f 736f 7572 6365 2e70 6174 6368  ode_source.patch
-00012fd0: 287b 2273 7461 7465 223a 2075 7064 6174  ({"state": updat
-00012fe0: 6573 7d29 0a0a 2020 2020 2020 2020 6966  es})..        if
-00012ff0: 2073 656c 662e 6c61 796f 7574 2e76 6973   self.layout.vis
-00013000: 6962 6c65 5f75 7064 6174 6573 3a0a 2020  ible_updates:.  
-00013010: 2020 2020 2020 2020 2020 7570 6461 7465            update
-00013020: 7320 3d20 7365 6c66 2e6c 6179 6f75 742e  s = self.layout.
-00013030: 7669 7369 626c 655f 7570 6461 7465 730a  visible_updates.
-00013040: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-00013050: 7465 7320 3d20 5b28 692c 2063 2920 666f  tes = [(i, c) fo
-00013060: 7220 692c 2063 2069 6e20 7570 6461 7465  r i, c in update
-00013070: 7320 6966 2069 203c 206e 5d0a 2020 2020  s if i < n].    
-00013080: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
-00013090: 6f75 742e 7669 7369 626c 655f 7570 6461  out.visible_upda
-000130a0: 7465 7320 3d20 5b5d 0a20 2020 2020 2020  tes = [].       
-000130b0: 2020 2020 2073 656c 662e 6e6f 6465 5f73       self.node_s
-000130c0: 6f75 7263 652e 7061 7463 6828 7b22 7669  ource.patch({"vi
-000130d0: 7369 626c 6522 3a20 7570 6461 7465 737d  sible": updates}
-000130e0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000130f0: 6c66 2e69 6e76 6973 6962 6c65 5f63 6f75  lf.invisible_cou
-00013100: 6e74 202b 3d20 6c65 6e28 7570 6461 7465  nt += len(update
-00013110: 7329 0a0a 2020 2020 2020 2020 6966 2073  s)..        if s
-00013120: 656c 662e 6c61 796f 7574 2e76 6973 6962  elf.layout.visib
-00013130: 6c65 5f65 6467 655f 7570 6461 7465 733a  le_edge_updates:
-00013140: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
-00013150: 6174 6573 203d 2073 656c 662e 6c61 796f  ates = self.layo
+000129e0: 206e 6f64 655f 6b65 792e 6170 7065 6e64   node_key.append
+000129f0: 2865 7363 6170 652e 7572 6c5f 6573 6361  (escape.url_esca
+00012a00: 7065 286b 6579 2929 0a20 2020 2020 2020  pe(key)).       
+00012a10: 2020 2020 2020 2020 206e 6f64 655f 782e           node_x.
+00012a20: 6170 7065 6e64 2878 7829 0a20 2020 2020  append(xx).     
+00012a30: 2020 2020 2020 2020 2020 206e 6f64 655f             node_
+00012a40: 792e 6170 7065 6e64 2879 7929 0a20 2020  y.append(yy).   
+00012a50: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00012a60: 655f 7374 6174 652e 6170 7065 6e64 2874  e_state.append(t
+00012a70: 6173 6b2e 7374 6174 6529 0a20 2020 2020  ask.state).     
+00012a80: 2020 2020 2020 2020 2020 206e 6f64 655f             node_
+00012a90: 6e61 6d65 2e61 7070 656e 6428 7461 736b  name.append(task
+00012aa0: 2e70 7265 6669 782e 6e61 6d65 290a 0a20  .prefix.name).. 
+00012ab0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+00012ac0: 2c20 6220 696e 206e 6577 5f65 6467 6573  , b in new_edges
+00012ad0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012ae0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00012af0: 2020 2020 2020 2020 2020 2065 6467 655f             edge_
+00012b00: 782e 6170 7065 6e64 285b 785b 615d 2c20  x.append([x[a], 
+00012b10: 785b 625d 5d29 0a20 2020 2020 2020 2020  x[b]]).         
+00012b20: 2020 2020 2020 2020 2020 2065 6467 655f             edge_
+00012b30: 792e 6170 7065 6e64 285b 795b 615d 2c20  y.append([y[a], 
+00012b40: 795b 625d 5d29 0a20 2020 2020 2020 2020  y[b]]).         
+00012b50: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00012b60: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+00012b70: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00012b80: 0a0a 2020 2020 2020 2020 2020 2020 6e6f  ..            no
+00012b90: 6465 203d 207b 0a20 2020 2020 2020 2020  de = {.         
+00012ba0: 2020 2020 2020 2022 7822 3a20 6e6f 6465         "x": node
+00012bb0: 5f78 2c0a 2020 2020 2020 2020 2020 2020  _x,.            
+00012bc0: 2020 2020 2279 223a 206e 6f64 655f 792c      "y": node_y,
+00012bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012be0: 2022 7374 6174 6522 3a20 6e6f 6465 5f73   "state": node_s
+00012bf0: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
+00012c00: 2020 2020 2020 226e 616d 6522 3a20 6e6f        "name": no
+00012c10: 6465 5f6e 616d 652c 0a20 2020 2020 2020  de_name,.       
+00012c20: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
+00012c30: 6e6f 6465 5f6b 6579 2c0a 2020 2020 2020  node_key,.      
+00012c40: 2020 2020 2020 2020 2020 2276 6973 6962            "visib
+00012c50: 6c65 223a 205b 2254 7275 6522 5d20 2a20  le": ["True"] * 
+00012c60: 6c65 6e28 6e6f 6465 5f78 292c 0a20 2020  len(node_x),.   
+00012c70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00012c80: 2020 2020 2020 2065 6467 6520 3d20 7b22         edge = {"
+00012c90: 7822 3a20 6564 6765 5f78 2c20 2279 223a  x": edge_x, "y":
+00012ca0: 2065 6467 655f 792c 2022 7669 7369 626c   edge_y, "visibl
+00012cb0: 6522 3a20 5b22 5472 7565 225d 202a 206c  e": ["True"] * l
+00012cc0: 656e 2865 6467 655f 7829 7d0a 0a20 2020  en(edge_x)}..   
+00012cd0: 2020 2020 2020 2020 2069 6620 7570 6461           if upda
+00012ce0: 7465 206f 7220 6e6f 7420 6c65 6e28 7365  te or not len(se
+00012cf0: 6c66 2e6e 6f64 655f 736f 7572 6365 2e64  lf.node_source.d
+00012d00: 6174 615b 2278 225d 293a 0a20 2020 2020  ata["x"]):.     
+00012d10: 2020 2020 2020 2020 2020 2023 2073 6565             # see
+00012d20: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
+00012d30: 636f 6d2f 626f 6b65 682f 626f 6b65 682f  com/bokeh/bokeh/
+00012d40: 6973 7375 6573 2f37 3532 330a 2020 2020  issues/7523.    
+00012d50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012d60: 2e6e 6f64 655f 736f 7572 6365 2e64 6174  .node_source.dat
+00012d70: 612e 7570 6461 7465 286e 6f64 6529 0a20  a.update(node). 
+00012d80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00012d90: 656c 662e 6564 6765 5f73 6f75 7263 652e  elf.edge_source.
+00012da0: 6461 7461 2e75 7064 6174 6528 6564 6765  data.update(edge
+00012db0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00012dc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00012dd0: 2020 2020 7365 6c66 2e6e 6f64 655f 736f      self.node_so
+00012de0: 7572 6365 2e73 7472 6561 6d28 6e6f 6465  urce.stream(node
+00012df0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012e00: 2020 7365 6c66 2e65 6467 655f 736f 7572    self.edge_sour
+00012e10: 6365 2e73 7472 6561 6d28 6564 6765 290a  ce.stream(edge).
+00012e20: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+00012e30: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+00012e40: 6e0a 2020 2020 6465 6620 7061 7463 685f  n.    def patch_
+00012e50: 7570 6461 7465 7328 7365 6c66 293a 0a20  updates(self):. 
+00012e60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00012e70: 2020 2053 6d61 6c6c 2075 7064 6174 6573     Small updates
+00012e80: 206c 696b 6520 636f 6c6f 7220 6368 616e   like color chan
+00012e90: 6765 7320 6f72 206c 6f73 7420 6e6f 6465  ges or lost node
+00012ea0: 7320 6672 6f6d 2074 6173 6b20 7472 616e  s from task tran
+00012eb0: 7369 7469 6f6e 730a 2020 2020 2020 2020  sitions.        
+00012ec0: 2222 220a 2020 2020 2020 2020 6e20 3d20  """.        n = 
+00012ed0: 6c65 6e28 7365 6c66 2e6e 6f64 655f 736f  len(self.node_so
+00012ee0: 7572 6365 2e64 6174 615b 2278 225d 290a  urce.data["x"]).
+00012ef0: 2020 2020 2020 2020 6d20 3d20 6c65 6e28          m = len(
+00012f00: 7365 6c66 2e65 6467 655f 736f 7572 6365  self.edge_source
+00012f10: 2e64 6174 615b 2278 225d 290a 0a20 2020  .data["x"])..   
+00012f20: 2020 2020 2069 6620 7365 6c66 2e6c 6179       if self.lay
+00012f30: 6f75 742e 7374 6174 655f 7570 6461 7465  out.state_update
+00012f40: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+00012f50: 7461 7465 5f75 7064 6174 6573 203d 2073  tate_updates = s
+00012f60: 656c 662e 6c61 796f 7574 2e73 7461 7465  elf.layout.state
+00012f70: 5f75 7064 6174 6573 0a20 2020 2020 2020  _updates.       
+00012f80: 2020 2020 2073 656c 662e 6c61 796f 7574       self.layout
+00012f90: 2e73 7461 7465 5f75 7064 6174 6573 203d  .state_updates =
+00012fa0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00012fb0: 7570 6461 7465 7320 3d20 5b28 692c 2063  updates = [(i, c
+00012fc0: 2920 666f 7220 692c 2063 2069 6e20 7374  ) for i, c in st
+00012fd0: 6174 655f 7570 6461 7465 7320 6966 2069  ate_updates if i
+00012fe0: 203c 206e 5d0a 2020 2020 2020 2020 2020   < n].          
+00012ff0: 2020 7365 6c66 2e6e 6f64 655f 736f 7572    self.node_sour
+00013000: 6365 2e70 6174 6368 287b 2273 7461 7465  ce.patch({"state
+00013010: 223a 2075 7064 6174 6573 7d29 0a0a 2020  ": updates})..  
+00013020: 2020 2020 2020 6966 2073 656c 662e 6c61        if self.la
+00013030: 796f 7574 2e76 6973 6962 6c65 5f75 7064  yout.visible_upd
+00013040: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
+00013050: 2020 7570 6461 7465 7320 3d20 7365 6c66    updates = self
+00013060: 2e6c 6179 6f75 742e 7669 7369 626c 655f  .layout.visible_
+00013070: 7570 6461 7465 730a 2020 2020 2020 2020  updates.        
+00013080: 2020 2020 7570 6461 7465 7320 3d20 5b28      updates = [(
+00013090: 692c 2063 2920 666f 7220 692c 2063 2069  i, c) for i, c i
+000130a0: 6e20 7570 6461 7465 7320 6966 2069 203c  n updates if i <
+000130b0: 206e 5d0a 2020 2020 2020 2020 2020 2020   n].            
+000130c0: 7365 6c66 2e6c 6179 6f75 742e 7669 7369  self.layout.visi
+000130d0: 626c 655f 7570 6461 7465 7320 3d20 5b5d  ble_updates = []
+000130e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000130f0: 662e 6e6f 6465 5f73 6f75 7263 652e 7061  f.node_source.pa
+00013100: 7463 6828 7b22 7669 7369 626c 6522 3a20  tch({"visible": 
+00013110: 7570 6461 7465 737d 290a 2020 2020 2020  updates}).      
+00013120: 2020 2020 2020 7365 6c66 2e69 6e76 6973        self.invis
+00013130: 6962 6c65 5f63 6f75 6e74 202b 3d20 6c65  ible_count += le
+00013140: 6e28 7570 6461 7465 7329 0a0a 2020 2020  n(updates)..    
+00013150: 2020 2020 6966 2073 656c 662e 6c61 796f      if self.layo
 00013160: 7574 2e76 6973 6962 6c65 5f65 6467 655f  ut.visible_edge_
-00013170: 7570 6461 7465 730a 2020 2020 2020 2020  updates.        
-00013180: 2020 2020 7570 6461 7465 7320 3d20 5b28      updates = [(
-00013190: 692c 2063 2920 666f 7220 692c 2063 2069  i, c) for i, c i
-000131a0: 6e20 7570 6461 7465 7320 6966 2069 203c  n updates if i <
-000131b0: 206d 5d0a 2020 2020 2020 2020 2020 2020   m].            
-000131c0: 7365 6c66 2e6c 6179 6f75 742e 7669 7369  self.layout.visi
-000131d0: 626c 655f 6564 6765 5f75 7064 6174 6573  ble_edge_updates
-000131e0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-000131f0: 2020 7365 6c66 2e65 6467 655f 736f 7572    self.edge_sour
-00013200: 6365 2e70 6174 6368 287b 2276 6973 6962  ce.patch({"visib
-00013210: 6c65 223a 2075 7064 6174 6573 7d29 0a0a  le": updates})..
-00013220: 2020 2020 6465 6620 5f5f 6465 6c5f 5f28      def __del__(
-00013230: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00013240: 656c 662e 7363 6865 6475 6c65 722e 7265  elf.scheduler.re
-00013250: 6d6f 7665 5f70 6c75 6769 6e28 6e61 6d65  move_plugin(name
-00013260: 3d73 656c 662e 6c61 796f 7574 2e6e 616d  =self.layout.nam
-00013270: 6529 0a0a 0a63 6c61 7373 2054 6173 6b47  e)...class TaskG
-00013280: 726f 7570 4772 6170 6828 4461 7368 626f  roupGraph(Dashbo
-00013290: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
-000132a0: 2020 2022 2222 0a20 2020 2054 6173 6b20     """.    Task 
-000132b0: 4772 6f75 7020 4772 6170 680a 0a20 2020  Group Graph..   
-000132c0: 2043 7265 6174 6573 2061 2067 7261 7068   Creates a graph
-000132d0: 206c 6179 6f75 7420 666f 7220 5461 736b   layout for Task
-000132e0: 4772 6f75 7073 206f 6e20 7468 6520 7363  Groups on the sc
-000132f0: 6865 6475 6c65 722e 2020 4974 2061 7373  heduler.  It ass
-00013300: 6967 6e73 0a20 2020 2028 782c 2079 2920  igns.    (x, y) 
-00013310: 6c6f 6361 7469 6f6e 7320 746f 2061 6c6c  locations to all
-00013320: 2074 6865 2054 6173 6b47 726f 7570 7320   the TaskGroups 
-00013330: 616e 6420 6c61 7973 2074 6865 6d20 6f75  and lays them ou
-00013340: 7420 6279 2061 6363 6f72 6469 6e67 0a20  t by according. 
-00013350: 2020 2074 6f20 7468 6569 7220 6465 7065     to their depe
-00013360: 6e64 656e 6369 6573 2e20 5468 6520 6c61  ndencies. The la
-00013370: 796f 7574 2067 6574 7320 7570 6461 7465  yout gets update
-00013380: 6420 6576 6572 7920 7469 6d65 2074 6861  d every time tha
-00013390: 7420 6e65 770a 2020 2020 5461 736b 4772  t new.    TaskGr
-000133a0: 6f75 7073 2061 7265 2061 6464 6564 2e0a  oups are added..
-000133b0: 0a20 2020 2045 6163 6820 7461 736b 2067  .    Each task g
-000133c0: 726f 7570 206e 6f64 6520 696e 636f 6465  roup node incode
-000133d0: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
-000133e0: 6f75 7420 7461 736b 2070 726f 6772 6573  out task progres
-000133f0: 732c 206d 656d 6f72 792c 0a20 2020 2061  s, memory,.    a
-00013400: 6e64 206f 7574 7075 7420 7479 7065 2069  nd output type i
-00013410: 6e74 6f20 676c 7970 6873 2c20 6173 2077  nto glyphs, as w
-00013420: 656c 6c20 6173 2061 2068 6f76 6572 2074  ell as a hover t
-00013430: 6f6f 6c74 6970 2077 6974 6820 6d6f 7265  ooltip with more
-00013440: 2064 6574 6169 6c65 640a 2020 2020 696e   detailed.    in
-00013450: 666f 726d 6174 696f 6e20 6f6e 206e 616d  formation on nam
-00013460: 652c 2063 6f6d 7075 7461 7469 6f6e 2074  e, computation t
-00013470: 696d 652c 206d 656d 6f72 792c 2061 6e64  ime, memory, and
-00013480: 2074 6173 6b73 2073 7461 7475 732e 0a20   tasks status.. 
-00013490: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-000134a0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-000134b0: 6368 6564 756c 6572 2c20 2a2a 6b77 6172  cheduler, **kwar
-000134c0: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
-000134d0: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-000134e0: 6865 6475 6c65 720a 0a20 2020 2020 2020  heduler..       
-000134f0: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
-00013500: 7574 203d 207b 7d0a 2020 2020 2020 2020  ut = {}.        
-00013510: 7365 6c66 2e61 7272 6f77 735f 6c61 796f  self.arrows_layo
-00013520: 7574 203d 207b 7d0a 0a20 2020 2020 2020  ut = {}..       
-00013530: 2073 656c 662e 6f6c 645f 636f 756e 7465   self.old_counte
-00013540: 7220 3d20 2d31 0a0a 2020 2020 2020 2020  r = -1..        
-00013550: 7365 6c66 2e6e 6f64 6573 5f73 6f75 7263  self.nodes_sourc
-00013560: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
-00013570: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
-00013580: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00013590: 2020 2020 2278 223a 205b 5d2c 0a20 2020      "x": [],.   
-000135a0: 2020 2020 2020 2020 2020 2020 2022 7922               "y"
-000135b0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000135c0: 2020 2020 2020 2277 5f62 6f78 223a 205b        "w_box": [
-000135d0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000135e0: 2020 2022 685f 626f 7822 3a20 5b5d 2c0a     "h_box": [],.
-000135f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013600: 226e 616d 6522 3a20 5b5d 2c0a 2020 2020  "name": [],.    
-00013610: 2020 2020 2020 2020 2020 2020 2274 6f74              "tot
-00013620: 5f74 6173 6b73 223a 205b 5d2c 0a20 2020  _tasks": [],.   
-00013630: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-00013640: 6c6f 7222 3a20 5b5d 2c0a 2020 2020 2020  lor": [],.      
-00013650: 2020 2020 2020 2020 2020 2278 5f73 7461            "x_sta
-00013660: 7274 223a 205b 5d2c 0a20 2020 2020 2020  rt": [],.       
-00013670: 2020 2020 2020 2020 2022 785f 656e 6422           "x_end"
-00013680: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00013690: 2020 2020 2020 2279 5f73 7461 7274 223a        "y_start":
-000136a0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000136b0: 2020 2020 2022 795f 656e 6422 3a20 5b5d       "y_end": []
-000136c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000136d0: 2020 2278 5f65 6e64 5f70 726f 6772 6573    "x_end_progres
-000136e0: 7322 3a20 5b5d 2c0a 2020 2020 2020 2020  s": [],.        
-000136f0: 2020 2020 2020 2020 226d 656d 5f61 6c70          "mem_alp
-00013700: 6861 223a 205b 5d2c 0a20 2020 2020 2020  ha": [],.       
-00013710: 2020 2020 2020 2020 2022 6e6f 6465 5f6c           "node_l
-00013720: 696e 655f 7769 6474 6822 3a20 5b5d 2c0a  ine_width": [],.
-00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013740: 2263 6f6d 705f 7461 736b 7322 3a20 5b5d  "comp_tasks": []
-00013750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013760: 2020 2275 726c 5f6c 6f67 6f22 3a20 5b5d    "url_logo": []
-00013770: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013780: 2020 2278 5f6c 6f67 6f22 3a20 5b5d 2c0a    "x_logo": [],.
-00013790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137a0: 2279 5f6c 6f67 6f22 3a20 5b5d 2c0a 2020  "y_logo": [],.  
-000137b0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-000137c0: 5f6c 6f67 6f22 3a20 5b5d 2c0a 2020 2020  _logo": [],.    
-000137d0: 2020 2020 2020 2020 2020 2020 2268 5f6c              "h_l
-000137e0: 6f67 6f22 3a20 5b5d 2c0a 2020 2020 2020  ogo": [],.      
-000137f0: 2020 2020 2020 2020 2020 2269 6e5f 7072            "in_pr
-00013800: 6f63 6573 7369 6e67 223a 205b 5d2c 0a20  ocessing": [],. 
-00013810: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00013820: 696e 5f6d 656d 6f72 7922 3a20 5b5d 2c0a  in_memory": [],.
-00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013840: 2269 6e5f 7265 6c65 6173 6564 223a 205b  "in_released": [
-00013850: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00013860: 2020 2022 696e 5f65 7272 6564 223a 205b     "in_erred": [
-00013870: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00013880: 2020 2022 636f 6d70 7574 655f 7469 6d65     "compute_time
-00013890: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-000138a0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-000138b0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000138c0: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
-000138d0: 2020 2020 2020 7365 6c66 2e61 7272 6f77        self.arrow
-000138e0: 735f 736f 7572 6365 203d 2043 6f6c 756d  s_source = Colum
-000138f0: 6e44 6174 6153 6f75 7263 6528 7b22 7873  nDataSource({"xs
-00013900: 223a 205b 5d2c 2022 7973 223a 205b 5d2c  ": [], "ys": [],
-00013910: 2022 7865 223a 205b 5d2c 2022 7965 223a   "xe": [], "ye":
-00013920: 205b 5d7d 290a 0a20 2020 2020 2020 2073   []})..        s
-00013930: 656c 662e 726f 6f74 203d 2066 6967 7572  elf.root = figur
-00013940: 6528 7469 746c 653d 2254 6173 6b20 4772  e(title="Task Gr
-00013950: 6f75 7073 2047 7261 7068 222c 206d 6174  oups Graph", mat
-00013960: 6368 5f61 7370 6563 743d 5472 7565 2c20  ch_aspect=True, 
-00013970: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-00013980: 2020 7365 6c66 2e72 6f6f 742e 6178 6973    self.root.axis
-00013990: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-000139a0: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
-000139b0: 6274 6974 6c65 203d 2054 6974 6c65 2874  btitle = Title(t
-000139c0: 6578 743d 2220 222c 2074 6578 745f 666f  ext=" ", text_fo
-000139d0: 6e74 5f73 7479 6c65 3d22 6974 616c 6963  nt_style="italic
-000139e0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-000139f0: 726f 6f74 2e61 6464 5f6c 6179 6f75 7428  root.add_layout(
-00013a00: 7365 6c66 2e73 7562 7469 746c 652c 2022  self.subtitle, "
-00013a10: 6162 6f76 6522 290a 0a20 2020 2020 2020  above")..       
-00013a20: 2072 6563 7420 3d20 7365 6c66 2e72 6f6f   rect = self.roo
-00013a30: 742e 7265 6374 280a 2020 2020 2020 2020  t.rect(.        
-00013a40: 2020 2020 783d 2278 222c 0a20 2020 2020      x="x",.     
-00013a50: 2020 2020 2020 2079 3d22 7922 2c0a 2020         y="y",.  
-00013a60: 2020 2020 2020 2020 2020 7769 6474 683d            width=
-00013a70: 2277 5f62 6f78 222c 0a20 2020 2020 2020  "w_box",.       
-00013a80: 2020 2020 2068 6569 6768 743d 2268 5f62       height="h_b
-00013a90: 6f78 222c 0a20 2020 2020 2020 2020 2020  ox",.           
-00013aa0: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
-00013ab0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00013ac0: 5f61 6c70 6861 3d22 6d65 6d5f 616c 7068  _alpha="mem_alph
-00013ad0: 6122 2c0a 2020 2020 2020 2020 2020 2020  a",.            
-00013ae0: 6c69 6e65 5f63 6f6c 6f72 3d22 626c 6163  line_color="blac
-00013af0: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
-00013b00: 6c69 6e65 5f77 6964 7468 3d22 6e6f 6465  line_width="node
-00013b10: 5f6c 696e 655f 7769 6474 6822 2c0a 2020  _line_width",.  
-00013b20: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00013b30: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
-00013b40: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
-00013b50: 2020 2020 2020 2023 2070 6c6f 7420 7467         # plot tg
-00013b60: 206c 6f67 0a20 2020 2020 2020 2073 656c   log.        sel
-00013b70: 662e 726f 6f74 2e69 6d61 6765 5f75 726c  f.root.image_url
-00013b80: 280a 2020 2020 2020 2020 2020 2020 7572  (.            ur
-00013b90: 6c3d 2275 726c 5f6c 6f67 6f22 2c0a 2020  l="url_logo",.  
-00013ba0: 2020 2020 2020 2020 2020 783d 2278 5f6c            x="x_l
-00013bb0: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
-00013bc0: 2020 793d 2279 5f6c 6f67 6f22 2c0a 2020    y="y_logo",.  
-00013bd0: 2020 2020 2020 2020 2020 773d 2277 5f6c            w="w_l
-00013be0: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
-00013bf0: 2020 683d 2268 5f6c 6f67 6f22 2c0a 2020    h="h_logo",.  
-00013c00: 2020 2020 2020 2020 2020 616e 6368 6f72            anchor
-00013c10: 3d22 6365 6e74 6572 222c 0a20 2020 2020  ="center",.     
-00013c20: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-00013c30: 6c66 2e6e 6f64 6573 5f73 6f75 7263 652c  lf.nodes_source,
-00013c40: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00013c50: 2020 2020 2320 7072 6f67 7265 7373 2062      # progress b
-00013c60: 6172 2070 6c61 696e 2062 6f78 0a20 2020  ar plain box.   
-00013c70: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
-00013c80: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
-00013c90: 206c 6566 743d 2278 5f73 7461 7274 222c   left="x_start",
-00013ca0: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-00013cb0: 6874 3d22 785f 656e 6422 2c0a 2020 2020  ht="x_end",.    
-00013cc0: 2020 2020 2020 2020 626f 7474 6f6d 3d22          bottom="
-00013cd0: 795f 7374 6172 7422 2c0a 2020 2020 2020  y_start",.      
-00013ce0: 2020 2020 2020 746f 703d 2279 5f65 6e64        top="y_end
-00013cf0: 222c 0a20 2020 2020 2020 2020 2020 2063  ",.            c
-00013d00: 6f6c 6f72 3d4e 6f6e 652c 0a20 2020 2020  olor=None,.     
-00013d10: 2020 2020 2020 206c 696e 655f 636f 6c6f         line_colo
-00013d20: 723d 2262 6c61 636b 222c 0a20 2020 2020  r="black",.     
-00013d30: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-00013d40: 6c66 2e6e 6f64 6573 5f73 6f75 7263 652c  lf.nodes_source,
-00013d50: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00013d60: 2020 2020 2320 7072 6f67 7265 7373 2062      # progress b
-00013d70: 6172 0a20 2020 2020 2020 2073 656c 662e  ar.        self.
-00013d80: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
-00013d90: 2020 2020 2020 206c 6566 743d 2278 5f73         left="x_s
-00013da0: 7461 7274 222c 0a20 2020 2020 2020 2020  tart",.         
-00013db0: 2020 2072 6967 6874 3d22 785f 656e 645f     right="x_end_
-00013dc0: 7072 6f67 7265 7373 222c 0a20 2020 2020  progress",.     
-00013dd0: 2020 2020 2020 2062 6f74 746f 6d3d 2279         bottom="y
-00013de0: 5f73 7461 7274 222c 0a20 2020 2020 2020  _start",.       
-00013df0: 2020 2020 2074 6f70 3d22 795f 656e 6422       top="y_end"
-00013e00: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-00013e10: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-00013e20: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-00013e30: 6c6f 723d 4e6f 6e65 2c0a 2020 2020 2020  lor=None,.      
-00013e40: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
-00013e50: 3d30 2e36 2c0a 2020 2020 2020 2020 2020  =0.6,.          
-00013e60: 2020 736f 7572 6365 3d73 656c 662e 6e6f    source=self.no
-00013e70: 6465 735f 736f 7572 6365 2c0a 2020 2020  des_source,.    
-00013e80: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00013e90: 656c 662e 6172 726f 7773 203d 2041 7272  elf.arrows = Arr
-00013ea0: 6f77 280a 2020 2020 2020 2020 2020 2020  ow(.            
-00013eb0: 656e 643d 5665 6548 6561 6428 7369 7a65  end=VeeHead(size
-00013ec0: 3d38 292c 0a20 2020 2020 2020 2020 2020  =8),.           
-00013ed0: 206c 696e 655f 636f 6c6f 723d 2262 6c61   line_color="bla
-00013ee0: 636b 222c 0a20 2020 2020 2020 2020 2020  ck",.           
-00013ef0: 206c 696e 655f 616c 7068 613d 302e 352c   line_alpha=0.5,
-00013f00: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00013f10: 655f 7769 6474 683d 312c 0a20 2020 2020  e_width=1,.     
-00013f20: 2020 2020 2020 2078 5f73 7461 7274 3d22         x_start="
-00013f30: 7873 222c 0a20 2020 2020 2020 2020 2020  xs",.           
-00013f40: 2079 5f73 7461 7274 3d22 7973 222c 0a20   y_start="ys",. 
-00013f50: 2020 2020 2020 2020 2020 2078 5f65 6e64             x_end
-00013f60: 3d22 7865 222c 0a20 2020 2020 2020 2020  ="xe",.         
-00013f70: 2020 2079 5f65 6e64 3d22 7965 222c 0a20     y_end="ye",. 
-00013f80: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00013f90: 653d 7365 6c66 2e61 7272 6f77 735f 736f  e=self.arrows_so
-00013fa0: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
-00013fb0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00013fc0: 742e 6164 645f 6c61 796f 7574 2873 656c  t.add_layout(sel
-00013fd0: 662e 6172 726f 7773 290a 0a20 2020 2020  f.arrows)..     
-00013fe0: 2020 2073 656c 662e 726f 6f74 2e78 6772     self.root.xgr
-00013ff0: 6964 2e67 7269 645f 6c69 6e65 5f63 6f6c  id.grid_line_col
-00014000: 6f72 203d 204e 6f6e 650a 2020 2020 2020  or = None.      
-00014010: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
-00014020: 642e 6772 6964 5f6c 696e 655f 636f 6c6f  d.grid_line_colo
-00014030: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
-00014040: 2073 656c 662e 726f 6f74 2e78 5f72 616e   self.root.x_ran
-00014050: 6765 2e72 616e 6765 5f70 6164 6469 6e67  ge.range_padding
-00014060: 203d 2030 2e35 0a20 2020 2020 2020 2073   = 0.5.        s
-00014070: 656c 662e 726f 6f74 2e79 5f72 616e 6765  elf.root.y_range
-00014080: 2e72 616e 6765 5f70 6164 6469 6e67 203d  .range_padding =
-00014090: 2030 2e35 0a0a 2020 2020 2020 2020 686f   0.5..        ho
-000140a0: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
-000140b0: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
-000140c0: 6e74 5f70 6f6c 6963 793d 2266 6f6c 6c6f  nt_policy="follo
-000140d0: 775f 6d6f 7573 6522 2c0a 2020 2020 2020  w_mouse",.      
-000140e0: 2020 2020 2020 746f 6f6c 7469 7073 3d22        tooltips="
-000140f0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-00014100: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-00014110: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-00014120: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-00014130: 697a 653a 2031 3270 783b 2066 6f6e 742d  ize: 12px; font-
-00014140: 7765 6967 6874 3a20 626f 6c64 3b22 3e4e  weight: bold;">N
-00014150: 616d 653a 3c2f 7370 616e 3e26 6e62 7370  ame:</span>&nbsp
-00014160: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00014170: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00014180: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
-00014190: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
-000141a0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
-000141b0: 6365 3b22 3e40 6e61 6d65 3c2f 7370 616e  ce;">@name</span
-000141c0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000141d0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-000141e0: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-000141f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014200: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00014210: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00014220: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00014230: 6c64 3b22 3e43 6f6d 7075 7465 2074 696d  ld;">Compute tim
-00014240: 653a 3c2f 7370 616e 3e26 6e62 7370 3b0a  e:</span>&nbsp;.
-00014250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014260: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-00014270: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-00014280: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-00014290: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-000142a0: 3b22 3e40 636f 6d70 7574 655f 7469 6d65  ;">@compute_time
-000142b0: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-000142c0: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-000142d0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-000142e0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-000142f0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-00014300: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00014310: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
-00014320: 6874 3a20 626f 6c64 3b22 3e4d 656d 6f72  ht: bold;">Memor
-00014330: 793a 3c2f 7370 616e 3e26 6e62 7370 3b0a  y:</span>&nbsp;.
-00014340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014350: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-00014360: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-00014370: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-00014380: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-00014390: 3b22 3e40 6d65 6d6f 7279 3c2f 7370 616e  ;">@memory</span
-000143a0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000143b0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-000143c0: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-000143d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143e0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-000143f0: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00014400: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00014410: 6c64 3b22 3e54 6173 6b73 3a3c 2f73 7061  ld;">Tasks:</spa
-00014420: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-00014430: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-00014440: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-00014450: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
-00014460: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
-00014470: 6d6f 6e6f 7370 6163 653b 223e 4074 6f74  monospace;">@tot
-00014480: 5f74 6173 6b73 3c2f 7370 616e 3e0a 2020  _tasks</span>.  
-00014490: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-000144a0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-000144b0: 2020 2020 203c 6469 7620 7374 796c 653d       <div style=
-000144c0: 226d 6172 6769 6e2d 6c65 6674 3a20 3265  "margin-left: 2e
-000144d0: 6d3b 223e 0a20 2020 2020 2020 2020 2020  m;">.           
-000144e0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-000144f0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00014500: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
-00014510: 6874 3a20 626f 6c64 3b22 3e43 6f6d 706c  ht: bold;">Compl
-00014520: 6574 6564 3a3c 2f73 7061 6e3e 266e 6273  eted:</span>&nbs
-00014530: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-00014540: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00014550: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00014560: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00014570: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-00014580: 6163 653b 223e 4063 6f6d 705f 7461 736b  ace;">@comp_task
-00014590: 733c 2f73 7061 6e3e 0a20 2020 2020 2020  s</span>.       
-000145a0: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
-000145b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145c0: 3c64 6976 2073 7479 6c65 3d22 6d61 7267  <div style="marg
-000145d0: 696e 2d6c 6566 743a 2032 656d 3b22 3e0a  in-left: 2em;">.
-000145e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145f0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-00014600: 2266 6f6e 742d 7369 7a65 3a20 3132 7078  "font-size: 12px
-00014610: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
-00014620: 6f6c 643b 223e 5072 6f63 6573 7369 6e67  old;">Processing
-00014630: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014650: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00014660: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-00014670: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-00014680: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-00014690: 223e 4069 6e5f 7072 6f63 6573 7369 6e67  ">@in_processing
-000146a0: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-000146b0: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-000146c0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-000146d0: 6469 7620 7374 796c 653d 226d 6172 6769  div style="margi
-000146e0: 6e2d 6c65 6674 3a20 3265 6d3b 223e 0a20  n-left: 2em;">. 
-000146f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014700: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00014710: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00014720: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00014730: 6c64 3b22 3e49 6e20 6d65 6d6f 7279 3a3c  ld;">In memory:<
-00014740: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
-00014750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014760: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00014770: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-00014780: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-00014790: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-000147a0: 4069 6e5f 6d65 6d6f 7279 3c2f 7370 616e  @in_memory</span
-000147b0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000147c0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-000147d0: 2020 2020 2020 2020 203c 6469 7620 7374           <div st
-000147e0: 796c 653d 226d 6172 6769 6e2d 6c65 6674  yle="margin-left
-000147f0: 3a20 3265 6d3b 223e 0a20 2020 2020 2020  : 2em;">.       
-00014800: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-00014810: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-00014820: 697a 653a 2031 3270 783b 2066 6f6e 742d  ize: 12px; font-
-00014830: 7765 6967 6874 3a20 626f 6c64 3b22 3e45  weight: bold;">E
-00014840: 7272 6564 3a3c 2f73 7061 6e3e 266e 6273  rred:</span>&nbs
-00014850: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-00014860: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00014870: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00014880: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00014890: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-000148a0: 6163 653b 223e 4069 6e5f 6572 7265 643c  ace;">@in_erred<
-000148b0: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
-000148c0: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
-000148d0: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
-000148e0: 6976 2073 7479 6c65 3d22 6d61 7267 696e  iv style="margin
-000148f0: 2d6c 6566 743a 2032 656d 3b22 3e0a 2020  -left: 2em;">.  
-00014900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014910: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-00014920: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
-00014930: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
-00014940: 643b 223e 5265 6c65 6173 6564 3a3c 2f73  d;">Released:</s
-00014950: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
-00014960: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014970: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00014980: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-00014990: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-000149a0: 2c20 6d6f 6e6f 7370 6163 653b 223e 4069  , monospace;">@i
-000149b0: 6e5f 7265 6c65 6173 6564 3c2f 7370 616e  n_released</span
-000149c0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000149d0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-000149e0: 2020 2020 2020 2020 2022 2222 2c0a 2020           """,.  
-000149f0: 2020 2020 2020 2020 2020 7265 6e64 6572            render
-00014a00: 6572 733d 5b72 6563 745d 2c0a 2020 2020  ers=[rect],.    
-00014a10: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00014a20: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
-00014a30: 6c73 2868 6f76 6572 290a 0a20 2020 2040  ls(hover)..    @
-00014a40: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-00014a50: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-00014a60: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00014a70: 6465 6620 7570 6461 7465 5f6c 6179 6f75  def update_layou
-00014a80: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00014a90: 2023 2047 6574 2064 6570 656e 6465 6e63   # Get dependenc
-00014aa0: 6965 7320 7065 7220 7461 736b 2067 726f  ies per task gro
-00014ab0: 7570 2e0a 2020 2020 2020 2020 2320 496e  up..        # In
-00014ac0: 2073 6f6d 6520 6361 7365 7320 7468 6572   some cases ther
-00014ad0: 6520 6172 6520 7467 2074 6861 7420 6861  e are tg that ha
-00014ae0: 7665 2074 6865 6d73 656c 7665 7320 6173  ve themselves as
-00014af0: 2064 6570 656e 6465 6e63 6965 7320 2d20   dependencies - 
-00014b00: 7765 2072 656d 6f76 6520 7468 6f73 652e  we remove those.
-00014b10: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
-00014b20: 6e63 6965 7320 3d20 7b0a 2020 2020 2020  ncies = {.      
-00014b30: 2020 2020 2020 6b3a 207b 6473 2e6e 616d        k: {ds.nam
-00014b40: 6520 666f 7220 6473 2069 6e20 7473 2e64  e for ds in ts.d
-00014b50: 6570 656e 6465 6e63 6965 7320 6966 2064  ependencies if d
-00014b60: 732e 6e61 6d65 2021 3d20 6b7d 0a20 2020  s.name != k}.   
-00014b70: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
-00014b80: 7473 2069 6e20 7365 6c66 2e73 6368 6564  ts in self.sched
-00014b90: 756c 6572 2e74 6173 6b5f 6772 6f75 7073  uler.task_groups
-00014ba0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-00014bb0: 207d 0a0a 2020 2020 2020 2020 696d 706f   }..        impo
-00014bc0: 7274 2064 6173 6b0a 0a20 2020 2020 2020  rt dask..       
-00014bd0: 206f 7264 6572 203d 2064 6173 6b2e 6f72   order = dask.or
-00014be0: 6465 722e 6f72 6465 7228 0a20 2020 2020  der.order(.     
-00014bf0: 2020 2020 2020 2064 736b 3d7b 6772 6f75         dsk={grou
-00014c00: 702e 6e61 6d65 3a20 3120 666f 7220 6b2c  p.name: 1 for k,
-00014c10: 2067 726f 7570 2069 6e20 7365 6c66 2e73   group in self.s
-00014c20: 6368 6564 756c 6572 2e74 6173 6b5f 6772  cheduler.task_gr
-00014c30: 6f75 7073 2e69 7465 6d73 2829 7d2c 0a20  oups.items()},. 
-00014c40: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00014c50: 6465 6e63 6965 733d 6465 7065 6e64 656e  dencies=dependen
-00014c60: 6369 6573 2c0a 2020 2020 2020 2020 290a  cies,.        ).
-00014c70: 0a20 2020 2020 2020 206f 7264 6572 6564  .        ordered
-00014c80: 203d 2073 6f72 7465 6428 7365 6c66 2e73   = sorted(self.s
-00014c90: 6368 6564 756c 6572 2e74 6173 6b5f 6772  cheduler.task_gr
-00014ca0: 6f75 7073 2c20 6b65 793d 6f72 6465 722e  oups, key=order.
-00014cb0: 6765 7429 0a0a 2020 2020 2020 2020 7873  get)..        xs
-00014cc0: 203d 207b 7d0a 2020 2020 2020 2020 7973   = {}.        ys
-00014cd0: 203d 207b 7d0a 2020 2020 2020 2020 6c6f   = {}.        lo
-00014ce0: 6361 7469 6f6e 7320 3d20 7365 7428 290a  cations = set().
-00014cf0: 2020 2020 2020 2020 6e6f 6465 735f 6c61          nodes_la
-00014d00: 796f 7574 203d 207b 7d0a 2020 2020 2020  yout = {}.      
-00014d10: 2020 6172 726f 7773 5f6c 6179 6f75 7420    arrows_layout 
-00014d20: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-00014d30: 2074 6720 696e 206f 7264 6572 6564 3a0a   tg in ordered:.
-00014d40: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00014d50: 6570 656e 6465 6e63 6965 735b 7467 5d3a  ependencies[tg]:
-00014d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014d70: 2078 203d 206d 6178 2878 735b 6465 705d   x = max(xs[dep]
-00014d80: 2066 6f72 2064 6570 2069 6e20 6465 7065   for dep in depe
-00014d90: 6e64 656e 6369 6573 5b74 675d 2920 2b20  ndencies[tg]) + 
-00014da0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00014db0: 2020 7920 3d20 6d61 7828 7973 5b64 6570    y = max(ys[dep
-00014dc0: 5d20 666f 7220 6465 7020 696e 2064 6570  ] for dep in dep
-00014dd0: 656e 6465 6e63 6965 735b 7467 5d29 0a20  endencies[tg]). 
-00014de0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014df0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00014e00: 2020 2020 2020 2020 6c65 6e28 6465 7065          len(depe
-00014e10: 6e64 656e 6369 6573 5b74 675d 2920 3e20  ndencies[tg]) > 
-00014e20: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00014e30: 2020 2020 2020 616e 6420 6c65 6e28 7b79        and len({y
-00014e40: 735b 6465 705d 2066 6f72 2064 6570 2069  s[dep] for dep i
-00014e50: 6e20 6465 7065 6e64 656e 6369 6573 5b74  n dependencies[t
-00014e60: 675d 7d29 203d 3d20 310a 2020 2020 2020  g]}) == 1.      
-00014e70: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
-00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e90: 2079 202b 3d20 310a 2020 2020 2020 2020   y += 1.        
-00014ea0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00014eb0: 2020 2020 2020 2020 2020 7820 3d20 300a            x = 0.
-00014ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ed0: 7920 3d20 6d61 7828 7973 2e76 616c 7565  y = max(ys.value
-00014ee0: 7328 2929 202b 2031 2069 6620 7973 2065  s()) + 1 if ys e
-00014ef0: 6c73 6520 300a 0a20 2020 2020 2020 2020  lse 0..         
-00014f00: 2020 2077 6869 6c65 2028 782c 2079 2920     while (x, y) 
-00014f10: 696e 206c 6f63 6174 696f 6e73 3a20 2023  in locations:  #
-00014f20: 2061 766f 6964 2063 6f6c 6c69 7369 6f6e   avoid collision
-00014f30: 7320 6279 206d 6f76 696e 6720 7570 0a20  s by moving up. 
-00014f40: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00014f50: 202b 3d20 310a 0a20 2020 2020 2020 2020   += 1..         
-00014f60: 2020 206c 6f63 6174 696f 6e73 2e61 6464     locations.add
-00014f70: 2828 782c 2079 2929 0a0a 2020 2020 2020  ((x, y))..      
-00014f80: 2020 2020 2020 7873 5b74 675d 2c20 7973        xs[tg], ys
-00014f90: 5b74 675d 203d 2078 2c20 790a 0a20 2020  [tg] = x, y..   
-00014fa0: 2020 2020 2020 2020 2023 2069 6e66 6f20           # info 
-00014fb0: 6e65 6564 6564 2066 6f72 206e 6f64 6520  needed for node 
-00014fc0: 6c61 796f 7574 2074 6f20 636f 6c75 6d6e  layout to column
-00014fd0: 2064 6174 6120 736f 7572 6365 0a20 2020   data source.   
-00014fe0: 2020 2020 2020 2020 206e 6f64 6573 5f6c           nodes_l
-00014ff0: 6179 6f75 745b 7467 5d20 3d20 7b22 7822  ayout[tg] = {"x"
-00015000: 3a20 7873 5b74 675d 2c20 2279 223a 2079  : xs[tg], "y": y
-00015010: 735b 7467 5d7d 0a0a 2020 2020 2020 2020  s[tg]}..        
-00015020: 2020 2020 2320 696e 666f 206e 6565 6465      # info neede
-00015030: 6420 666f 7220 6172 726f 7720 6c61 796f  d for arrow layo
-00015040: 7574 0a20 2020 2020 2020 2020 2020 2061  ut.            a
-00015050: 7272 6f77 735f 6c61 796f 7574 5b74 675d  rrows_layout[tg]
-00015060: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00015070: 2020 2020 2022 6e73 7461 7274 223a 2064       "nstart": d
-00015080: 6570 656e 6465 6e63 6965 735b 7467 5d2c  ependencies[tg],
-00015090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000150a0: 2022 6e65 6e64 223a 205b 7467 5d20 2a20   "nend": [tg] * 
-000150b0: 6c65 6e28 6465 7065 6e64 656e 6369 6573  len(dependencies
-000150c0: 5b74 675d 292c 0a20 2020 2020 2020 2020  [tg]),.         
-000150d0: 2020 207d 0a0a 2020 2020 2020 2020 7265     }..        re
-000150e0: 7475 726e 206e 6f64 6573 5f6c 6179 6f75  turn nodes_layou
-000150f0: 742c 2061 7272 6f77 735f 6c61 796f 7574  t, arrows_layout
-00015100: 0a0a 2020 2020 6465 6620 636f 6d70 7574  ..    def comput
-00015110: 655f 7369 7a65 2873 656c 662c 2078 2c20  e_size(self, x, 
-00015120: 6d69 6e5f 626f 782c 206d 6178 5f62 6f78  min_box, max_box
-00015130: 293a 0a20 2020 2020 2020 2073 7461 7274  ):.        start
-00015140: 203d 2030 2e34 0a20 2020 2020 2020 2065   = 0.4.        e
-00015150: 6e64 203d 2030 2e38 0a0a 2020 2020 2020  nd = 0.8..      
-00015160: 2020 7920 3d20 2865 6e64 202d 2073 7461    y = (end - sta
-00015170: 7274 2920 2f20 286d 6178 5f62 6f78 202d  rt) / (max_box -
-00015180: 206d 696e 5f62 6f78 2920 2a20 2878 202d   min_box) * (x -
-00015190: 206d 696e 5f62 6f78 2920 2b20 7374 6172   min_box) + star
-000151a0: 740a 0a20 2020 2020 2020 2072 6574 7572  t..        retur
-000151b0: 6e20 790a 0a20 2020 2040 7769 7468 6f75  n y..    @withou
-000151c0: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
-000151d0: 6174 696f 6e0a 2020 2020 6465 6620 7570  ation.    def up
-000151e0: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
-000151f0: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
-00015200: 6475 6c65 722e 7472 616e 7369 7469 6f6e  duler.transition
-00015210: 5f63 6f75 6e74 6572 203d 3d20 7365 6c66  _counter == self
-00015220: 2e6f 6c64 5f63 6f75 6e74 6572 3a0a 2020  .old_counter:.  
-00015230: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00015240: 0a20 2020 2020 2020 2073 656c 662e 6f6c  .        self.ol
-00015250: 645f 636f 756e 7465 7220 3d20 7365 6c66  d_counter = self
-00015260: 2e73 6368 6564 756c 6572 2e74 7261 6e73  .scheduler.trans
-00015270: 6974 696f 6e5f 636f 756e 7465 720a 0a20  ition_counter.. 
-00015280: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00015290: 6c66 2e73 6368 6564 756c 6572 2e74 6173  lf.scheduler.tas
-000152a0: 6b5f 6772 6f75 7073 3a0a 2020 2020 2020  k_groups:.      
-000152b0: 2020 2020 2020 7365 6c66 2e73 7562 7469        self.subti
-000152c0: 746c 652e 7465 7874 203d 2022 5363 6865  tle.text = "Sche
-000152d0: 6475 6c65 7220 6973 2065 6d70 7479 2e22  duler is empty."
-000152e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000152f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00015300: 7375 6274 6974 6c65 2e74 6578 7420 3d20  subtitle.text = 
-00015310: 2220 220a 0a20 2020 2020 2020 2069 6620  " "..        if 
-00015320: 7365 6c66 2e6e 6f64 6573 5f6c 6179 6f75  self.nodes_layou
-00015330: 742e 6b65 7973 2829 2021 3d20 7365 6c66  t.keys() != self
-00015340: 2e73 6368 6564 756c 6572 2e74 6173 6b5f  .scheduler.task_
-00015350: 6772 6f75 7073 2e6b 6579 7328 293a 0a20  groups.keys():. 
-00015360: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00015370: 6e6f 6465 735f 6c61 796f 7574 2c20 7365  nodes_layout, se
-00015380: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
-00015390: 203d 2073 656c 662e 7570 6461 7465 5f6c   = self.update_l
-000153a0: 6179 6f75 7428 290a 0a20 2020 2020 2020  ayout()..       
-000153b0: 206e 6f64 6573 5f64 6174 6120 3d20 7b0a   nodes_data = {.
-000153c0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
-000153d0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000153e0: 2022 7922 3a20 5b5d 2c0a 2020 2020 2020   "y": [],.      
-000153f0: 2020 2020 2020 2277 5f62 6f78 223a 205b        "w_box": [
-00015400: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00015410: 685f 626f 7822 3a20 5b5d 2c0a 2020 2020  h_box": [],.    
-00015420: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-00015430: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015440: 2263 6f6c 6f72 223a 205b 5d2c 0a20 2020  "color": [],.   
-00015450: 2020 2020 2020 2020 2022 746f 745f 7461           "tot_ta
-00015460: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
-00015470: 2020 2020 2020 2278 5f73 7461 7274 223a        "x_start":
+00013170: 7570 6461 7465 733a 0a20 2020 2020 2020  updates:.       
+00013180: 2020 2020 2075 7064 6174 6573 203d 2073       updates = s
+00013190: 656c 662e 6c61 796f 7574 2e76 6973 6962  elf.layout.visib
+000131a0: 6c65 5f65 6467 655f 7570 6461 7465 730a  le_edge_updates.
+000131b0: 2020 2020 2020 2020 2020 2020 7570 6461              upda
+000131c0: 7465 7320 3d20 5b28 692c 2063 2920 666f  tes = [(i, c) fo
+000131d0: 7220 692c 2063 2069 6e20 7570 6461 7465  r i, c in update
+000131e0: 7320 6966 2069 203c 206d 5d0a 2020 2020  s if i < m].    
+000131f0: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
+00013200: 6f75 742e 7669 7369 626c 655f 6564 6765  out.visible_edge
+00013210: 5f75 7064 6174 6573 203d 205b 5d0a 2020  _updates = [].  
+00013220: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00013230: 6467 655f 736f 7572 6365 2e70 6174 6368  dge_source.patch
+00013240: 287b 2276 6973 6962 6c65 223a 2075 7064  ({"visible": upd
+00013250: 6174 6573 7d29 0a0a 2020 2020 6465 6620  ates})..    def 
+00013260: 5f5f 6465 6c5f 5f28 7365 6c66 293a 0a20  __del__(self):. 
+00013270: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+00013280: 6475 6c65 722e 7265 6d6f 7665 5f70 6c75  duler.remove_plu
+00013290: 6769 6e28 6e61 6d65 3d73 656c 662e 6c61  gin(name=self.la
+000132a0: 796f 7574 2e6e 616d 6529 0a0a 0a63 6c61  yout.name)...cla
+000132b0: 7373 2054 6173 6b47 726f 7570 4772 6170  ss TaskGroupGrap
+000132c0: 6828 4461 7368 626f 6172 6443 6f6d 706f  h(DashboardCompo
+000132d0: 6e65 6e74 293a 0a20 2020 2022 2222 0a20  nent):.    """. 
+000132e0: 2020 2054 6173 6b20 4772 6f75 7020 4772     Task Group Gr
+000132f0: 6170 680a 0a20 2020 2043 7265 6174 6573  aph..    Creates
+00013300: 2061 2067 7261 7068 206c 6179 6f75 7420   a graph layout 
+00013310: 666f 7220 5461 736b 4772 6f75 7073 206f  for TaskGroups o
+00013320: 6e20 7468 6520 7363 6865 6475 6c65 722e  n the scheduler.
+00013330: 2020 4974 2061 7373 6967 6e73 0a20 2020    It assigns.   
+00013340: 2028 782c 2079 2920 6c6f 6361 7469 6f6e   (x, y) location
+00013350: 7320 746f 2061 6c6c 2074 6865 2054 6173  s to all the Tas
+00013360: 6b47 726f 7570 7320 616e 6420 6c61 7973  kGroups and lays
+00013370: 2074 6865 6d20 6f75 7420 6279 2061 6363   them out by acc
+00013380: 6f72 6469 6e67 0a20 2020 2074 6f20 7468  ording.    to th
+00013390: 6569 7220 6465 7065 6e64 656e 6369 6573  eir dependencies
+000133a0: 2e20 5468 6520 6c61 796f 7574 2067 6574  . The layout get
+000133b0: 7320 7570 6461 7465 6420 6576 6572 7920  s updated every 
+000133c0: 7469 6d65 2074 6861 7420 6e65 770a 2020  time that new.  
+000133d0: 2020 5461 736b 4772 6f75 7073 2061 7265    TaskGroups are
+000133e0: 2061 6464 6564 2e0a 0a20 2020 2045 6163   added...    Eac
+000133f0: 6820 7461 736b 2067 726f 7570 206e 6f64  h task group nod
+00013400: 6520 696e 636f 6465 7320 696e 666f 726d  e incodes inform
+00013410: 6174 696f 6e20 6162 6f75 7420 7461 736b  ation about task
+00013420: 2070 726f 6772 6573 732c 206d 656d 6f72   progress, memor
+00013430: 792c 0a20 2020 2061 6e64 206f 7574 7075  y,.    and outpu
+00013440: 7420 7479 7065 2069 6e74 6f20 676c 7970  t type into glyp
+00013450: 6873 2c20 6173 2077 656c 6c20 6173 2061  hs, as well as a
+00013460: 2068 6f76 6572 2074 6f6f 6c74 6970 2077   hover tooltip w
+00013470: 6974 6820 6d6f 7265 2064 6574 6169 6c65  ith more detaile
+00013480: 640a 2020 2020 696e 666f 726d 6174 696f  d.    informatio
+00013490: 6e20 6f6e 206e 616d 652c 2063 6f6d 7075  n on name, compu
+000134a0: 7461 7469 6f6e 2074 696d 652c 206d 656d  tation time, mem
+000134b0: 6f72 792c 2061 6e64 2074 6173 6b73 2073  ory, and tasks s
+000134c0: 7461 7475 732e 0a20 2020 2022 2222 0a0a  tatus..    """..
+000134d0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000134e0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+000134f0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00013500: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00013510: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+00013520: 0a20 2020 2020 2020 2073 656c 662e 6e6f  .        self.no
+00013530: 6465 735f 6c61 796f 7574 203d 207b 7d0a  des_layout = {}.
+00013540: 2020 2020 2020 2020 7365 6c66 2e61 7272          self.arr
+00013550: 6f77 735f 6c61 796f 7574 203d 207b 7d0a  ows_layout = {}.
+00013560: 0a20 2020 2020 2020 2073 656c 662e 6f6c  .        self.ol
+00013570: 645f 636f 756e 7465 7220 3d20 2d31 0a0a  d_counter = -1..
+00013580: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
+00013590: 6573 5f73 6f75 7263 6520 3d20 436f 6c75  es_source = Colu
+000135a0: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
+000135b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000135c0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
+000135d0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000135e0: 2020 2020 2022 7922 3a20 5b5d 2c0a 2020       "y": [],.  
+000135f0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
+00013600: 5f62 6f78 223a 205b 5d2c 0a20 2020 2020  _box": [],.     
+00013610: 2020 2020 2020 2020 2020 2022 685f 626f             "h_bo
+00013620: 7822 3a20 5b5d 2c0a 2020 2020 2020 2020  x": [],.        
+00013630: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+00013640: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00013650: 2020 2020 2274 6f74 5f74 6173 6b73 223a      "tot_tasks":
+00013660: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00013670: 2020 2020 2022 636f 6c6f 7222 3a20 5b5d       "color": []
+00013680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013690: 2020 2278 5f73 7461 7274 223a 205b 5d2c    "x_start": [],
+000136a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000136b0: 2022 785f 656e 6422 3a20 5b5d 2c0a 2020   "x_end": [],.  
+000136c0: 2020 2020 2020 2020 2020 2020 2020 2279                "y
+000136d0: 5f73 7461 7274 223a 205b 5d2c 0a20 2020  _start": [],.   
+000136e0: 2020 2020 2020 2020 2020 2020 2022 795f               "y_
+000136f0: 656e 6422 3a20 5b5d 2c0a 2020 2020 2020  end": [],.      
+00013700: 2020 2020 2020 2020 2020 2278 5f65 6e64            "x_end
+00013710: 5f70 726f 6772 6573 7322 3a20 5b5d 2c0a  _progress": [],.
+00013720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013730: 226d 656d 5f61 6c70 6861 223a 205b 5d2c  "mem_alpha": [],
+00013740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013750: 2022 6e6f 6465 5f6c 696e 655f 7769 6474   "node_line_widt
+00013760: 6822 3a20 5b5d 2c0a 2020 2020 2020 2020  h": [],.        
+00013770: 2020 2020 2020 2020 2263 6f6d 705f 7461          "comp_ta
+00013780: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
+00013790: 2020 2020 2020 2020 2020 2275 726c 5f6c            "url_l
+000137a0: 6f67 6f22 3a20 5b5d 2c0a 2020 2020 2020  ogo": [],.      
+000137b0: 2020 2020 2020 2020 2020 2278 5f6c 6f67            "x_log
+000137c0: 6f22 3a20 5b5d 2c0a 2020 2020 2020 2020  o": [],.        
+000137d0: 2020 2020 2020 2020 2279 5f6c 6f67 6f22          "y_logo"
+000137e0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000137f0: 2020 2020 2020 2277 5f6c 6f67 6f22 3a20        "w_logo": 
+00013800: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00013810: 2020 2020 2268 5f6c 6f67 6f22 3a20 5b5d      "h_logo": []
+00013820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013830: 2020 2269 6e5f 7072 6f63 6573 7369 6e67    "in_processing
+00013840: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00013850: 2020 2020 2020 2022 696e 5f6d 656d 6f72         "in_memor
+00013860: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
+00013870: 2020 2020 2020 2020 2269 6e5f 7265 6c65          "in_rele
+00013880: 6173 6564 223a 205b 5d2c 0a20 2020 2020  ased": [],.     
+00013890: 2020 2020 2020 2020 2020 2022 696e 5f65             "in_e
+000138a0: 7272 6564 223a 205b 5d2c 0a20 2020 2020  rred": [],.     
+000138b0: 2020 2020 2020 2020 2020 2022 636f 6d70             "comp
+000138c0: 7574 655f 7469 6d65 223a 205b 5d2c 0a20  ute_time": [],. 
+000138d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000138e0: 6d65 6d6f 7279 223a 205b 5d2c 0a20 2020  memory": [],.   
+000138f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00013900: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00013910: 6c66 2e61 7272 6f77 735f 736f 7572 6365  lf.arrows_source
+00013920: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+00013930: 7263 6528 7b22 7873 223a 205b 5d2c 2022  rce({"xs": [], "
+00013940: 7973 223a 205b 5d2c 2022 7865 223a 205b  ys": [], "xe": [
+00013950: 5d2c 2022 7965 223a 205b 5d7d 290a 0a20  ], "ye": []}).. 
+00013960: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00013970: 203d 2066 6967 7572 6528 7469 746c 653d   = figure(title=
+00013980: 2254 6173 6b20 4772 6f75 7073 2047 7261  "Task Groups Gra
+00013990: 7068 222c 206d 6174 6368 5f61 7370 6563  ph", match_aspec
+000139a0: 743d 5472 7565 2c20 2a2a 6b77 6172 6773  t=True, **kwargs
+000139b0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+000139c0: 6f6f 742e 6178 6973 2e76 6973 6962 6c65  oot.axis.visible
+000139d0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+000139e0: 2073 656c 662e 7375 6274 6974 6c65 203d   self.subtitle =
+000139f0: 2054 6974 6c65 2874 6578 743d 2220 222c   Title(text=" ",
+00013a00: 2074 6578 745f 666f 6e74 5f73 7479 6c65   text_font_style
+00013a10: 3d22 6974 616c 6963 2229 0a20 2020 2020  ="italic").     
+00013a20: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
+00013a30: 5f6c 6179 6f75 7428 7365 6c66 2e73 7562  _layout(self.sub
+00013a40: 7469 746c 652c 2022 6162 6f76 6522 290a  title, "above").
+00013a50: 0a20 2020 2020 2020 2072 6563 7420 3d20  .        rect = 
+00013a60: 7365 6c66 2e72 6f6f 742e 7265 6374 280a  self.root.rect(.
+00013a70: 2020 2020 2020 2020 2020 2020 783d 2278              x="x
+00013a80: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+00013a90: 3d22 7922 2c0a 2020 2020 2020 2020 2020  ="y",.          
+00013aa0: 2020 7769 6474 683d 2277 5f62 6f78 222c    width="w_box",
+00013ab0: 0a20 2020 2020 2020 2020 2020 2068 6569  .            hei
+00013ac0: 6768 743d 2268 5f62 6f78 222c 0a20 2020  ght="h_box",.   
+00013ad0: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
+00013ae0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+00013af0: 2020 2020 6669 6c6c 5f61 6c70 6861 3d22      fill_alpha="
+00013b00: 6d65 6d5f 616c 7068 6122 2c0a 2020 2020  mem_alpha",.    
+00013b10: 2020 2020 2020 2020 6c69 6e65 5f63 6f6c          line_col
+00013b20: 6f72 3d22 626c 6163 6b22 2c0a 2020 2020  or="black",.    
+00013b30: 2020 2020 2020 2020 6c69 6e65 5f77 6964          line_wid
+00013b40: 7468 3d22 6e6f 6465 5f6c 696e 655f 7769  th="node_line_wi
+00013b50: 6474 6822 2c0a 2020 2020 2020 2020 2020  dth",.          
+00013b60: 2020 736f 7572 6365 3d73 656c 662e 6e6f    source=self.no
+00013b70: 6465 735f 736f 7572 6365 2c0a 2020 2020  des_source,.    
+00013b80: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00013b90: 2070 6c6f 7420 7467 206c 6f67 0a20 2020   plot tg log.   
+00013ba0: 2020 2020 2073 656c 662e 726f 6f74 2e69       self.root.i
+00013bb0: 6d61 6765 5f75 726c 280a 2020 2020 2020  mage_url(.      
+00013bc0: 2020 2020 2020 7572 6c3d 2275 726c 5f6c        url="url_l
+00013bd0: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
+00013be0: 2020 783d 2278 5f6c 6f67 6f22 2c0a 2020    x="x_logo",.  
+00013bf0: 2020 2020 2020 2020 2020 793d 2279 5f6c            y="y_l
+00013c00: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
+00013c10: 2020 773d 2277 5f6c 6f67 6f22 2c0a 2020    w="w_logo",.  
+00013c20: 2020 2020 2020 2020 2020 683d 2268 5f6c            h="h_l
+00013c30: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
+00013c40: 2020 616e 6368 6f72 3d22 6365 6e74 6572    anchor="center
+00013c50: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+00013c60: 6f75 7263 653d 7365 6c66 2e6e 6f64 6573  ource=self.nodes
+00013c70: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
+00013c80: 2029 0a0a 2020 2020 2020 2020 2320 7072   )..        # pr
+00013c90: 6f67 7265 7373 2062 6172 2070 6c61 696e  ogress bar plain
+00013ca0: 2062 6f78 0a20 2020 2020 2020 2073 656c   box.        sel
+00013cb0: 662e 726f 6f74 2e71 7561 6428 0a20 2020  f.root.quad(.   
+00013cc0: 2020 2020 2020 2020 206c 6566 743d 2278           left="x
+00013cd0: 5f73 7461 7274 222c 0a20 2020 2020 2020  _start",.       
+00013ce0: 2020 2020 2072 6967 6874 3d22 785f 656e       right="x_en
+00013cf0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00013d00: 626f 7474 6f6d 3d22 795f 7374 6172 7422  bottom="y_start"
+00013d10: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00013d20: 703d 2279 5f65 6e64 222c 0a20 2020 2020  p="y_end",.     
+00013d30: 2020 2020 2020 2063 6f6c 6f72 3d4e 6f6e         color=Non
+00013d40: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
+00013d50: 696e 655f 636f 6c6f 723d 2262 6c61 636b  ine_color="black
+00013d60: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+00013d70: 6f75 7263 653d 7365 6c66 2e6e 6f64 6573  ource=self.nodes
+00013d80: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
+00013d90: 2029 0a0a 2020 2020 2020 2020 2320 7072   )..        # pr
+00013da0: 6f67 7265 7373 2062 6172 0a20 2020 2020  ogress bar.     
+00013db0: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
+00013dc0: 6428 0a20 2020 2020 2020 2020 2020 206c  d(.            l
+00013dd0: 6566 743d 2278 5f73 7461 7274 222c 0a20  eft="x_start",. 
+00013de0: 2020 2020 2020 2020 2020 2072 6967 6874             right
+00013df0: 3d22 785f 656e 645f 7072 6f67 7265 7373  ="x_end_progress
+00013e00: 222c 0a20 2020 2020 2020 2020 2020 2062  ",.            b
+00013e10: 6f74 746f 6d3d 2279 5f73 7461 7274 222c  ottom="y_start",
+00013e20: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
+00013e30: 3d22 795f 656e 6422 2c0a 2020 2020 2020  ="y_end",.      
+00013e40: 2020 2020 2020 636f 6c6f 723d 2263 6f6c        color="col
+00013e50: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+00013e60: 206c 696e 655f 636f 6c6f 723d 4e6f 6e65   line_color=None
+00013e70: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00013e80: 6c6c 5f61 6c70 6861 3d30 2e36 2c0a 2020  ll_alpha=0.6,.  
+00013e90: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00013ea0: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
+00013eb0: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00013ec0: 2020 2020 2020 2073 656c 662e 6172 726f         self.arro
+00013ed0: 7773 203d 2041 7272 6f77 280a 2020 2020  ws = Arrow(.    
+00013ee0: 2020 2020 2020 2020 656e 643d 5665 6548          end=VeeH
+00013ef0: 6561 6428 7369 7a65 3d38 292c 0a20 2020  ead(size=8),.   
+00013f00: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
+00013f10: 6c6f 723d 2262 6c61 636b 222c 0a20 2020  lor="black",.   
+00013f20: 2020 2020 2020 2020 206c 696e 655f 616c           line_al
+00013f30: 7068 613d 302e 352c 0a20 2020 2020 2020  pha=0.5,.       
+00013f40: 2020 2020 206c 696e 655f 7769 6474 683d       line_width=
+00013f50: 312c 0a20 2020 2020 2020 2020 2020 2078  1,.            x
+00013f60: 5f73 7461 7274 3d22 7873 222c 0a20 2020  _start="xs",.   
+00013f70: 2020 2020 2020 2020 2079 5f73 7461 7274           y_start
+00013f80: 3d22 7973 222c 0a20 2020 2020 2020 2020  ="ys",.         
+00013f90: 2020 2078 5f65 6e64 3d22 7865 222c 0a20     x_end="xe",. 
+00013fa0: 2020 2020 2020 2020 2020 2079 5f65 6e64             y_end
+00013fb0: 3d22 7965 222c 0a20 2020 2020 2020 2020  ="ye",.         
+00013fc0: 2020 2073 6f75 7263 653d 7365 6c66 2e61     source=self.a
+00013fd0: 7272 6f77 735f 736f 7572 6365 2c0a 2020  rrows_source,.  
+00013fe0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00013ff0: 7365 6c66 2e72 6f6f 742e 6164 645f 6c61  self.root.add_la
+00014000: 796f 7574 2873 656c 662e 6172 726f 7773  yout(self.arrows
+00014010: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00014020: 726f 6f74 2e78 6772 6964 2e67 7269 645f  root.xgrid.grid_
+00014030: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
+00014040: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
+00014050: 6f6f 742e 7967 7269 642e 6772 6964 5f6c  oot.ygrid.grid_l
+00014060: 696e 655f 636f 6c6f 7220 3d20 4e6f 6e65  ine_color = None
+00014070: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00014080: 6f74 2e78 5f72 616e 6765 2e72 616e 6765  ot.x_range.range
+00014090: 5f70 6164 6469 6e67 203d 2030 2e35 0a20  _padding = 0.5. 
+000140a0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+000140b0: 2e79 5f72 616e 6765 2e72 616e 6765 5f70  .y_range.range_p
+000140c0: 6164 6469 6e67 203d 2030 2e35 0a0a 2020  adding = 0.5..  
+000140d0: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
+000140e0: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
+000140f0: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
+00014100: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
+00014110: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00014120: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
+00014130: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+00014140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014150: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00014160: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
+00014170: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+00014180: 626f 6c64 3b22 3e4e 616d 653a 3c2f 7370  bold;">Name:</sp
+00014190: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
+000141a0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+000141b0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+000141c0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+000141d0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+000141e0: 206d 6f6e 6f73 7061 6365 3b22 3e40 6e61   monospace;">@na
+000141f0: 6d65 3c2f 7370 616e 3e0a 2020 2020 2020  me</span>.      
+00014200: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+00014210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014220: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
+00014230: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00014240: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00014250: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
+00014260: 6967 6874 3a20 626f 6c64 3b22 3e43 6f6d  ight: bold;">Com
+00014270: 7075 7465 2074 696d 653a 3c2f 7370 616e  pute time:</span
+00014280: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+00014290: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+000142a0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+000142b0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+000142c0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+000142d0: 6f6e 6f73 7061 6365 3b22 3e40 636f 6d70  onospace;">@comp
+000142e0: 7574 655f 7469 6d65 3c2f 7370 616e 3e0a  ute_time</span>.
+000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014300: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+00014310: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
+00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014330: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00014340: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
+00014350: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+00014360: 3b22 3e4d 656d 6f72 793a 3c2f 7370 616e  ;">Memory:</span
+00014370: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+00014380: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00014390: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+000143a0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+000143b0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+000143c0: 6f6e 6f73 7061 6365 3b22 3e40 6d65 6d6f  onospace;">@memo
+000143d0: 7279 3c2f 7370 616e 3e0a 2020 2020 2020  ry</span>.      
+000143e0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+000143f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014400: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
+00014410: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00014420: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00014430: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
+00014440: 6967 6874 3a20 626f 6c64 3b22 3e54 6173  ight: bold;">Tas
+00014450: 6b73 3a3c 2f73 7061 6e3e 266e 6273 703b  ks:</span>&nbsp;
+00014460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014470: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00014480: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
+00014490: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
+000144a0: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
+000144b0: 653b 223e 4074 6f74 5f74 6173 6b73 3c2f  e;">@tot_tasks</
+000144c0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
+000144d0: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+000144e0: 2020 2020 2020 2020 2020 2020 203c 6469               <di
+000144f0: 7620 7374 796c 653d 226d 6172 6769 6e2d  v style="margin-
+00014500: 6c65 6674 3a20 3265 6d3b 223e 0a20 2020  left: 2em;">.   
+00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014520: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00014530: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
+00014540: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+00014550: 3b22 3e43 6f6d 706c 6574 6564 3a3c 2f73  ;">Completed:</s
+00014560: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
+00014570: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014580: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+00014590: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
+000145a0: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
+000145b0: 2c20 6d6f 6e6f 7370 6163 653b 223e 4063  , monospace;">@c
+000145c0: 6f6d 705f 7461 736b 733c 2f73 7061 6e3e  omp_tasks</span>
+000145d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000145e0: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+000145f0: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
+00014600: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
+00014610: 2032 656d 3b22 3e0a 2020 2020 2020 2020   2em;">.        
+00014620: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00014630: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00014640: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00014650: 6569 6768 743a 2062 6f6c 643b 223e 5072  eight: bold;">Pr
+00014660: 6f63 6573 7369 6e67 3a3c 2f73 7061 6e3e  ocessing:</span>
+00014670: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
+00014680: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00014690: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+000146a0: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+000146b0: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+000146c0: 6e6f 7370 6163 653b 223e 4069 6e5f 7072  nospace;">@in_pr
+000146d0: 6f63 6573 7369 6e67 3c2f 7370 616e 3e0a  ocessing</span>.
+000146e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146f0: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+00014700: 2020 2020 2020 203c 6469 7620 7374 796c         <div styl
+00014710: 653d 226d 6172 6769 6e2d 6c65 6674 3a20  e="margin-left: 
+00014720: 3265 6d3b 223e 0a20 2020 2020 2020 2020  2em;">.         
+00014730: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00014740: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00014750: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
+00014760: 6967 6874 3a20 626f 6c64 3b22 3e49 6e20  ight: bold;">In 
+00014770: 6d65 6d6f 7279 3a3c 2f73 7061 6e3e 266e  memory:</span>&n
+00014780: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
+00014790: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+000147a0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+000147b0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+000147c0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+000147d0: 7370 6163 653b 223e 4069 6e5f 6d65 6d6f  space;">@in_memo
+000147e0: 7279 3c2f 7370 616e 3e0a 2020 2020 2020  ry</span>.      
+000147f0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+00014800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014810: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
+00014820: 6769 6e2d 6c65 6674 3a20 3265 6d3b 223e  gin-left: 2em;">
+00014830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014840: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00014850: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
+00014860: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+00014870: 626f 6c64 3b22 3e45 7272 6564 3a3c 2f73  bold;">Erred:</s
+00014880: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
+00014890: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+000148a0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+000148b0: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
+000148c0: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
+000148d0: 2c20 6d6f 6e6f 7370 6163 653b 223e 4069  , monospace;">@i
+000148e0: 6e5f 6572 7265 643c 2f73 7061 6e3e 0a20  n_erred</span>. 
+000148f0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014900: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00014910: 2020 2020 2020 3c64 6976 2073 7479 6c65        <div style
+00014920: 3d22 6d61 7267 696e 2d6c 6566 743a 2032  ="margin-left: 2
+00014930: 656d 3b22 3e0a 2020 2020 2020 2020 2020  em;">.          
+00014940: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00014950: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00014960: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
+00014970: 6768 743a 2062 6f6c 643b 223e 5265 6c65  ght: bold;">Rele
+00014980: 6173 6564 3a3c 2f73 7061 6e3e 266e 6273  ased:</span>&nbs
+00014990: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+000149a0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+000149b0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+000149c0: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+000149d0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+000149e0: 6163 653b 223e 4069 6e5f 7265 6c65 6173  ace;">@in_releas
+000149f0: 6564 3c2f 7370 616e 3e0a 2020 2020 2020  ed</span>.      
+00014a00: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+00014a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014a20: 2022 2222 2c0a 2020 2020 2020 2020 2020   """,.          
+00014a30: 2020 7265 6e64 6572 6572 733d 5b72 6563    renderers=[rec
+00014a40: 745d 2c0a 2020 2020 2020 2020 290a 0a20  t],.        ).. 
+00014a50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00014a60: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
+00014a70: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+00014a80: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+00014a90: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+00014aa0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+00014ab0: 7465 5f6c 6179 6f75 7428 7365 6c66 293a  te_layout(self):
+00014ac0: 0a20 2020 2020 2020 2023 2047 6574 2064  .        # Get d
+00014ad0: 6570 656e 6465 6e63 6965 7320 7065 7220  ependencies per 
+00014ae0: 7461 736b 2067 726f 7570 2e0a 2020 2020  task group..    
+00014af0: 2020 2020 2320 496e 2073 6f6d 6520 6361      # In some ca
+00014b00: 7365 7320 7468 6572 6520 6172 6520 7467  ses there are tg
+00014b10: 2074 6861 7420 6861 7665 2074 6865 6d73   that have thems
+00014b20: 656c 7665 7320 6173 2064 6570 656e 6465  elves as depende
+00014b30: 6e63 6965 7320 2d20 7765 2072 656d 6f76  ncies - we remov
+00014b40: 6520 7468 6f73 652e 0a20 2020 2020 2020  e those..       
+00014b50: 2064 6570 656e 6465 6e63 6965 7320 3d20   dependencies = 
+00014b60: 7b0a 2020 2020 2020 2020 2020 2020 6b3a  {.            k:
+00014b70: 207b 6473 2e6e 616d 6520 666f 7220 6473   {ds.name for ds
+00014b80: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00014b90: 6965 7320 6966 2064 732e 6e61 6d65 2021  ies if ds.name !
+00014ba0: 3d20 6b7d 0a20 2020 2020 2020 2020 2020  = k}.           
+00014bb0: 2066 6f72 206b 2c20 7473 2069 6e20 7365   for k, ts in se
+00014bc0: 6c66 2e73 6368 6564 756c 6572 2e74 6173  lf.scheduler.tas
+00014bd0: 6b5f 6772 6f75 7073 2e69 7465 6d73 2829  k_groups.items()
+00014be0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00014bf0: 2020 2020 696d 706f 7274 2064 6173 6b0a      import dask.
+00014c00: 0a20 2020 2020 2020 206f 7264 6572 203d  .        order =
+00014c10: 2064 6173 6b2e 6f72 6465 722e 6f72 6465   dask.order.orde
+00014c20: 7228 0a20 2020 2020 2020 2020 2020 2064  r(.            d
+00014c30: 736b 3d7b 6772 6f75 702e 6e61 6d65 3a20  sk={group.name: 
+00014c40: 3120 666f 7220 6b2c 2067 726f 7570 2069  1 for k, group i
+00014c50: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
+00014c60: 2e74 6173 6b5f 6772 6f75 7073 2e69 7465  .task_groups.ite
+00014c70: 6d73 2829 7d2c 0a20 2020 2020 2020 2020  ms()},.         
+00014c80: 2020 2064 6570 656e 6465 6e63 6965 733d     dependencies=
+00014c90: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
+00014ca0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00014cb0: 206f 7264 6572 6564 203d 2073 6f72 7465   ordered = sorte
+00014cc0: 6428 7365 6c66 2e73 6368 6564 756c 6572  d(self.scheduler
+00014cd0: 2e74 6173 6b5f 6772 6f75 7073 2c20 6b65  .task_groups, ke
+00014ce0: 793d 6f72 6465 722e 6765 7429 0a0a 2020  y=order.get)..  
+00014cf0: 2020 2020 2020 7873 203d 207b 7d0a 2020        xs = {}.  
+00014d00: 2020 2020 2020 7973 203d 207b 7d0a 2020        ys = {}.  
+00014d10: 2020 2020 2020 6c6f 6361 7469 6f6e 7320        locations 
+00014d20: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00014d30: 6e6f 6465 735f 6c61 796f 7574 203d 207b  nodes_layout = {
+00014d40: 7d0a 2020 2020 2020 2020 6172 726f 7773  }.        arrows
+00014d50: 5f6c 6179 6f75 7420 3d20 7b7d 0a20 2020  _layout = {}.   
+00014d60: 2020 2020 2066 6f72 2074 6720 696e 206f       for tg in o
+00014d70: 7264 6572 6564 3a0a 2020 2020 2020 2020  rdered:.        
+00014d80: 2020 2020 6966 2064 6570 656e 6465 6e63      if dependenc
+00014d90: 6965 735b 7467 5d3a 0a20 2020 2020 2020  ies[tg]:.       
+00014da0: 2020 2020 2020 2020 2078 203d 206d 6178           x = max
+00014db0: 2878 735b 6465 705d 2066 6f72 2064 6570  (xs[dep] for dep
+00014dc0: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
+00014dd0: 5b74 675d 2920 2b20 310a 2020 2020 2020  [tg]) + 1.      
+00014de0: 2020 2020 2020 2020 2020 7920 3d20 6d61            y = ma
+00014df0: 7828 7973 5b64 6570 5d20 666f 7220 6465  x(ys[dep] for de
+00014e00: 7020 696e 2064 6570 656e 6465 6e63 6965  p in dependencie
+00014e10: 735b 7467 5d29 0a20 2020 2020 2020 2020  s[tg]).         
+00014e20: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e40: 6c65 6e28 6465 7065 6e64 656e 6369 6573  len(dependencies
+00014e50: 5b74 675d 2920 3e20 310a 2020 2020 2020  [tg]) > 1.      
+00014e60: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00014e70: 6420 6c65 6e28 7b79 735b 6465 705d 2066  d len({ys[dep] f
+00014e80: 6f72 2064 6570 2069 6e20 6465 7065 6e64  or dep in depend
+00014e90: 656e 6369 6573 5b74 675d 7d29 203d 3d20  encies[tg]}) == 
+00014ea0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00014eb0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00014ec0: 2020 2020 2020 2020 2079 202b 3d20 310a           y += 1.
+00014ed0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00014ee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014ef0: 2020 7820 3d20 300a 2020 2020 2020 2020    x = 0.        
+00014f00: 2020 2020 2020 2020 7920 3d20 6d61 7828          y = max(
+00014f10: 7973 2e76 616c 7565 7328 2929 202b 2031  ys.values()) + 1
+00014f20: 2069 6620 7973 2065 6c73 6520 300a 0a20   if ys else 0.. 
+00014f30: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+00014f40: 2028 782c 2079 2920 696e 206c 6f63 6174   (x, y) in locat
+00014f50: 696f 6e73 3a20 2023 2061 766f 6964 2063  ions:  # avoid c
+00014f60: 6f6c 6c69 7369 6f6e 7320 6279 206d 6f76  ollisions by mov
+00014f70: 696e 6720 7570 0a20 2020 2020 2020 2020  ing up.         
+00014f80: 2020 2020 2020 2079 202b 3d20 310a 0a20         y += 1.. 
+00014f90: 2020 2020 2020 2020 2020 206c 6f63 6174             locat
+00014fa0: 696f 6e73 2e61 6464 2828 782c 2079 2929  ions.add((x, y))
+00014fb0: 0a0a 2020 2020 2020 2020 2020 2020 7873  ..            xs
+00014fc0: 5b74 675d 2c20 7973 5b74 675d 203d 2078  [tg], ys[tg] = x
+00014fd0: 2c20 790a 0a20 2020 2020 2020 2020 2020  , y..           
+00014fe0: 2023 2069 6e66 6f20 6e65 6564 6564 2066   # info needed f
+00014ff0: 6f72 206e 6f64 6520 6c61 796f 7574 2074  or node layout t
+00015000: 6f20 636f 6c75 6d6e 2064 6174 6120 736f  o column data so
+00015010: 7572 6365 0a20 2020 2020 2020 2020 2020  urce.           
+00015020: 206e 6f64 6573 5f6c 6179 6f75 745b 7467   nodes_layout[tg
+00015030: 5d20 3d20 7b22 7822 3a20 7873 5b74 675d  ] = {"x": xs[tg]
+00015040: 2c20 2279 223a 2079 735b 7467 5d7d 0a0a  , "y": ys[tg]}..
+00015050: 2020 2020 2020 2020 2020 2020 2320 696e              # in
+00015060: 666f 206e 6565 6465 6420 666f 7220 6172  fo needed for ar
+00015070: 726f 7720 6c61 796f 7574 0a20 2020 2020  row layout.     
+00015080: 2020 2020 2020 2061 7272 6f77 735f 6c61         arrows_la
+00015090: 796f 7574 5b74 675d 203d 207b 0a20 2020  yout[tg] = {.   
+000150a0: 2020 2020 2020 2020 2020 2020 2022 6e73               "ns
+000150b0: 7461 7274 223a 2064 6570 656e 6465 6e63  tart": dependenc
+000150c0: 6965 735b 7467 5d2c 0a20 2020 2020 2020  ies[tg],.       
+000150d0: 2020 2020 2020 2020 2022 6e65 6e64 223a           "nend":
+000150e0: 205b 7467 5d20 2a20 6c65 6e28 6465 7065   [tg] * len(depe
+000150f0: 6e64 656e 6369 6573 5b74 675d 292c 0a20  ndencies[tg]),. 
+00015100: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00015110: 2020 2020 2020 7265 7475 726e 206e 6f64        return nod
+00015120: 6573 5f6c 6179 6f75 742c 2061 7272 6f77  es_layout, arrow
+00015130: 735f 6c61 796f 7574 0a0a 2020 2020 6465  s_layout..    de
+00015140: 6620 636f 6d70 7574 655f 7369 7a65 2873  f compute_size(s
+00015150: 656c 662c 2078 2c20 6d69 6e5f 626f 782c  elf, x, min_box,
+00015160: 206d 6178 5f62 6f78 293a 0a20 2020 2020   max_box):.     
+00015170: 2020 2073 7461 7274 203d 2030 2e34 0a20     start = 0.4. 
+00015180: 2020 2020 2020 2065 6e64 203d 2030 2e38         end = 0.8
+00015190: 0a0a 2020 2020 2020 2020 7920 3d20 2865  ..        y = (e
+000151a0: 6e64 202d 2073 7461 7274 2920 2f20 286d  nd - start) / (m
+000151b0: 6178 5f62 6f78 202d 206d 696e 5f62 6f78  ax_box - min_box
+000151c0: 2920 2a20 2878 202d 206d 696e 5f62 6f78  ) * (x - min_box
+000151d0: 2920 2b20 7374 6172 740a 0a20 2020 2020  ) + start..     
+000151e0: 2020 2072 6574 7572 6e20 790a 0a20 2020     return y..   
+000151f0: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
+00015200: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
+00015210: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
+00015220: 6629 3a0a 2020 2020 2020 2020 6966 2073  f):.        if s
+00015230: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
+00015240: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00015250: 203d 3d20 7365 6c66 2e6f 6c64 5f63 6f75   == self.old_cou
+00015260: 6e74 6572 3a0a 2020 2020 2020 2020 2020  nter:.          
+00015270: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+00015280: 2073 656c 662e 6f6c 645f 636f 756e 7465   self.old_counte
+00015290: 7220 3d20 7365 6c66 2e73 6368 6564 756c  r = self.schedul
+000152a0: 6572 2e74 7261 6e73 6974 696f 6e5f 636f  er.transition_co
+000152b0: 756e 7465 720a 0a20 2020 2020 2020 2069  unter..        i
+000152c0: 6620 6e6f 7420 7365 6c66 2e73 6368 6564  f not self.sched
+000152d0: 756c 6572 2e74 6173 6b5f 6772 6f75 7073  uler.task_groups
+000152e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000152f0: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
+00015300: 203d 2022 5363 6865 6475 6c65 7220 6973   = "Scheduler is
+00015310: 2065 6d70 7479 2e22 0a20 2020 2020 2020   empty.".       
+00015320: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00015330: 2020 2073 656c 662e 7375 6274 6974 6c65     self.subtitle
+00015340: 2e74 6578 7420 3d20 2220 220a 0a20 2020  .text = " "..   
+00015350: 2020 2020 2069 6620 7365 6c66 2e6e 6f64       if self.nod
+00015360: 6573 5f6c 6179 6f75 742e 6b65 7973 2829  es_layout.keys()
+00015370: 2021 3d20 7365 6c66 2e73 6368 6564 756c   != self.schedul
+00015380: 6572 2e74 6173 6b5f 6772 6f75 7073 2e6b  er.task_groups.k
+00015390: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+000153a0: 2020 2073 656c 662e 6e6f 6465 735f 6c61     self.nodes_la
+000153b0: 796f 7574 2c20 7365 6c66 2e61 7272 6f77  yout, self.arrow
+000153c0: 735f 6c61 796f 7574 203d 2073 656c 662e  s_layout = self.
+000153d0: 7570 6461 7465 5f6c 6179 6f75 7428 290a  update_layout().
+000153e0: 0a20 2020 2020 2020 206e 6f64 6573 5f64  .        nodes_d
+000153f0: 6174 6120 3d20 7b0a 2020 2020 2020 2020  ata = {.        
+00015400: 2020 2020 2278 223a 205b 5d2c 0a20 2020      "x": [],.   
+00015410: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
+00015420: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+00015430: 5f62 6f78 223a 205b 5d2c 0a20 2020 2020  _box": [],.     
+00015440: 2020 2020 2020 2022 685f 626f 7822 3a20         "h_box": 
+00015450: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00015460: 226e 616d 6522 3a20 5b5d 2c0a 2020 2020  "name": [],.    
+00015470: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
 00015480: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00015490: 2022 785f 656e 6422 3a20 5b5d 2c0a 2020   "x_end": [],.  
-000154a0: 2020 2020 2020 2020 2020 2279 5f73 7461            "y_sta
-000154b0: 7274 223a 205b 5d2c 0a20 2020 2020 2020  rt": [],.       
-000154c0: 2020 2020 2022 795f 656e 6422 3a20 5b5d       "y_end": []
-000154d0: 2c0a 2020 2020 2020 2020 2020 2020 2278  ,.            "x
-000154e0: 5f65 6e64 5f70 726f 6772 6573 7322 3a20  _end_progress": 
-000154f0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015500: 226d 656d 5f61 6c70 6861 223a 205b 5d2c  "mem_alpha": [],
-00015510: 0a20 2020 2020 2020 2020 2020 2022 6e6f  .            "no
-00015520: 6465 5f6c 696e 655f 7769 6474 6822 3a20  de_line_width": 
-00015530: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015540: 2263 6f6d 705f 7461 736b 7322 3a20 5b5d  "comp_tasks": []
-00015550: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
-00015560: 726c 5f6c 6f67 6f22 3a20 5b5d 2c0a 2020  rl_logo": [],.  
-00015570: 2020 2020 2020 2020 2020 2278 5f6c 6f67            "x_log
-00015580: 6f22 3a20 5b5d 2c0a 2020 2020 2020 2020  o": [],.        
-00015590: 2020 2020 2279 5f6c 6f67 6f22 3a20 5b5d      "y_logo": []
-000155a0: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-000155b0: 5f6c 6f67 6f22 3a20 5b5d 2c0a 2020 2020  _logo": [],.    
-000155c0: 2020 2020 2020 2020 2268 5f6c 6f67 6f22          "h_logo"
-000155d0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000155e0: 2020 2269 6e5f 7072 6f63 6573 7369 6e67    "in_processing
-000155f0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00015600: 2020 2022 696e 5f6d 656d 6f72 7922 3a20     "in_memory": 
-00015610: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015620: 2269 6e5f 7265 6c65 6173 6564 223a 205b  "in_released": [
-00015630: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00015640: 696e 5f65 7272 6564 223a 205b 5d2c 0a20  in_erred": [],. 
-00015650: 2020 2020 2020 2020 2020 2022 636f 6d70             "comp
-00015660: 7574 655f 7469 6d65 223a 205b 5d2c 0a20  ute_time": [],. 
-00015670: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00015680: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
-00015690: 207d 0a0a 2020 2020 2020 2020 6172 726f   }..        arro
-000156a0: 7773 5f64 6174 6120 3d20 7b0a 2020 2020  ws_data = {.    
-000156b0: 2020 2020 2020 2020 2278 7322 3a20 5b5d          "xs": []
-000156c0: 2c0a 2020 2020 2020 2020 2020 2020 2279  ,.            "y
-000156d0: 7322 3a20 5b5d 2c0a 2020 2020 2020 2020  s": [],.        
-000156e0: 2020 2020 2278 6522 3a20 5b5d 2c0a 2020      "xe": [],.  
-000156f0: 2020 2020 2020 2020 2020 2279 6522 3a20            "ye": 
-00015700: 5b5d 2c0a 2020 2020 2020 2020 7d0a 0a20  [],.        }.. 
-00015710: 2020 2020 2020 2064 7572 6174 696f 6e73         durations
-00015720: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00015730: 206e 6279 7465 7320 3d20 7365 7428 290a   nbytes = set().
-00015740: 2020 2020 2020 2020 666f 7220 7467 2069          for tg i
-00015750: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
-00015760: 2e74 6173 6b5f 6772 6f75 7073 2e76 616c  .task_groups.val
-00015770: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
-00015780: 2020 2069 6620 7467 2e64 7572 6174 696f     if tg.duratio
-00015790: 6e20 616e 6420 7467 2e6e 6279 7465 735f  n and tg.nbytes_
-000157a0: 746f 7461 6c3a 0a20 2020 2020 2020 2020  total:.         
-000157b0: 2020 2020 2020 2064 7572 6174 696f 6e73         durations
-000157c0: 2e61 6464 2874 672e 6475 7261 7469 6f6e  .add(tg.duration
-000157d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000157e0: 2020 6e62 7974 6573 2e61 6464 2874 672e    nbytes.add(tg.
-000157f0: 6e62 7974 6573 5f74 6f74 616c 290a 0a20  nbytes_total).. 
-00015800: 2020 2020 2020 2064 7572 6174 696f 6e73         durations
-00015810: 5f6d 696e 203d 206d 696e 2864 7572 6174  _min = min(durat
-00015820: 696f 6e73 2c20 6465 6661 756c 743d 3029  ions, default=0)
-00015830: 0a20 2020 2020 2020 2064 7572 6174 696f  .        duratio
-00015840: 6e73 5f6d 6178 203d 206d 6178 2864 7572  ns_max = max(dur
-00015850: 6174 696f 6e73 2c20 6465 6661 756c 743d  ations, default=
-00015860: 3029 0a20 2020 2020 2020 206e 6279 7465  0).        nbyte
-00015870: 735f 6d69 6e20 3d20 6d69 6e28 6e62 7974  s_min = min(nbyt
-00015880: 6573 2c20 6465 6661 756c 743d 3029 0a20  es, default=0). 
-00015890: 2020 2020 2020 206e 6279 7465 735f 6d61         nbytes_ma
-000158a0: 7820 3d20 6d61 7828 6e62 7974 6573 2c20  x = max(nbytes, 
-000158b0: 6465 6661 756c 743d 3029 0a0a 2020 2020  default=0)..    
-000158c0: 2020 2020 626f 785f 6469 6d20 3d20 7b7d      box_dim = {}
-000158d0: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
-000158e0: 2c20 7467 2069 6e20 7365 6c66 2e73 6368  , tg in self.sch
-000158f0: 6564 756c 6572 2e74 6173 6b5f 6772 6f75  eduler.task_grou
-00015900: 7073 2e69 7465 6d73 2829 3a0a 2020 2020  ps.items():.    
-00015910: 2020 2020 2020 2020 636f 6d70 5f74 6173          comp_tas
-00015920: 6b73 203d 2028 0a20 2020 2020 2020 2020  ks = (.         
-00015930: 2020 2020 2020 2074 672e 7374 6174 6573         tg.states
-00015940: 5b22 7265 6c65 6173 6564 225d 202b 2074  ["released"] + t
-00015950: 672e 7374 6174 6573 5b22 6d65 6d6f 7279  g.states["memory
-00015960: 225d 202b 2074 672e 7374 6174 6573 5b22  "] + tg.states["
-00015970: 6572 7265 6422 5d0a 2020 2020 2020 2020  erred"].        
-00015980: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00015990: 2020 746f 745f 7461 736b 7320 3d20 7375    tot_tasks = su
-000159a0: 6d28 7467 2e73 7461 7465 732e 7661 6c75  m(tg.states.valu
-000159b0: 6573 2829 290a 0a20 2020 2020 2020 2020  es())..         
-000159c0: 2020 2023 2063 6f6d 7075 7465 2077 6964     # compute wid
-000159d0: 7468 2061 6e64 2068 6569 6768 7420 6f66  th and height of
-000159e0: 2062 6f78 6573 0a20 2020 2020 2020 2020   boxes.         
-000159f0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-00015a00: 2020 2020 2020 2020 7467 2e64 7572 6174          tg.durat
-00015a10: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-00015a20: 2020 2020 616e 6420 7467 2e6e 6279 7465      and tg.nbyte
-00015a30: 735f 746f 7461 6c0a 2020 2020 2020 2020  s_total.        
-00015a40: 2020 2020 2020 2020 616e 6420 636f 6d70          and comp
-00015a50: 5f74 6173 6b73 0a20 2020 2020 2020 2020  _tasks.         
-00015a60: 2020 2020 2020 2061 6e64 206c 656e 2864         and len(d
-00015a70: 7572 6174 696f 6e73 2920 3e20 310a 2020  urations) > 1.  
-00015a80: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00015a90: 6420 6c65 6e28 6e62 7974 6573 2920 3e20  d len(nbytes) > 
-00015aa0: 310a 2020 2020 2020 2020 2020 2020 293a  1.            ):
-00015ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ac0: 2023 2073 6361 6c65 2064 7572 6174 696f   # scale duratio
-00015ad0: 6e20 2877 6964 7468 290a 2020 2020 2020  n (width).      
-00015ae0: 2020 2020 2020 2020 2020 7769 6474 685f            width_
-00015af0: 626f 7820 3d20 7365 6c66 2e63 6f6d 7075  box = self.compu
-00015b00: 7465 5f73 697a 6528 0a20 2020 2020 2020  te_size(.       
-00015b10: 2020 2020 2020 2020 2020 2020 2074 672e               tg.
-00015b20: 6475 7261 7469 6f6e 202f 2063 6f6d 705f  duration / comp_
-00015b30: 7461 736b 7320 2a20 746f 745f 7461 736b  tasks * tot_task
-00015b40: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00015b50: 2020 2020 2020 206d 696e 5f62 6f78 3d64         min_box=d
-00015b60: 7572 6174 696f 6e73 5f6d 696e 202f 2063  urations_min / c
-00015b70: 6f6d 705f 7461 736b 7320 2a20 746f 745f  omp_tasks * tot_
-00015b80: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
-00015b90: 2020 2020 2020 2020 2020 206d 6178 5f62             max_b
-00015ba0: 6f78 3d64 7572 6174 696f 6e73 5f6d 6178  ox=durations_max
-00015bb0: 202f 2063 6f6d 705f 7461 736b 7320 2a20   / comp_tasks * 
-00015bc0: 746f 745f 7461 736b 732c 0a20 2020 2020  tot_tasks,.     
-00015bd0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00015be0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015bf0: 6e65 6564 2074 6f20 7363 616c 6520 6d65  need to scale me
-00015c00: 6d6f 7279 2028 6865 6967 6874 290a 2020  mory (height).  
-00015c10: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00015c20: 6967 6874 5f62 6f78 203d 2073 656c 662e  ight_box = self.
-00015c30: 636f 6d70 7574 655f 7369 7a65 280a 2020  compute_size(.  
-00015c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c50: 2020 7467 2e6e 6279 7465 735f 746f 7461    tg.nbytes_tota
-00015c60: 6c20 2f20 636f 6d70 5f74 6173 6b73 202a  l / comp_tasks *
-00015c70: 2074 6f74 5f74 6173 6b73 2c0a 2020 2020   tot_tasks,.    
-00015c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c90: 6d69 6e5f 626f 783d 6e62 7974 6573 5f6d  min_box=nbytes_m
-00015ca0: 696e 202f 2063 6f6d 705f 7461 736b 7320  in / comp_tasks 
-00015cb0: 2a20 746f 745f 7461 736b 732c 0a20 2020  * tot_tasks,.   
-00015cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cd0: 206d 6178 5f62 6f78 3d6e 6279 7465 735f   max_box=nbytes_
-00015ce0: 6d61 7820 2f20 636f 6d70 5f74 6173 6b73  max / comp_tasks
-00015cf0: 202a 2074 6f74 5f74 6173 6b73 2c0a 2020   * tot_tasks,.  
-00015d00: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015d10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00015d20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00015d30: 2020 2077 6964 7468 5f62 6f78 203d 2030     width_box = 0
-00015d40: 2e36 0a20 2020 2020 2020 2020 2020 2020  .6.             
-00015d50: 2020 2068 6569 6768 745f 626f 7820 3d20     height_box = 
-00015d60: 7769 6474 685f 626f 7820 2f20 320a 0a20  width_box / 2.. 
-00015d70: 2020 2020 2020 2020 2020 2062 6f78 5f64             box_d
-00015d80: 696d 5b6b 6579 5d20 3d20 7b22 7769 6474  im[key] = {"widt
-00015d90: 6822 3a20 7769 6474 685f 626f 782c 2022  h": width_box, "
-00015da0: 6865 6967 6874 223a 2068 6569 6768 745f  height": height_
-00015db0: 626f 787d 0a0a 2020 2020 2020 2020 666f  box}..        fo
-00015dc0: 7220 6b65 792c 2074 6720 696e 2073 656c  r key, tg in sel
-00015dd0: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
-00015de0: 5f67 726f 7570 732e 6974 656d 7328 293a  _groups.items():
-00015df0: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
-00015e00: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
-00015e10: 7574 5b6b 6579 5d5b 2278 225d 0a20 2020  ut[key]["x"].   
-00015e20: 2020 2020 2020 2020 2079 203d 2073 656c           y = sel
-00015e30: 662e 6e6f 6465 735f 6c61 796f 7574 5b6b  f.nodes_layout[k
-00015e40: 6579 5d5b 2279 225d 0a20 2020 2020 2020  ey]["y"].       
-00015e50: 2020 2020 2077 6964 7468 203d 2062 6f78       width = box
-00015e60: 5f64 696d 5b6b 6579 5d5b 2277 6964 7468  _dim[key]["width
-00015e70: 225d 0a20 2020 2020 2020 2020 2020 2068  "].            h
-00015e80: 6569 6768 7420 3d20 626f 785f 6469 6d5b  eight = box_dim[
-00015e90: 6b65 795d 5b22 6865 6967 6874 225d 0a0a  key]["height"]..
-00015ea0: 2020 2020 2020 2020 2020 2020 2320 6d61              # ma
-00015eb0: 696e 2062 6f78 6573 206c 6179 6f75 740a  in boxes layout.
-00015ec0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00015ed0: 735f 6461 7461 5b22 7822 5d2e 6170 7065  s_data["x"].appe
-00015ee0: 6e64 2878 290a 2020 2020 2020 2020 2020  nd(x).          
-00015ef0: 2020 6e6f 6465 735f 6461 7461 5b22 7922    nodes_data["y"
-00015f00: 5d2e 6170 7065 6e64 2879 290a 2020 2020  ].append(y).    
-00015f10: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-00015f20: 7461 5b22 775f 626f 7822 5d2e 6170 7065  ta["w_box"].appe
-00015f30: 6e64 2877 6964 7468 290a 2020 2020 2020  nd(width).      
-00015f40: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00015f50: 5b22 685f 626f 7822 5d2e 6170 7065 6e64  ["h_box"].append
-00015f60: 2868 6569 6768 7429 0a0a 2020 2020 2020  (height)..      
-00015f70: 2020 2020 2020 636f 6d70 5f74 6173 6b73        comp_tasks
-00015f80: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00015f90: 2020 2020 2074 672e 7374 6174 6573 5b22       tg.states["
-00015fa0: 7265 6c65 6173 6564 225d 202b 2074 672e  released"] + tg.
-00015fb0: 7374 6174 6573 5b22 6d65 6d6f 7279 225d  states["memory"]
-00015fc0: 202b 2074 672e 7374 6174 6573 5b22 6572   + tg.states["er
-00015fd0: 7265 6422 5d0a 2020 2020 2020 2020 2020  red"].          
-00015fe0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00015ff0: 746f 745f 7461 736b 7320 3d20 7375 6d28  tot_tasks = sum(
-00016000: 7467 2e73 7461 7465 732e 7661 6c75 6573  tg.states.values
-00016010: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
-00016020: 206e 6f64 6573 5f64 6174 615b 226e 616d   nodes_data["nam
-00016030: 6522 5d2e 6170 7065 6e64 2874 672e 7072  e"].append(tg.pr
-00016040: 6566 6978 2e6e 616d 6529 0a0a 2020 2020  efix.name)..    
-00016050: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-00016060: 7461 5b22 636f 6c6f 7222 5d2e 6170 7065  ta["color"].appe
-00016070: 6e64 2863 6f6c 6f72 5f6f 6628 7467 2e70  nd(color_of(tg.p
-00016080: 7265 6669 782e 6e61 6d65 2929 0a20 2020  refix.name)).   
-00016090: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-000160a0: 6174 615b 2274 6f74 5f74 6173 6b73 225d  ata["tot_tasks"]
-000160b0: 2e61 7070 656e 6428 746f 745f 7461 736b  .append(tot_task
-000160c0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-000160d0: 2320 6d65 6d6f 7279 2061 6c70 6861 2066  # memory alpha f
-000160e0: 6163 746f 7220 6279 2030 2e34 2069 6620  actor by 0.4 if 
-000160f0: 6e6f 7420 6765 7427 7320 746f 6f20 6461  not get's too da
-00016100: 726b 0a20 2020 2020 2020 2020 2020 206e  rk.            n
-00016110: 6f64 6573 5f64 6174 615b 226d 656d 5f61  odes_data["mem_a
-00016120: 6c70 6861 225d 2e61 7070 656e 6428 0a20  lpha"].append(. 
-00016130: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00016140: 7467 2e73 7461 7465 735b 226d 656d 6f72  tg.states["memor
-00016150: 7922 5d20 2f20 7375 6d28 7467 2e73 7461  y"] / sum(tg.sta
-00016160: 7465 732e 7661 6c75 6573 2829 2929 202a  tes.values())) *
-00016170: 2030 2e34 0a20 2020 2020 2020 2020 2020   0.4.           
-00016180: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00016190: 2320 6d61 696e 2062 6f78 206c 696e 6520  # main box line 
-000161a0: 7769 6474 680a 2020 2020 2020 2020 2020  width.          
-000161b0: 2020 6966 2074 672e 7374 6174 6573 5b22    if tg.states["
-000161c0: 7072 6f63 6573 7369 6e67 225d 3a0a 2020  processing"]:.  
-000161d0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-000161e0: 6465 735f 6461 7461 5b22 6e6f 6465 5f6c  des_data["node_l
-000161f0: 696e 655f 7769 6474 6822 5d2e 6170 7065  ine_width"].appe
-00016200: 6e64 2835 290a 2020 2020 2020 2020 2020  nd(5).          
-00016210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00016220: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-00016230: 7461 5b22 6e6f 6465 5f6c 696e 655f 7769  ta["node_line_wi
-00016240: 6474 6822 5d2e 6170 7065 6e64 2831 290a  dth"].append(1).
-00016250: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
-00016260: 726f 6772 6573 7320 6261 7220 6461 7461  rogress bar data
-00016270: 2075 7064 6174 650a 2020 2020 2020 2020   update.        
-00016280: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
-00016290: 785f 7374 6172 7422 5d2e 6170 7065 6e64  x_start"].append
-000162a0: 2878 202d 2077 6964 7468 202f 2032 290a  (x - width / 2).
+00015490: 2022 746f 745f 7461 736b 7322 3a20 5b5d   "tot_tasks": []
+000154a0: 2c0a 2020 2020 2020 2020 2020 2020 2278  ,.            "x
+000154b0: 5f73 7461 7274 223a 205b 5d2c 0a20 2020  _start": [],.   
+000154c0: 2020 2020 2020 2020 2022 785f 656e 6422           "x_end"
+000154d0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000154e0: 2020 2279 5f73 7461 7274 223a 205b 5d2c    "y_start": [],
+000154f0: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
+00015500: 656e 6422 3a20 5b5d 2c0a 2020 2020 2020  end": [],.      
+00015510: 2020 2020 2020 2278 5f65 6e64 5f70 726f        "x_end_pro
+00015520: 6772 6573 7322 3a20 5b5d 2c0a 2020 2020  gress": [],.    
+00015530: 2020 2020 2020 2020 226d 656d 5f61 6c70          "mem_alp
+00015540: 6861 223a 205b 5d2c 0a20 2020 2020 2020  ha": [],.       
+00015550: 2020 2020 2022 6e6f 6465 5f6c 696e 655f       "node_line_
+00015560: 7769 6474 6822 3a20 5b5d 2c0a 2020 2020  width": [],.    
+00015570: 2020 2020 2020 2020 2263 6f6d 705f 7461          "comp_ta
+00015580: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
+00015590: 2020 2020 2020 2275 726c 5f6c 6f67 6f22        "url_logo"
+000155a0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000155b0: 2020 2278 5f6c 6f67 6f22 3a20 5b5d 2c0a    "x_logo": [],.
+000155c0: 2020 2020 2020 2020 2020 2020 2279 5f6c              "y_l
+000155d0: 6f67 6f22 3a20 5b5d 2c0a 2020 2020 2020  ogo": [],.      
+000155e0: 2020 2020 2020 2277 5f6c 6f67 6f22 3a20        "w_logo": 
+000155f0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00015600: 2268 5f6c 6f67 6f22 3a20 5b5d 2c0a 2020  "h_logo": [],.  
+00015610: 2020 2020 2020 2020 2020 2269 6e5f 7072            "in_pr
+00015620: 6f63 6573 7369 6e67 223a 205b 5d2c 0a20  ocessing": [],. 
+00015630: 2020 2020 2020 2020 2020 2022 696e 5f6d             "in_m
+00015640: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
+00015650: 2020 2020 2020 2020 2269 6e5f 7265 6c65          "in_rele
+00015660: 6173 6564 223a 205b 5d2c 0a20 2020 2020  ased": [],.     
+00015670: 2020 2020 2020 2022 696e 5f65 7272 6564         "in_erred
+00015680: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015690: 2020 2022 636f 6d70 7574 655f 7469 6d65     "compute_time
+000156a0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+000156b0: 2020 2022 6d65 6d6f 7279 223a 205b 5d2c     "memory": [],
+000156c0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+000156d0: 2020 2020 6172 726f 7773 5f64 6174 6120      arrows_data 
+000156e0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000156f0: 2278 7322 3a20 5b5d 2c0a 2020 2020 2020  "xs": [],.      
+00015700: 2020 2020 2020 2279 7322 3a20 5b5d 2c0a        "ys": [],.
+00015710: 2020 2020 2020 2020 2020 2020 2278 6522              "xe"
+00015720: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00015730: 2020 2279 6522 3a20 5b5d 2c0a 2020 2020    "ye": [],.    
+00015740: 2020 2020 7d0a 0a20 2020 2020 2020 2064      }..        d
+00015750: 7572 6174 696f 6e73 203d 2073 6574 2829  urations = set()
+00015760: 0a20 2020 2020 2020 206e 6279 7465 7320  .        nbytes 
+00015770: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00015780: 666f 7220 7467 2069 6e20 7365 6c66 2e73  for tg in self.s
+00015790: 6368 6564 756c 6572 2e74 6173 6b5f 6772  cheduler.task_gr
+000157a0: 6f75 7073 2e76 616c 7565 7328 293a 0a20  oups.values():. 
+000157b0: 2020 2020 2020 2020 2020 2069 6620 7467             if tg
+000157c0: 2e64 7572 6174 696f 6e20 616e 6420 7467  .duration and tg
+000157d0: 2e6e 6279 7465 735f 746f 7461 6c3a 0a20  .nbytes_total:. 
+000157e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000157f0: 7572 6174 696f 6e73 2e61 6464 2874 672e  urations.add(tg.
+00015800: 6475 7261 7469 6f6e 290a 2020 2020 2020  duration).      
+00015810: 2020 2020 2020 2020 2020 6e62 7974 6573            nbytes
+00015820: 2e61 6464 2874 672e 6e62 7974 6573 5f74  .add(tg.nbytes_t
+00015830: 6f74 616c 290a 0a20 2020 2020 2020 2064  otal)..        d
+00015840: 7572 6174 696f 6e73 5f6d 696e 203d 206d  urations_min = m
+00015850: 696e 2864 7572 6174 696f 6e73 2c20 6465  in(durations, de
+00015860: 6661 756c 743d 3029 0a20 2020 2020 2020  fault=0).       
+00015870: 2064 7572 6174 696f 6e73 5f6d 6178 203d   durations_max =
+00015880: 206d 6178 2864 7572 6174 696f 6e73 2c20   max(durations, 
+00015890: 6465 6661 756c 743d 3029 0a20 2020 2020  default=0).     
+000158a0: 2020 206e 6279 7465 735f 6d69 6e20 3d20     nbytes_min = 
+000158b0: 6d69 6e28 6e62 7974 6573 2c20 6465 6661  min(nbytes, defa
+000158c0: 756c 743d 3029 0a20 2020 2020 2020 206e  ult=0).        n
+000158d0: 6279 7465 735f 6d61 7820 3d20 6d61 7828  bytes_max = max(
+000158e0: 6e62 7974 6573 2c20 6465 6661 756c 743d  nbytes, default=
+000158f0: 3029 0a0a 2020 2020 2020 2020 626f 785f  0)..        box_
+00015900: 6469 6d20 3d20 7b7d 0a20 2020 2020 2020  dim = {}.       
+00015910: 2066 6f72 206b 6579 2c20 7467 2069 6e20   for key, tg in 
+00015920: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
+00015930: 6173 6b5f 6772 6f75 7073 2e69 7465 6d73  ask_groups.items
+00015940: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00015950: 636f 6d70 5f74 6173 6b73 203d 2028 0a20  comp_tasks = (. 
+00015960: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00015970: 672e 7374 6174 6573 5b22 7265 6c65 6173  g.states["releas
+00015980: 6564 225d 202b 2074 672e 7374 6174 6573  ed"] + tg.states
+00015990: 5b22 6d65 6d6f 7279 225d 202b 2074 672e  ["memory"] + tg.
+000159a0: 7374 6174 6573 5b22 6572 7265 6422 5d0a  states["erred"].
+000159b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000159c0: 2020 2020 2020 2020 2020 746f 745f 7461            tot_ta
+000159d0: 736b 7320 3d20 7375 6d28 7467 2e73 7461  sks = sum(tg.sta
+000159e0: 7465 732e 7661 6c75 6573 2829 290a 0a20  tes.values()).. 
+000159f0: 2020 2020 2020 2020 2020 2023 2063 6f6d             # com
+00015a00: 7075 7465 2077 6964 7468 2061 6e64 2068  pute width and h
+00015a10: 6569 6768 7420 6f66 2062 6f78 6573 0a20  eight of boxes. 
+00015a20: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a40: 7467 2e64 7572 6174 696f 6e0a 2020 2020  tg.duration.    
+00015a50: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00015a60: 7467 2e6e 6279 7465 735f 746f 7461 6c0a  tg.nbytes_total.
+00015a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a80: 616e 6420 636f 6d70 5f74 6173 6b73 0a20  and comp_tasks. 
+00015a90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00015aa0: 6e64 206c 656e 2864 7572 6174 696f 6e73  nd len(durations
+00015ab0: 2920 3e20 310a 2020 2020 2020 2020 2020  ) > 1.          
+00015ac0: 2020 2020 2020 616e 6420 6c65 6e28 6e62        and len(nb
+00015ad0: 7974 6573 2920 3e20 310a 2020 2020 2020  ytes) > 1.      
+00015ae0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+00015af0: 2020 2020 2020 2020 2023 2073 6361 6c65           # scale
+00015b00: 2064 7572 6174 696f 6e20 2877 6964 7468   duration (width
+00015b10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015b20: 2020 7769 6474 685f 626f 7820 3d20 7365    width_box = se
+00015b30: 6c66 2e63 6f6d 7075 7465 5f73 697a 6528  lf.compute_size(
+00015b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015b50: 2020 2020 2074 672e 6475 7261 7469 6f6e       tg.duration
+00015b60: 202f 2063 6f6d 705f 7461 736b 7320 2a20   / comp_tasks * 
+00015b70: 746f 745f 7461 736b 732c 0a20 2020 2020  tot_tasks,.     
+00015b80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00015b90: 696e 5f62 6f78 3d64 7572 6174 696f 6e73  in_box=durations
+00015ba0: 5f6d 696e 202f 2063 6f6d 705f 7461 736b  _min / comp_task
+00015bb0: 7320 2a20 746f 745f 7461 736b 732c 0a20  s * tot_tasks,. 
+00015bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015bd0: 2020 206d 6178 5f62 6f78 3d64 7572 6174     max_box=durat
+00015be0: 696f 6e73 5f6d 6178 202f 2063 6f6d 705f  ions_max / comp_
+00015bf0: 7461 736b 7320 2a20 746f 745f 7461 736b  tasks * tot_task
+00015c00: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00015c10: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00015c20: 2020 2020 2020 2320 6e65 6564 2074 6f20        # need to 
+00015c30: 7363 616c 6520 6d65 6d6f 7279 2028 6865  scale memory (he
+00015c40: 6967 6874 290a 2020 2020 2020 2020 2020  ight).          
+00015c50: 2020 2020 2020 6865 6967 6874 5f62 6f78        height_box
+00015c60: 203d 2073 656c 662e 636f 6d70 7574 655f   = self.compute_
+00015c70: 7369 7a65 280a 2020 2020 2020 2020 2020  size(.          
+00015c80: 2020 2020 2020 2020 2020 7467 2e6e 6279            tg.nby
+00015c90: 7465 735f 746f 7461 6c20 2f20 636f 6d70  tes_total / comp
+00015ca0: 5f74 6173 6b73 202a 2074 6f74 5f74 6173  _tasks * tot_tas
+00015cb0: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
+00015cc0: 2020 2020 2020 2020 6d69 6e5f 626f 783d          min_box=
+00015cd0: 6e62 7974 6573 5f6d 696e 202f 2063 6f6d  nbytes_min / com
+00015ce0: 705f 7461 736b 7320 2a20 746f 745f 7461  p_tasks * tot_ta
+00015cf0: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
+00015d00: 2020 2020 2020 2020 206d 6178 5f62 6f78           max_box
+00015d10: 3d6e 6279 7465 735f 6d61 7820 2f20 636f  =nbytes_max / co
+00015d20: 6d70 5f74 6173 6b73 202a 2074 6f74 5f74  mp_tasks * tot_t
+00015d30: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+00015d40: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00015d50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00015d60: 2020 2020 2020 2020 2020 2077 6964 7468             width
+00015d70: 5f62 6f78 203d 2030 2e36 0a20 2020 2020  _box = 0.6.     
+00015d80: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00015d90: 745f 626f 7820 3d20 7769 6474 685f 626f  t_box = width_bo
+00015da0: 7820 2f20 320a 0a20 2020 2020 2020 2020  x / 2..         
+00015db0: 2020 2062 6f78 5f64 696d 5b6b 6579 5d20     box_dim[key] 
+00015dc0: 3d20 7b22 7769 6474 6822 3a20 7769 6474  = {"width": widt
+00015dd0: 685f 626f 782c 2022 6865 6967 6874 223a  h_box, "height":
+00015de0: 2068 6569 6768 745f 626f 787d 0a0a 2020   height_box}..  
+00015df0: 2020 2020 2020 666f 7220 6b65 792c 2074        for key, t
+00015e00: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
+00015e10: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
+00015e20: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00015e30: 2020 2020 2078 203d 2073 656c 662e 6e6f       x = self.no
+00015e40: 6465 735f 6c61 796f 7574 5b6b 6579 5d5b  des_layout[key][
+00015e50: 2278 225d 0a20 2020 2020 2020 2020 2020  "x"].           
+00015e60: 2079 203d 2073 656c 662e 6e6f 6465 735f   y = self.nodes_
+00015e70: 6c61 796f 7574 5b6b 6579 5d5b 2279 225d  layout[key]["y"]
+00015e80: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+00015e90: 7468 203d 2062 6f78 5f64 696d 5b6b 6579  th = box_dim[key
+00015ea0: 5d5b 2277 6964 7468 225d 0a20 2020 2020  ]["width"].     
+00015eb0: 2020 2020 2020 2068 6569 6768 7420 3d20         height = 
+00015ec0: 626f 785f 6469 6d5b 6b65 795d 5b22 6865  box_dim[key]["he
+00015ed0: 6967 6874 225d 0a0a 2020 2020 2020 2020  ight"]..        
+00015ee0: 2020 2020 2320 6d61 696e 2062 6f78 6573      # main boxes
+00015ef0: 206c 6179 6f75 740a 2020 2020 2020 2020   layout.        
+00015f00: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
+00015f10: 7822 5d2e 6170 7065 6e64 2878 290a 2020  x"].append(x).  
+00015f20: 2020 2020 2020 2020 2020 6e6f 6465 735f            nodes_
+00015f30: 6461 7461 5b22 7922 5d2e 6170 7065 6e64  data["y"].append
+00015f40: 2879 290a 2020 2020 2020 2020 2020 2020  (y).            
+00015f50: 6e6f 6465 735f 6461 7461 5b22 775f 626f  nodes_data["w_bo
+00015f60: 7822 5d2e 6170 7065 6e64 2877 6964 7468  x"].append(width
+00015f70: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
+00015f80: 6465 735f 6461 7461 5b22 685f 626f 7822  des_data["h_box"
+00015f90: 5d2e 6170 7065 6e64 2868 6569 6768 7429  ].append(height)
+00015fa0: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+00015fb0: 6d70 5f74 6173 6b73 203d 2028 0a20 2020  mp_tasks = (.   
+00015fc0: 2020 2020 2020 2020 2020 2020 2074 672e               tg.
+00015fd0: 7374 6174 6573 5b22 7265 6c65 6173 6564  states["released
+00015fe0: 225d 202b 2074 672e 7374 6174 6573 5b22  "] + tg.states["
+00015ff0: 6d65 6d6f 7279 225d 202b 2074 672e 7374  memory"] + tg.st
+00016000: 6174 6573 5b22 6572 7265 6422 5d0a 2020  ates["erred"].  
+00016010: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016020: 2020 2020 2020 2020 746f 745f 7461 736b          tot_task
+00016030: 7320 3d20 7375 6d28 7467 2e73 7461 7465  s = sum(tg.state
+00016040: 732e 7661 6c75 6573 2829 290a 0a20 2020  s.values())..   
+00016050: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016060: 6174 615b 226e 616d 6522 5d2e 6170 7065  ata["name"].appe
+00016070: 6e64 2874 672e 7072 6566 6978 2e6e 616d  nd(tg.prefix.nam
+00016080: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00016090: 6e6f 6465 735f 6461 7461 5b22 636f 6c6f  nodes_data["colo
+000160a0: 7222 5d2e 6170 7065 6e64 2863 6f6c 6f72  r"].append(color
+000160b0: 5f6f 6628 7467 2e70 7265 6669 782e 6e61  _of(tg.prefix.na
+000160c0: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
+000160d0: 206e 6f64 6573 5f64 6174 615b 2274 6f74   nodes_data["tot
+000160e0: 5f74 6173 6b73 225d 2e61 7070 656e 6428  _tasks"].append(
+000160f0: 746f 745f 7461 736b 7329 0a0a 2020 2020  tot_tasks)..    
+00016100: 2020 2020 2020 2020 2320 6d65 6d6f 7279          # memory
+00016110: 2061 6c70 6861 2066 6163 746f 7220 6279   alpha factor by
+00016120: 2030 2e34 2069 6620 6e6f 7420 6765 7427   0.4 if not get'
+00016130: 7320 746f 6f20 6461 726b 0a20 2020 2020  s too dark.     
+00016140: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+00016150: 615b 226d 656d 5f61 6c70 6861 225d 2e61  a["mem_alpha"].a
+00016160: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+00016170: 2020 2020 2020 2028 7467 2e73 7461 7465         (tg.state
+00016180: 735b 226d 656d 6f72 7922 5d20 2f20 7375  s["memory"] / su
+00016190: 6d28 7467 2e73 7461 7465 732e 7661 6c75  m(tg.states.valu
+000161a0: 6573 2829 2929 202a 2030 2e34 0a20 2020  es())) * 0.4.   
+000161b0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000161c0: 2020 2020 2020 2020 2320 6d61 696e 2062          # main b
+000161d0: 6f78 206c 696e 6520 7769 6474 680a 2020  ox line width.  
+000161e0: 2020 2020 2020 2020 2020 6966 2074 672e            if tg.
+000161f0: 7374 6174 6573 5b22 7072 6f63 6573 7369  states["processi
+00016200: 6e67 225d 3a0a 2020 2020 2020 2020 2020  ng"]:.          
+00016210: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016220: 5b22 6e6f 6465 5f6c 696e 655f 7769 6474  ["node_line_widt
+00016230: 6822 5d2e 6170 7065 6e64 2835 290a 2020  h"].append(5).  
+00016240: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016260: 6e6f 6465 735f 6461 7461 5b22 6e6f 6465  nodes_data["node
+00016270: 5f6c 696e 655f 7769 6474 6822 5d2e 6170  _line_width"].ap
+00016280: 7065 6e64 2831 290a 0a20 2020 2020 2020  pend(1)..       
+00016290: 2020 2020 2023 2070 726f 6772 6573 7320       # progress 
+000162a0: 6261 7220 6461 7461 2075 7064 6174 650a  bar data update.
 000162b0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000162c0: 735f 6461 7461 5b22 785f 656e 6422 5d2e  s_data["x_end"].
-000162d0: 6170 7065 6e64 2878 202b 2077 6964 7468  append(x + width
-000162e0: 202f 2032 290a 0a20 2020 2020 2020 2020   / 2)..         
-000162f0: 2020 206e 6f64 6573 5f64 6174 615b 2279     nodes_data["y
-00016300: 5f73 7461 7274 225d 2e61 7070 656e 6428  _start"].append(
-00016310: 7920 2d20 6865 6967 6874 202f 2032 290a  y - height / 2).
-00016320: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00016330: 735f 6461 7461 5b22 795f 656e 6422 5d2e  s_data["y_end"].
-00016340: 6170 7065 6e64 2879 202d 2068 6569 6768  append(y - heigh
-00016350: 7420 2f20 3220 2b20 6865 6967 6874 202a  t / 2 + height *
-00016360: 2030 2e34 290a 0a20 2020 2020 2020 2020   0.4)..         
-00016370: 2020 206e 6f64 6573 5f64 6174 615b 2278     nodes_data["x
-00016380: 5f65 6e64 5f70 726f 6772 6573 7322 5d2e  _end_progress"].
-00016390: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-000163a0: 2020 2020 2020 2020 7820 2d20 7769 6474          x - widt
-000163b0: 6820 2f20 3220 2b20 7769 6474 6820 2a20  h / 2 + width * 
-000163c0: 636f 6d70 5f74 6173 6b73 202f 2074 6f74  comp_tasks / tot
-000163d0: 5f74 6173 6b73 0a20 2020 2020 2020 2020  _tasks.         
-000163e0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-000163f0: 2020 2320 6172 726f 7773 0a20 2020 2020    # arrows.     
-00016400: 2020 2020 2020 2061 7272 6f77 735f 6461         arrows_da
-00016410: 7461 5b22 7873 225d 202b 3d20 5b0a 2020  ta["xs"] += [.  
-00016420: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00016430: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 745b  lf.nodes_layout[
-00016440: 6b5d 5b22 7822 5d20 2b20 626f 785f 6469  k]["x"] + box_di
-00016450: 6d5b 6b5d 5b22 7769 6474 6822 5d20 2f20  m[k]["width"] / 
-00016460: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-00016470: 2020 666f 7220 6b20 696e 2073 656c 662e    for k in self.
-00016480: 6172 726f 7773 5f6c 6179 6f75 745b 6b65  arrows_layout[ke
-00016490: 795d 5b22 6e73 7461 7274 225d 0a20 2020  y]["nstart"].   
-000164a0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-000164b0: 2020 2020 2020 2061 7272 6f77 735f 6461         arrows_da
-000164c0: 7461 5b22 7973 225d 202b 3d20 5b0a 2020  ta["ys"] += [.  
-000164d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000164e0: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 745b  lf.nodes_layout[
-000164f0: 6b5d 5b22 7922 5d20 666f 7220 6b20 696e  k]["y"] for k in
-00016500: 2073 656c 662e 6172 726f 7773 5f6c 6179   self.arrows_lay
-00016510: 6f75 745b 6b65 795d 5b22 6e73 7461 7274  out[key]["nstart
-00016520: 225d 0a20 2020 2020 2020 2020 2020 205d  "].            ]
-00016530: 0a20 2020 2020 2020 2020 2020 2061 7272  .            arr
-00016540: 6f77 735f 6461 7461 5b22 7865 225d 202b  ows_data["xe"] +
-00016550: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00016560: 2020 2020 7365 6c66 2e6e 6f64 6573 5f6c      self.nodes_l
-00016570: 6179 6f75 745b 6b5d 5b22 7822 5d20 2d20  ayout[k]["x"] - 
-00016580: 626f 785f 6469 6d5b 6b5d 5b22 7769 6474  box_dim[k]["widt
-00016590: 6822 5d20 2f20 320a 2020 2020 2020 2020  h"] / 2.        
-000165a0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-000165b0: 2073 656c 662e 6172 726f 7773 5f6c 6179   self.arrows_lay
-000165c0: 6f75 745b 6b65 795d 5b22 6e65 6e64 225d  out[key]["nend"]
-000165d0: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
-000165e0: 2020 2020 2020 2020 2020 2061 7272 6f77             arrow
-000165f0: 735f 6461 7461 5b22 7965 225d 202b 3d20  s_data["ye"] += 
-00016600: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00016610: 2020 7365 6c66 2e6e 6f64 6573 5f6c 6179    self.nodes_lay
-00016620: 6f75 745b 6b5d 5b22 7922 5d20 666f 7220  out[k]["y"] for 
-00016630: 6b20 696e 2073 656c 662e 6172 726f 7773  k in self.arrows
-00016640: 5f6c 6179 6f75 745b 6b65 795d 5b22 6e65  _layout[key]["ne
-00016650: 6e64 225d 0a20 2020 2020 2020 2020 2020  nd"].           
-00016660: 205d 0a0a 2020 2020 2020 2020 2020 2020   ]..            
-00016670: 2320 4c4f 474f 530a 2020 2020 2020 2020  # LOGOS.        
-00016680: 2020 2020 6966 206c 656e 2874 672e 7479      if len(tg.ty
-00016690: 7065 7329 203d 3d20 313a 0a20 2020 2020  pes) == 1:.     
-000166a0: 2020 2020 2020 2020 2020 206c 6f67 6f5f             logo_
-000166b0: 7479 7065 203d 206e 6578 7428 6974 6572  type = next(iter
-000166c0: 2874 672e 7479 7065 7329 292e 7370 6c69  (tg.types)).spli
-000166d0: 7428 222e 2229 5b30 5d0a 2020 2020 2020  t(".")[0].      
-000166e0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000166f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016700: 2020 2075 726c 5f6c 6f67 6f20 3d20 6c6f     url_logo = lo
-00016710: 676f 735f 6469 6374 5b6c 6f67 6f5f 7479  gos_dict[logo_ty
-00016720: 7065 5d0a 2020 2020 2020 2020 2020 2020  pe].            
-00016730: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
-00016740: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00016750: 2020 2020 2020 2020 2075 726c 5f6c 6f67           url_log
-00016760: 6f20 3d20 2222 0a20 2020 2020 2020 2020  o = "".         
-00016770: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016780: 2020 2020 2020 2020 2075 726c 5f6c 6f67           url_log
-00016790: 6f20 3d20 2222 0a0a 2020 2020 2020 2020  o = ""..        
-000167a0: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
-000167b0: 7572 6c5f 6c6f 676f 225d 2e61 7070 656e  url_logo"].appen
-000167c0: 6428 7572 6c5f 6c6f 676f 290a 0a20 2020  d(url_logo)..   
-000167d0: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-000167e0: 6174 615b 2278 5f6c 6f67 6f22 5d2e 6170  ata["x_logo"].ap
-000167f0: 7065 6e64 2878 202b 2077 6964 7468 202f  pend(x + width /
-00016800: 2033 290a 2020 2020 2020 2020 2020 2020   3).            
-00016810: 6e6f 6465 735f 6461 7461 5b22 795f 6c6f  nodes_data["y_lo
-00016820: 676f 225d 2e61 7070 656e 6428 7920 2b20  go"].append(y + 
-00016830: 6865 6967 6874 202f 2033 290a 0a20 2020  height / 3)..   
-00016840: 2020 2020 2020 2020 2072 6174 696f 203d           ratio =
-00016850: 2077 6964 7468 202f 2068 6569 6768 740a   width / height.
-00016860: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00016870: 7261 7469 6f20 3e20 313a 0a20 2020 2020  ratio > 1:.     
-00016880: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016890: 5f64 6174 615b 2268 5f6c 6f67 6f22 5d2e  _data["h_logo"].
-000168a0: 6170 7065 6e64 2868 6569 6768 7420 2a20  append(height * 
-000168b0: 302e 3329 0a20 2020 2020 2020 2020 2020  0.3).           
-000168c0: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-000168d0: 2277 5f6c 6f67 6f22 5d2e 6170 7065 6e64  "w_logo"].append
-000168e0: 2877 6964 7468 202a 2030 2e33 202f 2072  (width * 0.3 / r
-000168f0: 6174 696f 290a 2020 2020 2020 2020 2020  atio).          
-00016900: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00016910: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-00016920: 7461 5b22 685f 6c6f 676f 225d 2e61 7070  ta["h_logo"].app
-00016930: 656e 6428 6865 6967 6874 202a 2030 2e33  end(height * 0.3
-00016940: 202a 2072 6174 696f 290a 2020 2020 2020   * ratio).      
-00016950: 2020 2020 2020 2020 2020 6e6f 6465 735f            nodes_
-00016960: 6461 7461 5b22 775f 6c6f 676f 225d 2e61  data["w_logo"].a
-00016970: 7070 656e 6428 7769 6474 6820 2a20 302e  ppend(width * 0.
-00016980: 3329 0a0a 2020 2020 2020 2020 2020 2020  3)..            
-00016990: 2320 636f 6d70 7574 655f 7469 6d65 2061  # compute_time a
-000169a0: 6e64 206d 656d 6f72 790a 2020 2020 2020  nd memory.      
-000169b0: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-000169c0: 5b22 636f 6d70 7574 655f 7469 6d65 225d  ["compute_time"]
-000169d0: 2e61 7070 656e 6428 666f 726d 6174 5f74  .append(format_t
-000169e0: 696d 6528 7467 2e64 7572 6174 696f 6e29  ime(tg.duration)
-000169f0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
-00016a00: 6465 735f 6461 7461 5b22 6d65 6d6f 7279  des_data["memory
-00016a10: 225d 2e61 7070 656e 6428 666f 726d 6174  "].append(format
-00016a20: 5f62 7974 6573 2874 672e 6e62 7974 6573  _bytes(tg.nbytes
-00016a30: 5f74 6f74 616c 2929 0a0a 2020 2020 2020  _total))..      
-00016a40: 2020 2020 2020 2320 4164 6420 736f 6d65        # Add some
-00016a50: 2073 7461 7475 7320 746f 2068 6f76 6572   status to hover
-00016a60: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00016a70: 6b73 5f70 726f 6365 7373 696e 6720 3d20  ks_processing = 
-00016a80: 7467 2e73 7461 7465 735b 2270 726f 6365  tg.states["proce
-00016a90: 7373 696e 6722 5d0a 2020 2020 2020 2020  ssing"].        
-00016aa0: 2020 2020 7461 736b 735f 6d65 6d6f 7279      tasks_memory
-00016ab0: 203d 2074 672e 7374 6174 6573 5b22 6d65   = tg.states["me
-00016ac0: 6d6f 7279 225d 0a20 2020 2020 2020 2020  mory"].         
-00016ad0: 2020 2074 6173 6b73 5f72 656c 6173 6564     tasks_relased
-00016ae0: 203d 2074 672e 7374 6174 6573 5b22 7265   = tg.states["re
-00016af0: 6c65 6173 6564 225d 0a20 2020 2020 2020  leased"].       
-00016b00: 2020 2020 2074 6173 6b73 5f65 7272 6564       tasks_erred
-00016b10: 203d 2074 672e 7374 6174 6573 5b22 6572   = tg.states["er
-00016b20: 7265 6422 5d0a 0a20 2020 2020 2020 2020  red"]..         
-00016b30: 2020 206e 6f64 6573 5f64 6174 615b 2263     nodes_data["c
-00016b40: 6f6d 705f 7461 736b 7322 5d2e 6170 7065  omp_tasks"].appe
-00016b50: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-00016b60: 2020 2020 6622 7b63 6f6d 705f 7461 736b      f"{comp_task
-00016b70: 737d 2028 7b63 6f6d 705f 7461 736b 7320  s} ({comp_tasks 
-00016b80: 2f20 746f 745f 7461 736b 7320 2a20 3130  / tot_tasks * 10
-00016b90: 303a 2e30 667d 2025 2922 0a20 2020 2020  0:.0f} %)".     
-00016ba0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00016bb0: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-00016bc0: 2269 6e5f 7072 6f63 6573 7369 6e67 225d  "in_processing"]
-00016bd0: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-00016be0: 2020 2020 2020 2020 2066 227b 7461 736b           f"{task
-00016bf0: 735f 7072 6f63 6573 7369 6e67 7d20 287b  s_processing} ({
-00016c00: 7461 736b 735f 7072 6f63 6573 7369 6e67  tasks_processing
-00016c10: 2f20 746f 745f 7461 736b 7320 2a20 3130  / tot_tasks * 10
-00016c20: 303a 2e30 667d 2025 2922 0a20 2020 2020  0:.0f} %)".     
-00016c30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00016c40: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-00016c50: 2269 6e5f 6d65 6d6f 7279 225d 2e61 7070  "in_memory"].app
-00016c60: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-00016c70: 2020 2020 2066 227b 7461 736b 735f 6d65       f"{tasks_me
-00016c80: 6d6f 7279 7d20 287b 7461 736b 735f 6d65  mory} ({tasks_me
-00016c90: 6d6f 7279 2f20 746f 745f 7461 736b 7320  mory/ tot_tasks 
-00016ca0: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
-00016cb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00016cc0: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016cd0: 6174 615b 2269 6e5f 7265 6c65 6173 6564  ata["in_released
-00016ce0: 225d 2e61 7070 656e 6428 0a20 2020 2020  "].append(.     
-00016cf0: 2020 2020 2020 2020 2020 2066 227b 7461             f"{ta
-00016d00: 736b 735f 7265 6c61 7365 647d 2028 7b74  sks_relased} ({t
-00016d10: 6173 6b73 5f72 656c 6173 6564 2f20 746f  asks_relased/ to
-00016d20: 745f 7461 736b 7320 2a20 3130 303a 2e30  t_tasks * 100:.0
-00016d30: 667d 2025 2922 0a20 2020 2020 2020 2020  f} %)".         
-00016d40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00016d50: 206e 6f64 6573 5f64 6174 615b 2269 6e5f   nodes_data["in_
-00016d60: 6572 7265 6422 5d2e 6170 7065 6e64 280a  erred"].append(.
-00016d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d80: 6622 7b20 7461 736b 735f 6572 7265 647d  f"{ tasks_erred}
-00016d90: 2028 7b74 6173 6b73 5f65 7272 6564 2f20   ({tasks_erred/ 
-00016da0: 746f 745f 7461 736b 7320 2a20 3130 303a  tot_tasks * 100:
-00016db0: 2e30 667d 2025 2922 0a20 2020 2020 2020  .0f} %)".       
-00016dc0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00016dd0: 7365 6c66 2e6e 6f64 6573 5f73 6f75 7263  self.nodes_sourc
-00016de0: 652e 6461 7461 2e75 7064 6174 6528 6e6f  e.data.update(no
-00016df0: 6465 735f 6461 7461 290a 2020 2020 2020  des_data).      
-00016e00: 2020 7365 6c66 2e61 7272 6f77 735f 736f    self.arrows_so
-00016e10: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
-00016e20: 2861 7272 6f77 735f 6461 7461 290a 0a0a  (arrows_data)...
-00016e30: 636c 6173 7320 5461 736b 4772 6f75 7050  class TaskGroupP
-00016e40: 726f 6772 6573 7328 4461 7368 626f 6172  rogress(Dashboar
-00016e50: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-00016e60: 2022 2222 5374 6163 6b65 6420 6172 6561   """Stacked area
-00016e70: 2063 6861 7274 2073 686f 7769 6e67 2074   chart showing t
-00016e80: 6173 6b20 6772 6f75 7073 2074 6872 6f75  ask groups throu
-00016e90: 6768 2074 696d 6522 2222 0a0a 2020 2020  gh time"""..    
-00016ea0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00016eb0: 662c 2073 6368 6564 756c 6572 2c20 2a2a  f, scheduler, **
-00016ec0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00016ed0: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
-00016ee0: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
-00016ef0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
-00016f00: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-00016f10: 6365 2829 0a20 2020 2020 2020 2023 2054  ce().        # T
-00016f20: 6865 206c 656e 6774 6820 6f66 2074 696d  he length of tim
-00016f30: 6573 6572 6965 7320 746f 2063 6861 7274  eseries to chart
-00016f40: 2028 696e 2075 6e69 7473 206f 6620 706c   (in units of pl
-00016f50: 7567 696e 2e64 7429 0a20 2020 2020 2020  ugin.dt).       
-00016f60: 2073 656c 662e 6e70 7473 203d 2031 3830   self.npts = 180
-00016f70: 0a0a 2020 2020 2020 2020 6966 2047 726f  ..        if Gro
-00016f80: 7570 5469 6d69 6e67 2e6e 616d 6520 6e6f  upTiming.name no
-00016f90: 7420 696e 2073 6368 6564 756c 6572 2e70  t in scheduler.p
-00016fa0: 6c75 6769 6e73 3a0a 2020 2020 2020 2020  lugins:.        
-00016fb0: 2020 2020 7363 6865 6475 6c65 722e 6164      scheduler.ad
-00016fc0: 645f 706c 7567 696e 2870 6c75 6769 6e3d  d_plugin(plugin=
-00016fd0: 4772 6f75 7054 696d 696e 6728 7363 6865  GroupTiming(sche
-00016fe0: 6475 6c65 7229 290a 0a20 2020 2020 2020  duler))..       
-00016ff0: 2073 656c 662e 706c 7567 696e 203d 2073   self.plugin = s
-00017000: 6368 6564 756c 6572 2e70 6c75 6769 6e73  cheduler.plugins
-00017010: 5b47 726f 7570 5469 6d69 6e67 2e6e 616d  [GroupTiming.nam
-00017020: 655d 0a0a 2020 2020 2020 2020 7365 6c66  e]..        self
-00017030: 2e73 6f75 7263 652e 6164 6428 6e70 2e61  .source.add(np.a
-00017040: 7272 6179 2873 656c 662e 706c 7567 696e  rray(self.plugin
-00017050: 2e74 696d 6529 202a 2031 3030 302e 302c  .time) * 1000.0,
-00017060: 2022 7469 6d65 2229 0a0a 2020 2020 2020   "time")..      
-00017070: 2020 785f 7261 6e67 6520 3d20 4461 7461    x_range = Data
-00017080: 5261 6e67 6531 6428 7261 6e67 655f 7061  Range1d(range_pa
-00017090: 6464 696e 673d 3029 0a20 2020 2020 2020  dding=0).       
-000170a0: 2079 5f72 616e 6765 203d 2052 616e 6765   y_range = Range
-000170b0: 3164 2830 2c20 6d61 7828 7365 6c66 2e70  1d(0, max(self.p
-000170c0: 6c75 6769 6e2e 6e74 6872 6561 6473 2929  lugin.nthreads))
-000170d0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-000170e0: 6f6f 7420 3d20 6669 6775 7265 280a 2020  oot = figure(.  
-000170f0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-00017100: 2254 6173 6b20 4772 6f75 7020 5072 6f67  "Task Group Prog
-00017110: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
-00017120: 2020 206e 616d 653d 2274 6173 6b5f 6772     name="task_gr
-00017130: 6f75 705f 7072 6f67 7265 7373 222c 0a20  oup_progress",. 
-00017140: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
-00017150: 6172 5f6c 6f63 6174 696f 6e3d 2261 626f  ar_location="abo
-00017160: 7665 222c 0a20 2020 2020 2020 2020 2020  ve",.           
-00017170: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
-00017180: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
-00017190: 2020 2078 5f72 616e 6765 3d78 5f72 616e     x_range=x_ran
-000171a0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
-000171b0: 795f 7261 6e67 653d 795f 7261 6e67 652c  y_range=y_range,
-000171c0: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-000171d0: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
-000171e0: 2020 2078 5f61 7869 735f 7479 7065 3d22     x_axis_type="
-000171f0: 6461 7465 7469 6d65 222c 0a20 2020 2020  datetime",.     
-00017200: 2020 2020 2020 2079 5f61 7869 735f 6c6f         y_axis_lo
-00017210: 6361 7469 6f6e 3d4e 6f6e 652c 0a20 2020  cation=None,.   
-00017220: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00017230: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-00017240: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-00017250: 6178 6973 2e6d 616a 6f72 5f6c 6162 656c  axis.major_label
-00017260: 5f74 6578 745f 616c 7068 6120 3d20 300a  _text_alpha = 0.
-00017270: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00017280: 742e 7961 7869 732e 6d69 6e6f 725f 7469  t.yaxis.minor_ti
-00017290: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
-000172a0: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
-000172b0: 6f6f 742e 7961 7869 732e 6d61 6a6f 725f  oot.yaxis.major_
-000172c0: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
-000172d0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-000172e0: 2e72 6f6f 742e 7867 7269 642e 7669 7369  .root.xgrid.visi
-000172f0: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
-00017300: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
-00017310: 6464 5f74 6f6f 6c73 280a 2020 2020 2020  dd_tools(.      
-00017320: 2020 2020 2020 426f 785a 6f6f 6d54 6f6f        BoxZoomToo
-00017330: 6c28 292c 0a20 2020 2020 2020 2020 2020  l(),.           
-00017340: 2052 6573 6574 546f 6f6c 2829 2c0a 2020   ResetTool(),.  
-00017350: 2020 2020 2020 2020 2020 5061 6e54 6f6f            PanToo
-00017360: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
-00017370: 6474 6822 292c 0a20 2020 2020 2020 2020  dth"),.         
-00017380: 2020 2057 6865 656c 5a6f 6f6d 546f 6f6c     WheelZoomTool
-00017390: 2864 696d 656e 7369 6f6e 733d 2277 6964  (dimensions="wid
-000173a0: 7468 2229 2c0a 2020 2020 2020 2020 290a  th"),.        ).
-000173b0: 2020 2020 2020 2020 7365 6c66 2e5f 686f          self._ho
-000173c0: 7665 7220 3d20 4e6f 6e65 0a20 2020 2020  ver = None.     
-000173d0: 2020 2073 656c 662e 5f6c 6173 745f 6472     self._last_dr
-000173e0: 6177 6e20 3d20 4e6f 6e65 0a20 2020 2020  awn = None.     
-000173f0: 2020 2073 656c 662e 5f6f 6666 7365 7420     self._offset 
-00017400: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
-00017410: 2073 656c 662e 5f6c 6173 745f 7472 616e   self._last_tran
-00017420: 7369 7469 6f6e 5f63 6f75 6e74 203d 2073  sition_count = s
-00017430: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-00017440: 696f 6e5f 636f 756e 7465 720a 2020 2020  ion_counter.    
-00017450: 2020 2020 2320 4f72 6465 7265 6444 6963      # OrderedDic
-00017460: 7420 736f 2077 6520 6361 6e20 6d61 6b65  t so we can make
-00017470: 2061 2072 6576 6572 7365 2069 7465 7261   a reverse itera
-00017480: 746f 7220 6c61 7465 7220 616e 6420 6765  tor later and ge
-00017490: 7420 7468 650a 2020 2020 2020 2020 2320  t the.        # 
-000174a0: 6d6f 7374 2d72 6563 656e 746c 792d 6164  most-recently-ad
-000174b0: 6465 6420 676c 7970 6873 2e0a 2020 2020  ded glyphs..    
-000174c0: 2020 2020 7365 6c66 2e5f 7265 6e64 6572      self._render
-000174d0: 6572 7320 3d20 4f72 6465 7265 6444 6963  ers = OrderedDic
-000174e0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-000174f0: 2e5f 6c69 6e65 5f72 656e 6465 7265 7273  ._line_renderers
-00017500: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-00017510: 0a0a 2020 2020 6465 6620 5f73 686f 756c  ..    def _shoul
-00017520: 645f 6164 645f 6e65 775f 7265 6e64 6572  d_add_new_render
-00017530: 6572 7328 7365 6c66 2920 2d3e 2062 6f6f  ers(self) -> boo
-00017540: 6c3a 0a20 2020 2020 2020 2022 2222 0a20  l:.        """. 
-00017550: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
-00017560: 6f20 6164 6420 6e65 7720 7265 6e64 6572  o add new render
-00017570: 6572 7320 746f 2074 6865 2063 6861 7274  ers to the chart
-00017580: 2e0a 0a20 2020 2020 2020 2057 6865 6e20  ...        When 
-00017590: 6120 6e65 7720 7365 7420 6f66 2074 6173  a new set of tas
-000175a0: 6b20 6772 6f75 7073 2065 6e74 6572 7320  k groups enters 
-000175b0: 7468 6520 7363 6865 6475 6c65 7220 7765  the scheduler we
-000175c0: 2764 206c 696b 6520 746f 2073 7461 7274  'd like to start
-000175d0: 2072 656e 6465 7269 6e67 0a20 2020 2020   rendering.     
-000175e0: 2020 2074 6865 6d2e 2042 7574 2069 7420     them. But it 
-000175f0: 6361 6e20 6265 2065 7870 656e 7369 7665  can be expensive
-00017600: 2074 6f20 6164 6420 6e65 7720 676c 7970   to add new glyp
-00017610: 732c 2073 6f20 7765 2064 6f20 6974 2064  s, so we do it d
-00017620: 656c 6962 6572 6174 656c 792c 0a20 2020  eliberately,.   
-00017630: 2020 2020 2063 6865 636b 696e 6720 7768       checking wh
-00017640: 6574 6865 7220 7765 2068 6176 6520 746f  ether we have to
-00017650: 2064 6f20 6974 2061 6e64 2077 6865 7468   do it and wheth
-00017660: 6572 2074 6865 2073 6368 6564 756c 6572  er the scheduler
-00017670: 2073 6565 6d73 2062 7573 792e 0a20 2020   seems busy..   
-00017680: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00017690: 2023 2041 6c77 6179 7320 6472 6177 2069   # Always draw i
-000176a0: 6620 7765 2068 6176 6520 6e6f 7420 6265  f we have not be
-000176b0: 666f 7265 0a20 2020 2020 2020 2069 6620  fore.        if 
-000176c0: 6e6f 7420 7365 6c66 2e5f 6c61 7374 5f64  not self._last_d
-000176d0: 7261 776e 3a0a 2020 2020 2020 2020 2020  rawn:.          
-000176e0: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
-000176f0: 2020 2020 2020 2320 446f 6e27 7420 6472        # Don't dr
-00017700: 6177 2069 6620 7468 6572 6520 6861 7665  aw if there have
-00017710: 2062 6565 6e20 6e6f 206e 6577 2074 6173   been no new tas
-00017720: 6b73 2063 6f6d 706c 6574 6564 2073 696e  ks completed sin
-00017730: 6365 2074 6865 206c 6173 7420 7570 6461  ce the last upda
-00017740: 7465 2c0a 2020 2020 2020 2020 2320 6f72  te,.        # or
-00017750: 2069 6620 7468 6520 7363 6865 6475 6c65   if the schedule
-00017760: 7220 4350 5520 6973 206f 6363 7570 6965  r CPU is occupie
-00017770: 642e 0a20 2020 2020 2020 2069 6620 280a  d..        if (.
-00017780: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017790: 2e5f 6c61 7374 5f74 7261 6e73 6974 696f  ._last_transitio
-000177a0: 6e5f 636f 756e 7420 3d3d 2073 656c 662e  n_count == self.
-000177b0: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
-000177c0: 7469 6f6e 5f63 6f75 6e74 6572 0a20 2020  tion_counter.   
-000177d0: 2020 2020 2020 2020 206f 7220 7365 6c66           or self
-000177e0: 2e73 6368 6564 756c 6572 2e70 726f 632e  .scheduler.proc.
-000177f0: 6370 755f 7065 7263 656e 7428 2920 3e20  cpu_percent() > 
-00017800: 3530 0a20 2020 2020 2020 2029 3a0a 2020  50.        ):.  
-00017810: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017820: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-00017830: 2320 4f6e 6c79 2072 6574 7572 6e20 7472  # Only return tr
-00017840: 7565 2069 6620 7468 6572 6520 6172 6520  ue if there are 
-00017850: 6e65 7720 7461 736b 2067 726f 7570 7320  new task groups 
-00017860: 7468 6174 2077 6520 6861 7665 206e 6f74  that we have not
-00017870: 2079 6574 2061 6464 6564 0a20 2020 2020   yet added.     
-00017880: 2020 2023 2074 6f20 7468 6520 436f 6c75     # to the Colu
-00017890: 6d6e 4461 7461 536f 7572 6365 2e0a 2020  mnDataSource..  
-000178a0: 2020 2020 2020 7265 7475 726e 206e 6f74        return not
-000178b0: 2073 6574 2873 656c 662e 706c 7567 696e   set(self.plugin
-000178c0: 2e63 6f6d 7075 7465 2e6b 6579 7328 2929  .compute.keys())
-000178d0: 203c 3d20 7365 7428 7365 6c66 2e73 6f75   <= set(self.sou
-000178e0: 7263 652e 6461 7461 2e6b 6579 7328 2929  rce.data.keys())
-000178f0: 0a0a 2020 2020 6465 6620 5f73 686f 756c  ..    def _shoul
-00017900: 645f 7570 6461 7465 2873 656c 6629 202d  d_update(self) -
-00017910: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-00017920: 2222 220a 2020 2020 2020 2020 5768 6574  """.        Whet
-00017930: 6865 7220 746f 2075 7064 6174 6520 7468  her to update th
-00017940: 6520 436f 6c75 6d6e 4461 7461 536f 7572  e ColumnDataSour
-00017950: 6365 2e20 5468 6973 2069 7320 6368 6561  ce. This is chea
-00017960: 7065 7220 7468 616e 2072 6564 7261 7769  per than redrawi
-00017970: 6e67 2c0a 2020 2020 2020 2020 6275 7420  ng,.        but 
-00017980: 7374 696c 6c20 6e6f 7420 6672 6565 2c20  still not free, 
-00017990: 736f 2077 6520 6368 6563 6b20 7768 6574  so we check whet
-000179a0: 6865 7220 7765 206e 6565 6420 6974 2061  her we need it a
-000179b0: 6e64 2077 6865 7468 6572 2074 6865 2073  nd whether the s
-000179c0: 6368 6575 646c 6572 0a20 2020 2020 2020  cheudler.       
-000179d0: 2069 7320 6275 7379 2e0a 2020 2020 2020   is busy..      
-000179e0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-000179f0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-00017a00: 2020 2073 656c 662e 5f6c 6173 745f 7472     self._last_tr
-00017a10: 616e 7369 7469 6f6e 5f63 6f75 6e74 2021  ansition_count !
-00017a20: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00017a30: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-00017a40: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-00017a50: 616e 6420 7365 6c66 2e73 6368 6564 756c  and self.schedul
-00017a60: 6572 2e70 726f 632e 6370 755f 7065 7263  er.proc.cpu_perc
-00017a70: 656e 7428 2920 3c20 3530 0a20 2020 2020  ent() < 50.     
-00017a80: 2020 2029 0a0a 2020 2020 6465 6620 5f67     )..    def _g
-00017a90: 6574 5f74 696d 6573 6572 6965 7328 7365  et_timeseries(se
-00017aa0: 6c66 2c20 7265 7374 7269 6374 5f74 6f5f  lf, restrict_to_
-00017ab0: 6578 6973 7469 6e67 3d46 616c 7365 293a  existing=False):
-00017ac0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00017ad0: 2020 2020 2055 7064 6174 6520 7468 6520       Update the 
-00017ae0: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-00017af0: 2077 6974 6820 6f75 7220 7469 6d65 2073   with our time s
-00017b00: 6572 6965 7320 6461 7461 2e0a 0a20 2020  eries data...   
-00017b10: 2020 2020 2072 6573 7472 6963 745f 746f       restrict_to
-00017b20: 5f65 7869 7374 696e 6720 6465 7465 726d  _existing determ
-00017b30: 696e 6573 2077 6865 7468 6572 2074 6f20  ines whether to 
-00017b40: 6164 6420 6e65 7720 7461 736b 2067 726f  add new task gro
-00017b50: 7570 730a 2020 2020 2020 2020 7768 6963  ups.        whic
-00017b60: 6820 6d69 6768 7420 6861 7665 2062 6565  h might have bee
-00017b70: 6e20 6164 6465 6420 7369 6e63 6520 7468  n added since th
-00017b80: 6520 6c61 7374 2074 696d 6520 7765 2072  e last time we r
-00017b90: 656e 6465 7265 642e 0a20 2020 2020 2020  endered..       
-00017ba0: 2054 6869 7320 6973 2069 6d70 6f72 7461   This is importa
-00017bb0: 6e74 2061 7320 7765 2077 616e 7420 746f  nt as we want to
-00017bc0: 2061 6464 206e 6577 2073 7461 636b 6572   add new stacker
-00017bd0: 7320 7665 7279 2064 656c 6962 6572 6174  s very deliberat
-00017be0: 656c 792e 0a20 2020 2020 2020 2022 2222  ely..        """
-00017bf0: 0a20 2020 2020 2020 2023 2047 6574 2074  .        # Get t
-00017c00: 6865 2066 726f 6e74 2f62 6163 6b20 696e  he front/back in
-00017c10: 6469 6365 7320 666f 7220 6d6f 7374 2072  dices for most r
-00017c20: 6563 656e 7420 6e70 7473 2062 696e 7320  ecent npts bins 
-00017c30: 6f75 7420 6f66 2074 6865 2074 696d 6573  out of the times
-00017c40: 6572 6965 730a 2020 2020 2020 2020 6672  eries.        fr
-00017c50: 6f6e 7420 3d20 6d61 7828 6c65 6e28 7365  ont = max(len(se
-00017c60: 6c66 2e70 6c75 6769 6e2e 7469 6d65 2920  lf.plugin.time) 
-00017c70: 2d20 7365 6c66 2e6e 7074 732c 2030 290a  - self.npts, 0).
-00017c80: 2020 2020 2020 2020 6261 636b 203d 204e          back = N
-00017c90: 6f6e 650a 2020 2020 2020 2020 2320 5265  one.        # Re
-00017ca0: 6d6f 7665 2061 6e79 2070 6572 696f 6473  move any periods
-00017cb0: 206f 6620 7a65 726f 2063 6f6d 7075 7465   of zero compute
-00017cc0: 2061 7420 7468 6520 6672 6f6e 7420 6f72   at the front or
-00017cd0: 2062 6163 6b20 6f66 2074 6865 2074 696d   back of the tim
-00017ce0: 6573 6572 6965 730a 2020 2020 2020 2020  eseries.        
-00017cf0: 6966 206c 656e 2873 656c 662e 706c 7567  if len(self.plug
-00017d00: 696e 2e63 6f6d 7075 7465 293a 0a20 2020  in.compute):.   
-00017d10: 2020 2020 2020 2020 2061 6767 203d 2073           agg = s
-00017d20: 756d 286e 702e 6172 7261 7928 765b 6672  um(np.array(v[fr
-00017d30: 6f6e 743a 5d29 2066 6f72 2076 2069 6e20  ont:]) for v in 
-00017d40: 7365 6c66 2e70 6c75 6769 6e2e 636f 6d70  self.plugin.comp
-00017d50: 7574 652e 7661 6c75 6573 2829 290a 2020  ute.values()).  
-00017d60: 2020 2020 2020 2020 2020 6672 6f6e 7432            front2
-00017d70: 203d 206c 656e 2861 6767 2920 2d20 6c65   = len(agg) - le
-00017d80: 6e28 6e70 2e74 7269 6d5f 7a65 726f 7328  n(np.trim_zeros(
-00017d90: 6167 672c 2074 7269 6d3d 2266 2229 290a  agg, trim="f")).
-00017da0: 2020 2020 2020 2020 2020 2020 6672 6f6e              fron
-00017db0: 7420 2b3d 2066 726f 6e74 320a 2020 2020  t += front2.    
-00017dc0: 2020 2020 2020 2020 6261 636b 203d 206c          back = l
-00017dd0: 656e 286e 702e 7472 696d 5f7a 6572 6f73  en(np.trim_zeros
-00017de0: 2861 6767 2c20 7472 696d 3d22 6222 2929  (agg, trim="b"))
-00017df0: 202d 206c 656e 2861 6767 2920 6f72 204e   - len(agg) or N
-00017e00: 6f6e 650a 0a20 2020 2020 2020 2070 7265  one..        pre
-00017e10: 7065 6e64 203d 2028 0a20 2020 2020 2020  pend = (.       
-00017e20: 2020 2020 2073 656c 662e 706c 7567 696e       self.plugin
-00017e30: 2e74 696d 655b 6672 6f6e 7420 2d20 315d  .time[front - 1]
-00017e40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00017e50: 6672 6f6e 7420 3e3d 2031 0a20 2020 2020  front >= 1.     
-00017e60: 2020 2020 2020 2065 6c73 6520 7365 6c66         else self
-00017e70: 2e70 6c75 6769 6e2e 7469 6d65 5b66 726f  .plugin.time[fro
-00017e80: 6e74 5d20 2d20 7365 6c66 2e70 6c75 6769  nt] - self.plugi
-00017e90: 6e2e 6474 0a20 2020 2020 2020 2029 0a20  n.dt.        ). 
-00017ea0: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
-00017eb0: 7320 3d20 6e70 2e61 7272 6179 2873 656c  s = np.array(sel
-00017ec0: 662e 706c 7567 696e 2e74 696d 655b 6672  f.plugin.time[fr
-00017ed0: 6f6e 743a 6261 636b 5d29 0a20 2020 2020  ont:back]).     
-00017ee0: 2020 2064 7420 3d20 6e70 2e64 6966 6628     dt = np.diff(
-00017ef0: 7469 6d65 7374 616d 7073 2c20 7072 6570  timestamps, prep
-00017f00: 656e 643d 7072 6570 656e 6429 0a0a 2020  end=prepend)..  
-00017f10: 2020 2020 2020 6966 2072 6573 7472 6963        if restric
-00017f20: 745f 746f 5f65 7869 7374 696e 673a 0a20  t_to_existing:. 
-00017f30: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
-00017f40: 6174 6120 3d20 7b0a 2020 2020 2020 2020  ata = {.        
-00017f50: 2020 2020 2020 2020 6b3a 206e 702e 6172          k: np.ar
-00017f60: 7261 7928 765b 6672 6f6e 743a 6261 636b  ray(v[front:back
-00017f70: 5d29 202f 2064 740a 2020 2020 2020 2020  ]) / dt.        
-00017f80: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
-00017f90: 2069 6e20 7365 6c66 2e70 6c75 6769 6e2e   in self.plugin.
-00017fa0: 636f 6d70 7574 652e 6974 656d 7328 290a  compute.items().
+000162c0: 735f 6461 7461 5b22 785f 7374 6172 7422  s_data["x_start"
+000162d0: 5d2e 6170 7065 6e64 2878 202d 2077 6964  ].append(x - wid
+000162e0: 7468 202f 2032 290a 2020 2020 2020 2020  th / 2).        
+000162f0: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
+00016300: 785f 656e 6422 5d2e 6170 7065 6e64 2878  x_end"].append(x
+00016310: 202b 2077 6964 7468 202f 2032 290a 0a20   + width / 2).. 
+00016320: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016330: 5f64 6174 615b 2279 5f73 7461 7274 225d  _data["y_start"]
+00016340: 2e61 7070 656e 6428 7920 2d20 6865 6967  .append(y - heig
+00016350: 6874 202f 2032 290a 2020 2020 2020 2020  ht / 2).        
+00016360: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
+00016370: 795f 656e 6422 5d2e 6170 7065 6e64 2879  y_end"].append(y
+00016380: 202d 2068 6569 6768 7420 2f20 3220 2b20   - height / 2 + 
+00016390: 6865 6967 6874 202a 2030 2e34 290a 0a20  height * 0.4).. 
+000163a0: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+000163b0: 5f64 6174 615b 2278 5f65 6e64 5f70 726f  _data["x_end_pro
+000163c0: 6772 6573 7322 5d2e 6170 7065 6e64 280a  gress"].append(.
+000163d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163e0: 7820 2d20 7769 6474 6820 2f20 3220 2b20  x - width / 2 + 
+000163f0: 7769 6474 6820 2a20 636f 6d70 5f74 6173  width * comp_tas
+00016400: 6b73 202f 2074 6f74 5f74 6173 6b73 0a20  ks / tot_tasks. 
+00016410: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00016420: 2020 2020 2020 2020 2020 2320 6172 726f            # arro
+00016430: 7773 0a20 2020 2020 2020 2020 2020 2061  ws.            a
+00016440: 7272 6f77 735f 6461 7461 5b22 7873 225d  rrows_data["xs"]
+00016450: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
+00016460: 2020 2020 2020 7365 6c66 2e6e 6f64 6573        self.nodes
+00016470: 5f6c 6179 6f75 745b 6b5d 5b22 7822 5d20  _layout[k]["x"] 
+00016480: 2b20 626f 785f 6469 6d5b 6b5d 5b22 7769  + box_dim[k]["wi
+00016490: 6474 6822 5d20 2f20 320a 2020 2020 2020  dth"] / 2.      
+000164a0: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
+000164b0: 696e 2073 656c 662e 6172 726f 7773 5f6c  in self.arrows_l
+000164c0: 6179 6f75 745b 6b65 795d 5b22 6e73 7461  ayout[key]["nsta
+000164d0: 7274 225d 0a20 2020 2020 2020 2020 2020  rt"].           
+000164e0: 205d 0a20 2020 2020 2020 2020 2020 2061   ].            a
+000164f0: 7272 6f77 735f 6461 7461 5b22 7973 225d  rrows_data["ys"]
+00016500: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
+00016510: 2020 2020 2020 7365 6c66 2e6e 6f64 6573        self.nodes
+00016520: 5f6c 6179 6f75 745b 6b5d 5b22 7922 5d20  _layout[k]["y"] 
+00016530: 666f 7220 6b20 696e 2073 656c 662e 6172  for k in self.ar
+00016540: 726f 7773 5f6c 6179 6f75 745b 6b65 795d  rows_layout[key]
+00016550: 5b22 6e73 7461 7274 225d 0a20 2020 2020  ["nstart"].     
+00016560: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00016570: 2020 2020 2061 7272 6f77 735f 6461 7461       arrows_data
+00016580: 5b22 7865 225d 202b 3d20 5b0a 2020 2020  ["xe"] += [.    
+00016590: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000165a0: 2e6e 6f64 6573 5f6c 6179 6f75 745b 6b5d  .nodes_layout[k]
+000165b0: 5b22 7822 5d20 2d20 626f 785f 6469 6d5b  ["x"] - box_dim[
+000165c0: 6b5d 5b22 7769 6474 6822 5d20 2f20 320a  k]["width"] / 2.
+000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165e0: 666f 7220 6b20 696e 2073 656c 662e 6172  for k in self.ar
+000165f0: 726f 7773 5f6c 6179 6f75 745b 6b65 795d  rows_layout[key]
+00016600: 5b22 6e65 6e64 225d 0a20 2020 2020 2020  ["nend"].       
+00016610: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+00016620: 2020 2061 7272 6f77 735f 6461 7461 5b22     arrows_data["
+00016630: 7965 225d 202b 3d20 5b0a 2020 2020 2020  ye"] += [.      
+00016640: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
+00016650: 6f64 6573 5f6c 6179 6f75 745b 6b5d 5b22  odes_layout[k]["
+00016660: 7922 5d20 666f 7220 6b20 696e 2073 656c  y"] for k in sel
+00016670: 662e 6172 726f 7773 5f6c 6179 6f75 745b  f.arrows_layout[
+00016680: 6b65 795d 5b22 6e65 6e64 225d 0a20 2020  key]["nend"].   
+00016690: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+000166a0: 2020 2020 2020 2020 2320 4c4f 474f 530a          # LOGOS.
+000166b0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+000166c0: 656e 2874 672e 7479 7065 7329 203d 3d20  en(tg.types) == 
+000166d0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+000166e0: 2020 206c 6f67 6f5f 7479 7065 203d 206e     logo_type = n
+000166f0: 6578 7428 6974 6572 2874 672e 7479 7065  ext(iter(tg.type
+00016700: 7329 292e 7370 6c69 7428 222e 2229 5b30  s)).split(".")[0
+00016710: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00016720: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00016730: 2020 2020 2020 2020 2020 2075 726c 5f6c             url_l
+00016740: 6f67 6f20 3d20 6c6f 676f 735f 6469 6374  ogo = logos_dict
+00016750: 5b6c 6f67 6f5f 7479 7065 5d0a 2020 2020  [logo_type].    
+00016760: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00016770: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016790: 2075 726c 5f6c 6f67 6f20 3d20 2222 0a20   url_logo = "". 
+000167a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000167b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000167c0: 2075 726c 5f6c 6f67 6f20 3d20 2222 0a0a   url_logo = ""..
+000167d0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000167e0: 735f 6461 7461 5b22 7572 6c5f 6c6f 676f  s_data["url_logo
+000167f0: 225d 2e61 7070 656e 6428 7572 6c5f 6c6f  "].append(url_lo
+00016800: 676f 290a 0a20 2020 2020 2020 2020 2020  go)..           
+00016810: 206e 6f64 6573 5f64 6174 615b 2278 5f6c   nodes_data["x_l
+00016820: 6f67 6f22 5d2e 6170 7065 6e64 2878 202b  ogo"].append(x +
+00016830: 2077 6964 7468 202f 2033 290a 2020 2020   width / 3).    
+00016840: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+00016850: 7461 5b22 795f 6c6f 676f 225d 2e61 7070  ta["y_logo"].app
+00016860: 656e 6428 7920 2b20 6865 6967 6874 202f  end(y + height /
+00016870: 2033 290a 0a20 2020 2020 2020 2020 2020   3)..           
+00016880: 2072 6174 696f 203d 2077 6964 7468 202f   ratio = width /
+00016890: 2068 6569 6768 740a 0a20 2020 2020 2020   height..       
+000168a0: 2020 2020 2069 6620 7261 7469 6f20 3e20       if ratio > 
+000168b0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+000168c0: 2020 206e 6f64 6573 5f64 6174 615b 2268     nodes_data["h
+000168d0: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2868  _logo"].append(h
+000168e0: 6569 6768 7420 2a20 302e 3329 0a20 2020  eight * 0.3).   
+000168f0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00016900: 6573 5f64 6174 615b 2277 5f6c 6f67 6f22  es_data["w_logo"
+00016910: 5d2e 6170 7065 6e64 2877 6964 7468 202a  ].append(width *
+00016920: 2030 2e33 202f 2072 6174 696f 290a 2020   0.3 / ratio).  
+00016930: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016950: 6e6f 6465 735f 6461 7461 5b22 685f 6c6f  nodes_data["h_lo
+00016960: 676f 225d 2e61 7070 656e 6428 6865 6967  go"].append(heig
+00016970: 6874 202a 2030 2e33 202a 2072 6174 696f  ht * 0.3 * ratio
+00016980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016990: 2020 6e6f 6465 735f 6461 7461 5b22 775f    nodes_data["w_
+000169a0: 6c6f 676f 225d 2e61 7070 656e 6428 7769  logo"].append(wi
+000169b0: 6474 6820 2a20 302e 3329 0a0a 2020 2020  dth * 0.3)..    
+000169c0: 2020 2020 2020 2020 2320 636f 6d70 7574          # comput
+000169d0: 655f 7469 6d65 2061 6e64 206d 656d 6f72  e_time and memor
+000169e0: 790a 2020 2020 2020 2020 2020 2020 6e6f  y.            no
+000169f0: 6465 735f 6461 7461 5b22 636f 6d70 7574  des_data["comput
+00016a00: 655f 7469 6d65 225d 2e61 7070 656e 6428  e_time"].append(
+00016a10: 666f 726d 6174 5f74 696d 6528 7467 2e64  format_time(tg.d
+00016a20: 7572 6174 696f 6e29 290a 2020 2020 2020  uration)).      
+00016a30: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016a40: 5b22 6d65 6d6f 7279 225d 2e61 7070 656e  ["memory"].appen
+00016a50: 6428 666f 726d 6174 5f62 7974 6573 2874  d(format_bytes(t
+00016a60: 672e 6e62 7974 6573 5f74 6f74 616c 2929  g.nbytes_total))
+00016a70: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00016a80: 4164 6420 736f 6d65 2073 7461 7475 7320  Add some status 
+00016a90: 746f 2068 6f76 6572 0a20 2020 2020 2020  to hover.       
+00016aa0: 2020 2020 2074 6173 6b73 5f70 726f 6365       tasks_proce
+00016ab0: 7373 696e 6720 3d20 7467 2e73 7461 7465  ssing = tg.state
+00016ac0: 735b 2270 726f 6365 7373 696e 6722 5d0a  s["processing"].
+00016ad0: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00016ae0: 735f 6d65 6d6f 7279 203d 2074 672e 7374  s_memory = tg.st
+00016af0: 6174 6573 5b22 6d65 6d6f 7279 225d 0a20  ates["memory"]. 
+00016b00: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
+00016b10: 5f72 656c 6173 6564 203d 2074 672e 7374  _relased = tg.st
+00016b20: 6174 6573 5b22 7265 6c65 6173 6564 225d  ates["released"]
+00016b30: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
+00016b40: 6b73 5f65 7272 6564 203d 2074 672e 7374  ks_erred = tg.st
+00016b50: 6174 6573 5b22 6572 7265 6422 5d0a 0a20  ates["erred"].. 
+00016b60: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016b70: 5f64 6174 615b 2263 6f6d 705f 7461 736b  _data["comp_task
+00016b80: 7322 5d2e 6170 7065 6e64 280a 2020 2020  s"].append(.    
+00016b90: 2020 2020 2020 2020 2020 2020 6622 7b63              f"{c
+00016ba0: 6f6d 705f 7461 736b 737d 2028 7b63 6f6d  omp_tasks} ({com
+00016bb0: 705f 7461 736b 7320 2f20 746f 745f 7461  p_tasks / tot_ta
+00016bc0: 736b 7320 2a20 3130 303a 2e30 667d 2025  sks * 100:.0f} %
+00016bd0: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
+00016be0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00016bf0: 6573 5f64 6174 615b 2269 6e5f 7072 6f63  es_data["in_proc
+00016c00: 6573 7369 6e67 225d 2e61 7070 656e 6428  essing"].append(
+00016c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016c20: 2066 227b 7461 736b 735f 7072 6f63 6573   f"{tasks_proces
+00016c30: 7369 6e67 7d20 287b 7461 736b 735f 7072  sing} ({tasks_pr
+00016c40: 6f63 6573 7369 6e67 2f20 746f 745f 7461  ocessing/ tot_ta
+00016c50: 736b 7320 2a20 3130 303a 2e30 667d 2025  sks * 100:.0f} %
+00016c60: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
+00016c70: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00016c80: 6573 5f64 6174 615b 2269 6e5f 6d65 6d6f  es_data["in_memo
+00016c90: 7279 225d 2e61 7070 656e 6428 0a20 2020  ry"].append(.   
+00016ca0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00016cb0: 7461 736b 735f 6d65 6d6f 7279 7d20 287b  tasks_memory} ({
+00016cc0: 7461 736b 735f 6d65 6d6f 7279 2f20 746f  tasks_memory/ to
+00016cd0: 745f 7461 736b 7320 2a20 3130 303a 2e30  t_tasks * 100:.0
+00016ce0: 667d 2025 2922 0a20 2020 2020 2020 2020  f} %)".         
+00016cf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00016d00: 206e 6f64 6573 5f64 6174 615b 2269 6e5f   nodes_data["in_
+00016d10: 7265 6c65 6173 6564 225d 2e61 7070 656e  released"].appen
+00016d20: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00016d30: 2020 2066 227b 7461 736b 735f 7265 6c61     f"{tasks_rela
+00016d40: 7365 647d 2028 7b74 6173 6b73 5f72 656c  sed} ({tasks_rel
+00016d50: 6173 6564 2f20 746f 745f 7461 736b 7320  ased/ tot_tasks 
+00016d60: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
+00016d70: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00016d80: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016d90: 6174 615b 2269 6e5f 6572 7265 6422 5d2e  ata["in_erred"].
+00016da0: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+00016db0: 2020 2020 2020 2020 6622 7b20 7461 736b          f"{ task
+00016dc0: 735f 6572 7265 647d 2028 7b74 6173 6b73  s_erred} ({tasks
+00016dd0: 5f65 7272 6564 2f20 746f 745f 7461 736b  _erred/ tot_task
+00016de0: 7320 2a20 3130 303a 2e30 667d 2025 2922  s * 100:.0f} %)"
+00016df0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00016e00: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
+00016e10: 6573 5f73 6f75 7263 652e 6461 7461 2e75  es_source.data.u
+00016e20: 7064 6174 6528 6e6f 6465 735f 6461 7461  pdate(nodes_data
+00016e30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00016e40: 7272 6f77 735f 736f 7572 6365 2e64 6174  rrows_source.dat
+00016e50: 612e 7570 6461 7465 2861 7272 6f77 735f  a.update(arrows_
+00016e60: 6461 7461 290a 0a0a 636c 6173 7320 5461  data)...class Ta
+00016e70: 736b 4772 6f75 7050 726f 6772 6573 7328  skGroupProgress(
+00016e80: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+00016e90: 6e74 293a 0a20 2020 2022 2222 5374 6163  nt):.    """Stac
+00016ea0: 6b65 6420 6172 6561 2063 6861 7274 2073  ked area chart s
+00016eb0: 686f 7769 6e67 2074 6173 6b20 6772 6f75  howing task grou
+00016ec0: 7073 2074 6872 6f75 6768 2074 696d 6522  ps through time"
+00016ed0: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+00016ee0: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+00016ef0: 756c 6572 2c20 2a2a 6b77 6172 6773 293a  uler, **kwargs):
+00016f00: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+00016f10: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
+00016f20: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
+00016f30: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
+00016f40: 4461 7461 536f 7572 6365 2829 0a20 2020  DataSource().   
+00016f50: 2020 2020 2023 2054 6865 206c 656e 6774       # The lengt
+00016f60: 6820 6f66 2074 696d 6573 6572 6965 7320  h of timeseries 
+00016f70: 746f 2063 6861 7274 2028 696e 2075 6e69  to chart (in uni
+00016f80: 7473 206f 6620 706c 7567 696e 2e64 7429  ts of plugin.dt)
+00016f90: 0a20 2020 2020 2020 2073 656c 662e 6e70  .        self.np
+00016fa0: 7473 203d 2031 3830 0a0a 2020 2020 2020  ts = 180..      
+00016fb0: 2020 6966 2047 726f 7570 5469 6d69 6e67    if GroupTiming
+00016fc0: 2e6e 616d 6520 6e6f 7420 696e 2073 6368  .name not in sch
+00016fd0: 6564 756c 6572 2e70 6c75 6769 6e73 3a0a  eduler.plugins:.
+00016fe0: 2020 2020 2020 2020 2020 2020 7363 6865              sche
+00016ff0: 6475 6c65 722e 6164 645f 706c 7567 696e  duler.add_plugin
+00017000: 2870 6c75 6769 6e3d 4772 6f75 7054 696d  (plugin=GroupTim
+00017010: 696e 6728 7363 6865 6475 6c65 7229 290a  ing(scheduler)).
+00017020: 0a20 2020 2020 2020 2073 656c 662e 706c  .        self.pl
+00017030: 7567 696e 203d 2073 6368 6564 756c 6572  ugin = scheduler
+00017040: 2e70 6c75 6769 6e73 5b47 726f 7570 5469  .plugins[GroupTi
+00017050: 6d69 6e67 2e6e 616d 655d 0a0a 2020 2020  ming.name]..    
+00017060: 2020 2020 7365 6c66 2e73 6f75 7263 652e      self.source.
+00017070: 6164 6428 6e70 2e61 7272 6179 2873 656c  add(np.array(sel
+00017080: 662e 706c 7567 696e 2e74 696d 6529 202a  f.plugin.time) *
+00017090: 2031 3030 302e 302c 2022 7469 6d65 2229   1000.0, "time")
+000170a0: 0a0a 2020 2020 2020 2020 785f 7261 6e67  ..        x_rang
+000170b0: 6520 3d20 4461 7461 5261 6e67 6531 6428  e = DataRange1d(
+000170c0: 7261 6e67 655f 7061 6464 696e 673d 3029  range_padding=0)
+000170d0: 0a20 2020 2020 2020 2079 5f72 616e 6765  .        y_range
+000170e0: 203d 2052 616e 6765 3164 2830 2c20 6d61   = Range1d(0, ma
+000170f0: 7828 7365 6c66 2e70 6c75 6769 6e2e 6e74  x(self.plugin.nt
+00017100: 6872 6561 6473 2929 0a0a 2020 2020 2020  hreads))..      
+00017110: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+00017120: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+00017130: 2020 7469 746c 653d 2254 6173 6b20 4772    title="Task Gr
+00017140: 6f75 7020 5072 6f67 7265 7373 222c 0a20  oup Progress",. 
+00017150: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00017160: 2274 6173 6b5f 6772 6f75 705f 7072 6f67  "task_group_prog
+00017170: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
+00017180: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
+00017190: 696f 6e3d 2261 626f 7665 222c 0a20 2020  ion="above",.   
+000171a0: 2020 2020 2020 2020 206d 696e 5f62 6f72           min_bor
+000171b0: 6465 725f 626f 7474 6f6d 3d35 302c 0a20  der_bottom=50,. 
+000171c0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+000171d0: 6765 3d78 5f72 616e 6765 2c0a 2020 2020  ge=x_range,.    
+000171e0: 2020 2020 2020 2020 795f 7261 6e67 653d          y_range=
+000171f0: 795f 7261 6e67 652c 0a20 2020 2020 2020  y_range,.       
+00017200: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+00017210: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
+00017220: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
+00017230: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+00017240: 5f61 7869 735f 6c6f 6361 7469 6f6e 3d4e  _axis_location=N
+00017250: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00017260: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+00017270: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00017280: 662e 726f 6f74 2e79 6178 6973 2e6d 616a  f.root.yaxis.maj
+00017290: 6f72 5f6c 6162 656c 5f74 6578 745f 616c  or_label_text_al
+000172a0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+000172b0: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
+000172c0: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
+000172d0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
+000172e0: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
+000172f0: 732e 6d61 6a6f 725f 7469 636b 5f6c 696e  s.major_tick_lin
+00017300: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
+00017310: 2020 2020 7365 6c66 2e72 6f6f 742e 7867      self.root.xg
+00017320: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+00017330: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
+00017340: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
+00017350: 280a 2020 2020 2020 2020 2020 2020 426f  (.            Bo
+00017360: 785a 6f6f 6d54 6f6f 6c28 292c 0a20 2020  xZoomTool(),.   
+00017370: 2020 2020 2020 2020 2052 6573 6574 546f           ResetTo
+00017380: 6f6c 2829 2c0a 2020 2020 2020 2020 2020  ol(),.          
+00017390: 2020 5061 6e54 6f6f 6c28 6469 6d65 6e73    PanTool(dimens
+000173a0: 696f 6e73 3d22 7769 6474 6822 292c 0a20  ions="width"),. 
+000173b0: 2020 2020 2020 2020 2020 2057 6865 656c             Wheel
+000173c0: 5a6f 6f6d 546f 6f6c 2864 696d 656e 7369  ZoomTool(dimensi
+000173d0: 6f6e 733d 2277 6964 7468 2229 2c0a 2020  ons="width"),.  
+000173e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000173f0: 7365 6c66 2e5f 686f 7665 7220 3d20 4e6f  self._hover = No
+00017400: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+00017410: 5f6c 6173 745f 6472 6177 6e20 3d20 4e6f  _last_drawn = No
+00017420: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+00017430: 5f6f 6666 7365 7420 3d20 7469 6d65 2829  _offset = time()
+00017440: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00017450: 6173 745f 7472 616e 7369 7469 6f6e 5f63  ast_transition_c
+00017460: 6f75 6e74 203d 2073 6368 6564 756c 6572  ount = scheduler
+00017470: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+00017480: 7465 720a 2020 2020 2020 2020 2320 4f72  ter.        # Or
+00017490: 6465 7265 6444 6963 7420 736f 2077 6520  deredDict so we 
+000174a0: 6361 6e20 6d61 6b65 2061 2072 6576 6572  can make a rever
+000174b0: 7365 2069 7465 7261 746f 7220 6c61 7465  se iterator late
+000174c0: 7220 616e 6420 6765 7420 7468 650a 2020  r and get the.  
+000174d0: 2020 2020 2020 2320 6d6f 7374 2d72 6563        # most-rec
+000174e0: 656e 746c 792d 6164 6465 6420 676c 7970  ently-added glyp
+000174f0: 6873 2e0a 2020 2020 2020 2020 7365 6c66  hs..        self
+00017500: 2e5f 7265 6e64 6572 6572 7320 3d20 4f72  ._renderers = Or
+00017510: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
+00017520: 2020 2020 7365 6c66 2e5f 6c69 6e65 5f72      self._line_r
+00017530: 656e 6465 7265 7273 203d 204f 7264 6572  enderers = Order
+00017540: 6564 4469 6374 2829 0a0a 2020 2020 6465  edDict()..    de
+00017550: 6620 5f73 686f 756c 645f 6164 645f 6e65  f _should_add_ne
+00017560: 775f 7265 6e64 6572 6572 7328 7365 6c66  w_renderers(self
+00017570: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+00017580: 2020 2022 2222 0a20 2020 2020 2020 2057     """.        W
+00017590: 6865 7468 6572 2074 6f20 6164 6420 6e65  hether to add ne
+000175a0: 7720 7265 6e64 6572 6572 7320 746f 2074  w renderers to t
+000175b0: 6865 2063 6861 7274 2e0a 0a20 2020 2020  he chart...     
+000175c0: 2020 2057 6865 6e20 6120 6e65 7720 7365     When a new se
+000175d0: 7420 6f66 2074 6173 6b20 6772 6f75 7073  t of task groups
+000175e0: 2065 6e74 6572 7320 7468 6520 7363 6865   enters the sche
+000175f0: 6475 6c65 7220 7765 2764 206c 696b 6520  duler we'd like 
+00017600: 746f 2073 7461 7274 2072 656e 6465 7269  to start renderi
+00017610: 6e67 0a20 2020 2020 2020 2074 6865 6d2e  ng.        them.
+00017620: 2042 7574 2069 7420 6361 6e20 6265 2065   But it can be e
+00017630: 7870 656e 7369 7665 2074 6f20 6164 6420  xpensive to add 
+00017640: 6e65 7720 676c 7970 732c 2073 6f20 7765  new glyps, so we
+00017650: 2064 6f20 6974 2064 656c 6962 6572 6174   do it deliberat
+00017660: 656c 792c 0a20 2020 2020 2020 2063 6865  ely,.        che
+00017670: 636b 696e 6720 7768 6574 6865 7220 7765  cking whether we
+00017680: 2068 6176 6520 746f 2064 6f20 6974 2061   have to do it a
+00017690: 6e64 2077 6865 7468 6572 2074 6865 2073  nd whether the s
+000176a0: 6368 6564 756c 6572 2073 6565 6d73 2062  cheduler seems b
+000176b0: 7573 792e 0a20 2020 2020 2020 2022 2222  usy..        """
+000176c0: 0a20 2020 2020 2020 2023 2041 6c77 6179  .        # Alway
+000176d0: 7320 6472 6177 2069 6620 7765 2068 6176  s draw if we hav
+000176e0: 6520 6e6f 7420 6265 666f 7265 0a20 2020  e not before.   
+000176f0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00017700: 2e5f 6c61 7374 5f64 7261 776e 3a0a 2020  ._last_drawn:.  
+00017710: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00017720: 2054 7275 650a 2020 2020 2020 2020 2320   True.        # 
+00017730: 446f 6e27 7420 6472 6177 2069 6620 7468  Don't draw if th
+00017740: 6572 6520 6861 7665 2062 6565 6e20 6e6f  ere have been no
+00017750: 206e 6577 2074 6173 6b73 2063 6f6d 706c   new tasks compl
+00017760: 6574 6564 2073 696e 6365 2074 6865 206c  eted since the l
+00017770: 6173 7420 7570 6461 7465 2c0a 2020 2020  ast update,.    
+00017780: 2020 2020 2320 6f72 2069 6620 7468 6520      # or if the 
+00017790: 7363 6865 6475 6c65 7220 4350 5520 6973  scheduler CPU is
+000177a0: 206f 6363 7570 6965 642e 0a20 2020 2020   occupied..     
+000177b0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+000177c0: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
+000177d0: 7261 6e73 6974 696f 6e5f 636f 756e 7420  ransition_count 
+000177e0: 3d3d 2073 656c 662e 7363 6865 6475 6c65  == self.schedule
+000177f0: 722e 7472 616e 7369 7469 6f6e 5f63 6f75  r.transition_cou
+00017800: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
+00017810: 206f 7220 7365 6c66 2e73 6368 6564 756c   or self.schedul
+00017820: 6572 2e70 726f 632e 6370 755f 7065 7263  er.proc.cpu_perc
+00017830: 656e 7428 2920 3e20 3530 0a20 2020 2020  ent() > 50.     
+00017840: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00017850: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+00017860: 2020 2020 2020 2020 2320 4f6e 6c79 2072          # Only r
+00017870: 6574 7572 6e20 7472 7565 2069 6620 7468  eturn true if th
+00017880: 6572 6520 6172 6520 6e65 7720 7461 736b  ere are new task
+00017890: 2067 726f 7570 7320 7468 6174 2077 6520   groups that we 
+000178a0: 6861 7665 206e 6f74 2079 6574 2061 6464  have not yet add
+000178b0: 6564 0a20 2020 2020 2020 2023 2074 6f20  ed.        # to 
+000178c0: 7468 6520 436f 6c75 6d6e 4461 7461 536f  the ColumnDataSo
+000178d0: 7572 6365 2e0a 2020 2020 2020 2020 7265  urce..        re
+000178e0: 7475 726e 206e 6f74 2073 6574 2873 656c  turn not set(sel
+000178f0: 662e 706c 7567 696e 2e63 6f6d 7075 7465  f.plugin.compute
+00017900: 2e6b 6579 7328 2929 203c 3d20 7365 7428  .keys()) <= set(
+00017910: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
+00017920: 2e6b 6579 7328 2929 0a0a 2020 2020 6465  .keys())..    de
+00017930: 6620 5f73 686f 756c 645f 7570 6461 7465  f _should_update
+00017940: 2873 656c 6629 202d 3e20 626f 6f6c 3a0a  (self) -> bool:.
+00017950: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00017960: 2020 2020 5768 6574 6865 7220 746f 2075      Whether to u
+00017970: 7064 6174 6520 7468 6520 436f 6c75 6d6e  pdate the Column
+00017980: 4461 7461 536f 7572 6365 2e20 5468 6973  DataSource. This
+00017990: 2069 7320 6368 6561 7065 7220 7468 616e   is cheaper than
+000179a0: 2072 6564 7261 7769 6e67 2c0a 2020 2020   redrawing,.    
+000179b0: 2020 2020 6275 7420 7374 696c 6c20 6e6f      but still no
+000179c0: 7420 6672 6565 2c20 736f 2077 6520 6368  t free, so we ch
+000179d0: 6563 6b20 7768 6574 6865 7220 7765 206e  eck whether we n
+000179e0: 6565 6420 6974 2061 6e64 2077 6865 7468  eed it and wheth
+000179f0: 6572 2074 6865 2073 6368 6575 646c 6572  er the scheudler
+00017a00: 0a20 2020 2020 2020 2069 7320 6275 7379  .        is busy
+00017a10: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00017a20: 2020 2020 2020 7265 7475 726e 2028 0a20        return (. 
+00017a30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017a40: 5f6c 6173 745f 7472 616e 7369 7469 6f6e  _last_transition
+00017a50: 5f63 6f75 6e74 2021 3d20 7365 6c66 2e73  _count != self.s
+00017a60: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+00017a70: 696f 6e5f 636f 756e 7465 720a 2020 2020  ion_counter.    
+00017a80: 2020 2020 2020 2020 616e 6420 7365 6c66          and self
+00017a90: 2e73 6368 6564 756c 6572 2e70 726f 632e  .scheduler.proc.
+00017aa0: 6370 755f 7065 7263 656e 7428 2920 3c20  cpu_percent() < 
+00017ab0: 3530 0a20 2020 2020 2020 2029 0a0a 2020  50.        )..  
+00017ac0: 2020 6465 6620 5f67 6574 5f74 696d 6573    def _get_times
+00017ad0: 6572 6965 7328 7365 6c66 2c20 7265 7374  eries(self, rest
+00017ae0: 7269 6374 5f74 6f5f 6578 6973 7469 6e67  rict_to_existing
+00017af0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+00017b00: 2022 2222 0a20 2020 2020 2020 2055 7064   """.        Upd
+00017b10: 6174 6520 7468 6520 436f 6c75 6d6e 4461  ate the ColumnDa
+00017b20: 7461 536f 7572 6365 2077 6974 6820 6f75  taSource with ou
+00017b30: 7220 7469 6d65 2073 6572 6965 7320 6461  r time series da
+00017b40: 7461 2e0a 0a20 2020 2020 2020 2072 6573  ta...        res
+00017b50: 7472 6963 745f 746f 5f65 7869 7374 696e  trict_to_existin
+00017b60: 6720 6465 7465 726d 696e 6573 2077 6865  g determines whe
+00017b70: 7468 6572 2074 6f20 6164 6420 6e65 7720  ther to add new 
+00017b80: 7461 736b 2067 726f 7570 730a 2020 2020  task groups.    
+00017b90: 2020 2020 7768 6963 6820 6d69 6768 7420      which might 
+00017ba0: 6861 7665 2062 6565 6e20 6164 6465 6420  have been added 
+00017bb0: 7369 6e63 6520 7468 6520 6c61 7374 2074  since the last t
+00017bc0: 696d 6520 7765 2072 656e 6465 7265 642e  ime we rendered.
+00017bd0: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
+00017be0: 2069 6d70 6f72 7461 6e74 2061 7320 7765   important as we
+00017bf0: 2077 616e 7420 746f 2061 6464 206e 6577   want to add new
+00017c00: 2073 7461 636b 6572 7320 7665 7279 2064   stackers very d
+00017c10: 656c 6962 6572 6174 656c 792e 0a20 2020  eliberately..   
+00017c20: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00017c30: 2023 2047 6574 2074 6865 2066 726f 6e74   # Get the front
+00017c40: 2f62 6163 6b20 696e 6469 6365 7320 666f  /back indices fo
+00017c50: 7220 6d6f 7374 2072 6563 656e 7420 6e70  r most recent np
+00017c60: 7473 2062 696e 7320 6f75 7420 6f66 2074  ts bins out of t
+00017c70: 6865 2074 696d 6573 6572 6965 730a 2020  he timeseries.  
+00017c80: 2020 2020 2020 6672 6f6e 7420 3d20 6d61        front = ma
+00017c90: 7828 6c65 6e28 7365 6c66 2e70 6c75 6769  x(len(self.plugi
+00017ca0: 6e2e 7469 6d65 2920 2d20 7365 6c66 2e6e  n.time) - self.n
+00017cb0: 7074 732c 2030 290a 2020 2020 2020 2020  pts, 0).        
+00017cc0: 6261 636b 203d 204e 6f6e 650a 2020 2020  back = None.    
+00017cd0: 2020 2020 2320 5265 6d6f 7665 2061 6e79      # Remove any
+00017ce0: 2070 6572 696f 6473 206f 6620 7a65 726f   periods of zero
+00017cf0: 2063 6f6d 7075 7465 2061 7420 7468 6520   compute at the 
+00017d00: 6672 6f6e 7420 6f72 2062 6163 6b20 6f66  front or back of
+00017d10: 2074 6865 2074 696d 6573 6572 6965 730a   the timeseries.
+00017d20: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+00017d30: 656c 662e 706c 7567 696e 2e63 6f6d 7075  elf.plugin.compu
+00017d40: 7465 293a 0a20 2020 2020 2020 2020 2020  te):.           
+00017d50: 2061 6767 203d 2073 756d 286e 702e 6172   agg = sum(np.ar
+00017d60: 7261 7928 765b 6672 6f6e 743a 5d29 2066  ray(v[front:]) f
+00017d70: 6f72 2076 2069 6e20 7365 6c66 2e70 6c75  or v in self.plu
+00017d80: 6769 6e2e 636f 6d70 7574 652e 7661 6c75  gin.compute.valu
+00017d90: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+00017da0: 2020 6672 6f6e 7432 203d 206c 656e 2861    front2 = len(a
+00017db0: 6767 2920 2d20 6c65 6e28 6e70 2e74 7269  gg) - len(np.tri
+00017dc0: 6d5f 7a65 726f 7328 6167 672c 2074 7269  m_zeros(agg, tri
+00017dd0: 6d3d 2266 2229 290a 2020 2020 2020 2020  m="f")).        
+00017de0: 2020 2020 6672 6f6e 7420 2b3d 2066 726f      front += fro
+00017df0: 6e74 320a 2020 2020 2020 2020 2020 2020  nt2.            
+00017e00: 6261 636b 203d 206c 656e 286e 702e 7472  back = len(np.tr
+00017e10: 696d 5f7a 6572 6f73 2861 6767 2c20 7472  im_zeros(agg, tr
+00017e20: 696d 3d22 6222 2929 202d 206c 656e 2861  im="b")) - len(a
+00017e30: 6767 2920 6f72 204e 6f6e 650a 0a20 2020  gg) or None..   
+00017e40: 2020 2020 2070 7265 7065 6e64 203d 2028       prepend = (
+00017e50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00017e60: 662e 706c 7567 696e 2e74 696d 655b 6672  f.plugin.time[fr
+00017e70: 6f6e 7420 2d20 315d 0a20 2020 2020 2020  ont - 1].       
+00017e80: 2020 2020 2069 6620 6672 6f6e 7420 3e3d       if front >=
+00017e90: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
+00017ea0: 6c73 6520 7365 6c66 2e70 6c75 6769 6e2e  lse self.plugin.
+00017eb0: 7469 6d65 5b66 726f 6e74 5d20 2d20 7365  time[front] - se
+00017ec0: 6c66 2e70 6c75 6769 6e2e 6474 0a20 2020  lf.plugin.dt.   
+00017ed0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+00017ee0: 696d 6573 7461 6d70 7320 3d20 6e70 2e61  imestamps = np.a
+00017ef0: 7272 6179 2873 656c 662e 706c 7567 696e  rray(self.plugin
+00017f00: 2e74 696d 655b 6672 6f6e 743a 6261 636b  .time[front:back
+00017f10: 5d29 0a20 2020 2020 2020 2064 7420 3d20  ]).        dt = 
+00017f20: 6e70 2e64 6966 6628 7469 6d65 7374 616d  np.diff(timestam
+00017f30: 7073 2c20 7072 6570 656e 643d 7072 6570  ps, prepend=prep
+00017f40: 656e 6429 0a0a 2020 2020 2020 2020 6966  end)..        if
+00017f50: 2072 6573 7472 6963 745f 746f 5f65 7869   restrict_to_exi
+00017f60: 7374 696e 673a 0a20 2020 2020 2020 2020  sting:.         
+00017f70: 2020 206e 6577 5f64 6174 6120 3d20 7b0a     new_data = {.
+00017f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f90: 6b3a 206e 702e 6172 7261 7928 765b 6672  k: np.array(v[fr
+00017fa0: 6f6e 743a 6261 636b 5d29 202f 2064 740a  ont:back]) / dt.
 00017fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fc0: 6966 206b 2069 6e20 7365 6c66 2e73 6f75  if k in self.sou
-00017fd0: 7263 652e 6461 7461 0a20 2020 2020 2020  rce.data.       
-00017fe0: 2020 2020 207d 0a20 2020 2020 2020 2065       }.        e
-00017ff0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018000: 206e 6577 5f64 6174 6120 3d20 7661 6c6d   new_data = valm
-00018010: 6170 280a 2020 2020 2020 2020 2020 2020  ap(.            
-00018020: 2020 2020 6c61 6d62 6461 2078 3a20 6e70      lambda x: np
-00018030: 2e61 7272 6179 2878 5b66 726f 6e74 3a62  .array(x[front:b
-00018040: 6163 6b5d 2920 2f20 6474 2c0a 2020 2020  ack]) / dt,.    
-00018050: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018060: 2e70 6c75 6769 6e2e 636f 6d70 7574 652c  .plugin.compute,
-00018070: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00018080: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
-00018090: 5b22 7469 6d65 225d 203d 2028 0a20 2020  ["time"] = (.   
-000180a0: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
-000180b0: 6d70 7320 2d20 7365 6c66 2e5f 6f66 6673  mps - self._offs
-000180c0: 6574 0a20 2020 2020 2020 2029 202a 2031  et.        ) * 1
-000180d0: 3030 302e 3020 2023 2062 6f6b 6568 206c  000.0  # bokeh l
-000180e0: 696b 6573 206d 696c 6c69 7365 636f 6e64  ikes millisecond
-000180f0: 730a 2020 2020 2020 2020 6e65 775f 6461  s.        new_da
-00018100: 7461 5b22 6e74 6872 6561 6473 225d 203d  ta["nthreads"] =
-00018110: 206e 702e 6172 7261 7928 7365 6c66 2e70   np.array(self.p
-00018120: 6c75 6769 6e2e 6e74 6872 6561 6473 5b66  lugin.nthreads[f
-00018130: 726f 6e74 3a62 6163 6b5d 290a 0a20 2020  ront:back])..   
-00018140: 2020 2020 2072 6574 7572 6e20 6e65 775f       return new_
-00018150: 6461 7461 0a0a 2020 2020 4077 6974 686f  data..    @witho
-00018160: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00018170: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-00018180: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-00018190: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-000181a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000181b0: 204d 6179 6265 2075 7064 6174 6520 7468   Maybe update th
-000181c0: 6520 6368 6172 742e 2054 6869 7320 6973  e chart. This is
-000181d0: 2073 6f6d 6577 6861 7420 6578 7065 6e73   somewhat expens
-000181e0: 6976 6520 746f 2064 7261 772c 2073 6f20  ive to draw, so 
-000181f0: 7765 2075 7064 6174 650a 2020 2020 2020  we update.      
-00018200: 2020 6974 2070 7265 7474 7920 6465 6665    it pretty defe
-00018210: 6e73 6976 656c 792e 0a20 2020 2020 2020  nsively..       
-00018220: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00018230: 7365 6c66 2e5f 7368 6f75 6c64 5f61 6464  self._should_add
-00018240: 5f6e 6577 5f72 656e 6465 7265 7273 2829  _new_renderers()
-00018250: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00018260: 5570 6461 7465 2074 6865 2063 6861 7274  Update the chart
-00018270: 2c20 616c 6c6f 7769 6e67 2066 6f72 206e  , allowing for n
-00018280: 6577 2074 6173 6b20 6772 6f75 7073 2074  ew task groups t
-00018290: 6f20 6265 2061 6464 6564 2e0a 2020 2020  o be added..    
-000182a0: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
-000182b0: 203d 2073 656c 662e 5f67 6574 5f74 696d   = self._get_tim
-000182c0: 6573 6572 6965 7328 7265 7374 7269 6374  eseries(restrict
-000182d0: 5f74 6f5f 6578 6973 7469 6e67 3d46 616c  _to_existing=Fal
-000182e0: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-000182f0: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
-00018300: 203d 206e 6577 5f64 6174 610a 0a20 2020   = new_data..   
-00018310: 2020 2020 2020 2020 2023 2050 6f73 7369           # Possi
-00018320: 626c 7920 7570 6461 7465 2074 6865 2079  bly update the y
-00018330: 2072 616e 6765 2069 6620 7468 6520 6e75   range if the nu
-00018340: 6d62 6572 206f 6620 7468 7265 6164 7320  mber of threads 
-00018350: 6861 7320 696e 6372 6561 7365 642e 0a20  has increased.. 
-00018360: 2020 2020 2020 2020 2020 206d 6178 5f6e             max_n
-00018370: 7468 7265 6164 7320 3d20 6d61 7828 7365  threads = max(se
-00018380: 6c66 2e70 6c75 6769 6e2e 6e74 6872 6561  lf.plugin.nthrea
-00018390: 6473 290a 2020 2020 2020 2020 2020 2020  ds).            
-000183a0: 6966 2073 656c 662e 726f 6f74 2e79 5f72  if self.root.y_r
-000183b0: 616e 6765 2e65 6e64 2021 3d20 6d61 785f  ange.end != max_
-000183c0: 6e74 6872 6561 6473 3a0a 2020 2020 2020  nthreads:.      
-000183d0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000183e0: 6f6f 742e 795f 7261 6e67 652e 656e 6420  oot.y_range.end 
-000183f0: 3d20 6d61 785f 6e74 6872 6561 6473 0a0a  = max_nthreads..
-00018400: 2020 2020 2020 2020 2020 2020 7374 6163              stac
-00018410: 6b65 7273 203d 206c 6973 7428 7365 6c66  kers = list(self
-00018420: 2e70 6c75 6769 6e2e 636f 6d70 7574 652e  .plugin.compute.
-00018430: 6b65 7973 2829 290a 2020 2020 2020 2020  keys()).        
-00018440: 2020 2020 636f 6c6f 7273 203d 205b 636f      colors = [co
-00018450: 6c6f 725f 6f66 286b 6579 5f73 706c 6974  lor_of(key_split
-00018460: 286b 2929 2066 6f72 206b 2069 6e20 7374  (k)) for k in st
-00018470: 6163 6b65 7273 5d0a 0a20 2020 2020 2020  ackers]..       
-00018480: 2020 2020 2066 6f72 2069 2c20 2867 726f       for i, (gro
-00018490: 7570 2c20 636f 6c6f 7229 2069 6e20 656e  up, color) in en
-000184a0: 756d 6572 6174 6528 7a69 7028 7374 6163  umerate(zip(stac
-000184b0: 6b65 7273 2c20 636f 6c6f 7273 2929 3a0a  kers, colors)):.
-000184c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184d0: 2320 4966 2077 6520 6861 7665 2061 6c72  # If we have alr
-000184e0: 6561 6479 2064 7261 776e 2074 6865 2067  eady drawn the g
-000184f0: 726f 7570 2c20 6275 7420 6974 2069 7320  roup, but it is 
-00018500: 616c 6c20 7a65 726f 2c0a 2020 2020 2020  all zero,.      
-00018510: 2020 2020 2020 2020 2020 2320 7365 7420            # set 
-00018520: 6974 2074 6f20 6265 2069 6e76 6973 6962  it to be invisib
-00018530: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
-00018540: 2020 2020 6966 2067 726f 7570 2069 6e20      if group in 
-00018550: 7365 6c66 2e5f 7265 6e64 6572 6572 733a  self._renderers:
-00018560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018570: 2020 2020 2069 6620 6e6f 7420 6e70 2e63       if not np.c
-00018580: 6f75 6e74 5f6e 6f6e 7a65 726f 286e 6577  ount_nonzero(new
-00018590: 5f64 6174 615b 6772 6f75 705d 2920 3e20  _data[group]) > 
-000185a0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-000185b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000185c0: 5f72 656e 6465 7265 7273 5b67 726f 7570  _renderers[group
-000185d0: 5d2e 7669 7369 626c 6520 3d20 4661 6c73  ].visible = Fals
-000185e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000185f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00018600: 6c69 6e65 5f72 656e 6465 7265 7273 5b67  line_renderers[g
-00018610: 726f 7570 5d2e 7669 7369 626c 6520 3d20  roup].visible = 
-00018620: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-00018630: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00018640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018650: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
-00018660: 6e64 6572 6572 735b 6772 6f75 705d 2e76  nderers[group].v
-00018670: 6973 6962 6c65 203d 2054 7275 650a 2020  isible = True.  
+00017fc0: 666f 7220 6b2c 2076 2069 6e20 7365 6c66  for k, v in self
+00017fd0: 2e70 6c75 6769 6e2e 636f 6d70 7574 652e  .plugin.compute.
+00017fe0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+00017ff0: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
+00018000: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
+00018010: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00018020: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00018030: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
+00018040: 6120 3d20 7661 6c6d 6170 280a 2020 2020  a = valmap(.    
+00018050: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+00018060: 6461 2078 3a20 6e70 2e61 7272 6179 2878  da x: np.array(x
+00018070: 5b66 726f 6e74 3a62 6163 6b5d 2920 2f20  [front:back]) / 
+00018080: 6474 2c0a 2020 2020 2020 2020 2020 2020  dt,.            
+00018090: 2020 2020 7365 6c66 2e70 6c75 6769 6e2e      self.plugin.
+000180a0: 636f 6d70 7574 652c 0a20 2020 2020 2020  compute,.       
+000180b0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000180c0: 6e65 775f 6461 7461 5b22 7469 6d65 225d  new_data["time"]
+000180d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000180e0: 2074 696d 6573 7461 6d70 7320 2d20 7365   timestamps - se
+000180f0: 6c66 2e5f 6f66 6673 6574 0a20 2020 2020  lf._offset.     
+00018100: 2020 2029 202a 2031 3030 302e 3020 2023     ) * 1000.0  #
+00018110: 2062 6f6b 6568 206c 696b 6573 206d 696c   bokeh likes mil
+00018120: 6c69 7365 636f 6e64 730a 2020 2020 2020  liseconds.      
+00018130: 2020 6e65 775f 6461 7461 5b22 6e74 6872    new_data["nthr
+00018140: 6561 6473 225d 203d 206e 702e 6172 7261  eads"] = np.arra
+00018150: 7928 7365 6c66 2e70 6c75 6769 6e2e 6e74  y(self.plugin.nt
+00018160: 6872 6561 6473 5b66 726f 6e74 3a62 6163  hreads[front:bac
+00018170: 6b5d 290a 0a20 2020 2020 2020 2072 6574  k])..        ret
+00018180: 7572 6e20 6e65 775f 6461 7461 0a0a 2020  urn new_data..  
+00018190: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+000181a0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+000181b0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+000181c0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+000181d0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+000181e0: 0a20 2020 2020 2020 204d 6179 6265 2075  .        Maybe u
+000181f0: 7064 6174 6520 7468 6520 6368 6172 742e  pdate the chart.
+00018200: 2054 6869 7320 6973 2073 6f6d 6577 6861   This is somewha
+00018210: 7420 6578 7065 6e73 6976 6520 746f 2064  t expensive to d
+00018220: 7261 772c 2073 6f20 7765 2075 7064 6174  raw, so we updat
+00018230: 650a 2020 2020 2020 2020 6974 2070 7265  e.        it pre
+00018240: 7474 7920 6465 6665 6e73 6976 656c 792e  tty defensively.
+00018250: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00018260: 2020 2020 2069 6620 7365 6c66 2e5f 7368       if self._sh
+00018270: 6f75 6c64 5f61 6464 5f6e 6577 5f72 656e  ould_add_new_ren
+00018280: 6465 7265 7273 2829 3a0a 2020 2020 2020  derers():.      
+00018290: 2020 2020 2020 2320 5570 6461 7465 2074        # Update t
+000182a0: 6865 2063 6861 7274 2c20 616c 6c6f 7769  he chart, allowi
+000182b0: 6e67 2066 6f72 206e 6577 2074 6173 6b20  ng for new task 
+000182c0: 6772 6f75 7073 2074 6f20 6265 2061 6464  groups to be add
+000182d0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000182e0: 6e65 775f 6461 7461 203d 2073 656c 662e  new_data = self.
+000182f0: 5f67 6574 5f74 696d 6573 6572 6965 7328  _get_timeseries(
+00018300: 7265 7374 7269 6374 5f74 6f5f 6578 6973  restrict_to_exis
+00018310: 7469 6e67 3d46 616c 7365 290a 2020 2020  ting=False).    
+00018320: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00018330: 7263 652e 6461 7461 203d 206e 6577 5f64  rce.data = new_d
+00018340: 6174 610a 0a20 2020 2020 2020 2020 2020  ata..           
+00018350: 2023 2050 6f73 7369 626c 7920 7570 6461   # Possibly upda
+00018360: 7465 2074 6865 2079 2072 616e 6765 2069  te the y range i
+00018370: 6620 7468 6520 6e75 6d62 6572 206f 6620  f the number of 
+00018380: 7468 7265 6164 7320 6861 7320 696e 6372  threads has incr
+00018390: 6561 7365 642e 0a20 2020 2020 2020 2020  eased..         
+000183a0: 2020 206d 6178 5f6e 7468 7265 6164 7320     max_nthreads 
+000183b0: 3d20 6d61 7828 7365 6c66 2e70 6c75 6769  = max(self.plugi
+000183c0: 6e2e 6e74 6872 6561 6473 290a 2020 2020  n.nthreads).    
+000183d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000183e0: 726f 6f74 2e79 5f72 616e 6765 2e65 6e64  root.y_range.end
+000183f0: 2021 3d20 6d61 785f 6e74 6872 6561 6473   != max_nthreads
+00018400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018410: 2020 7365 6c66 2e72 6f6f 742e 795f 7261    self.root.y_ra
+00018420: 6e67 652e 656e 6420 3d20 6d61 785f 6e74  nge.end = max_nt
+00018430: 6872 6561 6473 0a0a 2020 2020 2020 2020  hreads..        
+00018440: 2020 2020 7374 6163 6b65 7273 203d 206c      stackers = l
+00018450: 6973 7428 7365 6c66 2e70 6c75 6769 6e2e  ist(self.plugin.
+00018460: 636f 6d70 7574 652e 6b65 7973 2829 290a  compute.keys()).
+00018470: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+00018480: 7273 203d 205b 636f 6c6f 725f 6f66 286b  rs = [color_of(k
+00018490: 6579 5f73 706c 6974 286b 2929 2066 6f72  ey_split(k)) for
+000184a0: 206b 2069 6e20 7374 6163 6b65 7273 5d0a   k in stackers].
+000184b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000184c0: 2069 2c20 2867 726f 7570 2c20 636f 6c6f   i, (group, colo
+000184d0: 7229 2069 6e20 656e 756d 6572 6174 6528  r) in enumerate(
+000184e0: 7a69 7028 7374 6163 6b65 7273 2c20 636f  zip(stackers, co
+000184f0: 6c6f 7273 2929 3a0a 2020 2020 2020 2020  lors)):.        
+00018500: 2020 2020 2020 2020 2320 4966 2077 6520          # If we 
+00018510: 6861 7665 2061 6c72 6561 6479 2064 7261  have already dra
+00018520: 776e 2074 6865 2067 726f 7570 2c20 6275  wn the group, bu
+00018530: 7420 6974 2069 7320 616c 6c20 7a65 726f  t it is all zero
+00018540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018550: 2020 2320 7365 7420 6974 2074 6f20 6265    # set it to be
+00018560: 2069 6e76 6973 6962 6c65 2e0a 2020 2020   invisible..    
+00018570: 2020 2020 2020 2020 2020 2020 6966 2067              if g
+00018580: 726f 7570 2069 6e20 7365 6c66 2e5f 7265  roup in self._re
+00018590: 6e64 6572 6572 733a 0a20 2020 2020 2020  nderers:.       
+000185a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000185b0: 6e6f 7420 6e70 2e63 6f75 6e74 5f6e 6f6e  not np.count_non
+000185c0: 7a65 726f 286e 6577 5f64 6174 615b 6772  zero(new_data[gr
+000185d0: 6f75 705d 2920 3e20 303a 0a20 2020 2020  oup]) > 0:.     
+000185e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185f0: 2020 2073 656c 662e 5f72 656e 6465 7265     self._rendere
+00018600: 7273 5b67 726f 7570 5d2e 7669 7369 626c  rs[group].visibl
+00018610: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
+00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018630: 2020 7365 6c66 2e5f 6c69 6e65 5f72 656e    self._line_ren
+00018640: 6465 7265 7273 5b67 726f 7570 5d2e 7669  derers[group].vi
+00018650: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+00018660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018670: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018690: 2020 2020 2020 7365 6c66 2e5f 6c69 6e65        self._line
-000186a0: 5f72 656e 6465 7265 7273 5b67 726f 7570  _renderers[group
-000186b0: 5d2e 7669 7369 626c 6520 3d20 5472 7565  ].visible = True
-000186c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000186d0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-000186e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186f0: 2320 4472 6177 2074 6865 206e 6577 2061  # Draw the new a
-00018700: 7265 6120 616e 6420 6c69 6e65 2067 6c79  rea and line gly
-00018710: 7068 732e 0a20 2020 2020 2020 2020 2020  phs..           
-00018720: 2020 2020 2072 656e 6465 7265 7220 3d20       renderer = 
-00018730: 7365 6c66 2e72 6f6f 742e 7661 7265 6128  self.root.varea(
-00018740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018750: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-00018760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018770: 2020 2079 313d 7374 6163 6b28 2a73 7461     y1=stack(*sta
-00018780: 636b 6572 735b 3a69 5d29 2c0a 2020 2020  ckers[:i]),.    
-00018790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187a0: 7932 3d73 7461 636b 282a 7374 6163 6b65  y2=stack(*stacke
-000187b0: 7273 5b3a 2069 202b 2031 5d29 2c0a 2020  rs[: i + 1]),.  
-000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187d0: 2020 636f 6c6f 723d 636f 6c6f 722c 0a20    color=color,. 
-000187e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187f0: 2020 2061 6c70 6861 3d30 2e35 2c0a 2020     alpha=0.5,.  
-00018800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018810: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-00018820: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-00018830: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00018840: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
-00018850: 6e64 6572 6572 735b 6772 6f75 705d 203d  nderers[group] =
-00018860: 2072 656e 6465 7265 720a 0a20 2020 2020   renderer..     
-00018870: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-00018880: 7265 6e64 6572 6572 203d 2073 656c 662e  renderer = self.
-00018890: 726f 6f74 2e6c 696e 6528 0a20 2020 2020  root.line(.     
-000188a0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-000188b0: 3d22 7469 6d65 222c 0a20 2020 2020 2020  ="time",.       
-000188c0: 2020 2020 2020 2020 2020 2020 2079 3d73               y=s
-000188d0: 7461 636b 282a 7374 6163 6b65 7273 5b3a  tack(*stackers[:
-000188e0: 2069 202b 2031 5d29 2c0a 2020 2020 2020   i + 1]),.      
-000188f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00018900: 6c6f 723d 636f 6c6f 722c 0a20 2020 2020  lor=color,.     
-00018910: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00018920: 6c70 6861 3d31 2e30 2c0a 2020 2020 2020  lpha=1.0,.      
-00018930: 2020 2020 2020 2020 2020 2020 2020 736f                so
-00018940: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-00018950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018960: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00018970: 2020 2020 7365 6c66 2e5f 6c69 6e65 5f72      self._line_r
-00018980: 656e 6465 7265 7273 5b67 726f 7570 5d20  enderers[group] 
-00018990: 3d20 6c69 6e65 5f72 656e 6465 7265 720a  = line_renderer.
-000189a0: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-000189b0: 6f6e 2774 2061 6464 2068 6f76 6572 2075  on't add hover u
-000189c0: 6e74 696c 2074 6865 7265 2069 7320 736f  ntil there is so
-000189d0: 6d65 7468 696e 6720 746f 2073 686f 772c  mething to show,
-000189e0: 2061 7320 626f 6b65 686a 7320 7365 656d   as bokehjs seem
-000189f0: 7320 746f 0a20 2020 2020 2020 2020 2020  s to.           
-00018a00: 2023 2068 6176 6520 7472 6f75 626c 6520   # have trouble 
-00018a10: 7769 7468 2063 7573 746f 6d20 686f 7665  with custom hove
-00018a20: 7273 2077 6865 6e20 7468 6572 6520 6172  rs when there ar
-00018a30: 6520 6e6f 2072 656e 6465 7265 7273 2e0a  e no renderers..
-00018a40: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00018a50: 656c 662e 706c 7567 696e 2e63 6f6d 7075  elf.plugin.compu
-00018a60: 7465 2061 6e64 2073 656c 662e 5f68 6f76  te and self._hov
-00018a70: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
-00018a80: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
-00018a90: 6420 6120 686f 7665 7220 7468 6174 2077  d a hover that w
-00018aa0: 696c 6c20 7368 6f77 206f 6363 7570 616e  ill show occupan
-00018ab0: 6379 2066 6f72 2061 6c6c 2063 7572 7265  cy for all curre
-00018ac0: 6e74 6c79 2061 6374 6976 650a 2020 2020  ntly active.    
-00018ad0: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
-00018ae0: 736b 2067 726f 7570 732e 2054 6869 7320  sk groups. This 
-00018af0: 6973 2061 206c 6974 746c 6520 7472 6963  is a little tric
-00018b00: 6b79 2c20 626f 6b65 6820 646f 6573 6e27  ky, bokeh doesn'
-00018b10: 7420 2879 6574 2920 7375 7070 6f72 740a  t (yet) support.
-00018b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b30: 2320 6869 7420 7465 7374 7320 666f 7220  # hit tests for 
-00018b40: 7374 6163 6b65 6420 6172 6561 2063 6861  stacked area cha
-00018b50: 7274 733a 2068 7474 7073 3a2f 2f67 6974  rts: https://git
-00018b60: 6875 622e 636f 6d2f 626f 6b65 682f 626f  hub.com/bokeh/bo
-00018b70: 6b65 682f 6973 7375 6573 2f39 3138 320a  keh/issues/9182.
-00018b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b90: 2320 496e 7374 6561 642c 2073 686f 7720  # Instead, show 
-00018ba0: 6120 7369 6e67 6c65 2076 6c69 6e65 2068  a single vline h
-00018bb0: 6f76 6572 2077 6869 6368 206c 6973 7473  over which lists
-00018bc0: 2074 6865 2063 7572 7265 6e74 6c79 2061   the currently a
-00018bd0: 6374 6976 6520 7461 736b 0a20 2020 2020  ctive task.     
-00018be0: 2020 2020 2020 2020 2020 2023 2067 726f             # gro
-00018bf0: 7570 732e 2041 2063 7573 746f 6d20 666f  ups. A custom fo
-00018c00: 726d 6174 7465 7220 696e 204a 532d 6c61  rmatter in JS-la
-00018c10: 6e64 2070 756c 6c73 2074 6865 2072 656c  nd pulls the rel
-00018c20: 6576 616e 7420 6461 7461 2069 6e64 6578  evant data index
-00018c30: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
-00018c40: 2020 2020 2023 2061 7373 656d 626c 6573       # assembles
-00018c50: 2074 6865 2074 6f6f 6c74 6970 2e0a 2020   the tooltip..  
-00018c60: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00018c70: 726d 6174 7465 7220 3d20 4375 7374 6f6d  rmatter = Custom
-00018c80: 4a53 486f 7665 7228 636f 6465 3d22 7265  JSHover(code="re
-00018c90: 7475 726e 2027 273b 2229 0a20 2020 2020  turn '';").     
-00018ca0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00018cb0: 5f68 6f76 6572 203d 2048 6f76 6572 546f  _hover = HoverTo
-00018cc0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
-00018cd0: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
-00018ce0: 3d22 2222 0a20 2020 2020 2020 2020 2020  =""".           
-00018cf0: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-00018d00: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00018d10: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-00018d20: 7620 7374 796c 653d 2266 6f6e 742d 7369  v style="font-si
-00018d30: 7a65 3a20 312e 3265 6d3b 2066 6f6e 742d  ze: 1.2em; font-
-00018d40: 7765 6967 6874 3a20 626f 6c64 223e 0a20  weight: bold">. 
-00018d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d60: 2020 2020 2020 2020 2020 203c 623e 576f             <b>Wo
-00018d70: 726b 6572 2074 6872 6561 6420 6f63 6375  rker thread occu
-00018d80: 7061 6e63 793c 2f62 3e0a 2020 2020 2020  pancy</b>.      
+00018690: 7365 6c66 2e5f 7265 6e64 6572 6572 735b  self._renderers[
+000186a0: 6772 6f75 705d 2e76 6973 6962 6c65 203d  group].visible =
+000186b0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+000186c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000186d0: 6c66 2e5f 6c69 6e65 5f72 656e 6465 7265  lf._line_rendere
+000186e0: 7273 5b67 726f 7570 5d2e 7669 7369 626c  rs[group].visibl
+000186f0: 6520 3d20 5472 7565 0a0a 2020 2020 2020  e = True..      
+00018700: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00018710: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+00018720: 2020 2020 2020 2020 2320 4472 6177 2074          # Draw t
+00018730: 6865 206e 6577 2061 7265 6120 616e 6420  he new area and 
+00018740: 6c69 6e65 2067 6c79 7068 732e 0a20 2020  line glyphs..   
+00018750: 2020 2020 2020 2020 2020 2020 2072 656e               ren
+00018760: 6465 7265 7220 3d20 7365 6c66 2e72 6f6f  derer = self.roo
+00018770: 742e 7661 7265 6128 0a20 2020 2020 2020  t.varea(.       
+00018780: 2020 2020 2020 2020 2020 2020 2078 3d22               x="
+00018790: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
+000187a0: 2020 2020 2020 2020 2020 2079 313d 7374             y1=st
+000187b0: 6163 6b28 2a73 7461 636b 6572 735b 3a69  ack(*stackers[:i
+000187c0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000187d0: 2020 2020 2020 2020 7932 3d73 7461 636b          y2=stack
+000187e0: 282a 7374 6163 6b65 7273 5b3a 2069 202b  (*stackers[: i +
+000187f0: 2031 5d29 2c0a 2020 2020 2020 2020 2020   1]),.          
+00018800: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
+00018810: 636f 6c6f 722c 0a20 2020 2020 2020 2020  color,.         
+00018820: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
+00018830: 3d30 2e35 2c0a 2020 2020 2020 2020 2020  =0.5,.          
+00018840: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00018850: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+00018860: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018880: 7365 6c66 2e5f 7265 6e64 6572 6572 735b  self._renderers[
+00018890: 6772 6f75 705d 203d 2072 656e 6465 7265  group] = rendere
+000188a0: 720a 0a20 2020 2020 2020 2020 2020 2020  r..             
+000188b0: 2020 206c 696e 655f 7265 6e64 6572 6572     line_renderer
+000188c0: 203d 2073 656c 662e 726f 6f74 2e6c 696e   = self.root.lin
+000188d0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000188e0: 2020 2020 2020 2078 3d22 7469 6d65 222c         x="time",
+000188f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018900: 2020 2020 2079 3d73 7461 636b 282a 7374       y=stack(*st
+00018910: 6163 6b65 7273 5b3a 2069 202b 2031 5d29  ackers[: i + 1])
+00018920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018930: 2020 2020 2020 636f 6c6f 723d 636f 6c6f        color=colo
+00018940: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00018950: 2020 2020 2020 2061 6c70 6861 3d31 2e30         alpha=1.0
+00018960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018970: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+00018980: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
+00018990: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000189a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000189b0: 2e5f 6c69 6e65 5f72 656e 6465 7265 7273  ._line_renderers
+000189c0: 5b67 726f 7570 5d20 3d20 6c69 6e65 5f72  [group] = line_r
+000189d0: 656e 6465 7265 720a 0a20 2020 2020 2020  enderer..       
+000189e0: 2020 2020 2023 2044 6f6e 2774 2061 6464       # Don't add
+000189f0: 2068 6f76 6572 2075 6e74 696c 2074 6865   hover until the
+00018a00: 7265 2069 7320 736f 6d65 7468 696e 6720  re is something 
+00018a10: 746f 2073 686f 772c 2061 7320 626f 6b65  to show, as boke
+00018a20: 686a 7320 7365 656d 7320 746f 0a20 2020  hjs seems to.   
+00018a30: 2020 2020 2020 2020 2023 2068 6176 6520           # have 
+00018a40: 7472 6f75 626c 6520 7769 7468 2063 7573  trouble with cus
+00018a50: 746f 6d20 686f 7665 7273 2077 6865 6e20  tom hovers when 
+00018a60: 7468 6572 6520 6172 6520 6e6f 2072 656e  there are no ren
+00018a70: 6465 7265 7273 2e0a 2020 2020 2020 2020  derers..        
+00018a80: 2020 2020 6966 2073 656c 662e 706c 7567      if self.plug
+00018a90: 696e 2e63 6f6d 7075 7465 2061 6e64 2073  in.compute and s
+00018aa0: 656c 662e 5f68 6f76 6572 2069 7320 4e6f  elf._hover is No
+00018ab0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00018ac0: 2020 2020 2320 4164 6420 6120 686f 7665      # Add a hove
+00018ad0: 7220 7468 6174 2077 696c 6c20 7368 6f77  r that will show
+00018ae0: 206f 6363 7570 616e 6379 2066 6f72 2061   occupancy for a
+00018af0: 6c6c 2063 7572 7265 6e74 6c79 2061 6374  ll currently act
+00018b00: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
+00018b10: 2020 2020 2320 7461 736b 2067 726f 7570      # task group
+00018b20: 732e 2054 6869 7320 6973 2061 206c 6974  s. This is a lit
+00018b30: 746c 6520 7472 6963 6b79 2c20 626f 6b65  tle tricky, boke
+00018b40: 6820 646f 6573 6e27 7420 2879 6574 2920  h doesn't (yet) 
+00018b50: 7375 7070 6f72 740a 2020 2020 2020 2020  support.        
+00018b60: 2020 2020 2020 2020 2320 6869 7420 7465          # hit te
+00018b70: 7374 7320 666f 7220 7374 6163 6b65 6420  sts for stacked 
+00018b80: 6172 6561 2063 6861 7274 733a 2068 7474  area charts: htt
+00018b90: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00018ba0: 626f 6b65 682f 626f 6b65 682f 6973 7375  bokeh/bokeh/issu
+00018bb0: 6573 2f39 3138 320a 2020 2020 2020 2020  es/9182.        
+00018bc0: 2020 2020 2020 2020 2320 496e 7374 6561          # Instea
+00018bd0: 642c 2073 686f 7720 6120 7369 6e67 6c65  d, show a single
+00018be0: 2076 6c69 6e65 2068 6f76 6572 2077 6869   vline hover whi
+00018bf0: 6368 206c 6973 7473 2074 6865 2063 7572  ch lists the cur
+00018c00: 7265 6e74 6c79 2061 6374 6976 6520 7461  rently active ta
+00018c10: 736b 0a20 2020 2020 2020 2020 2020 2020  sk.             
+00018c20: 2020 2023 2067 726f 7570 732e 2041 2063     # groups. A c
+00018c30: 7573 746f 6d20 666f 726d 6174 7465 7220  ustom formatter 
+00018c40: 696e 204a 532d 6c61 6e64 2070 756c 6c73  in JS-land pulls
+00018c50: 2074 6865 2072 656c 6576 616e 7420 6461   the relevant da
+00018c60: 7461 2069 6e64 6578 2061 6e64 0a20 2020  ta index and.   
+00018c70: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+00018c80: 7373 656d 626c 6573 2074 6865 2074 6f6f  ssembles the too
+00018c90: 6c74 6970 2e0a 2020 2020 2020 2020 2020  ltip..          
+00018ca0: 2020 2020 2020 666f 726d 6174 7465 7220        formatter 
+00018cb0: 3d20 4375 7374 6f6d 4a53 486f 7665 7228  = CustomJSHover(
+00018cc0: 636f 6465 3d22 7265 7475 726e 2027 273b  code="return '';
+00018cd0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00018ce0: 2020 2073 656c 662e 5f68 6f76 6572 203d     self._hover =
+00018cf0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
+00018d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d10: 746f 6f6c 7469 7073 3d22 2222 0a20 2020  tooltips=""".   
+00018d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d30: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+00018d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d50: 2020 2020 203c 6469 7620 7374 796c 653d       <div style=
+00018d60: 2266 6f6e 742d 7369 7a65 3a20 312e 3265  "font-size: 1.2e
+00018d70: 6d3b 2066 6f6e 742d 7765 6967 6874 3a20  m; font-weight: 
+00018d80: 626f 6c64 223e 0a20 2020 2020 2020 2020  bold">.         
 00018d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018da0: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
-00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018dc0: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-00018dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018de0: 2020 2020 2020 2024 696e 6465 787b 6375         $index{cu
-00018df0: 7374 6f6d 7d0a 2020 2020 2020 2020 2020  stom}.          
-00018e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e10: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-00018e20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00018e30: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00018e40: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-00018e50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00018e60: 2020 2020 2020 206d 6f64 653d 2276 6c69         mode="vli
-00018e70: 6e65 222c 0a20 2020 2020 2020 2020 2020  ne",.           
-00018e80: 2020 2020 2020 2020 206c 696e 655f 706f           line_po
-00018e90: 6c69 6379 3d22 6e65 6172 6573 7422 2c0a  licy="nearest",.
-00018ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018eb0: 2020 2020 6174 7461 6368 6d65 6e74 3d22      attachment="
-00018ec0: 686f 7269 7a6f 6e74 616c 222c 0a20 2020  horizontal",.   
-00018ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ee0: 2066 6f72 6d61 7474 6572 733d 7b22 2469   formatters={"$i
-00018ef0: 6e64 6578 223a 2066 6f72 6d61 7474 6572  ndex": formatter
-00018f00: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00018f10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00018f20: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
-00018f30: 6464 5f74 6f6f 6c73 2873 656c 662e 5f68  dd_tools(self._h
-00018f40: 6f76 6572 290a 0a20 2020 2020 2020 2020  over)..         
-00018f50: 2020 2069 6620 7365 6c66 2e5f 686f 7665     if self._hove
-00018f60: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00018f70: 2020 2023 2043 7265 6174 6520 6120 6375     # Create a cu
-00018f80: 7374 6f6d 2074 6f6f 6c74 6970 2074 6861  stom tooltip tha
-00018f90: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00018fa0: 2020 2023 2020 2031 2e20 496e 636c 7564     #   1. Includ
-00018fb0: 6573 206e 7468 7265 6164 730a 2020 2020  es nthreads.    
-00018fc0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00018fd0: 322e 2046 696c 7465 7273 206f 7574 2069  2. Filters out i
-00018fe0: 6e61 6374 6976 6520 7461 736b 2067 726f  nactive task gro
-00018ff0: 7570 730a 2020 2020 2020 2020 2020 2020  ups.            
-00019000: 2020 2020 2320 2020 2020 2028 6f6e 6573      #      (ones
-00019010: 2077 6974 686f 7574 2061 6e79 2063 6f6d   without any com
-00019020: 7075 7465 2064 7572 696e 6720 7468 6520  pute during the 
-00019030: 7265 6c65 7661 6e74 2064 7429 0a20 2020  relevant dt).   
-00019040: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-00019050: 2033 2e20 436f 6c6f 7273 2074 6865 206c   3. Colors the l
-00019060: 6162 656c 7320 6170 7072 6f70 7269 6174  abels appropriat
-00019070: 656c 792e 0a20 2020 2020 2020 2020 2020  ely..           
-00019080: 2020 2020 2066 6f72 6d61 7474 6572 203d       formatter =
-00019090: 2043 7573 746f 6d4a 5348 6f76 6572 280a   CustomJSHover(.
-000190a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190b0: 2020 2020 636f 6465 3d22 2222 0a20 2020      code=""".   
-000190c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190d0: 2020 2020 2063 6f6e 7374 2063 6f6c 6f72       const color
-000190e0: 6d61 7020 3d20 2573 3b0a 2020 2020 2020  map = %s;.      
-000190f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019100: 2020 636f 6e73 7420 6469 7673 203d 205b    const divs = [
-00019110: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-00019120: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00019130: 6c65 7420 6b20 6f66 204f 626a 6563 742e  let k of Object.
-00019140: 6b65 7973 2873 6f75 7263 652e 6461 7461  keys(source.data
-00019150: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
-00019160: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019170: 6f6e 7374 2076 616c 203d 2073 6f75 7263  onst val = sourc
-00019180: 652e 6461 7461 5b6b 5d5b 7661 6c75 655d  e.data[k][value]
-00019190: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000191a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000191b0: 7420 636f 6c6f 7220 3d20 636f 6c6f 726d  t color = colorm
-000191c0: 6170 5b6b 5d3b 0a20 2020 2020 2020 2020  ap[k];.         
+00018da0: 2020 203c 623e 576f 726b 6572 2074 6872     <b>Worker thr
+00018db0: 6561 6420 6f63 6375 7061 6e63 793c 2f62  ead occupancy</b
+00018dc0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00018dd0: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+00018de0: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+00018df0: 2020 2020 2020 2020 2020 2020 203c 6469               <di
+00018e00: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+00018e10: 2020 2020 2020 2020 2020 2020 2020 2024                 $
+00018e20: 696e 6465 787b 6375 7374 6f6d 7d0a 2020  index{custom}.  
+00018e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e40: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
+00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e60: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e80: 2020 2020 2020 2222 222c 0a20 2020 2020        """,.     
+00018e90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00018ea0: 6f64 653d 2276 6c69 6e65 222c 0a20 2020  ode="vline",.   
+00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ec0: 206c 696e 655f 706f 6c69 6379 3d22 6e65   line_policy="ne
+00018ed0: 6172 6573 7422 2c0a 2020 2020 2020 2020  arest",.        
+00018ee0: 2020 2020 2020 2020 2020 2020 6174 7461              atta
+00018ef0: 6368 6d65 6e74 3d22 686f 7269 7a6f 6e74  chment="horizont
+00018f00: 616c 222c 0a20 2020 2020 2020 2020 2020  al",.           
+00018f10: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
+00018f20: 6572 733d 7b22 2469 6e64 6578 223a 2066  ers={"$index": f
+00018f30: 6f72 6d61 7474 6572 7d2c 0a20 2020 2020  ormatter},.     
+00018f40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00018f50: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00018f60: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
+00018f70: 2873 656c 662e 5f68 6f76 6572 290a 0a20  (self._hover).. 
+00018f80: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00018f90: 6c66 2e5f 686f 7665 723a 0a20 2020 2020  lf._hover:.     
+00018fa0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
+00018fb0: 6174 6520 6120 6375 7374 6f6d 2074 6f6f  ate a custom too
+00018fc0: 6c74 6970 2074 6861 743a 0a20 2020 2020  ltip that:.     
+00018fd0: 2020 2020 2020 2020 2020 2023 2020 2031             #   1
+00018fe0: 2e20 496e 636c 7564 6573 206e 7468 7265  . Includes nthre
+00018ff0: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
+00019000: 2020 2020 2320 2020 322e 2046 696c 7465      #   2. Filte
+00019010: 7273 206f 7574 2069 6e61 6374 6976 6520  rs out inactive 
+00019020: 7461 736b 2067 726f 7570 730a 2020 2020  task groups.    
+00019030: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00019040: 2020 2028 6f6e 6573 2077 6974 686f 7574     (ones without
+00019050: 2061 6e79 2063 6f6d 7075 7465 2064 7572   any compute dur
+00019060: 696e 6720 7468 6520 7265 6c65 7661 6e74  ing the relevant
+00019070: 2064 7429 0a20 2020 2020 2020 2020 2020   dt).           
+00019080: 2020 2020 2023 2020 2033 2e20 436f 6c6f       #   3. Colo
+00019090: 7273 2074 6865 206c 6162 656c 7320 6170  rs the labels ap
+000190a0: 7072 6f70 7269 6174 656c 792e 0a20 2020  propriately..   
+000190b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000190c0: 6d61 7474 6572 203d 2043 7573 746f 6d4a  matter = CustomJ
+000190d0: 5348 6f76 6572 280a 2020 2020 2020 2020  SHover(.        
+000190e0: 2020 2020 2020 2020 2020 2020 636f 6465              code
+000190f0: 3d22 2222 0a20 2020 2020 2020 2020 2020  =""".           
+00019100: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00019110: 7374 2063 6f6c 6f72 6d61 7020 3d20 2573  st colormap = %s
+00019120: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00019130: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00019140: 6469 7673 203d 205b 5d3b 0a20 2020 2020  divs = [];.     
+00019150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019160: 2020 2066 6f72 2028 6c65 7420 6b20 6f66     for (let k of
+00019170: 204f 626a 6563 742e 6b65 7973 2873 6f75   Object.keys(sou
+00019180: 7263 652e 6461 7461 2929 207b 0a20 2020  rce.data)) {.   
+00019190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191a0: 2020 2020 2020 2063 6f6e 7374 2076 616c         const val
+000191b0: 203d 2073 6f75 7263 652e 6461 7461 5b6b   = source.data[k
+000191c0: 5d5b 7661 6c75 655d 3b0a 2020 2020 2020  ][value];.      
 000191d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191e0: 2069 6620 286b 203d 3d3d 2022 7469 6d65   if (k === "time
-000191f0: 2220 7c7c 206b 203d 3d3d 2022 6e74 6872  " || k === "nthr
-00019200: 6561 6473 2220 7c7c 2076 616c 203c 2031  eads" || val < 1
-00019210: 2e65 2d33 2920 7b0a 2020 2020 2020 2020  .e-3) {.        
-00019220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019230: 2020 2020 636f 6e74 696e 7565 3b0a 2020      continue;.  
-00019240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019250: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00019260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019270: 2020 2020 636f 6e73 7420 6c61 6265 6c20      const label 
-00019280: 3d20 6b2e 6c65 6e67 7468 203e 3d20 3230  = k.length >= 20
-00019290: 203f 206b 2e73 6c69 6365 2830 2c20 3230   ? k.slice(0, 20
-000192a0: 2920 2b20 27e2 80a6 2720 3a20 6b3b 0a0a  ) + '...' : k;..
-000192b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192c0: 2020 2020 2020 2020 2020 2f2f 2055 6e73            // Uns
-000192d0: 6869 6674 2073 6f20 7468 6174 2074 6865  hift so that the
-000192e0: 206f 7264 6572 696e 6720 6f66 2074 6865   ordering of the
-000192f0: 206c 6162 656c 7320 6973 2074 6865 2073   labels is the s
-00019300: 616d 6520 6173 0a20 2020 2020 2020 2020  ame as.         
-00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019320: 202f 2f20 7468 6520 6f72 6465 7269 6e67   // the ordering
-00019330: 206f 6620 7468 6520 7374 6163 6b65 7273   of the stackers
-00019340: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00019350: 2020 2020 2020 2020 2020 2020 6469 7673              divs
-00019360: 2e75 6e73 6869 6674 280a 2020 2020 2020  .unshift(.      
-00019370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019380: 2020 2020 2020 273c 6469 763e 270a 2020        '<div>'.  
-00019390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193a0: 2020 2020 2020 2020 2020 2020 2b20 273c              + '<
-000193b0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-000193c0: 2d77 6569 6768 743a 2062 6f6c 643b 2063  -weight: bold; c
-000193d0: 6f6c 6f72 3a27 202b 2063 6f6c 6f72 202b  olor:' + color +
-000193e0: 2027 3b22 3e27 0a20 2020 2020 2020 2020   ';">'.         
-000193f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019400: 2020 2020 2020 202b 206c 6162 656c 0a20         + label. 
-00019410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019420: 2020 2020 2020 2020 2020 2020 202b 2027               + '
-00019430: 3c2f 7370 616e 3e27 0a20 2020 2020 2020  </span>'.       
-00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019450: 2020 2020 2020 202b 2027 3a20 270a 2020         + ': '.  
-00019460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019470: 2020 2020 2020 2020 2020 2020 2b20 2076              +  v
-00019480: 616c 2e74 6f46 6978 6564 2831 290a 2020  al.toFixed(1).  
-00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194a0: 2020 2020 2020 2020 2020 2020 2b20 273c              + '<
-000194b0: 2f64 6976 3e27 0a20 2020 2020 2020 2020  /div>'.         
-000194c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194d0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-000194e0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+000191e0: 2020 2020 636f 6e73 7420 636f 6c6f 7220      const color 
+000191f0: 3d20 636f 6c6f 726d 6170 5b6b 5d3b 0a20  = colormap[k];. 
+00019200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019210: 2020 2020 2020 2020 2069 6620 286b 203d           if (k =
+00019220: 3d3d 2022 7469 6d65 2220 7c7c 206b 203d  == "time" || k =
+00019230: 3d3d 2022 6e74 6872 6561 6473 2220 7c7c  == "nthreads" ||
+00019240: 2076 616c 203c 2031 2e65 2d33 2920 7b0a   val < 1.e-3) {.
+00019250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019260: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00019270: 696e 7565 3b0a 2020 2020 2020 2020 2020  inue;.          
+00019280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019290: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+000192a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000192b0: 7420 6c61 6265 6c20 3d20 6b2e 6c65 6e67  t label = k.leng
+000192c0: 7468 203e 3d20 3230 203f 206b 2e73 6c69  th >= 20 ? k.sli
+000192d0: 6365 2830 2c20 3230 2920 2b20 27e2 80a6  ce(0, 20) + '...
+000192e0: 2720 3a20 6b3b 0a0a 2020 2020 2020 2020  ' : k;..        
+000192f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019300: 2020 2f2f 2055 6e73 6869 6674 2073 6f20    // Unshift so 
+00019310: 7468 6174 2074 6865 206f 7264 6572 696e  that the orderin
+00019320: 6720 6f66 2074 6865 206c 6162 656c 7320  g of the labels 
+00019330: 6973 2074 6865 2073 616d 6520 6173 0a20  is the same as. 
+00019340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019350: 2020 2020 2020 2020 202f 2f20 7468 6520           // the 
+00019360: 6f72 6465 7269 6e67 206f 6620 7468 6520  ordering of the 
+00019370: 7374 6163 6b65 7273 2e0a 2020 2020 2020  stackers..      
+00019380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019390: 2020 2020 6469 7673 2e75 6e73 6869 6674      divs.unshift
+000193a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000193b0: 2020 2020 2020 2020 2020 2020 2020 273c                '<
+000193c0: 6469 763e 270a 2020 2020 2020 2020 2020  div>'.          
+000193d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193e0: 2020 2020 2b20 273c 7370 616e 2073 7479      + '<span sty
+000193f0: 6c65 3d22 666f 6e74 2d77 6569 6768 743a  le="font-weight:
+00019400: 2062 6f6c 643b 2063 6f6c 6f72 3a27 202b   bold; color:' +
+00019410: 2063 6f6c 6f72 202b 2027 3b22 3e27 0a20   color + ';">'. 
+00019420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019430: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00019440: 206c 6162 656c 0a20 2020 2020 2020 2020   label.         
+00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019460: 2020 2020 202b 2027 3c2f 7370 616e 3e27       + '</span>'
+00019470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019480: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00019490: 2027 3a20 270a 2020 2020 2020 2020 2020   ': '.          
+000194a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194b0: 2020 2020 2b20 2076 616c 2e74 6f46 6978      +  val.toFix
+000194c0: 6564 2831 290a 2020 2020 2020 2020 2020  ed(1).          
+000194d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194e0: 2020 2020 2b20 273c 2f64 6976 3e27 0a20      + '</div>'. 
 000194f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019500: 2020 2020 2020 6469 7673 2e75 6e73 6869        divs.unshi
-00019510: 6674 280a 2020 2020 2020 2020 2020 2020  ft(.            
-00019520: 2020 2020 2020 2020 2020 2020 2020 273c                '<
-00019530: 6469 763e 270a 2020 2020 2020 2020 2020  div>'.          
-00019540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019550: 2020 2b20 273c 7370 616e 2073 7479 6c65    + '<span style
-00019560: 3d22 666f 6e74 2d77 6569 6768 743a 2062  ="font-weight: b
-00019570: 6f6c 643b 2063 6f6c 6f72 3a20 6461 726b  old; color: dark
-00019580: 6772 6579 3b22 3e6e 7468 7265 6164 733a  grey;">nthreads:
-00019590: 203c 2f73 7061 6e3e 270a 2020 2020 2020   </span>'.      
-000195a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195b0: 2020 2020 2020 2b20 736f 7572 6365 2e64        + source.d
-000195c0: 6174 612e 6e74 6872 6561 6473 5b76 616c  ata.nthreads[val
-000195d0: 7565 5d0a 2020 2020 2020 2020 2020 2020  ue].            
-000195e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195f0: 2b20 273c 2f64 6976 3e27 0a20 2020 2020  + '</div>'.     
-00019600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019610: 2020 2029 3b0a 2020 2020 2020 2020 2020     );.          
-00019620: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00019630: 7475 726e 2064 6976 732e 6a6f 696e 2827  turn divs.join('
-00019640: 5c5c 6e27 290a 2020 2020 2020 2020 2020  \\n').          
-00019650: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-00019660: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00019670: 2020 2020 2020 2520 6469 6374 280a 2020        % dict(.  
+00019500: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019520: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00019530: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00019540: 7673 2e75 6e73 6869 6674 280a 2020 2020  vs.unshift(.    
+00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019560: 2020 2020 2020 273c 6469 763e 270a 2020        '<div>'.  
+00019570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019580: 2020 2020 2020 2020 2020 2b20 273c 7370            + '<sp
+00019590: 616e 2073 7479 6c65 3d22 666f 6e74 2d77  an style="font-w
+000195a0: 6569 6768 743a 2062 6f6c 643b 2063 6f6c  eight: bold; col
+000195b0: 6f72 3a20 6461 726b 6772 6579 3b22 3e6e  or: darkgrey;">n
+000195c0: 7468 7265 6164 733a 203c 2f73 7061 6e3e  threads: </span>
+000195d0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000195e0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+000195f0: 736f 7572 6365 2e64 6174 612e 6e74 6872  source.data.nthr
+00019600: 6561 6473 5b76 616c 7565 5d0a 2020 2020  eads[value].    
+00019610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019620: 2020 2020 2020 2020 2b20 273c 2f64 6976          + '</div
+00019630: 3e27 0a20 2020 2020 2020 2020 2020 2020  >'.             
+00019640: 2020 2020 2020 2020 2020 2029 3b0a 2020             );.  
+00019650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019660: 2020 2020 2020 7265 7475 726e 2064 6976        return div
+00019670: 732e 6a6f 696e 2827 5c5c 6e27 290a 2020  s.join('\\n').  
 00019680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019690: 2020 2020 2020 7a69 7028 7374 6163 6b65        zip(stacke
-000196a0: 7273 2c20 636f 6c6f 7273 290a 2020 2020  rs, colors).    
-000196b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196c0: 292c 2020 2320 736e 6561 6b20 7468 6520  ),  # sneak the 
-000196d0: 636f 6c6f 7220 6d61 7070 696e 6720 696e  color mapping in
-000196e0: 746f 2074 6865 2063 616c 6c62 6163 6b0a  to the callback.
-000196f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019700: 2020 2020 6172 6773 3d7b 2273 6f75 7263      args={"sourc
-00019710: 6522 3a20 7365 6c66 2e73 6f75 7263 657d  e": self.source}
-00019720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019730: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00019740: 2020 2020 2320 4164 6420 7468 6520 486f      # Add the Ho
-00019750: 7665 7254 6f6f 6c20 746f 2074 6865 2074  verTool to the t
-00019760: 6f70 206c 696e 6520 7265 6e64 6572 6572  op line renderer
-00019770: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00019780: 2020 746f 705f 6c69 6e65 203d 204e 6f6e    top_line = Non
-00019790: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000197a0: 2020 666f 7220 6c69 6e65 2069 6e20 7265    for line in re
-000197b0: 7665 7273 6564 2873 656c 662e 5f6c 696e  versed(self._lin
-000197c0: 655f 7265 6e64 6572 6572 732e 7661 6c75  e_renderers.valu
-000197d0: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
-000197e0: 2020 2020 2020 2020 2020 2069 6620 6c69             if li
-000197f0: 6e65 2e76 6973 6962 6c65 3a0a 2020 2020  ne.visible:.    
-00019800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019810: 2020 2020 746f 705f 6c69 6e65 203d 206c      top_line = l
-00019820: 696e 650a 2020 2020 2020 2020 2020 2020  ine.            
-00019830: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00019840: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-00019850: 2020 7365 6c66 2e5f 686f 7665 722e 7265    self._hover.re
-00019860: 6e64 6572 6572 7320 3d20 5b74 6f70 5f6c  nderers = [top_l
-00019870: 696e 655d 0a20 2020 2020 2020 2020 2020  ine].           
-00019880: 2020 2020 2073 656c 662e 5f68 6f76 6572       self._hover
-00019890: 2e66 6f72 6d61 7474 6572 7320 3d20 7b22  .formatters = {"
-000198a0: 2469 6e64 6578 223a 2066 6f72 6d61 7474  $index": formatt
-000198b0: 6572 7d0a 0a20 2020 2020 2020 2020 2020  er}..           
-000198c0: 2073 656c 662e 5f6c 6173 745f 6472 6177   self._last_draw
-000198d0: 6e20 3d20 7469 6d65 2829 0a20 2020 2020  n = time().     
-000198e0: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
-000198f0: 745f 7472 616e 7369 7469 6f6e 5f63 6f75  t_transition_cou
-00019900: 6e74 203d 2073 656c 662e 7363 6865 6475  nt = self.schedu
-00019910: 6c65 722e 7472 616e 7369 7469 6f6e 5f63  ler.transition_c
-00019920: 6f75 6e74 6572 0a20 2020 2020 2020 2065  ounter.        e
-00019930: 6c69 6620 7365 6c66 2e5f 7368 6f75 6c64  lif self._should
-00019940: 5f75 7064 6174 6528 293a 0a20 2020 2020  _update():.     
-00019950: 2020 2020 2020 2023 2050 6f73 7369 626c         # Possibl
-00019960: 7920 7570 6461 7465 2074 6865 2079 2072  y update the y r
-00019970: 616e 6765 2069 6620 6e65 7720 7468 7265  ange if new thre
-00019980: 6164 7320 6861 7665 2062 6565 6e20 6164  ads have been ad
-00019990: 6465 640a 2020 2020 2020 2020 2020 2020  ded.            
-000199a0: 6d61 785f 6e74 6872 6561 6473 203d 206d  max_nthreads = m
-000199b0: 6178 2873 656c 662e 706c 7567 696e 2e6e  ax(self.plugin.n
-000199c0: 7468 7265 6164 7329 0a20 2020 2020 2020  threads).       
-000199d0: 2020 2020 2069 6620 7365 6c66 2e72 6f6f       if self.roo
-000199e0: 742e 795f 7261 6e67 652e 656e 6420 213d  t.y_range.end !=
-000199f0: 206d 6178 5f6e 7468 7265 6164 733a 0a20   max_nthreads:. 
-00019a00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019a10: 656c 662e 726f 6f74 2e79 5f72 616e 6765  elf.root.y_range
-00019a20: 2e65 6e64 203d 206d 6178 5f6e 7468 7265  .end = max_nthre
-00019a30: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-00019a40: 2320 5570 6461 7465 2074 6865 2064 6174  # Update the dat
-00019a50: 612c 206f 6e6c 7920 696e 636c 7564 696e  a, only includin
-00019a60: 6720 6578 6973 7469 6e67 2063 6f6c 756d  g existing colum
-00019a70: 6e73 2c20 7261 7468 6572 2074 6861 6e20  ns, rather than 
-00019a80: 7265 6472 6177 696e 670a 2020 2020 2020  redrawing.      
-00019a90: 2020 2020 2020 2320 7468 6520 7768 6f6c        # the whol
-00019aa0: 6520 6368 6172 742e 0a20 2020 2020 2020  e chart..       
-00019ab0: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-00019ac0: 2e64 6174 6120 3d20 7365 6c66 2e5f 6765  .data = self._ge
-00019ad0: 745f 7469 6d65 7365 7269 6573 2872 6573  t_timeseries(res
-00019ae0: 7472 6963 745f 746f 5f65 7869 7374 696e  trict_to_existin
-00019af0: 673d 5472 7565 290a 2020 2020 2020 2020  g=True).        
-00019b00: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
-00019b10: 7261 6e73 6974 696f 6e5f 636f 756e 7420  ransition_count 
-00019b20: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00019b30: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-00019b40: 7465 720a 0a0a 636c 6173 7320 5461 736b  ter...class Task
-00019b50: 5072 6f67 7265 7373 2844 6173 6862 6f61  Progress(Dashboa
-00019b60: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
-00019b70: 2020 2222 2250 726f 6772 6573 7320 6261    """Progress ba
-00019b80: 7273 2070 6572 2074 6173 6b20 7479 7065  rs per task type
-00019b90: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-00019ba0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-00019bb0: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
-00019bc0: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00019bd0: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00019be0: 756c 6572 0a0a 2020 2020 2020 2020 6461  uler..        da
-00019bf0: 7461 203d 2070 726f 6772 6573 735f 7175  ta = progress_qu
-00019c00: 6164 7328 0a20 2020 2020 2020 2020 2020  ads(.           
-00019c10: 2064 6963 7428 616c 6c3d 7b7d 2c20 6d65   dict(all={}, me
-00019c20: 6d6f 7279 3d7b 7d2c 2065 7272 6564 3d7b  mory={}, erred={
-00019c30: 7d2c 2072 656c 6561 7365 643d 7b7d 2c20  }, released={}, 
-00019c40: 7072 6f63 6573 7369 6e67 3d7b 7d2c 2071  processing={}, q
-00019c50: 7565 7565 643d 7b7d 290a 2020 2020 2020  ueued={}).      
-00019c60: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00019c70: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
-00019c80: 4461 7461 536f 7572 6365 2864 6174 613d  DataSource(data=
-00019c90: 6461 7461 290a 0a20 2020 2020 2020 2078  data)..        x
-00019ca0: 5f72 616e 6765 203d 2044 6174 6152 616e  _range = DataRan
-00019cb0: 6765 3164 2872 616e 6765 5f70 6164 6469  ge1d(range_paddi
-00019cc0: 6e67 3d30 290a 2020 2020 2020 2020 795f  ng=0).        y_
-00019cd0: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
-00019ce0: 2d38 2c20 3029 0a0a 2020 2020 2020 2020  -8, 0)..        
-00019cf0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
-00019d00: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00019d10: 7469 746c 653d 2250 726f 6772 6573 7322  title="Progress"
-00019d20: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-00019d30: 6d65 3d22 7461 736b 5f70 726f 6772 6573  me="task_progres
-00019d40: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00019d50: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
-00019d60: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
-00019d70: 616e 6765 3d79 5f72 616e 6765 2c0a 2020  ange=y_range,.  
-00019d80: 2020 2020 2020 2020 2020 746f 6f6c 6261            toolba
-00019d90: 725f 6c6f 6361 7469 6f6e 3d22 6162 6f76  r_location="abov
-00019da0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00019db0: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-00019dc0: 2020 2020 2020 6d69 6e5f 626f 7264 6572        min_border
-00019dd0: 5f62 6f74 746f 6d3d 3530 2c0a 2020 2020  _bottom=50,.    
-00019de0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-00019df0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00019e00: 2020 2020 7365 6c66 2e72 6f6f 742e 6c69      self.root.li
-00019e10: 6e65 2820 2023 206a 7573 7420 746f 2064  ne(  # just to d
-00019e20: 6566 696e 6520 6561 726c 7920 7261 6e67  efine early rang
-00019e30: 6573 0a20 2020 2020 2020 2020 2020 2078  es.            x
-00019e40: 3d5b 302c 2030 2e39 5d2c 2079 3d5b 2d31  =[0, 0.9], y=[-1
-00019e50: 2c20 305d 2c20 6c69 6e65 5f63 6f6c 6f72  , 0], line_color
-00019e60: 3d22 2346 4646 4646 4622 2c20 616c 7068  ="#FFFFFF", alph
-00019e70: 613d 302e 300a 2020 2020 2020 2020 290a  a=0.0.        ).
-00019e80: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00019e90: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
-00019ea0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-00019eb0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-00019ec0: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
-00019ed0: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
-00019ee0: 6d3d 2262 6f74 746f 6d22 2c0a 2020 2020  m="bottom",.    
-00019ef0: 2020 2020 2020 2020 6c65 6674 3d22 6c65          left="le
-00019f00: 6674 222c 0a20 2020 2020 2020 2020 2020  ft",.           
-00019f10: 2072 6967 6874 3d22 7269 6768 7422 2c0a   right="right",.
-00019f20: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00019f30: 5f63 6f6c 6f72 3d22 2361 6161 6161 6122  _color="#aaaaaa"
-00019f40: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-00019f50: 6e65 5f63 6f6c 6f72 3d22 2361 6161 6161  ne_color="#aaaaa
-00019f60: 6122 2c0a 2020 2020 2020 2020 2020 2020  a",.            
-00019f70: 6669 6c6c 5f61 6c70 6861 3d30 2e31 2c0a  fill_alpha=0.1,.
-00019f80: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-00019f90: 5f61 6c70 6861 3d30 2e33 2c0a 2020 2020  _alpha=0.3,.    
-00019fa0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00019fb0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-00019fc0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00019fd0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-00019fe0: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
-00019ff0: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
-0001a000: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
-0001a010: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-0001a020: 6674 3d22 6c65 6674 222c 0a20 2020 2020  ft="left",.     
-0001a030: 2020 2020 2020 2072 6967 6874 3d22 7265         right="re
-0001a040: 6c65 6173 6564 2d6c 6f63 222c 0a20 2020  leased-loc",.   
-0001a050: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-0001a060: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-0001a070: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-0001a080: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-0001a090: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
-0001a0a0: 7068 613d 302e 362c 0a20 2020 2020 2020  pha=0.6,.       
-0001a0b0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0001a0c0: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
-0001a0d0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-0001a0e0: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-0001a0f0: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
-0001a100: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
-0001a110: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
-0001a120: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-0001a130: 2272 656c 6561 7365 642d 6c6f 6322 2c0a  "released-loc",.
-0001a140: 2020 2020 2020 2020 2020 2020 7269 6768              righ
-0001a150: 743d 226d 656d 6f72 792d 6c6f 6322 2c0a  t="memory-loc",.
-0001a160: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-0001a170: 5f63 6f6c 6f72 3d22 636f 6c6f 7222 2c0a  _color="color",.
-0001a180: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-0001a190: 5f63 6f6c 6f72 3d22 636f 6c6f 7222 2c0a  _color="color",.
-0001a1a0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-0001a1b0: 5f61 6c70 6861 3d31 2e30 2c0a 2020 2020  _alpha=1.0,.    
-0001a1c0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001a1d0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-0001a1e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0001a1f0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-0001a200: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
-0001a210: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
-0001a220: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
-0001a230: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-0001a240: 6674 3d22 6d65 6d6f 7279 2d6c 6f63 222c  ft="memory-loc",
-0001a250: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-0001a260: 6874 3d22 6572 7265 642d 6c6f 6322 2c0a  ht="erred-loc",.
-0001a270: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-0001a280: 5f63 6f6c 6f72 3d22 626c 6163 6b22 2c0a  _color="black",.
-0001a290: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-0001a2a0: 5f61 6c70 6861 3d30 2e35 2c0a 2020 2020  _alpha=0.5,.    
-0001a2b0: 2020 2020 2020 2020 6c69 6e65 5f61 6c70          line_alp
-0001a2c0: 6861 3d30 2c0a 2020 2020 2020 2020 290a  ha=0,.        ).
-0001a2d0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001a2e0: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
-0001a2f0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0001a300: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0001a310: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
-0001a320: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
-0001a330: 6d3d 2262 6f74 746f 6d22 2c0a 2020 2020  m="bottom",.    
-0001a340: 2020 2020 2020 2020 6c65 6674 3d22 6572          left="er
-0001a350: 7265 642d 6c6f 6322 2c0a 2020 2020 2020  red-loc",.      
-0001a360: 2020 2020 2020 7269 6768 743d 2270 726f        right="pro
-0001a370: 6365 7373 696e 672d 6c6f 6322 2c0a 2020  cessing-loc",.  
-0001a380: 2020 2020 2020 2020 2020 6669 6c6c 5f63            fill_c
-0001a390: 6f6c 6f72 3d22 6772 6179 222c 0a20 2020  olor="gray",.   
-0001a3a0: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
-0001a3b0: 7068 613d 302e 3335 2c0a 2020 2020 2020  pha=0.35,.      
-0001a3c0: 2020 2020 2020 6c69 6e65 5f61 6c70 6861        line_alpha
-0001a3d0: 3d30 2c0a 2020 2020 2020 2020 290a 2020  =0,.        ).  
-0001a3e0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0001a3f0: 7175 6164 280a 2020 2020 2020 2020 2020  quad(.          
-0001a400: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-0001a410: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-0001a420: 2020 746f 703d 2274 6f70 222c 0a20 2020    top="top",.   
-0001a430: 2020 2020 2020 2020 2062 6f74 746f 6d3d           bottom=
-0001a440: 2262 6f74 746f 6d22 2c0a 2020 2020 2020  "bottom",.      
-0001a450: 2020 2020 2020 6c65 6674 3d22 7072 6f63        left="proc
-0001a460: 6573 7369 6e67 2d6c 6f63 222c 0a20 2020  essing-loc",.   
-0001a470: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
-0001a480: 7175 6575 6564 2d6c 6f63 222c 0a20 2020  queued-loc",.   
-0001a490: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-0001a4a0: 6c6f 723d 2267 7261 7922 2c0a 2020 2020  lor="gray",.    
-0001a4b0: 2020 2020 2020 2020 6861 7463 685f 7061          hatch_pa
-0001a4c0: 7474 6572 6e3d 222f 222c 0a20 2020 2020  ttern="/",.     
-0001a4d0: 2020 2020 2020 2068 6174 6368 5f63 6f6c         hatch_col
-0001a4e0: 6f72 3d22 7768 6974 6522 2c0a 2020 2020  or="white",.    
-0001a4f0: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
-0001a500: 6861 3d30 2e33 352c 0a20 2020 2020 2020  ha=0.35,.       
-0001a510: 2020 2020 206c 696e 655f 616c 7068 613d       line_alpha=
-0001a520: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
-0001a530: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
-0001a540: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
-0001a550: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-0001a560: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0001a570: 2074 6f70 3d22 746f 7022 2c0a 2020 2020   top="top",.    
-0001a580: 2020 2020 2020 2020 626f 7474 6f6d 3d22          bottom="
-0001a590: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
-0001a5a0: 2020 2020 206c 6566 743d 2271 7565 7565       left="queue
-0001a5b0: 642d 6c6f 6322 2c0a 2020 2020 2020 2020  d-loc",.        
-0001a5c0: 2020 2020 7269 6768 743d 226e 6f2d 776f      right="no-wo
-0001a5d0: 726b 6572 2d6c 6f63 222c 0a20 2020 2020  rker-loc",.     
-0001a5e0: 2020 2020 2020 2066 696c 6c5f 636f 6c6f         fill_colo
-0001a5f0: 723d 2272 6564 222c 0a20 2020 2020 2020  r="red",.       
-0001a600: 2020 2020 2068 6174 6368 5f70 6174 7465       hatch_patte
-0001a610: 726e 3d22 2f22 2c0a 2020 2020 2020 2020  rn="/",.        
-0001a620: 2020 2020 6861 7463 685f 636f 6c6f 723d      hatch_color=
-0001a630: 2262 6c61 636b 222c 0a20 2020 2020 2020  "black",.       
-0001a640: 2020 2020 2066 696c 6c5f 616c 7068 613d       fill_alpha=
-0001a650: 302e 3335 2c0a 2020 2020 2020 2020 2020  0.35,.          
-0001a660: 2020 6c69 6e65 5f61 6c70 6861 3d30 2c0a    line_alpha=0,.
-0001a670: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001a680: 2020 7365 6c66 2e72 6f6f 742e 7465 7874    self.root.text
-0001a690: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0001a6a0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0001a6b0: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-0001a6c0: 7874 3d22 7368 6f77 2d6e 616d 6522 2c0a  xt="show-name",.
-0001a6d0: 2020 2020 2020 2020 2020 2020 793d 2262              y="b
-0001a6e0: 6f74 746f 6d22 2c0a 2020 2020 2020 2020  ottom",.        
-0001a6f0: 2020 2020 783d 226c 6566 7422 2c0a 2020      x="left",.  
-0001a700: 2020 2020 2020 2020 2020 785f 6f66 6673            x_offs
-0001a710: 6574 3d35 2c0a 2020 2020 2020 2020 2020  et=5,.          
-0001a720: 2020 7465 7874 5f66 6f6e 745f 7369 7a65    text_font_size
-0001a730: 3d76 616c 7565 2822 3130 7074 2229 2c0a  =value("10pt"),.
-0001a740: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001a750: 2020 7365 6c66 2e72 6f6f 742e 7465 7874    self.root.text
-0001a760: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0001a770: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0001a780: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-0001a790: 7874 3d22 646f 6e65 222c 0a20 2020 2020  xt="done",.     
-0001a7a0: 2020 2020 2020 2079 3d22 626f 7474 6f6d         y="bottom
-0001a7b0: 222c 0a20 2020 2020 2020 2020 2020 2078  ",.            x
-0001a7c0: 3d22 7269 6768 7422 2c0a 2020 2020 2020  ="right",.      
-0001a7d0: 2020 2020 2020 785f 6f66 6673 6574 3d2d        x_offset=-
-0001a7e0: 352c 0a20 2020 2020 2020 2020 2020 2074  5,.            t
-0001a7f0: 6578 745f 616c 6967 6e3d 2272 6967 6874  ext_align="right
-0001a800: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-0001a810: 6578 745f 666f 6e74 5f73 697a 653d 7661  ext_font_size=va
-0001a820: 6c75 6528 2231 3070 7422 292c 0a20 2020  lue("10pt"),.   
-0001a830: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001a840: 656c 662e 726f 6f74 2e79 6772 6964 2e76  elf.root.ygrid.v
-0001a850: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-0001a860: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001a870: 2e79 6178 6973 2e6d 696e 6f72 5f74 6963  .yaxis.minor_tic
-0001a880: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
-0001a890: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0001a8a0: 6f74 2e79 6178 6973 2e76 6973 6962 6c65  ot.yaxis.visible
-0001a8b0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0001a8c0: 2073 656c 662e 726f 6f74 2e78 6772 6964   self.root.xgrid
-0001a8d0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-0001a8e0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0001a8f0: 6f74 2e78 6178 6973 2e6d 696e 6f72 5f74  ot.xaxis.minor_t
-0001a900: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
-0001a910: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-0001a920: 726f 6f74 2e78 6178 6973 2e76 6973 6962  root.xaxis.visib
-0001a930: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
-0001a940: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-0001a950: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
-0001a960: 2020 2070 6f69 6e74 5f70 6f6c 6963 793d     point_policy=
-0001a970: 2266 6f6c 6c6f 775f 6d6f 7573 6522 2c0a  "follow_mouse",.
-0001a980: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-0001a990: 7469 7073 3d22 2222 0a20 2020 2020 2020  tips=""".       
-0001a9a0: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-0001a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9c0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-0001a9d0: 666f 6e74 2d73 697a 653a 2031 3470 783b  font-size: 14px;
-0001a9e0: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-0001a9f0: 6c64 3b22 3e4e 616d 653a 3c2f 7370 616e  ld;">Name:</span
-0001aa00: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-0001aa10: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-0001aa20: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-0001aa30: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-0001aa40: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-0001aa50: 6f6e 6f73 7061 6365 3b22 3e40 6e61 6d65  onospace;">@name
-0001aa60: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-0001aa70: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-0001aa80: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001aa90: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001aaa0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-0001aab0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-0001aac0: 2031 3470 783b 2066 6f6e 742d 7765 6967   14px; font-weig
-0001aad0: 6874 3a20 626f 6c64 3b22 3e41 6c6c 3a3c  ht: bold;">All:<
-0001aae0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
-0001aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab00: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-0001ab10: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-0001ab20: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-0001ab30: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-0001ab40: 4061 6c6c 3c2f 7370 616e 3e0a 2020 2020  @all</span>.    
-0001ab50: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-0001ab60: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-0001ab70: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-0001ab80: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-0001ab90: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-0001aba0: 697a 653a 2031 3470 783b 2066 6f6e 742d  ize: 14px; font-
-0001abb0: 7765 6967 6874 3a20 626f 6c64 3b22 3e51  weight: bold;">Q
-0001abc0: 7565 7565 643a 3c2f 7370 616e 3e26 6e62  ueued:</span>&nb
-0001abd0: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
-0001abe0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-0001abf0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-0001ac00: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
-0001ac10: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
-0001ac20: 7061 6365 3b22 3e40 7175 6575 6564 3c2f  pace;">@queued</
-0001ac30: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-0001ac40: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
-0001ac50: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-0001ac60: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-0001ac70: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-0001ac80: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-0001ac90: 3470 783b 2066 6f6e 742d 7765 6967 6874  4px; font-weight
-0001aca0: 3a20 626f 6c64 3b22 3e4e 6f2d 776f 726b  : bold;">No-work
-0001acb0: 6572 3a3c 2f73 7061 6e3e 266e 6273 703b  er:</span>&nbsp;
-0001acc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001acd0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-0001ace0: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
-0001acf0: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
-0001ad00: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
-0001ad10: 653b 223e 406e 6f5f 776f 726b 6572 3c2f  e;">@no_worker</
-0001ad20: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-0001ad30: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
-0001ad40: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-0001ad50: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-0001ad60: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-0001ad70: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-0001ad80: 3470 783b 2066 6f6e 742d 7765 6967 6874  4px; font-weight
-0001ad90: 3a20 626f 6c64 3b22 3e50 726f 6365 7373  : bold;">Process
-0001ada0: 696e 673a 3c2f 7370 616e 3e26 6e62 7370  ing:</span>&nbsp
-0001adb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0001adc0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-0001add0: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
-0001ade0: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
-0001adf0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
-0001ae00: 6365 3b22 3e40 7072 6f63 6573 7369 6e67  ce;">@processing
-0001ae10: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-0001ae20: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-0001ae30: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001ae40: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001ae50: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-0001ae60: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-0001ae70: 2031 3470 783b 2066 6f6e 742d 7765 6967   14px; font-weig
-0001ae80: 6874 3a20 626f 6c64 3b22 3e4d 656d 6f72  ht: bold;">Memor
-0001ae90: 793a 3c2f 7370 616e 3e26 6e62 7370 3b0a  y:</span>&nbsp;.
-0001aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aeb0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-0001aec0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-0001aed0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-0001aee0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-0001aef0: 3b22 3e40 6d65 6d6f 7279 3c2f 7370 616e  ;">@memory</span
-0001af00: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0001af10: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-0001af20: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-0001af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af40: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-0001af50: 666f 6e74 2d73 697a 653a 2031 3470 783b  font-size: 14px;
-0001af60: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-0001af70: 6c64 3b22 3e45 7272 6564 3a3c 2f73 7061  ld;">Erred:</spa
-0001af80: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-0001af90: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-0001afa0: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-0001afb0: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
-0001afc0: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
-0001afd0: 6d6f 6e6f 7370 6163 653b 223e 4065 7272  monospace;">@err
-0001afe0: 6564 3c2f 7370 616e 3e0a 2020 2020 2020  ed</span>.      
-0001aff0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-0001b000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b010: 2022 2222 2c0a 2020 2020 2020 2020 290a   """,.        ).
-0001b020: 2020 2020 2020 2020 6865 6c70 5f20 3d20          help_ = 
-0001b030: 4865 6c70 546f 6f6c 280a 2020 2020 2020  HelpTool(.      
-0001b040: 2020 2020 2020 7265 6469 7265 6374 3d22        redirect="
-0001b050: 6874 7470 733a 2f2f 646f 6373 2e64 6173  https://docs.das
-0001b060: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
-0001b070: 6461 7368 626f 6172 642e 6874 6d6c 2370  dashboard.html#p
-0001b080: 726f 6772 6573 7322 2c0a 2020 2020 2020  rogress",.      
-0001b090: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
-0001b0a0: 6e3d 2241 2064 6573 6372 6970 7469 6f6e  n="A description
-0001b0b0: 206f 6620 7468 6520 7072 6f67 7265 7373   of the progress
-0001b0c0: 2062 6172 7320 706c 6f74 2e22 2c0a 2020   bars plot.",.  
-0001b0d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001b0e0: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
-0001b0f0: 6f6c 7328 686f 7665 722c 2068 656c 705f  ols(hover, help_
-0001b100: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-0001b110: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-0001b120: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-0001b130: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-0001b140: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-0001b150: 2020 7374 6174 6520 3d20 7b0a 2020 2020    state = {.    
-0001b160: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
-0001b170: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
-0001b180: 2020 2265 7272 6564 223a 207b 7d2c 0a20    "erred": {},. 
-0001b190: 2020 2020 2020 2020 2020 2022 7265 6c65             "rele
-0001b1a0: 6173 6564 223a 207b 7d2c 0a20 2020 2020  ased": {},.     
-0001b1b0: 2020 2020 2020 2022 7072 6f63 6573 7369         "processi
-0001b1c0: 6e67 223a 207b 7d2c 0a20 2020 2020 2020  ng": {},.       
-0001b1d0: 2020 2020 2022 7761 6974 696e 6722 3a20       "waiting": 
-0001b1e0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
-0001b1f0: 2271 7565 7565 6422 3a20 7b7d 2c0a 2020  "queued": {},.  
-0001b200: 2020 2020 2020 2020 2020 226e 6f5f 776f            "no_wo
-0001b210: 726b 6572 223a 207b 7d2c 0a20 2020 2020  rker": {},.     
-0001b220: 2020 207d 0a0a 2020 2020 2020 2020 666f     }..        fo
-0001b230: 7220 7470 2069 6e20 7365 6c66 2e73 6368  r tp in self.sch
-0001b240: 6564 756c 6572 2e74 6173 6b5f 7072 6566  eduler.task_pref
-0001b250: 6978 6573 2e76 616c 7565 7328 293a 0a20  ixes.values():. 
-0001b260: 2020 2020 2020 2020 2020 2061 6374 6976             activ
-0001b270: 655f 7374 6174 6573 203d 2074 702e 6163  e_states = tp.ac
-0001b280: 7469 7665 5f73 7461 7465 730a 2020 2020  tive_states.    
-0001b290: 2020 2020 2020 2020 6966 2061 6e79 2861          if any(a
-0001b2a0: 6374 6976 655f 7374 6174 6573 2e67 6574  ctive_states.get
-0001b2b0: 2873 2920 666f 7220 7320 696e 2073 7461  (s) for s in sta
-0001b2c0: 7465 2e6b 6579 7328 2929 3a0a 2020 2020  te.keys()):.    
-0001b2d0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-0001b2e0: 655b 226d 656d 6f72 7922 5d5b 7470 2e6e  e["memory"][tp.n
-0001b2f0: 616d 655d 203d 2061 6374 6976 655f 7374  ame] = active_st
-0001b300: 6174 6573 5b22 6d65 6d6f 7279 225d 0a20  ates["memory"]. 
-0001b310: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001b320: 7461 7465 5b22 6572 7265 6422 5d5b 7470  tate["erred"][tp
-0001b330: 2e6e 616d 655d 203d 2061 6374 6976 655f  .name] = active_
-0001b340: 7374 6174 6573 5b22 6572 7265 6422 5d0a  states["erred"].
-0001b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b360: 7374 6174 655b 2272 656c 6561 7365 6422  state["released"
-0001b370: 5d5b 7470 2e6e 616d 655d 203d 2061 6374  ][tp.name] = act
-0001b380: 6976 655f 7374 6174 6573 5b22 7265 6c65  ive_states["rele
-0001b390: 6173 6564 225d 0a20 2020 2020 2020 2020  ased"].         
-0001b3a0: 2020 2020 2020 2073 7461 7465 5b22 7072         state["pr
-0001b3b0: 6f63 6573 7369 6e67 225d 5b74 702e 6e61  ocessing"][tp.na
-0001b3c0: 6d65 5d20 3d20 6163 7469 7665 5f73 7461  me] = active_sta
-0001b3d0: 7465 735b 2270 726f 6365 7373 696e 6722  tes["processing"
-0001b3e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001b3f0: 2020 7374 6174 655b 2277 6169 7469 6e67    state["waiting
-0001b400: 225d 5b74 702e 6e61 6d65 5d20 3d20 6163  "][tp.name] = ac
-0001b410: 7469 7665 5f73 7461 7465 735b 2277 6169  tive_states["wai
-0001b420: 7469 6e67 225d 0a20 2020 2020 2020 2020  ting"].         
-0001b430: 2020 2020 2020 2073 7461 7465 5b22 7175         state["qu
-0001b440: 6575 6564 225d 5b74 702e 6e61 6d65 5d20  eued"][tp.name] 
-0001b450: 3d20 6163 7469 7665 5f73 7461 7465 735b  = active_states[
-0001b460: 2271 7565 7565 6422 5d0a 2020 2020 2020  "queued"].      
-0001b470: 2020 2020 2020 2020 2020 7374 6174 655b            state[
-0001b480: 226e 6f5f 776f 726b 6572 225d 5b74 702e  "no_worker"][tp.
-0001b490: 6e61 6d65 5d20 3d20 6163 7469 7665 5f73  name] = active_s
-0001b4a0: 7461 7465 735b 226e 6f2d 776f 726b 6572  tates["no-worker
-0001b4b0: 225d 0a0a 2020 2020 2020 2020 7374 6174  "]..        stat
-0001b4c0: 655b 2261 6c6c 225d 203d 207b 6b3a 2073  e["all"] = {k: s
-0001b4d0: 756d 2876 5b6b 5d20 666f 7220 7620 696e  um(v[k] for v in
-0001b4e0: 2073 7461 7465 2e76 616c 7565 7328 2929   state.values())
-0001b4f0: 2066 6f72 206b 2069 6e20 7374 6174 655b   for k in state[
-0001b500: 226d 656d 6f72 7922 5d7d 0a0a 2020 2020  "memory"]}..    
-0001b510: 2020 2020 6966 206e 6f74 2073 7461 7465      if not state
-0001b520: 5b22 616c 6c22 5d20 616e 6420 6e6f 7420  ["all"] and not 
-0001b530: 6c65 6e28 7365 6c66 2e73 6f75 7263 652e  len(self.source.
-0001b540: 6461 7461 5b22 616c 6c22 5d29 3a0a 2020  data["all"]):.  
-0001b550: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001b560: 0a0a 2020 2020 2020 2020 6420 3d20 7072  ..        d = pr
-0001b570: 6f67 7265 7373 5f71 7561 6473 2873 7461  ogress_quads(sta
-0001b580: 7465 290a 0a20 2020 2020 2020 2075 7064  te)..        upd
-0001b590: 6174 6528 7365 6c66 2e73 6f75 7263 652c  ate(self.source,
-0001b5a0: 2064 290a 0a20 2020 2020 2020 2074 6f74   d)..        tot
-0001b5b0: 616c 7320 3d20 7b0a 2020 2020 2020 2020  als = {.        
-0001b5c0: 2020 2020 6b3a 2073 756d 2873 7461 7465      k: sum(state
-0001b5d0: 5b6b 5d2e 7661 6c75 6573 2829 290a 2020  [k].values()).  
-0001b5e0: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
-0001b5f0: 696e 205b 0a20 2020 2020 2020 2020 2020  in [.           
-0001b600: 2020 2020 2022 616c 6c22 2c0a 2020 2020       "all",.    
-0001b610: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-0001b620: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
-0001b630: 2020 2020 2020 2265 7272 6564 222c 0a20        "erred",. 
-0001b640: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001b650: 7265 6c65 6173 6564 222c 0a20 2020 2020  released",.     
-0001b660: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
-0001b670: 696e 6722 2c0a 2020 2020 2020 2020 2020  ing",.          
-0001b680: 2020 2020 2020 2271 7565 7565 6422 2c0a        "queued",.
-0001b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6a0: 226e 6f5f 776f 726b 6572 222c 0a20 2020  "no_worker",.   
-0001b6b0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-0001b6c0: 2020 207d 0a20 2020 2020 2020 2074 6f74     }.        tot
-0001b6d0: 616c 735b 2270 726f 6365 7373 696e 6722  als["processing"
-0001b6e0: 5d20 3d20 746f 7461 6c73 5b22 616c 6c22  ] = totals["all"
-0001b6f0: 5d20 2d20 7375 6d28 0a20 2020 2020 2020  ] - sum(.       
-0001b700: 2020 2020 2076 2066 6f72 206b 2c20 7620       v for k, v 
-0001b710: 696e 2074 6f74 616c 732e 6974 656d 7328  in totals.items(
-0001b720: 2920 6966 206b 2021 3d20 2261 6c6c 220a  ) if k != "all".
-0001b730: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001b740: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
-0001b750: 6c65 2e74 6578 7420 3d20 280a 2020 2020  le.text = (.    
-0001b760: 2020 2020 2020 2020 2250 726f 6772 6573          "Progres
-0001b770: 7320 2d2d 2074 6f74 616c 3a20 2528 616c  s -- total: %(al
-0001b780: 6c29 732c 2022 0a20 2020 2020 2020 2020  l)s, ".         
-0001b790: 2020 2022 7761 6974 696e 673a 2025 2877     "waiting: %(w
-0001b7a0: 6169 7469 6e67 2973 2c20 220a 2020 2020  aiting)s, ".    
-0001b7b0: 2020 2020 2020 2020 2271 7565 7565 643a          "queued:
-0001b7c0: 2025 2871 7565 7565 6429 732c 2022 0a20   %(queued)s, ". 
-0001b7d0: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
-0001b7e0: 6573 7369 6e67 3a20 2528 7072 6f63 6573  essing: %(proces
-0001b7f0: 7369 6e67 2973 2c20 220a 2020 2020 2020  sing)s, ".      
-0001b800: 2020 2020 2020 2269 6e2d 6d65 6d6f 7279        "in-memory
-0001b810: 3a20 2528 6d65 6d6f 7279 2973 2c20 220a  : %(memory)s, ".
-0001b820: 2020 2020 2020 2020 2020 2020 226e 6f2d              "no-
-0001b830: 776f 726b 6572 3a20 2528 6e6f 5f77 6f72  worker: %(no_wor
-0001b840: 6b65 7229 732c 2022 0a20 2020 2020 2020  ker)s, ".       
-0001b850: 2020 2020 2022 6572 7265 643a 2025 2865       "erred: %(e
-0001b860: 7272 6564 2973 2220 2520 746f 7461 6c73  rred)s" % totals
-0001b870: 0a20 2020 2020 2020 2029 0a0a 0a63 6c61  .        )...cla
-0001b880: 7373 2043 6f6e 7465 6e74 696f 6e28 4461  ss Contention(Da
-0001b890: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-0001b8a0: 293a 0a20 2020 2022 2222 0a20 2020 2045  ):.    """.    E
-0001b8b0: 7665 6e74 204c 6f6f 7020 4865 616c 7468  vent Loop Health
-0001b8c0: 2028 616e 6420 4749 4c20 436f 6e74 656e   (and GIL Conten
-0001b8d0: 7469 6f6e 2c20 6966 2063 6f6e 6669 6775  tion, if configu
-0001b8e0: 7265 6429 0a20 2020 2022 2222 0a0a 2020  red).    """..  
-0001b8f0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-0001b900: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0001b910: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
-0001b920: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0001b930: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-0001b940: 7220 3d20 7363 6865 6475 6c65 720a 2020  r = scheduler.  
-0001b950: 2020 2020 2020 7365 6c66 2e64 6174 6120        self.data 
-0001b960: 3d20 6469 6374 280a 2020 2020 2020 2020  = dict(.        
-0001b970: 2020 2020 6e61 6d65 733d 5b0a 2020 2020      names=[.    
-0001b980: 2020 2020 2020 2020 2020 2020 2822 5363              ("Sc
-0001b990: 6865 6475 6c65 7222 2c20 2245 7665 6e74  heduler", "Event
-0001b9a0: 204c 6f6f 7022 292c 0a20 2020 2020 2020   Loop"),.       
-0001b9b0: 2020 2020 2020 2020 2028 2253 6368 6564           ("Sched
-0001b9c0: 756c 6572 222c 2022 4749 4c20 436f 6e74  uler", "GIL Cont
-0001b9d0: 656e 7469 6f6e 2229 2c0a 2020 2020 2020  ention"),.      
-0001b9e0: 2020 2020 2020 2020 2020 2822 576f 726b            ("Work
-0001b9f0: 6572 7322 2c20 2245 7665 6e74 204c 6f6f  ers", "Event Loo
-0001ba00: 7022 292c 0a20 2020 2020 2020 2020 2020  p"),.           
-0001ba10: 2020 2020 2028 2257 6f72 6b65 7273 222c       ("Workers",
-0001ba20: 2022 4749 4c20 436f 6e74 656e 7469 6f6e   "GIL Contention
-0001ba30: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0001ba40: 5d2c 0a20 2020 2020 2020 2020 2020 2076  ],.            v
-0001ba50: 616c 7565 733d 5b30 2c20 302c 2030 2c20  alues=[0, 0, 0, 
-0001ba60: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-0001ba70: 7465 7874 3d5b 2230 7322 2c20 2230 2522  text=["0s", "0%"
-0001ba80: 2c20 2230 7322 2c20 2230 2522 5d2c 0a20  , "0s", "0%"],. 
-0001ba90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001baa0: 2074 6974 6c65 203d 2022 4576 656e 7420   title = "Event 
-0001bab0: 4c6f 6f70 2026 2047 494c 2043 6f6e 7465  Loop & GIL Conte
-0001bac0: 6e74 696f 6e22 0a0a 2020 2020 2020 2020  ntion"..        
-0001bad0: 2320 5265 6d6f 7665 2047 494c 2072 656c  # Remove GIL rel
-0001bae0: 6174 6564 206e 616d 6573 2f76 616c 7565  ated names/value
-0001baf0: 7320 6966 206e 6f74 206d 6f6e 6974 6f72  s if not monitor
-0001bb00: 696e 6720 4749 4c0a 2020 2020 2020 2020  ing GIL.        
-0001bb10: 6966 206e 6f74 2073 656c 662e 7363 6865  if not self.sche
-0001bb20: 6475 6c65 722e 6d6f 6e69 746f 722e 6d6f  duler.monitor.mo
-0001bb30: 6e69 746f 725f 6769 6c5f 636f 6e74 656e  nitor_gil_conten
-0001bb40: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-0001bb50: 2020 7469 746c 6520 3d20 2245 7665 6e74    title = "Event
-0001bb60: 204c 6f6f 7022 0a20 2020 2020 2020 2020   Loop".         
-0001bb70: 2020 2066 6f72 206b 6579 2069 6e20 7365     for key in se
-0001bb80: 6c66 2e64 6174 613a 0a20 2020 2020 2020  lf.data:.       
-0001bb90: 2020 2020 2020 2020 2073 656c 662e 6461           self.da
-0001bba0: 7461 5b6b 6579 5d20 3d20 7365 6c66 2e64  ta[key] = self.d
-0001bbb0: 6174 615b 6b65 795d 5b3a 3a32 5d0a 0a20  ata[key][::2].. 
-0001bbc0: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-0001bbd0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-0001bbe0: 6f75 7263 6528 6461 7461 3d73 656c 662e  ource(data=self.
-0001bbf0: 6461 7461 290a 2020 2020 2020 2020 7365  data).        se
-0001bc00: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
-0001bc10: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-0001bc20: 746c 653d 7469 746c 652c 0a20 2020 2020  tle=title,.     
-0001bc30: 2020 2020 2020 2078 5f72 616e 6765 3d46         x_range=F
-0001bc40: 6163 746f 7252 616e 6765 282a 7365 6c66  actorRange(*self
-0001bc50: 2e64 6174 615b 226e 616d 6573 225d 292c  .data["names"]),
-0001bc60: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
-0001bc70: 616e 6765 3d28 302c 2031 292c 0a20 2020  ange=(0, 1),.   
-0001bc80: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
-0001bc90: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-0001bca0: 6f6f 6c62 6172 5f6c 6f63 6174 696f 6e3d  oolbar_location=
-0001bcb0: 2261 626f 7665 222c 0a20 2020 2020 2020  "above",.       
-0001bcc0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0001bcd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001bce0: 2073 656c 662e 726f 6f74 2e76 6261 7228   self.root.vbar(
-0001bcf0: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-0001bd00: 6e61 6d65 7322 2c0a 2020 2020 2020 2020  names",.        
-0001bd10: 2020 2020 746f 703d 2276 616c 7565 7322      top="values"
-0001bd20: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
-0001bd30: 6474 683d 302e 392c 0a20 2020 2020 2020  dth=0.9,.       
-0001bd40: 2020 2020 206c 696e 655f 636f 6c6f 723d       line_color=
-0001bd50: 2277 6869 7465 222c 0a20 2020 2020 2020  "white",.       
-0001bd60: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0001bd70: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-0001bd80: 2020 2020 2066 696c 6c5f 636f 6c6f 723d       fill_color=
-0001bd90: 6661 6374 6f72 5f63 6d61 7028 0a20 2020  factor_cmap(.   
-0001bda0: 2020 2020 2020 2020 2020 2020 2066 6965               fie
-0001bdb0: 6c64 5f6e 616d 653d 226e 616d 6573 222c  ld_name="names",
-0001bdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bdd0: 2070 616c 6574 7465 3d5b 2223 6238 6530   palette=["#b8e0
-0001bde0: 6365 222c 2022 2338 3161 6165 3422 5d2c  ce", "#81aae4"],
-0001bdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001be00: 2066 6163 746f 7273 3d5b 2245 7665 6e74   factors=["Event
-0001be10: 204c 6f6f 7022 2c20 2247 494c 2043 6f6e   Loop", "GIL Con
-0001be20: 7465 6e74 696f 6e22 5d2c 0a20 2020 2020  tention"],.     
-0001be30: 2020 2020 2020 2020 2020 2073 7461 7274             start
-0001be40: 3d31 2c0a 2020 2020 2020 2020 2020 2020  =1,.            
-0001be50: 2020 2020 656e 643d 322c 0a20 2020 2020      end=2,.     
-0001be60: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0001be70: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0001be80: 662e 726f 6f74 2e78 5f72 616e 6765 2e67  f.root.x_range.g
-0001be90: 726f 7570 5f70 6164 6469 6e67 203d 2030  roup_padding = 0
-0001bea0: 2e32 350a 2020 2020 2020 2020 7365 6c66  .25.        self
-0001beb0: 2e72 6f6f 742e 7861 7869 732e 6d69 6e6f  .root.xaxis.mino
-0001bec0: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
-0001bed0: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
-0001bee0: 6c66 2e72 6f6f 742e 7967 7269 642e 7669  lf.root.ygrid.vi
-0001bef0: 7369 626c 6520 3d20 5472 7565 0a20 2020  sible = True.   
-0001bf00: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
-0001bf10: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
-0001bf20: 616c 7365 0a0a 2020 2020 2020 2020 686f  alse..        ho
-0001bf30: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
-0001bf40: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-0001bf50: 6c74 6970 733d 5b28 224e 616d 6522 2c20  ltips=[("Name", 
-0001bf60: 2240 6e61 6d65 7322 292c 2028 2256 616c  "@names"), ("Val
-0001bf70: 7565 222c 2022 4074 6578 7422 295d 2c20  ue", "@text")], 
-0001bf80: 6d6f 6465 3d22 766c 696e 6522 0a20 2020  mode="vline".   
-0001bf90: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001bfa0: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
-0001bfb0: 6c73 2868 6f76 6572 290a 0a20 2020 2040  ls(hover)..    @
-0001bfc0: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-0001bfd0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-0001bfe0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-0001bff0: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-0001c000: 3a0a 2020 2020 2020 2020 7320 3d20 7365  :.        s = se
-0001c010: 6c66 2e73 6368 6564 756c 6572 0a20 2020  lf.scheduler.   
-0001c020: 2020 2020 206d 6f6e 6974 6f72 5f67 696c       monitor_gil
-0001c030: 203d 2073 2e6d 6f6e 6974 6f72 2e6d 6f6e   = s.monitor.mon
-0001c040: 6974 6f72 5f67 696c 5f63 6f6e 7465 6e74  itor_gil_content
-0001c050: 696f 6e0a 0a20 2020 2020 2020 2073 656c  ion..        sel
-0001c060: 662e 6461 7461 5b22 7661 6c75 6573 225d  f.data["values"]
-0001c070: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001c080: 2073 2e5f 7469 636b 5f69 6e74 6572 7661   s._tick_interva
-0001c090: 6c5f 6f62 7365 7276 6564 2c0a 2020 2020  l_observed,.    
-0001c0a0: 2020 2020 2020 2020 7365 6c66 2e67 696c          self.gil
-0001c0b0: 5f63 6f6e 7465 6e74 696f 6e5f 7363 6865  _contention_sche
-0001c0c0: 6475 6c65 722c 0a20 2020 2020 2020 2020  duler,.         
-0001c0d0: 2020 2073 756d 2877 2e6d 6574 7269 6373     sum(w.metrics
-0001c0e0: 5b22 6576 656e 745f 6c6f 6f70 5f69 6e74  ["event_loop_int
-0001c0f0: 6572 7661 6c22 5d20 666f 7220 7720 696e  erval"] for w in
-0001c100: 2073 2e77 6f72 6b65 7273 2e76 616c 7565   s.workers.value
-0001c110: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-0001c120: 202f 2028 6c65 6e28 732e 776f 726b 6572   / (len(s.worker
-0001c130: 7329 206f 7220 3129 2c0a 2020 2020 2020  s) or 1),.      
-0001c140: 2020 2020 2020 7365 6c66 2e67 696c 5f63        self.gil_c
-0001c150: 6f6e 7465 6e74 696f 6e5f 776f 726b 6572  ontention_worker
-0001c160: 732c 0a20 2020 2020 2020 205d 5b3a 3a20  s,.        ][:: 
-0001c170: 3120 6966 206d 6f6e 6974 6f72 5f67 696c  1 if monitor_gil
-0001c180: 2065 6c73 6520 325d 0a0a 2020 2020 2020   else 2]..      
-0001c190: 2020 2320 466f 726d 6174 2065 7665 6e74    # Format event
-0001c1a0: 206c 6f6f 7020 6173 2074 696d 6520 616e   loop as time an
-0001c1b0: 6420 4749 4c20 2869 6620 636f 6e66 6967  d GIL (if config
-0001c1c0: 7572 6564 2920 6173 2025 0a20 2020 2020  ured) as %.     
-0001c1d0: 2020 2073 656c 662e 6461 7461 5b22 7465     self.data["te
-0001c1e0: 7874 225d 203d 205b 0a20 2020 2020 2020  xt"] = [.       
-0001c1f0: 2020 2020 2066 227b 7820 2a20 3130 303a       f"{x * 100:
-0001c200: 2e31 667d 2522 2069 6620 6920 2520 3220  .1f}%" if i % 2 
-0001c210: 616e 6420 6d6f 6e69 746f 725f 6769 6c20  and monitor_gil 
-0001c220: 656c 7365 2066 6f72 6d61 745f 7469 6d65  else format_time
-0001c230: 2878 290a 2020 2020 2020 2020 2020 2020  (x).            
-0001c240: 666f 7220 692c 2078 2069 6e20 656e 756d  for i, x in enum
-0001c250: 6572 6174 6528 7365 6c66 2e64 6174 615b  erate(self.data[
-0001c260: 2276 616c 7565 7322 5d29 0a20 2020 2020  "values"]).     
-0001c270: 2020 205d 0a20 2020 2020 2020 2075 7064     ].        upd
-0001c280: 6174 6528 7365 6c66 2e73 6f75 7263 652c  ate(self.source,
-0001c290: 2073 656c 662e 6461 7461 290a 0a20 2020   self.data)..   
-0001c2a0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0001c2b0: 6566 2067 696c 5f63 6f6e 7465 6e74 696f  ef gil_contentio
-0001c2c0: 6e5f 776f 726b 6572 7328 7365 6c66 2920  n_workers(self) 
-0001c2d0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-0001c2e0: 2020 776f 726b 6572 7320 3d20 7365 6c66    workers = self
-0001c2f0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-0001c300: 7273 0a20 2020 2020 2020 2069 6620 776f  rs.        if wo
-0001c310: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
-0001c320: 2020 2072 6574 7572 6e20 7375 6d28 0a20     return sum(. 
-0001c330: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001c340: 2e6d 6574 7269 6373 2e67 6574 2822 6769  .metrics.get("gi
-0001c350: 6c5f 636f 6e74 656e 7469 6f6e 222c 2030  l_contention", 0
-0001c360: 2920 666f 7220 7720 696e 2077 6f72 6b65  ) for w in worke
-0001c370: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
-0001c380: 2020 2020 2020 2020 2920 2f20 6c65 6e28          ) / len(
-0001c390: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
-0001c3a0: 2072 6574 7572 6e20 666c 6f61 7428 224e   return float("N
-0001c3b0: 614e 2229 0a0a 2020 2020 4070 726f 7065  aN")..    @prope
-0001c3c0: 7274 790a 2020 2020 6465 6620 6769 6c5f  rty.    def gil_
-0001c3d0: 636f 6e74 656e 7469 6f6e 5f73 6368 6564  contention_sched
-0001c3e0: 756c 6572 2873 656c 6629 202d 3e20 666c  uler(self) -> fl
-0001c3f0: 6f61 743a 0a20 2020 2020 2020 2072 6574  oat:.        ret
-0001c400: 7572 6e20 7365 6c66 2e73 6368 6564 756c  urn self.schedul
-0001c410: 6572 2e6d 6f6e 6974 6f72 2e72 6563 656e  er.monitor.recen
-0001c420: 7428 292e 6765 7428 2267 696c 5f63 6f6e  t().get("gil_con
-0001c430: 7465 6e74 696f 6e22 2c20 666c 6f61 7428  tention", float(
-0001c440: 224e 614e 2229 290a 0a0a 636c 6173 7320  "NaN"))...class 
-0001c450: 4578 6365 7074 696f 6e73 5461 626c 6528  ExceptionsTable(
-0001c460: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-0001c470: 6e74 293a 0a20 2020 2022 2222 0a20 2020  nt):.    """.   
-0001c480: 2045 7863 6570 7469 6f6e 7320 6c6f 6767   Exceptions logg
-0001c490: 6564 2069 6e20 7461 736b 732e 0a0a 2020  ed in tasks...  
-0001c4a0: 2020 5369 6e63 6520 7468 6572 6520 6d69    Since there mi
-0001c4b0: 6768 7420 6265 206d 616e 7920 7265 6c61  ght be many rela
-0001c4c0: 7465 6420 6578 6365 7074 696f 6e73 2028  ted exceptions (
-0001c4d0: 652e 672e 2c20 616c 6c20 7461 736b 7320  e.g., all tasks 
-0001c4e0: 696e 2061 2067 6976 656e 0a20 2020 2074  in a given.    t
-0001c4f0: 6173 6b20 6772 6f75 7020 6661 696c 2066  ask group fail f
-0001c500: 6f72 2074 6865 2073 616d 6520 7265 6173  or the same reas
-0001c510: 6f6e 292c 2077 6520 6d61 6b65 2061 2062  on), we make a b
-0001c520: 6573 742d 6566 666f 7274 2061 7474 656d  est-effort attem
-0001c530: 7074 2074 6f0a 2020 2020 2831 2920 6167  pt to.    (1) ag
-0001c540: 6772 6567 6174 6520 746f 2074 6865 2074  gregate to the t
-0001c550: 6173 6b20 6772 6f75 702c 2061 6e64 2028  ask group, and (
-0001c560: 3229 2064 6564 7570 6c69 6361 7465 2073  2) deduplicate s
-0001c570: 696d 696c 6172 206c 6f6f 6b69 6e67 2074  imilar looking t
-0001c580: 6173 6b73 2e0a 2020 2020 2222 220a 0a20  asks..    """.. 
-0001c590: 2020 2073 6368 6564 756c 6572 3a20 5363     scheduler: Sc
-0001c5a0: 6865 6475 6c65 720a 0a20 2020 2064 6566  heduler..    def
-0001c5b0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0001c5c0: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
-0001c5d0: 756c 6572 2c20 7769 6474 683a 2069 6e74  uler, width: int
-0001c5e0: 203d 2031 3030 302c 202a 2a6b 7761 7267   = 1000, **kwarg
-0001c5f0: 733a 2041 6e79 293a 0a20 2020 2020 2020  s: Any):.       
-0001c600: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
-0001c610: 3d20 7363 6865 6475 6c65 720a 0a20 2020  = scheduler..   
-0001c620: 2020 2020 2073 656c 662e 6e61 6d65 7320       self.names 
-0001c630: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0001c640: 2254 6173 6b22 2c0a 2020 2020 2020 2020  "Task",.        
-0001c650: 2020 2020 2245 7863 6570 7469 6f6e 222c      "Exception",
-0001c660: 0a20 2020 2020 2020 2020 2020 2022 5472  .            "Tr
-0001c670: 6163 6562 6163 6b22 2c0a 2020 2020 2020  aceback",.      
-0001c680: 2020 2020 2020 2257 6f72 6b65 7228 7329        "Worker(s)
-0001c690: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0001c6a0: 436f 756e 7422 2c0a 2020 2020 2020 2020  Count",.        
-0001c6b0: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
-0001c6c0: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
-0001c6d0: 6174 6153 6f75 7263 6528 7b6b 3a20 5b5d  ataSource({k: []
-0001c6e0: 2066 6f72 206b 2069 6e20 7365 6c66 2e6e   for k in self.n
-0001c6f0: 616d 6573 7d29 0a0a 2020 2020 2020 2020  ames})..        
-0001c700: 636f 6465 5f66 6f72 6d61 7474 6572 203d  code_formatter =
-0001c710: 2048 544d 4c54 656d 706c 6174 6546 6f72   HTMLTemplateFor
-0001c720: 6d61 7474 6572 280a 2020 2020 2020 2020  matter(.        
-0001c730: 2020 2020 7465 6d70 6c61 7465 3d27 3c63      template='<c
-0001c740: 6f64 6520 7469 746c 653d 223c 252d 2076  ode title="<%- v
-0001c750: 616c 7565 2025 3e22 3e3c 253d 2076 616c  alue %>"><%= val
-0001c760: 7565 2025 3e3c 2f63 6f64 653e 270a 2020  ue %></code>'.  
-0001c770: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001c780: 636f 6c75 6d6e 7320 3d20 5b0a 2020 2020  columns = [.    
-0001c790: 2020 2020 2020 2020 5461 626c 6543 6f6c          TableCol
-0001c7a0: 756d 6e28 0a20 2020 2020 2020 2020 2020  umn(.           
-0001c7b0: 2020 2020 2066 6965 6c64 3d22 5461 736b       field="Task
-0001c7c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001c7d0: 2020 2074 6974 6c65 3d22 5461 736b 222c     title="Task",
-0001c7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c7f0: 2066 6f72 6d61 7474 6572 3d63 6f64 655f   formatter=code_
-0001c800: 666f 726d 6174 7465 722c 0a20 2020 2020  formatter,.     
-0001c810: 2020 2020 2020 2020 2020 2077 6964 7468             width
-0001c820: 3d31 3530 2c0a 2020 2020 2020 2020 2020  =150,.          
-0001c830: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-0001c840: 2054 6162 6c65 436f 6c75 6d6e 280a 2020   TableColumn(.  
-0001c850: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001c860: 656c 643d 2245 7863 6570 7469 6f6e 222c  eld="Exception",
-0001c870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c880: 2074 6974 6c65 3d22 4578 6365 7074 696f   title="Exceptio
-0001c890: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-0001c8a0: 2020 2020 666f 726d 6174 7465 723d 636f      formatter=co
-0001c8b0: 6465 5f66 6f72 6d61 7474 6572 2c0a 2020  de_formatter,.  
-0001c8c0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0001c8d0: 6474 683d 3330 302c 0a20 2020 2020 2020  dth=300,.       
-0001c8e0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0001c8f0: 2020 2020 5461 626c 6543 6f6c 756d 6e28      TableColumn(
-0001c900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c910: 2066 6965 6c64 3d22 5472 6163 6562 6163   field="Tracebac
-0001c920: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
-0001c930: 2020 2020 7469 746c 653d 2254 7261 6365      title="Trace
-0001c940: 6261 636b 222c 0a20 2020 2020 2020 2020  back",.         
-0001c950: 2020 2020 2020 2066 6f72 6d61 7474 6572         formatter
-0001c960: 3d63 6f64 655f 666f 726d 6174 7465 722c  =code_formatter,
-0001c970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c980: 2077 6964 7468 3d33 3030 2c0a 2020 2020   width=300,.    
-0001c990: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0001c9a0: 2020 2020 2020 2054 6162 6c65 436f 6c75         TableColu
-0001c9b0: 6d6e 280a 2020 2020 2020 2020 2020 2020  mn(.            
-0001c9c0: 2020 2020 6669 656c 643d 2257 6f72 6b65      field="Worke
-0001c9d0: 7228 7329 222c 0a20 2020 2020 2020 2020  r(s)",.         
-0001c9e0: 2020 2020 2020 2074 6974 6c65 3d22 576f         title="Wo
-0001c9f0: 726b 6572 2873 2922 2c0a 2020 2020 2020  rker(s)",.      
-0001ca00: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0001ca10: 7465 723d 636f 6465 5f66 6f72 6d61 7474  ter=code_formatt
-0001ca20: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0001ca30: 2020 2020 7769 6474 683d 3230 302c 0a20      width=200,. 
-0001ca40: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0001ca50: 2020 2020 2020 2020 2020 5461 626c 6543            TableC
-0001ca60: 6f6c 756d 6e28 0a20 2020 2020 2020 2020  olumn(.         
-0001ca70: 2020 2020 2020 2066 6965 6c64 3d22 436f         field="Co
-0001ca80: 756e 7422 2c0a 2020 2020 2020 2020 2020  unt",.          
-0001ca90: 2020 2020 2020 7469 746c 653d 2243 6f75        title="Cou
-0001caa0: 6e74 222c 0a20 2020 2020 2020 2020 2020  nt",.           
-0001cab0: 2020 2020 2066 6f72 6d61 7474 6572 3d4e       formatter=N
-0001cac0: 756d 6265 7246 6f72 6d61 7474 6572 2866  umberFormatter(f
-0001cad0: 6f72 6d61 743d 2230 2c30 2229 2c0a 2020  ormat="0,0"),.  
-0001cae0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0001caf0: 6474 683d 3530 2c0a 2020 2020 2020 2020  dth=50,.        
-0001cb00: 2020 2020 292c 0a20 2020 2020 2020 205d      ),.        ]
-0001cb10: 0a0a 2020 2020 2020 2020 6966 2022 7369  ..        if "si
-0001cb20: 7a69 6e67 5f6d 6f64 6522 2069 6e20 6b77  zing_mode" in kw
-0001cb30: 6172 6773 3a0a 2020 2020 2020 2020 2020  args:.          
-0001cb40: 2020 7369 7a69 6e67 5f6d 6f64 6520 3d20    sizing_mode = 
-0001cb50: 7b22 7369 7a69 6e67 5f6d 6f64 6522 3a20  {"sizing_mode": 
-0001cb60: 6b77 6172 6773 5b22 7369 7a69 6e67 5f6d  kwargs["sizing_m
-0001cb70: 6f64 6522 5d7d 0a20 2020 2020 2020 2065  ode"]}.        e
-0001cb80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001cb90: 2073 697a 696e 675f 6d6f 6465 203d 207b   sizing_mode = {
-0001cba0: 7d0a 2020 2020 2020 2020 7365 6c66 2e72  }.        self.r
-0001cbb0: 6f6f 7420 3d20 4461 7461 5461 626c 6528  oot = DataTable(
-0001cbc0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0001cbd0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0001cbe0: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-0001cbf0: 756d 6e73 3d63 6f6c 756d 6e73 2c0a 2020  umns=columns,.  
-0001cc00: 2020 2020 2020 2020 2020 7265 6f72 6465            reorde
-0001cc10: 7261 626c 653d 5472 7565 2c0a 2020 2020  rable=True,.    
-0001cc20: 2020 2020 2020 2020 736f 7274 6162 6c65          sortable
-0001cc30: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0001cc40: 2020 2077 6964 7468 3d77 6964 7468 2c0a     width=width,.
-0001cc50: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-0001cc60: 785f 706f 7369 7469 6f6e 3d4e 6f6e 652c  x_position=None,
-0001cc70: 0a20 2020 2020 2020 2020 2020 202a 2a5f  .            **_
-0001cc80: 4441 5441 5441 424c 455f 5354 594c 4553  DATATABLE_STYLES
-0001cc90: 4845 4554 535f 4b57 4152 4753 2c0a 2020  HEETS_KWARGS,.  
-0001cca0: 2020 2020 2020 2020 2020 2a2a 7369 7a69            **sizi
-0001ccb0: 6e67 5f6d 6f64 652c 0a20 2020 2020 2020  ng_mode,.       
-0001ccc0: 2029 0a0a 2020 2020 4077 6974 686f 7574   )..    @without
-0001ccd0: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
-0001cce0: 7469 6f6e 0a20 2020 2064 6566 2075 7064  tion.    def upd
-0001ccf0: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
-0001cd00: 2020 206e 6577 5f64 6174 6120 3d20 7b6e     new_data = {n
-0001cd10: 616d 653a 205b 5d20 666f 7220 6e61 6d65  ame: [] for name
-0001cd20: 2069 6e20 7365 6c66 2e6e 616d 6573 7d0a   in self.names}.
-0001cd30: 2020 2020 2020 2020 6572 7265 645f 7461          erred_ta
-0001cd40: 736b 7320 3d20 7365 6c66 2e73 6368 6564  sks = self.sched
-0001cd50: 756c 6572 2e65 7272 6564 5f74 6173 6b73  uler.erred_tasks
-0001cd60: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
-0001cd70: 2069 6e20 6572 7265 645f 7461 736b 733a   in erred_tasks:
-0001cd80: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-0001cd90: 5f64 6174 615b 2254 6173 6b22 5d2e 6170  _data["Task"].ap
-0001cda0: 7065 6e64 2874 732e 6b65 7929 0a20 2020  pend(ts.key).   
-0001cdb0: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
-0001cdc0: 615b 2245 7863 6570 7469 6f6e 225d 2e61  a["Exception"].a
-0001cdd0: 7070 656e 6428 7473 2e65 7863 6570 7469  ppend(ts.excepti
-0001cde0: 6f6e 5f74 6578 7429 0a20 2020 2020 2020  on_text).       
-0001cdf0: 2020 2020 206e 6577 5f64 6174 615b 2254       new_data["T
-0001ce00: 7261 6365 6261 636b 225d 2e61 7070 656e  raceback"].appen
-0001ce10: 6428 7473 2e74 7261 6365 6261 636b 5f74  d(ts.traceback_t
-0001ce20: 6578 7429 0a20 2020 2020 2020 2020 2020  ext).           
-0001ce30: 206e 6577 5f64 6174 615b 2257 6f72 6b65   new_data["Worke
-0001ce40: 7228 7329 225d 2e61 7070 656e 6428 222c  r(s)"].append(",
-0001ce50: 5c6e 222e 6a6f 696e 2874 732e 6572 7265  \n".join(ts.erre
-0001ce60: 645f 6f6e 2929 0a20 2020 2020 2020 2020  d_on)).         
-0001ce70: 2020 206e 6577 5f64 6174 615b 2243 6f75     new_data["Cou
-0001ce80: 6e74 225d 2e61 7070 656e 6428 6c65 6e28  nt"].append(len(
-0001ce90: 7473 2e65 7272 6564 5f6f 6e29 290a 0a20  ts.erred_on)).. 
-0001cea0: 2020 2020 2020 2075 7064 6174 6528 7365         update(se
-0001ceb0: 6c66 2e73 6f75 7263 652c 206e 6577 5f64  lf.source, new_d
-0001cec0: 6174 6129 0a0a 0a63 6c61 7373 2057 6f72  ata)...class Wor
-0001ced0: 6b65 7254 6162 6c65 2844 6173 6862 6f61  kerTable(Dashboa
-0001cee0: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
-0001cef0: 2020 2222 2253 7461 7475 7320 6f66 2074    """Status of t
-0001cf00: 6865 2063 7572 7265 6e74 2077 6f72 6b65  he current worke
-0001cf10: 7273 0a0a 2020 2020 5468 6973 2069 7320  rs..    This is 
-0001cf20: 7477 6f20 706c 6f74 732c 2061 2074 6578  two plots, a tex
-0001cf30: 742d 6261 7365 6420 7461 626c 6520 666f  t-based table fo
-0001cf40: 7220 6561 6368 2068 6f73 7420 616e 6420  r each host and 
-0001cf50: 6120 7468 696e 2068 6f72 697a 6f6e 7461  a thin horizonta
-0001cf60: 6c0a 2020 2020 706c 6f74 206c 6179 696e  l.    plot layin
-0001cf70: 6720 6f75 7420 686f 7374 7320 6279 2074  g out hosts by t
-0001cf80: 6865 6972 2063 7572 7265 6e74 206d 656d  heir current mem
-0001cf90: 6f72 7920 7573 652e 0a20 2020 2022 2222  ory use..    """
-0001cfa0: 0a0a 2020 2020 6578 636c 7564 6564 5f6e  ..    excluded_n
-0001cfb0: 616d 6573 203d 207b 0a20 2020 2020 2020  ames = {.       
-0001cfc0: 2022 6578 6563 7574 696e 6722 2c0a 2020   "executing",.  
-0001cfd0: 2020 2020 2020 2269 6e5f 666c 6967 6874        "in_flight
-0001cfe0: 222c 0a20 2020 2020 2020 2022 696e 5f6d  ",.        "in_m
-0001cff0: 656d 6f72 7922 2c0a 2020 2020 2020 2020  emory",.        
-0001d000: 2272 6561 6479 222c 0a20 2020 2020 2020  "ready",.       
-0001d010: 2022 7469 6d65 222c 0a20 2020 2020 2020   "time",.       
-0001d020: 2023 2055 7365 2073 6368 6564 756c 6572   # Use scheduler
-0001d030: 2e57 6f72 6b65 7253 7461 7465 2e6d 656d  .WorkerState.mem
-0001d040: 6f72 792e 6d61 6e61 6765 6420 696e 7374  ory.managed inst
-0001d050: 6561 6420 6f66 0a20 2020 2020 2020 2023  ead of.        #
-0001d060: 2073 6368 6564 756c 6572 2e57 6f72 6b65   scheduler.Worke
-0001d070: 7253 7461 7465 2e6d 6574 7269 6373 5b22  rState.metrics["
-0001d080: 6d61 6e61 6765 645f 6279 7465 7322 5d3b  managed_bytes"];
-0001d090: 2074 6865 2074 776f 206d 6561 7375 7265   the two measure
-0001d0a0: 7320 6172 6520 736c 6967 6874 6c79 0a20  s are slightly. 
-0001d0b0: 2020 2020 2020 2023 2064 6966 6665 7265         # differe
-0001d0c0: 6e74 2e20 5365 6520 6578 706c 616e 6174  nt. See explanat
-0001d0d0: 696f 6e20 696e 2073 6368 6564 756c 6572  ion in scheduler
-0001d0e0: 2e57 6f72 6b65 7253 7461 7465 2e6d 656d  .WorkerState.mem
-0001d0f0: 6f72 7928 292e 0a20 2020 2020 2020 2022  ory()..        "
-0001d100: 6d61 6e61 6765 645f 6279 7465 7322 2c0a  managed_bytes",.
-0001d110: 2020 2020 2020 2020 2273 7069 6c6c 6564          "spilled
-0001d120: 5f62 7974 6573 222c 0a20 2020 207d 0a0a  _bytes",.    }..
-0001d130: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0001d140: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-0001d150: 2c20 7769 6474 683d 3830 302c 202a 2a6b  , width=800, **k
-0001d160: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0001d170: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-0001d180: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
-0001d190: 2020 2073 656c 662e 6e61 6d65 7320 3d20     self.names = 
-0001d1a0: 5b0a 2020 2020 2020 2020 2020 2020 226e  [.            "n
-0001d1b0: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
-0001d1c0: 2020 2261 6464 7265 7373 222c 0a20 2020    "address",.   
-0001d1d0: 2020 2020 2020 2020 2022 6e74 6872 6561           "nthrea
-0001d1e0: 6473 222c 0a20 2020 2020 2020 2020 2020  ds",.           
-0001d1f0: 2022 6370 7522 2c0a 2020 2020 2020 2020   "cpu",.        
-0001d200: 2020 2020 226d 656d 6f72 7922 2c0a 2020      "memory",.  
-0001d210: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-0001d220: 795f 6c69 6d69 7422 2c0a 2020 2020 2020  y_limit",.      
-0001d230: 2020 2020 2020 226d 656d 6f72 795f 7065        "memory_pe
-0001d240: 7263 656e 7422 2c0a 2020 2020 2020 2020  rcent",.        
-0001d250: 2020 2020 226d 656d 6f72 795f 6d61 6e61      "memory_mana
-0001d260: 6765 6422 2c0a 2020 2020 2020 2020 2020  ged",.          
-0001d270: 2020 226d 656d 6f72 795f 756e 6d61 6e61    "memory_unmana
-0001d280: 6765 645f 6f6c 6422 2c0a 2020 2020 2020  ged_old",.      
-0001d290: 2020 2020 2020 226d 656d 6f72 795f 756e        "memory_un
-0001d2a0: 6d61 6e61 6765 645f 7265 6365 6e74 222c  managed_recent",
-0001d2b0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-0001d2c0: 6d6f 7279 5f73 7069 6c6c 6564 222c 0a20  mory_spilled",. 
-0001d2d0: 2020 2020 2020 2020 2020 2022 6e75 6d5f             "num_
-0001d2e0: 6664 7322 2c0a 2020 2020 2020 2020 2020  fds",.          
-0001d2f0: 2020 2268 6f73 745f 6e65 745f 696f 2e72    "host_net_io.r
-0001d300: 6561 645f 6270 7322 2c0a 2020 2020 2020  ead_bps",.      
-0001d310: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
-0001d320: 696f 2e77 7269 7465 5f62 7073 222c 0a20  io.write_bps",. 
-0001d330: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-0001d340: 5f64 6973 6b5f 696f 2e72 6561 645f 6270  _disk_io.read_bp
-0001d350: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0001d360: 2268 6f73 745f 6469 736b 5f69 6f2e 7772  "host_disk_io.wr
-0001d370: 6974 655f 6270 7322 2c0a 2020 2020 2020  ite_bps",.      
-0001d380: 2020 2020 2020 2263 7075 5f66 7261 6374        "cpu_fract
-0001d390: 696f 6e22 2c0a 2020 2020 2020 2020 5d0a  ion",.        ].
-0001d3a0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-0001d3b0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-0001d3c0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0001d3d0: 290a 2020 2020 2020 2020 7365 6c66 2e65  ).        self.e
-0001d3e0: 7874 7261 5f6e 616d 6573 203d 2073 6f72  xtra_names = sor
-0001d3f0: 7465 6428 0a20 2020 2020 2020 2020 2020  ted(.           
-0001d400: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0001d410: 2020 206d 0a20 2020 2020 2020 2020 2020     m.           
-0001d420: 2020 2020 2066 6f72 2077 7320 696e 2077       for ws in w
-0001d430: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-0001d440: 2020 2020 2020 2066 6f72 206d 2c20 7620         for m, v 
-0001d450: 696e 2077 732e 6d65 7472 6963 732e 6974  in ws.metrics.it
-0001d460: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-0001d470: 2020 2020 2020 6966 206d 206e 6f74 2069        if m not i
-0001d480: 6e20 7365 6c66 2e6e 616d 6573 2061 6e64  n self.names and
-0001d490: 2069 7369 6e73 7461 6e63 6528 762c 2028   isinstance(v, (
-0001d4a0: 7374 722c 2069 6e74 2c20 666c 6f61 7429  str, int, float)
-0001d4b0: 290a 2020 2020 2020 2020 2020 2020 7d0a  ).            }.
-0001d4c0: 2020 2020 2020 2020 2020 2020 2d20 7365              - se
-0001d4d0: 6c66 2e65 7863 6c75 6465 645f 6e61 6d65  lf.excluded_name
-0001d4e0: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
-0001d4f0: 2020 2020 2074 6162 6c65 5f6e 616d 6573       table_names
-0001d500: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001d510: 2022 6e61 6d65 222c 0a20 2020 2020 2020   "name",.       
-0001d520: 2020 2020 2022 6164 6472 6573 7322 2c0a       "address",.
-0001d530: 2020 2020 2020 2020 2020 2020 226e 7468              "nth
-0001d540: 7265 6164 7322 2c0a 2020 2020 2020 2020  reads",.        
-0001d550: 2020 2020 2263 7075 222c 0a20 2020 2020      "cpu",.     
-0001d560: 2020 2020 2020 2022 6d65 6d6f 7279 222c         "memory",
-0001d570: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-0001d580: 6d6f 7279 5f6c 696d 6974 222c 0a20 2020  mory_limit",.   
-0001d590: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-0001d5a0: 5f70 6572 6365 6e74 222c 0a20 2020 2020  _percent",.     
-0001d5b0: 2020 2020 2020 2022 6d65 6d6f 7279 5f6d         "memory_m
-0001d5c0: 616e 6167 6564 222c 0a20 2020 2020 2020  anaged",.       
-0001d5d0: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
-0001d5e0: 616e 6167 6564 5f6f 6c64 222c 0a20 2020  anaged_old",.   
-0001d5f0: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-0001d600: 5f75 6e6d 616e 6167 6564 5f72 6563 656e  _unmanaged_recen
-0001d610: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0001d620: 226d 656d 6f72 795f 7370 696c 6c65 6422  "memory_spilled"
-0001d630: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-0001d640: 756d 5f66 6473 222c 0a20 2020 2020 2020  um_fds",.       
-0001d650: 2020 2020 2022 686f 7374 5f6e 6574 5f69       "host_net_i
-0001d660: 6f2e 7265 6164 5f62 7073 222c 0a20 2020  o.read_bps",.   
-0001d670: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
-0001d680: 6574 5f69 6f2e 7772 6974 655f 6270 7322  et_io.write_bps"
-0001d690: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-0001d6a0: 6f73 745f 6469 736b 5f69 6f2e 7265 6164  ost_disk_io.read
-0001d6b0: 5f62 7073 222c 0a20 2020 2020 2020 2020  _bps",.         
-0001d6c0: 2020 2022 686f 7374 5f64 6973 6b5f 696f     "host_disk_io
-0001d6d0: 2e77 7269 7465 5f62 7073 222c 0a20 2020  .write_bps",.   
-0001d6e0: 2020 2020 205d 0a20 2020 2020 2020 2063       ].        c
-0001d6f0: 6f6c 756d 6e5f 7469 746c 655f 7265 6e61  olumn_title_rena
-0001d700: 6d65 7320 3d20 7b0a 2020 2020 2020 2020  mes = {.        
-0001d710: 2020 2020 226d 656d 6f72 795f 6c69 6d69      "memory_limi
-0001d720: 7422 3a20 226c 696d 6974 222c 0a20 2020  t": "limit",.   
-0001d730: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-0001d740: 5f70 6572 6365 6e74 223a 2022 6d65 6d6f  _percent": "memo
-0001d750: 7279 2025 222c 0a20 2020 2020 2020 2020  ry %",.         
-0001d760: 2020 2022 6d65 6d6f 7279 5f6d 616e 6167     "memory_manag
-0001d770: 6564 223a 2022 6d61 6e61 6765 6422 2c0a  ed": "managed",.
-0001d780: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-0001d790: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
-0001d7a0: 6422 3a20 2275 6e6d 616e 6167 6564 206f  d": "unmanaged o
-0001d7b0: 6c64 222c 0a20 2020 2020 2020 2020 2020  ld",.           
-0001d7c0: 2022 6d65 6d6f 7279 5f75 6e6d 616e 6167   "memory_unmanag
-0001d7d0: 6564 5f72 6563 656e 7422 3a20 2275 6e6d  ed_recent": "unm
-0001d7e0: 616e 6167 6564 2072 6563 656e 7422 2c0a  anaged recent",.
-0001d7f0: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-0001d800: 6f72 795f 7370 696c 6c65 6422 3a20 2273  ory_spilled": "s
-0001d810: 7069 6c6c 6564 222c 0a20 2020 2020 2020  pilled",.       
-0001d820: 2020 2020 2022 6e75 6d5f 6664 7322 3a20       "num_fds": 
-0001d830: 2223 2066 6473 222c 0a20 2020 2020 2020  "# fds",.       
-0001d840: 2020 2020 2022 686f 7374 5f6e 6574 5f69       "host_net_i
-0001d850: 6f2e 7265 6164 5f62 7073 223a 2022 6e65  o.read_bps": "ne
-0001d860: 7420 7265 6164 222c 0a20 2020 2020 2020  t read",.       
-0001d870: 2020 2020 2022 686f 7374 5f6e 6574 5f69       "host_net_i
-0001d880: 6f2e 7772 6974 655f 6270 7322 3a20 226e  o.write_bps": "n
-0001d890: 6574 2077 7269 7465 222c 0a20 2020 2020  et write",.     
-0001d8a0: 2020 2020 2020 2022 686f 7374 5f64 6973         "host_dis
-0001d8b0: 6b5f 696f 2e72 6561 645f 6270 7322 3a20  k_io.read_bps": 
-0001d8c0: 2264 6973 6b20 7265 6164 222c 0a20 2020  "disk read",.   
-0001d8d0: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
-0001d8e0: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
-0001d8f0: 223a 2022 6469 736b 2077 7269 7465 222c  ": "disk write",
-0001d900: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0001d910: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
-0001d920: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-0001d930: 6365 287b 6b3a 205b 5d20 666f 7220 6b20  ce({k: [] for k 
-0001d940: 696e 2073 656c 662e 6e61 6d65 737d 290a  in self.names}).
-0001d950: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-0001d960: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0001d970: 206e 616d 653a 2054 6162 6c65 436f 6c75   name: TableColu
-0001d980: 6d6e 2866 6965 6c64 3d6e 616d 652c 2074  mn(field=name, t
-0001d990: 6974 6c65 3d63 6f6c 756d 6e5f 7469 746c  itle=column_titl
-0001d9a0: 655f 7265 6e61 6d65 732e 6765 7428 6e61  e_renames.get(na
-0001d9b0: 6d65 2c20 6e61 6d65 2929 0a20 2020 2020  me, name)).     
-0001d9c0: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
-0001d9d0: 696e 2074 6162 6c65 5f6e 616d 6573 0a20  in table_names. 
-0001d9e0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0001d9f0: 2020 666f 726d 6174 7465 7273 203d 207b    formatters = {
-0001da00: 0a20 2020 2020 2020 2020 2020 2022 6370  .            "cp
-0001da10: 7522 3a20 4e75 6d62 6572 466f 726d 6174  u": NumberFormat
-0001da20: 7465 7228 666f 726d 6174 3d22 3020 2522  ter(format="0 %"
-0001da30: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
-0001da40: 6d65 6d6f 7279 5f70 6572 6365 6e74 223a  memory_percent":
-0001da50: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
-0001da60: 2866 6f72 6d61 743d 2230 2e30 2025 2229  (format="0.0 %")
-0001da70: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-0001da80: 656d 6f72 7922 3a20 4e75 6d62 6572 466f  emory": NumberFo
-0001da90: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-0001daa0: 302e 3020 6222 292c 0a20 2020 2020 2020  0.0 b"),.       
-0001dab0: 2020 2020 2022 6d65 6d6f 7279 5f6c 696d       "memory_lim
-0001dac0: 6974 223a 204e 756d 6265 7246 6f72 6d61  it": NumberForma
-0001dad0: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
-0001dae0: 2062 2229 2c0a 2020 2020 2020 2020 2020   b"),.          
-0001daf0: 2020 226d 656d 6f72 795f 6d61 6e61 6765    "memory_manage
-0001db00: 6422 3a20 4e75 6d62 6572 466f 726d 6174  d": NumberFormat
-0001db10: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-0001db20: 6222 292c 0a20 2020 2020 2020 2020 2020  b"),.           
-0001db30: 2022 6d65 6d6f 7279 5f75 6e6d 616e 6167   "memory_unmanag
-0001db40: 6564 5f6f 6c64 223a 204e 756d 6265 7246  ed_old": NumberF
-0001db50: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-0001db60: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
-0001db70: 2020 2020 2020 226d 656d 6f72 795f 756e        "memory_un
-0001db80: 6d61 6e61 6765 645f 7265 6365 6e74 223a  managed_recent":
-0001db90: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
-0001dba0: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
-0001dbb0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-0001dbc0: 656d 6f72 795f 7370 696c 6c65 6422 3a20  emory_spilled": 
-0001dbd0: 4e75 6d62 6572 466f 726d 6174 7465 7228  NumberFormatter(
-0001dbe0: 666f 726d 6174 3d22 302e 3020 6222 292c  format="0.0 b"),
-0001dbf0: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-0001dc00: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
-0001dc10: 7073 223a 204e 756d 6265 7246 6f72 6d61  ps": NumberForma
-0001dc20: 7474 6572 2866 6f72 6d61 743d 2230 2062  tter(format="0 b
-0001dc30: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0001dc40: 2268 6f73 745f 6e65 745f 696f 2e77 7269  "host_net_io.wri
-0001dc50: 7465 5f62 7073 223a 204e 756d 6265 7246  te_bps": NumberF
-0001dc60: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-0001dc70: 2230 2062 2229 2c0a 2020 2020 2020 2020  "0 b"),.        
-0001dc80: 2020 2020 226e 756d 5f66 6473 223a 204e      "num_fds": N
-0001dc90: 756d 6265 7246 6f72 6d61 7474 6572 2866  umberFormatter(f
-0001dca0: 6f72 6d61 743d 2230 2229 2c0a 2020 2020  ormat="0"),.    
-0001dcb0: 2020 2020 2020 2020 226e 7468 7265 6164          "nthread
-0001dcc0: 7322 3a20 4e75 6d62 6572 466f 726d 6174  s": NumberFormat
-0001dcd0: 7465 7228 666f 726d 6174 3d22 3022 292c  ter(format="0"),
-0001dce0: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-0001dcf0: 7374 5f64 6973 6b5f 696f 2e72 6561 645f  st_disk_io.read_
-0001dd00: 6270 7322 3a20 4e75 6d62 6572 466f 726d  bps": NumberForm
-0001dd10: 6174 7465 7228 666f 726d 6174 3d22 3020  atter(format="0 
-0001dd20: 6222 292c 0a20 2020 2020 2020 2020 2020  b"),.           
-0001dd30: 2022 686f 7374 5f64 6973 6b5f 696f 2e77   "host_disk_io.w
-0001dd40: 7269 7465 5f62 7073 223a 204e 756d 6265  rite_bps": Numbe
-0001dd50: 7246 6f72 6d61 7474 6572 2866 6f72 6d61  rFormatter(forma
-0001dd60: 743d 2230 2062 2229 2c0a 2020 2020 2020  t="0 b"),.      
-0001dd70: 2020 7d0a 0a20 2020 2020 2020 2074 6162    }..        tab
-0001dd80: 6c65 203d 2044 6174 6154 6162 6c65 280a  le = DataTable(.
-0001dd90: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0001dda0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-0001ddb0: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-0001ddc0: 6d6e 733d 5b63 6f6c 756d 6e73 5b6e 5d20  mns=[columns[n] 
-0001ddd0: 666f 7220 6e20 696e 2074 6162 6c65 5f6e  for n in table_n
-0001dde0: 616d 6573 5d2c 0a20 2020 2020 2020 2020  ames],.         
-0001ddf0: 2020 2072 656f 7264 6572 6162 6c65 3d54     reorderable=T
-0001de00: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0001de10: 2073 6f72 7461 626c 653d 5472 7565 2c0a   sortable=True,.
-0001de20: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-0001de30: 683d 7769 6474 682c 0a20 2020 2020 2020  h=width,.       
-0001de40: 2020 2020 2069 6e64 6578 5f70 6f73 6974       index_posit
-0001de50: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
-0001de60: 2020 2020 2020 2a2a 5f44 4154 4154 4142        **_DATATAB
-0001de70: 4c45 5f53 5459 4c45 5348 4545 5453 5f4b  LE_STYLESHEETS_K
-0001de80: 5741 5247 532c 0a20 2020 2020 2020 2029  WARGS,.        )
-0001de90: 0a0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
-0001dea0: 6d65 2069 6e20 7461 626c 655f 6e61 6d65  me in table_name
-0001deb0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0001dec0: 6620 6e61 6d65 2069 6e20 666f 726d 6174  f name in format
-0001ded0: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
-0001dee0: 2020 2020 2020 7461 626c 652e 636f 6c75        table.colu
-0001def0: 6d6e 735b 7461 626c 655f 6e61 6d65 732e  mns[table_names.
-0001df00: 696e 6465 7828 6e61 6d65 295d 2e66 6f72  index(name)].for
-0001df10: 6d61 7474 6572 203d 2066 6f72 6d61 7474  matter = formatt
-0001df20: 6572 735b 6e61 6d65 5d0a 0a20 2020 2020  ers[name]..     
-0001df30: 2020 2065 7874 7261 5f6e 616d 6573 203d     extra_names =
-0001df40: 205b 226e 616d 6522 2c20 2261 6464 7265   ["name", "addre
-0001df50: 7373 225d 202b 2073 656c 662e 6578 7472  ss"] + self.extr
-0001df60: 615f 6e61 6d65 730a 2020 2020 2020 2020  a_names.        
-0001df70: 6578 7472 615f 636f 6c75 6d6e 7320 3d20  extra_columns = 
-0001df80: 7b0a 2020 2020 2020 2020 2020 2020 6e61  {.            na
-0001df90: 6d65 3a20 5461 626c 6543 6f6c 756d 6e28  me: TableColumn(
-0001dfa0: 6669 656c 643d 6e61 6d65 2c20 7469 746c  field=name, titl
-0001dfb0: 653d 636f 6c75 6d6e 5f74 6974 6c65 5f72  e=column_title_r
-0001dfc0: 656e 616d 6573 2e67 6574 286e 616d 652c  enames.get(name,
-0001dfd0: 206e 616d 6529 290a 2020 2020 2020 2020   name)).        
-0001dfe0: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
-0001dff0: 6578 7472 615f 6e61 6d65 730a 2020 2020  extra_names.    
-0001e000: 2020 2020 7d0a 0a20 2020 2020 2020 2065      }..        e
-0001e010: 7874 7261 5f74 6162 6c65 203d 2044 6174  xtra_table = Dat
-0001e020: 6154 6162 6c65 280a 2020 2020 2020 2020  aTable(.        
-0001e030: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0001e040: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0001e050: 2020 2020 636f 6c75 6d6e 733d 5b65 7874      columns=[ext
-0001e060: 7261 5f63 6f6c 756d 6e73 5b6e 5d20 666f  ra_columns[n] fo
-0001e070: 7220 6e20 696e 2065 7874 7261 5f6e 616d  r n in extra_nam
-0001e080: 6573 5d2c 0a20 2020 2020 2020 2020 2020  es],.           
-0001e090: 2072 656f 7264 6572 6162 6c65 3d54 7275   reorderable=Tru
-0001e0a0: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
-0001e0b0: 6f72 7461 626c 653d 5472 7565 2c0a 2020  ortable=True,.  
-0001e0c0: 2020 2020 2020 2020 2020 7769 6474 683d            width=
-0001e0d0: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
-0001e0e0: 2020 2069 6e64 6578 5f70 6f73 6974 696f     index_positio
-0001e0f0: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
-0001e100: 2020 2020 2a2a 5f44 4154 4154 4142 4c45      **_DATATABLE
-0001e110: 5f53 5459 4c45 5348 4545 5453 5f4b 5741  _STYLESHEETS_KWA
-0001e120: 5247 532c 0a20 2020 2020 2020 2029 0a0a  RGS,.        )..
-0001e130: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
-0001e140: 2069 6e20 6578 7472 615f 6e61 6d65 733a   in extra_names:
-0001e150: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001e160: 6e61 6d65 2069 6e20 666f 726d 6174 7465  name in formatte
-0001e170: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0001e180: 2020 2020 6578 7472 615f 7461 626c 652e      extra_table.
-0001e190: 636f 6c75 6d6e 735b 6578 7472 615f 6e61  columns[extra_na
-0001e1a0: 6d65 732e 696e 6465 7828 6e61 6d65 295d  mes.index(name)]
-0001e1b0: 2e66 6f72 6d61 7474 6572 203d 2066 6f72  .formatter = for
-0001e1c0: 6d61 7474 6572 735b 0a20 2020 2020 2020  matters[.       
-0001e1d0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-0001e1e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001e1f0: 2020 5d0a 0a20 2020 2020 2020 2068 6f76    ]..        hov
-0001e200: 6572 203d 2048 6f76 6572 546f 6f6c 280a  er = HoverTool(.
-0001e210: 2020 2020 2020 2020 2020 2020 706f 696e              poin
-0001e220: 745f 706f 6c69 6379 3d22 666f 6c6c 6f77  t_policy="follow
-0001e230: 5f6d 6f75 7365 222c 0a20 2020 2020 2020  _mouse",.       
-0001e240: 2020 2020 2074 6f6f 6c74 6970 733d 2222       tooltips=""
-0001e250: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001e260: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
-0001e270: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-0001e280: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-0001e290: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
-0001e2a0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
-0001e2b0: 6f73 7061 6365 3b22 3e57 6f72 6b65 7220  ospace;">Worker 
-0001e2c0: 2840 6e61 6d65 293a 203c 2f73 7061 6e3e  (@name): </span>
-0001e2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e2e0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-0001e2f0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-0001e300: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-0001e310: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-0001e320: 223e 406d 656d 6f72 795f 7065 7263 656e  ">@memory_percen
-0001e330: 747b 302e 3020 257d 3c2f 7370 616e 3e0a  t{0.0 %}</span>.
-0001e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e350: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-0001e360: 2020 2020 2020 2022 2222 2c0a 2020 2020         """,.    
-0001e370: 2020 2020 290a 0a20 2020 2020 2020 206d      )..        m
-0001e380: 656d 5f70 6c6f 7420 3d20 6669 6775 7265  em_plot = figure
-0001e390: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-0001e3a0: 746c 653d 224d 656d 6f72 7920 5573 6520  tle="Memory Use 
-0001e3b0: 2825 2922 2c0a 2020 2020 2020 2020 2020  (%)",.          
-0001e3c0: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
-0001e3d0: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
-0001e3e0: 2020 2020 2078 5f72 616e 6765 3d28 302c       x_range=(0,
-0001e3f0: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
-0001e400: 2079 5f72 616e 6765 3d28 2d30 2e31 2c20   y_range=(-0.1, 
-0001e410: 302e 3129 2c0a 2020 2020 2020 2020 2020  0.1),.          
-0001e420: 2020 6865 6967 6874 3d36 302c 0a20 2020    height=60,.   
-0001e430: 2020 2020 2020 2020 2077 6964 7468 3d77           width=w
-0001e440: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-0001e450: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
-0001e460: 2020 2020 2020 2020 6d69 6e5f 626f 7264          min_bord
-0001e470: 6572 5f72 6967 6874 3d30 2c0a 2020 2020  er_right=0,.    
-0001e480: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0001e490: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0001e4a0: 2020 2020 6d65 6d5f 706c 6f74 2e63 6972      mem_plot.cir
-0001e4b0: 636c 6528 0a20 2020 2020 2020 2020 2020  cle(.           
-0001e4c0: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-0001e4d0: 7263 652c 2078 3d22 6d65 6d6f 7279 5f70  rce, x="memory_p
-0001e4e0: 6572 6365 6e74 222c 2079 3d30 2c20 7369  ercent", y=0, si
-0001e4f0: 7a65 3d31 302c 2066 696c 6c5f 616c 7068  ze=10, fill_alph
-0001e500: 613d 302e 350a 2020 2020 2020 2020 290a  a=0.5.        ).
-0001e510: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
-0001e520: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
-0001e530: 2046 616c 7365 0a20 2020 2020 2020 206d   False.        m
-0001e540: 656d 5f70 6c6f 742e 7961 7869 732e 6d69  em_plot.yaxis.mi
-0001e550: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
-0001e560: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-0001e570: 6d65 6d5f 706c 6f74 2e78 6178 6973 2e76  mem_plot.xaxis.v
-0001e580: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-0001e590: 2020 2020 2020 206d 656d 5f70 6c6f 742e         mem_plot.
-0001e5a0: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
-0001e5b0: 4661 6c73 650a 2020 2020 2020 2020 6d65  False.        me
-0001e5c0: 6d5f 706c 6f74 2e61 6464 5f74 6f6f 6c73  m_plot.add_tools
-0001e5d0: 2868 6f76 6572 2c20 426f 7853 656c 6563  (hover, BoxSelec
-0001e5e0: 7454 6f6f 6c28 2929 0a0a 2020 2020 2020  tTool())..      
-0001e5f0: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
-0001e600: 6f6f 6c28 0a20 2020 2020 2020 2020 2020  ool(.           
-0001e610: 2070 6f69 6e74 5f70 6f6c 6963 793d 2266   point_policy="f
-0001e620: 6f6c 6c6f 775f 6d6f 7573 6522 2c0a 2020  ollow_mouse",.  
-0001e630: 2020 2020 2020 2020 2020 746f 6f6c 7469            toolti
-0001e640: 7073 3d22 2222 0a20 2020 2020 2020 2020  ps=""".         
-0001e650: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
-0001e660: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001e670: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-0001e680: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-0001e690: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-0001e6a0: 2c20 6d6f 6e6f 7370 6163 653b 223e 576f  , monospace;">Wo
-0001e6b0: 726b 6572 2028 406e 616d 6529 3a20 3c2f  rker (@name): </
-0001e6c0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-0001e6d0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-0001e6e0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-0001e6f0: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
-0001e700: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
-0001e710: 7061 6365 3b22 3e40 6370 755f 6672 6163  pace;">@cpu_frac
-0001e720: 7469 6f6e 7b30 2025 7d3c 2f73 7061 6e3e  tion{0 %}</span>
-0001e730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e740: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
-0001e750: 2020 2020 2020 2020 2222 222c 0a20 2020          """,.   
-0001e760: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001e770: 6370 755f 706c 6f74 203d 2066 6967 7572  cpu_plot = figur
-0001e780: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-0001e790: 6974 6c65 3d22 4350 5520 5573 6520 2825  itle="CPU Use (%
-0001e7a0: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
-0001e7b0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-0001e7c0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-0001e7d0: 2020 2078 5f72 616e 6765 3d28 302c 2031     x_range=(0, 1
-0001e7e0: 292c 0a20 2020 2020 2020 2020 2020 2079  ),.            y
-0001e7f0: 5f72 616e 6765 3d28 2d30 2e31 2c20 302e  _range=(-0.1, 0.
-0001e800: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-0001e810: 6865 6967 6874 3d36 302c 0a20 2020 2020  height=60,.     
-0001e820: 2020 2020 2020 2077 6964 7468 3d77 6964         width=wid
-0001e830: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0001e840: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-0001e850: 2020 2020 2020 6d69 6e5f 626f 7264 6572        min_border
-0001e860: 5f72 6967 6874 3d30 2c0a 2020 2020 2020  _right=0,.      
-0001e870: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-0001e880: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001e890: 2020 6370 755f 706c 6f74 2e63 6972 636c    cpu_plot.circl
-0001e8a0: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
-0001e8b0: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-0001e8c0: 652c 2078 3d22 6370 755f 6672 6163 7469  e, x="cpu_fracti
-0001e8d0: 6f6e 222c 2079 3d30 2c20 7369 7a65 3d31  on", y=0, size=1
-0001e8e0: 302c 2066 696c 6c5f 616c 7068 613d 302e  0, fill_alpha=0.
-0001e8f0: 350a 2020 2020 2020 2020 290a 2020 2020  5.        ).    
-0001e900: 2020 2020 6370 755f 706c 6f74 2e79 6772      cpu_plot.ygr
-0001e910: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
-0001e920: 7365 0a20 2020 2020 2020 2063 7075 5f70  se.        cpu_p
-0001e930: 6c6f 742e 7961 7869 732e 6d69 6e6f 725f  lot.yaxis.minor_
-0001e940: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
-0001e950: 3d20 300a 2020 2020 2020 2020 6370 755f  = 0.        cpu_
-0001e960: 706c 6f74 2e78 6178 6973 2e76 6973 6962  plot.xaxis.visib
-0001e970: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-0001e980: 2020 2063 7075 5f70 6c6f 742e 7961 7869     cpu_plot.yaxi
-0001e990: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
-0001e9a0: 650a 2020 2020 2020 2020 6370 755f 706c  e.        cpu_pl
-0001e9b0: 6f74 2e61 6464 5f74 6f6f 6c73 2868 6f76  ot.add_tools(hov
-0001e9c0: 6572 2c20 426f 7853 656c 6563 7454 6f6f  er, BoxSelectToo
-0001e9d0: 6c28 2929 0a20 2020 2020 2020 2073 656c  l()).        sel
-0001e9e0: 662e 6370 755f 706c 6f74 203d 2063 7075  f.cpu_plot = cpu
-0001e9f0: 5f70 6c6f 740a 0a20 2020 2020 2020 2069  _plot..        i
-0001ea00: 6620 2273 697a 696e 675f 6d6f 6465 2220  f "sizing_mode" 
-0001ea10: 696e 206b 7761 7267 733a 0a20 2020 2020  in kwargs:.     
-0001ea20: 2020 2020 2020 2073 697a 696e 675f 6d6f         sizing_mo
-0001ea30: 6465 203d 207b 2273 697a 696e 675f 6d6f  de = {"sizing_mo
-0001ea40: 6465 223a 206b 7761 7267 735b 2273 697a  de": kwargs["siz
-0001ea50: 696e 675f 6d6f 6465 225d 7d0a 2020 2020  ing_mode"]}.    
-0001ea60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001ea70: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
-0001ea80: 6520 3d20 7b7d 0a0a 2020 2020 2020 2020  e = {}..        
-0001ea90: 636f 6d70 6f6e 656e 7473 203d 205b 6370  components = [cp
-0001eaa0: 755f 706c 6f74 2c20 6d65 6d5f 706c 6f74  u_plot, mem_plot
-0001eab0: 2c20 7461 626c 655d 0a20 2020 2020 2020  , table].       
-0001eac0: 2069 6620 7365 6c66 2e65 7874 7261 5f6e   if self.extra_n
-0001ead0: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
-0001eae0: 2020 636f 6d70 6f6e 656e 7473 2e61 7070    components.app
-0001eaf0: 656e 6428 6578 7472 615f 7461 626c 6529  end(extra_table)
-0001eb00: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0001eb10: 6f6f 7420 3d20 636f 6c75 6d6e 282a 636f  oot = column(*co
-0001eb20: 6d70 6f6e 656e 7473 2c20 2a2a 7369 7a69  mponents, **sizi
-0001eb30: 6e67 5f6d 6f64 6529 0a0a 2020 2020 4077  ng_mode)..    @w
-0001eb40: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
-0001eb50: 7661 6c69 6461 7469 6f6e 0a20 2020 2064  validation.    d
-0001eb60: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
-0001eb70: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
-0001eb80: 7b6e 616d 653a 205b 5d20 666f 7220 6e61  {name: [] for na
-0001eb90: 6d65 2069 6e20 7365 6c66 2e6e 616d 6573  me in self.names
-0001eba0: 202b 2073 656c 662e 6578 7472 615f 6e61   + self.extra_na
-0001ebb0: 6d65 737d 0a20 2020 2020 2020 2066 6f72  mes}.        for
-0001ebc0: 2069 2c20 7773 2069 6e20 656e 756d 6572   i, ws in enumer
-0001ebd0: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-0001ebe0: 2073 6f72 7465 6428 7365 6c66 2e73 6368   sorted(self.sch
-0001ebf0: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
-0001ec00: 616c 7565 7328 292c 206b 6579 3d6c 616d  alues(), key=lam
-0001ec10: 6264 6120 7773 3a20 7374 7228 7773 2e6e  bda ws: str(ws.n
-0001ec20: 616d 6529 290a 2020 2020 2020 2020 293a  ame)).        ):
-0001ec30: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
-0001ec40: 666f 203d 2077 732e 6d65 6d6f 7279 0a0a  fo = ws.memory..
-0001ec50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001ec60: 6e61 6d65 2069 6e20 7365 6c66 2e6e 616d  name in self.nam
-0001ec70: 6573 202b 2073 656c 662e 6578 7472 615f  es + self.extra_
-0001ec80: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
-0001ec90: 2020 2020 2020 2069 6620 222e 2220 696e         if "." in
-0001eca0: 206e 616d 653a 0a20 2020 2020 2020 2020   name:.         
-0001ecb0: 2020 2020 2020 2020 2020 206e 302c 205f             n0, _
-0001ecc0: 2c20 6e31 203d 206e 616d 652e 7061 7274  , n1 = name.part
-0001ecd0: 6974 696f 6e28 222e 2229 0a20 2020 2020  ition(".").     
-0001ece0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0001ecf0: 203d 2077 732e 6d65 7472 6963 732e 6765   = ws.metrics.ge
-0001ed00: 7428 6e30 2c20 7b7d 292e 6765 7428 6e31  t(n0, {}).get(n1
-0001ed10: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0001ed20: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed40: 2020 7620 3d20 7773 2e6d 6574 7269 6373    v = ws.metrics
-0001ed50: 2e67 6574 286e 616d 652c 204e 6f6e 6529  .get(name, None)
-0001ed60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ed70: 2064 6174 615b 6e61 6d65 5d2e 6170 7065   data[name].appe
-0001ed80: 6e64 2876 290a 0a20 2020 2020 2020 2020  nd(v)..         
-0001ed90: 2020 2064 6174 615b 226e 616d 6522 5d5b     data["name"][
-0001eda0: 2d31 5d20 3d20 7773 2e6e 616d 6520 6966  -1] = ws.name if
-0001edb0: 2077 732e 6e61 6d65 2069 7320 6e6f 7420   ws.name is not 
-0001edc0: 4e6f 6e65 2065 6c73 6520 690a 2020 2020  None else i.    
-0001edd0: 2020 2020 2020 2020 6461 7461 5b22 6164          data["ad
-0001ede0: 6472 6573 7322 5d5b 2d31 5d20 3d20 7773  dress"][-1] = ws
-0001edf0: 2e61 6464 7265 7373 0a20 2020 2020 2020  .address.       
-0001ee00: 2020 2020 2069 6620 7773 2e6d 656d 6f72       if ws.memor
-0001ee10: 795f 6c69 6d69 743a 0a20 2020 2020 2020  y_limit:.       
-0001ee20: 2020 2020 2020 2020 2064 6174 615b 226d           data["m
-0001ee30: 656d 6f72 795f 7065 7263 656e 7422 5d5b  emory_percent"][
-0001ee40: 2d31 5d20 3d20 7773 2e6d 6574 7269 6373  -1] = ws.metrics
-0001ee50: 5b22 6d65 6d6f 7279 225d 202f 2077 732e  ["memory"] / ws.
-0001ee60: 6d65 6d6f 7279 5f6c 696d 6974 0a20 2020  memory_limit.   
-0001ee70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001ee80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001ee90: 6174 615b 226d 656d 6f72 795f 7065 7263  ata["memory_perc
-0001eea0: 656e 7422 5d5b 2d31 5d20 3d20 2222 0a20  ent"][-1] = "". 
-0001eeb0: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-0001eec0: 226d 656d 6f72 795f 6c69 6d69 7422 5d5b  "memory_limit"][
-0001eed0: 2d31 5d20 3d20 7773 2e6d 656d 6f72 795f  -1] = ws.memory_
-0001eee0: 6c69 6d69 740a 2020 2020 2020 2020 2020  limit.          
-0001eef0: 2020 6461 7461 5b22 6d65 6d6f 7279 5f6d    data["memory_m
-0001ef00: 616e 6167 6564 225d 5b2d 315d 203d 206d  anaged"][-1] = m
-0001ef10: 696e 666f 2e6d 616e 6167 6564 0a20 2020  info.managed.   
-0001ef20: 2020 2020 2020 2020 2064 6174 615b 226d           data["m
-0001ef30: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-0001ef40: 6f6c 6422 5d5b 2d31 5d20 3d20 6d69 6e66  old"][-1] = minf
-0001ef50: 6f2e 756e 6d61 6e61 6765 645f 6f6c 640a  o.unmanaged_old.
-0001ef60: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001ef70: 5b22 6d65 6d6f 7279 5f75 6e6d 616e 6167  ["memory_unmanag
-0001ef80: 6564 5f72 6563 656e 7422 5d5b 2d31 5d20  ed_recent"][-1] 
-0001ef90: 3d20 6d69 6e66 6f2e 756e 6d61 6e61 6765  = minfo.unmanage
-0001efa0: 645f 7265 6365 6e74 0a20 2020 2020 2020  d_recent.       
-0001efb0: 2020 2020 2064 6174 615b 226d 656d 6f72       data["memor
-0001efc0: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
-0001efd0: 6e74 225d 5b2d 315d 203d 206d 696e 666f  nt"][-1] = minfo
-0001efe0: 2e75 6e6d 616e 6167 6564 5f72 6563 656e  .unmanaged_recen
-0001eff0: 740a 2020 2020 2020 2020 2020 2020 6461  t.            da
-0001f000: 7461 5b22 6d65 6d6f 7279 5f73 7069 6c6c  ta["memory_spill
-0001f010: 6564 225d 5b2d 315d 203d 206d 696e 666f  ed"][-1] = minfo
-0001f020: 2e73 7069 6c6c 6564 0a20 2020 2020 2020  .spilled.       
-0001f030: 2020 2020 2064 6174 615b 2263 7075 225d       data["cpu"]
-0001f040: 5b2d 315d 203d 2077 732e 6d65 7472 6963  [-1] = ws.metric
-0001f050: 735b 2263 7075 225d 202f 2031 3030 2e30  s["cpu"] / 100.0
-0001f060: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0001f070: 615b 2263 7075 5f66 7261 6374 696f 6e22  a["cpu_fraction"
-0001f080: 5d5b 2d31 5d20 3d20 7773 2e6d 6574 7269  ][-1] = ws.metri
-0001f090: 6373 5b22 6370 7522 5d20 2f20 3130 302e  cs["cpu"] / 100.
-0001f0a0: 3020 2f20 7773 2e6e 7468 7265 6164 730a  0 / ws.nthreads.
-0001f0b0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001f0c0: 5b22 6e74 6872 6561 6473 225d 5b2d 315d  ["nthreads"][-1]
-0001f0d0: 203d 2077 732e 6e74 6872 6561 6473 0a0a   = ws.nthreads..
-0001f0e0: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
-0001f0f0: 2069 6e20 7365 6c66 2e6e 616d 6573 202b   in self.names +
-0001f100: 2073 656c 662e 6578 7472 615f 6e61 6d65   self.extra_name
-0001f110: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0001f120: 6620 6e61 6d65 203d 3d20 226e 616d 6522  f name == "name"
-0001f130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f140: 2020 6461 7461 5b6e 616d 655d 2e69 6e73    data[name].ins
-0001f150: 6572 7428 302c 2066 2254 6f74 616c 2028  ert(0, f"Total (
-0001f160: 7b6c 656e 2864 6174 615b 6e61 6d65 5d29  {len(data[name])
-0001f170: 7d29 2229 0a20 2020 2020 2020 2020 2020  })").           
-0001f180: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0001f190: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0001f1a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001f1b0: 6620 6c65 6e28 7365 6c66 2e73 6368 6564  f len(self.sched
-0001f1c0: 756c 6572 2e77 6f72 6b65 7273 2920 3d3d  uler.workers) ==
-0001f1d0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0001f1e0: 2020 2020 2020 2020 746f 7461 6c5f 6461          total_da
-0001f1f0: 7461 203d 204e 6f6e 650a 2020 2020 2020  ta = None.      
-0001f200: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
-0001f210: 616d 6520 3d3d 2022 6d65 6d6f 7279 5f70  ame == "memory_p
-0001f220: 6572 6365 6e74 223a 0a20 2020 2020 2020  ercent":.       
-0001f230: 2020 2020 2020 2020 2020 2020 2074 6f74               tot
-0001f240: 616c 5f6d 656d 203d 2073 756d 280a 2020  al_mem = sum(.  
-0001f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f260: 2020 2020 2020 7773 2e6d 656d 6f72 795f        ws.memory_
-0001f270: 6c69 6d69 7420 666f 7220 7773 2069 6e20  limit for ws in 
-0001f280: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-0001f290: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
-0001f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001f2c0: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
-0001f2d0: 6461 7461 203d 2028 0a20 2020 2020 2020  data = (.       
-0001f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2f0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0001f300: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001f310: 756d 280a 2020 2020 2020 2020 2020 2020  um(.            
-0001f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f330: 2020 2020 7773 2e6d 6574 7269 6373 5b22      ws.metrics["
-0001f340: 6d65 6d6f 7279 225d 0a20 2020 2020 2020  memory"].       
-0001f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f360: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
-0001f370: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
-0001f380: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
-0001f390: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0001f3a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001f3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f3c0: 2020 2020 2020 2020 2020 2020 202f 2074               / t
-0001f3d0: 6f74 616c 5f6d 656d 0a20 2020 2020 2020  otal_mem.       
-0001f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3f0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0001f400: 2020 2020 2020 2020 2020 2069 6620 746f             if to
-0001f410: 7461 6c5f 6d65 6d0a 2020 2020 2020 2020  tal_mem.        
-0001f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f430: 656c 7365 2022 220a 2020 2020 2020 2020  else "".        
-0001f440: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001f450: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0001f460: 6966 206e 616d 6520 3d3d 2022 6370 7522  if name == "cpu"
-0001f470: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f480: 2020 2020 2020 746f 7461 6c5f 6461 7461        total_data
-0001f490: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-0001f4a0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-0001f4b0: 2877 732e 6d65 7472 6963 735b 2263 7075  (ws.metrics["cpu
-0001f4c0: 225d 2066 6f72 2077 7320 696e 2073 656c  "] for ws in sel
-0001f4d0: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-0001f4e0: 6572 732e 7661 6c75 6573 2829 290a 2020  ers.values()).  
-0001f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f500: 2020 2020 2020 2f20 3130 300a 2020 2020        / 100.    
-0001f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f520: 2020 2020 2f20 6c65 6e28 7365 6c66 2e73      / len(self.s
-0001f530: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0001f540: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-0001f550: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001f560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f570: 2065 6c69 6620 6e61 6d65 203d 3d20 2263   elif name == "c
-0001f580: 7075 5f66 7261 6374 696f 6e22 3a0a 2020  pu_fraction":.  
-0001f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5a0: 2020 746f 7461 6c5f 6461 7461 203d 2028    total_data = (
-0001f5b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f5c0: 2020 2020 2020 2020 2073 756d 2877 732e           sum(ws.
-0001f5d0: 6d65 7472 6963 735b 2263 7075 225d 2066  metrics["cpu"] f
-0001f5e0: 6f72 2077 7320 696e 2073 656c 662e 7363  or ws in self.sc
-0001f5f0: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
-0001f600: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
-0001f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f620: 2020 2f20 3130 300a 2020 2020 2020 2020    / 100.        
-0001f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f640: 2f20 7375 6d28 7773 2e6e 7468 7265 6164  / sum(ws.nthread
-0001f650: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
-0001f660: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-0001f670: 7273 2e76 616c 7565 7328 2929 0a20 2020  rs.values()).   
-0001f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f690: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0001f6a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001f6b0: 2020 2020 2020 2020 2020 2020 2074 6f74               tot
-0001f6c0: 616c 5f64 6174 6120 3d20 7375 6d28 6461  al_data = sum(da
-0001f6d0: 7461 5b6e 616d 655d 290a 0a20 2020 2020  ta[name])..     
-0001f6e0: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-0001f6f0: 6e61 6d65 5d2e 696e 7365 7274 2830 2c20  name].insert(0, 
-0001f700: 746f 7461 6c5f 6461 7461 290a 2020 2020  total_data).    
-0001f710: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0001f720: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
-0001f730: 2020 2020 2020 2020 2020 6461 7461 5b6e            data[n
-0001f740: 616d 655d 2e69 6e73 6572 7428 302c 204e  ame].insert(0, N
-0001f750: 6f6e 6529 0a0a 2020 2020 2020 2020 7365  one)..        se
-0001f760: 6c66 2e73 6f75 7263 652e 6461 7461 2e75  lf.source.data.u
-0001f770: 7064 6174 6528 6461 7461 290a 0a0a 636c  pdate(data)...cl
-0001f780: 6173 7320 5368 7566 666c 696e 6728 4461  ass Shuffling(Da
-0001f790: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-0001f7a0: 293a 0a20 2020 2022 2222 4f63 6375 7061  ):.    """Occupa
-0001f7b0: 6e63 7920 2869 6e20 7469 6d65 2920 7065  ncy (in time) pe
-0001f7c0: 7220 776f 726b 6572 2222 220a 0a20 2020  r worker"""..   
-0001f7d0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0001f7e0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
-0001f7f0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0001f800: 2020 7769 7468 206c 6f67 5f65 7272 6f72    with log_error
-0001f810: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0001f820: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
-0001f830: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
-0001f840: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-0001f850: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-0001f860: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
-0001f870: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0001f880: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-0001f890: 6f72 6b65 7222 3a20 5b5d 2c0a 2020 2020  orker": [],.    
-0001f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8b0: 2279 223a 205b 5d2c 0a20 2020 2020 2020  "y": [],.       
-0001f8c0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-0001f8d0: 6d6d 5f6d 656d 6f72 7922 3a20 5b5d 2c0a  mm_memory": [],.
-0001f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8f0: 2020 2020 2263 6f6d 6d5f 6d65 6d6f 7279      "comm_memory
-0001f900: 5f6c 696d 6974 223a 205b 5d2c 0a20 2020  _limit": [],.   
-0001f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f920: 2022 636f 6d6d 5f62 7563 6b65 7473 223a   "comm_buckets":
-0001f930: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-0001f940: 2020 2020 2020 2020 2022 636f 6d6d 5f61           "comm_a
-0001f950: 7667 5f64 7572 6174 696f 6e22 3a20 5b5d  vg_duration": []
-0001f960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f970: 2020 2020 2020 2263 6f6d 6d5f 6176 675f        "comm_avg_
-0001f980: 7369 7a65 223a 205b 5d2c 0a20 2020 2020  size": [],.     
-0001f990: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001f9a0: 636f 6d6d 5f72 6561 6422 3a20 5b5d 2c0a  comm_read": [],.
-0001f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f9c0: 2020 2020 2263 6f6d 6d5f 7772 6974 7465      "comm_writte
-0001f9d0: 6e22 3a20 5b5d 2c0a 2020 2020 2020 2020  n": [],.        
-0001f9e0: 2020 2020 2020 2020 2020 2020 2263 6f6d              "com
-0001f9f0: 6d5f 636f 6c6f 7222 3a20 5b5d 2c0a 2020  m_color": [],.  
-0001fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa10: 2020 2264 6973 6b5f 6d65 6d6f 7279 223a    "disk_memory":
-0001fa20: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-0001fa30: 2020 2020 2020 2020 2022 6469 736b 5f6d           "disk_m
-0001fa40: 656d 6f72 795f 6c69 6d69 7422 3a20 5b5d  emory_limit": []
-0001fa50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fa60: 2020 2020 2020 2264 6973 6b5f 6275 636b        "disk_buck
-0001fa70: 6574 7322 3a20 5b5d 2c0a 2020 2020 2020  ets": [],.      
-0001fa80: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-0001fa90: 6973 6b5f 6176 675f 6475 7261 7469 6f6e  isk_avg_duration
-0001faa0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-0001fab0: 2020 2020 2020 2020 2020 2022 6469 736b             "disk
-0001fac0: 5f61 7667 5f73 697a 6522 3a20 5b5d 2c0a  _avg_size": [],.
-0001fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fae0: 2020 2020 2264 6973 6b5f 7265 6164 223a      "disk_read":
-0001faf0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-0001fb00: 2020 2020 2020 2020 2022 6469 736b 5f77           "disk_w
-0001fb10: 7269 7474 656e 223a 205b 5d2c 0a20 2020  ritten": [],.   
-0001fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb30: 2022 6469 736b 5f63 6f6c 6f72 223a 205b   "disk_color": [
-0001fb40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0001fb50: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0001fb60: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-0001fb70: 656c 662e 746f 7461 6c73 5f73 6f75 7263  elf.totals_sourc
-0001fb80: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
-0001fb90: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
-0001fba0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0001fbb0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
-0001fbc0: 205b 224e 6574 776f 726b 2053 656e 6422   ["Network Send"
-0001fbd0: 2c20 224e 6574 776f 726b 2052 6563 6569  , "Network Recei
-0001fbe0: 7665 222c 2022 4469 736b 2057 7269 7465  ve", "Disk Write
-0001fbf0: 222c 2022 4469 736b 2052 6561 6422 5d2c  ", "Disk Read"],
-0001fc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fc10: 2020 2020 2022 7661 6c75 6573 223a 205b       "values": [
-0001fc20: 302c 2030 2c20 302c 2030 5d2c 0a20 2020  0, 0, 0, 0],.   
-0001fc30: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0001fc40: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001fc50: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0001fc60: 6f6d 6d5f 6d65 6d6f 7279 203d 2066 6967  omm_memory = fig
-0001fc70: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
-0001fc80: 2020 2020 2074 6974 6c65 3d22 436f 6d6d       title="Comm
-0001fc90: 7320 4275 6666 6572 222c 0a20 2020 2020  s Buffer",.     
-0001fca0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-0001fcb0: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-0001fcc0: 2020 2020 2074 6f6f 6c62 6172 5f6c 6f63       toolbar_loc
-0001fcd0: 6174 696f 6e3d 2261 626f 7665 222c 0a20  ation="above",. 
-0001fce0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-0001fcf0: 5f72 616e 6765 3d52 616e 6765 3164 2830  _range=Range1d(0
-0001fd00: 2c20 3130 305f 3030 305f 3030 3029 2c0a  , 100_000_000),.
-0001fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd20: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-0001fd30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001fd40: 2020 2020 7365 6c66 2e63 6f6d 6d5f 6d65      self.comm_me
-0001fd50: 6d6f 7279 2e68 6261 7228 0a20 2020 2020  mory.hbar(.     
-0001fd60: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0001fd70: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-0001fd80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001fd90: 6967 6874 3d22 636f 6d6d 5f6d 656d 6f72  ight="comm_memor
-0001fda0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-0001fdb0: 2020 2020 793d 2279 222c 0a20 2020 2020      y="y",.     
-0001fdc0: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-0001fdd0: 743d 302e 392c 0a20 2020 2020 2020 2020  t=0.9,.         
-0001fde0: 2020 2020 2020 2063 6f6c 6f72 3d22 636f         color="co
-0001fdf0: 6d6d 5f63 6f6c 6f72 222c 0a20 2020 2020  mm_color",.     
-0001fe00: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001fe10: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
-0001fe20: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
-0001fe30: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
-0001fe40: 3d5b 0a20 2020 2020 2020 2020 2020 2020  =[.             
-0001fe50: 2020 2020 2020 2028 224d 656d 6f72 7920         ("Memory 
-0001fe60: 5573 6564 222c 2022 4063 6f6d 6d5f 6d65  Used", "@comm_me
-0001fe70: 6d6f 7279 7b30 2e30 3020 627d 2229 2c0a  mory{0.00 b}"),.
-0001fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe90: 2020 2020 2822 4176 6572 6167 6520 5772      ("Average Wr
-0001fea0: 6974 6522 2c20 2240 636f 6d6d 5f61 7667  ite", "@comm_avg
-0001feb0: 5f73 697a 657b 302e 3030 2062 7d22 292c  _size{0.00 b}"),
-0001fec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fed0: 2020 2020 2028 2223 2042 7563 6b65 7473       ("# Buckets
-0001fee0: 222c 2022 4063 6f6d 6d5f 6275 636b 6574  ", "@comm_bucket
-0001fef0: 7322 292c 0a20 2020 2020 2020 2020 2020  s"),.           
-0001ff00: 2020 2020 2020 2020 2028 2241 7665 7261           ("Avera
-0001ff10: 6765 2044 7572 6174 696f 6e22 2c20 2240  ge Duration", "@
-0001ff20: 636f 6d6d 5f61 7667 5f64 7572 6174 696f  comm_avg_duratio
-0001ff30: 6e22 292c 0a20 2020 2020 2020 2020 2020  n"),.           
-0001ff40: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001ff50: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
-0001ff60: 7273 3d7b 2240 636f 6d6d 5f61 7667 5f64  rs={"@comm_avg_d
-0001ff70: 7572 6174 696f 6e22 3a20 2264 6174 6574  uration": "datet
-0001ff80: 696d 6522 7d2c 0a20 2020 2020 2020 2020  ime"},.         
-0001ff90: 2020 2020 2020 206d 6f64 653d 2268 6c69         mode="hli
-0001ffa0: 6e65 222c 0a20 2020 2020 2020 2020 2020  ne",.           
-0001ffb0: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-0001ffc0: 656c 662e 636f 6d6d 5f6d 656d 6f72 792e  elf.comm_memory.
-0001ffd0: 6164 645f 746f 6f6c 7328 686f 7665 7229  add_tools(hover)
-0001ffe0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001fff0: 662e 636f 6d6d 5f6d 656d 6f72 792e 785f  f.comm_memory.x_
-00020000: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
-00020010: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00020020: 2e63 6f6d 6d5f 6d65 6d6f 7279 2e78 5f72  .comm_memory.x_r
-00020030: 616e 6765 2e65 6e64 203d 2031 0a20 2020  ange.end = 1.   
-00020040: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00020050: 6d6d 5f6d 656d 6f72 792e 7861 7869 735b  mm_memory.xaxis[
-00020060: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
-00020070: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
-00020080: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-00020090: 6222 290a 0a20 2020 2020 2020 2020 2020  b")..           
-000200a0: 2073 656c 662e 6469 736b 5f6d 656d 6f72   self.disk_memor
-000200b0: 7920 3d20 6669 6775 7265 280a 2020 2020  y = figure(.    
-000200c0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-000200d0: 653d 2244 6973 6b20 4275 6666 6572 222c  e="Disk Buffer",
-000200e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000200f0: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
-00020100: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
-00020110: 6172 5f6c 6f63 6174 696f 6e3d 2261 626f  ar_location="abo
-00020120: 7665 222c 0a20 2020 2020 2020 2020 2020  ve",.           
-00020130: 2020 2020 2078 5f72 616e 6765 3d52 616e       x_range=Ran
-00020140: 6765 3164 2830 2c20 3130 305f 3030 305f  ge1d(0, 100_000_
-00020150: 3030 3029 2c0a 2020 2020 2020 2020 2020  000),.          
-00020160: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-00020170: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00020180: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00020190: 6973 6b5f 6d65 6d6f 7279 2e79 6178 6973  isk_memory.yaxis
-000201a0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-000201b0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-000201c0: 6c66 2e64 6973 6b5f 6d65 6d6f 7279 2e68  lf.disk_memory.h
-000201d0: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
-000201e0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-000201f0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-00020200: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
-00020210: 6469 736b 5f6d 656d 6f72 7922 2c0a 2020  disk_memory",.  
-00020220: 2020 2020 2020 2020 2020 2020 2020 793d                y=
-00020230: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
-00020240: 2020 2020 2068 6569 6768 743d 302e 392c       height=0.9,
-00020250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020260: 2063 6f6c 6f72 3d22 6469 736b 5f63 6f6c   color="disk_col
-00020270: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-00020280: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00020290: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
-000202a0: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-000202b0: 2020 2074 6f6f 6c74 6970 733d 5b0a 2020     tooltips=[.  
-000202c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202d0: 2020 2822 4d65 6d6f 7279 2055 7365 6422    ("Memory Used"
-000202e0: 2c20 2240 6469 736b 5f6d 656d 6f72 797b  , "@disk_memory{
-000202f0: 302e 3030 2062 7d22 292c 0a20 2020 2020  0.00 b}"),.     
-00020300: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00020310: 2241 7665 7261 6765 2057 7269 7465 222c  "Average Write",
-00020320: 2022 4064 6973 6b5f 6176 675f 7369 7a65   "@disk_avg_size
-00020330: 7b30 2e30 3020 627d 2229 2c0a 2020 2020  {0.00 b}"),.    
-00020340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020350: 2822 2320 4275 636b 6574 7322 2c20 2240  ("# Buckets", "@
-00020360: 6469 736b 5f62 7563 6b65 7473 2229 2c0a  disk_buckets"),.
-00020370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020380: 2020 2020 2822 4176 6572 6167 6520 4475      ("Average Du
-00020390: 7261 7469 6f6e 222c 2022 4064 6973 6b5f  ration", "@disk_
-000203a0: 6176 675f 6475 7261 7469 6f6e 2229 2c0a  avg_duration"),.
-000203b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203c0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000203d0: 2020 2066 6f72 6d61 7474 6572 733d 7b22     formatters={"
-000203e0: 4064 6973 6b5f 6176 675f 6475 7261 7469  @disk_avg_durati
-000203f0: 6f6e 223a 2022 6461 7465 7469 6d65 227d  on": "datetime"}
-00020400: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020410: 2020 6d6f 6465 3d22 686c 696e 6522 2c0a    mode="hline",.
-00020420: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00020430: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00020440: 6973 6b5f 6d65 6d6f 7279 2e61 6464 5f74  isk_memory.add_t
-00020450: 6f6f 6c73 2868 6f76 6572 290a 2020 2020  ools(hover).    
-00020460: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-00020470: 6b5f 6d65 6d6f 7279 2e78 6178 6973 5b30  k_memory.xaxis[0
-00020480: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
-00020490: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
-000204a0: 6572 2866 6f72 6d61 743d 2230 2e30 2062  er(format="0.0 b
-000204b0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-000204c0: 7365 6c66 2e74 6f74 616c 7320 3d20 6669  self.totals = fi
-000204d0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-000204e0: 2020 2020 2020 7469 746c 653d 2254 6f74        title="Tot
-000204f0: 616c 206d 6f76 656d 656e 7422 2c0a 2020  al movement",.  
-00020500: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00020510: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-00020520: 2020 2020 2020 2020 746f 6f6c 6261 725f          toolbar_
-00020530: 6c6f 6361 7469 6f6e 3d22 6162 6f76 6522  location="above"
-00020540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020550: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-00020560: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00020570: 2020 2020 2020 7469 746c 6573 203d 205b        titles = [
-00020580: 224e 6574 776f 726b 2053 656e 6422 2c20  "Network Send", 
-00020590: 224e 6574 776f 726b 2052 6563 6569 7665  "Network Receive
-000205a0: 222c 2022 4469 736b 2057 7269 7465 222c  ", "Disk Write",
-000205b0: 2022 4469 736b 2052 6561 6422 5d0a 2020   "Disk Read"].  
-000205c0: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-000205d0: 6f74 616c 7320 3d20 6669 6775 7265 280a  otals = figure(.
-000205e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205f0: 785f 7261 6e67 653d 7469 746c 6573 2c0a  x_range=titles,.
-00020600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020610: 7469 746c 653d 2254 6f74 616c 7322 2c0a  title="Totals",.
-00020620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020630: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-00020640: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00020650: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-00020660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020670: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-00020680: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00020690: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
-000206a0: 732e 7662 6172 280a 2020 2020 2020 2020  s.vbar(.        
-000206b0: 2020 2020 2020 2020 783d 2278 222c 0a20          x="x",. 
-000206c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000206d0: 6f70 3d22 7661 6c75 6573 222c 0a20 2020  op="values",.   
-000206e0: 2020 2020 2020 2020 2020 2020 2077 6964               wid
-000206f0: 7468 3d30 2e39 2c0a 2020 2020 2020 2020  th=0.9,.        
-00020700: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-00020710: 656c 662e 746f 7461 6c73 5f73 6f75 7263  elf.totals_sourc
-00020720: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
-00020730: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00020740: 6c66 2e74 6f74 616c 732e 7867 7269 642e  lf.totals.xgrid.
-00020750: 6772 6964 5f6c 696e 655f 636f 6c6f 7220  grid_line_color 
-00020760: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00020770: 2020 2073 656c 662e 746f 7461 6c73 2e79     self.totals.y
-00020780: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
-00020790: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000207a0: 662e 746f 7461 6c73 2e79 6178 6973 5b30  f.totals.yaxis[0
-000207b0: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
-000207c0: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
-000207d0: 6572 2866 6f72 6d61 743d 2230 2e30 2062  er(format="0.0 b
-000207e0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-000207f0: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
-00020800: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00020810: 2020 2074 6f6f 6c74 6970 733d 5b28 2254     tooltips=[("T
-00020820: 6f74 616c 222c 2022 4076 616c 7565 737b  otal", "@values{
-00020830: 302e 3030 627d 2229 5d2c 0a20 2020 2020  0.00b}")],.     
-00020840: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
-00020850: 2276 6c69 6e65 222c 0a20 2020 2020 2020  "vline",.       
-00020860: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00020870: 2020 2073 656c 662e 746f 7461 6c73 2e61     self.totals.a
-00020880: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
-00020890: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000208a0: 662e 726f 6f74 203d 2072 6f77 2873 656c  f.root = row(sel
-000208b0: 662e 636f 6d6d 5f6d 656d 6f72 792c 2073  f.comm_memory, s
-000208c0: 656c 662e 6469 736b 5f6d 656d 6f72 7929  elf.disk_memory)
-000208d0: 0a0a 2020 2020 4077 6974 686f 7574 5f70  ..    @without_p
-000208e0: 726f 7065 7274 795f 7661 6c69 6461 7469  roperty_validati
-000208f0: 6f6e 0a20 2020 2064 6566 2075 7064 6174  on.    def updat
-00020900: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00020910: 2077 6974 6820 6c6f 675f 6572 726f 7273   with log_errors
-00020920: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00020930: 696e 7075 7420 3d20 7365 6c66 2e73 6368  input = self.sch
-00020940: 6564 756c 6572 2e65 7874 656e 7369 6f6e  eduler.extension
-00020950: 735b 2273 6875 6666 6c65 225d 2e68 6561  s["shuffle"].hea
-00020960: 7274 6265 6174 730a 2020 2020 2020 2020  rtbeats.        
-00020970: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
-00020980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020990: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-000209a0: 2020 2020 2020 696e 7075 7420 3d20 6c69        input = li
-000209b0: 7374 2869 6e70 7574 2e76 616c 7565 7328  st(input.values(
-000209c0: 2929 5b2d 315d 2020 2320 544f 444f 3a20  ))[-1]  # TODO: 
-000209d0: 6d75 6c74 6970 6c65 2063 6f6e 6375 7272  multiple concurr
-000209e0: 656e 7420 7368 7566 666c 6573 0a0a 2020  ent shuffles..  
-000209f0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00020a00: 2064 6566 6175 6c74 6469 6374 286c 6973   defaultdict(lis
-00020a10: 7429 0a20 2020 2020 2020 2020 2020 206e  t).            n
-00020a20: 6f77 203d 2074 696d 6528 290a 0a20 2020  ow = time()..   
-00020a30: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
-00020a40: 2877 6f72 6b65 722c 2064 2920 696e 2065  (worker, d) in e
-00020a50: 6e75 6d65 7261 7465 2869 6e70 7574 2e69  numerate(input.i
-00020a60: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
-00020a70: 2020 2020 2020 2020 2064 6174 615b 2279           data["y
-00020a80: 225d 2e61 7070 656e 6428 6929 0a20 2020  "].append(i).   
-00020a90: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00020aa0: 615b 2277 6f72 6b65 7222 5d2e 6170 7065  a["worker"].appe
-00020ab0: 6e64 2877 6f72 6b65 7229 0a20 2020 2020  nd(worker).     
-00020ac0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-00020ad0: 7265 6669 7820 696e 205b 2263 6f6d 6d22  refix in ["comm"
-00020ae0: 2c20 2264 6973 6b22 5d3a 0a20 2020 2020  , "disk"]:.     
-00020af0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00020b00: 6174 615b 6622 7b70 7265 6669 787d 5f74  ata[f"{prefix}_t
-00020b10: 6f74 616c 225d 2e61 7070 656e 6428 645b  otal"].append(d[
-00020b20: 7072 6566 6978 5d5b 2274 6f74 616c 225d  prefix]["total"]
-00020b30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00020b40: 2020 2020 2020 6461 7461 5b66 227b 7072        data[f"{pr
-00020b50: 6566 6978 7d5f 6d65 6d6f 7279 225d 2e61  efix}_memory"].a
-00020b60: 7070 656e 6428 645b 7072 6566 6978 5d5b  ppend(d[prefix][
-00020b70: 226d 656d 6f72 7922 5d29 0a20 2020 2020  "memory"]).     
-00020b80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00020b90: 6174 615b 6622 7b70 7265 6669 787d 5f6d  ata[f"{prefix}_m
-00020ba0: 656d 6f72 795f 6c69 6d69 7422 5d2e 6170  emory_limit"].ap
-00020bb0: 7065 6e64 2864 5b70 7265 6669 785d 5b22  pend(d[prefix]["
-00020bc0: 6d65 6d6f 7279 5f6c 696d 6974 225d 290a  memory_limit"]).
-00020bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020be0: 2020 2020 6461 7461 5b66 227b 7072 6566      data[f"{pref
-00020bf0: 6978 7d5f 6275 636b 6574 7322 5d2e 6170  ix}_buckets"].ap
-00020c00: 7065 6e64 2864 5b70 7265 6669 785d 5b22  pend(d[prefix]["
-00020c10: 6275 636b 6574 7322 5d29 0a20 2020 2020  buckets"]).     
-00020c20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00020c30: 6174 615b 6622 7b70 7265 6669 787d 5f61  ata[f"{prefix}_a
-00020c40: 7667 5f64 7572 6174 696f 6e22 5d2e 6170  vg_duration"].ap
-00020c50: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-00020c60: 2020 2020 2020 2020 2020 2020 2020 645b                d[
-00020c70: 7072 6566 6978 5d5b 2264 6961 676e 6f73  prefix]["diagnos
-00020c80: 7469 6373 225d 2e67 6574 2822 6176 675f  tics"].get("avg_
-00020c90: 6475 7261 7469 6f6e 222c 2030 290a 2020  duration", 0).  
-00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020cb0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00020cc0: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
-00020cd0: 7072 6566 6978 7d5f 6176 675f 7369 7a65  prefix}_avg_size
-00020ce0: 225d 2e61 7070 656e 6428 0a20 2020 2020  "].append(.     
-00020cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d00: 2020 2064 5b70 7265 6669 785d 5b22 6469     d[prefix]["di
-00020d10: 6167 6e6f 7374 6963 7322 5d2e 6765 7428  agnostics"].get(
-00020d20: 2261 7667 5f73 697a 6522 2c20 3029 0a20  "avg_size", 0). 
-00020d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00020d50: 2020 2020 2020 2020 2064 6174 615b 6622           data[f"
-00020d60: 7b70 7265 6669 787d 5f72 6561 6422 5d2e  {prefix}_read"].
-00020d70: 6170 7065 6e64 2864 5b70 7265 6669 785d  append(d[prefix]
-00020d80: 5b22 7265 6164 225d 290a 2020 2020 2020  ["read"]).      
-00020d90: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00020da0: 7461 5b66 227b 7072 6566 6978 7d5f 7772  ta[f"{prefix}_wr
-00020db0: 6974 7465 6e22 5d2e 6170 7065 6e64 2864  itten"].append(d
-00020dc0: 5b70 7265 6669 785d 5b22 7772 6974 7465  [prefix]["writte
-00020dd0: 6e22 5d29 0a20 2020 2020 2020 2020 2020  n"]).           
-00020de0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00020df0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-00020e00: 7273 5b77 6f72 6b65 725d 2e6c 6173 745f  rs[worker].last_
-00020e10: 7365 656e 203c 206e 6f77 202d 2035 3a0a  seen < now - 5:.
-00020e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e30: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
-00020e40: 7072 6566 6978 7d5f 636f 6c6f 7222 5d2e  prefix}_color"].
-00020e50: 6170 7065 6e64 2822 6772 6179 2229 0a20  append("gray"). 
-00020e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e70: 2020 2065 6c69 6620 645b 7072 6566 6978     elif d[prefix
-00020e80: 5d5b 226d 656d 6f72 7922 5d20 3e20 645b  ]["memory"] > d[
-00020e90: 7072 6566 6978 5d5b 226d 656d 6f72 795f  prefix]["memory_
-00020ea0: 6c69 6d69 7422 5d3a 0a20 2020 2020 2020  limit"]:.       
-00020eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ec0: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
-00020ed0: 5f63 6f6c 6f72 225d 2e61 7070 656e 6428  _color"].append(
-00020ee0: 2272 6564 2229 0a20 2020 2020 2020 2020  "red").         
-00020ef0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00020f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020f10: 2020 2020 2020 2020 2064 6174 615b 6622           data[f"
-00020f20: 7b70 7265 6669 787d 5f63 6f6c 6f72 225d  {prefix}_color"]
-00020f30: 2e61 7070 656e 6428 2262 6c75 6522 290a  .append("blue").
-00020f40: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-00020f50: 0a20 2020 2020 2020 2020 2020 2073 696e  .            sin
-00020f60: 676c 6574 6f6e 7320 3d20 7b0a 2020 2020  gletons = {.    
-00020f70: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-00020f80: 7265 6669 787d 5f61 7667 5f64 7572 6174  refix}_avg_durat
-00020f90: 696f 6e22 3a20 5b0a 2020 2020 2020 2020  ion": [.        
-00020fa0: 2020 2020 2020 2020 2020 2020 7375 6d28              sum(
-00020fb0: 6461 7461 5b66 227b 7072 6566 6978 7d5f  data[f"{prefix}_
-00020fc0: 6176 675f 6475 7261 7469 6f6e 225d 2920  avg_duration"]) 
-00020fd0: 2f20 6c65 6e28 6461 7461 5b66 227b 7072  / len(data[f"{pr
-00020fe0: 6566 6978 7d5f 6176 675f 6475 7261 7469  efix}_avg_durati
-00020ff0: 6f6e 225d 290a 2020 2020 2020 2020 2020  on"]).          
-00021000: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00021010: 2020 2020 2020 2020 2066 227b 7072 6566           f"{pref
-00021020: 6978 7d5f 6176 675f 7369 7a65 223a 205b  ix}_avg_size": [
-00021030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021040: 2020 2020 2073 756d 2864 6174 615b 6622       sum(data[f"
-00021050: 7b70 7265 6669 787d 5f61 7667 5f73 697a  {prefix}_avg_siz
-00021060: 6522 5d29 202f 206c 656e 2864 6174 615b  e"]) / len(data[
-00021070: 6622 7b70 7265 6669 787d 5f61 7667 5f73  f"{prefix}_avg_s
-00021080: 697a 6522 5d29 0a20 2020 2020 2020 2020  ize"]).         
-00021090: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000210a0: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
-000210b0: 6176 675f 6475 7261 7469 6f6e 223a 205b  avg_duration": [
-000210c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000210d0: 2020 2020 2073 756d 2864 6174 615b 2264       sum(data["d
-000210e0: 6973 6b5f 6176 675f 6475 7261 7469 6f6e  isk_avg_duration
-000210f0: 225d 2920 2f20 6c65 6e28 6461 7461 5b22  "]) / len(data["
-00021100: 6469 736b 5f61 7667 5f64 7572 6174 696f  disk_avg_duratio
-00021110: 6e22 5d29 0a20 2020 2020 2020 2020 2020  n"]).           
-00021120: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00021130: 2020 2020 2020 2020 2264 6973 6b5f 6176          "disk_av
-00021140: 675f 7369 7a65 223a 205b 0a20 2020 2020  g_size": [.     
-00021150: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00021160: 756d 2864 6174 615b 2264 6973 6b5f 6176  um(data["disk_av
-00021170: 675f 7369 7a65 225d 2920 2f20 6c65 6e28  g_size"]) / len(
-00021180: 6461 7461 5b22 6469 736b 5f61 7667 5f73  data["disk_avg_s
-00021190: 697a 6522 5d29 0a20 2020 2020 2020 2020  ize"]).         
-000211a0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000211b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000211c0: 2020 2020 7369 6e67 6c65 746f 6e73 5b66      singletons[f
-000211d0: 227b 7072 6566 6978 7d5f 6176 675f 6261  "{prefix}_avg_ba
-000211e0: 6e64 7769 6474 6822 5d20 3d20 5b0a 2020  ndwidth"] = [.  
-000211f0: 2020 2020 2020 2020 2020 2020 2020 7369                si
-00021200: 6e67 6c65 746f 6e73 5b66 227b 7072 6566  ngletons[f"{pref
-00021210: 6978 7d5f 6176 675f 7369 7a65 225d 5b30  ix}_avg_size"][0
-00021220: 5d20 2f20 7369 6e67 6c65 746f 6e73 5b66  ] / singletons[f
-00021230: 227b 7072 6566 6978 7d5f 6176 675f 6475  "{prefix}_avg_du
-00021240: 7261 7469 6f6e 225d 5b30 5d0a 2020 2020  ration"][0].    
-00021250: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00021260: 2020 2020 2020 7369 6e67 6c65 746f 6e73        singletons
-00021270: 5b22 6469 736b 5f61 7667 5f62 616e 6477  ["disk_avg_bandw
-00021280: 6964 7468 225d 203d 205b 0a20 2020 2020  idth"] = [.     
-00021290: 2020 2020 2020 2020 2020 2073 696e 676c             singl
-000212a0: 6574 6f6e 735b 2264 6973 6b5f 6176 675f  etons["disk_avg_
-000212b0: 7369 7a65 225d 5b30 5d20 2f20 7369 6e67  size"][0] / sing
-000212c0: 6c65 746f 6e73 5b22 6469 736b 5f61 7667  letons["disk_avg
-000212d0: 5f64 7572 6174 696f 6e22 5d5b 305d 0a20  _duration"][0]. 
-000212e0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-000212f0: 2020 2020 2020 2020 2073 696e 676c 6574           singlet
-00021300: 6f6e 735b 2279 225d 203d 205b 6461 7461  ons["y"] = [data
-00021310: 5b22 7922 5d5b 2d31 5d20 2f20 325d 0a20  ["y"][-1] / 2]. 
-00021320: 2020 2020 2020 2020 2020 2022 2222 0a0a             """..
-00021330: 2020 2020 2020 2020 2020 2020 746f 7461              tota
-00021340: 6c73 203d 207b 0a20 2020 2020 2020 2020  ls = {.         
-00021350: 2020 2020 2020 2022 7822 3a20 5b22 4e65         "x": ["Ne
-00021360: 7477 6f72 6b20 5365 6e64 222c 2022 4e65  twork Send", "Ne
-00021370: 7477 6f72 6b20 5265 6365 6976 6522 2c20  twork Receive", 
-00021380: 2244 6973 6b20 5772 6974 6522 2c20 2244  "Disk Write", "D
-00021390: 6973 6b20 5265 6164 225d 2c0a 2020 2020  isk Read"],.    
-000213a0: 2020 2020 2020 2020 2020 2020 2276 616c              "val
-000213b0: 7565 7322 3a20 5b0a 2020 2020 2020 2020  ues": [.        
-000213c0: 2020 2020 2020 2020 2020 2020 7375 6d28              sum(
-000213d0: 6461 7461 5b22 636f 6d6d 5f77 7269 7474  data["comm_writt
-000213e0: 656e 225d 292c 0a20 2020 2020 2020 2020  en"]),.         
-000213f0: 2020 2020 2020 2020 2020 2073 756d 2864             sum(d
-00021400: 6174 615b 2263 6f6d 6d5f 7265 6164 225d  ata["comm_read"]
-00021410: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00021420: 2020 2020 2020 2073 756d 2864 6174 615b         sum(data[
-00021430: 2264 6973 6b5f 7772 6974 7465 6e22 5d29  "disk_written"])
-00021440: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021450: 2020 2020 2020 7375 6d28 6461 7461 5b22        sum(data["
-00021460: 6469 736b 5f72 6561 6422 5d29 2c0a 2020  disk_read"]),.  
-00021470: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00021480: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00021490: 2020 2020 2020 2020 2020 2075 7064 6174             updat
-000214a0: 6528 7365 6c66 2e74 6f74 616c 735f 736f  e(self.totals_so
-000214b0: 7572 6365 2c20 746f 7461 6c73 290a 0a20  urce, totals).. 
-000214c0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
-000214d0: 6528 7365 6c66 2e73 6f75 7263 652c 2064  e(self.source, d
-000214e0: 6963 7428 6461 7461 2929 0a20 2020 2020  ict(data)).     
-000214f0: 2020 2020 2020 206c 696d 6974 203d 206d         limit = m
-00021500: 6178 2864 6174 615b 2263 6f6d 6d5f 6d65  ax(data["comm_me
-00021510: 6d6f 7279 5f6c 696d 6974 225d 202b 2064  mory_limit"] + d
-00021520: 6174 615b 2264 6973 6b5f 6d65 6d6f 7279  ata["disk_memory
-00021530: 5f6c 696d 6974 225d 2920 2a20 312e 320a  _limit"]) * 1.2.
-00021540: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00021550: 2e63 6f6d 6d5f 6d65 6d6f 7279 2e78 5f72  .comm_memory.x_r
-00021560: 616e 6765 2e65 6e64 203d 206c 696d 6974  ange.end = limit
-00021570: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00021580: 662e 6469 736b 5f6d 656d 6f72 792e 785f  f.disk_memory.x_
-00021590: 7261 6e67 652e 656e 6420 3d20 6c69 6d69  range.end = limi
-000215a0: 740a 0a0a 5f53 5459 4c45 5320 3d20 7b0a  t..._STYLES = {.
-000215b0: 2020 2020 2277 6964 7468 223a 2022 3130      "width": "10
-000215c0: 3025 222c 0a20 2020 2022 6865 6967 6874  0%",.    "height
-000215d0: 223a 2022 3130 3025 222c 0a20 2020 2022  ": "100%",.    "
-000215e0: 6d61 782d 7769 6474 6822 3a20 2231 3932  max-width": "192
-000215f0: 3070 7822 2c0a 2020 2020 226d 6178 2d68  0px",.    "max-h
-00021600: 6569 6768 7422 3a20 2231 3038 3070 7822  eight": "1080px"
-00021610: 2c0a 2020 2020 2270 6164 6469 6e67 223a  ,.    "padding":
-00021620: 2022 3132 7078 222c 0a20 2020 2022 626f   "12px",.    "bo
-00021630: 7264 6572 223a 2022 3170 7820 736f 6c69  rder": "1px soli
-00021640: 6420 6c69 6768 7467 7261 7922 2c0a 2020  d lightgray",.  
-00021650: 2020 2262 6f78 2d73 6861 646f 7722 3a20    "box-shadow": 
-00021660: 2269 6e73 6574 2031 7078 2030 2038 7078  "inset 1px 0 8px
-00021670: 2030 206c 6967 6874 6772 6179 222c 0a20   0 lightgray",. 
-00021680: 2020 2022 6f76 6572 666c 6f77 223a 2022     "overflow": "
-00021690: 6175 746f 222c 0a7d 0a69 6620 424f 4b45  auto",.}.if BOKE
-000216a0: 485f 5645 5253 494f 4e2e 6d61 6a6f 7220  H_VERSION.major 
-000216b0: 3c20 333a 0a20 2020 205f 424f 4b45 485f  < 3:.    _BOKEH_
-000216c0: 5354 594c 4553 5f4b 5741 5247 5320 3d20  STYLES_KWARGS = 
-000216d0: 7b22 7374 796c 6522 3a20 5f53 5459 4c45  {"style": _STYLE
-000216e0: 537d 0a65 6c73 653a 0a20 2020 205f 424f  S}.else:.    _BO
-000216f0: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
-00021700: 5320 3d20 7b22 7374 796c 6573 223a 205f  S = {"styles": _
-00021710: 5354 594c 4553 7d0a 0a0a 636c 6173 7320  STYLES}...class 
-00021720: 5363 6865 6475 6c65 724c 6f67 733a 0a20  SchedulerLogs:. 
-00021730: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00021740: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
-00021750: 2073 7461 7274 3d4e 6f6e 6529 3a0a 2020   start=None):.  
-00021760: 2020 2020 2020 6c6f 6773 203d 2073 6368        logs = sch
-00021770: 6564 756c 6572 2e67 6574 5f6c 6f67 7328  eduler.get_logs(
-00021780: 7374 6172 743d 7374 6172 742c 2074 696d  start=start, tim
-00021790: 6573 7461 6d70 733d 5472 7565 290a 0a20  estamps=True).. 
-000217a0: 2020 2020 2020 2069 6620 6e6f 7420 6c6f         if not lo
-000217b0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-000217c0: 6c6f 6773 5f68 746d 6c20 3d20 280a 2020  logs_html = (.  
-000217d0: 2020 2020 2020 2020 2020 2020 2020 273c                '<
-000217e0: 7020 7374 796c 653d 2266 6f6e 742d 6661  p style="font-fa
-000217f0: 6d69 6c79 3a20 6d6f 6e6f 7370 6163 653b  mily: monospace;
-00021800: 206d 6172 6769 6e3a 2030 3b22 3e4e 6f20   margin: 0;">No 
-00021810: 6c6f 6773 2074 6f20 7265 706f 7274 3c2f  logs to report</
-00021820: 703e 270a 2020 2020 2020 2020 2020 2020  p>'.            
-00021830: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00021840: 2020 2020 2020 2020 2020 2020 6c6f 6773              logs
-00021850: 5f68 746d 6c20 3d20 4c6f 6728 0a20 2020  _html = Log(.   
-00021860: 2020 2020 2020 2020 2020 2020 2022 5c6e               "\n
-00021870: 222e 6a6f 696e 280a 2020 2020 2020 2020  ".join(.        
-00021880: 2020 2020 2020 2020 2020 2020 2225 7320              "%s 
-00021890: 2d20 2573 220a 2020 2020 2020 2020 2020  - %s".          
-000218a0: 2020 2020 2020 2020 2020 2520 2864 6174            % (dat
-000218b0: 6574 696d 652e 6672 6f6d 7469 6d65 7374  etime.fromtimest
-000218c0: 616d 7028 7469 6d65 292e 7374 7266 7469  amp(time).strfti
-000218d0: 6d65 2822 2548 3a25 4d3a 2553 2e25 6622  me("%H:%M:%S.%f"
-000218e0: 292c 206c 696e 6529 0a20 2020 2020 2020  ), line).       
-000218f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00021900: 2074 696d 652c 206c 6576 656c 2c20 6c69   time, level, li
-00021910: 6e65 2069 6e20 6c6f 6773 0a20 2020 2020  ne in logs.     
-00021920: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00021930: 2020 2020 2020 2020 2029 2e5f 7265 7072           )._repr
-00021940: 5f68 746d 6c5f 2829 0a0a 2020 2020 2020  _html_()..      
-00021950: 2020 7365 6c66 2e72 6f6f 7420 3d20 4469    self.root = Di
-00021960: 7628 7465 7874 3d6c 6f67 735f 6874 6d6c  v(text=logs_html
-00021970: 2c20 2a2a 5f42 4f4b 4548 5f53 5459 4c45  , **_BOKEH_STYLE
-00021980: 535f 4b57 4152 4753 290a 0a0a 406c 6f67  S_KWARGS)...@log
-00021990: 5f65 7272 6f72 730a 6465 6620 7379 7374  _errors.def syst
-000219a0: 656d 6d6f 6e69 746f 725f 646f 6328 7363  emmonitor_doc(sc
-000219b0: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
-000219c0: 646f 6329 3a0a 2020 2020 7379 736d 6f6e  doc):.    sysmon
-000219d0: 203d 2053 7973 7465 6d4d 6f6e 6974 6f72   = SystemMonitor
-000219e0: 2873 6368 6564 756c 6572 2c20 7369 7a69  (scheduler, sizi
-000219f0: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00021a00: 5f62 6f74 6822 290a 2020 2020 646f 632e  _both").    doc.
-00021a10: 7469 746c 6520 3d20 2244 6173 6b3a 2053  title = "Dask: S
-00021a20: 6368 6564 756c 6572 2053 7973 7465 6d20  cheduler System 
-00021a30: 4d6f 6e69 746f 7222 0a20 2020 2061 6464  Monitor".    add
-00021a40: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-00021a50: 636b 2864 6f63 2c20 7379 736d 6f6e 2c20  ck(doc, sysmon, 
-00021a60: 3530 3029 0a0a 2020 2020 646f 632e 6164  500)..    doc.ad
-00021a70: 645f 726f 6f74 2873 7973 6d6f 6e2e 726f  d_root(sysmon.ro
-00021a80: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
-00021a90: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-00021aa0: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-00021ab0: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-00021ac0: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-00021ad0: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-00021ae0: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-00021af0: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
-00021b00: 6f67 5f65 7272 6f72 730a 6465 6620 7368  og_errors.def sh
-00021b10: 7566 666c 696e 675f 646f 6328 7363 6865  uffling_doc(sche
-00021b20: 6475 6c65 722c 2065 7874 7261 2c20 646f  duler, extra, do
-00021b30: 6329 3a0a 2020 2020 646f 632e 7469 746c  c):.    doc.titl
-00021b40: 6520 3d20 2244 6173 6b3a 2053 6875 6666  e = "Dask: Shuff
-00021b50: 6c69 6e67 220a 0a20 2020 2073 6875 6666  ling"..    shuff
-00021b60: 6c69 6e67 203d 2053 6875 6666 6c69 6e67  ling = Shuffling
-00021b70: 2873 6368 6564 756c 6572 2c20 7769 6474  (scheduler, widt
-00021b80: 683d 3430 302c 2068 6569 6768 743d 3430  h=400, height=40
-00021b90: 3029 0a20 2020 2077 6f72 6b65 7273 5f6d  0).    workers_m
-00021ba0: 656d 6f72 7920 3d20 576f 726b 6572 734d  emory = WorkersM
-00021bb0: 656d 6f72 7928 7363 6865 6475 6c65 722c  emory(scheduler,
-00021bc0: 2077 6964 7468 3d34 3030 2c20 6865 6967   width=400, heig
-00021bd0: 6874 3d34 3030 290a 2020 2020 7469 6d65  ht=400).    time
-00021be0: 7365 7269 6573 203d 2053 7973 7465 6d54  series = SystemT
-00021bf0: 696d 6573 6572 6965 7328 0a20 2020 2020  imeseries(.     
-00021c00: 2020 2073 6368 6564 756c 6572 2c20 7769     scheduler, wi
-00021c10: 6474 683d 3136 3030 2c20 6865 6967 6874  dth=1600, height
-00021c20: 3d32 3030 2c20 666f 6c6c 6f77 5f69 6e74  =200, follow_int
-00021c30: 6572 7661 6c3d 3330 3030 0a20 2020 2029  erval=3000.    )
-00021c40: 0a20 2020 2065 7665 6e74 5f6c 6f6f 7020  .    event_loop 
-00021c50: 3d20 436f 6e74 656e 7469 6f6e 2873 6368  = Contention(sch
-00021c60: 6564 756c 6572 2c20 7769 6474 683d 3230  eduler, width=20
-00021c70: 302c 2068 6569 6768 743d 3430 3029 0a0a  0, height=400)..
-00021c80: 2020 2020 6164 645f 7065 7269 6f64 6963      add_periodic
-00021c90: 5f63 616c 6c62 6163 6b28 646f 632c 2073  _callback(doc, s
-00021ca0: 6875 6666 6c69 6e67 2c20 3230 3029 0a20  huffling, 200). 
-00021cb0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-00021cc0: 6361 6c6c 6261 636b 2864 6f63 2c20 776f  callback(doc, wo
-00021cd0: 726b 6572 735f 6d65 6d6f 7279 2c20 3230  rkers_memory, 20
-00021ce0: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
-00021cf0: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00021d00: 2c20 7469 6d65 7365 7269 6573 2c20 3530  , timeseries, 50
-00021d10: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
-00021d20: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00021d30: 2c20 6576 656e 745f 6c6f 6f70 2c20 3530  , event_loop, 50
-00021d40: 3029 0a0a 2020 2020 7469 6d65 7365 7269  0)..    timeseri
-00021d50: 6573 2e62 616e 6477 6964 7468 2e79 5f72  es.bandwidth.y_r
-00021d60: 616e 6765 203d 2074 696d 6573 6572 6965  ange = timeserie
-00021d70: 732e 6469 736b 2e79 5f72 616e 6765 0a0a  s.disk.y_range..
-00021d80: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
-00021d90: 280a 2020 2020 2020 2020 636f 6c75 6d6e  (.        column
-00021da0: 280a 2020 2020 2020 2020 2020 2020 726f  (.            ro
-00021db0: 7728 0a20 2020 2020 2020 2020 2020 2020  w(.             
-00021dc0: 2020 2077 6f72 6b65 7273 5f6d 656d 6f72     workers_memor
-00021dd0: 792e 726f 6f74 2c0a 2020 2020 2020 2020  y.root,.        
-00021de0: 2020 2020 2020 2020 7368 7566 666c 696e          shufflin
-00021df0: 672e 636f 6d6d 5f6d 656d 6f72 792c 0a20  g.comm_memory,. 
-00021e00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00021e10: 6875 6666 6c69 6e67 2e64 6973 6b5f 6d65  huffling.disk_me
-00021e20: 6d6f 7279 2c0a 2020 2020 2020 2020 2020  mory,.          
-00021e30: 2020 2020 2020 7368 7566 666c 696e 672e        shuffling.
-00021e40: 746f 7461 6c73 2c0a 2020 2020 2020 2020  totals,.        
-00021e50: 2020 2020 2020 2020 6576 656e 745f 6c6f          event_lo
-00021e60: 6f70 2e72 6f6f 742c 0a20 2020 2020 2020  op.root,.       
-00021e70: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00021e80: 2020 2020 726f 7728 636f 6c75 6d6e 2874      row(column(t
-00021e90: 696d 6573 6572 6965 732e 6261 6e64 7769  imeseries.bandwi
-00021ea0: 6474 682c 2074 696d 6573 6572 6965 732e  dth, timeseries.
-00021eb0: 6469 736b 2929 2c0a 2020 2020 2020 2020  disk)),.        
-00021ec0: 290a 2020 2020 290a 2020 2020 646f 632e  ).    ).    doc.
-00021ed0: 7465 6d70 6c61 7465 203d 2065 6e76 2e67  template = env.g
-00021ee0: 6574 5f74 656d 706c 6174 6528 2273 696d  et_template("sim
-00021ef0: 706c 652e 6874 6d6c 2229 0a20 2020 2064  ple.html").    d
-00021f00: 6f63 2e74 656d 706c 6174 655f 7661 7269  oc.template_vari
-00021f10: 6162 6c65 732e 7570 6461 7465 2865 7874  ables.update(ext
-00021f20: 7261 290a 2020 2020 646f 632e 7468 656d  ra).    doc.them
-00021f30: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
-00021f40: 0a0a 406c 6f67 5f65 7272 6f72 730a 6465  ..@log_errors.de
-00021f50: 6620 7374 6561 6c69 6e67 5f64 6f63 2873  f stealing_doc(s
-00021f60: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
-00021f70: 2064 6f63 293a 0a20 2020 206f 6363 7570   doc):.    occup
-00021f80: 616e 6379 203d 204f 6363 7570 616e 6379  ancy = Occupancy
-00021f90: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-00021fa0: 7374 6561 6c69 6e67 5f74 7320 3d20 5374  stealing_ts = St
-00021fb0: 6561 6c69 6e67 5469 6d65 5365 7269 6573  ealingTimeSeries
-00021fc0: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-00021fd0: 7374 6561 6c69 6e67 5f65 7665 6e74 7320  stealing_events 
-00021fe0: 3d20 5374 6561 6c69 6e67 4576 656e 7473  = StealingEvents
-00021ff0: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-00022000: 7374 6561 6c69 6e67 5f65 7665 6e74 732e  stealing_events.
-00022010: 726f 6f74 2e78 5f72 616e 6765 203d 2073  root.x_range = s
-00022020: 7465 616c 696e 675f 7473 2e72 6f6f 742e  tealing_ts.root.
-00022030: 785f 7261 6e67 650a 2020 2020 646f 632e  x_range.    doc.
-00022040: 7469 746c 6520 3d20 2244 6173 6b3a 2057  title = "Dask: W
-00022050: 6f72 6b20 5374 6561 6c69 6e67 220a 2020  ork Stealing".  
-00022060: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-00022070: 616c 6c62 6163 6b28 646f 632c 206f 6363  allback(doc, occ
-00022080: 7570 616e 6379 2c20 3530 3029 0a20 2020  upancy, 500).   
-00022090: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
-000220a0: 6c6c 6261 636b 2864 6f63 2c20 7374 6561  llback(doc, stea
-000220b0: 6c69 6e67 5f74 732c 2035 3030 290a 2020  ling_ts, 500).  
-000220c0: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-000220d0: 616c 6c62 6163 6b28 646f 632c 2073 7465  allback(doc, ste
-000220e0: 616c 696e 675f 6576 656e 7473 2c20 3530  aling_events, 50
-000220f0: 3029 0a0a 2020 2020 646f 632e 6164 645f  0)..    doc.add_
-00022100: 726f 6f74 280a 2020 2020 2020 2020 726f  root(.        ro
-00022110: 7728 0a20 2020 2020 2020 2020 2020 206f  w(.            o
-00022120: 6363 7570 616e 6379 2e72 6f6f 742c 0a20  ccupancy.root,. 
-00022130: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
-00022140: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00022150: 2020 2073 7465 616c 696e 675f 7473 2e72     stealing_ts.r
-00022160: 6f6f 742c 0a20 2020 2020 2020 2020 2020  oot,.           
-00022170: 2020 2020 2073 7465 616c 696e 675f 6576       stealing_ev
-00022180: 656e 7473 2e72 6f6f 742c 0a20 2020 2020  ents.root,.     
-00022190: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
-000221a0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-000221b0: 626f 7468 222c 0a20 2020 2020 2020 2020  both",.         
-000221c0: 2020 2029 2c0a 2020 2020 2020 2020 290a     ),.        ).
-000221d0: 2020 2020 290a 0a20 2020 2064 6f63 2e74      )..    doc.t
-000221e0: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-000221f0: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
-00022200: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
-00022210: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-00022220: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-00022230: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
-00022240: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
-00022250: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
-00022260: 2065 7665 6e74 735f 646f 6328 7363 6865   events_doc(sche
-00022270: 6475 6c65 722c 2065 7874 7261 2c20 646f  duler, extra, do
-00022280: 6329 3a0a 2020 2020 6576 656e 7473 203d  c):.    events =
-00022290: 2045 7665 6e74 7328 7363 6865 6475 6c65   Events(schedule
-000222a0: 722c 2022 616c 6c22 2c20 6865 6967 6874  r, "all", height
-000222b0: 3d32 3530 290a 2020 2020 6576 656e 7473  =250).    events
-000222c0: 2e75 7064 6174 6528 290a 2020 2020 6164  .update().    ad
-000222d0: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
-000222e0: 6163 6b28 646f 632c 2065 7665 6e74 732c  ack(doc, events,
-000222f0: 2035 3030 290a 2020 2020 646f 632e 7469   500).    doc.ti
-00022300: 746c 6520 3d20 2244 6173 6b3a 2053 6368  tle = "Dask: Sch
-00022310: 6564 756c 6572 2045 7665 6e74 7322 0a20  eduler Events". 
-00022320: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
-00022330: 636f 6c75 6d6e 2865 7665 6e74 732e 726f  column(events.ro
-00022340: 6f74 2c20 7369 7a69 6e67 5f6d 6f64 653d  ot, sizing_mode=
-00022350: 2273 6361 6c65 5f77 6964 7468 2229 290a  "scale_width")).
-00022360: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-00022370: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00022380: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00022390: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-000223a0: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-000223b0: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-000223c0: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-000223d0: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
-000223e0: 7272 6f72 730a 6465 6620 6578 6365 7074  rrors.def except
-000223f0: 696f 6e73 5f64 6f63 2873 6368 6564 756c  ions_doc(schedul
-00022400: 6572 2c20 6578 7472 612c 2064 6f63 293a  er, extra, doc):
-00022410: 0a20 2020 2074 6162 6c65 203d 2045 7863  .    table = Exc
-00022420: 6570 7469 6f6e 7354 6162 6c65 2873 6368  eptionsTable(sch
-00022430: 6564 756c 6572 290a 2020 2020 7461 626c  eduler).    tabl
-00022440: 652e 7570 6461 7465 2829 0a20 2020 2061  e.update().    a
-00022450: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
-00022460: 6261 636b 2864 6f63 2c20 7461 626c 652c  back(doc, table,
-00022470: 2031 3030 3029 0a20 2020 2064 6f63 2e74   1000).    doc.t
-00022480: 6974 6c65 203d 2022 4461 736b 3a20 4578  itle = "Dask: Ex
-00022490: 6365 7074 696f 6e73 220a 2020 2020 646f  ceptions".    do
-000224a0: 632e 6164 645f 726f 6f74 2874 6162 6c65  c.add_root(table
-000224b0: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
-000224c0: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-000224d0: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
-000224e0: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
-000224f0: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-00022500: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-00022510: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
-00022520: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
-00022530: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
-00022540: 2077 6f72 6b65 7273 5f64 6f63 2873 6368   workers_doc(sch
-00022550: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
-00022560: 6f63 293a 0a20 2020 2074 6162 6c65 203d  oc):.    table =
-00022570: 2057 6f72 6b65 7254 6162 6c65 2873 6368   WorkerTable(sch
-00022580: 6564 756c 6572 290a 2020 2020 7461 626c  eduler).    tabl
-00022590: 652e 7570 6461 7465 2829 0a20 2020 2061  e.update().    a
-000225a0: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
-000225b0: 6261 636b 2864 6f63 2c20 7461 626c 652c  back(doc, table,
-000225c0: 2035 3030 290a 2020 2020 646f 632e 7469   500).    doc.ti
-000225d0: 746c 6520 3d20 2244 6173 6b3a 2057 6f72  tle = "Dask: Wor
-000225e0: 6b65 7273 220a 2020 2020 646f 632e 6164  kers".    doc.ad
-000225f0: 645f 726f 6f74 2874 6162 6c65 2e72 6f6f  d_root(table.roo
-00022600: 7429 0a20 2020 2064 6f63 2e74 656d 706c  t).    doc.templ
-00022610: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
-00022620: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
-00022630: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
-00022640: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
-00022650: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
-00022660: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
-00022670: 4f4b 4548 5f54 4845 4d45 0a0a 0a40 6c6f  OKEH_THEME...@lo
-00022680: 675f 6572 726f 7273 0a64 6566 2068 6172  g_errors.def har
-00022690: 6477 6172 655f 646f 6328 7363 6865 6475  dware_doc(schedu
-000226a0: 6c65 722c 2065 7874 7261 2c20 646f 6329  ler, extra, doc)
-000226b0: 3a0a 2020 2020 6877 203d 2048 6172 6477  :.    hw = Hardw
-000226c0: 6172 6528 7363 6865 6475 6c65 7229 0a20  are(scheduler). 
-000226d0: 2020 2068 772e 7570 6461 7465 2829 0a20     hw.update(). 
-000226e0: 2020 2064 6f63 2e74 6974 6c65 203d 2022     doc.title = "
-000226f0: 4461 736b 3a20 436c 7573 7465 7220 4861  Dask: Cluster Ha
-00022700: 7264 7761 7265 2042 616e 6477 6964 7468  rdware Bandwidth
-00022710: 220a 2020 2020 646f 632e 6164 645f 726f  ".    doc.add_ro
-00022720: 6f74 2868 772e 726f 6f74 290a 2020 2020  ot(hw.root).    
-00022730: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-00022740: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00022750: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00022760: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-00022770: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-00022780: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-00022790: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-000227a0: 454d 450a 0a20 2020 2061 6464 5f70 6572  EME..    add_per
-000227b0: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-000227c0: 6f63 2c20 6877 2c20 3530 3029 0a0a 0a40  oc, hw, 500)...@
-000227d0: 6c6f 675f 6572 726f 7273 0a64 6566 2074  log_errors.def t
-000227e0: 6173 6b73 5f64 6f63 2873 6368 6564 756c  asks_doc(schedul
-000227f0: 6572 2c20 6578 7472 612c 2064 6f63 293a  er, extra, doc):
-00022800: 0a20 2020 2074 7320 3d20 5461 736b 5374  .    ts = TaskSt
-00022810: 7265 616d 280a 2020 2020 2020 2020 7363  ream(.        sc
-00022820: 6865 6475 6c65 722c 0a20 2020 2020 2020  heduler,.       
-00022830: 206e 5f72 6563 7461 6e67 6c65 733d 6461   n_rectangles=da
-00022840: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
-00022850: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-00022860: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-00022870: 722e 6461 7368 626f 6172 642e 7461 736b  r.dashboard.task
-00022880: 732e 7461 736b 2d73 7472 6561 6d2d 6c65  s.task-stream-le
-00022890: 6e67 7468 220a 2020 2020 2020 2020 292c  ngth".        ),
-000228a0: 0a20 2020 2020 2020 2063 6c65 6172 5f69  .        clear_i
-000228b0: 6e74 6572 7661 6c3d 2236 3073 222c 0a20  nterval="60s",. 
-000228c0: 2020 2020 2020 2073 697a 696e 675f 6d6f         sizing_mo
-000228d0: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
-000228e0: 222c 0a20 2020 2029 0a20 2020 2074 732e  ",.    ).    ts.
-000228f0: 7570 6461 7465 2829 0a20 2020 2061 6464  update().    add
-00022900: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-00022910: 636b 2864 6f63 2c20 7473 2c20 3530 3030  ck(doc, ts, 5000
-00022920: 290a 2020 2020 646f 632e 7469 746c 6520  ).    doc.title 
-00022930: 3d20 2244 6173 6b3a 2054 6173 6b20 5374  = "Dask: Task St
-00022940: 7265 616d 220a 2020 2020 646f 632e 6164  ream".    doc.ad
-00022950: 645f 726f 6f74 2874 732e 726f 6f74 290a  d_root(ts.root).
-00022960: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-00022970: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00022980: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00022990: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-000229a0: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-000229b0: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-000229c0: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-000229d0: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
-000229e0: 7272 6f72 730a 6465 6620 6772 6170 685f  rrors.def graph_
-000229f0: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
-00022a00: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
-00022a10: 6772 6170 6820 3d20 5461 736b 4772 6170  graph = TaskGrap
-00022a20: 6828 7363 6865 6475 6c65 722c 2073 697a  h(scheduler, siz
-00022a30: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00022a40: 685f 626f 7468 2229 0a20 2020 2064 6f63  h_both").    doc
-00022a50: 2e74 6974 6c65 203d 2022 4461 736b 3a20  .title = "Dask: 
-00022a60: 5461 736b 2047 7261 7068 220a 2020 2020  Task Graph".    
-00022a70: 6772 6170 682e 7570 6461 7465 2829 0a20  graph.update(). 
-00022a80: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-00022a90: 6361 6c6c 6261 636b 2864 6f63 2c20 6772  callback(doc, gr
-00022aa0: 6170 682c 2032 3030 290a 2020 2020 646f  aph, 200).    do
-00022ab0: 632e 6164 645f 726f 6f74 2867 7261 7068  c.add_root(graph
-00022ac0: 2e72 6f6f 7429 0a0a 2020 2020 646f 632e  .root)..    doc.
-00022ad0: 7465 6d70 6c61 7465 203d 2065 6e76 2e67  template = env.g
-00022ae0: 6574 5f74 656d 706c 6174 6528 2273 696d  et_template("sim
-00022af0: 706c 652e 6874 6d6c 2229 0a20 2020 2064  ple.html").    d
-00022b00: 6f63 2e74 656d 706c 6174 655f 7661 7269  oc.template_vari
-00022b10: 6162 6c65 732e 7570 6461 7465 2865 7874  ables.update(ext
-00022b20: 7261 290a 2020 2020 646f 632e 7468 656d  ra).    doc.them
-00022b30: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
-00022b40: 0a0a 406c 6f67 5f65 7272 6f72 730a 6465  ..@log_errors.de
-00022b50: 6620 7467 5f67 7261 7068 5f64 6f63 2873  f tg_graph_doc(s
-00022b60: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
-00022b70: 2064 6f63 293a 0a20 2020 2074 675f 6772   doc):.    tg_gr
-00022b80: 6170 6820 3d20 5461 736b 4772 6f75 7047  aph = TaskGroupG
-00022b90: 7261 7068 2873 6368 6564 756c 6572 2c20  raph(scheduler, 
-00022ba0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00022bb0: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
-00022bc0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
-00022bd0: 6b3a 2054 6173 6b20 4772 6f75 7073 2047  k: Task Groups G
-00022be0: 7261 7068 220a 2020 2020 7467 5f67 7261  raph".    tg_gra
-00022bf0: 7068 2e75 7064 6174 6528 290a 2020 2020  ph.update().    
-00022c00: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
-00022c10: 6c62 6163 6b28 646f 632c 2074 675f 6772  lback(doc, tg_gr
-00022c20: 6170 682c 2032 3030 290a 2020 2020 646f  aph, 200).    do
-00022c30: 632e 6164 645f 726f 6f74 2874 675f 6772  c.add_root(tg_gr
-00022c40: 6170 682e 726f 6f74 290a 2020 2020 646f  aph.root).    do
-00022c50: 632e 7465 6d70 6c61 7465 203d 2065 6e76  c.template = env
-00022c60: 2e67 6574 5f74 656d 706c 6174 6528 2273  .get_template("s
-00022c70: 696d 706c 652e 6874 6d6c 2229 0a20 2020  imple.html").   
-00022c80: 2064 6f63 2e74 656d 706c 6174 655f 7661   doc.template_va
-00022c90: 7269 6162 6c65 732e 7570 6461 7465 2865  riables.update(e
-00022ca0: 7874 7261 290a 2020 2020 646f 632e 7468  xtra).    doc.th
-00022cb0: 656d 6520 3d20 424f 4b45 485f 5448 454d  eme = BOKEH_THEM
-00022cc0: 450a 0a0a 406c 6f67 5f65 7272 6f72 730a  E...@log_errors.
-00022cd0: 6465 6620 7374 6174 7573 5f64 6f63 2873  def status_doc(s
-00022ce0: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
-00022cf0: 2064 6f63 293a 0a20 2020 2063 6c75 7374   doc):.    clust
-00022d00: 6572 5f6d 656d 6f72 7920 3d20 436c 7573  er_memory = Clus
-00022d10: 7465 724d 656d 6f72 7928 7363 6865 6475  terMemory(schedu
-00022d20: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
-00022d30: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
-00022d40: 0a20 2020 2063 6c75 7374 6572 5f6d 656d  .    cluster_mem
-00022d50: 6f72 792e 7570 6461 7465 2829 0a20 2020  ory.update().   
-00022d60: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
-00022d70: 6c6c 6261 636b 2864 6f63 2c20 636c 7573  llback(doc, clus
-00022d80: 7465 725f 6d65 6d6f 7279 2c20 3130 3029  ter_memory, 100)
-00022d90: 0a20 2020 2064 6f63 2e61 6464 5f72 6f6f  .    doc.add_roo
-00022da0: 7428 636c 7573 7465 725f 6d65 6d6f 7279  t(cluster_memory
-00022db0: 2e72 6f6f 7429 0a0a 2020 2020 6966 206c  .root)..    if l
-00022dc0: 656e 2873 6368 6564 756c 6572 2e77 6f72  en(scheduler.wor
-00022dd0: 6b65 7273 2920 3c3d 2031 3030 3a0a 2020  kers) <= 100:.  
-00022de0: 2020 2020 2020 776f 726b 6572 735f 6d65        workers_me
-00022df0: 6d6f 7279 203d 2057 6f72 6b65 7273 4d65  mory = WorkersMe
-00022e00: 6d6f 7279 2873 6368 6564 756c 6572 2c20  mory(scheduler, 
-00022e10: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00022e20: 6574 6368 5f62 6f74 6822 290a 0a20 2020  etch_both")..   
-00022e30: 2020 2020 2070 726f 6365 7373 696e 6720       processing 
-00022e40: 3d20 4375 7272 656e 744c 6f61 6428 7363  = CurrentLoad(sc
-00022e50: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-00022e60: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00022e70: 7468 2229 0a0a 2020 2020 2020 2020 7072  th")..        pr
-00022e80: 6f63 6573 7369 6e67 5f72 6f6f 7420 3d20  ocessing_root = 
-00022e90: 7072 6f63 6573 7369 6e67 2e70 726f 6365  processing.proce
-00022ea0: 7373 696e 675f 6669 6775 7265 0a20 2020  ssing_figure.   
-00022eb0: 2065 6c73 653a 0a20 2020 2020 2020 2077   else:.        w
-00022ec0: 6f72 6b65 7273 5f6d 656d 6f72 7920 3d20  orkers_memory = 
-00022ed0: 576f 726b 6572 734d 656d 6f72 7948 6973  WorkersMemoryHis
-00022ee0: 746f 6772 616d 2873 6368 6564 756c 6572  togram(scheduler
-00022ef0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00022f00: 7472 6574 6368 5f62 6f74 6822 290a 2020  tretch_both").  
-00022f10: 2020 2020 2020 7072 6f63 6573 7369 6e67        processing
-00022f20: 203d 2050 726f 6365 7373 696e 6748 6973   = ProcessingHis
-00022f30: 746f 6772 616d 2873 6368 6564 756c 6572  togram(scheduler
-00022f40: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00022f50: 7472 6574 6368 5f62 6f74 6822 290a 0a20  tretch_both").. 
-00022f60: 2020 2020 2020 2070 726f 6365 7373 696e         processin
-00022f70: 675f 726f 6f74 203d 2070 726f 6365 7373  g_root = process
-00022f80: 696e 672e 726f 6f74 0a0a 2020 2020 6375  ing.root..    cu
-00022f90: 7272 656e 745f 6c6f 6164 203d 2043 7572  rrent_load = Cur
-00022fa0: 7265 6e74 4c6f 6164 2873 6368 6564 756c  rentLoad(schedul
-00022fb0: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
-00022fc0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-00022fd0: 2020 2020 6f63 6375 7061 6e63 7920 3d20      occupancy = 
-00022fe0: 4f63 6375 7061 6e63 7928 7363 6865 6475  Occupancy(schedu
-00022ff0: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
-00023000: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
-00023010: 0a20 2020 2077 6f72 6b65 7273 5f74 7261  .    workers_tra
-00023020: 6e73 6665 725f 6279 7465 7320 3d20 576f  nsfer_bytes = Wo
-00023030: 726b 6572 7354 7261 6e73 6665 7242 7974  rkersTransferByt
-00023040: 6573 2873 6368 6564 756c 6572 2c20 7369  es(scheduler, si
-00023050: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
-00023060: 6368 5f62 6f74 6822 290a 0a20 2020 2063  ch_both")..    c
-00023070: 7075 5f72 6f6f 7420 3d20 6375 7272 656e  pu_root = curren
-00023080: 745f 6c6f 6164 2e63 7075 5f66 6967 7572  t_load.cpu_figur
-00023090: 650a 2020 2020 6f63 6375 7061 6e63 795f  e.    occupancy_
-000230a0: 726f 6f74 203d 206f 6363 7570 616e 6379  root = occupancy
-000230b0: 2e72 6f6f 740a 0a20 2020 2077 6f72 6b65  .root..    worke
-000230c0: 7273 5f6d 656d 6f72 792e 7570 6461 7465  rs_memory.update
-000230d0: 2829 0a20 2020 2077 6f72 6b65 7273 5f74  ().    workers_t
-000230e0: 7261 6e73 6665 725f 6279 7465 732e 7570  ransfer_bytes.up
-000230f0: 6461 7465 2829 0a20 2020 2070 726f 6365  date().    proce
-00023100: 7373 696e 672e 7570 6461 7465 2829 0a20  ssing.update(). 
-00023110: 2020 2063 7572 7265 6e74 5f6c 6f61 642e     current_load.
-00023120: 7570 6461 7465 2829 0a20 2020 206f 6363  update().    occ
-00023130: 7570 616e 6379 2e75 7064 6174 6528 290a  upancy.update().
-00023140: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-00023150: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-00023160: 776f 726b 6572 735f 6d65 6d6f 7279 2c20  workers_memory, 
-00023170: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
-00023180: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00023190: 6f63 2c20 776f 726b 6572 735f 7472 616e  oc, workers_tran
-000231a0: 7366 6572 5f62 7974 6573 2c20 3130 3029  sfer_bytes, 100)
-000231b0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-000231c0: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-000231d0: 7072 6f63 6573 7369 6e67 2c20 3130 3029  processing, 100)
-000231e0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-000231f0: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-00023200: 6375 7272 656e 745f 6c6f 6164 2c20 3130  current_load, 10
-00023210: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
-00023220: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00023230: 2c20 6f63 6375 7061 6e63 792c 2031 3030  , occupancy, 100
-00023240: 290a 0a20 2020 2064 6f63 2e61 6464 5f72  )..    doc.add_r
-00023250: 6f6f 7428 776f 726b 6572 735f 6d65 6d6f  oot(workers_memo
-00023260: 7279 2e72 6f6f 7429 0a0a 2020 2020 7461  ry.root)..    ta
-00023270: 6273 203d 205b 0a20 2020 2020 2020 2054  bs = [.        T
-00023280: 6162 5061 6e65 6c28 6368 696c 643d 7072  abPanel(child=pr
-00023290: 6f63 6573 7369 6e67 5f72 6f6f 742c 2074  ocessing_root, t
-000232a0: 6974 6c65 3d22 5072 6f63 6573 7369 6e67  itle="Processing
-000232b0: 2229 2c0a 2020 2020 2020 2020 5461 6250  "),.        TabP
-000232c0: 616e 656c 2863 6869 6c64 3d63 7075 5f72  anel(child=cpu_r
-000232d0: 6f6f 742c 2074 6974 6c65 3d22 4350 5522  oot, title="CPU"
-000232e0: 292c 0a20 2020 2020 2020 2054 6162 5061  ),.        TabPa
-000232f0: 6e65 6c28 6368 696c 643d 6f63 6375 7061  nel(child=occupa
-00023300: 6e63 795f 726f 6f74 2c20 7469 746c 653d  ncy_root, title=
-00023310: 224f 6363 7570 616e 6379 2229 2c0a 2020  "Occupancy"),.  
-00023320: 2020 2020 2020 5461 6250 616e 656c 2863        TabPanel(c
-00023330: 6869 6c64 3d77 6f72 6b65 7273 5f74 7261  hild=workers_tra
-00023340: 6e73 6665 725f 6279 7465 732e 726f 6f74  nsfer_bytes.root
-00023350: 2c20 7469 746c 653d 2244 6174 6120 5472  , title="Data Tr
-00023360: 616e 7366 6572 2229 2c0a 2020 2020 5d0a  ansfer"),.    ].
-00023370: 0a20 2020 2068 656c 705f 203d 2048 656c  .    help_ = Hel
-00023380: 7054 6f6f 6c28 0a20 2020 2020 2020 2072  pTool(.        r
-00023390: 6564 6972 6563 743d 2268 7474 7073 3a2f  edirect="https:/
-000233a0: 2f64 6f63 732e 6461 736b 2e6f 7267 2f65  /docs.dask.org/e
-000233b0: 6e2f 7374 6162 6c65 2f64 6173 6862 6f61  n/stable/dashboa
-000233c0: 7264 2e68 746d 6c23 7461 736b 2d70 726f  rd.html#task-pro
-000233d0: 6365 7373 696e 672d 6370 752d 7574 696c  cessing-cpu-util
-000233e0: 697a 6174 696f 6e2d 6f63 6375 7061 6e63  ization-occupanc
-000233f0: 792d 6461 7461 2d74 7261 6e73 6665 7222  y-data-transfer"
-00023400: 2c0a 2020 2020 2020 2020 6465 7363 7269  ,.        descri
-00023410: 7074 696f 6e3d 2241 2064 6573 6372 6970  ption="A descrip
-00023420: 7469 6f6e 206f 6620 5461 736b 2050 726f  tion of Task Pro
-00023430: 6365 7373 696e 672f 4350 5520 5574 696c  cessing/CPU Util
-00023440: 697a 6174 696f 6e2f 4f63 6375 7061 6e63  ization/Occupanc
-00023450: 7922 2c0a 2020 2020 290a 2020 2020 666f  y",.    ).    fo
-00023460: 7220 7461 6220 696e 2074 6162 733a 0a20  r tab in tabs:. 
-00023470: 2020 2020 2020 2074 6162 2e63 6869 6c64         tab.child
-00023480: 2e74 6f6f 6c62 6172 5f6c 6f63 6174 696f  .toolbar_locatio
-00023490: 6e20 3d20 2261 626f 7665 220a 2020 2020  n = "above".    
-000234a0: 2020 2020 7461 622e 6368 696c 642e 6164      tab.child.ad
-000234b0: 645f 746f 6f6c 7328 6865 6c70 5f29 0a0a  d_tools(help_)..
-000234c0: 2020 2020 7072 6f63 5f74 6162 7320 3d20      proc_tabs = 
-000234d0: 5461 6273 2874 6162 733d 7461 6273 2c20  Tabs(tabs=tabs, 
-000234e0: 6e61 6d65 3d22 7072 6f63 6573 7369 6e67  name="processing
-000234f0: 5f74 6162 7322 2c20 7369 7a69 6e67 5f6d  _tabs", sizing_m
-00023500: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
-00023510: 6822 290a 2020 2020 646f 632e 6164 645f  h").    doc.add_
-00023520: 726f 6f74 2870 726f 635f 7461 6273 290a  root(proc_tabs).
-00023530: 0a20 2020 2074 6173 6b5f 7374 7265 616d  .    task_stream
-00023540: 203d 2054 6173 6b53 7472 6561 6d28 0a20   = TaskStream(. 
-00023550: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
-00023560: 2c0a 2020 2020 2020 2020 6e5f 7265 6374  ,.        n_rect
-00023570: 616e 676c 6573 3d64 6173 6b2e 636f 6e66  angles=dask.conf
-00023580: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
-00023590: 2020 2020 2264 6973 7472 6962 7574 6564      "distributed
-000235a0: 2e73 6368 6564 756c 6572 2e64 6173 6862  .scheduler.dashb
-000235b0: 6f61 7264 2e73 7461 7475 732e 7461 736b  oard.status.task
-000235c0: 2d73 7472 6561 6d2d 6c65 6e67 7468 220a  -stream-length".
-000235d0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-000235e0: 2020 2063 6c65 6172 5f69 6e74 6572 7661     clear_interva
-000235f0: 6c3d 2235 7322 2c0a 2020 2020 2020 2020  l="5s",.        
-00023600: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00023610: 6574 6368 5f62 6f74 6822 2c0a 2020 2020  etch_both",.    
-00023620: 290a 2020 2020 7461 736b 5f73 7472 6561  ).    task_strea
-00023630: 6d2e 7570 6461 7465 2829 0a20 2020 2061  m.update().    a
-00023640: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
-00023650: 6261 636b 2864 6f63 2c20 7461 736b 5f73  back(doc, task_s
-00023660: 7472 6561 6d2c 2031 3030 290a 2020 2020  tream, 100).    
-00023670: 646f 632e 6164 645f 726f 6f74 2874 6173  doc.add_root(tas
-00023680: 6b5f 7374 7265 616d 2e72 6f6f 7429 0a0a  k_stream.root)..
-00023690: 2020 2020 7461 736b 5f70 726f 6772 6573      task_progres
-000236a0: 7320 3d20 5461 736b 5072 6f67 7265 7373  s = TaskProgress
-000236b0: 2873 6368 6564 756c 6572 2c20 7369 7a69  (scheduler, sizi
-000236c0: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-000236d0: 5f62 6f74 6822 290a 2020 2020 7461 736b  _both").    task
-000236e0: 5f70 726f 6772 6573 732e 7570 6461 7465  _progress.update
-000236f0: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
-00023700: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00023710: 2c20 7461 736b 5f70 726f 6772 6573 732c  , task_progress,
-00023720: 2031 3030 290a 2020 2020 646f 632e 6164   100).    doc.ad
-00023730: 645f 726f 6f74 2874 6173 6b5f 7072 6f67  d_root(task_prog
-00023740: 7265 7373 2e72 6f6f 7429 0a0a 2020 2020  ress.root)..    
-00023750: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
-00023760: 6b3a 2053 7461 7475 7322 0a20 2020 2064  k: Status".    d
-00023770: 6f63 2e74 6865 6d65 203d 2042 4f4b 4548  oc.theme = BOKEH
-00023780: 5f54 4845 4d45 0a20 2020 2064 6f63 2e74  _THEME.    doc.t
-00023790: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-000237a0: 745f 7465 6d70 6c61 7465 2822 7374 6174  t_template("stat
-000237b0: 7573 2e68 746d 6c22 290a 2020 2020 646f  us.html").    do
-000237c0: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-000237d0: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-000237e0: 6129 0a0a 0a40 6375 7272 790a 6465 6620  a)...@curry.def 
-000237f0: 696e 6469 7669 6475 616c 5f64 6f63 2863  individual_doc(c
-00023800: 6c73 2c20 696e 7465 7276 616c 2c20 7363  ls, interval, sc
-00023810: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
-00023820: 646f 632c 2066 6967 5f61 7474 723d 2272  doc, fig_attr="r
-00023830: 6f6f 7422 2c20 2a2a 6b77 6172 6773 293a  oot", **kwargs):
-00023840: 0a20 2020 2023 204e 6f74 653a 2040 6c6f  .    # Note: @lo
-00023850: 675f 6572 726f 7273 2061 6e64 2040 6375  g_errors and @cu
-00023860: 7272 7920 6172 6520 6e6f 7420 636f 6d70  rry are not comp
-00023870: 6174 6962 6c65 0a20 2020 2077 6974 6820  atible.    with 
-00023880: 6c6f 675f 6572 726f 7273 2829 3a0a 2020  log_errors():.  
-00023890: 2020 2020 2020 6669 6720 3d20 636c 7328        fig = cls(
-000238a0: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
-000238b0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-000238c0: 626f 7468 222c 202a 2a6b 7761 7267 7329  both", **kwargs)
-000238d0: 0a20 2020 2020 2020 2066 6967 2e75 7064  .        fig.upd
-000238e0: 6174 6528 290a 2020 2020 2020 2020 6164  ate().        ad
-000238f0: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
-00023900: 6163 6b28 646f 632c 2066 6967 2c20 696e  ack(doc, fig, in
-00023910: 7465 7276 616c 290a 2020 2020 2020 2020  terval).        
-00023920: 646f 632e 6164 645f 726f 6f74 2867 6574  doc.add_root(get
-00023930: 6174 7472 2866 6967 2c20 6669 675f 6174  attr(fig, fig_at
-00023940: 7472 2929 0a20 2020 2020 2020 2064 6f63  tr)).        doc
-00023950: 2e74 6865 6d65 203d 2042 4f4b 4548 5f54  .theme = BOKEH_T
-00023960: 4845 4d45 0a20 2020 2020 2020 2064 6f63  HEME.        doc
-00023970: 2e74 6974 6c65 203d 2022 4461 736b 3a20  .title = "Dask: 
-00023980: 2220 2b20 6675 6e63 6e61 6d65 2863 6c73  " + funcname(cls
-00023990: 290a 0a0a 406c 6f67 5f65 7272 6f72 730a  )...@log_errors.
-000239a0: 6465 6620 696e 6469 7669 6475 616c 5f70  def individual_p
-000239b0: 726f 6669 6c65 5f64 6f63 2873 6368 6564  rofile_doc(sched
-000239c0: 756c 6572 2c20 6578 7472 612c 2064 6f63  uler, extra, doc
-000239d0: 293a 0a20 2020 2070 726f 6620 3d20 5072  ):.    prof = Pr
-000239e0: 6f66 696c 6554 696d 6550 6c6f 7428 7363  ofileTimePlot(sc
-000239f0: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-00023a00: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00023a10: 7468 222c 2064 6f63 3d64 6f63 290a 2020  th", doc=doc).  
-00023a20: 2020 646f 632e 6164 645f 726f 6f74 2870    doc.add_root(p
-00023a30: 726f 662e 726f 6f74 290a 2020 2020 7072  rof.root).    pr
-00023a40: 6f66 2e74 7269 6767 6572 5f75 7064 6174  of.trigger_updat
-00023a50: 6528 290a 2020 2020 646f 632e 7468 656d  e().    doc.them
-00023a60: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
-00023a70: 0a0a 406c 6f67 5f65 7272 6f72 730a 6465  ..@log_errors.de
-00023a80: 6620 696e 6469 7669 6475 616c 5f70 726f  f individual_pro
-00023a90: 6669 6c65 5f73 6572 7665 725f 646f 6328  file_server_doc(
-00023aa0: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
-00023ab0: 2c20 646f 6329 3a0a 2020 2020 7072 6f66  , doc):.    prof
-00023ac0: 203d 2050 726f 6669 6c65 5365 7276 6572   = ProfileServer
-00023ad0: 2873 6368 6564 756c 6572 2c20 7369 7a69  (scheduler, sizi
-00023ae0: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00023af0: 5f62 6f74 6822 2c20 646f 633d 646f 6329  _both", doc=doc)
-00023b00: 0a20 2020 2064 6f63 2e61 6464 5f72 6f6f  .    doc.add_roo
-00023b10: 7428 7072 6f66 2e72 6f6f 7429 0a20 2020  t(prof.root).   
-00023b20: 2070 726f 662e 7472 6967 6765 725f 7570   prof.trigger_up
-00023b30: 6461 7465 2829 0a20 2020 2064 6f63 2e74  date().    doc.t
-00023b40: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
-00023b50: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
-00023b60: 0a64 6566 2070 726f 6669 6c65 5f64 6f63  .def profile_doc
-00023b70: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
-00023b80: 612c 2064 6f63 293a 0a20 2020 2064 6f63  a, doc):.    doc
-00023b90: 2e74 6974 6c65 203d 2022 4461 736b 3a20  .title = "Dask: 
-00023ba0: 5072 6f66 696c 6522 0a20 2020 2070 726f  Profile".    pro
-00023bb0: 6620 3d20 5072 6f66 696c 6554 696d 6550  f = ProfileTimeP
-00023bc0: 6c6f 7428 7363 6865 6475 6c65 722c 2073  lot(scheduler, s
-00023bd0: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
-00023be0: 7463 685f 626f 7468 222c 2064 6f63 3d64  tch_both", doc=d
-00023bf0: 6f63 290a 2020 2020 646f 632e 6164 645f  oc).    doc.add_
-00023c00: 726f 6f74 2870 726f 662e 726f 6f74 290a  root(prof.root).
-00023c10: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-00023c20: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00023c30: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00023c40: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-00023c50: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-00023c60: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-00023c70: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-00023c80: 485f 5448 454d 450a 0a20 2020 2070 726f  H_THEME..    pro
-00023c90: 662e 7472 6967 6765 725f 7570 6461 7465  f.trigger_update
-00023ca0: 2829 0a0a 0a40 6c6f 675f 6572 726f 7273  ()...@log_errors
-00023cb0: 0a64 6566 2070 726f 6669 6c65 5f73 6572  .def profile_ser
-00023cc0: 7665 725f 646f 6328 7363 6865 6475 6c65  ver_doc(schedule
-00023cd0: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
-00023ce0: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
-00023cf0: 2244 6173 6b3a 2050 726f 6669 6c65 206f  "Dask: Profile o
-00023d00: 6620 4576 656e 7420 4c6f 6f70 220a 2020  f Event Loop".  
-00023d10: 2020 7072 6f66 203d 2050 726f 6669 6c65    prof = Profile
-00023d20: 5365 7276 6572 2873 6368 6564 756c 6572  Server(scheduler
-00023d30: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00023d40: 7472 6574 6368 5f62 6f74 6822 2c20 646f  tretch_both", do
-00023d50: 633d 646f 6329 0a20 2020 2064 6f63 2e61  c=doc).    doc.a
-00023d60: 6464 5f72 6f6f 7428 7072 6f66 2e72 6f6f  dd_root(prof.roo
-00023d70: 7429 0a20 2020 2064 6f63 2e74 656d 706c  t).    doc.templ
-00023d80: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
-00023d90: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
-00023da0: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
-00023db0: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
-00023dc0: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
-00023dd0: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
-00023de0: 4f4b 4548 5f54 4845 4d45 0a0a 2020 2020  OKEH_THEME..    
-00023df0: 7072 6f66 2e74 7269 6767 6572 5f75 7064  prof.trigger_upd
-00023e00: 6174 6528 290a                           ate().
+00019690: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2520                % 
+000196b0: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
+000196c0: 2020 2020 2020 2020 2020 2020 2020 7a69                zi
+000196d0: 7028 7374 6163 6b65 7273 2c20 636f 6c6f  p(stackers, colo
+000196e0: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
+000196f0: 2020 2020 2020 2020 292c 2020 2320 736e          ),  # sn
+00019700: 6561 6b20 7468 6520 636f 6c6f 7220 6d61  eak the color ma
+00019710: 7070 696e 6720 696e 746f 2074 6865 2063  pping into the c
+00019720: 616c 6c62 6163 6b0a 2020 2020 2020 2020  allback.        
+00019730: 2020 2020 2020 2020 2020 2020 6172 6773              args
+00019740: 3d7b 2273 6f75 7263 6522 3a20 7365 6c66  ={"source": self
+00019750: 2e73 6f75 7263 657d 2c0a 2020 2020 2020  .source},.      
+00019760: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00019770: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
+00019780: 6420 7468 6520 486f 7665 7254 6f6f 6c20  d the HoverTool 
+00019790: 746f 2074 6865 2074 6f70 206c 696e 6520  to the top line 
+000197a0: 7265 6e64 6572 6572 2e0a 2020 2020 2020  renderer..      
+000197b0: 2020 2020 2020 2020 2020 746f 705f 6c69            top_li
+000197c0: 6e65 203d 204e 6f6e 650a 2020 2020 2020  ne = None.      
+000197d0: 2020 2020 2020 2020 2020 666f 7220 6c69            for li
+000197e0: 6e65 2069 6e20 7265 7665 7273 6564 2873  ne in reversed(s
+000197f0: 656c 662e 5f6c 696e 655f 7265 6e64 6572  elf._line_render
+00019800: 6572 732e 7661 6c75 6573 2829 293a 0a20  ers.values()):. 
+00019810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019820: 2020 2069 6620 6c69 6e65 2e76 6973 6962     if line.visib
+00019830: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00019840: 2020 2020 2020 2020 2020 2020 746f 705f              top_
+00019850: 6c69 6e65 203d 206c 696e 650a 2020 2020  line = line.    
+00019860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019870: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00019880: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00019890: 686f 7665 722e 7265 6e64 6572 6572 7320  hover.renderers 
+000198a0: 3d20 5b74 6f70 5f6c 696e 655d 0a20 2020  = [top_line].   
+000198b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000198c0: 662e 5f68 6f76 6572 2e66 6f72 6d61 7474  f._hover.formatt
+000198d0: 6572 7320 3d20 7b22 2469 6e64 6578 223a  ers = {"$index":
+000198e0: 2066 6f72 6d61 7474 6572 7d0a 0a20 2020   formatter}..   
+000198f0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+00019900: 6173 745f 6472 6177 6e20 3d20 7469 6d65  ast_drawn = time
+00019910: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+00019920: 656c 662e 5f6c 6173 745f 7472 616e 7369  elf._last_transi
+00019930: 7469 6f6e 5f63 6f75 6e74 203d 2073 656c  tion_count = sel
+00019940: 662e 7363 6865 6475 6c65 722e 7472 616e  f.scheduler.tran
+00019950: 7369 7469 6f6e 5f63 6f75 6e74 6572 0a20  sition_counter. 
+00019960: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00019970: 2e5f 7368 6f75 6c64 5f75 7064 6174 6528  ._should_update(
+00019980: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+00019990: 2050 6f73 7369 626c 7920 7570 6461 7465   Possibly update
+000199a0: 2074 6865 2079 2072 616e 6765 2069 6620   the y range if 
+000199b0: 6e65 7720 7468 7265 6164 7320 6861 7665  new threads have
+000199c0: 2062 6565 6e20 6164 6465 640a 2020 2020   been added.    
+000199d0: 2020 2020 2020 2020 6d61 785f 6e74 6872          max_nthr
+000199e0: 6561 6473 203d 206d 6178 2873 656c 662e  eads = max(self.
+000199f0: 706c 7567 696e 2e6e 7468 7265 6164 7329  plugin.nthreads)
+00019a00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00019a10: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
+00019a20: 652e 656e 6420 213d 206d 6178 5f6e 7468  e.end != max_nth
+00019a30: 7265 6164 733a 0a20 2020 2020 2020 2020  reads:.         
+00019a40: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00019a50: 2e79 5f72 616e 6765 2e65 6e64 203d 206d  .y_range.end = m
+00019a60: 6178 5f6e 7468 7265 6164 730a 2020 2020  ax_nthreads.    
+00019a70: 2020 2020 2020 2020 2320 5570 6461 7465          # Update
+00019a80: 2074 6865 2064 6174 612c 206f 6e6c 7920   the data, only 
+00019a90: 696e 636c 7564 696e 6720 6578 6973 7469  including existi
+00019aa0: 6e67 2063 6f6c 756d 6e73 2c20 7261 7468  ng columns, rath
+00019ab0: 6572 2074 6861 6e20 7265 6472 6177 696e  er than redrawin
+00019ac0: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
+00019ad0: 7468 6520 7768 6f6c 6520 6368 6172 742e  the whole chart.
+00019ae0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00019af0: 662e 736f 7572 6365 2e64 6174 6120 3d20  f.source.data = 
+00019b00: 7365 6c66 2e5f 6765 745f 7469 6d65 7365  self._get_timese
+00019b10: 7269 6573 2872 6573 7472 6963 745f 746f  ries(restrict_to
+00019b20: 5f65 7869 7374 696e 673d 5472 7565 290a  _existing=True).
+00019b30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019b40: 2e5f 6c61 7374 5f74 7261 6e73 6974 696f  ._last_transitio
+00019b50: 6e5f 636f 756e 7420 3d20 7365 6c66 2e73  n_count = self.s
+00019b60: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+00019b70: 696f 6e5f 636f 756e 7465 720a 0a0a 636c  ion_counter...cl
+00019b80: 6173 7320 5461 736b 5072 6f67 7265 7373  ass TaskProgress
+00019b90: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
+00019ba0: 656e 7429 3a0a 2020 2020 2222 2250 726f  ent):.    """Pro
+00019bb0: 6772 6573 7320 6261 7273 2070 6572 2074  gress bars per t
+00019bc0: 6173 6b20 7479 7065 2222 220a 0a20 2020  ask type"""..   
+00019bd0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00019be0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
+00019bf0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00019c00: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+00019c10: 203d 2073 6368 6564 756c 6572 0a0a 2020   = scheduler..  
+00019c20: 2020 2020 2020 6461 7461 203d 2070 726f        data = pro
+00019c30: 6772 6573 735f 7175 6164 7328 0a20 2020  gress_quads(.   
+00019c40: 2020 2020 2020 2020 2064 6963 7428 616c           dict(al
+00019c50: 6c3d 7b7d 2c20 6d65 6d6f 7279 3d7b 7d2c  l={}, memory={},
+00019c60: 2065 7272 6564 3d7b 7d2c 2072 656c 6561   erred={}, relea
+00019c70: 7365 643d 7b7d 2c20 7072 6f63 6573 7369  sed={}, processi
+00019c80: 6e67 3d7b 7d2c 2071 7565 7565 643d 7b7d  ng={}, queued={}
+00019c90: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00019ca0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+00019cb0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+00019cc0: 6365 2864 6174 613d 6461 7461 290a 0a20  ce(data=data).. 
+00019cd0: 2020 2020 2020 2078 5f72 616e 6765 203d         x_range =
+00019ce0: 2044 6174 6152 616e 6765 3164 2872 616e   DataRange1d(ran
+00019cf0: 6765 5f70 6164 6469 6e67 3d30 290a 2020  ge_padding=0).  
+00019d00: 2020 2020 2020 795f 7261 6e67 6520 3d20        y_range = 
+00019d10: 5261 6e67 6531 6428 2d38 2c20 3029 0a0a  Range1d(-8, 0)..
+00019d20: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00019d30: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+00019d40: 2020 2020 2020 2020 7469 746c 653d 2250          title="P
+00019d50: 726f 6772 6573 7322 2c0a 2020 2020 2020  rogress",.      
+00019d60: 2020 2020 2020 6e61 6d65 3d22 7461 736b        name="task
+00019d70: 5f70 726f 6772 6573 7322 2c0a 2020 2020  _progress",.    
+00019d80: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+00019d90: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
+00019da0: 2020 2020 2079 5f72 616e 6765 3d79 5f72       y_range=y_r
+00019db0: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
+00019dc0: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
+00019dd0: 6f6e 3d22 6162 6f76 6522 2c0a 2020 2020  on="above",.    
+00019de0: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
+00019df0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
+00019e00: 6e5f 626f 7264 6572 5f62 6f74 746f 6d3d  n_border_bottom=
+00019e10: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
+00019e20: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+00019e30: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00019e40: 2e72 6f6f 742e 6c69 6e65 2820 2023 206a  .root.line(  # j
+00019e50: 7573 7420 746f 2064 6566 696e 6520 6561  ust to define ea
+00019e60: 726c 7920 7261 6e67 6573 0a20 2020 2020  rly ranges.     
+00019e70: 2020 2020 2020 2078 3d5b 302c 2030 2e39         x=[0, 0.9
+00019e80: 5d2c 2079 3d5b 2d31 2c20 305d 2c20 6c69  ], y=[-1, 0], li
+00019e90: 6e65 5f63 6f6c 6f72 3d22 2346 4646 4646  ne_color="#FFFFF
+00019ea0: 4622 2c20 616c 7068 613d 302e 300a 2020  F", alpha=0.0.  
+00019eb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00019ec0: 7365 6c66 2e72 6f6f 742e 7175 6164 280a  self.root.quad(.
+00019ed0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00019ee0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
+00019ef0: 2020 2020 2020 2020 2020 2020 746f 703d              top=
+00019f00: 2274 6f70 222c 0a20 2020 2020 2020 2020  "top",.         
+00019f10: 2020 2062 6f74 746f 6d3d 2262 6f74 746f     bottom="botto
+00019f20: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
+00019f30: 6c65 6674 3d22 6c65 6674 222c 0a20 2020  left="left",.   
+00019f40: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
+00019f50: 7269 6768 7422 2c0a 2020 2020 2020 2020  right",.        
+00019f60: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+00019f70: 2361 6161 6161 6122 2c0a 2020 2020 2020  #aaaaaa",.      
+00019f80: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
+00019f90: 3d22 2361 6161 6161 6122 2c0a 2020 2020  ="#aaaaaa",.    
+00019fa0: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
+00019fb0: 6861 3d30 2e31 2c0a 2020 2020 2020 2020  ha=0.1,.        
+00019fc0: 2020 2020 6c69 6e65 5f61 6c70 6861 3d30      line_alpha=0
+00019fd0: 2e33 2c0a 2020 2020 2020 2020 290a 2020  .3,.        ).  
+00019fe0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00019ff0: 7175 6164 280a 2020 2020 2020 2020 2020  quad(.          
+0001a000: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+0001a010: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+0001a020: 2020 746f 703d 2274 6f70 222c 0a20 2020    top="top",.   
+0001a030: 2020 2020 2020 2020 2062 6f74 746f 6d3d           bottom=
+0001a040: 2262 6f74 746f 6d22 2c0a 2020 2020 2020  "bottom",.      
+0001a050: 2020 2020 2020 6c65 6674 3d22 6c65 6674        left="left
+0001a060: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
+0001a070: 6967 6874 3d22 7265 6c65 6173 6564 2d6c  ight="released-l
+0001a080: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
+0001a090: 2066 696c 6c5f 636f 6c6f 723d 2263 6f6c   fill_color="col
+0001a0a0: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+0001a0b0: 206c 696e 655f 636f 6c6f 723d 2263 6f6c   line_color="col
+0001a0c0: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+0001a0d0: 2066 696c 6c5f 616c 7068 613d 302e 362c   fill_alpha=0.6,
+0001a0e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001a0f0: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
+0001a100: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
+0001a110: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+0001a120: 652c 0a20 2020 2020 2020 2020 2020 2074  e,.            t
+0001a130: 6f70 3d22 746f 7022 2c0a 2020 2020 2020  op="top",.      
+0001a140: 2020 2020 2020 626f 7474 6f6d 3d22 626f        bottom="bo
+0001a150: 7474 6f6d 222c 0a20 2020 2020 2020 2020  ttom",.         
+0001a160: 2020 206c 6566 743d 2272 656c 6561 7365     left="release
+0001a170: 642d 6c6f 6322 2c0a 2020 2020 2020 2020  d-loc",.        
+0001a180: 2020 2020 7269 6768 743d 226d 656d 6f72      right="memor
+0001a190: 792d 6c6f 6322 2c0a 2020 2020 2020 2020  y-loc",.        
+0001a1a0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+0001a1b0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+0001a1c0: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+0001a1d0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+0001a1e0: 2020 2020 6669 6c6c 5f61 6c70 6861 3d31      fill_alpha=1
+0001a1f0: 2e30 2c0a 2020 2020 2020 2020 290a 2020  .0,.        ).  
+0001a200: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0001a210: 7175 6164 280a 2020 2020 2020 2020 2020  quad(.          
+0001a220: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+0001a230: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+0001a240: 2020 746f 703d 2274 6f70 222c 0a20 2020    top="top",.   
+0001a250: 2020 2020 2020 2020 2062 6f74 746f 6d3d           bottom=
+0001a260: 2262 6f74 746f 6d22 2c0a 2020 2020 2020  "bottom",.      
+0001a270: 2020 2020 2020 6c65 6674 3d22 6d65 6d6f        left="memo
+0001a280: 7279 2d6c 6f63 222c 0a20 2020 2020 2020  ry-loc",.       
+0001a290: 2020 2020 2072 6967 6874 3d22 6572 7265       right="erre
+0001a2a0: 642d 6c6f 6322 2c0a 2020 2020 2020 2020  d-loc",.        
+0001a2b0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+0001a2c0: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
+0001a2d0: 2020 2020 6669 6c6c 5f61 6c70 6861 3d30      fill_alpha=0
+0001a2e0: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
+0001a2f0: 6c69 6e65 5f61 6c70 6861 3d30 2c0a 2020  line_alpha=0,.  
+0001a300: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001a310: 7365 6c66 2e72 6f6f 742e 7175 6164 280a  self.root.quad(.
+0001a320: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+0001a330: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
+0001a340: 2020 2020 2020 2020 2020 2020 746f 703d              top=
+0001a350: 2274 6f70 222c 0a20 2020 2020 2020 2020  "top",.         
+0001a360: 2020 2062 6f74 746f 6d3d 2262 6f74 746f     bottom="botto
+0001a370: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
+0001a380: 6c65 6674 3d22 6572 7265 642d 6c6f 6322  left="erred-loc"
+0001a390: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
+0001a3a0: 6768 743d 2270 726f 6365 7373 696e 672d  ght="processing-
+0001a3b0: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
+0001a3c0: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 6772    fill_color="gr
+0001a3d0: 6179 222c 0a20 2020 2020 2020 2020 2020  ay",.           
+0001a3e0: 2066 696c 6c5f 616c 7068 613d 302e 3335   fill_alpha=0.35
+0001a3f0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+0001a400: 6e65 5f61 6c70 6861 3d30 2c0a 2020 2020  ne_alpha=0,.    
+0001a410: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0001a420: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+0001a430: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0001a440: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+0001a450: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
+0001a460: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
+0001a470: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
+0001a480: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+0001a490: 6674 3d22 7072 6f63 6573 7369 6e67 2d6c  ft="processing-l
+0001a4a0: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
+0001a4b0: 2072 6967 6874 3d22 7175 6575 6564 2d6c   right="queued-l
+0001a4c0: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
+0001a4d0: 2066 696c 6c5f 636f 6c6f 723d 2267 7261   fill_color="gra
+0001a4e0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+0001a4f0: 6861 7463 685f 7061 7474 6572 6e3d 222f  hatch_pattern="/
+0001a500: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+0001a510: 6174 6368 5f63 6f6c 6f72 3d22 7768 6974  atch_color="whit
+0001a520: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0001a530: 6669 6c6c 5f61 6c70 6861 3d30 2e33 352c  fill_alpha=0.35,
+0001a540: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+0001a550: 655f 616c 7068 613d 302c 0a20 2020 2020  e_alpha=0,.     
+0001a560: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0001a570: 662e 726f 6f74 2e71 7561 6428 0a20 2020  f.root.quad(.   
+0001a580: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0001a590: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+0001a5a0: 2020 2020 2020 2020 2074 6f70 3d22 746f           top="to
+0001a5b0: 7022 2c0a 2020 2020 2020 2020 2020 2020  p",.            
+0001a5c0: 626f 7474 6f6d 3d22 626f 7474 6f6d 222c  bottom="bottom",
+0001a5d0: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
+0001a5e0: 743d 2271 7565 7565 642d 6c6f 6322 2c0a  t="queued-loc",.
+0001a5f0: 2020 2020 2020 2020 2020 2020 7269 6768              righ
+0001a600: 743d 226e 6f2d 776f 726b 6572 2d6c 6f63  t="no-worker-loc
+0001a610: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a620: 696c 6c5f 636f 6c6f 723d 2272 6564 222c  ill_color="red",
+0001a630: 0a20 2020 2020 2020 2020 2020 2068 6174  .            hat
+0001a640: 6368 5f70 6174 7465 726e 3d22 2f22 2c0a  ch_pattern="/",.
+0001a650: 2020 2020 2020 2020 2020 2020 6861 7463              hatc
+0001a660: 685f 636f 6c6f 723d 2262 6c61 636b 222c  h_color="black",
+0001a670: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0001a680: 6c5f 616c 7068 613d 302e 3335 2c0a 2020  l_alpha=0.35,.  
+0001a690: 2020 2020 2020 2020 2020 6c69 6e65 5f61            line_a
+0001a6a0: 6c70 6861 3d30 2c0a 2020 2020 2020 2020  lpha=0,.        
+0001a6b0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0001a6c0: 6f6f 742e 7465 7874 280a 2020 2020 2020  oot.text(.      
+0001a6d0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+0001a6e0: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
+0001a6f0: 2020 2020 2020 7465 7874 3d22 7368 6f77        text="show
+0001a700: 2d6e 616d 6522 2c0a 2020 2020 2020 2020  -name",.        
+0001a710: 2020 2020 793d 2262 6f74 746f 6d22 2c0a      y="bottom",.
+0001a720: 2020 2020 2020 2020 2020 2020 783d 226c              x="l
+0001a730: 6566 7422 2c0a 2020 2020 2020 2020 2020  eft",.          
+0001a740: 2020 785f 6f66 6673 6574 3d35 2c0a 2020    x_offset=5,.  
+0001a750: 2020 2020 2020 2020 2020 7465 7874 5f66            text_f
+0001a760: 6f6e 745f 7369 7a65 3d76 616c 7565 2822  ont_size=value("
+0001a770: 3130 7074 2229 2c0a 2020 2020 2020 2020  10pt"),.        
+0001a780: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0001a790: 6f6f 742e 7465 7874 280a 2020 2020 2020  oot.text(.      
+0001a7a0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+0001a7b0: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
+0001a7c0: 2020 2020 2020 7465 7874 3d22 646f 6e65        text="done
+0001a7d0: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+0001a7e0: 3d22 626f 7474 6f6d 222c 0a20 2020 2020  ="bottom",.     
+0001a7f0: 2020 2020 2020 2078 3d22 7269 6768 7422         x="right"
+0001a800: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+0001a810: 6f66 6673 6574 3d2d 352c 0a20 2020 2020  offset=-5,.     
+0001a820: 2020 2020 2020 2074 6578 745f 616c 6967         text_alig
+0001a830: 6e3d 2272 6967 6874 222c 0a20 2020 2020  n="right",.     
+0001a840: 2020 2020 2020 2074 6578 745f 666f 6e74         text_font
+0001a850: 5f73 697a 653d 7661 6c75 6528 2231 3070  _size=value("10p
+0001a860: 7422 292c 0a20 2020 2020 2020 2029 0a20  t"),.        ). 
+0001a870: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0001a880: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
+0001a890: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+0001a8a0: 656c 662e 726f 6f74 2e79 6178 6973 2e6d  elf.root.yaxis.m
+0001a8b0: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
+0001a8c0: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
+0001a8d0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+0001a8e0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+0001a8f0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0001a900: 6f74 2e78 6772 6964 2e76 6973 6962 6c65  ot.xgrid.visible
+0001a910: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0001a920: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+0001a930: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
+0001a940: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
+0001a950: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+0001a960: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
+0001a970: 7365 0a0a 2020 2020 2020 2020 686f 7665  se..        hove
+0001a980: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
+0001a990: 2020 2020 2020 2020 2020 2070 6f69 6e74             point
+0001a9a0: 5f70 6f6c 6963 793d 2266 6f6c 6c6f 775f  _policy="follow_
+0001a9b0: 6d6f 7573 6522 2c0a 2020 2020 2020 2020  mouse",.        
+0001a9c0: 2020 2020 746f 6f6c 7469 7073 3d22 2222      tooltips="""
+0001a9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a9e0: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
+0001a9f0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+0001aa00: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+0001aa10: 653a 2031 3470 783b 2066 6f6e 742d 7765  e: 14px; font-we
+0001aa20: 6967 6874 3a20 626f 6c64 3b22 3e4e 616d  ight: bold;">Nam
+0001aa30: 653a 3c2f 7370 616e 3e26 6e62 7370 3b0a  e:</span>&nbsp;.
+0001aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa50: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+0001aa60: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+0001aa70: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+0001aa80: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+0001aa90: 3b22 3e40 6e61 6d65 3c2f 7370 616e 3e0a  ;">@name</span>.
+0001aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aab0: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+0001aac0: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
+0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aae0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+0001aaf0: 6e74 2d73 697a 653a 2031 3470 783b 2066  nt-size: 14px; f
+0001ab00: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+0001ab10: 3b22 3e41 6c6c 3a3c 2f73 7061 6e3e 266e  ;">All:</span>&n
+0001ab20: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
+0001ab30: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+0001ab40: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+0001ab50: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+0001ab60: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+0001ab70: 7370 6163 653b 223e 4061 6c6c 3c2f 7370  space;">@all</sp
+0001ab80: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
+0001ab90: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
+0001aba0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+0001abb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001abc0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+0001abd0: 3d22 666f 6e74 2d73 697a 653a 2031 3470  ="font-size: 14p
+0001abe0: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+0001abf0: 626f 6c64 3b22 3e51 7565 7565 643a 3c2f  bold;">Queued:</
+0001ac00: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+0001ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac20: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+0001ac30: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
+0001ac40: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
+0001ac50: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
+0001ac60: 7175 6575 6564 3c2f 7370 616e 3e0a 2020  queued</span>.  
+0001ac70: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
+0001ac80: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0001ac90: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001acb0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+0001acc0: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
+0001acd0: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
+0001ace0: 3e4e 6f2d 776f 726b 6572 3a3c 2f73 7061  >No-worker:</spa
+0001acf0: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
+0001ad00: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+0001ad10: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+0001ad20: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
+0001ad30: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
+0001ad40: 6d6f 6e6f 7370 6163 653b 223e 406e 6f5f  monospace;">@no_
+0001ad50: 776f 726b 6572 3c2f 7370 616e 3e0a 2020  worker</span>.  
+0001ad60: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
+0001ad70: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0001ad80: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+0001ad90: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001ada0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+0001adb0: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
+0001adc0: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
+0001add0: 3e50 726f 6365 7373 696e 673a 3c2f 7370  >Processing:</sp
+0001ade0: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
+0001adf0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+0001ae00: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+0001ae10: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+0001ae20: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+0001ae30: 206d 6f6e 6f73 7061 6365 3b22 3e40 7072   monospace;">@pr
+0001ae40: 6f63 6573 7369 6e67 3c2f 7370 616e 3e0a  ocessing</span>.
+0001ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae60: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+0001ae70: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
+0001ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae90: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+0001aea0: 6e74 2d73 697a 653a 2031 3470 783b 2066  nt-size: 14px; f
+0001aeb0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+0001aec0: 3b22 3e4d 656d 6f72 793a 3c2f 7370 616e  ;">Memory:</span
+0001aed0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+0001aee0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+0001aef0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+0001af00: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+0001af10: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+0001af20: 6f6e 6f73 7061 6365 3b22 3e40 6d65 6d6f  onospace;">@memo
+0001af30: 7279 3c2f 7370 616e 3e0a 2020 2020 2020  ry</span>.      
+0001af40: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+0001af50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001af60: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
+0001af70: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+0001af80: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+0001af90: 653a 2031 3470 783b 2066 6f6e 742d 7765  e: 14px; font-we
+0001afa0: 6967 6874 3a20 626f 6c64 3b22 3e45 7272  ight: bold;">Err
+0001afb0: 6564 3a3c 2f73 7061 6e3e 266e 6273 703b  ed:</span>&nbsp;
+0001afc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001afd0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+0001afe0: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
+0001aff0: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
+0001b000: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
+0001b010: 653b 223e 4065 7272 6564 3c2f 7370 616e  e;">@erred</span
+0001b020: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001b030: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+0001b040: 2020 2020 2020 2020 2022 2222 2c0a 2020           """,.  
+0001b050: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001b060: 6865 6c70 5f20 3d20 4865 6c70 546f 6f6c  help_ = HelpTool
+0001b070: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
+0001b080: 6469 7265 6374 3d22 6874 7470 733a 2f2f  direct="https://
+0001b090: 646f 6373 2e64 6173 6b2e 6f72 672f 656e  docs.dask.org/en
+0001b0a0: 2f73 7461 626c 652f 6461 7368 626f 6172  /stable/dashboar
+0001b0b0: 642e 6874 6d6c 2370 726f 6772 6573 7322  d.html#progress"
+0001b0c0: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+0001b0d0: 7363 7269 7074 696f 6e3d 2241 2064 6573  scription="A des
+0001b0e0: 6372 6970 7469 6f6e 206f 6620 7468 6520  cription of the 
+0001b0f0: 7072 6f67 7265 7373 2062 6172 7320 706c  progress bars pl
+0001b100: 6f74 2e22 2c0a 2020 2020 2020 2020 290a  ot.",.        ).
+0001b110: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001b120: 742e 6164 645f 746f 6f6c 7328 686f 7665  t.add_tools(hove
+0001b130: 722c 2068 656c 705f 290a 0a20 2020 2040  r, help_)..    @
+0001b140: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+0001b150: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
+0001b160: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+0001b170: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
+0001b180: 3a0a 2020 2020 2020 2020 7374 6174 6520  :.        state 
+0001b190: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001b1a0: 226d 656d 6f72 7922 3a20 7b7d 2c0a 2020  "memory": {},.  
+0001b1b0: 2020 2020 2020 2020 2020 2265 7272 6564            "erred
+0001b1c0: 223a 207b 7d2c 0a20 2020 2020 2020 2020  ": {},.         
+0001b1d0: 2020 2022 7265 6c65 6173 6564 223a 207b     "released": {
+0001b1e0: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
+0001b1f0: 7072 6f63 6573 7369 6e67 223a 207b 7d2c  processing": {},
+0001b200: 0a20 2020 2020 2020 2020 2020 2022 7761  .            "wa
+0001b210: 6974 696e 6722 3a20 7b7d 2c0a 2020 2020  iting": {},.    
+0001b220: 2020 2020 2020 2020 2271 7565 7565 6422          "queued"
+0001b230: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
+0001b240: 2020 226e 6f5f 776f 726b 6572 223a 207b    "no_worker": {
+0001b250: 7d2c 0a20 2020 2020 2020 207d 0a0a 2020  },.        }..  
+0001b260: 2020 2020 2020 666f 7220 7470 2069 6e20        for tp in 
+0001b270: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
+0001b280: 6173 6b5f 7072 6566 6978 6573 2e76 616c  ask_prefixes.val
+0001b290: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
+0001b2a0: 2020 2061 6374 6976 655f 7374 6174 6573     active_states
+0001b2b0: 203d 2074 702e 6163 7469 7665 5f73 7461   = tp.active_sta
+0001b2c0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+0001b2d0: 6966 2061 6e79 2861 6374 6976 655f 7374  if any(active_st
+0001b2e0: 6174 6573 2e67 6574 2873 2920 666f 7220  ates.get(s) for 
+0001b2f0: 7320 696e 2073 7461 7465 2e6b 6579 7328  s in state.keys(
+0001b300: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0001b310: 2020 2020 7374 6174 655b 226d 656d 6f72      state["memor
+0001b320: 7922 5d5b 7470 2e6e 616d 655d 203d 2061  y"][tp.name] = a
+0001b330: 6374 6976 655f 7374 6174 6573 5b22 6d65  ctive_states["me
+0001b340: 6d6f 7279 225d 0a20 2020 2020 2020 2020  mory"].         
+0001b350: 2020 2020 2020 2073 7461 7465 5b22 6572         state["er
+0001b360: 7265 6422 5d5b 7470 2e6e 616d 655d 203d  red"][tp.name] =
+0001b370: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+0001b380: 6572 7265 6422 5d0a 2020 2020 2020 2020  erred"].        
+0001b390: 2020 2020 2020 2020 7374 6174 655b 2272          state["r
+0001b3a0: 656c 6561 7365 6422 5d5b 7470 2e6e 616d  eleased"][tp.nam
+0001b3b0: 655d 203d 2061 6374 6976 655f 7374 6174  e] = active_stat
+0001b3c0: 6573 5b22 7265 6c65 6173 6564 225d 0a20  es["released"]. 
+0001b3d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001b3e0: 7461 7465 5b22 7072 6f63 6573 7369 6e67  tate["processing
+0001b3f0: 225d 5b74 702e 6e61 6d65 5d20 3d20 6163  "][tp.name] = ac
+0001b400: 7469 7665 5f73 7461 7465 735b 2270 726f  tive_states["pro
+0001b410: 6365 7373 696e 6722 5d0a 2020 2020 2020  cessing"].      
+0001b420: 2020 2020 2020 2020 2020 7374 6174 655b            state[
+0001b430: 2277 6169 7469 6e67 225d 5b74 702e 6e61  "waiting"][tp.na
+0001b440: 6d65 5d20 3d20 6163 7469 7665 5f73 7461  me] = active_sta
+0001b450: 7465 735b 2277 6169 7469 6e67 225d 0a20  tes["waiting"]. 
+0001b460: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001b470: 7461 7465 5b22 7175 6575 6564 225d 5b74  tate["queued"][t
+0001b480: 702e 6e61 6d65 5d20 3d20 6163 7469 7665  p.name] = active
+0001b490: 5f73 7461 7465 735b 2271 7565 7565 6422  _states["queued"
+0001b4a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0001b4b0: 2020 7374 6174 655b 226e 6f5f 776f 726b    state["no_work
+0001b4c0: 6572 225d 5b74 702e 6e61 6d65 5d20 3d20  er"][tp.name] = 
+0001b4d0: 6163 7469 7665 5f73 7461 7465 735b 226e  active_states["n
+0001b4e0: 6f2d 776f 726b 6572 225d 0a0a 2020 2020  o-worker"]..    
+0001b4f0: 2020 2020 7374 6174 655b 2261 6c6c 225d      state["all"]
+0001b500: 203d 207b 6b3a 2073 756d 2876 5b6b 5d20   = {k: sum(v[k] 
+0001b510: 666f 7220 7620 696e 2073 7461 7465 2e76  for v in state.v
+0001b520: 616c 7565 7328 2929 2066 6f72 206b 2069  alues()) for k i
+0001b530: 6e20 7374 6174 655b 226d 656d 6f72 7922  n state["memory"
+0001b540: 5d7d 0a0a 2020 2020 2020 2020 6966 206e  ]}..        if n
+0001b550: 6f74 2073 7461 7465 5b22 616c 6c22 5d20  ot state["all"] 
+0001b560: 616e 6420 6e6f 7420 6c65 6e28 7365 6c66  and not len(self
+0001b570: 2e73 6f75 7263 652e 6461 7461 5b22 616c  .source.data["al
+0001b580: 6c22 5d29 3a0a 2020 2020 2020 2020 2020  l"]):.          
+0001b590: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+0001b5a0: 2020 6420 3d20 7072 6f67 7265 7373 5f71    d = progress_q
+0001b5b0: 7561 6473 2873 7461 7465 290a 0a20 2020  uads(state)..   
+0001b5c0: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
+0001b5d0: 2e73 6f75 7263 652c 2064 290a 0a20 2020  .source, d)..   
+0001b5e0: 2020 2020 2074 6f74 616c 7320 3d20 7b0a       totals = {.
+0001b5f0: 2020 2020 2020 2020 2020 2020 6b3a 2073              k: s
+0001b600: 756d 2873 7461 7465 5b6b 5d2e 7661 6c75  um(state[k].valu
+0001b610: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+0001b620: 2020 666f 7220 6b20 696e 205b 0a20 2020    for k in [.   
+0001b630: 2020 2020 2020 2020 2020 2020 2022 616c               "al
+0001b640: 6c22 2c0a 2020 2020 2020 2020 2020 2020  l",.            
+0001b650: 2020 2020 226d 656d 6f72 7922 2c0a 2020      "memory",.  
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+0001b670: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
+0001b680: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
+0001b690: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001b6a0: 2020 2022 7761 6974 696e 6722 2c0a 2020     "waiting",.  
+0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2271                "q
+0001b6c0: 7565 7565 6422 2c0a 2020 2020 2020 2020  ueued",.        
+0001b6d0: 2020 2020 2020 2020 226e 6f5f 776f 726b          "no_work
+0001b6e0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
+0001b6f0: 205d 0a20 2020 2020 2020 207d 0a20 2020   ].        }.   
+0001b700: 2020 2020 2074 6f74 616c 735b 2270 726f       totals["pro
+0001b710: 6365 7373 696e 6722 5d20 3d20 746f 7461  cessing"] = tota
+0001b720: 6c73 5b22 616c 6c22 5d20 2d20 7375 6d28  ls["all"] - sum(
+0001b730: 0a20 2020 2020 2020 2020 2020 2076 2066  .            v f
+0001b740: 6f72 206b 2c20 7620 696e 2074 6f74 616c  or k, v in total
+0001b750: 732e 6974 656d 7328 2920 6966 206b 2021  s.items() if k !
+0001b760: 3d20 2261 6c6c 220a 2020 2020 2020 2020  = "all".        
+0001b770: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001b780: 726f 6f74 2e74 6974 6c65 2e74 6578 7420  root.title.text 
+0001b790: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0001b7a0: 2250 726f 6772 6573 7320 2d2d 2074 6f74  "Progress -- tot
+0001b7b0: 616c 3a20 2528 616c 6c29 732c 2022 0a20  al: %(all)s, ". 
+0001b7c0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
+0001b7d0: 696e 673a 2025 2877 6169 7469 6e67 2973  ing: %(waiting)s
+0001b7e0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+0001b7f0: 2271 7565 7565 643a 2025 2871 7565 7565  "queued: %(queue
+0001b800: 6429 732c 2022 0a20 2020 2020 2020 2020  d)s, ".         
+0001b810: 2020 2022 7072 6f63 6573 7369 6e67 3a20     "processing: 
+0001b820: 2528 7072 6f63 6573 7369 6e67 2973 2c20  %(processing)s, 
+0001b830: 220a 2020 2020 2020 2020 2020 2020 2269  ".            "i
+0001b840: 6e2d 6d65 6d6f 7279 3a20 2528 6d65 6d6f  n-memory: %(memo
+0001b850: 7279 2973 2c20 220a 2020 2020 2020 2020  ry)s, ".        
+0001b860: 2020 2020 226e 6f2d 776f 726b 6572 3a20      "no-worker: 
+0001b870: 2528 6e6f 5f77 6f72 6b65 7229 732c 2022  %(no_worker)s, "
+0001b880: 0a20 2020 2020 2020 2020 2020 2022 6572  .            "er
+0001b890: 7265 643a 2025 2865 7272 6564 2973 2220  red: %(erred)s" 
+0001b8a0: 2520 746f 7461 6c73 0a20 2020 2020 2020  % totals.       
+0001b8b0: 2029 0a0a 0a63 6c61 7373 2046 696e 6550   )...class FineP
+0001b8c0: 6572 666f 726d 616e 6365 4d65 7472 6963  erformanceMetric
+0001b8d0: 7328 4461 7368 626f 6172 6443 6f6d 706f  s(DashboardCompo
+0001b8e0: 6e65 6e74 293a 0a20 2020 2022 2222 0a20  nent):.    """. 
+0001b8f0: 2020 2054 6865 206d 6169 6e20 6f76 6572     The main over
+0001b900: 7669 6577 206f 6620 7468 6520 4669 6e65  view of the Fine
+0001b910: 2050 6572 666f 726d 616e 6365 204d 6574   Performance Met
+0001b920: 7269 6373 2070 6167 652e 0a20 2020 2022  rics page..    "
+0001b930: 2222 0a0a 2020 2020 406c 6f67 5f65 7272  ""..    @log_err
+0001b940: 6f72 730a 2020 2020 6465 6620 5f5f 696e  ors.    def __in
+0001b950: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+0001b960: 756c 6572 2c20 2a2a 6b77 6172 6773 293a  uler, **kwargs):
+0001b970: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+0001b980: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
+0001b990: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
+0001b9a0: 2e73 656e 6464 6174 6120 3d20 6465 6661  .senddata = defa
+0001b9b0: 756c 7464 6963 7428 6c69 7374 290a 2020  ultdict(list).  
+0001b9c0: 2020 2020 2020 7365 6c66 2e73 656e 6473        self.sends
+0001b9d0: 7263 203d 2043 6f6c 756d 6e44 6174 6153  rc = ColumnDataS
+0001b9e0: 6f75 7263 6528 6461 7461 3d64 6963 7428  ource(data=dict(
+0001b9f0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0001ba00: 7461 736b 5f65 7865 635f 6461 7461 203d  task_exec_data =
+0001ba10: 2064 6566 6175 6c74 6469 6374 286c 6973   defaultdict(lis
+0001ba20: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0001ba30: 7461 736b 5f65 7865 635f 6461 7461 5f6c  task_exec_data_l
+0001ba40: 696d 6974 6564 203d 2064 6566 6175 6c74  imited = default
+0001ba50: 6469 6374 286c 6973 7429 0a20 2020 2020  dict(list).     
+0001ba60: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
+0001ba70: 635f 6279 5f70 7265 6669 785f 7372 6320  c_by_prefix_src 
+0001ba80: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+0001ba90: 6365 2864 6174 613d 6469 6374 2829 290a  ce(data=dict()).
+0001baa0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001bab0: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
+0001bac0: 7479 5f73 7263 203d 2043 6f6c 756d 6e44  ty_src = ColumnD
+0001bad0: 6174 6153 6f75 7263 6528 6461 7461 3d64  ataSource(data=d
+0001bae0: 6963 7428 2929 0a20 2020 2020 2020 2073  ict()).        s
+0001baf0: 656c 662e 7375 6273 7461 6e74 6961 6c5f  elf.substantial_
+0001bb00: 6368 616e 6765 203d 2046 616c 7365 0a20  change = False. 
+0001bb10: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0001bb20: 5f61 6374 6976 6974 6965 7320 3d20 5b5d  _activities = []
+0001bb30: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+0001bb40: 6974 5f72 6f6f 7428 290a 0a20 2020 2064  it_root()..    d
+0001bb50: 6566 2069 6e69 745f 726f 6f74 2873 656c  ef init_root(sel
+0001bb60: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0001bb70: 6861 6e64 6c65 5f73 656c 6563 746f 725f  handle_selector_
+0001bb80: 6368 6e67 2861 7474 722c 206f 6c64 2c20  chng(attr, old, 
+0001bb90: 6e65 7729 3a0a 2020 2020 2020 2020 2020  new):.          
+0001bba0: 2020 7365 6c66 2e75 6e69 745f 7365 6c65    self.unit_sele
+0001bbb0: 6374 6564 203d 206e 6577 0a20 2020 2020  cted = new.     
+0001bbc0: 2020 2020 2020 2073 656c 662e 7375 6273         self.subs
+0001bbd0: 7461 6e74 6961 6c5f 6368 616e 6765 203d  tantial_change =
+0001bbe0: 2054 7275 650a 0a20 2020 2020 2020 2073   True..        s
+0001bbf0: 656c 662e 6675 6e63 7469 6f6e 5f73 656c  elf.function_sel
+0001bc00: 6563 746f 7220 3d20 4d75 6c74 6943 686f  ector = MultiCho
+0001bc10: 6963 6528 7661 6c75 653d 5b5d 2c20 6f70  ice(value=[], op
+0001bc20: 7469 6f6e 733d 5b5d 290a 2020 2020 2020  tions=[]).      
+0001bc30: 2020 7365 6c66 2e66 756e 6374 696f 6e5f    self.function_
+0001bc40: 7365 6c65 6374 6f72 2e70 6c61 6365 686f  selector.placeho
+0001bc50: 6c64 6572 203d 2022 5365 6c65 6374 2073  lder = "Select s
+0001bc60: 7065 6369 6669 6320 6675 6e63 7469 6f6e  pecific function
+0001bc70: 7322 0a20 2020 2020 2020 2073 656c 662e  s".        self.
+0001bc80: 756e 6974 5f73 656c 6563 746f 7220 3d20  unit_selector = 
+0001bc90: 5365 6c65 6374 2874 6974 6c65 3d22 556e  Select(title="Un
+0001bca0: 6974 2073 656c 6563 7469 6f6e 222c 206f  it selection", o
+0001bcb0: 7074 696f 6e73 3d5b 5d29 0a20 2020 2020  ptions=[]).     
+0001bcc0: 2020 2073 656c 662e 756e 6974 5f73 656c     self.unit_sel
+0001bcd0: 6563 746f 722e 6f6e 5f63 6861 6e67 6528  ector.on_change(
+0001bce0: 2276 616c 7565 222c 2068 616e 646c 655f  "value", handle_
+0001bcf0: 7365 6c65 6374 6f72 5f63 686e 6729 0a20  selector_chng). 
+0001bd00: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
+0001bd10: 5f73 656c 6563 7465 6420 3d20 2273 6563  _selected = "sec
+0001bd20: 6f6e 6473 220a 2020 2020 2020 2020 7365  onds".        se
+0001bd30: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
+0001bd40: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
+0001bd50: 2066 6967 7572 6528 290a 2020 2020 2020   figure().      
+0001bd60: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001bd70: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
+0001bd80: 203d 2066 6967 7572 6528 290a 2020 2020   = figure().    
+0001bd90: 2020 2020 7365 6c66 2e73 656e 6464 6174      self.senddat
+0001bda0: 615f 6279 5f61 6374 6976 6974 795f 6368  a_by_activity_ch
+0001bdb0: 6172 7420 3d20 6669 6775 7265 2829 0a20  art = figure(). 
+0001bdc0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0001bdd0: 203d 2063 6f6c 756d 6e28 0a20 2020 2020   = column(.     
+0001bde0: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+0001bdf0: 7469 6f6e 5f73 656c 6563 746f 722c 0a20  tion_selector,. 
+0001be00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001be10: 756e 6974 5f73 656c 6563 746f 722c 0a20  unit_selector,. 
+0001be20: 2020 2020 2020 2020 2020 2072 6f77 280a             row(.
+0001be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be40: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0001be50: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+0001be60: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
+0001be70: 6861 7274 2c0a 2020 2020 2020 2020 2020  hart,.          
+0001be80: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+0001be90: 6173 6b5f 6578 6563 5f62 795f 6163 7469  ask_exec_by_acti
+0001bea0: 7669 7479 5f63 6861 7274 2c0a 2020 2020  vity_chart,.    
+0001beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bec0: 7365 6c66 2e73 656e 6464 6174 615f 6279  self.senddata_by
+0001bed0: 5f61 6374 6976 6974 795f 6368 6172 742c  _activity_chart,
+0001bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bef0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+0001bf00: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
+0001bf10: 2273 7472 6574 6368 5f77 6964 7468 222c  "stretch_width",
+0001bf20: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0001bf30: 2020 2020 2020 2020 2020 2020 7369 7a69              sizi
+0001bf40: 6e67 5f6d 6f64 653d 2273 6361 6c65 5f77  ng_mode="scale_w
+0001bf50: 6964 7468 222c 0a20 2020 2020 2020 2029  idth",.        )
+0001bf60: 0a0a 2020 2020 6465 6620 666f 726d 6174  ..    def format
+0001bf70: 2873 656c 662c 2075 6e69 743a 2073 7472  (self, unit: str
+0001bf80: 2c20 7661 6c3a 2041 6e79 2920 2d3e 2073  , val: Any) -> s
+0001bf90: 7472 3a0a 2020 2020 2020 2020 666f 726d  tr:.        form
+0001bfa0: 6174 7465 7273 203d 207b 2262 7974 6573  atters = {"bytes
+0001bfb0: 223a 2066 6f72 6d61 745f 6279 7465 732c  ": format_bytes,
+0001bfc0: 2022 7365 636f 6e64 7322 3a20 666f 726d   "seconds": form
+0001bfd0: 6174 5f74 696d 657d 0a20 2020 2020 2020  at_time}.       
+0001bfe0: 2072 6574 7572 6e20 666f 726d 6174 7465   return formatte
+0001bff0: 7273 2e67 6574 2875 6e69 742c 2073 7472  rs.get(unit, str
+0001c000: 2928 7661 6c29 0a0a 2020 2020 4077 6974  )(val)..    @wit
+0001c010: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+0001c020: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+0001c030: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+0001c040: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+0001c050: 2020 2020 2020 2069 7465 6d73 203d 2073         items = s
+0001c060: 6f72 7465 6428 0a20 2020 2020 2020 2020  orted(.         
+0001c070: 2020 2028 6b2c 2076 290a 2020 2020 2020     (k, v).      
+0001c080: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
+0001c090: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
+0001c0a0: 2e63 756d 756c 6174 6976 655f 776f 726b  .cumulative_work
+0001c0b0: 6572 5f6d 6574 7269 6373 2e69 7465 6d73  er_metrics.items
+0001c0c0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0001c0d0: 6620 6973 696e 7374 616e 6365 286b 2c20  f isinstance(k, 
+0001c0e0: 7475 706c 6529 0a20 2020 2020 2020 2029  tuple).        )
+0001c0f0: 0a20 2020 2020 2020 2066 6f72 2028 636f  .        for (co
+0001c100: 6e74 6578 742c 202a 7061 7274 7329 2c20  ntext, *parts), 
+0001c110: 7661 6c20 696e 2069 7465 6d73 3a0a 2020  val in items:.  
+0001c120: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
+0001c130: 7465 7874 203d 3d20 2267 6574 2d64 6174  text == "get-dat
+0001c140: 6122 3a0a 2020 2020 2020 2020 2020 2020  a":.            
+0001c150: 2020 2020 6163 7469 7669 7479 2c20 756e      activity, un
+0001c160: 6974 203d 2070 6172 7473 0a0a 2020 2020  it = parts..    
+0001c170: 2020 2020 2020 2020 2020 2020 6966 2075              if u
+0001c180: 6e69 7420 6e6f 7420 696e 2073 656c 662e  nit not in self.
+0001c190: 756e 6974 5f73 656c 6563 746f 722e 6f70  unit_selector.op
+0001c1a0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+0001c1b0: 2020 2020 2020 2020 2020 2023 206e 6f74             # not
+0001c1c0: 6520 6170 7065 6e64 2064 6f65 736e 2774  e append doesn't
+0001c1d0: 2077 6f72 6b20 6865 7265 0a20 2020 2020   work here.     
+0001c1e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001c1f0: 656c 662e 756e 6974 5f73 656c 6563 746f  elf.unit_selecto
+0001c200: 722e 6f70 7469 6f6e 7320 2b3d 205b 756e  r.options += [un
+0001c210: 6974 5d0a 0a20 2020 2020 2020 2020 2020  it]..           
+0001c220: 2020 2020 2069 6620 6163 7469 7669 7479       if activity
+0001c230: 206e 6f74 2069 6e20 7365 6c66 2e73 656e   not in self.sen
+0001c240: 6464 6174 615b 2261 6374 6976 6974 7922  ddata["activity"
+0001c250: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0001c260: 2020 2020 2020 2073 656c 662e 7375 6273         self.subs
+0001c270: 7461 6e74 6961 6c5f 6368 616e 6765 203d  tantial_change =
+0001c280: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0001c290: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0001c2a0: 656e 6464 6174 615b 2261 6374 6976 6974  enddata["activit
+0001c2b0: 7922 5d2e 6170 7065 6e64 2861 6374 6976  y"].append(activ
+0001c2c0: 6974 7929 0a0a 2020 2020 2020 2020 2020  ity)..          
+0001c2d0: 2020 2020 2020 6964 7820 3d20 7365 6c66        idx = self
+0001c2e0: 2e73 656e 6464 6174 615b 2261 6374 6976  .senddata["activ
+0001c2f0: 6974 7922 5d2e 696e 6465 7828 6163 7469  ity"].index(acti
+0001c300: 7669 7479 290a 2020 2020 2020 2020 2020  vity).          
+0001c310: 2020 2020 2020 7768 696c 6520 6964 7820        while idx 
+0001c320: 3e3d 206c 656e 2873 656c 662e 7365 6e64  >= len(self.send
+0001c330: 6461 7461 5b66 227b 6163 7469 7669 7479  data[f"{activity
+0001c340: 7d5f 7b75 6e69 747d 225d 293a 0a20 2020  }_{unit}"]):.   
+0001c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c360: 2073 656c 662e 7365 6e64 6461 7461 5b66   self.senddata[f
+0001c370: 227b 6163 7469 7669 7479 7d5f 7b75 6e69  "{activity}_{uni
+0001c380: 747d 225d 2e61 7070 656e 6428 3029 0a20  t}"].append(0). 
+0001c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3a0: 2020 2073 656c 662e 7365 6e64 6461 7461     self.senddata
+0001c3b0: 5b66 227b 6163 7469 7669 7479 7d5f 7b75  [f"{activity}_{u
+0001c3c0: 6e69 747d 5f74 6578 7422 5d2e 6170 7065  nit}_text"].appe
+0001c3d0: 6e64 2822 2229 0a20 2020 2020 2020 2020  nd("").         
+0001c3e0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
+0001c3f0: 6461 7461 5b66 227b 6163 7469 7669 7479  data[f"{activity
+0001c400: 7d5f 7b75 6e69 747d 5f74 6578 7422 5d5b  }_{unit}_text"][
+0001c410: 6964 785d 203d 2073 656c 662e 666f 726d  idx] = self.form
+0001c420: 6174 2875 6e69 742c 2076 616c 290a 2020  at(unit, val).  
+0001c430: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001c440: 6c66 2e73 656e 6464 6174 615b 6622 7b61  lf.senddata[f"{a
+0001c450: 6374 6976 6974 797d 5f7b 756e 6974 7d22  ctivity}_{unit}"
+0001c460: 5d5b 6964 785d 203d 2076 616c 0a0a 2020  ][idx] = val..  
+0001c470: 2020 2020 2020 2020 2020 656c 6966 2063            elif c
+0001c480: 6f6e 7465 7874 203d 3d20 2265 7865 6375  ontext == "execu
+0001c490: 7465 223a 0a20 2020 2020 2020 2020 2020  te":.           
+0001c4a0: 2020 2020 2070 7265 6669 782c 2061 6374       prefix, act
+0001c4b0: 6976 6974 792c 2075 6e69 7420 3d20 7061  ivity, unit = pa
+0001c4c0: 7274 730a 0a20 2020 2020 2020 2020 2020  rts..           
+0001c4d0: 2020 2020 2069 6620 756e 6974 206e 6f74       if unit not
+0001c4e0: 2069 6e20 7365 6c66 2e75 6e69 745f 7365   in self.unit_se
+0001c4f0: 6c65 6374 6f72 2e6f 7074 696f 6e73 3a0a  lector.options:.
+0001c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c510: 2020 2020 2320 6e6f 7465 2061 7070 656e      # note appen
+0001c520: 6420 646f 6573 6e27 7420 776f 726b 2068  d doesn't work h
+0001c530: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
+0001c540: 2020 2020 2020 2020 7365 6c66 2e75 6e69          self.uni
+0001c550: 745f 7365 6c65 6374 6f72 2e6f 7074 696f  t_selector.optio
+0001c560: 6e73 202b 3d20 5b75 6e69 745d 0a0a 2020  ns += [unit]..  
+0001c570: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001c580: 2061 6374 6976 6974 7920 6e6f 7420 696e   activity not in
+0001c590: 2073 656c 662e 7461 736b 5f61 6374 6976   self.task_activ
+0001c5a0: 6974 6965 733a 0a20 2020 2020 2020 2020  ities:.         
+0001c5b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001c5c0: 7375 6273 7461 6e74 6961 6c5f 6368 616e  substantial_chan
+0001c5d0: 6765 203d 2054 7275 650a 2020 2020 2020  ge = True.      
+0001c5e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001c5f0: 6c66 2e74 6173 6b5f 6163 7469 7669 7469  lf.task_activiti
+0001c600: 6573 2e61 7070 656e 6428 6163 7469 7669  es.append(activi
+0001c610: 7479 290a 0a20 2020 2020 2020 2020 2020  ty)..           
+0001c620: 2020 2020 2069 6620 7072 6566 6978 206e       if prefix n
+0001c630: 6f74 2069 6e20 7365 6c66 2e74 6173 6b5f  ot in self.task_
+0001c640: 6578 6563 5f64 6174 615b 2266 756e 6374  exec_data["funct
+0001c650: 696f 6e73 225d 3a0a 2020 2020 2020 2020  ions"]:.        
+0001c660: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001c670: 2e73 7562 7374 616e 7469 616c 5f63 6861  .substantial_cha
+0001c680: 6e67 6520 3d20 5472 7565 0a20 2020 2020  nge = True.     
+0001c690: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001c6a0: 656c 662e 6675 6e63 7469 6f6e 5f73 656c  elf.function_sel
+0001c6b0: 6563 746f 722e 6f70 7469 6f6e 732e 6170  ector.options.ap
+0001c6c0: 7065 6e64 2870 7265 6669 7829 0a20 2020  pend(prefix).   
+0001c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6e0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
+0001c6f0: 6461 7461 5b22 6675 6e63 7469 6f6e 7322  data["functions"
+0001c700: 5d2e 6170 7065 6e64 2870 7265 6669 7829  ].append(prefix)
+0001c710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c720: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
+0001c730: 7865 635f 6461 7461 5b22 7469 6d65 7374  xec_data["timest
+0001c740: 616d 7022 5d2e 6170 7065 6e64 2864 6174  amp"].append(dat
+0001c750: 6574 696d 652e 7574 636e 6f77 2829 290a  etime.utcnow()).
+0001c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c770: 6964 7820 3d20 7365 6c66 2e74 6173 6b5f  idx = self.task_
+0001c780: 6578 6563 5f64 6174 615b 2266 756e 6374  exec_data["funct
+0001c790: 696f 6e73 225d 2e69 6e64 6578 2870 7265  ions"].index(pre
+0001c7a0: 6669 7829 0a0a 2020 2020 2020 2020 2020  fix)..          
+0001c7b0: 2020 2020 2020 2320 536f 6d65 2066 756e        # Some fun
+0001c7c0: 6374 696f 6e2f 6163 7469 7669 7479 2063  ction/activity c
+0001c7d0: 6f6d 626f 7320 6d69 7373 696e 672c 2073  ombos missing, s
+0001c7e0: 6f20 6e65 6564 2074 6f20 6b65 6570 2063  o need to keep c
+0001c7f0: 6f6c 756d 6e73 2061 6c69 676e 6564 0a20  olumns aligned. 
+0001c800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001c810: 6f72 206f 7020 696e 2073 656c 662e 7461  or op in self.ta
+0001c820: 736b 5f61 6374 6976 6974 6965 733a 0a20  sk_activities:. 
+0001c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c840: 2020 2077 6869 6c65 206c 656e 2873 656c     while len(sel
+0001c850: 662e 7461 736b 5f65 7865 635f 6461 7461  f.task_exec_data
+0001c860: 5b66 227b 6f70 7d5f 7b75 6e69 747d 225d  [f"{op}_{unit}"]
+0001c870: 2920 213d 206c 656e 280a 2020 2020 2020  ) != len(.      
+0001c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c890: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001c8a0: 5f64 6174 615b 2266 756e 6374 696f 6e73  _data["functions
+0001c8b0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+0001c8c0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8e0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001c8f0: 5f64 6174 615b 6622 7b6f 707d 5f7b 756e  _data[f"{op}_{un
+0001c900: 6974 7d22 5d2e 6170 7065 6e64 2830 290a  it}"].append(0).
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c920: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001c930: 6b5f 6578 6563 5f64 6174 615b 6622 7b6f  k_exec_data[f"{o
+0001c940: 707d 5f7b 756e 6974 7d5f 7465 7874 225d  p}_{unit}_text"]
+0001c950: 2e61 7070 656e 6428 2222 290a 0a20 2020  .append("")..   
+0001c960: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001c970: 662e 7461 736b 5f65 7865 635f 6461 7461  f.task_exec_data
+0001c980: 5b66 227b 6163 7469 7669 7479 7d5f 7b75  [f"{activity}_{u
+0001c990: 6e69 747d 225d 5b69 6478 5d20 3d20 7661  nit}"][idx] = va
+0001c9a0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+0001c9b0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001c9c0: 5f64 6174 615b 6622 7b61 6374 6976 6974  _data[f"{activit
+0001c9d0: 797d 5f7b 756e 6974 7d5f 7465 7874 225d  y}_{unit}_text"]
+0001c9e0: 5b69 6478 5d20 3d20 7365 6c66 2e66 6f72  [idx] = self.for
+0001c9f0: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+0001ca00: 2020 2020 2020 2020 2075 6e69 742c 2076           unit, v
+0001ca10: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
+0001ca20: 2020 2029 0a0a 2020 2020 2020 2020 6461     )..        da
+0001ca30: 7461 203d 2073 656c 662e 7461 736b 5f65  ta = self.task_e
+0001ca40: 7865 635f 6461 7461 2e63 6f70 7928 290a  xec_data.copy().
+0001ca50: 2020 2020 2020 2020 2320 4966 2075 7365          # If use
+0001ca60: 7220 6861 7320 6d61 6e75 616c 6c79 2073  r has manually s
+0001ca70: 656c 6563 7465 6420 6675 6e63 7469 6f6e  elected function
+0001ca80: 2873 2920 7468 656e 2077 6520 6172 6520  (s) then we are 
+0001ca90: 6f6e 6c79 2073 686f 7769 6e67 2074 6865  only showing the
+0001caa0: 6d2e 0a20 2020 2020 2020 2069 6620 7365  m..        if se
+0001cab0: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
+0001cac0: 6374 6f72 2e76 616c 7565 3a0a 2020 2020  ctor.value:.    
+0001cad0: 2020 2020 2020 2020 696e 6465 7865 7320          indexes 
+0001cae0: 3d20 5b64 6174 615b 2266 756e 6374 696f  = [data["functio
+0001caf0: 6e73 225d 2e69 6e64 6578 2866 2920 666f  ns"].index(f) fo
+0001cb00: 7220 6620 696e 2073 656c 662e 6675 6e63  r f in self.func
+0001cb10: 7469 6f6e 5f73 656c 6563 746f 722e 7661  tion_selector.va
+0001cb20: 6c75 655d 0a20 2020 2020 2020 2020 2020  lue].           
+0001cb30: 2066 6f72 206b 6579 2c20 7661 6c75 6573   for key, values
+0001cb40: 2069 6e20 6461 7461 2e69 7465 6d73 2829   in data.items()
+0001cb50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cb60: 2020 6461 7461 5b6b 6579 5d20 3d20 5b76    data[key] = [v
+0001cb70: 616c 7565 735b 6964 785d 2066 6f72 2069  alues[idx] for i
+0001cb80: 6478 2069 6e20 696e 6465 7865 735d 0a0a  dx in indexes]..
+0001cb90: 2020 2020 2020 2020 2320 4f74 6865 7277          # Otherw
+0001cba0: 6973 6520 6c69 6d69 7420 7468 6f73 6520  ise limit those 
+0001cbb0: 6265 696e 6720 7368 6f77 6e20 7768 6963  being shown whic
+0001cbc0: 6820 6861 7665 2027 6578 7069 7265 6427  h have 'expired'
+0001cbd0: 2074 6f20 6265 2064 6973 706c 6179 6564   to be displayed
+0001cbe0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001cbf0: 2020 2020 2020 2020 2020 2063 7574 6f66             cutof
+0001cc00: 6620 3d20 6461 7465 7469 6d65 2e75 7463  f = datetime.utc
+0001cc10: 6e6f 7728 2920 2d20 7469 6d65 6465 6c74  now() - timedelt
+0001cc20: 6128 7365 636f 6e64 733d 3130 290a 2020  a(seconds=10).  
+0001cc30: 2020 2020 2020 2020 2020 6e5f 7368 6f77            n_show
+0001cc40: 203d 206c 656e 285b 6420 666f 7220 6420   = len([d for d 
+0001cc50: 696e 2064 6174 615b 2274 696d 6573 7461  in data["timesta
+0001cc60: 6d70 225d 2069 6620 6420 3e20 6375 746f  mp"] if d > cuto
+0001cc70: 6666 5d29 206f 7220 350a 2020 2020 2020  ff]) or 5.      
+0001cc80: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+0001cc90: 2064 6174 613a 0a20 2020 2020 2020 2020   data:.         
+0001cca0: 2020 2020 2020 2064 6174 615b 6b65 795d         data[key]
+0001ccb0: 203d 2064 6174 615b 6b65 795d 5b2d 6e5f   = data[key][-n_
+0001ccc0: 7368 6f77 3a5d 0a20 2020 2020 2020 2073  show:].        s
+0001ccd0: 656c 662e 7461 736b 5f65 7865 635f 6461  elf.task_exec_da
+0001cce0: 7461 5f6c 696d 6974 6564 203d 2064 6174  ta_limited = dat
+0001ccf0: 612e 636f 7079 2829 0a0a 2020 2020 2020  a.copy()..      
+0001cd00: 2020 2320 5368 6f77 2074 6f74 616c 206e    # Show total n
+0001cd10: 756d 6265 7220 6f66 2066 756e 6374 696f  umber of functio
+0001cd20: 6e73 2074 6f20 6368 6f6f 7365 2066 726f  ns to choose fro
+0001cd30: 6d0a 2020 2020 2020 2020 7365 6c66 2e66  m.        self.f
+0001cd40: 756e 6374 696f 6e5f 7365 6c65 6374 6f72  unction_selector
+0001cd50: 2e74 6974 6c65 203d 2028 0a20 2020 2020  .title = (.     
+0001cd60: 2020 2020 2020 2066 2246 696c 7465 7220         f"Filter 
+0001cd70: 6279 2066 756e 6374 696f 6e20 287b 6c65  by function ({le
+0001cd80: 6e28 7365 6c66 2e66 756e 6374 696f 6e5f  n(self.function_
+0001cd90: 7365 6c65 6374 6f72 2e6f 7074 696f 6e73  selector.options
+0001cda0: 297d 293a 220a 2020 2020 2020 2020 290a  )}):".        ).
+0001cdb0: 0a20 2020 2020 2020 2074 6173 6b5f 6578  .        task_ex
+0001cdc0: 6563 5f70 6965 6368 6172 7420 3d20 7365  ec_piechart = se
+0001cdd0: 6c66 2e5f 6275 696c 645f 7461 736b 5f65  lf._build_task_e
+0001cde0: 7865 6375 7469 6f6e 5f62 795f 6163 7469  xecution_by_acti
+0001cdf0: 7669 7479 5f63 6861 7274 280a 2020 2020  vity_chart(.    
+0001ce00: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001ce10: 6b5f 6578 6563 5f64 6174 615f 6c69 6d69  k_exec_data_limi
+0001ce20: 7465 642e 636f 7079 2829 0a20 2020 2020  ted.copy().     
+0001ce30: 2020 2029 0a20 2020 2020 2020 2074 6173     ).        tas
+0001ce40: 6b5f 6578 6563 5f62 6172 6368 6172 7420  k_exec_barchart 
+0001ce50: 3d20 7365 6c66 2e5f 6275 696c 645f 7461  = self._build_ta
+0001ce60: 736b 5f65 7865 6375 7469 6f6e 5f62 795f  sk_execution_by_
+0001ce70: 7072 6566 6978 5f63 6861 7274 280a 2020  prefix_chart(.  
+0001ce80: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+0001ce90: 6173 6b5f 6578 6563 5f64 6174 615f 6c69  ask_exec_data_li
+0001cea0: 6d69 7465 642e 636f 7079 2829 0a20 2020  mited.copy().   
+0001ceb0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0001cec0: 656e 6464 6174 615f 7069 6563 6861 7274  enddata_piechart
+0001ced0: 203d 2073 656c 662e 5f62 7569 6c64 5f73   = self._build_s
+0001cee0: 656e 6464 6174 615f 6368 6172 7428 7365  enddata_chart(se
+0001cef0: 6c66 2e73 656e 6464 6174 612e 636f 7079  lf.senddata.copy
+0001cf00: 2829 290a 0a20 2020 2020 2020 2023 2052  ())..        # R
+0001cf10: 6570 6c61 6369 6e67 2074 6865 2063 6869  eplacing the chi
+0001cf20: 6c64 2063 6175 7365 7320 736d 616c 6c20  ld causes small 
+0001cf30: 626c 6970 7320 6966 2064 6f6e 6520 6576  blips if done ev
+0001cf40: 6572 7920 6974 6572 6174 696f 6e20 7673  ery iteration vs
+0001cf50: 2075 7064 6174 696e 670a 2020 2020 2020   updating.      
+0001cf60: 2020 2320 7265 6e64 6572 6572 732c 2062    # renderers, b
+0001cf70: 7574 2069 7427 7320 6e65 6564 6564 2077  ut it's needed w
+0001cf80: 6865 6e20 6e65 7720 6675 6e63 7469 6f6e  hen new function
+0001cf90: 7320 616e 642f 6f72 2061 6374 6976 6974  s and/or activit
+0001cfa0: 6965 7320 7368 6f77 2075 7020 746f 0a20  ies show up to. 
+0001cfb0: 2020 2020 2020 2023 2072 6572 656e 6465         # rerende
+0001cfc0: 7220 706c 6f74 0a20 2020 2020 2020 2069  r plot.        i
+0001cfd0: 6620 7365 6c66 2e73 7562 7374 616e 7469  f self.substanti
+0001cfe0: 616c 5f63 6861 6e67 653a 0a20 2020 2020  al_change:.     
+0001cff0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0001d000: 2e63 6869 6c64 7265 6e5b 2d31 5d2e 6368  .children[-1].ch
+0001d010: 696c 6472 656e 5b30 5d20 3d20 7461 736b  ildren[0] = task
+0001d020: 5f65 7865 635f 6261 7263 6861 7274 0a20  _exec_barchart. 
+0001d030: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001d040: 726f 6f74 2e63 6869 6c64 7265 6e5b 2d31  root.children[-1
+0001d050: 5d2e 6368 696c 6472 656e 5b31 5d20 3d20  ].children[1] = 
+0001d060: 7461 736b 5f65 7865 635f 7069 6563 6861  task_exec_piecha
+0001d070: 7274 0a20 2020 2020 2020 2020 2020 2073  rt.            s
+0001d080: 656c 662e 726f 6f74 2e63 6869 6c64 7265  elf.root.childre
+0001d090: 6e5b 2d31 5d2e 6368 696c 6472 656e 5b32  n[-1].children[2
+0001d0a0: 5d20 3d20 7365 6e64 6461 7461 5f70 6965  ] = senddata_pie
+0001d0b0: 6368 6172 740a 2020 2020 2020 2020 2020  chart.          
+0001d0c0: 2020 7365 6c66 2e73 7562 7374 616e 7469    self.substanti
+0001d0d0: 616c 5f63 6861 6e67 6520 3d20 4661 6c73  al_change = Fals
+0001d0e0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+0001d0f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001d100: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001d110: 6566 6978 5f63 6861 7274 2e72 656e 6465  efix_chart.rende
+0001d120: 7265 7273 203d 2074 6173 6b5f 6578 6563  rers = task_exec
+0001d130: 5f70 6965 6368 6172 742e 7265 6e64 6572  _piechart.render
+0001d140: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+0001d150: 7365 6c66 2e74 6173 6b5f 6578 6563 5f62  self.task_exec_b
+0001d160: 795f 6163 7469 7669 7479 5f63 6861 7274  y_activity_chart
+0001d170: 2e72 656e 6465 7265 7273 203d 2074 6173  .renderers = tas
+0001d180: 6b5f 6578 6563 5f62 6172 6368 6172 742e  k_exec_barchart.
+0001d190: 7265 6e64 6572 6572 730a 2020 2020 2020  renderers.      
+0001d1a0: 2020 2020 2020 7365 6c66 2e73 656e 6464        self.sendd
+0001d1b0: 6174 615f 6279 5f61 6374 6976 6974 795f  ata_by_activity_
+0001d1c0: 6368 6172 742e 7265 6e64 6572 6572 7320  chart.renderers 
+0001d1d0: 3d20 7365 6e64 6461 7461 5f70 6965 6368  = senddata_piech
+0001d1e0: 6172 742e 7265 6e64 6572 6572 730a 0a20  art.renderers.. 
+0001d1f0: 2020 2064 6566 205f 6275 696c 645f 7461     def _build_ta
+0001d200: 736b 5f65 7865 6375 7469 6f6e 5f62 795f  sk_execution_by_
+0001d210: 6163 7469 7669 7479 5f63 6861 7274 280a  activity_chart(.
+0001d220: 2020 2020 2020 2020 7365 6c66 2c20 7461          self, ta
+0001d230: 736b 5f65 7865 635f 6461 7461 3a20 6465  sk_exec_data: de
+0001d240: 6661 756c 7464 6963 745b 7374 722c 206c  faultdict[str, l
+0001d250: 6973 745d 0a20 2020 2029 202d 3e20 6669  ist].    ) -> fi
+0001d260: 6775 7265 3a0a 2020 2020 2020 2020 7069  gure:.        pi
+0001d270: 6563 6861 7274 5f64 6174 6120 3d20 7b7d  echart_data = {}
+0001d280: 0a20 2020 2020 2020 2070 6965 6368 6172  .        piechar
+0001d290: 745f 6461 7461 5b22 7661 6c75 6522 5d20  t_data["value"] 
+0001d2a0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001d2b0: 7375 6d28 7461 736b 5f65 7865 635f 6461  sum(task_exec_da
+0001d2c0: 7461 5b66 227b 6f70 7d5f 7b73 656c 662e  ta[f"{op}_{self.
+0001d2d0: 756e 6974 5f73 656c 6563 7465 647d 225d  unit_selected}"]
+0001d2e0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0001d2f0: 7220 6f70 2069 6e20 7365 6c66 2e74 6173  r op in self.tas
+0001d300: 6b5f 6163 7469 7669 7469 6573 0a20 2020  k_activities.   
+0001d310: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
+0001d320: 6965 6368 6172 745f 6461 7461 5b22 7465  iechart_data["te
+0001d330: 7874 225d 203d 205b 0a20 2020 2020 2020  xt"] = [.       
+0001d340: 2020 2020 2073 656c 662e 666f 726d 6174       self.format
+0001d350: 2873 656c 662e 756e 6974 5f73 656c 6563  (self.unit_selec
+0001d360: 7465 642c 2076 2920 666f 7220 7620 696e  ted, v) for v in
+0001d370: 2070 6965 6368 6172 745f 6461 7461 5b22   piechart_data["
+0001d380: 7661 6c75 6522 5d0a 2020 2020 2020 2020  value"].        
+0001d390: 5d0a 2020 2020 2020 2020 7069 6563 6861  ].        piecha
+0001d3a0: 7274 5f64 6174 615b 2261 6e67 6c65 225d  rt_data["angle"]
+0001d3b0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0001d3c0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0001d3d0: 2020 2073 756d 2874 6173 6b5f 6578 6563     sum(task_exec
+0001d3e0: 5f64 6174 615b 6622 7b61 6374 6976 6974  _data[f"{activit
+0001d3f0: 797d 5f7b 7365 6c66 2e75 6e69 745f 7365  y}_{self.unit_se
+0001d400: 6c65 6374 6564 7d22 5d29 0a20 2020 2020  lected}"]).     
+0001d410: 2020 2020 2020 2020 2020 202f 2073 756d             / sum
+0001d420: 2870 6965 6368 6172 745f 6461 7461 5b22  (piechart_data["
+0001d430: 7661 6c75 6522 5d29 0a20 2020 2020 2020  value"]).       
+0001d440: 2020 2020 2020 2020 2069 6620 7375 6d28           if sum(
+0001d450: 7069 6563 6861 7274 5f64 6174 615b 2276  piechart_data["v
+0001d460: 616c 7565 225d 290a 2020 2020 2020 2020  alue"]).        
+0001d470: 2020 2020 2020 2020 656c 7365 2030 2020          else 0  
+0001d480: 2320 6d61 7920 6e6f 7420 6861 7665 2061  # may not have a
+0001d490: 6e79 2062 7974 6573 206d 6f76 656d 656e  ny bytes movemen
+0001d4a0: 7420 7265 706f 7274 6564 2c20 6176 6f69  t reported, avoi
+0001d4b0: 6420 6469 7669 6465 2062 7920 7a65 726f  d divide by zero
+0001d4c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001d4d0: 2020 2020 2020 2020 2020 202a 2032 0a20             * 2. 
+0001d4e0: 2020 2020 2020 2020 2020 202a 206d 6174             * mat
+0001d4f0: 682e 7069 0a20 2020 2020 2020 2020 2020  h.pi.           
+0001d500: 2066 6f72 2061 6374 6976 6974 7920 696e   for activity in
+0001d510: 2073 656c 662e 7461 736b 5f61 6374 6976   self.task_activ
+0001d520: 6974 6965 730a 2020 2020 2020 2020 5d0a  ities.        ].
+0001d530: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
+0001d540: 5f64 6174 615b 2263 6f6c 6f72 225d 203d  _data["color"] =
+0001d550: 2073 6d61 6c6c 5f70 616c 6574 7465 735b   small_palettes[
+0001d560: 2259 6c47 6e42 7522 5d2e 6765 7428 0a20  "YlGnBu"].get(. 
+0001d570: 2020 2020 2020 2020 2020 206c 656e 2873             len(s
+0001d580: 656c 662e 7461 736b 5f61 6374 6976 6974  elf.task_activit
+0001d590: 6965 7329 2c20 5b5d 0a20 2020 2020 2020  ies), [].       
+0001d5a0: 2029 0a20 2020 2020 2020 2070 6965 6368   ).        piech
+0001d5b0: 6172 745f 6461 7461 5b22 6163 7469 7669  art_data["activi
+0001d5c0: 7479 225d 203d 2073 656c 662e 7461 736b  ty"] = self.task
+0001d5d0: 5f61 6374 6976 6974 6965 730a 2020 2020  _activities.    
+0001d5e0: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
+0001d5f0: 6563 5f62 795f 6163 7469 7669 7479 5f73  ec_by_activity_s
+0001d600: 7263 2e64 6174 6120 3d20 7069 6563 6861  rc.data = piecha
+0001d610: 7274 5f64 6174 610a 0a20 2020 2020 2020  rt_data..       
+0001d620: 2070 6965 6368 6172 7420 3d20 6669 6775   piechart = figu
+0001d630: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+0001d640: 6865 6967 6874 3d35 3030 2c0a 2020 2020  height=500,.    
+0001d650: 2020 2020 2020 2020 7369 7a69 6e67 5f6d          sizing_m
+0001d660: 6f64 653d 2273 6361 6c65 5f62 6f74 6822  ode="scale_both"
+0001d670: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+0001d680: 746c 653d 2254 6173 6b20 6578 6563 7574  tle="Task execut
+0001d690: 696f 6e2c 2062 7920 6163 7469 7669 7479  ion, by activity
+0001d6a0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+0001d6b0: 6f6f 6c73 3d22 686f 7665 7222 2c0a 2020  ools="hover",.  
+0001d6c0: 2020 2020 2020 2020 2020 746f 6f6c 7469            toolti
+0001d6d0: 7073 3d22 407b 6163 7469 7669 7479 7d3a  ps="@{activity}:
+0001d6e0: 2040 7465 7874 222c 0a20 2020 2020 2020   @text",.       
+0001d6f0: 2020 2020 2078 5f72 616e 6765 3d28 2d30       x_range=(-0
+0001d700: 2e35 2c20 312e 3029 2c0a 2020 2020 2020  .5, 1.0),.      
+0001d710: 2020 290a 2020 2020 2020 2020 7069 6563    ).        piec
+0001d720: 6861 7274 2e61 7869 732e 6178 6973 5f6c  hart.axis.axis_l
+0001d730: 6162 656c 203d 204e 6f6e 650a 2020 2020  abel = None.    
+0001d740: 2020 2020 7069 6563 6861 7274 2e61 7869      piechart.axi
+0001d750: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
+0001d760: 650a 2020 2020 2020 2020 7069 6563 6861  e.        piecha
+0001d770: 7274 2e67 7269 642e 6772 6964 5f6c 696e  rt.grid.grid_lin
+0001d780: 655f 636f 6c6f 7220 3d20 4e6f 6e65 0a0a  e_color = None..
+0001d790: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
+0001d7a0: 2e77 6564 6765 280a 2020 2020 2020 2020  .wedge(.        
+0001d7b0: 2020 2020 783d 302c 0a20 2020 2020 2020      x=0,.       
+0001d7c0: 2020 2020 2079 3d31 2c0a 2020 2020 2020       y=1,.      
+0001d7d0: 2020 2020 2020 7261 6469 7573 3d30 2e34        radius=0.4
+0001d7e0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+0001d7f0: 6172 745f 616e 676c 653d 6375 6d73 756d  art_angle=cumsum
+0001d800: 2822 616e 676c 6522 2c20 696e 636c 7564  ("angle", includ
+0001d810: 655f 7a65 726f 3d54 7275 6529 2c0a 2020  e_zero=True),.  
+0001d820: 2020 2020 2020 2020 2020 656e 645f 616e            end_an
+0001d830: 676c 653d 6375 6d73 756d 2822 616e 676c  gle=cumsum("angl
+0001d840: 6522 292c 0a20 2020 2020 2020 2020 2020  e"),.           
+0001d850: 206c 696e 655f 636f 6c6f 723d 2277 6869   line_color="whi
+0001d860: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
+0001d870: 2066 696c 6c5f 636f 6c6f 723d 2263 6f6c   fill_color="col
+0001d880: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+0001d890: 206c 6567 656e 645f 6669 656c 643d 2261   legend_field="a
+0001d8a0: 6374 6976 6974 7922 2c0a 2020 2020 2020  ctivity",.      
+0001d8b0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+0001d8c0: 662e 7461 736b 5f65 7865 635f 6279 5f61  f.task_exec_by_a
+0001d8d0: 6374 6976 6974 795f 7372 632c 0a20 2020  ctivity_src,.   
+0001d8e0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0001d8f0: 6574 7572 6e20 7069 6563 6861 7274 0a0a  eturn piechart..
+0001d900: 2020 2020 6465 6620 5f62 7569 6c64 5f74      def _build_t
+0001d910: 6173 6b5f 6578 6563 7574 696f 6e5f 6279  ask_execution_by
+0001d920: 5f70 7265 6669 785f 6368 6172 7428 0a20  _prefix_chart(. 
+0001d930: 2020 2020 2020 2073 656c 662c 2074 6173         self, tas
+0001d940: 6b5f 6578 6563 5f64 6174 613a 2064 6566  k_exec_data: def
+0001d950: 6175 6c74 6469 6374 5b73 7472 2c20 6c69  aultdict[str, li
+0001d960: 7374 5d0a 2020 2020 2920 2d3e 2066 6967  st].    ) -> fig
+0001d970: 7572 653a 0a20 2020 2020 2020 2062 6172  ure:.        bar
+0001d980: 6368 6172 7420 3d20 6669 6775 7265 280a  chart = figure(.
+0001d990: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
+0001d9a0: 6e67 653d 7461 736b 5f65 7865 635f 6461  nge=task_exec_da
+0001d9b0: 7461 5b22 6675 6e63 7469 6f6e 7322 5d2c  ta["functions"],
+0001d9c0: 0a20 2020 2020 2020 2020 2020 2068 6569  .            hei
+0001d9d0: 6768 743d 3530 302c 0a20 2020 2020 2020  ght=500,.       
+0001d9e0: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
+0001d9f0: 3d22 7363 616c 655f 626f 7468 222c 0a20  ="scale_both",. 
+0001da00: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+0001da10: 3d22 5461 736b 2065 7865 6375 7469 6f6e  ="Task execution
+0001da20: 2c20 6279 2066 756e 6374 696f 6e22 2c0a  , by function",.
+0001da30: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+0001da40: 733d 2270 616e 2c77 6865 656c 5f7a 6f6f  s="pan,wheel_zoo
+0001da50: 6d2c 626f 785f 7a6f 6f6d 2c72 6573 6574  m,box_zoom,reset
+0001da60: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+0001da70: 2020 2020 2062 6172 6368 6172 742e 7961       barchart.ya
+0001da80: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
+0001da90: 6c73 650a 2020 2020 2020 2020 6261 7263  lse.        barc
+0001daa0: 6861 7274 2e78 6178 6973 2e6d 616a 6f72  hart.xaxis.major
+0001dab0: 5f6c 6162 656c 5f6f 7269 656e 7461 7469  _label_orientati
+0001dac0: 6f6e 203d 2030 2e32 0a20 2020 2020 2020  on = 0.2.       
+0001dad0: 2062 6172 6368 6172 742e 6772 6964 2e67   barchart.grid.g
+0001dae0: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
+0001daf0: 204e 6f6e 650a 2020 2020 2020 2020 7374   None.        st
+0001db00: 6163 6b65 7273 203d 205b 0a20 2020 2020  ackers = [.     
+0001db10: 2020 2020 2020 206e 616d 6520 666f 7220         name for 
+0001db20: 6e61 6d65 2069 6e20 7461 736b 5f65 7865  name in task_exe
+0001db30: 635f 6461 7461 2069 6620 6e61 6d65 2e65  c_data if name.e
+0001db40: 6e64 7377 6974 6828 7365 6c66 2e75 6e69  ndswith(self.uni
+0001db50: 745f 7365 6c65 6374 6564 290a 2020 2020  t_selected).    
+0001db60: 2020 2020 5d0a 2020 2020 2020 2020 6966      ].        if
+0001db70: 2073 7461 636b 6572 733a 0a20 2020 2020   stackers:.     
+0001db80: 2020 2020 2020 2072 656e 6465 7265 7273         renderers
+0001db90: 203d 2062 6172 6368 6172 742e 7662 6172   = barchart.vbar
+0001dba0: 5f73 7461 636b 280a 2020 2020 2020 2020  _stack(.        
+0001dbb0: 2020 2020 2020 2020 7374 6163 6b65 7273          stackers
+0001dbc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001dbd0: 2020 783d 2266 756e 6374 696f 6e73 222c    x="functions",
+0001dbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dbf0: 2077 6964 7468 3d30 2e39 2c0a 2020 2020   width=0.9,.    
+0001dc00: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+0001dc10: 6365 3d73 656c 662e 7461 736b 5f65 7865  ce=self.task_exe
+0001dc20: 635f 6279 5f70 7265 6669 785f 7372 632c  c_by_prefix_src,
+0001dc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dc40: 2063 6f6c 6f72 3d73 6d61 6c6c 5f70 616c   color=small_pal
+0001dc50: 6574 7465 735b 2259 6c47 6e42 7522 5d2e  ettes["YlGnBu"].
+0001dc60: 6765 7428 6c65 6e28 7365 6c66 2e74 6173  get(len(self.tas
+0001dc70: 6b5f 6163 7469 7669 7469 6573 292c 205b  k_activities), [
+0001dc80: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0001dc90: 2020 2020 6c65 6765 6e64 5f6c 6162 656c      legend_label
+0001dca0: 3d73 656c 662e 7461 736b 5f61 6374 6976  =self.task_activ
+0001dcb0: 6974 6965 732c 0a20 2020 2020 2020 2020  ities,.         
+0001dcc0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001dcd0: 2066 6f72 2076 6261 7220 696e 2072 656e   for vbar in ren
+0001dce0: 6465 7265 7273 3a0a 2020 2020 2020 2020  derers:.        
+0001dcf0: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
+0001dd00: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0001dd10: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+0001dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd30: 2020 2076 6261 722e 6e61 6d65 2c0a 2020     vbar.name,.  
+0001dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd50: 2020 2020 2020 6622 407b 7b7b 7662 6172        f"@{{{vbar
+0001dd60: 2e6e 616d 657d 5f74 6578 747d 7d22 2c0a  .name}_text}}",.
+0001dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd80: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+0001dd90: 2020 2020 2020 2020 2020 2028 2266 756e             ("fun
+0001dda0: 6374 696f 6e22 2c20 2240 6675 6e63 7469  ction", "@functi
+0001ddb0: 6f6e 7322 292c 0a20 2020 2020 2020 2020  ons"),.         
+0001ddc0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0001ddd0: 2020 2020 2020 2020 2062 6172 6368 6172           barchar
+0001dde0: 742e 6164 645f 746f 6f6c 7328 486f 7665  t.add_tools(Hove
+0001ddf0: 7254 6f6f 6c28 746f 6f6c 7469 7073 3d74  rTool(tooltips=t
+0001de00: 6f6f 6c74 6970 732c 2072 656e 6465 7265  ooltips, rendere
+0001de10: 7273 3d5b 7662 6172 5d29 290a 0a20 2020  rs=[vbar]))..   
+0001de20: 2020 2020 2020 2020 2069 6620 616e 7928           if any(
+0001de30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001de40: 206c 656e 2873 656c 662e 7461 736b 5f65   len(self.task_e
+0001de50: 7865 635f 6279 5f70 7265 6669 785f 7372  xec_by_prefix_sr
+0001de60: 632e 6461 7461 5b6b 5d29 2021 3d20 6c65  c.data[k]) != le
+0001de70: 6e28 7461 736b 5f65 7865 635f 6461 7461  n(task_exec_data
+0001de80: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
+0001de90: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
+0001dea0: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
+0001deb0: 7072 6566 6978 5f73 7263 2e64 6174 610a  prefix_src.data.
+0001dec0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+0001ded0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001dee0: 656c 662e 7375 6273 7461 6e74 6961 6c5f  elf.substantial_
+0001def0: 6368 616e 6765 203d 2054 7275 650a 0a20  change = True.. 
+0001df00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001df10: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
+0001df20: 6669 785f 7372 632e 6461 7461 203d 2064  fix_src.data = d
+0001df30: 6963 7428 7461 736b 5f65 7865 635f 6461  ict(task_exec_da
+0001df40: 7461 290a 2020 2020 2020 2020 2020 2020  ta).            
+0001df50: 6261 7263 6861 7274 2e72 656e 6465 7265  barchart.rendere
+0001df60: 7273 203d 2072 656e 6465 7265 7273 0a20  rs = renderers. 
+0001df70: 2020 2020 2020 2072 6574 7572 6e20 6261         return ba
+0001df80: 7263 6861 7274 0a0a 2020 2020 6465 6620  rchart..    def 
+0001df90: 5f62 7569 6c64 5f73 656e 6464 6174 615f  _build_senddata_
+0001dfa0: 6368 6172 7428 7365 6c66 2c20 7365 6e64  chart(self, send
+0001dfb0: 6461 7461 3a20 6465 6661 756c 7464 6963  data: defaultdic
+0001dfc0: 745b 7374 722c 206c 6973 745d 2920 2d3e  t[str, list]) ->
+0001dfd0: 2066 6967 7572 653a 0a20 2020 2020 2020   figure:.       
+0001dfe0: 2070 6965 6461 7461 203d 207b 7d0a 2020   piedata = {}.  
+0001dff0: 2020 2020 2020 7069 6564 6174 615b 2261        piedata["a
+0001e000: 6374 6976 6974 7922 5d20 3d20 7365 6e64  ctivity"] = send
+0001e010: 6461 7461 5b22 6163 7469 7669 7479 225d  data["activity"]
+0001e020: 0a20 2020 2020 2020 2070 6965 6461 7461  .        piedata
+0001e030: 5b22 7661 6c75 6522 5d20 3d20 5b0a 2020  ["value"] = [.  
+0001e040: 2020 2020 2020 2020 2020 2873 756d 2873            (sum(s
+0001e050: 656e 6464 6174 615b 6622 7b6f 707d 5f7b  enddata[f"{op}_{
+0001e060: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
+0001e070: 6564 7d22 5d29 2920 666f 7220 6f70 2069  ed}"])) for op i
+0001e080: 6e20 7365 6e64 6461 7461 5b22 6163 7469  n senddata["acti
+0001e090: 7669 7479 225d 0a20 2020 2020 2020 205d  vity"].        ]
+0001e0a0: 0a20 2020 2020 2020 2070 6965 6461 7461  .        piedata
+0001e0b0: 5b22 7465 7874 225d 203d 205b 7365 6c66  ["text"] = [self
+0001e0c0: 2e66 6f72 6d61 7428 7365 6c66 2e75 6e69  .format(self.uni
+0001e0d0: 745f 7365 6c65 6374 6564 2c20 7629 2066  t_selected, v) f
+0001e0e0: 6f72 2076 2069 6e20 7069 6564 6174 615b  or v in piedata[
+0001e0f0: 2276 616c 7565 225d 5d0a 2020 2020 2020  "value"]].      
+0001e100: 2020 7069 6564 6174 615b 2261 6e67 6c65    piedata["angle
+0001e110: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
+0001e120: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
+0001e130: 2020 2020 2028 7375 6d28 7365 6e64 6461       (sum(sendda
+0001e140: 7461 5b66 227b 6f70 7d5f 7b73 656c 662e  ta[f"{op}_{self.
+0001e150: 756e 6974 5f73 656c 6563 7465 647d 225d  unit_selected}"]
+0001e160: 2920 2f20 7375 6d28 7069 6564 6174 615b  ) / sum(piedata[
+0001e170: 2276 616c 7565 225d 2929 0a20 2020 2020  "value"])).     
+0001e180: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+0001e190: 6d28 7069 6564 6174 615b 2276 616c 7565  m(piedata["value
+0001e1a0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+0001e1b0: 2020 2020 656c 7365 2030 2e30 0a20 2020      else 0.0.   
+0001e1c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001e1d0: 2020 2020 2020 202a 2032 0a20 2020 2020         * 2.     
+0001e1e0: 2020 2020 2020 202a 206d 6174 682e 7069         * math.pi
+0001e1f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001e200: 206f 7020 696e 2070 6965 6461 7461 5b22   op in piedata["
+0001e210: 6163 7469 7669 7479 225d 0a20 2020 2020  activity"].     
+0001e220: 2020 205d 0a20 2020 2020 2020 2070 6965     ].        pie
+0001e230: 6461 7461 5b22 636f 6c6f 7222 5d20 3d20  data["color"] = 
+0001e240: 736d 616c 6c5f 7061 6c65 7474 6573 5b22  small_palettes["
+0001e250: 596c 476e 4275 225d 2e67 6574 286c 656e  YlGnBu"].get(len
+0001e260: 2870 6965 6461 7461 5b22 6163 7469 7669  (piedata["activi
+0001e270: 7479 225d 292c 205b 5d29 0a0a 2020 2020  ty"]), [])..    
+0001e280: 2020 2020 7365 6c66 2e73 656e 6473 7263      self.sendsrc
+0001e290: 2e64 6174 6120 3d20 7069 6564 6174 610a  .data = piedata.
+0001e2a0: 2020 2020 2020 2020 7365 6e64 6461 7461          senddata
+0001e2b0: 5f70 6965 6368 6172 7420 3d20 6669 6775  _piechart = figu
+0001e2c0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+0001e2d0: 6865 6967 6874 3d35 3030 2c0a 2020 2020  height=500,.    
+0001e2e0: 2020 2020 2020 2020 7369 7a69 6e67 5f6d          sizing_m
+0001e2f0: 6f64 653d 2273 6361 6c65 5f62 6f74 6822  ode="scale_both"
+0001e300: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+0001e310: 746c 653d 2253 656e 6420 6461 7461 2c20  tle="Send data, 
+0001e320: 6279 2061 6374 6976 6974 7922 2c0a 2020  by activity",.  
+0001e330: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+0001e340: 2268 6f76 6572 222c 0a20 2020 2020 2020  "hover",.       
+0001e350: 2020 2020 2074 6f6f 6c74 6970 733d 2240       tooltips="@
+0001e360: 7b61 6374 6976 6974 797d 3a20 4074 6578  {activity}: @tex
+0001e370: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0001e380: 785f 7261 6e67 653d 282d 302e 352c 2031  x_range=(-0.5, 1
+0001e390: 2e30 292c 0a20 2020 2020 2020 2029 0a20  .0),.        ). 
+0001e3a0: 2020 2020 2020 2073 656e 6464 6174 615f         senddata_
+0001e3b0: 7069 6563 6861 7274 2e77 6564 6765 280a  piechart.wedge(.
+0001e3c0: 2020 2020 2020 2020 2020 2020 783d 302c              x=0,
+0001e3d0: 0a20 2020 2020 2020 2020 2020 2079 3d31  .            y=1
+0001e3e0: 2c0a 2020 2020 2020 2020 2020 2020 7261  ,.            ra
+0001e3f0: 6469 7573 3d30 2e34 2c0a 2020 2020 2020  dius=0.4,.      
+0001e400: 2020 2020 2020 7374 6172 745f 616e 676c        start_angl
+0001e410: 653d 6375 6d73 756d 2822 616e 676c 6522  e=cumsum("angle"
+0001e420: 2c20 696e 636c 7564 655f 7a65 726f 3d54  , include_zero=T
+0001e430: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
+0001e440: 2020 656e 645f 616e 676c 653d 6375 6d73    end_angle=cums
+0001e450: 756d 2822 616e 676c 6522 292c 0a20 2020  um("angle"),.   
+0001e460: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
+0001e470: 6c6f 723d 2277 6869 7465 222c 0a20 2020  lor="white",.   
+0001e480: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+0001e490: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
+0001e4a0: 2020 2020 2020 2020 206c 6567 656e 645f           legend_
+0001e4b0: 6669 656c 643d 2261 6374 6976 6974 7922  field="activity"
+0001e4c0: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
+0001e4d0: 7572 6365 3d73 656c 662e 7365 6e64 7372  urce=self.sendsr
+0001e4e0: 632c 0a20 2020 2020 2020 2029 0a20 2020  c,.        ).   
+0001e4f0: 2020 2020 2073 656e 6464 6174 615f 7069       senddata_pi
+0001e500: 6563 6861 7274 2e61 7869 732e 6178 6973  echart.axis.axis
+0001e510: 5f6c 6162 656c 203d 204e 6f6e 650a 2020  _label = None.  
+0001e520: 2020 2020 2020 7365 6e64 6461 7461 5f70        senddata_p
+0001e530: 6965 6368 6172 742e 6178 6973 2e76 6973  iechart.axis.vis
+0001e540: 6962 6c65 203d 2046 616c 7365 0a20 2020  ible = False.   
+0001e550: 2020 2020 2073 656e 6464 6174 615f 7069       senddata_pi
+0001e560: 6563 6861 7274 2e67 7269 642e 6772 6964  echart.grid.grid
+0001e570: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
+0001e580: 6e65 0a20 2020 2020 2020 2072 6574 7572  ne.        retur
+0001e590: 6e20 7365 6e64 6461 7461 5f70 6965 6368  n senddata_piech
+0001e5a0: 6172 740a 0a0a 636c 6173 7320 436f 6e74  art...class Cont
+0001e5b0: 656e 7469 6f6e 2844 6173 6862 6f61 7264  ention(Dashboard
+0001e5c0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
+0001e5d0: 2222 220a 2020 2020 4576 656e 7420 4c6f  """.    Event Lo
+0001e5e0: 6f70 2048 6561 6c74 6820 2861 6e64 2047  op Health (and G
+0001e5f0: 494c 2043 6f6e 7465 6e74 696f 6e2c 2069  IL Contention, i
+0001e600: 6620 636f 6e66 6967 7572 6564 290a 2020  f configured).  
+0001e610: 2020 2222 220a 0a20 2020 2040 6c6f 675f    """..    @log_
+0001e620: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
+0001e630: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+0001e640: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
+0001e650: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+0001e660: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+0001e670: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+0001e680: 656c 662e 6461 7461 203d 2064 6963 7428  elf.data = dict(
+0001e690: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001e6a0: 6573 3d5b 0a20 2020 2020 2020 2020 2020  es=[.           
+0001e6b0: 2020 2020 2028 2253 6368 6564 756c 6572       ("Scheduler
+0001e6c0: 222c 2022 4576 656e 7420 4c6f 6f70 2229  ", "Event Loop")
+0001e6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001e6e0: 2020 2822 5363 6865 6475 6c65 7222 2c20    ("Scheduler", 
+0001e6f0: 2247 494c 2043 6f6e 7465 6e74 696f 6e22  "GIL Contention"
+0001e700: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001e710: 2020 2028 2257 6f72 6b65 7273 222c 2022     ("Workers", "
+0001e720: 4576 656e 7420 4c6f 6f70 2229 2c0a 2020  Event Loop"),.  
+0001e730: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+0001e740: 576f 726b 6572 7322 2c20 2247 494c 2043  Workers", "GIL C
+0001e750: 6f6e 7465 6e74 696f 6e22 292c 0a20 2020  ontention"),.   
+0001e760: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+0001e770: 2020 2020 2020 2020 7661 6c75 6573 3d5b          values=[
+0001e780: 302c 2030 2c20 302c 2030 5d2c 0a20 2020  0, 0, 0, 0],.   
+0001e790: 2020 2020 2020 2020 2074 6578 743d 5b22           text=["
+0001e7a0: 3073 222c 2022 3025 222c 2022 3073 222c  0s", "0%", "0s",
+0001e7b0: 2022 3025 225d 2c0a 2020 2020 2020 2020   "0%"],.        
+0001e7c0: 290a 2020 2020 2020 2020 7469 746c 6520  ).        title 
+0001e7d0: 3d20 2245 7665 6e74 204c 6f6f 7020 2620  = "Event Loop & 
+0001e7e0: 4749 4c20 436f 6e74 656e 7469 6f6e 220a  GIL Contention".
+0001e7f0: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
+0001e800: 6520 4749 4c20 7265 6c61 7465 6420 6e61  e GIL related na
+0001e810: 6d65 732f 7661 6c75 6573 2069 6620 6e6f  mes/values if no
+0001e820: 7420 6d6f 6e69 746f 7269 6e67 2047 494c  t monitoring GIL
+0001e830: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001e840: 7365 6c66 2e73 6368 6564 756c 6572 2e6d  self.scheduler.m
+0001e850: 6f6e 6974 6f72 2e6d 6f6e 6974 6f72 5f67  onitor.monitor_g
+0001e860: 696c 5f63 6f6e 7465 6e74 696f 6e3a 0a20  il_contention:. 
+0001e870: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+0001e880: 203d 2022 4576 656e 7420 4c6f 6f70 220a   = "Event Loop".
+0001e890: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001e8a0: 6b65 7920 696e 2073 656c 662e 6461 7461  key in self.data
+0001e8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e8c0: 2020 7365 6c66 2e64 6174 615b 6b65 795d    self.data[key]
+0001e8d0: 203d 2073 656c 662e 6461 7461 5b6b 6579   = self.data[key
+0001e8e0: 5d5b 3a3a 325d 0a0a 2020 2020 2020 2020  ][::2]..        
+0001e8f0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
+0001e900: 6c75 6d6e 4461 7461 536f 7572 6365 2864  lumnDataSource(d
+0001e910: 6174 613d 7365 6c66 2e64 6174 6129 0a20  ata=self.data). 
+0001e920: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0001e930: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+0001e940: 2020 2020 2020 2074 6974 6c65 3d74 6974         title=tit
+0001e950: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+0001e960: 785f 7261 6e67 653d 4661 6374 6f72 5261  x_range=FactorRa
+0001e970: 6e67 6528 2a73 656c 662e 6461 7461 5b22  nge(*self.data["
+0001e980: 6e61 6d65 7322 5d29 2c0a 2020 2020 2020  names"]),.      
+0001e990: 2020 2020 2020 795f 7261 6e67 653d 2830        y_range=(0
+0001e9a0: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
+0001e9b0: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
+0001e9c0: 2020 2020 2020 2020 746f 6f6c 6261 725f          toolbar_
+0001e9d0: 6c6f 6361 7469 6f6e 3d22 6162 6f76 6522  location="above"
+0001e9e0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+0001e9f0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+0001ea00: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0001ea10: 6f6f 742e 7662 6172 280a 2020 2020 2020  oot.vbar(.      
+0001ea20: 2020 2020 2020 783d 226e 616d 6573 222c        x="names",
+0001ea30: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
+0001ea40: 3d22 7661 6c75 6573 222c 0a20 2020 2020  ="values",.     
+0001ea50: 2020 2020 2020 2077 6964 7468 3d30 2e39         width=0.9
+0001ea60: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+0001ea70: 6e65 5f63 6f6c 6f72 3d22 7768 6974 6522  ne_color="white"
+0001ea80: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
+0001ea90: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+0001eaa0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+0001eab0: 6c6c 5f63 6f6c 6f72 3d66 6163 746f 725f  ll_color=factor_
+0001eac0: 636d 6170 280a 2020 2020 2020 2020 2020  cmap(.          
+0001ead0: 2020 2020 2020 6669 656c 645f 6e61 6d65        field_name
+0001eae0: 3d22 6e61 6d65 7322 2c0a 2020 2020 2020  ="names",.      
+0001eaf0: 2020 2020 2020 2020 2020 7061 6c65 7474            palett
+0001eb00: 653d 5b22 2362 3865 3063 6522 2c20 2223  e=["#b8e0ce", "#
+0001eb10: 3831 6161 6534 225d 2c0a 2020 2020 2020  81aae4"],.      
+0001eb20: 2020 2020 2020 2020 2020 6661 6374 6f72            factor
+0001eb30: 733d 5b22 4576 656e 7420 4c6f 6f70 222c  s=["Event Loop",
+0001eb40: 2022 4749 4c20 436f 6e74 656e 7469 6f6e   "GIL Contention
+0001eb50: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0001eb60: 2020 2020 7374 6172 743d 312c 0a20 2020      start=1,.   
+0001eb70: 2020 2020 2020 2020 2020 2020 2065 6e64               end
+0001eb80: 3d32 2c0a 2020 2020 2020 2020 2020 2020  =2,.            
+0001eb90: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+0001eba0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0001ebb0: 785f 7261 6e67 652e 6772 6f75 705f 7061  x_range.group_pa
+0001ebc0: 6464 696e 6720 3d20 302e 3235 0a20 2020  dding = 0.25.   
+0001ebd0: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
+0001ebe0: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
+0001ebf0: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
+0001ec00: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0001ec10: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
+0001ec20: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
+0001ec30: 6c66 2e72 6f6f 742e 7867 7269 642e 7669  lf.root.xgrid.vi
+0001ec40: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0001ec50: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0001ec60: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
+0001ec70: 2020 2020 2020 746f 6f6c 7469 7073 3d5b        tooltips=[
+0001ec80: 2822 4e61 6d65 222c 2022 406e 616d 6573  ("Name", "@names
+0001ec90: 2229 2c20 2822 5661 6c75 6522 2c20 2240  "), ("Value", "@
+0001eca0: 7465 7874 2229 5d2c 206d 6f64 653d 2276  text")], mode="v
+0001ecb0: 6c69 6e65 220a 2020 2020 2020 2020 290a  line".        ).
+0001ecc0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001ecd0: 742e 6164 645f 746f 6f6c 7328 686f 7665  t.add_tools(hove
+0001ece0: 7229 0a0a 2020 2020 4077 6974 686f 7574  r)..    @without
+0001ecf0: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
+0001ed00: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
+0001ed10: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
+0001ed20: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
+0001ed30: 2020 2073 203d 2073 656c 662e 7363 6865     s = self.sche
+0001ed40: 6475 6c65 720a 2020 2020 2020 2020 6d6f  duler.        mo
+0001ed50: 6e69 746f 725f 6769 6c20 3d20 732e 6d6f  nitor_gil = s.mo
+0001ed60: 6e69 746f 722e 6d6f 6e69 746f 725f 6769  nitor.monitor_gi
+0001ed70: 6c5f 636f 6e74 656e 7469 6f6e 0a0a 2020  l_contention..  
+0001ed80: 2020 2020 2020 7365 6c66 2e64 6174 615b        self.data[
+0001ed90: 2276 616c 7565 7322 5d20 3d20 5b0a 2020  "values"] = [.  
+0001eda0: 2020 2020 2020 2020 2020 732e 5f74 6963            s._tic
+0001edb0: 6b5f 696e 7465 7276 616c 5f6f 6273 6572  k_interval_obser
+0001edc0: 7665 642c 0a20 2020 2020 2020 2020 2020  ved,.           
+0001edd0: 2073 656c 662e 6769 6c5f 636f 6e74 656e   self.gil_conten
+0001ede0: 7469 6f6e 5f73 6368 6564 756c 6572 2c0a  tion_scheduler,.
+0001edf0: 2020 2020 2020 2020 2020 2020 7375 6d28              sum(
+0001ee00: 772e 6d65 7472 6963 735b 2265 7665 6e74  w.metrics["event
+0001ee10: 5f6c 6f6f 705f 696e 7465 7276 616c 225d  _loop_interval"]
+0001ee20: 2066 6f72 2077 2069 6e20 732e 776f 726b   for w in s.work
+0001ee30: 6572 732e 7661 6c75 6573 2829 290a 2020  ers.values()).  
+0001ee40: 2020 2020 2020 2020 2020 2f20 286c 656e            / (len
+0001ee50: 2873 2e77 6f72 6b65 7273 2920 6f72 2031  (s.workers) or 1
+0001ee60: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
+0001ee70: 656c 662e 6769 6c5f 636f 6e74 656e 7469  elf.gil_contenti
+0001ee80: 6f6e 5f77 6f72 6b65 7273 2c0a 2020 2020  on_workers,.    
+0001ee90: 2020 2020 5d5b 3a3a 2031 2069 6620 6d6f      ][:: 1 if mo
+0001eea0: 6e69 746f 725f 6769 6c20 656c 7365 2032  nitor_gil else 2
+0001eeb0: 5d0a 0a20 2020 2020 2020 2023 2046 6f72  ]..        # For
+0001eec0: 6d61 7420 6576 656e 7420 6c6f 6f70 2061  mat event loop a
+0001eed0: 7320 7469 6d65 2061 6e64 2047 494c 2028  s time and GIL (
+0001eee0: 6966 2063 6f6e 6669 6775 7265 6429 2061  if configured) a
+0001eef0: 7320 250a 2020 2020 2020 2020 7365 6c66  s %.        self
+0001ef00: 2e64 6174 615b 2274 6578 7422 5d20 3d20  .data["text"] = 
+0001ef10: 5b0a 2020 2020 2020 2020 2020 2020 6622  [.            f"
+0001ef20: 7b78 202a 2031 3030 3a2e 3166 7d25 2220  {x * 100:.1f}%" 
+0001ef30: 6966 2069 2025 2032 2061 6e64 206d 6f6e  if i % 2 and mon
+0001ef40: 6974 6f72 5f67 696c 2065 6c73 6520 666f  itor_gil else fo
+0001ef50: 726d 6174 5f74 696d 6528 7829 0a20 2020  rmat_time(x).   
+0001ef60: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
+0001ef70: 7820 696e 2065 6e75 6d65 7261 7465 2873  x in enumerate(s
+0001ef80: 656c 662e 6461 7461 5b22 7661 6c75 6573  elf.data["values
+0001ef90: 225d 290a 2020 2020 2020 2020 5d0a 2020  "]).        ].  
+0001efa0: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
+0001efb0: 662e 736f 7572 6365 2c20 7365 6c66 2e64  f.source, self.d
+0001efc0: 6174 6129 0a0a 2020 2020 4070 726f 7065  ata)..    @prope
+0001efd0: 7274 790a 2020 2020 6465 6620 6769 6c5f  rty.    def gil_
+0001efe0: 636f 6e74 656e 7469 6f6e 5f77 6f72 6b65  contention_worke
+0001eff0: 7273 2873 656c 6629 202d 3e20 666c 6f61  rs(self) -> floa
+0001f000: 743a 0a20 2020 2020 2020 2077 6f72 6b65  t:.        worke
+0001f010: 7273 203d 2073 656c 662e 7363 6865 6475  rs = self.schedu
+0001f020: 6c65 722e 776f 726b 6572 730a 2020 2020  ler.workers.    
+0001f030: 2020 2020 6966 2077 6f72 6b65 7273 3a0a      if workers:.
+0001f040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001f050: 726e 2073 756d 280a 2020 2020 2020 2020  rn sum(.        
+0001f060: 2020 2020 2020 2020 772e 6d65 7472 6963          w.metric
+0001f070: 732e 6765 7428 2267 696c 5f63 6f6e 7465  s.get("gil_conte
+0001f080: 6e74 696f 6e22 2c20 3029 2066 6f72 2077  ntion", 0) for w
+0001f090: 2069 6e20 776f 726b 6572 732e 7661 6c75   in workers.valu
+0001f0a0: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+0001f0b0: 2029 202f 206c 656e 2877 6f72 6b65 7273   ) / len(workers
+0001f0c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001f0d0: 2066 6c6f 6174 2822 4e61 4e22 290a 0a20   float("NaN").. 
+0001f0e0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+0001f0f0: 2064 6566 2067 696c 5f63 6f6e 7465 6e74   def gil_content
+0001f100: 696f 6e5f 7363 6865 6475 6c65 7228 7365  ion_scheduler(se
+0001f110: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
+0001f120: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001f130: 662e 7363 6865 6475 6c65 722e 6d6f 6e69  f.scheduler.moni
+0001f140: 746f 722e 7265 6365 6e74 2829 2e67 6574  tor.recent().get
+0001f150: 2822 6769 6c5f 636f 6e74 656e 7469 6f6e  ("gil_contention
+0001f160: 222c 2066 6c6f 6174 2822 4e61 4e22 2929  ", float("NaN"))
+0001f170: 0a0a 0a63 6c61 7373 2045 7863 6570 7469  ...class Excepti
+0001f180: 6f6e 7354 6162 6c65 2844 6173 6862 6f61  onsTable(Dashboa
+0001f190: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
+0001f1a0: 2020 2222 220a 2020 2020 4578 6365 7074    """.    Except
+0001f1b0: 696f 6e73 206c 6f67 6765 6420 696e 2074  ions logged in t
+0001f1c0: 6173 6b73 2e0a 0a20 2020 2053 696e 6365  asks...    Since
+0001f1d0: 2074 6865 7265 206d 6967 6874 2062 6520   there might be 
+0001f1e0: 6d61 6e79 2072 656c 6174 6564 2065 7863  many related exc
+0001f1f0: 6570 7469 6f6e 7320 2865 2e67 2e2c 2061  eptions (e.g., a
+0001f200: 6c6c 2074 6173 6b73 2069 6e20 6120 6769  ll tasks in a gi
+0001f210: 7665 6e0a 2020 2020 7461 736b 2067 726f  ven.    task gro
+0001f220: 7570 2066 6169 6c20 666f 7220 7468 6520  up fail for the 
+0001f230: 7361 6d65 2072 6561 736f 6e29 2c20 7765  same reason), we
+0001f240: 206d 616b 6520 6120 6265 7374 2d65 6666   make a best-eff
+0001f250: 6f72 7420 6174 7465 6d70 7420 746f 0a20  ort attempt to. 
+0001f260: 2020 2028 3129 2061 6767 7265 6761 7465     (1) aggregate
+0001f270: 2074 6f20 7468 6520 7461 736b 2067 726f   to the task gro
+0001f280: 7570 2c20 616e 6420 2832 2920 6465 6475  up, and (2) dedu
+0001f290: 706c 6963 6174 6520 7369 6d69 6c61 7220  plicate similar 
+0001f2a0: 6c6f 6f6b 696e 6720 7461 736b 732e 0a20  looking tasks.. 
+0001f2b0: 2020 2022 2222 0a0a 2020 2020 7363 6865     """..    sche
+0001f2c0: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
+0001f2d0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+0001f2e0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+0001f2f0: 6572 3a20 5363 6865 6475 6c65 722c 2077  er: Scheduler, w
+0001f300: 6964 7468 3a20 696e 7420 3d20 3130 3030  idth: int = 1000
+0001f310: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
+0001f320: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+0001f330: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+0001f340: 756c 6572 0a0a 2020 2020 2020 2020 7365  uler..        se
+0001f350: 6c66 2e6e 616d 6573 203d 205b 0a20 2020  lf.names = [.   
+0001f360: 2020 2020 2020 2020 2022 5461 736b 222c           "Task",
+0001f370: 0a20 2020 2020 2020 2020 2020 2022 4578  .            "Ex
+0001f380: 6365 7074 696f 6e22 2c0a 2020 2020 2020  ception",.      
+0001f390: 2020 2020 2020 2254 7261 6365 6261 636b        "Traceback
+0001f3a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0001f3b0: 576f 726b 6572 2873 2922 2c0a 2020 2020  Worker(s)",.    
+0001f3c0: 2020 2020 2020 2020 2243 6f75 6e74 222c          "Count",
+0001f3d0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
+0001f3e0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+0001f3f0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+0001f400: 6365 287b 6b3a 205b 5d20 666f 7220 6b20  ce({k: [] for k 
+0001f410: 696e 2073 656c 662e 6e61 6d65 737d 290a  in self.names}).
+0001f420: 0a20 2020 2020 2020 2063 6f64 655f 666f  .        code_fo
+0001f430: 726d 6174 7465 7220 3d20 4854 4d4c 5465  rmatter = HTMLTe
+0001f440: 6d70 6c61 7465 466f 726d 6174 7465 7228  mplateFormatter(
+0001f450: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0001f460: 706c 6174 653d 273c 636f 6465 2074 6974  plate='<code tit
+0001f470: 6c65 3d22 3c25 2d20 7661 6c75 6520 253e  le="<%- value %>
+0001f480: 223e 3c25 3d20 7661 6c75 6520 253e 3c2f  "><%= value %></
+0001f490: 636f 6465 3e27 0a20 2020 2020 2020 2029  code>'.        )
+0001f4a0: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
+0001f4b0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0001f4c0: 2054 6162 6c65 436f 6c75 6d6e 280a 2020   TableColumn(.  
+0001f4d0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0001f4e0: 656c 643d 2254 6173 6b22 2c0a 2020 2020  eld="Task",.    
+0001f4f0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+0001f500: 653d 2254 6173 6b22 2c0a 2020 2020 2020  e="Task",.      
+0001f510: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0001f520: 7465 723d 636f 6465 5f66 6f72 6d61 7474  ter=code_formatt
+0001f530: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0001f540: 2020 2020 7769 6474 683d 3135 302c 0a20      width=150,. 
+0001f550: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0001f560: 2020 2020 2020 2020 2020 5461 626c 6543            TableC
+0001f570: 6f6c 756d 6e28 0a20 2020 2020 2020 2020  olumn(.         
+0001f580: 2020 2020 2020 2066 6965 6c64 3d22 4578         field="Ex
+0001f590: 6365 7074 696f 6e22 2c0a 2020 2020 2020  ception",.      
+0001f5a0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0001f5b0: 2245 7863 6570 7469 6f6e 222c 0a20 2020  "Exception",.   
+0001f5c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001f5d0: 6d61 7474 6572 3d63 6f64 655f 666f 726d  matter=code_form
+0001f5e0: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
+0001f5f0: 2020 2020 2020 2077 6964 7468 3d33 3030         width=300
+0001f600: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
+0001f610: 0a20 2020 2020 2020 2020 2020 2054 6162  .            Tab
+0001f620: 6c65 436f 6c75 6d6e 280a 2020 2020 2020  leColumn(.      
+0001f630: 2020 2020 2020 2020 2020 6669 656c 643d            field=
+0001f640: 2254 7261 6365 6261 636b 222c 0a20 2020  "Traceback",.   
+0001f650: 2020 2020 2020 2020 2020 2020 2074 6974               tit
+0001f660: 6c65 3d22 5472 6163 6562 6163 6b22 2c0a  le="Traceback",.
+0001f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f680: 666f 726d 6174 7465 723d 636f 6465 5f66  formatter=code_f
+0001f690: 6f72 6d61 7474 6572 2c0a 2020 2020 2020  ormatter,.      
+0001f6a0: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+0001f6b0: 3330 302c 0a20 2020 2020 2020 2020 2020  300,.           
+0001f6c0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0001f6d0: 5461 626c 6543 6f6c 756d 6e28 0a20 2020  TableColumn(.   
+0001f6e0: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+0001f6f0: 6c64 3d22 576f 726b 6572 2873 2922 2c0a  ld="Worker(s)",.
+0001f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f710: 7469 746c 653d 2257 6f72 6b65 7228 7329  title="Worker(s)
+0001f720: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001f730: 2020 2066 6f72 6d61 7474 6572 3d63 6f64     formatter=cod
+0001f740: 655f 666f 726d 6174 7465 722c 0a20 2020  e_formatter,.   
+0001f750: 2020 2020 2020 2020 2020 2020 2077 6964               wid
+0001f760: 7468 3d32 3030 2c0a 2020 2020 2020 2020  th=200,.        
+0001f770: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+0001f780: 2020 2054 6162 6c65 436f 6c75 6d6e 280a     TableColumn(.
+0001f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f7a0: 6669 656c 643d 2243 6f75 6e74 222c 0a20  field="Count",. 
+0001f7b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001f7c0: 6974 6c65 3d22 436f 756e 7422 2c0a 2020  itle="Count",.  
+0001f7d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001f7e0: 726d 6174 7465 723d 4e75 6d62 6572 466f  rmatter=NumberFo
+0001f7f0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+0001f800: 302c 3022 292c 0a20 2020 2020 2020 2020  0,0"),.         
+0001f810: 2020 2020 2020 2077 6964 7468 3d35 302c         width=50,
+0001f820: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0001f830: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+0001f840: 2020 2069 6620 2273 697a 696e 675f 6d6f     if "sizing_mo
+0001f850: 6465 2220 696e 206b 7761 7267 733a 0a20  de" in kwargs:. 
+0001f860: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
+0001f870: 675f 6d6f 6465 203d 207b 2273 697a 696e  g_mode = {"sizin
+0001f880: 675f 6d6f 6465 223a 206b 7761 7267 735b  g_mode": kwargs[
+0001f890: 2273 697a 696e 675f 6d6f 6465 225d 7d0a  "sizing_mode"]}.
+0001f8a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f8b0: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
+0001f8c0: 5f6d 6f64 6520 3d20 7b7d 0a20 2020 2020  _mode = {}.     
+0001f8d0: 2020 2073 656c 662e 726f 6f74 203d 2044     self.root = D
+0001f8e0: 6174 6154 6162 6c65 280a 2020 2020 2020  ataTable(.      
+0001f8f0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+0001f900: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
+0001f910: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
+0001f920: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
+0001f930: 2020 2072 656f 7264 6572 6162 6c65 3d54     reorderable=T
+0001f940: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0001f950: 2073 6f72 7461 626c 653d 5472 7565 2c0a   sortable=True,.
+0001f960: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+0001f970: 683d 7769 6474 682c 0a20 2020 2020 2020  h=width,.       
+0001f980: 2020 2020 2069 6e64 6578 5f70 6f73 6974       index_posit
+0001f990: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
+0001f9a0: 2020 2020 2020 2a2a 5f44 4154 4154 4142        **_DATATAB
+0001f9b0: 4c45 5f53 5459 4c45 5348 4545 5453 5f4b  LE_STYLESHEETS_K
+0001f9c0: 5741 5247 532c 0a20 2020 2020 2020 2020  WARGS,.         
+0001f9d0: 2020 202a 2a73 697a 696e 675f 6d6f 6465     **sizing_mode
+0001f9e0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0001f9f0: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
+0001fa00: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
+0001fa10: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
+0001fa20: 6629 3a0a 2020 2020 2020 2020 6e65 775f  f):.        new_
+0001fa30: 6461 7461 203d 207b 6e61 6d65 3a20 5b5d  data = {name: []
+0001fa40: 2066 6f72 206e 616d 6520 696e 2073 656c   for name in sel
+0001fa50: 662e 6e61 6d65 737d 0a20 2020 2020 2020  f.names}.       
+0001fa60: 2065 7272 6564 5f74 6173 6b73 203d 2073   erred_tasks = s
+0001fa70: 656c 662e 7363 6865 6475 6c65 722e 6572  elf.scheduler.er
+0001fa80: 7265 645f 7461 736b 730a 0a20 2020 2020  red_tasks..     
+0001fa90: 2020 2066 6f72 2074 7320 696e 2065 7272     for ts in err
+0001faa0: 6564 5f74 6173 6b73 3a0a 2020 2020 2020  ed_tasks:.      
+0001fab0: 2020 2020 2020 6e65 775f 6461 7461 5b22        new_data["
+0001fac0: 5461 736b 225d 2e61 7070 656e 6428 7473  Task"].append(ts
+0001fad0: 2e6b 6579 290a 2020 2020 2020 2020 2020  .key).          
+0001fae0: 2020 6e65 775f 6461 7461 5b22 4578 6365    new_data["Exce
+0001faf0: 7074 696f 6e22 5d2e 6170 7065 6e64 2874  ption"].append(t
+0001fb00: 732e 6578 6365 7074 696f 6e5f 7465 7874  s.exception_text
+0001fb10: 290a 2020 2020 2020 2020 2020 2020 6e65  ).            ne
+0001fb20: 775f 6461 7461 5b22 5472 6163 6562 6163  w_data["Tracebac
+0001fb30: 6b22 5d2e 6170 7065 6e64 2874 732e 7472  k"].append(ts.tr
+0001fb40: 6163 6562 6163 6b5f 7465 7874 290a 2020  aceback_text).  
+0001fb50: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
+0001fb60: 7461 5b22 576f 726b 6572 2873 2922 5d2e  ta["Worker(s)"].
+0001fb70: 6170 7065 6e64 2822 2c5c 6e22 2e6a 6f69  append(",\n".joi
+0001fb80: 6e28 7473 2e65 7272 6564 5f6f 6e29 290a  n(ts.erred_on)).
+0001fb90: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0001fba0: 6461 7461 5b22 436f 756e 7422 5d2e 6170  data["Count"].ap
+0001fbb0: 7065 6e64 286c 656e 2874 732e 6572 7265  pend(len(ts.erre
+0001fbc0: 645f 6f6e 2929 0a0a 2020 2020 2020 2020  d_on))..        
+0001fbd0: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
+0001fbe0: 6365 2c20 6e65 775f 6461 7461 290a 0a0a  ce, new_data)...
+0001fbf0: 636c 6173 7320 576f 726b 6572 5461 626c  class WorkerTabl
+0001fc00: 6528 4461 7368 626f 6172 6443 6f6d 706f  e(DashboardCompo
+0001fc10: 6e65 6e74 293a 0a20 2020 2022 2222 5374  nent):.    """St
+0001fc20: 6174 7573 206f 6620 7468 6520 6375 7272  atus of the curr
+0001fc30: 656e 7420 776f 726b 6572 730a 0a20 2020  ent workers..   
+0001fc40: 2054 6869 7320 6973 2074 776f 2070 6c6f   This is two plo
+0001fc50: 7473 2c20 6120 7465 7874 2d62 6173 6564  ts, a text-based
+0001fc60: 2074 6162 6c65 2066 6f72 2065 6163 6820   table for each 
+0001fc70: 686f 7374 2061 6e64 2061 2074 6869 6e20  host and a thin 
+0001fc80: 686f 7269 7a6f 6e74 616c 0a20 2020 2070  horizontal.    p
+0001fc90: 6c6f 7420 6c61 7969 6e67 206f 7574 2068  lot laying out h
+0001fca0: 6f73 7473 2062 7920 7468 6569 7220 6375  osts by their cu
+0001fcb0: 7272 656e 7420 6d65 6d6f 7279 2075 7365  rrent memory use
+0001fcc0: 2e0a 2020 2020 2222 220a 0a20 2020 2065  ..    """..    e
+0001fcd0: 7863 6c75 6465 645f 6e61 6d65 7320 3d20  xcluded_names = 
+0001fce0: 7b0a 2020 2020 2020 2020 2265 7865 6375  {.        "execu
+0001fcf0: 7469 6e67 222c 0a20 2020 2020 2020 2022  ting",.        "
+0001fd00: 696e 5f66 6c69 6768 7422 2c0a 2020 2020  in_flight",.    
+0001fd10: 2020 2020 2269 6e5f 6d65 6d6f 7279 222c      "in_memory",
+0001fd20: 0a20 2020 2020 2020 2022 7265 6164 7922  .        "ready"
+0001fd30: 2c0a 2020 2020 2020 2020 2274 696d 6522  ,.        "time"
+0001fd40: 2c0a 2020 2020 2020 2020 2320 5573 6520  ,.        # Use 
+0001fd50: 7363 6865 6475 6c65 722e 576f 726b 6572  scheduler.Worker
+0001fd60: 5374 6174 652e 6d65 6d6f 7279 2e6d 616e  State.memory.man
+0001fd70: 6167 6564 2069 6e73 7465 6164 206f 660a  aged instead of.
+0001fd80: 2020 2020 2020 2020 2320 7363 6865 6475          # schedu
+0001fd90: 6c65 722e 576f 726b 6572 5374 6174 652e  ler.WorkerState.
+0001fda0: 6d65 7472 6963 735b 226d 616e 6167 6564  metrics["managed
+0001fdb0: 5f62 7974 6573 225d 3b20 7468 6520 7477  _bytes"]; the tw
+0001fdc0: 6f20 6d65 6173 7572 6573 2061 7265 2073  o measures are s
+0001fdd0: 6c69 6768 746c 790a 2020 2020 2020 2020  lightly.        
+0001fde0: 2320 6469 6666 6572 656e 742e 2053 6565  # different. See
+0001fdf0: 2065 7870 6c61 6e61 7469 6f6e 2069 6e20   explanation in 
+0001fe00: 7363 6865 6475 6c65 722e 576f 726b 6572  scheduler.Worker
+0001fe10: 5374 6174 652e 6d65 6d6f 7279 2829 2e0a  State.memory()..
+0001fe20: 2020 2020 2020 2020 226d 616e 6167 6564          "managed
+0001fe30: 5f62 7974 6573 222c 0a20 2020 2020 2020  _bytes",.       
+0001fe40: 2022 7370 696c 6c65 645f 6279 7465 7322   "spilled_bytes"
+0001fe50: 2c0a 2020 2020 7d0a 0a20 2020 2064 6566  ,.    }..    def
+0001fe60: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0001fe70: 7363 6865 6475 6c65 722c 2077 6964 7468  scheduler, width
+0001fe80: 3d38 3030 2c20 2a2a 6b77 6172 6773 293a  =800, **kwargs):
+0001fe90: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+0001fea0: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
+0001feb0: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
+0001fec0: 2e6e 616d 6573 203d 205b 0a20 2020 2020  .names = [.     
+0001fed0: 2020 2020 2020 2022 6e61 6d65 222c 0a20         "name",. 
+0001fee0: 2020 2020 2020 2020 2020 2022 6164 6472             "addr
+0001fef0: 6573 7322 2c0a 2020 2020 2020 2020 2020  ess",.          
+0001ff00: 2020 226e 7468 7265 6164 7322 2c0a 2020    "nthreads",.  
+0001ff10: 2020 2020 2020 2020 2020 2263 7075 222c            "cpu",
+0001ff20: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+0001ff30: 6d6f 7279 222c 0a20 2020 2020 2020 2020  mory",.         
+0001ff40: 2020 2022 6d65 6d6f 7279 5f6c 696d 6974     "memory_limit
+0001ff50: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0001ff60: 6d65 6d6f 7279 5f70 6572 6365 6e74 222c  memory_percent",
+0001ff70: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+0001ff80: 6d6f 7279 5f6d 616e 6167 6564 222c 0a20  mory_managed",. 
+0001ff90: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+0001ffa0: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
+0001ffb0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0001ffc0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+0001ffd0: 5f72 6563 656e 7422 2c0a 2020 2020 2020  _recent",.      
+0001ffe0: 2020 2020 2020 226d 656d 6f72 795f 7370        "memory_sp
+0001fff0: 696c 6c65 6422 2c0a 2020 2020 2020 2020  illed",.        
+00020000: 2020 2020 226e 756d 5f66 6473 222c 0a20      "num_fds",. 
+00020010: 2020 2020 2020 2020 2020 2022 686f 7374             "host
+00020020: 5f6e 6574 5f69 6f2e 7265 6164 5f62 7073  _net_io.read_bps
+00020030: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00020040: 686f 7374 5f6e 6574 5f69 6f2e 7772 6974  host_net_io.writ
+00020050: 655f 6270 7322 2c0a 2020 2020 2020 2020  e_bps",.        
+00020060: 2020 2020 2268 6f73 745f 6469 736b 5f69      "host_disk_i
+00020070: 6f2e 7265 6164 5f62 7073 222c 0a20 2020  o.read_bps",.   
+00020080: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
+00020090: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
+000200a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000200b0: 6370 755f 6672 6163 7469 6f6e 222c 0a20  cpu_fraction",. 
+000200c0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+000200d0: 2077 6f72 6b65 7273 203d 2073 656c 662e   workers = self.
+000200e0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+000200f0: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
+00020100: 2020 2073 656c 662e 6578 7472 615f 6e61     self.extra_na
+00020110: 6d65 7320 3d20 736f 7274 6564 280a 2020  mes = sorted(.  
+00020120: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00020130: 2020 2020 2020 2020 2020 2020 6d0a 2020              m.  
+00020140: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00020150: 7220 7773 2069 6e20 776f 726b 6572 730a  r ws in workers.
+00020160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020170: 666f 7220 6d2c 2076 2069 6e20 7773 2e6d  for m, v in ws.m
+00020180: 6574 7269 6373 2e69 7465 6d73 2829 0a20  etrics.items(). 
+00020190: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000201a0: 6620 6d20 6e6f 7420 696e 2073 656c 662e  f m not in self.
+000201b0: 6e61 6d65 7320 616e 6420 6973 696e 7374  names and isinst
+000201c0: 616e 6365 2876 2c20 2873 7472 2c20 696e  ance(v, (str, in
+000201d0: 742c 2066 6c6f 6174 2929 0a20 2020 2020  t, float)).     
+000201e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000201f0: 2020 2020 202d 2073 656c 662e 6578 636c       - self.excl
+00020200: 7564 6564 5f6e 616d 6573 0a20 2020 2020  uded_names.     
+00020210: 2020 2029 0a0a 2020 2020 2020 2020 7461     )..        ta
+00020220: 626c 655f 6e61 6d65 7320 3d20 5b0a 2020  ble_names = [.  
+00020230: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+00020240: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
+00020250: 6464 7265 7373 222c 0a20 2020 2020 2020  ddress",.       
+00020260: 2020 2020 2022 6e74 6872 6561 6473 222c       "nthreads",
+00020270: 0a20 2020 2020 2020 2020 2020 2022 6370  .            "cp
+00020280: 7522 2c0a 2020 2020 2020 2020 2020 2020  u",.            
+00020290: 226d 656d 6f72 7922 2c0a 2020 2020 2020  "memory",.      
+000202a0: 2020 2020 2020 226d 656d 6f72 795f 6c69        "memory_li
+000202b0: 6d69 7422 2c0a 2020 2020 2020 2020 2020  mit",.          
+000202c0: 2020 226d 656d 6f72 795f 7065 7263 656e    "memory_percen
+000202d0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+000202e0: 226d 656d 6f72 795f 6d61 6e61 6765 6422  "memory_managed"
+000202f0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00020300: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00020310: 6f6c 6422 2c0a 2020 2020 2020 2020 2020  old",.          
+00020320: 2020 226d 656d 6f72 795f 756e 6d61 6e61    "memory_unmana
+00020330: 6765 645f 7265 6365 6e74 222c 0a20 2020  ged_recent",.   
+00020340: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00020350: 5f73 7069 6c6c 6564 222c 0a20 2020 2020  _spilled",.     
+00020360: 2020 2020 2020 2022 6e75 6d5f 6664 7322         "num_fds"
+00020370: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+00020380: 6f73 745f 6e65 745f 696f 2e72 6561 645f  ost_net_io.read_
+00020390: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
+000203a0: 2020 2268 6f73 745f 6e65 745f 696f 2e77    "host_net_io.w
+000203b0: 7269 7465 5f62 7073 222c 0a20 2020 2020  rite_bps",.     
+000203c0: 2020 2020 2020 2022 686f 7374 5f64 6973         "host_dis
+000203d0: 6b5f 696f 2e72 6561 645f 6270 7322 2c0a  k_io.read_bps",.
+000203e0: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+000203f0: 745f 6469 736b 5f69 6f2e 7772 6974 655f  t_disk_io.write_
+00020400: 6270 7322 2c0a 2020 2020 2020 2020 5d0a  bps",.        ].
+00020410: 2020 2020 2020 2020 636f 6c75 6d6e 5f74          column_t
+00020420: 6974 6c65 5f72 656e 616d 6573 203d 207b  itle_renames = {
+00020430: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00020440: 6d6f 7279 5f6c 696d 6974 223a 2022 6c69  mory_limit": "li
+00020450: 6d69 7422 2c0a 2020 2020 2020 2020 2020  mit",.          
+00020460: 2020 226d 656d 6f72 795f 7065 7263 656e    "memory_percen
+00020470: 7422 3a20 226d 656d 6f72 7920 2522 2c0a  t": "memory %",.
+00020480: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
+00020490: 6f72 795f 6d61 6e61 6765 6422 3a20 226d  ory_managed": "m
+000204a0: 616e 6167 6564 222c 0a20 2020 2020 2020  anaged",.       
+000204b0: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
+000204c0: 616e 6167 6564 5f6f 6c64 223a 2022 756e  anaged_old": "un
+000204d0: 6d61 6e61 6765 6420 6f6c 6422 2c0a 2020  managed old",.  
+000204e0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+000204f0: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
+00020500: 6e74 223a 2022 756e 6d61 6e61 6765 6420  nt": "unmanaged 
+00020510: 7265 6365 6e74 222c 0a20 2020 2020 2020  recent",.       
+00020520: 2020 2020 2022 6d65 6d6f 7279 5f73 7069       "memory_spi
+00020530: 6c6c 6564 223a 2022 7370 696c 6c65 6422  lled": "spilled"
+00020540: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
+00020550: 756d 5f66 6473 223a 2022 2320 6664 7322  um_fds": "# fds"
+00020560: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+00020570: 6f73 745f 6e65 745f 696f 2e72 6561 645f  ost_net_io.read_
+00020580: 6270 7322 3a20 226e 6574 2072 6561 6422  bps": "net read"
+00020590: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+000205a0: 6f73 745f 6e65 745f 696f 2e77 7269 7465  ost_net_io.write
+000205b0: 5f62 7073 223a 2022 6e65 7420 7772 6974  _bps": "net writ
+000205c0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+000205d0: 2268 6f73 745f 6469 736b 5f69 6f2e 7265  "host_disk_io.re
+000205e0: 6164 5f62 7073 223a 2022 6469 736b 2072  ad_bps": "disk r
+000205f0: 6561 6422 2c0a 2020 2020 2020 2020 2020  ead",.          
+00020600: 2020 2268 6f73 745f 6469 736b 5f69 6f2e    "host_disk_io.
+00020610: 7772 6974 655f 6270 7322 3a20 2264 6973  write_bps": "dis
+00020620: 6b20 7772 6974 6522 2c0a 2020 2020 2020  k write",.      
+00020630: 2020 7d0a 0a20 2020 2020 2020 2073 656c    }..        sel
+00020640: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
+00020650: 6e44 6174 6153 6f75 7263 6528 7b6b 3a20  nDataSource({k: 
+00020660: 5b5d 2066 6f72 206b 2069 6e20 7365 6c66  [] for k in self
+00020670: 2e6e 616d 6573 7d29 0a0a 2020 2020 2020  .names})..      
+00020680: 2020 636f 6c75 6d6e 7320 3d20 7b0a 2020    columns = {.  
+00020690: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+000206a0: 5461 626c 6543 6f6c 756d 6e28 6669 656c  TableColumn(fiel
+000206b0: 643d 6e61 6d65 2c20 7469 746c 653d 636f  d=name, title=co
+000206c0: 6c75 6d6e 5f74 6974 6c65 5f72 656e 616d  lumn_title_renam
+000206d0: 6573 2e67 6574 286e 616d 652c 206e 616d  es.get(name, nam
+000206e0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+000206f0: 666f 7220 6e61 6d65 2069 6e20 7461 626c  for name in tabl
+00020700: 655f 6e61 6d65 730a 2020 2020 2020 2020  e_names.        
+00020710: 7d0a 0a20 2020 2020 2020 2066 6f72 6d61  }..        forma
+00020720: 7474 6572 7320 3d20 7b0a 2020 2020 2020  tters = {.      
+00020730: 2020 2020 2020 2263 7075 223a 204e 756d        "cpu": Num
+00020740: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00020750: 6d61 743d 2230 2025 2229 2c0a 2020 2020  mat="0 %"),.    
+00020760: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+00020770: 7065 7263 656e 7422 3a20 4e75 6d62 6572  percent": Number
+00020780: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+00020790: 3d22 302e 3020 2522 292c 0a20 2020 2020  ="0.0 %"),.     
+000207a0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
+000207b0: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
+000207c0: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
+000207d0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+000207e0: 656d 6f72 795f 6c69 6d69 7422 3a20 4e75  emory_limit": Nu
+000207f0: 6d62 6572 466f 726d 6174 7465 7228 666f  mberFormatter(fo
+00020800: 726d 6174 3d22 302e 3020 6222 292c 0a20  rmat="0.0 b"),. 
+00020810: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00020820: 7279 5f6d 616e 6167 6564 223a 204e 756d  ry_managed": Num
+00020830: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00020840: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
+00020850: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00020860: 795f 756e 6d61 6e61 6765 645f 6f6c 6422  y_unmanaged_old"
+00020870: 3a20 4e75 6d62 6572 466f 726d 6174 7465  : NumberFormatte
+00020880: 7228 666f 726d 6174 3d22 302e 3020 6222  r(format="0.0 b"
+00020890: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+000208a0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+000208b0: 5f72 6563 656e 7422 3a20 4e75 6d62 6572  _recent": Number
+000208c0: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+000208d0: 3d22 302e 3020 6222 292c 0a20 2020 2020  ="0.0 b"),.     
+000208e0: 2020 2020 2020 2022 6d65 6d6f 7279 5f73         "memory_s
+000208f0: 7069 6c6c 6564 223a 204e 756d 6265 7246  pilled": NumberF
+00020900: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+00020910: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
+00020920: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
+00020930: 696f 2e72 6561 645f 6270 7322 3a20 4e75  io.read_bps": Nu
+00020940: 6d62 6572 466f 726d 6174 7465 7228 666f  mberFormatter(fo
+00020950: 726d 6174 3d22 3020 6222 292c 0a20 2020  rmat="0 b"),.   
+00020960: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
+00020970: 6574 5f69 6f2e 7772 6974 655f 6270 7322  et_io.write_bps"
+00020980: 3a20 4e75 6d62 6572 466f 726d 6174 7465  : NumberFormatte
+00020990: 7228 666f 726d 6174 3d22 3020 6222 292c  r(format="0 b"),
+000209a0: 0a20 2020 2020 2020 2020 2020 2022 6e75  .            "nu
+000209b0: 6d5f 6664 7322 3a20 4e75 6d62 6572 466f  m_fds": NumberFo
+000209c0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+000209d0: 3022 292c 0a20 2020 2020 2020 2020 2020  0"),.           
+000209e0: 2022 6e74 6872 6561 6473 223a 204e 756d   "nthreads": Num
+000209f0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00020a00: 6d61 743d 2230 2229 2c0a 2020 2020 2020  mat="0"),.      
+00020a10: 2020 2020 2020 2268 6f73 745f 6469 736b        "host_disk
+00020a20: 5f69 6f2e 7265 6164 5f62 7073 223a 204e  _io.read_bps": N
+00020a30: 756d 6265 7246 6f72 6d61 7474 6572 2866  umberFormatter(f
+00020a40: 6f72 6d61 743d 2230 2062 2229 2c0a 2020  ormat="0 b"),.  
+00020a50: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
+00020a60: 6469 736b 5f69 6f2e 7772 6974 655f 6270  disk_io.write_bp
+00020a70: 7322 3a20 4e75 6d62 6572 466f 726d 6174  s": NumberFormat
+00020a80: 7465 7228 666f 726d 6174 3d22 3020 6222  ter(format="0 b"
+00020a90: 292c 0a20 2020 2020 2020 207d 0a0a 2020  ),.        }..  
+00020aa0: 2020 2020 2020 7461 626c 6520 3d20 4461        table = Da
+00020ab0: 7461 5461 626c 6528 0a20 2020 2020 2020  taTable(.       
+00020ac0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00020ad0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+00020ae0: 2020 2020 2063 6f6c 756d 6e73 3d5b 636f       columns=[co
+00020af0: 6c75 6d6e 735b 6e5d 2066 6f72 206e 2069  lumns[n] for n i
+00020b00: 6e20 7461 626c 655f 6e61 6d65 735d 2c0a  n table_names],.
+00020b10: 2020 2020 2020 2020 2020 2020 7265 6f72              reor
+00020b20: 6465 7261 626c 653d 5472 7565 2c0a 2020  derable=True,.  
+00020b30: 2020 2020 2020 2020 2020 736f 7274 6162            sortab
+00020b40: 6c65 3d54 7275 652c 0a20 2020 2020 2020  le=True,.       
+00020b50: 2020 2020 2077 6964 7468 3d77 6964 7468       width=width
+00020b60: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00020b70: 6465 785f 706f 7369 7469 6f6e 3d4e 6f6e  dex_position=Non
+00020b80: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
+00020b90: 2a5f 4441 5441 5441 424c 455f 5354 594c  *_DATATABLE_STYL
+00020ba0: 4553 4845 4554 535f 4b57 4152 4753 2c0a  ESHEETS_KWARGS,.
+00020bb0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00020bc0: 2020 2066 6f72 206e 616d 6520 696e 2074     for name in t
+00020bd0: 6162 6c65 5f6e 616d 6573 3a0a 2020 2020  able_names:.    
+00020be0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+00020bf0: 696e 2066 6f72 6d61 7474 6572 733a 0a20  in formatters:. 
+00020c00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00020c10: 6162 6c65 2e63 6f6c 756d 6e73 5b74 6162  able.columns[tab
+00020c20: 6c65 5f6e 616d 6573 2e69 6e64 6578 286e  le_names.index(n
+00020c30: 616d 6529 5d2e 666f 726d 6174 7465 7220  ame)].formatter 
+00020c40: 3d20 666f 726d 6174 7465 7273 5b6e 616d  = formatters[nam
+00020c50: 655d 0a0a 2020 2020 2020 2020 6578 7472  e]..        extr
+00020c60: 615f 6e61 6d65 7320 3d20 5b22 6e61 6d65  a_names = ["name
+00020c70: 222c 2022 6164 6472 6573 7322 5d20 2b20  ", "address"] + 
+00020c80: 7365 6c66 2e65 7874 7261 5f6e 616d 6573  self.extra_names
+00020c90: 0a20 2020 2020 2020 2065 7874 7261 5f63  .        extra_c
+00020ca0: 6f6c 756d 6e73 203d 207b 0a20 2020 2020  olumns = {.     
+00020cb0: 2020 2020 2020 206e 616d 653a 2054 6162         name: Tab
+00020cc0: 6c65 436f 6c75 6d6e 2866 6965 6c64 3d6e  leColumn(field=n
+00020cd0: 616d 652c 2074 6974 6c65 3d63 6f6c 756d  ame, title=colum
+00020ce0: 6e5f 7469 746c 655f 7265 6e61 6d65 732e  n_title_renames.
+00020cf0: 6765 7428 6e61 6d65 2c20 6e61 6d65 2929  get(name, name))
+00020d00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00020d10: 206e 616d 6520 696e 2065 7874 7261 5f6e   name in extra_n
+00020d20: 616d 6573 0a20 2020 2020 2020 207d 0a0a  ames.        }..
+00020d30: 2020 2020 2020 2020 6578 7472 615f 7461          extra_ta
+00020d40: 626c 6520 3d20 4461 7461 5461 626c 6528  ble = DataTable(
+00020d50: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00020d60: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+00020d70: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+00020d80: 756d 6e73 3d5b 6578 7472 615f 636f 6c75  umns=[extra_colu
+00020d90: 6d6e 735b 6e5d 2066 6f72 206e 2069 6e20  mns[n] for n in 
+00020da0: 6578 7472 615f 6e61 6d65 735d 2c0a 2020  extra_names],.  
+00020db0: 2020 2020 2020 2020 2020 7265 6f72 6465            reorde
+00020dc0: 7261 626c 653d 5472 7565 2c0a 2020 2020  rable=True,.    
+00020dd0: 2020 2020 2020 2020 736f 7274 6162 6c65          sortable
+00020de0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00020df0: 2020 2077 6964 7468 3d77 6964 7468 2c0a     width=width,.
+00020e00: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00020e10: 785f 706f 7369 7469 6f6e 3d4e 6f6e 652c  x_position=None,
+00020e20: 0a20 2020 2020 2020 2020 2020 202a 2a5f  .            **_
+00020e30: 4441 5441 5441 424c 455f 5354 594c 4553  DATATABLE_STYLES
+00020e40: 4845 4554 535f 4b57 4152 4753 2c0a 2020  HEETS_KWARGS,.  
+00020e50: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00020e60: 2066 6f72 206e 616d 6520 696e 2065 7874   for name in ext
+00020e70: 7261 5f6e 616d 6573 3a0a 2020 2020 2020  ra_names:.      
+00020e80: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
+00020e90: 2066 6f72 6d61 7474 6572 733a 0a20 2020   formatters:.   
+00020ea0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+00020eb0: 7261 5f74 6162 6c65 2e63 6f6c 756d 6e73  ra_table.columns
+00020ec0: 5b65 7874 7261 5f6e 616d 6573 2e69 6e64  [extra_names.ind
+00020ed0: 6578 286e 616d 6529 5d2e 666f 726d 6174  ex(name)].format
+00020ee0: 7465 7220 3d20 666f 726d 6174 7465 7273  ter = formatters
+00020ef0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00020f00: 2020 2020 2020 6e61 6d65 0a20 2020 2020        name.     
+00020f10: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
+00020f20: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
+00020f30: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
+00020f40: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
+00020f50: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
+00020f60: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00020f70: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
+00020f80: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+00020f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020fa0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+00020fb0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+00020fc0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+00020fd0: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+00020fe0: 223e 576f 726b 6572 2028 406e 616d 6529  ">Worker (@name)
+00020ff0: 3a20 3c2f 7370 616e 3e0a 2020 2020 2020  : </span>.      
+00021000: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00021010: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00021020: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+00021030: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+00021040: 6f6e 6f73 7061 6365 3b22 3e40 6d65 6d6f  onospace;">@memo
+00021050: 7279 5f70 6572 6365 6e74 7b30 2e30 2025  ry_percent{0.0 %
+00021060: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
+00021070: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+00021080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021090: 2222 222c 0a20 2020 2020 2020 2029 0a0a  """,.        )..
+000210a0: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
+000210b0: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+000210c0: 2020 2020 2020 2074 6974 6c65 3d22 4d65         title="Me
+000210d0: 6d6f 7279 2055 7365 2028 2529 222c 0a20  mory Use (%)",. 
+000210e0: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
+000210f0: 6172 5f6c 6f63 6174 696f 6e3d 4e6f 6e65  ar_location=None
+00021100: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+00021110: 7261 6e67 653d 2830 2c20 3129 2c0a 2020  range=(0, 1),.  
+00021120: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
+00021130: 653d 282d 302e 312c 2030 2e31 292c 0a20  e=(-0.1, 0.1),. 
+00021140: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00021150: 743d 3630 2c0a 2020 2020 2020 2020 2020  t=60,.          
+00021160: 2020 7769 6474 683d 7769 6474 682c 0a20    width=width,. 
+00021170: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+00021180: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+00021190: 206d 696e 5f62 6f72 6465 725f 7269 6768   min_border_righ
+000211a0: 743d 302c 0a20 2020 2020 2020 2020 2020  t=0,.           
+000211b0: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+000211c0: 2020 2029 0a20 2020 2020 2020 206d 656d     ).        mem
+000211d0: 5f70 6c6f 742e 6369 7263 6c65 280a 2020  _plot.circle(.  
+000211e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+000211f0: 3d73 656c 662e 736f 7572 6365 2c20 783d  =self.source, x=
+00021200: 226d 656d 6f72 795f 7065 7263 656e 7422  "memory_percent"
+00021210: 2c20 793d 302c 2073 697a 653d 3130 2c20  , y=0, size=10, 
+00021220: 6669 6c6c 5f61 6c70 6861 3d30 2e35 0a20  fill_alpha=0.5. 
+00021230: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00021240: 206d 656d 5f70 6c6f 742e 7967 7269 642e   mem_plot.ygrid.
+00021250: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
+00021260: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
+00021270: 2e79 6178 6973 2e6d 696e 6f72 5f74 6963  .yaxis.minor_tic
+00021280: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
+00021290: 0a20 2020 2020 2020 206d 656d 5f70 6c6f  .        mem_plo
+000212a0: 742e 7861 7869 732e 7669 7369 626c 6520  t.xaxis.visible 
+000212b0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000212c0: 6d65 6d5f 706c 6f74 2e79 6178 6973 2e76  mem_plot.yaxis.v
+000212d0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+000212e0: 2020 2020 2020 206d 656d 5f70 6c6f 742e         mem_plot.
+000212f0: 6164 645f 746f 6f6c 7328 686f 7665 722c  add_tools(hover,
+00021300: 2042 6f78 5365 6c65 6374 546f 6f6c 2829   BoxSelectTool()
+00021310: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
+00021320: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+00021330: 2020 2020 2020 2020 2020 706f 696e 745f            point_
+00021340: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
+00021350: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
+00021360: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
+00021370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021380: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+00021390: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+000213a0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+000213b0: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
+000213c0: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
+000213d0: 7061 6365 3b22 3e57 6f72 6b65 7220 2840  pace;">Worker (@
+000213e0: 6e61 6d65 293a 203c 2f73 7061 6e3e 0a20  name): </span>. 
+000213f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021400: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00021410: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+00021420: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+00021430: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00021440: 4063 7075 5f66 7261 6374 696f 6e7b 3020  @cpu_fraction{0 
+00021450: 257d 3c2f 7370 616e 3e0a 2020 2020 2020  %}</span>.      
+00021460: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+00021470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021480: 2022 2222 2c0a 2020 2020 2020 2020 290a   """,.        ).
+00021490: 0a20 2020 2020 2020 2063 7075 5f70 6c6f  .        cpu_plo
+000214a0: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+000214b0: 2020 2020 2020 2020 7469 746c 653d 2243          title="C
+000214c0: 5055 2055 7365 2028 2529 222c 0a20 2020  PU Use (%)",.   
+000214d0: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
+000214e0: 5f6c 6f63 6174 696f 6e3d 4e6f 6e65 2c0a  _location=None,.
+000214f0: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
+00021500: 6e67 653d 2830 2c20 3129 2c0a 2020 2020  nge=(0, 1),.    
+00021510: 2020 2020 2020 2020 795f 7261 6e67 653d          y_range=
+00021520: 282d 302e 312c 2030 2e31 292c 0a20 2020  (-0.1, 0.1),.   
+00021530: 2020 2020 2020 2020 2068 6569 6768 743d           height=
+00021540: 3630 2c0a 2020 2020 2020 2020 2020 2020  60,.            
+00021550: 7769 6474 683d 7769 6474 682c 0a20 2020  width=width,.   
+00021560: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
+00021570: 222c 0a20 2020 2020 2020 2020 2020 206d  ",.            m
+00021580: 696e 5f62 6f72 6465 725f 7269 6768 743d  in_border_right=
+00021590: 302c 0a20 2020 2020 2020 2020 2020 202a  0,.            *
+000215a0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+000215b0: 2029 0a20 2020 2020 2020 2063 7075 5f70   ).        cpu_p
+000215c0: 6c6f 742e 6369 7263 6c65 280a 2020 2020  lot.circle(.    
+000215d0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+000215e0: 656c 662e 736f 7572 6365 2c20 783d 2263  elf.source, x="c
+000215f0: 7075 5f66 7261 6374 696f 6e22 2c20 793d  pu_fraction", y=
+00021600: 302c 2073 697a 653d 3130 2c20 6669 6c6c  0, size=10, fill
+00021610: 5f61 6c70 6861 3d30 2e35 0a20 2020 2020  _alpha=0.5.     
+00021620: 2020 2029 0a20 2020 2020 2020 2063 7075     ).        cpu
+00021630: 5f70 6c6f 742e 7967 7269 642e 7669 7369  _plot.ygrid.visi
+00021640: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+00021650: 2020 2020 6370 755f 706c 6f74 2e79 6178      cpu_plot.yax
+00021660: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+00021670: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+00021680: 2020 2020 2063 7075 5f70 6c6f 742e 7861       cpu_plot.xa
+00021690: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
+000216a0: 6c73 650a 2020 2020 2020 2020 6370 755f  lse.        cpu_
+000216b0: 706c 6f74 2e79 6178 6973 2e76 6973 6962  plot.yaxis.visib
+000216c0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
+000216d0: 2020 2063 7075 5f70 6c6f 742e 6164 645f     cpu_plot.add_
+000216e0: 746f 6f6c 7328 686f 7665 722c 2042 6f78  tools(hover, Box
+000216f0: 5365 6c65 6374 546f 6f6c 2829 290a 2020  SelectTool()).  
+00021700: 2020 2020 2020 7365 6c66 2e63 7075 5f70        self.cpu_p
+00021710: 6c6f 7420 3d20 6370 755f 706c 6f74 0a0a  lot = cpu_plot..
+00021720: 2020 2020 2020 2020 6966 2022 7369 7a69          if "sizi
+00021730: 6e67 5f6d 6f64 6522 2069 6e20 6b77 6172  ng_mode" in kwar
+00021740: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00021750: 7369 7a69 6e67 5f6d 6f64 6520 3d20 7b22  sizing_mode = {"
+00021760: 7369 7a69 6e67 5f6d 6f64 6522 3a20 6b77  sizing_mode": kw
+00021770: 6172 6773 5b22 7369 7a69 6e67 5f6d 6f64  args["sizing_mod
+00021780: 6522 5d7d 0a20 2020 2020 2020 2065 6c73  e"]}.        els
+00021790: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000217a0: 697a 696e 675f 6d6f 6465 203d 207b 7d0a  izing_mode = {}.
+000217b0: 0a20 2020 2020 2020 2063 6f6d 706f 6e65  .        compone
+000217c0: 6e74 7320 3d20 5b63 7075 5f70 6c6f 742c  nts = [cpu_plot,
+000217d0: 206d 656d 5f70 6c6f 742c 2074 6162 6c65   mem_plot, table
+000217e0: 5d0a 2020 2020 2020 2020 6966 2073 656c  ].        if sel
+000217f0: 662e 6578 7472 615f 6e61 6d65 733a 0a20  f.extra_names:. 
+00021800: 2020 2020 2020 2020 2020 2063 6f6d 706f             compo
+00021810: 6e65 6e74 732e 6170 7065 6e64 2865 7874  nents.append(ext
+00021820: 7261 5f74 6162 6c65 290a 0a20 2020 2020  ra_table)..     
+00021830: 2020 2073 656c 662e 726f 6f74 203d 2063     self.root = c
+00021840: 6f6c 756d 6e28 2a63 6f6d 706f 6e65 6e74  olumn(*component
+00021850: 732c 202a 2a73 697a 696e 675f 6d6f 6465  s, **sizing_mode
+00021860: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+00021870: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+00021880: 696f 6e0a 2020 2020 6465 6620 7570 6461  ion.    def upda
+00021890: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+000218a0: 2020 6461 7461 203d 207b 6e61 6d65 3a20    data = {name: 
+000218b0: 5b5d 2066 6f72 206e 616d 6520 696e 2073  [] for name in s
+000218c0: 656c 662e 6e61 6d65 7320 2b20 7365 6c66  elf.names + self
+000218d0: 2e65 7874 7261 5f6e 616d 6573 7d0a 2020  .extra_names}.  
+000218e0: 2020 2020 2020 666f 7220 692c 2077 7320        for i, ws 
+000218f0: 696e 2065 6e75 6d65 7261 7465 280a 2020  in enumerate(.  
+00021900: 2020 2020 2020 2020 2020 736f 7274 6564            sorted
+00021910: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
+00021920: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00021930: 2c20 6b65 793d 6c61 6d62 6461 2077 733a  , key=lambda ws:
+00021940: 2073 7472 2877 732e 6e61 6d65 2929 0a20   str(ws.name)). 
+00021950: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00021960: 2020 2020 2020 6d69 6e66 6f20 3d20 7773        minfo = ws
+00021970: 2e6d 656d 6f72 790a 0a20 2020 2020 2020  .memory..       
+00021980: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
+00021990: 2073 656c 662e 6e61 6d65 7320 2b20 7365   self.names + se
+000219a0: 6c66 2e65 7874 7261 5f6e 616d 6573 3a0a  lf.extra_names:.
+000219b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219c0: 6966 2022 2e22 2069 6e20 6e61 6d65 3a0a  if "." in name:.
+000219d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219e0: 2020 2020 6e30 2c20 5f2c 206e 3120 3d20      n0, _, n1 = 
+000219f0: 6e61 6d65 2e70 6172 7469 7469 6f6e 2822  name.partition("
+00021a00: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00021a10: 2020 2020 2020 2020 7620 3d20 7773 2e6d          v = ws.m
+00021a20: 6574 7269 6373 2e67 6574 286e 302c 207b  etrics.get(n0, {
+00021a30: 7d29 2e67 6574 286e 312c 204e 6f6e 6529  }).get(n1, None)
+00021a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021a50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00021a60: 2020 2020 2020 2020 2020 2076 203d 2077             v = w
+00021a70: 732e 6d65 7472 6963 732e 6765 7428 6e61  s.metrics.get(na
+00021a80: 6d65 2c20 4e6f 6e65 290a 2020 2020 2020  me, None).      
+00021a90: 2020 2020 2020 2020 2020 6461 7461 5b6e            data[n
+00021aa0: 616d 655d 2e61 7070 656e 6428 7629 0a0a  ame].append(v)..
+00021ab0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00021ac0: 5b22 6e61 6d65 225d 5b2d 315d 203d 2077  ["name"][-1] = w
+00021ad0: 732e 6e61 6d65 2069 6620 7773 2e6e 616d  s.name if ws.nam
+00021ae0: 6520 6973 206e 6f74 204e 6f6e 6520 656c  e is not None el
+00021af0: 7365 2069 0a20 2020 2020 2020 2020 2020  se i.           
+00021b00: 2064 6174 615b 2261 6464 7265 7373 225d   data["address"]
+00021b10: 5b2d 315d 203d 2077 732e 6164 6472 6573  [-1] = ws.addres
+00021b20: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+00021b30: 2077 732e 6d65 6d6f 7279 5f6c 696d 6974   ws.memory_limit
+00021b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021b50: 2020 6461 7461 5b22 6d65 6d6f 7279 5f70    data["memory_p
+00021b60: 6572 6365 6e74 225d 5b2d 315d 203d 2077  ercent"][-1] = w
+00021b70: 732e 6d65 7472 6963 735b 226d 656d 6f72  s.metrics["memor
+00021b80: 7922 5d20 2f20 7773 2e6d 656d 6f72 795f  y"] / ws.memory_
+00021b90: 6c69 6d69 740a 2020 2020 2020 2020 2020  limit.          
+00021ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00021bb0: 2020 2020 2020 2020 6461 7461 5b22 6d65          data["me
+00021bc0: 6d6f 7279 5f70 6572 6365 6e74 225d 5b2d  mory_percent"][-
+00021bd0: 315d 203d 2022 220a 2020 2020 2020 2020  1] = "".        
+00021be0: 2020 2020 6461 7461 5b22 6d65 6d6f 7279      data["memory
+00021bf0: 5f6c 696d 6974 225d 5b2d 315d 203d 2077  _limit"][-1] = w
+00021c00: 732e 6d65 6d6f 7279 5f6c 696d 6974 0a20  s.memory_limit. 
+00021c10: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00021c20: 226d 656d 6f72 795f 6d61 6e61 6765 6422  "memory_managed"
+00021c30: 5d5b 2d31 5d20 3d20 6d69 6e66 6f2e 6d61  ][-1] = minfo.ma
+00021c40: 6e61 6765 640a 2020 2020 2020 2020 2020  naged.          
+00021c50: 2020 6461 7461 5b22 6d65 6d6f 7279 5f75    data["memory_u
+00021c60: 6e6d 616e 6167 6564 5f6f 6c64 225d 5b2d  nmanaged_old"][-
+00021c70: 315d 203d 206d 696e 666f 2e75 6e6d 616e  1] = minfo.unman
+00021c80: 6167 6564 5f6f 6c64 0a20 2020 2020 2020  aged_old.       
+00021c90: 2020 2020 2064 6174 615b 226d 656d 6f72       data["memor
+00021ca0: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
+00021cb0: 6e74 225d 5b2d 315d 203d 206d 696e 666f  nt"][-1] = minfo
+00021cc0: 2e75 6e6d 616e 6167 6564 5f72 6563 656e  .unmanaged_recen
+00021cd0: 740a 2020 2020 2020 2020 2020 2020 6461  t.            da
+00021ce0: 7461 5b22 6d65 6d6f 7279 5f75 6e6d 616e  ta["memory_unman
+00021cf0: 6167 6564 5f72 6563 656e 7422 5d5b 2d31  aged_recent"][-1
+00021d00: 5d20 3d20 6d69 6e66 6f2e 756e 6d61 6e61  ] = minfo.unmana
+00021d10: 6765 645f 7265 6365 6e74 0a20 2020 2020  ged_recent.     
+00021d20: 2020 2020 2020 2064 6174 615b 226d 656d         data["mem
+00021d30: 6f72 795f 7370 696c 6c65 6422 5d5b 2d31  ory_spilled"][-1
+00021d40: 5d20 3d20 6d69 6e66 6f2e 7370 696c 6c65  ] = minfo.spille
+00021d50: 640a 2020 2020 2020 2020 2020 2020 6461  d.            da
+00021d60: 7461 5b22 6370 7522 5d5b 2d31 5d20 3d20  ta["cpu"][-1] = 
+00021d70: 7773 2e6d 6574 7269 6373 5b22 6370 7522  ws.metrics["cpu"
+00021d80: 5d20 2f20 3130 302e 300a 2020 2020 2020  ] / 100.0.      
+00021d90: 2020 2020 2020 6461 7461 5b22 6370 755f        data["cpu_
+00021da0: 6672 6163 7469 6f6e 225d 5b2d 315d 203d  fraction"][-1] =
+00021db0: 2077 732e 6d65 7472 6963 735b 2263 7075   ws.metrics["cpu
+00021dc0: 225d 202f 2031 3030 2e30 202f 2077 732e  "] / 100.0 / ws.
+00021dd0: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
+00021de0: 2020 2020 2064 6174 615b 226e 7468 7265       data["nthre
+00021df0: 6164 7322 5d5b 2d31 5d20 3d20 7773 2e6e  ads"][-1] = ws.n
+00021e00: 7468 7265 6164 730a 0a20 2020 2020 2020  threads..       
+00021e10: 2066 6f72 206e 616d 6520 696e 2073 656c   for name in sel
+00021e20: 662e 6e61 6d65 7320 2b20 7365 6c66 2e65  f.names + self.e
+00021e30: 7874 7261 5f6e 616d 6573 3a0a 2020 2020  xtra_names:.    
+00021e40: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+00021e50: 3d3d 2022 6e61 6d65 223a 0a20 2020 2020  == "name":.     
+00021e60: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00021e70: 6e61 6d65 5d2e 696e 7365 7274 2830 2c20  name].insert(0, 
+00021e80: 6622 546f 7461 6c20 287b 6c65 6e28 6461  f"Total ({len(da
+00021e90: 7461 5b6e 616d 655d 297d 2922 290a 2020  ta[name])})").  
+00021ea0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00021eb0: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00021ec0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00021ed0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+00021ee0: 656c 662e 7363 6865 6475 6c65 722e 776f  elf.scheduler.wo
+00021ef0: 726b 6572 7329 203d 3d20 303a 0a20 2020  rkers) == 0:.   
+00021f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f10: 2074 6f74 616c 5f64 6174 6120 3d20 4e6f   total_data = No
+00021f20: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00021f30: 2020 2065 6c69 6620 6e61 6d65 203d 3d20     elif name == 
+00021f40: 226d 656d 6f72 795f 7065 7263 656e 7422  "memory_percent"
+00021f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021f60: 2020 2020 2020 746f 7461 6c5f 6d65 6d20        total_mem 
+00021f70: 3d20 7375 6d28 0a20 2020 2020 2020 2020  = sum(.         
+00021f80: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00021f90: 732e 6d65 6d6f 7279 5f6c 696d 6974 2066  s.memory_limit f
+00021fa0: 6f72 2077 7320 696e 2073 656c 662e 7363  or ws in self.sc
+00021fb0: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
+00021fc0: 7661 6c75 6573 2829 0a20 2020 2020 2020  values().       
+00021fd0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ff0: 2020 2074 6f74 616c 5f64 6174 6120 3d20     total_data = 
+00022000: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00022010: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
+00022020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022030: 2020 2020 2020 2020 7375 6d28 0a20 2020          sum(.   
+00022040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022050: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
+00022060: 6d65 7472 6963 735b 226d 656d 6f72 7922  metrics["memory"
+00022070: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00022080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022090: 2020 666f 7220 7773 2069 6e20 7365 6c66    for ws in self
+000220a0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+000220b0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
+000220c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000220e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220f0: 2020 2020 2020 2f20 746f 7461 6c5f 6d65        / total_me
+00022100: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+00022110: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00022120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022130: 2020 2020 6966 2074 6f74 616c 5f6d 656d      if total_mem
+00022140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022150: 2020 2020 2020 2020 2065 6c73 6520 2222           else ""
+00022160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022170: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00022180: 2020 2020 2020 2065 6c69 6620 6e61 6d65         elif name
+00022190: 203d 3d20 2263 7075 223a 0a20 2020 2020   == "cpu":.     
+000221a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000221b0: 6f74 616c 5f64 6174 6120 3d20 280a 2020  otal_data = (.  
+000221c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000221d0: 2020 2020 2020 7375 6d28 7773 2e6d 6574        sum(ws.met
+000221e0: 7269 6373 5b22 6370 7522 5d20 666f 7220  rics["cpu"] for 
+000221f0: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
+00022200: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+00022210: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
+00022220: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00022230: 2031 3030 0a20 2020 2020 2020 2020 2020   100.           
+00022240: 2020 2020 2020 2020 2020 2020 202f 206c               / l
+00022250: 656e 2873 656c 662e 7363 6865 6475 6c65  en(self.schedule
+00022260: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
+00022270: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00022280: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00022290: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+000222a0: 616d 6520 3d3d 2022 6370 755f 6672 6163  ame == "cpu_frac
+000222b0: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
+000222c0: 2020 2020 2020 2020 2020 2074 6f74 616c             total
+000222d0: 5f64 6174 6120 3d20 280a 2020 2020 2020  _data = (.      
+000222e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222f0: 2020 7375 6d28 7773 2e6d 6574 7269 6373    sum(ws.metrics
+00022300: 5b22 6370 7522 5d20 666f 7220 7773 2069  ["cpu"] for ws i
+00022310: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
+00022320: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00022330: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00022340: 2020 2020 2020 2020 2020 202f 2031 3030             / 100
+00022350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022360: 2020 2020 2020 2020 202f 2073 756d 2877           / sum(w
+00022370: 732e 6e74 6872 6561 6473 2066 6f72 2077  s.nthreads for w
+00022380: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
+00022390: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+000223a0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+000223b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000223c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000223d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000223e0: 2020 2020 2020 746f 7461 6c5f 6461 7461        total_data
+000223f0: 203d 2073 756d 2864 6174 615b 6e61 6d65   = sum(data[name
+00022400: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00022410: 2020 2020 6461 7461 5b6e 616d 655d 2e69      data[name].i
+00022420: 6e73 6572 7428 302c 2074 6f74 616c 5f64  nsert(0, total_d
+00022430: 6174 6129 0a20 2020 2020 2020 2020 2020  ata).           
+00022440: 2065 7863 6570 7420 5479 7065 4572 726f   except TypeErro
+00022450: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00022460: 2020 2064 6174 615b 6e61 6d65 5d2e 696e     data[name].in
+00022470: 7365 7274 2830 2c20 4e6f 6e65 290a 0a20  sert(0, None).. 
+00022480: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
+00022490: 6365 2e64 6174 612e 7570 6461 7465 2864  ce.data.update(d
+000224a0: 6174 6129 0a0a 0a63 6c61 7373 2053 6875  ata)...class Shu
+000224b0: 6666 6c69 6e67 2844 6173 6862 6f61 7264  ffling(Dashboard
+000224c0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
+000224d0: 2222 224f 6363 7570 616e 6379 2028 696e  """Occupancy (in
+000224e0: 2074 696d 6529 2070 6572 2077 6f72 6b65   time) per worke
+000224f0: 7222 2222 0a0a 2020 2020 6465 6620 5f5f  r"""..    def __
+00022500: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+00022510: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
+00022520: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
+00022530: 6c6f 675f 6572 726f 7273 2829 3a0a 2020  log_errors():.  
+00022540: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00022550: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+00022560: 756c 6572 0a20 2020 2020 2020 2020 2020  uler.           
+00022570: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
+00022580: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
+00022590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000225a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000225b0: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
+000225c0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000225d0: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
+000225e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000225f0: 2020 2020 2020 2263 6f6d 6d5f 6d65 6d6f        "comm_memo
+00022600: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
+00022610: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+00022620: 6d6d 5f6d 656d 6f72 795f 6c69 6d69 7422  mm_memory_limit"
+00022630: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00022640: 2020 2020 2020 2020 2020 2263 6f6d 6d5f            "comm_
+00022650: 6275 636b 6574 7322 3a20 5b5d 2c0a 2020  buckets": [],.  
+00022660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022670: 2020 2263 6f6d 6d5f 6176 675f 6475 7261    "comm_avg_dura
+00022680: 7469 6f6e 223a 205b 5d2c 0a20 2020 2020  tion": [],.     
+00022690: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000226a0: 636f 6d6d 5f61 7667 5f73 697a 6522 3a20  comm_avg_size": 
+000226b0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+000226c0: 2020 2020 2020 2020 2263 6f6d 6d5f 7265          "comm_re
+000226d0: 6164 223a 205b 5d2c 0a20 2020 2020 2020  ad": [],.       
+000226e0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+000226f0: 6d6d 5f77 7269 7474 656e 223a 205b 5d2c  mm_written": [],
+00022700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022710: 2020 2020 2022 636f 6d6d 5f63 6f6c 6f72       "comm_color
+00022720: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00022730: 2020 2020 2020 2020 2020 2022 6469 736b             "disk
+00022740: 5f6d 656d 6f72 7922 3a20 5b5d 2c0a 2020  _memory": [],.  
+00022750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022760: 2020 2264 6973 6b5f 6d65 6d6f 7279 5f6c    "disk_memory_l
+00022770: 696d 6974 223a 205b 5d2c 0a20 2020 2020  imit": [],.     
+00022780: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00022790: 6469 736b 5f62 7563 6b65 7473 223a 205b  disk_buckets": [
+000227a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000227b0: 2020 2020 2020 2022 6469 736b 5f61 7667         "disk_avg
+000227c0: 5f64 7572 6174 696f 6e22 3a20 5b5d 2c0a  _duration": [],.
+000227d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227e0: 2020 2020 2264 6973 6b5f 6176 675f 7369      "disk_avg_si
+000227f0: 7a65 223a 205b 5d2c 0a20 2020 2020 2020  ze": [],.       
+00022800: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+00022810: 736b 5f72 6561 6422 3a20 5b5d 2c0a 2020  sk_read": [],.  
+00022820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022830: 2020 2264 6973 6b5f 7772 6974 7465 6e22    "disk_written"
+00022840: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00022850: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
+00022860: 636f 6c6f 7222 3a20 5b5d 2c0a 2020 2020  color": [],.    
+00022870: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00022880: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00022890: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+000228a0: 616c 735f 736f 7572 6365 203d 2043 6f6c  als_source = Col
+000228b0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
+000228c0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+000228d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000228e0: 2020 2020 2022 7822 3a20 5b22 4e65 7477       "x": ["Netw
+000228f0: 6f72 6b20 5365 6e64 222c 2022 4e65 7477  ork Send", "Netw
+00022900: 6f72 6b20 5265 6365 6976 6522 2c20 2244  ork Receive", "D
+00022910: 6973 6b20 5772 6974 6522 2c20 2244 6973  isk Write", "Dis
+00022920: 6b20 5265 6164 225d 2c0a 2020 2020 2020  k Read"],.      
+00022930: 2020 2020 2020 2020 2020 2020 2020 2276                "v
+00022940: 616c 7565 7322 3a20 5b30 2c20 302c 2030  alues": [0, 0, 0
+00022950: 2c20 305d 2c0a 2020 2020 2020 2020 2020  , 0],.          
+00022960: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00022970: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00022980: 2020 2073 656c 662e 636f 6d6d 5f6d 656d     self.comm_mem
+00022990: 6f72 7920 3d20 6669 6775 7265 280a 2020  ory = figure(.  
+000229a0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+000229b0: 746c 653d 2243 6f6d 6d73 2042 7566 6665  tle="Comms Buffe
+000229c0: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
+000229d0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
+000229e0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000229f0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
+00022a00: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
+00022a10: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+00022a20: 5261 6e67 6531 6428 302c 2031 3030 5f30  Range1d(0, 100_0
+00022a30: 3030 5f30 3030 292c 0a20 2020 2020 2020  00_000),.       
+00022a40: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00022a50: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+00022a60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00022a70: 662e 636f 6d6d 5f6d 656d 6f72 792e 6862  f.comm_memory.hb
+00022a80: 6172 280a 2020 2020 2020 2020 2020 2020  ar(.            
+00022a90: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+00022aa0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+00022ab0: 2020 2020 2020 2020 7269 6768 743d 2263          right="c
+00022ac0: 6f6d 6d5f 6d65 6d6f 7279 222c 0a20 2020  omm_memory",.   
+00022ad0: 2020 2020 2020 2020 2020 2020 2079 3d22               y="
+00022ae0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+00022af0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
+00022b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b10: 636f 6c6f 723d 2263 6f6d 6d5f 636f 6c6f  color="comm_colo
+00022b20: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
+00022b30: 290a 2020 2020 2020 2020 2020 2020 686f  ).            ho
+00022b40: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
+00022b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b60: 2074 6f6f 6c74 6970 733d 5b0a 2020 2020   tooltips=[.    
+00022b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b80: 2822 4d65 6d6f 7279 2055 7365 6422 2c20  ("Memory Used", 
+00022b90: 2240 636f 6d6d 5f6d 656d 6f72 797b 302e  "@comm_memory{0.
+00022ba0: 3030 2062 7d22 292c 0a20 2020 2020 2020  00 b}"),.       
+00022bb0: 2020 2020 2020 2020 2020 2020 2028 2241               ("A
+00022bc0: 7665 7261 6765 2057 7269 7465 222c 2022  verage Write", "
+00022bd0: 4063 6f6d 6d5f 6176 675f 7369 7a65 7b30  @comm_avg_size{0
+00022be0: 2e30 3020 627d 2229 2c0a 2020 2020 2020  .00 b}"),.      
+00022bf0: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+00022c00: 2320 4275 636b 6574 7322 2c20 2240 636f  # Buckets", "@co
+00022c10: 6d6d 5f62 7563 6b65 7473 2229 2c0a 2020  mm_buckets"),.  
+00022c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c30: 2020 2822 4176 6572 6167 6520 4475 7261    ("Average Dura
+00022c40: 7469 6f6e 222c 2022 4063 6f6d 6d5f 6176  tion", "@comm_av
+00022c50: 675f 6475 7261 7469 6f6e 2229 2c0a 2020  g_duration"),.  
+00022c60: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+00022c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022c80: 2066 6f72 6d61 7474 6572 733d 7b22 4063   formatters={"@c
+00022c90: 6f6d 6d5f 6176 675f 6475 7261 7469 6f6e  omm_avg_duration
+00022ca0: 223a 2022 6461 7465 7469 6d65 227d 2c0a  ": "datetime"},.
+00022cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022cc0: 6d6f 6465 3d22 686c 696e 6522 2c0a 2020  mode="hline",.  
+00022cd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00022ce0: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+00022cf0: 6d5f 6d65 6d6f 7279 2e61 6464 5f74 6f6f  m_memory.add_too
+00022d00: 6c73 2868 6f76 6572 290a 2020 2020 2020  ls(hover).      
+00022d10: 2020 2020 2020 7365 6c66 2e63 6f6d 6d5f        self.comm_
+00022d20: 6d65 6d6f 7279 2e78 5f72 616e 6765 2e73  memory.x_range.s
+00022d30: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
+00022d40: 2020 2020 2073 656c 662e 636f 6d6d 5f6d       self.comm_m
+00022d50: 656d 6f72 792e 785f 7261 6e67 652e 656e  emory.x_range.en
+00022d60: 6420 3d20 310a 2020 2020 2020 2020 2020  d = 1.          
+00022d70: 2020 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f    self.comm_memo
+00022d80: 7279 2e78 6178 6973 5b30 5d2e 666f 726d  ry.xaxis[0].form
+00022d90: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
+00022da0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
+00022db0: 6d61 743d 2230 2e30 2062 2229 0a0a 2020  mat="0.0 b")..  
+00022dc0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00022dd0: 6973 6b5f 6d65 6d6f 7279 203d 2066 6967  isk_memory = fig
+00022de0: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+00022df0: 2020 2020 2074 6974 6c65 3d22 4469 736b       title="Disk
+00022e00: 2042 7566 6665 7222 2c0a 2020 2020 2020   Buffer",.      
+00022e10: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00022e20: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00022e30: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
+00022e40: 7469 6f6e 3d22 6162 6f76 6522 2c0a 2020  tion="above",.  
+00022e50: 2020 2020 2020 2020 2020 2020 2020 785f                x_
+00022e60: 7261 6e67 653d 5261 6e67 6531 6428 302c  range=Range1d(0,
+00022e70: 2031 3030 5f30 3030 5f30 3030 292c 0a20   100_000_000),. 
+00022e80: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00022e90: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00022ea0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00022eb0: 2020 2073 656c 662e 6469 736b 5f6d 656d     self.disk_mem
+00022ec0: 6f72 792e 7961 7869 732e 7669 7369 626c  ory.yaxis.visibl
+00022ed0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+00022ee0: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00022ef0: 5f6d 656d 6f72 792e 6862 6172 280a 2020  _memory.hbar(.  
+00022f00: 2020 2020 2020 2020 2020 2020 2020 736f                so
+00022f10: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+00022f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022f30: 2020 7269 6768 743d 2264 6973 6b5f 6d65    right="disk_me
+00022f40: 6d6f 7279 222c 0a20 2020 2020 2020 2020  mory",.         
+00022f50: 2020 2020 2020 2079 3d22 7922 2c0a 2020         y="y",.  
+00022f60: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00022f70: 6967 6874 3d30 2e39 2c0a 2020 2020 2020  ight=0.9,.      
+00022f80: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
+00022f90: 2264 6973 6b5f 636f 6c6f 7222 2c0a 2020  "disk_color",.  
+00022fa0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00022fb0: 2020 2020 2020 2020 2068 6f76 6572 203d           hover =
+00022fc0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
+00022fd0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00022fe0: 7469 7073 3d5b 0a20 2020 2020 2020 2020  tips=[.         
+00022ff0: 2020 2020 2020 2020 2020 2028 224d 656d             ("Mem
+00023000: 6f72 7920 5573 6564 222c 2022 4064 6973  ory Used", "@dis
+00023010: 6b5f 6d65 6d6f 7279 7b30 2e30 3020 627d  k_memory{0.00 b}
+00023020: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00023030: 2020 2020 2020 2020 2822 4176 6572 6167          ("Averag
+00023040: 6520 5772 6974 6522 2c20 2240 6469 736b  e Write", "@disk
+00023050: 5f61 7667 5f73 697a 657b 302e 3030 2062  _avg_size{0.00 b
+00023060: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
+00023070: 2020 2020 2020 2020 2028 2223 2042 7563           ("# Buc
+00023080: 6b65 7473 222c 2022 4064 6973 6b5f 6275  kets", "@disk_bu
+00023090: 636b 6574 7322 292c 0a20 2020 2020 2020  ckets"),.       
+000230a0: 2020 2020 2020 2020 2020 2020 2028 2241               ("A
+000230b0: 7665 7261 6765 2044 7572 6174 696f 6e22  verage Duration"
+000230c0: 2c20 2240 6469 736b 5f61 7667 5f64 7572  , "@disk_avg_dur
+000230d0: 6174 696f 6e22 292c 0a20 2020 2020 2020  ation"),.       
+000230e0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000230f0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00023100: 6174 7465 7273 3d7b 2240 6469 736b 5f61  atters={"@disk_a
+00023110: 7667 5f64 7572 6174 696f 6e22 3a20 2264  vg_duration": "d
+00023120: 6174 6574 696d 6522 7d2c 0a20 2020 2020  atetime"},.     
+00023130: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+00023140: 2268 6c69 6e65 222c 0a20 2020 2020 2020  "hline",.       
+00023150: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00023160: 2020 2073 656c 662e 6469 736b 5f6d 656d     self.disk_mem
+00023170: 6f72 792e 6164 645f 746f 6f6c 7328 686f  ory.add_tools(ho
+00023180: 7665 7229 0a20 2020 2020 2020 2020 2020  ver).           
+00023190: 2073 656c 662e 6469 736b 5f6d 656d 6f72   self.disk_memor
+000231a0: 792e 7861 7869 735b 305d 2e66 6f72 6d61  y.xaxis[0].forma
+000231b0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
+000231c0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
+000231d0: 6174 3d22 302e 3020 6222 290a 0a20 2020  at="0.0 b")..   
+000231e0: 2020 2020 2020 2020 2073 656c 662e 746f           self.to
+000231f0: 7461 6c73 203d 2066 6967 7572 6528 0a20  tals = figure(. 
+00023200: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00023210: 6974 6c65 3d22 546f 7461 6c20 6d6f 7665  itle="Total move
+00023220: 6d65 6e74 222c 0a20 2020 2020 2020 2020  ment",.         
+00023230: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
+00023240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023250: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
+00023260: 6e3d 2261 626f 7665 222c 0a20 2020 2020  n="above",.     
+00023270: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+00023280: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
+00023290: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
+000232a0: 6974 6c65 7320 3d20 5b22 4e65 7477 6f72  itles = ["Networ
+000232b0: 6b20 5365 6e64 222c 2022 4e65 7477 6f72  k Send", "Networ
+000232c0: 6b20 5265 6365 6976 6522 2c20 2244 6973  k Receive", "Dis
+000232d0: 6b20 5772 6974 6522 2c20 2244 6973 6b20  k Write", "Disk 
+000232e0: 5265 6164 225d 0a20 2020 2020 2020 2020  Read"].         
+000232f0: 2020 2073 656c 662e 746f 7461 6c73 203d     self.totals =
+00023300: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+00023310: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+00023320: 3d74 6974 6c65 732c 0a20 2020 2020 2020  =titles,.       
+00023330: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
+00023340: 546f 7461 6c73 222c 0a20 2020 2020 2020  Totals",.       
+00023350: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
+00023360: 5f6c 6f63 6174 696f 6e3d 4e6f 6e65 2c0a  _location=None,.
+00023370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023380: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+00023390: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+000233a0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+000233b0: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
+000233c0: 656c 662e 746f 7461 6c73 2e76 6261 7228  elf.totals.vbar(
+000233d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000233e0: 2078 3d22 7822 2c0a 2020 2020 2020 2020   x="x",.        
+000233f0: 2020 2020 2020 2020 746f 703d 2276 616c          top="val
+00023400: 7565 7322 2c0a 2020 2020 2020 2020 2020  ues",.          
+00023410: 2020 2020 2020 7769 6474 683d 302e 392c        width=0.9,
+00023420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023430: 2073 6f75 7263 653d 7365 6c66 2e74 6f74   source=self.tot
+00023440: 616c 735f 736f 7572 6365 2c0a 2020 2020  als_source,.    
+00023450: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00023460: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
+00023470: 6c73 2e78 6772 6964 2e67 7269 645f 6c69  ls.xgrid.grid_li
+00023480: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
+00023490: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000234a0: 2e74 6f74 616c 732e 795f 7261 6e67 652e  .totals.y_range.
+000234b0: 7374 6172 7420 3d20 300a 2020 2020 2020  start = 0.      
+000234c0: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
+000234d0: 732e 7961 7869 735b 305d 2e66 6f72 6d61  s.yaxis[0].forma
+000234e0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
+000234f0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
+00023500: 6174 3d22 302e 3020 6222 290a 0a20 2020  at="0.0 b")..   
+00023510: 2020 2020 2020 2020 2068 6f76 6572 203d           hover =
+00023520: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
+00023530: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00023540: 7469 7073 3d5b 2822 546f 7461 6c22 2c20  tips=[("Total", 
+00023550: 2240 7661 6c75 6573 7b30 2e30 3062 7d22  "@values{0.00b}"
+00023560: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
+00023570: 2020 2020 6d6f 6465 3d22 766c 696e 6522      mode="vline"
+00023580: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00023590: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000235a0: 2e74 6f74 616c 732e 6164 645f 746f 6f6c  .totals.add_tool
+000235b0: 7328 686f 7665 7229 0a0a 2020 2020 2020  s(hover)..      
+000235c0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+000235d0: 3d20 726f 7728 7365 6c66 2e63 6f6d 6d5f  = row(self.comm_
+000235e0: 6d65 6d6f 7279 2c20 7365 6c66 2e64 6973  memory, self.dis
+000235f0: 6b5f 6d65 6d6f 7279 290a 0a20 2020 2040  k_memory)..    @
+00023600: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+00023610: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
+00023620: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
+00023630: 3a0a 2020 2020 2020 2020 7769 7468 206c  :.        with l
+00023640: 6f67 5f65 7272 6f72 7328 293a 0a20 2020  og_errors():.   
+00023650: 2020 2020 2020 2020 2069 6e70 7574 203d           input =
+00023660: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00023670: 6578 7465 6e73 696f 6e73 5b22 7368 7566  extensions["shuf
+00023680: 666c 6522 5d2e 6865 6172 7462 6561 7473  fle"].heartbeats
+00023690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000236a0: 6e6f 7420 696e 7075 743a 0a20 2020 2020  not input:.     
+000236b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000236c0: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
+000236d0: 6e70 7574 203d 206c 6973 7428 696e 7075  nput = list(inpu
+000236e0: 742e 7661 6c75 6573 2829 295b 2d31 5d20  t.values())[-1] 
+000236f0: 2023 2054 4f44 4f3a 206d 756c 7469 706c   # TODO: multipl
+00023700: 6520 636f 6e63 7572 7265 6e74 2073 6875  e concurrent shu
+00023710: 6666 6c65 730a 0a20 2020 2020 2020 2020  ffles..         
+00023720: 2020 2064 6174 6120 3d20 6465 6661 756c     data = defaul
+00023730: 7464 6963 7428 6c69 7374 290a 2020 2020  tdict(list).    
+00023740: 2020 2020 2020 2020 6e6f 7720 3d20 7469          now = ti
+00023750: 6d65 2829 0a0a 2020 2020 2020 2020 2020  me()..          
+00023760: 2020 666f 7220 692c 2028 776f 726b 6572    for i, (worker
+00023770: 2c20 6429 2069 6e20 656e 756d 6572 6174  , d) in enumerat
+00023780: 6528 696e 7075 742e 6974 656d 7328 2929  e(input.items())
+00023790: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000237a0: 2020 6461 7461 5b22 7922 5d2e 6170 7065    data["y"].appe
+000237b0: 6e64 2869 290a 2020 2020 2020 2020 2020  nd(i).          
+000237c0: 2020 2020 2020 6461 7461 5b22 776f 726b        data["work
+000237d0: 6572 225d 2e61 7070 656e 6428 776f 726b  er"].append(work
+000237e0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+000237f0: 2020 2020 666f 7220 7072 6566 6978 2069      for prefix i
+00023800: 6e20 5b22 636f 6d6d 222c 2022 6469 736b  n ["comm", "disk
+00023810: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
+00023820: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
+00023830: 7072 6566 6978 7d5f 746f 7461 6c22 5d2e  prefix}_total"].
+00023840: 6170 7065 6e64 2864 5b70 7265 6669 785d  append(d[prefix]
+00023850: 5b22 746f 7461 6c22 5d29 0a20 2020 2020  ["total"]).     
+00023860: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00023870: 6174 615b 6622 7b70 7265 6669 787d 5f6d  ata[f"{prefix}_m
+00023880: 656d 6f72 7922 5d2e 6170 7065 6e64 2864  emory"].append(d
+00023890: 5b70 7265 6669 785d 5b22 6d65 6d6f 7279  [prefix]["memory
+000238a0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+000238b0: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
+000238c0: 7072 6566 6978 7d5f 6d65 6d6f 7279 5f6c  prefix}_memory_l
+000238d0: 696d 6974 225d 2e61 7070 656e 6428 645b  imit"].append(d[
+000238e0: 7072 6566 6978 5d5b 226d 656d 6f72 795f  prefix]["memory_
+000238f0: 6c69 6d69 7422 5d29 0a20 2020 2020 2020  limit"]).       
+00023900: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00023910: 615b 6622 7b70 7265 6669 787d 5f62 7563  a[f"{prefix}_buc
+00023920: 6b65 7473 225d 2e61 7070 656e 6428 645b  kets"].append(d[
+00023930: 7072 6566 6978 5d5b 2262 7563 6b65 7473  prefix]["buckets
+00023940: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+00023950: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
+00023960: 7072 6566 6978 7d5f 6176 675f 6475 7261  prefix}_avg_dura
+00023970: 7469 6f6e 225d 2e61 7070 656e 6428 0a20  tion"].append(. 
+00023980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023990: 2020 2020 2020 2064 5b70 7265 6669 785d         d[prefix]
+000239a0: 5b22 6469 6167 6e6f 7374 6963 7322 5d2e  ["diagnostics"].
+000239b0: 6765 7428 2261 7667 5f64 7572 6174 696f  get("avg_duratio
+000239c0: 6e22 2c20 3029 0a20 2020 2020 2020 2020  n", 0).         
+000239d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000239e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000239f0: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
+00023a00: 5f61 7667 5f73 697a 6522 5d2e 6170 7065  _avg_size"].appe
+00023a10: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+00023a20: 2020 2020 2020 2020 2020 2020 645b 7072              d[pr
+00023a30: 6566 6978 5d5b 2264 6961 676e 6f73 7469  efix]["diagnosti
+00023a40: 6373 225d 2e67 6574 2822 6176 675f 7369  cs"].get("avg_si
+00023a50: 7a65 222c 2030 290a 2020 2020 2020 2020  ze", 0).        
+00023a60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00023a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a80: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
+00023a90: 7d5f 7265 6164 225d 2e61 7070 656e 6428  }_read"].append(
+00023aa0: 645b 7072 6566 6978 5d5b 2272 6561 6422  d[prefix]["read"
+00023ab0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00023ac0: 2020 2020 2020 2064 6174 615b 6622 7b70         data[f"{p
+00023ad0: 7265 6669 787d 5f77 7269 7474 656e 225d  refix}_written"]
+00023ae0: 2e61 7070 656e 6428 645b 7072 6566 6978  .append(d[prefix
+00023af0: 5d5b 2277 7269 7474 656e 225d 290a 2020  ]["written"]).  
+00023b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023b10: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
+00023b20: 6c65 722e 776f 726b 6572 735b 776f 726b  ler.workers[work
+00023b30: 6572 5d2e 6c61 7374 5f73 6565 6e20 3c20  er].last_seen < 
+00023b40: 6e6f 7720 2d20 353a 0a20 2020 2020 2020  now - 5:.       
+00023b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023b60: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
+00023b70: 5f63 6f6c 6f72 225d 2e61 7070 656e 6428  _color"].append(
+00023b80: 2267 7261 7922 290a 2020 2020 2020 2020  "gray").        
+00023b90: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00023ba0: 2064 5b70 7265 6669 785d 5b22 6d65 6d6f   d[prefix]["memo
+00023bb0: 7279 225d 203e 2064 5b70 7265 6669 785d  ry"] > d[prefix]
+00023bc0: 5b22 6d65 6d6f 7279 5f6c 696d 6974 225d  ["memory_limit"]
+00023bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023be0: 2020 2020 2020 2020 2020 6461 7461 5b66            data[f
+00023bf0: 227b 7072 6566 6978 7d5f 636f 6c6f 7222  "{prefix}_color"
+00023c00: 5d2e 6170 7065 6e64 2822 7265 6422 290a  ].append("red").
+00023c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00023c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c40: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
+00023c50: 7d5f 636f 6c6f 7222 5d2e 6170 7065 6e64  }_color"].append
+00023c60: 2822 626c 7565 2229 0a0a 2020 2020 2020  ("blue")..      
+00023c70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00023c80: 2020 2020 2020 7369 6e67 6c65 746f 6e73        singletons
+00023c90: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00023ca0: 2020 2020 2066 227b 7072 6566 6978 7d5f       f"{prefix}_
+00023cb0: 6176 675f 6475 7261 7469 6f6e 223a 205b  avg_duration": [
+00023cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023cd0: 2020 2020 2073 756d 2864 6174 615b 6622       sum(data[f"
+00023ce0: 7b70 7265 6669 787d 5f61 7667 5f64 7572  {prefix}_avg_dur
+00023cf0: 6174 696f 6e22 5d29 202f 206c 656e 2864  ation"]) / len(d
+00023d00: 6174 615b 6622 7b70 7265 6669 787d 5f61  ata[f"{prefix}_a
+00023d10: 7667 5f64 7572 6174 696f 6e22 5d29 0a20  vg_duration"]). 
+00023d20: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+00023d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023d40: 2020 6622 7b70 7265 6669 787d 5f61 7667    f"{prefix}_avg
+00023d50: 5f73 697a 6522 3a20 5b0a 2020 2020 2020  _size": [.      
+00023d60: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00023d70: 6d28 6461 7461 5b66 227b 7072 6566 6978  m(data[f"{prefix
+00023d80: 7d5f 6176 675f 7369 7a65 225d 2920 2f20  }_avg_size"]) / 
+00023d90: 6c65 6e28 6461 7461 5b66 227b 7072 6566  len(data[f"{pref
+00023da0: 6978 7d5f 6176 675f 7369 7a65 225d 290a  ix}_avg_size"]).
+00023db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023dc0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023dd0: 2020 2022 6469 736b 5f61 7667 5f64 7572     "disk_avg_dur
+00023de0: 6174 696f 6e22 3a20 5b0a 2020 2020 2020  ation": [.      
+00023df0: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00023e00: 6d28 6461 7461 5b22 6469 736b 5f61 7667  m(data["disk_avg
+00023e10: 5f64 7572 6174 696f 6e22 5d29 202f 206c  _duration"]) / l
+00023e20: 656e 2864 6174 615b 2264 6973 6b5f 6176  en(data["disk_av
+00023e30: 675f 6475 7261 7469 6f6e 225d 290a 2020  g_duration"]).  
+00023e40: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+00023e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023e60: 2022 6469 736b 5f61 7667 5f73 697a 6522   "disk_avg_size"
+00023e70: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
+00023e80: 2020 2020 2020 2020 7375 6d28 6461 7461          sum(data
+00023e90: 5b22 6469 736b 5f61 7667 5f73 697a 6522  ["disk_avg_size"
+00023ea0: 5d29 202f 206c 656e 2864 6174 615b 2264  ]) / len(data["d
+00023eb0: 6973 6b5f 6176 675f 7369 7a65 225d 290a  isk_avg_size"]).
+00023ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ed0: 5d2c 0a20 2020 2020 2020 2020 2020 207d  ],.            }
+00023ee0: 0a20 2020 2020 2020 2020 2020 2073 696e  .            sin
+00023ef0: 676c 6574 6f6e 735b 6622 7b70 7265 6669  gletons[f"{prefi
+00023f00: 787d 5f61 7667 5f62 616e 6477 6964 7468  x}_avg_bandwidth
+00023f10: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
+00023f20: 2020 2020 2020 2073 696e 676c 6574 6f6e         singleton
+00023f30: 735b 6622 7b70 7265 6669 787d 5f61 7667  s[f"{prefix}_avg
+00023f40: 5f73 697a 6522 5d5b 305d 202f 2073 696e  _size"][0] / sin
+00023f50: 676c 6574 6f6e 735b 6622 7b70 7265 6669  gletons[f"{prefi
+00023f60: 787d 5f61 7667 5f64 7572 6174 696f 6e22  x}_avg_duration"
+00023f70: 5d5b 305d 0a20 2020 2020 2020 2020 2020  ][0].           
+00023f80: 205d 0a20 2020 2020 2020 2020 2020 2073   ].            s
+00023f90: 696e 676c 6574 6f6e 735b 2264 6973 6b5f  ingletons["disk_
+00023fa0: 6176 675f 6261 6e64 7769 6474 6822 5d20  avg_bandwidth"] 
+00023fb0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00023fc0: 2020 2020 7369 6e67 6c65 746f 6e73 5b22      singletons["
+00023fd0: 6469 736b 5f61 7667 5f73 697a 6522 5d5b  disk_avg_size"][
+00023fe0: 305d 202f 2073 696e 676c 6574 6f6e 735b  0] / singletons[
+00023ff0: 2264 6973 6b5f 6176 675f 6475 7261 7469  "disk_avg_durati
+00024000: 6f6e 225d 5b30 5d0a 2020 2020 2020 2020  on"][0].        
+00024010: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00024020: 2020 7369 6e67 6c65 746f 6e73 5b22 7922    singletons["y"
+00024030: 5d20 3d20 5b64 6174 615b 2279 225d 5b2d  ] = [data["y"][-
+00024040: 315d 202f 2032 5d0a 2020 2020 2020 2020  1] / 2].        
+00024050: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+00024060: 2020 2020 2074 6f74 616c 7320 3d20 7b0a       totals = {.
+00024070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024080: 2278 223a 205b 224e 6574 776f 726b 2053  "x": ["Network S
+00024090: 656e 6422 2c20 224e 6574 776f 726b 2052  end", "Network R
+000240a0: 6563 6569 7665 222c 2022 4469 736b 2057  eceive", "Disk W
+000240b0: 7269 7465 222c 2022 4469 736b 2052 6561  rite", "Disk Rea
+000240c0: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
+000240d0: 2020 2020 2022 7661 6c75 6573 223a 205b       "values": [
+000240e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000240f0: 2020 2020 2073 756d 2864 6174 615b 2263       sum(data["c
+00024100: 6f6d 6d5f 7772 6974 7465 6e22 5d29 2c0a  omm_written"]),.
+00024110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024120: 2020 2020 7375 6d28 6461 7461 5b22 636f      sum(data["co
+00024130: 6d6d 5f72 6561 6422 5d29 2c0a 2020 2020  mm_read"]),.    
+00024140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024150: 7375 6d28 6461 7461 5b22 6469 736b 5f77  sum(data["disk_w
+00024160: 7269 7474 656e 225d 292c 0a20 2020 2020  ritten"]),.     
+00024170: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00024180: 756d 2864 6174 615b 2264 6973 6b5f 7265  um(data["disk_re
+00024190: 6164 225d 292c 0a20 2020 2020 2020 2020  ad"]),.         
+000241a0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000241b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000241c0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+000241d0: 746f 7461 6c73 5f73 6f75 7263 652c 2074  totals_source, t
+000241e0: 6f74 616c 7329 0a0a 2020 2020 2020 2020  otals)..        
+000241f0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+00024200: 736f 7572 6365 2c20 6469 6374 2864 6174  source, dict(dat
+00024210: 6129 290a 2020 2020 2020 2020 2020 2020  a)).            
+00024220: 6c69 6d69 7420 3d20 6d61 7828 6461 7461  limit = max(data
+00024230: 5b22 636f 6d6d 5f6d 656d 6f72 795f 6c69  ["comm_memory_li
+00024240: 6d69 7422 5d20 2b20 6461 7461 5b22 6469  mit"] + data["di
+00024250: 736b 5f6d 656d 6f72 795f 6c69 6d69 7422  sk_memory_limit"
+00024260: 5d29 202a 2031 2e32 0a20 2020 2020 2020  ]) * 1.2.       
+00024270: 2020 2020 2073 656c 662e 636f 6d6d 5f6d       self.comm_m
+00024280: 656d 6f72 792e 785f 7261 6e67 652e 656e  emory.x_range.en
+00024290: 6420 3d20 6c69 6d69 740a 2020 2020 2020  d = limit.      
+000242a0: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
+000242b0: 6d65 6d6f 7279 2e78 5f72 616e 6765 2e65  memory.x_range.e
+000242c0: 6e64 203d 206c 696d 6974 0a0a 0a5f 5354  nd = limit..._ST
+000242d0: 594c 4553 203d 207b 0a20 2020 2022 7769  YLES = {.    "wi
+000242e0: 6474 6822 3a20 2231 3030 2522 2c0a 2020  dth": "100%",.  
+000242f0: 2020 2268 6569 6768 7422 3a20 2231 3030    "height": "100
+00024300: 2522 2c0a 2020 2020 226d 6178 2d77 6964  %",.    "max-wid
+00024310: 7468 223a 2022 3139 3230 7078 222c 0a20  th": "1920px",. 
+00024320: 2020 2022 6d61 782d 6865 6967 6874 223a     "max-height":
+00024330: 2022 3130 3830 7078 222c 0a20 2020 2022   "1080px",.    "
+00024340: 7061 6464 696e 6722 3a20 2231 3270 7822  padding": "12px"
+00024350: 2c0a 2020 2020 2262 6f72 6465 7222 3a20  ,.    "border": 
+00024360: 2231 7078 2073 6f6c 6964 206c 6967 6874  "1px solid light
+00024370: 6772 6179 222c 0a20 2020 2022 626f 782d  gray",.    "box-
+00024380: 7368 6164 6f77 223a 2022 696e 7365 7420  shadow": "inset 
+00024390: 3170 7820 3020 3870 7820 3020 6c69 6768  1px 0 8px 0 ligh
+000243a0: 7467 7261 7922 2c0a 2020 2020 226f 7665  tgray",.    "ove
+000243b0: 7266 6c6f 7722 3a20 2261 7574 6f22 2c0a  rflow": "auto",.
+000243c0: 7d0a 6966 2042 4f4b 4548 5f56 4552 5349  }.if BOKEH_VERSI
+000243d0: 4f4e 2e6d 616a 6f72 203c 2033 3a0a 2020  ON.major < 3:.  
+000243e0: 2020 5f42 4f4b 4548 5f53 5459 4c45 535f    _BOKEH_STYLES_
+000243f0: 4b57 4152 4753 203d 207b 2273 7479 6c65  KWARGS = {"style
+00024400: 223a 205f 5354 594c 4553 7d0a 656c 7365  ": _STYLES}.else
+00024410: 3a0a 2020 2020 5f42 4f4b 4548 5f53 5459  :.    _BOKEH_STY
+00024420: 4c45 535f 4b57 4152 4753 203d 207b 2273  LES_KWARGS = {"s
+00024430: 7479 6c65 7322 3a20 5f53 5459 4c45 537d  tyles": _STYLES}
+00024440: 0a0a 0a63 6c61 7373 2053 6368 6564 756c  ...class Schedul
+00024450: 6572 4c6f 6773 3a0a 2020 2020 6465 6620  erLogs:.    def 
+00024460: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
+00024470: 6368 6564 756c 6572 2c20 7374 6172 743d  cheduler, start=
+00024480: 4e6f 6e65 293a 0a20 2020 2020 2020 206c  None):.        l
+00024490: 6f67 7320 3d20 7363 6865 6475 6c65 722e  ogs = scheduler.
+000244a0: 6765 745f 6c6f 6773 2873 7461 7274 3d73  get_logs(start=s
+000244b0: 7461 7274 2c20 7469 6d65 7374 616d 7073  tart, timestamps
+000244c0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+000244d0: 6966 206e 6f74 206c 6f67 733a 0a20 2020  if not logs:.   
+000244e0: 2020 2020 2020 2020 206c 6f67 735f 6874           logs_ht
+000244f0: 6d6c 203d 2028 0a20 2020 2020 2020 2020  ml = (.         
+00024500: 2020 2020 2020 2027 3c70 2073 7479 6c65         '<p style
+00024510: 3d22 666f 6e74 2d66 616d 696c 793a 206d  ="font-family: m
+00024520: 6f6e 6f73 7061 6365 3b20 6d61 7267 696e  onospace; margin
+00024530: 3a20 303b 223e 4e6f 206c 6f67 7320 746f  : 0;">No logs to
+00024540: 2072 6570 6f72 743c 2f70 3e27 0a20 2020   report</p>'.   
+00024550: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00024560: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00024570: 2020 2020 206c 6f67 735f 6874 6d6c 203d       logs_html =
+00024580: 204c 6f67 280a 2020 2020 2020 2020 2020   Log(.          
+00024590: 2020 2020 2020 225c 6e22 2e6a 6f69 6e28        "\n".join(
+000245a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000245b0: 2020 2020 2022 2573 202d 2025 7322 0a20       "%s - %s". 
+000245c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000245d0: 2020 2025 2028 6461 7465 7469 6d65 2e66     % (datetime.f
+000245e0: 726f 6d74 696d 6573 7461 6d70 2874 696d  romtimestamp(tim
+000245f0: 6529 2e73 7472 6674 696d 6528 2225 483a  e).strftime("%H:
+00024600: 254d 3a25 532e 2566 2229 2c20 6c69 6e65  %M:%S.%f"), line
+00024610: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00024620: 2020 2020 2020 666f 7220 7469 6d65 2c20        for time, 
+00024630: 6c65 7665 6c2c 206c 696e 6520 696e 206c  level, line in l
+00024640: 6f67 730a 2020 2020 2020 2020 2020 2020  ogs.            
+00024650: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00024660: 2020 292e 5f72 6570 725f 6874 6d6c 5f28    )._repr_html_(
+00024670: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00024680: 726f 6f74 203d 2044 6976 2874 6578 743d  root = Div(text=
+00024690: 6c6f 6773 5f68 746d 6c2c 202a 2a5f 424f  logs_html, **_BO
+000246a0: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
+000246b0: 5329 0a0a 0a40 6c6f 675f 6572 726f 7273  S)...@log_errors
+000246c0: 0a64 6566 2073 7973 7465 6d6d 6f6e 6974  .def systemmonit
+000246d0: 6f72 5f64 6f63 2873 6368 6564 756c 6572  or_doc(scheduler
+000246e0: 2c20 6578 7472 612c 2064 6f63 293a 0a20  , extra, doc):. 
+000246f0: 2020 2073 7973 6d6f 6e20 3d20 5379 7374     sysmon = Syst
+00024700: 656d 4d6f 6e69 746f 7228 7363 6865 6475  emMonitor(schedu
+00024710: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
+00024720: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
+00024730: 0a20 2020 2064 6f63 2e74 6974 6c65 203d  .    doc.title =
+00024740: 2022 4461 736b 3a20 5363 6865 6475 6c65   "Dask: Schedule
+00024750: 7220 5379 7374 656d 204d 6f6e 6974 6f72  r System Monitor
+00024760: 220a 2020 2020 6164 645f 7065 7269 6f64  ".    add_period
+00024770: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
+00024780: 2073 7973 6d6f 6e2c 2035 3030 290a 0a20   sysmon, 500).. 
+00024790: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
+000247a0: 7379 736d 6f6e 2e72 6f6f 7429 0a20 2020  sysmon.root).   
+000247b0: 2064 6f63 2e74 656d 706c 6174 6520 3d20   doc.template = 
+000247c0: 656e 762e 6765 745f 7465 6d70 6c61 7465  env.get_template
+000247d0: 2822 7369 6d70 6c65 2e68 746d 6c22 290a  ("simple.html").
+000247e0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+000247f0: 5f76 6172 6961 626c 6573 2e75 7064 6174  _variables.updat
+00024800: 6528 6578 7472 6129 0a20 2020 2064 6f63  e(extra).    doc
+00024810: 2e74 6865 6d65 203d 2042 4f4b 4548 5f54  .theme = BOKEH_T
+00024820: 4845 4d45 0a0a 0a40 6c6f 675f 6572 726f  HEME...@log_erro
+00024830: 7273 0a64 6566 2073 6875 6666 6c69 6e67  rs.def shuffling
+00024840: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00024850: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00024860: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
+00024870: 736b 3a20 5368 7566 666c 696e 6722 0a0a  sk: Shuffling"..
+00024880: 2020 2020 7368 7566 666c 696e 6720 3d20      shuffling = 
+00024890: 5368 7566 666c 696e 6728 7363 6865 6475  Shuffling(schedu
+000248a0: 6c65 722c 2077 6964 7468 3d34 3030 2c20  ler, width=400, 
+000248b0: 6865 6967 6874 3d34 3030 290a 2020 2020  height=400).    
+000248c0: 776f 726b 6572 735f 6d65 6d6f 7279 203d  workers_memory =
+000248d0: 2057 6f72 6b65 7273 4d65 6d6f 7279 2873   WorkersMemory(s
+000248e0: 6368 6564 756c 6572 2c20 7769 6474 683d  cheduler, width=
+000248f0: 3430 302c 2068 6569 6768 743d 3430 3029  400, height=400)
+00024900: 0a20 2020 2074 696d 6573 6572 6965 7320  .    timeseries 
+00024910: 3d20 5379 7374 656d 5469 6d65 7365 7269  = SystemTimeseri
+00024920: 6573 280a 2020 2020 2020 2020 7363 6865  es(.        sche
+00024930: 6475 6c65 722c 2077 6964 7468 3d31 3630  duler, width=160
+00024940: 302c 2068 6569 6768 743d 3230 302c 2066  0, height=200, f
+00024950: 6f6c 6c6f 775f 696e 7465 7276 616c 3d33  ollow_interval=3
+00024960: 3030 300a 2020 2020 290a 2020 2020 6576  000.    ).    ev
+00024970: 656e 745f 6c6f 6f70 203d 2043 6f6e 7465  ent_loop = Conte
+00024980: 6e74 696f 6e28 7363 6865 6475 6c65 722c  ntion(scheduler,
+00024990: 2077 6964 7468 3d32 3030 2c20 6865 6967   width=200, heig
+000249a0: 6874 3d34 3030 290a 0a20 2020 2061 6464  ht=400)..    add
+000249b0: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+000249c0: 636b 2864 6f63 2c20 7368 7566 666c 696e  ck(doc, shufflin
+000249d0: 672c 2032 3030 290a 2020 2020 6164 645f  g, 200).    add_
+000249e0: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
+000249f0: 6b28 646f 632c 2077 6f72 6b65 7273 5f6d  k(doc, workers_m
+00024a00: 656d 6f72 792c 2032 3030 290a 2020 2020  emory, 200).    
+00024a10: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
+00024a20: 6c62 6163 6b28 646f 632c 2074 696d 6573  lback(doc, times
+00024a30: 6572 6965 732c 2035 3030 290a 2020 2020  eries, 500).    
+00024a40: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
+00024a50: 6c62 6163 6b28 646f 632c 2065 7665 6e74  lback(doc, event
+00024a60: 5f6c 6f6f 702c 2035 3030 290a 0a20 2020  _loop, 500)..   
+00024a70: 2074 696d 6573 6572 6965 732e 6261 6e64   timeseries.band
+00024a80: 7769 6474 682e 795f 7261 6e67 6520 3d20  width.y_range = 
+00024a90: 7469 6d65 7365 7269 6573 2e64 6973 6b2e  timeseries.disk.
+00024aa0: 795f 7261 6e67 650a 0a20 2020 2064 6f63  y_range..    doc
+00024ab0: 2e61 6464 5f72 6f6f 7428 0a20 2020 2020  .add_root(.     
+00024ac0: 2020 2063 6f6c 756d 6e28 0a20 2020 2020     column(.     
+00024ad0: 2020 2020 2020 2072 6f77 280a 2020 2020         row(.    
+00024ae0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00024af0: 6572 735f 6d65 6d6f 7279 2e72 6f6f 742c  ers_memory.root,
+00024b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024b10: 2073 6875 6666 6c69 6e67 2e63 6f6d 6d5f   shuffling.comm_
+00024b20: 6d65 6d6f 7279 2c0a 2020 2020 2020 2020  memory,.        
+00024b30: 2020 2020 2020 2020 7368 7566 666c 696e          shufflin
+00024b40: 672e 6469 736b 5f6d 656d 6f72 792c 0a20  g.disk_memory,. 
+00024b50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00024b60: 6875 6666 6c69 6e67 2e74 6f74 616c 732c  huffling.totals,
+00024b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024b80: 2065 7665 6e74 5f6c 6f6f 702e 726f 6f74   event_loop.root
+00024b90: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
+00024ba0: 0a20 2020 2020 2020 2020 2020 2072 6f77  .            row
+00024bb0: 2863 6f6c 756d 6e28 7469 6d65 7365 7269  (column(timeseri
+00024bc0: 6573 2e62 616e 6477 6964 7468 2c20 7469  es.bandwidth, ti
+00024bd0: 6d65 7365 7269 6573 2e64 6973 6b29 292c  meseries.disk)),
+00024be0: 0a20 2020 2020 2020 2029 0a20 2020 2029  .        ).    )
+00024bf0: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
+00024c00: 6520 3d20 656e 762e 6765 745f 7465 6d70  e = env.get_temp
+00024c10: 6c61 7465 2822 7369 6d70 6c65 2e68 746d  late("simple.htm
+00024c20: 6c22 290a 2020 2020 646f 632e 7465 6d70  l").    doc.temp
+00024c30: 6c61 7465 5f76 6172 6961 626c 6573 2e75  late_variables.u
+00024c40: 7064 6174 6528 6578 7472 6129 0a20 2020  pdate(extra).   
+00024c50: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
+00024c60: 4548 5f54 4845 4d45 0a0a 0a40 6c6f 675f  EH_THEME...@log_
+00024c70: 6572 726f 7273 0a64 6566 2073 7465 616c  errors.def steal
+00024c80: 696e 675f 646f 6328 7363 6865 6475 6c65  ing_doc(schedule
+00024c90: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
+00024ca0: 2020 2020 6f63 6375 7061 6e63 7920 3d20      occupancy = 
+00024cb0: 4f63 6375 7061 6e63 7928 7363 6865 6475  Occupancy(schedu
+00024cc0: 6c65 7229 0a20 2020 2073 7465 616c 696e  ler).    stealin
+00024cd0: 675f 7473 203d 2053 7465 616c 696e 6754  g_ts = StealingT
+00024ce0: 696d 6553 6572 6965 7328 7363 6865 6475  imeSeries(schedu
+00024cf0: 6c65 7229 0a20 2020 2073 7465 616c 696e  ler).    stealin
+00024d00: 675f 6576 656e 7473 203d 2053 7465 616c  g_events = Steal
+00024d10: 696e 6745 7665 6e74 7328 7363 6865 6475  ingEvents(schedu
+00024d20: 6c65 7229 0a20 2020 2073 7465 616c 696e  ler).    stealin
+00024d30: 675f 6576 656e 7473 2e72 6f6f 742e 785f  g_events.root.x_
+00024d40: 7261 6e67 6520 3d20 7374 6561 6c69 6e67  range = stealing
+00024d50: 5f74 732e 726f 6f74 2e78 5f72 616e 6765  _ts.root.x_range
+00024d60: 0a20 2020 2064 6f63 2e74 6974 6c65 203d  .    doc.title =
+00024d70: 2022 4461 736b 3a20 576f 726b 2053 7465   "Dask: Work Ste
+00024d80: 616c 696e 6722 0a20 2020 2061 6464 5f70  aling".    add_p
+00024d90: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00024da0: 2864 6f63 2c20 6f63 6375 7061 6e63 792c  (doc, occupancy,
+00024db0: 2035 3030 290a 2020 2020 6164 645f 7065   500).    add_pe
+00024dc0: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
+00024dd0: 646f 632c 2073 7465 616c 696e 675f 7473  doc, stealing_ts
+00024de0: 2c20 3530 3029 0a20 2020 2061 6464 5f70  , 500).    add_p
+00024df0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00024e00: 2864 6f63 2c20 7374 6561 6c69 6e67 5f65  (doc, stealing_e
+00024e10: 7665 6e74 732c 2035 3030 290a 0a20 2020  vents, 500)..   
+00024e20: 2064 6f63 2e61 6464 5f72 6f6f 7428 0a20   doc.add_root(. 
+00024e30: 2020 2020 2020 2072 6f77 280a 2020 2020         row(.    
+00024e40: 2020 2020 2020 2020 6f63 6375 7061 6e63          occupanc
+00024e50: 792e 726f 6f74 2c0a 2020 2020 2020 2020  y.root,.        
+00024e60: 2020 2020 636f 6c75 6d6e 280a 2020 2020      column(.    
+00024e70: 2020 2020 2020 2020 2020 2020 7374 6561              stea
+00024e80: 6c69 6e67 5f74 732e 726f 6f74 2c0a 2020  ling_ts.root,.  
+00024e90: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00024ea0: 6561 6c69 6e67 5f65 7665 6e74 732e 726f  ealing_events.ro
+00024eb0: 6f74 2c0a 2020 2020 2020 2020 2020 2020  ot,.            
+00024ec0: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
+00024ed0: 2273 7472 6574 6368 5f62 6f74 6822 2c0a  "stretch_both",.
+00024ee0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00024ef0: 2020 2020 2020 2029 0a20 2020 2029 0a0a         ).    )..
+00024f00: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+00024f10: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
+00024f20: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
+00024f30: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
+00024f40: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
+00024f50: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
+00024f60: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
+00024f70: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
+00024f80: 7272 6f72 730a 6465 6620 6576 656e 7473  rrors.def events
+00024f90: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00024fa0: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00024fb0: 2065 7665 6e74 7320 3d20 4576 656e 7473   events = Events
+00024fc0: 2873 6368 6564 756c 6572 2c20 2261 6c6c  (scheduler, "all
+00024fd0: 222c 2068 6569 6768 743d 3235 3029 0a20  ", height=250). 
+00024fe0: 2020 2065 7665 6e74 732e 7570 6461 7465     events.update
+00024ff0: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
+00025000: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
+00025010: 2c20 6576 656e 7473 2c20 3530 3029 0a20  , events, 500). 
+00025020: 2020 2064 6f63 2e74 6974 6c65 203d 2022     doc.title = "
+00025030: 4461 736b 3a20 5363 6865 6475 6c65 7220  Dask: Scheduler 
+00025040: 4576 656e 7473 220a 2020 2020 646f 632e  Events".    doc.
+00025050: 6164 645f 726f 6f74 2863 6f6c 756d 6e28  add_root(column(
+00025060: 6576 656e 7473 2e72 6f6f 742c 2073 697a  events.root, siz
+00025070: 696e 675f 6d6f 6465 3d22 7363 616c 655f  ing_mode="scale_
+00025080: 7769 6474 6822 2929 0a20 2020 2064 6f63  width")).    doc
+00025090: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
+000250a0: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
+000250b0: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
+000250c0: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
+000250d0: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
+000250e0: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
+000250f0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
+00025100: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
+00025110: 6566 2065 7863 6570 7469 6f6e 735f 646f  ef exceptions_do
+00025120: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
+00025130: 7261 2c20 646f 6329 3a0a 2020 2020 7461  ra, doc):.    ta
+00025140: 626c 6520 3d20 4578 6365 7074 696f 6e73  ble = Exceptions
+00025150: 5461 626c 6528 7363 6865 6475 6c65 7229  Table(scheduler)
+00025160: 0a20 2020 2074 6162 6c65 2e75 7064 6174  .    table.updat
+00025170: 6528 290a 2020 2020 6164 645f 7065 7269  e().    add_peri
+00025180: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
+00025190: 632c 2074 6162 6c65 2c20 3130 3030 290a  c, table, 1000).
+000251a0: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
+000251b0: 2244 6173 6b3a 2045 7863 6570 7469 6f6e  "Dask: Exception
+000251c0: 7322 0a20 2020 2064 6f63 2e61 6464 5f72  s".    doc.add_r
+000251d0: 6f6f 7428 7461 626c 652e 726f 6f74 290a  oot(table.root).
+000251e0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+000251f0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
+00025200: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
+00025210: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
+00025220: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
+00025230: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
+00025240: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
+00025250: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
+00025260: 7272 6f72 730a 6465 6620 776f 726b 6572  rrors.def worker
+00025270: 735f 646f 6328 7363 6865 6475 6c65 722c  s_doc(scheduler,
+00025280: 2065 7874 7261 2c20 646f 6329 3a0a 2020   extra, doc):.  
+00025290: 2020 7461 626c 6520 3d20 576f 726b 6572    table = Worker
+000252a0: 5461 626c 6528 7363 6865 6475 6c65 7229  Table(scheduler)
+000252b0: 0a20 2020 2074 6162 6c65 2e75 7064 6174  .    table.updat
+000252c0: 6528 290a 2020 2020 6164 645f 7065 7269  e().    add_peri
+000252d0: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
+000252e0: 632c 2074 6162 6c65 2c20 3530 3029 0a20  c, table, 500). 
+000252f0: 2020 2064 6f63 2e74 6974 6c65 203d 2022     doc.title = "
+00025300: 4461 736b 3a20 576f 726b 6572 7322 0a20  Dask: Workers". 
+00025310: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
+00025320: 7461 626c 652e 726f 6f74 290a 2020 2020  table.root).    
+00025330: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00025340: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00025350: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+00025360: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+00025370: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+00025380: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+00025390: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+000253a0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
+000253b0: 730a 6465 6620 6861 7264 7761 7265 5f64  s.def hardware_d
+000253c0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+000253d0: 7472 612c 2064 6f63 293a 0a20 2020 2068  tra, doc):.    h
+000253e0: 7720 3d20 4861 7264 7761 7265 2873 6368  w = Hardware(sch
+000253f0: 6564 756c 6572 290a 2020 2020 6877 2e75  eduler).    hw.u
+00025400: 7064 6174 6528 290a 2020 2020 646f 632e  pdate().    doc.
+00025410: 7469 746c 6520 3d20 2244 6173 6b3a 2043  title = "Dask: C
+00025420: 6c75 7374 6572 2048 6172 6477 6172 6520  luster Hardware 
+00025430: 4261 6e64 7769 6474 6822 0a20 2020 2064  Bandwidth".    d
+00025440: 6f63 2e61 6464 5f72 6f6f 7428 6877 2e72  oc.add_root(hw.r
+00025450: 6f6f 7429 0a20 2020 2064 6f63 2e74 656d  oot).    doc.tem
+00025460: 706c 6174 6520 3d20 656e 762e 6765 745f  plate = env.get_
+00025470: 7465 6d70 6c61 7465 2822 7369 6d70 6c65  template("simple
+00025480: 2e68 746d 6c22 290a 2020 2020 646f 632e  .html").    doc.
+00025490: 7465 6d70 6c61 7465 5f76 6172 6961 626c  template_variabl
+000254a0: 6573 2e75 7064 6174 6528 6578 7472 6129  es.update(extra)
+000254b0: 0a20 2020 2064 6f63 2e74 6865 6d65 203d  .    doc.theme =
+000254c0: 2042 4f4b 4548 5f54 4845 4d45 0a0a 2020   BOKEH_THEME..  
+000254d0: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
+000254e0: 616c 6c62 6163 6b28 646f 632c 2068 772c  allback(doc, hw,
+000254f0: 2035 3030 290a 0a0a 406c 6f67 5f65 7272   500)...@log_err
+00025500: 6f72 730a 6465 6620 7461 736b 735f 646f  ors.def tasks_do
+00025510: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
+00025520: 7261 2c20 646f 6329 3a0a 2020 2020 7473  ra, doc):.    ts
+00025530: 203d 2054 6173 6b53 7472 6561 6d28 0a20   = TaskStream(. 
+00025540: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00025550: 2c0a 2020 2020 2020 2020 6e5f 7265 6374  ,.        n_rect
+00025560: 616e 676c 6573 3d64 6173 6b2e 636f 6e66  angles=dask.conf
+00025570: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
+00025580: 2020 2020 2264 6973 7472 6962 7574 6564      "distributed
+00025590: 2e73 6368 6564 756c 6572 2e64 6173 6862  .scheduler.dashb
+000255a0: 6f61 7264 2e74 6173 6b73 2e74 6173 6b2d  oard.tasks.task-
+000255b0: 7374 7265 616d 2d6c 656e 6774 6822 0a20  stream-length". 
+000255c0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+000255d0: 2020 636c 6561 725f 696e 7465 7276 616c    clear_interval
+000255e0: 3d22 3630 7322 2c0a 2020 2020 2020 2020  ="60s",.        
+000255f0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
+00025600: 6574 6368 5f62 6f74 6822 2c0a 2020 2020  etch_both",.    
+00025610: 290a 2020 2020 7473 2e75 7064 6174 6528  ).    ts.update(
+00025620: 290a 2020 2020 6164 645f 7065 7269 6f64  ).    add_period
+00025630: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
+00025640: 2074 732c 2035 3030 3029 0a20 2020 2064   ts, 5000).    d
+00025650: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
+00025660: 3a20 5461 736b 2053 7472 6561 6d22 0a20  : Task Stream". 
+00025670: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
+00025680: 7473 2e72 6f6f 7429 0a20 2020 2064 6f63  ts.root).    doc
+00025690: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
+000256a0: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
+000256b0: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
+000256c0: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
+000256d0: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
+000256e0: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
+000256f0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
+00025700: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
+00025710: 6566 2067 7261 7068 5f64 6f63 2873 6368  ef graph_doc(sch
+00025720: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
+00025730: 6f63 293a 0a20 2020 2067 7261 7068 203d  oc):.    graph =
+00025740: 2054 6173 6b47 7261 7068 2873 6368 6564   TaskGraph(sched
+00025750: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
+00025760: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00025770: 290a 2020 2020 646f 632e 7469 746c 6520  ).    doc.title 
+00025780: 3d20 2244 6173 6b3a 2054 6173 6b20 4772  = "Dask: Task Gr
+00025790: 6170 6822 0a20 2020 2067 7261 7068 2e75  aph".    graph.u
+000257a0: 7064 6174 6528 290a 2020 2020 6164 645f  pdate().    add_
+000257b0: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
+000257c0: 6b28 646f 632c 2067 7261 7068 2c20 3230  k(doc, graph, 20
+000257d0: 3029 0a20 2020 2064 6f63 2e61 6464 5f72  0).    doc.add_r
+000257e0: 6f6f 7428 6772 6170 682e 726f 6f74 290a  oot(graph.root).
+000257f0: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
+00025800: 6520 3d20 656e 762e 6765 745f 7465 6d70  e = env.get_temp
+00025810: 6c61 7465 2822 7369 6d70 6c65 2e68 746d  late("simple.htm
+00025820: 6c22 290a 2020 2020 646f 632e 7465 6d70  l").    doc.temp
+00025830: 6c61 7465 5f76 6172 6961 626c 6573 2e75  late_variables.u
+00025840: 7064 6174 6528 6578 7472 6129 0a20 2020  pdate(extra).   
+00025850: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
+00025860: 4548 5f54 4845 4d45 0a0a 0a40 6c6f 675f  EH_THEME...@log_
+00025870: 6572 726f 7273 0a64 6566 2074 675f 6772  errors.def tg_gr
+00025880: 6170 685f 646f 6328 7363 6865 6475 6c65  aph_doc(schedule
+00025890: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
+000258a0: 2020 2020 7467 5f67 7261 7068 203d 2054      tg_graph = T
+000258b0: 6173 6b47 726f 7570 4772 6170 6828 7363  askGroupGraph(sc
+000258c0: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
+000258d0: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+000258e0: 7468 2229 0a20 2020 2064 6f63 2e74 6974  th").    doc.tit
+000258f0: 6c65 203d 2022 4461 736b 3a20 5461 736b  le = "Dask: Task
+00025900: 2047 726f 7570 7320 4772 6170 6822 0a20   Groups Graph". 
+00025910: 2020 2074 675f 6772 6170 682e 7570 6461     tg_graph.upda
+00025920: 7465 2829 0a20 2020 2061 6464 5f70 6572  te().    add_per
+00025930: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+00025940: 6f63 2c20 7467 5f67 7261 7068 2c20 3230  oc, tg_graph, 20
+00025950: 3029 0a20 2020 2064 6f63 2e61 6464 5f72  0).    doc.add_r
+00025960: 6f6f 7428 7467 5f67 7261 7068 2e72 6f6f  oot(tg_graph.roo
+00025970: 7429 0a20 2020 2064 6f63 2e74 656d 706c  t).    doc.templ
+00025980: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
+00025990: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
+000259a0: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
+000259b0: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
+000259c0: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
+000259d0: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
+000259e0: 4f4b 4548 5f54 4845 4d45 0a0a 0a40 6c6f  OKEH_THEME...@lo
+000259f0: 675f 6572 726f 7273 0a64 6566 2073 7461  g_errors.def sta
+00025a00: 7475 735f 646f 6328 7363 6865 6475 6c65  tus_doc(schedule
+00025a10: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
+00025a20: 2020 2020 636c 7573 7465 725f 6d65 6d6f      cluster_memo
+00025a30: 7279 203d 2043 6c75 7374 6572 4d65 6d6f  ry = ClusterMemo
+00025a40: 7279 2873 6368 6564 756c 6572 2c20 7369  ry(scheduler, si
+00025a50: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+00025a60: 6368 5f62 6f74 6822 290a 2020 2020 636c  ch_both").    cl
+00025a70: 7573 7465 725f 6d65 6d6f 7279 2e75 7064  uster_memory.upd
+00025a80: 6174 6528 290a 2020 2020 6164 645f 7065  ate().    add_pe
+00025a90: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
+00025aa0: 646f 632c 2063 6c75 7374 6572 5f6d 656d  doc, cluster_mem
+00025ab0: 6f72 792c 2031 3030 290a 2020 2020 646f  ory, 100).    do
+00025ac0: 632e 6164 645f 726f 6f74 2863 6c75 7374  c.add_root(clust
+00025ad0: 6572 5f6d 656d 6f72 792e 726f 6f74 290a  er_memory.root).
+00025ae0: 0a20 2020 2069 6620 6c65 6e28 7363 6865  .    if len(sche
+00025af0: 6475 6c65 722e 776f 726b 6572 7329 203c  duler.workers) <
+00025b00: 3d20 3130 303a 0a20 2020 2020 2020 2077  = 100:.        w
+00025b10: 6f72 6b65 7273 5f6d 656d 6f72 7920 3d20  orkers_memory = 
+00025b20: 576f 726b 6572 734d 656d 6f72 7928 7363  WorkersMemory(sc
+00025b30: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
+00025b40: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+00025b50: 7468 2229 0a0a 2020 2020 2020 2020 7072  th")..        pr
+00025b60: 6f63 6573 7369 6e67 203d 2043 7572 7265  ocessing = Curre
+00025b70: 6e74 4c6f 6164 2873 6368 6564 756c 6572  ntLoad(scheduler
+00025b80: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+00025b90: 7472 6574 6368 5f62 6f74 6822 290a 0a20  tretch_both").. 
+00025ba0: 2020 2020 2020 2070 726f 6365 7373 696e         processin
+00025bb0: 675f 726f 6f74 203d 2070 726f 6365 7373  g_root = process
+00025bc0: 696e 672e 7072 6f63 6573 7369 6e67 5f66  ing.processing_f
+00025bd0: 6967 7572 650a 2020 2020 656c 7365 3a0a  igure.    else:.
+00025be0: 2020 2020 2020 2020 776f 726b 6572 735f          workers_
+00025bf0: 6d65 6d6f 7279 203d 2057 6f72 6b65 7273  memory = Workers
+00025c00: 4d65 6d6f 7279 4869 7374 6f67 7261 6d28  MemoryHistogram(
+00025c10: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
+00025c20: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00025c30: 626f 7468 2229 0a20 2020 2020 2020 2070  both").        p
+00025c40: 726f 6365 7373 696e 6720 3d20 5072 6f63  rocessing = Proc
+00025c50: 6573 7369 6e67 4869 7374 6f67 7261 6d28  essingHistogram(
+00025c60: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
+00025c70: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00025c80: 626f 7468 2229 0a0a 2020 2020 2020 2020  both")..        
+00025c90: 7072 6f63 6573 7369 6e67 5f72 6f6f 7420  processing_root 
+00025ca0: 3d20 7072 6f63 6573 7369 6e67 2e72 6f6f  = processing.roo
+00025cb0: 740a 0a20 2020 2063 7572 7265 6e74 5f6c  t..    current_l
+00025cc0: 6f61 6420 3d20 4375 7272 656e 744c 6f61  oad = CurrentLoa
+00025cd0: 6428 7363 6865 6475 6c65 722c 2073 697a  d(scheduler, siz
+00025ce0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+00025cf0: 685f 626f 7468 2229 0a20 2020 206f 6363  h_both").    occ
+00025d00: 7570 616e 6379 203d 204f 6363 7570 616e  upancy = Occupan
+00025d10: 6379 2873 6368 6564 756c 6572 2c20 7369  cy(scheduler, si
+00025d20: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+00025d30: 6368 5f62 6f74 6822 290a 2020 2020 776f  ch_both").    wo
+00025d40: 726b 6572 735f 7472 616e 7366 6572 5f62  rkers_transfer_b
+00025d50: 7974 6573 203d 2057 6f72 6b65 7273 5472  ytes = WorkersTr
+00025d60: 616e 7366 6572 4279 7465 7328 7363 6865  ansferBytes(sche
+00025d70: 6475 6c65 722c 2073 697a 696e 675f 6d6f  duler, sizing_mo
+00025d80: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
+00025d90: 2229 0a0a 2020 2020 6370 755f 726f 6f74  ")..    cpu_root
+00025da0: 203d 2063 7572 7265 6e74 5f6c 6f61 642e   = current_load.
+00025db0: 6370 755f 6669 6775 7265 0a20 2020 206f  cpu_figure.    o
+00025dc0: 6363 7570 616e 6379 5f72 6f6f 7420 3d20  ccupancy_root = 
+00025dd0: 6f63 6375 7061 6e63 792e 726f 6f74 0a0a  occupancy.root..
+00025de0: 2020 2020 776f 726b 6572 735f 6d65 6d6f      workers_memo
+00025df0: 7279 2e75 7064 6174 6528 290a 2020 2020  ry.update().    
+00025e00: 776f 726b 6572 735f 7472 616e 7366 6572  workers_transfer
+00025e10: 5f62 7974 6573 2e75 7064 6174 6528 290a  _bytes.update().
+00025e20: 2020 2020 7072 6f63 6573 7369 6e67 2e75      processing.u
+00025e30: 7064 6174 6528 290a 2020 2020 6375 7272  pdate().    curr
+00025e40: 656e 745f 6c6f 6164 2e75 7064 6174 6528  ent_load.update(
+00025e50: 290a 2020 2020 6f63 6375 7061 6e63 792e  ).    occupancy.
+00025e60: 7570 6461 7465 2829 0a0a 2020 2020 6164  update()..    ad
+00025e70: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
+00025e80: 6163 6b28 646f 632c 2077 6f72 6b65 7273  ack(doc, workers
+00025e90: 5f6d 656d 6f72 792c 2031 3030 290a 2020  _memory, 100).  
+00025ea0: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
+00025eb0: 616c 6c62 6163 6b28 646f 632c 2077 6f72  allback(doc, wor
+00025ec0: 6b65 7273 5f74 7261 6e73 6665 725f 6279  kers_transfer_by
+00025ed0: 7465 732c 2031 3030 290a 2020 2020 6164  tes, 100).    ad
+00025ee0: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
+00025ef0: 6163 6b28 646f 632c 2070 726f 6365 7373  ack(doc, process
+00025f00: 696e 672c 2031 3030 290a 2020 2020 6164  ing, 100).    ad
+00025f10: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
+00025f20: 6163 6b28 646f 632c 2063 7572 7265 6e74  ack(doc, current
+00025f30: 5f6c 6f61 642c 2031 3030 290a 2020 2020  _load, 100).    
+00025f40: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
+00025f50: 6c62 6163 6b28 646f 632c 206f 6363 7570  lback(doc, occup
+00025f60: 616e 6379 2c20 3130 3029 0a0a 2020 2020  ancy, 100)..    
+00025f70: 646f 632e 6164 645f 726f 6f74 2877 6f72  doc.add_root(wor
+00025f80: 6b65 7273 5f6d 656d 6f72 792e 726f 6f74  kers_memory.root
+00025f90: 290a 0a20 2020 2074 6162 7320 3d20 5b0a  )..    tabs = [.
+00025fa0: 2020 2020 2020 2020 5461 6250 616e 656c          TabPanel
+00025fb0: 2863 6869 6c64 3d70 726f 6365 7373 696e  (child=processin
+00025fc0: 675f 726f 6f74 2c20 7469 746c 653d 2250  g_root, title="P
+00025fd0: 726f 6365 7373 696e 6722 292c 0a20 2020  rocessing"),.   
+00025fe0: 2020 2020 2054 6162 5061 6e65 6c28 6368       TabPanel(ch
+00025ff0: 696c 643d 6370 755f 726f 6f74 2c20 7469  ild=cpu_root, ti
+00026000: 746c 653d 2243 5055 2229 2c0a 2020 2020  tle="CPU"),.    
+00026010: 2020 2020 5461 6250 616e 656c 2863 6869      TabPanel(chi
+00026020: 6c64 3d6f 6363 7570 616e 6379 5f72 6f6f  ld=occupancy_roo
+00026030: 742c 2074 6974 6c65 3d22 4f63 6375 7061  t, title="Occupa
+00026040: 6e63 7922 292c 0a20 2020 2020 2020 2054  ncy"),.        T
+00026050: 6162 5061 6e65 6c28 6368 696c 643d 776f  abPanel(child=wo
+00026060: 726b 6572 735f 7472 616e 7366 6572 5f62  rkers_transfer_b
+00026070: 7974 6573 2e72 6f6f 742c 2074 6974 6c65  ytes.root, title
+00026080: 3d22 4461 7461 2054 7261 6e73 6665 7222  ="Data Transfer"
+00026090: 292c 0a20 2020 205d 0a0a 2020 2020 6865  ),.    ]..    he
+000260a0: 6c70 5f20 3d20 4865 6c70 546f 6f6c 280a  lp_ = HelpTool(.
+000260b0: 2020 2020 2020 2020 7265 6469 7265 6374          redirect
+000260c0: 3d22 6874 7470 733a 2f2f 646f 6373 2e64  ="https://docs.d
+000260d0: 6173 6b2e 6f72 672f 656e 2f73 7461 626c  ask.org/en/stabl
+000260e0: 652f 6461 7368 626f 6172 642e 6874 6d6c  e/dashboard.html
+000260f0: 2374 6173 6b2d 7072 6f63 6573 7369 6e67  #task-processing
+00026100: 2d63 7075 2d75 7469 6c69 7a61 7469 6f6e  -cpu-utilization
+00026110: 2d6f 6363 7570 616e 6379 2d64 6174 612d  -occupancy-data-
+00026120: 7472 616e 7366 6572 222c 0a20 2020 2020  transfer",.     
+00026130: 2020 2064 6573 6372 6970 7469 6f6e 3d22     description="
+00026140: 4120 6465 7363 7269 7074 696f 6e20 6f66  A description of
+00026150: 2054 6173 6b20 5072 6f63 6573 7369 6e67   Task Processing
+00026160: 2f43 5055 2055 7469 6c69 7a61 7469 6f6e  /CPU Utilization
+00026170: 2f4f 6363 7570 616e 6379 222c 0a20 2020  /Occupancy",.   
+00026180: 2029 0a20 2020 2066 6f72 2074 6162 2069   ).    for tab i
+00026190: 6e20 7461 6273 3a0a 2020 2020 2020 2020  n tabs:.        
+000261a0: 7461 622e 6368 696c 642e 746f 6f6c 6261  tab.child.toolba
+000261b0: 725f 6c6f 6361 7469 6f6e 203d 2022 6162  r_location = "ab
+000261c0: 6f76 6522 0a20 2020 2020 2020 2074 6162  ove".        tab
+000261d0: 2e63 6869 6c64 2e61 6464 5f74 6f6f 6c73  .child.add_tools
+000261e0: 2868 656c 705f 290a 0a20 2020 2070 726f  (help_)..    pro
+000261f0: 635f 7461 6273 203d 2054 6162 7328 7461  c_tabs = Tabs(ta
+00026200: 6273 3d74 6162 732c 206e 616d 653d 2270  bs=tabs, name="p
+00026210: 726f 6365 7373 696e 675f 7461 6273 222c  rocessing_tabs",
+00026220: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00026230: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+00026240: 2064 6f63 2e61 6464 5f72 6f6f 7428 7072   doc.add_root(pr
+00026250: 6f63 5f74 6162 7329 0a0a 2020 2020 7461  oc_tabs)..    ta
+00026260: 736b 5f73 7472 6561 6d20 3d20 5461 736b  sk_stream = Task
+00026270: 5374 7265 616d 280a 2020 2020 2020 2020  Stream(.        
+00026280: 7363 6865 6475 6c65 722c 0a20 2020 2020  scheduler,.     
+00026290: 2020 206e 5f72 6563 7461 6e67 6c65 733d     n_rectangles=
+000262a0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+000262b0: 0a20 2020 2020 2020 2020 2020 2022 6469  .            "di
+000262c0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+000262d0: 6c65 722e 6461 7368 626f 6172 642e 7374  ler.dashboard.st
+000262e0: 6174 7573 2e74 6173 6b2d 7374 7265 616d  atus.task-stream
+000262f0: 2d6c 656e 6774 6822 0a20 2020 2020 2020  -length".       
+00026300: 2029 2c0a 2020 2020 2020 2020 636c 6561   ),.        clea
+00026310: 725f 696e 7465 7276 616c 3d22 3573 222c  r_interval="5s",
+00026320: 0a20 2020 2020 2020 2073 697a 696e 675f  .        sizing_
+00026330: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+00026340: 7468 222c 0a20 2020 2029 0a20 2020 2074  th",.    ).    t
+00026350: 6173 6b5f 7374 7265 616d 2e75 7064 6174  ask_stream.updat
+00026360: 6528 290a 2020 2020 6164 645f 7065 7269  e().    add_peri
+00026370: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
+00026380: 632c 2074 6173 6b5f 7374 7265 616d 2c20  c, task_stream, 
+00026390: 3130 3029 0a20 2020 2064 6f63 2e61 6464  100).    doc.add
+000263a0: 5f72 6f6f 7428 7461 736b 5f73 7472 6561  _root(task_strea
+000263b0: 6d2e 726f 6f74 290a 0a20 2020 2074 6173  m.root)..    tas
+000263c0: 6b5f 7072 6f67 7265 7373 203d 2054 6173  k_progress = Tas
+000263d0: 6b50 726f 6772 6573 7328 7363 6865 6475  kProgress(schedu
+000263e0: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
+000263f0: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
+00026400: 0a20 2020 2074 6173 6b5f 7072 6f67 7265  .    task_progre
+00026410: 7373 2e75 7064 6174 6528 290a 2020 2020  ss.update().    
+00026420: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
+00026430: 6c62 6163 6b28 646f 632c 2074 6173 6b5f  lback(doc, task_
+00026440: 7072 6f67 7265 7373 2c20 3130 3029 0a20  progress, 100). 
+00026450: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
+00026460: 7461 736b 5f70 726f 6772 6573 732e 726f  task_progress.ro
+00026470: 6f74 290a 0a20 2020 2064 6f63 2e74 6974  ot)..    doc.tit
+00026480: 6c65 203d 2022 4461 736b 3a20 5374 6174  le = "Dask: Stat
+00026490: 7573 220a 2020 2020 646f 632e 7468 656d  us".    doc.them
+000264a0: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
+000264b0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+000264c0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
+000264d0: 6174 6528 2273 7461 7475 732e 6874 6d6c  ate("status.html
+000264e0: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
+000264f0: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
+00026500: 6461 7465 2865 7874 7261 290a 0a0a 4063  date(extra)...@c
+00026510: 7572 7279 0a64 6566 2069 6e64 6976 6964  urry.def individ
+00026520: 7561 6c5f 646f 6328 636c 732c 2069 6e74  ual_doc(cls, int
+00026530: 6572 7661 6c2c 2073 6368 6564 756c 6572  erval, scheduler
+00026540: 2c20 6578 7472 612c 2064 6f63 2c20 6669  , extra, doc, fi
+00026550: 675f 6174 7472 3d22 726f 6f74 222c 202a  g_attr="root", *
+00026560: 2a6b 7761 7267 7329 3a0a 2020 2020 2320  *kwargs):.    # 
+00026570: 4e6f 7465 3a20 406c 6f67 5f65 7272 6f72  Note: @log_error
+00026580: 7320 616e 6420 4063 7572 7279 2061 7265  s and @curry are
+00026590: 206e 6f74 2063 6f6d 7061 7469 626c 650a   not compatible.
+000265a0: 2020 2020 7769 7468 206c 6f67 5f65 7272      with log_err
+000265b0: 6f72 7328 293a 0a20 2020 2020 2020 2066  ors():.        f
+000265c0: 6967 203d 2063 6c73 2873 6368 6564 756c  ig = cls(schedul
+000265d0: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
+000265e0: 2273 7472 6574 6368 5f62 6f74 6822 2c20  "stretch_both", 
+000265f0: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+00026600: 2020 6669 672e 7570 6461 7465 2829 0a20    fig.update(). 
+00026610: 2020 2020 2020 2061 6464 5f70 6572 696f         add_perio
+00026620: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
+00026630: 2c20 6669 672c 2069 6e74 6572 7661 6c29  , fig, interval)
+00026640: 0a20 2020 2020 2020 2064 6f63 2e61 6464  .        doc.add
+00026650: 5f72 6f6f 7428 6765 7461 7474 7228 6669  _root(getattr(fi
+00026660: 672c 2066 6967 5f61 7474 7229 290a 2020  g, fig_attr)).  
+00026670: 2020 2020 2020 646f 632e 7468 656d 6520        doc.theme 
+00026680: 3d20 424f 4b45 485f 5448 454d 450a 2020  = BOKEH_THEME.  
+00026690: 2020 2020 2020 646f 632e 7469 746c 6520        doc.title 
+000266a0: 3d20 2244 6173 6b3a 2022 202b 2066 756e  = "Dask: " + fun
+000266b0: 636e 616d 6528 636c 7329 0a0a 0a40 6c6f  cname(cls)...@lo
+000266c0: 675f 6572 726f 7273 0a64 6566 2069 6e64  g_errors.def ind
+000266d0: 6976 6964 7561 6c5f 7072 6f66 696c 655f  ividual_profile_
+000266e0: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
+000266f0: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
+00026700: 7072 6f66 203d 2050 726f 6669 6c65 5469  prof = ProfileTi
+00026710: 6d65 506c 6f74 2873 6368 6564 756c 6572  mePlot(scheduler
+00026720: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+00026730: 7472 6574 6368 5f62 6f74 6822 2c20 646f  tretch_both", do
+00026740: 633d 646f 6329 0a20 2020 2064 6f63 2e61  c=doc).    doc.a
+00026750: 6464 5f72 6f6f 7428 7072 6f66 2e72 6f6f  dd_root(prof.roo
+00026760: 7429 0a20 2020 2070 726f 662e 7472 6967  t).    prof.trig
+00026770: 6765 725f 7570 6461 7465 2829 0a20 2020  ger_update().   
+00026780: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
+00026790: 4548 5f54 4845 4d45 0a0a 0a40 6c6f 675f  EH_THEME...@log_
+000267a0: 6572 726f 7273 0a64 6566 2069 6e64 6976  errors.def indiv
+000267b0: 6964 7561 6c5f 7072 6f66 696c 655f 7365  idual_profile_se
+000267c0: 7276 6572 5f64 6f63 2873 6368 6564 756c  rver_doc(schedul
+000267d0: 6572 2c20 6578 7472 612c 2064 6f63 293a  er, extra, doc):
+000267e0: 0a20 2020 2070 726f 6620 3d20 5072 6f66  .    prof = Prof
+000267f0: 696c 6553 6572 7665 7228 7363 6865 6475  ileServer(schedu
+00026800: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
+00026810: 3d22 7374 7265 7463 685f 626f 7468 222c  ="stretch_both",
+00026820: 2064 6f63 3d64 6f63 290a 2020 2020 646f   doc=doc).    do
+00026830: 632e 6164 645f 726f 6f74 2870 726f 662e  c.add_root(prof.
+00026840: 726f 6f74 290a 2020 2020 7072 6f66 2e74  root).    prof.t
+00026850: 7269 6767 6572 5f75 7064 6174 6528 290a  rigger_update().
+00026860: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00026870: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
+00026880: 6f67 5f65 7272 6f72 730a 6465 6620 7072  og_errors.def pr
+00026890: 6f66 696c 655f 646f 6328 7363 6865 6475  ofile_doc(schedu
+000268a0: 6c65 722c 2065 7874 7261 2c20 646f 6329  ler, extra, doc)
+000268b0: 3a0a 2020 2020 646f 632e 7469 746c 6520  :.    doc.title 
+000268c0: 3d20 2244 6173 6b3a 2050 726f 6669 6c65  = "Dask: Profile
+000268d0: 220a 2020 2020 7072 6f66 203d 2050 726f  ".    prof = Pro
+000268e0: 6669 6c65 5469 6d65 506c 6f74 2873 6368  fileTimePlot(sch
+000268f0: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+00026900: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00026910: 6822 2c20 646f 633d 646f 6329 0a20 2020  h", doc=doc).   
+00026920: 2064 6f63 2e61 6464 5f72 6f6f 7428 7072   doc.add_root(pr
+00026930: 6f66 2e72 6f6f 7429 0a20 2020 2064 6f63  of.root).    doc
+00026940: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
+00026950: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
+00026960: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
+00026970: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
+00026980: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
+00026990: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
+000269a0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
+000269b0: 0a0a 2020 2020 7072 6f66 2e74 7269 6767  ..    prof.trigg
+000269c0: 6572 5f75 7064 6174 6528 290a 0a0a 406c  er_update()...@l
+000269d0: 6f67 5f65 7272 6f72 730a 6465 6620 7072  og_errors.def pr
+000269e0: 6f66 696c 655f 7365 7276 6572 5f64 6f63  ofile_server_doc
+000269f0: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
+00026a00: 612c 2064 6f63 293a 0a20 2020 2064 6f63  a, doc):.    doc
+00026a10: 2e74 6974 6c65 203d 2022 4461 736b 3a20  .title = "Dask: 
+00026a20: 5072 6f66 696c 6520 6f66 2045 7665 6e74  Profile of Event
+00026a30: 204c 6f6f 7022 0a20 2020 2070 726f 6620   Loop".    prof 
+00026a40: 3d20 5072 6f66 696c 6553 6572 7665 7228  = ProfileServer(
+00026a50: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
+00026a60: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00026a70: 626f 7468 222c 2064 6f63 3d64 6f63 290a  both", doc=doc).
+00026a80: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00026a90: 2870 726f 662e 726f 6f74 290a 2020 2020  (prof.root).    
+00026aa0: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00026ab0: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00026ac0: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+00026ad0: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+00026ae0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+00026af0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+00026b00: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+00026b10: 454d 450a 0a20 2020 2070 726f 662e 7472  EME..    prof.tr
+00026b20: 6967 6765 725f 7570 6461 7465 2829 0a    igger_update().
```

### Comparing `distributed-2023.5.0/distributed/dashboard/components/shared.py` & `distributed-2023.5.1/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/components/worker.py` & `distributed-2023.5.1/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/core.py` & `distributed-2023.5.1/distributed/dashboard/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/export_tool.js` & `distributed-2023.5.1/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/export_tool.py` & `distributed-2023.5.1/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/scheduler.py` & `distributed-2023.5.1/distributed/dashboard/scheduler.py`

 * *Files 3% similar despite different names*

```diff
@@ -17,14 +17,15 @@
     BandwidthTypes,
     BandwidthWorkers,
     ClusterMemory,
     ComputePerKey,
     Contention,
     CurrentLoad,
     ExceptionsTable,
+    FinePerformanceMetrics,
     MemoryByKey,
     Occupancy,
     SystemMonitor,
     SystemTimeseries,
     TaskGraph,
     TaskGroupGraph,
     TaskGroupProgress,
@@ -108,14 +109,15 @@
         SystemTimeseries, 500, fig_attr="disk"
     ),
     "/individual-memory-by-key": individual_doc(MemoryByKey, 500),
     "/individual-compute-time-per-key": individual_doc(ComputePerKey, 500),
     "/individual-aggregate-time-per-action": individual_doc(AggregateAction, 500),
     "/individual-scheduler-system": individual_doc(SystemMonitor, 500),
     "/individual-contention": individual_doc(Contention, 500),
+    "/individual-fine-performance-metrics": individual_doc(FinePerformanceMetrics, 500),
     "/individual-profile": individual_profile_doc,
     "/individual-profile-server": individual_profile_server_doc,
     "/individual-gpu-memory": gpu_memory_doc,
     "/individual-gpu-utilization": gpu_utilization_doc,
     "/individual-rmm-memory": rmm_memory_doc,
 }
```

### Comparing `distributed-2023.5.0/distributed/dashboard/utils.py` & `distributed-2023.5.1/distributed/dashboard/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/dashboard/worker.py` & `distributed-2023.5.1/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/adaptive.py` & `distributed-2023.5.1/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/adaptive_core.py` & `distributed-2023.5.1/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/cluster.py` & `distributed-2023.5.1/distributed/deploy/cluster.py`

 * *Files 1% similar despite different names*

```diff
@@ -157,19 +157,14 @@
         while self.status == Status.running:
             try:
                 await self.scheduler_comm.set_metadata(
                     keys=["cluster-manager-info"],
                     value=self._cluster_info.copy(),
                 )
                 err_count = 0
-            except asyncio.CancelledError:
-                # Task is being closed. When we drop Python < 3.8 we can drop
-                # this check (since CancelledError is not a subclass of
-                # Exception then).
-                break
             except Exception:
                 err_count += 1
                 # Only warn if multiple subsequent attempts fail, and only once
                 # per set of subsequent failed attempts. This way we're not
                 # excessively noisy during a connection blip, but we also don't
                 # silently fail.
                 if err_count == warn_at:
```

### Comparing `distributed-2023.5.0/distributed/deploy/local.py` & `distributed-2023.5.1/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/old_ssh.py` & `distributed-2023.5.1/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/spec.py` & `distributed-2023.5.1/distributed/deploy/spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/ssh.py` & `distributed-2023.5.1/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/subprocess.py` & `distributed-2023.5.1/distributed/deploy/subprocess.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/deploy/utils.py` & `distributed-2023.5.1/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/cluster_dump.py` & `distributed-2023.5.1/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/eventstream.py` & `distributed-2023.5.1/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/graph_layout.py` & `distributed-2023.5.1/distributed/diagnostics/graph_layout.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/memory_sampler.py` & `distributed-2023.5.1/distributed/diagnostics/memory_sampler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/nvml.py` & `distributed-2023.5.1/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/plugin.py` & `distributed-2023.5.1/distributed/diagnostics/plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/progress.py` & `distributed-2023.5.1/distributed/diagnostics/progress.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/progress_stream.py` & `distributed-2023.5.1/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/progressbar.py` & `distributed-2023.5.1/distributed/diagnostics/progressbar.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/rmm.py` & `distributed-2023.5.1/distributed/diagnostics/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/task_stream.py` & `distributed-2023.5.1/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diagnostics/websocket.py` & `distributed-2023.5.1/distributed/diagnostics/websocket.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/diskutils.py` & `distributed-2023.5.1/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/distributed-schema.yaml` & `distributed-2023.5.1/distributed/distributed-schema.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/distributed.yaml` & `distributed-2023.5.1/distributed/distributed.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/event.py` & `distributed-2023.5.1/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/exceptions.py` & `distributed-2023.5.1/distributed/exceptions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/prometheus.py` & `distributed-2023.5.1/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/proxy.py` & `distributed-2023.5.1/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/routing.py` & `distributed-2023.5.1/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/api.py` & `distributed-2023.5.1/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/info.py` & `distributed-2023.5.1/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/json.py` & `distributed-2023.5.1/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/missing_bokeh.py` & `distributed-2023.5.1/distributed/http/scheduler/missing_bokeh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/prometheus/core.py` & `distributed-2023.5.1/distributed/http/scheduler/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2023.5.1/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2023.5.1/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/css/base.css` & `distributed-2023.5.1/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/css/individual-cluster-map.css` & `distributed-2023.5.1/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/css/status.css` & `distributed-2023.5.1/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/dask-logo.svg` & `distributed-2023.5.1/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/fa-bars.svg` & `distributed-2023.5.1/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/favicon.ico` & `distributed-2023.5.1/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/jupyter.svg` & `distributed-2023.5.1/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/numpy.png` & `distributed-2023.5.1/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/pandas.png` & `distributed-2023.5.1/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/images/python.png` & `distributed-2023.5.1/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/individual-cluster-map.html` & `distributed-2023.5.1/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/js/anime.min.js` & `distributed-2023.5.1/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/js/individual-cluster-map.js` & `distributed-2023.5.1/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2023.5.1/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/templates/base.html` & `distributed-2023.5.1/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/templates/exceptions.html` & `distributed-2023.5.1/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/templates/status.html` & `distributed-2023.5.1/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/templates/task.html` & `distributed-2023.5.1/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/templates/worker-table.html` & `distributed-2023.5.1/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/templates/worker.html` & `distributed-2023.5.1/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/utils.py` & `distributed-2023.5.1/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/http/worker/prometheus/core.py` & `distributed-2023.5.1/distributed/http/worker/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/lock.py` & `distributed-2023.5.1/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/metrics.py` & `distributed-2023.5.1/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/multi_lock.py` & `distributed-2023.5.1/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/nanny.py` & `distributed-2023.5.1/distributed/nanny.py`

 * *Files 0% similar despite different names*

```diff
@@ -8,19 +8,19 @@
 import multiprocessing
 import os
 import shutil
 import threading
 import uuid
 import warnings
 import weakref
-from collections.abc import Collection
+from collections.abc import Callable, Collection
 from inspect import isawaitable
 from queue import Empty
 from time import sleep as sync_sleep
-from typing import TYPE_CHECKING, Callable, ClassVar, Literal
+from typing import TYPE_CHECKING, ClassVar, Literal
 
 from toolz import merge
 from tornado.ioloop import IOLoop
 
 import dask
 from dask.system import CPU_COUNT
 from dask.utils import parse_timedelta
```

### Comparing `distributed-2023.5.0/distributed/node.py` & `distributed-2023.5.1/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/objects.py` & `distributed-2023.5.1/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/preloading.py` & `distributed-2023.5.1/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/process.py` & `distributed-2023.5.1/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/proctitle.py` & `distributed-2023.5.1/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/profile.py` & `distributed-2023.5.1/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/__init__.py` & `distributed-2023.5.1/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/arrow.py` & `distributed-2023.5.1/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/compression.py` & `distributed-2023.5.1/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/core.py` & `distributed-2023.5.1/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/cuda.py` & `distributed-2023.5.1/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/cupy.py` & `distributed-2023.5.1/distributed/protocol/cupy.py`

 * *Files 3% similar despite different names*

```diff
@@ -64,15 +64,20 @@
 def dask_deserialize_cupy_ndarray(header, frames):
     frames = [dask_deserialize_cuda_buffer(header, frames)]
     arr = cuda_deserialize_cupy_ndarray(header, frames)
     return arr
 
 
 try:
-    from cupy.cusparse import MatDescriptor
+    from packaging.version import Version
+
+    if Version(cupy.__version__) >= Version("12"):
+        from cupyx.cusparse import MatDescriptor
+    else:
+        from cupy.cusparse import MatDescriptor
     from cupyx.scipy.sparse import spmatrix
 except ImportError:
     MatDescriptor = None
     spmatrix = None
 
 
 if MatDescriptor is not None:
```

### Comparing `distributed-2023.5.0/distributed/protocol/h5py.py` & `distributed-2023.5.1/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/keras.py` & `distributed-2023.5.1/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/netcdf4.py` & `distributed-2023.5.1/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/numba.py` & `distributed-2023.5.1/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/numpy.py` & `distributed-2023.5.1/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/pickle.py` & `distributed-2023.5.1/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/rmm.py` & `distributed-2023.5.1/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/scipy.py` & `distributed-2023.5.1/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/serialize.py` & `distributed-2023.5.1/distributed/protocol/serialize.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/sparse.py` & `distributed-2023.5.1/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/torch.py` & `distributed-2023.5.1/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/protocol/utils.py` & `distributed-2023.5.1/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/publish.py` & `distributed-2023.5.1/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/pubsub.py` & `distributed-2023.5.1/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/queues.py` & `distributed-2023.5.1/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/recreate_tasks.py` & `distributed-2023.5.1/distributed/recreate_tasks.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/scheduler.py` & `distributed-2023.5.1/distributed/scheduler.py`

 * *Files 0% similar despite different names*

```diff
@@ -232,18650 +232,18685 @@
 00000e70: 2020 2020 2265 7272 6564 222c 0a20 2020      "erred",.   
 00000e80: 2022 666f 7267 6f74 7465 6e22 2c0a 5d0a   "forgotten",.].
 00000e90: 0a41 4c4c 5f54 4153 4b5f 5354 4154 4553  .ALL_TASK_STATES
 00000ea0: 3a20 5365 745b 5461 736b 5374 6174 6553  : Set[TaskStateS
 00000eb0: 7461 7465 5d20 3d20 7365 7428 5461 736b  tate] = set(Task
 00000ec0: 5374 6174 6553 7461 7465 2e5f 5f61 7267  StateState.__arg
 00000ed0: 735f 5f29 2020 2320 7479 7065 3a20 6967  s__)  # type: ig
-00000ee0: 6e6f 7265 0a0a 2320 544f 444f 2072 656d  nore..# TODO rem
-00000ef0: 6f76 6520 7175 6f74 6573 2028 7265 7175  ove quotes (requ
-00000f00: 6972 6573 2050 7974 686f 6e20 3e3d 332e  ires Python >=3.
-00000f10: 3929 0a23 207b 7461 736b 206b 6579 202d  9).# {task key -
-00000f20: 3e20 6669 6e69 7368 2073 7461 7465 7d0a  > finish state}.
-00000f30: 2320 4e6f 7420 746f 2062 6520 636f 6e66  # Not to be conf
-00000f40: 7573 6564 2077 6974 6820 6469 7374 7269  used with distri
-00000f50: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
-00000f60: 7465 5f6d 6163 6869 6e65 2e52 6563 730a  te_machine.Recs.
-00000f70: 5265 6373 3a20 5479 7065 416c 6961 7320  Recs: TypeAlias 
-00000f80: 3d20 2264 6963 745b 7374 722c 2054 6173  = "dict[str, Tas
-00000f90: 6b53 7461 7465 5374 6174 655d 220a 2320  kStateState]".# 
-00000fa0: 7b63 6c69 656e 7420 6f72 2077 6f72 6b65  {client or worke
-00000fb0: 7220 6164 6472 6573 733a 205b 7b6f 703a  r address: [{op:
-00000fc0: 203c 6b65 793e 2c20 2e2e 2e7d 2c20 2e2e   <key>, ...}, ..
-00000fd0: 2e5d 7d0a 4d73 6773 3a20 5479 7065 416c  .]}.Msgs: TypeAl
-00000fe0: 6961 7320 3d20 2264 6963 745b 7374 722c  ias = "dict[str,
-00000ff0: 206c 6973 745b 6469 6374 5b73 7472 2c20   list[dict[str, 
-00001000: 416e 795d 5d5d 220a 2320 2872 6563 6f6d  Any]]]".# (recom
-00001010: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
-00001020: 6e74 206d 6573 7361 6765 732c 2077 6f72  nt messages, wor
-00001030: 6b65 7220 6d65 7373 6167 6573 290a 5265  ker messages).Re
-00001040: 6373 4d73 6773 3a20 5479 7065 416c 6961  csMsgs: TypeAlia
-00001050: 7320 3d20 2274 7570 6c65 5b52 6563 732c  s = "tuple[Recs,
-00001060: 204d 7367 732c 204d 7367 735d 220a 0a6c   Msgs, Msgs]"..l
-00001070: 6f67 6765 7220 3d20 6c6f 6767 696e 672e  ogger = logging.
-00001080: 6765 744c 6f67 6765 7228 5f5f 6e61 6d65  getLogger(__name
-00001090: 5f5f 290a 4c4f 475f 5044 4220 3d20 6461  __).LOG_PDB = da
-000010a0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-000010b0: 6973 7472 6962 7574 6564 2e61 646d 696e  istributed.admin
-000010c0: 2e70 6462 2d6f 6e2d 6572 7222 290a 4445  .pdb-on-err").DE
-000010d0: 4641 554c 545f 4441 5441 5f53 495a 4520  FAULT_DATA_SIZE 
-000010e0: 3d20 7061 7273 655f 6279 7465 7328 0a20  = parse_bytes(. 
-000010f0: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
-00001100: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-00001110: 7363 6865 6475 6c65 722e 6465 6661 756c  scheduler.defaul
-00001120: 742d 6461 7461 2d73 697a 6522 290a 290a  t-data-size").).
-00001130: 5354 494d 554c 5553 5f49 445f 554e 5345  STIMULUS_ID_UNSE
-00001140: 5420 3d20 223c 7374 696d 756c 7573 5f69  T = "<stimulus_i
-00001150: 6420 756e 7365 743e 220a 0a44 4546 4155  d unset>"..DEFAU
-00001160: 4c54 5f45 5854 454e 5349 4f4e 5320 3d20  LT_EXTENSIONS = 
-00001170: 7b0a 2020 2020 226c 6f63 6b73 223a 204c  {.    "locks": L
-00001180: 6f63 6b45 7874 656e 7369 6f6e 2c0a 2020  ockExtension,.  
-00001190: 2020 226d 756c 7469 5f6c 6f63 6b73 223a    "multi_locks":
-000011a0: 204d 756c 7469 4c6f 636b 4578 7465 6e73   MultiLockExtens
-000011b0: 696f 6e2c 0a20 2020 2022 7075 626c 6973  ion,.    "publis
-000011c0: 6822 3a20 5075 626c 6973 6845 7874 656e  h": PublishExten
-000011d0: 7369 6f6e 2c0a 2020 2020 2272 6570 6c61  sion,.    "repla
-000011e0: 792d 7461 736b 7322 3a20 5265 706c 6179  y-tasks": Replay
-000011f0: 5461 736b 5363 6865 6475 6c65 722c 0a20  TaskScheduler,. 
-00001200: 2020 2022 7175 6575 6573 223a 2051 7565     "queues": Que
-00001210: 7565 4578 7465 6e73 696f 6e2c 0a20 2020  ueExtension,.   
-00001220: 2022 7661 7269 6162 6c65 7322 3a20 5661   "variables": Va
-00001230: 7269 6162 6c65 4578 7465 6e73 696f 6e2c  riableExtension,
-00001240: 0a20 2020 2022 7075 6273 7562 223a 2050  .    "pubsub": P
-00001250: 7562 5375 6253 6368 6564 756c 6572 4578  ubSubSchedulerEx
-00001260: 7465 6e73 696f 6e2c 0a20 2020 2022 7365  tension,.    "se
-00001270: 6d61 7068 6f72 6573 223a 2053 656d 6170  maphores": Semap
-00001280: 686f 7265 4578 7465 6e73 696f 6e2c 0a20  horeExtension,. 
-00001290: 2020 2022 6576 656e 7473 223a 2045 7665     "events": Eve
-000012a0: 6e74 4578 7465 6e73 696f 6e2c 0a20 2020  ntExtension,.   
-000012b0: 2022 616d 6d22 3a20 4163 7469 7665 4d65   "amm": ActiveMe
-000012c0: 6d6f 7279 4d61 6e61 6765 7245 7874 656e  moryManagerExten
-000012d0: 7369 6f6e 2c0a 2020 2020 226d 656d 6f72  sion,.    "memor
-000012e0: 795f 7361 6d70 6c65 7222 3a20 4d65 6d6f  y_sampler": Memo
-000012f0: 7279 5361 6d70 6c65 7245 7874 656e 7369  rySamplerExtensi
-00001300: 6f6e 2c0a 2020 2020 2273 6875 6666 6c65  on,.    "shuffle
-00001310: 223a 2053 6875 6666 6c65 5363 6865 6475  ": ShuffleSchedu
-00001320: 6c65 7245 7874 656e 7369 6f6e 2c0a 2020  lerExtension,.  
-00001330: 2020 2273 7465 616c 696e 6722 3a20 576f    "stealing": Wo
-00001340: 726b 5374 6561 6c69 6e67 2c0a 7d0a 0a0a  rkStealing,.}...
-00001350: 636c 6173 7320 436c 6965 6e74 5374 6174  class ClientStat
-00001360: 653a 0a20 2020 2022 2222 4120 7369 6d70  e:.    """A simp
-00001370: 6c65 206f 626a 6563 7420 686f 6c64 696e  le object holdin
-00001380: 6720 696e 666f 726d 6174 696f 6e20 6162  g information ab
-00001390: 6f75 7420 6120 636c 6965 6e74 2e22 2222  out a client."""
-000013a0: 0a0a 2020 2020 233a 2041 2075 6e69 7175  ..    #: A uniqu
-000013b0: 6520 6964 656e 7469 6669 6572 2066 6f72  e identifier for
-000013c0: 2074 6869 7320 636c 6965 6e74 2e20 5468   this client. Th
-000013d0: 6973 2069 7320 6765 6e65 7261 6c6c 7920  is is generally 
-000013e0: 616e 206f 7061 7175 650a 2020 2020 233a  an opaque.    #:
-000013f0: 2073 7472 696e 6720 6765 6e65 7261 7465   string generate
-00001400: 6420 6279 2074 6865 2063 6c69 656e 7420  d by the client 
-00001410: 6974 7365 6c66 2e0a 2020 2020 636c 6965  itself..    clie
-00001420: 6e74 5f6b 6579 3a20 7374 720a 0a20 2020  nt_key: str..   
-00001430: 2023 3a20 4361 6368 6564 2068 6173 6820   #: Cached hash 
-00001440: 6f66 203a 6174 7472 3a60 7e43 6c69 656e  of :attr:`~Clien
-00001450: 7453 7461 7465 2e63 6c69 656e 745f 6b65  tState.client_ke
-00001460: 7960 0a20 2020 205f 6861 7368 3a20 696e  y`.    _hash: in
-00001470: 740a 0a20 2020 2023 3a20 4120 7365 7420  t..    #: A set 
-00001480: 6f66 2074 6173 6b73 2074 6869 7320 636c  of tasks this cl
-00001490: 6965 6e74 2077 616e 7473 2074 6f20 6265  ient wants to be
-000014a0: 206b 6570 7420 696e 206d 656d 6f72 792c   kept in memory,
-000014b0: 2073 6f20 7468 6174 2069 7420 6361 6e20   so that it can 
-000014c0: 646f 776e 6c6f 6164 0a20 2020 2023 3a20  download.    #: 
-000014d0: 6974 7320 7265 7375 6c74 2077 6865 6e20  its result when 
-000014e0: 6465 7369 7265 642e 2054 6869 7320 6973  desired. This is
-000014f0: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
-00001500: 7069 6e67 206f 660a 2020 2020 233a 203a  ping of.    #: :
-00001510: 636c 6173 733a 6054 6173 6b53 7461 7465  class:`TaskState
-00001520: 2e77 686f 5f77 616e 7473 602e 2054 6173  .who_wants`. Tas
-00001530: 6b73 2061 7265 2074 7970 6963 616c 6c79  ks are typically
-00001540: 2072 656d 6f76 6564 2066 726f 6d20 7468   removed from th
-00001550: 6973 2073 6574 2077 6865 6e20 7468 650a  is set when the.
-00001560: 2020 2020 233a 2063 6f72 7265 7370 6f6e      #: correspon
-00001570: 6469 6e67 206f 626a 6563 7420 696e 2074  ding object in t
-00001580: 6865 2063 6c69 656e 7427 7320 7370 6163  he client's spac
-00001590: 6520 2866 6f72 2065 7861 6d70 6c65 2061  e (for example a
-000015a0: 2060 6046 7574 7572 6560 6020 6f72 2061   ``Future`` or a
-000015b0: 2044 6173 6b0a 2020 2020 233a 2063 6f6c   Dask.    #: col
-000015c0: 6c65 6374 696f 6e29 2067 6574 7320 6761  lection) gets ga
-000015d0: 7262 6167 652d 636f 6c6c 6563 7465 642e  rbage-collected.
-000015e0: 0a20 2020 2077 616e 7473 5f77 6861 743a  .    wants_what:
-000015f0: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
-00001600: 0a20 2020 2023 3a20 5468 6520 6c61 7374  .    #: The last
-00001610: 2074 696d 6520 7765 2072 6563 6569 7665   time we receive
-00001620: 6420 6120 6865 6172 7462 6561 7420 6672  d a heartbeat fr
-00001630: 6f6d 2074 6869 7320 636c 6965 6e74 2c20  om this client, 
-00001640: 696e 206c 6f63 616c 2073 6368 6564 756c  in local schedul
-00001650: 6572 2074 696d 652e 0a20 2020 206c 6173  er time..    las
-00001660: 745f 7365 656e 3a20 666c 6f61 740a 0a20  t_seen: float.. 
-00001670: 2020 2023 3a20 4f75 7470 7574 206f 6620     #: Output of 
-00001680: 3a66 756e 633a 6064 6973 7472 6962 7574  :func:`distribut
-00001690: 6564 2e76 6572 7369 6f6e 732e 6765 745f  ed.versions.get_
-000016a0: 7665 7273 696f 6e73 6020 6f6e 2074 6865  versions` on the
-000016b0: 2063 6c69 656e 740a 2020 2020 7665 7273   client.    vers
-000016c0: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
-000016d0: 416e 795d 0a0a 2020 2020 5f5f 736c 6f74  Any]..    __slot
-000016e0: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-000016f0: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-00001700: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00001710: 656c 662c 2063 6c69 656e 743a 2073 7472  elf, client: str
-00001720: 2c20 2a2c 2076 6572 7369 6f6e 733a 2064  , *, versions: d
-00001730: 6963 745b 7374 722c 2041 6e79 5d20 7c20  ict[str, Any] | 
-00001740: 4e6f 6e65 203d 204e 6f6e 6529 3a0a 2020  None = None):.  
-00001750: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00001760: 745f 6b65 7920 3d20 636c 6965 6e74 0a20  t_key = client. 
-00001770: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
-00001780: 6820 3d20 6861 7368 2863 6c69 656e 7429  h = hash(client)
-00001790: 0a20 2020 2020 2020 2073 656c 662e 7761  .        self.wa
-000017a0: 6e74 735f 7768 6174 203d 2073 6574 2829  nts_what = set()
-000017b0: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
-000017c0: 7374 5f73 6565 6e20 3d20 7469 6d65 2829  st_seen = time()
-000017d0: 0a20 2020 2020 2020 2073 656c 662e 7665  .        self.ve
-000017e0: 7273 696f 6e73 203d 2076 6572 7369 6f6e  rsions = version
-000017f0: 7320 6f72 207b 7d0a 0a20 2020 2064 6566  s or {}..    def
-00001800: 205f 5f68 6173 685f 5f28 7365 6c66 2920   __hash__(self) 
-00001810: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-00001820: 7265 7475 726e 2073 656c 662e 5f68 6173  return self._has
-00001830: 680a 0a20 2020 2064 6566 205f 5f65 715f  h..    def __eq_
-00001840: 5f28 7365 6c66 2c20 6f74 6865 723a 206f  _(self, other: o
-00001850: 626a 6563 7429 202d 3e20 626f 6f6c 3a0a  bject) -> bool:.
-00001860: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00001870: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
-00001880: 2043 6c69 656e 7453 7461 7465 293a 0a20   ClientState):. 
-00001890: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000018a0: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-000018b0: 7265 7475 726e 2073 656c 662e 636c 6965  return self.clie
-000018c0: 6e74 5f6b 6579 203d 3d20 6f74 6865 722e  nt_key == other.
-000018d0: 636c 6965 6e74 5f6b 6579 0a0a 2020 2020  client_key..    
-000018e0: 6465 6620 5f5f 7265 7072 5f5f 2873 656c  def __repr__(sel
-000018f0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
-00001900: 2020 2072 6574 7572 6e20 6622 3c43 6c69     return f"<Cli
-00001910: 656e 7420 7b73 656c 662e 636c 6965 6e74  ent {self.client
-00001920: 5f6b 6579 2172 7d3e 220a 0a20 2020 2064  _key!r}>"..    d
-00001930: 6566 205f 5f73 7472 5f5f 2873 656c 6629  ef __str__(self)
-00001940: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00001950: 2072 6574 7572 6e20 7365 6c66 2e63 6c69   return self.cli
-00001960: 656e 745f 6b65 790a 0a20 2020 2064 6566  ent_key..    def
-00001970: 205f 746f 5f64 6963 745f 6e6f 5f6e 6573   _to_dict_no_nes
-00001980: 7428 7365 6c66 2c20 2a2c 2065 7863 6c75  t(self, *, exclu
-00001990: 6465 3a20 436f 6e74 6169 6e65 725b 7374  de: Container[st
-000019a0: 725d 203d 2028 2929 202d 3e20 6469 6374  r] = ()) -> dict
-000019b0: 3a0a 2020 2020 2020 2020 2222 2244 6963  :.        """Dic
-000019c0: 7469 6f6e 6172 7920 7265 7072 6573 656e  tionary represen
-000019d0: 7461 7469 6f6e 2066 6f72 2064 6562 7567  tation for debug
-000019e0: 6769 6e67 2070 7572 706f 7365 732e 0a20  ging purposes.. 
-000019f0: 2020 2020 2020 204e 6f74 2074 7970 6520         Not type 
-00001a00: 7374 6162 6c65 2061 6e64 206e 6f74 2069  stable and not i
-00001a10: 6e74 656e 6465 6420 666f 7220 726f 756e  ntended for roun
-00001a20: 6474 7269 7073 2e0a 0a20 2020 2020 2020  dtrips...       
-00001a30: 2053 6565 2061 6c73 6f0a 2020 2020 2020   See also.      
-00001a40: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-00001a50: 2020 2043 6c69 656e 742e 6475 6d70 5f63     Client.dump_c
-00001a60: 6c75 7374 6572 5f73 7461 7465 0a20 2020  luster_state.   
-00001a70: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
-00001a80: 2e75 7469 6c73 2e72 6563 7572 7369 7665  .utils.recursive
-00001a90: 5f74 6f5f 6469 6374 0a20 2020 2020 2020  _to_dict.       
-00001aa0: 2054 6173 6b53 7461 7465 2e5f 746f 5f64   TaskState._to_d
-00001ab0: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
-00001ac0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00001ad0: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
-00001ae0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00001af0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-00001b00: 6578 636c 7564 653d 7365 7428 6578 636c  exclude=set(excl
-00001b10: 7564 6529 207c 207b 2276 6572 7369 6f6e  ude) | {"version
-00001b20: 7322 7d2c 2020 2320 7479 7065 3a20 6967  s"},  # type: ig
-00001b30: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-00001b40: 206d 656d 6265 7273 3d54 7275 652c 0a20   members=True,. 
-00001b50: 2020 2020 2020 2029 0a0a 0a63 6c61 7373         )...class
-00001b60: 204d 656d 6f72 7953 7461 7465 3a0a 2020   MemoryState:.  
-00001b70: 2020 2222 224d 656d 6f72 7920 7265 6164    """Memory read
-00001b80: 696e 6773 206f 6e20 6120 776f 726b 6572  ings on a worker
-00001b90: 206f 7220 6f6e 2074 6865 2077 686f 6c65   or on the whole
-00001ba0: 2063 6c75 7374 6572 2e0a 0a20 2020 2053   cluster...    S
-00001bb0: 6565 203a 646f 633a 6077 6f72 6b65 722d  ee :doc:`worker-
-00001bc0: 6d65 6d6f 7279 602e 0a0a 2020 2020 4174  memory`...    At
-00001bd0: 7472 6962 7574 6573 202f 2070 726f 7065  tributes / prope
-00001be0: 7274 6965 733a 0a0a 2020 2020 6d61 6e61  rties:..    mana
-00001bf0: 6765 645f 746f 7461 6c0a 2020 2020 2020  ged_total.      
-00001c00: 2020 5375 6d20 6f66 2074 6865 206f 7574    Sum of the out
-00001c10: 7075 7420 6f66 2073 697a 656f 6628 2920  put of sizeof() 
-00001c20: 666f 7220 616c 6c20 6461 736b 206b 6579  for all dask key
-00001c30: 7320 6865 6c64 2062 7920 7468 6520 776f  s held by the wo
-00001c40: 726b 6572 2069 6e20 6d65 6d6f 7279 2c0a  rker in memory,.
-00001c50: 2020 2020 2020 2020 706c 7573 206e 756d          plus num
-00001c60: 6265 7220 6f66 2062 7974 6573 2073 7069  ber of bytes spi
-00001c70: 6c6c 6564 2074 6f20 6469 736b 0a0a 2020  lled to disk..  
-00001c80: 2020 6d61 6e61 6765 640a 2020 2020 2020    managed.      
-00001c90: 2020 5375 6d20 6f66 2074 6865 206f 7574    Sum of the out
-00001ca0: 7075 7420 6f66 2073 697a 656f 6628 2920  put of sizeof() 
-00001cb0: 666f 7220 7468 6520 6461 736b 206b 6579  for the dask key
-00001cc0: 7320 6865 6c64 2069 6e20 5241 4d2e 204e  s held in RAM. N
-00001cd0: 6f74 6520 7468 6174 2074 6869 7320 6d61  ote that this ma
-00001ce0: 790a 2020 2020 2020 2020 6265 2069 6e61  y.        be ina
-00001cf0: 6363 7572 6174 652c 2077 6869 6368 206d  ccurate, which m
-00001d00: 6179 2063 6175 7365 2069 6e61 6363 7572  ay cause inaccur
-00001d10: 6174 6520 756e 6d61 6e61 6765 6420 6d65  ate unmanaged me
-00001d20: 6d6f 7279 2028 7365 6520 6265 6c6f 7729  mory (see below)
-00001d30: 2e0a 0a20 2020 2073 7069 6c6c 6564 0a20  ...    spilled. 
-00001d40: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
-00001d50: 2062 7974 6573 2020 666f 7220 7468 6520   bytes  for the 
-00001d60: 6461 736b 206b 6579 7320 7370 696c 6c65  dask keys spille
-00001d70: 6420 746f 2074 6865 2068 6172 6420 6472  d to the hard dr
-00001d80: 6976 652e 0a20 2020 2020 2020 204e 6f74  ive..        Not
-00001d90: 6520 7468 6174 2074 6869 7320 6973 2074  e that this is t
-00001da0: 6865 2073 697a 6520 6f6e 2064 6973 6b3b  he size on disk;
-00001db0: 2073 697a 6520 696e 206d 656d 6f72 7920   size in memory 
-00001dc0: 6d61 7920 6265 2064 6966 6665 7265 6e74  may be different
-00001dd0: 2064 7565 2074 6f0a 2020 2020 2020 2020   due to.        
-00001de0: 636f 6d70 7265 7373 696f 6e20 616e 6420  compression and 
-00001df0: 696e 6163 6375 7261 6369 6573 2069 6e20  inaccuracies in 
-00001e00: 7369 7a65 6f66 2829 2e20 496e 206f 7468  sizeof(). In oth
-00001e10: 6572 2077 6f72 6473 2c20 6769 7665 6e20  er words, given 
-00001e20: 7468 6520 7361 6d65 206b 6579 732c 0a20  the same keys,. 
-00001e30: 2020 2020 2020 2027 6d61 6e61 6765 6427         'managed'
-00001e40: 2077 696c 6c20 6368 616e 6765 2064 6570   will change dep
-00001e50: 656e 6469 6e67 206f 6e20 7468 6520 6b65  ending on the ke
-00001e60: 7973 2062 6569 6e67 2069 6e20 6d65 6d6f  ys being in memo
-00001e70: 7279 206f 7220 7370 696c 6c65 642e 0a0a  ry or spilled...
-00001e80: 2020 2020 7072 6f63 6573 730a 2020 2020      process.    
-00001e90: 2020 2020 546f 7461 6c20 5253 5320 6d65      Total RSS me
-00001ea0: 6d6f 7279 206d 6561 7375 7265 6420 6279  mory measured by
-00001eb0: 2074 6865 204f 5320 6f6e 2074 6865 2077   the OS on the w
-00001ec0: 6f72 6b65 7220 7072 6f63 6573 732e 0a20  orker process.. 
-00001ed0: 2020 2020 2020 2054 6869 7320 6973 2061         This is a
-00001ee0: 6c77 6179 7320 6578 6163 746c 7920 6571  lways exactly eq
-00001ef0: 7561 6c20 746f 206d 616e 6167 6564 202b  ual to managed +
-00001f00: 2075 6e6d 616e 6167 6564 2e0a 0a20 2020   unmanaged...   
-00001f10: 2075 6e6d 616e 6167 6564 0a20 2020 2020   unmanaged.     
-00001f20: 2020 2070 726f 6365 7373 202d 206d 616e     process - man
-00001f30: 6167 6564 2e20 5468 6973 2069 7320 7468  aged. This is th
-00001f40: 6520 7375 6d20 6f66 0a0a 2020 2020 2020  e sum of..      
-00001f50: 2020 2d20 5079 7468 6f6e 2069 6e74 6572    - Python inter
-00001f60: 7072 6574 6572 2061 6e64 206d 6f64 756c  preter and modul
-00001f70: 6573 0a20 2020 2020 2020 202d 2067 6c6f  es.        - glo
-00001f80: 6261 6c20 7661 7269 6162 6c65 730a 2020  bal variables.  
-00001f90: 2020 2020 2020 2d20 6d65 6d6f 7279 2074        - memory t
-00001fa0: 656d 706f 7261 7269 6c79 2061 6c6c 6f63  emporarily alloc
-00001fb0: 6174 6564 2062 7920 7468 6520 6461 736b  ated by the dask
-00001fc0: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
-00001fd0: 6375 7272 656e 746c 7920 7275 6e6e 696e  currently runnin
-00001fe0: 670a 2020 2020 2020 2020 2d20 6d65 6d6f  g.        - memo
-00001ff0: 7279 2066 7261 676d 656e 7461 7469 6f6e  ry fragmentation
-00002000: 0a20 2020 2020 2020 202d 206d 656d 6f72  .        - memor
-00002010: 7920 6c65 616b 730a 2020 2020 2020 2020  y leaks.        
-00002020: 2d20 6d65 6d6f 7279 206e 6f74 2079 6574  - memory not yet
-00002030: 2067 6172 6261 6765 2063 6f6c 6c65 6374   garbage collect
-00002040: 6564 0a20 2020 2020 2020 202d 206d 656d  ed.        - mem
-00002050: 6f72 7920 6e6f 7420 7965 7420 6672 6565  ory not yet free
-00002060: 2829 2764 2062 7920 7468 6520 5079 7468  ()'d by the Pyth
-00002070: 6f6e 206d 656d 6f72 7920 6d61 6e61 6765  on memory manage
-00002080: 7220 746f 2074 6865 204f 530a 0a20 2020  r to the OS..   
-00002090: 2075 6e6d 616e 6167 6564 5f6f 6c64 0a20   unmanaged_old. 
-000020a0: 2020 2020 2020 204d 696e 696d 756d 206f         Minimum o
-000020b0: 6620 7468 6520 2775 6e6d 616e 6167 6564  f the 'unmanaged
-000020c0: 2720 6d65 6173 7572 6573 206f 7665 7220  ' measures over 
-000020d0: 7468 6520 6c61 7374 0a20 2020 2020 2020  the last.       
-000020e0: 2060 6064 6973 7472 6962 7574 6564 2e6d   ``distributed.m
-000020f0: 656d 6f72 792e 7265 6365 6e74 2d74 6f2d  emory.recent-to-
-00002100: 6f6c 642d 7469 6d65 6060 2073 6563 6f6e  old-time`` secon
-00002110: 6473 0a0a 2020 2020 756e 6d61 6e61 6765  ds..    unmanage
-00002120: 645f 7265 6365 6e74 0a20 2020 2020 2020  d_recent.       
-00002130: 2075 6e6d 616e 6167 6564 202d 2075 6e6d   unmanaged - unm
-00002140: 616e 6167 6564 5f6f 6c64 3b20 696e 206f  anaged_old; in o
-00002150: 7468 6572 2077 6f72 6473 2070 726f 6365  ther words proce
-00002160: 7373 206d 656d 6f72 7920 7468 6174 2068  ss memory that h
-00002170: 6173 2062 6565 6e20 7265 6365 6e74 6c79  as been recently
-00002180: 0a20 2020 2020 2020 2061 6c6c 6f63 6174  .        allocat
-00002190: 6564 2062 7574 2069 7320 6e6f 7420 6163  ed but is not ac
-000021a0: 636f 756e 7465 6420 666f 7220 6279 2064  counted for by d
-000021b0: 6173 6b3b 2068 6f70 6566 756c 6c79 2069  ask; hopefully i
-000021c0: 7427 7320 6d6f 7374 6c79 2061 2074 656d  t's mostly a tem
-000021d0: 706f 7261 7279 0a20 2020 2020 2020 2073  porary.        s
-000021e0: 7069 6b65 2e0a 0a20 2020 206f 7074 696d  pike...    optim
-000021f0: 6973 7469 630a 2020 2020 2020 2020 6d61  istic.        ma
-00002200: 6e61 6765 6420 2b20 756e 6d61 6e61 6765  naged + unmanage
-00002210: 645f 6f6c 643b 2069 6e20 6f74 6865 7220  d_old; in other 
-00002220: 776f 7264 7320 7468 6520 6d65 6d6f 7279  words the memory
-00002230: 2068 656c 6420 6c6f 6e67 2d74 6572 6d20   held long-term 
-00002240: 6279 0a20 2020 2020 2020 2074 6865 2070  by.        the p
-00002250: 726f 6365 7373 2075 6e64 6572 2074 6865  rocess under the
-00002260: 2068 6f70 6566 756c 2061 7373 756d 7074   hopeful assumpt
-00002270: 696f 6e20 7468 6174 2061 6c6c 2075 6e6d  ion that all unm
-00002280: 616e 6167 6564 5f72 6563 656e 7420 6d65  anaged_recent me
-00002290: 6d6f 7279 2069 7320 610a 2020 2020 2020  mory is a.      
-000022a0: 2020 7465 6d70 6f72 6172 7920 7370 696b    temporary spik
-000022b0: 650a 2020 2020 2222 220a 0a20 2020 2070  e.    """..    p
-000022c0: 726f 6365 7373 3a20 696e 740a 2020 2020  rocess: int.    
-000022d0: 756e 6d61 6e61 6765 645f 6f6c 643a 2069  unmanaged_old: i
-000022e0: 6e74 0a20 2020 206d 616e 6167 6564 3a20  nt.    managed: 
-000022f0: 696e 740a 2020 2020 7370 696c 6c65 643a  int.    spilled:
-00002300: 2069 6e74 0a0a 2020 2020 5f5f 736c 6f74   int..    __slot
-00002310: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-00002320: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-00002330: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
-00002340: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00002350: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00002360: 2070 726f 6365 7373 3a20 696e 742c 0a20   process: int,. 
-00002370: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
-00002380: 5f6f 6c64 3a20 696e 742c 0a20 2020 2020  _old: int,.     
-00002390: 2020 206d 616e 6167 6564 3a20 696e 742c     managed: int,
-000023a0: 0a20 2020 2020 2020 2073 7069 6c6c 6564  .        spilled
-000023b0: 3a20 696e 742c 0a20 2020 2029 3a0a 2020  : int,.    ):.  
-000023c0: 2020 2020 2020 2320 536f 6d65 2064 6174        # Some dat
-000023d0: 6120 6172 7269 7665 7320 7769 7468 2074  a arrives with t
-000023e0: 6865 2068 6561 7274 6265 6174 2c20 736f  he heartbeat, so
-000023f0: 6d65 206f 7468 6572 2061 7272 6976 6573  me other arrives
-00002400: 2069 6e20 7265 616c 7469 6d65 2061 7320   in realtime as 
-00002410: 7468 650a 2020 2020 2020 2020 2320 7461  the.        # ta
-00002420: 736b 7320 7072 6f67 7265 7373 2e20 416c  sks progress. Al
-00002430: 736f 2c20 7369 7a65 6f66 2829 2069 7320  so, sizeof() is 
-00002440: 6e6f 7420 6775 6172 616e 7465 6564 2074  not guaranteed t
-00002450: 6f20 7265 7475 726e 2063 6f72 7265 6374  o return correct
-00002460: 2072 6573 756c 7473 2e0a 2020 2020 2020   results..      
-00002470: 2020 2320 5468 6973 2063 616e 2063 6175    # This can cau
-00002480: 7365 2067 6c69 7463 6865 7320 7768 6572  se glitches wher
-00002490: 6520 6120 7061 7274 6961 6c20 6d65 6173  e a partial meas
-000024a0: 7572 6520 6973 206c 6172 6765 7220 7468  ure is larger th
-000024b0: 616e 2074 6865 2077 686f 6c65 2c20 736f  an the whole, so
-000024c0: 0a20 2020 2020 2020 2023 2077 6520 6e65  .        # we ne
-000024d0: 6564 2074 6f20 666f 7263 6520 616c 6c20  ed to force all 
-000024e0: 6e75 6d62 6572 7320 746f 2061 6464 2075  numbers to add u
-000024f0: 7020 6578 6163 746c 7920 6279 2064 6566  p exactly by def
-00002500: 696e 6974 696f 6e2e 0a20 2020 2020 2020  inition..       
-00002510: 2073 656c 662e 7072 6f63 6573 7320 3d20   self.process = 
-00002520: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-00002530: 7365 6c66 2e6d 616e 6167 6564 203d 206d  self.managed = m
-00002540: 696e 2873 656c 662e 7072 6f63 6573 732c  in(self.process,
-00002550: 206d 616e 6167 6564 290a 2020 2020 2020   managed).      
-00002560: 2020 7365 6c66 2e73 7069 6c6c 6564 203d    self.spilled =
-00002570: 2073 7069 6c6c 6564 0a20 2020 2020 2020   spilled.       
-00002580: 2023 2053 7562 7472 6163 7469 6f6e 7320   # Subtractions 
-00002590: 6265 7477 6565 6e20 756e 7369 676e 6564  between unsigned
-000025a0: 2069 6e74 7320 6775 6172 616e 7465 6564   ints guaranteed
-000025b0: 2062 7920 636f 6e73 7472 7563 7469 6f6e   by construction
-000025c0: 2074 6f20 6265 203e 3d20 300a 2020 2020   to be >= 0.    
-000025d0: 2020 2020 7365 6c66 2e75 6e6d 616e 6167      self.unmanag
-000025e0: 6564 5f6f 6c64 203d 206d 696e 2875 6e6d  ed_old = min(unm
-000025f0: 616e 6167 6564 5f6f 6c64 2c20 7072 6f63  anaged_old, proc
-00002600: 6573 7320 2d20 7365 6c66 2e6d 616e 6167  ess - self.manag
-00002610: 6564 290a 0a20 2020 2040 7374 6174 6963  ed)..    @static
-00002620: 6d65 7468 6f64 0a20 2020 2064 6566 2073  method.    def s
-00002630: 756d 282a 696e 666f 733a 204d 656d 6f72  um(*infos: Memor
-00002640: 7953 7461 7465 2920 2d3e 204d 656d 6f72  yState) -> Memor
-00002650: 7953 7461 7465 3a0a 2020 2020 2020 2020  yState:.        
-00002660: 7072 6f63 6573 7320 3d20 300a 2020 2020  process = 0.    
-00002670: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
-00002680: 6420 3d20 300a 2020 2020 2020 2020 6d61  d = 0.        ma
-00002690: 6e61 6765 6420 3d20 300a 2020 2020 2020  naged = 0.      
-000026a0: 2020 7370 696c 6c65 6420 3d20 300a 2020    spilled = 0.  
-000026b0: 2020 2020 2020 666f 7220 6d73 2069 6e20        for ms in 
-000026c0: 696e 666f 733a 0a20 2020 2020 2020 2020  infos:.         
-000026d0: 2020 2070 726f 6365 7373 202b 3d20 6d73     process += ms
-000026e0: 2e70 726f 6365 7373 0a20 2020 2020 2020  .process.       
-000026f0: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
-00002700: 6c64 202b 3d20 6d73 2e75 6e6d 616e 6167  ld += ms.unmanag
-00002710: 6564 5f6f 6c64 0a20 2020 2020 2020 2020  ed_old.         
-00002720: 2020 2073 7069 6c6c 6564 202b 3d20 6d73     spilled += ms
-00002730: 2e73 7069 6c6c 6564 0a20 2020 2020 2020  .spilled.       
-00002740: 2020 2020 206d 616e 6167 6564 202b 3d20       managed += 
-00002750: 6d73 2e6d 616e 6167 6564 0a20 2020 2020  ms.managed.     
-00002760: 2020 2072 6574 7572 6e20 4d65 6d6f 7279     return Memory
-00002770: 5374 6174 6528 0a20 2020 2020 2020 2020  State(.         
-00002780: 2020 2070 726f 6365 7373 3d70 726f 6365     process=proce
-00002790: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000027a0: 756e 6d61 6e61 6765 645f 6f6c 643d 756e  unmanaged_old=un
-000027b0: 6d61 6e61 6765 645f 6f6c 642c 0a20 2020  managed_old,.   
-000027c0: 2020 2020 2020 2020 206d 616e 6167 6564           managed
-000027d0: 3d6d 616e 6167 6564 2c0a 2020 2020 2020  =managed,.      
-000027e0: 2020 2020 2020 7370 696c 6c65 643d 7370        spilled=sp
-000027f0: 696c 6c65 642c 0a20 2020 2020 2020 2029  illed,.        )
-00002800: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00002810: 2020 2020 6465 6620 6d61 6e61 6765 645f      def managed_
-00002820: 746f 7461 6c28 7365 6c66 2920 2d3e 2069  total(self) -> i
-00002830: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
-00002840: 726e 2073 656c 662e 6d61 6e61 6765 6420  rn self.managed 
-00002850: 2b20 7365 6c66 2e73 7069 6c6c 6564 0a0a  + self.spilled..
-00002860: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00002870: 2020 6465 6620 756e 6d61 6e61 6765 6428    def unmanaged(
-00002880: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
-00002890: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
-000028a0: 6e65 7665 7220 6e65 6761 7469 7665 2074  never negative t
-000028b0: 6861 6e6b 7320 746f 205f 5f69 6e69 745f  hanks to __init_
-000028c0: 5f0a 2020 2020 2020 2020 7265 7475 726e  _.        return
-000028d0: 2073 656c 662e 7072 6f63 6573 7320 2d20   self.process - 
-000028e0: 7365 6c66 2e6d 616e 6167 6564 0a0a 2020  self.managed..  
-000028f0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00002900: 6465 6620 756e 6d61 6e61 6765 645f 7265  def unmanaged_re
-00002910: 6365 6e74 2873 656c 6629 202d 3e20 696e  cent(self) -> in
-00002920: 743a 0a20 2020 2020 2020 2023 2054 6869  t:.        # Thi
-00002930: 7320 6973 206e 6576 6572 206e 6567 6174  s is never negat
-00002940: 6976 6520 7468 616e 6b73 2074 6f20 5f5f  ive thanks to __
-00002950: 696e 6974 5f5f 0a20 2020 2020 2020 2072  init__.        r
-00002960: 6574 7572 6e20 7365 6c66 2e70 726f 6365  eturn self.proce
-00002970: 7373 202d 2073 656c 662e 6d61 6e61 6765  ss - self.manage
-00002980: 6420 2d20 7365 6c66 2e75 6e6d 616e 6167  d - self.unmanag
-00002990: 6564 5f6f 6c64 0a0a 2020 2020 4070 726f  ed_old..    @pro
-000029a0: 7065 7274 790a 2020 2020 6465 6620 6f70  perty.    def op
-000029b0: 7469 6d69 7374 6963 2873 656c 6629 202d  timistic(self) -
-000029c0: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
-000029d0: 6574 7572 6e20 7365 6c66 2e6d 616e 6167  eturn self.manag
-000029e0: 6564 202b 2073 656c 662e 756e 6d61 6e61  ed + self.unmana
-000029f0: 6765 645f 6f6c 640a 0a20 2020 2040 7072  ged_old..    @pr
-00002a00: 6f70 6572 7479 0a20 2020 2064 6566 206d  operty.    def m
-00002a10: 616e 6167 6564 5f69 6e5f 6d65 6d6f 7279  anaged_in_memory
-00002a20: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
-00002a30: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
-00002a40: 7761 726e 2822 6d61 6e61 6765 645f 696e  warn("managed_in
-00002a50: 5f6d 656d 6f72 7920 6861 7320 6265 656e  _memory has been
-00002a60: 2072 656e 616d 6564 2074 6f20 6d61 6e61   renamed to mana
-00002a70: 6765 6422 2c20 4675 7475 7265 5761 726e  ged", FutureWarn
-00002a80: 696e 6729 0a20 2020 2020 2020 2072 6574  ing).        ret
-00002a90: 7572 6e20 7365 6c66 2e6d 616e 6167 6564  urn self.managed
-00002aa0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00002ab0: 2020 2020 6465 6620 6d61 6e61 6765 645f      def managed_
-00002ac0: 7370 696c 6c65 6428 7365 6c66 2920 2d3e  spilled(self) ->
-00002ad0: 2069 6e74 3a0a 2020 2020 2020 2020 7761   int:.        wa
-00002ae0: 726e 696e 6773 2e77 6172 6e28 226d 616e  rnings.warn("man
-00002af0: 6167 6564 5f73 7069 6c6c 6564 2068 6173  aged_spilled has
-00002b00: 2062 6565 6e20 7265 6e61 6d65 6420 746f   been renamed to
-00002b10: 2073 7069 6c6c 6564 222c 2046 7574 7572   spilled", Futur
-00002b20: 6557 6172 6e69 6e67 290a 2020 2020 2020  eWarning).      
-00002b30: 2020 7265 7475 726e 2073 656c 662e 7370    return self.sp
-00002b40: 696c 6c65 640a 0a20 2020 2064 6566 205f  illed..    def _
-00002b50: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
-00002b60: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
-00002b70: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-00002b80: 2020 2066 2250 726f 6365 7373 206d 656d     f"Process mem
-00002b90: 6f72 7920 2852 5353 2920 203a 207b 666f  ory (RSS)  : {fo
-00002ba0: 726d 6174 5f62 7974 6573 2873 656c 662e  rmat_bytes(self.
-00002bb0: 7072 6f63 6573 7329 7d5c 6e22 0a20 2020  process)}\n".   
-00002bc0: 2020 2020 2020 2020 2066 2220 202d 206d           f"  - m
-00002bd0: 616e 6167 6564 2062 7920 4461 736b 2020  anaged by Dask  
-00002be0: 203a 207b 666f 726d 6174 5f62 7974 6573   : {format_bytes
-00002bf0: 2873 656c 662e 6d61 6e61 6765 6429 7d5c  (self.managed)}\
-00002c00: 6e22 0a20 2020 2020 2020 2020 2020 2066  n".            f
-00002c10: 2220 202d 2075 6e6d 616e 6167 6564 2028  "  - unmanaged (
-00002c20: 6f6c 6429 2020 203a 207b 666f 726d 6174  old)   : {format
-00002c30: 5f62 7974 6573 2873 656c 662e 756e 6d61  _bytes(self.unma
-00002c40: 6e61 6765 645f 6f6c 6429 7d5c 6e22 0a20  naged_old)}\n". 
-00002c50: 2020 2020 2020 2020 2020 2066 2220 202d             f"  -
-00002c60: 2075 6e6d 616e 6167 6564 2028 7265 6365   unmanaged (rece
-00002c70: 6e74 293a 207b 666f 726d 6174 5f62 7974  nt): {format_byt
-00002c80: 6573 2873 656c 662e 756e 6d61 6e61 6765  es(self.unmanage
-00002c90: 645f 7265 6365 6e74 297d 5c6e 220a 2020  d_recent)}\n".  
-00002ca0: 2020 2020 2020 2020 2020 6622 5370 696c            f"Spil
-00002cb0: 6c65 6420 746f 2064 6973 6b20 2020 2020  led to disk     
-00002cc0: 2020 3a20 7b66 6f72 6d61 745f 6279 7465    : {format_byte
-00002cd0: 7328 7365 6c66 2e73 7069 6c6c 6564 297d  s(self.spilled)}
-00002ce0: 5c6e 220a 2020 2020 2020 2020 290a 0a20  \n".        ).. 
-00002cf0: 2020 2064 6566 205f 746f 5f64 6963 7428     def _to_dict(
-00002d00: 7365 6c66 2c20 2a2c 2065 7863 6c75 6465  self, *, exclude
-00002d10: 3a20 436f 6e74 6169 6e65 725b 7374 725d  : Container[str]
-00002d20: 203d 2028 2929 202d 3e20 6469 6374 3a0a   = ()) -> dict:.
-00002d30: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
-00002d40: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
-00002d50: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
-00002d60: 6e67 2070 7572 706f 7365 732e 0a0a 2020  ng purposes...  
-00002d70: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
-00002d80: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
-00002d90: 2020 2020 2020 2020 436c 6965 6e74 2e64          Client.d
-00002da0: 756d 705f 636c 7573 7465 725f 7374 6174  ump_cluster_stat
-00002db0: 650a 2020 2020 2020 2020 6469 7374 7269  e.        distri
-00002dc0: 6275 7465 642e 7574 696c 732e 7265 6375  buted.utils.recu
-00002dd0: 7273 6976 655f 746f 5f64 6963 740a 2020  rsive_to_dict.  
-00002de0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00002df0: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-00002e00: 2020 2020 2020 206b 3a20 6765 7461 7474         k: getatt
-00002e10: 7228 7365 6c66 2c20 6b29 0a20 2020 2020  r(self, k).     
-00002e20: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
-00002e30: 6469 7228 7365 6c66 290a 2020 2020 2020  dir(self).      
-00002e40: 2020 2020 2020 6966 206e 6f74 206b 2e73        if not k.s
-00002e50: 7461 7274 7377 6974 6828 225f 2229 0a20  tartswith("_"). 
-00002e60: 2020 2020 2020 2020 2020 2061 6e64 206b             and k
-00002e70: 206e 6f74 2069 6e20 7b22 7375 6d22 2c20   not in {"sum", 
-00002e80: 226d 616e 6167 6564 5f69 6e5f 6d65 6d6f  "managed_in_memo
-00002e90: 7279 222c 2022 6d61 6e61 6765 645f 7370  ry", "managed_sp
-00002ea0: 696c 6c65 6422 7d0a 2020 2020 2020 2020  illed"}.        
-00002eb0: 7d0a 0a0a 636c 6173 7320 576f 726b 6572  }...class Worker
-00002ec0: 5374 6174 653a 0a20 2020 2022 2222 4120  State:.    """A 
-00002ed0: 7369 6d70 6c65 206f 626a 6563 7420 686f  simple object ho
-00002ee0: 6c64 696e 6720 696e 666f 726d 6174 696f  lding informatio
-00002ef0: 6e20 6162 6f75 7420 6120 776f 726b 6572  n about a worker
-00002f00: 2e0a 0a20 2020 204e 6f74 2074 6f20 6265  ...    Not to be
-00002f10: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
-00002f20: 636c 6173 733a 6064 6973 7472 6962 7574  class:`distribut
-00002f30: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
-00002f40: 6d61 6368 696e 652e 576f 726b 6572 5374  machine.WorkerSt
-00002f50: 6174 6560 2e0a 2020 2020 2222 220a 0a20  ate`..    """.. 
-00002f60: 2020 2023 3a20 5468 6973 2077 6f72 6b65     #: This worke
-00002f70: 7227 7320 756e 6971 7565 206b 6579 2e20  r's unique key. 
-00002f80: 5468 6973 2063 616e 2062 6520 6974 7320  This can be its 
-00002f90: 636f 6e6e 6563 7465 6420 6164 6472 6573  connected addres
-00002fa0: 730a 2020 2020 233a 2028 7375 6368 2061  s.    #: (such a
-00002fb0: 7320 6060 2274 6370 3a2f 2f31 3237 2e30  s ``"tcp://127.0
-00002fc0: 2e30 2e31 3a38 3839 3122 6060 2920 6f72  .0.1:8891"``) or
-00002fd0: 2061 6e20 616c 6961 7320 2873 7563 6820   an alias (such 
-00002fe0: 6173 2060 6022 616c 6963 6522 6060 292e  as ``"alice"``).
-00002ff0: 0a20 2020 2061 6464 7265 7373 3a20 7374  .    address: st
-00003000: 720a 0a20 2020 2070 6964 3a20 696e 740a  r..    pid: int.
-00003010: 2020 2020 6e61 6d65 3a20 4861 7368 6162      name: Hashab
-00003020: 6c65 0a0a 2020 2020 233a 2054 6865 206e  le..    #: The n
-00003030: 756d 6265 7220 6f66 2043 5055 2074 6872  umber of CPU thr
-00003040: 6561 6473 206d 6164 6520 6176 6169 6c61  eads made availa
-00003050: 626c 6520 6f6e 2074 6869 7320 776f 726b  ble on this work
-00003060: 6572 0a20 2020 206e 7468 7265 6164 733a  er.    nthreads:
-00003070: 2069 6e74 0a0a 2020 2020 233a 204d 656d   int..    #: Mem
-00003080: 6f72 7920 6176 6169 6c61 626c 6520 746f  ory available to
-00003090: 2074 6865 2077 6f72 6b65 722c 2069 6e20   the worker, in 
-000030a0: 6279 7465 730a 2020 2020 6d65 6d6f 7279  bytes.    memory
-000030b0: 5f6c 696d 6974 3a20 696e 740a 0a20 2020  _limit: int..   
-000030c0: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
-000030d0: 3a20 7374 720a 2020 2020 7365 7276 6963  : str.    servic
-000030e0: 6573 3a20 6469 6374 5b73 7472 2c20 696e  es: dict[str, in
-000030f0: 745d 0a0a 2020 2020 233a 204f 7574 7075  t]..    #: Outpu
-00003100: 7420 6f66 203a 6d65 7468 3a60 6469 7374  t of :meth:`dist
-00003110: 7269 6275 7465 642e 7665 7273 696f 6e73  ributed.versions
-00003120: 2e67 6574 5f76 6572 7369 6f6e 7360 206f  .get_versions` o
-00003130: 6e20 7468 6520 776f 726b 6572 0a20 2020  n the worker.   
-00003140: 2076 6572 7369 6f6e 733a 2064 6963 745b   versions: dict[
-00003150: 7374 722c 2041 6e79 5d0a 0a20 2020 2023  str, Any]..    #
-00003160: 3a20 4164 6472 6573 7320 6f66 2074 6865  : Address of the
-00003170: 2061 7373 6f63 6961 7465 6420 3a63 6c61   associated :cla
-00003180: 7373 3a60 7e64 6973 7472 6962 7574 6564  ss:`~distributed
-00003190: 2e6e 616e 6e79 2e4e 616e 6e79 602c 2069  .nanny.Nanny`, i
-000031a0: 6620 7072 6573 656e 740a 2020 2020 6e61  f present.    na
-000031b0: 6e6e 793a 2073 7472 0a0a 2020 2020 233a  nny: str..    #:
-000031c0: 2052 6561 642d 6f6e 6c79 2077 6f72 6b65   Read-only worke
-000031d0: 7220 7374 6174 7573 2c20 7379 6e63 6564  r status, synced
-000031e0: 206f 6e65 2077 6179 2066 726f 6d20 7468   one way from th
-000031f0: 6520 7265 6d6f 7465 2057 6f72 6b65 7220  e remote Worker 
-00003200: 6f62 6a65 6374 0a20 2020 2073 7461 7475  object.    statu
-00003210: 733a 2053 7461 7475 730a 0a20 2020 2023  s: Status..    #
-00003220: 3a20 4361 6368 6564 2068 6173 6820 6f66  : Cached hash of
-00003230: 203a 6174 7472 3a60 7e57 6f72 6b65 7253   :attr:`~WorkerS
-00003240: 7461 7465 2e61 6464 7265 7373 600a 2020  tate.address`.  
-00003250: 2020 5f68 6173 683a 2069 6e74 0a0a 2020    _hash: int..  
-00003260: 2020 233a 2054 6865 2074 6f74 616c 206d    #: The total m
-00003270: 656d 6f72 7920 7369 7a65 2c20 696e 2062  emory size, in b
-00003280: 7974 6573 2c20 7573 6564 2062 7920 7468  ytes, used by th
-00003290: 6520 7461 736b 7320 7468 6973 2077 6f72  e tasks this wor
-000032a0: 6b65 7220 686f 6c64 7320 696e 206d 656d  ker holds in mem
-000032b0: 6f72 790a 2020 2020 233a 2028 692e 652e  ory.    #: (i.e.
-000032c0: 2074 6865 2074 6173 6b73 2069 6e20 7468   the tasks in th
-000032d0: 6973 2077 6f72 6b65 7227 7320 3a61 7474  is worker's :att
-000032e0: 723a 607e 576f 726b 6572 5374 6174 652e  r:`~WorkerState.
-000032f0: 6861 735f 7768 6174 6029 2e0a 2020 2020  has_what`)..    
-00003300: 6e62 7974 6573 3a20 696e 740a 0a20 2020  nbytes: int..   
-00003310: 2023 3a20 576f 726b 6572 206d 656d 6f72   #: Worker memor
-00003320: 7920 756e 6b6e 6f77 6e20 746f 2074 6865  y unknown to the
-00003330: 2077 6f72 6b65 722c 2069 6e20 6279 7465   worker, in byte
-00003340: 732c 2077 6869 6368 2068 6173 2062 6565  s, which has bee
-00003350: 6e20 7468 6572 6520 666f 7220 6d6f 7265  n there for more
-00003360: 2074 6861 6e0a 2020 2020 233a 2033 3020   than.    #: 30 
-00003370: 7365 636f 6e64 732e 2053 6565 203a 636c  seconds. See :cl
-00003380: 6173 733a 604d 656d 6f72 7953 7461 7465  ass:`MemoryState
-00003390: 602e 0a20 2020 205f 6d65 6d6f 7279 5f75  `..    _memory_u
-000033a0: 6e6d 616e 6167 6564 5f6f 6c64 3a20 696e  nmanaged_old: in
-000033b0: 740a 0a20 2020 2023 3a20 4869 7374 6f72  t..    #: Histor
-000033c0: 7920 6f66 2074 6865 206c 6173 7420 3330  y of the last 30
-000033d0: 2073 6563 6f6e 6473 2720 776f 7274 6820   seconds' worth 
-000033e0: 6f66 2075 6e6d 616e 6167 6564 206d 656d  of unmanaged mem
-000033f0: 6f72 792e 2055 7365 6420 746f 2064 6966  ory. Used to dif
-00003400: 6665 7265 6e74 6961 7465 0a20 2020 2023  ferentiate.    #
-00003410: 3a20 6265 7477 6565 6e20 226f 6c64 2220  : between "old" 
-00003420: 616e 6420 226e 6577 2220 756e 6d61 6e61  and "new" unmana
-00003430: 6765 6420 6d65 6d6f 7279 2e0a 2020 2020  ged memory..    
-00003440: 233a 2046 6f72 6d61 743a 2060 605b 2874  #: Format: ``[(t
-00003450: 696d 6573 7461 6d70 2c20 6279 7465 7329  imestamp, bytes)
-00003460: 2c20 2874 696d 6573 7461 6d70 2c20 6279  , (timestamp, by
-00003470: 7465 7329 2c20 2e2e 2e5d 6060 0a20 2020  tes), ...]``.   
-00003480: 205f 6d65 6d6f 7279 5f75 6e6d 616e 6167   _memory_unmanag
-00003490: 6564 5f68 6973 746f 7279 3a20 6465 7175  ed_history: dequ
-000034a0: 655b 7475 706c 655b 666c 6f61 742c 2069  e[tuple[float, i
-000034b0: 6e74 5d5d 0a0a 2020 2020 6d65 7472 6963  nt]]..    metric
-000034c0: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
-000034d0: 5d0a 0a20 2020 2023 3a20 5468 6520 6c61  ]..    #: The la
-000034e0: 7374 2074 696d 6520 7765 2072 6563 6569  st time we recei
-000034f0: 7665 6420 6120 6865 6172 7462 6561 7420  ved a heartbeat 
-00003500: 6672 6f6d 2074 6869 7320 776f 726b 6572  from this worker
-00003510: 2c20 696e 206c 6f63 616c 2073 6368 6564  , in local sched
-00003520: 756c 6572 2074 696d 652e 0a20 2020 206c  uler time..    l
-00003530: 6173 745f 7365 656e 3a20 666c 6f61 740a  ast_seen: float.
-00003540: 0a20 2020 2074 696d 655f 6465 6c61 793a  .    time_delay:
-00003550: 2066 6c6f 6174 0a20 2020 2062 616e 6477   float.    bandw
-00003560: 6964 7468 3a20 666c 6f61 740a 0a20 2020  idth: float..   
-00003570: 2023 3a20 4120 7365 7420 6f66 2061 6c6c   #: A set of all
-00003580: 2054 6173 6b53 7461 7465 7320 6f6e 2074   TaskStates on t
-00003590: 6869 7320 776f 726b 6572 2074 6861 7420  his worker that 
-000035a0: 6172 6520 6163 746f 7273 2e20 5468 6973  are actors. This
-000035b0: 206f 6e6c 7920 696e 636c 7564 6573 2074   only includes t
-000035c0: 686f 7365 0a20 2020 2023 3a20 6163 746f  hose.    #: acto
-000035d0: 7273 2077 686f 7365 2073 7461 7465 2061  rs whose state a
-000035e0: 6374 7561 6c6c 7920 6c69 7665 7320 6f6e  ctually lives on
-000035f0: 2074 6869 7320 776f 726b 6572 2c20 6e6f   this worker, no
-00003600: 7420 6163 746f 7273 2074 6f20 7768 6963  t actors to whic
-00003610: 6820 7468 6973 2077 6f72 6b65 720a 2020  h this worker.  
-00003620: 2020 233a 2068 6173 2061 2072 6566 6572    #: has a refer
-00003630: 656e 6365 2e0a 2020 2020 6163 746f 7273  ence..    actors
-00003640: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
-00003650: 0a0a 2020 2020 233a 2055 6e64 6572 6c79  ..    #: Underly
-00003660: 696e 6720 6461 7461 206f 6620 3a6d 6574  ing data of :met
-00003670: 683a 6057 6f72 6b65 7253 7461 7465 2e68  h:`WorkerState.h
-00003680: 6173 5f77 6861 7460 0a20 2020 205f 6861  as_what`.    _ha
-00003690: 735f 7768 6174 3a20 6469 6374 5b54 6173  s_what: dict[Tas
-000036a0: 6b53 7461 7465 2c20 4e6f 6e65 5d0a 0a20  kState, None].. 
-000036b0: 2020 2023 3a20 4120 7365 7420 6f66 2074     #: A set of t
-000036c0: 6173 6b73 2074 6861 7420 6861 7665 2062  asks that have b
-000036d0: 6565 6e20 7375 626d 6974 7465 6420 746f  een submitted to
-000036e0: 2074 6869 7320 776f 726b 6572 2e20 4d75   this worker. Mu
-000036f0: 6c74 6970 6c65 2074 6173 6b73 206d 6179  ltiple tasks may
-00003700: 2062 650a 2020 2020 2320 7375 626d 6974   be.    # submit
-00003710: 7465 6420 746f 2061 2077 6f72 6b65 7220  ted to a worker 
-00003720: 696e 2061 6476 616e 6365 2061 6e64 2074  in advance and t
-00003730: 6865 2077 6f72 6b65 7220 7769 6c6c 2072  he worker will r
-00003740: 756e 2074 6865 6d20 6576 656e 7475 616c  un them eventual
-00003750: 6c79 2c0a 2020 2020 2320 6465 7065 6e64  ly,.    # depend
-00003760: 696e 6720 6f6e 2069 7473 2065 7865 6375  ing on its execu
-00003770: 7469 6f6e 2072 6573 6f75 7263 6573 2028  tion resources (
-00003780: 6275 7420 7365 6520 3a64 6f63 3a60 776f  but see :doc:`wo
-00003790: 726b 2d73 7465 616c 696e 6760 292e 0a20  rk-stealing`).. 
-000037a0: 2020 2023 3a0a 2020 2020 233a 2041 6c6c     #:.    #: All
-000037b0: 2074 6865 2074 6173 6b73 2068 6572 6520   the tasks here 
-000037c0: 6172 6520 696e 2074 6865 2022 7072 6f63  are in the "proc
-000037d0: 6573 7369 6e67 2220 7374 6174 652e 0a20  essing" state.. 
-000037e0: 2020 2023 3a20 5468 6973 2061 7474 7269     #: This attri
-000037f0: 6275 7465 2069 7320 6b65 7074 2069 6e20  bute is kept in 
-00003800: 7379 6e63 2077 6974 6820 3a61 7474 723a  sync with :attr:
-00003810: 6054 6173 6b53 7461 7465 2e70 726f 6365  `TaskState.proce
-00003820: 7373 696e 675f 6f6e 602e 0a20 2020 2070  ssing_on`..    p
-00003830: 726f 6365 7373 696e 673a 2073 6574 5b54  rocessing: set[T
-00003840: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
-00003850: 3a20 5275 6e6e 696e 6720 7461 736b 7320  : Running tasks 
-00003860: 7468 6174 2069 6e76 6f6b 6564 203a 6675  that invoked :fu
-00003870: 6e63 3a60 6469 7374 7269 6275 7465 642e  nc:`distributed.
-00003880: 7365 6365 6465 600a 2020 2020 6c6f 6e67  secede`.    long
-00003890: 5f72 756e 6e69 6e67 3a20 7365 745b 5461  _running: set[Ta
-000038a0: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
-000038b0: 2041 2064 6963 7469 6f6e 6172 7920 6f66   A dictionary of
-000038c0: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
-000038d0: 6375 7272 656e 746c 7920 6265 696e 6720  currently being 
-000038e0: 7275 6e20 6f6e 2074 6869 7320 776f 726b  run on this work
-000038f0: 6572 2e0a 2020 2020 233a 2045 6163 6820  er..    #: Each 
-00003900: 7461 736b 2073 7461 7465 2069 7320 6173  task state is as
-00003910: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
-00003920: 6520 6475 7261 7469 6f6e 2069 6e20 7365  e duration in se
-00003930: 636f 6e64 7320 7768 6963 6820 7468 6520  conds which the 
-00003940: 7461 736b 2068 6173 0a20 2020 2023 3a20  task has.    #: 
-00003950: 6265 656e 2072 756e 6e69 6e67 2e0a 2020  been running..  
-00003960: 2020 6578 6563 7574 696e 673a 2064 6963    executing: dic
-00003970: 745b 5461 736b 5374 6174 652c 2066 6c6f  t[TaskState, flo
-00003980: 6174 5d0a 0a20 2020 2023 3a20 5468 6520  at]..    #: The 
-00003990: 6176 6169 6c61 626c 6520 7265 736f 7572  available resour
-000039a0: 6365 7320 6f6e 2074 6869 7320 776f 726b  ces on this work
-000039b0: 6572 2c20 652e 672e 2060 607b 2247 5055  er, e.g. ``{"GPU
-000039c0: 223a 2032 7d60 602e 0a20 2020 2023 3a20  ": 2}``..    #: 
-000039d0: 5468 6573 6520 6172 6520 6162 7374 7261  These are abstra
-000039e0: 6374 2071 7561 6e74 6974 6965 7320 7468  ct quantities th
-000039f0: 6174 2063 6f6e 7374 7261 696e 2063 6572  at constrain cer
-00003a00: 7461 696e 2074 6173 6b73 2066 726f 6d20  tain tasks from 
-00003a10: 7275 6e6e 696e 6720 6174 2074 6865 0a20  running at the. 
-00003a20: 2020 2023 3a20 7361 6d65 2074 696d 6520     #: same time 
-00003a30: 6f6e 2074 6869 7320 776f 726b 6572 2e0a  on this worker..
-00003a40: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
-00003a50: 6963 745b 7374 722c 2066 6c6f 6174 5d0a  ict[str, float].
-00003a60: 0a20 2020 2023 3a20 5468 6520 7375 6d20  .    #: The sum 
-00003a70: 6f66 2065 6163 6820 7265 736f 7572 6365  of each resource
-00003a80: 2075 7365 6420 6279 2061 6c6c 2074 6173   used by all tas
-00003a90: 6b73 2061 6c6c 6f63 6174 6564 2074 6f20  ks allocated to 
-00003aa0: 7468 6973 2077 6f72 6b65 722e 0a20 2020  this worker..   
-00003ab0: 2023 3a20 5468 6520 6e75 6d62 6572 7320   #: The numbers 
-00003ac0: 696e 2074 6869 7320 6469 6374 696f 6e61  in this dictiona
-00003ad0: 7279 2063 616e 206f 6e6c 7920 6265 206c  ry can only be l
-00003ae0: 6573 7320 6f72 2065 7175 616c 2074 6861  ess or equal tha
-00003af0: 6e20 7468 6f73 6520 696e 2074 6869 730a  n those in this.
-00003b00: 2020 2020 233a 2077 6f72 6b65 7227 7320      #: worker's 
-00003b10: 3a61 7474 723a 607e 576f 726b 6572 5374  :attr:`~WorkerSt
-00003b20: 6174 652e 7265 736f 7572 6365 7360 2e0a  ate.resources`..
-00003b30: 2020 2020 7573 6564 5f72 6573 6f75 7263      used_resourc
-00003b40: 6573 3a20 6469 6374 5b73 7472 2c20 666c  es: dict[str, fl
-00003b50: 6f61 745d 0a0a 2020 2020 233a 2041 7262  oat]..    #: Arb
-00003b60: 6974 7261 7279 2061 6464 6974 696f 6e61  itrary additiona
-00003b70: 6c20 6d65 7461 6461 7461 2074 6f20 6265  l metadata to be
-00003b80: 2061 6464 6564 2074 6f20 3a6d 6574 683a   added to :meth:
-00003b90: 607e 576f 726b 6572 5374 6174 652e 6964  `~WorkerState.id
-00003ba0: 656e 7469 7479 600a 2020 2020 6578 7472  entity`.    extr
-00003bb0: 613a 2064 6963 745b 7374 722c 2041 6e79  a: dict[str, Any
-00003bc0: 5d0a 0a20 2020 2023 2054 6865 2075 6e69  ]..    # The uni
-00003bd0: 7175 6520 7365 7276 6572 2049 4420 7468  que server ID th
-00003be0: 6973 2057 6f72 6b65 7253 7461 7465 2069  is WorkerState i
-00003bf0: 7320 7265 6665 7265 6e63 696e 670a 2020  s referencing.  
-00003c00: 2020 7365 7276 6572 5f69 643a 2073 7472    server_id: str
-00003c10: 0a0a 2020 2020 2320 5265 6665 7265 6e63  ..    # Referenc
-00003c20: 6520 746f 2073 6368 6564 756c 6572 2074  e to scheduler t
-00003c30: 6173 6b5f 6772 6f75 7073 0a20 2020 2073  ask_groups.    s
-00003c40: 6368 6564 756c 6572 5f72 6566 3a20 7765  cheduler_ref: we
-00003c50: 616b 7265 662e 7265 665b 5363 6865 6475  akref.ref[Schedu
-00003c60: 6c65 7253 7461 7465 5d20 7c20 4e6f 6e65  lerState] | None
-00003c70: 0a20 2020 2074 6173 6b5f 7072 6566 6978  .    task_prefix
-00003c80: 5f63 6f75 6e74 3a20 6465 6661 756c 7464  _count: defaultd
-00003c90: 6963 745b 7374 722c 2069 6e74 5d0a 2020  ict[str, int].  
-00003ca0: 2020 5f6e 6574 776f 726b 5f6f 6363 3a20    _network_occ: 
-00003cb0: 666c 6f61 740a 2020 2020 5f6f 6363 7570  float.    _occup
-00003cc0: 616e 6379 5f63 6163 6865 3a20 666c 6f61  ancy_cache: floa
-00003cd0: 7420 7c20 4e6f 6e65 0a0a 2020 2020 233a  t | None..    #:
-00003ce0: 204b 6579 7320 7468 6174 206d 6179 206e   Keys that may n
-00003cf0: 6565 6420 746f 2062 6520 6665 7463 6865  eed to be fetche
-00003d00: 6420 746f 2074 6869 7320 776f 726b 6572  d to this worker
-00003d10: 2c20 616e 6420 7468 6520 6e75 6d62 6572  , and the number
-00003d20: 206f 6620 7461 736b 7320 7468 6174 206e   of tasks that n
-00003d30: 6565 6420 7468 656d 2e0a 2020 2020 233a  eed them..    #:
-00003d40: 2041 6c6c 2074 6173 6b73 2061 7265 2063   All tasks are c
-00003d50: 7572 7265 6e74 6c79 2069 6e20 606d 656d  urrently in `mem
-00003d60: 6f72 7960 206f 6e20 6120 776f 726b 6572  ory` on a worker
-00003d70: 206f 7468 6572 2074 6861 6e20 7468 6973   other than this
-00003d80: 206f 6e65 2e0a 2020 2020 233a 204d 7563   one..    #: Muc
-00003d90: 6820 6c69 6b65 2060 7072 6f63 6573 7369  h like `processi
-00003da0: 6e67 602c 2074 6869 7320 646f 6573 206e  ng`, this does n
-00003db0: 6f74 2065 7861 6374 6c79 2072 6566 6c65  ot exactly refle
-00003dc0: 6374 2077 6f72 6b65 7220 7374 6174 653a  ct worker state:
-00003dd0: 0a20 2020 2023 3a20 6b65 7973 2068 6572  .    #: keys her
-00003de0: 6520 6d61 7920 6265 2071 7565 7565 6420  e may be queued 
-00003df0: 746f 2066 6574 6368 2c20 696e 2066 6c69  to fetch, in fli
-00003e00: 6768 742c 206f 7220 616c 7265 6164 7920  ght, or already 
-00003e10: 696e 206d 656d 6f72 790a 2020 2020 233a  in memory.    #:
-00003e20: 206f 6e20 7468 6520 776f 726b 6572 2e0a   on the worker..
-00003e30: 2020 2020 6e65 6564 735f 7768 6174 3a20      needs_what: 
-00003e40: 6469 6374 5b54 6173 6b53 7461 7465 2c20  dict[TaskState, 
-00003e50: 696e 745d 0a0a 2020 2020 5f5f 736c 6f74  int]..    __slot
-00003e60: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-00003e70: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-00003e80: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
-00003e90: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00003ea0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00003eb0: 2061 6464 7265 7373 3a20 7374 722c 0a20   address: str,. 
-00003ec0: 2020 2020 2020 2073 7461 7475 733a 2053         status: S
-00003ed0: 7461 7475 732c 0a20 2020 2020 2020 2070  tatus,.        p
-00003ee0: 6964 3a20 696e 742c 0a20 2020 2020 2020  id: int,.       
-00003ef0: 206e 616d 653a 206f 626a 6563 742c 0a20   name: object,. 
-00003f00: 2020 2020 2020 206e 7468 7265 6164 733a         nthreads:
-00003f10: 2069 6e74 203d 2030 2c0a 2020 2020 2020   int = 0,.      
-00003f20: 2020 6d65 6d6f 7279 5f6c 696d 6974 3a20    memory_limit: 
-00003f30: 696e 742c 0a20 2020 2020 2020 206c 6f63  int,.        loc
-00003f40: 616c 5f64 6972 6563 746f 7279 3a20 7374  al_directory: st
-00003f50: 722c 0a20 2020 2020 2020 206e 616e 6e79  r,.        nanny
-00003f60: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
-00003f70: 6572 7665 725f 6964 3a20 7374 722c 0a20  erver_id: str,. 
-00003f80: 2020 2020 2020 2073 6572 7669 6365 733a         services:
-00003f90: 2064 6963 745b 7374 722c 2069 6e74 5d20   dict[str, int] 
-00003fa0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00003fb0: 2020 2020 2020 2076 6572 7369 6f6e 733a         versions:
-00003fc0: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
-00003fd0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00003fe0: 2020 2020 2020 2065 7874 7261 3a20 6469         extra: di
-00003ff0: 6374 5b73 7472 2c20 416e 795d 207c 204e  ct[str, Any] | N
-00004000: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00004010: 2020 2020 7363 6865 6475 6c65 723a 2053      scheduler: S
-00004020: 6368 6564 756c 6572 5374 6174 6520 7c20  chedulerState | 
-00004030: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00004040: 2029 3a0a 2020 2020 2020 2020 7365 6c66   ):.        self
-00004050: 2e73 6572 7665 725f 6964 203d 2073 6572  .server_id = ser
-00004060: 7665 725f 6964 0a20 2020 2020 2020 2073  ver_id.        s
-00004070: 656c 662e 6164 6472 6573 7320 3d20 6164  elf.address = ad
-00004080: 6472 6573 730a 2020 2020 2020 2020 7365  dress.        se
-00004090: 6c66 2e70 6964 203d 2070 6964 0a20 2020  lf.pid = pid.   
-000040a0: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
-000040b0: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
-000040c0: 6c66 2e6e 7468 7265 6164 7320 3d20 6e74  lf.nthreads = nt
-000040d0: 6872 6561 6473 0a20 2020 2020 2020 2073  hreads.        s
-000040e0: 656c 662e 6d65 6d6f 7279 5f6c 696d 6974  elf.memory_limit
-000040f0: 203d 206d 656d 6f72 795f 6c69 6d69 740a   = memory_limit.
-00004100: 2020 2020 2020 2020 7365 6c66 2e6c 6f63          self.loc
-00004110: 616c 5f64 6972 6563 746f 7279 203d 206c  al_directory = l
-00004120: 6f63 616c 5f64 6972 6563 746f 7279 0a20  ocal_directory. 
-00004130: 2020 2020 2020 2073 656c 662e 7365 7276         self.serv
-00004140: 6963 6573 203d 2073 6572 7669 6365 7320  ices = services 
-00004150: 6f72 207b 7d0a 2020 2020 2020 2020 7365  or {}.        se
-00004160: 6c66 2e76 6572 7369 6f6e 7320 3d20 7665  lf.versions = ve
-00004170: 7273 696f 6e73 206f 7220 7b7d 0a20 2020  rsions or {}.   
-00004180: 2020 2020 2073 656c 662e 6e61 6e6e 7920       self.nanny 
-00004190: 3d20 6e61 6e6e 790a 2020 2020 2020 2020  = nanny.        
-000041a0: 7365 6c66 2e73 7461 7475 7320 3d20 7374  self.status = st
-000041b0: 6174 7573 0a20 2020 2020 2020 2073 656c  atus.        sel
-000041c0: 662e 5f68 6173 6820 3d20 6861 7368 2873  f._hash = hash(s
-000041d0: 656c 662e 7365 7276 6572 5f69 6429 0a20  elf.server_id). 
-000041e0: 2020 2020 2020 2073 656c 662e 6e62 7974         self.nbyt
-000041f0: 6573 203d 2030 0a20 2020 2020 2020 2073  es = 0.        s
-00004200: 656c 662e 5f6d 656d 6f72 795f 756e 6d61  elf._memory_unma
-00004210: 6e61 6765 645f 6f6c 6420 3d20 300a 2020  naged_old = 0.  
-00004220: 2020 2020 2020 7365 6c66 2e5f 6d65 6d6f        self._memo
-00004230: 7279 5f75 6e6d 616e 6167 6564 5f68 6973  ry_unmanaged_his
-00004240: 746f 7279 203d 2064 6571 7565 2829 0a20  tory = deque(). 
-00004250: 2020 2020 2020 2073 656c 662e 6d65 7472         self.metr
-00004260: 6963 7320 3d20 7b7d 0a20 2020 2020 2020  ics = {}.       
-00004270: 2073 656c 662e 6c61 7374 5f73 6565 6e20   self.last_seen 
-00004280: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-00004290: 2e74 696d 655f 6465 6c61 7920 3d20 300a  .time_delay = 0.
-000042a0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-000042b0: 6477 6964 7468 203d 2070 6172 7365 5f62  dwidth = parse_b
-000042c0: 7974 6573 2864 6173 6b2e 636f 6e66 6967  ytes(dask.config
-000042d0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-000042e0: 642e 7363 6865 6475 6c65 722e 6261 6e64  d.scheduler.band
-000042f0: 7769 6474 6822 2929 0a20 2020 2020 2020  width")).       
-00004300: 2073 656c 662e 6163 746f 7273 203d 2073   self.actors = s
-00004310: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00004320: 662e 5f68 6173 5f77 6861 7420 3d20 7b7d  f._has_what = {}
-00004330: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
-00004340: 6f63 6573 7369 6e67 203d 2073 6574 2829  ocessing = set()
-00004350: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00004360: 6e67 5f72 756e 6e69 6e67 203d 2073 6574  ng_running = set
-00004370: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00004380: 6578 6563 7574 696e 6720 3d20 7b7d 0a20  executing = {}. 
-00004390: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
-000043a0: 7572 6365 7320 3d20 7b7d 0a20 2020 2020  urces = {}.     
-000043b0: 2020 2073 656c 662e 7573 6564 5f72 6573     self.used_res
-000043c0: 6f75 7263 6573 203d 207b 7d0a 2020 2020  ources = {}.    
-000043d0: 2020 2020 7365 6c66 2e65 7874 7261 203d      self.extra =
-000043e0: 2065 7874 7261 206f 7220 7b7d 0a20 2020   extra or {}.   
-000043f0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00004400: 6c65 725f 7265 6620 3d20 7765 616b 7265  ler_ref = weakre
-00004410: 662e 7265 6628 7363 6865 6475 6c65 7229  f.ref(scheduler)
-00004420: 2069 6620 7363 6865 6475 6c65 7220 656c   if scheduler el
-00004430: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
-00004440: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
-00004450: 5f63 6f75 6e74 203d 2064 6566 6175 6c74  _count = default
-00004460: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
-00004470: 2020 7365 6c66 2e6e 6565 6473 5f77 6861    self.needs_wha
-00004480: 7420 3d20 7b7d 0a20 2020 2020 2020 2073  t = {}.        s
-00004490: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
-000044a0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-000044b0: 662e 5f6f 6363 7570 616e 6379 5f63 6163  f._occupancy_cac
-000044c0: 6865 203d 204e 6f6e 650a 0a20 2020 2064  he = None..    d
-000044d0: 6566 205f 5f68 6173 685f 5f28 7365 6c66  ef __hash__(self
-000044e0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-000044f0: 2020 7265 7475 726e 2073 656c 662e 5f68    return self._h
-00004500: 6173 680a 0a20 2020 2064 6566 205f 5f65  ash..    def __e
-00004510: 715f 5f28 7365 6c66 2c20 6f74 6865 723a  q__(self, other:
-00004520: 206f 626a 6563 7429 202d 3e20 626f 6f6c   object) -> bool
-00004530: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00004540: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
-00004550: 722c 2057 6f72 6b65 7253 7461 7465 2920  r, WorkerState) 
-00004560: 616e 6420 6f74 6865 722e 7365 7276 6572  and other.server
-00004570: 5f69 6420 3d3d 2073 656c 662e 7365 7276  _id == self.serv
-00004580: 6572 5f69 640a 0a20 2020 2040 7072 6f70  er_id..    @prop
-00004590: 6572 7479 0a20 2020 2064 6566 2068 6173  erty.    def has
-000045a0: 5f77 6861 7428 7365 6c66 2920 2d3e 2053  _what(self) -> S
-000045b0: 6574 5b54 6173 6b53 7461 7465 5d3a 0a20  et[TaskState]:. 
-000045c0: 2020 2020 2020 2022 2222 416e 2069 6e73         """An ins
-000045d0: 6572 7469 6f6e 2d73 6f72 7465 6420 7365  ertion-sorted se
-000045e0: 742d 6c69 6b65 206f 6620 7461 736b 7320  t-like of tasks 
-000045f0: 7768 6963 6820 6375 7272 656e 746c 7920  which currently 
-00004600: 7265 7369 6465 206f 6e20 7468 6973 2077  reside on this w
-00004610: 6f72 6b65 722e 0a20 2020 2020 2020 2041  orker..        A
-00004620: 6c6c 2074 6865 2074 6173 6b73 2068 6572  ll the tasks her
-00004630: 6520 6172 6520 696e 2074 6865 2022 6d65  e are in the "me
-00004640: 6d6f 7279 2220 7374 6174 652e 0a20 2020  mory" state..   
-00004650: 2020 2020 2054 6869 7320 6973 2074 6865       This is the
-00004660: 2072 6576 6572 7365 206d 6170 7069 6e67   reverse mapping
-00004670: 206f 6620 3a61 7474 723a 6054 6173 6b53   of :attr:`TaskS
-00004680: 7461 7465 2e77 686f 5f68 6173 602e 0a0a  tate.who_has`...
-00004690: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
-000046a0: 6120 7265 6164 2d6f 6e6c 7920 7075 626c  a read-only publ
-000046b0: 6963 2061 6363 6573 736f 722e 2054 6865  ic accessor. The
-000046c0: 2064 6174 6120 6973 2069 6d70 6c65 6d65   data is impleme
-000046d0: 6e74 6564 2061 7320 6120 6469 6374 2077  nted as a dict w
-000046e0: 6974 686f 7574 0a20 2020 2020 2020 2076  ithout.        v
-000046f0: 616c 7565 732c 2062 6563 6175 7365 2072  alues, because r
-00004700: 6562 616c 616e 6365 2829 2072 656c 6965  ebalance() relie
-00004710: 7320 6f6e 2064 6963 7473 2062 6569 6e67  s on dicts being
-00004720: 2069 6e73 6572 7469 6f6e 2d73 6f72 7465   insertion-sorte
-00004730: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
-00004740: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00004750: 6c66 2e5f 6861 735f 7768 6174 2e6b 6579  lf._has_what.key
-00004760: 7328 290a 0a20 2020 2040 7072 6f70 6572  s()..    @proper
-00004770: 7479 0a20 2020 2064 6566 2068 6f73 7428  ty.    def host(
-00004780: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-00004790: 2020 2020 2020 7265 7475 726e 2067 6574        return get
-000047a0: 5f61 6464 7265 7373 5f68 6f73 7428 7365  _address_host(se
-000047b0: 6c66 2e61 6464 7265 7373 290a 0a20 2020  lf.address)..   
-000047c0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-000047d0: 6566 206d 656d 6f72 7928 7365 6c66 2920  ef memory(self) 
-000047e0: 2d3e 204d 656d 6f72 7953 7461 7465 3a0a  -> MemoryState:.
-000047f0: 2020 2020 2020 2020 2222 2250 6f6c 6973          """Polis
-00004800: 6865 6420 6d65 6d6f 7279 206d 6574 7269  hed memory metri
-00004810: 6373 2066 6f72 2074 6865 2077 6f72 6b65  cs for the worke
-00004820: 722e 0a0a 2020 2020 2020 2020 2a2a 4465  r...        **De
-00004830: 7369 676e 206e 6f74 6520 6f6e 206d 616e  sign note on man
-00004840: 6167 6564 206d 656d 6f72 792a 2a0a 0a20  aged memory**.. 
-00004850: 2020 2020 2020 2054 6865 7265 2061 7265         There are
-00004860: 2074 776f 206d 6561 7375 7265 7320 6176   two measures av
-00004870: 6169 6c61 626c 6520 666f 7220 6d61 6e61  ailable for mana
-00004880: 6765 6420 6d65 6d6f 7279 3a0a 0a20 2020  ged memory:..   
-00004890: 2020 2020 202d 2060 6073 656c 662e 6e62       - ``self.nb
-000048a0: 7974 6573 6060 0a20 2020 2020 2020 202d  ytes``.        -
-000048b0: 2060 6073 656c 662e 6d65 7472 6963 735b   ``self.metrics[
-000048c0: 226d 616e 6167 6564 5f62 7974 6573 225d  "managed_bytes"]
-000048d0: 6060 0a0a 2020 2020 2020 2020 4174 2072  ``..        At r
-000048e0: 6573 742c 2074 6865 2074 776f 206e 756d  est, the two num
-000048f0: 6265 7273 206d 7573 7420 6265 2069 6465  bers must be ide
-00004900: 6e74 6963 616c 2e20 486f 7765 7665 722c  ntical. However,
-00004910: 2060 6073 656c 662e 6e62 7974 6573 6060   ``self.nbytes``
-00004920: 2069 730a 2020 2020 2020 2020 696d 6d65   is.        imme
-00004930: 6469 6174 656c 7920 7570 6461 7465 6420  diately updated 
-00004940: 7468 726f 7567 6820 7468 6520 6261 7463  through the batc
-00004950: 6865 6420 636f 6d6d 7320 6173 2073 6f6f  hed comms as soo
-00004960: 6e20 6173 2065 6163 6820 7461 736b 206c  n as each task l
-00004970: 616e 6473 2069 6e0a 2020 2020 2020 2020  ands in.        
-00004980: 6d65 6d6f 7279 206f 6e20 7468 6520 776f  memory on the wo
-00004990: 726b 6572 3b20 6060 7365 6c66 2e6d 6574  rker; ``self.met
-000049a0: 7269 6373 5b22 6d61 6e61 6765 645f 6279  rics["managed_by
-000049b0: 7465 7322 5d60 6020 696e 7374 6561 6420  tes"]`` instead 
-000049c0: 6973 2075 7064 6174 6564 2062 790a 2020  is updated by.  
-000049d0: 2020 2020 2020 7468 6520 6865 6172 7462        the heartb
-000049e0: 6561 742c 2077 6869 6368 2063 616e 206c  eat, which can l
-000049f0: 6167 2073 6576 6572 616c 2073 6563 6f6e  ag several secon
-00004a00: 6473 2062 6568 696e 642e 0a0a 2020 2020  ds behind...    
-00004a10: 2020 2020 4265 6c6f 7720 7765 2061 7265      Below we are
-00004a20: 206d 6978 696e 6720 6c69 6b65 6c79 206e   mixing likely n
-00004a30: 6577 6572 206d 616e 6167 6564 206d 656d  ewer managed mem
-00004a40: 6f72 7920 696e 666f 2066 726f 6d20 6060  ory info from ``
-00004a50: 7365 6c66 2e6e 6279 7465 7360 6020 7769  self.nbytes`` wi
-00004a60: 7468 0a20 2020 2020 2020 2070 726f 6365  th.        proce
-00004a70: 7373 2061 6e64 2073 7069 6c6c 6564 206d  ss and spilled m
-00004a80: 656d 6f72 7920 6672 6f6d 2074 6865 2068  emory from the h
-00004a90: 6561 7274 6265 6174 2e20 5468 6973 2069  eartbeat. This i
-00004aa0: 7320 6465 6c69 6265 7261 7465 2c20 736f  s deliberate, so
-00004ab0: 2074 6861 740a 2020 2020 2020 2020 6d61   that.        ma
-00004ac0: 6e61 6765 6420 6d65 6d6f 7279 2074 6f74  naged memory tot
-00004ad0: 616c 2069 7320 7570 6461 7465 6420 6d6f  al is updated mo
-00004ae0: 7265 2066 7265 7175 656e 746c 792e 0a0a  re frequently...
-00004af0: 2020 2020 2020 2020 4d61 6e61 6765 6420          Managed 
-00004b00: 6d65 6d6f 7279 2064 6972 6563 746c 7920  memory directly 
-00004b10: 616e 6420 696d 6d65 6469 6174 656c 7920  and immediately 
-00004b20: 636f 6e74 7269 6275 7465 7320 746f 206f  contributes to o
-00004b30: 7074 696d 6973 7469 6320 6d65 6d6f 7279  ptimistic memory
-00004b40: 2c20 7768 6963 680a 2020 2020 2020 2020  , which.        
-00004b50: 6973 2069 6e20 7475 726e 2075 7365 6420  is in turn used 
-00004b60: 696e 2041 6374 6976 6520 4d65 6d6f 7279  in Active Memory
-00004b70: 204d 616e 6167 6572 2068 6575 7269 7374   Manager heurist
-00004b80: 6963 7320 2861 7420 7468 6520 6d6f 6d65  ics (at the mome
-00004b90: 6e74 206f 6620 7772 6974 696e 673b 0a20  nt of writing;. 
-00004ba0: 2020 2020 2020 206d 6f72 6520 7573 6573         more uses
-00004bb0: 2077 696c 6c20 6c69 6b65 6c79 2062 6520   will likely be 
-00004bc0: 6164 6465 6420 696e 2074 6865 2066 7574  added in the fut
-00004bd0: 7572 6529 2e20 536f 2069 7427 7320 696d  ure). So it's im
-00004be0: 706f 7274 616e 7420 746f 2068 6176 6520  portant to have 
-00004bf0: 6974 0a20 2020 2020 2020 2075 7020 746f  it.        up to
-00004c00: 2064 6174 653b 206d 7563 6820 6d6f 7265   date; much more
-00004c10: 2074 6861 6e20 6974 2069 7320 666f 7220   than it is for 
-00004c20: 7072 6f63 6573 7320 6d65 6d6f 7279 2e0a  process memory..
-00004c30: 0a20 2020 2020 2020 2048 6176 696e 6720  .        Having 
-00004c40: 7570 2d74 6f2d 6461 7465 206d 616e 6167  up-to-date manag
-00004c50: 6564 206d 656d 6f72 7920 696e 666f 2061  ed memory info a
-00004c60: 7320 736f 6f6e 2061 7320 7468 6520 7363  s soon as the sc
-00004c70: 6865 6475 6c65 7220 6c65 6172 6e73 2061  heduler learns a
-00004c80: 626f 7574 0a20 2020 2020 2020 2074 6173  bout.        tas
-00004c90: 6b20 636f 6d70 6c65 7469 6f6e 2061 6c73  k completion als
-00004ca0: 6f20 7375 6273 7461 6e74 6961 6c6c 7920  o substantially 
-00004cb0: 7369 6d70 6c69 6669 6573 2075 6e69 7420  simplifies unit 
-00004cc0: 7465 7374 732e 0a0a 2020 2020 2020 2020  tests...        
-00004cd0: 5468 6520 666c 6970 2073 6964 6520 6f66  The flip side of
-00004ce0: 2074 6869 7320 6465 7369 676e 2069 7320   this design is 
-00004cf0: 7468 6174 2069 7420 6d61 7920 6361 7573  that it may caus
-00004d00: 6520 736f 6d65 206e 6f69 7365 2069 6e20  e some noise in 
-00004d10: 7468 650a 2020 2020 2020 2020 756e 6d61  the.        unma
-00004d20: 6e61 6765 645f 7265 6365 6e74 206d 6561  naged_recent mea
-00004d30: 7375 7265 2e20 652e 672e 3a0a 0a20 2020  sure. e.g.:..   
-00004d40: 2020 2020 2031 2e20 4465 6c65 7465 2031       1. Delete 1
-00004d50: 3030 4d42 206f 6620 6d61 6e61 6765 6420  00MB of managed 
-00004d60: 6461 7461 0a20 2020 2020 2020 2032 2e20  data.        2. 
-00004d70: 5468 6520 7570 6461 7465 6420 6d61 6e61  The updated mana
-00004d80: 6765 6420 6d65 6d6f 7279 2072 6561 6368  ged memory reach
-00004d90: 6573 2074 6865 2073 6368 6564 756c 6572  es the scheduler
-00004da0: 2066 6173 7465 7220 7468 616e 2074 6865   faster than the
-00004db0: 0a20 2020 2020 2020 2020 2020 7570 6461  .           upda
-00004dc0: 7465 6420 7072 6f63 6573 7320 6d65 6d6f  ted process memo
-00004dd0: 7279 0a20 2020 2020 2020 2033 2e20 5468  ry.        3. Th
-00004de0: 6572 6527 7320 6120 626c 6970 2077 6865  ere's a blip whe
-00004df0: 7265 2074 6865 2073 6368 6564 756c 6572  re the scheduler
-00004e00: 2074 6869 6e6b 7320 7468 6174 2074 6865   thinks that the
-00004e10: 7265 2773 2061 2073 7564 6465 6e20 3130  re's a sudden 10
-00004e20: 304d 420a 2020 2020 2020 2020 2020 2069  0MB.           i
-00004e30: 6e63 7265 6173 6520 696e 2075 6e6d 616e  ncrease in unman
-00004e40: 6167 6564 5f72 6563 656e 742c 2073 696e  aged_recent, sin
-00004e50: 6365 2070 726f 6365 7373 206d 656d 6f72  ce process memor
-00004e60: 7920 6861 736e 2774 2063 6861 6e67 6564  y hasn't changed
-00004e70: 2062 7574 206d 616e 6167 6564 0a20 2020   but managed.   
-00004e80: 2020 2020 2020 2020 6d65 6d6f 7279 2068          memory h
-00004e90: 6173 2064 6563 7265 6173 6564 2062 7920  as decreased by 
-00004ea0: 3130 304d 420a 2020 2020 2020 2020 342e  100MB.        4.
-00004eb0: 2057 6865 6e20 7468 6520 6865 6172 7462   When the heartb
-00004ec0: 6561 7420 6172 7269 7665 732c 2070 726f  eat arrives, pro
-00004ed0: 6365 7373 206d 656d 6f72 7920 676f 6573  cess memory goes
-00004ee0: 2064 6f77 6e20 616e 6420 736f 2064 6f65   down and so doe
-00004ef0: 7320 7468 650a 2020 2020 2020 2020 2020  s the.          
-00004f00: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
-00004f10: 742e 0a0a 2020 2020 2020 2020 5468 6973  t...        This
-00004f20: 2069 7320 4f4b 202d 206f 6e65 206f 6620   is OK - one of 
-00004f30: 7468 6520 6d61 696e 2072 6561 736f 6e73  the main reasons
-00004f40: 2066 6f72 2074 6865 2075 6e6d 616e 6167   for the unmanag
-00004f50: 6564 5f72 6563 656e 7420 2f20 756e 6d61  ed_recent / unma
-00004f60: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
-00004f70: 2020 7370 6c69 7420 6973 2065 7861 6374    split is exact
-00004f80: 6c79 2074 6f20 636f 6e63 656e 7472 6174  ly to concentrat
-00004f90: 6520 616c 6c20 7468 6520 6e6f 6973 6520  e all the noise 
-00004fa0: 696e 2075 6e6d 616e 6167 6564 5f72 6563  in unmanaged_rec
-00004fb0: 656e 7420 616e 6420 6578 636c 7564 6520  ent and exclude 
-00004fc0: 6974 0a20 2020 2020 2020 2066 726f 6d20  it.        from 
-00004fd0: 6f70 7469 6d69 7374 6963 206d 656d 6f72  optimistic memor
-00004fe0: 792c 2077 6869 6368 2069 7320 7573 6564  y, which is used
-00004ff0: 2066 6f72 2068 6575 7269 7374 6963 732e   for heuristics.
-00005000: 0a0a 2020 2020 2020 2020 536f 6d65 7468  ..        Someth
-00005010: 696e 6720 7468 6174 2069 7320 6c65 7373  ing that is less
-00005020: 204f 4b2c 2062 7574 2061 6c73 6f20 6c65   OK, but also le
-00005030: 7373 2066 7265 7175 656e 742c 2069 7320  ss frequent, is 
-00005040: 7468 6174 2074 6865 2073 7564 6465 6e20  that the sudden 
-00005050: 6465 6c65 7469 6f6e 0a20 2020 2020 2020  deletion.       
-00005060: 206f 6620 7370 696c 6c65 6420 6b65 7973   of spilled keys
-00005070: 2077 696c 6c20 6361 7573 6520 6120 6e65   will cause a ne
-00005080: 6761 7469 7665 2062 6c69 7020 696e 206d  gative blip in m
-00005090: 616e 6167 6564 206d 656d 6f72 793a 0a0a  anaged memory:..
-000050a0: 2020 2020 2020 2020 312e 2044 656c 6574          1. Delet
-000050b0: 6520 3130 304d 4220 6f66 2073 7069 6c6c  e 100MB of spill
-000050c0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
-000050d0: 322e 2054 6865 2075 7064 6174 6564 206d  2. The updated m
-000050e0: 616e 6167 6564 206d 656d 6f72 7920 2a74  anaged memory *t
-000050f0: 6f74 616c 2a20 7265 6163 6865 7320 7468  otal* reaches th
-00005100: 6520 7363 6865 6475 6c65 7220 6661 7374  e scheduler fast
-00005110: 6572 2074 6861 6e20 7468 650a 2020 2020  er than the.    
-00005120: 2020 2020 2020 2075 7064 6174 6564 2073         updated s
-00005130: 7069 6c6c 6564 2070 6f72 7469 6f6e 0a20  pilled portion. 
-00005140: 2020 2020 2020 2033 2e20 5468 6973 2063         3. This c
-00005150: 6175 7365 7320 7468 6520 6d61 6e61 6765  auses the manage
-00005160: 6420 6d65 6d6f 7279 2074 6f20 7465 6d70  d memory to temp
-00005170: 6f72 6172 696c 7920 706c 756d 6d65 7420  orarily plummet 
-00005180: 616e 6420 6265 2072 6570 6c61 6365 6420  and be replaced 
-00005190: 6279 0a20 2020 2020 2020 2020 2020 756e  by.           un
-000051a0: 6d61 6e61 6765 645f 7265 6365 6e74 2c20  managed_recent, 
-000051b0: 7768 696c 6520 7370 696c 6c65 6420 6d65  while spilled me
-000051c0: 6d6f 7279 2072 656d 6169 6e73 2075 6e61  mory remains una
-000051d0: 6c74 6572 6564 0a20 2020 2020 2020 2034  ltered.        4
-000051e0: 2e20 5768 656e 2074 6865 2068 6561 7274  . When the heart
-000051f0: 6265 6174 2061 7272 6976 6573 2c20 6d61  beat arrives, ma
-00005200: 6e61 6765 6420 676f 6573 2062 6163 6b20  naged goes back 
-00005210: 7570 2c20 756e 6d61 6e61 6765 645f 7265  up, unmanaged_re
-00005220: 6365 6e74 0a20 2020 2020 2020 2020 2020  cent.           
-00005230: 676f 6573 2062 6163 6b20 646f 776e 2c20  goes back down, 
-00005240: 616e 6420 7370 696c 6c65 6420 676f 6573  and spilled goes
-00005250: 2064 6f77 6e20 6279 2031 3030 4d42 2061   down by 100MB a
-00005260: 7320 6974 2073 686f 756c 6420 6861 7665  s it should have
-00005270: 2074 6f0a 2020 2020 2020 2020 2020 2062   to.           b
-00005280: 6567 696e 2077 6974 682e 0a0a 2020 2020  egin with...    
-00005290: 2020 2020 3a69 7373 7565 3a60 3630 3032      :issue:`6002
-000052a0: 6020 7769 6c6c 206c 6574 2075 7320 736f  ` will let us so
-000052b0: 6c76 6520 7468 6973 2e0a 2020 2020 2020  lve this..      
-000052c0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-000052d0: 7475 726e 204d 656d 6f72 7953 7461 7465  turn MemoryState
-000052e0: 280a 2020 2020 2020 2020 2020 2020 7072  (.            pr
-000052f0: 6f63 6573 733d 7365 6c66 2e6d 6574 7269  ocess=self.metri
-00005300: 6373 5b22 6d65 6d6f 7279 225d 2c0a 2020  cs["memory"],.  
-00005310: 2020 2020 2020 2020 2020 6d61 6e61 6765            manage
-00005320: 643d 6d61 7828 302c 2073 656c 662e 6e62  d=max(0, self.nb
-00005330: 7974 6573 202d 2073 656c 662e 6d65 7472  ytes - self.metr
-00005340: 6963 735b 2273 7069 6c6c 6564 5f62 7974  ics["spilled_byt
-00005350: 6573 225d 5b22 6d65 6d6f 7279 225d 292c  es"]["memory"]),
-00005360: 0a20 2020 2020 2020 2020 2020 2073 7069  .            spi
-00005370: 6c6c 6564 3d73 656c 662e 6d65 7472 6963  lled=self.metric
-00005380: 735b 2273 7069 6c6c 6564 5f62 7974 6573  s["spilled_bytes
-00005390: 225d 5b22 6469 736b 225d 2c0a 2020 2020  "]["disk"],.    
-000053a0: 2020 2020 2020 2020 756e 6d61 6e61 6765          unmanage
-000053b0: 645f 6f6c 643d 7365 6c66 2e5f 6d65 6d6f  d_old=self._memo
-000053c0: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-000053d0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-000053e0: 2064 6566 2063 6c65 616e 2873 656c 6629   def clean(self)
-000053f0: 202d 3e20 576f 726b 6572 5374 6174 653a   -> WorkerState:
-00005400: 0a20 2020 2020 2020 2022 2222 5265 7475  .        """Retu
-00005410: 726e 2061 2076 6572 7369 6f6e 206f 6620  rn a version of 
-00005420: 7468 6973 206f 626a 6563 7420 7468 6174  this object that
-00005430: 2069 7320 6170 7072 6f70 7269 6174 6520   is appropriate 
-00005440: 666f 7220 7365 7269 616c 697a 6174 696f  for serializatio
-00005450: 6e22 2222 0a20 2020 2020 2020 2077 7320  n""".        ws 
-00005460: 3d20 576f 726b 6572 5374 6174 6528 0a20  = WorkerState(. 
-00005470: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-00005480: 7373 3d73 656c 662e 6164 6472 6573 732c  ss=self.address,
-00005490: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000054a0: 7475 733d 7365 6c66 2e73 7461 7475 732c  tus=self.status,
-000054b0: 0a20 2020 2020 2020 2020 2020 2070 6964  .            pid
-000054c0: 3d73 656c 662e 7069 642c 0a20 2020 2020  =self.pid,.     
-000054d0: 2020 2020 2020 206e 616d 653d 7365 6c66         name=self
-000054e0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-000054f0: 2020 206e 7468 7265 6164 733d 7365 6c66     nthreads=self
-00005500: 2e6e 7468 7265 6164 732c 0a20 2020 2020  .nthreads,.     
-00005510: 2020 2020 2020 206d 656d 6f72 795f 6c69         memory_li
-00005520: 6d69 743d 7365 6c66 2e6d 656d 6f72 795f  mit=self.memory_
-00005530: 6c69 6d69 742c 0a20 2020 2020 2020 2020  limit,.         
-00005540: 2020 206c 6f63 616c 5f64 6972 6563 746f     local_directo
-00005550: 7279 3d73 656c 662e 6c6f 6361 6c5f 6469  ry=self.local_di
-00005560: 7265 6374 6f72 792c 0a20 2020 2020 2020  rectory,.       
-00005570: 2020 2020 2073 6572 7669 6365 733d 7365       services=se
-00005580: 6c66 2e73 6572 7669 6365 732c 0a20 2020  lf.services,.   
-00005590: 2020 2020 2020 2020 206e 616e 6e79 3d73           nanny=s
-000055a0: 656c 662e 6e61 6e6e 792c 0a20 2020 2020  elf.nanny,.     
-000055b0: 2020 2020 2020 2065 7874 7261 3d73 656c         extra=sel
-000055c0: 662e 6578 7472 612c 0a20 2020 2020 2020  f.extra,.       
-000055d0: 2020 2020 2073 6572 7665 725f 6964 3d73       server_id=s
-000055e0: 656c 662e 7365 7276 6572 5f69 642c 0a20  elf.server_id,. 
-000055f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00005600: 2077 732e 5f6f 6363 7570 616e 6379 5f63   ws._occupancy_c
-00005610: 6163 6865 203d 2073 656c 662e 6f63 6375  ache = self.occu
-00005620: 7061 6e63 790a 0a20 2020 2020 2020 2077  pancy..        w
-00005630: 732e 6578 6563 7574 696e 6720 3d20 7b0a  s.executing = {.
-00005640: 2020 2020 2020 2020 2020 2020 7473 2e6b              ts.k
-00005650: 6579 3a20 6475 7261 7469 6f6e 2066 6f72  ey: duration for
-00005660: 2074 732c 2064 7572 6174 696f 6e20 696e   ts, duration in
-00005670: 2073 656c 662e 6578 6563 7574 696e 672e   self.executing.
-00005680: 6974 656d 7328 2920 2023 2074 7970 653a  items()  # type:
-00005690: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
-000056a0: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
-000056b0: 2077 730a 0a20 2020 2064 6566 205f 5f72   ws..    def __r
-000056c0: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
-000056d0: 7472 3a0a 2020 2020 2020 2020 6e61 6d65  tr:.        name
-000056e0: 203d 2066 222c 206e 616d 653a 207b 7365   = f", name: {se
-000056f0: 6c66 2e6e 616d 657d 2220 6966 2073 656c  lf.name}" if sel
-00005700: 662e 6e61 6d65 2021 3d20 7365 6c66 2e61  f.name != self.a
-00005710: 6464 7265 7373 2065 6c73 6520 2222 0a20  ddress else "". 
-00005720: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
-00005730: 2020 2020 2020 2020 2020 2020 6622 3c57              f"<W
-00005740: 6f72 6b65 7253 7461 7465 207b 7365 6c66  orkerState {self
-00005750: 2e61 6464 7265 7373 2172 7d7b 6e61 6d65  .address!r}{name
-00005760: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
-00005770: 2066 2273 7461 7475 733a 207b 7365 6c66   f"status: {self
-00005780: 2e73 7461 7475 732e 6e61 6d65 7d2c 2022  .status.name}, "
-00005790: 0a20 2020 2020 2020 2020 2020 2066 226d  .            f"m
-000057a0: 656d 6f72 793a 207b 6c65 6e28 7365 6c66  emory: {len(self
-000057b0: 2e68 6173 5f77 6861 7429 7d2c 2022 0a20  .has_what)}, ". 
-000057c0: 2020 2020 2020 2020 2020 2066 2270 726f             f"pro
-000057d0: 6365 7373 696e 673a 207b 6c65 6e28 7365  cessing: {len(se
-000057e0: 6c66 2e70 726f 6365 7373 696e 6729 7d3e  lf.processing)}>
-000057f0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-00005800: 2064 6566 205f 7265 7072 5f68 746d 6c5f   def _repr_html_
-00005810: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-00005820: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
-00005830: 745f 7465 6d70 6c61 7465 2822 776f 726b  t_template("work
-00005840: 6572 5f73 7461 7465 2e68 746d 6c2e 6a32  er_state.html.j2
-00005850: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
-00005860: 2020 2020 2020 2061 6464 7265 7373 3d73         address=s
-00005870: 656c 662e 6164 6472 6573 732c 0a20 2020  elf.address,.   
-00005880: 2020 2020 2020 2020 206e 616d 653d 7365           name=se
-00005890: 6c66 2e6e 616d 652c 0a20 2020 2020 2020  lf.name,.       
-000058a0: 2020 2020 2073 7461 7475 733d 7365 6c66       status=self
-000058b0: 2e73 7461 7475 732e 6e61 6d65 2c0a 2020  .status.name,.  
-000058c0: 2020 2020 2020 2020 2020 6861 735f 7768            has_wh
-000058d0: 6174 3d73 656c 662e 6861 735f 7768 6174  at=self.has_what
-000058e0: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
-000058f0: 6f63 6573 7369 6e67 3d73 656c 662e 7072  ocessing=self.pr
-00005900: 6f63 6573 7369 6e67 2c0a 2020 2020 2020  ocessing,.      
-00005910: 2020 290a 0a20 2020 2064 6566 2069 6465    )..    def ide
-00005920: 6e74 6974 7928 7365 6c66 2920 2d3e 2064  ntity(self) -> d
-00005930: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-00005940: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
-00005950: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
-00005960: 6522 3a20 2257 6f72 6b65 7222 2c0a 2020  e": "Worker",.  
-00005970: 2020 2020 2020 2020 2020 2269 6422 3a20            "id": 
-00005980: 7365 6c66 2e6e 616d 652c 0a20 2020 2020  self.name,.     
-00005990: 2020 2020 2020 2022 686f 7374 223a 2073         "host": s
-000059a0: 656c 662e 686f 7374 2c0a 2020 2020 2020  elf.host,.      
-000059b0: 2020 2020 2020 2272 6573 6f75 7263 6573        "resources
-000059c0: 223a 2073 656c 662e 7265 736f 7572 6365  ": self.resource
-000059d0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-000059e0: 6c6f 6361 6c5f 6469 7265 6374 6f72 7922  local_directory"
-000059f0: 3a20 7365 6c66 2e6c 6f63 616c 5f64 6972  : self.local_dir
-00005a00: 6563 746f 7279 2c0a 2020 2020 2020 2020  ectory,.        
-00005a10: 2020 2020 226e 616d 6522 3a20 7365 6c66      "name": self
-00005a20: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-00005a30: 2020 2022 6e74 6872 6561 6473 223a 2073     "nthreads": s
-00005a40: 656c 662e 6e74 6872 6561 6473 2c0a 2020  elf.nthreads,.  
-00005a50: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00005a60: 795f 6c69 6d69 7422 3a20 7365 6c66 2e6d  y_limit": self.m
-00005a70: 656d 6f72 795f 6c69 6d69 742c 0a20 2020  emory_limit,.   
-00005a80: 2020 2020 2020 2020 2022 6c61 7374 5f73           "last_s
-00005a90: 6565 6e22 3a20 7365 6c66 2e6c 6173 745f  een": self.last_
-00005aa0: 7365 656e 2c0a 2020 2020 2020 2020 2020  seen,.          
-00005ab0: 2020 2273 6572 7669 6365 7322 3a20 7365    "services": se
-00005ac0: 6c66 2e73 6572 7669 6365 732c 0a20 2020  lf.services,.   
-00005ad0: 2020 2020 2020 2020 2022 6d65 7472 6963           "metric
-00005ae0: 7322 3a20 7365 6c66 2e6d 6574 7269 6373  s": self.metrics
-00005af0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-00005b00: 7461 7475 7322 3a20 7365 6c66 2e73 7461  tatus": self.sta
-00005b10: 7475 732e 6e61 6d65 2c0a 2020 2020 2020  tus.name,.      
-00005b20: 2020 2020 2020 226e 616e 6e79 223a 2073        "nanny": s
-00005b30: 656c 662e 6e61 6e6e 792c 0a20 2020 2020  elf.nanny,.     
-00005b40: 2020 2020 2020 202a 2a73 656c 662e 6578         **self.ex
-00005b50: 7472 612c 0a20 2020 2020 2020 207d 0a0a  tra,.        }..
-00005b60: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
-00005b70: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
-00005b80: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
-00005b90: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
-00005ba0: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
-00005bb0: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
-00005bc0: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
-00005bd0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
-00005be0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
-00005bf0: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
-00005c00: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
-00005c10: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
-00005c20: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
-00005c30: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-00005c40: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00005c50: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
-00005c60: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
-00005c70: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-00005c80: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
-00005c90: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
-00005ca0: 2020 5461 736b 5374 6174 652e 5f74 6f5f    TaskState._to_
-00005cb0: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
-00005cc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00005cd0: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
-00005ce0: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
-00005cf0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
-00005d00: 2065 7863 6c75 6465 3d73 6574 2865 7863   exclude=set(exc
-00005d10: 6c75 6465 2920 7c20 7b22 7665 7273 696f  lude) | {"versio
-00005d20: 6e73 227d 2c20 2023 2074 7970 653a 2069  ns"},  # type: i
-00005d30: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
-00005d40: 2020 6d65 6d62 6572 733d 5472 7565 2c0a    members=True,.
-00005d50: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-00005d60: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00005d70: 2073 6368 6564 756c 6572 2873 656c 6629   scheduler(self)
-00005d80: 202d 3e20 5363 6865 6475 6c65 7253 7461   -> SchedulerSta
-00005d90: 7465 3a0a 2020 2020 2020 2020 6173 7365  te:.        asse
-00005da0: 7274 2073 656c 662e 7363 6865 6475 6c65  rt self.schedule
-00005db0: 725f 7265 660a 2020 2020 2020 2020 7320  r_ref.        s 
-00005dc0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00005dd0: 5f72 6566 2829 0a20 2020 2020 2020 2061  _ref().        a
-00005de0: 7373 6572 7420 730a 2020 2020 2020 2020  ssert s.        
-00005df0: 7265 7475 726e 2073 0a0a 2020 2020 6465  return s..    de
-00005e00: 6620 6164 645f 746f 5f70 726f 6365 7373  f add_to_process
-00005e10: 696e 6728 7365 6c66 2c20 7473 3a20 5461  ing(self, ts: Ta
-00005e20: 736b 5374 6174 6529 202d 3e20 4e6f 6e65  skState) -> None
-00005e30: 3a0a 2020 2020 2020 2020 2222 2241 7373  :.        """Ass
-00005e40: 6967 6e20 6120 7461 736b 2074 6f20 7468  ign a task to th
-00005e50: 6973 2077 6f72 6b65 7220 666f 7220 636f  is worker for co
-00005e60: 6d70 7574 652e 2222 220a 2020 2020 2020  mpute.""".      
-00005e70: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
-00005e80: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
-00005e90: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00005ea0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-00005eb0: 7072 6f63 6573 7369 6e67 0a0a 2020 2020  processing..    
-00005ec0: 2020 2020 7470 203d 2074 732e 7072 6566      tp = ts.pref
-00005ed0: 6978 0a20 2020 2020 2020 2073 656c 662e  ix.        self.
-00005ee0: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
-00005ef0: 745b 7470 2e6e 616d 655d 202b 3d20 310a  t[tp.name] += 1.
-00005f00: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00005f10: 6564 756c 6572 2e5f 7461 736b 5f70 7265  eduler._task_pre
-00005f20: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
-00005f30: 5b74 702e 6e61 6d65 5d20 2b3d 2031 0a20  [tp.name] += 1. 
-00005f40: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
-00005f50: 6573 7369 6e67 2e61 6464 2874 7329 0a20  essing.add(ts). 
-00005f60: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-00005f70: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-00005f80: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-00005f90: 6620 7365 6c66 206e 6f74 2069 6e20 6474  f self not in dt
-00005fa0: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
-00005fb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005fc0: 5f69 6e63 5f6e 6565 6473 5f72 6570 6c69  _inc_needs_repli
-00005fd0: 6361 2864 7473 290a 0a20 2020 2064 6566  ca(dts)..    def
-00005fe0: 2061 6464 5f74 6f5f 6c6f 6e67 5f72 756e   add_to_long_run
-00005ff0: 6e69 6e67 2873 656c 662c 2074 733a 2054  ning(self, ts: T
-00006000: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
-00006010: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
-00006020: 6c66 2e73 6368 6564 756c 6572 2e76 616c  lf.scheduler.val
-00006030: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00006040: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00006050: 7365 6c66 2e70 726f 6365 7373 696e 670a  self.processing.
-00006060: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00006070: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
-00006080: 662e 6c6f 6e67 5f72 756e 6e69 6e67 0a0a  f.long_running..
-00006090: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
-000060a0: 6d6f 7665 5f66 726f 6d5f 7461 736b 5f70  move_from_task_p
-000060b0: 7265 6669 785f 636f 756e 7428 7473 290a  refix_count(ts).
-000060c0: 2020 2020 2020 2020 2320 4361 6e6e 6f74          # Cannot
-000060d0: 2072 656d 6f76 6520 6672 6f6d 2070 726f   remove from pro
-000060e0: 6365 7373 696e 6720 7369 6e63 6520 7765  cessing since we
-000060f0: 2772 6520 7573 696e 6720 7468 6973 2066  're using this f
-00006100: 6f72 2074 6869 6e67 7320 6c69 6b65 0a20  or things like. 
-00006110: 2020 2020 2020 2023 2069 646c 656e 6573         # idlenes
-00006120: 7320 6465 7465 6374 696f 6e2e 2049 646c  s detection. Idl
-00006130: 6520 776f 726b 6572 7320 6172 6520 7479  e workers are ty
-00006140: 7069 6361 6c6c 7920 7461 7267 6574 6564  pically targeted
-00006150: 2066 6f72 0a20 2020 2020 2020 2023 2064   for.        # d
-00006160: 6f77 6e73 6361 6c69 6e67 2062 7574 2077  ownscaling but w
-00006170: 6520 7368 6f75 6c64 206e 6f74 2064 6f77  e should not dow
-00006180: 6e73 6361 6c65 2077 6f72 6b65 7273 2077  nscale workers w
-00006190: 6974 6820 6c6f 6e67 2072 756e 6e69 6e67  ith long running
-000061a0: 0a20 2020 2020 2020 2023 2074 6173 6b73  .        # tasks
-000061b0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-000061c0: 6e67 5f72 756e 6e69 6e67 2e61 6464 2874  ng_running.add(t
-000061d0: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
-000061e0: 7665 5f66 726f 6d5f 7072 6f63 6573 7369  ve_from_processi
-000061f0: 6e67 2873 656c 662c 2074 733a 2054 6173  ng(self, ts: Tas
-00006200: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
-00006210: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
-00006220: 7665 2061 2074 6173 6b20 6672 6f6d 2061  ve a task from a
-00006230: 2077 6f72 6b65 7273 2070 726f 6365 7373   workers process
-00006240: 696e 6722 2222 0a20 2020 2020 2020 2069  ing""".        i
-00006250: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
-00006260: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00006270: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00006280: 2069 6e20 7365 6c66 2e70 726f 6365 7373   in self.process
-00006290: 696e 670a 0a20 2020 2020 2020 2069 6620  ing..        if 
-000062a0: 7473 2069 6e20 7365 6c66 2e6c 6f6e 675f  ts in self.long_
-000062b0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-000062c0: 2020 2020 2073 656c 662e 6c6f 6e67 5f72       self.long_r
-000062d0: 756e 6e69 6e67 2e64 6973 6361 7264 2874  unning.discard(t
-000062e0: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
-000062f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00006300: 662e 5f72 656d 6f76 655f 6672 6f6d 5f74  f._remove_from_t
-00006310: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-00006320: 2874 7329 0a20 2020 2020 2020 2073 656c  (ts).        sel
-00006330: 662e 7072 6f63 6573 7369 6e67 2e72 656d  f.processing.rem
-00006340: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
-00006350: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-00006360: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-00006370: 2020 2020 2020 2020 6966 2064 7473 2069          if dts i
-00006380: 6e20 7365 6c66 2e6e 6565 6473 5f77 6861  n self.needs_wha
-00006390: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-000063a0: 2020 2073 656c 662e 5f64 6563 5f6e 6565     self._dec_nee
-000063b0: 6473 5f72 6570 6c69 6361 2864 7473 290a  ds_replica(dts).
-000063c0: 0a20 2020 2064 6566 205f 7265 6d6f 7665  .    def _remove
-000063d0: 5f66 726f 6d5f 7461 736b 5f70 7265 6669  _from_task_prefi
-000063e0: 785f 636f 756e 7428 7365 6c66 2c20 7473  x_count(self, ts
-000063f0: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-00006400: 4e6f 6e65 3a0a 2020 2020 2020 2020 636f  None:.        co
-00006410: 756e 7420 3d20 7365 6c66 2e74 6173 6b5f  unt = self.task_
-00006420: 7072 6566 6978 5f63 6f75 6e74 5b74 732e  prefix_count[ts.
-00006430: 7072 6566 6978 2e6e 616d 655d 202d 2031  prefix.name] - 1
-00006440: 0a20 2020 2020 2020 2069 6620 636f 756e  .        if coun
-00006450: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
-00006460: 656c 662e 7461 736b 5f70 7265 6669 785f  elf.task_prefix_
-00006470: 636f 756e 745b 7473 2e70 7265 6669 782e  count[ts.prefix.
-00006480: 6e61 6d65 5d20 3d20 636f 756e 740a 2020  name] = count.  
-00006490: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000064a0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-000064b0: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
-000064c0: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
-000064d0: 655d 0a0a 2020 2020 2020 2020 636f 756e  e]..        coun
-000064e0: 7420 3d20 7365 6c66 2e73 6368 6564 756c  t = self.schedul
-000064f0: 6572 2e5f 7461 736b 5f70 7265 6669 785f  er._task_prefix_
-00006500: 636f 756e 745f 676c 6f62 616c 5b74 732e  count_global[ts.
-00006510: 7072 6566 6978 2e6e 616d 655d 202d 2031  prefix.name] - 1
-00006520: 0a20 2020 2020 2020 2069 6620 636f 756e  .        if coun
-00006530: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
-00006540: 656c 662e 7363 6865 6475 6c65 722e 5f74  elf.scheduler._t
-00006550: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-00006560: 5f67 6c6f 6261 6c5b 7473 2e70 7265 6669  _global[ts.prefi
-00006570: 782e 6e61 6d65 5d20 3d20 636f 756e 740a  x.name] = count.
-00006580: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00006590: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-000065a0: 6c66 2e73 6368 6564 756c 6572 2e5f 7461  lf.scheduler._ta
-000065b0: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
-000065c0: 676c 6f62 616c 5b74 732e 7072 6566 6978  global[ts.prefix
-000065d0: 2e6e 616d 655d 0a0a 2020 2020 6465 6620  .name]..    def 
-000065e0: 7265 6d6f 7665 5f72 6570 6c69 6361 2873  remove_replica(s
-000065f0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-00006600: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-00006610: 2020 2020 2022 2222 5468 6520 776f 726b       """The work
-00006620: 6572 206e 6f20 6c6f 6e67 6572 2068 6173  er no longer has
-00006630: 2061 2074 6173 6b20 696e 206d 656d 6f72   a task in memor
-00006640: 7922 2222 0a20 2020 2020 2020 2069 6620  y""".        if 
-00006650: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
-00006660: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00006670: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-00006680: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
-00006690: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000066a0: 7420 7473 2069 6e20 7365 6c66 2e68 6173  t ts in self.has
-000066b0: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
-000066c0: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-000066d0: 696e 2073 656c 662e 6e65 6564 735f 7768  in self.needs_wh
-000066e0: 6174 0a0a 2020 2020 2020 2020 7365 6c66  at..        self
-000066f0: 2e6e 6279 7465 7320 2d3d 2074 732e 6765  .nbytes -= ts.ge
-00006700: 745f 6e62 7974 6573 2829 0a20 2020 2020  t_nbytes().     
-00006710: 2020 2064 656c 2073 656c 662e 5f68 6173     del self._has
-00006720: 5f77 6861 745b 7473 5d0a 2020 2020 2020  _what[ts].      
-00006730: 2020 7473 2e77 686f 5f68 6173 2e72 656d    ts.who_has.rem
-00006740: 6f76 6528 7365 6c66 290a 0a20 2020 2064  ove(self)..    d
-00006750: 6566 205f 696e 635f 6e65 6564 735f 7265  ef _inc_needs_re
-00006760: 706c 6963 6128 7365 6c66 2c20 7473 3a20  plica(self, ts: 
-00006770: 5461 736b 5374 6174 6529 202d 3e20 4e6f  TaskState) -> No
-00006780: 6e65 3a0a 2020 2020 2020 2020 2222 2241  ne:.        """A
-00006790: 7373 6967 6e20 6120 7461 736b 2066 6574  ssign a task fet
-000067a0: 6368 2074 6f20 7468 6973 2077 6f72 6b65  ch to this worke
-000067b0: 7220 616e 6420 7570 6461 7465 206e 6574  r and update net
-000067c0: 776f 726b 206f 6363 7570 616e 6369 6573  work occupancies
-000067d0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-000067e0: 656c 662e 7363 6865 6475 6c65 722e 7661  elf.scheduler.va
-000067f0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-00006800: 2020 2020 6173 7365 7274 2073 656c 6620      assert self 
-00006810: 6e6f 7420 696e 2074 732e 7768 6f5f 6861  not in ts.who_ha
-00006820: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-00006830: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-00006840: 656c 662e 6861 735f 7768 6174 0a20 2020  elf.has_what.   
-00006850: 2020 2020 2069 6620 7473 206e 6f74 2069       if ts not i
-00006860: 6e20 7365 6c66 2e6e 6565 6473 5f77 6861  n self.needs_wha
-00006870: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
-00006880: 656c 662e 6e65 6564 735f 7768 6174 5b74  elf.needs_what[t
-00006890: 735d 203d 2031 0a20 2020 2020 2020 2020  s] = 1.         
-000068a0: 2020 206e 6279 7465 7320 3d20 7473 2e67     nbytes = ts.g
-000068b0: 6574 5f6e 6279 7465 7328 290a 2020 2020  et_nbytes().    
-000068c0: 2020 2020 2020 2020 7365 6c66 2e5f 6e65          self._ne
-000068d0: 7477 6f72 6b5f 6f63 6320 2b3d 206e 6279  twork_occ += nby
-000068e0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
-000068f0: 7365 6c66 2e73 6368 6564 756c 6572 2e5f  self.scheduler._
-00006900: 6e65 7477 6f72 6b5f 6f63 635f 676c 6f62  network_occ_glob
-00006910: 616c 202b 3d20 6e62 7974 6573 0a20 2020  al += nbytes.   
-00006920: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006930: 2020 2020 2020 2073 656c 662e 6e65 6564         self.need
-00006940: 735f 7768 6174 5b74 735d 202b 3d20 310a  s_what[ts] += 1.
-00006950: 0a20 2020 2064 6566 205f 6465 635f 6e65  .    def _dec_ne
-00006960: 6564 735f 7265 706c 6963 6128 7365 6c66  eds_replica(self
-00006970: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-00006980: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00006990: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
-000069a0: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
-000069b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000069c0: 2074 7320 696e 2073 656c 662e 6e65 6564   ts in self.need
-000069d0: 735f 7768 6174 0a0a 2020 2020 2020 2020  s_what..        
-000069e0: 7365 6c66 2e6e 6565 6473 5f77 6861 745b  self.needs_what[
-000069f0: 7473 5d20 2d3d 2031 0a20 2020 2020 2020  ts] -= 1.       
-00006a00: 2069 6620 7365 6c66 2e6e 6565 6473 5f77   if self.needs_w
-00006a10: 6861 745b 7473 5d20 3d3d 2030 3a0a 2020  hat[ts] == 0:.  
-00006a20: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-00006a30: 6c66 2e6e 6565 6473 5f77 6861 745b 7473  lf.needs_what[ts
-00006a40: 5d0a 2020 2020 2020 2020 2020 2020 6e62  ].            nb
-00006a50: 7974 6573 203d 2074 732e 6765 745f 6e62  ytes = ts.get_nb
-00006a60: 7974 6573 2829 0a20 2020 2020 2020 2020  ytes().         
-00006a70: 2020 2073 656c 662e 5f6e 6574 776f 726b     self._network
-00006a80: 5f6f 6363 202d 3d20 6e62 7974 6573 0a20  _occ -= nbytes. 
-00006a90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006aa0: 7363 6865 6475 6c65 722e 5f6e 6574 776f  scheduler._netwo
-00006ab0: 726b 5f6f 6363 5f67 6c6f 6261 6c20 2d3d  rk_occ_global -=
-00006ac0: 206e 6279 7465 730a 0a20 2020 2064 6566   nbytes..    def
-00006ad0: 2061 6464 5f72 6570 6c69 6361 2873 656c   add_replica(sel
-00006ae0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-00006af0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00006b00: 2020 2022 2222 5468 6520 776f 726b 6572     """The worker
-00006b10: 2061 6371 7569 7265 6420 6120 7265 706c   acquired a repl
-00006b20: 6963 6120 6f66 2074 6173 6b22 2222 0a20  ica of task""". 
-00006b30: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-00006b40: 6368 6564 756c 6572 2e76 616c 6964 6174  cheduler.validat
-00006b50: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00006b60: 7373 6572 7420 7365 6c66 206e 6f74 2069  ssert self not i
-00006b70: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
-00006b80: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00006b90: 7473 206e 6f74 2069 6e20 7365 6c66 2e68  ts not in self.h
-00006ba0: 6173 5f77 6861 740a 0a20 2020 2020 2020  as_what..       
-00006bb0: 206e 6279 7465 7320 3d20 7473 2e67 6574   nbytes = ts.get
-00006bc0: 5f6e 6279 7465 7328 290a 2020 2020 2020  _nbytes().      
-00006bd0: 2020 6966 2074 7320 696e 2073 656c 662e    if ts in self.
-00006be0: 6e65 6564 735f 7768 6174 3a0a 2020 2020  needs_what:.    
-00006bf0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-00006c00: 2e6e 6565 6473 5f77 6861 745b 7473 5d0a  .needs_what[ts].
-00006c10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00006c20: 2e5f 6e65 7477 6f72 6b5f 6f63 6320 2d3d  ._network_occ -=
-00006c30: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
-00006c40: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
-00006c50: 6572 2e5f 6e65 7477 6f72 6b5f 6f63 635f  er._network_occ_
-00006c60: 676c 6f62 616c 202d 3d20 6e62 7974 6573  global -= nbytes
-00006c70: 0a20 2020 2020 2020 2074 732e 7768 6f5f  .        ts.who_
-00006c80: 6861 732e 6164 6428 7365 6c66 290a 2020  has.add(self).  
-00006c90: 2020 2020 2020 7365 6c66 2e6e 6279 7465        self.nbyte
-00006ca0: 7320 2b3d 206e 6279 7465 730a 2020 2020  s += nbytes.    
-00006cb0: 2020 2020 7365 6c66 2e5f 6861 735f 7768      self._has_wh
-00006cc0: 6174 5b74 735d 203d 204e 6f6e 650a 0a20  at[ts] = None.. 
-00006cd0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00006ce0: 2064 6566 206f 6363 7570 616e 6379 2873   def occupancy(s
-00006cf0: 656c 6629 202d 3e20 666c 6f61 743a 0a20  elf) -> float:. 
-00006d00: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00006d10: 6c66 2e5f 6f63 6375 7061 6e63 795f 6361  lf._occupancy_ca
-00006d20: 6368 6520 6f72 2073 656c 662e 7363 6865  che or self.sche
-00006d30: 6475 6c65 722e 5f63 616c 635f 6f63 6375  duler._calc_occu
-00006d40: 7061 6e63 7928 0a20 2020 2020 2020 2020  pancy(.         
-00006d50: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
-00006d60: 6669 785f 636f 756e 742c 2073 656c 662e  fix_count, self.
-00006d70: 5f6e 6574 776f 726b 5f6f 6363 0a20 2020  _network_occ.   
-00006d80: 2020 2020 2029 0a0a 0a40 6461 7461 636c       )...@datacl
-00006d90: 6173 7365 732e 6461 7461 636c 6173 730a  asses.dataclass.
-00006da0: 636c 6173 7320 4572 7265 6454 6173 6b3a  class ErredTask:
-00006db0: 0a20 2020 2022 2222 4c69 6768 7477 6569  .    """Lightwei
-00006dc0: 6768 7420 7265 7072 6573 656e 7461 7469  ght representati
-00006dd0: 6f6e 206f 6620 616e 2065 7272 6564 2074  on of an erred t
-00006de0: 6173 6b20 7769 7468 6f75 7420 616e 7920  ask without any 
-00006df0: 6465 7065 6e64 656e 6379 2069 6e66 6f72  dependency infor
-00006e00: 6d61 7469 6f6e 0a20 2020 206f 7220 7275  mation.    or ru
-00006e10: 6e73 7065 632e 0a0a 2020 2020 5365 6520  nspec...    See 
-00006e20: 616c 736f 0a20 2020 202d 2d2d 2d2d 2d2d  also.    -------
-00006e30: 2d0a 2020 2020 5461 736b 5374 6174 650a  -.    TaskState.
-00006e40: 2020 2020 2222 220a 0a20 2020 206b 6579      """..    key
-00006e50: 3a20 4861 7368 6162 6c65 0a20 2020 2074  : Hashable.    t
-00006e60: 696d 6573 7461 6d70 3a20 666c 6f61 740a  imestamp: float.
-00006e70: 2020 2020 6572 7265 645f 6f6e 3a20 7365      erred_on: se
-00006e80: 745b 7374 725d 0a20 2020 2065 7863 6570  t[str].    excep
-00006e90: 7469 6f6e 5f74 6578 743a 2073 7472 0a20  tion_text: str. 
-00006ea0: 2020 2074 7261 6365 6261 636b 5f74 6578     traceback_tex
-00006eb0: 743a 2073 7472 0a0a 0a63 6c61 7373 2043  t: str...class C
-00006ec0: 6f6d 7075 7461 7469 6f6e 3a0a 2020 2020  omputation:.    
-00006ed0: 2222 2243 6f6c 6c65 6374 696f 6e20 7472  """Collection tr
-00006ee0: 6163 6b69 6e67 2061 2073 696e 676c 6520  acking a single 
-00006ef0: 636f 6d70 7574 6520 6f72 2070 6572 7369  compute or persi
-00006f00: 7374 2063 616c 6c0a 0a20 2020 2053 6565  st call..    See
-00006f10: 2061 6c73 6f0a 2020 2020 2d2d 2d2d 2d2d   also.    ------
-00006f20: 2d2d 0a20 2020 2054 6173 6b50 7265 6669  --.    TaskPrefi
-00006f30: 780a 2020 2020 5461 736b 4772 6f75 700a  x.    TaskGroup.
-00006f40: 2020 2020 5461 736b 5374 6174 650a 2020      TaskState.  
-00006f50: 2020 2222 220a 0a20 2020 2073 7461 7274    """..    start
-00006f60: 3a20 666c 6f61 740a 2020 2020 6772 6f75  : float.    grou
-00006f70: 7073 3a20 7365 745b 5461 736b 4772 6f75  ps: set[TaskGrou
-00006f80: 705d 0a20 2020 2063 6f64 653a 2053 6f72  p].    code: Sor
-00006f90: 7465 6453 6574 0a20 2020 2069 643a 2075  tedSet.    id: u
-00006fa0: 7569 642e 5555 4944 0a20 2020 2061 6e6e  uid.UUID.    ann
-00006fb0: 6f74 6174 696f 6e73 3a20 6469 6374 0a0a  otations: dict..
-00006fc0: 2020 2020 5f5f 736c 6f74 735f 5f20 3d20      __slots__ = 
-00006fd0: 7475 706c 6528 5f5f 616e 6e6f 7461 7469  tuple(__annotati
-00006fe0: 6f6e 735f 5f29 0a0a 2020 2020 6465 6620  ons__)..    def 
-00006ff0: 5f5f 696e 6974 5f5f 2873 656c 6629 3a0a  __init__(self):.
-00007000: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00007010: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
-00007020: 2020 2020 7365 6c66 2e67 726f 7570 7320      self.groups 
-00007030: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00007040: 7365 6c66 2e63 6f64 6520 3d20 536f 7274  self.code = Sort
-00007050: 6564 5365 7428 290a 2020 2020 2020 2020  edSet().        
-00007060: 7365 6c66 2e69 6420 3d20 7575 6964 2e75  self.id = uuid.u
-00007070: 7569 6434 2829 0a20 2020 2020 2020 2073  uid4().        s
-00007080: 656c 662e 616e 6e6f 7461 7469 6f6e 7320  elf.annotations 
-00007090: 3d20 7b7d 0a0a 2020 2020 4070 726f 7065  = {}..    @prope
-000070a0: 7274 790a 2020 2020 6465 6620 7374 6f70  rty.    def stop
-000070b0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
-000070c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000070d0: 2e67 726f 7570 733a 0a20 2020 2020 2020  .groups:.       
-000070e0: 2020 2020 2072 6574 7572 6e20 6d61 7828       return max(
-000070f0: 7467 2e73 746f 7020 666f 7220 7467 2069  tg.stop for tg i
-00007100: 6e20 7365 6c66 2e67 726f 7570 7329 0a20  n self.groups). 
-00007110: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007120: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00007130: 2d31 0a0a 2020 2020 4070 726f 7065 7274  -1..    @propert
-00007140: 790a 2020 2020 6465 6620 7374 6174 6573  y.    def states
-00007150: 2873 656c 6629 202d 3e20 6469 6374 5b54  (self) -> dict[T
-00007160: 6173 6b53 7461 7465 5374 6174 652c 2069  askStateState, i
-00007170: 6e74 5d3a 0a20 2020 2020 2020 2072 6574  nt]:.        ret
-00007180: 7572 6e20 6d65 7267 655f 7769 7468 2873  urn merge_with(s
-00007190: 756d 2c20 2874 672e 7374 6174 6573 2066  um, (tg.states f
-000071a0: 6f72 2074 6720 696e 2073 656c 662e 6772  or tg in self.gr
-000071b0: 6f75 7073 2929 0a0a 2020 2020 6465 6620  oups))..    def 
-000071c0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
-000071d0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
-000071e0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
-000071f0: 2020 2020 6622 3c43 6f6d 7075 7461 7469      f"<Computati
-00007200: 6f6e 207b 7365 6c66 2e69 647d 3a20 220a  on {self.id}: ".
-00007210: 2020 2020 2020 2020 2020 2020 2b20 2254              + "T
-00007220: 6173 6b73 3a20 220a 2020 2020 2020 2020  asks: ".        
-00007230: 2020 2020 2b20 222c 2022 2e6a 6f69 6e28      + ", ".join(
-00007240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007250: 2022 2573 3a20 2564 2220 2520 286b 2c20   "%s: %d" % (k, 
-00007260: 7629 2066 6f72 2028 6b2c 2076 2920 696e  v) for (k, v) in
-00007270: 2073 6f72 7465 6428 7365 6c66 2e73 7461   sorted(self.sta
-00007280: 7465 732e 6974 656d 7328 2929 2069 6620  tes.items()) if 
-00007290: 760a 2020 2020 2020 2020 2020 2020 290a  v.            ).
-000072a0: 2020 2020 2020 2020 2020 2020 2b20 223e              + ">
-000072b0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-000072c0: 2064 6566 205f 7265 7072 5f68 746d 6c5f   def _repr_html_
-000072d0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-000072e0: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
-000072f0: 745f 7465 6d70 6c61 7465 2822 636f 6d70  t_template("comp
-00007300: 7574 6174 696f 6e2e 6874 6d6c 2e6a 3222  utation.html.j2"
-00007310: 292e 7265 6e64 6572 280a 2020 2020 2020  ).render(.      
-00007320: 2020 2020 2020 6964 3d73 656c 662e 6964        id=self.id
-00007330: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00007340: 6172 743d 7365 6c66 2e73 7461 7274 2c0a  art=self.start,.
-00007350: 2020 2020 2020 2020 2020 2020 7374 6f70              stop
-00007360: 3d73 656c 662e 7374 6f70 2c0a 2020 2020  =self.stop,.    
-00007370: 2020 2020 2020 2020 6772 6f75 7073 3d73          groups=s
-00007380: 656c 662e 6772 6f75 7073 2c0a 2020 2020  elf.groups,.    
-00007390: 2020 2020 2020 2020 7374 6174 6573 3d73          states=s
-000073a0: 656c 662e 7374 6174 6573 2c0a 2020 2020  elf.states,.    
-000073b0: 2020 2020 2020 2020 636f 6465 3d73 656c          code=sel
-000073c0: 662e 636f 6465 2c0a 2020 2020 2020 2020  f.code,.        
-000073d0: 290a 0a0a 636c 6173 7320 5461 736b 5072  )...class TaskPr
-000073e0: 6566 6978 3a0a 2020 2020 2222 2243 6f6c  efix:.    """Col
-000073f0: 6c65 6374 696f 6e20 7472 6163 6b69 6e67  lection tracking
-00007400: 2061 6c6c 2074 6173 6b73 2077 6974 6869   all tasks withi
-00007410: 6e20 6120 6772 6f75 700a 0a20 2020 204b  n a group..    K
-00007420: 6579 7320 6f66 7465 6e20 6861 7665 2061  eys often have a
-00007430: 2073 7472 7563 7475 7265 206c 696b 6520   structure like 
-00007440: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
-00007450: 0a20 2020 2041 2067 726f 7570 2074 616b  .    A group tak
-00007460: 6573 2074 6865 2066 6972 7374 2073 6563  es the first sec
-00007470: 7469 6f6e 2c20 6c69 6b65 2060 6022 7822  tion, like ``"x"
-00007480: 6060 0a0a 2020 2020 5365 6520 416c 736f  ``..    See Also
-00007490: 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a 2020  .    --------.  
-000074a0: 2020 5461 736b 4772 6f75 700a 2020 2020    TaskGroup.    
-000074b0: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
-000074c0: 6e61 6d65 206f 6620 6120 6772 6f75 7020  name of a group 
-000074d0: 6f66 2074 6173 6b73 2e0a 2020 2020 233a  of tasks..    #:
-000074e0: 2046 6f72 2061 2074 6173 6b20 6c69 6b65   For a task like
-000074f0: 2060 6028 2278 2d31 3233 222c 2030 2960   ``("x-123", 0)`
-00007500: 6020 7468 6973 2069 7320 7468 6520 7465  ` this is the te
-00007510: 7874 2060 6022 7822 6060 0a20 2020 206e  xt ``"x"``.    n
-00007520: 616d 653a 2073 7472 0a0a 2020 2020 233a  ame: str..    #:
-00007530: 2041 6e20 6578 706f 6e65 6e74 6961 6c6c   An exponentiall
-00007540: 7920 7765 6967 6874 6564 206d 6f76 696e  y weighted movin
-00007550: 6720 6176 6572 6167 6520 6475 7261 7469  g average durati
-00007560: 6f6e 206f 6620 616c 6c20 7461 736b 7320  on of all tasks 
-00007570: 7769 7468 2074 6869 7320 7072 6566 6978  with this prefix
-00007580: 0a20 2020 2064 7572 6174 696f 6e5f 6176  .    duration_av
-00007590: 6572 6167 653a 2066 6c6f 6174 0a0a 2020  erage: float..  
-000075a0: 2020 233a 204e 756d 6265 7273 206f 6620    #: Numbers of 
-000075b0: 7469 6d65 7320 6120 7461 736b 2077 6173  times a task was
-000075c0: 206d 6172 6b65 6420 6173 2073 7573 7069   marked as suspi
-000075d0: 6369 6f75 7320 7769 7468 2074 6869 7320  cious with this 
-000075e0: 7072 6566 6978 0a20 2020 2073 7573 7069  prefix.    suspi
-000075f0: 6369 6f75 733a 2069 6e74 0a0a 2020 2020  cious: int..    
-00007600: 233a 2053 746f 7265 2074 696d 696e 6773  #: Store timings
-00007610: 2066 6f72 2065 6163 6820 7072 6566 6978   for each prefix
-00007620: 2d61 6374 696f 6e0a 2020 2020 616c 6c5f  -action.    all_
-00007630: 6475 7261 7469 6f6e 733a 2064 6566 6175  durations: defau
-00007640: 6c74 6469 6374 5b73 7472 2c20 666c 6f61  ltdict[str, floa
-00007650: 745d 0a0a 2020 2020 233a 2054 6869 7320  t]..    #: This 
-00007660: 6d65 6173 7572 6573 2074 6865 206d 6178  measures the max
-00007670: 696d 756d 2072 6563 6f72 6465 6420 6c69  imum recorded li
-00007680: 7665 2065 7865 6375 7469 6f6e 2074 696d  ve execution tim
-00007690: 6520 616e 6420 6361 6e20 6265 2075 7365  e and can be use
-000076a0: 6420 746f 0a20 2020 2023 3a20 6465 7465  d to.    #: dete
-000076b0: 6374 206f 7574 6c69 6572 730a 2020 2020  ct outliers.    
-000076c0: 6d61 785f 6578 6563 5f74 696d 653a 2066  max_exec_time: f
-000076d0: 6c6f 6174 0a0a 2020 2020 233a 2054 6173  loat..    #: Tas
-000076e0: 6b20 6772 6f75 7073 2061 7373 6f63 6961  k groups associa
-000076f0: 7465 6420 746f 2074 6869 7320 7072 6566  ted to this pref
-00007700: 6978 0a20 2020 2067 726f 7570 733a 206c  ix.    groups: l
-00007710: 6973 745b 5461 736b 4772 6f75 705d 0a0a  ist[TaskGroup]..
-00007720: 2020 2020 233a 2041 6363 756d 756c 6174      #: Accumulat
-00007730: 6520 636f 756e 7420 6f66 206e 756d 6265  e count of numbe
-00007740: 7220 6f66 2074 6173 6b73 2069 6e20 6561  r of tasks in ea
-00007750: 6368 2073 7461 7465 0a20 2020 2073 7461  ch state.    sta
-00007760: 7465 5f63 6f75 6e74 733a 2064 6566 6175  te_counts: defau
-00007770: 6c74 6469 6374 5b54 6173 6b53 7461 7465  ltdict[TaskState
-00007780: 5374 6174 652c 2069 6e74 5d0a 0a20 2020  State, int]..   
-00007790: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
-000077a0: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
-000077b0: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
-000077c0: 6e69 745f 5f28 7365 6c66 2c20 6e61 6d65  nit__(self, name
-000077d0: 3a20 7374 7229 3a0a 2020 2020 2020 2020  : str):.        
-000077e0: 7365 6c66 2e6e 616d 6520 3d20 6e61 6d65  self.name = name
-000077f0: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
-00007800: 6f75 7073 203d 205b 5d0a 2020 2020 2020  oups = [].      
-00007810: 2020 7365 6c66 2e61 6c6c 5f64 7572 6174    self.all_durat
-00007820: 696f 6e73 203d 2064 6566 6175 6c74 6469  ions = defaultdi
-00007830: 6374 2866 6c6f 6174 290a 2020 2020 2020  ct(float).      
-00007840: 2020 7365 6c66 2e73 7461 7465 5f63 6f75    self.state_cou
-00007850: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
-00007860: 7428 696e 7429 0a20 2020 2020 2020 2074  t(int).        t
-00007870: 6173 6b5f 6475 7261 7469 6f6e 7320 3d20  ask_durations = 
-00007880: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-00007890: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-000078a0: 6564 756c 6572 2e64 6566 6175 6c74 2d74  eduler.default-t
-000078b0: 6173 6b2d 6475 7261 7469 6f6e 7322 290a  ask-durations").
-000078c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000078d0: 6e61 6d65 2069 6e20 7461 736b 5f64 7572  name in task_dur
-000078e0: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
-000078f0: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
-00007900: 6e5f 6176 6572 6167 6520 3d20 7061 7273  n_average = pars
-00007910: 655f 7469 6d65 6465 6c74 6128 7461 736b  e_timedelta(task
-00007920: 5f64 7572 6174 696f 6e73 5b73 656c 662e  _durations[self.
-00007930: 6e61 6d65 5d29 0a20 2020 2020 2020 2065  name]).        e
-00007940: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00007950: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
-00007960: 7665 7261 6765 203d 202d 310a 2020 2020  verage = -1.    
-00007970: 2020 2020 7365 6c66 2e6d 6178 5f65 7865      self.max_exe
-00007980: 635f 7469 6d65 203d 202d 310a 2020 2020  c_time = -1.    
-00007990: 2020 2020 7365 6c66 2e73 7573 7069 6369      self.suspici
-000079a0: 6f75 7320 3d20 300a 0a20 2020 2064 6566  ous = 0..    def
-000079b0: 2061 6464 5f65 7865 635f 7469 6d65 2873   add_exec_time(s
-000079c0: 656c 662c 2064 7572 6174 696f 6e3a 2066  elf, duration: f
-000079d0: 6c6f 6174 2920 2d3e 204e 6f6e 653a 0a20  loat) -> None:. 
-000079e0: 2020 2020 2020 2073 656c 662e 6d61 785f         self.max_
-000079f0: 6578 6563 5f74 696d 6520 3d20 6d61 7828  exec_time = max(
-00007a00: 6475 7261 7469 6f6e 2c20 7365 6c66 2e6d  duration, self.m
-00007a10: 6178 5f65 7865 635f 7469 6d65 290a 2020  ax_exec_time).  
-00007a20: 2020 2020 2020 6966 2064 7572 6174 696f        if duratio
-00007a30: 6e20 3e20 3220 2a20 7365 6c66 2e64 7572  n > 2 * self.dur
-00007a40: 6174 696f 6e5f 6176 6572 6167 653a 0a20  ation_average:. 
-00007a50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00007a60: 6475 7261 7469 6f6e 5f61 7665 7261 6765  duration_average
-00007a70: 203d 202d 310a 0a20 2020 2064 6566 2061   = -1..    def a
-00007a80: 6464 5f64 7572 6174 696f 6e28 7365 6c66  dd_duration(self
-00007a90: 2c20 6163 7469 6f6e 3a20 7374 722c 2073  , action: str, s
-00007aa0: 7461 7274 3a20 666c 6f61 742c 2073 746f  tart: float, sto
-00007ab0: 703a 2066 6c6f 6174 2920 2d3e 204e 6f6e  p: float) -> Non
-00007ac0: 653a 0a20 2020 2020 2020 2064 7572 6174  e:.        durat
-00007ad0: 696f 6e20 3d20 7374 6f70 202d 2073 7461  ion = stop - sta
-00007ae0: 7274 0a20 2020 2020 2020 2073 656c 662e  rt.        self.
-00007af0: 616c 6c5f 6475 7261 7469 6f6e 735b 6163  all_durations[ac
-00007b00: 7469 6f6e 5d20 2b3d 2064 7572 6174 696f  tion] += duratio
-00007b10: 6e0a 2020 2020 2020 2020 6966 2061 6374  n.        if act
-00007b20: 696f 6e20 3d3d 2022 636f 6d70 7574 6522  ion == "compute"
-00007b30: 3a0a 2020 2020 2020 2020 2020 2020 6f6c  :.            ol
-00007b40: 6420 3d20 7365 6c66 2e64 7572 6174 696f  d = self.duratio
-00007b50: 6e5f 6176 6572 6167 650a 2020 2020 2020  n_average.      
-00007b60: 2020 2020 2020 6966 206f 6c64 203c 2030        if old < 0
-00007b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007b80: 2020 7365 6c66 2e64 7572 6174 696f 6e5f    self.duration_
-00007b90: 6176 6572 6167 6520 3d20 6475 7261 7469  average = durati
-00007ba0: 6f6e 0a20 2020 2020 2020 2020 2020 2065  on.            e
-00007bb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00007bc0: 2020 2020 2073 656c 662e 6475 7261 7469       self.durati
-00007bd0: 6f6e 5f61 7665 7261 6765 203d 2030 2e35  on_average = 0.5
-00007be0: 202a 2064 7572 6174 696f 6e20 2b20 302e   * duration + 0.
-00007bf0: 3520 2a20 6f6c 640a 0a20 2020 2040 7072  5 * old..    @pr
-00007c00: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
-00007c10: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
-00007c20: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
-00007c30: 2020 2020 2020 2022 2222 5468 6520 6e75         """The nu
-00007c40: 6d62 6572 206f 6620 7461 736b 7320 696e  mber of tasks in
-00007c50: 2065 6163 6820 7374 6174 652c 0a20 2020   each state,.   
-00007c60: 2020 2020 206c 696b 6520 6060 7b22 6d65       like ``{"me
-00007c70: 6d6f 7279 223a 2031 302c 2022 7072 6f63  mory": 10, "proc
-00007c80: 6573 7369 6e67 223a 2033 2c20 2272 656c  essing": 3, "rel
-00007c90: 6561 7365 6422 3a20 342c 202e 2e2e 7d60  eased": 4, ...}`
-00007ca0: 600a 2020 2020 2020 2020 2222 220a 2020  `.        """.  
-00007cb0: 2020 2020 2020 7265 7475 726e 206d 6572        return mer
-00007cc0: 6765 5f77 6974 6828 7375 6d2c 205b 7467  ge_with(sum, [tg
-00007cd0: 2e73 7461 7465 7320 666f 7220 7467 2069  .states for tg i
-00007ce0: 6e20 7365 6c66 2e67 726f 7570 735d 290a  n self.groups]).
-00007cf0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00007d00: 2020 2064 6566 2061 6374 6976 6528 7365     def active(se
-00007d10: 6c66 2920 2d3e 206c 6973 745b 5461 736b  lf) -> list[Task
-00007d20: 4772 6f75 705d 3a0a 2020 2020 2020 2020  Group]:.        
-00007d30: 7265 7475 726e 205b 0a20 2020 2020 2020  return [.       
-00007d40: 2020 2020 2074 670a 2020 2020 2020 2020       tg.        
-00007d50: 2020 2020 666f 7220 7467 2069 6e20 7365      for tg in se
-00007d60: 6c66 2e67 726f 7570 730a 2020 2020 2020  lf.groups.      
-00007d70: 2020 2020 2020 6966 2061 6e79 286b 2021        if any(k !
-00007d80: 3d20 2266 6f72 676f 7474 656e 2220 616e  = "forgotten" an
-00007d90: 6420 7620 213d 2030 2066 6f72 206b 2c20  d v != 0 for k, 
-00007da0: 7620 696e 2074 672e 7374 6174 6573 2e69  v in tg.states.i
-00007db0: 7465 6d73 2829 290a 2020 2020 2020 2020  tems()).        
-00007dc0: 5d0a 0a20 2020 2040 7072 6f70 6572 7479  ]..    @property
-00007dd0: 0a20 2020 2064 6566 2061 6374 6976 655f  .    def active_
-00007de0: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
-00007df0: 6469 6374 5b73 7472 2c20 696e 745d 3a0a  dict[str, int]:.
-00007e00: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-00007e10: 6572 6765 5f77 6974 6828 7375 6d2c 205b  erge_with(sum, [
-00007e20: 7467 2e73 7461 7465 7320 666f 7220 7467  tg.states for tg
-00007e30: 2069 6e20 7365 6c66 2e61 6374 6976 655d   in self.active]
-00007e40: 290a 0a20 2020 2064 6566 205f 5f72 6570  )..    def __rep
-00007e50: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
-00007e60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00007e70: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-00007e80: 3c22 0a20 2020 2020 2020 2020 2020 202b  <".            +
-00007e90: 2073 656c 662e 6e61 6d65 0a20 2020 2020   self.name.     
-00007ea0: 2020 2020 2020 202b 2022 3a20 220a 2020         + ": ".  
-00007eb0: 2020 2020 2020 2020 2020 2b20 222c 2022            + ", "
-00007ec0: 2e6a 6f69 6e28 0a20 2020 2020 2020 2020  .join(.         
-00007ed0: 2020 2020 2020 2022 2573 3a20 2564 2220         "%s: %d" 
-00007ee0: 2520 286b 2c20 7629 2066 6f72 2028 6b2c  % (k, v) for (k,
-00007ef0: 2076 2920 696e 2073 6f72 7465 6428 7365   v) in sorted(se
-00007f00: 6c66 2e73 7461 7465 732e 6974 656d 7328  lf.states.items(
-00007f10: 2929 2069 6620 760a 2020 2020 2020 2020  )) if v.        
-00007f20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00007f30: 2020 2b20 223e 220a 2020 2020 2020 2020    + ">".        
-00007f40: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-00007f50: 0a20 2020 2064 6566 206e 6279 7465 735f  .    def nbytes_
-00007f60: 746f 7461 6c28 7365 6c66 2920 2d3e 2069  total(self) -> i
-00007f70: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
-00007f80: 726e 2073 756d 2874 672e 6e62 7974 6573  rn sum(tg.nbytes
-00007f90: 5f74 6f74 616c 2066 6f72 2074 6720 696e  _total for tg in
-00007fa0: 2073 656c 662e 6772 6f75 7073 290a 0a20   self.groups).. 
-00007fb0: 2020 2064 6566 205f 5f6c 656e 5f5f 2873     def __len__(s
-00007fc0: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-00007fd0: 2020 2020 2072 6574 7572 6e20 7375 6d28       return sum(
-00007fe0: 6d61 7028 6c65 6e2c 2073 656c 662e 6772  map(len, self.gr
-00007ff0: 6f75 7073 2929 0a0a 2020 2020 4070 726f  oups))..    @pro
-00008000: 7065 7274 790a 2020 2020 6465 6620 6475  perty.    def du
-00008010: 7261 7469 6f6e 2873 656c 6629 202d 3e20  ration(self) -> 
-00008020: 666c 6f61 743a 0a20 2020 2020 2020 2072  float:.        r
-00008030: 6574 7572 6e20 7375 6d28 7467 2e64 7572  eturn sum(tg.dur
-00008040: 6174 696f 6e20 666f 7220 7467 2069 6e20  ation for tg in 
-00008050: 7365 6c66 2e67 726f 7570 7329 0a0a 2020  self.groups)..  
-00008060: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00008070: 6465 6620 7479 7065 7328 7365 6c66 2920  def types(self) 
-00008080: 2d3e 2073 6574 5b73 7472 5d3a 0a20 2020  -> set[str]:.   
-00008090: 2020 2020 2072 6574 7572 6e20 7b74 7970       return {typ
-000080a0: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
-000080b0: 6772 6f75 7073 2066 6f72 2074 7970 2069  groups for typ i
-000080c0: 6e20 7467 2e74 7970 6573 7d0a 0a0a 636c  n tg.types}...cl
-000080d0: 6173 7320 5461 736b 4772 6f75 703a 0a20  ass TaskGroup:. 
-000080e0: 2020 2022 2222 436f 6c6c 6563 7469 6f6e     """Collection
-000080f0: 2074 7261 636b 696e 6720 616c 6c20 7461   tracking all ta
-00008100: 736b 7320 7769 7468 696e 2061 2067 726f  sks within a gro
-00008110: 7570 0a0a 2020 2020 4b65 7973 206f 6674  up..    Keys oft
-00008120: 656e 2068 6176 6520 6120 7374 7275 6374  en have a struct
-00008130: 7572 6520 6c69 6b65 2060 6028 2278 2d31  ure like ``("x-1
-00008140: 3233 222c 2030 2960 600a 2020 2020 4120  23", 0)``.    A 
-00008150: 6772 6f75 7020 7461 6b65 7320 7468 6520  group takes the 
-00008160: 6669 7273 7420 7365 6374 696f 6e2c 206c  first section, l
-00008170: 696b 6520 6060 2278 2d31 3233 2260 600a  ike ``"x-123"``.
-00008180: 0a20 2020 2053 6565 2061 6c73 6f0a 2020  .    See also.  
-00008190: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2054    --------.    T
-000081a0: 6173 6b50 7265 6669 780a 2020 2020 2222  askPrefix.    ""
-000081b0: 220a 0a20 2020 2023 3a20 5468 6520 6e61  "..    #: The na
-000081c0: 6d65 206f 6620 6120 6772 6f75 7020 6f66  me of a group of
-000081d0: 2074 6173 6b73 2e0a 2020 2020 233a 2046   tasks..    #: F
-000081e0: 6f72 2061 2074 6173 6b20 6c69 6b65 2060  or a task like `
-000081f0: 6028 2278 2d31 3233 222c 2030 2960 6020  `("x-123", 0)`` 
-00008200: 7468 6973 2069 7320 7468 6520 7465 7874  this is the text
-00008210: 2060 6022 782d 3132 3322 6060 0a20 2020   ``"x-123"``.   
-00008220: 206e 616d 653a 2073 7472 0a0a 2020 2020   name: str..    
-00008230: 233a 2054 6865 206e 756d 6265 7220 6f66  #: The number of
-00008240: 2074 6173 6b73 2069 6e20 6561 6368 2073   tasks in each s
-00008250: 7461 7465 2c0a 2020 2020 233a 206c 696b  tate,.    #: lik
-00008260: 6520 6060 7b22 6d65 6d6f 7279 223a 2031  e ``{"memory": 1
-00008270: 302c 2022 7072 6f63 6573 7369 6e67 223a  0, "processing":
-00008280: 2033 2c20 2272 656c 6561 7365 6422 3a20   3, "released": 
-00008290: 342c 202e 2e2e 7d60 600a 2020 2020 7374  4, ...}``.    st
-000082a0: 6174 6573 3a20 6469 6374 5b54 6173 6b53  ates: dict[TaskS
-000082b0: 7461 7465 5374 6174 652c 2069 6e74 5d0a  tateState, int].
-000082c0: 0a20 2020 2023 3a20 5468 6520 6f74 6865  .    #: The othe
-000082d0: 7220 5461 736b 4772 6f75 7073 206f 6e20  r TaskGroups on 
-000082e0: 7768 6963 6820 7468 6973 206f 6e65 2064  which this one d
-000082f0: 6570 656e 6473 0a20 2020 2064 6570 656e  epends.    depen
-00008300: 6465 6e63 6965 733a 2073 6574 5b54 6173  dencies: set[Tas
-00008310: 6b47 726f 7570 5d0a 0a20 2020 2023 3a20  kGroup]..    #: 
-00008320: 5468 6520 746f 7461 6c20 6e75 6d62 6572  The total number
-00008330: 206f 6620 6279 7465 7320 7468 6174 2074   of bytes that t
-00008340: 6869 7320 7461 736b 2067 726f 7570 2068  his task group h
-00008350: 6173 2070 726f 6475 6365 640a 2020 2020  as produced.    
-00008360: 6e62 7974 6573 5f74 6f74 616c 3a20 696e  nbytes_total: in
-00008370: 740a 0a20 2020 2023 3a20 5468 6520 746f  t..    #: The to
-00008380: 7461 6c20 616d 6f75 6e74 206f 6620 7469  tal amount of ti
-00008390: 6d65 2073 7065 6e74 206f 6e20 616c 6c20  me spent on all 
-000083a0: 7461 736b 7320 696e 2074 6869 7320 5461  tasks in this Ta
-000083b0: 736b 4772 6f75 700a 2020 2020 6475 7261  skGroup.    dura
-000083c0: 7469 6f6e 3a20 666c 6f61 740a 0a20 2020  tion: float..   
-000083d0: 2023 3a20 5468 6520 7265 7375 6c74 2074   #: The result t
-000083e0: 7970 6573 206f 6620 7468 6973 2054 6173  ypes of this Tas
-000083f0: 6b47 726f 7570 0a20 2020 2074 7970 6573  kGroup.    types
-00008400: 3a20 7365 745b 7374 725d 0a0a 2020 2020  : set[str]..    
-00008410: 233a 2054 6865 2077 6f72 6b65 7220 6d6f  #: The worker mo
-00008420: 7374 2072 6563 656e 746c 7920 6173 7369  st recently assi
-00008430: 676e 6564 2061 2074 6173 6b20 6672 6f6d  gned a task from
-00008440: 2074 6869 7320 6772 6f75 702c 206f 7220   this group, or 
-00008450: 4e6f 6e65 2077 6865 6e20 7468 6520 6772  None when the gr
-00008460: 6f75 700a 2020 2020 233a 2069 7320 6e6f  oup.    #: is no
-00008470: 7420 6964 656e 7469 6669 6564 2074 6f20  t identified to 
-00008480: 6265 2072 6f6f 742d 6c69 6b65 2062 7920  be root-like by 
-00008490: 6053 6368 6564 756c 6572 5374 6174 652e  `SchedulerState.
-000084a0: 6465 6369 6465 5f77 6f72 6b65 7260 2e0a  decide_worker`..
-000084b0: 2020 2020 6c61 7374 5f77 6f72 6b65 723a      last_worker:
-000084c0: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
-000084d0: 6f6e 650a 0a20 2020 2023 3a20 4966 2060  one..    #: If `
-000084e0: 6c61 7374 5f77 6f72 6b65 7260 2069 7320  last_worker` is 
-000084f0: 6e6f 7420 4e6f 6e65 2c20 7468 6520 6e75  not None, the nu
-00008500: 6d62 6572 206f 6620 7469 6d65 7320 7468  mber of times th
-00008510: 6174 2077 6f72 6b65 7220 7368 6f75 6c64  at worker should
-00008520: 2062 6520 6173 7369 676e 6564 0a20 2020   be assigned.   
-00008530: 2023 3a20 7375 6273 6571 7565 6e74 2074   #: subsequent t
-00008540: 6173 6b73 2075 6e74 696c 2061 206e 6577  asks until a new
-00008550: 2077 6f72 6b65 7220 6973 2063 686f 7365   worker is chose
-00008560: 6e2e 0a20 2020 206c 6173 745f 776f 726b  n..    last_work
-00008570: 6572 5f74 6173 6b73 5f6c 6566 743a 2069  er_tasks_left: i
-00008580: 6e74 0a0a 2020 2020 7072 6566 6978 3a20  nt..    prefix: 
-00008590: 5461 736b 5072 6566 6978 207c 204e 6f6e  TaskPrefix | Non
-000085a0: 650a 2020 2020 7374 6172 743a 2066 6c6f  e.    start: flo
-000085b0: 6174 0a20 2020 2073 746f 703a 2066 6c6f  at.    stop: flo
-000085c0: 6174 0a20 2020 2061 6c6c 5f64 7572 6174  at.    all_durat
-000085d0: 696f 6e73 3a20 6465 6661 756c 7464 6963  ions: defaultdic
-000085e0: 745b 7374 722c 2066 6c6f 6174 5d0a 0a20  t[str, float].. 
-000085f0: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
-00008600: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
-00008610: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
-00008620: 5f69 6e69 745f 5f28 7365 6c66 2c20 6e61  _init__(self, na
-00008630: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
-00008640: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
-00008650: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-00008660: 7072 6566 6978 203d 204e 6f6e 650a 2020  prefix = None.  
-00008670: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-00008680: 7320 3d20 6469 6374 2e66 726f 6d6b 6579  s = dict.fromkey
-00008690: 7328 414c 4c5f 5441 534b 5f53 5441 5445  s(ALL_TASK_STATE
-000086a0: 532c 2030 290a 2020 2020 2020 2020 7365  S, 0).        se
-000086b0: 6c66 2e64 6570 656e 6465 6e63 6965 7320  lf.dependencies 
-000086c0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-000086d0: 7365 6c66 2e6e 6279 7465 735f 746f 7461  self.nbytes_tota
-000086e0: 6c20 3d20 300a 2020 2020 2020 2020 7365  l = 0.        se
-000086f0: 6c66 2e64 7572 6174 696f 6e20 3d20 300a  lf.duration = 0.
-00008700: 2020 2020 2020 2020 7365 6c66 2e74 7970          self.typ
-00008710: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
-00008720: 2020 2073 656c 662e 7374 6172 7420 3d20     self.start = 
-00008730: 302e 300a 2020 2020 2020 2020 7365 6c66  0.0.        self
-00008740: 2e73 746f 7020 3d20 302e 300a 2020 2020  .stop = 0.0.    
-00008750: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
-00008760: 6174 696f 6e73 203d 2064 6566 6175 6c74  ations = default
-00008770: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
-00008780: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
-00008790: 726b 6572 203d 204e 6f6e 650a 2020 2020  rker = None.    
-000087a0: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
-000087b0: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
-000087c0: 3d20 300a 0a20 2020 2064 6566 2061 6464  = 0..    def add
-000087d0: 5f64 7572 6174 696f 6e28 7365 6c66 2c20  _duration(self, 
-000087e0: 6163 7469 6f6e 3a20 7374 722c 2073 7461  action: str, sta
-000087f0: 7274 3a20 666c 6f61 742c 2073 746f 703a  rt: float, stop:
-00008800: 2066 6c6f 6174 2920 2d3e 204e 6f6e 653a   float) -> None:
-00008810: 0a20 2020 2020 2020 2064 7572 6174 696f  .        duratio
-00008820: 6e20 3d20 7374 6f70 202d 2073 7461 7274  n = stop - start
-00008830: 0a20 2020 2020 2020 2073 656c 662e 616c  .        self.al
-00008840: 6c5f 6475 7261 7469 6f6e 735b 6163 7469  l_durations[acti
-00008850: 6f6e 5d20 2b3d 2064 7572 6174 696f 6e0a  on] += duration.
-00008860: 2020 2020 2020 2020 6966 2061 6374 696f          if actio
-00008870: 6e20 3d3d 2022 636f 6d70 7574 6522 3a0a  n == "compute":.
-00008880: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00008890: 656c 662e 7374 6f70 203c 2073 746f 703a  elf.stop < stop:
-000088a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000088b0: 2073 656c 662e 7374 6f70 203d 2073 746f   self.stop = sto
-000088c0: 700a 2020 2020 2020 2020 2020 2020 7365  p.            se
-000088d0: 6c66 2e73 7461 7274 203d 2073 656c 662e  lf.start = self.
-000088e0: 7374 6172 7420 6f72 2073 7461 7274 0a20  start or start. 
-000088f0: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
-00008900: 7469 6f6e 202b 3d20 6475 7261 7469 6f6e  tion += duration
-00008910: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00008920: 7365 6c66 2e70 7265 6669 7820 6973 206e  self.prefix is n
-00008930: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-00008940: 7365 6c66 2e70 7265 6669 782e 6164 645f  self.prefix.add_
-00008950: 6475 7261 7469 6f6e 2861 6374 696f 6e2c  duration(action,
-00008960: 2073 7461 7274 2c20 7374 6f70 290a 0a20   start, stop).. 
-00008970: 2020 2064 6566 2061 6464 2873 656c 662c     def add(self,
-00008980: 206f 7468 6572 3a20 5461 736b 5374 6174   other: TaskStat
-00008990: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-000089a0: 2020 2020 7365 6c66 2e73 7461 7465 735b      self.states[
-000089b0: 6f74 6865 722e 7374 6174 655d 202b 3d20  other.state] += 
-000089c0: 310a 2020 2020 2020 2020 6f74 6865 722e  1.        other.
-000089d0: 6772 6f75 7020 3d20 7365 6c66 0a0a 2020  group = self..  
-000089e0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
-000089f0: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-00008a00: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-00008a10: 2020 2020 2020 2020 2020 223c 220a 2020            "<".  
-00008a20: 2020 2020 2020 2020 2020 2b20 2873 656c            + (sel
-00008a30: 662e 6e61 6d65 206f 7220 226e 6f2d 6772  f.name or "no-gr
-00008a40: 6f75 7022 290a 2020 2020 2020 2020 2020  oup").          
-00008a50: 2020 2b20 223a 2022 0a20 2020 2020 2020    + ": ".       
-00008a60: 2020 2020 202b 2022 2c20 222e 6a6f 696e       + ", ".join
-00008a70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008a80: 2020 2225 733a 2025 6422 2025 2028 6b2c    "%s: %d" % (k,
-00008a90: 2076 2920 666f 7220 286b 2c20 7629 2069   v) for (k, v) i
-00008aa0: 6e20 736f 7274 6564 2873 656c 662e 7374  n sorted(self.st
-00008ab0: 6174 6573 2e69 7465 6d73 2829 2920 6966  ates.items()) if
-00008ac0: 2076 0a20 2020 2020 2020 2020 2020 2029   v.            )
-00008ad0: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
-00008ae0: 3e22 0a20 2020 2020 2020 2029 0a0a 2020  >".        )..  
-00008af0: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
-00008b00: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-00008b10: 2020 2020 7265 7475 726e 2073 756d 2873      return sum(s
-00008b20: 656c 662e 7374 6174 6573 2e76 616c 7565  elf.states.value
-00008b30: 7328 2929 0a0a 2020 2020 6465 6620 5f74  s())..    def _t
-00008b40: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
-00008b50: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
-00008b60: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
-00008b70: 3d20 2829 2920 2d3e 2064 6963 745b 7374  = ()) -> dict[st
-00008b80: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
-00008b90: 2022 2222 4469 6374 696f 6e61 7279 2072   """Dictionary r
-00008ba0: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
-00008bb0: 7220 6465 6275 6767 696e 6720 7075 7270  r debugging purp
-00008bc0: 6f73 6573 2e0a 2020 2020 2020 2020 4e6f  oses..        No
-00008bd0: 7420 7479 7065 2073 7461 626c 6520 616e  t type stable an
-00008be0: 6420 6e6f 7420 696e 7465 6e64 6564 2066  d not intended f
-00008bf0: 6f72 2072 6f75 6e64 7472 6970 732e 0a0a  or roundtrips...
-00008c00: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-00008c10: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00008c20: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
-00008c30: 2e64 756d 705f 636c 7573 7465 725f 7374  .dump_cluster_st
-00008c40: 6174 650a 2020 2020 2020 2020 6469 7374  ate.        dist
-00008c50: 7269 6275 7465 642e 7574 696c 732e 7265  ributed.utils.re
-00008c60: 6375 7273 6976 655f 746f 5f64 6963 740a  cursive_to_dict.
-00008c70: 2020 2020 2020 2020 5461 736b 5374 6174          TaskStat
-00008c80: 652e 5f74 6f5f 6469 6374 0a20 2020 2020  e._to_dict.     
-00008c90: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00008ca0: 6574 7572 6e20 7265 6375 7273 6976 655f  eturn recursive_
-00008cb0: 746f 5f64 6963 7428 7365 6c66 2c20 6578  to_dict(self, ex
-00008cc0: 636c 7564 653d 6578 636c 7564 652c 206d  clude=exclude, m
-00008cd0: 656d 6265 7273 3d54 7275 6529 0a0a 0a63  embers=True)...c
-00008ce0: 6c61 7373 2054 6173 6b53 7461 7465 3a0a  lass TaskState:.
-00008cf0: 2020 2020 2222 2241 2073 696d 706c 6520      """A simple 
-00008d00: 6f62 6a65 6374 2068 6f6c 6469 6e67 2069  object holding i
-00008d10: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-00008d20: 2061 2074 6173 6b2e 0a0a 2020 2020 4e6f   a task...    No
-00008d30: 7420 746f 2062 6520 636f 6e66 7573 6564  t to be confused
-00008d40: 2077 6974 6820 3a63 6c61 7373 3a60 6469   with :class:`di
-00008d50: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
-00008d60: 5f73 7461 7465 5f6d 6163 6869 6e65 2e54  _state_machine.T
-00008d70: 6173 6b53 7461 7465 602c 2077 6869 6368  askState`, which
-00008d80: 0a20 2020 2068 6f6c 6473 2073 696d 696c  .    holds simil
-00008d90: 6172 2069 6e66 6f72 6d61 7469 6f6e 206f  ar information o
-00008da0: 6e20 7468 6520 576f 726b 6572 2073 6964  n the Worker sid
-00008db0: 652e 0a20 2020 2022 2222 0a0a 2020 2020  e..    """..    
-00008dc0: 233a 2054 6865 206b 6579 2069 7320 7468  #: The key is th
-00008dd0: 6520 756e 6971 7565 2069 6465 6e74 6966  e unique identif
-00008de0: 6965 7220 6f66 2061 2074 6173 6b2c 2067  ier of a task, g
-00008df0: 656e 6572 616c 6c79 2066 6f72 6d65 6420  enerally formed 
-00008e00: 6672 6f6d 2074 6865 206e 616d 6520 6f66  from the name of
-00008e10: 2074 6865 0a20 2020 2023 3a20 6675 6e63   the.    #: func
-00008e20: 7469 6f6e 2c20 666f 6c6c 6f77 6564 2062  tion, followed b
-00008e30: 7920 6120 6861 7368 206f 6620 7468 6520  y a hash of the 
-00008e40: 6675 6e63 7469 6f6e 2061 6e64 2061 7267  function and arg
-00008e50: 756d 656e 7473 2c20 6c69 6b65 0a20 2020  uments, like.   
-00008e60: 2023 3a20 6060 2769 6e63 2d61 6233 3163   #: ``'inc-ab31c
-00008e70: 3031 3034 3434 3937 3730 3034 6436 3536  010444977004d656
-00008e80: 3631 3064 3264 3432 3165 6327 6060 2e0a  610d2d421ec'``..
-00008e90: 2020 2020 6b65 793a 2073 7472 0a0a 2020      key: str..  
-00008ea0: 2020 233a 2054 6865 2062 726f 6164 2063    #: The broad c
-00008eb0: 6c61 7373 206f 6620 7461 736b 7320 746f  lass of tasks to
-00008ec0: 2077 6869 6368 2074 6869 7320 7461 736b   which this task
-00008ed0: 2062 656c 6f6e 6773 206c 696b 6520 2269   belongs like "i
-00008ee0: 6e63 2220 6f72 2022 7265 6164 5f63 7376  nc" or "read_csv
-00008ef0: 220a 2020 2020 7072 6566 6978 3a20 5461  ".    prefix: Ta
-00008f00: 736b 5072 6566 6978 0a0a 2020 2020 233a  skPrefix..    #:
-00008f10: 2041 2073 7065 6369 6669 6361 7469 6f6e   A specification
-00008f20: 206f 6620 686f 7720 746f 2072 756e 2074   of how to run t
-00008f30: 6865 2074 6173 6b2e 2020 5468 6520 7479  he task.  The ty
-00008f40: 7065 2061 6e64 206d 6561 6e69 6e67 206f  pe and meaning o
-00008f50: 6620 7468 6973 2076 616c 7565 2069 730a  f this value is.
-00008f60: 2020 2020 233a 206f 7061 7175 6520 746f      #: opaque to
-00008f70: 2074 6865 2073 6368 6564 756c 6572 2c20   the scheduler, 
-00008f80: 6173 2069 7420 6973 206f 6e6c 7920 696e  as it is only in
-00008f90: 7465 7270 7265 7465 6420 6279 2074 6865  terpreted by the
-00008fa0: 2077 6f72 6b65 7220 746f 2077 6869 6368   worker to which
-00008fb0: 2074 6865 0a20 2020 2023 3a20 7461 736b   the.    #: task
-00008fc0: 2069 7320 7365 6e74 2066 6f72 2065 7865   is sent for exe
-00008fd0: 6375 7469 6e67 2e0a 2020 2020 233a 0a20  cuting..    #:. 
-00008fe0: 2020 2023 3a20 4173 2061 2073 7065 6369     #: As a speci
-00008ff0: 616c 2063 6173 652c 2074 6869 7320 6174  al case, this at
-00009000: 7472 6962 7574 6520 6d61 7920 616c 736f  tribute may also
-00009010: 2062 6520 6060 4e6f 6e65 6060 2c20 696e   be ``None``, in
-00009020: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
-00009030: 7461 736b 2069 730a 2020 2020 233a 2022  task is.    #: "
-00009040: 7075 7265 2064 6174 6122 2028 7375 6368  pure data" (such
-00009050: 2061 732c 2066 6f72 2065 7861 6d70 6c65   as, for example
-00009060: 2c20 6120 7069 6563 6520 6f66 2064 6174  , a piece of dat
-00009070: 6120 6c6f 6164 6564 2069 6e20 7468 6520  a loaded in the 
-00009080: 7363 6865 6475 6c65 7220 7573 696e 670a  scheduler using.
-00009090: 2020 2020 233a 203a 6d65 7468 3a60 436c      #: :meth:`Cl
-000090a0: 6965 6e74 2e73 6361 7474 6572 6029 2e20  ient.scatter`). 
-000090b0: 2041 2022 7075 7265 2064 6174 6122 2074   A "pure data" t
-000090c0: 6173 6b20 6361 6e6e 6f74 2062 6520 636f  ask cannot be co
-000090d0: 6d70 7574 6564 2061 6761 696e 2069 6620  mputed again if 
-000090e0: 6974 730a 2020 2020 233a 2076 616c 7565  its.    #: value
-000090f0: 2069 7320 6c6f 7374 2e0a 2020 2020 7275   is lost..    ru
-00009100: 6e5f 7370 6563 3a20 6f62 6a65 6374 0a0a  n_spec: object..
-00009110: 2020 2020 233a 2054 6865 2070 7269 6f72      #: The prior
-00009120: 6974 7920 7072 6f76 6964 6573 2065 6163  ity provides eac
-00009130: 6820 7461 736b 2077 6974 6820 6120 7265  h task with a re
-00009140: 6c61 7469 7665 2072 616e 6b69 6e67 2077  lative ranking w
-00009150: 6869 6368 2069 7320 7573 6564 2074 6f20  hich is used to 
-00009160: 6272 6561 6b0a 2020 2020 233a 2074 6965  break.    #: tie
-00009170: 7320 7768 656e 206d 616e 7920 7461 736b  s when many task
-00009180: 7320 6172 6520 6265 696e 6720 636f 6e73  s are being cons
-00009190: 6964 6572 6564 2066 6f72 2065 7865 6375  idered for execu
-000091a0: 7469 6f6e 2e0a 2020 2020 233a 0a20 2020  tion..    #:.   
-000091b0: 2023 3a20 5468 6973 2072 616e 6b69 6e67   #: This ranking
-000091c0: 2069 7320 6765 6e65 7261 6c6c 7920 6120   is generally a 
-000091d0: 322d 6974 656d 2074 7570 6c65 2e20 2054  2-item tuple.  T
-000091e0: 6865 2066 6972 7374 2028 616e 6420 646f  he first (and do
-000091f0: 6d69 6e61 6e74 2920 6974 656d 0a20 2020  minant) item.   
-00009200: 2023 3a20 636f 7272 6573 706f 6e64 7320   #: corresponds 
-00009210: 746f 2077 6865 6e20 6974 2077 6173 2073  to when it was s
-00009220: 7562 6d69 7474 6564 2e20 2047 656e 6572  ubmitted.  Gener
-00009230: 616c 6c79 2c20 6561 726c 6965 7220 7461  ally, earlier ta
-00009240: 736b 7320 7461 6b65 2070 7265 6365 6465  sks take precede
-00009250: 6e63 652e 0a20 2020 2023 3a20 5468 6520  nce..    #: The 
-00009260: 7365 636f 6e64 2069 7465 6d20 6973 2064  second item is d
-00009270: 6574 6572 6d69 6e65 6420 6279 2074 6865  etermined by the
-00009280: 2063 6c69 656e 742c 2061 6e64 2069 7320   client, and is 
-00009290: 6120 7761 7920 746f 2070 7269 6f72 6974  a way to priorit
-000092a0: 697a 6520 7461 736b 730a 2020 2020 233a  ize tasks.    #:
-000092b0: 2077 6974 6869 6e20 6120 6c61 7267 6520   within a large 
-000092c0: 6772 6170 6820 7468 6174 206d 6179 2062  graph that may b
-000092d0: 6520 696d 706f 7274 616e 742c 2073 7563  e important, suc
-000092e0: 6820 6173 2069 6620 7468 6579 2061 7265  h as if they are
-000092f0: 206f 6e20 7468 6520 6372 6974 6963 616c   on the critical
-00009300: 0a20 2020 2023 3a20 7061 7468 2c20 6f72  .    #: path, or
-00009310: 2067 6f6f 6420 746f 2072 756e 2069 6e20   good to run in 
-00009320: 6f72 6465 7220 746f 2072 656c 6561 7365  order to release
-00009330: 206d 616e 7920 6465 7065 6e64 656e 6369   many dependenci
-00009340: 6573 2e20 2054 6869 7320 6973 2065 7870  es.  This is exp
-00009350: 6c61 696e 6564 0a20 2020 2023 3a20 6675  lained.    #: fu
-00009360: 7274 6865 7220 696e 203a 646f 633a 6053  rther in :doc:`S
-00009370: 6368 6564 756c 696e 6720 506f 6c69 6379  cheduling Policy
-00009380: 203c 7363 6865 6475 6c69 6e67 2d70 6f6c   <scheduling-pol
-00009390: 6963 6965 733e 602e 0a20 2020 2070 7269  icies>`..    pri
-000093a0: 6f72 6974 793a 2074 7570 6c65 5b66 6c6f  ority: tuple[flo
-000093b0: 6174 2c20 2e2e 2e5d 207c 204e 6f6e 650a  at, ...] | None.
-000093c0: 0a20 2020 2023 2041 7474 7269 6275 7465  .    # Attribute
-000093d0: 2075 6e64 6572 6c79 696e 6720 7468 6520   underlying the 
-000093e0: 7374 6174 6520 7072 6f70 6572 7479 0a20  state property. 
-000093f0: 2020 205f 7374 6174 653a 2054 6173 6b53     _state: TaskS
-00009400: 7461 7465 5374 6174 650a 0a20 2020 2023  tateState..    #
-00009410: 3a20 5468 6520 7365 7420 6f66 2074 6173  : The set of tas
-00009420: 6b73 2074 6869 7320 7461 736b 2064 6570  ks this task dep
-00009430: 656e 6473 206f 6e20 666f 7220 7072 6f70  ends on for prop
-00009440: 6572 2065 7865 6375 7469 6f6e 2e20 4f6e  er execution. On
-00009450: 6c79 2074 6173 6b73 2073 7469 6c6c 0a20  ly tasks still. 
-00009460: 2020 2023 3a20 616c 6976 6520 6172 6520     #: alive are 
-00009470: 6c69 7374 6564 2069 6e20 7468 6973 2073  listed in this s
-00009480: 6574 2e20 4966 2c20 666f 7220 7768 6174  et. If, for what
-00009490: 6576 6572 2072 6561 736f 6e2c 2074 6869  ever reason, thi
-000094a0: 7320 7461 736b 2061 6c73 6f20 6465 7065  s task also depe
-000094b0: 6e64 7320 6f6e 0a20 2020 2023 3a20 6120  nds on.    #: a 
-000094c0: 666f 7267 6f74 7465 6e20 7461 736b 2c20  forgotten task, 
-000094d0: 7468 6520 3a61 7474 723a 6068 6173 5f6c  the :attr:`has_l
-000094e0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-000094f0: 6020 666c 6167 2069 7320 7365 742e 0a20  ` flag is set.. 
-00009500: 2020 2023 3a0a 2020 2020 233a 2041 2074     #:.    #: A t
-00009510: 6173 6b20 6361 6e20 6f6e 6c79 2062 6520  ask can only be 
-00009520: 6578 6563 7574 6564 206f 6e63 6520 616c  executed once al
-00009530: 6c20 6974 7320 6465 7065 6e64 656e 6369  l its dependenci
-00009540: 6573 2068 6176 6520 616c 7265 6164 7920  es have already 
-00009550: 6265 656e 0a20 2020 2023 3a20 7375 6363  been.    #: succ
-00009560: 6573 7366 756c 6c79 2065 7865 6375 7465  essfully execute
-00009570: 6420 616e 6420 6861 7665 2074 6865 6972  d and have their
-00009580: 2072 6573 756c 7420 7374 6f72 6564 206f   result stored o
-00009590: 6e20 6174 206c 6561 7374 206f 6e65 2077  n at least one w
-000095a0: 6f72 6b65 722e 2054 6869 730a 2020 2020  orker. This.    
-000095b0: 233a 2069 7320 7472 6163 6b65 6420 6279  #: is tracked by
-000095c0: 2070 726f 6772 6573 7369 7665 6c79 2064   progressively d
-000095d0: 7261 696e 696e 6720 7468 6520 3a61 7474  raining the :att
-000095e0: 723a 6077 6169 7469 6e67 5f6f 6e60 2073  r:`waiting_on` s
-000095f0: 6574 2e0a 2020 2020 6465 7065 6e64 656e  et..    dependen
-00009600: 6369 6573 3a20 7365 745b 5461 736b 5374  cies: set[TaskSt
-00009610: 6174 655d 0a0a 2020 2020 233a 2054 6865  ate]..    #: The
-00009620: 2073 6574 206f 6620 7461 736b 7320 7768   set of tasks wh
-00009630: 6963 6820 6465 7065 6e64 206f 6e20 7468  ich depend on th
-00009640: 6973 2074 6173 6b2e 2020 4f6e 6c79 2074  is task.  Only t
-00009650: 6173 6b73 2073 7469 6c6c 2061 6c69 7665  asks still alive
-00009660: 2061 7265 206c 6973 7465 6420 696e 0a20   are listed in. 
-00009670: 2020 2023 3a20 7468 6973 2073 6574 2e20     #: this set. 
-00009680: 5468 6973 2069 7320 7468 6520 7265 7665  This is the reve
-00009690: 7273 6520 6d61 7070 696e 6720 6f66 203a  rse mapping of :
-000096a0: 6174 7472 3a60 6465 7065 6e64 656e 6369  attr:`dependenci
-000096b0: 6573 602e 0a20 2020 2064 6570 656e 6465  es`..    depende
-000096c0: 6e74 733a 2073 6574 5b54 6173 6b53 7461  nts: set[TaskSta
-000096d0: 7465 5d0a 0a20 2020 2023 3a20 5768 6574  te]..    #: Whet
-000096e0: 6865 7220 616e 7920 6f66 2074 6865 2064  her any of the d
-000096f0: 6570 656e 6465 6e63 6965 7320 6f66 2074  ependencies of t
-00009700: 6869 7320 7461 736b 2068 6173 2062 6565  his task has bee
-00009710: 6e20 666f 7267 6f74 7465 6e2e 2046 6f72  n forgotten. For
-00009720: 206d 656d 6f72 790a 2020 2020 233a 2063   memory.    #: c
-00009730: 6f6e 7375 6d70 7469 6f6e 2072 6561 736f  onsumption reaso
-00009740: 6e73 2c20 666f 7267 6f74 7465 6e20 7461  ns, forgotten ta
-00009750: 736b 7320 6172 6520 6e6f 7420 6b65 7074  sks are not kept
-00009760: 2069 6e20 6d65 6d6f 7279 2065 7665 6e20   in memory even 
-00009770: 7468 6f75 6768 2074 6865 7920 6d61 790a  though they may.
-00009780: 2020 2020 233a 2068 6176 6520 6465 7065      #: have depe
-00009790: 6e64 656e 7420 7461 736b 732e 2020 5768  ndent tasks.  Wh
-000097a0: 656e 2061 2074 6173 6b20 6973 2066 6f72  en a task is for
-000097b0: 676f 7474 656e 2c20 7468 6572 6566 6f72  gotten, therefor
-000097c0: 652c 2065 6163 6820 6f66 2069 7473 0a20  e, each of its. 
-000097d0: 2020 2023 3a20 6465 7065 6e64 656e 7473     #: dependents
-000097e0: 2068 6173 2074 6865 6972 203a 6174 7472   has their :attr
-000097f0: 3a60 6861 735f 6c6f 7374 5f64 6570 656e  :`has_lost_depen
-00009800: 6465 6e63 6965 7360 2061 7474 7269 6275  dencies` attribu
-00009810: 7465 2073 6574 2074 6f20 6060 5472 7565  te set to ``True
-00009820: 6060 2e0a 2020 2020 233a 0a20 2020 2023  ``..    #:.    #
-00009830: 3a20 4966 203a 6174 7472 3a60 6861 735f  : If :attr:`has_
-00009840: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
-00009850: 7360 2069 7320 7472 7565 2c20 7468 6973  s` is true, this
-00009860: 2074 6173 6b20 6361 6e6e 6f74 2067 6f20   task cannot go 
-00009870: 696e 746f 2074 6865 0a20 2020 2023 3a20  into the.    #: 
-00009880: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
-00009890: 7465 2061 6e79 6d6f 7265 2e0a 2020 2020  te anymore..    
-000098a0: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
-000098b0: 6e63 6965 733a 2062 6f6f 6c0a 0a20 2020  ncies: bool..   
-000098c0: 2023 3a20 5468 6520 7365 7420 6f66 2074   #: The set of t
-000098d0: 6173 6b73 2074 6869 7320 7461 736b 2069  asks this task i
-000098e0: 7320 7761 6974 696e 6720 6f6e 202a 6265  s waiting on *be
-000098f0: 666f 7265 2a20 6974 2063 616e 2062 6520  fore* it can be 
-00009900: 6578 6563 7574 6564 2e20 5468 6973 2069  executed. This i
-00009910: 730a 2020 2020 233a 2061 6c77 6179 7320  s.    #: always 
-00009920: 6120 7375 6273 6574 206f 6620 3a61 7474  a subset of :att
-00009930: 723a 6064 6570 656e 6465 6e63 6965 7360  r:`dependencies`
-00009940: 2e20 2045 6163 6820 7469 6d65 206f 6e65  .  Each time one
-00009950: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
-00009960: 6369 6573 2068 6173 0a20 2020 2023 3a20  cies has.    #: 
-00009970: 6669 6e69 7368 6564 2070 726f 6365 7373  finished process
-00009980: 696e 672c 2069 7420 6973 2072 656d 6f76  ing, it is remov
-00009990: 6564 2066 726f 6d20 7468 6520 3a61 7474  ed from the :att
-000099a0: 723a 6077 6169 7469 6e67 5f6f 6e60 2073  r:`waiting_on` s
-000099b0: 6574 2e0a 2020 2020 233a 0a20 2020 2023  et..    #:.    #
-000099c0: 3a20 4f6e 6365 203a 6174 7472 3a60 7761  : Once :attr:`wa
-000099d0: 6974 696e 675f 6f6e 6020 6265 636f 6d65  iting_on` become
-000099e0: 7320 656d 7074 792c 2074 6869 7320 7461  s empty, this ta
-000099f0: 736b 2063 616e 206d 6f76 6520 6672 6f6d  sk can move from
-00009a00: 2074 6865 2022 7761 6974 696e 6722 0a20   the "waiting". 
-00009a10: 2020 2023 3a20 7374 6174 6520 746f 2074     #: state to t
-00009a20: 6865 2022 7072 6f63 6573 7369 6e67 2220  he "processing" 
-00009a30: 7374 6174 6520 2875 6e6c 6573 7320 6f6e  state (unless on
-00009a40: 6520 6f66 2074 6865 2064 6570 656e 6465  e of the depende
-00009a50: 6e63 6965 7320 6572 726f 7265 6420 6f75  ncies errored ou
-00009a60: 742c 2069 6e0a 2020 2020 233a 2077 6869  t, in.    #: whi
-00009a70: 6368 2063 6173 6520 7468 6973 2074 6173  ch case this tas
-00009a80: 6b20 6973 2069 6e73 7465 6164 206d 6172  k is instead mar
-00009a90: 6b65 6420 2265 7272 6564 2229 2e0a 2020  ked "erred")..  
-00009aa0: 2020 7761 6974 696e 675f 6f6e 3a20 7365    waiting_on: se
-00009ab0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-00009ac0: 2020 233a 2054 6865 2073 6574 206f 6620    #: The set of 
-00009ad0: 7461 736b 7320 7768 6963 6820 6e65 6564  tasks which need
-00009ae0: 2074 6869 7320 7461 736b 2074 6f20 7265   this task to re
-00009af0: 6d61 696e 2061 6c69 7665 2e20 2054 6869  main alive.  Thi
-00009b00: 7320 6973 2061 6c77 6179 7320 6120 7375  s is always a su
-00009b10: 6273 6574 0a20 2020 2023 3a20 6f66 203a  bset.    #: of :
-00009b20: 6174 7472 3a60 6465 7065 6e64 656e 7473  attr:`dependents
-00009b30: 602e 2020 4561 6368 2074 696d 6520 6f6e  `.  Each time on
-00009b40: 6520 6f66 2074 6865 2064 6570 656e 6465  e of the depende
-00009b50: 6e74 7320 6861 7320 6669 6e69 7368 6564  nts has finished
-00009b60: 2070 726f 6365 7373 696e 672c 0a20 2020   processing,.   
-00009b70: 2023 3a20 6974 2069 7320 7265 6d6f 7665   #: it is remove
-00009b80: 6420 6672 6f6d 2074 6865 203a 6174 7472  d from the :attr
-00009b90: 3a60 7761 6974 6572 7360 2073 6574 2e0a  :`waiters` set..
-00009ba0: 2020 2020 233a 0a20 2020 2023 3a20 4f6e      #:.    #: On
-00009bb0: 6365 2062 6f74 6820 3a61 7474 723a 6077  ce both :attr:`w
-00009bc0: 6169 7465 7273 6020 616e 6420 3a61 7474  aiters` and :att
-00009bd0: 723a 6077 686f 5f77 616e 7473 6020 6265  r:`who_wants` be
-00009be0: 636f 6d65 2065 6d70 7479 2c20 7468 6973  come empty, this
-00009bf0: 2074 6173 6b20 6361 6e20 6265 0a20 2020   task can be.   
-00009c00: 2023 3a20 7265 6c65 6173 6564 2028 6966   #: released (if
-00009c10: 2069 7420 6861 7320 6120 6e6f 6e2d 656d   it has a non-em
-00009c20: 7074 7920 3a61 7474 723a 6072 756e 5f73  pty :attr:`run_s
-00009c30: 7065 6360 2920 6f72 2066 6f72 676f 7474  pec`) or forgott
-00009c40: 656e 2028 6f74 6865 7277 6973 6529 2062  en (otherwise) b
-00009c50: 7920 7468 650a 2020 2020 233a 2073 6368  y the.    #: sch
-00009c60: 6564 756c 6572 2c20 616e 6420 6279 2061  eduler, and by a
-00009c70: 6e79 2077 6f72 6b65 7273 2069 6e20 3a61  ny workers in :a
-00009c80: 7474 723a 6077 686f 5f68 6173 602e 0a20  ttr:`who_has`.. 
-00009c90: 2020 2023 3a0a 2020 2020 233a 202e 2e20     #:.    #: .. 
-00009ca0: 6e6f 7465 3a3a 0a20 2020 2023 3a20 2020  note::.    #:   
-00009cb0: 2043 6f75 6e74 6572 2d69 6e74 7569 7469   Counter-intuiti
-00009cc0: 7665 6c79 2c20 3a61 7474 723a 6077 6169  vely, :attr:`wai
-00009cd0: 7469 6e67 5f6f 6e60 2061 6e64 203a 6174  ting_on` and :at
-00009ce0: 7472 3a60 7761 6974 6572 7360 2061 7265  tr:`waiters` are
-00009cf0: 206e 6f74 2072 6576 6572 7365 0a20 2020   not reverse.   
-00009d00: 2023 3a20 2020 206d 6170 7069 6e67 7320   #:    mappings 
-00009d10: 6f66 2065 6163 6820 6f74 6865 722e 0a20  of each other.. 
-00009d20: 2020 2077 6169 7465 7273 3a20 7365 745b     waiters: set[
-00009d30: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
-00009d40: 233a 2054 6865 2073 6574 206f 6620 636c  #: The set of cl
-00009d50: 6965 6e74 7320 7768 6f20 7761 6e74 2074  ients who want t
-00009d60: 6865 2072 6573 756c 7420 6f66 2074 6869  he result of thi
-00009d70: 7320 7461 736b 2074 6f20 7265 6d61 696e  s task to remain
-00009d80: 2061 6c69 7665 2e0a 2020 2020 233a 2054   alive..    #: T
-00009d90: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
-00009da0: 7365 206d 6170 7069 6e67 206f 6620 3a61  se mapping of :a
-00009db0: 7474 723a 6043 6c69 656e 7453 7461 7465  ttr:`ClientState
-00009dc0: 2e77 616e 7473 5f77 6861 7460 2e0a 2020  .wants_what`..  
-00009dd0: 2020 233a 0a20 2020 2023 3a20 5768 656e    #:.    #: When
-00009de0: 2061 2063 6c69 656e 7420 7375 626d 6974   a client submit
-00009df0: 7320 6120 6772 6170 6820 746f 2074 6865  s a graph to the
-00009e00: 2073 6368 6564 756c 6572 2069 7420 616c   scheduler it al
-00009e10: 736f 2073 7065 6369 6669 6573 2077 6869  so specifies whi
-00009e20: 6368 206f 7574 7075 740a 2020 2020 233a  ch output.    #:
-00009e30: 2074 6173 6b73 2069 7420 6465 7369 7265   tasks it desire
-00009e40: 732c 2073 7563 6820 7468 6174 2074 6865  s, such that the
-00009e50: 6972 2072 6573 756c 7473 2061 7265 206e  ir results are n
-00009e60: 6f74 2072 656c 6561 7365 6420 6672 6f6d  ot released from
-00009e70: 206d 656d 6f72 792e 0a20 2020 2023 3a0a   memory..    #:.
-00009e80: 2020 2020 233a 204f 6e63 6520 6120 7461      #: Once a ta
-00009e90: 736b 2068 6173 2066 696e 6973 6865 6420  sk has finished 
-00009ea0: 6578 6563 7574 696e 6720 2869 2e65 2e20  executing (i.e. 
-00009eb0: 6d6f 7665 7320 696e 746f 2074 6865 2022  moves into the "
-00009ec0: 6d65 6d6f 7279 2220 6f72 2022 6572 7265  memory" or "erre
-00009ed0: 6422 0a20 2020 2023 3a20 7374 6174 6529  d".    #: state)
-00009ee0: 2c20 7468 6520 636c 6965 6e74 7320 696e  , the clients in
-00009ef0: 203a 6174 7472 3a60 7768 6f5f 7761 6e74   :attr:`who_want
-00009f00: 7360 2061 7265 206e 6f74 6966 6965 642e  s` are notified.
-00009f10: 0a20 2020 2023 3a0a 2020 2020 233a 204f  .    #:.    #: O
-00009f20: 6e63 6520 626f 7468 203a 6174 7472 3a60  nce both :attr:`
-00009f30: 7761 6974 6572 7360 2061 6e64 203a 6174  waiters` and :at
-00009f40: 7472 3a60 7768 6f5f 7761 6e74 7360 2062  tr:`who_wants` b
-00009f50: 6563 6f6d 6520 656d 7074 792c 2074 6869  ecome empty, thi
-00009f60: 7320 7461 736b 2063 616e 2062 650a 2020  s task can be.  
-00009f70: 2020 233a 2072 656c 6561 7365 6420 2869    #: released (i
-00009f80: 6620 6974 2068 6173 2061 206e 6f6e 2d65  f it has a non-e
-00009f90: 6d70 7479 203a 6174 7472 3a60 7275 6e5f  mpty :attr:`run_
-00009fa0: 7370 6563 6029 206f 7220 666f 7267 6f74  spec`) or forgot
-00009fb0: 7465 6e20 286f 7468 6572 7769 7365 2920  ten (otherwise) 
-00009fc0: 6279 2074 6865 0a20 2020 2023 3a20 7363  by the.    #: sc
-00009fd0: 6865 6475 6c65 722c 2061 6e64 2062 7920  heduler, and by 
-00009fe0: 616e 7920 776f 726b 6572 7320 696e 203a  any workers in :
-00009ff0: 6174 7472 3a60 7768 6f5f 6861 7360 2e0a  attr:`who_has`..
-0000a000: 2020 2020 7768 6f5f 7761 6e74 733a 2073      who_wants: s
-0000a010: 6574 5b43 6c69 656e 7453 7461 7465 5d0a  et[ClientState].
-0000a020: 0a20 2020 2023 3a20 5468 6520 7365 7420  .    #: The set 
-0000a030: 6f66 2077 6f72 6b65 7273 2077 686f 2068  of workers who h
-0000a040: 6176 6520 7468 6973 2074 6173 6b27 7320  ave this task's 
-0000a050: 7265 7375 6c74 2069 6e20 6d65 6d6f 7279  result in memory
-0000a060: 2e20 4974 2069 7320 6e6f 6e2d 656d 7074  . It is non-empt
-0000a070: 7920 6966 6620 7468 650a 2020 2020 233a  y iff the.    #:
-0000a080: 2074 6173 6b20 6973 2069 6e20 7468 6520   task is in the 
-0000a090: 226d 656d 6f72 7922 2073 7461 7465 2e20  "memory" state. 
-0000a0a0: 2054 6865 7265 2063 616e 2062 6520 6d6f   There can be mo
-0000a0b0: 7265 2074 6861 6e20 6f6e 6520 776f 726b  re than one work
-0000a0c0: 6572 2069 6e20 7468 6973 2073 6574 2069  er in this set i
-0000a0d0: 662c 0a20 2020 2023 3a20 666f 7220 6578  f,.    #: for ex
-0000a0e0: 616d 706c 652c 203a 6d65 7468 3a60 436c  ample, :meth:`Cl
-0000a0f0: 6965 6e74 2e73 6361 7474 6572 6020 6f72  ient.scatter` or
-0000a100: 203a 6d65 7468 3a60 436c 6965 6e74 2e72   :meth:`Client.r
-0000a110: 6570 6c69 6361 7465 6020 7761 7320 7573  eplicate` was us
-0000a120: 6564 2e0a 2020 2020 233a 0a20 2020 2023  ed..    #:.    #
-0000a130: 3a20 5468 6973 2069 7320 7468 6520 7265  : This is the re
-0000a140: 7665 7273 6520 6d61 7070 696e 6720 6f66  verse mapping of
-0000a150: 203a 6174 7472 3a60 576f 726b 6572 5374   :attr:`WorkerSt
-0000a160: 6174 652e 6861 735f 7768 6174 602e 0a20  ate.has_what`.. 
-0000a170: 2020 2077 686f 5f68 6173 3a20 7365 745b     who_has: set[
-0000a180: 576f 726b 6572 5374 6174 655d 0a0a 2020  WorkerState]..  
-0000a190: 2020 233a 2049 6620 7468 6973 2074 6173    #: If this tas
-0000a1a0: 6b20 6973 2069 6e20 7468 6520 2270 726f  k is in the "pro
-0000a1b0: 6365 7373 696e 6722 2073 7461 7465 2c20  cessing" state, 
-0000a1c0: 7768 6963 6820 776f 726b 6572 2069 7320  which worker is 
-0000a1d0: 6375 7272 656e 746c 7920 7072 6f63 6573  currently proces
-0000a1e0: 7369 6e67 0a20 2020 2023 3a20 6974 2e20  sing.    #: it. 
-0000a1f0: 5468 6973 2061 7474 7269 6275 7465 2069  This attribute i
-0000a200: 7320 6b65 7074 2069 6e20 7379 6e63 2077  s kept in sync w
-0000a210: 6974 6820 3a61 7474 723a 6057 6f72 6b65  ith :attr:`Worke
-0000a220: 7253 7461 7465 2e70 726f 6365 7373 696e  rState.processin
-0000a230: 6760 2e0a 2020 2020 7072 6f63 6573 7369  g`..    processi
-0000a240: 6e67 5f6f 6e3a 2057 6f72 6b65 7253 7461  ng_on: WorkerSta
-0000a250: 7465 207c 204e 6f6e 650a 0a20 2020 2023  te | None..    #
-0000a260: 3a20 5468 6520 6e75 6d62 6572 206f 6620  : The number of 
-0000a270: 7469 6d65 7320 7468 6973 2074 6173 6b20  times this task 
-0000a280: 6361 6e20 6175 746f 6d61 7469 6361 6c6c  can automaticall
-0000a290: 7920 6265 2072 6574 7269 6564 2069 6e20  y be retried in 
-0000a2a0: 6361 7365 206f 6620 6661 696c 7572 652e  case of failure.
-0000a2b0: 0a20 2020 2023 3a20 4966 2061 2074 6173  .    #: If a tas
-0000a2c0: 6b20 6661 696c 7320 6578 6563 7574 696e  k fails executin
-0000a2d0: 6720 2874 6865 2077 6f72 6b65 7220 7265  g (the worker re
-0000a2e0: 7475 726e 7320 7769 7468 2061 6e20 6572  turns with an er
-0000a2f0: 726f 7229 2c20 6974 7320 3a61 7474 723a  ror), its :attr:
-0000a300: 6072 6574 7269 6573 600a 2020 2020 233a  `retries`.    #:
-0000a310: 2061 7474 7269 6275 7465 2069 7320 6368   attribute is ch
-0000a320: 6563 6b65 642e 2049 6620 6974 2069 7320  ecked. If it is 
-0000a330: 6571 7561 6c20 746f 2030 2c20 7468 6520  equal to 0, the 
-0000a340: 7461 736b 2069 7320 6d61 726b 6564 2022  task is marked "
-0000a350: 6572 7265 6422 2e20 4966 2069 7420 6973  erred". If it is
-0000a360: 0a20 2020 2023 3a20 6772 6561 7465 7220  .    #: greater 
-0000a370: 7468 616e 2030 2c20 7468 6520 3a61 7474  than 0, the :att
-0000a380: 723a 6072 6574 7269 6573 6020 6174 7472  r:`retries` attr
-0000a390: 6962 7574 6520 6973 2064 6563 7265 6d65  ibute is decreme
-0000a3a0: 6e74 6564 2061 6e64 2065 7865 6375 7469  nted and executi
-0000a3b0: 6f6e 2069 730a 2020 2020 233a 2061 7474  on is.    #: att
-0000a3c0: 656d 7074 6564 2061 6761 696e 2e0a 2020  empted again..  
-0000a3d0: 2020 7265 7472 6965 733a 2069 6e74 0a0a    retries: int..
-0000a3e0: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
-0000a3f0: 7220 6f66 2062 7974 6573 2c20 6173 2064  r of bytes, as d
-0000a400: 6574 6572 6d69 6e65 6420 6279 2060 6073  etermined by ``s
-0000a410: 697a 656f 6660 602c 206f 6620 7468 6520  izeof``, of the 
-0000a420: 7265 7375 6c74 206f 6620 6120 6669 6e69  result of a fini
-0000a430: 7368 6564 0a20 2020 2023 3a20 7461 736b  shed.    #: task
-0000a440: 2e20 5468 6973 206e 756d 6265 7220 6973  . This number is
-0000a450: 2075 7365 6420 666f 7220 6469 6167 6e6f   used for diagno
-0000a460: 7374 6963 7320 616e 6420 746f 2068 656c  stics and to hel
-0000a470: 7020 7072 696f 7269 7469 7a65 2077 6f72  p prioritize wor
-0000a480: 6b2e 0a20 2020 2023 3a20 5365 7420 746f  k..    #: Set to
-0000a490: 202d 3120 666f 7220 756e 6669 6e69 7368   -1 for unfinish
-0000a4a0: 6564 2074 6173 6b73 2e0a 2020 2020 6e62  ed tasks..    nb
-0000a4b0: 7974 6573 3a20 696e 740a 0a20 2020 2023  ytes: int..    #
-0000a4c0: 3a20 5468 6520 7479 7065 206f 6620 7468  : The type of th
-0000a4d0: 6520 6f62 6a65 6374 2061 7320 6120 7374  e object as a st
-0000a4e0: 7269 6e67 2e20 4f6e 6c79 2070 7265 7365  ring. Only prese
-0000a4f0: 6e74 2066 6f72 2074 6173 6b73 2074 6861  nt for tasks tha
-0000a500: 7420 6861 7665 2062 6565 6e0a 2020 2020  t have been.    
-0000a510: 233a 2063 6f6d 7075 7465 642e 0a20 2020  #: computed..   
-0000a520: 2074 7970 653a 2073 7472 0a0a 2020 2020   type: str..    
-0000a530: 233a 2049 6620 7468 6973 2074 6173 6b20  #: If this task 
-0000a540: 6661 696c 6564 2065 7865 6375 7469 6e67  failed executing
-0000a550: 2c20 7468 6520 6578 6365 7074 696f 6e20  , the exception 
-0000a560: 6f62 6a65 6374 2069 7320 7374 6f72 6564  object is stored
-0000a570: 2068 6572 652e 0a20 2020 2065 7863 6570   here..    excep
-0000a580: 7469 6f6e 3a20 5365 7269 616c 697a 6564  tion: Serialized
-0000a590: 207c 204e 6f6e 650a 0a20 2020 2023 3a20   | None..    #: 
-0000a5a0: 4966 2074 6869 7320 7461 736b 2066 6169  If this task fai
-0000a5b0: 6c65 6420 6578 6563 7574 696e 672c 2074  led executing, t
-0000a5c0: 6865 2074 7261 6365 6261 636b 206f 626a  he traceback obj
-0000a5d0: 6563 7420 6973 2073 746f 7265 6420 6865  ect is stored he
-0000a5e0: 7265 2e0a 2020 2020 7472 6163 6562 6163  re..    tracebac
-0000a5f0: 6b3a 2053 6572 6961 6c69 7a65 6420 7c20  k: Serialized | 
-0000a600: 4e6f 6e65 0a0a 2020 2020 233a 2073 7472  None..    #: str
-0000a610: 696e 6720 7265 7072 6573 656e 7461 7469  ing representati
-0000a620: 6f6e 206f 6620 6578 6365 7074 696f 6e0a  on of exception.
-0000a630: 2020 2020 6578 6365 7074 696f 6e5f 7465      exception_te
-0000a640: 7874 3a20 7374 720a 0a20 2020 2023 3a20  xt: str..    #: 
-0000a650: 7374 7269 6e67 2072 6570 7265 7365 6e74  string represent
-0000a660: 6174 696f 6e20 6f66 2074 7261 6365 6261  ation of traceba
-0000a670: 636b 0a20 2020 2074 7261 6365 6261 636b  ck.    traceback
-0000a680: 5f74 6578 743a 2073 7472 0a0a 2020 2020  _text: str..    
-0000a690: 233a 2049 6620 7468 6973 2074 6173 6b20  #: If this task 
-0000a6a0: 6f72 206f 6e65 206f 6620 6974 7320 6465  or one of its de
-0000a6b0: 7065 6e64 656e 6369 6573 2066 6169 6c65  pendencies faile
-0000a6c0: 6420 6578 6563 7574 696e 672c 2074 6865  d executing, the
-0000a6d0: 2066 6169 6c65 6420 7461 736b 2069 730a   failed task is.
-0000a6e0: 2020 2020 233a 2073 746f 7265 6420 6865      #: stored he
-0000a6f0: 7265 2028 706f 7373 6962 6c79 2069 7473  re (possibly its
-0000a700: 656c 6629 2e0a 2020 2020 6578 6365 7074  elf)..    except
-0000a710: 696f 6e5f 626c 616d 653a 2054 6173 6b53  ion_blame: TaskS
-0000a720: 7461 7465 207c 204e 6f6e 650a 0a20 2020  tate | None..   
-0000a730: 2023 3a20 576f 726b 6572 2061 6464 7265   #: Worker addre
-0000a740: 7373 6573 206f 6e20 7768 6963 6820 6572  sses on which er
-0000a750: 726f 7273 2061 7070 6561 7265 642c 2063  rors appeared, c
-0000a760: 6175 7369 6e67 2074 6869 7320 7461 736b  ausing this task
-0000a770: 2074 6f20 6265 2069 6e20 616e 2065 7272   to be in an err
-0000a780: 6f72 0a20 2020 2023 3a20 7374 6174 652e  or.    #: state.
-0000a790: 0a20 2020 2065 7272 6564 5f6f 6e3a 2073  .    erred_on: s
-0000a7a0: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
-0000a7b0: 5468 6520 6e75 6d62 6572 206f 6620 7469  The number of ti
-0000a7c0: 6d65 7320 7468 6973 2074 6173 6b20 6861  mes this task ha
-0000a7d0: 7320 6265 656e 2069 6e76 6f6c 7665 6420  s been involved 
-0000a7e0: 696e 2061 2077 6f72 6b65 7220 6465 6174  in a worker deat
-0000a7f0: 682e 0a20 2020 2023 3a0a 2020 2020 233a  h..    #:.    #:
-0000a800: 2053 6f6d 6520 7461 736b 7320 6d61 7920   Some tasks may 
-0000a810: 6361 7573 6520 776f 726b 6572 7320 746f  cause workers to
-0000a820: 2064 6965 2028 7375 6368 2061 7320 6361   die (such as ca
-0000a830: 6c6c 696e 6720 6060 6f73 2e5f 6578 6974  lling ``os._exit
-0000a840: 2830 2960 6029 2e20 5768 656e 2061 0a20  (0)``). When a. 
-0000a850: 2020 2023 3a20 776f 726b 6572 2064 6965     #: worker die
-0000a860: 732c 2061 6c6c 206f 6620 7468 6520 7461  s, all of the ta
-0000a870: 736b 7320 6f6e 2074 6861 7420 776f 726b  sks on that work
-0000a880: 6572 2061 7265 2072 6561 7373 6967 6e65  er are reassigne
-0000a890: 6420 746f 206f 7468 6572 732e 2054 6869  d to others. Thi
-0000a8a0: 730a 2020 2020 233a 2063 6f6d 6269 6e61  s.    #: combina
-0000a8b0: 7469 6f6e 206f 6620 6265 6861 7669 6f72  tion of behavior
-0000a8c0: 7320 6361 6e20 6361 7573 6520 6120 6261  s can cause a ba
-0000a8d0: 6420 7461 736b 2074 6f20 6361 7461 7374  d task to catast
-0000a8e0: 726f 7068 6963 616c 6c79 2064 6573 7472  rophically destr
-0000a8f0: 6f79 2061 6c6c 0a20 2020 2023 3a20 776f  oy all.    #: wo
-0000a900: 726b 6572 7320 6f6e 2074 6865 2063 6c75  rkers on the clu
-0000a910: 7374 6572 2c20 6f6e 6520 6166 7465 7220  ster, one after 
-0000a920: 616e 6f74 6865 722e 2057 6865 6e65 7665  another. Wheneve
-0000a930: 7220 6120 776f 726b 6572 2064 6965 732c  r a worker dies,
-0000a940: 2077 6520 6d61 726b 2065 6163 680a 2020   we mark each.  
-0000a950: 2020 233a 2074 6173 6b20 6375 7272 656e    #: task curren
-0000a960: 746c 7920 7072 6f63 6573 7369 6e67 206f  tly processing o
-0000a970: 6e20 7468 6174 2077 6f72 6b65 7220 2861  n that worker (a
-0000a980: 7320 7265 636f 7264 6564 2062 790a 2020  s recorded by.  
-0000a990: 2020 233a 203a 6174 7472 3a60 576f 726b    #: :attr:`Work
-0000a9a0: 6572 5374 6174 652e 7072 6f63 6573 7369  erState.processi
-0000a9b0: 6e67 6029 2061 7320 7375 7370 6963 696f  ng`) as suspicio
-0000a9c0: 7573 2e20 4966 2061 2074 6173 6b20 6973  us. If a task is
-0000a9d0: 2069 6e76 6f6c 7665 6420 696e 2074 6872   involved in thr
-0000a9e0: 6565 0a20 2020 2023 3a20 6465 6174 6873  ee.    #: deaths
-0000a9f0: 2028 6f72 2073 6f6d 6520 6f74 6865 7220   (or some other 
-0000aa00: 6669 7865 6420 636f 6e73 7461 6e74 2920  fixed constant) 
-0000aa10: 7468 656e 2077 6520 6d61 726b 2074 6865  then we mark the
-0000aa20: 2074 6173 6b20 6173 2060 6065 7272 6564   task as ``erred
-0000aa30: 6060 2e0a 2020 2020 7375 7370 6963 696f  ``..    suspicio
-0000aa40: 7573 3a20 696e 740a 0a20 2020 2023 3a20  us: int..    #: 
-0000aa50: 4120 7365 7420 6f66 2068 6f73 746e 616d  A set of hostnam
-0000aa60: 6573 2077 6865 7265 2074 6869 7320 7461  es where this ta
-0000aa70: 736b 2063 616e 2062 6520 7275 6e20 286f  sk can be run (o
-0000aa80: 7220 6060 4e6f 6e65 6060 2069 6620 656d  r ``None`` if em
-0000aa90: 7074 7929 2e20 5573 7561 6c6c 790a 2020  pty). Usually.  
-0000aaa0: 2020 233a 2074 6869 7320 6973 2065 6d70    #: this is emp
-0000aab0: 7479 2075 6e6c 6573 7320 7468 6520 7461  ty unless the ta
-0000aac0: 736b 2068 6173 2062 6565 6e20 7370 6563  sk has been spec
-0000aad0: 6966 6963 616c 6c79 2072 6573 7472 6963  ifically restric
-0000aae0: 7465 6420 746f 206f 6e6c 7920 7275 6e20  ted to only run 
-0000aaf0: 6f6e 0a20 2020 2023 3a20 6365 7274 6169  on.    #: certai
-0000ab00: 6e20 686f 7374 732e 2041 2068 6f73 746e  n hosts. A hostn
-0000ab10: 616d 6520 6d61 7920 636f 7272 6573 706f  ame may correspo
-0000ab20: 6e64 2074 6f20 6f6e 6520 6f72 2073 6576  nd to one or sev
-0000ab30: 6572 616c 2063 6f6e 6e65 6374 6564 2077  eral connected w
-0000ab40: 6f72 6b65 7273 2e0a 2020 2020 686f 7374  orkers..    host
-0000ab50: 5f72 6573 7472 6963 7469 6f6e 733a 2073  _restrictions: s
-0000ab60: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
-0000ab70: 4120 7365 7420 6f66 2063 6f6d 706c 6574  A set of complet
-0000ab80: 6520 776f 726b 6572 2061 6464 7265 7373  e worker address
-0000ab90: 6573 2077 6865 7265 2074 6869 7320 6361  es where this ca
-0000aba0: 6e20 6265 2072 756e 2028 6f72 2060 604e  n be run (or ``N
-0000abb0: 6f6e 6560 6020 6966 2065 6d70 7479 292e  one`` if empty).
-0000abc0: 0a20 2020 2023 3a20 5573 7561 6c6c 7920  .    #: Usually 
-0000abd0: 7468 6973 2069 7320 656d 7074 7920 756e  this is empty un
-0000abe0: 6c65 7373 2074 6865 2074 6173 6b20 6861  less the task ha
-0000abf0: 7320 6265 656e 2073 7065 6369 6669 6361  s been specifica
-0000ac00: 6c6c 7920 7265 7374 7269 6374 6564 2074  lly restricted t
-0000ac10: 6f20 6f6e 6c79 0a20 2020 2023 3a20 7275  o only.    #: ru
-0000ac20: 6e20 6f6e 2063 6572 7461 696e 2077 6f72  n on certain wor
-0000ac30: 6b65 7273 2e0a 2020 2020 233a 204e 6f74  kers..    #: Not
-0000ac40: 6520 7468 6973 2069 7320 7472 6163 6b69  e this is tracki
-0000ac50: 6e67 2077 6f72 6b65 7220 6164 6472 6573  ng worker addres
-0000ac60: 7365 732c 206e 6f74 2077 6f72 6b65 7220  ses, not worker 
-0000ac70: 7374 6174 6573 2c20 7369 6e63 6520 7468  states, since th
-0000ac80: 6520 7370 6563 6966 6963 0a20 2020 2023  e specific.    #
-0000ac90: 3a20 776f 726b 6572 7320 6d61 7920 6e6f  : workers may no
-0000aca0: 7420 6265 2063 6f6e 6e65 6374 6564 2061  t be connected a
-0000acb0: 7420 7468 6973 2074 696d 652e 0a20 2020  t this time..   
-0000acc0: 2077 6f72 6b65 725f 7265 7374 7269 6374   worker_restrict
-0000acd0: 696f 6e73 3a20 7365 745b 7374 725d 0a0a  ions: set[str]..
-0000ace0: 2020 2020 233a 2052 6573 6f75 7263 6573      #: Resources
-0000acf0: 2072 6571 7569 7265 6420 6279 2074 6869   required by thi
-0000ad00: 7320 7461 736b 2c20 7375 6368 2061 7320  s task, such as 
-0000ad10: 6060 7b27 6770 7527 3a20 317d 6060 206f  ``{'gpu': 1}`` o
-0000ad20: 7220 6060 7b27 6d65 6d6f 7279 273a 2031  r ``{'memory': 1
-0000ad30: 6539 7d60 600a 2020 2020 233a 2054 6865  e9}``.    #: The
-0000ad40: 7365 2061 7265 2075 7365 722d 6465 6669  se are user-defi
-0000ad50: 6e65 6420 6e61 6d65 7320 616e 6420 6172  ned names and ar
-0000ad60: 6520 6d61 7463 6865 6420 6167 6169 6e73  e matched agains
-0000ad70: 7420 7468 6520 3a20 636f 6e74 656e 7473  t the : contents
-0000ad80: 206f 6620 6561 6368 0a20 2020 2023 3a20   of each.    #: 
-0000ad90: 3a61 7474 723a 6057 6f72 6b65 7253 7461  :attr:`WorkerSta
-0000ada0: 7465 2e72 6573 6f75 7263 6573 6020 6469  te.resources` di
-0000adb0: 6374 696f 6e61 7279 2e0a 2020 2020 7265  ctionary..    re
-0000adc0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
-0000add0: 6f6e 733a 2064 6963 745b 7374 722c 2066  ons: dict[str, f
-0000ade0: 6c6f 6174 5d0a 0a20 2020 2023 3a20 4661  loat]..    #: Fa
-0000adf0: 6c73 650a 2020 2020 233a 2020 2020 2045  lse.    #:     E
-0000ae00: 6163 6820 6f66 203a 6174 7472 3a60 686f  ach of :attr:`ho
-0000ae10: 7374 5f72 6573 7472 6963 7469 6f6e 7360  st_restrictions`
-0000ae20: 2c20 3a61 7474 723a 6077 6f72 6b65 725f  , :attr:`worker_
-0000ae30: 7265 7374 7269 6374 696f 6e73 6020 616e  restrictions` an
-0000ae40: 640a 2020 2020 233a 2020 2020 203a 6174  d.    #:     :at
-0000ae50: 7472 3a60 7265 736f 7572 6365 5f72 6573  tr:`resource_res
-0000ae60: 7472 6963 7469 6f6e 7360 2069 7320 6120  trictions` is a 
-0000ae70: 6861 7264 2063 6f6e 7374 7261 696e 743a  hard constraint:
-0000ae80: 2069 6620 6e6f 2077 6f72 6b65 7220 6973   if no worker is
-0000ae90: 2061 7661 696c 6162 6c65 0a20 2020 2023   available.    #
-0000aea0: 3a20 2020 2020 7361 7469 7366 7969 6e67  :     satisfying
-0000aeb0: 2074 686f 7365 2072 6573 7472 6963 7469   those restricti
-0000aec0: 6f6e 732c 2074 6865 2074 6173 6b20 6361  ons, the task ca
-0000aed0: 6e6e 6f74 2067 6f20 696e 746f 2074 6865  nnot go into the
-0000aee0: 2022 7072 6f63 6573 7369 6e67 2220 7374   "processing" st
-0000aef0: 6174 650a 2020 2020 233a 2020 2020 2061  ate.    #:     a
-0000af00: 6e64 2077 696c 6c20 696e 7374 6561 6420  nd will instead 
-0000af10: 676f 2069 6e74 6f20 7468 6520 226e 6f2d  go into the "no-
-0000af20: 776f 726b 6572 2220 7374 6174 652e 0a20  worker" state.. 
-0000af30: 2020 2023 3a20 5472 7565 0a20 2020 2023     #: True.    #
-0000af40: 3a20 2020 2020 5468 6520 6162 6f76 6520  :     The above 
-0000af50: 7265 7374 7269 6374 696f 6e73 2061 7265  restrictions are
-0000af60: 206d 6572 6520 7072 6566 6572 656e 6365   mere preference
-0000af70: 733a 2069 6620 6e6f 2077 6f72 6b65 7220  s: if no worker 
-0000af80: 6973 2061 7661 696c 6162 6c65 0a20 2020  is available.   
-0000af90: 2023 3a20 2020 2020 7361 7469 7366 7969   #:     satisfyi
-0000afa0: 6e67 2074 686f 7365 2072 6573 7472 6963  ng those restric
-0000afb0: 7469 6f6e 732c 2074 6865 2074 6173 6b20  tions, the task 
-0000afc0: 6361 6e20 7374 696c 6c20 676f 2069 6e74  can still go int
-0000afd0: 6f20 7468 650a 2020 2020 233a 2020 2020  o the.    #:    
-0000afe0: 2022 7072 6f63 6573 7369 6e67 2220 7374   "processing" st
-0000aff0: 6174 6520 616e 6420 6265 2073 656e 7420  ate and be sent 
-0000b000: 666f 7220 6578 6563 7574 696f 6e20 746f  for execution to
-0000b010: 2061 6e6f 7468 6572 2063 6f6e 6e65 6374   another connect
-0000b020: 6564 2077 6f72 6b65 722e 0a20 2020 206c  ed worker..    l
-0000b030: 6f6f 7365 5f72 6573 7472 6963 7469 6f6e  oose_restriction
-0000b040: 733a 2062 6f6f 6c0a 0a20 2020 2023 3a20  s: bool..    #: 
-0000b050: 5768 6574 6865 7220 7468 6973 2074 6173  Whether this tas
-0000b060: 6b20 6973 2061 6e20 4163 746f 720a 2020  k is an Actor.  
-0000b070: 2020 6163 746f 723a 2062 6f6f 6c0a 0a20    actor: bool.. 
-0000b080: 2020 2023 3a20 5468 6520 6772 6f75 7020     #: The group 
-0000b090: 6f66 2074 6173 6b73 2074 6f20 7768 6963  of tasks to whic
-0000b0a0: 6820 7468 6973 206f 6e65 2062 656c 6f6e  h this one belon
-0000b0b0: 6773 0a20 2020 2067 726f 7570 3a20 5461  gs.    group: Ta
-0000b0c0: 736b 4772 6f75 700a 0a20 2020 2023 3a20  skGroup..    #: 
-0000b0d0: 5361 6d65 2061 7320 6f66 2067 726f 7570  Same as of group
-0000b0e0: 2e6e 616d 650a 2020 2020 6772 6f75 705f  .name.    group_
-0000b0f0: 6b65 793a 2073 7472 0a0a 2020 2020 233a  key: str..    #:
-0000b100: 204d 6574 6164 6174 6120 7265 6c61 7465   Metadata relate
-0000b110: 6420 746f 2074 6173 6b0a 2020 2020 6d65  d to task.    me
-0000b120: 7461 6461 7461 3a20 6469 6374 5b73 7472  tadata: dict[str
-0000b130: 2c20 416e 795d 0a0a 2020 2020 233a 2054  , Any]..    #: T
-0000b140: 6173 6b20 616e 6e6f 7461 7469 6f6e 730a  ask annotations.
-0000b150: 2020 2020 616e 6e6f 7461 7469 6f6e 733a      annotations:
-0000b160: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
-0000b170: 0a20 2020 2023 3a20 5468 6520 756e 6971  .    #: The uniq
-0000b180: 7565 2069 6465 6e74 6966 6965 7220 6f66  ue identifier of
-0000b190: 2061 2073 7065 6369 6669 6320 6578 6563   a specific exec
-0000b1a0: 7574 696f 6e20 6f66 2061 2074 6173 6b2e  ution of a task.
-0000b1b0: 2054 6869 7320 6964 656e 7469 6669 6572   This identifier
-0000b1c0: 0a20 2020 2023 3a20 6973 2075 7365 6420  .    #: is used 
-0000b1d0: 746f 2073 6967 6e20 6120 7461 736b 2073  to sign a task s
-0000b1e0: 7563 6820 7468 6174 2074 6865 2061 7373  uch that the ass
-0000b1f0: 6967 6e65 6420 776f 726b 6572 2069 7320  igned worker is 
-0000b200: 6578 7065 6374 6564 2074 6f20 7265 7475  expected to retu
-0000b210: 726e 0a20 2020 2023 3a20 7468 6520 7361  rn.    #: the sa
-0000b220: 6d65 2069 6465 6e74 6966 6965 7220 696e  me identifier in
-0000b230: 2074 6865 2074 6173 6b2d 6669 6e69 7368   the task-finish
-0000b240: 6564 206d 6573 7361 6765 2e20 5468 6973  ed message. This
-0000b250: 2069 7320 7573 6564 2074 6f20 636f 7272   is used to corr
-0000b260: 656c 6174 650a 2020 2020 233a 2072 6573  elate.    #: res
-0000b270: 706f 6e73 6573 2e0a 2020 2020 233a 204f  ponses..    #: O
-0000b280: 6e6c 7920 7468 6520 6d6f 7374 2072 6563  nly the most rec
-0000b290: 656e 746c 7920 6173 7369 676e 6564 2077  ently assigned w
-0000b2a0: 6f72 6b65 7220 6973 2074 7275 7374 6564  orker is trusted
-0000b2b0: 2e20 416c 6c20 6f74 6865 7220 7265 7375  . All other resu
-0000b2c0: 6c74 7320 7769 6c6c 0a20 2020 2023 3a20  lts will.    #: 
-0000b2d0: 6265 2072 656a 6563 7465 642e 0a20 2020  be rejected..   
-0000b2e0: 2072 756e 5f69 643a 2069 6e74 207c 204e   run_id: int | N
-0000b2f0: 6f6e 650a 0a20 2020 2023 3a20 4361 6368  one..    #: Cach
-0000b300: 6564 2068 6173 6820 6f66 203a 6174 7472  ed hash of :attr
-0000b310: 3a60 7e54 6173 6b53 7461 7465 2e63 6c69  :`~TaskState.cli
-0000b320: 656e 745f 6b65 7960 0a20 2020 205f 6861  ent_key`.    _ha
-0000b330: 7368 3a20 696e 740a 0a20 2020 2023 2053  sh: int..    # S
-0000b340: 7570 706f 7274 2066 6f72 2077 6561 6b72  upport for weakr
-0000b350: 6566 7320 746f 2061 2063 6c61 7373 2077  efs to a class w
-0000b360: 6974 6820 5f5f 736c 6f74 735f 5f0a 2020  ith __slots__.  
-0000b370: 2020 5f5f 7765 616b 7265 665f 5f3a 2041    __weakref__: A
-0000b380: 6e79 203d 204e 6f6e 650a 2020 2020 5f5f  ny = None.    __
-0000b390: 736c 6f74 735f 5f20 3d20 7475 706c 6528  slots__ = tuple(
-0000b3a0: 5f5f 616e 6e6f 7461 7469 6f6e 735f 5f29  __annotations__)
-0000b3b0: 0a0a 2020 2020 233a 2047 6c6f 6261 6c20  ..    #: Global 
-0000b3c0: 6974 6572 6174 6f72 2075 7365 6420 746f  iterator used to
-0000b3d0: 2063 7265 6174 6520 756e 6971 7565 2074   create unique t
-0000b3e0: 6173 6b20 7275 6e20 4944 730a 2020 2020  ask run IDs.    
-0000b3f0: 5f72 756e 5f69 645f 6974 6572 6174 6f72  _run_id_iterator
-0000b400: 3a20 436c 6173 7356 6172 5b69 7465 7274  : ClassVar[itert
-0000b410: 6f6f 6c73 2e63 6f75 6e74 5d20 3d20 6974  ools.count] = it
-0000b420: 6572 746f 6f6c 732e 636f 756e 7428 290a  ertools.count().
-0000b430: 0a20 2020 2023 2049 6e73 7461 6e63 6573  .    # Instances
-0000b440: 206e 6f74 2070 6172 7420 6f66 2073 6c6f   not part of slo
-0000b450: 7473 2073 696e 6365 2063 6c61 7373 2076  ts since class v
-0000b460: 6172 6961 626c 650a 2020 2020 5f69 6e73  ariable.    _ins
-0000b470: 7461 6e63 6573 3a20 436c 6173 7356 6172  tances: ClassVar
-0000b480: 5b77 6561 6b72 6566 2e57 6561 6b53 6574  [weakref.WeakSet
-0000b490: 5b54 6173 6b53 7461 7465 5d5d 203d 2077  [TaskState]] = w
-0000b4a0: 6561 6b72 6566 2e57 6561 6b53 6574 2829  eakref.WeakSet()
-0000b4b0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-0000b4c0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
-0000b4d0: 2c0a 2020 2020 2020 2020 6b65 793a 2073  ,.        key: s
-0000b4e0: 7472 2c0a 2020 2020 2020 2020 7275 6e5f  tr,.        run_
-0000b4f0: 7370 6563 3a20 6f62 6a65 6374 2c0a 2020  spec: object,.  
-0000b500: 2020 2020 2020 7374 6174 653a 2054 6173        state: Tas
-0000b510: 6b53 7461 7465 5374 6174 652c 0a20 2020  kStateState,.   
-0000b520: 2029 3a0a 2020 2020 2020 2020 7365 6c66   ):.        self
-0000b530: 2e6b 6579 203d 206b 6579 0a20 2020 2020  .key = key.     
-0000b540: 2020 2073 656c 662e 5f68 6173 6820 3d20     self._hash = 
-0000b550: 6861 7368 286b 6579 290a 2020 2020 2020  hash(key).      
-0000b560: 2020 7365 6c66 2e72 756e 5f73 7065 6320    self.run_spec 
-0000b570: 3d20 7275 6e5f 7370 6563 0a20 2020 2020  = run_spec.     
-0000b580: 2020 2073 656c 662e 5f73 7461 7465 203d     self._state =
-0000b590: 2073 7461 7465 0a20 2020 2020 2020 2073   state.        s
-0000b5a0: 656c 662e 6578 6365 7074 696f 6e20 3d20  elf.exception = 
-0000b5b0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-0000b5c0: 662e 6578 6365 7074 696f 6e5f 626c 616d  f.exception_blam
-0000b5d0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-0000b5e0: 2073 656c 662e 7472 6163 6562 6163 6b20   self.traceback 
-0000b5f0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-0000b600: 656c 662e 6578 6365 7074 696f 6e5f 7465  elf.exception_te
-0000b610: 7874 203d 2022 220a 2020 2020 2020 2020  xt = "".        
-0000b620: 7365 6c66 2e74 7261 6365 6261 636b 5f74  self.traceback_t
-0000b630: 6578 7420 3d20 2222 0a20 2020 2020 2020  ext = "".       
-0000b640: 2073 656c 662e 7375 7370 6963 696f 7573   self.suspicious
-0000b650: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000b660: 662e 7265 7472 6965 7320 3d20 300a 2020  f.retries = 0.  
-0000b670: 2020 2020 2020 7365 6c66 2e6e 6279 7465        self.nbyte
-0000b680: 7320 3d20 2d31 0a20 2020 2020 2020 2073  s = -1.        s
-0000b690: 656c 662e 7072 696f 7269 7479 203d 204e  elf.priority = N
-0000b6a0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0000b6b0: 2e77 686f 5f77 616e 7473 203d 2073 6574  .who_wants = set
-0000b6c0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0000b6d0: 6465 7065 6e64 656e 6369 6573 203d 2073  dependencies = s
-0000b6e0: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-0000b6f0: 662e 6465 7065 6e64 656e 7473 203d 2073  f.dependents = s
-0000b700: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-0000b710: 662e 7761 6974 696e 675f 6f6e 203d 2073  f.waiting_on = s
-0000b720: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-0000b730: 662e 7761 6974 6572 7320 3d20 7365 7428  f.waiters = set(
-0000b740: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
-0000b750: 686f 5f68 6173 203d 2073 6574 2829 0a20  ho_has = set(). 
-0000b760: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
-0000b770: 6573 7369 6e67 5f6f 6e20 3d20 4e6f 6e65  essing_on = None
-0000b780: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-0000b790: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
-0000b7a0: 6965 7320 3d20 4661 6c73 650a 2020 2020  ies = False.    
-0000b7b0: 2020 2020 7365 6c66 2e68 6f73 745f 7265      self.host_re
-0000b7c0: 7374 7269 6374 696f 6e73 203d 2073 6574  strictions = set
-0000b7d0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0000b7e0: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
-0000b7f0: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
-0000b800: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
-0000b810: 655f 7265 7374 7269 6374 696f 6e73 203d  e_restrictions =
-0000b820: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0000b830: 2e6c 6f6f 7365 5f72 6573 7472 6963 7469  .loose_restricti
-0000b840: 6f6e 7320 3d20 4661 6c73 650a 2020 2020  ons = False.    
-0000b850: 2020 2020 7365 6c66 2e61 6374 6f72 203d      self.actor =
-0000b860: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
-0000b870: 656c 662e 7072 6566 6978 203d 204e 6f6e  elf.prefix = Non
-0000b880: 6520 2023 2074 7970 653a 2069 676e 6f72  e  # type: ignor
-0000b890: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
-0000b8a0: 7970 6520 3d20 4e6f 6e65 2020 2320 7479  ype = None  # ty
-0000b8b0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-0000b8c0: 2020 2073 656c 662e 6772 6f75 705f 6b65     self.group_ke
-0000b8d0: 7920 3d20 6b65 795f 7370 6c69 745f 6772  y = key_split_gr
-0000b8e0: 6f75 7028 6b65 7929 0a20 2020 2020 2020  oup(key).       
-0000b8f0: 2073 656c 662e 6772 6f75 7020 3d20 4e6f   self.group = No
-0000b900: 6e65 2020 2320 7479 7065 3a20 6967 6e6f  ne  # type: igno
-0000b910: 7265 0a20 2020 2020 2020 2073 656c 662e  re.        self.
-0000b920: 6d65 7461 6461 7461 203d 207b 7d0a 2020  metadata = {}.  
-0000b930: 2020 2020 2020 7365 6c66 2e61 6e6e 6f74        self.annot
-0000b940: 6174 696f 6e73 203d 207b 7d0a 2020 2020  ations = {}.    
-0000b950: 2020 2020 7365 6c66 2e65 7272 6564 5f6f      self.erred_o
-0000b960: 6e20 3d20 7365 7428 290a 2020 2020 2020  n = set().      
-0000b970: 2020 7365 6c66 2e72 756e 5f69 6420 3d20    self.run_id = 
-0000b980: 4e6f 6e65 0a20 2020 2020 2020 2054 6173  None.        Tas
-0000b990: 6b53 7461 7465 2e5f 696e 7374 616e 6365  kState._instance
-0000b9a0: 732e 6164 6428 7365 6c66 290a 0a20 2020  s.add(self)..   
-0000b9b0: 2064 6566 205f 5f68 6173 685f 5f28 7365   def __hash__(se
-0000b9c0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-0000b9d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000b9e0: 5f68 6173 680a 0a20 2020 2064 6566 205f  _hash..    def _
-0000b9f0: 5f65 715f 5f28 7365 6c66 2c20 6f74 6865  _eq__(self, othe
-0000ba00: 723a 206f 626a 6563 7429 202d 3e20 626f  r: object) -> bo
-0000ba10: 6f6c 3a0a 2020 2020 2020 2020 7265 7475  ol:.        retu
-0000ba20: 726e 2069 7369 6e73 7461 6e63 6528 6f74  rn isinstance(ot
-0000ba30: 6865 722c 2054 6173 6b53 7461 7465 2920  her, TaskState) 
-0000ba40: 616e 6420 7365 6c66 2e6b 6579 203d 3d20  and self.key == 
-0000ba50: 6f74 6865 722e 6b65 790a 0a20 2020 2040  other.key..    @
-0000ba60: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0000ba70: 2073 7461 7465 2873 656c 6629 202d 3e20   state(self) -> 
-0000ba80: 5461 736b 5374 6174 6553 7461 7465 3a0a  TaskStateState:.
-0000ba90: 2020 2020 2020 2020 2222 2254 6869 7320          """This 
-0000baa0: 7461 736b 2773 2063 7572 7265 6e74 2073  task's current s
-0000bab0: 7461 7465 2e20 2056 616c 6964 2073 7461  tate.  Valid sta
-0000bac0: 7465 7320 6172 6520 6060 7265 6c65 6173  tes are ``releas
-0000bad0: 6564 6060 2c20 6060 7761 6974 696e 6760  ed``, ``waiting`
-0000bae0: 602c 0a20 2020 2020 2020 2060 606e 6f2d  `,.        ``no-
-0000baf0: 776f 726b 6572 6060 2c20 6060 7072 6f63  worker``, ``proc
-0000bb00: 6573 7369 6e67 6060 2c20 6060 6d65 6d6f  essing``, ``memo
-0000bb10: 7279 6060 2c20 6060 6572 7265 6460 6020  ry``, ``erred`` 
-0000bb20: 616e 6420 6060 666f 7267 6f74 7465 6e60  and ``forgotten`
-0000bb30: 602e 2020 4966 2069 740a 2020 2020 2020  `.  If it.      
-0000bb40: 2020 6973 2060 6066 6f72 676f 7474 656e    is ``forgotten
-0000bb50: 6060 2c20 7468 6520 7461 736b 2069 736e  ``, the task isn
-0000bb60: 2774 2073 746f 7265 6420 696e 2074 6865  't stored in the
-0000bb70: 2060 6074 6173 6b73 6060 2064 6963 7469   ``tasks`` dicti
-0000bb80: 6f6e 6172 7920 616e 796d 6f72 6520 616e  onary anymore an
-0000bb90: 640a 2020 2020 2020 2020 7769 6c6c 2070  d.        will p
-0000bba0: 726f 6261 626c 7920 6469 7361 7070 6561  robably disappea
-0000bbb0: 7220 736f 6f6e 2066 726f 6d20 6d65 6d6f  r soon from memo
-0000bbc0: 7279 2e0a 2020 2020 2020 2020 2222 220a  ry..        """.
-0000bbd0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000bbe0: 656c 662e 5f73 7461 7465 0a0a 2020 2020  elf._state..    
-0000bbf0: 4073 7461 7465 2e73 6574 7465 720a 2020  @state.setter.  
-0000bc00: 2020 6465 6620 7374 6174 6528 7365 6c66    def state(self
-0000bc10: 2c20 7661 6c75 653a 2054 6173 6b53 7461  , value: TaskSta
-0000bc20: 7465 5374 6174 6529 202d 3e20 4e6f 6e65  teState) -> None
-0000bc30: 3a0a 2020 2020 2020 2020 7365 6c66 2e67  :.        self.g
-0000bc40: 726f 7570 2e73 7461 7465 735b 7365 6c66  roup.states[self
-0000bc50: 2e5f 7374 6174 655d 202d 3d20 310a 2020  ._state] -= 1.  
-0000bc60: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
-0000bc70: 2e73 7461 7465 735b 7661 6c75 655d 202b  .states[value] +
-0000bc80: 3d20 310a 2020 2020 2020 2020 7365 6c66  = 1.        self
-0000bc90: 2e5f 7374 6174 6520 3d20 7661 6c75 650a  ._state = value.
-0000bca0: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
-0000bcb0: 6669 782e 7374 6174 655f 636f 756e 7473  fix.state_counts
-0000bcc0: 5b76 616c 7565 5d20 2b3d 2031 0a0a 2020  [value] += 1..  
-0000bcd0: 2020 6465 6620 6164 645f 6465 7065 6e64    def add_depend
-0000bce0: 656e 6379 2873 656c 662c 206f 7468 6572  ency(self, other
-0000bcf0: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-0000bd00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0000bd10: 2241 6464 2061 6e6f 7468 6572 2074 6173  "Add another tas
-0000bd20: 6b20 6173 2061 2064 6570 656e 6465 6e63  k as a dependenc
-0000bd30: 7920 6f66 2074 6869 7320 7461 736b 2222  y of this task""
-0000bd40: 220a 2020 2020 2020 2020 7365 6c66 2e64  ".        self.d
-0000bd50: 6570 656e 6465 6e63 6965 732e 6164 6428  ependencies.add(
-0000bd60: 6f74 6865 7229 0a20 2020 2020 2020 2073  other).        s
-0000bd70: 656c 662e 6772 6f75 702e 6465 7065 6e64  elf.group.depend
-0000bd80: 656e 6369 6573 2e61 6464 286f 7468 6572  encies.add(other
-0000bd90: 2e67 726f 7570 290a 2020 2020 2020 2020  .group).        
-0000bda0: 6f74 6865 722e 6465 7065 6e64 656e 7473  other.dependents
-0000bdb0: 2e61 6464 2873 656c 6629 0a0a 2020 2020  .add(self)..    
-0000bdc0: 6465 6620 6765 745f 6e62 7974 6573 2873  def get_nbytes(s
-0000bdd0: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-0000bde0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000bdf0: 2e6e 6279 7465 7320 6966 2073 656c 662e  .nbytes if self.
-0000be00: 6e62 7974 6573 203e 3d20 3020 656c 7365  nbytes >= 0 else
-0000be10: 2044 4546 4155 4c54 5f44 4154 415f 5349   DEFAULT_DATA_SI
-0000be20: 5a45 0a0a 2020 2020 6465 6620 7365 745f  ZE..    def set_
-0000be30: 6e62 7974 6573 2873 656c 662c 206e 6279  nbytes(self, nby
-0000be40: 7465 733a 2069 6e74 2920 2d3e 204e 6f6e  tes: int) -> Non
-0000be50: 653a 0a20 2020 2020 2020 2064 6966 6620  e:.        diff 
-0000be60: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
-0000be70: 206f 6c64 5f6e 6279 7465 7320 3d20 7365   old_nbytes = se
-0000be80: 6c66 2e6e 6279 7465 730a 2020 2020 2020  lf.nbytes.      
-0000be90: 2020 6966 206f 6c64 5f6e 6279 7465 7320    if old_nbytes 
-0000bea0: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
-0000beb0: 2020 6469 6666 202d 3d20 6f6c 645f 6e62    diff -= old_nb
-0000bec0: 7974 6573 0a20 2020 2020 2020 2073 656c  ytes.        sel
-0000bed0: 662e 6772 6f75 702e 6e62 7974 6573 5f74  f.group.nbytes_t
-0000bee0: 6f74 616c 202b 3d20 6469 6666 0a20 2020  otal += diff.   
-0000bef0: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
-0000bf00: 656c 662e 7768 6f5f 6861 733a 0a20 2020  elf.who_has:.   
-0000bf10: 2020 2020 2020 2020 2077 732e 6e62 7974           ws.nbyt
-0000bf20: 6573 202b 3d20 6469 6666 0a20 2020 2020  es += diff.     
-0000bf30: 2020 2073 656c 662e 6e62 7974 6573 203d     self.nbytes =
-0000bf40: 206e 6279 7465 730a 0a20 2020 2064 6566   nbytes..    def
-0000bf50: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
-0000bf60: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000bf70: 7265 7475 726e 2066 223c 5461 736b 5374  return f"<TaskSt
-0000bf80: 6174 6520 7b73 656c 662e 6b65 7921 727d  ate {self.key!r}
-0000bf90: 207b 7365 6c66 2e5f 7374 6174 657d 3e22   {self._state}>"
-0000bfa0: 0a0a 2020 2020 6465 6620 5f72 6570 725f  ..    def _repr_
-0000bfb0: 6874 6d6c 5f28 7365 6c66 2920 2d3e 2073  html_(self) -> s
-0000bfc0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-0000bfd0: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
-0000bfe0: 2274 6173 6b5f 7374 6174 652e 6874 6d6c  "task_state.html
-0000bff0: 2e6a 3222 292e 7265 6e64 6572 280a 2020  .j2").render(.  
-0000c000: 2020 2020 2020 2020 2020 7374 6174 653d            state=
-0000c010: 7365 6c66 2e73 7461 7465 2c0a 2020 2020  self.state,.    
-0000c020: 2020 2020 2020 2020 6e62 7974 6573 3d73          nbytes=s
-0000c030: 656c 662e 6e62 7974 6573 2c0a 2020 2020  elf.nbytes,.    
-0000c040: 2020 2020 2020 2020 6b65 793d 7365 6c66          key=self
-0000c050: 2e6b 6579 2c0a 2020 2020 2020 2020 290a  .key,.        ).
-0000c060: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
-0000c070: 6528 7365 6c66 2920 2d3e 204e 6f6e 653a  e(self) -> None:
-0000c080: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000c090: 2020 2020 2020 2020 2020 666f 7220 6373            for cs
-0000c0a0: 2069 6e20 7365 6c66 2e77 686f 5f77 616e   in self.who_wan
-0000c0b0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0000c0c0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000c0d0: 7461 6e63 6528 6373 2c20 436c 6965 6e74  tance(cs, Client
-0000c0e0: 5374 6174 6529 2c20 2872 6570 7228 6373  State), (repr(cs
-0000c0f0: 292c 2073 656c 662e 7768 6f5f 7761 6e74  ), self.who_want
-0000c100: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-0000c110: 6f72 2077 7320 696e 2073 656c 662e 7768  or ws in self.wh
-0000c120: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
-0000c130: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000c140: 696e 7374 616e 6365 2877 732c 2057 6f72  instance(ws, Wor
-0000c150: 6b65 7253 7461 7465 292c 2028 7265 7072  kerState), (repr
-0000c160: 2877 7329 2c20 7365 6c66 2e77 686f 5f68  (ws), self.who_h
-0000c170: 6173 290a 2020 2020 2020 2020 2020 2020  as).            
-0000c180: 666f 7220 7473 2069 6e20 7365 6c66 2e64  for ts in self.d
-0000c190: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-0000c1a0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0000c1b0: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
-0000c1c0: 732c 2054 6173 6b53 7461 7465 292c 2028  s, TaskState), (
-0000c1d0: 7265 7072 2874 7329 2c20 7365 6c66 2e64  repr(ts), self.d
-0000c1e0: 6570 656e 6465 6e63 6965 7329 0a20 2020  ependencies).   
-0000c1f0: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
-0000c200: 696e 2073 656c 662e 6465 7065 6e64 656e  in self.dependen
-0000c210: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0000c220: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000c230: 7461 6e63 6528 7473 2c20 5461 736b 5374  tance(ts, TaskSt
-0000c240: 6174 6529 2c20 2872 6570 7228 7473 292c  ate), (repr(ts),
-0000c250: 2073 656c 662e 6465 7065 6e64 656e 7473   self.dependents
-0000c260: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
-0000c270: 6c69 6461 7465 5f74 6173 6b5f 7374 6174  lidate_task_stat
-0000c280: 6528 7365 6c66 290a 2020 2020 2020 2020  e(self).        
-0000c290: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0000c2a0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0000c2b0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
-0000c2c0: 696f 6e28 6529 0a20 2020 2020 2020 2020  ion(e).         
-0000c2d0: 2020 2069 6620 4c4f 475f 5044 423a 0a20     if LOG_PDB:. 
-0000c2e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c2f0: 6d70 6f72 7420 7064 620a 0a20 2020 2020  mport pdb..     
-0000c300: 2020 2020 2020 2020 2020 2070 6462 2e73             pdb.s
-0000c310: 6574 5f74 7261 6365 2829 0a0a 2020 2020  et_trace()..    
-0000c320: 6465 6620 6765 745f 6e62 7974 6573 5f64  def get_nbytes_d
-0000c330: 6570 7328 7365 6c66 2920 2d3e 2069 6e74  eps(self) -> int
-0000c340: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000c350: 2073 756d 2874 732e 6765 745f 6e62 7974   sum(ts.get_nbyt
-0000c360: 6573 2829 2066 6f72 2074 7320 696e 2073  es() for ts in s
-0000c370: 656c 662e 6465 7065 6e64 656e 6369 6573  elf.dependencies
-0000c380: 290a 0a20 2020 2064 6566 205f 746f 5f64  )..    def _to_d
-0000c390: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
-0000c3a0: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
-0000c3b0: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
-0000c3c0: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
-0000c3d0: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
-0000c3e0: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
-0000c3f0: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
-0000c400: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
-0000c410: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
-0000c420: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
-0000c430: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
-0000c440: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
-0000c450: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-0000c460: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0000c470: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
-0000c480: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
-0000c490: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
-0000c4a0: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
-0000c4b0: 7369 7665 5f74 6f5f 6469 6374 0a0a 2020  sive_to_dict..  
-0000c4c0: 2020 2020 2020 4e6f 7465 730a 2020 2020        Notes.    
-0000c4d0: 2020 2020 2d2d 2d2d 2d0a 2020 2020 2020      -----.      
-0000c4e0: 2020 5468 6973 2063 6c61 7373 2075 7365    This class use
-0000c4f0: 7320 6060 5f74 6f5f 6469 6374 5f6e 6f5f  s ``_to_dict_no_
-0000c500: 6e65 7374 6060 2069 6e73 7465 6164 206f  nest`` instead o
-0000c510: 6620 6060 5f74 6f5f 6469 6374 6060 2e0a  f ``_to_dict``..
-0000c520: 2020 2020 2020 2020 5768 656e 2061 2074          When a t
-0000c530: 6173 6b20 7265 6665 7265 6e63 6573 2061  ask references a
-0000c540: 6e6f 7468 6572 2074 6173 6b2c 206f 7220  nother task, or 
-0000c550: 7768 656e 2061 2057 6f72 6b65 7253 7461  when a WorkerSta
-0000c560: 7465 2e74 6173 6b73 2063 6f6e 7461 696e  te.tasks contain
-0000c570: 7320 7461 736b 732c 0a20 2020 2020 2020  s tasks,.       
-0000c580: 2074 6869 7320 6d65 7468 6f64 2069 7320   this method is 
-0000c590: 6e6f 7420 6578 6563 7574 6564 2066 6f72  not executed for
-0000c5a0: 2074 6865 2069 6e6e 6572 2074 6173 6b2c   the inner task,
-0000c5b0: 2065 7665 6e20 6966 2074 6865 2069 6e6e   even if the inn
-0000c5c0: 6572 2074 6173 6b20 7761 7320 6e65 7665  er task was neve
-0000c5d0: 720a 2020 2020 2020 2020 7365 656e 2062  r.        seen b
-0000c5e0: 6566 6f72 653b 2079 6f75 2067 6574 2061  efore; you get a
-0000c5f0: 2072 6570 7220 696e 7374 6561 642e 2041   repr instead. A
-0000c600: 6c6c 2074 6173 6b73 2073 686f 756c 6420  ll tasks should 
-0000c610: 6e65 6174 6c79 2061 7070 6561 7220 756e  neatly appear un
-0000c620: 6465 720a 2020 2020 2020 2020 5363 6865  der.        Sche
-0000c630: 6475 6c65 722e 7461 736b 732e 2054 6869  duler.tasks. Thi
-0000c640: 7320 616c 736f 2070 7265 7665 6e74 7320  s also prevents 
-0000c650: 6120 5265 6375 7273 696f 6e45 7272 6f72  a RecursionError
-0000c660: 2064 7572 696e 6720 7061 7274 6963 756c   during particul
-0000c670: 6172 6c79 2068 6561 7679 0a20 2020 2020  arly heavy.     
-0000c680: 2020 206c 6f61 6473 2c20 7768 6963 6820     loads, which 
-0000c690: 6861 7665 2062 6565 6e20 6f62 7365 7276  have been observ
-0000c6a0: 6564 2074 6f20 6861 7070 656e 2077 6865  ed to happen whe
-0000c6b0: 6e65 7665 7220 7468 6572 6527 7320 616e  never there's an
-0000c6c0: 2061 6379 636c 6963 2064 6570 656e 6465   acyclic depende
-0000c6d0: 6e63 790a 2020 2020 2020 2020 6368 6169  ncy.        chai
-0000c6e0: 6e20 6f66 207e 3230 302b 2074 6173 6b73  n of ~200+ tasks
-0000c6f0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0000c700: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
-0000c710: 7572 7369 7665 5f74 6f5f 6469 6374 2873  ursive_to_dict(s
-0000c720: 656c 662c 2065 7863 6c75 6465 3d65 7863  elf, exclude=exc
-0000c730: 6c75 6465 2c20 6d65 6d62 6572 733d 5472  lude, members=Tr
-0000c740: 7565 290a 0a0a 636c 6173 7320 5472 616e  ue)...class Tran
-0000c750: 7369 7469 6f6e 284e 616d 6564 5475 706c  sition(NamedTupl
-0000c760: 6529 3a0a 2020 2020 2222 2241 6e20 656e  e):.    """An en
-0000c770: 7472 7920 696e 203a 6174 7472 3a60 5363  try in :attr:`Sc
-0000c780: 6865 6475 6c65 7253 7461 7465 2e74 7261  hedulerState.tra
-0000c790: 6e73 6974 696f 6e5f 6c6f 6760 2222 220a  nsition_log`""".
-0000c7a0: 0a20 2020 206b 6579 3a20 7374 720a 2020  .    key: str.  
-0000c7b0: 2020 7374 6172 743a 2054 6173 6b53 7461    start: TaskSta
-0000c7c0: 7465 5374 6174 650a 2020 2020 6669 6e69  teState.    fini
-0000c7d0: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
-0000c7e0: 7465 0a20 2020 2072 6563 6f6d 6d65 6e64  te.    recommend
-0000c7f0: 6174 696f 6e73 3a20 5265 6373 0a20 2020  ations: Recs.   
-0000c800: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-0000c810: 720a 2020 2020 7469 6d65 7374 616d 703a  r.    timestamp:
-0000c820: 2066 6c6f 6174 0a0a 0a63 6c61 7373 2053   float...class S
-0000c830: 6368 6564 756c 6572 5374 6174 653a 0a20  chedulerState:. 
-0000c840: 2020 2022 2222 556e 6465 726c 7969 6e67     """Underlying
-0000c850: 2074 6173 6b20 7374 6174 6520 6f66 2064   task state of d
-0000c860: 796e 616d 6963 2073 6368 6564 756c 6572  ynamic scheduler
-0000c870: 0a0a 2020 2020 5472 6163 6b73 2074 6865  ..    Tracks the
-0000c880: 2063 7572 7265 6e74 2073 7461 7465 206f   current state o
-0000c890: 6620 776f 726b 6572 732c 2064 6174 612c  f workers, data,
-0000c8a0: 2061 6e64 2063 6f6d 7075 7461 7469 6f6e   and computation
-0000c8b0: 732e 0a0a 2020 2020 4861 6e64 6c65 7320  s...    Handles 
-0000c8c0: 7472 616e 7369 7469 6f6e 7320 6265 7477  transitions betw
-0000c8d0: 6565 6e20 6469 6666 6572 656e 7420 7461  een different ta
-0000c8e0: 736b 2073 7461 7465 732e 204e 6f74 6966  sk states. Notif
-0000c8f0: 6965 7320 7468 650a 2020 2020 5363 6865  ies the.    Sche
-0000c900: 6475 6c65 7220 6f66 2063 6861 6e67 6573  duler of changes
-0000c910: 2062 7920 6d65 7373 6167 696e 6720 7061   by messaging pa
-0000c920: 7373 696e 6720 7468 726f 7567 6820 5175  ssing through Qu
-0000c930: 6575 6573 2c20 7768 6963 6820 7468 650a  eues, which the.
-0000c940: 2020 2020 5363 6865 6475 6c65 7220 6c69      Scheduler li
-0000c950: 7374 656e 7320 746f 2072 6573 706f 6e64  stens to respond
-0000c960: 7320 6163 636f 7264 696e 676c 792e 0a0a  s accordingly...
-0000c970: 2020 2020 416c 6c20 6576 656e 7473 2061      All events a
-0000c980: 7265 2068 616e 646c 6564 2071 7569 636b  re handled quick
-0000c990: 6c79 2c20 696e 206c 696e 6561 7220 7469  ly, in linear ti
-0000c9a0: 6d65 2077 6974 6820 7265 7370 6563 7420  me with respect 
-0000c9b0: 746f 2074 6865 6972 0a20 2020 2069 6e70  to their.    inp
-0000c9c0: 7574 2028 7768 6963 6820 6973 206f 6674  ut (which is oft
-0000c9d0: 656e 206f 6620 636f 6e73 7461 6e74 2073  en of constant s
-0000c9e0: 697a 6529 2061 6e64 2067 656e 6572 616c  ize) and general
-0000c9f0: 6c79 2077 6974 6869 6e20 610a 2020 2020  ly within a.    
-0000ca00: 6d69 6c6c 6973 6563 6f6e 642e 0a0a 2020  millisecond...  
-0000ca10: 2020 5573 6572 7320 7479 7069 6361 6c6c    Users typicall
-0000ca20: 7920 646f 206e 6f74 2069 6e74 6572 6163  y do not interac
-0000ca30: 7420 7769 7468 2060 6054 7261 6e73 6974  t with ``Transit
-0000ca40: 696f 6e73 6060 2064 6972 6563 746c 792e  ions`` directly.
-0000ca50: 2049 6e73 7465 6164 0a20 2020 2075 7365   Instead.    use
-0000ca60: 7273 2069 6e74 6572 6163 7420 7769 7468  rs interact with
-0000ca70: 2074 6865 2060 6043 6c69 656e 7460 602c   the ``Client``,
-0000ca80: 2077 6869 6368 2069 6e20 7475 726e 2065   which in turn e
-0000ca90: 6e67 6167 6573 2074 6865 0a20 2020 2060  ngages the.    `
-0000caa0: 6053 6368 6564 756c 6572 6060 2061 6666  `Scheduler`` aff
-0000cab0: 6563 7469 6e67 2064 6966 6665 7265 6e74  ecting different
-0000cac0: 2074 7261 6e73 6974 696f 6e73 2068 6572   transitions her
-0000cad0: 6520 756e 6465 722d 7468 652d 686f 6f64  e under-the-hood
-0000cae0: 2e20 496e 0a20 2020 2074 6865 2062 6163  . In.    the bac
-0000caf0: 6b67 726f 756e 6420 6060 576f 726b 6572  kground ``Worker
-0000cb00: 6060 7320 616c 736f 2065 6e67 6167 6520  ``s also engage 
-0000cb10: 7769 7468 2074 6865 2060 6053 6368 6564  with the ``Sched
-0000cb20: 756c 6572 6060 0a20 2020 2061 6666 6563  uler``.    affec
-0000cb30: 7469 6e67 2074 6865 7365 2073 7461 7465  ting these state
-0000cb40: 2074 7261 6e73 6974 696f 6e73 2061 7320   transitions as 
-0000cb50: 7765 6c6c 2e0a 2020 2020 2222 220a 0a20  well..    """.. 
-0000cb60: 2020 2062 616e 6477 6964 7468 3a20 696e     bandwidth: in
-0000cb70: 740a 0a20 2020 2023 3a20 436c 6965 6e74  t..    #: Client
-0000cb80: 7320 6375 7272 656e 746c 7920 636f 6e6e  s currently conn
-0000cb90: 6563 7465 6420 746f 2074 6865 2073 6368  ected to the sch
-0000cba0: 6564 756c 6572 0a20 2020 2063 6c69 656e  eduler.    clien
-0000cbb0: 7473 3a20 6469 6374 5b73 7472 2c20 436c  ts: dict[str, Cl
-0000cbc0: 6965 6e74 5374 6174 655d 0a0a 2020 2020  ientState]..    
-0000cbd0: 6578 7465 6e73 696f 6e73 3a20 6469 6374  extensions: dict
-0000cbe0: 5b73 7472 2c20 416e 795d 2020 2320 544f  [str, Any]  # TO
-0000cbf0: 444f 2077 7269 7465 2061 2073 6368 6564  DO write a sched
-0000cc00: 756c 6572 2065 7874 656e 7369 6f6e 2050  uler extension P
-0000cc10: 726f 746f 636f 6c0a 2020 2020 706c 7567  rotocol.    plug
-0000cc20: 696e 733a 2064 6963 745b 7374 722c 2053  ins: dict[str, S
-0000cc30: 6368 6564 756c 6572 506c 7567 696e 5d0a  chedulerPlugin].
-0000cc40: 2020 2020 686f 7374 5f69 6e66 6f3a 2064      host_info: d
-0000cc50: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-0000cc60: 722c 2041 6e79 5d5d 0a0a 2020 2020 233a  r, Any]]..    #:
-0000cc70: 2049 6620 5472 7565 2c20 656e 6162 6c65   If True, enable
-0000cc80: 2065 7870 656e 7369 7665 2069 6e74 6572   expensive inter
-0000cc90: 6e61 6c20 636f 6e73 6973 7465 6e63 7920  nal consistency 
-0000cca0: 6368 6563 6b2e 0a20 2020 2023 3a20 5479  check..    #: Ty
-0000ccb0: 7069 6361 6c6c 7920 6469 7361 626c 6564  pically disabled
-0000ccc0: 2069 6e20 7072 6f64 7563 7469 6f6e 2e0a   in production..
-0000ccd0: 2020 2020 7661 6c69 6461 7465 3a20 626f      validate: bo
-0000cce0: 6f6c 0a0a 2020 2020 2323 2323 2323 2323  ol..    ########
-0000ccf0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000cd00: 2020 2020 2320 576f 726b 6572 732d 7265      # Workers-re
-0000cd10: 6c61 7465 6420 7374 6174 650a 2020 2020  lated state.    
-0000cd20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cd30: 2323 2323 2323 230a 0a20 2020 2023 3a20  #######..    #: 
-0000cd40: 576f 726b 6572 7320 6375 7272 656e 746c  Workers currentl
-0000cd50: 7920 636f 6e6e 6563 7465 6420 746f 2074  y connected to t
-0000cd60: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
-0000cd70: 2023 3a20 2861 6374 7561 6c6c 7920 6120   #: (actually a 
-0000cd80: 536f 7274 6564 4469 6374 2c20 6275 7420  SortedDict, but 
-0000cd90: 7468 6520 736f 7274 6564 636f 6e74 6169  the sortedcontai
-0000cda0: 6e65 7273 2070 6163 6b61 6765 2069 736e  ners package isn
-0000cdb0: 2774 2061 6e6e 6f74 6174 6564 290a 2020  't annotated).  
-0000cdc0: 2020 776f 726b 6572 733a 2064 6963 745b    workers: dict[
-0000cdd0: 7374 722c 2057 6f72 6b65 7253 7461 7465  str, WorkerState
-0000cde0: 5d0a 2020 2020 233a 2057 6f72 6b65 7220  ].    #: Worker 
-0000cdf0: 7b6e 616d 653a 2061 6464 7265 7373 7d0a  {name: address}.
-0000ce00: 2020 2020 616c 6961 7365 733a 2064 6963      aliases: dic
-0000ce10: 745b 4861 7368 6162 6c65 2c20 7374 725d  t[Hashable, str]
-0000ce20: 0a20 2020 2023 3a20 576f 726b 6572 7320  .    #: Workers 
-0000ce30: 7468 6174 2061 7265 2063 7572 7265 6e74  that are current
-0000ce40: 6c79 2069 6e20 7275 6e6e 696e 6720 7374  ly in running st
-0000ce50: 6174 650a 2020 2020 7275 6e6e 696e 673a  ate.    running:
-0000ce60: 2073 6574 5b57 6f72 6b65 7253 7461 7465   set[WorkerState
-0000ce70: 5d0a 2020 2020 233a 2057 6f72 6b65 7273  ].    #: Workers
-0000ce80: 2074 6861 7420 6172 6520 6375 7272 656e   that are curren
-0000ce90: 746c 7920 696e 2072 756e 6e69 6e67 2073  tly in running s
-0000cea0: 7461 7465 2061 6e64 206e 6f74 2066 756c  tate and not ful
-0000ceb0: 6c79 2075 7469 6c69 7a65 640a 2020 2020  ly utilized.    
-0000cec0: 233a 2044 6566 696e 6974 696f 6e20 6261  #: Definition ba
-0000ced0: 7365 6420 6f6e 206f 6363 7570 616e 6379  sed on occupancy
-0000cee0: 0a20 2020 2023 3a20 2861 6374 7561 6c6c  .    #: (actuall
-0000cef0: 7920 6120 536f 7274 6564 4469 6374 2c20  y a SortedDict, 
-0000cf00: 6275 7420 7468 6520 736f 7274 6564 636f  but the sortedco
-0000cf10: 6e74 6169 6e65 7273 2070 6163 6b61 6765  ntainers package
-0000cf20: 2069 736e 2774 2061 6e6e 6f74 6174 6564   isn't annotated
-0000cf30: 290a 2020 2020 6964 6c65 3a20 6469 6374  ).    idle: dict
-0000cf40: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
-0000cf50: 655d 0a20 2020 2023 3a20 5369 6d69 6c61  e].    #: Simila
-0000cf60: 7220 746f 2060 6964 6c65 600a 2020 2020  r to `idle`.    
-0000cf70: 233a 2044 6566 696e 6974 696f 6e20 6261  #: Definition ba
-0000cf80: 7365 6420 6f6e 2061 7373 6967 6e65 6420  sed on assigned 
-0000cf90: 7461 736b 730a 2020 2020 6964 6c65 5f74  tasks.    idle_t
-0000cfa0: 6173 6b5f 636f 756e 743a 2073 6574 5b57  ask_count: set[W
-0000cfb0: 6f72 6b65 7253 7461 7465 5d0a 2020 2020  orkerState].    
-0000cfc0: 233a 2057 6f72 6b65 7273 2074 6861 7420  #: Workers that 
-0000cfd0: 6172 6520 6675 6c6c 7920 7574 696c 697a  are fully utiliz
-0000cfe0: 6564 2e20 4d61 7920 696e 636c 7564 6520  ed. May include 
-0000cff0: 6e6f 6e2d 7275 6e6e 696e 6720 776f 726b  non-running work
-0000d000: 6572 732e 0a20 2020 2073 6174 7572 6174  ers..    saturat
-0000d010: 6564 3a20 7365 745b 576f 726b 6572 5374  ed: set[WorkerSt
-0000d020: 6174 655d 0a20 2020 2074 6f74 616c 5f6e  ate].    total_n
-0000d030: 7468 7265 6164 733a 2069 6e74 0a20 2020  threads: int.   
-0000d040: 2023 3a20 436c 7573 7465 722d 7769 6465   #: Cluster-wide
-0000d050: 2072 6573 6f75 7263 6573 2e20 7b72 6573   resources. {res
-0000d060: 6f75 7263 6520 6e61 6d65 3a20 7b77 6f72  ource name: {wor
-0000d070: 6b65 7220 6164 6472 6573 733a 2061 6d6f  ker address: amo
-0000d080: 756e 747d 7d0a 2020 2020 7265 736f 7572  unt}}.    resour
-0000d090: 6365 733a 2064 6963 745b 7374 722c 2064  ces: dict[str, d
-0000d0a0: 6963 745b 7374 722c 2066 6c6f 6174 5d5d  ict[str, float]]
-0000d0b0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-0000d0c0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0000d0d0: 2320 5461 736b 732d 7265 6c61 7465 6420  # Tasks-related 
-0000d0e0: 7374 6174 650a 2020 2020 2323 2323 2323  state.    ######
-0000d0f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000d100: 0a20 2020 2023 3a20 546f 7461 6c20 6e75  .    #: Total nu
-0000d110: 6d62 6572 206f 6620 7461 736b 7320 6576  mber of tasks ev
-0000d120: 6572 2070 726f 6365 7373 6564 0a20 2020  er processed.   
-0000d130: 206e 5f74 6173 6b73 3a20 696e 740a 0a20   n_tasks: int.. 
-0000d140: 2020 2023 3a20 416c 6c20 7461 736b 7320     #: All tasks 
-0000d150: 6375 7272 656e 746c 7920 6b6e 6f77 6e20  currently known 
-0000d160: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
-0000d170: 0a20 2020 2074 6173 6b73 3a20 6469 6374  .    tasks: dict
-0000d180: 5b73 7472 2c20 5461 736b 5374 6174 655d  [str, TaskState]
-0000d190: 0a0a 2020 2020 233a 2054 6173 6b73 2069  ..    #: Tasks i
-0000d1a0: 6e20 7468 6520 2271 7565 7565 6422 2073  n the "queued" s
-0000d1b0: 7461 7465 2c20 6f72 6465 7265 6420 6279  tate, ordered by
-0000d1c0: 2070 7269 6f72 6974 790a 2020 2020 7175   priority.    qu
-0000d1d0: 6575 6564 3a20 4865 6170 5365 745b 5461  eued: HeapSet[Ta
-0000d1e0: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
-0000d1f0: 2054 6173 6b73 2069 6e20 7468 6520 226e   Tasks in the "n
-0000d200: 6f2d 776f 726b 6572 2220 7374 6174 650a  o-worker" state.
-0000d210: 2020 2020 756e 7275 6e6e 6162 6c65 3a20      unrunnable: 
-0000d220: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
-0000d230: 2020 2020 233a 2053 7562 7365 7420 6f66      #: Subset of
-0000d240: 2074 6173 6b73 2074 6861 7420 6578 6973   tasks that exis
-0000d250: 7420 696e 206d 656d 6f72 7920 6f6e 206d  t in memory on m
-0000d260: 6f72 6520 7468 616e 206f 6e65 2077 6f72  ore than one wor
-0000d270: 6b65 720a 2020 2020 7265 706c 6963 6174  ker.    replicat
-0000d280: 6564 5f74 6173 6b73 3a20 7365 745b 5461  ed_tasks: set[Ta
-0000d290: 736b 5374 6174 655d 0a0a 2020 2020 756e  skState]..    un
-0000d2a0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 733a  known_durations:
-0000d2b0: 2064 6963 745b 7374 722c 2073 6574 5b54   dict[str, set[T
-0000d2c0: 6173 6b53 7461 7465 5d5d 0a20 2020 2074  askState]].    t
-0000d2d0: 6173 6b5f 6772 6f75 7073 3a20 6469 6374  ask_groups: dict
-0000d2e0: 5b73 7472 2c20 5461 736b 4772 6f75 705d  [str, TaskGroup]
-0000d2f0: 0a20 2020 2074 6173 6b5f 7072 6566 6978  .    task_prefix
-0000d300: 6573 3a20 6469 6374 5b73 7472 2c20 5461  es: dict[str, Ta
-0000d310: 736b 5072 6566 6978 5d0a 2020 2020 7461  skPrefix].    ta
-0000d320: 736b 5f6d 6574 6164 6174 613a 2064 6963  sk_metadata: dic
-0000d330: 745b 7374 722c 2041 6e79 5d0a 0a20 2020  t[str, Any]..   
-0000d340: 2023 2323 2323 2323 2323 0a20 2020 2023   #########.    #
-0000d350: 2048 6973 746f 7279 0a20 2020 2023 2323   History.    ###
-0000d360: 2323 2323 2323 0a0a 2020 2020 233a 2048  ######..    #: H
-0000d370: 6973 746f 7279 206f 6620 636f 6d70 7574  istory of comput
-0000d380: 6174 696f 6e73 2e0a 2020 2020 233a 2054  ations..    #: T
-0000d390: 6865 206c 656e 6774 6820 6361 6e20 6265  he length can be
-0000d3a0: 2074 7765 616b 6564 2074 6872 6f75 6768   tweaked through
-0000d3b0: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
-0000d3c0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
-0000d3d0: 636f 6d70 7574 6174 696f 6e73 2e6d 6178  computations.max
-0000d3e0: 2d68 6973 746f 7279 0a20 2020 2063 6f6d  -history.    com
-0000d3f0: 7075 7461 7469 6f6e 733a 2064 6571 7565  putations: deque
-0000d400: 5b43 6f6d 7075 7461 7469 6f6e 5d0a 0a20  [Computation].. 
-0000d410: 2020 2023 3a20 4869 7374 6f72 7920 6f66     #: History of
-0000d420: 2065 7272 6564 2074 6173 6b73 2e0a 2020   erred tasks..  
-0000d430: 2020 233a 2054 6865 206c 656e 6774 6820    #: The length 
-0000d440: 6361 6e20 6265 2074 7765 616b 6564 2074  can be tweaked t
-0000d450: 6872 6f75 6768 0a20 2020 2023 3a20 6469  hrough.    #: di
-0000d460: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
-0000d470: 7374 6963 732e 6572 7265 642d 7461 736b  stics.erred-task
-0000d480: 732e 6d61 782d 6869 7374 6f72 790a 2020  s.max-history.  
-0000d490: 2020 6572 7265 645f 7461 736b 733a 2064    erred_tasks: d
-0000d4a0: 6571 7565 5b45 7272 6564 5461 736b 5d0a  eque[ErredTask].
-0000d4b0: 0a20 2020 2023 3a20 4869 7374 6f72 7920  .    #: History 
-0000d4c0: 6f66 2074 6173 6b20 7374 6174 6520 7472  of task state tr
-0000d4d0: 616e 7369 7469 6f6e 732e 0a20 2020 2023  ansitions..    #
-0000d4e0: 3a20 5468 6520 6c65 6e67 7468 2063 616e  : The length can
-0000d4f0: 2062 6520 7477 6561 6b65 6420 7468 726f   be tweaked thro
-0000d500: 7567 680a 2020 2020 233a 2064 6973 7472  ugh.    #: distr
-0000d510: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0000d520: 2e74 7261 6e73 6974 696f 6e2d 6c6f 672d  .transition-log-
-0000d530: 6c65 6e67 7468 0a20 2020 2074 7261 6e73  length.    trans
-0000d540: 6974 696f 6e5f 6c6f 673a 2064 6571 7565  ition_log: deque
-0000d550: 5b54 7261 6e73 6974 696f 6e5d 0a0a 2020  [Transition]..  
-0000d560: 2020 233a 2054 6f74 616c 206e 756d 6265    #: Total numbe
-0000d570: 7220 6f66 2074 7261 6e73 6974 696f 6e73  r of transitions
-0000d580: 2073 696e 6365 2074 6865 2063 6c75 7374   since the clust
-0000d590: 6572 2077 6173 2073 7461 7274 6564 0a20  er was started. 
-0000d5a0: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
-0000d5b0: 756e 7465 723a 2069 6e74 0a0a 2020 2020  unter: int..    
-0000d5c0: 233a 2054 6f74 616c 206e 756d 6265 7220  #: Total number 
-0000d5d0: 6f66 2074 7261 6e73 6974 696f 6e73 2061  of transitions a
-0000d5e0: 7320 6f66 2074 6865 2070 7265 7669 6f75  s of the previou
-0000d5f0: 7320 6361 6c6c 2074 6f20 6368 6563 6b5f  s call to check_
-0000d600: 6964 6c65 2829 0a20 2020 205f 6964 6c65  idle().    _idle
-0000d610: 5f74 7261 6e73 6974 696f 6e5f 636f 756e  _transition_coun
-0000d620: 7465 723a 2069 6e74 0a0a 2020 2020 233a  ter: int..    #:
-0000d630: 2052 6169 7365 2061 6e20 6572 726f 7220   Raise an error 
-0000d640: 6966 2074 6865 203a 6174 7472 3a60 7472  if the :attr:`tr
-0000d650: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-0000d660: 6020 6576 6572 2072 6561 6368 6573 2074  ` ever reaches t
-0000d670: 6869 7320 7661 6c75 652e 0a20 2020 2023  his value..    #
-0000d680: 3a20 5468 6973 2069 7320 6d65 616e 7420  : This is meant 
-0000d690: 666f 7220 6465 6275 6767 696e 6720 6f6e  for debugging on
-0000d6a0: 6c79 2c20 746f 2063 6174 6368 2069 6e66  ly, to catch inf
-0000d6b0: 696e 6974 6520 7265 6375 7273 696f 6e20  inite recursion 
-0000d6c0: 6c6f 6f70 732e 0a20 2020 2023 3a20 496e  loops..    #: In
-0000d6d0: 2070 726f 6475 6374 696f 6e2c 2069 7420   production, it 
-0000d6e0: 7368 6f75 6c64 2061 6c77 6179 7320 6265  should always be
-0000d6f0: 2073 6574 2074 6f20 4661 6c73 652e 0a20   set to False.. 
-0000d700: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
-0000d710: 756e 7465 725f 6d61 783a 2069 6e74 207c  unter_max: int |
-0000d720: 204c 6974 6572 616c 5b46 616c 7365 5d0a   Literal[False].
-0000d730: 0a20 2020 205f 7461 736b 5f70 7265 6669  .    _task_prefi
-0000d740: 785f 636f 756e 745f 676c 6f62 616c 3a20  x_count_global: 
-0000d750: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
-0000d760: 2069 6e74 5d0a 2020 2020 5f6e 6574 776f   int].    _netwo
-0000d770: 726b 5f6f 6363 5f67 6c6f 6261 6c3a 2066  rk_occ_global: f
-0000d780: 6c6f 6174 0a20 2020 2023 2323 2323 2323  loat.    #######
-0000d790: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000d7a0: 2020 2020 2320 4361 6368 6564 2063 6f6e      # Cached con
-0000d7b0: 6669 6775 7261 7469 6f6e 0a20 2020 2023  figuration.    #
+00000ee0: 6e6f 7265 0a0a 2320 7b74 6173 6b20 6b65  nore..# {task ke
+00000ef0: 7920 2d3e 2066 696e 6973 6820 7374 6174  y -> finish stat
+00000f00: 657d 0a23 204e 6f74 2074 6f20 6265 2063  e}.# Not to be c
+00000f10: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
+00000f20: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
+00000f30: 7374 6174 655f 6d61 6368 696e 652e 5265  state_machine.Re
+00000f40: 6373 0a52 6563 733a 2054 7970 6541 6c69  cs.Recs: TypeAli
+00000f50: 6173 203d 2064 6963 745b 7374 722c 2054  as = dict[str, T
+00000f60: 6173 6b53 7461 7465 5374 6174 655d 0a23  askStateState].#
+00000f70: 207b 636c 6965 6e74 206f 7220 776f 726b   {client or work
+00000f80: 6572 2061 6464 7265 7373 3a20 5b7b 6f70  er address: [{op
+00000f90: 3a20 3c6b 6579 3e2c 202e 2e2e 7d2c 202e  : <key>, ...}, .
+00000fa0: 2e2e 5d7d 0a4d 7367 733a 2054 7970 6541  ..]}.Msgs: TypeA
+00000fb0: 6c69 6173 203d 2064 6963 745b 7374 722c  lias = dict[str,
+00000fc0: 206c 6973 745b 6469 6374 5b73 7472 2c20   list[dict[str, 
+00000fd0: 416e 795d 5d5d 0a23 2028 7265 636f 6d6d  Any]]].# (recomm
+00000fe0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+00000ff0: 7420 6d65 7373 6167 6573 2c20 776f 726b  t messages, work
+00001000: 6572 206d 6573 7361 6765 7329 0a52 6563  er messages).Rec
+00001010: 734d 7367 733a 2054 7970 6541 6c69 6173  sMsgs: TypeAlias
+00001020: 203d 2074 7570 6c65 5b52 6563 732c 204d   = tuple[Recs, M
+00001030: 7367 732c 204d 7367 735d 0a0a 6c6f 6767  sgs, Msgs]..logg
+00001040: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
+00001050: 4c6f 6767 6572 285f 5f6e 616d 655f 5f29  Logger(__name__)
+00001060: 0a4c 4f47 5f50 4442 203d 2064 6173 6b2e  .LOG_PDB = dask.
+00001070: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+00001080: 7269 6275 7465 642e 6164 6d69 6e2e 7064  ributed.admin.pd
+00001090: 622d 6f6e 2d65 7272 2229 0a44 4546 4155  b-on-err").DEFAU
+000010a0: 4c54 5f44 4154 415f 5349 5a45 203d 2070  LT_DATA_SIZE = p
+000010b0: 6172 7365 5f62 7974 6573 280a 2020 2020  arse_bytes(.    
+000010c0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+000010d0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+000010e0: 6564 756c 6572 2e64 6566 6175 6c74 2d64  eduler.default-d
+000010f0: 6174 612d 7369 7a65 2229 0a29 0a53 5449  ata-size").).STI
+00001100: 4d55 4c55 535f 4944 5f55 4e53 4554 203d  MULUS_ID_UNSET =
+00001110: 2022 3c73 7469 6d75 6c75 735f 6964 2075   "<stimulus_id u
+00001120: 6e73 6574 3e22 0a0a 4445 4641 554c 545f  nset>"..DEFAULT_
+00001130: 4558 5445 4e53 494f 4e53 203d 207b 0a20  EXTENSIONS = {. 
+00001140: 2020 2022 6c6f 636b 7322 3a20 4c6f 636b     "locks": Lock
+00001150: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
+00001160: 6d75 6c74 695f 6c6f 636b 7322 3a20 4d75  multi_locks": Mu
+00001170: 6c74 694c 6f63 6b45 7874 656e 7369 6f6e  ltiLockExtension
+00001180: 2c0a 2020 2020 2270 7562 6c69 7368 223a  ,.    "publish":
+00001190: 2050 7562 6c69 7368 4578 7465 6e73 696f   PublishExtensio
+000011a0: 6e2c 0a20 2020 2022 7265 706c 6179 2d74  n,.    "replay-t
+000011b0: 6173 6b73 223a 2052 6570 6c61 7954 6173  asks": ReplayTas
+000011c0: 6b53 6368 6564 756c 6572 2c0a 2020 2020  kScheduler,.    
+000011d0: 2271 7565 7565 7322 3a20 5175 6575 6545  "queues": QueueE
+000011e0: 7874 656e 7369 6f6e 2c0a 2020 2020 2276  xtension,.    "v
+000011f0: 6172 6961 626c 6573 223a 2056 6172 6961  ariables": Varia
+00001200: 626c 6545 7874 656e 7369 6f6e 2c0a 2020  bleExtension,.  
+00001210: 2020 2270 7562 7375 6222 3a20 5075 6253    "pubsub": PubS
+00001220: 7562 5363 6865 6475 6c65 7245 7874 656e  ubSchedulerExten
+00001230: 7369 6f6e 2c0a 2020 2020 2273 656d 6170  sion,.    "semap
+00001240: 686f 7265 7322 3a20 5365 6d61 7068 6f72  hores": Semaphor
+00001250: 6545 7874 656e 7369 6f6e 2c0a 2020 2020  eExtension,.    
+00001260: 2265 7665 6e74 7322 3a20 4576 656e 7445  "events": EventE
+00001270: 7874 656e 7369 6f6e 2c0a 2020 2020 2261  xtension,.    "a
+00001280: 6d6d 223a 2041 6374 6976 654d 656d 6f72  mm": ActiveMemor
+00001290: 794d 616e 6167 6572 4578 7465 6e73 696f  yManagerExtensio
+000012a0: 6e2c 0a20 2020 2022 6d65 6d6f 7279 5f73  n,.    "memory_s
+000012b0: 616d 706c 6572 223a 204d 656d 6f72 7953  ampler": MemoryS
+000012c0: 616d 706c 6572 4578 7465 6e73 696f 6e2c  amplerExtension,
+000012d0: 0a20 2020 2022 7368 7566 666c 6522 3a20  .    "shuffle": 
+000012e0: 5368 7566 666c 6553 6368 6564 756c 6572  ShuffleScheduler
+000012f0: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
+00001300: 7374 6561 6c69 6e67 223a 2057 6f72 6b53  stealing": WorkS
+00001310: 7465 616c 696e 672c 0a7d 0a0a 0a63 6c61  tealing,.}...cla
+00001320: 7373 2043 6c69 656e 7453 7461 7465 3a0a  ss ClientState:.
+00001330: 2020 2020 2222 2241 2073 696d 706c 6520      """A simple 
+00001340: 6f62 6a65 6374 2068 6f6c 6469 6e67 2069  object holding i
+00001350: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+00001360: 2061 2063 6c69 656e 742e 2222 220a 0a20   a client.""".. 
+00001370: 2020 2023 3a20 4120 756e 6971 7565 2069     #: A unique i
+00001380: 6465 6e74 6966 6965 7220 666f 7220 7468  dentifier for th
+00001390: 6973 2063 6c69 656e 742e 2054 6869 7320  is client. This 
+000013a0: 6973 2067 656e 6572 616c 6c79 2061 6e20  is generally an 
+000013b0: 6f70 6171 7565 0a20 2020 2023 3a20 7374  opaque.    #: st
+000013c0: 7269 6e67 2067 656e 6572 6174 6564 2062  ring generated b
+000013d0: 7920 7468 6520 636c 6965 6e74 2069 7473  y the client its
+000013e0: 656c 662e 0a20 2020 2063 6c69 656e 745f  elf..    client_
+000013f0: 6b65 793a 2073 7472 0a0a 2020 2020 233a  key: str..    #:
+00001400: 2043 6163 6865 6420 6861 7368 206f 6620   Cached hash of 
+00001410: 3a61 7474 723a 607e 436c 6965 6e74 5374  :attr:`~ClientSt
+00001420: 6174 652e 636c 6965 6e74 5f6b 6579 600a  ate.client_key`.
+00001430: 2020 2020 5f68 6173 683a 2069 6e74 0a0a      _hash: int..
+00001440: 2020 2020 233a 2041 2073 6574 206f 6620      #: A set of 
+00001450: 7461 736b 7320 7468 6973 2063 6c69 656e  tasks this clien
+00001460: 7420 7761 6e74 7320 746f 2062 6520 6b65  t wants to be ke
+00001470: 7074 2069 6e20 6d65 6d6f 7279 2c20 736f  pt in memory, so
+00001480: 2074 6861 7420 6974 2063 616e 2064 6f77   that it can dow
+00001490: 6e6c 6f61 640a 2020 2020 233a 2069 7473  nload.    #: its
+000014a0: 2072 6573 756c 7420 7768 656e 2064 6573   result when des
+000014b0: 6972 6564 2e20 5468 6973 2069 7320 7468  ired. This is th
+000014c0: 6520 7265 7665 7273 6520 6d61 7070 696e  e reverse mappin
+000014d0: 6720 6f66 0a20 2020 2023 3a20 3a63 6c61  g of.    #: :cla
+000014e0: 7373 3a60 5461 736b 5374 6174 652e 7768  ss:`TaskState.wh
+000014f0: 6f5f 7761 6e74 7360 2e20 5461 736b 7320  o_wants`. Tasks 
+00001500: 6172 6520 7479 7069 6361 6c6c 7920 7265  are typically re
+00001510: 6d6f 7665 6420 6672 6f6d 2074 6869 7320  moved from this 
+00001520: 7365 7420 7768 656e 2074 6865 0a20 2020  set when the.   
+00001530: 2023 3a20 636f 7272 6573 706f 6e64 696e   #: correspondin
+00001540: 6720 6f62 6a65 6374 2069 6e20 7468 6520  g object in the 
+00001550: 636c 6965 6e74 2773 2073 7061 6365 2028  client's space (
+00001560: 666f 7220 6578 616d 706c 6520 6120 6060  for example a ``
+00001570: 4675 7475 7265 6060 206f 7220 6120 4461  Future`` or a Da
+00001580: 736b 0a20 2020 2023 3a20 636f 6c6c 6563  sk.    #: collec
+00001590: 7469 6f6e 2920 6765 7473 2067 6172 6261  tion) gets garba
+000015a0: 6765 2d63 6f6c 6c65 6374 6564 2e0a 2020  ge-collected..  
+000015b0: 2020 7761 6e74 735f 7768 6174 3a20 7365    wants_what: se
+000015c0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+000015d0: 2020 233a 2054 6865 206c 6173 7420 7469    #: The last ti
+000015e0: 6d65 2077 6520 7265 6365 6976 6564 2061  me we received a
+000015f0: 2068 6561 7274 6265 6174 2066 726f 6d20   heartbeat from 
+00001600: 7468 6973 2063 6c69 656e 742c 2069 6e20  this client, in 
+00001610: 6c6f 6361 6c20 7363 6865 6475 6c65 7220  local scheduler 
+00001620: 7469 6d65 2e0a 2020 2020 6c61 7374 5f73  time..    last_s
+00001630: 6565 6e3a 2066 6c6f 6174 0a0a 2020 2020  een: float..    
+00001640: 233a 204f 7574 7075 7420 6f66 203a 6675  #: Output of :fu
+00001650: 6e63 3a60 6469 7374 7269 6275 7465 642e  nc:`distributed.
+00001660: 7665 7273 696f 6e73 2e67 6574 5f76 6572  versions.get_ver
+00001670: 7369 6f6e 7360 206f 6e20 7468 6520 636c  sions` on the cl
+00001680: 6965 6e74 0a20 2020 2076 6572 7369 6f6e  ient.    version
+00001690: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
+000016a0: 5d0a 0a20 2020 205f 5f73 6c6f 7473 5f5f  ]..    __slots__
+000016b0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+000016c0: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
+000016d0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000016e0: 2c20 636c 6965 6e74 3a20 7374 722c 202a  , client: str, *
+000016f0: 2c20 7665 7273 696f 6e73 3a20 6469 6374  , versions: dict
+00001700: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
+00001710: 6520 3d20 4e6f 6e65 293a 0a20 2020 2020  e = None):.     
+00001720: 2020 2073 656c 662e 636c 6965 6e74 5f6b     self.client_k
+00001730: 6579 203d 2063 6c69 656e 740a 2020 2020  ey = client.    
+00001740: 2020 2020 7365 6c66 2e5f 6861 7368 203d      self._hash =
+00001750: 2068 6173 6828 636c 6965 6e74 290a 2020   hash(client).  
+00001760: 2020 2020 2020 7365 6c66 2e77 616e 7473        self.wants
+00001770: 5f77 6861 7420 3d20 7365 7428 290a 2020  _what = set().  
+00001780: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
+00001790: 7365 656e 203d 2074 696d 6528 290a 2020  seen = time().  
+000017a0: 2020 2020 2020 7365 6c66 2e76 6572 7369        self.versi
+000017b0: 6f6e 7320 3d20 7665 7273 696f 6e73 206f  ons = versions o
+000017c0: 7220 7b7d 0a0a 2020 2020 6465 6620 5f5f  r {}..    def __
+000017d0: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
+000017e0: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
+000017f0: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
+00001800: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
+00001810: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
+00001820: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
+00001830: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00001840: 7374 616e 6365 286f 7468 6572 2c20 436c  stance(other, Cl
+00001850: 6965 6e74 5374 6174 6529 3a0a 2020 2020  ientState):.    
+00001860: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00001870: 616c 7365 0a20 2020 2020 2020 2072 6574  alse.        ret
+00001880: 7572 6e20 7365 6c66 2e63 6c69 656e 745f  urn self.client_
+00001890: 6b65 7920 3d3d 206f 7468 6572 2e63 6c69  key == other.cli
+000018a0: 656e 745f 6b65 790a 0a20 2020 2064 6566  ent_key..    def
+000018b0: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
+000018c0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+000018d0: 7265 7475 726e 2066 223c 436c 6965 6e74  return f"<Client
+000018e0: 207b 7365 6c66 2e63 6c69 656e 745f 6b65   {self.client_ke
+000018f0: 7921 727d 3e22 0a0a 2020 2020 6465 6620  y!r}>"..    def 
+00001900: 5f5f 7374 725f 5f28 7365 6c66 2920 2d3e  __str__(self) ->
+00001910: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+00001920: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
+00001930: 5f6b 6579 0a0a 2020 2020 6465 6620 5f74  _key..    def _t
+00001940: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
+00001950: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
+00001960: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
+00001970: 3d20 2829 2920 2d3e 2064 6963 743a 0a20  = ()) -> dict:. 
+00001980: 2020 2020 2020 2022 2222 4469 6374 696f         """Dictio
+00001990: 6e61 7279 2072 6570 7265 7365 6e74 6174  nary representat
+000019a0: 696f 6e20 666f 7220 6465 6275 6767 696e  ion for debuggin
+000019b0: 6720 7075 7270 6f73 6573 2e0a 2020 2020  g purposes..    
+000019c0: 2020 2020 4e6f 7420 7479 7065 2073 7461      Not type sta
+000019d0: 626c 6520 616e 6420 6e6f 7420 696e 7465  ble and not inte
+000019e0: 6e64 6564 2066 6f72 2072 6f75 6e64 7472  nded for roundtr
+000019f0: 6970 732e 0a0a 2020 2020 2020 2020 5365  ips...        Se
+00001a00: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+00001a10: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00001a20: 436c 6965 6e74 2e64 756d 705f 636c 7573  Client.dump_clus
+00001a30: 7465 725f 7374 6174 650a 2020 2020 2020  ter_state.      
+00001a40: 2020 6469 7374 7269 6275 7465 642e 7574    distributed.ut
+00001a50: 696c 732e 7265 6375 7273 6976 655f 746f  ils.recursive_to
+00001a60: 5f64 6963 740a 2020 2020 2020 2020 5461  _dict.        Ta
+00001a70: 736b 5374 6174 652e 5f74 6f5f 6469 6374  skState._to_dict
+00001a80: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00001a90: 2020 2020 2072 6574 7572 6e20 7265 6375       return recu
+00001aa0: 7273 6976 655f 746f 5f64 6963 7428 0a20  rsive_to_dict(. 
+00001ab0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00001ac0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00001ad0: 6c75 6465 3d73 6574 2865 7863 6c75 6465  lude=set(exclude
+00001ae0: 2920 7c20 7b22 7665 7273 696f 6e73 227d  ) | {"versions"}
+00001af0: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
+00001b00: 650a 2020 2020 2020 2020 2020 2020 6d65  e.            me
+00001b10: 6d62 6572 733d 5472 7565 2c0a 2020 2020  mbers=True,.    
+00001b20: 2020 2020 290a 0a0a 636c 6173 7320 4d65      )...class Me
+00001b30: 6d6f 7279 5374 6174 653a 0a20 2020 2022  moryState:.    "
+00001b40: 2222 4d65 6d6f 7279 2072 6561 6469 6e67  ""Memory reading
+00001b50: 7320 6f6e 2061 2077 6f72 6b65 7220 6f72  s on a worker or
+00001b60: 206f 6e20 7468 6520 7768 6f6c 6520 636c   on the whole cl
+00001b70: 7573 7465 722e 0a0a 2020 2020 5365 6520  uster...    See 
+00001b80: 3a64 6f63 3a60 776f 726b 6572 2d6d 656d  :doc:`worker-mem
+00001b90: 6f72 7960 2e0a 0a20 2020 2041 7474 7269  ory`...    Attri
+00001ba0: 6275 7465 7320 2f20 7072 6f70 6572 7469  butes / properti
+00001bb0: 6573 3a0a 0a20 2020 206d 616e 6167 6564  es:..    managed
+00001bc0: 5f74 6f74 616c 0a20 2020 2020 2020 2053  _total.        S
+00001bd0: 756d 206f 6620 7468 6520 6f75 7470 7574  um of the output
+00001be0: 206f 6620 7369 7a65 6f66 2829 2066 6f72   of sizeof() for
+00001bf0: 2061 6c6c 2064 6173 6b20 6b65 7973 2068   all dask keys h
+00001c00: 656c 6420 6279 2074 6865 2077 6f72 6b65  eld by the worke
+00001c10: 7220 696e 206d 656d 6f72 792c 0a20 2020  r in memory,.   
+00001c20: 2020 2020 2070 6c75 7320 6e75 6d62 6572       plus number
+00001c30: 206f 6620 6279 7465 7320 7370 696c 6c65   of bytes spille
+00001c40: 6420 746f 2064 6973 6b0a 0a20 2020 206d  d to disk..    m
+00001c50: 616e 6167 6564 0a20 2020 2020 2020 2053  anaged.        S
+00001c60: 756d 206f 6620 7468 6520 6f75 7470 7574  um of the output
+00001c70: 206f 6620 7369 7a65 6f66 2829 2066 6f72   of sizeof() for
+00001c80: 2074 6865 2064 6173 6b20 6b65 7973 2068   the dask keys h
+00001c90: 656c 6420 696e 2052 414d 2e20 4e6f 7465  eld in RAM. Note
+00001ca0: 2074 6861 7420 7468 6973 206d 6179 0a20   that this may. 
+00001cb0: 2020 2020 2020 2062 6520 696e 6163 6375         be inaccu
+00001cc0: 7261 7465 2c20 7768 6963 6820 6d61 7920  rate, which may 
+00001cd0: 6361 7573 6520 696e 6163 6375 7261 7465  cause inaccurate
+00001ce0: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
+00001cf0: 7920 2873 6565 2062 656c 6f77 292e 0a0a  y (see below)...
+00001d00: 2020 2020 7370 696c 6c65 640a 2020 2020      spilled.    
+00001d10: 2020 2020 4e75 6d62 6572 206f 6620 6279      Number of by
+00001d20: 7465 7320 2066 6f72 2074 6865 2064 6173  tes  for the das
+00001d30: 6b20 6b65 7973 2073 7069 6c6c 6564 2074  k keys spilled t
+00001d40: 6f20 7468 6520 6861 7264 2064 7269 7665  o the hard drive
+00001d50: 2e0a 2020 2020 2020 2020 4e6f 7465 2074  ..        Note t
+00001d60: 6861 7420 7468 6973 2069 7320 7468 6520  hat this is the 
+00001d70: 7369 7a65 206f 6e20 6469 736b 3b20 7369  size on disk; si
+00001d80: 7a65 2069 6e20 6d65 6d6f 7279 206d 6179  ze in memory may
+00001d90: 2062 6520 6469 6666 6572 656e 7420 6475   be different du
+00001da0: 6520 746f 0a20 2020 2020 2020 2063 6f6d  e to.        com
+00001db0: 7072 6573 7369 6f6e 2061 6e64 2069 6e61  pression and ina
+00001dc0: 6363 7572 6163 6965 7320 696e 2073 697a  ccuracies in siz
+00001dd0: 656f 6628 292e 2049 6e20 6f74 6865 7220  eof(). In other 
+00001de0: 776f 7264 732c 2067 6976 656e 2074 6865  words, given the
+00001df0: 2073 616d 6520 6b65 7973 2c0a 2020 2020   same keys,.    
+00001e00: 2020 2020 276d 616e 6167 6564 2720 7769      'managed' wi
+00001e10: 6c6c 2063 6861 6e67 6520 6465 7065 6e64  ll change depend
+00001e20: 696e 6720 6f6e 2074 6865 206b 6579 7320  ing on the keys 
+00001e30: 6265 696e 6720 696e 206d 656d 6f72 7920  being in memory 
+00001e40: 6f72 2073 7069 6c6c 6564 2e0a 0a20 2020  or spilled...   
+00001e50: 2070 726f 6365 7373 0a20 2020 2020 2020   process.       
+00001e60: 2054 6f74 616c 2052 5353 206d 656d 6f72   Total RSS memor
+00001e70: 7920 6d65 6173 7572 6564 2062 7920 7468  y measured by th
+00001e80: 6520 4f53 206f 6e20 7468 6520 776f 726b  e OS on the work
+00001e90: 6572 2070 726f 6365 7373 2e0a 2020 2020  er process..    
+00001ea0: 2020 2020 5468 6973 2069 7320 616c 7761      This is alwa
+00001eb0: 7973 2065 7861 6374 6c79 2065 7175 616c  ys exactly equal
+00001ec0: 2074 6f20 6d61 6e61 6765 6420 2b20 756e   to managed + un
+00001ed0: 6d61 6e61 6765 642e 0a0a 2020 2020 756e  managed...    un
+00001ee0: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
+00001ef0: 7072 6f63 6573 7320 2d20 6d61 6e61 6765  process - manage
+00001f00: 642e 2054 6869 7320 6973 2074 6865 2073  d. This is the s
+00001f10: 756d 206f 660a 0a20 2020 2020 2020 202d  um of..        -
+00001f20: 2050 7974 686f 6e20 696e 7465 7270 7265   Python interpre
+00001f30: 7465 7220 616e 6420 6d6f 6475 6c65 730a  ter and modules.
+00001f40: 2020 2020 2020 2020 2d20 676c 6f62 616c          - global
+00001f50: 2076 6172 6961 626c 6573 0a20 2020 2020   variables.     
+00001f60: 2020 202d 206d 656d 6f72 7920 7465 6d70     - memory temp
+00001f70: 6f72 6172 696c 7920 616c 6c6f 6361 7465  orarily allocate
+00001f80: 6420 6279 2074 6865 2064 6173 6b20 7461  d by the dask ta
+00001f90: 736b 7320 7468 6174 2061 7265 2063 7572  sks that are cur
+00001fa0: 7265 6e74 6c79 2072 756e 6e69 6e67 0a20  rently running. 
+00001fb0: 2020 2020 2020 202d 206d 656d 6f72 7920         - memory 
+00001fc0: 6672 6167 6d65 6e74 6174 696f 6e0a 2020  fragmentation.  
+00001fd0: 2020 2020 2020 2d20 6d65 6d6f 7279 206c        - memory l
+00001fe0: 6561 6b73 0a20 2020 2020 2020 202d 206d  eaks.        - m
+00001ff0: 656d 6f72 7920 6e6f 7420 7965 7420 6761  emory not yet ga
+00002000: 7262 6167 6520 636f 6c6c 6563 7465 640a  rbage collected.
+00002010: 2020 2020 2020 2020 2d20 6d65 6d6f 7279          - memory
+00002020: 206e 6f74 2079 6574 2066 7265 6528 2927   not yet free()'
+00002030: 6420 6279 2074 6865 2050 7974 686f 6e20  d by the Python 
+00002040: 6d65 6d6f 7279 206d 616e 6167 6572 2074  memory manager t
+00002050: 6f20 7468 6520 4f53 0a0a 2020 2020 756e  o the OS..    un
+00002060: 6d61 6e61 6765 645f 6f6c 640a 2020 2020  managed_old.    
+00002070: 2020 2020 4d69 6e69 6d75 6d20 6f66 2074      Minimum of t
+00002080: 6865 2027 756e 6d61 6e61 6765 6427 206d  he 'unmanaged' m
+00002090: 6561 7375 7265 7320 6f76 6572 2074 6865  easures over the
+000020a0: 206c 6173 740a 2020 2020 2020 2020 6060   last.        ``
+000020b0: 6469 7374 7269 6275 7465 642e 6d65 6d6f  distributed.memo
+000020c0: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
+000020d0: 2d74 696d 6560 6020 7365 636f 6e64 730a  -time`` seconds.
+000020e0: 0a20 2020 2075 6e6d 616e 6167 6564 5f72  .    unmanaged_r
+000020f0: 6563 656e 740a 2020 2020 2020 2020 756e  ecent.        un
+00002100: 6d61 6e61 6765 6420 2d20 756e 6d61 6e61  managed - unmana
+00002110: 6765 645f 6f6c 643b 2069 6e20 6f74 6865  ged_old; in othe
+00002120: 7220 776f 7264 7320 7072 6f63 6573 7320  r words process 
+00002130: 6d65 6d6f 7279 2074 6861 7420 6861 7320  memory that has 
+00002140: 6265 656e 2072 6563 656e 746c 790a 2020  been recently.  
+00002150: 2020 2020 2020 616c 6c6f 6361 7465 6420        allocated 
+00002160: 6275 7420 6973 206e 6f74 2061 6363 6f75  but is not accou
+00002170: 6e74 6564 2066 6f72 2062 7920 6461 736b  nted for by dask
+00002180: 3b20 686f 7065 6675 6c6c 7920 6974 2773  ; hopefully it's
+00002190: 206d 6f73 746c 7920 6120 7465 6d70 6f72   mostly a tempor
+000021a0: 6172 790a 2020 2020 2020 2020 7370 696b  ary.        spik
+000021b0: 652e 0a0a 2020 2020 6f70 7469 6d69 7374  e...    optimist
+000021c0: 6963 0a20 2020 2020 2020 206d 616e 6167  ic.        manag
+000021d0: 6564 202b 2075 6e6d 616e 6167 6564 5f6f  ed + unmanaged_o
+000021e0: 6c64 3b20 696e 206f 7468 6572 2077 6f72  ld; in other wor
+000021f0: 6473 2074 6865 206d 656d 6f72 7920 6865  ds the memory he
+00002200: 6c64 206c 6f6e 672d 7465 726d 2062 790a  ld long-term by.
+00002210: 2020 2020 2020 2020 7468 6520 7072 6f63          the proc
+00002220: 6573 7320 756e 6465 7220 7468 6520 686f  ess under the ho
+00002230: 7065 6675 6c20 6173 7375 6d70 7469 6f6e  peful assumption
+00002240: 2074 6861 7420 616c 6c20 756e 6d61 6e61   that all unmana
+00002250: 6765 645f 7265 6365 6e74 206d 656d 6f72  ged_recent memor
+00002260: 7920 6973 2061 0a20 2020 2020 2020 2074  y is a.        t
+00002270: 656d 706f 7261 7279 2073 7069 6b65 0a20  emporary spike. 
+00002280: 2020 2022 2222 0a0a 2020 2020 7072 6f63     """..    proc
+00002290: 6573 733a 2069 6e74 0a20 2020 2075 6e6d  ess: int.    unm
+000022a0: 616e 6167 6564 5f6f 6c64 3a20 696e 740a  anaged_old: int.
+000022b0: 2020 2020 6d61 6e61 6765 643a 2069 6e74      managed: int
+000022c0: 0a20 2020 2073 7069 6c6c 6564 3a20 696e  .    spilled: in
+000022d0: 740a 0a20 2020 205f 5f73 6c6f 7473 5f5f  t..    __slots__
+000022e0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+000022f0: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
+00002300: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00002310: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00002320: 2020 202a 2c0a 2020 2020 2020 2020 7072     *,.        pr
+00002330: 6f63 6573 733a 2069 6e74 2c0a 2020 2020  ocess: int,.    
+00002340: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
+00002350: 643a 2069 6e74 2c0a 2020 2020 2020 2020  d: int,.        
+00002360: 6d61 6e61 6765 643a 2069 6e74 2c0a 2020  managed: int,.  
+00002370: 2020 2020 2020 7370 696c 6c65 643a 2069        spilled: i
+00002380: 6e74 2c0a 2020 2020 293a 0a20 2020 2020  nt,.    ):.     
+00002390: 2020 2023 2053 6f6d 6520 6461 7461 2061     # Some data a
+000023a0: 7272 6976 6573 2077 6974 6820 7468 6520  rrives with the 
+000023b0: 6865 6172 7462 6561 742c 2073 6f6d 6520  heartbeat, some 
+000023c0: 6f74 6865 7220 6172 7269 7665 7320 696e  other arrives in
+000023d0: 2072 6561 6c74 696d 6520 6173 2074 6865   realtime as the
+000023e0: 0a20 2020 2020 2020 2023 2074 6173 6b73  .        # tasks
+000023f0: 2070 726f 6772 6573 732e 2041 6c73 6f2c   progress. Also,
+00002400: 2073 697a 656f 6628 2920 6973 206e 6f74   sizeof() is not
+00002410: 2067 7561 7261 6e74 6565 6420 746f 2072   guaranteed to r
+00002420: 6574 7572 6e20 636f 7272 6563 7420 7265  eturn correct re
+00002430: 7375 6c74 732e 0a20 2020 2020 2020 2023  sults..        #
+00002440: 2054 6869 7320 6361 6e20 6361 7573 6520   This can cause 
+00002450: 676c 6974 6368 6573 2077 6865 7265 2061  glitches where a
+00002460: 2070 6172 7469 616c 206d 6561 7375 7265   partial measure
+00002470: 2069 7320 6c61 7267 6572 2074 6861 6e20   is larger than 
+00002480: 7468 6520 7768 6f6c 652c 2073 6f0a 2020  the whole, so.  
+00002490: 2020 2020 2020 2320 7765 206e 6565 6420        # we need 
+000024a0: 746f 2066 6f72 6365 2061 6c6c 206e 756d  to force all num
+000024b0: 6265 7273 2074 6f20 6164 6420 7570 2065  bers to add up e
+000024c0: 7861 6374 6c79 2062 7920 6465 6669 6e69  xactly by defini
+000024d0: 7469 6f6e 2e0a 2020 2020 2020 2020 7365  tion..        se
+000024e0: 6c66 2e70 726f 6365 7373 203d 2070 726f  lf.process = pro
+000024f0: 6365 7373 0a20 2020 2020 2020 2073 656c  cess.        sel
+00002500: 662e 6d61 6e61 6765 6420 3d20 6d69 6e28  f.managed = min(
+00002510: 7365 6c66 2e70 726f 6365 7373 2c20 6d61  self.process, ma
+00002520: 6e61 6765 6429 0a20 2020 2020 2020 2073  naged).        s
+00002530: 656c 662e 7370 696c 6c65 6420 3d20 7370  elf.spilled = sp
+00002540: 696c 6c65 640a 2020 2020 2020 2020 2320  illed.        # 
+00002550: 5375 6274 7261 6374 696f 6e73 2062 6574  Subtractions bet
+00002560: 7765 656e 2075 6e73 6967 6e65 6420 696e  ween unsigned in
+00002570: 7473 2067 7561 7261 6e74 6565 6420 6279  ts guaranteed by
+00002580: 2063 6f6e 7374 7275 6374 696f 6e20 746f   construction to
+00002590: 2062 6520 3e3d 2030 0a20 2020 2020 2020   be >= 0.       
+000025a0: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
+000025b0: 6f6c 6420 3d20 6d69 6e28 756e 6d61 6e61  old = min(unmana
+000025c0: 6765 645f 6f6c 642c 2070 726f 6365 7373  ged_old, process
+000025d0: 202d 2073 656c 662e 6d61 6e61 6765 6429   - self.managed)
+000025e0: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+000025f0: 686f 640a 2020 2020 6465 6620 7375 6d28  hod.    def sum(
+00002600: 2a69 6e66 6f73 3a20 4d65 6d6f 7279 5374  *infos: MemorySt
+00002610: 6174 6529 202d 3e20 4d65 6d6f 7279 5374  ate) -> MemorySt
+00002620: 6174 653a 0a20 2020 2020 2020 2070 726f  ate:.        pro
+00002630: 6365 7373 203d 2030 0a20 2020 2020 2020  cess = 0.       
+00002640: 2075 6e6d 616e 6167 6564 5f6f 6c64 203d   unmanaged_old =
+00002650: 2030 0a20 2020 2020 2020 206d 616e 6167   0.        manag
+00002660: 6564 203d 2030 0a20 2020 2020 2020 2073  ed = 0.        s
+00002670: 7069 6c6c 6564 203d 2030 0a20 2020 2020  pilled = 0.     
+00002680: 2020 2066 6f72 206d 7320 696e 2069 6e66     for ms in inf
+00002690: 6f73 3a0a 2020 2020 2020 2020 2020 2020  os:.            
+000026a0: 7072 6f63 6573 7320 2b3d 206d 732e 7072  process += ms.pr
+000026b0: 6f63 6573 730a 2020 2020 2020 2020 2020  ocess.          
+000026c0: 2020 756e 6d61 6e61 6765 645f 6f6c 6420    unmanaged_old 
+000026d0: 2b3d 206d 732e 756e 6d61 6e61 6765 645f  += ms.unmanaged_
+000026e0: 6f6c 640a 2020 2020 2020 2020 2020 2020  old.            
+000026f0: 7370 696c 6c65 6420 2b3d 206d 732e 7370  spilled += ms.sp
+00002700: 696c 6c65 640a 2020 2020 2020 2020 2020  illed.          
+00002710: 2020 6d61 6e61 6765 6420 2b3d 206d 732e    managed += ms.
+00002720: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
+00002730: 7265 7475 726e 204d 656d 6f72 7953 7461  return MemorySta
+00002740: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+00002750: 7072 6f63 6573 733d 7072 6f63 6573 732c  process=process,
+00002760: 0a20 2020 2020 2020 2020 2020 2075 6e6d  .            unm
+00002770: 616e 6167 6564 5f6f 6c64 3d75 6e6d 616e  anaged_old=unman
+00002780: 6167 6564 5f6f 6c64 2c0a 2020 2020 2020  aged_old,.      
+00002790: 2020 2020 2020 6d61 6e61 6765 643d 6d61        managed=ma
+000027a0: 6e61 6765 642c 0a20 2020 2020 2020 2020  naged,.         
+000027b0: 2020 2073 7069 6c6c 6564 3d73 7069 6c6c     spilled=spill
+000027c0: 6564 2c0a 2020 2020 2020 2020 290a 0a20  ed,.        ).. 
+000027d0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+000027e0: 2064 6566 206d 616e 6167 6564 5f74 6f74   def managed_tot
+000027f0: 616c 2873 656c 6629 202d 3e20 696e 743a  al(self) -> int:
+00002800: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00002810: 7365 6c66 2e6d 616e 6167 6564 202b 2073  self.managed + s
+00002820: 656c 662e 7370 696c 6c65 640a 0a20 2020  elf.spilled..   
+00002830: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00002840: 6566 2075 6e6d 616e 6167 6564 2873 656c  ef unmanaged(sel
+00002850: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+00002860: 2020 2023 2054 6869 7320 6973 206e 6576     # This is nev
+00002870: 6572 206e 6567 6174 6976 6520 7468 616e  er negative than
+00002880: 6b73 2074 6f20 5f5f 696e 6974 5f5f 0a20  ks to __init__. 
+00002890: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000028a0: 6c66 2e70 726f 6365 7373 202d 2073 656c  lf.process - sel
+000028b0: 662e 6d61 6e61 6765 640a 0a20 2020 2040  f.managed..    @
+000028c0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+000028d0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+000028e0: 7428 7365 6c66 2920 2d3e 2069 6e74 3a0a  t(self) -> int:.
+000028f0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+00002900: 7320 6e65 7665 7220 6e65 6761 7469 7665  s never negative
+00002910: 2074 6861 6e6b 7320 746f 205f 5f69 6e69   thanks to __ini
+00002920: 745f 5f0a 2020 2020 2020 2020 7265 7475  t__.        retu
+00002930: 726e 2073 656c 662e 7072 6f63 6573 7320  rn self.process 
+00002940: 2d20 7365 6c66 2e6d 616e 6167 6564 202d  - self.managed -
+00002950: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
+00002960: 6f6c 640a 0a20 2020 2040 7072 6f70 6572  old..    @proper
+00002970: 7479 0a20 2020 2064 6566 206f 7074 696d  ty.    def optim
+00002980: 6973 7469 6328 7365 6c66 2920 2d3e 2069  istic(self) -> i
+00002990: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
+000029a0: 726e 2073 656c 662e 6d61 6e61 6765 6420  rn self.managed 
+000029b0: 2b20 7365 6c66 2e75 6e6d 616e 6167 6564  + self.unmanaged
+000029c0: 5f6f 6c64 0a0a 2020 2020 4070 726f 7065  _old..    @prope
+000029d0: 7274 790a 2020 2020 6465 6620 6d61 6e61  rty.    def mana
+000029e0: 6765 645f 696e 5f6d 656d 6f72 7928 7365  ged_in_memory(se
+000029f0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+00002a00: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00002a10: 6e28 226d 616e 6167 6564 5f69 6e5f 6d65  n("managed_in_me
+00002a20: 6d6f 7279 2068 6173 2062 6565 6e20 7265  mory has been re
+00002a30: 6e61 6d65 6420 746f 206d 616e 6167 6564  named to managed
+00002a40: 222c 2046 7574 7572 6557 6172 6e69 6e67  ", FutureWarning
+00002a50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00002a60: 2073 656c 662e 6d61 6e61 6765 640a 0a20   self.managed.. 
+00002a70: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00002a80: 2064 6566 206d 616e 6167 6564 5f73 7069   def managed_spi
+00002a90: 6c6c 6564 2873 656c 6629 202d 3e20 696e  lled(self) -> in
+00002aa0: 743a 0a20 2020 2020 2020 2077 6172 6e69  t:.        warni
+00002ab0: 6e67 732e 7761 726e 2822 6d61 6e61 6765  ngs.warn("manage
+00002ac0: 645f 7370 696c 6c65 6420 6861 7320 6265  d_spilled has be
+00002ad0: 656e 2072 656e 616d 6564 2074 6f20 7370  en renamed to sp
+00002ae0: 696c 6c65 6422 2c20 4675 7475 7265 5761  illed", FutureWa
+00002af0: 726e 696e 6729 0a20 2020 2020 2020 2072  rning).        r
+00002b00: 6574 7572 6e20 7365 6c66 2e73 7069 6c6c  eturn self.spill
+00002b10: 6564 0a0a 2020 2020 6465 6620 5f5f 7265  ed..    def __re
+00002b20: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
+00002b30: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+00002b40: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00002b50: 6622 5072 6f63 6573 7320 6d65 6d6f 7279  f"Process memory
+00002b60: 2028 5253 5329 2020 3a20 7b66 6f72 6d61   (RSS)  : {forma
+00002b70: 745f 6279 7465 7328 7365 6c66 2e70 726f  t_bytes(self.pro
+00002b80: 6365 7373 297d 5c6e 220a 2020 2020 2020  cess)}\n".      
+00002b90: 2020 2020 2020 6622 2020 2d20 6d61 6e61        f"  - mana
+00002ba0: 6765 6420 6279 2044 6173 6b20 2020 3a20  ged by Dask   : 
+00002bb0: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
+00002bc0: 6c66 2e6d 616e 6167 6564 297d 5c6e 220a  lf.managed)}\n".
+00002bd0: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
+00002be0: 2d20 756e 6d61 6e61 6765 6420 286f 6c64  - unmanaged (old
+00002bf0: 2920 2020 3a20 7b66 6f72 6d61 745f 6279  )   : {format_by
+00002c00: 7465 7328 7365 6c66 2e75 6e6d 616e 6167  tes(self.unmanag
+00002c10: 6564 5f6f 6c64 297d 5c6e 220a 2020 2020  ed_old)}\n".    
+00002c20: 2020 2020 2020 2020 6622 2020 2d20 756e          f"  - un
+00002c30: 6d61 6e61 6765 6420 2872 6563 656e 7429  managed (recent)
+00002c40: 3a20 7b66 6f72 6d61 745f 6279 7465 7328  : {format_bytes(
+00002c50: 7365 6c66 2e75 6e6d 616e 6167 6564 5f72  self.unmanaged_r
+00002c60: 6563 656e 7429 7d5c 6e22 0a20 2020 2020  ecent)}\n".     
+00002c70: 2020 2020 2020 2066 2253 7069 6c6c 6564         f"Spilled
+00002c80: 2074 6f20 6469 736b 2020 2020 2020 203a   to disk       :
+00002c90: 207b 666f 726d 6174 5f62 7974 6573 2873   {format_bytes(s
+00002ca0: 656c 662e 7370 696c 6c65 6429 7d5c 6e22  elf.spilled)}\n"
+00002cb0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00002cc0: 6465 6620 5f74 6f5f 6469 6374 2873 656c  def _to_dict(sel
+00002cd0: 662c 202a 2c20 6578 636c 7564 653a 2043  f, *, exclude: C
+00002ce0: 6f6e 7461 696e 6572 5b73 7472 5d20 3d20  ontainer[str] = 
+00002cf0: 2829 2920 2d3e 2064 6963 743a 0a20 2020  ()) -> dict:.   
+00002d00: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
+00002d10: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
+00002d20: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
+00002d30: 7075 7270 6f73 6573 2e0a 0a20 2020 2020  purposes...     
+00002d40: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+00002d50: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00002d60: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
+00002d70: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
+00002d80: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
+00002d90: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
+00002da0: 7665 5f74 6f5f 6469 6374 0a20 2020 2020  ve_to_dict.     
+00002db0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00002dc0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+00002dd0: 2020 2020 6b3a 2067 6574 6174 7472 2873      k: getattr(s
+00002de0: 656c 662c 206b 290a 2020 2020 2020 2020  elf, k).        
+00002df0: 2020 2020 666f 7220 6b20 696e 2064 6972      for k in dir
+00002e00: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
+00002e10: 2020 2069 6620 6e6f 7420 6b2e 7374 6172     if not k.star
+00002e20: 7473 7769 7468 2822 5f22 290a 2020 2020  tswith("_").    
+00002e30: 2020 2020 2020 2020 616e 6420 6b20 6e6f          and k no
+00002e40: 7420 696e 207b 2273 756d 222c 2022 6d61  t in {"sum", "ma
+00002e50: 6e61 6765 645f 696e 5f6d 656d 6f72 7922  naged_in_memory"
+00002e60: 2c20 226d 616e 6167 6564 5f73 7069 6c6c  , "managed_spill
+00002e70: 6564 227d 0a20 2020 2020 2020 207d 0a0a  ed"}.        }..
+00002e80: 0a63 6c61 7373 2057 6f72 6b65 7253 7461  .class WorkerSta
+00002e90: 7465 3a0a 2020 2020 2222 2241 2073 696d  te:.    """A sim
+00002ea0: 706c 6520 6f62 6a65 6374 2068 6f6c 6469  ple object holdi
+00002eb0: 6e67 2069 6e66 6f72 6d61 7469 6f6e 2061  ng information a
+00002ec0: 626f 7574 2061 2077 6f72 6b65 722e 0a0a  bout a worker...
+00002ed0: 2020 2020 4e6f 7420 746f 2062 6520 636f      Not to be co
+00002ee0: 6e66 7573 6564 2077 6974 6820 3a63 6c61  nfused with :cla
+00002ef0: 7373 3a60 6469 7374 7269 6275 7465 642e  ss:`distributed.
+00002f00: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
+00002f10: 6869 6e65 2e57 6f72 6b65 7253 7461 7465  hine.WorkerState
+00002f20: 602e 0a20 2020 2022 2222 0a0a 2020 2020  `..    """..    
+00002f30: 233a 2054 6869 7320 776f 726b 6572 2773  #: This worker's
+00002f40: 2075 6e69 7175 6520 6b65 792e 2054 6869   unique key. Thi
+00002f50: 7320 6361 6e20 6265 2069 7473 2063 6f6e  s can be its con
+00002f60: 6e65 6374 6564 2061 6464 7265 7373 0a20  nected address. 
+00002f70: 2020 2023 3a20 2873 7563 6820 6173 2060     #: (such as `
+00002f80: 6022 7463 703a 2f2f 3132 372e 302e 302e  `"tcp://127.0.0.
+00002f90: 313a 3838 3931 2260 6029 206f 7220 616e  1:8891"``) or an
+00002fa0: 2061 6c69 6173 2028 7375 6368 2061 7320   alias (such as 
+00002fb0: 6060 2261 6c69 6365 2260 6029 2e0a 2020  ``"alice"``)..  
+00002fc0: 2020 6164 6472 6573 733a 2073 7472 0a0a    address: str..
+00002fd0: 2020 2020 7069 643a 2069 6e74 0a20 2020      pid: int.   
+00002fe0: 206e 616d 653a 2048 6173 6861 626c 650a   name: Hashable.
+00002ff0: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
+00003000: 6572 206f 6620 4350 5520 7468 7265 6164  er of CPU thread
+00003010: 7320 6d61 6465 2061 7661 696c 6162 6c65  s made available
+00003020: 206f 6e20 7468 6973 2077 6f72 6b65 720a   on this worker.
+00003030: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
+00003040: 740a 0a20 2020 2023 3a20 4d65 6d6f 7279  t..    #: Memory
+00003050: 2061 7661 696c 6162 6c65 2074 6f20 7468   available to th
+00003060: 6520 776f 726b 6572 2c20 696e 2062 7974  e worker, in byt
+00003070: 6573 0a20 2020 206d 656d 6f72 795f 6c69  es.    memory_li
+00003080: 6d69 743a 2069 6e74 0a0a 2020 2020 6c6f  mit: int..    lo
+00003090: 6361 6c5f 6469 7265 6374 6f72 793a 2073  cal_directory: s
+000030a0: 7472 0a20 2020 2073 6572 7669 6365 733a  tr.    services:
+000030b0: 2064 6963 745b 7374 722c 2069 6e74 5d0a   dict[str, int].
+000030c0: 0a20 2020 2023 3a20 4f75 7470 7574 206f  .    #: Output o
+000030d0: 6620 3a6d 6574 683a 6064 6973 7472 6962  f :meth:`distrib
+000030e0: 7574 6564 2e76 6572 7369 6f6e 732e 6765  uted.versions.ge
+000030f0: 745f 7665 7273 696f 6e73 6020 6f6e 2074  t_versions` on t
+00003100: 6865 2077 6f72 6b65 720a 2020 2020 7665  he worker.    ve
+00003110: 7273 696f 6e73 3a20 6469 6374 5b73 7472  rsions: dict[str
+00003120: 2c20 416e 795d 0a0a 2020 2020 233a 2041  , Any]..    #: A
+00003130: 6464 7265 7373 206f 6620 7468 6520 6173  ddress of the as
+00003140: 736f 6369 6174 6564 203a 636c 6173 733a  sociated :class:
+00003150: 607e 6469 7374 7269 6275 7465 642e 6e61  `~distributed.na
+00003160: 6e6e 792e 4e61 6e6e 7960 2c20 6966 2070  nny.Nanny`, if p
+00003170: 7265 7365 6e74 0a20 2020 206e 616e 6e79  resent.    nanny
+00003180: 3a20 7374 720a 0a20 2020 2023 3a20 5265  : str..    #: Re
+00003190: 6164 2d6f 6e6c 7920 776f 726b 6572 2073  ad-only worker s
+000031a0: 7461 7475 732c 2073 796e 6365 6420 6f6e  tatus, synced on
+000031b0: 6520 7761 7920 6672 6f6d 2074 6865 2072  e way from the r
+000031c0: 656d 6f74 6520 576f 726b 6572 206f 626a  emote Worker obj
+000031d0: 6563 740a 2020 2020 7374 6174 7573 3a20  ect.    status: 
+000031e0: 5374 6174 7573 0a0a 2020 2020 233a 2043  Status..    #: C
+000031f0: 6163 6865 6420 6861 7368 206f 6620 3a61  ached hash of :a
+00003200: 7474 723a 607e 576f 726b 6572 5374 6174  ttr:`~WorkerStat
+00003210: 652e 6164 6472 6573 7360 0a20 2020 205f  e.address`.    _
+00003220: 6861 7368 3a20 696e 740a 0a20 2020 2023  hash: int..    #
+00003230: 3a20 5468 6520 746f 7461 6c20 6d65 6d6f  : The total memo
+00003240: 7279 2073 697a 652c 2069 6e20 6279 7465  ry size, in byte
+00003250: 732c 2075 7365 6420 6279 2074 6865 2074  s, used by the t
+00003260: 6173 6b73 2074 6869 7320 776f 726b 6572  asks this worker
+00003270: 2068 6f6c 6473 2069 6e20 6d65 6d6f 7279   holds in memory
+00003280: 0a20 2020 2023 3a20 2869 2e65 2e20 7468  .    #: (i.e. th
+00003290: 6520 7461 736b 7320 696e 2074 6869 7320  e tasks in this 
+000032a0: 776f 726b 6572 2773 203a 6174 7472 3a60  worker's :attr:`
+000032b0: 7e57 6f72 6b65 7253 7461 7465 2e68 6173  ~WorkerState.has
+000032c0: 5f77 6861 7460 292e 0a20 2020 206e 6279  _what`)..    nby
+000032d0: 7465 733a 2069 6e74 0a0a 2020 2020 233a  tes: int..    #:
+000032e0: 2057 6f72 6b65 7220 6d65 6d6f 7279 2075   Worker memory u
+000032f0: 6e6b 6e6f 776e 2074 6f20 7468 6520 776f  nknown to the wo
+00003300: 726b 6572 2c20 696e 2062 7974 6573 2c20  rker, in bytes, 
+00003310: 7768 6963 6820 6861 7320 6265 656e 2074  which has been t
+00003320: 6865 7265 2066 6f72 206d 6f72 6520 7468  here for more th
+00003330: 616e 0a20 2020 2023 3a20 3330 2073 6563  an.    #: 30 sec
+00003340: 6f6e 6473 2e20 5365 6520 3a63 6c61 7373  onds. See :class
+00003350: 3a60 4d65 6d6f 7279 5374 6174 6560 2e0a  :`MemoryState`..
+00003360: 2020 2020 5f6d 656d 6f72 795f 756e 6d61      _memory_unma
+00003370: 6e61 6765 645f 6f6c 643a 2069 6e74 0a0a  naged_old: int..
+00003380: 2020 2020 233a 2048 6973 746f 7279 206f      #: History o
+00003390: 6620 7468 6520 6c61 7374 2033 3020 7365  f the last 30 se
+000033a0: 636f 6e64 7327 2077 6f72 7468 206f 6620  conds' worth of 
+000033b0: 756e 6d61 6e61 6765 6420 6d65 6d6f 7279  unmanaged memory
+000033c0: 2e20 5573 6564 2074 6f20 6469 6666 6572  . Used to differ
+000033d0: 656e 7469 6174 650a 2020 2020 233a 2062  entiate.    #: b
+000033e0: 6574 7765 656e 2022 6f6c 6422 2061 6e64  etween "old" and
+000033f0: 2022 6e65 7722 2075 6e6d 616e 6167 6564   "new" unmanaged
+00003400: 206d 656d 6f72 792e 0a20 2020 2023 3a20   memory..    #: 
+00003410: 466f 726d 6174 3a20 6060 5b28 7469 6d65  Format: ``[(time
+00003420: 7374 616d 702c 2062 7974 6573 292c 2028  stamp, bytes), (
+00003430: 7469 6d65 7374 616d 702c 2062 7974 6573  timestamp, bytes
+00003440: 292c 202e 2e2e 5d60 600a 2020 2020 5f6d  ), ...]``.    _m
+00003450: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00003460: 6869 7374 6f72 793a 2064 6571 7565 5b74  history: deque[t
+00003470: 7570 6c65 5b66 6c6f 6174 2c20 696e 745d  uple[float, int]
+00003480: 5d0a 0a20 2020 206d 6574 7269 6373 3a20  ]..    metrics: 
+00003490: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
+000034a0: 2020 2020 233a 2054 6865 206c 6173 7420      #: The last 
+000034b0: 7469 6d65 2077 6520 7265 6365 6976 6564  time we received
+000034c0: 2061 2068 6561 7274 6265 6174 2066 726f   a heartbeat fro
+000034d0: 6d20 7468 6973 2077 6f72 6b65 722c 2069  m this worker, i
+000034e0: 6e20 6c6f 6361 6c20 7363 6865 6475 6c65  n local schedule
+000034f0: 7220 7469 6d65 2e0a 2020 2020 6c61 7374  r time..    last
+00003500: 5f73 6565 6e3a 2066 6c6f 6174 0a0a 2020  _seen: float..  
+00003510: 2020 7469 6d65 5f64 656c 6179 3a20 666c    time_delay: fl
+00003520: 6f61 740a 2020 2020 6261 6e64 7769 6474  oat.    bandwidt
+00003530: 683a 2066 6c6f 6174 0a0a 2020 2020 233a  h: float..    #:
+00003540: 2041 2073 6574 206f 6620 616c 6c20 5461   A set of all Ta
+00003550: 736b 5374 6174 6573 206f 6e20 7468 6973  skStates on this
+00003560: 2077 6f72 6b65 7220 7468 6174 2061 7265   worker that are
+00003570: 2061 6374 6f72 732e 2054 6869 7320 6f6e   actors. This on
+00003580: 6c79 2069 6e63 6c75 6465 7320 7468 6f73  ly includes thos
+00003590: 650a 2020 2020 233a 2061 6374 6f72 7320  e.    #: actors 
+000035a0: 7768 6f73 6520 7374 6174 6520 6163 7475  whose state actu
+000035b0: 616c 6c79 206c 6976 6573 206f 6e20 7468  ally lives on th
+000035c0: 6973 2077 6f72 6b65 722c 206e 6f74 2061  is worker, not a
+000035d0: 6374 6f72 7320 746f 2077 6869 6368 2074  ctors to which t
+000035e0: 6869 7320 776f 726b 6572 0a20 2020 2023  his worker.    #
+000035f0: 3a20 6861 7320 6120 7265 6665 7265 6e63  : has a referenc
+00003600: 652e 0a20 2020 2061 6374 6f72 733a 2073  e..    actors: s
+00003610: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+00003620: 2020 2023 3a20 556e 6465 726c 7969 6e67     #: Underlying
+00003630: 2064 6174 6120 6f66 203a 6d65 7468 3a60   data of :meth:`
+00003640: 576f 726b 6572 5374 6174 652e 6861 735f  WorkerState.has_
+00003650: 7768 6174 600a 2020 2020 5f68 6173 5f77  what`.    _has_w
+00003660: 6861 743a 2064 6963 745b 5461 736b 5374  hat: dict[TaskSt
+00003670: 6174 652c 204e 6f6e 655d 0a0a 2020 2020  ate, None]..    
+00003680: 233a 2041 2073 6574 206f 6620 7461 736b  #: A set of task
+00003690: 7320 7468 6174 2068 6176 6520 6265 656e  s that have been
+000036a0: 2073 7562 6d69 7474 6564 2074 6f20 7468   submitted to th
+000036b0: 6973 2077 6f72 6b65 722e 204d 756c 7469  is worker. Multi
+000036c0: 706c 6520 7461 736b 7320 6d61 7920 6265  ple tasks may be
+000036d0: 0a20 2020 2023 2073 7562 6d69 7474 6564  .    # submitted
+000036e0: 2074 6f20 6120 776f 726b 6572 2069 6e20   to a worker in 
+000036f0: 6164 7661 6e63 6520 616e 6420 7468 6520  advance and the 
+00003700: 776f 726b 6572 2077 696c 6c20 7275 6e20  worker will run 
+00003710: 7468 656d 2065 7665 6e74 7561 6c6c 792c  them eventually,
+00003720: 0a20 2020 2023 2064 6570 656e 6469 6e67  .    # depending
+00003730: 206f 6e20 6974 7320 6578 6563 7574 696f   on its executio
+00003740: 6e20 7265 736f 7572 6365 7320 2862 7574  n resources (but
+00003750: 2073 6565 203a 646f 633a 6077 6f72 6b2d   see :doc:`work-
+00003760: 7374 6561 6c69 6e67 6029 2e0a 2020 2020  stealing`)..    
+00003770: 233a 0a20 2020 2023 3a20 416c 6c20 7468  #:.    #: All th
+00003780: 6520 7461 736b 7320 6865 7265 2061 7265  e tasks here are
+00003790: 2069 6e20 7468 6520 2270 726f 6365 7373   in the "process
+000037a0: 696e 6722 2073 7461 7465 2e0a 2020 2020  ing" state..    
+000037b0: 233a 2054 6869 7320 6174 7472 6962 7574  #: This attribut
+000037c0: 6520 6973 206b 6570 7420 696e 2073 796e  e is kept in syn
+000037d0: 6320 7769 7468 203a 6174 7472 3a60 5461  c with :attr:`Ta
+000037e0: 736b 5374 6174 652e 7072 6f63 6573 7369  skState.processi
+000037f0: 6e67 5f6f 6e60 2e0a 2020 2020 7072 6f63  ng_on`..    proc
+00003800: 6573 7369 6e67 3a20 7365 745b 5461 736b  essing: set[Task
+00003810: 5374 6174 655d 0a0a 2020 2020 233a 2052  State]..    #: R
+00003820: 756e 6e69 6e67 2074 6173 6b73 2074 6861  unning tasks tha
+00003830: 7420 696e 766f 6b65 6420 3a66 756e 633a  t invoked :func:
+00003840: 6064 6973 7472 6962 7574 6564 2e73 6563  `distributed.sec
+00003850: 6564 6560 0a20 2020 206c 6f6e 675f 7275  ede`.    long_ru
+00003860: 6e6e 696e 673a 2073 6574 5b54 6173 6b53  nning: set[TaskS
+00003870: 7461 7465 5d0a 0a20 2020 2023 3a20 4120  tate]..    #: A 
+00003880: 6469 6374 696f 6e61 7279 206f 6620 7461  dictionary of ta
+00003890: 736b 7320 7468 6174 2061 7265 2063 7572  sks that are cur
+000038a0: 7265 6e74 6c79 2062 6569 6e67 2072 756e  rently being run
+000038b0: 206f 6e20 7468 6973 2077 6f72 6b65 722e   on this worker.
+000038c0: 0a20 2020 2023 3a20 4561 6368 2074 6173  .    #: Each tas
+000038d0: 6b20 7374 6174 6520 6973 2061 7373 6f63  k state is assoc
+000038e0: 6961 7465 6420 7769 7468 2074 6865 2064  iated with the d
+000038f0: 7572 6174 696f 6e20 696e 2073 6563 6f6e  uration in secon
+00003900: 6473 2077 6869 6368 2074 6865 2074 6173  ds which the tas
+00003910: 6b20 6861 730a 2020 2020 233a 2062 6565  k has.    #: bee
+00003920: 6e20 7275 6e6e 696e 672e 0a20 2020 2065  n running..    e
+00003930: 7865 6375 7469 6e67 3a20 6469 6374 5b54  xecuting: dict[T
+00003940: 6173 6b53 7461 7465 2c20 666c 6f61 745d  askState, float]
+00003950: 0a0a 2020 2020 233a 2054 6865 2061 7661  ..    #: The ava
+00003960: 696c 6162 6c65 2072 6573 6f75 7263 6573  ilable resources
+00003970: 206f 6e20 7468 6973 2077 6f72 6b65 722c   on this worker,
+00003980: 2065 2e67 2e20 6060 7b22 4750 5522 3a20   e.g. ``{"GPU": 
+00003990: 327d 6060 2e0a 2020 2020 233a 2054 6865  2}``..    #: The
+000039a0: 7365 2061 7265 2061 6273 7472 6163 7420  se are abstract 
+000039b0: 7175 616e 7469 7469 6573 2074 6861 7420  quantities that 
+000039c0: 636f 6e73 7472 6169 6e20 6365 7274 6169  constrain certai
+000039d0: 6e20 7461 736b 7320 6672 6f6d 2072 756e  n tasks from run
+000039e0: 6e69 6e67 2061 7420 7468 650a 2020 2020  ning at the.    
+000039f0: 233a 2073 616d 6520 7469 6d65 206f 6e20  #: same time on 
+00003a00: 7468 6973 2077 6f72 6b65 722e 0a20 2020  this worker..   
+00003a10: 2072 6573 6f75 7263 6573 3a20 6469 6374   resources: dict
+00003a20: 5b73 7472 2c20 666c 6f61 745d 0a0a 2020  [str, float]..  
+00003a30: 2020 233a 2054 6865 2073 756d 206f 6620    #: The sum of 
+00003a40: 6561 6368 2072 6573 6f75 7263 6520 7573  each resource us
+00003a50: 6564 2062 7920 616c 6c20 7461 736b 7320  ed by all tasks 
+00003a60: 616c 6c6f 6361 7465 6420 746f 2074 6869  allocated to thi
+00003a70: 7320 776f 726b 6572 2e0a 2020 2020 233a  s worker..    #:
+00003a80: 2054 6865 206e 756d 6265 7273 2069 6e20   The numbers in 
+00003a90: 7468 6973 2064 6963 7469 6f6e 6172 7920  this dictionary 
+00003aa0: 6361 6e20 6f6e 6c79 2062 6520 6c65 7373  can only be less
+00003ab0: 206f 7220 6571 7561 6c20 7468 616e 2074   or equal than t
+00003ac0: 686f 7365 2069 6e20 7468 6973 0a20 2020  hose in this.   
+00003ad0: 2023 3a20 776f 726b 6572 2773 203a 6174   #: worker's :at
+00003ae0: 7472 3a60 7e57 6f72 6b65 7253 7461 7465  tr:`~WorkerState
+00003af0: 2e72 6573 6f75 7263 6573 602e 0a20 2020  .resources`..   
+00003b00: 2075 7365 645f 7265 736f 7572 6365 733a   used_resources:
+00003b10: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
+00003b20: 5d0a 0a20 2020 2023 3a20 4172 6269 7472  ]..    #: Arbitr
+00003b30: 6172 7920 6164 6469 7469 6f6e 616c 206d  ary additional m
+00003b40: 6574 6164 6174 6120 746f 2062 6520 6164  etadata to be ad
+00003b50: 6465 6420 746f 203a 6d65 7468 3a60 7e57  ded to :meth:`~W
+00003b60: 6f72 6b65 7253 7461 7465 2e69 6465 6e74  orkerState.ident
+00003b70: 6974 7960 0a20 2020 2065 7874 7261 3a20  ity`.    extra: 
+00003b80: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
+00003b90: 2020 2020 2320 5468 6520 756e 6971 7565      # The unique
+00003ba0: 2073 6572 7665 7220 4944 2074 6869 7320   server ID this 
+00003bb0: 576f 726b 6572 5374 6174 6520 6973 2072  WorkerState is r
+00003bc0: 6566 6572 656e 6369 6e67 0a20 2020 2073  eferencing.    s
+00003bd0: 6572 7665 725f 6964 3a20 7374 720a 0a20  erver_id: str.. 
+00003be0: 2020 2023 2052 6566 6572 656e 6365 2074     # Reference t
+00003bf0: 6f20 7363 6865 6475 6c65 7220 7461 736b  o scheduler task
+00003c00: 5f67 726f 7570 730a 2020 2020 7363 6865  _groups.    sche
+00003c10: 6475 6c65 725f 7265 663a 2077 6561 6b72  duler_ref: weakr
+00003c20: 6566 2e72 6566 5b53 6368 6564 756c 6572  ef.ref[Scheduler
+00003c30: 5374 6174 655d 207c 204e 6f6e 650a 2020  State] | None.  
+00003c40: 2020 7461 736b 5f70 7265 6669 785f 636f    task_prefix_co
+00003c50: 756e 743a 2064 6566 6175 6c74 6469 6374  unt: defaultdict
+00003c60: 5b73 7472 2c20 696e 745d 0a20 2020 205f  [str, int].    _
+00003c70: 6e65 7477 6f72 6b5f 6f63 633a 2066 6c6f  network_occ: flo
+00003c80: 6174 0a20 2020 205f 6f63 6375 7061 6e63  at.    _occupanc
+00003c90: 795f 6361 6368 653a 2066 6c6f 6174 207c  y_cache: float |
+00003ca0: 204e 6f6e 650a 0a20 2020 2023 3a20 4b65   None..    #: Ke
+00003cb0: 7973 2074 6861 7420 6d61 7920 6e65 6564  ys that may need
+00003cc0: 2074 6f20 6265 2066 6574 6368 6564 2074   to be fetched t
+00003cd0: 6f20 7468 6973 2077 6f72 6b65 722c 2061  o this worker, a
+00003ce0: 6e64 2074 6865 206e 756d 6265 7220 6f66  nd the number of
+00003cf0: 2074 6173 6b73 2074 6861 7420 6e65 6564   tasks that need
+00003d00: 2074 6865 6d2e 0a20 2020 2023 3a20 416c   them..    #: Al
+00003d10: 6c20 7461 736b 7320 6172 6520 6375 7272  l tasks are curr
+00003d20: 656e 746c 7920 696e 2060 6d65 6d6f 7279  ently in `memory
+00003d30: 6020 6f6e 2061 2077 6f72 6b65 7220 6f74  ` on a worker ot
+00003d40: 6865 7220 7468 616e 2074 6869 7320 6f6e  her than this on
+00003d50: 652e 0a20 2020 2023 3a20 4d75 6368 206c  e..    #: Much l
+00003d60: 696b 6520 6070 726f 6365 7373 696e 6760  ike `processing`
+00003d70: 2c20 7468 6973 2064 6f65 7320 6e6f 7420  , this does not 
+00003d80: 6578 6163 746c 7920 7265 666c 6563 7420  exactly reflect 
+00003d90: 776f 726b 6572 2073 7461 7465 3a0a 2020  worker state:.  
+00003da0: 2020 233a 206b 6579 7320 6865 7265 206d    #: keys here m
+00003db0: 6179 2062 6520 7175 6575 6564 2074 6f20  ay be queued to 
+00003dc0: 6665 7463 682c 2069 6e20 666c 6967 6874  fetch, in flight
+00003dd0: 2c20 6f72 2061 6c72 6561 6479 2069 6e20  , or already in 
+00003de0: 6d65 6d6f 7279 0a20 2020 2023 3a20 6f6e  memory.    #: on
+00003df0: 2074 6865 2077 6f72 6b65 722e 0a20 2020   the worker..   
+00003e00: 206e 6565 6473 5f77 6861 743a 2064 6963   needs_what: dic
+00003e10: 745b 5461 736b 5374 6174 652c 2069 6e74  t[TaskState, int
+00003e20: 5d0a 0a20 2020 205f 5f73 6c6f 7473 5f5f  ]..    __slots__
+00003e30: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+00003e40: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
+00003e50: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00003e60: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00003e70: 2020 202a 2c0a 2020 2020 2020 2020 6164     *,.        ad
+00003e80: 6472 6573 733a 2073 7472 2c0a 2020 2020  dress: str,.    
+00003e90: 2020 2020 7374 6174 7573 3a20 5374 6174      status: Stat
+00003ea0: 7573 2c0a 2020 2020 2020 2020 7069 643a  us,.        pid:
+00003eb0: 2069 6e74 2c0a 2020 2020 2020 2020 6e61   int,.        na
+00003ec0: 6d65 3a20 6f62 6a65 6374 2c0a 2020 2020  me: object,.    
+00003ed0: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
+00003ee0: 7420 3d20 302c 0a20 2020 2020 2020 206d  t = 0,.        m
+00003ef0: 656d 6f72 795f 6c69 6d69 743a 2069 6e74  emory_limit: int
+00003f00: 2c0a 2020 2020 2020 2020 6c6f 6361 6c5f  ,.        local_
+00003f10: 6469 7265 6374 6f72 793a 2073 7472 2c0a  directory: str,.
+00003f20: 2020 2020 2020 2020 6e61 6e6e 793a 2073          nanny: s
+00003f30: 7472 2c0a 2020 2020 2020 2020 7365 7276  tr,.        serv
+00003f40: 6572 5f69 643a 2073 7472 2c0a 2020 2020  er_id: str,.    
+00003f50: 2020 2020 7365 7276 6963 6573 3a20 6469      services: di
+00003f60: 6374 5b73 7472 2c20 696e 745d 207c 204e  ct[str, int] | N
+00003f70: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00003f80: 2020 2020 7665 7273 696f 6e73 3a20 6469      versions: di
+00003f90: 6374 5b73 7472 2c20 416e 795d 207c 204e  ct[str, Any] | N
+00003fa0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00003fb0: 2020 2020 6578 7472 613a 2064 6963 745b      extra: dict[
+00003fc0: 7374 722c 2041 6e79 5d20 7c20 4e6f 6e65  str, Any] | None
+00003fd0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00003fe0: 2073 6368 6564 756c 6572 3a20 5363 6865   scheduler: Sche
+00003ff0: 6475 6c65 7253 7461 7465 207c 204e 6f6e  dulerState | Non
+00004000: 6520 3d20 4e6f 6e65 2c0a 2020 2020 293a  e = None,.    ):
+00004010: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00004020: 7276 6572 5f69 6420 3d20 7365 7276 6572  rver_id = server
+00004030: 5f69 640a 2020 2020 2020 2020 7365 6c66  _id.        self
+00004040: 2e61 6464 7265 7373 203d 2061 6464 7265  .address = addre
+00004050: 7373 0a20 2020 2020 2020 2073 656c 662e  ss.        self.
+00004060: 7069 6420 3d20 7069 640a 2020 2020 2020  pid = pid.      
+00004070: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
+00004080: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
+00004090: 6e74 6872 6561 6473 203d 206e 7468 7265  nthreads = nthre
+000040a0: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
+000040b0: 2e6d 656d 6f72 795f 6c69 6d69 7420 3d20  .memory_limit = 
+000040c0: 6d65 6d6f 7279 5f6c 696d 6974 0a20 2020  memory_limit.   
+000040d0: 2020 2020 2073 656c 662e 6c6f 6361 6c5f       self.local_
+000040e0: 6469 7265 6374 6f72 7920 3d20 6c6f 6361  directory = loca
+000040f0: 6c5f 6469 7265 6374 6f72 790a 2020 2020  l_directory.    
+00004100: 2020 2020 7365 6c66 2e73 6572 7669 6365      self.service
+00004110: 7320 3d20 7365 7276 6963 6573 206f 7220  s = services or 
+00004120: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00004130: 7665 7273 696f 6e73 203d 2076 6572 7369  versions = versi
+00004140: 6f6e 7320 6f72 207b 7d0a 2020 2020 2020  ons or {}.      
+00004150: 2020 7365 6c66 2e6e 616e 6e79 203d 206e    self.nanny = n
+00004160: 616e 6e79 0a20 2020 2020 2020 2073 656c  anny.        sel
+00004170: 662e 7374 6174 7573 203d 2073 7461 7475  f.status = statu
+00004180: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
+00004190: 6861 7368 203d 2068 6173 6828 7365 6c66  hash = hash(self
+000041a0: 2e73 6572 7665 725f 6964 290a 2020 2020  .server_id).    
+000041b0: 2020 2020 7365 6c66 2e6e 6279 7465 7320      self.nbytes 
+000041c0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+000041d0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
+000041e0: 6564 5f6f 6c64 203d 2030 0a20 2020 2020  ed_old = 0.     
+000041f0: 2020 2073 656c 662e 5f6d 656d 6f72 795f     self._memory_
+00004200: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
+00004210: 7920 3d20 6465 7175 6528 290a 2020 2020  y = deque().    
+00004220: 2020 2020 7365 6c66 2e6d 6574 7269 6373      self.metrics
+00004230: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00004240: 6c66 2e6c 6173 745f 7365 656e 203d 2030  lf.last_seen = 0
+00004250: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
+00004260: 6d65 5f64 656c 6179 203d 2030 0a20 2020  me_delay = 0.   
+00004270: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+00004280: 6474 6820 3d20 7061 7273 655f 6279 7465  dth = parse_byte
+00004290: 7328 6461 736b 2e63 6f6e 6669 672e 6765  s(dask.config.ge
+000042a0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+000042b0: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
+000042c0: 7468 2229 290a 2020 2020 2020 2020 7365  th")).        se
+000042d0: 6c66 2e61 6374 6f72 7320 3d20 7365 7428  lf.actors = set(
+000042e0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+000042f0: 6861 735f 7768 6174 203d 207b 7d0a 2020  has_what = {}.  
+00004300: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
+00004310: 7373 696e 6720 3d20 7365 7428 290a 2020  ssing = set().  
+00004320: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
+00004330: 7275 6e6e 696e 6720 3d20 7365 7428 290a  running = set().
+00004340: 2020 2020 2020 2020 7365 6c66 2e65 7865          self.exe
+00004350: 6375 7469 6e67 203d 207b 7d0a 2020 2020  cuting = {}.    
+00004360: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
+00004370: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
+00004380: 7365 6c66 2e75 7365 645f 7265 736f 7572  self.used_resour
+00004390: 6365 7320 3d20 7b7d 0a20 2020 2020 2020  ces = {}.       
+000043a0: 2073 656c 662e 6578 7472 6120 3d20 6578   self.extra = ex
+000043b0: 7472 6120 6f72 207b 7d0a 2020 2020 2020  tra or {}.      
+000043c0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+000043d0: 5f72 6566 203d 2077 6561 6b72 6566 2e72  _ref = weakref.r
+000043e0: 6566 2873 6368 6564 756c 6572 2920 6966  ef(scheduler) if
+000043f0: 2073 6368 6564 756c 6572 2065 6c73 6520   scheduler else 
+00004400: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00004410: 662e 7461 736b 5f70 7265 6669 785f 636f  f.task_prefix_co
+00004420: 756e 7420 3d20 6465 6661 756c 7464 6963  unt = defaultdic
+00004430: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
+00004440: 656c 662e 6e65 6564 735f 7768 6174 203d  elf.needs_what =
+00004450: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+00004460: 2e5f 6e65 7477 6f72 6b5f 6f63 6320 3d20  ._network_occ = 
+00004470: 300a 2020 2020 2020 2020 7365 6c66 2e5f  0.        self._
+00004480: 6f63 6375 7061 6e63 795f 6361 6368 6520  occupancy_cache 
+00004490: 3d20 4e6f 6e65 0a0a 2020 2020 6465 6620  = None..    def 
+000044a0: 5f5f 6861 7368 5f5f 2873 656c 6629 202d  __hash__(self) -
+000044b0: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
+000044c0: 6574 7572 6e20 7365 6c66 2e5f 6861 7368  eturn self._hash
+000044d0: 0a0a 2020 2020 6465 6620 5f5f 6571 5f5f  ..    def __eq__
+000044e0: 2873 656c 662c 206f 7468 6572 3a20 6f62  (self, other: ob
+000044f0: 6a65 6374 2920 2d3e 2062 6f6f 6c3a 0a20  ject) -> bool:. 
+00004500: 2020 2020 2020 2072 6574 7572 6e20 6973         return is
+00004510: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+00004520: 576f 726b 6572 5374 6174 6529 2061 6e64  WorkerState) and
+00004530: 206f 7468 6572 2e73 6572 7665 725f 6964   other.server_id
+00004540: 203d 3d20 7365 6c66 2e73 6572 7665 725f   == self.server_
+00004550: 6964 0a0a 2020 2020 4070 726f 7065 7274  id..    @propert
+00004560: 790a 2020 2020 6465 6620 6861 735f 7768  y.    def has_wh
+00004570: 6174 2873 656c 6629 202d 3e20 5365 745b  at(self) -> Set[
+00004580: 5461 736b 5374 6174 655d 3a0a 2020 2020  TaskState]:.    
+00004590: 2020 2020 2222 2241 6e20 696e 7365 7274      """An insert
+000045a0: 696f 6e2d 736f 7274 6564 2073 6574 2d6c  ion-sorted set-l
+000045b0: 696b 6520 6f66 2074 6173 6b73 2077 6869  ike of tasks whi
+000045c0: 6368 2063 7572 7265 6e74 6c79 2072 6573  ch currently res
+000045d0: 6964 6520 6f6e 2074 6869 7320 776f 726b  ide on this work
+000045e0: 6572 2e0a 2020 2020 2020 2020 416c 6c20  er..        All 
+000045f0: 7468 6520 7461 736b 7320 6865 7265 2061  the tasks here a
+00004600: 7265 2069 6e20 7468 6520 226d 656d 6f72  re in the "memor
+00004610: 7922 2073 7461 7465 2e0a 2020 2020 2020  y" state..      
+00004620: 2020 5468 6973 2069 7320 7468 6520 7265    This is the re
+00004630: 7665 7273 6520 6d61 7070 696e 6720 6f66  verse mapping of
+00004640: 203a 6174 7472 3a60 5461 736b 5374 6174   :attr:`TaskStat
+00004650: 652e 7768 6f5f 6861 7360 2e0a 0a20 2020  e.who_has`...   
+00004660: 2020 2020 2054 6869 7320 6973 2061 2072       This is a r
+00004670: 6561 642d 6f6e 6c79 2070 7562 6c69 6320  ead-only public 
+00004680: 6163 6365 7373 6f72 2e20 5468 6520 6461  accessor. The da
+00004690: 7461 2069 7320 696d 706c 656d 656e 7465  ta is implemente
+000046a0: 6420 6173 2061 2064 6963 7420 7769 7468  d as a dict with
+000046b0: 6f75 740a 2020 2020 2020 2020 7661 6c75  out.        valu
+000046c0: 6573 2c20 6265 6361 7573 6520 7265 6261  es, because reba
+000046d0: 6c61 6e63 6528 2920 7265 6c69 6573 206f  lance() relies o
+000046e0: 6e20 6469 6374 7320 6265 696e 6720 696e  n dicts being in
+000046f0: 7365 7274 696f 6e2d 736f 7274 6564 2e0a  sertion-sorted..
+00004700: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00004710: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00004720: 5f68 6173 5f77 6861 742e 6b65 7973 2829  _has_what.keys()
+00004730: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00004740: 2020 2020 6465 6620 686f 7374 2873 656c      def host(sel
+00004750: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+00004760: 2020 2072 6574 7572 6e20 6765 745f 6164     return get_ad
+00004770: 6472 6573 735f 686f 7374 2873 656c 662e  dress_host(self.
+00004780: 6164 6472 6573 7329 0a0a 2020 2020 4070  address)..    @p
+00004790: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+000047a0: 6d65 6d6f 7279 2873 656c 6629 202d 3e20  memory(self) -> 
+000047b0: 4d65 6d6f 7279 5374 6174 653a 0a20 2020  MemoryState:.   
+000047c0: 2020 2020 2022 2222 506f 6c69 7368 6564       """Polished
+000047d0: 206d 656d 6f72 7920 6d65 7472 6963 7320   memory metrics 
+000047e0: 666f 7220 7468 6520 776f 726b 6572 2e0a  for the worker..
+000047f0: 0a20 2020 2020 2020 202a 2a44 6573 6967  .        **Desig
+00004800: 6e20 6e6f 7465 206f 6e20 6d61 6e61 6765  n note on manage
+00004810: 6420 6d65 6d6f 7279 2a2a 0a0a 2020 2020  d memory**..    
+00004820: 2020 2020 5468 6572 6520 6172 6520 7477      There are tw
+00004830: 6f20 6d65 6173 7572 6573 2061 7661 696c  o measures avail
+00004840: 6162 6c65 2066 6f72 206d 616e 6167 6564  able for managed
+00004850: 206d 656d 6f72 793a 0a0a 2020 2020 2020   memory:..      
+00004860: 2020 2d20 6060 7365 6c66 2e6e 6279 7465    - ``self.nbyte
+00004870: 7360 600a 2020 2020 2020 2020 2d20 6060  s``.        - ``
+00004880: 7365 6c66 2e6d 6574 7269 6373 5b22 6d61  self.metrics["ma
+00004890: 6e61 6765 645f 6279 7465 7322 5d60 600a  naged_bytes"]``.
+000048a0: 0a20 2020 2020 2020 2041 7420 7265 7374  .        At rest
+000048b0: 2c20 7468 6520 7477 6f20 6e75 6d62 6572  , the two number
+000048c0: 7320 6d75 7374 2062 6520 6964 656e 7469  s must be identi
+000048d0: 6361 6c2e 2048 6f77 6576 6572 2c20 6060  cal. However, ``
+000048e0: 7365 6c66 2e6e 6279 7465 7360 6020 6973  self.nbytes`` is
+000048f0: 0a20 2020 2020 2020 2069 6d6d 6564 6961  .        immedia
+00004900: 7465 6c79 2075 7064 6174 6564 2074 6872  tely updated thr
+00004910: 6f75 6768 2074 6865 2062 6174 6368 6564  ough the batched
+00004920: 2063 6f6d 6d73 2061 7320 736f 6f6e 2061   comms as soon a
+00004930: 7320 6561 6368 2074 6173 6b20 6c61 6e64  s each task land
+00004940: 7320 696e 0a20 2020 2020 2020 206d 656d  s in.        mem
+00004950: 6f72 7920 6f6e 2074 6865 2077 6f72 6b65  ory on the worke
+00004960: 723b 2060 6073 656c 662e 6d65 7472 6963  r; ``self.metric
+00004970: 735b 226d 616e 6167 6564 5f62 7974 6573  s["managed_bytes
+00004980: 225d 6060 2069 6e73 7465 6164 2069 7320  "]`` instead is 
+00004990: 7570 6461 7465 6420 6279 0a20 2020 2020  updated by.     
+000049a0: 2020 2074 6865 2068 6561 7274 6265 6174     the heartbeat
+000049b0: 2c20 7768 6963 6820 6361 6e20 6c61 6720  , which can lag 
+000049c0: 7365 7665 7261 6c20 7365 636f 6e64 7320  several seconds 
+000049d0: 6265 6869 6e64 2e0a 0a20 2020 2020 2020  behind...       
+000049e0: 2042 656c 6f77 2077 6520 6172 6520 6d69   Below we are mi
+000049f0: 7869 6e67 206c 696b 656c 7920 6e65 7765  xing likely newe
+00004a00: 7220 6d61 6e61 6765 6420 6d65 6d6f 7279  r managed memory
+00004a10: 2069 6e66 6f20 6672 6f6d 2060 6073 656c   info from ``sel
+00004a20: 662e 6e62 7974 6573 6060 2077 6974 680a  f.nbytes`` with.
+00004a30: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+00004a40: 616e 6420 7370 696c 6c65 6420 6d65 6d6f  and spilled memo
+00004a50: 7279 2066 726f 6d20 7468 6520 6865 6172  ry from the hear
+00004a60: 7462 6561 742e 2054 6869 7320 6973 2064  tbeat. This is d
+00004a70: 656c 6962 6572 6174 652c 2073 6f20 7468  eliberate, so th
+00004a80: 6174 0a20 2020 2020 2020 206d 616e 6167  at.        manag
+00004a90: 6564 206d 656d 6f72 7920 746f 7461 6c20  ed memory total 
+00004aa0: 6973 2075 7064 6174 6564 206d 6f72 6520  is updated more 
+00004ab0: 6672 6571 7565 6e74 6c79 2e0a 0a20 2020  frequently...   
+00004ac0: 2020 2020 204d 616e 6167 6564 206d 656d       Managed mem
+00004ad0: 6f72 7920 6469 7265 6374 6c79 2061 6e64  ory directly and
+00004ae0: 2069 6d6d 6564 6961 7465 6c79 2063 6f6e   immediately con
+00004af0: 7472 6962 7574 6573 2074 6f20 6f70 7469  tributes to opti
+00004b00: 6d69 7374 6963 206d 656d 6f72 792c 2077  mistic memory, w
+00004b10: 6869 6368 0a20 2020 2020 2020 2069 7320  hich.        is 
+00004b20: 696e 2074 7572 6e20 7573 6564 2069 6e20  in turn used in 
+00004b30: 4163 7469 7665 204d 656d 6f72 7920 4d61  Active Memory Ma
+00004b40: 6e61 6765 7220 6865 7572 6973 7469 6373  nager heuristics
+00004b50: 2028 6174 2074 6865 206d 6f6d 656e 7420   (at the moment 
+00004b60: 6f66 2077 7269 7469 6e67 3b0a 2020 2020  of writing;.    
+00004b70: 2020 2020 6d6f 7265 2075 7365 7320 7769      more uses wi
+00004b80: 6c6c 206c 696b 656c 7920 6265 2061 6464  ll likely be add
+00004b90: 6564 2069 6e20 7468 6520 6675 7475 7265  ed in the future
+00004ba0: 292e 2053 6f20 6974 2773 2069 6d70 6f72  ). So it's impor
+00004bb0: 7461 6e74 2074 6f20 6861 7665 2069 740a  tant to have it.
+00004bc0: 2020 2020 2020 2020 7570 2074 6f20 6461          up to da
+00004bd0: 7465 3b20 6d75 6368 206d 6f72 6520 7468  te; much more th
+00004be0: 616e 2069 7420 6973 2066 6f72 2070 726f  an it is for pro
+00004bf0: 6365 7373 206d 656d 6f72 792e 0a0a 2020  cess memory...  
+00004c00: 2020 2020 2020 4861 7669 6e67 2075 702d        Having up-
+00004c10: 746f 2d64 6174 6520 6d61 6e61 6765 6420  to-date managed 
+00004c20: 6d65 6d6f 7279 2069 6e66 6f20 6173 2073  memory info as s
+00004c30: 6f6f 6e20 6173 2074 6865 2073 6368 6564  oon as the sched
+00004c40: 756c 6572 206c 6561 726e 7320 6162 6f75  uler learns abou
+00004c50: 740a 2020 2020 2020 2020 7461 736b 2063  t.        task c
+00004c60: 6f6d 706c 6574 696f 6e20 616c 736f 2073  ompletion also s
+00004c70: 7562 7374 616e 7469 616c 6c79 2073 696d  ubstantially sim
+00004c80: 706c 6966 6965 7320 756e 6974 2074 6573  plifies unit tes
+00004c90: 7473 2e0a 0a20 2020 2020 2020 2054 6865  ts...        The
+00004ca0: 2066 6c69 7020 7369 6465 206f 6620 7468   flip side of th
+00004cb0: 6973 2064 6573 6967 6e20 6973 2074 6861  is design is tha
+00004cc0: 7420 6974 206d 6179 2063 6175 7365 2073  t it may cause s
+00004cd0: 6f6d 6520 6e6f 6973 6520 696e 2074 6865  ome noise in the
+00004ce0: 0a20 2020 2020 2020 2075 6e6d 616e 6167  .        unmanag
+00004cf0: 6564 5f72 6563 656e 7420 6d65 6173 7572  ed_recent measur
+00004d00: 652e 2065 2e67 2e3a 0a0a 2020 2020 2020  e. e.g.:..      
+00004d10: 2020 312e 2044 656c 6574 6520 3130 304d    1. Delete 100M
+00004d20: 4220 6f66 206d 616e 6167 6564 2064 6174  B of managed dat
+00004d30: 610a 2020 2020 2020 2020 322e 2054 6865  a.        2. The
+00004d40: 2075 7064 6174 6564 206d 616e 6167 6564   updated managed
+00004d50: 206d 656d 6f72 7920 7265 6163 6865 7320   memory reaches 
+00004d60: 7468 6520 7363 6865 6475 6c65 7220 6661  the scheduler fa
+00004d70: 7374 6572 2074 6861 6e20 7468 650a 2020  ster than the.  
+00004d80: 2020 2020 2020 2020 2075 7064 6174 6564           updated
+00004d90: 2070 726f 6365 7373 206d 656d 6f72 790a   process memory.
+00004da0: 2020 2020 2020 2020 332e 2054 6865 7265          3. There
+00004db0: 2773 2061 2062 6c69 7020 7768 6572 6520  's a blip where 
+00004dc0: 7468 6520 7363 6865 6475 6c65 7220 7468  the scheduler th
+00004dd0: 696e 6b73 2074 6861 7420 7468 6572 6527  inks that there'
+00004de0: 7320 6120 7375 6464 656e 2031 3030 4d42  s a sudden 100MB
+00004df0: 0a20 2020 2020 2020 2020 2020 696e 6372  .           incr
+00004e00: 6561 7365 2069 6e20 756e 6d61 6e61 6765  ease in unmanage
+00004e10: 645f 7265 6365 6e74 2c20 7369 6e63 6520  d_recent, since 
+00004e20: 7072 6f63 6573 7320 6d65 6d6f 7279 2068  process memory h
+00004e30: 6173 6e27 7420 6368 616e 6765 6420 6275  asn't changed bu
+00004e40: 7420 6d61 6e61 6765 640a 2020 2020 2020  t managed.      
+00004e50: 2020 2020 206d 656d 6f72 7920 6861 7320       memory has 
+00004e60: 6465 6372 6561 7365 6420 6279 2031 3030  decreased by 100
+00004e70: 4d42 0a20 2020 2020 2020 2034 2e20 5768  MB.        4. Wh
+00004e80: 656e 2074 6865 2068 6561 7274 6265 6174  en the heartbeat
+00004e90: 2061 7272 6976 6573 2c20 7072 6f63 6573   arrives, proces
+00004ea0: 7320 6d65 6d6f 7279 2067 6f65 7320 646f  s memory goes do
+00004eb0: 776e 2061 6e64 2073 6f20 646f 6573 2074  wn and so does t
+00004ec0: 6865 0a20 2020 2020 2020 2020 2020 756e  he.           un
+00004ed0: 6d61 6e61 6765 645f 7265 6365 6e74 2e0a  managed_recent..
+00004ee0: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
+00004ef0: 204f 4b20 2d20 6f6e 6520 6f66 2074 6865   OK - one of the
+00004f00: 206d 6169 6e20 7265 6173 6f6e 7320 666f   main reasons fo
+00004f10: 7220 7468 6520 756e 6d61 6e61 6765 645f  r the unmanaged_
+00004f20: 7265 6365 6e74 202f 2075 6e6d 616e 6167  recent / unmanag
+00004f30: 6564 5f6f 6c64 0a20 2020 2020 2020 2073  ed_old.        s
+00004f40: 706c 6974 2069 7320 6578 6163 746c 7920  plit is exactly 
+00004f50: 746f 2063 6f6e 6365 6e74 7261 7465 2061  to concentrate a
+00004f60: 6c6c 2074 6865 206e 6f69 7365 2069 6e20  ll the noise in 
+00004f70: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
+00004f80: 2061 6e64 2065 7863 6c75 6465 2069 740a   and exclude it.
+00004f90: 2020 2020 2020 2020 6672 6f6d 206f 7074          from opt
+00004fa0: 696d 6973 7469 6320 6d65 6d6f 7279 2c20  imistic memory, 
+00004fb0: 7768 6963 6820 6973 2075 7365 6420 666f  which is used fo
+00004fc0: 7220 6865 7572 6973 7469 6373 2e0a 0a20  r heuristics... 
+00004fd0: 2020 2020 2020 2053 6f6d 6574 6869 6e67         Something
+00004fe0: 2074 6861 7420 6973 206c 6573 7320 4f4b   that is less OK
+00004ff0: 2c20 6275 7420 616c 736f 206c 6573 7320  , but also less 
+00005000: 6672 6571 7565 6e74 2c20 6973 2074 6861  frequent, is tha
+00005010: 7420 7468 6520 7375 6464 656e 2064 656c  t the sudden del
+00005020: 6574 696f 6e0a 2020 2020 2020 2020 6f66  etion.        of
+00005030: 2073 7069 6c6c 6564 206b 6579 7320 7769   spilled keys wi
+00005040: 6c6c 2063 6175 7365 2061 206e 6567 6174  ll cause a negat
+00005050: 6976 6520 626c 6970 2069 6e20 6d61 6e61  ive blip in mana
+00005060: 6765 6420 6d65 6d6f 7279 3a0a 0a20 2020  ged memory:..   
+00005070: 2020 2020 2031 2e20 4465 6c65 7465 2031       1. Delete 1
+00005080: 3030 4d42 206f 6620 7370 696c 6c65 6420  00MB of spilled 
+00005090: 6461 7461 0a20 2020 2020 2020 2032 2e20  data.        2. 
+000050a0: 5468 6520 7570 6461 7465 6420 6d61 6e61  The updated mana
+000050b0: 6765 6420 6d65 6d6f 7279 202a 746f 7461  ged memory *tota
+000050c0: 6c2a 2072 6561 6368 6573 2074 6865 2073  l* reaches the s
+000050d0: 6368 6564 756c 6572 2066 6173 7465 7220  cheduler faster 
+000050e0: 7468 616e 2074 6865 0a20 2020 2020 2020  than the.       
+000050f0: 2020 2020 7570 6461 7465 6420 7370 696c      updated spil
+00005100: 6c65 6420 706f 7274 696f 6e0a 2020 2020  led portion.    
+00005110: 2020 2020 332e 2054 6869 7320 6361 7573      3. This caus
+00005120: 6573 2074 6865 206d 616e 6167 6564 206d  es the managed m
+00005130: 656d 6f72 7920 746f 2074 656d 706f 7261  emory to tempora
+00005140: 7269 6c79 2070 6c75 6d6d 6574 2061 6e64  rily plummet and
+00005150: 2062 6520 7265 706c 6163 6564 2062 790a   be replaced by.
+00005160: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
+00005170: 6167 6564 5f72 6563 656e 742c 2077 6869  aged_recent, whi
+00005180: 6c65 2073 7069 6c6c 6564 206d 656d 6f72  le spilled memor
+00005190: 7920 7265 6d61 696e 7320 756e 616c 7465  y remains unalte
+000051a0: 7265 640a 2020 2020 2020 2020 342e 2057  red.        4. W
+000051b0: 6865 6e20 7468 6520 6865 6172 7462 6561  hen the heartbea
+000051c0: 7420 6172 7269 7665 732c 206d 616e 6167  t arrives, manag
+000051d0: 6564 2067 6f65 7320 6261 636b 2075 702c  ed goes back up,
+000051e0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+000051f0: 740a 2020 2020 2020 2020 2020 2067 6f65  t.           goe
+00005200: 7320 6261 636b 2064 6f77 6e2c 2061 6e64  s back down, and
+00005210: 2073 7069 6c6c 6564 2067 6f65 7320 646f   spilled goes do
+00005220: 776e 2062 7920 3130 304d 4220 6173 2069  wn by 100MB as i
+00005230: 7420 7368 6f75 6c64 2068 6176 6520 746f  t should have to
+00005240: 0a20 2020 2020 2020 2020 2020 6265 6769  .           begi
+00005250: 6e20 7769 7468 2e0a 0a20 2020 2020 2020  n with...       
+00005260: 203a 6973 7375 653a 6036 3030 3260 2077   :issue:`6002` w
+00005270: 696c 6c20 6c65 7420 7573 2073 6f6c 7665  ill let us solve
+00005280: 2074 6869 732e 0a20 2020 2020 2020 2022   this..        "
+00005290: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+000052a0: 6e20 4d65 6d6f 7279 5374 6174 6528 0a20  n MemoryState(. 
+000052b0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+000052c0: 7373 3d73 656c 662e 6d65 7472 6963 735b  ss=self.metrics[
+000052d0: 226d 656d 6f72 7922 5d2c 0a20 2020 2020  "memory"],.     
+000052e0: 2020 2020 2020 206d 616e 6167 6564 3d6d         managed=m
+000052f0: 6178 2830 2c20 7365 6c66 2e6e 6279 7465  ax(0, self.nbyte
+00005300: 7320 2d20 7365 6c66 2e6d 6574 7269 6373  s - self.metrics
+00005310: 5b22 7370 696c 6c65 645f 6279 7465 7322  ["spilled_bytes"
+00005320: 5d5b 226d 656d 6f72 7922 5d29 2c0a 2020  ]["memory"]),.  
+00005330: 2020 2020 2020 2020 2020 7370 696c 6c65            spille
+00005340: 643d 7365 6c66 2e6d 6574 7269 6373 5b22  d=self.metrics["
+00005350: 7370 696c 6c65 645f 6279 7465 7322 5d5b  spilled_bytes"][
+00005360: 2264 6973 6b22 5d2c 0a20 2020 2020 2020  "disk"],.       
+00005370: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
+00005380: 6c64 3d73 656c 662e 5f6d 656d 6f72 795f  ld=self._memory_
+00005390: 756e 6d61 6e61 6765 645f 6f6c 642c 0a20  unmanaged_old,. 
+000053a0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+000053b0: 6620 636c 6561 6e28 7365 6c66 2920 2d3e  f clean(self) ->
+000053c0: 2057 6f72 6b65 7253 7461 7465 3a0a 2020   WorkerState:.  
+000053d0: 2020 2020 2020 2222 2252 6574 7572 6e20        """Return 
+000053e0: 6120 7665 7273 696f 6e20 6f66 2074 6869  a version of thi
+000053f0: 7320 6f62 6a65 6374 2074 6861 7420 6973  s object that is
+00005400: 2061 7070 726f 7072 6961 7465 2066 6f72   appropriate for
+00005410: 2073 6572 6961 6c69 7a61 7469 6f6e 2222   serialization""
+00005420: 220a 2020 2020 2020 2020 7773 203d 2057  ".        ws = W
+00005430: 6f72 6b65 7253 7461 7465 280a 2020 2020  orkerState(.    
+00005440: 2020 2020 2020 2020 6164 6472 6573 733d          address=
+00005450: 7365 6c66 2e61 6464 7265 7373 2c0a 2020  self.address,.  
+00005460: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00005470: 3d73 656c 662e 7374 6174 7573 2c0a 2020  =self.status,.  
+00005480: 2020 2020 2020 2020 2020 7069 643d 7365            pid=se
+00005490: 6c66 2e70 6964 2c0a 2020 2020 2020 2020  lf.pid,.        
+000054a0: 2020 2020 6e61 6d65 3d73 656c 662e 6e61      name=self.na
+000054b0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+000054c0: 6e74 6872 6561 6473 3d73 656c 662e 6e74  nthreads=self.nt
+000054d0: 6872 6561 6473 2c0a 2020 2020 2020 2020  hreads,.        
+000054e0: 2020 2020 6d65 6d6f 7279 5f6c 696d 6974      memory_limit
+000054f0: 3d73 656c 662e 6d65 6d6f 7279 5f6c 696d  =self.memory_lim
+00005500: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+00005510: 6c6f 6361 6c5f 6469 7265 6374 6f72 793d  local_directory=
+00005520: 7365 6c66 2e6c 6f63 616c 5f64 6972 6563  self.local_direc
+00005530: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
+00005540: 2020 7365 7276 6963 6573 3d73 656c 662e    services=self.
+00005550: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
+00005560: 2020 2020 2020 6e61 6e6e 793d 7365 6c66        nanny=self
+00005570: 2e6e 616e 6e79 2c0a 2020 2020 2020 2020  .nanny,.        
+00005580: 2020 2020 6578 7472 613d 7365 6c66 2e65      extra=self.e
+00005590: 7874 7261 2c0a 2020 2020 2020 2020 2020  xtra,.          
+000055a0: 2020 7365 7276 6572 5f69 643d 7365 6c66    server_id=self
+000055b0: 2e73 6572 7665 725f 6964 2c0a 2020 2020  .server_id,.    
+000055c0: 2020 2020 290a 2020 2020 2020 2020 7773      ).        ws
+000055d0: 2e5f 6f63 6375 7061 6e63 795f 6361 6368  ._occupancy_cach
+000055e0: 6520 3d20 7365 6c66 2e6f 6363 7570 616e  e = self.occupan
+000055f0: 6379 0a0a 2020 2020 2020 2020 7773 2e65  cy..        ws.e
+00005600: 7865 6375 7469 6e67 203d 207b 0a20 2020  xecuting = {.   
+00005610: 2020 2020 2020 2020 2074 732e 6b65 793a           ts.key:
+00005620: 2064 7572 6174 696f 6e20 666f 7220 7473   duration for ts
+00005630: 2c20 6475 7261 7469 6f6e 2069 6e20 7365  , duration in se
+00005640: 6c66 2e65 7865 6375 7469 6e67 2e69 7465  lf.executing.ite
+00005650: 6d73 2829 2020 2320 7479 7065 3a20 6967  ms()  # type: ig
+00005660: 6e6f 7265 0a20 2020 2020 2020 207d 0a20  nore.        }. 
+00005670: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+00005680: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+00005690: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+000056a0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+000056b0: 6622 2c20 6e61 6d65 3a20 7b73 656c 662e  f", name: {self.
+000056c0: 6e61 6d65 7d22 2069 6620 7365 6c66 2e6e  name}" if self.n
+000056d0: 616d 6520 213d 2073 656c 662e 6164 6472  ame != self.addr
+000056e0: 6573 7320 656c 7365 2022 220a 2020 2020  ess else "".    
+000056f0: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00005700: 2020 2020 2020 2020 2066 223c 576f 726b           f"<Work
+00005710: 6572 5374 6174 6520 7b73 656c 662e 6164  erState {self.ad
+00005720: 6472 6573 7321 727d 7b6e 616d 657d 2c20  dress!r}{name}, 
+00005730: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00005740: 7374 6174 7573 3a20 7b73 656c 662e 7374  status: {self.st
+00005750: 6174 7573 2e6e 616d 657d 2c20 220a 2020  atus.name}, ".  
+00005760: 2020 2020 2020 2020 2020 6622 6d65 6d6f            f"memo
+00005770: 7279 3a20 7b6c 656e 2873 656c 662e 6861  ry: {len(self.ha
+00005780: 735f 7768 6174 297d 2c20 220a 2020 2020  s_what)}, ".    
+00005790: 2020 2020 2020 2020 6622 7072 6f63 6573          f"proces
+000057a0: 7369 6e67 3a20 7b6c 656e 2873 656c 662e  sing: {len(self.
+000057b0: 7072 6f63 6573 7369 6e67 297d 3e22 0a20  processing)}>". 
+000057c0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+000057d0: 6620 5f72 6570 725f 6874 6d6c 5f28 7365  f _repr_html_(se
+000057e0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+000057f0: 2020 2020 7265 7475 726e 2067 6574 5f74      return get_t
+00005800: 656d 706c 6174 6528 2277 6f72 6b65 725f  emplate("worker_
+00005810: 7374 6174 652e 6874 6d6c 2e6a 3222 292e  state.html.j2").
+00005820: 7265 6e64 6572 280a 2020 2020 2020 2020  render(.        
+00005830: 2020 2020 6164 6472 6573 733d 7365 6c66      address=self
+00005840: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
+00005850: 2020 2020 2020 6e61 6d65 3d73 656c 662e        name=self.
+00005860: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00005870: 2020 7374 6174 7573 3d73 656c 662e 7374    status=self.st
+00005880: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
+00005890: 2020 2020 2020 2068 6173 5f77 6861 743d         has_what=
+000058a0: 7365 6c66 2e68 6173 5f77 6861 742c 0a20  self.has_what,. 
+000058b0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+000058c0: 7373 696e 673d 7365 6c66 2e70 726f 6365  ssing=self.proce
+000058d0: 7373 696e 672c 0a20 2020 2020 2020 2029  ssing,.        )
+000058e0: 0a0a 2020 2020 6465 6620 6964 656e 7469  ..    def identi
+000058f0: 7479 2873 656c 6629 202d 3e20 6469 6374  ty(self) -> dict
+00005900: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+00005910: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+00005920: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
+00005930: 2022 576f 726b 6572 222c 0a20 2020 2020   "Worker",.     
+00005940: 2020 2020 2020 2022 6964 223a 2073 656c         "id": sel
+00005950: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
+00005960: 2020 2020 2268 6f73 7422 3a20 7365 6c66      "host": self
+00005970: 2e68 6f73 742c 0a20 2020 2020 2020 2020  .host,.         
+00005980: 2020 2022 7265 736f 7572 6365 7322 3a20     "resources": 
+00005990: 7365 6c66 2e72 6573 6f75 7263 6573 2c0a  self.resources,.
+000059a0: 2020 2020 2020 2020 2020 2020 226c 6f63              "loc
+000059b0: 616c 5f64 6972 6563 746f 7279 223a 2073  al_directory": s
+000059c0: 656c 662e 6c6f 6361 6c5f 6469 7265 6374  elf.local_direct
+000059d0: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
+000059e0: 2022 6e61 6d65 223a 2073 656c 662e 6e61   "name": self.na
+000059f0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00005a00: 226e 7468 7265 6164 7322 3a20 7365 6c66  "nthreads": self
+00005a10: 2e6e 7468 7265 6164 732c 0a20 2020 2020  .nthreads,.     
+00005a20: 2020 2020 2020 2022 6d65 6d6f 7279 5f6c         "memory_l
+00005a30: 696d 6974 223a 2073 656c 662e 6d65 6d6f  imit": self.memo
+00005a40: 7279 5f6c 696d 6974 2c0a 2020 2020 2020  ry_limit,.      
+00005a50: 2020 2020 2020 226c 6173 745f 7365 656e        "last_seen
+00005a60: 223a 2073 656c 662e 6c61 7374 5f73 6565  ": self.last_see
+00005a70: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
+00005a80: 7365 7276 6963 6573 223a 2073 656c 662e  services": self.
+00005a90: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
+00005aa0: 2020 2020 2020 226d 6574 7269 6373 223a        "metrics":
+00005ab0: 2073 656c 662e 6d65 7472 6963 732c 0a20   self.metrics,. 
+00005ac0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00005ad0: 7573 223a 2073 656c 662e 7374 6174 7573  us": self.status
+00005ae0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+00005af0: 2020 2022 6e61 6e6e 7922 3a20 7365 6c66     "nanny": self
+00005b00: 2e6e 616e 6e79 2c0a 2020 2020 2020 2020  .nanny,.        
+00005b10: 2020 2020 2a2a 7365 6c66 2e65 7874 7261      **self.extra
+00005b20: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+00005b30: 2064 6566 205f 746f 5f64 6963 745f 6e6f   def _to_dict_no
+00005b40: 5f6e 6573 7428 7365 6c66 2c20 2a2c 2065  _nest(self, *, e
+00005b50: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
+00005b60: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
+00005b70: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+00005b80: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
+00005b90: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
+00005ba0: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
+00005bb0: 6e67 2070 7572 706f 7365 732e 0a20 2020  ng purposes..   
+00005bc0: 2020 2020 204e 6f74 2074 7970 6520 7374       Not type st
+00005bd0: 6162 6c65 2061 6e64 206e 6f74 2069 6e74  able and not int
+00005be0: 656e 6465 6420 666f 7220 726f 756e 6474  ended for roundt
+00005bf0: 7269 7073 2e0a 0a20 2020 2020 2020 2053  rips...        S
+00005c00: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+00005c10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00005c20: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
+00005c30: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
+00005c40: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
+00005c50: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
+00005c60: 6f5f 6469 6374 0a20 2020 2020 2020 2054  o_dict.        T
+00005c70: 6173 6b53 7461 7465 2e5f 746f 5f64 6963  askState._to_dic
+00005c80: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+00005c90: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
+00005ca0: 7572 7369 7665 5f74 6f5f 6469 6374 280a  ursive_to_dict(.
+00005cb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005cc0: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
+00005cd0: 636c 7564 653d 7365 7428 6578 636c 7564  clude=set(exclud
+00005ce0: 6529 207c 207b 2276 6572 7369 6f6e 7322  e) | {"versions"
+00005cf0: 7d2c 2020 2320 7479 7065 3a20 6967 6e6f  },  # type: igno
+00005d00: 7265 0a20 2020 2020 2020 2020 2020 206d  re.            m
+00005d10: 656d 6265 7273 3d54 7275 652c 0a20 2020  embers=True,.   
+00005d20: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
+00005d30: 7065 7274 790a 2020 2020 6465 6620 7363  perty.    def sc
+00005d40: 6865 6475 6c65 7228 7365 6c66 2920 2d3e  heduler(self) ->
+00005d50: 2053 6368 6564 756c 6572 5374 6174 653a   SchedulerState:
+00005d60: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00005d70: 7365 6c66 2e73 6368 6564 756c 6572 5f72  self.scheduler_r
+00005d80: 6566 0a20 2020 2020 2020 2073 203d 2073  ef.        s = s
+00005d90: 656c 662e 7363 6865 6475 6c65 725f 7265  elf.scheduler_re
+00005da0: 6628 290a 2020 2020 2020 2020 6173 7365  f().        asse
+00005db0: 7274 2073 0a20 2020 2020 2020 2072 6574  rt s.        ret
+00005dc0: 7572 6e20 730a 0a20 2020 2064 6566 2061  urn s..    def a
+00005dd0: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
+00005de0: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+00005df0: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+00005e00: 2020 2020 2020 2022 2222 4173 7369 676e         """Assign
+00005e10: 2061 2074 6173 6b20 746f 2074 6869 7320   a task to this 
+00005e20: 776f 726b 6572 2066 6f72 2063 6f6d 7075  worker for compu
+00005e30: 7465 2e22 2222 0a20 2020 2020 2020 2069  te.""".        i
+00005e40: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+00005e50: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00005e60: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00005e70: 206e 6f74 2069 6e20 7365 6c66 2e70 726f   not in self.pro
+00005e80: 6365 7373 696e 670a 0a20 2020 2020 2020  cessing..       
+00005e90: 2074 7020 3d20 7473 2e70 7265 6669 780a   tp = ts.prefix.
+00005ea0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+00005eb0: 6b5f 7072 6566 6978 5f63 6f75 6e74 5b74  k_prefix_count[t
+00005ec0: 702e 6e61 6d65 5d20 2b3d 2031 0a20 2020  p.name] += 1.   
+00005ed0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00005ee0: 6c65 722e 5f74 6173 6b5f 7072 6566 6978  ler._task_prefix
+00005ef0: 5f63 6f75 6e74 5f67 6c6f 6261 6c5b 7470  _count_global[tp
+00005f00: 2e6e 616d 655d 202b 3d20 310a 2020 2020  .name] += 1.    
+00005f10: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
+00005f20: 696e 672e 6164 6428 7473 290a 2020 2020  ing.add(ts).    
+00005f30: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+00005f40: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+00005f50: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00005f60: 656c 6620 6e6f 7420 696e 2064 7473 2e77  elf not in dts.w
+00005f70: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
+00005f80: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+00005f90: 635f 6e65 6564 735f 7265 706c 6963 6128  c_needs_replica(
+00005fa0: 6474 7329 0a0a 2020 2020 6465 6620 6164  dts)..    def ad
+00005fb0: 645f 746f 5f6c 6f6e 675f 7275 6e6e 696e  d_to_long_runnin
+00005fc0: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
+00005fd0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00005fe0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00005ff0: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
+00006000: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00006010: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
+00006020: 662e 7072 6f63 6573 7369 6e67 0a20 2020  f.processing.   
+00006030: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00006040: 7473 206e 6f74 2069 6e20 7365 6c66 2e6c  ts not in self.l
+00006050: 6f6e 675f 7275 6e6e 696e 670a 0a20 2020  ong_running..   
+00006060: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
+00006070: 655f 6672 6f6d 5f74 6173 6b5f 7072 6566  e_from_task_pref
+00006080: 6978 5f63 6f75 6e74 2874 7329 0a20 2020  ix_count(ts).   
+00006090: 2020 2020 2023 2043 616e 6e6f 7420 7265       # Cannot re
+000060a0: 6d6f 7665 2066 726f 6d20 7072 6f63 6573  move from proces
+000060b0: 7369 6e67 2073 696e 6365 2077 6527 7265  sing since we're
+000060c0: 2075 7369 6e67 2074 6869 7320 666f 7220   using this for 
+000060d0: 7468 696e 6773 206c 696b 650a 2020 2020  things like.    
+000060e0: 2020 2020 2320 6964 6c65 6e65 7373 2064      # idleness d
+000060f0: 6574 6563 7469 6f6e 2e20 4964 6c65 2077  etection. Idle w
+00006100: 6f72 6b65 7273 2061 7265 2074 7970 6963  orkers are typic
+00006110: 616c 6c79 2074 6172 6765 7465 6420 666f  ally targeted fo
+00006120: 720a 2020 2020 2020 2020 2320 646f 776e  r.        # down
+00006130: 7363 616c 696e 6720 6275 7420 7765 2073  scaling but we s
+00006140: 686f 756c 6420 6e6f 7420 646f 776e 7363  hould not downsc
+00006150: 616c 6520 776f 726b 6572 7320 7769 7468  ale workers with
+00006160: 206c 6f6e 6720 7275 6e6e 696e 670a 2020   long running.  
+00006170: 2020 2020 2020 2320 7461 736b 730a 2020        # tasks.  
+00006180: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
+00006190: 7275 6e6e 696e 672e 6164 6428 7473 290a  running.add(ts).
+000061a0: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+000061b0: 6672 6f6d 5f70 726f 6365 7373 696e 6728  from_processing(
+000061c0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+000061d0: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+000061e0: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+000061f0: 6120 7461 736b 2066 726f 6d20 6120 776f  a task from a wo
+00006200: 726b 6572 7320 7072 6f63 6573 7369 6e67  rkers processing
+00006210: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+00006220: 656c 662e 7363 6865 6475 6c65 722e 7661  elf.scheduler.va
+00006230: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+00006240: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+00006250: 2073 656c 662e 7072 6f63 6573 7369 6e67   self.processing
+00006260: 0a0a 2020 2020 2020 2020 6966 2074 7320  ..        if ts 
+00006270: 696e 2073 656c 662e 6c6f 6e67 5f72 756e  in self.long_run
+00006280: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00006290: 2020 7365 6c66 2e6c 6f6e 675f 7275 6e6e    self.long_runn
+000062a0: 696e 672e 6469 7363 6172 6428 7473 290a  ing.discard(ts).
+000062b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000062c0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000062d0: 7265 6d6f 7665 5f66 726f 6d5f 7461 736b  remove_from_task
+000062e0: 5f70 7265 6669 785f 636f 756e 7428 7473  _prefix_count(ts
+000062f0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00006300: 726f 6365 7373 696e 672e 7265 6d6f 7665  rocessing.remove
+00006310: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
+00006320: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+00006330: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+00006340: 2020 2020 2069 6620 6474 7320 696e 2073       if dts in s
+00006350: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
+00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006370: 7365 6c66 2e5f 6465 635f 6e65 6564 735f  self._dec_needs_
+00006380: 7265 706c 6963 6128 6474 7329 0a0a 2020  replica(dts)..  
+00006390: 2020 6465 6620 5f72 656d 6f76 655f 6672    def _remove_fr
+000063a0: 6f6d 5f74 6173 6b5f 7072 6566 6978 5f63  om_task_prefix_c
+000063b0: 6f75 6e74 2873 656c 662c 2074 733a 2054  ount(self, ts: T
+000063c0: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+000063d0: 653a 0a20 2020 2020 2020 2063 6f75 6e74  e:.        count
+000063e0: 203d 2073 656c 662e 7461 736b 5f70 7265   = self.task_pre
+000063f0: 6669 785f 636f 756e 745b 7473 2e70 7265  fix_count[ts.pre
+00006400: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
+00006410: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
+00006420: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006430: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+00006440: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
+00006450: 655d 203d 2063 6f75 6e74 0a20 2020 2020  e] = count.     
+00006460: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006470: 2020 2020 2064 656c 2073 656c 662e 7461       del self.ta
+00006480: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
+00006490: 7473 2e70 7265 6669 782e 6e61 6d65 5d0a  ts.prefix.name].
+000064a0: 0a20 2020 2020 2020 2063 6f75 6e74 203d  .        count =
+000064b0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+000064c0: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+000064d0: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
+000064e0: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
+000064f0: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
+00006500: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006510: 2e73 6368 6564 756c 6572 2e5f 7461 736b  .scheduler._task
+00006520: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
+00006530: 6f62 616c 5b74 732e 7072 6566 6978 2e6e  obal[ts.prefix.n
+00006540: 616d 655d 203d 2063 6f75 6e74 0a20 2020  ame] = count.   
+00006550: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00006560: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+00006570: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
+00006580: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
+00006590: 6261 6c5b 7473 2e70 7265 6669 782e 6e61  bal[ts.prefix.na
+000065a0: 6d65 5d0a 0a20 2020 2064 6566 2072 656d  me]..    def rem
+000065b0: 6f76 655f 7265 706c 6963 6128 7365 6c66  ove_replica(self
+000065c0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+000065d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000065e0: 2020 2222 2254 6865 2077 6f72 6b65 7220    """The worker 
+000065f0: 6e6f 206c 6f6e 6765 7220 6861 7320 6120  no longer has a 
+00006600: 7461 736b 2069 6e20 6d65 6d6f 7279 2222  task in memory""
+00006610: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+00006620: 662e 7363 6865 6475 6c65 722e 7661 6c69  f.scheduler.vali
+00006630: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00006640: 2020 6173 7365 7274 2073 656c 6620 696e    assert self in
+00006650: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+00006660: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00006670: 7320 696e 2073 656c 662e 6861 735f 7768  s in self.has_wh
+00006680: 6174 0a20 2020 2020 2020 2020 2020 2061  at.            a
+00006690: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+000066a0: 7365 6c66 2e6e 6565 6473 5f77 6861 740a  self.needs_what.
+000066b0: 0a20 2020 2020 2020 2073 656c 662e 6e62  .        self.nb
+000066c0: 7974 6573 202d 3d20 7473 2e67 6574 5f6e  ytes -= ts.get_n
+000066d0: 6279 7465 7328 290a 2020 2020 2020 2020  bytes().        
+000066e0: 6465 6c20 7365 6c66 2e5f 6861 735f 7768  del self._has_wh
+000066f0: 6174 5b74 735d 0a20 2020 2020 2020 2074  at[ts].        t
+00006700: 732e 7768 6f5f 6861 732e 7265 6d6f 7665  s.who_has.remove
+00006710: 2873 656c 6629 0a0a 2020 2020 6465 6620  (self)..    def 
+00006720: 5f69 6e63 5f6e 6565 6473 5f72 6570 6c69  _inc_needs_repli
+00006730: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
+00006740: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+00006750: 0a20 2020 2020 2020 2022 2222 4173 7369  .        """Assi
+00006760: 676e 2061 2074 6173 6b20 6665 7463 6820  gn a task fetch 
+00006770: 746f 2074 6869 7320 776f 726b 6572 2061  to this worker a
+00006780: 6e64 2075 7064 6174 6520 6e65 7477 6f72  nd update networ
+00006790: 6b20 6f63 6375 7061 6e63 6965 7322 2222  k occupancies"""
+000067a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000067b0: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
+000067c0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+000067d0: 2061 7373 6572 7420 7365 6c66 206e 6f74   assert self not
+000067e0: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
+000067f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00006800: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+00006810: 2e68 6173 5f77 6861 740a 2020 2020 2020  .has_what.      
+00006820: 2020 6966 2074 7320 6e6f 7420 696e 2073    if ts not in s
+00006830: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
+00006840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006850: 2e6e 6565 6473 5f77 6861 745b 7473 5d20  .needs_what[ts] 
+00006860: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00006870: 6e62 7974 6573 203d 2074 732e 6765 745f  nbytes = ts.get_
+00006880: 6e62 7974 6573 2829 0a20 2020 2020 2020  nbytes().       
+00006890: 2020 2020 2073 656c 662e 5f6e 6574 776f       self._netwo
+000068a0: 726b 5f6f 6363 202b 3d20 6e62 7974 6573  rk_occ += nbytes
+000068b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000068c0: 662e 7363 6865 6475 6c65 722e 5f6e 6574  f.scheduler._net
+000068d0: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c20  work_occ_global 
+000068e0: 2b3d 206e 6279 7465 730a 2020 2020 2020  += nbytes.      
+000068f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00006900: 2020 2020 7365 6c66 2e6e 6565 6473 5f77      self.needs_w
+00006910: 6861 745b 7473 5d20 2b3d 2031 0a0a 2020  hat[ts] += 1..  
+00006920: 2020 6465 6620 5f64 6563 5f6e 6565 6473    def _dec_needs
+00006930: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
+00006940: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+00006950: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00006960: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+00006970: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00006980: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00006990: 2069 6e20 7365 6c66 2e6e 6565 6473 5f77   in self.needs_w
+000069a0: 6861 740a 0a20 2020 2020 2020 2073 656c  hat..        sel
+000069b0: 662e 6e65 6564 735f 7768 6174 5b74 735d  f.needs_what[ts]
+000069c0: 202d 3d20 310a 2020 2020 2020 2020 6966   -= 1.        if
+000069d0: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
+000069e0: 5b74 735d 203d 3d20 303a 0a20 2020 2020  [ts] == 0:.     
+000069f0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+00006a00: 6e65 6564 735f 7768 6174 5b74 735d 0a20  needs_what[ts]. 
+00006a10: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
+00006a20: 7320 3d20 7473 2e67 6574 5f6e 6279 7465  s = ts.get_nbyte
+00006a30: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00006a40: 7365 6c66 2e5f 6e65 7477 6f72 6b5f 6f63  self._network_oc
+00006a50: 6320 2d3d 206e 6279 7465 730a 2020 2020  c -= nbytes.    
+00006a60: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00006a70: 6564 756c 6572 2e5f 6e65 7477 6f72 6b5f  eduler._network_
+00006a80: 6f63 635f 676c 6f62 616c 202d 3d20 6e62  occ_global -= nb
+00006a90: 7974 6573 0a0a 2020 2020 6465 6620 6164  ytes..    def ad
+00006aa0: 645f 7265 706c 6963 6128 7365 6c66 2c20  d_replica(self, 
+00006ab0: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+00006ac0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00006ad0: 2222 2254 6865 2077 6f72 6b65 7220 6163  """The worker ac
+00006ae0: 7175 6972 6564 2061 2072 6570 6c69 6361  quired a replica
+00006af0: 206f 6620 7461 736b 2222 220a 2020 2020   of task""".    
+00006b00: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
+00006b10: 6475 6c65 722e 7661 6c69 6461 7465 3a0a  duler.validate:.
+00006b20: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006b30: 7274 2073 656c 6620 6e6f 7420 696e 2074  rt self not in t
+00006b40: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00006b50: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00006b60: 6e6f 7420 696e 2073 656c 662e 6861 735f  not in self.has_
+00006b70: 7768 6174 0a0a 2020 2020 2020 2020 6e62  what..        nb
+00006b80: 7974 6573 203d 2074 732e 6765 745f 6e62  ytes = ts.get_nb
+00006b90: 7974 6573 2829 0a20 2020 2020 2020 2069  ytes().        i
+00006ba0: 6620 7473 2069 6e20 7365 6c66 2e6e 6565  f ts in self.nee
+00006bb0: 6473 5f77 6861 743a 0a20 2020 2020 2020  ds_what:.       
+00006bc0: 2020 2020 2064 656c 2073 656c 662e 6e65       del self.ne
+00006bd0: 6564 735f 7768 6174 5b74 735d 0a20 2020  eds_what[ts].   
+00006be0: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
+00006bf0: 6574 776f 726b 5f6f 6363 202d 3d20 6e62  etwork_occ -= nb
+00006c00: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
+00006c10: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006c20: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
+00006c30: 6261 6c20 2d3d 206e 6279 7465 730a 2020  bal -= nbytes.  
+00006c40: 2020 2020 2020 7473 2e77 686f 5f68 6173        ts.who_has
+00006c50: 2e61 6464 2873 656c 6629 0a20 2020 2020  .add(self).     
+00006c60: 2020 2073 656c 662e 6e62 7974 6573 202b     self.nbytes +
+00006c70: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+00006c80: 2073 656c 662e 5f68 6173 5f77 6861 745b   self._has_what[
+00006c90: 7473 5d20 3d20 4e6f 6e65 0a0a 2020 2020  ts] = None..    
+00006ca0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00006cb0: 6620 6f63 6375 7061 6e63 7928 7365 6c66  f occupancy(self
+00006cc0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00006cd0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00006ce0: 5f6f 6363 7570 616e 6379 5f63 6163 6865  _occupancy_cache
+00006cf0: 206f 7220 7365 6c66 2e73 6368 6564 756c   or self.schedul
+00006d00: 6572 2e5f 6361 6c63 5f6f 6363 7570 616e  er._calc_occupan
+00006d10: 6379 280a 2020 2020 2020 2020 2020 2020  cy(.            
+00006d20: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+00006d30: 5f63 6f75 6e74 2c20 7365 6c66 2e5f 6e65  _count, self._ne
+00006d40: 7477 6f72 6b5f 6f63 630a 2020 2020 2020  twork_occ.      
+00006d50: 2020 290a 0a0a 4064 6174 6163 6c61 7373    )...@dataclass
+00006d60: 6573 2e64 6174 6163 6c61 7373 0a63 6c61  es.dataclass.cla
+00006d70: 7373 2045 7272 6564 5461 736b 3a0a 2020  ss ErredTask:.  
+00006d80: 2020 2222 224c 6967 6874 7765 6967 6874    """Lightweight
+00006d90: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
+00006da0: 6f66 2061 6e20 6572 7265 6420 7461 736b  of an erred task
+00006db0: 2077 6974 686f 7574 2061 6e79 2064 6570   without any dep
+00006dc0: 656e 6465 6e63 7920 696e 666f 726d 6174  endency informat
+00006dd0: 696f 6e0a 2020 2020 6f72 2072 756e 7370  ion.    or runsp
+00006de0: 6563 2e0a 0a20 2020 2053 6565 2061 6c73  ec...    See als
+00006df0: 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  o.    --------. 
+00006e00: 2020 2054 6173 6b53 7461 7465 0a20 2020     TaskState.   
+00006e10: 2022 2222 0a0a 2020 2020 6b65 793a 2048   """..    key: H
+00006e20: 6173 6861 626c 650a 2020 2020 7469 6d65  ashable.    time
+00006e30: 7374 616d 703a 2066 6c6f 6174 0a20 2020  stamp: float.   
+00006e40: 2065 7272 6564 5f6f 6e3a 2073 6574 5b73   erred_on: set[s
+00006e50: 7472 5d0a 2020 2020 6578 6365 7074 696f  tr].    exceptio
+00006e60: 6e5f 7465 7874 3a20 7374 720a 2020 2020  n_text: str.    
+00006e70: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
+00006e80: 7374 720a 0a0a 636c 6173 7320 436f 6d70  str...class Comp
+00006e90: 7574 6174 696f 6e3a 0a20 2020 2022 2222  utation:.    """
+00006ea0: 436f 6c6c 6563 7469 6f6e 2074 7261 636b  Collection track
+00006eb0: 696e 6720 6120 7369 6e67 6c65 2063 6f6d  ing a single com
+00006ec0: 7075 7465 206f 7220 7065 7273 6973 7420  pute or persist 
+00006ed0: 6361 6c6c 0a0a 2020 2020 5365 6520 616c  call..    See al
+00006ee0: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
+00006ef0: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
+00006f00: 2020 2054 6173 6b47 726f 7570 0a20 2020     TaskGroup.   
+00006f10: 2054 6173 6b53 7461 7465 0a20 2020 2022   TaskState.    "
+00006f20: 2222 0a0a 2020 2020 7374 6172 743a 2066  ""..    start: f
+00006f30: 6c6f 6174 0a20 2020 2067 726f 7570 733a  loat.    groups:
+00006f40: 2073 6574 5b54 6173 6b47 726f 7570 5d0a   set[TaskGroup].
+00006f50: 2020 2020 636f 6465 3a20 536f 7274 6564      code: Sorted
+00006f60: 5365 740a 2020 2020 6964 3a20 7575 6964  Set.    id: uuid
+00006f70: 2e55 5549 440a 2020 2020 616e 6e6f 7461  .UUID.    annota
+00006f80: 7469 6f6e 733a 2064 6963 740a 0a20 2020  tions: dict..   
+00006f90: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
+00006fa0: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
+00006fb0: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
+00006fc0: 6e69 745f 5f28 7365 6c66 293a 0a20 2020  nit__(self):.   
+00006fd0: 2020 2020 2073 656c 662e 7374 6172 7420       self.start 
+00006fe0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+00006ff0: 2073 656c 662e 6772 6f75 7073 203d 2073   self.groups = s
+00007000: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+00007010: 662e 636f 6465 203d 2053 6f72 7465 6453  f.code = SortedS
+00007020: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+00007030: 662e 6964 203d 2075 7569 642e 7575 6964  f.id = uuid.uuid
+00007040: 3428 290a 2020 2020 2020 2020 7365 6c66  4().        self
+00007050: 2e61 6e6e 6f74 6174 696f 6e73 203d 207b  .annotations = {
+00007060: 7d0a 0a20 2020 2040 7072 6f70 6572 7479  }..    @property
+00007070: 0a20 2020 2064 6566 2073 746f 7028 7365  .    def stop(se
+00007080: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
+00007090: 2020 2020 2020 6966 2073 656c 662e 6772        if self.gr
+000070a0: 6f75 7073 3a0a 2020 2020 2020 2020 2020  oups:.          
+000070b0: 2020 7265 7475 726e 206d 6178 2874 672e    return max(tg.
+000070c0: 7374 6f70 2066 6f72 2074 6720 696e 2073  stop for tg in s
+000070d0: 656c 662e 6772 6f75 7073 290a 2020 2020  elf.groups).    
+000070e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000070f0: 2020 2020 2020 7265 7475 726e 202d 310a        return -1.
+00007100: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00007110: 2020 2064 6566 2073 7461 7465 7328 7365     def states(se
+00007120: 6c66 2920 2d3e 2064 6963 745b 5461 736b  lf) -> dict[Task
+00007130: 5374 6174 6553 7461 7465 2c20 696e 745d  StateState, int]
+00007140: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00007150: 206d 6572 6765 5f77 6974 6828 7375 6d2c   merge_with(sum,
+00007160: 2028 7467 2e73 7461 7465 7320 666f 7220   (tg.states for 
+00007170: 7467 2069 6e20 7365 6c66 2e67 726f 7570  tg in self.group
+00007180: 7329 290a 0a20 2020 2064 6566 205f 5f72  s))..    def __r
+00007190: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
+000071a0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+000071b0: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+000071c0: 2066 223c 436f 6d70 7574 6174 696f 6e20   f"<Computation 
+000071d0: 7b73 656c 662e 6964 7d3a 2022 0a20 2020  {self.id}: ".   
+000071e0: 2020 2020 2020 2020 202b 2022 5461 736b           + "Task
+000071f0: 733a 2022 0a20 2020 2020 2020 2020 2020  s: ".           
+00007200: 202b 2022 2c20 222e 6a6f 696e 280a 2020   + ", ".join(.  
+00007210: 2020 2020 2020 2020 2020 2020 2020 2225                "%
+00007220: 733a 2025 6422 2025 2028 6b2c 2076 2920  s: %d" % (k, v) 
+00007230: 666f 7220 286b 2c20 7629 2069 6e20 736f  for (k, v) in so
+00007240: 7274 6564 2873 656c 662e 7374 6174 6573  rted(self.states
+00007250: 2e69 7465 6d73 2829 2920 6966 2076 0a20  .items()) if v. 
+00007260: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00007270: 2020 2020 2020 2020 202b 2022 3e22 0a20           + ">". 
+00007280: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00007290: 6620 5f72 6570 725f 6874 6d6c 5f28 7365  f _repr_html_(se
+000072a0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+000072b0: 2020 2020 7265 7475 726e 2067 6574 5f74      return get_t
+000072c0: 656d 706c 6174 6528 2263 6f6d 7075 7461  emplate("computa
+000072d0: 7469 6f6e 2e68 746d 6c2e 6a32 2229 2e72  tion.html.j2").r
+000072e0: 656e 6465 7228 0a20 2020 2020 2020 2020  ender(.         
+000072f0: 2020 2069 643d 7365 6c66 2e69 642c 0a20     id=self.id,. 
+00007300: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00007310: 3d73 656c 662e 7374 6172 742c 0a20 2020  =self.start,.   
+00007320: 2020 2020 2020 2020 2073 746f 703d 7365           stop=se
+00007330: 6c66 2e73 746f 702c 0a20 2020 2020 2020  lf.stop,.       
+00007340: 2020 2020 2067 726f 7570 733d 7365 6c66       groups=self
+00007350: 2e67 726f 7570 732c 0a20 2020 2020 2020  .groups,.       
+00007360: 2020 2020 2073 7461 7465 733d 7365 6c66       states=self
+00007370: 2e73 7461 7465 732c 0a20 2020 2020 2020  .states,.       
+00007380: 2020 2020 2063 6f64 653d 7365 6c66 2e63       code=self.c
+00007390: 6f64 652c 0a20 2020 2020 2020 2029 0a0a  ode,.        )..
+000073a0: 0a63 6c61 7373 2054 6173 6b50 7265 6669  .class TaskPrefi
+000073b0: 783a 0a20 2020 2022 2222 436f 6c6c 6563  x:.    """Collec
+000073c0: 7469 6f6e 2074 7261 636b 696e 6720 616c  tion tracking al
+000073d0: 6c20 7461 736b 7320 7769 7468 696e 2061  l tasks within a
+000073e0: 2067 726f 7570 0a0a 2020 2020 4b65 7973   group..    Keys
+000073f0: 206f 6674 656e 2068 6176 6520 6120 7374   often have a st
+00007400: 7275 6374 7572 6520 6c69 6b65 2060 6028  ructure like ``(
+00007410: 2278 2d31 3233 222c 2030 2960 600a 2020  "x-123", 0)``.  
+00007420: 2020 4120 6772 6f75 7020 7461 6b65 7320    A group takes 
+00007430: 7468 6520 6669 7273 7420 7365 6374 696f  the first sectio
+00007440: 6e2c 206c 696b 6520 6060 2278 2260 600a  n, like ``"x"``.
+00007450: 0a20 2020 2053 6565 2041 6c73 6f0a 2020  .    See Also.  
+00007460: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2054    --------.    T
+00007470: 6173 6b47 726f 7570 0a20 2020 2022 2222  askGroup.    """
+00007480: 0a0a 2020 2020 233a 2054 6865 206e 616d  ..    #: The nam
+00007490: 6520 6f66 2061 2067 726f 7570 206f 6620  e of a group of 
+000074a0: 7461 736b 732e 0a20 2020 2023 3a20 466f  tasks..    #: Fo
+000074b0: 7220 6120 7461 736b 206c 696b 6520 6060  r a task like ``
+000074c0: 2822 782d 3132 3322 2c20 3029 6060 2074  ("x-123", 0)`` t
+000074d0: 6869 7320 6973 2074 6865 2074 6578 7420  his is the text 
+000074e0: 6060 2278 2260 600a 2020 2020 6e61 6d65  ``"x"``.    name
+000074f0: 3a20 7374 720a 0a20 2020 2023 3a20 416e  : str..    #: An
+00007500: 2065 7870 6f6e 656e 7469 616c 6c79 2077   exponentially w
+00007510: 6569 6768 7465 6420 6d6f 7669 6e67 2061  eighted moving a
+00007520: 7665 7261 6765 2064 7572 6174 696f 6e20  verage duration 
+00007530: 6f66 2061 6c6c 2074 6173 6b73 2077 6974  of all tasks wit
+00007540: 6820 7468 6973 2070 7265 6669 780a 2020  h this prefix.  
+00007550: 2020 6475 7261 7469 6f6e 5f61 7665 7261    duration_avera
+00007560: 6765 3a20 666c 6f61 740a 0a20 2020 2023  ge: float..    #
+00007570: 3a20 4e75 6d62 6572 7320 6f66 2074 696d  : Numbers of tim
+00007580: 6573 2061 2074 6173 6b20 7761 7320 6d61  es a task was ma
+00007590: 726b 6564 2061 7320 7375 7370 6963 696f  rked as suspicio
+000075a0: 7573 2077 6974 6820 7468 6973 2070 7265  us with this pre
+000075b0: 6669 780a 2020 2020 7375 7370 6963 696f  fix.    suspicio
+000075c0: 7573 3a20 696e 740a 0a20 2020 2023 3a20  us: int..    #: 
+000075d0: 5374 6f72 6520 7469 6d69 6e67 7320 666f  Store timings fo
+000075e0: 7220 6561 6368 2070 7265 6669 782d 6163  r each prefix-ac
+000075f0: 7469 6f6e 0a20 2020 2061 6c6c 5f64 7572  tion.    all_dur
+00007600: 6174 696f 6e73 3a20 6465 6661 756c 7464  ations: defaultd
+00007610: 6963 745b 7374 722c 2066 6c6f 6174 5d0a  ict[str, float].
+00007620: 0a20 2020 2023 3a20 5468 6973 206d 6561  .    #: This mea
+00007630: 7375 7265 7320 7468 6520 6d61 7869 6d75  sures the maximu
+00007640: 6d20 7265 636f 7264 6564 206c 6976 6520  m recorded live 
+00007650: 6578 6563 7574 696f 6e20 7469 6d65 2061  execution time a
+00007660: 6e64 2063 616e 2062 6520 7573 6564 2074  nd can be used t
+00007670: 6f0a 2020 2020 233a 2064 6574 6563 7420  o.    #: detect 
+00007680: 6f75 746c 6965 7273 0a20 2020 206d 6178  outliers.    max
+00007690: 5f65 7865 635f 7469 6d65 3a20 666c 6f61  _exec_time: floa
+000076a0: 740a 0a20 2020 2023 3a20 5461 736b 2067  t..    #: Task g
+000076b0: 726f 7570 7320 6173 736f 6369 6174 6564  roups associated
+000076c0: 2074 6f20 7468 6973 2070 7265 6669 780a   to this prefix.
+000076d0: 2020 2020 6772 6f75 7073 3a20 6c69 7374      groups: list
+000076e0: 5b54 6173 6b47 726f 7570 5d0a 0a20 2020  [TaskGroup]..   
+000076f0: 2023 3a20 4163 6375 6d75 6c61 7465 2063   #: Accumulate c
+00007700: 6f75 6e74 206f 6620 6e75 6d62 6572 206f  ount of number o
+00007710: 6620 7461 736b 7320 696e 2065 6163 6820  f tasks in each 
+00007720: 7374 6174 650a 2020 2020 7374 6174 655f  state.    state_
+00007730: 636f 756e 7473 3a20 6465 6661 756c 7464  counts: defaultd
+00007740: 6963 745b 5461 736b 5374 6174 6553 7461  ict[TaskStateSta
+00007750: 7465 2c20 696e 745d 0a0a 2020 2020 5f5f  te, int]..    __
+00007760: 736c 6f74 735f 5f20 3d20 7475 706c 6528  slots__ = tuple(
+00007770: 5f5f 616e 6e6f 7461 7469 6f6e 735f 5f29  __annotations__)
+00007780: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00007790: 5f5f 2873 656c 662c 206e 616d 653a 2073  __(self, name: s
+000077a0: 7472 293a 0a20 2020 2020 2020 2073 656c  tr):.        sel
+000077b0: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
+000077c0: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
+000077d0: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
+000077e0: 656c 662e 616c 6c5f 6475 7261 7469 6f6e  elf.all_duration
+000077f0: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
+00007800: 666c 6f61 7429 0a20 2020 2020 2020 2073  float).        s
+00007810: 656c 662e 7374 6174 655f 636f 756e 7473  elf.state_counts
+00007820: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
+00007830: 6e74 290a 2020 2020 2020 2020 7461 736b  nt).        task
+00007840: 5f64 7572 6174 696f 6e73 203d 2064 6173  _durations = das
+00007850: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+00007860: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00007870: 6c65 722e 6465 6661 756c 742d 7461 736b  ler.default-task
+00007880: 2d64 7572 6174 696f 6e73 2229 0a20 2020  -durations").   
+00007890: 2020 2020 2069 6620 7365 6c66 2e6e 616d       if self.nam
+000078a0: 6520 696e 2074 6173 6b5f 6475 7261 7469  e in task_durati
+000078b0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+000078c0: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+000078d0: 7665 7261 6765 203d 2070 6172 7365 5f74  verage = parse_t
+000078e0: 696d 6564 656c 7461 2874 6173 6b5f 6475  imedelta(task_du
+000078f0: 7261 7469 6f6e 735b 7365 6c66 2e6e 616d  rations[self.nam
+00007900: 655d 290a 2020 2020 2020 2020 656c 7365  e]).        else
+00007910: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00007920: 6c66 2e64 7572 6174 696f 6e5f 6176 6572  lf.duration_aver
+00007930: 6167 6520 3d20 2d31 0a20 2020 2020 2020  age = -1.       
+00007940: 2073 656c 662e 6d61 785f 6578 6563 5f74   self.max_exec_t
+00007950: 696d 6520 3d20 2d31 0a20 2020 2020 2020  ime = -1.       
+00007960: 2073 656c 662e 7375 7370 6963 696f 7573   self.suspicious
+00007970: 203d 2030 0a0a 2020 2020 6465 6620 6164   = 0..    def ad
+00007980: 645f 6578 6563 5f74 696d 6528 7365 6c66  d_exec_time(self
+00007990: 2c20 6475 7261 7469 6f6e 3a20 666c 6f61  , duration: floa
+000079a0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+000079b0: 2020 2020 7365 6c66 2e6d 6178 5f65 7865      self.max_exe
+000079c0: 635f 7469 6d65 203d 206d 6178 2864 7572  c_time = max(dur
+000079d0: 6174 696f 6e2c 2073 656c 662e 6d61 785f  ation, self.max_
+000079e0: 6578 6563 5f74 696d 6529 0a20 2020 2020  exec_time).     
+000079f0: 2020 2069 6620 6475 7261 7469 6f6e 203e     if duration >
+00007a00: 2032 202a 2073 656c 662e 6475 7261 7469   2 * self.durati
+00007a10: 6f6e 5f61 7665 7261 6765 3a0a 2020 2020  on_average:.    
+00007a20: 2020 2020 2020 2020 7365 6c66 2e64 7572          self.dur
+00007a30: 6174 696f 6e5f 6176 6572 6167 6520 3d20  ation_average = 
+00007a40: 2d31 0a0a 2020 2020 6465 6620 6164 645f  -1..    def add_
+00007a50: 6475 7261 7469 6f6e 2873 656c 662c 2061  duration(self, a
+00007a60: 6374 696f 6e3a 2073 7472 2c20 7374 6172  ction: str, star
+00007a70: 743a 2066 6c6f 6174 2c20 7374 6f70 3a20  t: float, stop: 
+00007a80: 666c 6f61 7429 202d 3e20 4e6f 6e65 3a0a  float) -> None:.
+00007a90: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
+00007aa0: 203d 2073 746f 7020 2d20 7374 6172 740a   = stop - start.
+00007ab0: 2020 2020 2020 2020 7365 6c66 2e61 6c6c          self.all
+00007ac0: 5f64 7572 6174 696f 6e73 5b61 6374 696f  _durations[actio
+00007ad0: 6e5d 202b 3d20 6475 7261 7469 6f6e 0a20  n] += duration. 
+00007ae0: 2020 2020 2020 2069 6620 6163 7469 6f6e         if action
+00007af0: 203d 3d20 2263 6f6d 7075 7465 223a 0a20   == "compute":. 
+00007b00: 2020 2020 2020 2020 2020 206f 6c64 203d             old =
+00007b10: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+00007b20: 7665 7261 6765 0a20 2020 2020 2020 2020  verage.         
+00007b30: 2020 2069 6620 6f6c 6420 3c20 303a 0a20     if old < 0:. 
+00007b40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00007b50: 656c 662e 6475 7261 7469 6f6e 5f61 7665  elf.duration_ave
+00007b60: 7261 6765 203d 2064 7572 6174 696f 6e0a  rage = duration.
+00007b70: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00007b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007b90: 2020 7365 6c66 2e64 7572 6174 696f 6e5f    self.duration_
+00007ba0: 6176 6572 6167 6520 3d20 302e 3520 2a20  average = 0.5 * 
+00007bb0: 6475 7261 7469 6f6e 202b 2030 2e35 202a  duration + 0.5 *
+00007bc0: 206f 6c64 0a0a 2020 2020 4070 726f 7065   old..    @prope
+00007bd0: 7274 790a 2020 2020 6465 6620 7374 6174  rty.    def stat
+00007be0: 6573 2873 656c 6629 202d 3e20 6469 6374  es(self) -> dict
+00007bf0: 5b73 7472 2c20 696e 745d 3a0a 2020 2020  [str, int]:.    
+00007c00: 2020 2020 2222 2254 6865 206e 756d 6265      """The numbe
+00007c10: 7220 6f66 2074 6173 6b73 2069 6e20 6561  r of tasks in ea
+00007c20: 6368 2073 7461 7465 2c0a 2020 2020 2020  ch state,.      
+00007c30: 2020 6c69 6b65 2060 607b 226d 656d 6f72    like ``{"memor
+00007c40: 7922 3a20 3130 2c20 2270 726f 6365 7373  y": 10, "process
+00007c50: 696e 6722 3a20 332c 2022 7265 6c65 6173  ing": 3, "releas
+00007c60: 6564 223a 2034 2c20 2e2e 2e7d 6060 0a20  ed": 4, ...}``. 
+00007c70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00007c80: 2020 2072 6574 7572 6e20 6d65 7267 655f     return merge_
+00007c90: 7769 7468 2873 756d 2c20 5b74 672e 7374  with(sum, [tg.st
+00007ca0: 6174 6573 2066 6f72 2074 6720 696e 2073  ates for tg in s
+00007cb0: 656c 662e 6772 6f75 7073 5d29 0a0a 2020  elf.groups])..  
+00007cc0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00007cd0: 6465 6620 6163 7469 7665 2873 656c 6629  def active(self)
+00007ce0: 202d 3e20 6c69 7374 5b54 6173 6b47 726f   -> list[TaskGro
+00007cf0: 7570 5d3a 0a20 2020 2020 2020 2072 6574  up]:.        ret
+00007d00: 7572 6e20 5b0a 2020 2020 2020 2020 2020  urn [.          
+00007d10: 2020 7467 0a20 2020 2020 2020 2020 2020    tg.           
+00007d20: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
+00007d30: 6772 6f75 7073 0a20 2020 2020 2020 2020  groups.         
+00007d40: 2020 2069 6620 616e 7928 6b20 213d 2022     if any(k != "
+00007d50: 666f 7267 6f74 7465 6e22 2061 6e64 2076  forgotten" and v
+00007d60: 2021 3d20 3020 666f 7220 6b2c 2076 2069   != 0 for k, v i
+00007d70: 6e20 7467 2e73 7461 7465 732e 6974 656d  n tg.states.item
+00007d80: 7328 2929 0a20 2020 2020 2020 205d 0a0a  s()).        ]..
+00007d90: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00007da0: 2020 6465 6620 6163 7469 7665 5f73 7461    def active_sta
+00007db0: 7465 7328 7365 6c66 2920 2d3e 2064 6963  tes(self) -> dic
+00007dc0: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
+00007dd0: 2020 2020 2072 6574 7572 6e20 6d65 7267       return merg
+00007de0: 655f 7769 7468 2873 756d 2c20 5b74 672e  e_with(sum, [tg.
+00007df0: 7374 6174 6573 2066 6f72 2074 6720 696e  states for tg in
+00007e00: 2073 656c 662e 6163 7469 7665 5d29 0a0a   self.active])..
+00007e10: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
+00007e20: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+00007e30: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
+00007e40: 2020 2020 2020 2020 2020 2020 223c 220a              "<".
+00007e50: 2020 2020 2020 2020 2020 2020 2b20 7365              + se
+00007e60: 6c66 2e6e 616d 650a 2020 2020 2020 2020  lf.name.        
+00007e70: 2020 2020 2b20 223a 2022 0a20 2020 2020      + ": ".     
+00007e80: 2020 2020 2020 202b 2022 2c20 222e 6a6f         + ", ".jo
+00007e90: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+00007ea0: 2020 2020 2225 733a 2025 6422 2025 2028      "%s: %d" % (
+00007eb0: 6b2c 2076 2920 666f 7220 286b 2c20 7629  k, v) for (k, v)
+00007ec0: 2069 6e20 736f 7274 6564 2873 656c 662e   in sorted(self.
+00007ed0: 7374 6174 6573 2e69 7465 6d73 2829 2920  states.items()) 
+00007ee0: 6966 2076 0a20 2020 2020 2020 2020 2020  if v.           
+00007ef0: 2029 0a20 2020 2020 2020 2020 2020 202b   ).            +
+00007f00: 2022 3e22 0a20 2020 2020 2020 2029 0a0a   ">".        )..
+00007f10: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00007f20: 2020 6465 6620 6e62 7974 6573 5f74 6f74    def nbytes_tot
+00007f30: 616c 2873 656c 6629 202d 3e20 696e 743a  al(self) -> int:
+00007f40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007f50: 7375 6d28 7467 2e6e 6279 7465 735f 746f  sum(tg.nbytes_to
+00007f60: 7461 6c20 666f 7220 7467 2069 6e20 7365  tal for tg in se
+00007f70: 6c66 2e67 726f 7570 7329 0a0a 2020 2020  lf.groups)..    
+00007f80: 6465 6620 5f5f 6c65 6e5f 5f28 7365 6c66  def __len__(self
+00007f90: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+00007fa0: 2020 7265 7475 726e 2073 756d 286d 6170    return sum(map
+00007fb0: 286c 656e 2c20 7365 6c66 2e67 726f 7570  (len, self.group
+00007fc0: 7329 290a 0a20 2020 2040 7072 6f70 6572  s))..    @proper
+00007fd0: 7479 0a20 2020 2064 6566 2064 7572 6174  ty.    def durat
+00007fe0: 696f 6e28 7365 6c66 2920 2d3e 2066 6c6f  ion(self) -> flo
+00007ff0: 6174 3a0a 2020 2020 2020 2020 7265 7475  at:.        retu
+00008000: 726e 2073 756d 2874 672e 6475 7261 7469  rn sum(tg.durati
+00008010: 6f6e 2066 6f72 2074 6720 696e 2073 656c  on for tg in sel
+00008020: 662e 6772 6f75 7073 290a 0a20 2020 2040  f.groups)..    @
+00008030: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00008040: 2074 7970 6573 2873 656c 6629 202d 3e20   types(self) -> 
+00008050: 7365 745b 7374 725d 3a0a 2020 2020 2020  set[str]:.      
+00008060: 2020 7265 7475 726e 207b 7479 7020 666f    return {typ fo
+00008070: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
+00008080: 7570 7320 666f 7220 7479 7020 696e 2074  ups for typ in t
+00008090: 672e 7479 7065 737d 0a0a 0a63 6c61 7373  g.types}...class
+000080a0: 2054 6173 6b47 726f 7570 3a0a 2020 2020   TaskGroup:.    
+000080b0: 2222 2243 6f6c 6c65 6374 696f 6e20 7472  """Collection tr
+000080c0: 6163 6b69 6e67 2061 6c6c 2074 6173 6b73  acking all tasks
+000080d0: 2077 6974 6869 6e20 6120 6772 6f75 700a   within a group.
+000080e0: 0a20 2020 204b 6579 7320 6f66 7465 6e20  .    Keys often 
+000080f0: 6861 7665 2061 2073 7472 7563 7475 7265  have a structure
+00008100: 206c 696b 6520 6060 2822 782d 3132 3322   like ``("x-123"
+00008110: 2c20 3029 6060 0a20 2020 2041 2067 726f  , 0)``.    A gro
+00008120: 7570 2074 616b 6573 2074 6865 2066 6972  up takes the fir
+00008130: 7374 2073 6563 7469 6f6e 2c20 6c69 6b65  st section, like
+00008140: 2060 6022 782d 3132 3322 6060 0a0a 2020   ``"x-123"``..  
+00008150: 2020 5365 6520 616c 736f 0a20 2020 202d    See also.    -
+00008160: 2d2d 2d2d 2d2d 2d0a 2020 2020 5461 736b  -------.    Task
+00008170: 5072 6566 6978 0a20 2020 2022 2222 0a0a  Prefix.    """..
+00008180: 2020 2020 233a 2054 6865 206e 616d 6520      #: The name 
+00008190: 6f66 2061 2067 726f 7570 206f 6620 7461  of a group of ta
+000081a0: 736b 732e 0a20 2020 2023 3a20 466f 7220  sks..    #: For 
+000081b0: 6120 7461 736b 206c 696b 6520 6060 2822  a task like ``("
+000081c0: 782d 3132 3322 2c20 3029 6060 2074 6869  x-123", 0)`` thi
+000081d0: 7320 6973 2074 6865 2074 6578 7420 6060  s is the text ``
+000081e0: 2278 2d31 3233 2260 600a 2020 2020 6e61  "x-123"``.    na
+000081f0: 6d65 3a20 7374 720a 0a20 2020 2023 3a20  me: str..    #: 
+00008200: 5468 6520 6e75 6d62 6572 206f 6620 7461  The number of ta
+00008210: 736b 7320 696e 2065 6163 6820 7374 6174  sks in each stat
+00008220: 652c 0a20 2020 2023 3a20 6c69 6b65 2060  e,.    #: like `
+00008230: 607b 226d 656d 6f72 7922 3a20 3130 2c20  `{"memory": 10, 
+00008240: 2270 726f 6365 7373 696e 6722 3a20 332c  "processing": 3,
+00008250: 2022 7265 6c65 6173 6564 223a 2034 2c20   "released": 4, 
+00008260: 2e2e 2e7d 6060 0a20 2020 2073 7461 7465  ...}``.    state
+00008270: 733a 2064 6963 745b 5461 736b 5374 6174  s: dict[TaskStat
+00008280: 6553 7461 7465 2c20 696e 745d 0a0a 2020  eState, int]..  
+00008290: 2020 233a 2054 6865 206f 7468 6572 2054    #: The other T
+000082a0: 6173 6b47 726f 7570 7320 6f6e 2077 6869  askGroups on whi
+000082b0: 6368 2074 6869 7320 6f6e 6520 6465 7065  ch this one depe
+000082c0: 6e64 730a 2020 2020 6465 7065 6e64 656e  nds.    dependen
+000082d0: 6369 6573 3a20 7365 745b 5461 736b 4772  cies: set[TaskGr
+000082e0: 6f75 705d 0a0a 2020 2020 233a 2054 6865  oup]..    #: The
+000082f0: 2074 6f74 616c 206e 756d 6265 7220 6f66   total number of
+00008300: 2062 7974 6573 2074 6861 7420 7468 6973   bytes that this
+00008310: 2074 6173 6b20 6772 6f75 7020 6861 7320   task group has 
+00008320: 7072 6f64 7563 6564 0a20 2020 206e 6279  produced.    nby
+00008330: 7465 735f 746f 7461 6c3a 2069 6e74 0a0a  tes_total: int..
+00008340: 2020 2020 233a 2054 6865 2074 6f74 616c      #: The total
+00008350: 2061 6d6f 756e 7420 6f66 2074 696d 6520   amount of time 
+00008360: 7370 656e 7420 6f6e 2061 6c6c 2074 6173  spent on all tas
+00008370: 6b73 2069 6e20 7468 6973 2054 6173 6b47  ks in this TaskG
+00008380: 726f 7570 0a20 2020 2064 7572 6174 696f  roup.    duratio
+00008390: 6e3a 2066 6c6f 6174 0a0a 2020 2020 233a  n: float..    #:
+000083a0: 2054 6865 2072 6573 756c 7420 7479 7065   The result type
+000083b0: 7320 6f66 2074 6869 7320 5461 736b 4772  s of this TaskGr
+000083c0: 6f75 700a 2020 2020 7479 7065 733a 2073  oup.    types: s
+000083d0: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
+000083e0: 5468 6520 776f 726b 6572 206d 6f73 7420  The worker most 
+000083f0: 7265 6365 6e74 6c79 2061 7373 6967 6e65  recently assigne
+00008400: 6420 6120 7461 736b 2066 726f 6d20 7468  d a task from th
+00008410: 6973 2067 726f 7570 2c20 6f72 204e 6f6e  is group, or Non
+00008420: 6520 7768 656e 2074 6865 2067 726f 7570  e when the group
+00008430: 0a20 2020 2023 3a20 6973 206e 6f74 2069  .    #: is not i
+00008440: 6465 6e74 6966 6965 6420 746f 2062 6520  dentified to be 
+00008450: 726f 6f74 2d6c 696b 6520 6279 2060 5363  root-like by `Sc
+00008460: 6865 6475 6c65 7253 7461 7465 2e64 6563  hedulerState.dec
+00008470: 6964 655f 776f 726b 6572 602e 0a20 2020  ide_worker`..   
+00008480: 206c 6173 745f 776f 726b 6572 3a20 576f   last_worker: Wo
+00008490: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+000084a0: 0a0a 2020 2020 233a 2049 6620 606c 6173  ..    #: If `las
+000084b0: 745f 776f 726b 6572 6020 6973 206e 6f74  t_worker` is not
+000084c0: 204e 6f6e 652c 2074 6865 206e 756d 6265   None, the numbe
+000084d0: 7220 6f66 2074 696d 6573 2074 6861 7420  r of times that 
+000084e0: 776f 726b 6572 2073 686f 756c 6420 6265  worker should be
+000084f0: 2061 7373 6967 6e65 640a 2020 2020 233a   assigned.    #:
+00008500: 2073 7562 7365 7175 656e 7420 7461 736b   subsequent task
+00008510: 7320 756e 7469 6c20 6120 6e65 7720 776f  s until a new wo
+00008520: 726b 6572 2069 7320 6368 6f73 656e 2e0a  rker is chosen..
+00008530: 2020 2020 6c61 7374 5f77 6f72 6b65 725f      last_worker_
+00008540: 7461 736b 735f 6c65 6674 3a20 696e 740a  tasks_left: int.
+00008550: 0a20 2020 2070 7265 6669 783a 2054 6173  .    prefix: Tas
+00008560: 6b50 7265 6669 7820 7c20 4e6f 6e65 0a20  kPrefix | None. 
+00008570: 2020 2073 7461 7274 3a20 666c 6f61 740a     start: float.
+00008580: 2020 2020 7374 6f70 3a20 666c 6f61 740a      stop: float.
+00008590: 2020 2020 616c 6c5f 6475 7261 7469 6f6e      all_duration
+000085a0: 733a 2064 6566 6175 6c74 6469 6374 5b73  s: defaultdict[s
+000085b0: 7472 2c20 666c 6f61 745d 0a0a 2020 2020  tr, float]..    
+000085c0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+000085d0: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+000085e0: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+000085f0: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
+00008600: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
+00008610: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+00008620: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
+00008630: 6669 7820 3d20 4e6f 6e65 0a20 2020 2020  fix = None.     
+00008640: 2020 2073 656c 662e 7374 6174 6573 203d     self.states =
+00008650: 2064 6963 742e 6672 6f6d 6b65 7973 2841   dict.fromkeys(A
+00008660: 4c4c 5f54 4153 4b5f 5354 4154 4553 2c20  LL_TASK_STATES, 
+00008670: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+00008680: 6465 7065 6e64 656e 6369 6573 203d 2073  dependencies = s
+00008690: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+000086a0: 662e 6e62 7974 6573 5f74 6f74 616c 203d  f.nbytes_total =
+000086b0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+000086c0: 6475 7261 7469 6f6e 203d 2030 0a20 2020  duration = 0.   
+000086d0: 2020 2020 2073 656c 662e 7479 7065 7320       self.types 
+000086e0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+000086f0: 7365 6c66 2e73 7461 7274 203d 2030 2e30  self.start = 0.0
+00008700: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00008710: 6f70 203d 2030 2e30 0a20 2020 2020 2020  op = 0.0.       
+00008720: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+00008730: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
+00008740: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
+00008750: 2073 656c 662e 6c61 7374 5f77 6f72 6b65   self.last_worke
+00008760: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
+00008770: 2073 656c 662e 6c61 7374 5f77 6f72 6b65   self.last_worke
+00008780: 725f 7461 736b 735f 6c65 6674 203d 2030  r_tasks_left = 0
+00008790: 0a0a 2020 2020 6465 6620 6164 645f 6475  ..    def add_du
+000087a0: 7261 7469 6f6e 2873 656c 662c 2061 6374  ration(self, act
+000087b0: 696f 6e3a 2073 7472 2c20 7374 6172 743a  ion: str, start:
+000087c0: 2066 6c6f 6174 2c20 7374 6f70 3a20 666c   float, stop: fl
+000087d0: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
+000087e0: 2020 2020 2020 6475 7261 7469 6f6e 203d        duration =
+000087f0: 2073 746f 7020 2d20 7374 6172 740a 2020   stop - start.  
+00008800: 2020 2020 2020 7365 6c66 2e61 6c6c 5f64        self.all_d
+00008810: 7572 6174 696f 6e73 5b61 6374 696f 6e5d  urations[action]
+00008820: 202b 3d20 6475 7261 7469 6f6e 0a20 2020   += duration.   
+00008830: 2020 2020 2069 6620 6163 7469 6f6e 203d       if action =
+00008840: 3d20 2263 6f6d 7075 7465 223a 0a20 2020  = "compute":.   
+00008850: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00008860: 2e73 746f 7020 3c20 7374 6f70 3a0a 2020  .stop < stop:.  
+00008870: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00008880: 6c66 2e73 746f 7020 3d20 7374 6f70 0a20  lf.stop = stop. 
+00008890: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000088a0: 7374 6172 7420 3d20 7365 6c66 2e73 7461  start = self.sta
+000088b0: 7274 206f 7220 7374 6172 740a 2020 2020  rt or start.    
+000088c0: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
+000088d0: 6e20 2b3d 2064 7572 6174 696f 6e0a 2020  n += duration.  
+000088e0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+000088f0: 662e 7072 6566 6978 2069 7320 6e6f 7420  f.prefix is not 
+00008900: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00008910: 662e 7072 6566 6978 2e61 6464 5f64 7572  f.prefix.add_dur
+00008920: 6174 696f 6e28 6163 7469 6f6e 2c20 7374  ation(action, st
+00008930: 6172 742c 2073 746f 7029 0a0a 2020 2020  art, stop)..    
+00008940: 6465 6620 6164 6428 7365 6c66 2c20 6f74  def add(self, ot
+00008950: 6865 723a 2054 6173 6b53 7461 7465 2920  her: TaskState) 
+00008960: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00008970: 2073 656c 662e 7374 6174 6573 5b6f 7468   self.states[oth
+00008980: 6572 2e73 7461 7465 5d20 2b3d 2031 0a20  er.state] += 1. 
+00008990: 2020 2020 2020 206f 7468 6572 2e67 726f         other.gro
+000089a0: 7570 203d 2073 656c 660a 0a20 2020 2064  up = self..    d
+000089b0: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
+000089c0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+000089d0: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
+000089e0: 2020 2020 2020 2022 3c22 0a20 2020 2020         "<".     
+000089f0: 2020 2020 2020 202b 2028 7365 6c66 2e6e         + (self.n
+00008a00: 616d 6520 6f72 2022 6e6f 2d67 726f 7570  ame or "no-group
+00008a10: 2229 0a20 2020 2020 2020 2020 2020 202b  ").            +
+00008a20: 2022 3a20 220a 2020 2020 2020 2020 2020   ": ".          
+00008a30: 2020 2b20 222c 2022 2e6a 6f69 6e28 0a20    + ", ".join(. 
+00008a40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00008a50: 2573 3a20 2564 2220 2520 286b 2c20 7629  %s: %d" % (k, v)
+00008a60: 2066 6f72 2028 6b2c 2076 2920 696e 2073   for (k, v) in s
+00008a70: 6f72 7465 6428 7365 6c66 2e73 7461 7465  orted(self.state
+00008a80: 732e 6974 656d 7328 2929 2069 6620 760a  s.items()) if v.
+00008a90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00008aa0: 2020 2020 2020 2020 2020 2b20 223e 220a            + ">".
+00008ab0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00008ac0: 6566 205f 5f6c 656e 5f5f 2873 656c 6629  ef __len__(self)
+00008ad0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+00008ae0: 2072 6574 7572 6e20 7375 6d28 7365 6c66   return sum(self
+00008af0: 2e73 7461 7465 732e 7661 6c75 6573 2829  .states.values()
+00008b00: 290a 0a20 2020 2064 6566 205f 746f 5f64  )..    def _to_d
+00008b10: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
+00008b20: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
+00008b30: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
+00008b40: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
+00008b50: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
+00008b60: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
+00008b70: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
+00008b80: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
+00008b90: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
+00008ba0: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
+00008bb0: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
+00008bc0: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
+00008bd0: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
+00008be0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+00008bf0: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
+00008c00: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
+00008c10: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
+00008c20: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
+00008c30: 7369 7665 5f74 6f5f 6469 6374 0a20 2020  sive_to_dict.   
+00008c40: 2020 2020 2054 6173 6b53 7461 7465 2e5f       TaskState._
+00008c50: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
+00008c60: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00008c70: 726e 2072 6563 7572 7369 7665 5f74 6f5f  rn recursive_to_
+00008c80: 6469 6374 2873 656c 662c 2065 7863 6c75  dict(self, exclu
+00008c90: 6465 3d65 7863 6c75 6465 2c20 6d65 6d62  de=exclude, memb
+00008ca0: 6572 733d 5472 7565 290a 0a0a 636c 6173  ers=True)...clas
+00008cb0: 7320 5461 736b 5374 6174 653a 0a20 2020  s TaskState:.   
+00008cc0: 2022 2222 4120 7369 6d70 6c65 206f 626a   """A simple obj
+00008cd0: 6563 7420 686f 6c64 696e 6720 696e 666f  ect holding info
+00008ce0: 726d 6174 696f 6e20 6162 6f75 7420 6120  rmation about a 
+00008cf0: 7461 736b 2e0a 0a20 2020 204e 6f74 2074  task...    Not t
+00008d00: 6f20 6265 2063 6f6e 6675 7365 6420 7769  o be confused wi
+00008d10: 7468 203a 636c 6173 733a 6064 6973 7472  th :class:`distr
+00008d20: 6962 7574 6564 2e77 6f72 6b65 725f 7374  ibuted.worker_st
+00008d30: 6174 655f 6d61 6368 696e 652e 5461 736b  ate_machine.Task
+00008d40: 5374 6174 6560 2c20 7768 6963 680a 2020  State`, which.  
+00008d50: 2020 686f 6c64 7320 7369 6d69 6c61 7220    holds similar 
+00008d60: 696e 666f 726d 6174 696f 6e20 6f6e 2074  information on t
+00008d70: 6865 2057 6f72 6b65 7220 7369 6465 2e0a  he Worker side..
+00008d80: 2020 2020 2222 220a 0a20 2020 2023 3a20      """..    #: 
+00008d90: 5468 6520 6b65 7920 6973 2074 6865 2075  The key is the u
+00008da0: 6e69 7175 6520 6964 656e 7469 6669 6572  nique identifier
+00008db0: 206f 6620 6120 7461 736b 2c20 6765 6e65   of a task, gene
+00008dc0: 7261 6c6c 7920 666f 726d 6564 2066 726f  rally formed fro
+00008dd0: 6d20 7468 6520 6e61 6d65 206f 6620 7468  m the name of th
+00008de0: 650a 2020 2020 233a 2066 756e 6374 696f  e.    #: functio
+00008df0: 6e2c 2066 6f6c 6c6f 7765 6420 6279 2061  n, followed by a
+00008e00: 2068 6173 6820 6f66 2074 6865 2066 756e   hash of the fun
+00008e10: 6374 696f 6e20 616e 6420 6172 6775 6d65  ction and argume
+00008e20: 6e74 732c 206c 696b 650a 2020 2020 233a  nts, like.    #:
+00008e30: 2060 6027 696e 632d 6162 3331 6330 3130   ``'inc-ab31c010
+00008e40: 3434 3439 3737 3030 3464 3635 3636 3130  444977004d656610
+00008e50: 6432 6434 3231 6563 2760 602e 0a20 2020  d2d421ec'``..   
+00008e60: 206b 6579 3a20 7374 720a 0a20 2020 2023   key: str..    #
+00008e70: 3a20 5468 6520 6272 6f61 6420 636c 6173  : The broad clas
+00008e80: 7320 6f66 2074 6173 6b73 2074 6f20 7768  s of tasks to wh
+00008e90: 6963 6820 7468 6973 2074 6173 6b20 6265  ich this task be
+00008ea0: 6c6f 6e67 7320 6c69 6b65 2022 696e 6322  longs like "inc"
+00008eb0: 206f 7220 2272 6561 645f 6373 7622 0a20   or "read_csv". 
+00008ec0: 2020 2070 7265 6669 783a 2054 6173 6b50     prefix: TaskP
+00008ed0: 7265 6669 780a 0a20 2020 2023 3a20 4120  refix..    #: A 
+00008ee0: 7370 6563 6966 6963 6174 696f 6e20 6f66  specification of
+00008ef0: 2068 6f77 2074 6f20 7275 6e20 7468 6520   how to run the 
+00008f00: 7461 736b 2e20 2054 6865 2074 7970 6520  task.  The type 
+00008f10: 616e 6420 6d65 616e 696e 6720 6f66 2074  and meaning of t
+00008f20: 6869 7320 7661 6c75 6520 6973 0a20 2020  his value is.   
+00008f30: 2023 3a20 6f70 6171 7565 2074 6f20 7468   #: opaque to th
+00008f40: 6520 7363 6865 6475 6c65 722c 2061 7320  e scheduler, as 
+00008f50: 6974 2069 7320 6f6e 6c79 2069 6e74 6572  it is only inter
+00008f60: 7072 6574 6564 2062 7920 7468 6520 776f  preted by the wo
+00008f70: 726b 6572 2074 6f20 7768 6963 6820 7468  rker to which th
+00008f80: 650a 2020 2020 233a 2074 6173 6b20 6973  e.    #: task is
+00008f90: 2073 656e 7420 666f 7220 6578 6563 7574   sent for execut
+00008fa0: 696e 672e 0a20 2020 2023 3a0a 2020 2020  ing..    #:.    
+00008fb0: 233a 2041 7320 6120 7370 6563 6961 6c20  #: As a special 
+00008fc0: 6361 7365 2c20 7468 6973 2061 7474 7269  case, this attri
+00008fd0: 6275 7465 206d 6179 2061 6c73 6f20 6265  bute may also be
+00008fe0: 2060 604e 6f6e 6560 602c 2069 6e20 7768   ``None``, in wh
+00008ff0: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
+00009000: 6b20 6973 0a20 2020 2023 3a20 2270 7572  k is.    #: "pur
+00009010: 6520 6461 7461 2220 2873 7563 6820 6173  e data" (such as
+00009020: 2c20 666f 7220 6578 616d 706c 652c 2061  , for example, a
+00009030: 2070 6965 6365 206f 6620 6461 7461 206c   piece of data l
+00009040: 6f61 6465 6420 696e 2074 6865 2073 6368  oaded in the sch
+00009050: 6564 756c 6572 2075 7369 6e67 0a20 2020  eduler using.   
+00009060: 2023 3a20 3a6d 6574 683a 6043 6c69 656e   #: :meth:`Clien
+00009070: 742e 7363 6174 7465 7260 292e 2020 4120  t.scatter`).  A 
+00009080: 2270 7572 6520 6461 7461 2220 7461 736b  "pure data" task
+00009090: 2063 616e 6e6f 7420 6265 2063 6f6d 7075   cannot be compu
+000090a0: 7465 6420 6167 6169 6e20 6966 2069 7473  ted again if its
+000090b0: 0a20 2020 2023 3a20 7661 6c75 6520 6973  .    #: value is
+000090c0: 206c 6f73 742e 0a20 2020 2072 756e 5f73   lost..    run_s
+000090d0: 7065 633a 206f 626a 6563 740a 0a20 2020  pec: object..   
+000090e0: 2023 3a20 5468 6520 7072 696f 7269 7479   #: The priority
+000090f0: 2070 726f 7669 6465 7320 6561 6368 2074   provides each t
+00009100: 6173 6b20 7769 7468 2061 2072 656c 6174  ask with a relat
+00009110: 6976 6520 7261 6e6b 696e 6720 7768 6963  ive ranking whic
+00009120: 6820 6973 2075 7365 6420 746f 2062 7265  h is used to bre
+00009130: 616b 0a20 2020 2023 3a20 7469 6573 2077  ak.    #: ties w
+00009140: 6865 6e20 6d61 6e79 2074 6173 6b73 2061  hen many tasks a
+00009150: 7265 2062 6569 6e67 2063 6f6e 7369 6465  re being conside
+00009160: 7265 6420 666f 7220 6578 6563 7574 696f  red for executio
+00009170: 6e2e 0a20 2020 2023 3a0a 2020 2020 233a  n..    #:.    #:
+00009180: 2054 6869 7320 7261 6e6b 696e 6720 6973   This ranking is
+00009190: 2067 656e 6572 616c 6c79 2061 2032 2d69   generally a 2-i
+000091a0: 7465 6d20 7475 706c 652e 2020 5468 6520  tem tuple.  The 
+000091b0: 6669 7273 7420 2861 6e64 2064 6f6d 696e  first (and domin
+000091c0: 616e 7429 2069 7465 6d0a 2020 2020 233a  ant) item.    #:
+000091d0: 2063 6f72 7265 7370 6f6e 6473 2074 6f20   corresponds to 
+000091e0: 7768 656e 2069 7420 7761 7320 7375 626d  when it was subm
+000091f0: 6974 7465 642e 2020 4765 6e65 7261 6c6c  itted.  Generall
+00009200: 792c 2065 6172 6c69 6572 2074 6173 6b73  y, earlier tasks
+00009210: 2074 616b 6520 7072 6563 6564 656e 6365   take precedence
+00009220: 2e0a 2020 2020 233a 2054 6865 2073 6563  ..    #: The sec
+00009230: 6f6e 6420 6974 656d 2069 7320 6465 7465  ond item is dete
+00009240: 726d 696e 6564 2062 7920 7468 6520 636c  rmined by the cl
+00009250: 6965 6e74 2c20 616e 6420 6973 2061 2077  ient, and is a w
+00009260: 6179 2074 6f20 7072 696f 7269 7469 7a65  ay to prioritize
+00009270: 2074 6173 6b73 0a20 2020 2023 3a20 7769   tasks.    #: wi
+00009280: 7468 696e 2061 206c 6172 6765 2067 7261  thin a large gra
+00009290: 7068 2074 6861 7420 6d61 7920 6265 2069  ph that may be i
+000092a0: 6d70 6f72 7461 6e74 2c20 7375 6368 2061  mportant, such a
+000092b0: 7320 6966 2074 6865 7920 6172 6520 6f6e  s if they are on
+000092c0: 2074 6865 2063 7269 7469 6361 6c0a 2020   the critical.  
+000092d0: 2020 233a 2070 6174 682c 206f 7220 676f    #: path, or go
+000092e0: 6f64 2074 6f20 7275 6e20 696e 206f 7264  od to run in ord
+000092f0: 6572 2074 6f20 7265 6c65 6173 6520 6d61  er to release ma
+00009300: 6e79 2064 6570 656e 6465 6e63 6965 732e  ny dependencies.
+00009310: 2020 5468 6973 2069 7320 6578 706c 6169    This is explai
+00009320: 6e65 640a 2020 2020 233a 2066 7572 7468  ned.    #: furth
+00009330: 6572 2069 6e20 3a64 6f63 3a60 5363 6865  er in :doc:`Sche
+00009340: 6475 6c69 6e67 2050 6f6c 6963 7920 3c73  duling Policy <s
+00009350: 6368 6564 756c 696e 672d 706f 6c69 6369  cheduling-polici
+00009360: 6573 3e60 2e0a 2020 2020 7072 696f 7269  es>`..    priori
+00009370: 7479 3a20 7475 706c 655b 666c 6f61 742c  ty: tuple[float,
+00009380: 202e 2e2e 5d20 7c20 4e6f 6e65 0a0a 2020   ...] | None..  
+00009390: 2020 2320 4174 7472 6962 7574 6520 756e    # Attribute un
+000093a0: 6465 726c 7969 6e67 2074 6865 2073 7461  derlying the sta
+000093b0: 7465 2070 726f 7065 7274 790a 2020 2020  te property.    
+000093c0: 5f73 7461 7465 3a20 5461 736b 5374 6174  _state: TaskStat
+000093d0: 6553 7461 7465 0a0a 2020 2020 233a 2054  eState..    #: T
+000093e0: 6865 2073 6574 206f 6620 7461 736b 7320  he set of tasks 
+000093f0: 7468 6973 2074 6173 6b20 6465 7065 6e64  this task depend
+00009400: 7320 6f6e 2066 6f72 2070 726f 7065 7220  s on for proper 
+00009410: 6578 6563 7574 696f 6e2e 204f 6e6c 7920  execution. Only 
+00009420: 7461 736b 7320 7374 696c 6c0a 2020 2020  tasks still.    
+00009430: 233a 2061 6c69 7665 2061 7265 206c 6973  #: alive are lis
+00009440: 7465 6420 696e 2074 6869 7320 7365 742e  ted in this set.
+00009450: 2049 662c 2066 6f72 2077 6861 7465 7665   If, for whateve
+00009460: 7220 7265 6173 6f6e 2c20 7468 6973 2074  r reason, this t
+00009470: 6173 6b20 616c 736f 2064 6570 656e 6473  ask also depends
+00009480: 206f 6e0a 2020 2020 233a 2061 2066 6f72   on.    #: a for
+00009490: 676f 7474 656e 2074 6173 6b2c 2074 6865  gotten task, the
+000094a0: 203a 6174 7472 3a60 6861 735f 6c6f 7374   :attr:`has_lost
+000094b0: 5f64 6570 656e 6465 6e63 6965 7360 2066  _dependencies` f
+000094c0: 6c61 6720 6973 2073 6574 2e0a 2020 2020  lag is set..    
+000094d0: 233a 0a20 2020 2023 3a20 4120 7461 736b  #:.    #: A task
+000094e0: 2063 616e 206f 6e6c 7920 6265 2065 7865   can only be exe
+000094f0: 6375 7465 6420 6f6e 6365 2061 6c6c 2069  cuted once all i
+00009500: 7473 2064 6570 656e 6465 6e63 6965 7320  ts dependencies 
+00009510: 6861 7665 2061 6c72 6561 6479 2062 6565  have already bee
+00009520: 6e0a 2020 2020 233a 2073 7563 6365 7373  n.    #: success
+00009530: 6675 6c6c 7920 6578 6563 7574 6564 2061  fully executed a
+00009540: 6e64 2068 6176 6520 7468 6569 7220 7265  nd have their re
+00009550: 7375 6c74 2073 746f 7265 6420 6f6e 2061  sult stored on a
+00009560: 7420 6c65 6173 7420 6f6e 6520 776f 726b  t least one work
+00009570: 6572 2e20 5468 6973 0a20 2020 2023 3a20  er. This.    #: 
+00009580: 6973 2074 7261 636b 6564 2062 7920 7072  is tracked by pr
+00009590: 6f67 7265 7373 6976 656c 7920 6472 6169  ogressively drai
+000095a0: 6e69 6e67 2074 6865 203a 6174 7472 3a60  ning the :attr:`
+000095b0: 7761 6974 696e 675f 6f6e 6020 7365 742e  waiting_on` set.
+000095c0: 0a20 2020 2064 6570 656e 6465 6e63 6965  .    dependencie
+000095d0: 733a 2073 6574 5b54 6173 6b53 7461 7465  s: set[TaskState
+000095e0: 5d0a 0a20 2020 2023 3a20 5468 6520 7365  ]..    #: The se
+000095f0: 7420 6f66 2074 6173 6b73 2077 6869 6368  t of tasks which
+00009600: 2064 6570 656e 6420 6f6e 2074 6869 7320   depend on this 
+00009610: 7461 736b 2e20 204f 6e6c 7920 7461 736b  task.  Only task
+00009620: 7320 7374 696c 6c20 616c 6976 6520 6172  s still alive ar
+00009630: 6520 6c69 7374 6564 2069 6e0a 2020 2020  e listed in.    
+00009640: 233a 2074 6869 7320 7365 742e 2054 6869  #: this set. Thi
+00009650: 7320 6973 2074 6865 2072 6576 6572 7365  s is the reverse
+00009660: 206d 6170 7069 6e67 206f 6620 3a61 7474   mapping of :att
+00009670: 723a 6064 6570 656e 6465 6e63 6965 7360  r:`dependencies`
+00009680: 2e0a 2020 2020 6465 7065 6e64 656e 7473  ..    dependents
+00009690: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
+000096a0: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
+000096b0: 2061 6e79 206f 6620 7468 6520 6465 7065   any of the depe
+000096c0: 6e64 656e 6369 6573 206f 6620 7468 6973  ndencies of this
+000096d0: 2074 6173 6b20 6861 7320 6265 656e 2066   task has been f
+000096e0: 6f72 676f 7474 656e 2e20 466f 7220 6d65  orgotten. For me
+000096f0: 6d6f 7279 0a20 2020 2023 3a20 636f 6e73  mory.    #: cons
+00009700: 756d 7074 696f 6e20 7265 6173 6f6e 732c  umption reasons,
+00009710: 2066 6f72 676f 7474 656e 2074 6173 6b73   forgotten tasks
+00009720: 2061 7265 206e 6f74 206b 6570 7420 696e   are not kept in
+00009730: 206d 656d 6f72 7920 6576 656e 2074 686f   memory even tho
+00009740: 7567 6820 7468 6579 206d 6179 0a20 2020  ugh they may.   
+00009750: 2023 3a20 6861 7665 2064 6570 656e 6465   #: have depende
+00009760: 6e74 2074 6173 6b73 2e20 2057 6865 6e20  nt tasks.  When 
+00009770: 6120 7461 736b 2069 7320 666f 7267 6f74  a task is forgot
+00009780: 7465 6e2c 2074 6865 7265 666f 7265 2c20  ten, therefore, 
+00009790: 6561 6368 206f 6620 6974 730a 2020 2020  each of its.    
+000097a0: 233a 2064 6570 656e 6465 6e74 7320 6861  #: dependents ha
+000097b0: 7320 7468 6569 7220 3a61 7474 723a 6068  s their :attr:`h
+000097c0: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
+000097d0: 6369 6573 6020 6174 7472 6962 7574 6520  cies` attribute 
+000097e0: 7365 7420 746f 2060 6054 7275 6560 602e  set to ``True``.
+000097f0: 0a20 2020 2023 3a0a 2020 2020 233a 2049  .    #:.    #: I
+00009800: 6620 3a61 7474 723a 6068 6173 5f6c 6f73  f :attr:`has_los
+00009810: 745f 6465 7065 6e64 656e 6369 6573 6020  t_dependencies` 
+00009820: 6973 2074 7275 652c 2074 6869 7320 7461  is true, this ta
+00009830: 736b 2063 616e 6e6f 7420 676f 2069 6e74  sk cannot go int
+00009840: 6f20 7468 650a 2020 2020 233a 2022 7072  o the.    #: "pr
+00009850: 6f63 6573 7369 6e67 2220 7374 6174 6520  ocessing" state 
+00009860: 616e 796d 6f72 652e 0a20 2020 2068 6173  anymore..    has
+00009870: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+00009880: 6573 3a20 626f 6f6c 0a0a 2020 2020 233a  es: bool..    #:
+00009890: 2054 6865 2073 6574 206f 6620 7461 736b   The set of task
+000098a0: 7320 7468 6973 2074 6173 6b20 6973 2077  s this task is w
+000098b0: 6169 7469 6e67 206f 6e20 2a62 6566 6f72  aiting on *befor
+000098c0: 652a 2069 7420 6361 6e20 6265 2065 7865  e* it can be exe
+000098d0: 6375 7465 642e 2054 6869 7320 6973 0a20  cuted. This is. 
+000098e0: 2020 2023 3a20 616c 7761 7973 2061 2073     #: always a s
+000098f0: 7562 7365 7420 6f66 203a 6174 7472 3a60  ubset of :attr:`
+00009900: 6465 7065 6e64 656e 6369 6573 602e 2020  dependencies`.  
+00009910: 4561 6368 2074 696d 6520 6f6e 6520 6f66  Each time one of
+00009920: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
+00009930: 7320 6861 730a 2020 2020 233a 2066 696e  s has.    #: fin
+00009940: 6973 6865 6420 7072 6f63 6573 7369 6e67  ished processing
+00009950: 2c20 6974 2069 7320 7265 6d6f 7665 6420  , it is removed 
+00009960: 6672 6f6d 2074 6865 203a 6174 7472 3a60  from the :attr:`
+00009970: 7761 6974 696e 675f 6f6e 6020 7365 742e  waiting_on` set.
+00009980: 0a20 2020 2023 3a0a 2020 2020 233a 204f  .    #:.    #: O
+00009990: 6e63 6520 3a61 7474 723a 6077 6169 7469  nce :attr:`waiti
+000099a0: 6e67 5f6f 6e60 2062 6563 6f6d 6573 2065  ng_on` becomes e
+000099b0: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
+000099c0: 6361 6e20 6d6f 7665 2066 726f 6d20 7468  can move from th
+000099d0: 6520 2277 6169 7469 6e67 220a 2020 2020  e "waiting".    
+000099e0: 233a 2073 7461 7465 2074 6f20 7468 6520  #: state to the 
+000099f0: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+00009a00: 7465 2028 756e 6c65 7373 206f 6e65 206f  te (unless one o
+00009a10: 6620 7468 6520 6465 7065 6e64 656e 6369  f the dependenci
+00009a20: 6573 2065 7272 6f72 6564 206f 7574 2c20  es errored out, 
+00009a30: 696e 0a20 2020 2023 3a20 7768 6963 6820  in.    #: which 
+00009a40: 6361 7365 2074 6869 7320 7461 736b 2069  case this task i
+00009a50: 7320 696e 7374 6561 6420 6d61 726b 6564  s instead marked
+00009a60: 2022 6572 7265 6422 292e 0a20 2020 2077   "erred")..    w
+00009a70: 6169 7469 6e67 5f6f 6e3a 2073 6574 5b54  aiting_on: set[T
+00009a80: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
+00009a90: 3a20 5468 6520 7365 7420 6f66 2074 6173  : The set of tas
+00009aa0: 6b73 2077 6869 6368 206e 6565 6420 7468  ks which need th
+00009ab0: 6973 2074 6173 6b20 746f 2072 656d 6169  is task to remai
+00009ac0: 6e20 616c 6976 652e 2020 5468 6973 2069  n alive.  This i
+00009ad0: 7320 616c 7761 7973 2061 2073 7562 7365  s always a subse
+00009ae0: 740a 2020 2020 233a 206f 6620 3a61 7474  t.    #: of :att
+00009af0: 723a 6064 6570 656e 6465 6e74 7360 2e20  r:`dependents`. 
+00009b00: 2045 6163 6820 7469 6d65 206f 6e65 206f   Each time one o
+00009b10: 6620 7468 6520 6465 7065 6e64 656e 7473  f the dependents
+00009b20: 2068 6173 2066 696e 6973 6865 6420 7072   has finished pr
+00009b30: 6f63 6573 7369 6e67 2c0a 2020 2020 233a  ocessing,.    #:
+00009b40: 2069 7420 6973 2072 656d 6f76 6564 2066   it is removed f
+00009b50: 726f 6d20 7468 6520 3a61 7474 723a 6077  rom the :attr:`w
+00009b60: 6169 7465 7273 6020 7365 742e 0a20 2020  aiters` set..   
+00009b70: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
+00009b80: 626f 7468 203a 6174 7472 3a60 7761 6974  both :attr:`wait
+00009b90: 6572 7360 2061 6e64 203a 6174 7472 3a60  ers` and :attr:`
+00009ba0: 7768 6f5f 7761 6e74 7360 2062 6563 6f6d  who_wants` becom
+00009bb0: 6520 656d 7074 792c 2074 6869 7320 7461  e empty, this ta
+00009bc0: 736b 2063 616e 2062 650a 2020 2020 233a  sk can be.    #:
+00009bd0: 2072 656c 6561 7365 6420 2869 6620 6974   released (if it
+00009be0: 2068 6173 2061 206e 6f6e 2d65 6d70 7479   has a non-empty
+00009bf0: 203a 6174 7472 3a60 7275 6e5f 7370 6563   :attr:`run_spec
+00009c00: 6029 206f 7220 666f 7267 6f74 7465 6e20  `) or forgotten 
+00009c10: 286f 7468 6572 7769 7365 2920 6279 2074  (otherwise) by t
+00009c20: 6865 0a20 2020 2023 3a20 7363 6865 6475  he.    #: schedu
+00009c30: 6c65 722c 2061 6e64 2062 7920 616e 7920  ler, and by any 
+00009c40: 776f 726b 6572 7320 696e 203a 6174 7472  workers in :attr
+00009c50: 3a60 7768 6f5f 6861 7360 2e0a 2020 2020  :`who_has`..    
+00009c60: 233a 0a20 2020 2023 3a20 2e2e 206e 6f74  #:.    #: .. not
+00009c70: 653a 3a0a 2020 2020 233a 2020 2020 436f  e::.    #:    Co
+00009c80: 756e 7465 722d 696e 7475 6974 6976 656c  unter-intuitivel
+00009c90: 792c 203a 6174 7472 3a60 7761 6974 696e  y, :attr:`waitin
+00009ca0: 675f 6f6e 6020 616e 6420 3a61 7474 723a  g_on` and :attr:
+00009cb0: 6077 6169 7465 7273 6020 6172 6520 6e6f  `waiters` are no
+00009cc0: 7420 7265 7665 7273 650a 2020 2020 233a  t reverse.    #:
+00009cd0: 2020 2020 6d61 7070 696e 6773 206f 6620      mappings of 
+00009ce0: 6561 6368 206f 7468 6572 2e0a 2020 2020  each other..    
+00009cf0: 7761 6974 6572 733a 2073 6574 5b54 6173  waiters: set[Tas
+00009d00: 6b53 7461 7465 5d0a 0a20 2020 2023 3a20  kState]..    #: 
+00009d10: 5468 6520 7365 7420 6f66 2063 6c69 656e  The set of clien
+00009d20: 7473 2077 686f 2077 616e 7420 7468 6520  ts who want the 
+00009d30: 7265 7375 6c74 206f 6620 7468 6973 2074  result of this t
+00009d40: 6173 6b20 746f 2072 656d 6169 6e20 616c  ask to remain al
+00009d50: 6976 652e 0a20 2020 2023 3a20 5468 6973  ive..    #: This
+00009d60: 2069 7320 7468 6520 7265 7665 7273 6520   is the reverse 
+00009d70: 6d61 7070 696e 6720 6f66 203a 6174 7472  mapping of :attr
+00009d80: 3a60 436c 6965 6e74 5374 6174 652e 7761  :`ClientState.wa
+00009d90: 6e74 735f 7768 6174 602e 0a20 2020 2023  nts_what`..    #
+00009da0: 3a0a 2020 2020 233a 2057 6865 6e20 6120  :.    #: When a 
+00009db0: 636c 6965 6e74 2073 7562 6d69 7473 2061  client submits a
+00009dc0: 2067 7261 7068 2074 6f20 7468 6520 7363   graph to the sc
+00009dd0: 6865 6475 6c65 7220 6974 2061 6c73 6f20  heduler it also 
+00009de0: 7370 6563 6966 6965 7320 7768 6963 6820  specifies which 
+00009df0: 6f75 7470 7574 0a20 2020 2023 3a20 7461  output.    #: ta
+00009e00: 736b 7320 6974 2064 6573 6972 6573 2c20  sks it desires, 
+00009e10: 7375 6368 2074 6861 7420 7468 6569 7220  such that their 
+00009e20: 7265 7375 6c74 7320 6172 6520 6e6f 7420  results are not 
+00009e30: 7265 6c65 6173 6564 2066 726f 6d20 6d65  released from me
+00009e40: 6d6f 7279 2e0a 2020 2020 233a 0a20 2020  mory..    #:.   
+00009e50: 2023 3a20 4f6e 6365 2061 2074 6173 6b20   #: Once a task 
+00009e60: 6861 7320 6669 6e69 7368 6564 2065 7865  has finished exe
+00009e70: 6375 7469 6e67 2028 692e 652e 206d 6f76  cuting (i.e. mov
+00009e80: 6573 2069 6e74 6f20 7468 6520 226d 656d  es into the "mem
+00009e90: 6f72 7922 206f 7220 2265 7272 6564 220a  ory" or "erred".
+00009ea0: 2020 2020 233a 2073 7461 7465 292c 2074      #: state), t
+00009eb0: 6865 2063 6c69 656e 7473 2069 6e20 3a61  he clients in :a
+00009ec0: 7474 723a 6077 686f 5f77 616e 7473 6020  ttr:`who_wants` 
+00009ed0: 6172 6520 6e6f 7469 6669 6564 2e0a 2020  are notified..  
+00009ee0: 2020 233a 0a20 2020 2023 3a20 4f6e 6365    #:.    #: Once
+00009ef0: 2062 6f74 6820 3a61 7474 723a 6077 6169   both :attr:`wai
+00009f00: 7465 7273 6020 616e 6420 3a61 7474 723a  ters` and :attr:
+00009f10: 6077 686f 5f77 616e 7473 6020 6265 636f  `who_wants` beco
+00009f20: 6d65 2065 6d70 7479 2c20 7468 6973 2074  me empty, this t
+00009f30: 6173 6b20 6361 6e20 6265 0a20 2020 2023  ask can be.    #
+00009f40: 3a20 7265 6c65 6173 6564 2028 6966 2069  : released (if i
+00009f50: 7420 6861 7320 6120 6e6f 6e2d 656d 7074  t has a non-empt
+00009f60: 7920 3a61 7474 723a 6072 756e 5f73 7065  y :attr:`run_spe
+00009f70: 6360 2920 6f72 2066 6f72 676f 7474 656e  c`) or forgotten
+00009f80: 2028 6f74 6865 7277 6973 6529 2062 7920   (otherwise) by 
+00009f90: 7468 650a 2020 2020 233a 2073 6368 6564  the.    #: sched
+00009fa0: 756c 6572 2c20 616e 6420 6279 2061 6e79  uler, and by any
+00009fb0: 2077 6f72 6b65 7273 2069 6e20 3a61 7474   workers in :att
+00009fc0: 723a 6077 686f 5f68 6173 602e 0a20 2020  r:`who_has`..   
+00009fd0: 2077 686f 5f77 616e 7473 3a20 7365 745b   who_wants: set[
+00009fe0: 436c 6965 6e74 5374 6174 655d 0a0a 2020  ClientState]..  
+00009ff0: 2020 233a 2054 6865 2073 6574 206f 6620    #: The set of 
+0000a000: 776f 726b 6572 7320 7768 6f20 6861 7665  workers who have
+0000a010: 2074 6869 7320 7461 736b 2773 2072 6573   this task's res
+0000a020: 756c 7420 696e 206d 656d 6f72 792e 2049  ult in memory. I
+0000a030: 7420 6973 206e 6f6e 2d65 6d70 7479 2069  t is non-empty i
+0000a040: 6666 2074 6865 0a20 2020 2023 3a20 7461  ff the.    #: ta
+0000a050: 736b 2069 7320 696e 2074 6865 2022 6d65  sk is in the "me
+0000a060: 6d6f 7279 2220 7374 6174 652e 2020 5468  mory" state.  Th
+0000a070: 6572 6520 6361 6e20 6265 206d 6f72 6520  ere can be more 
+0000a080: 7468 616e 206f 6e65 2077 6f72 6b65 7220  than one worker 
+0000a090: 696e 2074 6869 7320 7365 7420 6966 2c0a  in this set if,.
+0000a0a0: 2020 2020 233a 2066 6f72 2065 7861 6d70      #: for examp
+0000a0b0: 6c65 2c20 3a6d 6574 683a 6043 6c69 656e  le, :meth:`Clien
+0000a0c0: 742e 7363 6174 7465 7260 206f 7220 3a6d  t.scatter` or :m
+0000a0d0: 6574 683a 6043 6c69 656e 742e 7265 706c  eth:`Client.repl
+0000a0e0: 6963 6174 6560 2077 6173 2075 7365 642e  icate` was used.
+0000a0f0: 0a20 2020 2023 3a0a 2020 2020 233a 2054  .    #:.    #: T
+0000a100: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
+0000a110: 7365 206d 6170 7069 6e67 206f 6620 3a61  se mapping of :a
+0000a120: 7474 723a 6057 6f72 6b65 7253 7461 7465  ttr:`WorkerState
+0000a130: 2e68 6173 5f77 6861 7460 2e0a 2020 2020  .has_what`..    
+0000a140: 7768 6f5f 6861 733a 2073 6574 5b57 6f72  who_has: set[Wor
+0000a150: 6b65 7253 7461 7465 5d0a 0a20 2020 2023  kerState]..    #
+0000a160: 3a20 4966 2074 6869 7320 7461 736b 2069  : If this task i
+0000a170: 7320 696e 2074 6865 2022 7072 6f63 6573  s in the "proces
+0000a180: 7369 6e67 2220 7374 6174 652c 2077 6869  sing" state, whi
+0000a190: 6368 2077 6f72 6b65 7220 6973 2063 7572  ch worker is cur
+0000a1a0: 7265 6e74 6c79 2070 726f 6365 7373 696e  rently processin
+0000a1b0: 670a 2020 2020 233a 2069 742e 2054 6869  g.    #: it. Thi
+0000a1c0: 7320 6174 7472 6962 7574 6520 6973 206b  s attribute is k
+0000a1d0: 6570 7420 696e 2073 796e 6320 7769 7468  ept in sync with
+0000a1e0: 203a 6174 7472 3a60 576f 726b 6572 5374   :attr:`WorkerSt
+0000a1f0: 6174 652e 7072 6f63 6573 7369 6e67 602e  ate.processing`.
+0000a200: 0a20 2020 2070 726f 6365 7373 696e 675f  .    processing_
+0000a210: 6f6e 3a20 576f 726b 6572 5374 6174 6520  on: WorkerState 
+0000a220: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2054  | None..    #: T
+0000a230: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
+0000a240: 6573 2074 6869 7320 7461 736b 2063 616e  es this task can
+0000a250: 2061 7574 6f6d 6174 6963 616c 6c79 2062   automatically b
+0000a260: 6520 7265 7472 6965 6420 696e 2063 6173  e retried in cas
+0000a270: 6520 6f66 2066 6169 6c75 7265 2e0a 2020  e of failure..  
+0000a280: 2020 233a 2049 6620 6120 7461 736b 2066    #: If a task f
+0000a290: 6169 6c73 2065 7865 6375 7469 6e67 2028  ails executing (
+0000a2a0: 7468 6520 776f 726b 6572 2072 6574 7572  the worker retur
+0000a2b0: 6e73 2077 6974 6820 616e 2065 7272 6f72  ns with an error
+0000a2c0: 292c 2069 7473 203a 6174 7472 3a60 7265  ), its :attr:`re
+0000a2d0: 7472 6965 7360 0a20 2020 2023 3a20 6174  tries`.    #: at
+0000a2e0: 7472 6962 7574 6520 6973 2063 6865 636b  tribute is check
+0000a2f0: 6564 2e20 4966 2069 7420 6973 2065 7175  ed. If it is equ
+0000a300: 616c 2074 6f20 302c 2074 6865 2074 6173  al to 0, the tas
+0000a310: 6b20 6973 206d 6172 6b65 6420 2265 7272  k is marked "err
+0000a320: 6564 222e 2049 6620 6974 2069 730a 2020  ed". If it is.  
+0000a330: 2020 233a 2067 7265 6174 6572 2074 6861    #: greater tha
+0000a340: 6e20 302c 2074 6865 203a 6174 7472 3a60  n 0, the :attr:`
+0000a350: 7265 7472 6965 7360 2061 7474 7269 6275  retries` attribu
+0000a360: 7465 2069 7320 6465 6372 656d 656e 7465  te is decremente
+0000a370: 6420 616e 6420 6578 6563 7574 696f 6e20  d and execution 
+0000a380: 6973 0a20 2020 2023 3a20 6174 7465 6d70  is.    #: attemp
+0000a390: 7465 6420 6167 6169 6e2e 0a20 2020 2072  ted again..    r
+0000a3a0: 6574 7269 6573 3a20 696e 740a 0a20 2020  etries: int..   
+0000a3b0: 2023 3a20 5468 6520 6e75 6d62 6572 206f   #: The number o
+0000a3c0: 6620 6279 7465 732c 2061 7320 6465 7465  f bytes, as dete
+0000a3d0: 726d 696e 6564 2062 7920 6060 7369 7a65  rmined by ``size
+0000a3e0: 6f66 6060 2c20 6f66 2074 6865 2072 6573  of``, of the res
+0000a3f0: 756c 7420 6f66 2061 2066 696e 6973 6865  ult of a finishe
+0000a400: 640a 2020 2020 233a 2074 6173 6b2e 2054  d.    #: task. T
+0000a410: 6869 7320 6e75 6d62 6572 2069 7320 7573  his number is us
+0000a420: 6564 2066 6f72 2064 6961 676e 6f73 7469  ed for diagnosti
+0000a430: 6373 2061 6e64 2074 6f20 6865 6c70 2070  cs and to help p
+0000a440: 7269 6f72 6974 697a 6520 776f 726b 2e0a  rioritize work..
+0000a450: 2020 2020 233a 2053 6574 2074 6f20 2d31      #: Set to -1
+0000a460: 2066 6f72 2075 6e66 696e 6973 6865 6420   for unfinished 
+0000a470: 7461 736b 732e 0a20 2020 206e 6279 7465  tasks..    nbyte
+0000a480: 733a 2069 6e74 0a0a 2020 2020 233a 2054  s: int..    #: T
+0000a490: 6865 2074 7970 6520 6f66 2074 6865 206f  he type of the o
+0000a4a0: 626a 6563 7420 6173 2061 2073 7472 696e  bject as a strin
+0000a4b0: 672e 204f 6e6c 7920 7072 6573 656e 7420  g. Only present 
+0000a4c0: 666f 7220 7461 736b 7320 7468 6174 2068  for tasks that h
+0000a4d0: 6176 6520 6265 656e 0a20 2020 2023 3a20  ave been.    #: 
+0000a4e0: 636f 6d70 7574 6564 2e0a 2020 2020 7479  computed..    ty
+0000a4f0: 7065 3a20 7374 720a 0a20 2020 2023 3a20  pe: str..    #: 
+0000a500: 4966 2074 6869 7320 7461 736b 2066 6169  If this task fai
+0000a510: 6c65 6420 6578 6563 7574 696e 672c 2074  led executing, t
+0000a520: 6865 2065 7863 6570 7469 6f6e 206f 626a  he exception obj
+0000a530: 6563 7420 6973 2073 746f 7265 6420 6865  ect is stored he
+0000a540: 7265 2e0a 2020 2020 6578 6365 7074 696f  re..    exceptio
+0000a550: 6e3a 2053 6572 6961 6c69 7a65 6420 7c20  n: Serialized | 
+0000a560: 4e6f 6e65 0a0a 2020 2020 233a 2049 6620  None..    #: If 
+0000a570: 7468 6973 2074 6173 6b20 6661 696c 6564  this task failed
+0000a580: 2065 7865 6375 7469 6e67 2c20 7468 6520   executing, the 
+0000a590: 7472 6163 6562 6163 6b20 6f62 6a65 6374  traceback object
+0000a5a0: 2069 7320 7374 6f72 6564 2068 6572 652e   is stored here.
+0000a5b0: 0a20 2020 2074 7261 6365 6261 636b 3a20  .    traceback: 
+0000a5c0: 5365 7269 616c 697a 6564 207c 204e 6f6e  Serialized | Non
+0000a5d0: 650a 0a20 2020 2023 3a20 7374 7269 6e67  e..    #: string
+0000a5e0: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
+0000a5f0: 6f66 2065 7863 6570 7469 6f6e 0a20 2020  of exception.   
+0000a600: 2065 7863 6570 7469 6f6e 5f74 6578 743a   exception_text:
+0000a610: 2073 7472 0a0a 2020 2020 233a 2073 7472   str..    #: str
+0000a620: 696e 6720 7265 7072 6573 656e 7461 7469  ing representati
+0000a630: 6f6e 206f 6620 7472 6163 6562 6163 6b0a  on of traceback.
+0000a640: 2020 2020 7472 6163 6562 6163 6b5f 7465      traceback_te
+0000a650: 7874 3a20 7374 720a 0a20 2020 2023 3a20  xt: str..    #: 
+0000a660: 4966 2074 6869 7320 7461 736b 206f 7220  If this task or 
+0000a670: 6f6e 6520 6f66 2069 7473 2064 6570 656e  one of its depen
+0000a680: 6465 6e63 6965 7320 6661 696c 6564 2065  dencies failed e
+0000a690: 7865 6375 7469 6e67 2c20 7468 6520 6661  xecuting, the fa
+0000a6a0: 696c 6564 2074 6173 6b20 6973 0a20 2020  iled task is.   
+0000a6b0: 2023 3a20 7374 6f72 6564 2068 6572 6520   #: stored here 
+0000a6c0: 2870 6f73 7369 626c 7920 6974 7365 6c66  (possibly itself
+0000a6d0: 292e 0a20 2020 2065 7863 6570 7469 6f6e  )..    exception
+0000a6e0: 5f62 6c61 6d65 3a20 5461 736b 5374 6174  _blame: TaskStat
+0000a6f0: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
+0000a700: 2057 6f72 6b65 7220 6164 6472 6573 7365   Worker addresse
+0000a710: 7320 6f6e 2077 6869 6368 2065 7272 6f72  s on which error
+0000a720: 7320 6170 7065 6172 6564 2c20 6361 7573  s appeared, caus
+0000a730: 696e 6720 7468 6973 2074 6173 6b20 746f  ing this task to
+0000a740: 2062 6520 696e 2061 6e20 6572 726f 720a   be in an error.
+0000a750: 2020 2020 233a 2073 7461 7465 2e0a 2020      #: state..  
+0000a760: 2020 6572 7265 645f 6f6e 3a20 7365 745b    erred_on: set[
+0000a770: 7374 725d 0a0a 2020 2020 233a 2054 6865  str]..    #: The
+0000a780: 206e 756d 6265 7220 6f66 2074 696d 6573   number of times
+0000a790: 2074 6869 7320 7461 736b 2068 6173 2062   this task has b
+0000a7a0: 6565 6e20 696e 766f 6c76 6564 2069 6e20  een involved in 
+0000a7b0: 6120 776f 726b 6572 2064 6561 7468 2e0a  a worker death..
+0000a7c0: 2020 2020 233a 0a20 2020 2023 3a20 536f      #:.    #: So
+0000a7d0: 6d65 2074 6173 6b73 206d 6179 2063 6175  me tasks may cau
+0000a7e0: 7365 2077 6f72 6b65 7273 2074 6f20 6469  se workers to di
+0000a7f0: 6520 2873 7563 6820 6173 2063 616c 6c69  e (such as calli
+0000a800: 6e67 2060 606f 732e 5f65 7869 7428 3029  ng ``os._exit(0)
+0000a810: 6060 292e 2057 6865 6e20 610a 2020 2020  ``). When a.    
+0000a820: 233a 2077 6f72 6b65 7220 6469 6573 2c20  #: worker dies, 
+0000a830: 616c 6c20 6f66 2074 6865 2074 6173 6b73  all of the tasks
+0000a840: 206f 6e20 7468 6174 2077 6f72 6b65 7220   on that worker 
+0000a850: 6172 6520 7265 6173 7369 676e 6564 2074  are reassigned t
+0000a860: 6f20 6f74 6865 7273 2e20 5468 6973 0a20  o others. This. 
+0000a870: 2020 2023 3a20 636f 6d62 696e 6174 696f     #: combinatio
+0000a880: 6e20 6f66 2062 6568 6176 696f 7273 2063  n of behaviors c
+0000a890: 616e 2063 6175 7365 2061 2062 6164 2074  an cause a bad t
+0000a8a0: 6173 6b20 746f 2063 6174 6173 7472 6f70  ask to catastrop
+0000a8b0: 6869 6361 6c6c 7920 6465 7374 726f 7920  hically destroy 
+0000a8c0: 616c 6c0a 2020 2020 233a 2077 6f72 6b65  all.    #: worke
+0000a8d0: 7273 206f 6e20 7468 6520 636c 7573 7465  rs on the cluste
+0000a8e0: 722c 206f 6e65 2061 6674 6572 2061 6e6f  r, one after ano
+0000a8f0: 7468 6572 2e20 5768 656e 6576 6572 2061  ther. Whenever a
+0000a900: 2077 6f72 6b65 7220 6469 6573 2c20 7765   worker dies, we
+0000a910: 206d 6172 6b20 6561 6368 0a20 2020 2023   mark each.    #
+0000a920: 3a20 7461 736b 2063 7572 7265 6e74 6c79  : task currently
+0000a930: 2070 726f 6365 7373 696e 6720 6f6e 2074   processing on t
+0000a940: 6861 7420 776f 726b 6572 2028 6173 2072  hat worker (as r
+0000a950: 6563 6f72 6465 6420 6279 0a20 2020 2023  ecorded by.    #
+0000a960: 3a20 3a61 7474 723a 6057 6f72 6b65 7253  : :attr:`WorkerS
+0000a970: 7461 7465 2e70 726f 6365 7373 696e 6760  tate.processing`
+0000a980: 2920 6173 2073 7573 7069 6369 6f75 732e  ) as suspicious.
+0000a990: 2049 6620 6120 7461 736b 2069 7320 696e   If a task is in
+0000a9a0: 766f 6c76 6564 2069 6e20 7468 7265 650a  volved in three.
+0000a9b0: 2020 2020 233a 2064 6561 7468 7320 286f      #: deaths (o
+0000a9c0: 7220 736f 6d65 206f 7468 6572 2066 6978  r some other fix
+0000a9d0: 6564 2063 6f6e 7374 616e 7429 2074 6865  ed constant) the
+0000a9e0: 6e20 7765 206d 6172 6b20 7468 6520 7461  n we mark the ta
+0000a9f0: 736b 2061 7320 6060 6572 7265 6460 602e  sk as ``erred``.
+0000aa00: 0a20 2020 2073 7573 7069 6369 6f75 733a  .    suspicious:
+0000aa10: 2069 6e74 0a0a 2020 2020 233a 2041 2073   int..    #: A s
+0000aa20: 6574 206f 6620 686f 7374 6e61 6d65 7320  et of hostnames 
+0000aa30: 7768 6572 6520 7468 6973 2074 6173 6b20  where this task 
+0000aa40: 6361 6e20 6265 2072 756e 2028 6f72 2060  can be run (or `
+0000aa50: 604e 6f6e 6560 6020 6966 2065 6d70 7479  `None`` if empty
+0000aa60: 292e 2055 7375 616c 6c79 0a20 2020 2023  ). Usually.    #
+0000aa70: 3a20 7468 6973 2069 7320 656d 7074 7920  : this is empty 
+0000aa80: 756e 6c65 7373 2074 6865 2074 6173 6b20  unless the task 
+0000aa90: 6861 7320 6265 656e 2073 7065 6369 6669  has been specifi
+0000aaa0: 6361 6c6c 7920 7265 7374 7269 6374 6564  cally restricted
+0000aab0: 2074 6f20 6f6e 6c79 2072 756e 206f 6e0a   to only run on.
+0000aac0: 2020 2020 233a 2063 6572 7461 696e 2068      #: certain h
+0000aad0: 6f73 7473 2e20 4120 686f 7374 6e61 6d65  osts. A hostname
+0000aae0: 206d 6179 2063 6f72 7265 7370 6f6e 6420   may correspond 
+0000aaf0: 746f 206f 6e65 206f 7220 7365 7665 7261  to one or severa
+0000ab00: 6c20 636f 6e6e 6563 7465 6420 776f 726b  l connected work
+0000ab10: 6572 732e 0a20 2020 2068 6f73 745f 7265  ers..    host_re
+0000ab20: 7374 7269 6374 696f 6e73 3a20 7365 745b  strictions: set[
+0000ab30: 7374 725d 0a0a 2020 2020 233a 2041 2073  str]..    #: A s
+0000ab40: 6574 206f 6620 636f 6d70 6c65 7465 2077  et of complete w
+0000ab50: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
+0000ab60: 7768 6572 6520 7468 6973 2063 616e 2062  where this can b
+0000ab70: 6520 7275 6e20 286f 7220 6060 4e6f 6e65  e run (or ``None
+0000ab80: 6060 2069 6620 656d 7074 7929 2e0a 2020  `` if empty)..  
+0000ab90: 2020 233a 2055 7375 616c 6c79 2074 6869    #: Usually thi
+0000aba0: 7320 6973 2065 6d70 7479 2075 6e6c 6573  s is empty unles
+0000abb0: 7320 7468 6520 7461 736b 2068 6173 2062  s the task has b
+0000abc0: 6565 6e20 7370 6563 6966 6963 616c 6c79  een specifically
+0000abd0: 2072 6573 7472 6963 7465 6420 746f 206f   restricted to o
+0000abe0: 6e6c 790a 2020 2020 233a 2072 756e 206f  nly.    #: run o
+0000abf0: 6e20 6365 7274 6169 6e20 776f 726b 6572  n certain worker
+0000ac00: 732e 0a20 2020 2023 3a20 4e6f 7465 2074  s..    #: Note t
+0000ac10: 6869 7320 6973 2074 7261 636b 696e 6720  his is tracking 
+0000ac20: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
+0000ac30: 2c20 6e6f 7420 776f 726b 6572 2073 7461  , not worker sta
+0000ac40: 7465 732c 2073 696e 6365 2074 6865 2073  tes, since the s
+0000ac50: 7065 6369 6669 630a 2020 2020 233a 2077  pecific.    #: w
+0000ac60: 6f72 6b65 7273 206d 6179 206e 6f74 2062  orkers may not b
+0000ac70: 6520 636f 6e6e 6563 7465 6420 6174 2074  e connected at t
+0000ac80: 6869 7320 7469 6d65 2e0a 2020 2020 776f  his time..    wo
+0000ac90: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
+0000aca0: 733a 2073 6574 5b73 7472 5d0a 0a20 2020  s: set[str]..   
+0000acb0: 2023 3a20 5265 736f 7572 6365 7320 7265   #: Resources re
+0000acc0: 7175 6972 6564 2062 7920 7468 6973 2074  quired by this t
+0000acd0: 6173 6b2c 2073 7563 6820 6173 2060 607b  ask, such as ``{
+0000ace0: 2767 7075 273a 2031 7d60 6020 6f72 2060  'gpu': 1}`` or `
+0000acf0: 607b 276d 656d 6f72 7927 3a20 3165 397d  `{'memory': 1e9}
+0000ad00: 6060 0a20 2020 2023 3a20 5468 6573 6520  ``.    #: These 
+0000ad10: 6172 6520 7573 6572 2d64 6566 696e 6564  are user-defined
+0000ad20: 206e 616d 6573 2061 6e64 2061 7265 206d   names and are m
+0000ad30: 6174 6368 6564 2061 6761 696e 7374 2074  atched against t
+0000ad40: 6865 203a 2063 6f6e 7465 6e74 7320 6f66  he : contents of
+0000ad50: 2065 6163 680a 2020 2020 233a 203a 6174   each.    #: :at
+0000ad60: 7472 3a60 576f 726b 6572 5374 6174 652e  tr:`WorkerState.
+0000ad70: 7265 736f 7572 6365 7360 2064 6963 7469  resources` dicti
+0000ad80: 6f6e 6172 792e 0a20 2020 2072 6573 6f75  onary..    resou
+0000ad90: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+0000ada0: 3a20 6469 6374 5b73 7472 2c20 666c 6f61  : dict[str, floa
+0000adb0: 745d 0a0a 2020 2020 233a 2046 616c 7365  t]..    #: False
+0000adc0: 0a20 2020 2023 3a20 2020 2020 4561 6368  .    #:     Each
+0000add0: 206f 6620 3a61 7474 723a 6068 6f73 745f   of :attr:`host_
+0000ade0: 7265 7374 7269 6374 696f 6e73 602c 203a  restrictions`, :
+0000adf0: 6174 7472 3a60 776f 726b 6572 5f72 6573  attr:`worker_res
+0000ae00: 7472 6963 7469 6f6e 7360 2061 6e64 0a20  trictions` and. 
+0000ae10: 2020 2023 3a20 2020 2020 3a61 7474 723a     #:     :attr:
+0000ae20: 6072 6573 6f75 7263 655f 7265 7374 7269  `resource_restri
+0000ae30: 6374 696f 6e73 6020 6973 2061 2068 6172  ctions` is a har
+0000ae40: 6420 636f 6e73 7472 6169 6e74 3a20 6966  d constraint: if
+0000ae50: 206e 6f20 776f 726b 6572 2069 7320 6176   no worker is av
+0000ae60: 6169 6c61 626c 650a 2020 2020 233a 2020  ailable.    #:  
+0000ae70: 2020 2073 6174 6973 6679 696e 6720 7468     satisfying th
+0000ae80: 6f73 6520 7265 7374 7269 6374 696f 6e73  ose restrictions
+0000ae90: 2c20 7468 6520 7461 736b 2063 616e 6e6f  , the task canno
+0000aea0: 7420 676f 2069 6e74 6f20 7468 6520 2270  t go into the "p
+0000aeb0: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
+0000aec0: 0a20 2020 2023 3a20 2020 2020 616e 6420  .    #:     and 
+0000aed0: 7769 6c6c 2069 6e73 7465 6164 2067 6f20  will instead go 
+0000aee0: 696e 746f 2074 6865 2022 6e6f 2d77 6f72  into the "no-wor
+0000aef0: 6b65 7222 2073 7461 7465 2e0a 2020 2020  ker" state..    
+0000af00: 233a 2054 7275 650a 2020 2020 233a 2020  #: True.    #:  
+0000af10: 2020 2054 6865 2061 626f 7665 2072 6573     The above res
+0000af20: 7472 6963 7469 6f6e 7320 6172 6520 6d65  trictions are me
+0000af30: 7265 2070 7265 6665 7265 6e63 6573 3a20  re preferences: 
+0000af40: 6966 206e 6f20 776f 726b 6572 2069 7320  if no worker is 
+0000af50: 6176 6169 6c61 626c 650a 2020 2020 233a  available.    #:
+0000af60: 2020 2020 2073 6174 6973 6679 696e 6720       satisfying 
+0000af70: 7468 6f73 6520 7265 7374 7269 6374 696f  those restrictio
+0000af80: 6e73 2c20 7468 6520 7461 736b 2063 616e  ns, the task can
+0000af90: 2073 7469 6c6c 2067 6f20 696e 746f 2074   still go into t
+0000afa0: 6865 0a20 2020 2023 3a20 2020 2020 2270  he.    #:     "p
+0000afb0: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
+0000afc0: 2061 6e64 2062 6520 7365 6e74 2066 6f72   and be sent for
+0000afd0: 2065 7865 6375 7469 6f6e 2074 6f20 616e   execution to an
+0000afe0: 6f74 6865 7220 636f 6e6e 6563 7465 6420  other connected 
+0000aff0: 776f 726b 6572 2e0a 2020 2020 6c6f 6f73  worker..    loos
+0000b000: 655f 7265 7374 7269 6374 696f 6e73 3a20  e_restrictions: 
+0000b010: 626f 6f6c 0a0a 2020 2020 233a 2057 6865  bool..    #: Whe
+0000b020: 7468 6572 2074 6869 7320 7461 736b 2069  ther this task i
+0000b030: 7320 616e 2041 6374 6f72 0a20 2020 2061  s an Actor.    a
+0000b040: 6374 6f72 3a20 626f 6f6c 0a0a 2020 2020  ctor: bool..    
+0000b050: 233a 2054 6865 2067 726f 7570 206f 6620  #: The group of 
+0000b060: 7461 736b 7320 746f 2077 6869 6368 2074  tasks to which t
+0000b070: 6869 7320 6f6e 6520 6265 6c6f 6e67 730a  his one belongs.
+0000b080: 2020 2020 6772 6f75 703a 2054 6173 6b47      group: TaskG
+0000b090: 726f 7570 0a0a 2020 2020 233a 2053 616d  roup..    #: Sam
+0000b0a0: 6520 6173 206f 6620 6772 6f75 702e 6e61  e as of group.na
+0000b0b0: 6d65 0a20 2020 2067 726f 7570 5f6b 6579  me.    group_key
+0000b0c0: 3a20 7374 720a 0a20 2020 2023 3a20 4d65  : str..    #: Me
+0000b0d0: 7461 6461 7461 2072 656c 6174 6564 2074  tadata related t
+0000b0e0: 6f20 7461 736b 0a20 2020 206d 6574 6164  o task.    metad
+0000b0f0: 6174 613a 2064 6963 745b 7374 722c 2041  ata: dict[str, A
+0000b100: 6e79 5d0a 0a20 2020 2023 3a20 5461 736b  ny]..    #: Task
+0000b110: 2061 6e6e 6f74 6174 696f 6e73 0a20 2020   annotations.   
+0000b120: 2061 6e6e 6f74 6174 696f 6e73 3a20 6469   annotations: di
+0000b130: 6374 5b73 7472 2c20 416e 795d 0a0a 2020  ct[str, Any]..  
+0000b140: 2020 233a 2054 6865 2075 6e69 7175 6520    #: The unique 
+0000b150: 6964 656e 7469 6669 6572 206f 6620 6120  identifier of a 
+0000b160: 7370 6563 6966 6963 2065 7865 6375 7469  specific executi
+0000b170: 6f6e 206f 6620 6120 7461 736b 2e20 5468  on of a task. Th
+0000b180: 6973 2069 6465 6e74 6966 6965 720a 2020  is identifier.  
+0000b190: 2020 233a 2069 7320 7573 6564 2074 6f20    #: is used to 
+0000b1a0: 7369 676e 2061 2074 6173 6b20 7375 6368  sign a task such
+0000b1b0: 2074 6861 7420 7468 6520 6173 7369 676e   that the assign
+0000b1c0: 6564 2077 6f72 6b65 7220 6973 2065 7870  ed worker is exp
+0000b1d0: 6563 7465 6420 746f 2072 6574 7572 6e0a  ected to return.
+0000b1e0: 2020 2020 233a 2074 6865 2073 616d 6520      #: the same 
+0000b1f0: 6964 656e 7469 6669 6572 2069 6e20 7468  identifier in th
+0000b200: 6520 7461 736b 2d66 696e 6973 6865 6420  e task-finished 
+0000b210: 6d65 7373 6167 652e 2054 6869 7320 6973  message. This is
+0000b220: 2075 7365 6420 746f 2063 6f72 7265 6c61   used to correla
+0000b230: 7465 0a20 2020 2023 3a20 7265 7370 6f6e  te.    #: respon
+0000b240: 7365 732e 0a20 2020 2023 3a20 4f6e 6c79  ses..    #: Only
+0000b250: 2074 6865 206d 6f73 7420 7265 6365 6e74   the most recent
+0000b260: 6c79 2061 7373 6967 6e65 6420 776f 726b  ly assigned work
+0000b270: 6572 2069 7320 7472 7573 7465 642e 2041  er is trusted. A
+0000b280: 6c6c 206f 7468 6572 2072 6573 756c 7473  ll other results
+0000b290: 2077 696c 6c0a 2020 2020 233a 2062 6520   will.    #: be 
+0000b2a0: 7265 6a65 6374 6564 2e0a 2020 2020 7275  rejected..    ru
+0000b2b0: 6e5f 6964 3a20 696e 7420 7c20 4e6f 6e65  n_id: int | None
+0000b2c0: 0a0a 2020 2020 233a 2043 6163 6865 6420  ..    #: Cached 
+0000b2d0: 6861 7368 206f 6620 3a61 7474 723a 607e  hash of :attr:`~
+0000b2e0: 5461 736b 5374 6174 652e 636c 6965 6e74  TaskState.client
+0000b2f0: 5f6b 6579 600a 2020 2020 5f68 6173 683a  _key`.    _hash:
+0000b300: 2069 6e74 0a0a 2020 2020 2320 5375 7070   int..    # Supp
+0000b310: 6f72 7420 666f 7220 7765 616b 7265 6673  ort for weakrefs
+0000b320: 2074 6f20 6120 636c 6173 7320 7769 7468   to a class with
+0000b330: 205f 5f73 6c6f 7473 5f5f 0a20 2020 205f   __slots__.    _
+0000b340: 5f77 6561 6b72 6566 5f5f 3a20 416e 7920  _weakref__: Any 
+0000b350: 3d20 4e6f 6e65 0a20 2020 205f 5f73 6c6f  = None.    __slo
+0000b360: 7473 5f5f 203d 2074 7570 6c65 285f 5f61  ts__ = tuple(__a
+0000b370: 6e6e 6f74 6174 696f 6e73 5f5f 290a 0a20  nnotations__).. 
+0000b380: 2020 2023 3a20 476c 6f62 616c 2069 7465     #: Global ite
+0000b390: 7261 746f 7220 7573 6564 2074 6f20 6372  rator used to cr
+0000b3a0: 6561 7465 2075 6e69 7175 6520 7461 736b  eate unique task
+0000b3b0: 2072 756e 2049 4473 0a20 2020 205f 7275   run IDs.    _ru
+0000b3c0: 6e5f 6964 5f69 7465 7261 746f 723a 2043  n_id_iterator: C
+0000b3d0: 6c61 7373 5661 725b 6974 6572 746f 6f6c  lassVar[itertool
+0000b3e0: 732e 636f 756e 745d 203d 2069 7465 7274  s.count] = itert
+0000b3f0: 6f6f 6c73 2e63 6f75 6e74 2829 0a0a 2020  ools.count()..  
+0000b400: 2020 2320 496e 7374 616e 6365 7320 6e6f    # Instances no
+0000b410: 7420 7061 7274 206f 6620 736c 6f74 7320  t part of slots 
+0000b420: 7369 6e63 6520 636c 6173 7320 7661 7269  since class vari
+0000b430: 6162 6c65 0a20 2020 205f 696e 7374 616e  able.    _instan
+0000b440: 6365 733a 2043 6c61 7373 5661 725b 7765  ces: ClassVar[we
+0000b450: 616b 7265 662e 5765 616b 5365 745b 5461  akref.WeakSet[Ta
+0000b460: 736b 5374 6174 655d 5d20 3d20 7765 616b  skState]] = weak
+0000b470: 7265 662e 5765 616b 5365 7428 290a 0a20  ref.WeakSet().. 
+0000b480: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0000b490: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0000b4a0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
+0000b4b0: 0a20 2020 2020 2020 2072 756e 5f73 7065  .        run_spe
+0000b4c0: 633a 206f 626a 6563 742c 0a20 2020 2020  c: object,.     
+0000b4d0: 2020 2073 7461 7465 3a20 5461 736b 5374     state: TaskSt
+0000b4e0: 6174 6553 7461 7465 2c0a 2020 2020 293a  ateState,.    ):
+0000b4f0: 0a20 2020 2020 2020 2073 656c 662e 6b65  .        self.ke
+0000b500: 7920 3d20 6b65 790a 2020 2020 2020 2020  y = key.        
+0000b510: 7365 6c66 2e5f 6861 7368 203d 2068 6173  self._hash = has
+0000b520: 6828 6b65 7929 0a20 2020 2020 2020 2073  h(key).        s
+0000b530: 656c 662e 7275 6e5f 7370 6563 203d 2072  elf.run_spec = r
+0000b540: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
+0000b550: 7365 6c66 2e5f 7374 6174 6520 3d20 7374  self._state = st
+0000b560: 6174 650a 2020 2020 2020 2020 7365 6c66  ate.        self
+0000b570: 2e65 7863 6570 7469 6f6e 203d 204e 6f6e  .exception = Non
+0000b580: 650a 2020 2020 2020 2020 7365 6c66 2e65  e.        self.e
+0000b590: 7863 6570 7469 6f6e 5f62 6c61 6d65 203d  xception_blame =
+0000b5a0: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+0000b5b0: 6c66 2e74 7261 6365 6261 636b 203d 204e  lf.traceback = N
+0000b5c0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000b5d0: 2e65 7863 6570 7469 6f6e 5f74 6578 7420  .exception_text 
+0000b5e0: 3d20 2222 0a20 2020 2020 2020 2073 656c  = "".        sel
+0000b5f0: 662e 7472 6163 6562 6163 6b5f 7465 7874  f.traceback_text
+0000b600: 203d 2022 220a 2020 2020 2020 2020 7365   = "".        se
+0000b610: 6c66 2e73 7573 7069 6369 6f75 7320 3d20  lf.suspicious = 
+0000b620: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
+0000b630: 6574 7269 6573 203d 2030 0a20 2020 2020  etries = 0.     
+0000b640: 2020 2073 656c 662e 6e62 7974 6573 203d     self.nbytes =
+0000b650: 202d 310a 2020 2020 2020 2020 7365 6c66   -1.        self
+0000b660: 2e70 7269 6f72 6974 7920 3d20 4e6f 6e65  .priority = None
+0000b670: 0a20 2020 2020 2020 2073 656c 662e 7768  .        self.wh
+0000b680: 6f5f 7761 6e74 7320 3d20 7365 7428 290a  o_wants = set().
+0000b690: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
+0000b6a0: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
+0000b6b0: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
+0000b6c0: 6570 656e 6465 6e74 7320 3d20 7365 7428  ependents = set(
+0000b6d0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0000b6e0: 6169 7469 6e67 5f6f 6e20 3d20 7365 7428  aiting_on = set(
+0000b6f0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0000b700: 6169 7465 7273 203d 2073 6574 2829 0a20  aiters = set(). 
+0000b710: 2020 2020 2020 2073 656c 662e 7768 6f5f         self.who_
+0000b720: 6861 7320 3d20 7365 7428 290a 2020 2020  has = set().    
+0000b730: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
+0000b740: 696e 675f 6f6e 203d 204e 6f6e 650a 2020  ing_on = None.  
+0000b750: 2020 2020 2020 7365 6c66 2e68 6173 5f6c        self.has_l
+0000b760: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+0000b770: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0000b780: 2073 656c 662e 686f 7374 5f72 6573 7472   self.host_restr
+0000b790: 6963 7469 6f6e 7320 3d20 7365 7428 290a  ictions = set().
+0000b7a0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+0000b7b0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+0000b7c0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+0000b7d0: 2073 656c 662e 7265 736f 7572 6365 5f72   self.resource_r
+0000b7e0: 6573 7472 6963 7469 6f6e 7320 3d20 7b7d  estrictions = {}
+0000b7f0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0000b800: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
+0000b810: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0000b820: 2073 656c 662e 6163 746f 7220 3d20 4661   self.actor = Fa
+0000b830: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+0000b840: 2e70 7265 6669 7820 3d20 4e6f 6e65 2020  .prefix = None  
+0000b850: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+0000b860: 2020 2020 2020 2073 656c 662e 7479 7065         self.type
+0000b870: 203d 204e 6f6e 6520 2023 2074 7970 653a   = None  # type:
+0000b880: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+0000b890: 7365 6c66 2e67 726f 7570 5f6b 6579 203d  self.group_key =
+0000b8a0: 206b 6579 5f73 706c 6974 5f67 726f 7570   key_split_group
+0000b8b0: 286b 6579 290a 2020 2020 2020 2020 7365  (key).        se
+0000b8c0: 6c66 2e67 726f 7570 203d 204e 6f6e 6520  lf.group = None 
+0000b8d0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+0000b8e0: 2020 2020 2020 2020 7365 6c66 2e6d 6574          self.met
+0000b8f0: 6164 6174 6120 3d20 7b7d 0a20 2020 2020  adata = {}.     
+0000b900: 2020 2073 656c 662e 616e 6e6f 7461 7469     self.annotati
+0000b910: 6f6e 7320 3d20 7b7d 0a20 2020 2020 2020  ons = {}.       
+0000b920: 2073 656c 662e 6572 7265 645f 6f6e 203d   self.erred_on =
+0000b930: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
+0000b940: 656c 662e 7275 6e5f 6964 203d 204e 6f6e  elf.run_id = Non
+0000b950: 650a 2020 2020 2020 2020 5461 736b 5374  e.        TaskSt
+0000b960: 6174 652e 5f69 6e73 7461 6e63 6573 2e61  ate._instances.a
+0000b970: 6464 2873 656c 6629 0a0a 2020 2020 6465  dd(self)..    de
+0000b980: 6620 5f5f 6861 7368 5f5f 2873 656c 6629  f __hash__(self)
+0000b990: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+0000b9a0: 2072 6574 7572 6e20 7365 6c66 2e5f 6861   return self._ha
+0000b9b0: 7368 0a0a 2020 2020 6465 6620 5f5f 6571  sh..    def __eq
+0000b9c0: 5f5f 2873 656c 662c 206f 7468 6572 3a20  __(self, other: 
+0000b9d0: 6f62 6a65 6374 2920 2d3e 2062 6f6f 6c3a  object) -> bool:
+0000b9e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b9f0: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
+0000ba00: 2c20 5461 736b 5374 6174 6529 2061 6e64  , TaskState) and
+0000ba10: 2073 656c 662e 6b65 7920 3d3d 206f 7468   self.key == oth
+0000ba20: 6572 2e6b 6579 0a0a 2020 2020 4070 726f  er.key..    @pro
+0000ba30: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
+0000ba40: 6174 6528 7365 6c66 2920 2d3e 2054 6173  ate(self) -> Tas
+0000ba50: 6b53 7461 7465 5374 6174 653a 0a20 2020  kStateState:.   
+0000ba60: 2020 2020 2022 2222 5468 6973 2074 6173       """This tas
+0000ba70: 6b27 7320 6375 7272 656e 7420 7374 6174  k's current stat
+0000ba80: 652e 2020 5661 6c69 6420 7374 6174 6573  e.  Valid states
+0000ba90: 2061 7265 2060 6072 656c 6561 7365 6460   are ``released`
+0000baa0: 602c 2060 6077 6169 7469 6e67 6060 2c0a  `, ``waiting``,.
+0000bab0: 2020 2020 2020 2020 6060 6e6f 2d77 6f72          ``no-wor
+0000bac0: 6b65 7260 602c 2060 6070 726f 6365 7373  ker``, ``process
+0000bad0: 696e 6760 602c 2060 606d 656d 6f72 7960  ing``, ``memory`
+0000bae0: 602c 2060 6065 7272 6564 6060 2061 6e64  `, ``erred`` and
+0000baf0: 2060 6066 6f72 676f 7474 656e 6060 2e20   ``forgotten``. 
+0000bb00: 2049 6620 6974 0a20 2020 2020 2020 2069   If it.        i
+0000bb10: 7320 6060 666f 7267 6f74 7465 6e60 602c  s ``forgotten``,
+0000bb20: 2074 6865 2074 6173 6b20 6973 6e27 7420   the task isn't 
+0000bb30: 7374 6f72 6564 2069 6e20 7468 6520 6060  stored in the ``
+0000bb40: 7461 736b 7360 6020 6469 6374 696f 6e61  tasks`` dictiona
+0000bb50: 7279 2061 6e79 6d6f 7265 2061 6e64 0a20  ry anymore and. 
+0000bb60: 2020 2020 2020 2077 696c 6c20 7072 6f62         will prob
+0000bb70: 6162 6c79 2064 6973 6170 7065 6172 2073  ably disappear s
+0000bb80: 6f6f 6e20 6672 6f6d 206d 656d 6f72 792e  oon from memory.
+0000bb90: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000bba0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000bbb0: 2e5f 7374 6174 650a 0a20 2020 2040 7374  ._state..    @st
+0000bbc0: 6174 652e 7365 7474 6572 0a20 2020 2064  ate.setter.    d
+0000bbd0: 6566 2073 7461 7465 2873 656c 662c 2076  ef state(self, v
+0000bbe0: 616c 7565 3a20 5461 736b 5374 6174 6553  alue: TaskStateS
+0000bbf0: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+0000bc00: 2020 2020 2020 2073 656c 662e 6772 6f75         self.grou
+0000bc10: 702e 7374 6174 6573 5b73 656c 662e 5f73  p.states[self._s
+0000bc20: 7461 7465 5d20 2d3d 2031 0a20 2020 2020  tate] -= 1.     
+0000bc30: 2020 2073 656c 662e 6772 6f75 702e 7374     self.group.st
+0000bc40: 6174 6573 5b76 616c 7565 5d20 2b3d 2031  ates[value] += 1
+0000bc50: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
+0000bc60: 7461 7465 203d 2076 616c 7565 0a20 2020  tate = value.   
+0000bc70: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
+0000bc80: 2e73 7461 7465 5f63 6f75 6e74 735b 7661  .state_counts[va
+0000bc90: 6c75 655d 202b 3d20 310a 0a20 2020 2064  lue] += 1..    d
+0000bca0: 6566 2061 6464 5f64 6570 656e 6465 6e63  ef add_dependenc
+0000bcb0: 7928 7365 6c66 2c20 6f74 6865 723a 2054  y(self, other: T
+0000bcc0: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+0000bcd0: 653a 0a20 2020 2020 2020 2022 2222 4164  e:.        """Ad
+0000bce0: 6420 616e 6f74 6865 7220 7461 736b 2061  d another task a
+0000bcf0: 7320 6120 6465 7065 6e64 656e 6379 206f  s a dependency o
+0000bd00: 6620 7468 6973 2074 6173 6b22 2222 0a20  f this task""". 
+0000bd10: 2020 2020 2020 2073 656c 662e 6465 7065         self.depe
+0000bd20: 6e64 656e 6369 6573 2e61 6464 286f 7468  ndencies.add(oth
+0000bd30: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
+0000bd40: 2e67 726f 7570 2e64 6570 656e 6465 6e63  .group.dependenc
+0000bd50: 6965 732e 6164 6428 6f74 6865 722e 6772  ies.add(other.gr
+0000bd60: 6f75 7029 0a20 2020 2020 2020 206f 7468  oup).        oth
+0000bd70: 6572 2e64 6570 656e 6465 6e74 732e 6164  er.dependents.ad
+0000bd80: 6428 7365 6c66 290a 0a20 2020 2064 6566  d(self)..    def
+0000bd90: 2067 6574 5f6e 6279 7465 7328 7365 6c66   get_nbytes(self
+0000bda0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+0000bdb0: 2020 7265 7475 726e 2073 656c 662e 6e62    return self.nb
+0000bdc0: 7974 6573 2069 6620 7365 6c66 2e6e 6279  ytes if self.nby
+0000bdd0: 7465 7320 3e3d 2030 2065 6c73 6520 4445  tes >= 0 else DE
+0000bde0: 4641 554c 545f 4441 5441 5f53 495a 450a  FAULT_DATA_SIZE.
+0000bdf0: 0a20 2020 2064 6566 2073 6574 5f6e 6279  .    def set_nby
+0000be00: 7465 7328 7365 6c66 2c20 6e62 7974 6573  tes(self, nbytes
+0000be10: 3a20 696e 7429 202d 3e20 4e6f 6e65 3a0a  : int) -> None:.
+0000be20: 2020 2020 2020 2020 6469 6666 203d 206e          diff = n
+0000be30: 6279 7465 730a 2020 2020 2020 2020 6f6c  bytes.        ol
+0000be40: 645f 6e62 7974 6573 203d 2073 656c 662e  d_nbytes = self.
+0000be50: 6e62 7974 6573 0a20 2020 2020 2020 2069  nbytes.        i
+0000be60: 6620 6f6c 645f 6e62 7974 6573 203e 3d20  f old_nbytes >= 
+0000be70: 303a 0a20 2020 2020 2020 2020 2020 2064  0:.            d
+0000be80: 6966 6620 2d3d 206f 6c64 5f6e 6279 7465  iff -= old_nbyte
+0000be90: 730a 2020 2020 2020 2020 7365 6c66 2e67  s.        self.g
+0000bea0: 726f 7570 2e6e 6279 7465 735f 746f 7461  roup.nbytes_tota
+0000beb0: 6c20 2b3d 2064 6966 660a 2020 2020 2020  l += diff.      
+0000bec0: 2020 666f 7220 7773 2069 6e20 7365 6c66    for ws in self
+0000bed0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+0000bee0: 2020 2020 2020 7773 2e6e 6279 7465 7320        ws.nbytes 
+0000bef0: 2b3d 2064 6966 660a 2020 2020 2020 2020  += diff.        
+0000bf00: 7365 6c66 2e6e 6279 7465 7320 3d20 6e62  self.nbytes = nb
+0000bf10: 7974 6573 0a0a 2020 2020 6465 6620 5f5f  ytes..    def __
+0000bf20: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
+0000bf30: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
+0000bf40: 7572 6e20 6622 3c54 6173 6b53 7461 7465  urn f"<TaskState
+0000bf50: 207b 7365 6c66 2e6b 6579 2172 7d20 7b73   {self.key!r} {s
+0000bf60: 656c 662e 5f73 7461 7465 7d3e 220a 0a20  elf._state}>".. 
+0000bf70: 2020 2064 6566 205f 7265 7072 5f68 746d     def _repr_htm
+0000bf80: 6c5f 2873 656c 6629 202d 3e20 7374 723a  l_(self) -> str:
+0000bf90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000bfa0: 6765 745f 7465 6d70 6c61 7465 2822 7461  get_template("ta
+0000bfb0: 736b 5f73 7461 7465 2e68 746d 6c2e 6a32  sk_state.html.j2
+0000bfc0: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
+0000bfd0: 2020 2020 2020 2073 7461 7465 3d73 656c         state=sel
+0000bfe0: 662e 7374 6174 652c 0a20 2020 2020 2020  f.state,.       
+0000bff0: 2020 2020 206e 6279 7465 733d 7365 6c66       nbytes=self
+0000c000: 2e6e 6279 7465 732c 0a20 2020 2020 2020  .nbytes,.       
+0000c010: 2020 2020 206b 6579 3d73 656c 662e 6b65       key=self.ke
+0000c020: 792c 0a20 2020 2020 2020 2029 0a0a 2020  y,.        )..  
+0000c030: 2020 6465 6620 7661 6c69 6461 7465 2873    def validate(s
+0000c040: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
+0000c050: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000c060: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
+0000c070: 2073 656c 662e 7768 6f5f 7761 6e74 733a   self.who_wants:
+0000c080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c090: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0000c0a0: 6365 2863 732c 2043 6c69 656e 7453 7461  ce(cs, ClientSta
+0000c0b0: 7465 292c 2028 7265 7072 2863 7329 2c20  te), (repr(cs), 
+0000c0c0: 7365 6c66 2e77 686f 5f77 616e 7473 290a  self.who_wants).
+0000c0d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000c0e0: 7773 2069 6e20 7365 6c66 2e77 686f 5f68  ws in self.who_h
+0000c0f0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+0000c100: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000c110: 7461 6e63 6528 7773 2c20 576f 726b 6572  tance(ws, Worker
+0000c120: 5374 6174 6529 2c20 2872 6570 7228 7773  State), (repr(ws
+0000c130: 292c 2073 656c 662e 7768 6f5f 6861 7329  ), self.who_has)
+0000c140: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000c150: 2074 7320 696e 2073 656c 662e 6465 7065   ts in self.depe
+0000c160: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+0000c170: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000c180: 2069 7369 6e73 7461 6e63 6528 7473 2c20   isinstance(ts, 
+0000c190: 5461 736b 5374 6174 6529 2c20 2872 6570  TaskState), (rep
+0000c1a0: 7228 7473 292c 2073 656c 662e 6465 7065  r(ts), self.depe
+0000c1b0: 6e64 656e 6369 6573 290a 2020 2020 2020  ndencies).      
+0000c1c0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+0000c1d0: 7365 6c66 2e64 6570 656e 6465 6e74 733a  self.dependents:
+0000c1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c1f0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0000c200: 6365 2874 732c 2054 6173 6b53 7461 7465  ce(ts, TaskState
+0000c210: 292c 2028 7265 7072 2874 7329 2c20 7365  ), (repr(ts), se
+0000c220: 6c66 2e64 6570 656e 6465 6e74 7329 0a20  lf.dependents). 
+0000c230: 2020 2020 2020 2020 2020 2076 616c 6964             valid
+0000c240: 6174 655f 7461 736b 5f73 7461 7465 2873  ate_task_state(s
+0000c250: 656c 6629 0a20 2020 2020 2020 2065 7863  elf).        exc
+0000c260: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0000c270: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000c280: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+0000c290: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
+0000c2a0: 6966 204c 4f47 5f50 4442 3a0a 2020 2020  if LOG_PDB:.    
+0000c2b0: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+0000c2c0: 7274 2070 6462 0a0a 2020 2020 2020 2020  rt pdb..        
+0000c2d0: 2020 2020 2020 2020 7064 622e 7365 745f          pdb.set_
+0000c2e0: 7472 6163 6528 290a 0a20 2020 2064 6566  trace()..    def
+0000c2f0: 2067 6574 5f6e 6279 7465 735f 6465 7073   get_nbytes_deps
+0000c300: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+0000c310: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
+0000c320: 6d28 7473 2e67 6574 5f6e 6279 7465 7328  m(ts.get_nbytes(
+0000c330: 2920 666f 7220 7473 2069 6e20 7365 6c66  ) for ts in self
+0000c340: 2e64 6570 656e 6465 6e63 6965 7329 0a0a  .dependencies)..
+0000c350: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
+0000c360: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
+0000c370: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
+0000c380: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
+0000c390: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
+0000c3a0: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
+0000c3b0: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
+0000c3c0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
+0000c3d0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
+0000c3e0: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
+0000c3f0: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
+0000c400: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
+0000c410: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
+0000c420: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+0000c430: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+0000c440: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
+0000c450: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
+0000c460: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+0000c470: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
+0000c480: 655f 746f 5f64 6963 740a 0a20 2020 2020  e_to_dict..     
+0000c490: 2020 204e 6f74 6573 0a20 2020 2020 2020     Notes.       
+0000c4a0: 202d 2d2d 2d2d 0a20 2020 2020 2020 2054   -----.        T
+0000c4b0: 6869 7320 636c 6173 7320 7573 6573 2060  his class uses `
+0000c4c0: 605f 746f 5f64 6963 745f 6e6f 5f6e 6573  `_to_dict_no_nes
+0000c4d0: 7460 6020 696e 7374 6561 6420 6f66 2060  t`` instead of `
+0000c4e0: 605f 746f 5f64 6963 7460 602e 0a20 2020  `_to_dict``..   
+0000c4f0: 2020 2020 2057 6865 6e20 6120 7461 736b       When a task
+0000c500: 2072 6566 6572 656e 6365 7320 616e 6f74   references anot
+0000c510: 6865 7220 7461 736b 2c20 6f72 2077 6865  her task, or whe
+0000c520: 6e20 6120 576f 726b 6572 5374 6174 652e  n a WorkerState.
+0000c530: 7461 736b 7320 636f 6e74 6169 6e73 2074  tasks contains t
+0000c540: 6173 6b73 2c0a 2020 2020 2020 2020 7468  asks,.        th
+0000c550: 6973 206d 6574 686f 6420 6973 206e 6f74  is method is not
+0000c560: 2065 7865 6375 7465 6420 666f 7220 7468   executed for th
+0000c570: 6520 696e 6e65 7220 7461 736b 2c20 6576  e inner task, ev
+0000c580: 656e 2069 6620 7468 6520 696e 6e65 7220  en if the inner 
+0000c590: 7461 736b 2077 6173 206e 6576 6572 0a20  task was never. 
+0000c5a0: 2020 2020 2020 2073 6565 6e20 6265 666f         seen befo
+0000c5b0: 7265 3b20 796f 7520 6765 7420 6120 7265  re; you get a re
+0000c5c0: 7072 2069 6e73 7465 6164 2e20 416c 6c20  pr instead. All 
+0000c5d0: 7461 736b 7320 7368 6f75 6c64 206e 6561  tasks should nea
+0000c5e0: 746c 7920 6170 7065 6172 2075 6e64 6572  tly appear under
+0000c5f0: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
+0000c600: 6572 2e74 6173 6b73 2e20 5468 6973 2061  er.tasks. This a
+0000c610: 6c73 6f20 7072 6576 656e 7473 2061 2052  lso prevents a R
+0000c620: 6563 7572 7369 6f6e 4572 726f 7220 6475  ecursionError du
+0000c630: 7269 6e67 2070 6172 7469 6375 6c61 726c  ring particularl
+0000c640: 7920 6865 6176 790a 2020 2020 2020 2020  y heavy.        
+0000c650: 6c6f 6164 732c 2077 6869 6368 2068 6176  loads, which hav
+0000c660: 6520 6265 656e 206f 6273 6572 7665 6420  e been observed 
+0000c670: 746f 2068 6170 7065 6e20 7768 656e 6576  to happen whenev
+0000c680: 6572 2074 6865 7265 2773 2061 6e20 6163  er there's an ac
+0000c690: 7963 6c69 6320 6465 7065 6e64 656e 6379  yclic dependency
+0000c6a0: 0a20 2020 2020 2020 2063 6861 696e 206f  .        chain o
+0000c6b0: 6620 7e32 3030 2b20 7461 736b 732e 0a20  f ~200+ tasks.. 
+0000c6c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000c6d0: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
+0000c6e0: 6976 655f 746f 5f64 6963 7428 7365 6c66  ive_to_dict(self
+0000c6f0: 2c20 6578 636c 7564 653d 6578 636c 7564  , exclude=exclud
+0000c700: 652c 206d 656d 6265 7273 3d54 7275 6529  e, members=True)
+0000c710: 0a0a 0a63 6c61 7373 2054 7261 6e73 6974  ...class Transit
+0000c720: 696f 6e28 4e61 6d65 6454 7570 6c65 293a  ion(NamedTuple):
+0000c730: 0a20 2020 2022 2222 416e 2065 6e74 7279  .    """An entry
+0000c740: 2069 6e20 3a61 7474 723a 6053 6368 6564   in :attr:`Sched
+0000c750: 756c 6572 5374 6174 652e 7472 616e 7369  ulerState.transi
+0000c760: 7469 6f6e 5f6c 6f67 6022 2222 0a0a 2020  tion_log`"""..  
+0000c770: 2020 6b65 793a 2073 7472 0a20 2020 2073    key: str.    s
+0000c780: 7461 7274 3a20 5461 736b 5374 6174 6553  tart: TaskStateS
+0000c790: 7461 7465 0a20 2020 2066 696e 6973 683a  tate.    finish:
+0000c7a0: 2054 6173 6b53 7461 7465 5374 6174 650a   TaskStateState.
+0000c7b0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0000c7c0: 6f6e 733a 2052 6563 730a 2020 2020 7374  ons: Recs.    st
+0000c7d0: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+0000c7e0: 2020 2074 696d 6573 7461 6d70 3a20 666c     timestamp: fl
+0000c7f0: 6f61 740a 0a0a 636c 6173 7320 5363 6865  oat...class Sche
+0000c800: 6475 6c65 7253 7461 7465 3a0a 2020 2020  dulerState:.    
+0000c810: 2222 2255 6e64 6572 6c79 696e 6720 7461  """Underlying ta
+0000c820: 736b 2073 7461 7465 206f 6620 6479 6e61  sk state of dyna
+0000c830: 6d69 6320 7363 6865 6475 6c65 720a 0a20  mic scheduler.. 
+0000c840: 2020 2054 7261 636b 7320 7468 6520 6375     Tracks the cu
+0000c850: 7272 656e 7420 7374 6174 6520 6f66 2077  rrent state of w
+0000c860: 6f72 6b65 7273 2c20 6461 7461 2c20 616e  orkers, data, an
+0000c870: 6420 636f 6d70 7574 6174 696f 6e73 2e0a  d computations..
+0000c880: 0a20 2020 2048 616e 646c 6573 2074 7261  .    Handles tra
+0000c890: 6e73 6974 696f 6e73 2062 6574 7765 656e  nsitions between
+0000c8a0: 2064 6966 6665 7265 6e74 2074 6173 6b20   different task 
+0000c8b0: 7374 6174 6573 2e20 4e6f 7469 6669 6573  states. Notifies
+0000c8c0: 2074 6865 0a20 2020 2053 6368 6564 756c   the.    Schedul
+0000c8d0: 6572 206f 6620 6368 616e 6765 7320 6279  er of changes by
+0000c8e0: 206d 6573 7361 6769 6e67 2070 6173 7369   messaging passi
+0000c8f0: 6e67 2074 6872 6f75 6768 2051 7565 7565  ng through Queue
+0000c900: 732c 2077 6869 6368 2074 6865 0a20 2020  s, which the.   
+0000c910: 2053 6368 6564 756c 6572 206c 6973 7465   Scheduler liste
+0000c920: 6e73 2074 6f20 7265 7370 6f6e 6473 2061  ns to responds a
+0000c930: 6363 6f72 6469 6e67 6c79 2e0a 0a20 2020  ccordingly...   
+0000c940: 2041 6c6c 2065 7665 6e74 7320 6172 6520   All events are 
+0000c950: 6861 6e64 6c65 6420 7175 6963 6b6c 792c  handled quickly,
+0000c960: 2069 6e20 6c69 6e65 6172 2074 696d 6520   in linear time 
+0000c970: 7769 7468 2072 6573 7065 6374 2074 6f20  with respect to 
+0000c980: 7468 6569 720a 2020 2020 696e 7075 7420  their.    input 
+0000c990: 2877 6869 6368 2069 7320 6f66 7465 6e20  (which is often 
+0000c9a0: 6f66 2063 6f6e 7374 616e 7420 7369 7a65  of constant size
+0000c9b0: 2920 616e 6420 6765 6e65 7261 6c6c 7920  ) and generally 
+0000c9c0: 7769 7468 696e 2061 0a20 2020 206d 696c  within a.    mil
+0000c9d0: 6c69 7365 636f 6e64 2e0a 0a20 2020 2055  lisecond...    U
+0000c9e0: 7365 7273 2074 7970 6963 616c 6c79 2064  sers typically d
+0000c9f0: 6f20 6e6f 7420 696e 7465 7261 6374 2077  o not interact w
+0000ca00: 6974 6820 6060 5472 616e 7369 7469 6f6e  ith ``Transition
+0000ca10: 7360 6020 6469 7265 6374 6c79 2e20 496e  s`` directly. In
+0000ca20: 7374 6561 640a 2020 2020 7573 6572 7320  stead.    users 
+0000ca30: 696e 7465 7261 6374 2077 6974 6820 7468  interact with th
+0000ca40: 6520 6060 436c 6965 6e74 6060 2c20 7768  e ``Client``, wh
+0000ca50: 6963 6820 696e 2074 7572 6e20 656e 6761  ich in turn enga
+0000ca60: 6765 7320 7468 650a 2020 2020 6060 5363  ges the.    ``Sc
+0000ca70: 6865 6475 6c65 7260 6020 6166 6665 6374  heduler`` affect
+0000ca80: 696e 6720 6469 6666 6572 656e 7420 7472  ing different tr
+0000ca90: 616e 7369 7469 6f6e 7320 6865 7265 2075  ansitions here u
+0000caa0: 6e64 6572 2d74 6865 2d68 6f6f 642e 2049  nder-the-hood. I
+0000cab0: 6e0a 2020 2020 7468 6520 6261 636b 6772  n.    the backgr
+0000cac0: 6f75 6e64 2060 6057 6f72 6b65 7260 6073  ound ``Worker``s
+0000cad0: 2061 6c73 6f20 656e 6761 6765 2077 6974   also engage wit
+0000cae0: 6820 7468 6520 6060 5363 6865 6475 6c65  h the ``Schedule
+0000caf0: 7260 600a 2020 2020 6166 6665 6374 696e  r``.    affectin
+0000cb00: 6720 7468 6573 6520 7374 6174 6520 7472  g these state tr
+0000cb10: 616e 7369 7469 6f6e 7320 6173 2077 656c  ansitions as wel
+0000cb20: 6c2e 0a20 2020 2022 2222 0a0a 2020 2020  l..    """..    
+0000cb30: 6261 6e64 7769 6474 683a 2069 6e74 0a0a  bandwidth: int..
+0000cb40: 2020 2020 233a 2043 6c69 656e 7473 2063      #: Clients c
+0000cb50: 7572 7265 6e74 6c79 2063 6f6e 6e65 6374  urrently connect
+0000cb60: 6564 2074 6f20 7468 6520 7363 6865 6475  ed to the schedu
+0000cb70: 6c65 720a 2020 2020 636c 6965 6e74 733a  ler.    clients:
+0000cb80: 2064 6963 745b 7374 722c 2043 6c69 656e   dict[str, Clien
+0000cb90: 7453 7461 7465 5d0a 0a20 2020 2065 7874  tState]..    ext
+0000cba0: 656e 7369 6f6e 733a 2064 6963 745b 7374  ensions: dict[st
+0000cbb0: 722c 2041 6e79 5d20 2023 2054 4f44 4f20  r, Any]  # TODO 
+0000cbc0: 7772 6974 6520 6120 7363 6865 6475 6c65  write a schedule
+0000cbd0: 7220 6578 7465 6e73 696f 6e20 5072 6f74  r extension Prot
+0000cbe0: 6f63 6f6c 0a20 2020 2070 6c75 6769 6e73  ocol.    plugins
+0000cbf0: 3a20 6469 6374 5b73 7472 2c20 5363 6865  : dict[str, Sche
+0000cc00: 6475 6c65 7250 6c75 6769 6e5d 0a20 2020  dulerPlugin].   
+0000cc10: 2068 6f73 745f 696e 666f 3a20 6469 6374   host_info: dict
+0000cc20: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
+0000cc30: 416e 795d 5d0a 0a20 2020 2023 3a20 4966  Any]]..    #: If
+0000cc40: 2054 7275 652c 2065 6e61 626c 6520 6578   True, enable ex
+0000cc50: 7065 6e73 6976 6520 696e 7465 726e 616c  pensive internal
+0000cc60: 2063 6f6e 7369 7374 656e 6379 2063 6865   consistency che
+0000cc70: 636b 2e0a 2020 2020 233a 2054 7970 6963  ck..    #: Typic
+0000cc80: 616c 6c79 2064 6973 6162 6c65 6420 696e  ally disabled in
+0000cc90: 2070 726f 6475 6374 696f 6e2e 0a20 2020   production..   
+0000cca0: 2076 616c 6964 6174 653a 2062 6f6f 6c0a   validate: bool.
+0000ccb0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+0000ccc0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+0000ccd0: 2023 2057 6f72 6b65 7273 2d72 656c 6174   # Workers-relat
+0000cce0: 6564 2073 7461 7465 0a20 2020 2023 2323  ed state.    ###
+0000ccf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cd00: 2323 2323 0a0a 2020 2020 233a 2057 6f72  ####..    #: Wor
+0000cd10: 6b65 7273 2063 7572 7265 6e74 6c79 2063  kers currently c
+0000cd20: 6f6e 6e65 6374 6564 2074 6f20 7468 6520  onnected to the 
+0000cd30: 7363 6865 6475 6c65 720a 2020 2020 233a  scheduler.    #:
+0000cd40: 2028 6163 7475 616c 6c79 2061 2053 6f72   (actually a Sor
+0000cd50: 7465 6444 6963 742c 2062 7574 2074 6865  tedDict, but the
+0000cd60: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
+0000cd70: 7320 7061 636b 6167 6520 6973 6e27 7420  s package isn't 
+0000cd80: 616e 6e6f 7461 7465 6429 0a20 2020 2077  annotated).    w
+0000cd90: 6f72 6b65 7273 3a20 6469 6374 5b73 7472  orkers: dict[str
+0000cda0: 2c20 576f 726b 6572 5374 6174 655d 0a20  , WorkerState]. 
+0000cdb0: 2020 2023 3a20 576f 726b 6572 207b 6e61     #: Worker {na
+0000cdc0: 6d65 3a20 6164 6472 6573 737d 0a20 2020  me: address}.   
+0000cdd0: 2061 6c69 6173 6573 3a20 6469 6374 5b48   aliases: dict[H
+0000cde0: 6173 6861 626c 652c 2073 7472 5d0a 2020  ashable, str].  
+0000cdf0: 2020 233a 2057 6f72 6b65 7273 2074 6861    #: Workers tha
+0000ce00: 7420 6172 6520 6375 7272 656e 746c 7920  t are currently 
+0000ce10: 696e 2072 756e 6e69 6e67 2073 7461 7465  in running state
+0000ce20: 0a20 2020 2072 756e 6e69 6e67 3a20 7365  .    running: se
+0000ce30: 745b 576f 726b 6572 5374 6174 655d 0a20  t[WorkerState]. 
+0000ce40: 2020 2023 3a20 576f 726b 6572 7320 7468     #: Workers th
+0000ce50: 6174 2061 7265 2063 7572 7265 6e74 6c79  at are currently
+0000ce60: 2069 6e20 7275 6e6e 696e 6720 7374 6174   in running stat
+0000ce70: 6520 616e 6420 6e6f 7420 6675 6c6c 7920  e and not fully 
+0000ce80: 7574 696c 697a 6564 0a20 2020 2023 3a20  utilized.    #: 
+0000ce90: 4465 6669 6e69 7469 6f6e 2062 6173 6564  Definition based
+0000cea0: 206f 6e20 6f63 6375 7061 6e63 790a 2020   on occupancy.  
+0000ceb0: 2020 233a 2028 6163 7475 616c 6c79 2061    #: (actually a
+0000cec0: 2053 6f72 7465 6444 6963 742c 2062 7574   SortedDict, but
+0000ced0: 2074 6865 2073 6f72 7465 6463 6f6e 7461   the sortedconta
+0000cee0: 696e 6572 7320 7061 636b 6167 6520 6973  iners package is
+0000cef0: 6e27 7420 616e 6e6f 7461 7465 6429 2e0a  n't annotated)..
+0000cf00: 2020 2020 233a 204e 6f74 2074 6f20 6265      #: Not to be
+0000cf10: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
+0000cf20: 6d65 7468 3a60 6973 5f69 646c 6560 2e0a  meth:`is_idle`..
+0000cf30: 2020 2020 6964 6c65 3a20 6469 6374 5b73      idle: dict[s
+0000cf40: 7472 2c20 576f 726b 6572 5374 6174 655d  tr, WorkerState]
+0000cf50: 0a20 2020 2023 3a20 5369 6d69 6c61 7220  .    #: Similar 
+0000cf60: 746f 2060 6964 6c65 600a 2020 2020 233a  to `idle`.    #:
+0000cf70: 2044 6566 696e 6974 696f 6e20 6261 7365   Definition base
+0000cf80: 6420 6f6e 2061 7373 6967 6e65 6420 7461  d on assigned ta
+0000cf90: 736b 730a 2020 2020 6964 6c65 5f74 6173  sks.    idle_tas
+0000cfa0: 6b5f 636f 756e 743a 2073 6574 5b57 6f72  k_count: set[Wor
+0000cfb0: 6b65 7253 7461 7465 5d0a 2020 2020 233a  kerState].    #:
+0000cfc0: 2057 6f72 6b65 7273 2074 6861 7420 6172   Workers that ar
+0000cfd0: 6520 6675 6c6c 7920 7574 696c 697a 6564  e fully utilized
+0000cfe0: 2e20 4d61 7920 696e 636c 7564 6520 6e6f  . May include no
+0000cff0: 6e2d 7275 6e6e 696e 6720 776f 726b 6572  n-running worker
+0000d000: 732e 0a20 2020 2073 6174 7572 6174 6564  s..    saturated
+0000d010: 3a20 7365 745b 576f 726b 6572 5374 6174  : set[WorkerStat
+0000d020: 655d 0a20 2020 2074 6f74 616c 5f6e 7468  e].    total_nth
+0000d030: 7265 6164 733a 2069 6e74 0a20 2020 2023  reads: int.    #
+0000d040: 3a20 436c 7573 7465 722d 7769 6465 2072  : Cluster-wide r
+0000d050: 6573 6f75 7263 6573 2e20 7b72 6573 6f75  esources. {resou
+0000d060: 7263 6520 6e61 6d65 3a20 7b77 6f72 6b65  rce name: {worke
+0000d070: 7220 6164 6472 6573 733a 2061 6d6f 756e  r address: amoun
+0000d080: 747d 7d0a 2020 2020 7265 736f 7572 6365  t}}.    resource
+0000d090: 733a 2064 6963 745b 7374 722c 2064 6963  s: dict[str, dic
+0000d0a0: 745b 7374 722c 2066 6c6f 6174 5d5d 0a0a  t[str, float]]..
+0000d0b0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0000d0c0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+0000d0d0: 5461 736b 732d 7265 6c61 7465 6420 7374  Tasks-related st
+0000d0e0: 6174 650a 2020 2020 2323 2323 2323 2323  ate.    ########
+0000d0f0: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
+0000d100: 2020 2023 3a20 546f 7461 6c20 6e75 6d62     #: Total numb
+0000d110: 6572 206f 6620 7461 736b 7320 6576 6572  er of tasks ever
+0000d120: 2070 726f 6365 7373 6564 0a20 2020 206e   processed.    n
+0000d130: 5f74 6173 6b73 3a20 696e 740a 0a20 2020  _tasks: int..   
+0000d140: 2023 3a20 416c 6c20 7461 736b 7320 6375   #: All tasks cu
+0000d150: 7272 656e 746c 7920 6b6e 6f77 6e20 746f  rrently known to
+0000d160: 2074 6865 2073 6368 6564 756c 6572 0a20   the scheduler. 
+0000d170: 2020 2074 6173 6b73 3a20 6469 6374 5b73     tasks: dict[s
+0000d180: 7472 2c20 5461 736b 5374 6174 655d 0a0a  tr, TaskState]..
+0000d190: 2020 2020 233a 2054 6173 6b73 2069 6e20      #: Tasks in 
+0000d1a0: 7468 6520 2271 7565 7565 6422 2073 7461  the "queued" sta
+0000d1b0: 7465 2c20 6f72 6465 7265 6420 6279 2070  te, ordered by p
+0000d1c0: 7269 6f72 6974 790a 2020 2020 7175 6575  riority.    queu
+0000d1d0: 6564 3a20 4865 6170 5365 745b 5461 736b  ed: HeapSet[Task
+0000d1e0: 5374 6174 655d 0a0a 2020 2020 233a 2054  State]..    #: T
+0000d1f0: 6173 6b73 2069 6e20 7468 6520 226e 6f2d  asks in the "no-
+0000d200: 776f 726b 6572 2220 7374 6174 650a 2020  worker" state.  
+0000d210: 2020 756e 7275 6e6e 6162 6c65 3a20 7365    unrunnable: se
+0000d220: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+0000d230: 2020 233a 2053 7562 7365 7420 6f66 2074    #: Subset of t
+0000d240: 6173 6b73 2074 6861 7420 6578 6973 7420  asks that exist 
+0000d250: 696e 206d 656d 6f72 7920 6f6e 206d 6f72  in memory on mor
+0000d260: 6520 7468 616e 206f 6e65 2077 6f72 6b65  e than one worke
+0000d270: 720a 2020 2020 7265 706c 6963 6174 6564  r.    replicated
+0000d280: 5f74 6173 6b73 3a20 7365 745b 5461 736b  _tasks: set[Task
+0000d290: 5374 6174 655d 0a0a 2020 2020 756e 6b6e  State]..    unkn
+0000d2a0: 6f77 6e5f 6475 7261 7469 6f6e 733a 2064  own_durations: d
+0000d2b0: 6963 745b 7374 722c 2073 6574 5b54 6173  ict[str, set[Tas
+0000d2c0: 6b53 7461 7465 5d5d 0a20 2020 2074 6173  kState]].    tas
+0000d2d0: 6b5f 6772 6f75 7073 3a20 6469 6374 5b73  k_groups: dict[s
+0000d2e0: 7472 2c20 5461 736b 4772 6f75 705d 0a20  tr, TaskGroup]. 
+0000d2f0: 2020 2074 6173 6b5f 7072 6566 6978 6573     task_prefixes
+0000d300: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
+0000d310: 5072 6566 6978 5d0a 2020 2020 7461 736b  Prefix].    task
+0000d320: 5f6d 6574 6164 6174 613a 2064 6963 745b  _metadata: dict[
+0000d330: 7374 722c 2041 6e79 5d0a 0a20 2020 2023  str, Any]..    #
+0000d340: 2323 2323 2323 2323 0a20 2020 2023 2048  ########.    # H
+0000d350: 6973 746f 7279 0a20 2020 2023 2323 2323  istory.    #####
+0000d360: 2323 2323 0a0a 2020 2020 233a 2048 6973  ####..    #: His
+0000d370: 746f 7279 206f 6620 636f 6d70 7574 6174  tory of computat
+0000d380: 696f 6e73 2e0a 2020 2020 233a 2054 6865  ions..    #: The
+0000d390: 206c 656e 6774 6820 6361 6e20 6265 2074   length can be t
+0000d3a0: 7765 616b 6564 2074 6872 6f75 6768 0a20  weaked through. 
+0000d3b0: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
+0000d3c0: 642e 6469 6167 6e6f 7374 6963 732e 636f  d.diagnostics.co
+0000d3d0: 6d70 7574 6174 696f 6e73 2e6d 6178 2d68  mputations.max-h
+0000d3e0: 6973 746f 7279 0a20 2020 2063 6f6d 7075  istory.    compu
+0000d3f0: 7461 7469 6f6e 733a 2064 6571 7565 5b43  tations: deque[C
+0000d400: 6f6d 7075 7461 7469 6f6e 5d0a 0a20 2020  omputation]..   
+0000d410: 2023 3a20 4869 7374 6f72 7920 6f66 2065   #: History of e
+0000d420: 7272 6564 2074 6173 6b73 2e0a 2020 2020  rred tasks..    
+0000d430: 233a 2054 6865 206c 656e 6774 6820 6361  #: The length ca
+0000d440: 6e20 6265 2074 7765 616b 6564 2074 6872  n be tweaked thr
+0000d450: 6f75 6768 0a20 2020 2023 3a20 6469 7374  ough.    #: dist
+0000d460: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
+0000d470: 6963 732e 6572 7265 642d 7461 736b 732e  ics.erred-tasks.
+0000d480: 6d61 782d 6869 7374 6f72 790a 2020 2020  max-history.    
+0000d490: 6572 7265 645f 7461 736b 733a 2064 6571  erred_tasks: deq
+0000d4a0: 7565 5b45 7272 6564 5461 736b 5d0a 0a20  ue[ErredTask].. 
+0000d4b0: 2020 2023 3a20 4869 7374 6f72 7920 6f66     #: History of
+0000d4c0: 2074 6173 6b20 7374 6174 6520 7472 616e   task state tran
+0000d4d0: 7369 7469 6f6e 732e 0a20 2020 2023 3a20  sitions..    #: 
+0000d4e0: 5468 6520 6c65 6e67 7468 2063 616e 2062  The length can b
+0000d4f0: 6520 7477 6561 6b65 6420 7468 726f 7567  e tweaked throug
+0000d500: 680a 2020 2020 233a 2064 6973 7472 6962  h.    #: distrib
+0000d510: 7574 6564 2e73 6368 6564 756c 6572 2e74  uted.scheduler.t
+0000d520: 7261 6e73 6974 696f 6e2d 6c6f 672d 6c65  ransition-log-le
+0000d530: 6e67 7468 0a20 2020 2074 7261 6e73 6974  ngth.    transit
+0000d540: 696f 6e5f 6c6f 673a 2064 6571 7565 5b54  ion_log: deque[T
+0000d550: 7261 6e73 6974 696f 6e5d 0a0a 2020 2020  ransition]..    
+0000d560: 233a 2054 6f74 616c 206e 756d 6265 7220  #: Total number 
+0000d570: 6f66 2074 7261 6e73 6974 696f 6e73 2073  of transitions s
+0000d580: 696e 6365 2074 6865 2063 6c75 7374 6572  ince the cluster
+0000d590: 2077 6173 2073 7461 7274 6564 0a20 2020   was started.   
+0000d5a0: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
+0000d5b0: 7465 723a 2069 6e74 0a0a 2020 2020 233a  ter: int..    #:
+0000d5c0: 2054 6f74 616c 206e 756d 6265 7220 6f66   Total number of
+0000d5d0: 2074 7261 6e73 6974 696f 6e73 2061 7320   transitions as 
+0000d5e0: 6f66 2074 6865 2070 7265 7669 6f75 7320  of the previous 
+0000d5f0: 6361 6c6c 2074 6f20 6368 6563 6b5f 6964  call to check_id
+0000d600: 6c65 2829 0a20 2020 205f 6964 6c65 5f74  le().    _idle_t
+0000d610: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0000d620: 723a 2069 6e74 0a0a 2020 2020 233a 2052  r: int..    #: R
+0000d630: 6169 7365 2061 6e20 6572 726f 7220 6966  aise an error if
+0000d640: 2074 6865 203a 6174 7472 3a60 7472 616e   the :attr:`tran
+0000d650: 7369 7469 6f6e 5f63 6f75 6e74 6572 6020  sition_counter` 
+0000d660: 6576 6572 2072 6561 6368 6573 2074 6869  ever reaches thi
+0000d670: 7320 7661 6c75 652e 0a20 2020 2023 3a20  s value..    #: 
+0000d680: 5468 6973 2069 7320 6d65 616e 7420 666f  This is meant fo
+0000d690: 7220 6465 6275 6767 696e 6720 6f6e 6c79  r debugging only
+0000d6a0: 2c20 746f 2063 6174 6368 2069 6e66 696e  , to catch infin
+0000d6b0: 6974 6520 7265 6375 7273 696f 6e20 6c6f  ite recursion lo
+0000d6c0: 6f70 732e 0a20 2020 2023 3a20 496e 2070  ops..    #: In p
+0000d6d0: 726f 6475 6374 696f 6e2c 2069 7420 7368  roduction, it sh
+0000d6e0: 6f75 6c64 2061 6c77 6179 7320 6265 2073  ould always be s
+0000d6f0: 6574 2074 6f20 4661 6c73 652e 0a20 2020  et to False..   
+0000d700: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
+0000d710: 7465 725f 6d61 783a 2069 6e74 207c 204c  ter_max: int | L
+0000d720: 6974 6572 616c 5b46 616c 7365 5d0a 0a20  iteral[False].. 
+0000d730: 2020 205f 7461 736b 5f70 7265 6669 785f     _task_prefix_
+0000d740: 636f 756e 745f 676c 6f62 616c 3a20 6465  count_global: de
+0000d750: 6661 756c 7464 6963 745b 7374 722c 2069  faultdict[str, i
+0000d760: 6e74 5d0a 2020 2020 5f6e 6574 776f 726b  nt].    _network
+0000d770: 5f6f 6363 5f67 6c6f 6261 6c3a 2066 6c6f  _occ_global: flo
+0000d780: 6174 0a20 2020 2023 2323 2323 2323 2323  at.    #########
+0000d790: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+0000d7a0: 2020 2320 4361 6368 6564 2063 6f6e 6669    # Cached confi
+0000d7b0: 6775 7261 7469 6f6e 0a20 2020 2023 2323  guration.    ###
 0000d7c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d7d0: 2323 2323 230a 0a20 2020 2023 3a20 6469  #####..    #: di
-0000d7e0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0000d7f0: 6c65 722e 756e 6b6e 6f77 6e2d 7461 736b  ler.unknown-task
-0000d800: 2d64 7572 6174 696f 6e0a 2020 2020 554e  -duration.    UN
-0000d810: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
-0000d820: 494f 4e3a 2066 6c6f 6174 0a20 2020 2023  ION: float.    #
-0000d830: 3a20 6469 7374 7269 6275 7465 642e 776f  : distributed.wo
-0000d840: 726b 6572 2e6d 656d 6f72 792e 7265 6365  rker.memory.rece
-0000d850: 6e74 2d74 6f2d 6f6c 642d 7469 6d65 0a20  nt-to-old-time. 
-0000d860: 2020 204d 454d 4f52 595f 5245 4345 4e54     MEMORY_RECENT
-0000d870: 5f54 4f5f 4f4c 445f 5449 4d45 3a20 666c  _TO_OLD_TIME: fl
-0000d880: 6f61 740a 2020 2020 233a 2064 6973 7472  oat.    #: distr
-0000d890: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-0000d8a0: 6d6f 7279 2e72 6562 616c 616e 6365 2e6d  mory.rebalance.m
-0000d8b0: 6561 7375 7265 0a20 2020 204d 454d 4f52  easure.    MEMOR
-0000d8c0: 595f 5245 4241 4c41 4e43 455f 4d45 4153  Y_REBALANCE_MEAS
-0000d8d0: 5552 453a 2073 7472 0a20 2020 2023 3a20  URE: str.    #: 
-0000d8e0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-0000d8f0: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
-0000d900: 6e63 652e 7365 6e64 6572 2d6d 696e 0a20  nce.sender-min. 
-0000d910: 2020 204d 454d 4f52 595f 5245 4241 4c41     MEMORY_REBALA
-0000d920: 4e43 455f 5345 4e44 4552 5f4d 494e 3a20  NCE_SENDER_MIN: 
-0000d930: 666c 6f61 740a 2020 2020 233a 2064 6973  float.    #: dis
-0000d940: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-0000d950: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
-0000d960: 2e72 6563 6970 6965 6e74 2d6d 6178 0a20  .recipient-max. 
-0000d970: 2020 204d 454d 4f52 595f 5245 4241 4c41     MEMORY_REBALA
-0000d980: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
-0000d990: 583a 2066 6c6f 6174 0a20 2020 2023 3a20  X: float.    #: 
-0000d9a0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-0000d9b0: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
-0000d9c0: 6e63 652e 7365 6e64 6572 2d72 6563 6970  nce.sender-recip
-0000d9d0: 6965 6e74 2d67 6170 202f 2032 0a20 2020  ient-gap / 2.   
-0000d9e0: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
-0000d9f0: 455f 4841 4c46 5f47 4150 3a20 666c 6f61  E_HALF_GAP: floa
-0000da00: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
-0000da10: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
-0000da20: 6f72 6b65 722d 7361 7475 7261 7469 6f6e  orker-saturation
-0000da30: 0a20 2020 2057 4f52 4b45 525f 5341 5455  .    WORKER_SATU
-0000da40: 5241 5449 4f4e 3a20 666c 6f61 740a 0a20  RATION: float.. 
-0000da50: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
-0000da60: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
-0000da70: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
-0000da80: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
-0000da90: 2073 656c 662c 0a20 2020 2020 2020 2061   self,.        a
-0000daa0: 6c69 6173 6573 3a20 6469 6374 5b48 6173  liases: dict[Has
-0000dab0: 6861 626c 652c 2073 7472 5d2c 0a20 2020  hable, str],.   
-0000dac0: 2020 2020 2063 6c69 656e 7473 3a20 6469       clients: di
-0000dad0: 6374 5b73 7472 2c20 436c 6965 6e74 5374  ct[str, ClientSt
-0000dae0: 6174 655d 2c0a 2020 2020 2020 2020 776f  ate],.        wo
-0000daf0: 726b 6572 733a 2053 6f72 7465 6444 6963  rkers: SortedDic
-0000db00: 745b 7374 722c 2057 6f72 6b65 7253 7461  t[str, WorkerSta
-0000db10: 7465 5d2c 0a20 2020 2020 2020 2068 6f73  te],.        hos
-0000db20: 745f 696e 666f 3a20 6469 6374 5b73 7472  t_info: dict[str
-0000db30: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
-0000db40: 5d2c 0a20 2020 2020 2020 2072 6573 6f75  ],.        resou
-0000db50: 7263 6573 3a20 6469 6374 5b73 7472 2c20  rces: dict[str, 
-0000db60: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
-0000db70: 5d2c 0a20 2020 2020 2020 2074 6173 6b73  ],.        tasks
-0000db80: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
-0000db90: 5374 6174 655d 2c0a 2020 2020 2020 2020  State],.        
-0000dba0: 756e 7275 6e6e 6162 6c65 3a20 7365 745b  unrunnable: set[
-0000dbb0: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
-0000dbc0: 2020 2020 7175 6575 6564 3a20 4865 6170      queued: Heap
-0000dbd0: 5365 745b 5461 736b 5374 6174 655d 2c0a  Set[TaskState],.
-0000dbe0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
-0000dbf0: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
-0000dc00: 706c 7567 696e 733a 2049 7465 7261 626c  plugins: Iterabl
-0000dc10: 655b 5363 6865 6475 6c65 7250 6c75 6769  e[SchedulerPlugi
-0000dc20: 6e5d 203d 2028 292c 0a20 2020 2020 2020  n] = (),.       
-0000dc30: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
-0000dc40: 7465 725f 6d61 783a 2069 6e74 207c 204c  ter_max: int | L
-0000dc50: 6974 6572 616c 5b46 616c 7365 5d20 3d20  iteral[False] = 
-0000dc60: 4661 6c73 652c 0a20 2020 2020 2020 202a  False,.        *
-0000dc70: 2a6b 7761 7267 733a 2041 6e79 2c20 2023  *kwargs: Any,  #
-0000dc80: 2050 6173 7365 6420 7665 7262 6174 696d   Passed verbatim
-0000dc90: 2074 6f20 5365 7276 6572 2e5f 5f69 6e69   to Server.__ini
-0000dca0: 745f 5f28 290a 2020 2020 293a 0a20 2020  t__().    ):.   
-0000dcb0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0000dcc0: 2822 5374 6174 6520 7374 6172 7422 290a  ("State start").
-0000dcd0: 2020 2020 2020 2020 7365 6c66 2e61 6c69          self.ali
-0000dce0: 6173 6573 203d 2061 6c69 6173 6573 0a20  ases = aliases. 
-0000dcf0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-0000dd00: 7769 6474 6820 3d20 7061 7273 655f 6279  width = parse_by
-0000dd10: 7465 7328 6461 736b 2e63 6f6e 6669 672e  tes(dask.config.
-0000dd20: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0000dd30: 2e73 6368 6564 756c 6572 2e62 616e 6477  .scheduler.bandw
-0000dd40: 6964 7468 2229 290a 2020 2020 2020 2020  idth")).        
-0000dd50: 7365 6c66 2e63 6c69 656e 7473 203d 2063  self.clients = c
-0000dd60: 6c69 656e 7473 0a20 2020 2020 2020 2073  lients.        s
-0000dd70: 656c 662e 636c 6965 6e74 735b 2266 6972  elf.clients["fir
-0000dd80: 652d 616e 642d 666f 7267 6574 225d 203d  e-and-forget"] =
-0000dd90: 2043 6c69 656e 7453 7461 7465 2822 6669   ClientState("fi
-0000dda0: 7265 2d61 6e64 2d66 6f72 6765 7422 290a  re-and-forget").
-0000ddb0: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
-0000ddc0: 656e 7369 6f6e 7320 3d20 7b7d 0a20 2020  ensions = {}.   
-0000ddd0: 2020 2020 2073 656c 662e 686f 7374 5f69       self.host_i
-0000dde0: 6e66 6f20 3d20 686f 7374 5f69 6e66 6f0a  nfo = host_info.
-0000ddf0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-0000de00: 6520 3d20 536f 7274 6564 4469 6374 2829  e = SortedDict()
-0000de10: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
-0000de20: 6c65 5f74 6173 6b5f 636f 756e 7420 3d20  le_task_count = 
-0000de30: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
-0000de40: 6c66 2e6e 5f74 6173 6b73 203d 2030 0a20  lf.n_tasks = 0. 
-0000de50: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
-0000de60: 7572 6365 7320 3d20 7265 736f 7572 6365  urces = resource
-0000de70: 730a 2020 2020 2020 2020 7365 6c66 2e73  s.        self.s
-0000de80: 6174 7572 6174 6564 203d 2073 6574 2829  aturated = set()
-0000de90: 0a20 2020 2020 2020 2073 656c 662e 7461  .        self.ta
-0000dea0: 736b 7320 3d20 7461 736b 730a 2020 2020  sks = tasks.    
-0000deb0: 2020 2020 7365 6c66 2e72 6570 6c69 6361      self.replica
-0000dec0: 7465 645f 7461 736b 7320 3d20 7b0a 2020  ted_tasks = {.  
-0000ded0: 2020 2020 2020 2020 2020 7473 2066 6f72            ts for
-0000dee0: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
-0000def0: 732e 7661 6c75 6573 2829 2069 6620 6c65  s.values() if le
-0000df00: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
-0000df10: 310a 2020 2020 2020 2020 7d0a 2020 2020  1.        }.    
-0000df20: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
-0000df30: 7469 6f6e 7320 3d20 6465 7175 6528 0a20  tions = deque(. 
-0000df40: 2020 2020 2020 2020 2020 206d 6178 6c65             maxle
-0000df50: 6e3d 6461 736b 2e63 6f6e 6669 672e 6765  n=dask.config.ge
-0000df60: 7428 2264 6973 7472 6962 7574 6564 2e64  t("distributed.d
-0000df70: 6961 676e 6f73 7469 6373 2e63 6f6d 7075  iagnostics.compu
-0000df80: 7461 7469 6f6e 732e 6d61 782d 6869 7374  tations.max-hist
-0000df90: 6f72 7922 290a 2020 2020 2020 2020 290a  ory").        ).
-0000dfa0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
-0000dfb0: 6564 5f74 6173 6b73 203d 2064 6571 7565  ed_tasks = deque
-0000dfc0: 280a 2020 2020 2020 2020 2020 2020 6d61  (.            ma
-0000dfd0: 786c 656e 3d64 6173 6b2e 636f 6e66 6967  xlen=dask.config
-0000dfe0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0000dff0: 642e 6469 6167 6e6f 7374 6963 732e 6572  d.diagnostics.er
-0000e000: 7265 642d 7461 736b 732e 6d61 782d 6869  red-tasks.max-hi
-0000e010: 7374 6f72 7922 290a 2020 2020 2020 2020  story").        
-0000e020: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
-0000e030: 6173 6b5f 6772 6f75 7073 203d 207b 7d0a  ask_groups = {}.
-0000e040: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0000e050: 6b5f 7072 6566 6978 6573 203d 207b 7d0a  k_prefixes = {}.
-0000e060: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0000e070: 6b5f 6d65 7461 6461 7461 203d 207b 7d0a  k_metadata = {}.
-0000e080: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
-0000e090: 616c 5f6e 7468 7265 6164 7320 3d20 300a  al_nthreads = 0.
-0000e0a0: 2020 2020 2020 2020 7365 6c66 2e75 6e6b          self.unk
-0000e0b0: 6e6f 776e 5f64 7572 6174 696f 6e73 203d  nown_durations =
-0000e0c0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0000e0d0: 2e71 7565 7565 6420 3d20 7175 6575 6564  .queued = queued
-0000e0e0: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-0000e0f0: 7275 6e6e 6162 6c65 203d 2075 6e72 756e  runnable = unrun
-0000e100: 6e61 626c 650a 2020 2020 2020 2020 7365  nable.        se
-0000e110: 6c66 2e76 616c 6964 6174 6520 3d20 7661  lf.validate = va
-0000e120: 6c69 6461 7465 0a20 2020 2020 2020 2073  lidate.        s
-0000e130: 656c 662e 776f 726b 6572 7320 3d20 776f  elf.workers = wo
-0000e140: 726b 6572 730a 2020 2020 2020 2020 7365  rkers.        se
-0000e150: 6c66 2e5f 7461 736b 5f70 7265 6669 785f  lf._task_prefix_
-0000e160: 636f 756e 745f 676c 6f62 616c 203d 2064  count_global = d
-0000e170: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
-0000e180: 2020 2020 2020 2020 7365 6c66 2e5f 6e65          self._ne
-0000e190: 7477 6f72 6b5f 6f63 635f 676c 6f62 616c  twork_occ_global
-0000e1a0: 203d 2030 2e30 0a20 2020 2020 2020 2073   = 0.0.        s
-0000e1b0: 656c 662e 7275 6e6e 696e 6720 3d20 7b0a  elf.running = {.
-0000e1c0: 2020 2020 2020 2020 2020 2020 7773 2066              ws f
-0000e1d0: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
-0000e1e0: 726b 6572 732e 7661 6c75 6573 2829 2069  rkers.values() i
-0000e1f0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-0000e200: 7461 7475 732e 7275 6e6e 696e 670a 2020  tatus.running.  
-0000e210: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0000e220: 7365 6c66 2e70 6c75 6769 6e73 203d 207b  self.plugins = {
-0000e230: 7d20 6966 206e 6f74 2070 6c75 6769 6e73  } if not plugins
-0000e240: 2065 6c73 6520 7b5f 6765 745f 706c 7567   else {_get_plug
-0000e250: 696e 5f6e 616d 6528 7029 3a20 7020 666f  in_name(p): p fo
-0000e260: 7220 7020 696e 2070 6c75 6769 6e73 7d0a  r p in plugins}.
-0000e270: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
-0000e280: 616e 7369 7469 6f6e 5f6c 6f67 203d 2064  ansition_log = d
-0000e290: 6571 7565 280a 2020 2020 2020 2020 2020  eque(.          
-0000e2a0: 2020 6d61 786c 656e 3d64 6173 6b2e 636f    maxlen=dask.co
-0000e2b0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0000e2c0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0000e2d0: 7472 616e 7369 7469 6f6e 2d6c 6f67 2d6c  transition-log-l
-0000e2e0: 656e 6774 6822 290a 2020 2020 2020 2020  ength").        
-0000e2f0: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
-0000e300: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-0000e310: 7220 3d20 300a 2020 2020 2020 2020 7365  r = 0.        se
-0000e320: 6c66 2e5f 6964 6c65 5f74 7261 6e73 6974  lf._idle_transit
-0000e330: 696f 6e5f 636f 756e 7465 7220 3d20 300a  ion_counter = 0.
-0000e340: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-0000e350: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
-0000e360: 6d61 7820 3d20 7472 616e 7369 7469 6f6e  max = transition
-0000e370: 5f63 6f75 6e74 6572 5f6d 6178 0a0a 2020  _counter_max..  
-0000e380: 2020 2020 2020 2320 5661 7269 6162 6c65        # Variable
-0000e390: 7320 6672 6f6d 2064 6173 6b2e 636f 6e66  s from dask.conf
-0000e3a0: 6967 2c20 6361 6368 6564 2062 7920 5f5f  ig, cached by __
-0000e3b0: 696e 6974 5f5f 2066 6f72 2070 6572 666f  init__ for perfo
-0000e3c0: 726d 616e 6365 0a20 2020 2020 2020 2073  rmance.        s
-0000e3d0: 656c 662e 554e 4b4e 4f57 4e5f 5441 534b  elf.UNKNOWN_TASK
-0000e3e0: 5f44 5552 4154 494f 4e20 3d20 7061 7273  _DURATION = pars
-0000e3f0: 655f 7469 6d65 6465 6c74 6128 0a20 2020  e_timedelta(.   
-0000e400: 2020 2020 2020 2020 2064 6173 6b2e 636f           dask.co
-0000e410: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0000e420: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0000e430: 756e 6b6e 6f77 6e2d 7461 736b 2d64 7572  unknown-task-dur
-0000e440: 6174 696f 6e22 290a 2020 2020 2020 2020  ation").        
-0000e450: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
-0000e460: 454d 4f52 595f 5245 4345 4e54 5f54 4f5f  EMORY_RECENT_TO_
-0000e470: 4f4c 445f 5449 4d45 203d 2070 6172 7365  OLD_TIME = parse
-0000e480: 5f74 696d 6564 656c 7461 280a 2020 2020  _timedelta(.    
-0000e490: 2020 2020 2020 2020 6461 736b 2e63 6f6e          dask.con
-0000e4a0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0000e4b0: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-0000e4c0: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-0000e4d0: 2d74 696d 6522 290a 2020 2020 2020 2020  -time").        
-0000e4e0: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
-0000e4f0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
-0000e500: 4d45 4153 5552 4520 3d20 6461 736b 2e63  MEASURE = dask.c
-0000e510: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
-0000e520: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
-0000e530: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
-0000e540: 792e 7265 6261 6c61 6e63 652e 6d65 6173  y.rebalance.meas
-0000e550: 7572 6522 0a20 2020 2020 2020 2029 0a20  ure".        ). 
-0000e560: 2020 2020 2020 2073 656c 662e 4d45 4d4f         self.MEMO
-0000e570: 5259 5f52 4542 414c 414e 4345 5f53 454e  RY_REBALANCE_SEN
-0000e580: 4445 525f 4d49 4e20 3d20 6461 736b 2e63  DER_MIN = dask.c
-0000e590: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
-0000e5a0: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
-0000e5b0: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
-0000e5c0: 792e 7265 6261 6c61 6e63 652e 7365 6e64  y.rebalance.send
-0000e5d0: 6572 2d6d 696e 220a 2020 2020 2020 2020  er-min".        
-0000e5e0: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
-0000e5f0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
-0000e600: 5245 4349 5049 454e 545f 4d41 5820 3d20  RECIPIENT_MAX = 
-0000e610: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0000e620: 0a20 2020 2020 2020 2020 2020 2022 6469  .            "di
-0000e630: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
-0000e640: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
-0000e650: 652e 7265 6369 7069 656e 742d 6d61 7822  e.recipient-max"
-0000e660: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000e670: 2020 2073 656c 662e 4d45 4d4f 5259 5f52     self.MEMORY_R
-0000e680: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
-0000e690: 5020 3d20 280a 2020 2020 2020 2020 2020  P = (.          
-0000e6a0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0000e6b0: 7428 2264 6973 7472 6962 7574 6564 2e77  t("distributed.w
-0000e6c0: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6562  orker.memory.reb
-0000e6d0: 616c 616e 6365 2e73 656e 6465 722d 7265  alance.sender-re
-0000e6e0: 6369 7069 656e 742d 6761 7022 290a 2020  cipient-gap").  
-0000e6f0: 2020 2020 2020 2020 2020 2f20 322e 300a            / 2.0.
-0000e700: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000e710: 2020 2073 656c 662e 574f 524b 4552 5f53     self.WORKER_S
-0000e720: 4154 5552 4154 494f 4e20 3d20 6461 736b  ATURATION = dask
-0000e730: 2e63 6f6e 6669 672e 6765 7428 0a20 2020  .config.get(.   
-0000e740: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
-0000e750: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0000e760: 776f 726b 6572 2d73 6174 7572 6174 696f  worker-saturatio
-0000e770: 6e22 0a20 2020 2020 2020 2029 0a20 2020  n".        ).   
-0000e780: 2020 2020 2069 6620 7365 6c66 2e57 4f52       if self.WOR
-0000e790: 4b45 525f 5341 5455 5241 5449 4f4e 203d  KER_SATURATION =
-0000e7a0: 3d20 2269 6e66 223a 0a20 2020 2020 2020  = "inf":.       
-0000e7b0: 2020 2020 2023 2053 7065 6369 616c 2063       # Special c
-0000e7c0: 6173 6520 6e65 6365 7373 6172 7920 6265  ase necessary be
-0000e7d0: 6361 7573 6520 7468 6572 6527 7320 6e6f  cause there's no
-0000e7e0: 2077 6179 2074 6f20 7061 7273 6520 6120   way to parse a 
-0000e7f0: 666c 6f61 7420 696e 6669 6e69 7479 0a20  float infinity. 
-0000e800: 2020 2020 2020 2020 2020 2023 2066 726f             # fro
-0000e810: 6d20 6120 4441 534b 5f2a 2065 6e76 6972  m a DASK_* envir
-0000e820: 6f6e 6d65 6e74 2076 6172 6961 626c 650a  onment variable.
-0000e830: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000e840: 2e57 4f52 4b45 525f 5341 5455 5241 5449  .WORKER_SATURATI
-0000e850: 4f4e 203d 206d 6174 682e 696e 660a 2020  ON = math.inf.  
-0000e860: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-0000e870: 2020 2020 2020 206e 6f74 2069 7369 6e73         not isins
-0000e880: 7461 6e63 6528 7365 6c66 2e57 4f52 4b45  tance(self.WORKE
-0000e890: 525f 5341 5455 5241 5449 4f4e 2c20 2869  R_SATURATION, (i
-0000e8a0: 6e74 2c20 666c 6f61 7429 290a 2020 2020  nt, float)).    
-0000e8b0: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
-0000e8c0: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
-0000e8d0: 4e20 3c3d 2030 0a20 2020 2020 2020 2029  N <= 0.        )
-0000e8e0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000e8f0: 6973 6520 5661 6c75 6545 7272 6f72 2820  ise ValueError( 
-0000e900: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
-0000e910: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-0000e920: 2020 2022 6064 6973 7472 6962 7574 6564     "`distributed
-0000e930: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-0000e940: 722d 7361 7475 7261 7469 6f6e 6020 6d75  r-saturation` mu
-0000e950: 7374 2062 6520 6120 666c 6f61 7420 3e20  st be a float > 
-0000e960: 303b 2067 6f74 2022 0a20 2020 2020 2020  0; got ".       
-0000e970: 2020 2020 2020 2020 202b 2072 6570 7228           + repr(
-0000e980: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-0000e990: 5241 5449 4f4e 290a 2020 2020 2020 2020  RATION).        
-0000e9a0: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
-0000e9b0: 6572 7479 0a20 2020 2064 6566 206d 656d  erty.    def mem
-0000e9c0: 6f72 7928 7365 6c66 2920 2d3e 204d 656d  ory(self) -> Mem
-0000e9d0: 6f72 7953 7461 7465 3a0a 2020 2020 2020  oryState:.      
-0000e9e0: 2020 7265 7475 726e 204d 656d 6f72 7953    return MemoryS
-0000e9f0: 7461 7465 2e73 756d 282a 2877 2e6d 656d  tate.sum(*(w.mem
-0000ea00: 6f72 7920 666f 7220 7720 696e 2073 656c  ory for w in sel
-0000ea10: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
-0000ea20: 2829 2929 0a0a 2020 2020 4070 726f 7065  ()))..    @prope
-0000ea30: 7274 790a 2020 2020 6465 6620 5f5f 7064  rty.    def __pd
-0000ea40: 6963 745f 5f28 7365 6c66 2920 2d3e 2064  ict__(self) -> d
-0000ea50: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0000ea60: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
-0000ea70: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
-0000ea80: 6477 6964 7468 223a 2073 656c 662e 6261  dwidth": self.ba
-0000ea90: 6e64 7769 6474 682c 0a20 2020 2020 2020  ndwidth,.       
-0000eaa0: 2020 2020 2022 7265 736f 7572 6365 7322       "resources"
-0000eab0: 3a20 7365 6c66 2e72 6573 6f75 7263 6573  : self.resources
-0000eac0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0000ead0: 6174 7572 6174 6564 223a 2073 656c 662e  aturated": self.
-0000eae0: 7361 7475 7261 7465 642c 0a20 2020 2020  saturated,.     
-0000eaf0: 2020 2020 2020 2022 756e 7275 6e6e 6162         "unrunnab
-0000eb00: 6c65 223a 2073 656c 662e 756e 7275 6e6e  le": self.unrunn
-0000eb10: 6162 6c65 2c0a 2020 2020 2020 2020 2020  able,.          
-0000eb20: 2020 2271 7565 7565 6422 3a20 7365 6c66    "queued": self
-0000eb30: 2e71 7565 7565 642c 0a20 2020 2020 2020  .queued,.       
-0000eb40: 2020 2020 2022 6e5f 7461 736b 7322 3a20       "n_tasks": 
-0000eb50: 7365 6c66 2e6e 5f74 6173 6b73 2c0a 2020  self.n_tasks,.  
-0000eb60: 2020 2020 2020 2020 2020 2275 6e6b 6e6f            "unkno
-0000eb70: 776e 5f64 7572 6174 696f 6e73 223a 2073  wn_durations": s
-0000eb80: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
-0000eb90: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-0000eba0: 2020 2022 7661 6c69 6461 7465 223a 2073     "validate": s
-0000ebb0: 656c 662e 7661 6c69 6461 7465 2c0a 2020  elf.validate,.  
-0000ebc0: 2020 2020 2020 2020 2020 2274 6173 6b73            "tasks
-0000ebd0: 223a 2073 656c 662e 7461 736b 732c 0a20  ": self.tasks,. 
-0000ebe0: 2020 2020 2020 2020 2020 2022 7461 736b             "task
-0000ebf0: 5f67 726f 7570 7322 3a20 7365 6c66 2e74  _groups": self.t
-0000ec00: 6173 6b5f 6772 6f75 7073 2c0a 2020 2020  ask_groups,.    
-0000ec10: 2020 2020 2020 2020 2274 6173 6b5f 7072          "task_pr
-0000ec20: 6566 6978 6573 223a 2073 656c 662e 7461  efixes": self.ta
-0000ec30: 736b 5f70 7265 6669 7865 732c 0a20 2020  sk_prefixes,.   
-0000ec40: 2020 2020 2020 2020 2022 746f 7461 6c5f           "total_
-0000ec50: 6e74 6872 6561 6473 223a 2073 656c 662e  nthreads": self.
-0000ec60: 746f 7461 6c5f 6e74 6872 6561 6473 2c0a  total_nthreads,.
-0000ec70: 2020 2020 2020 2020 2020 2020 2274 6f74              "tot
-0000ec80: 616c 5f6f 6363 7570 616e 6379 223a 2073  al_occupancy": s
-0000ec90: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
-0000eca0: 6e63 792c 0a20 2020 2020 2020 2020 2020  ncy,.           
-0000ecb0: 2022 6572 7265 645f 7461 736b 7322 3a20   "erred_tasks": 
-0000ecc0: 7365 6c66 2e65 7272 6564 5f74 6173 6b73  self.erred_tasks
-0000ecd0: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
-0000ece0: 7874 656e 7369 6f6e 7322 3a20 7365 6c66  xtensions": self
-0000ecf0: 2e65 7874 656e 7369 6f6e 732c 0a20 2020  .extensions,.   
-0000ed00: 2020 2020 2020 2020 2022 636c 6965 6e74           "client
-0000ed10: 7322 3a20 7365 6c66 2e63 6c69 656e 7473  s": self.clients
-0000ed20: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-0000ed30: 6f72 6b65 7273 223a 2073 656c 662e 776f  orkers": self.wo
-0000ed40: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
-0000ed50: 2020 2022 6964 6c65 223a 2073 656c 662e     "idle": self.
-0000ed60: 6964 6c65 2c0a 2020 2020 2020 2020 2020  idle,.          
-0000ed70: 2020 2268 6f73 745f 696e 666f 223a 2073    "host_info": s
-0000ed80: 656c 662e 686f 7374 5f69 6e66 6f2c 0a20  elf.host_info,. 
-0000ed90: 2020 2020 2020 207d 0a0a 2020 2020 6465         }..    de
-0000eda0: 6620 6e65 775f 7461 736b 280a 2020 2020  f new_task(.    
-0000edb0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0000edc0: 2020 6b65 793a 2073 7472 2c0a 2020 2020    key: str,.    
-0000edd0: 2020 2020 7370 6563 3a20 6f62 6a65 6374      spec: object
-0000ede0: 2c0a 2020 2020 2020 2020 7374 6174 653a  ,.        state:
-0000edf0: 2054 6173 6b53 7461 7465 5374 6174 652c   TaskStateState,
-0000ee00: 0a20 2020 2020 2020 2063 6f6d 7075 7461  .        computa
-0000ee10: 7469 6f6e 3a20 436f 6d70 7574 6174 696f  tion: Computatio
-0000ee20: 6e20 7c20 4e6f 6e65 203d 204e 6f6e 652c  n | None = None,
-0000ee30: 0a20 2020 2029 202d 3e20 5461 736b 5374  .    ) -> TaskSt
-0000ee40: 6174 653a 0a20 2020 2020 2020 2022 2222  ate:.        """
-0000ee50: 4372 6561 7465 2061 206e 6577 2074 6173  Create a new tas
-0000ee60: 6b2c 2061 6e64 2061 7373 6f63 6961 7465  k, and associate
-0000ee70: 6420 7374 6174 6573 2222 220a 2020 2020  d states""".    
-0000ee80: 2020 2020 7473 203d 2054 6173 6b53 7461      ts = TaskSta
-0000ee90: 7465 286b 6579 2c20 7370 6563 2c20 7374  te(key, spec, st
-0000eea0: 6174 6529 0a0a 2020 2020 2020 2020 7072  ate)..        pr
-0000eeb0: 6566 6978 5f6b 6579 203d 206b 6579 5f73  efix_key = key_s
-0000eec0: 706c 6974 286b 6579 290a 2020 2020 2020  plit(key).      
-0000eed0: 2020 7470 203d 2073 656c 662e 7461 736b    tp = self.task
-0000eee0: 5f70 7265 6669 7865 732e 6765 7428 7072  _prefixes.get(pr
-0000eef0: 6566 6978 5f6b 6579 290a 2020 2020 2020  efix_key).      
-0000ef00: 2020 6966 2074 7020 6973 204e 6f6e 653a    if tp is None:
-0000ef10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ef20: 662e 7461 736b 5f70 7265 6669 7865 735b  f.task_prefixes[
-0000ef30: 7072 6566 6978 5f6b 6579 5d20 3d20 7470  prefix_key] = tp
-0000ef40: 203d 2054 6173 6b50 7265 6669 7828 7072   = TaskPrefix(pr
-0000ef50: 6566 6978 5f6b 6579 290a 2020 2020 2020  efix_key).      
-0000ef60: 2020 7473 2e70 7265 6669 7820 3d20 7470    ts.prefix = tp
-0000ef70: 0a0a 2020 2020 2020 2020 6772 6f75 705f  ..        group_
-0000ef80: 6b65 7920 3d20 7473 2e67 726f 7570 5f6b  key = ts.group_k
-0000ef90: 6579 0a20 2020 2020 2020 2074 6720 3d20  ey.        tg = 
-0000efa0: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
-0000efb0: 2e67 6574 2867 726f 7570 5f6b 6579 290a  .get(group_key).
-0000efc0: 2020 2020 2020 2020 6966 2074 6720 6973          if tg is
-0000efd0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000efe0: 2020 2073 656c 662e 7461 736b 5f67 726f     self.task_gro
-0000eff0: 7570 735b 6772 6f75 705f 6b65 795d 203d  ups[group_key] =
-0000f000: 2074 6720 3d20 5461 736b 4772 6f75 7028   tg = TaskGroup(
-0000f010: 6772 6f75 705f 6b65 7929 0a20 2020 2020  group_key).     
-0000f020: 2020 2020 2020 2069 6620 636f 6d70 7574         if comput
-0000f030: 6174 696f 6e3a 0a20 2020 2020 2020 2020  ation:.         
-0000f040: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
-0000f050: 6f6e 2e67 726f 7570 732e 6164 6428 7467  on.groups.add(tg
-0000f060: 290a 2020 2020 2020 2020 2020 2020 7467  ).            tg
-0000f070: 2e70 7265 6669 7820 3d20 7470 0a20 2020  .prefix = tp.   
-0000f080: 2020 2020 2020 2020 2074 702e 6772 6f75           tp.grou
-0000f090: 7073 2e61 7070 656e 6428 7467 290a 2020  ps.append(tg).  
-0000f0a0: 2020 2020 2020 7467 2e61 6464 2874 7329        tg.add(ts)
-0000f0b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
-0000f0c0: 6173 6b73 5b6b 6579 5d20 3d20 7473 0a0a  asks[key] = ts..
-0000f0d0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0000f0e0: 730a 0a20 2020 2064 6566 205f 636c 6561  s..    def _clea
-0000f0f0: 725f 7461 736b 5f73 7461 7465 2873 656c  r_task_state(sel
-0000f100: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-0000f110: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-0000f120: 2822 436c 6561 7220 7461 736b 2073 7461  ("Clear task sta
-0000f130: 7465 2229 0a20 2020 2020 2020 2066 6f72  te").        for
-0000f140: 2063 6f6c 6c65 6374 696f 6e20 696e 2028   collection in (
-0000f150: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000f160: 662e 756e 7275 6e6e 6162 6c65 2c0a 2020  f.unrunnable,.  
-0000f170: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-0000f180: 7272 6564 5f74 6173 6b73 2c0a 2020 2020  rred_tasks,.    
-0000f190: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
-0000f1a0: 7075 7461 7469 6f6e 732c 0a20 2020 2020  putations,.     
-0000f1b0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0000f1c0: 5f70 7265 6669 7865 732c 0a20 2020 2020  _prefixes,.     
-0000f1d0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0000f1e0: 5f67 726f 7570 732c 0a20 2020 2020 2020  _groups,.       
-0000f1f0: 2020 2020 2073 656c 662e 7461 736b 5f6d       self.task_m
-0000f200: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
-0000f210: 2020 2020 2073 656c 662e 756e 6b6e 6f77       self.unknow
-0000f220: 6e5f 6475 7261 7469 6f6e 732c 0a20 2020  n_durations,.   
-0000f230: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0000f240: 706c 6963 6174 6564 5f74 6173 6b73 2c0a  plicated_tasks,.
-0000f250: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-0000f260: 2020 2020 2020 2063 6f6c 6c65 6374 696f         collectio
-0000f270: 6e2e 636c 6561 7228 2920 2023 2074 7970  n.clear()  # typ
-0000f280: 653a 2069 676e 6f72 650a 0a20 2020 2040  e: ignore..    @
-0000f290: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0000f2a0: 2074 6f74 616c 5f6f 6363 7570 616e 6379   total_occupancy
-0000f2b0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
-0000f2c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f2d0: 7365 6c66 2e5f 6361 6c63 5f6f 6363 7570  self._calc_occup
-0000f2e0: 616e 6379 280a 2020 2020 2020 2020 2020  ancy(.          
-0000f2f0: 2020 7365 6c66 2e5f 7461 736b 5f70 7265    self._task_pre
-0000f300: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
-0000f310: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-0000f320: 6c66 2e5f 6e65 7477 6f72 6b5f 6f63 635f  lf._network_occ_
-0000f330: 676c 6f62 616c 2c0a 2020 2020 2020 2020  global,.        
-0000f340: 290a 0a20 2020 2064 6566 205f 6361 6c63  )..    def _calc
-0000f350: 5f6f 6363 7570 616e 6379 280a 2020 2020  _occupancy(.    
-0000f360: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0000f370: 2020 7461 736b 5f70 7265 6669 785f 636f    task_prefix_co
-0000f380: 756e 743a 2064 6963 745b 7374 722c 2069  unt: dict[str, i
-0000f390: 6e74 5d2c 0a20 2020 2020 2020 206e 6574  nt],.        net
-0000f3a0: 776f 726b 5f6f 6363 3a20 666c 6f61 742c  work_occ: float,
-0000f3b0: 0a20 2020 2029 202d 3e20 666c 6f61 743a  .    ) -> float:
-0000f3c0: 0a20 2020 2020 2020 2072 6573 203d 2030  .        res = 0
-0000f3d0: 2e30 0a20 2020 2020 2020 2066 6f72 2070  .0.        for p
-0000f3e0: 7265 6669 785f 6e61 6d65 2c20 636f 756e  refix_name, coun
-0000f3f0: 7420 696e 2074 6173 6b5f 7072 6566 6978  t in task_prefix
-0000f400: 5f63 6f75 6e74 2e69 7465 6d73 2829 3a0a  _count.items():.
-0000f410: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0000f420: 444f 3a20 4465 616c 2077 6974 6820 756e  DO: Deal with un
-0000f430: 6b6e 6f77 6e20 7461 736b 7320 6265 7474  known tasks bett
-0000f440: 6572 0a20 2020 2020 2020 2020 2020 2070  er.            p
-0000f450: 7265 6669 7820 3d20 7365 6c66 2e74 6173  refix = self.tas
-0000f460: 6b5f 7072 6566 6978 6573 5b70 7265 6669  k_prefixes[prefi
-0000f470: 785f 6e61 6d65 5d0a 2020 2020 2020 2020  x_name].        
-0000f480: 2020 2020 6173 7365 7274 2070 7265 6669      assert prefi
-0000f490: 7820 6973 206e 6f74 204e 6f6e 650a 2020  x is not None.  
-0000f4a0: 2020 2020 2020 2020 2020 6475 7261 7469            durati
-0000f4b0: 6f6e 203d 2070 7265 6669 782e 6475 7261  on = prefix.dura
-0000f4c0: 7469 6f6e 5f61 7665 7261 6765 0a20 2020  tion_average.   
-0000f4d0: 2020 2020 2020 2020 2069 6620 6475 7261           if dura
-0000f4e0: 7469 6f6e 203c 2030 3a0a 2020 2020 2020  tion < 0:.      
-0000f4f0: 2020 2020 2020 2020 2020 6966 2070 7265            if pre
-0000f500: 6669 782e 6d61 785f 6578 6563 5f74 696d  fix.max_exec_tim
-0000f510: 6520 3e20 303a 0a20 2020 2020 2020 2020  e > 0:.         
-0000f520: 2020 2020 2020 2020 2020 2064 7572 6174             durat
-0000f530: 696f 6e20 3d20 3220 2a20 7072 6566 6978  ion = 2 * prefix
-0000f540: 2e6d 6178 5f65 7865 635f 7469 6d65 0a20  .max_exec_time. 
-0000f550: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f560: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000f570: 2020 2020 2020 2020 2064 7572 6174 696f           duratio
-0000f580: 6e20 3d20 7365 6c66 2e55 4e4b 4e4f 574e  n = self.UNKNOWN
-0000f590: 5f54 4153 4b5f 4455 5241 5449 4f4e 0a20  _TASK_DURATION. 
-0000f5a0: 2020 2020 2020 2020 2020 2072 6573 202b             res +
-0000f5b0: 3d20 6475 7261 7469 6f6e 202a 2063 6f75  = duration * cou
-0000f5c0: 6e74 0a20 2020 2020 2020 206f 6363 203d  nt.        occ =
-0000f5d0: 2072 6573 202b 206e 6574 776f 726b 5f6f   res + network_o
-0000f5e0: 6363 202f 2073 656c 662e 6261 6e64 7769  cc / self.bandwi
-0000f5f0: 6474 680a 2020 2020 2020 2020 6173 7365  dth.        asse
-0000f600: 7274 206f 6363 203e 3d20 302c 206f 6363  rt occ >= 0, occ
-0000f610: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f620: 6f63 630a 0a20 2020 2023 2323 2323 2323  occ..    #######
-0000f630: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0000f640: 2020 2023 2053 7461 7465 2054 7261 6e73     # State Trans
-0000f650: 6974 696f 6e73 2023 0a20 2020 2023 2323  itions #.    ###
-0000f660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000f670: 2323 0a0a 2020 2020 6465 6620 5f74 7261  ##..    def _tra
-0000f680: 6e73 6974 696f 6e28 0a20 2020 2020 2020  nsition(.       
-0000f690: 2073 656c 662c 206b 6579 3a20 7374 722c   self, key: str,
-0000f6a0: 2066 696e 6973 683a 2054 6173 6b53 7461   finish: TaskSta
-0000f6b0: 7465 5374 6174 652c 2073 7469 6d75 6c75  teState, stimulu
-0000f6c0: 735f 6964 3a20 7374 722c 202a 2a6b 7761  s_id: str, **kwa
-0000f6d0: 7267 733a 2041 6e79 0a20 2020 2029 202d  rgs: Any.    ) -
-0000f6e0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-0000f6f0: 2020 2020 2222 2254 7261 6e73 6974 696f      """Transitio
-0000f700: 6e20 6120 6b65 7920 6672 6f6d 2069 7473  n a key from its
-0000f710: 2063 7572 7265 6e74 2073 7461 7465 2074   current state t
-0000f720: 6f20 7468 6520 6669 6e69 7368 2073 7461  o the finish sta
-0000f730: 7465 0a0a 2020 2020 2020 2020 4578 616d  te..        Exam
-0000f740: 706c 6573 0a20 2020 2020 2020 202d 2d2d  ples.        ---
-0000f750: 2d2d 2d2d 2d0a 2020 2020 2020 2020 3e3e  -----.        >>
-0000f760: 3e20 7365 6c66 2e5f 7472 616e 7369 7469  > self._transiti
-0000f770: 6f6e 2827 7827 2c20 2777 6169 7469 6e67  on('x', 'waiting
-0000f780: 2729 0a20 2020 2020 2020 207b 2778 273a  ').        {'x':
-0000f790: 2027 7072 6f63 6573 7369 6e67 277d 2c20   'processing'}, 
-0000f7a0: 7b7d 2c20 7b7d 0a0a 2020 2020 2020 2020  {}, {}..        
-0000f7b0: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-0000f7c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0000f7d0: 5475 706c 6520 6f66 3a0a 0a20 2020 2020  Tuple of:..     
-0000f7e0: 2020 202d 2044 6963 7469 6f6e 6172 7920     - Dictionary 
-0000f7f0: 6f66 2072 6563 6f6d 6d65 6e64 6174 696f  of recommendatio
-0000f800: 6e73 2066 6f72 2066 7574 7572 6520 7472  ns for future tr
-0000f810: 616e 7369 7469 6f6e 7320 7b6b 6579 3a20  ansitions {key: 
-0000f820: 6e65 7720 7374 6174 657d 0a20 2020 2020  new state}.     
-0000f830: 2020 202d 204d 6573 7361 6765 7320 746f     - Messages to
-0000f840: 2063 6c69 656e 7473 207b 636c 6965 6e74   clients {client
-0000f850: 2061 6464 7265 7373 3a20 5b6d 7367 2c20   address: [msg, 
-0000f860: 6d73 672c 202e 2e2e 5d7d 0a20 2020 2020  msg, ...]}.     
-0000f870: 2020 202d 204d 6573 7361 6765 7320 746f     - Messages to
-0000f880: 2077 6f72 6b65 7273 207b 776f 726b 6572   workers {worker
-0000f890: 2061 6464 7265 7373 3a20 5b6d 7367 2c20   address: [msg, 
-0000f8a0: 6d73 672c 202e 2e2e 5d7d 0a0a 2020 2020  msg, ...]}..    
-0000f8b0: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
-0000f8c0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-0000f8d0: 2020 2020 2020 5363 6865 6475 6c65 722e        Scheduler.
-0000f8e0: 7472 616e 7369 7469 6f6e 7320 3a20 7472  transitions : tr
-0000f8f0: 616e 7369 7469 7665 2076 6572 7369 6f6e  ansitive version
-0000f900: 206f 6620 7468 6973 2066 756e 6374 696f   of this functio
-0000f910: 6e0a 2020 2020 2020 2020 2222 220a 2020  n.        """.  
-0000f920: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000f930: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-0000f940: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-0000f950: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0000f960: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0000f970: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f980: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a20 2020  n {}, {}, {}.   
-0000f990: 2020 2020 2020 2020 2073 7461 7274 203d           start =
-0000f9a0: 2074 732e 5f73 7461 7465 0a20 2020 2020   ts._state.     
-0000f9b0: 2020 2020 2020 2069 6620 7374 6172 7420         if start 
-0000f9c0: 3d3d 2066 696e 6973 683a 0a20 2020 2020  == finish:.     
-0000f9d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f9e0: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
-0000f9f0: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-0000fa00: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-0000fa10: 202d 2069 6e20 6361 7365 206f 6620 7472   - in case of tr
-0000fa20: 616e 7369 7469 6f6e 2074 6872 6f75 6768  ansition through
-0000fa30: 2072 656c 6561 7365 642c 2074 6869 7320   released, this 
-0000fa40: 636f 756e 7465 7220 6973 2069 6e63 7265  counter is incre
-0000fa50: 6d65 6e74 6564 2062 7920 320a 2020 2020  mented by 2.    
-0000fa60: 2020 2020 2020 2020 2320 2d20 7468 6973          # - this
-0000fa70: 2069 6e63 7265 6173 6520 6861 7070 656e   increase happen
-0000fa80: 7320 6265 666f 7265 2074 6865 2061 6374  s before the act
-0000fa90: 7561 6c20 7472 616e 7369 7469 6f6e 732c  ual transitions,
-0000faa0: 2073 6f20 7468 6174 2069 7420 6361 6e0a   so that it can.
-0000fab0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000fac0: 6361 7463 6820 706f 7465 6e74 6961 6c20  catch potential 
-0000fad0: 696e 6669 6e69 7465 2072 6563 7572 7369  infinite recursi
-0000fae0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
-0000faf0: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
-0000fb00: 636f 756e 7465 7220 2b3d 2031 0a20 2020  counter += 1.   
-0000fb10: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000fb20: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-0000fb30: 7465 725f 6d61 783a 0a20 2020 2020 2020  ter_max:.       
-0000fb40: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000fb50: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
-0000fb60: 636f 756e 7465 7220 3c20 7365 6c66 2e74  counter < self.t
-0000fb70: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-0000fb80: 725f 6d61 780a 0a20 2020 2020 2020 2020  r_max..         
-0000fb90: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0000fba0: 6e73 3a20 6469 6374 203d 207b 7d0a 2020  ns: dict = {}.  
-0000fbb0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0000fbc0: 5f6d 7367 733a 2064 6963 7420 3d20 7b7d  _msgs: dict = {}
-0000fbd0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0000fbe0: 656e 745f 6d73 6773 3a20 6469 6374 203d  ent_msgs: dict =
-0000fbf0: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
-0000fc00: 2069 6620 7365 6c66 2e70 6c75 6769 6e73   if self.plugins
-0000fc10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fc20: 2020 6465 7065 6e64 656e 7473 203d 2073    dependents = s
-0000fc30: 6574 2874 732e 6465 7065 6e64 656e 7473  et(ts.dependents
-0000fc40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000fc50: 2020 6465 7065 6e64 656e 6369 6573 203d    dependencies =
-0000fc60: 2073 6574 2874 732e 6465 7065 6e64 656e   set(ts.dependen
-0000fc70: 6369 6573 290a 0a20 2020 2020 2020 2020  cies)..         
-0000fc80: 2020 2066 756e 6320 3d20 7365 6c66 2e5f     func = self._
-0000fc90: 5452 414e 5349 5449 4f4e 535f 5441 424c  TRANSITIONS_TABL
-0000fca0: 452e 6765 7428 2873 7461 7274 2c20 6669  E.get((start, fi
-0000fcb0: 6e69 7368 2929 0a20 2020 2020 2020 2020  nish)).         
-0000fcc0: 2020 2069 6620 6675 6e63 2069 7320 6e6f     if func is no
-0000fcd0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000fce0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0000fcf0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-0000fd00: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-0000fd10: 7320 3d20 6675 6e63 280a 2020 2020 2020  s = func(.      
-0000fd20: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000fd30: 6c66 2c20 6b65 792c 2073 7469 6d75 6c75  lf, key, stimulu
-0000fd40: 735f 6964 2c20 2a2a 6b77 6172 6773 0a20  s_id, **kwargs. 
-0000fd50: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000fd60: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-0000fd70: 6966 2022 7265 6c65 6173 6564 2220 6e6f  if "released" no
-0000fd80: 7420 696e 2028 7374 6172 742c 2066 696e  t in (start, fin
-0000fd90: 6973 6829 3a0a 2020 2020 2020 2020 2020  ish):.          
-0000fda0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0000fdb0: 206b 7761 7267 732c 2028 6b77 6172 6773   kwargs, (kwargs
-0000fdc0: 2c20 7374 6172 742c 2066 696e 6973 6829  , start, finish)
-0000fdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fde0: 2061 5f72 6563 732c 2061 5f63 6d73 6773   a_recs, a_cmsgs
-0000fdf0: 2c20 615f 776d 7367 7320 3d20 7365 6c66  , a_wmsgs = self
-0000fe00: 2e5f 7472 616e 7369 7469 6f6e 280a 2020  ._transition(.  
-0000fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe20: 2020 6b65 792c 2022 7265 6c65 6173 6564    key, "released
-0000fe30: 222c 2073 7469 6d75 6c75 735f 6964 0a20  ", stimulus_id. 
-0000fe40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000fe50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000fe60: 2020 7620 3d20 615f 7265 6373 2e67 6574    v = a_recs.get
-0000fe70: 286b 6579 2c20 6669 6e69 7368 290a 2020  (key, finish).  
-0000fe80: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-0000fe90: 6e63 203d 2073 656c 662e 5f54 5241 4e53  nc = self._TRANS
-0000fea0: 4954 494f 4e53 5f54 4142 4c45 5b22 7265  ITIONS_TABLE["re
-0000feb0: 6c65 6173 6564 222c 2076 5d0a 2020 2020  leased", v].    
-0000fec0: 2020 2020 2020 2020 2020 2020 625f 7265              b_re
-0000fed0: 6373 2c20 625f 636d 7367 732c 2062 5f77  cs, b_cmsgs, b_w
-0000fee0: 6d73 6773 203d 2066 756e 6328 7365 6c66  msgs = func(self
-0000fef0: 2c20 6b65 792c 2073 7469 6d75 6c75 735f  , key, stimulus_
-0000ff00: 6964 290a 0a20 2020 2020 2020 2020 2020  id)..           
-0000ff10: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0000ff20: 696f 6e73 2e75 7064 6174 6528 615f 7265  ions.update(a_re
-0000ff30: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
-0000ff40: 2020 2020 666f 7220 632c 206e 6577 5f6d      for c, new_m
-0000ff50: 7367 7320 696e 2061 5f63 6d73 6773 2e69  sgs in a_cmsgs.i
-0000ff60: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0000ff70: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-0000ff80: 6e74 5f6d 7367 732e 7365 7464 6566 6175  nt_msgs.setdefau
-0000ff90: 6c74 2863 2c20 5b5d 292e 6578 7465 6e64  lt(c, []).extend
-0000ffa0: 286e 6577 5f6d 7367 7329 0a20 2020 2020  (new_msgs).     
-0000ffb0: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0000ffc0: 2c20 6e65 775f 6d73 6773 2069 6e20 615f  , new_msgs in a_
-0000ffd0: 776d 7367 732e 6974 656d 7328 293a 0a20  wmsgs.items():. 
-0000ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fff0: 2020 2077 6f72 6b65 725f 6d73 6773 2e73     worker_msgs.s
-00010000: 6574 6465 6661 756c 7428 772c 205b 5d29  etdefault(w, [])
-00010010: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
-00010020: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00010030: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00010040: 6e73 2e75 7064 6174 6528 625f 7265 6373  ns.update(b_recs
-00010050: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010060: 2020 666f 7220 632c 206e 6577 5f6d 7367    for c, new_msg
-00010070: 7320 696e 2062 5f63 6d73 6773 2e69 7465  s in b_cmsgs.ite
-00010080: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00010090: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-000100a0: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
-000100b0: 2863 2c20 5b5d 292e 6578 7465 6e64 286e  (c, []).extend(n
-000100c0: 6577 5f6d 7367 7329 0a20 2020 2020 2020  ew_msgs).       
-000100d0: 2020 2020 2020 2020 2066 6f72 2077 2c20           for w, 
-000100e0: 6e65 775f 6d73 6773 2069 6e20 625f 776d  new_msgs in b_wm
-000100f0: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
-00010100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010110: 2077 6f72 6b65 725f 6d73 6773 2e73 6574   worker_msgs.set
-00010120: 6465 6661 756c 7428 772c 205b 5d29 2e65  default(w, []).e
-00010130: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
-00010140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010150: 2073 7461 7274 203d 2022 7265 6c65 6173   start = "releas
-00010160: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
-00010170: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00010180: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00010190: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
-000101a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000101b0: 496d 706f 7373 6962 6c65 2074 7261 6e73  Impossible trans
-000101c0: 6974 696f 6e20 6672 6f6d 207b 7374 6172  ition from {star
-000101d0: 747d 2074 6f20 7b66 696e 6973 687d 2066  t} to {finish} f
-000101e0: 6f72 207b 6b65 7921 727d 3a20 220a 2020  or {key!r}: ".  
-000101f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010200: 2020 6622 7b73 7469 6d75 6c75 735f 6964    f"{stimulus_id
-00010210: 3d7d 2c20 7b6b 7761 7267 733d 7d2c 2073  =}, {kwargs=}, s
-00010220: 746f 7279 3d7b 7365 6c66 2e73 746f 7279  tory={self.story
-00010230: 2874 7329 7d22 0a20 2020 2020 2020 2020  (ts)}".         
-00010240: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00010250: 2020 2020 2020 6966 206e 6f74 2073 7469        if not sti
-00010260: 6d75 6c75 735f 6964 3a0a 2020 2020 2020  mulus_id:.      
-00010270: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
-00010280: 7573 5f69 6420 3d20 5354 494d 554c 5553  us_id = STIMULUS
-00010290: 5f49 445f 554e 5345 540a 0a20 2020 2020  _ID_UNSET..     
-000102a0: 2020 2020 2020 2061 6374 7561 6c5f 6669         actual_fi
-000102b0: 6e69 7368 203d 2074 732e 5f73 7461 7465  nish = ts._state
-000102c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000102d0: 662e 7472 616e 7369 7469 6f6e 5f6c 6f67  f.transition_log
-000102e0: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-000102f0: 2020 2020 2020 2020 2054 7261 6e73 6974           Transit
-00010300: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00010310: 2020 2020 2020 2020 206b 6579 2c20 7374           key, st
-00010320: 6172 742c 2061 6374 7561 6c5f 6669 6e69  art, actual_fini
-00010330: 7368 2c20 7265 636f 6d6d 656e 6461 7469  sh, recommendati
-00010340: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
-00010350: 2c20 7469 6d65 2829 0a20 2020 2020 2020  , time().       
-00010360: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00010370: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010380: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00010390: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-000103a0: 2020 2020 2020 2069 6620 7374 696d 756c         if stimul
-000103b0: 7573 5f69 6420 3d3d 2053 5449 4d55 4c55  us_id == STIMULU
-000103c0: 535f 4944 5f55 4e53 4554 3a0a 2020 2020  S_ID_UNSET:.    
+0000d7d0: 2323 230a 0a20 2020 2023 3a20 6469 7374  ###..    #: dist
+0000d7e0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0000d7f0: 722e 756e 6b6e 6f77 6e2d 7461 736b 2d64  r.unknown-task-d
+0000d800: 7572 6174 696f 6e0a 2020 2020 554e 4b4e  uration.    UNKN
+0000d810: 4f57 4e5f 5441 534b 5f44 5552 4154 494f  OWN_TASK_DURATIO
+0000d820: 4e3a 2066 6c6f 6174 0a20 2020 2023 3a20  N: float.    #: 
+0000d830: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0000d840: 6572 2e6d 656d 6f72 792e 7265 6365 6e74  er.memory.recent
+0000d850: 2d74 6f2d 6f6c 642d 7469 6d65 0a20 2020  -to-old-time.   
+0000d860: 204d 454d 4f52 595f 5245 4345 4e54 5f54   MEMORY_RECENT_T
+0000d870: 4f5f 4f4c 445f 5449 4d45 3a20 666c 6f61  O_OLD_TIME: floa
+0000d880: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
+0000d890: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
+0000d8a0: 7279 2e72 6562 616c 616e 6365 2e6d 6561  ry.rebalance.mea
+0000d8b0: 7375 7265 0a20 2020 204d 454d 4f52 595f  sure.    MEMORY_
+0000d8c0: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
+0000d8d0: 453a 2073 7472 0a20 2020 2023 3a20 6469  E: str.    #: di
+0000d8e0: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+0000d8f0: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
+0000d900: 652e 7365 6e64 6572 2d6d 696e 0a20 2020  e.sender-min.   
+0000d910: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
+0000d920: 455f 5345 4e44 4552 5f4d 494e 3a20 666c  E_SENDER_MIN: fl
+0000d930: 6f61 740a 2020 2020 233a 2064 6973 7472  oat.    #: distr
+0000d940: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+0000d950: 6d6f 7279 2e72 6562 616c 616e 6365 2e72  mory.rebalance.r
+0000d960: 6563 6970 6965 6e74 2d6d 6178 0a20 2020  ecipient-max.   
+0000d970: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
+0000d980: 455f 5245 4349 5049 454e 545f 4d41 583a  E_RECIPIENT_MAX:
+0000d990: 2066 6c6f 6174 0a20 2020 2023 3a20 6469   float.    #: di
+0000d9a0: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+0000d9b0: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
+0000d9c0: 652e 7365 6e64 6572 2d72 6563 6970 6965  e.sender-recipie
+0000d9d0: 6e74 2d67 6170 202f 2032 0a20 2020 204d  nt-gap / 2.    M
+0000d9e0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
+0000d9f0: 4841 4c46 5f47 4150 3a20 666c 6f61 740a  HALF_GAP: float.
+0000da00: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
+0000da10: 6564 2e73 6368 6564 756c 6572 2e77 6f72  ed.scheduler.wor
+0000da20: 6b65 722d 7361 7475 7261 7469 6f6e 0a20  ker-saturation. 
+0000da30: 2020 2057 4f52 4b45 525f 5341 5455 5241     WORKER_SATURA
+0000da40: 5449 4f4e 3a20 666c 6f61 740a 0a20 2020  TION: float..   
+0000da50: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
+0000da60: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
+0000da70: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
+0000da80: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+0000da90: 656c 662c 0a20 2020 2020 2020 2061 6c69  elf,.        ali
+0000daa0: 6173 6573 3a20 6469 6374 5b48 6173 6861  ases: dict[Hasha
+0000dab0: 626c 652c 2073 7472 5d2c 0a20 2020 2020  ble, str],.     
+0000dac0: 2020 2063 6c69 656e 7473 3a20 6469 6374     clients: dict
+0000dad0: 5b73 7472 2c20 436c 6965 6e74 5374 6174  [str, ClientStat
+0000dae0: 655d 2c0a 2020 2020 2020 2020 776f 726b  e],.        work
+0000daf0: 6572 733a 2053 6f72 7465 6444 6963 745b  ers: SortedDict[
+0000db00: 7374 722c 2057 6f72 6b65 7253 7461 7465  str, WorkerState
+0000db10: 5d2c 0a20 2020 2020 2020 2068 6f73 745f  ],.        host_
+0000db20: 696e 666f 3a20 6469 6374 5b73 7472 2c20  info: dict[str, 
+0000db30: 6469 6374 5b73 7472 2c20 416e 795d 5d2c  dict[str, Any]],
+0000db40: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
+0000db50: 6573 3a20 6469 6374 5b73 7472 2c20 6469  es: dict[str, di
+0000db60: 6374 5b73 7472 2c20 666c 6f61 745d 5d2c  ct[str, float]],
+0000db70: 0a20 2020 2020 2020 2074 6173 6b73 3a20  .        tasks: 
+0000db80: 6469 6374 5b73 7472 2c20 5461 736b 5374  dict[str, TaskSt
+0000db90: 6174 655d 2c0a 2020 2020 2020 2020 756e  ate],.        un
+0000dba0: 7275 6e6e 6162 6c65 3a20 7365 745b 5461  runnable: set[Ta
+0000dbb0: 736b 5374 6174 655d 2c0a 2020 2020 2020  skState],.      
+0000dbc0: 2020 7175 6575 6564 3a20 4865 6170 5365    queued: HeapSe
+0000dbd0: 745b 5461 736b 5374 6174 655d 2c0a 2020  t[TaskState],.  
+0000dbe0: 2020 2020 2020 7661 6c69 6461 7465 3a20        validate: 
+0000dbf0: 626f 6f6c 2c0a 2020 2020 2020 2020 706c  bool,.        pl
+0000dc00: 7567 696e 733a 2049 7465 7261 626c 655b  ugins: Iterable[
+0000dc10: 5363 6865 6475 6c65 7250 6c75 6769 6e5d  SchedulerPlugin]
+0000dc20: 203d 2028 292c 0a20 2020 2020 2020 2074   = (),.        t
+0000dc30: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0000dc40: 725f 6d61 783a 2069 6e74 207c 204c 6974  r_max: int | Lit
+0000dc50: 6572 616c 5b46 616c 7365 5d20 3d20 4661  eral[False] = Fa
+0000dc60: 6c73 652c 0a20 2020 2020 2020 202a 2a6b  lse,.        **k
+0000dc70: 7761 7267 733a 2041 6e79 2c20 2023 2050  wargs: Any,  # P
+0000dc80: 6173 7365 6420 7665 7262 6174 696d 2074  assed verbatim t
+0000dc90: 6f20 5365 7276 6572 2e5f 5f69 6e69 745f  o Server.__init_
+0000dca0: 5f28 290a 2020 2020 293a 0a20 2020 2020  _().    ):.     
+0000dcb0: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+0000dcc0: 5374 6174 6520 7374 6172 7422 290a 2020  State start").  
+0000dcd0: 2020 2020 2020 7365 6c66 2e61 6c69 6173        self.alias
+0000dce0: 6573 203d 2061 6c69 6173 6573 0a20 2020  es = aliases.   
+0000dcf0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+0000dd00: 6474 6820 3d20 7061 7273 655f 6279 7465  dth = parse_byte
+0000dd10: 7328 6461 736b 2e63 6f6e 6669 672e 6765  s(dask.config.ge
+0000dd20: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0000dd30: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
+0000dd40: 7468 2229 290a 2020 2020 2020 2020 7365  th")).        se
+0000dd50: 6c66 2e63 6c69 656e 7473 203d 2063 6c69  lf.clients = cli
+0000dd60: 656e 7473 0a20 2020 2020 2020 2073 656c  ents.        sel
+0000dd70: 662e 636c 6965 6e74 735b 2266 6972 652d  f.clients["fire-
+0000dd80: 616e 642d 666f 7267 6574 225d 203d 2043  and-forget"] = C
+0000dd90: 6c69 656e 7453 7461 7465 2822 6669 7265  lientState("fire
+0000dda0: 2d61 6e64 2d66 6f72 6765 7422 290a 2020  -and-forget").  
+0000ddb0: 2020 2020 2020 7365 6c66 2e65 7874 656e        self.exten
+0000ddc0: 7369 6f6e 7320 3d20 7b7d 0a20 2020 2020  sions = {}.     
+0000ddd0: 2020 2073 656c 662e 686f 7374 5f69 6e66     self.host_inf
+0000dde0: 6f20 3d20 686f 7374 5f69 6e66 6f0a 2020  o = host_info.  
+0000ddf0: 2020 2020 2020 7365 6c66 2e69 646c 6520        self.idle 
+0000de00: 3d20 536f 7274 6564 4469 6374 2829 0a20  = SortedDict(). 
+0000de10: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+0000de20: 5f74 6173 6b5f 636f 756e 7420 3d20 7365  _task_count = se
+0000de30: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000de40: 2e6e 5f74 6173 6b73 203d 2030 0a20 2020  .n_tasks = 0.   
+0000de50: 2020 2020 2073 656c 662e 7265 736f 7572       self.resour
+0000de60: 6365 7320 3d20 7265 736f 7572 6365 730a  ces = resources.
+0000de70: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
+0000de80: 7572 6174 6564 203d 2073 6574 2829 0a20  urated = set(). 
+0000de90: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0000dea0: 7320 3d20 7461 736b 730a 2020 2020 2020  s = tasks.      
+0000deb0: 2020 7365 6c66 2e72 6570 6c69 6361 7465    self.replicate
+0000dec0: 645f 7461 736b 7320 3d20 7b0a 2020 2020  d_tasks = {.    
+0000ded0: 2020 2020 2020 2020 7473 2066 6f72 2074          ts for t
+0000dee0: 7320 696e 2073 656c 662e 7461 736b 732e  s in self.tasks.
+0000def0: 7661 6c75 6573 2829 2069 6620 6c65 6e28  values() if len(
+0000df00: 7473 2e77 686f 5f68 6173 2920 3e20 310a  ts.who_has) > 1.
+0000df10: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0000df20: 2020 7365 6c66 2e63 6f6d 7075 7461 7469    self.computati
+0000df30: 6f6e 7320 3d20 6465 7175 6528 0a20 2020  ons = deque(.   
+0000df40: 2020 2020 2020 2020 206d 6178 6c65 6e3d           maxlen=
+0000df50: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0000df60: 2264 6973 7472 6962 7574 6564 2e64 6961  "distributed.dia
+0000df70: 676e 6f73 7469 6373 2e63 6f6d 7075 7461  gnostics.computa
+0000df80: 7469 6f6e 732e 6d61 782d 6869 7374 6f72  tions.max-histor
+0000df90: 7922 290a 2020 2020 2020 2020 290a 2020  y").        ).  
+0000dfa0: 2020 2020 2020 7365 6c66 2e65 7272 6564        self.erred
+0000dfb0: 5f74 6173 6b73 203d 2064 6571 7565 280a  _tasks = deque(.
+0000dfc0: 2020 2020 2020 2020 2020 2020 6d61 786c              maxl
+0000dfd0: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
+0000dfe0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0000dff0: 6469 6167 6e6f 7374 6963 732e 6572 7265  diagnostics.erre
+0000e000: 642d 7461 736b 732e 6d61 782d 6869 7374  d-tasks.max-hist
+0000e010: 6f72 7922 290a 2020 2020 2020 2020 290a  ory").        ).
+0000e020: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000e030: 6b5f 6772 6f75 7073 203d 207b 7d0a 2020  k_groups = {}.  
+0000e040: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+0000e050: 7072 6566 6978 6573 203d 207b 7d0a 2020  prefixes = {}.  
+0000e060: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+0000e070: 6d65 7461 6461 7461 203d 207b 7d0a 2020  metadata = {}.  
+0000e080: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
+0000e090: 5f6e 7468 7265 6164 7320 3d20 300a 2020  _nthreads = 0.  
+0000e0a0: 2020 2020 2020 7365 6c66 2e75 6e6b 6e6f        self.unkno
+0000e0b0: 776e 5f64 7572 6174 696f 6e73 203d 207b  wn_durations = {
+0000e0c0: 7d0a 2020 2020 2020 2020 7365 6c66 2e71  }.        self.q
+0000e0d0: 7565 7565 6420 3d20 7175 6575 6564 0a20  ueued = queued. 
+0000e0e0: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
+0000e0f0: 6e6e 6162 6c65 203d 2075 6e72 756e 6e61  nnable = unrunna
+0000e100: 626c 650a 2020 2020 2020 2020 7365 6c66  ble.        self
+0000e110: 2e76 616c 6964 6174 6520 3d20 7661 6c69  .validate = vali
+0000e120: 6461 7465 0a20 2020 2020 2020 2073 656c  date.        sel
+0000e130: 662e 776f 726b 6572 7320 3d20 776f 726b  f.workers = work
+0000e140: 6572 730a 2020 2020 2020 2020 7365 6c66  ers.        self
+0000e150: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
+0000e160: 756e 745f 676c 6f62 616c 203d 2064 6566  unt_global = def
+0000e170: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
+0000e180: 2020 2020 2020 7365 6c66 2e5f 6e65 7477        self._netw
+0000e190: 6f72 6b5f 6f63 635f 676c 6f62 616c 203d  ork_occ_global =
+0000e1a0: 2030 2e30 0a20 2020 2020 2020 2073 656c   0.0.        sel
+0000e1b0: 662e 7275 6e6e 696e 6720 3d20 7b0a 2020  f.running = {.  
+0000e1c0: 2020 2020 2020 2020 2020 7773 2066 6f72            ws for
+0000e1d0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
+0000e1e0: 6572 732e 7661 6c75 6573 2829 2069 6620  ers.values() if 
+0000e1f0: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
+0000e200: 7475 732e 7275 6e6e 696e 670a 2020 2020  tus.running.    
+0000e210: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+0000e220: 6c66 2e70 6c75 6769 6e73 203d 207b 7d20  lf.plugins = {} 
+0000e230: 6966 206e 6f74 2070 6c75 6769 6e73 2065  if not plugins e
+0000e240: 6c73 6520 7b5f 6765 745f 706c 7567 696e  lse {_get_plugin
+0000e250: 5f6e 616d 6528 7029 3a20 7020 666f 7220  _name(p): p for 
+0000e260: 7020 696e 2070 6c75 6769 6e73 7d0a 0a20  p in plugins}.. 
+0000e270: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+0000e280: 7369 7469 6f6e 5f6c 6f67 203d 2064 6571  sition_log = deq
+0000e290: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
+0000e2a0: 6d61 786c 656e 3d64 6173 6b2e 636f 6e66  maxlen=dask.conf
+0000e2b0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0000e2c0: 7465 642e 7363 6865 6475 6c65 722e 7472  ted.scheduler.tr
+0000e2d0: 616e 7369 7469 6f6e 2d6c 6f67 2d6c 656e  ansition-log-len
+0000e2e0: 6774 6822 290a 2020 2020 2020 2020 290a  gth").        ).
+0000e2f0: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+0000e300: 6e73 6974 696f 6e5f 636f 756e 7465 7220  nsition_counter 
+0000e310: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0000e320: 2e5f 6964 6c65 5f74 7261 6e73 6974 696f  ._idle_transitio
+0000e330: 6e5f 636f 756e 7465 7220 3d20 300a 2020  n_counter = 0.  
+0000e340: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+0000e350: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+0000e360: 7820 3d20 7472 616e 7369 7469 6f6e 5f63  x = transition_c
+0000e370: 6f75 6e74 6572 5f6d 6178 0a0a 2020 2020  ounter_max..    
+0000e380: 2020 2020 2320 5661 7269 6162 6c65 7320      # Variables 
+0000e390: 6672 6f6d 2064 6173 6b2e 636f 6e66 6967  from dask.config
+0000e3a0: 2c20 6361 6368 6564 2062 7920 5f5f 696e  , cached by __in
+0000e3b0: 6974 5f5f 2066 6f72 2070 6572 666f 726d  it__ for perform
+0000e3c0: 616e 6365 0a20 2020 2020 2020 2073 656c  ance.        sel
+0000e3d0: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
+0000e3e0: 5552 4154 494f 4e20 3d20 7061 7273 655f  URATION = parse_
+0000e3f0: 7469 6d65 6465 6c74 6128 0a20 2020 2020  timedelta(.     
+0000e400: 2020 2020 2020 2064 6173 6b2e 636f 6e66         dask.conf
+0000e410: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0000e420: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
+0000e430: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
+0000e440: 696f 6e22 290a 2020 2020 2020 2020 290a  ion").        ).
+0000e450: 2020 2020 2020 2020 7365 6c66 2e4d 454d          self.MEM
+0000e460: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
+0000e470: 445f 5449 4d45 203d 2070 6172 7365 5f74  D_TIME = parse_t
+0000e480: 696d 6564 656c 7461 280a 2020 2020 2020  imedelta(.      
+0000e490: 2020 2020 2020 6461 736b 2e63 6f6e 6669        dask.confi
+0000e4a0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+0000e4b0: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0000e4c0: 2e72 6563 656e 742d 746f 2d6f 6c64 2d74  .recent-to-old-t
+0000e4d0: 696d 6522 290a 2020 2020 2020 2020 290a  ime").        ).
+0000e4e0: 2020 2020 2020 2020 7365 6c66 2e4d 454d          self.MEM
+0000e4f0: 4f52 595f 5245 4241 4c41 4e43 455f 4d45  ORY_REBALANCE_ME
+0000e500: 4153 5552 4520 3d20 6461 736b 2e63 6f6e  ASURE = dask.con
+0000e510: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
+0000e520: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
+0000e530: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+0000e540: 7265 6261 6c61 6e63 652e 6d65 6173 7572  rebalance.measur
+0000e550: 6522 0a20 2020 2020 2020 2029 0a20 2020  e".        ).   
+0000e560: 2020 2020 2073 656c 662e 4d45 4d4f 5259       self.MEMORY
+0000e570: 5f52 4542 414c 414e 4345 5f53 454e 4445  _REBALANCE_SENDE
+0000e580: 525f 4d49 4e20 3d20 6461 736b 2e63 6f6e  R_MIN = dask.con
+0000e590: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
+0000e5a0: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
+0000e5b0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+0000e5c0: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
+0000e5d0: 2d6d 696e 220a 2020 2020 2020 2020 290a  -min".        ).
+0000e5e0: 2020 2020 2020 2020 7365 6c66 2e4d 454d          self.MEM
+0000e5f0: 4f52 595f 5245 4241 4c41 4e43 455f 5245  ORY_REBALANCE_RE
+0000e600: 4349 5049 454e 545f 4d41 5820 3d20 6461  CIPIENT_MAX = da
+0000e610: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+0000e620: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+0000e630: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+0000e640: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
+0000e650: 7265 6369 7069 656e 742d 6d61 7822 0a20  recipient-max". 
+0000e660: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000e670: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
+0000e680: 414c 414e 4345 5f48 414c 465f 4741 5020  ALANCE_HALF_GAP 
+0000e690: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000e6a0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0000e6b0: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
+0000e6c0: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
+0000e6d0: 616e 6365 2e73 656e 6465 722d 7265 6369  ance.sender-reci
+0000e6e0: 7069 656e 742d 6761 7022 290a 2020 2020  pient-gap").    
+0000e6f0: 2020 2020 2020 2020 2f20 322e 300a 2020          / 2.0.  
+0000e700: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000e710: 2073 656c 662e 574f 524b 4552 5f53 4154   self.WORKER_SAT
+0000e720: 5552 4154 494f 4e20 3d20 6461 736b 2e63  URATION = dask.c
+0000e730: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+0000e740: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+0000e750: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
+0000e760: 726b 6572 2d73 6174 7572 6174 696f 6e22  rker-saturation"
+0000e770: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000e780: 2020 2069 6620 7365 6c66 2e57 4f52 4b45     if self.WORKE
+0000e790: 525f 5341 5455 5241 5449 4f4e 203d 3d20  R_SATURATION == 
+0000e7a0: 2269 6e66 223a 0a20 2020 2020 2020 2020  "inf":.         
+0000e7b0: 2020 2023 2053 7065 6369 616c 2063 6173     # Special cas
+0000e7c0: 6520 6e65 6365 7373 6172 7920 6265 6361  e necessary beca
+0000e7d0: 7573 6520 7468 6572 6527 7320 6e6f 2077  use there's no w
+0000e7e0: 6179 2074 6f20 7061 7273 6520 6120 666c  ay to parse a fl
+0000e7f0: 6f61 7420 696e 6669 6e69 7479 0a20 2020  oat infinity.   
+0000e800: 2020 2020 2020 2020 2023 2066 726f 6d20           # from 
+0000e810: 6120 4441 534b 5f2a 2065 6e76 6972 6f6e  a DASK_* environ
+0000e820: 6d65 6e74 2076 6172 6961 626c 650a 2020  ment variable.  
+0000e830: 2020 2020 2020 2020 2020 7365 6c66 2e57            self.W
+0000e840: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000e850: 203d 206d 6174 682e 696e 660a 2020 2020   = math.inf.    
+0000e860: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+0000e870: 2020 2020 206e 6f74 2069 7369 6e73 7461       not isinsta
+0000e880: 6e63 6528 7365 6c66 2e57 4f52 4b45 525f  nce(self.WORKER_
+0000e890: 5341 5455 5241 5449 4f4e 2c20 2869 6e74  SATURATION, (int
+0000e8a0: 2c20 666c 6f61 7429 290a 2020 2020 2020  , float)).      
+0000e8b0: 2020 2020 2020 6f72 2073 656c 662e 574f        or self.WO
+0000e8c0: 524b 4552 5f53 4154 5552 4154 494f 4e20  RKER_SATURATION 
+0000e8d0: 3c3d 2030 0a20 2020 2020 2020 2029 3a0a  <= 0.        ):.
+0000e8e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000e8f0: 6520 5661 6c75 6545 7272 6f72 2820 2023  e ValueError(  #
+0000e900: 2070 7261 676d 613a 206e 6f63 6f76 6572   pragma: nocover
+0000e910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e920: 2022 6064 6973 7472 6962 7574 6564 2e73   "`distributed.s
+0000e930: 6368 6564 756c 6572 2e77 6f72 6b65 722d  cheduler.worker-
+0000e940: 7361 7475 7261 7469 6f6e 6020 6d75 7374  saturation` must
+0000e950: 2062 6520 6120 666c 6f61 7420 3e20 303b   be a float > 0;
+0000e960: 2067 6f74 2022 0a20 2020 2020 2020 2020   got ".         
+0000e970: 2020 2020 2020 202b 2072 6570 7228 7365         + repr(se
+0000e980: 6c66 2e57 4f52 4b45 525f 5341 5455 5241  lf.WORKER_SATURA
+0000e990: 5449 4f4e 290a 2020 2020 2020 2020 2020  TION).          
+0000e9a0: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
+0000e9b0: 7479 0a20 2020 2064 6566 206d 656d 6f72  ty.    def memor
+0000e9c0: 7928 7365 6c66 2920 2d3e 204d 656d 6f72  y(self) -> Memor
+0000e9d0: 7953 7461 7465 3a0a 2020 2020 2020 2020  yState:.        
+0000e9e0: 7265 7475 726e 204d 656d 6f72 7953 7461  return MemorySta
+0000e9f0: 7465 2e73 756d 282a 2877 2e6d 656d 6f72  te.sum(*(w.memor
+0000ea00: 7920 666f 7220 7720 696e 2073 656c 662e  y for w in self.
+0000ea10: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+0000ea20: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
+0000ea30: 790a 2020 2020 6465 6620 5f5f 7064 6963  y.    def __pdic
+0000ea40: 745f 5f28 7365 6c66 2920 2d3e 2064 6963  t__(self) -> dic
+0000ea50: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
+0000ea60: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+0000ea70: 2020 2020 2020 2020 2020 2262 616e 6477            "bandw
+0000ea80: 6964 7468 223a 2073 656c 662e 6261 6e64  idth": self.band
+0000ea90: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
+0000eaa0: 2020 2022 7265 736f 7572 6365 7322 3a20     "resources": 
+0000eab0: 7365 6c66 2e72 6573 6f75 7263 6573 2c0a  self.resources,.
+0000eac0: 2020 2020 2020 2020 2020 2020 2273 6174              "sat
+0000ead0: 7572 6174 6564 223a 2073 656c 662e 7361  urated": self.sa
+0000eae0: 7475 7261 7465 642c 0a20 2020 2020 2020  turated,.       
+0000eaf0: 2020 2020 2022 756e 7275 6e6e 6162 6c65       "unrunnable
+0000eb00: 223a 2073 656c 662e 756e 7275 6e6e 6162  ": self.unrunnab
+0000eb10: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+0000eb20: 2271 7565 7565 6422 3a20 7365 6c66 2e71  "queued": self.q
+0000eb30: 7565 7565 642c 0a20 2020 2020 2020 2020  ueued,.         
+0000eb40: 2020 2022 6e5f 7461 736b 7322 3a20 7365     "n_tasks": se
+0000eb50: 6c66 2e6e 5f74 6173 6b73 2c0a 2020 2020  lf.n_tasks,.    
+0000eb60: 2020 2020 2020 2020 2275 6e6b 6e6f 776e          "unknown
+0000eb70: 5f64 7572 6174 696f 6e73 223a 2073 656c  _durations": sel
+0000eb80: 662e 756e 6b6e 6f77 6e5f 6475 7261 7469  f.unknown_durati
+0000eb90: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000eba0: 2022 7661 6c69 6461 7465 223a 2073 656c   "validate": sel
+0000ebb0: 662e 7661 6c69 6461 7465 2c0a 2020 2020  f.validate,.    
+0000ebc0: 2020 2020 2020 2020 2274 6173 6b73 223a          "tasks":
+0000ebd0: 2073 656c 662e 7461 736b 732c 0a20 2020   self.tasks,.   
+0000ebe0: 2020 2020 2020 2020 2022 7461 736b 5f67           "task_g
+0000ebf0: 726f 7570 7322 3a20 7365 6c66 2e74 6173  roups": self.tas
+0000ec00: 6b5f 6772 6f75 7073 2c0a 2020 2020 2020  k_groups,.      
+0000ec10: 2020 2020 2020 2274 6173 6b5f 7072 6566        "task_pref
+0000ec20: 6978 6573 223a 2073 656c 662e 7461 736b  ixes": self.task
+0000ec30: 5f70 7265 6669 7865 732c 0a20 2020 2020  _prefixes,.     
+0000ec40: 2020 2020 2020 2022 746f 7461 6c5f 6e74         "total_nt
+0000ec50: 6872 6561 6473 223a 2073 656c 662e 746f  hreads": self.to
+0000ec60: 7461 6c5f 6e74 6872 6561 6473 2c0a 2020  tal_nthreads,.  
+0000ec70: 2020 2020 2020 2020 2020 2274 6f74 616c            "total
+0000ec80: 5f6f 6363 7570 616e 6379 223a 2073 656c  _occupancy": sel
+0000ec90: 662e 746f 7461 6c5f 6f63 6375 7061 6e63  f.total_occupanc
+0000eca0: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+0000ecb0: 6572 7265 645f 7461 736b 7322 3a20 7365  erred_tasks": se
+0000ecc0: 6c66 2e65 7272 6564 5f74 6173 6b73 2c0a  lf.erred_tasks,.
+0000ecd0: 2020 2020 2020 2020 2020 2020 2265 7874              "ext
+0000ece0: 656e 7369 6f6e 7322 3a20 7365 6c66 2e65  ensions": self.e
+0000ecf0: 7874 656e 7369 6f6e 732c 0a20 2020 2020  xtensions,.     
+0000ed00: 2020 2020 2020 2022 636c 6965 6e74 7322         "clients"
+0000ed10: 3a20 7365 6c66 2e63 6c69 656e 7473 2c0a  : self.clients,.
+0000ed20: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
+0000ed30: 6b65 7273 223a 2073 656c 662e 776f 726b  kers": self.work
+0000ed40: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+0000ed50: 2022 6964 6c65 223a 2073 656c 662e 6964   "idle": self.id
+0000ed60: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+0000ed70: 2268 6f73 745f 696e 666f 223a 2073 656c  "host_info": sel
+0000ed80: 662e 686f 7374 5f69 6e66 6f2c 0a20 2020  f.host_info,.   
+0000ed90: 2020 2020 207d 0a0a 2020 2020 6465 6620       }..    def 
+0000eda0: 6e65 775f 7461 736b 280a 2020 2020 2020  new_task(.      
+0000edb0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0000edc0: 6b65 793a 2073 7472 2c0a 2020 2020 2020  key: str,.      
+0000edd0: 2020 7370 6563 3a20 6f62 6a65 6374 2c0a    spec: object,.
+0000ede0: 2020 2020 2020 2020 7374 6174 653a 2054          state: T
+0000edf0: 6173 6b53 7461 7465 5374 6174 652c 0a20  askStateState,. 
+0000ee00: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
+0000ee10: 6f6e 3a20 436f 6d70 7574 6174 696f 6e20  on: Computation 
+0000ee20: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0000ee30: 2020 2029 202d 3e20 5461 736b 5374 6174     ) -> TaskStat
+0000ee40: 653a 0a20 2020 2020 2020 2022 2222 4372  e:.        """Cr
+0000ee50: 6561 7465 2061 206e 6577 2074 6173 6b2c  eate a new task,
+0000ee60: 2061 6e64 2061 7373 6f63 6961 7465 6420   and associated 
+0000ee70: 7374 6174 6573 2222 220a 2020 2020 2020  states""".      
+0000ee80: 2020 7473 203d 2054 6173 6b53 7461 7465    ts = TaskState
+0000ee90: 286b 6579 2c20 7370 6563 2c20 7374 6174  (key, spec, stat
+0000eea0: 6529 0a0a 2020 2020 2020 2020 7072 6566  e)..        pref
+0000eeb0: 6978 5f6b 6579 203d 206b 6579 5f73 706c  ix_key = key_spl
+0000eec0: 6974 286b 6579 290a 2020 2020 2020 2020  it(key).        
+0000eed0: 7470 203d 2073 656c 662e 7461 736b 5f70  tp = self.task_p
+0000eee0: 7265 6669 7865 732e 6765 7428 7072 6566  refixes.get(pref
+0000eef0: 6978 5f6b 6579 290a 2020 2020 2020 2020  ix_key).        
+0000ef00: 6966 2074 7020 6973 204e 6f6e 653a 0a20  if tp is None:. 
+0000ef10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000ef20: 7461 736b 5f70 7265 6669 7865 735b 7072  task_prefixes[pr
+0000ef30: 6566 6978 5f6b 6579 5d20 3d20 7470 203d  efix_key] = tp =
+0000ef40: 2054 6173 6b50 7265 6669 7828 7072 6566   TaskPrefix(pref
+0000ef50: 6978 5f6b 6579 290a 2020 2020 2020 2020  ix_key).        
+0000ef60: 7473 2e70 7265 6669 7820 3d20 7470 0a0a  ts.prefix = tp..
+0000ef70: 2020 2020 2020 2020 6772 6f75 705f 6b65          group_ke
+0000ef80: 7920 3d20 7473 2e67 726f 7570 5f6b 6579  y = ts.group_key
+0000ef90: 0a20 2020 2020 2020 2074 6720 3d20 7365  .        tg = se
+0000efa0: 6c66 2e74 6173 6b5f 6772 6f75 7073 2e67  lf.task_groups.g
+0000efb0: 6574 2867 726f 7570 5f6b 6579 290a 2020  et(group_key).  
+0000efc0: 2020 2020 2020 6966 2074 6720 6973 204e        if tg is N
+0000efd0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000efe0: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
+0000eff0: 735b 6772 6f75 705f 6b65 795d 203d 2074  s[group_key] = t
+0000f000: 6720 3d20 5461 736b 4772 6f75 7028 6772  g = TaskGroup(gr
+0000f010: 6f75 705f 6b65 7929 0a20 2020 2020 2020  oup_key).       
+0000f020: 2020 2020 2069 6620 636f 6d70 7574 6174       if computat
+0000f030: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+0000f040: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
+0000f050: 2e67 726f 7570 732e 6164 6428 7467 290a  .groups.add(tg).
+0000f060: 2020 2020 2020 2020 2020 2020 7467 2e70              tg.p
+0000f070: 7265 6669 7820 3d20 7470 0a20 2020 2020  refix = tp.     
+0000f080: 2020 2020 2020 2074 702e 6772 6f75 7073         tp.groups
+0000f090: 2e61 7070 656e 6428 7467 290a 2020 2020  .append(tg).    
+0000f0a0: 2020 2020 7467 2e61 6464 2874 7329 0a0a      tg.add(ts)..
+0000f0b0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000f0c0: 6b73 5b6b 6579 5d20 3d20 7473 0a0a 2020  ks[key] = ts..  
+0000f0d0: 2020 2020 2020 7265 7475 726e 2074 730a        return ts.
+0000f0e0: 0a20 2020 2064 6566 205f 636c 6561 725f  .    def _clear_
+0000f0f0: 7461 736b 5f73 7461 7465 2873 656c 6629  task_state(self)
+0000f100: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000f110: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+0000f120: 436c 6561 7220 7461 736b 2073 7461 7465  Clear task state
+0000f130: 2229 0a20 2020 2020 2020 2066 6f72 2063  ").        for c
+0000f140: 6f6c 6c65 6374 696f 6e20 696e 2028 0a20  ollection in (. 
+0000f150: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f160: 756e 7275 6e6e 6162 6c65 2c0a 2020 2020  unrunnable,.    
+0000f170: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
+0000f180: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
+0000f190: 2020 2020 2020 7365 6c66 2e63 6f6d 7075        self.compu
+0000f1a0: 7461 7469 6f6e 732c 0a20 2020 2020 2020  tations,.       
+0000f1b0: 2020 2020 2073 656c 662e 7461 736b 5f70       self.task_p
+0000f1c0: 7265 6669 7865 732c 0a20 2020 2020 2020  refixes,.       
+0000f1d0: 2020 2020 2073 656c 662e 7461 736b 5f67       self.task_g
+0000f1e0: 726f 7570 732c 0a20 2020 2020 2020 2020  roups,.         
+0000f1f0: 2020 2073 656c 662e 7461 736b 5f6d 6574     self.task_met
+0000f200: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
+0000f210: 2020 2073 656c 662e 756e 6b6e 6f77 6e5f     self.unknown_
+0000f220: 6475 7261 7469 6f6e 732c 0a20 2020 2020  durations,.     
+0000f230: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
+0000f240: 6963 6174 6564 5f74 6173 6b73 2c0a 2020  icated_tasks,.  
+0000f250: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+0000f260: 2020 2020 2063 6f6c 6c65 6374 696f 6e2e       collection.
+0000f270: 636c 6561 7228 2920 2023 2074 7970 653a  clear()  # type:
+0000f280: 2069 676e 6f72 650a 0a20 2020 2040 7072   ignore..    @pr
+0000f290: 6f70 6572 7479 0a20 2020 2064 6566 2069  operty.    def i
+0000f2a0: 735f 6964 6c65 2873 656c 6629 202d 3e20  s_idle(self) -> 
+0000f2b0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
+0000f2c0: 2252 6574 7572 6e20 5472 7565 2069 6666  "Return True iff
+0000f2d0: 2074 6865 7265 2061 7265 206e 6f20 7461   there are no ta
+0000f2e0: 736b 7320 7468 6174 2068 6176 656e 2774  sks that haven't
+0000f2f0: 2066 696e 6973 6865 6420 636f 6d70 7574   finished comput
+0000f300: 696e 672e 0a0a 2020 2020 2020 2020 556e  ing...        Un
+0000f310: 6c69 6b65 2074 6573 7469 6e67 2060 6073  like testing ``s
+0000f320: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
+0000f330: 6e63 7960 602c 2074 6869 7320 7072 6f70  ncy``, this prop
+0000f340: 6572 7479 2072 6574 7572 6e73 2046 616c  erty returns Fal
+0000f350: 7365 2069 6620 7468 6572 6520 6172 650a  se if there are.
+0000f360: 2020 2020 2020 2020 6c6f 6e67 2d72 756e          long-run
+0000f370: 6e69 6e67 2074 6173 6b73 2c20 6e6f 2d77  ning tasks, no-w
+0000f380: 6f72 6b65 722c 206f 7220 7175 6575 6564  orker, or queued
+0000f390: 2074 6173 6b73 2028 6475 6520 746f 206e   tasks (due to n
+0000f3a0: 6f74 2068 6176 696e 6720 616e 7920 776f  ot having any wo
+0000f3b0: 726b 6572 7329 2e0a 0a20 2020 2020 2020  rkers)...       
+0000f3c0: 204e 6f74 2074 6f20 6265 2063 6f6e 6675   Not to be confu
+0000f3d0: 7365 6420 7769 7468 2060 6069 646c 6560  sed with ``idle`
+0000f3e0: 602e 0a20 2020 2020 2020 2022 2222 0a20  `..        """. 
+0000f3f0: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
+0000f400: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
+0000f410: 6f75 6e74 203d 3d20 3020 6f72 2073 7461  ount == 0 or sta
+0000f420: 7465 2069 6e20 7b22 6d65 6d6f 7279 222c  te in {"memory",
+0000f430: 2022 6572 726f 7222 2c20 2272 656c 6561   "error", "relea
+0000f440: 7365 6422 2c20 2266 6f72 676f 7474 656e  sed", "forgotten
+0000f450: 227d 0a20 2020 2020 2020 2020 2020 2066  "}.            f
+0000f460: 6f72 2074 6720 696e 2073 656c 662e 7461  or tg in self.ta
+0000f470: 736b 5f67 726f 7570 732e 7661 6c75 6573  sk_groups.values
+0000f480: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
+0000f490: 6f72 2073 7461 7465 2c20 636f 756e 7420  or state, count 
+0000f4a0: 696e 2074 672e 7374 6174 6573 2e69 7465  in tg.states.ite
+0000f4b0: 6d73 2829 0a20 2020 2020 2020 2029 0a0a  ms().        )..
+0000f4c0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+0000f4d0: 2020 6465 6620 746f 7461 6c5f 6f63 6375    def total_occu
+0000f4e0: 7061 6e63 7928 7365 6c66 2920 2d3e 2066  pancy(self) -> f
+0000f4f0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
+0000f500: 7475 726e 2073 656c 662e 5f63 616c 635f  turn self._calc_
+0000f510: 6f63 6375 7061 6e63 7928 0a20 2020 2020  occupancy(.     
+0000f520: 2020 2020 2020 2073 656c 662e 5f74 6173         self._tas
+0000f530: 6b5f 7072 6566 6978 5f63 6f75 6e74 5f67  k_prefix_count_g
+0000f540: 6c6f 6261 6c2c 0a20 2020 2020 2020 2020  lobal,.         
+0000f550: 2020 2073 656c 662e 5f6e 6574 776f 726b     self._network
+0000f560: 5f6f 6363 5f67 6c6f 6261 6c2c 0a20 2020  _occ_global,.   
+0000f570: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0000f580: 5f63 616c 635f 6f63 6375 7061 6e63 7928  _calc_occupancy(
+0000f590: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0000f5a0: 2020 2020 2020 2074 6173 6b5f 7072 6566         task_pref
+0000f5b0: 6978 5f63 6f75 6e74 3a20 6469 6374 5b73  ix_count: dict[s
+0000f5c0: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
+0000f5d0: 2020 6e65 7477 6f72 6b5f 6f63 633a 2066    network_occ: f
+0000f5e0: 6c6f 6174 2c0a 2020 2020 2920 2d3e 2066  loat,.    ) -> f
+0000f5f0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
+0000f600: 7320 3d20 302e 300a 2020 2020 2020 2020  s = 0.0.        
+0000f610: 666f 7220 7072 6566 6978 5f6e 616d 652c  for prefix_name,
+0000f620: 2063 6f75 6e74 2069 6e20 7461 736b 5f70   count in task_p
+0000f630: 7265 6669 785f 636f 756e 742e 6974 656d  refix_count.item
+0000f640: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000f650: 2023 2054 4f44 4f3a 2044 6561 6c20 7769   # TODO: Deal wi
+0000f660: 7468 2075 6e6b 6e6f 776e 2074 6173 6b73  th unknown tasks
+0000f670: 2062 6574 7465 720a 2020 2020 2020 2020   better.        
+0000f680: 2020 2020 7072 6566 6978 203d 2073 656c      prefix = sel
+0000f690: 662e 7461 736b 5f70 7265 6669 7865 735b  f.task_prefixes[
+0000f6a0: 7072 6566 6978 5f6e 616d 655d 0a20 2020  prefix_name].   
+0000f6b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000f6c0: 7072 6566 6978 2069 7320 6e6f 7420 4e6f  prefix is not No
+0000f6d0: 6e65 0a20 2020 2020 2020 2020 2020 2064  ne.            d
+0000f6e0: 7572 6174 696f 6e20 3d20 7072 6566 6978  uration = prefix
+0000f6f0: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
+0000f700: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+0000f710: 2064 7572 6174 696f 6e20 3c20 303a 0a20   duration < 0:. 
+0000f720: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000f730: 6620 7072 6566 6978 2e6d 6178 5f65 7865  f prefix.max_exe
+0000f740: 635f 7469 6d65 203e 2030 3a0a 2020 2020  c_time > 0:.    
+0000f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f760: 6475 7261 7469 6f6e 203d 2032 202a 2070  duration = 2 * p
+0000f770: 7265 6669 782e 6d61 785f 6578 6563 5f74  refix.max_exec_t
+0000f780: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
+0000f790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f7a0: 2020 2020 2020 2020 2020 2020 2020 6475                du
+0000f7b0: 7261 7469 6f6e 203d 2073 656c 662e 554e  ration = self.UN
+0000f7c0: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
+0000f7d0: 494f 4e0a 2020 2020 2020 2020 2020 2020  ION.            
+0000f7e0: 7265 7320 2b3d 2064 7572 6174 696f 6e20  res += duration 
+0000f7f0: 2a20 636f 756e 740a 2020 2020 2020 2020  * count.        
+0000f800: 6f63 6320 3d20 7265 7320 2b20 6e65 7477  occ = res + netw
+0000f810: 6f72 6b5f 6f63 6320 2f20 7365 6c66 2e62  ork_occ / self.b
+0000f820: 616e 6477 6964 7468 0a20 2020 2020 2020  andwidth.       
+0000f830: 2061 7373 6572 7420 6f63 6320 3e3d 2030   assert occ >= 0
+0000f840: 2c20 6f63 630a 2020 2020 2020 2020 7265  , occ.        re
+0000f850: 7475 726e 206f 6363 0a0a 2020 2020 2323  turn occ..    ##
+0000f860: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f870: 2323 230a 2020 2020 2320 5374 6174 6520  ###.    # State 
+0000f880: 5472 616e 7369 7469 6f6e 7320 230a 2020  Transitions #.  
+0000f890: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0000f8a0: 2323 2323 2323 230a 0a20 2020 2064 6566  #######..    def
+0000f8b0: 205f 7472 616e 7369 7469 6f6e 280a 2020   _transition(.  
+0000f8c0: 2020 2020 2020 7365 6c66 2c20 6b65 793a        self, key:
+0000f8d0: 2073 7472 2c20 6669 6e69 7368 3a20 5461   str, finish: Ta
+0000f8e0: 736b 5374 6174 6553 7461 7465 2c20 7374  skStateState, st
+0000f8f0: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
+0000f900: 2a2a 6b77 6172 6773 3a20 416e 790a 2020  **kwargs: Any.  
+0000f910: 2020 2920 2d3e 2052 6563 734d 7367 733a    ) -> RecsMsgs:
+0000f920: 0a20 2020 2020 2020 2022 2222 5472 616e  .        """Tran
+0000f930: 7369 7469 6f6e 2061 206b 6579 2066 726f  sition a key fro
+0000f940: 6d20 6974 7320 6375 7272 656e 7420 7374  m its current st
+0000f950: 6174 6520 746f 2074 6865 2066 696e 6973  ate to the finis
+0000f960: 6820 7374 6174 650a 0a20 2020 2020 2020  h state..       
+0000f970: 2045 7861 6d70 6c65 730a 2020 2020 2020   Examples.      
+0000f980: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+0000f990: 2020 203e 3e3e 2073 656c 662e 5f74 7261     >>> self._tra
+0000f9a0: 6e73 6974 696f 6e28 2778 272c 2027 7761  nsition('x', 'wa
+0000f9b0: 6974 696e 6727 290a 2020 2020 2020 2020  iting').        
+0000f9c0: 7b27 7827 3a20 2770 726f 6365 7373 696e  {'x': 'processin
+0000f9d0: 6727 7d2c 207b 7d2c 207b 7d0a 0a20 2020  g'}, {}, {}..   
+0000f9e0: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+0000f9f0: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+0000fa00: 2020 2020 2054 7570 6c65 206f 663a 0a0a       Tuple of:..
+0000fa10: 2020 2020 2020 2020 2d20 4469 6374 696f          - Dictio
+0000fa20: 6e61 7279 206f 6620 7265 636f 6d6d 656e  nary of recommen
+0000fa30: 6461 7469 6f6e 7320 666f 7220 6675 7475  dations for futu
+0000fa40: 7265 2074 7261 6e73 6974 696f 6e73 207b  re transitions {
+0000fa50: 6b65 793a 206e 6577 2073 7461 7465 7d0a  key: new state}.
+0000fa60: 2020 2020 2020 2020 2d20 4d65 7373 6167          - Messag
+0000fa70: 6573 2074 6f20 636c 6965 6e74 7320 7b63  es to clients {c
+0000fa80: 6c69 656e 7420 6164 6472 6573 733a 205b  lient address: [
+0000fa90: 6d73 672c 206d 7367 2c20 2e2e 2e5d 7d0a  msg, msg, ...]}.
+0000faa0: 2020 2020 2020 2020 2d20 4d65 7373 6167          - Messag
+0000fab0: 6573 2074 6f20 776f 726b 6572 7320 7b77  es to workers {w
+0000fac0: 6f72 6b65 7220 6164 6472 6573 733a 205b  orker address: [
+0000fad0: 6d73 672c 206d 7367 2c20 2e2e 2e5d 7d0a  msg, msg, ...]}.
+0000fae0: 0a20 2020 2020 2020 2053 6565 2041 6c73  .        See Als
+0000faf0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+0000fb00: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
+0000fb10: 756c 6572 2e74 7261 6e73 6974 696f 6e73  uler.transitions
+0000fb20: 203a 2074 7261 6e73 6974 6976 6520 7665   : transitive ve
+0000fb30: 7273 696f 6e20 6f66 2074 6869 7320 6675  rsion of this fu
+0000fb40: 6e63 7469 6f6e 0a20 2020 2020 2020 2022  nction.        "
+0000fb50: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+0000fb60: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+0000fb70: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
+0000fb80: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0000fb90: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
+0000fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbb0: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
+0000fbc0: 7d0a 2020 2020 2020 2020 2020 2020 7374  }.            st
+0000fbd0: 6172 7420 3d20 7473 2e5f 7374 6174 650a  art = ts._state.
+0000fbe0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000fbf0: 7461 7274 203d 3d20 6669 6e69 7368 3a0a  tart == finish:.
+0000fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc10: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
+0000fc20: 7d0a 0a20 2020 2020 2020 2020 2020 2023  }..            #
+0000fc30: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
+0000fc40: 2020 2020 2320 2d20 696e 2063 6173 6520      # - in case 
+0000fc50: 6f66 2074 7261 6e73 6974 696f 6e20 7468  of transition th
+0000fc60: 726f 7567 6820 7265 6c65 6173 6564 2c20  rough released, 
+0000fc70: 7468 6973 2063 6f75 6e74 6572 2069 7320  this counter is 
+0000fc80: 696e 6372 656d 656e 7465 6420 6279 2032  incremented by 2
+0000fc90: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
+0000fca0: 2074 6869 7320 696e 6372 6561 7365 2068   this increase h
+0000fcb0: 6170 7065 6e73 2062 6566 6f72 6520 7468  appens before th
+0000fcc0: 6520 6163 7475 616c 2074 7261 6e73 6974  e actual transit
+0000fcd0: 696f 6e73 2c20 736f 2074 6861 7420 6974  ions, so that it
+0000fce0: 2063 616e 0a20 2020 2020 2020 2020 2020   can.           
+0000fcf0: 2023 2020 2063 6174 6368 2070 6f74 656e   #   catch poten
+0000fd00: 7469 616c 2069 6e66 696e 6974 6520 7265  tial infinite re
+0000fd10: 6375 7273 696f 6e73 0a20 2020 2020 2020  cursions.       
+0000fd20: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
+0000fd30: 7469 6f6e 5f63 6f75 6e74 6572 202b 3d20  tion_counter += 
+0000fd40: 310a 2020 2020 2020 2020 2020 2020 6966  1.            if
+0000fd50: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+0000fd60: 5f63 6f75 6e74 6572 5f6d 6178 3a0a 2020  _counter_max:.  
+0000fd70: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000fd80: 7365 7274 2073 656c 662e 7472 616e 7369  sert self.transi
+0000fd90: 7469 6f6e 5f63 6f75 6e74 6572 203c 2073  tion_counter < s
+0000fda0: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
+0000fdb0: 6f75 6e74 6572 5f6d 6178 0a0a 2020 2020  ounter_max..    
+0000fdc0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0000fdd0: 6461 7469 6f6e 733a 2064 6963 7420 3d20  dations: dict = 
+0000fde0: 7b7d 0a20 2020 2020 2020 2020 2020 2077  {}.            w
+0000fdf0: 6f72 6b65 725f 6d73 6773 3a20 6469 6374  orker_msgs: dict
+0000fe00: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+0000fe10: 2020 636c 6965 6e74 5f6d 7367 733a 2064    client_msgs: d
+0000fe20: 6963 7420 3d20 7b7d 0a0a 2020 2020 2020  ict = {}..      
+0000fe30: 2020 2020 2020 6966 2073 656c 662e 706c        if self.pl
+0000fe40: 7567 696e 733a 0a20 2020 2020 2020 2020  ugins:.         
+0000fe50: 2020 2020 2020 2064 6570 656e 6465 6e74         dependent
+0000fe60: 7320 3d20 7365 7428 7473 2e64 6570 656e  s = set(ts.depen
+0000fe70: 6465 6e74 7329 0a20 2020 2020 2020 2020  dents).         
+0000fe80: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+0000fe90: 6965 7320 3d20 7365 7428 7473 2e64 6570  ies = set(ts.dep
+0000fea0: 656e 6465 6e63 6965 7329 0a0a 2020 2020  endencies)..    
+0000feb0: 2020 2020 2020 2020 6675 6e63 203d 2073          func = s
+0000fec0: 656c 662e 5f54 5241 4e53 4954 494f 4e53  elf._TRANSITIONS
+0000fed0: 5f54 4142 4c45 2e67 6574 2828 7374 6172  _TABLE.get((star
+0000fee0: 742c 2066 696e 6973 6829 290a 2020 2020  t, finish)).    
+0000fef0: 2020 2020 2020 2020 6966 2066 756e 6320          if func 
+0000ff00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000ff10: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0000ff20: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
+0000ff30: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+0000ff40: 725f 6d73 6773 203d 2066 756e 6328 0a20  r_msgs = func(. 
+0000ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff60: 2020 2073 656c 662c 206b 6579 2c20 7374     self, key, st
+0000ff70: 696d 756c 7573 5f69 642c 202a 2a6b 7761  imulus_id, **kwa
+0000ff80: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
+0000ff90: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000ffa0: 2020 2065 6c69 6620 2272 656c 6561 7365     elif "release
+0000ffb0: 6422 206e 6f74 2069 6e20 2873 7461 7274  d" not in (start
+0000ffc0: 2c20 6669 6e69 7368 293a 0a20 2020 2020  , finish):.     
+0000ffd0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000ffe0: 7420 6e6f 7420 6b77 6172 6773 2c20 286b  t not kwargs, (k
+0000fff0: 7761 7267 732c 2073 7461 7274 2c20 6669  wargs, start, fi
+00010000: 6e69 7368 290a 2020 2020 2020 2020 2020  nish).          
+00010010: 2020 2020 2020 615f 7265 6373 2c20 615f        a_recs, a_
+00010020: 636d 7367 732c 2061 5f77 6d73 6773 203d  cmsgs, a_wmsgs =
+00010030: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+00010040: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00010050: 2020 2020 2020 206b 6579 2c20 2272 656c         key, "rel
+00010060: 6561 7365 6422 2c20 7374 696d 756c 7573  eased", stimulus
+00010070: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+00010080: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00010090: 2020 2020 2020 2076 203d 2061 5f72 6563         v = a_rec
+000100a0: 732e 6765 7428 6b65 792c 2066 696e 6973  s.get(key, finis
+000100b0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+000100c0: 2020 2066 756e 6320 3d20 7365 6c66 2e5f     func = self._
+000100d0: 5452 414e 5349 5449 4f4e 535f 5441 424c  TRANSITIONS_TABL
+000100e0: 455b 2272 656c 6561 7365 6422 2c20 765d  E["released", v]
+000100f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010100: 2062 5f72 6563 732c 2062 5f63 6d73 6773   b_recs, b_cmsgs
+00010110: 2c20 625f 776d 7367 7320 3d20 6675 6e63  , b_wmsgs = func
+00010120: 2873 656c 662c 206b 6579 2c20 7374 696d  (self, key, stim
+00010130: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
+00010140: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+00010150: 656e 6461 7469 6f6e 732e 7570 6461 7465  endations.update
+00010160: 2861 5f72 6563 7329 0a20 2020 2020 2020  (a_recs).       
+00010170: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
+00010180: 6e65 775f 6d73 6773 2069 6e20 615f 636d  new_msgs in a_cm
+00010190: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
+000101a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101b0: 2063 6c69 656e 745f 6d73 6773 2e73 6574   client_msgs.set
+000101c0: 6465 6661 756c 7428 632c 205b 5d29 2e65  default(c, []).e
+000101d0: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
+000101e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101f0: 666f 7220 772c 206e 6577 5f6d 7367 7320  for w, new_msgs 
+00010200: 696e 2061 5f77 6d73 6773 2e69 7465 6d73  in a_wmsgs.items
+00010210: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00010220: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+00010230: 7367 732e 7365 7464 6566 6175 6c74 2877  sgs.setdefault(w
+00010240: 2c20 5b5d 292e 6578 7465 6e64 286e 6577  , []).extend(new
+00010250: 5f6d 7367 7329 0a0a 2020 2020 2020 2020  _msgs)..        
+00010260: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00010270: 6461 7469 6f6e 732e 7570 6461 7465 2862  dations.update(b
+00010280: 5f72 6563 7329 0a20 2020 2020 2020 2020  _recs).         
+00010290: 2020 2020 2020 2066 6f72 2063 2c20 6e65         for c, ne
+000102a0: 775f 6d73 6773 2069 6e20 625f 636d 7367  w_msgs in b_cmsg
+000102b0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+000102c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000102d0: 6c69 656e 745f 6d73 6773 2e73 6574 6465  lient_msgs.setde
+000102e0: 6661 756c 7428 632c 205b 5d29 2e65 7874  fault(c, []).ext
+000102f0: 656e 6428 6e65 775f 6d73 6773 290a 2020  end(new_msgs).  
+00010300: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00010310: 7220 772c 206e 6577 5f6d 7367 7320 696e  r w, new_msgs in
+00010320: 2062 5f77 6d73 6773 2e69 7465 6d73 2829   b_wmsgs.items()
+00010330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010340: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00010350: 732e 7365 7464 6566 6175 6c74 2877 2c20  s.setdefault(w, 
+00010360: 5b5d 292e 6578 7465 6e64 286e 6577 5f6d  []).extend(new_m
+00010370: 7367 7329 0a0a 2020 2020 2020 2020 2020  sgs)..          
+00010380: 2020 2020 2020 7374 6172 7420 3d20 2272        start = "r
+00010390: 656c 6561 7365 6422 0a20 2020 2020 2020  eleased".       
+000103a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000103b0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000103c0: 2052 756e 7469 6d65 4572 726f 7228 0a20   RuntimeError(. 
 000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103e0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-000103f0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00010400: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00010410: 6d75 6c75 735f 6964 206e 6f74 2073 6574  mulus_id not set
-00010420: 2064 7572 696e 6720 5363 6865 6475 6c65   during Schedule
-00010430: 7220 7472 616e 7369 7469 6f6e 220a 2020  r transition".  
-00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010450: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00010460: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00010470: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010480: 2020 2020 2020 2254 7261 6e73 6974 696f        "Transitio
-00010490: 6e65 6420 2572 2025 732d 3e25 7320 2861  ned %r %s->%s (a
-000104a0: 6374 7561 6c3a 2025 7329 2e20 2043 6f6e  ctual: %s).  Con
-000104b0: 7365 7175 656e 6365 3a20 2573 222c 0a20  sequence: %s",. 
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104d0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
-000104e0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000104f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00010500: 2020 2020 2020 2066 696e 6973 682c 0a20         finish,. 
-00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010520: 2020 2061 6374 7561 6c5f 6669 6e69 7368     actual_finish
-00010530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010540: 2020 2020 2020 6469 6374 2872 6563 6f6d        dict(recom
-00010550: 6d65 6e64 6174 696f 6e73 292c 0a20 2020  mendations),.   
-00010560: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00010570: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00010580: 6c66 2e70 6c75 6769 6e73 3a0a 2020 2020  lf.plugins:.    
-00010590: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-000105a0: 6d70 6f72 6172 696c 7920 7075 7420 6261  mporarily put ba
-000105b0: 636b 2066 6f72 676f 7474 656e 206b 6579  ck forgotten key
-000105c0: 2066 6f72 2070 6c75 6769 6e20 746f 2072   for plugin to r
-000105d0: 6574 7269 6576 6520 6974 0a20 2020 2020  etrieve it.     
-000105e0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-000105f0: 2e5f 7374 6174 6520 3d3d 2022 666f 7267  ._state == "forg
-00010600: 6f74 7465 6e22 3a0a 2020 2020 2020 2020  otten":.        
-00010610: 2020 2020 2020 2020 2020 2020 7473 2e64              ts.d
-00010620: 6570 656e 6465 6e74 7320 3d20 6465 7065  ependents = depe
-00010630: 6e64 656e 7473 0a20 2020 2020 2020 2020  ndents.         
-00010640: 2020 2020 2020 2020 2020 2074 732e 6465             ts.de
-00010650: 7065 6e64 656e 6369 6573 203d 2064 6570  pendencies = dep
-00010660: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
-00010670: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00010680: 6c66 2e74 6173 6b73 5b74 732e 6b65 795d  lf.tasks[ts.key]
-00010690: 203d 2074 730a 2020 2020 2020 2020 2020   = ts.          
-000106a0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
-000106b0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-000106c0: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
-000106d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000106e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000106f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010700: 2020 706c 7567 696e 2e74 7261 6e73 6974    plugin.transit
-00010710: 696f 6e28 6b65 792c 2073 7461 7274 2c20  ion(key, start, 
-00010720: 6163 7475 616c 5f66 696e 6973 682c 202a  actual_finish, *
-00010730: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-00010740: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00010750: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00010780: 666f 2822 506c 7567 696e 2066 6169 6c65  fo("Plugin faile
-00010790: 6420 7769 7468 2065 7863 6570 7469 6f6e  d with exception
-000107a0: 222c 2065 7863 5f69 6e66 6f3d 5472 7565  ", exc_info=True
-000107b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000107c0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
-000107d0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
-000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107f0: 2020 6465 6c20 7365 6c66 2e74 6173 6b73    del self.tasks
-00010800: 5b74 732e 6b65 795d 0a0a 2020 2020 2020  [ts.key]..      
-00010810: 2020 2020 2020 7467 203d 2074 732e 6772        tg = ts.gr
-00010820: 6f75 700a 2020 2020 2020 2020 2020 2020  oup.            
-00010830: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
-00010840: 666f 7267 6f74 7465 6e22 2061 6e64 2074  forgotten" and t
-00010850: 672e 6e61 6d65 2069 6e20 7365 6c66 2e74  g.name in self.t
-00010860: 6173 6b5f 6772 6f75 7073 3a0a 2020 2020  ask_groups:.    
-00010870: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-00010880: 6d6f 7665 2054 6173 6b47 726f 7570 2069  move TaskGroup i
-00010890: 6620 616c 6c20 7461 736b 7320 6172 6520  f all tasks are 
-000108a0: 696e 2074 6865 2066 6f72 676f 7474 656e  in the forgotten
-000108b0: 2073 7461 7465 0a20 2020 2020 2020 2020   state.         
-000108c0: 2020 2020 2020 2069 6620 616c 6c28 7620         if all(v 
-000108d0: 3d3d 2030 206f 7220 6b20 3d3d 2022 666f  == 0 or k == "fo
-000108e0: 7267 6f74 7465 6e22 2066 6f72 206b 2c20  rgotten" for k, 
-000108f0: 7620 696e 2074 672e 7374 6174 6573 2e69  v in tg.states.i
-00010900: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
-00010910: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00010920: 7072 6566 6978 2e67 726f 7570 732e 7265  prefix.groups.re
-00010930: 6d6f 7665 2874 6729 0a20 2020 2020 2020  move(tg).       
-00010940: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00010950: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-00010960: 735b 7467 2e6e 616d 655d 0a0a 2020 2020  s[tg.name]..    
-00010970: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00010980: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-00010990: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-000109a0: 6b65 725f 6d73 6773 0a20 2020 2020 2020  ker_msgs.       
-000109b0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-000109c0: 6e3a 0a20 2020 2020 2020 2020 2020 206c  n:.            l
-000109d0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-000109e0: 2245 7272 6f72 2074 7261 6e73 6974 696f  "Error transitio
-000109f0: 6e69 6e67 2025 7220 6672 6f6d 2025 7220  ning %r from %r 
-00010a00: 746f 2025 7222 2c20 6b65 792c 2073 7461  to %r", key, sta
-00010a10: 7274 2c20 6669 6e69 7368 290a 2020 2020  rt, finish).    
-00010a20: 2020 2020 2020 2020 6966 204c 4f47 5f50          if LOG_P
-00010a30: 4442 3a0a 2020 2020 2020 2020 2020 2020  DB:.            
-00010a40: 2020 2020 696d 706f 7274 2070 6462 0a0a      import pdb..
-00010a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a60: 7064 622e 7365 745f 7472 6163 6528 290a  pdb.set_trace().
-00010a70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00010a80: 650a 0a20 2020 2064 6566 205f 7472 616e  e..    def _tran
-00010a90: 7369 7469 6f6e 7328 0a20 2020 2020 2020  sitions(.       
-00010aa0: 2073 656c 662c 0a20 2020 2020 2020 2072   self,.        r
-00010ab0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-00010ac0: 5265 6373 2c0a 2020 2020 2020 2020 636c  Recs,.        cl
-00010ad0: 6965 6e74 5f6d 7367 733a 204d 7367 732c  ient_msgs: Msgs,
-00010ae0: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00010af0: 6d73 6773 3a20 4d73 6773 2c0a 2020 2020  msgs: Msgs,.    
-00010b00: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
-00010b10: 2073 7472 2c0a 2020 2020 2920 2d3e 204e   str,.    ) -> N
-00010b20: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00010b30: 5072 6f63 6573 7320 7472 616e 7369 7469  Process transiti
-00010b40: 6f6e 7320 756e 7469 6c20 6e6f 6e65 2061  ons until none a
-00010b50: 7265 206c 6566 740a 0a20 2020 2020 2020  re left..       
-00010b60: 2054 6869 7320 696e 636c 7564 6573 2066   This includes f
-00010b70: 6565 6462 6163 6b20 6672 6f6d 2070 7265  eedback from pre
-00010b80: 7669 6f75 7320 7472 616e 7369 7469 6f6e  vious transition
-00010b90: 7320 616e 6420 636f 6e74 696e 7565 7320  s and continues 
-00010ba0: 756e 7469 6c20 7765 0a20 2020 2020 2020  until we.       
-00010bb0: 2072 6561 6368 2061 2073 7465 6164 7920   reach a steady 
-00010bc0: 7374 6174 650a 2020 2020 2020 2020 2222  state.        ""
-00010bd0: 220a 2020 2020 2020 2020 6b65 7973 3a20  ".        keys: 
-00010be0: 7365 745b 7374 725d 203d 2073 6574 2829  set[str] = set()
-00010bf0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00010c00: 6e64 6174 696f 6e73 203d 2072 6563 6f6d  ndations = recom
-00010c10: 6d65 6e64 6174 696f 6e73 2e63 6f70 7928  mendations.copy(
-00010c20: 290a 0a20 2020 2020 2020 2077 6869 6c65  )..        while
-00010c30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00010c40: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-00010c50: 792c 2066 696e 6973 6820 3d20 7265 636f  y, finish = reco
-00010c60: 6d6d 656e 6461 7469 6f6e 732e 706f 7069  mmendations.popi
-00010c70: 7465 6d28 290a 2020 2020 2020 2020 2020  tem().          
-00010c80: 2020 6b65 7973 2e61 6464 286b 6579 290a    keys.add(key).
-00010c90: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-00010ca0: 5f72 6563 732c 206e 6577 5f63 6d73 6773  _recs, new_cmsgs
-00010cb0: 2c20 6e65 775f 776d 7367 7320 3d20 7365  , new_wmsgs = se
-00010cc0: 6c66 2e5f 7472 616e 7369 7469 6f6e 286b  lf._transition(k
-00010cd0: 6579 2c20 6669 6e69 7368 2c20 7374 696d  ey, finish, stim
-00010ce0: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
-00010cf0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00010d00: 7469 6f6e 732e 7570 6461 7465 286e 6577  tions.update(new
-00010d10: 5f72 6563 7329 0a20 2020 2020 2020 2020  _recs).         
-00010d20: 2020 2066 6f72 2063 2c20 6e65 775f 6d73     for c, new_ms
-00010d30: 6773 2069 6e20 6e65 775f 636d 7367 732e  gs in new_cmsgs.
-00010d40: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00010d50: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-00010d60: 6d73 6773 2e73 6574 6465 6661 756c 7428  msgs.setdefault(
-00010d70: 632c 205b 5d29 2e65 7874 656e 6428 6e65  c, []).extend(ne
-00010d80: 775f 6d73 6773 290a 2020 2020 2020 2020  w_msgs).        
-00010d90: 2020 2020 666f 7220 772c 206e 6577 5f6d      for w, new_m
-00010da0: 7367 7320 696e 206e 6577 5f77 6d73 6773  sgs in new_wmsgs
-00010db0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00010dc0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00010dd0: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
-00010de0: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
-00010df0: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
-00010e00: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00010e10: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00010e20: 2320 4649 584d 4520 646f 776e 6361 7374  # FIXME downcast
-00010e30: 2061 6e74 6970 6174 7465 726e 0a20 2020   antipattern.   
-00010e40: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
-00010e50: 6572 203d 2063 6173 7428 5363 6865 6475  er = cast(Schedu
-00010e60: 6c65 722c 2073 656c 6629 0a20 2020 2020  ler, self).     
-00010e70: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00010e80: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-00010e90: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-00010ea0: 722e 7661 6c69 6461 7465 5f6b 6579 286b  r.validate_key(k
-00010eb0: 6579 290a 0a20 2020 2064 6566 2074 7261  ey)..    def tra
-00010ec0: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
-00010ed0: 5f77 6169 7469 6e67 2873 656c 662c 206b  _waiting(self, k
-00010ee0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
-00010ef0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00010f00: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00010f10: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00010f20: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
-00010f30: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00010f40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00010f50: 7274 2074 732e 7275 6e5f 7370 6563 0a20  rt ts.run_spec. 
-00010f60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00010f70: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00010f80: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-00010f90: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-00010fa0: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-00010fb0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00010fc0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
-00010fd0: 2020 2020 2020 2020 2020 666f 7220 6474            for dt
-00010fe0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00010ff0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-00011000: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
-00011010: 2e73 7461 7465 206e 6f74 2069 6e20 7b22  .state not in {"
-00011020: 666f 7267 6f74 7465 6e22 2c20 2265 7272  forgotten", "err
-00011030: 6564 227d 0a0a 2020 2020 2020 2020 6966  ed"}..        if
-00011040: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
-00011050: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00011060: 2020 2020 2020 2072 6574 7572 6e20 7b6b         return {k
-00011070: 6579 3a20 2266 6f72 676f 7474 656e 227d  ey: "forgotten"}
-00011080: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 2020  , {}, {}..      
-00011090: 2020 7473 2e73 7461 7465 203d 2022 7761    ts.state = "wa
-000110a0: 6974 696e 6722 0a0a 2020 2020 2020 2020  iting"..        
-000110b0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-000110c0: 2052 6563 7320 3d20 7b7d 0a0a 2020 2020   Recs = {}..    
-000110d0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-000110e0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-000110f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00011100: 6f74 2064 7473 2e77 686f 5f68 6173 3a0a  ot dts.who_has:.
-00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 7473 2e77 6169 7469 6e67 5f6f 6e2e 6164  ts.waiting_on.ad
-00011130: 6428 6474 7329 0a20 2020 2020 2020 2020  d(dts).         
-00011140: 2020 2069 6620 6474 732e 7374 6174 6520     if dts.state 
-00011150: 3d3d 2022 7265 6c65 6173 6564 223a 0a20  == "released":. 
-00011160: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011170: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
-00011180: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
-00011190: 6e67 220a 2020 2020 2020 2020 2020 2020  ng".            
-000111a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000111b0: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
-000111c0: 732e 6164 6428 7473 290a 0a20 2020 2020  s.add(ts)..     
-000111d0: 2020 2074 732e 7761 6974 6572 7320 3d20     ts.waiters = 
-000111e0: 7b64 7473 2066 6f72 2064 7473 2069 6e20  {dts for dts in 
-000111f0: 7473 2e64 6570 656e 6465 6e74 7320 6966  ts.dependents if
-00011200: 2064 7473 2e73 7461 7465 203d 3d20 2277   dts.state == "w
-00011210: 6169 7469 6e67 227d 0a0a 2020 2020 2020  aiting"}..      
-00011220: 2020 6966 206e 6f74 2074 732e 7761 6974    if not ts.wait
-00011230: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
-00011240: 2020 2020 2320 4e4f 5445 3a20 7761 6974      # NOTE: wait
-00011250: 696e 672d 3e70 726f 6365 7373 696e 6720  ing->processing 
-00011260: 7769 6c6c 2073 656e 6420 7461 736b 7320  will send tasks 
-00011270: 746f 2071 7565 7565 6420 6f72 206e 6f2d  to queued or no-
-00011280: 776f 726b 6572 2061 730a 2020 2020 2020  worker as.      
-00011290: 2020 2020 2020 2320 6e65 6365 7373 6172        # necessar
-000112a0: 790a 2020 2020 2020 2020 2020 2020 7265  y.            re
-000112b0: 636f 6d6d 656e 6461 7469 6f6e 735b 6b65  commendations[ke
-000112c0: 795d 203d 2022 7072 6f63 6573 7369 6e67  y] = "processing
-000112d0: 220a 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-000112e0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-000112f0: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
-00011300: 6566 2074 7261 6e73 6974 696f 6e5f 6e6f  ef transition_no
-00011310: 5f77 6f72 6b65 725f 7072 6f63 6573 7369  _worker_processi
-00011320: 6e67 2873 656c 662c 206b 6579 3a20 7374  ng(self, key: st
-00011330: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-00011340: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
-00011350: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-00011360: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-00011370: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00011380: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
-00011390: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-000113a0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-000113b0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-000113c0: 7473 2e61 6374 6f72 2c20 6622 4163 746f  ts.actor, f"Acto
-000113d0: 7273 2063 616e 2774 2062 6520 696e 2060  rs can't be in `
-000113e0: 6e6f 2d77 6f72 6b65 7260 3a20 7b74 737d  no-worker`: {ts}
-000113f0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
-00011400: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
-00011410: 756e 7275 6e6e 6162 6c65 0a0a 2020 2020  unrunnable..    
-00011420: 2020 2020 6966 2077 7320 3a3d 2073 656c      if ws := sel
-00011430: 662e 6465 6369 6465 5f77 6f72 6b65 725f  f.decide_worker_
-00011440: 6e6f 6e5f 726f 6f74 6973 6828 7473 293a  non_rootish(ts):
-00011450: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00011460: 662e 756e 7275 6e6e 6162 6c65 2e64 6973  f.unrunnable.dis
-00011470: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
-00011480: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00011490: 203d 2073 656c 662e 5f61 6464 5f74 6f5f   = self._add_to_
-000114a0: 7072 6f63 6573 7369 6e67 2874 732c 2077  processing(ts, w
-000114b0: 7329 0a20 2020 2020 2020 2023 2049 6620  s).        # If 
-000114c0: 6e6f 2077 6f72 6b65 722c 2074 6173 6b20  no worker, task 
-000114d0: 6a75 7374 2073 7461 7973 2069 6e20 606e  just stays in `n
-000114e0: 6f2d 776f 726b 6572 600a 0a20 2020 2020  o-worker`..     
-000114f0: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
-00011500: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
-00011510: 2020 2064 6566 2064 6563 6964 655f 776f     def decide_wo
-00011520: 726b 6572 5f72 6f6f 7469 7368 5f71 7565  rker_rootish_que
-00011530: 7569 6e67 5f64 6973 6162 6c65 6428 0a20  uing_disabled(. 
-00011540: 2020 2020 2020 2073 656c 662c 2074 733a         self, ts:
-00011550: 2054 6173 6b53 7461 7465 0a20 2020 2029   TaskState.    )
-00011560: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
-00011570: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
-00011580: 2222 2250 6963 6b20 6120 776f 726b 6572  """Pick a worker
-00011590: 2066 6f72 2061 2072 756e 6e61 626c 6520   for a runnable 
-000115a0: 726f 6f74 2d69 7368 2074 6173 6b2c 2077  root-ish task, w
-000115b0: 6974 686f 7574 2071 7565 7569 6e67 2e0a  ithout queuing..
-000115c0: 0a20 2020 2020 2020 2054 6869 7320 6174  .        This at
-000115d0: 7465 6d70 7473 2074 6f20 7363 6865 6475  tempts to schedu
-000115e0: 6c65 2073 6962 6c69 6e67 2074 6173 6b73  le sibling tasks
-000115f0: 206f 6e20 7468 6520 7361 6d65 2077 6f72   on the same wor
-00011600: 6b65 722c 2072 6564 7563 696e 6720 6675  ker, reducing fu
-00011610: 7475 7265 2064 6174 610a 2020 2020 2020  ture data.      
-00011620: 2020 7472 616e 7366 6572 2e20 4974 2064    transfer. It d
-00011630: 6f65 7320 6e6f 7420 636f 6e73 6964 6572  oes not consider
-00011640: 2074 6865 206c 6f63 6174 696f 6e20 6f66   the location of
-00011650: 2064 6570 656e 6465 6e63 6965 732c 2073   dependencies, s
-00011660: 696e 6365 2074 6865 7927 6c6c 2065 6e64  ince they'll end
-00011670: 0a20 2020 2020 2020 2075 7020 6f6e 2065  .        up on e
-00011680: 7665 7279 2077 6f72 6b65 7220 616e 7977  very worker anyw
-00011690: 6179 2e0a 0a20 2020 2020 2020 2049 7420  ay...        It 
-000116a0: 6173 7375 6d65 7320 6974 2773 2062 6569  assumes it's bei
-000116b0: 6e67 2063 616c 6c65 6420 6f6e 2061 2062  ng called on a b
-000116c0: 6174 6368 206f 6620 7461 736b 7320 696e  atch of tasks in
-000116d0: 2070 7269 6f72 6974 7920 6f72 6465 722c   priority order,
-000116e0: 2061 6e64 0a20 2020 2020 2020 206d 6169   and.        mai
-000116f0: 6e74 6169 6e73 2073 7461 7465 2069 6e20  ntains state in 
-00011700: 6053 6368 6564 756c 6572 5374 6174 652e  `SchedulerState.
-00011710: 6c61 7374 5f72 6f6f 745f 776f 726b 6572  last_root_worker
-00011720: 6020 616e 640a 2020 2020 2020 2020 6053  ` and.        `S
-00011730: 6368 6564 756c 6572 5374 6174 652e 6c61  chedulerState.la
-00011740: 7374 5f72 6f6f 745f 776f 726b 6572 5f74  st_root_worker_t
-00011750: 6173 6b73 5f6c 6566 7460 2074 6f20 6163  asks_left` to ac
-00011760: 6869 6576 6520 7468 6973 2e0a 0a20 2020  hieve this...   
-00011770: 2020 2020 2054 6869 7320 7769 6c6c 2073       This will s
-00011780: 656e 6420 6576 6572 7920 7275 6e6e 6162  end every runnab
-00011790: 6c65 2074 6173 6b20 746f 2061 2077 6f72  le task to a wor
-000117a0: 6b65 722c 206f 6674 656e 2063 6175 7369  ker, often causi
-000117b0: 6e67 2072 6f6f 7420 7461 736b 0a20 2020  ng root task.   
-000117c0: 2020 2020 206f 7665 7270 726f 6475 6374       overproduct
-000117d0: 696f 6e2e 0a0a 2020 2020 2020 2020 5265  ion...        Re
-000117e0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
-000117f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7773  -----.        ws
-00011800: 3a20 576f 726b 6572 5374 6174 6520 7c20  : WorkerState | 
-00011810: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00011820: 2054 6865 2077 6f72 6b65 7220 746f 2061   The worker to a
-00011830: 7373 6967 6e20 7468 6520 7461 736b 2074  ssign the task t
-00011840: 6f2e 2049 6620 7468 6572 6520 6172 6520  o. If there are 
-00011850: 6e6f 2077 6f72 6b65 7273 2069 6e20 7468  no workers in th
-00011860: 6520 636c 7573 7465 722c 0a20 2020 2020  e cluster,.     
-00011870: 2020 2020 2020 2072 6574 7572 6e73 204e         returns N
-00011880: 6f6e 652c 2069 6e20 7768 6963 6820 6361  one, in which ca
-00011890: 7365 2074 6865 2074 6173 6b20 7368 6f75  se the task shou
-000118a0: 6c64 2062 6520 7472 616e 7369 7469 6f6e  ld be transition
-000118b0: 6564 2074 6f0a 2020 2020 2020 2020 2020  ed to.          
-000118c0: 2020 6060 6e6f 2d77 6f72 6b65 7260 602e    ``no-worker``.
-000118d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000118e0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-000118f0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00011900: 2020 2023 2053 6565 2072 6f6f 742d 6973     # See root-is
-00011910: 682d 6e65 7373 206e 6f74 6520 6265 6c6f  h-ness note belo
-00011920: 7720 696e 2060 6465 6369 6465 5f77 6f72  w in `decide_wor
-00011930: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
-00011940: 696e 675f 656e 6162 6c65 6460 0a20 2020  ing_enabled`.   
-00011950: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00011960: 6d61 7468 2e69 7369 6e66 2873 656c 662e  math.isinf(self.
-00011970: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
-00011980: 4e29 0a0a 2020 2020 2020 2020 706f 6f6c  N)..        pool
-00011990: 203d 2073 656c 662e 6964 6c65 2e76 616c   = self.idle.val
-000119a0: 7565 7328 2920 6966 2073 656c 662e 6964  ues() if self.id
-000119b0: 6c65 2065 6c73 6520 7365 6c66 2e72 756e  le else self.run
-000119c0: 6e69 6e67 0a20 2020 2020 2020 2069 6620  ning.        if 
-000119d0: 6e6f 7420 706f 6f6c 3a0a 2020 2020 2020  not pool:.      
-000119e0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-000119f0: 650a 0a20 2020 2020 2020 2074 6720 3d20  e..        tg = 
-00011a00: 7473 2e67 726f 7570 0a20 2020 2020 2020  ts.group.       
-00011a10: 206c 7773 203d 2074 672e 6c61 7374 5f77   lws = tg.last_w
-00011a20: 6f72 6b65 720a 2020 2020 2020 2020 6966  orker.        if
-00011a30: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
-00011a40: 7773 0a20 2020 2020 2020 2020 2020 2061  ws.            a
-00011a50: 6e64 2074 672e 6c61 7374 5f77 6f72 6b65  nd tg.last_worke
-00011a60: 725f 7461 736b 735f 6c65 6674 0a20 2020  r_tasks_left.   
-00011a70: 2020 2020 2020 2020 2061 6e64 206c 7773           and lws
-00011a80: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-00011a90: 732e 7275 6e6e 696e 670a 2020 2020 2020  s.running.      
-00011aa0: 2020 2020 2020 616e 6420 7365 6c66 2e77        and self.w
-00011ab0: 6f72 6b65 7273 2e67 6574 286c 7773 2e61  orkers.get(lws.a
-00011ac0: 6464 7265 7373 2920 6973 206c 7773 0a20  ddress) is lws. 
-00011ad0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00011ae0: 2020 2020 2020 7773 203d 206c 7773 0a20        ws = lws. 
-00011af0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00011b00: 2020 2020 2020 2020 2023 204c 6173 742d           # Last-
-00011b10: 7573 6564 2077 6f72 6b65 7220 6973 2066  used worker is f
-00011b20: 756c 6c2c 2075 6e6b 6e6f 776e 2c20 7265  ull, unknown, re
-00011b30: 7469 7269 6e67 2c20 6f72 2070 6175 7365  tiring, or pause
-00011b40: 643b 0a20 2020 2020 2020 2020 2020 2023  d;.            #
-00011b50: 2070 6963 6b20 6120 6e65 7720 776f 726b   pick a new work
-00011b60: 6572 2066 6f72 2074 6865 206e 6578 7420  er for the next 
-00011b70: 6665 7720 7461 736b 730a 2020 2020 2020  few tasks.      
-00011b80: 2020 2020 2020 7773 203d 206d 696e 2870        ws = min(p
-00011b90: 6f6f 6c2c 206b 6579 3d70 6172 7469 616c  ool, key=partial
-00011ba0: 2873 656c 662e 776f 726b 6572 5f6f 626a  (self.worker_obj
-00011bb0: 6563 7469 7665 2c20 7473 2929 0a20 2020  ective, ts)).   
-00011bc0: 2020 2020 2020 2020 2074 672e 6c61 7374           tg.last
-00011bd0: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
-00011be0: 6674 203d 206d 6174 682e 666c 6f6f 7228  ft = math.floor(
-00011bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011c00: 2028 6c65 6e28 7467 2920 2f20 7365 6c66   (len(tg) / self
-00011c10: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
-00011c20: 202a 2077 732e 6e74 6872 6561 6473 0a20   * ws.nthreads. 
-00011c30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00011c40: 2020 2020 2020 2320 5265 636f 7264 2060        # Record `
-00011c50: 6c61 7374 5f77 6f72 6b65 7260 2c20 6f72  last_worker`, or
-00011c60: 2063 6c65 6172 2069 7420 6f6e 2074 6865   clear it on the
-00011c70: 2066 696e 616c 2074 6173 6b0a 2020 2020   final task.    
-00011c80: 2020 2020 7467 2e6c 6173 745f 776f 726b      tg.last_work
-00011c90: 6572 203d 2028 0a20 2020 2020 2020 2020  er = (.         
-00011ca0: 2020 2077 7320 6966 2074 672e 7374 6174     ws if tg.stat
-00011cb0: 6573 5b22 7265 6c65 6173 6564 225d 202b  es["released"] +
-00011cc0: 2074 672e 7374 6174 6573 5b22 7761 6974   tg.states["wait
-00011cd0: 696e 6722 5d20 3e20 3120 656c 7365 204e  ing"] > 1 else N
-00011ce0: 6f6e 650a 2020 2020 2020 2020 290a 2020  one.        ).  
-00011cf0: 2020 2020 2020 7467 2e6c 6173 745f 776f        tg.last_wo
-00011d00: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
-00011d10: 2d3d 2031 0a0a 2020 2020 2020 2020 6966  -= 1..        if
-00011d20: 2073 656c 662e 7661 6c69 6461 7465 2061   self.validate a
-00011d30: 6e64 2077 7320 6973 206e 6f74 204e 6f6e  nd ws is not Non
-00011d40: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00011d50: 7373 6572 7420 7365 6c66 2e77 6f72 6b65  ssert self.worke
-00011d60: 7273 2e67 6574 2877 732e 6164 6472 6573  rs.get(ws.addres
-00011d70: 7329 2069 7320 7773 0a20 2020 2020 2020  s) is ws.       
-00011d80: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
-00011d90: 6e20 7365 6c66 2e72 756e 6e69 6e67 2c20  n self.running, 
-00011da0: 2877 732c 2073 656c 662e 7275 6e6e 696e  (ws, self.runnin
-00011db0: 6729 0a0a 2020 2020 2020 2020 7265 7475  g)..        retu
-00011dc0: 726e 2077 730a 0a20 2020 2064 6566 2064  rn ws..    def d
-00011dd0: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
-00011de0: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
-00011df0: 626c 6564 2873 656c 6629 202d 3e20 576f  bled(self) -> Wo
-00011e00: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
-00011e10: 3a0a 2020 2020 2020 2020 2222 2250 6963  :.        """Pic
-00011e20: 6b20 6120 776f 726b 6572 2066 6f72 2061  k a worker for a
-00011e30: 2072 756e 6e61 626c 6520 726f 6f74 2d69   runnable root-i
-00011e40: 7368 2074 6173 6b2c 2069 6620 6e6f 7420  sh task, if not 
-00011e50: 616c 6c20 6172 6520 6275 7379 2e0a 0a20  all are busy... 
-00011e60: 2020 2020 2020 2050 6963 6b73 2074 6865         Picks the
-00011e70: 206c 6561 7374 2d62 7573 7920 776f 726b   least-busy work
-00011e80: 6572 206f 7574 206f 6620 7468 6520 6060  er out of the ``
-00011e90: 6964 6c65 6060 2077 6f72 6b65 7273 2028  idle`` workers (
-00011ea0: 6964 6c65 2077 6f72 6b65 7273 2068 6176  idle workers hav
-00011eb0: 6520 6665 7765 720a 2020 2020 2020 2020  e fewer.        
-00011ec0: 7461 736b 7320 7275 6e6e 696e 6720 7468  tasks running th
-00011ed0: 616e 2074 6872 6561 6473 2c20 6173 2073  an threads, as s
-00011ee0: 6574 2062 7920 6060 6469 7374 7269 6275  et by ``distribu
-00011ef0: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
-00011f00: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
-00011f10: 6029 2e0a 2020 2020 2020 2020 4974 2064  `)..        It d
-00011f20: 6f65 7320 6e6f 7420 636f 6e73 6964 6572  oes not consider
-00011f30: 2074 6865 206c 6f63 6174 696f 6e20 6f66   the location of
-00011f40: 2064 6570 656e 6465 6e63 6965 732c 2073   dependencies, s
-00011f50: 696e 6365 2074 6865 7927 6c6c 2065 6e64  ince they'll end
-00011f60: 2075 7020 6f6e 2065 7665 7279 0a20 2020   up on every.   
-00011f70: 2020 2020 2077 6f72 6b65 7220 616e 7977       worker anyw
-00011f80: 6179 2e0a 0a20 2020 2020 2020 2049 6620  ay...        If 
-00011f90: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
-00011fa0: 6675 6c6c 2c20 7265 7475 726e 7320 4e6f  full, returns No
-00011fb0: 6e65 2c20 6d65 616e 696e 6720 7468 6520  ne, meaning the 
-00011fc0: 7461 736b 2073 686f 756c 6420 7472 616e  task should tran
-00011fd0: 7369 7469 6f6e 2074 6f0a 2020 2020 2020  sition to.      
-00011fe0: 2020 6060 7175 6575 6564 6060 2e20 5468    ``queued``. Th
-00011ff0: 6520 7363 6865 6475 6c65 7220 7769 6c6c  e scheduler will
-00012000: 2077 6169 7420 746f 2073 656e 6420 6974   wait to send it
-00012010: 2074 6f20 6120 776f 726b 6572 2075 6e74   to a worker unt
-00012020: 696c 2061 2074 6872 6561 6420 6f70 656e  il a thread open
-00012030: 730a 2020 2020 2020 2020 7570 2e20 5468  s.        up. Th
-00012040: 6973 2065 6e73 7572 6573 2074 6861 7420  is ensures that 
-00012050: 646f 776e 7374 7265 616d 2074 6173 6b73  downstream tasks
-00012060: 2061 6c77 6179 7320 7275 6e20 6265 666f   always run befo
-00012070: 7265 206e 6577 2072 6f6f 7420 7461 736b  re new root task
-00012080: 7320 6172 650a 2020 2020 2020 2020 7374  s are.        st
-00012090: 6172 7465 642e 0a0a 2020 2020 2020 2020  arted...        
-000120a0: 5468 6973 2064 6f65 7320 6e6f 7420 7472  This does not tr
-000120b0: 7920 746f 2073 6368 6564 756c 6520 7369  y to schedule si
-000120c0: 626c 696e 6720 7461 736b 7320 6f6e 2074  bling tasks on t
-000120d0: 6865 2073 616d 6520 776f 726b 6572 3b20  he same worker; 
-000120e0: 696e 2066 6163 742c 2069 740a 2020 2020  in fact, it.    
-000120f0: 2020 2020 7573 7561 6c6c 7920 646f 6573      usually does
-00012100: 2074 6865 206f 7070 6f73 6974 652e 2045   the opposite. E
-00012110: 7665 6e20 7468 6f75 6768 2074 6869 7320  ven though this 
-00012120: 696e 6372 6561 7365 7320 7375 6273 6571  increases subseq
-00012130: 7565 6e74 2064 6174 6120 7472 616e 7366  uent data transf
-00012140: 6572 2c0a 2020 2020 2020 2020 6974 2074  er,.        it t
-00012150: 7970 6963 616c 6c79 2072 6564 7563 6573  ypically reduces
-00012160: 206f 7665 7261 6c6c 206d 656d 6f72 7920   overall memory 
-00012170: 7573 6520 6279 2065 6c69 6d69 6e61 7469  use by eliminati
-00012180: 6e67 2072 6f6f 7420 7461 736b 206f 7665  ng root task ove
-00012190: 7270 726f 6475 6374 696f 6e2e 0a0a 2020  rproduction...  
-000121a0: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
-000121b0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
-000121c0: 2020 2020 2020 7773 3a20 576f 726b 6572        ws: Worker
-000121d0: 5374 6174 6520 7c20 4e6f 6e65 0a20 2020  State | None.   
-000121e0: 2020 2020 2020 2020 2054 6865 2077 6f72           The wor
-000121f0: 6b65 7220 746f 2061 7373 6967 6e20 7468  ker to assign th
-00012200: 6520 7461 736b 2074 6f2e 2049 6620 7468  e task to. If th
-00012210: 6572 6520 6172 6520 6e6f 2069 646c 6520  ere are no idle 
-00012220: 776f 726b 6572 732c 2072 6574 7572 6e73  workers, returns
-00012230: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-00012240: 652c 2069 6e20 7768 6963 6820 6361 7365  e, in which case
-00012250: 2074 6865 2074 6173 6b20 7368 6f75 6c64   the task should
-00012260: 2062 6520 7472 616e 7369 7469 6f6e 6564   be transitioned
-00012270: 2074 6f20 6060 7175 6575 6564 6060 2e0a   to ``queued``..
-00012280: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00012290: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-000122a0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-000122b0: 2020 2023 2057 6520 646f 6e27 7420 6061     # We don't `a
-000122c0: 7373 6572 7420 7365 6c66 2e69 735f 726f  ssert self.is_ro
-000122d0: 6f74 6973 6828 7473 2960 2068 6572 652c  otish(ts)` here,
-000122e0: 2062 6563 6175 7365 2074 6861 7420 6368   because that ch
-000122f0: 6563 6b20 6973 0a20 2020 2020 2020 2020  eck is.         
-00012300: 2020 2023 2064 6570 656e 6465 6e74 206f     # dependent o
-00012310: 6e20 636c 7573 7465 7220 7369 7a65 2e20  n cluster size. 
-00012320: 4974 2773 2070 6f73 7369 626c 6520 6120  It's possible a 
-00012330: 7461 736b 206c 6f6f 6b65 6420 726f 6f74  task looked root
-00012340: 2d69 7368 2077 6865 6e20 6974 0a20 2020  -ish when it.   
-00012350: 2020 2020 2020 2020 2023 2077 6173 2071           # was q
-00012360: 7565 7565 642c 2062 7574 2074 6865 2063  ueued, but the c
-00012370: 6c75 7374 6572 2068 6173 2073 696e 6365  luster has since
-00012380: 2073 6361 6c65 6420 7570 2061 6e64 2069   scaled up and i
-00012390: 7420 6e6f 206c 6f6e 6765 7220 646f 6573  t no longer does
-000123a0: 2077 6865 6e0a 2020 2020 2020 2020 2020   when.          
-000123b0: 2020 2320 636f 6d69 6e67 206f 7574 206f    # coming out o
-000123c0: 6620 7468 6520 7175 6575 652e 2049 6620  f the queue. If 
-000123d0: 6069 735f 726f 6f74 6973 6860 2063 6861  `is_rootish` cha
-000123e0: 6e67 6573 2074 6f20 6120 7374 6174 6963  nges to a static
-000123f0: 2064 6566 696e 6974 696f 6e2c 0a20 2020   definition,.   
-00012400: 2020 2020 2020 2020 2023 2074 6865 6e20           # then 
-00012410: 6164 6420 7468 6174 2061 7373 6572 7469  add that asserti
-00012420: 6f6e 2068 6572 6520 2861 6e64 2061 6374  on here (and act
-00012430: 7561 6c6c 7920 7061 7373 2069 6e20 7468  ually pass in th
-00012440: 6520 7461 736b 292e 0a20 2020 2020 2020  e task)..       
-00012450: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00012460: 6d61 7468 2e69 7369 6e66 2873 656c 662e  math.isinf(self.
-00012470: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
-00012480: 4e29 0a0a 2020 2020 2020 2020 6966 206e  N)..        if n
-00012490: 6f74 2073 656c 662e 6964 6c65 5f74 6173  ot self.idle_tas
-000124a0: 6b5f 636f 756e 743a 0a20 2020 2020 2020  k_count:.       
-000124b0: 2020 2020 2023 2041 6c6c 2077 6f72 6b65       # All worke
-000124c0: 7273 2062 7573 793f 2054 6173 6b20 6765  rs busy? Task ge
-000124d0: 7473 2f73 7461 7973 2071 7565 7565 642e  ts/stays queued.
-000124e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000124f0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
-00012500: 2020 2320 4a75 7374 2070 6963 6b20 7468    # Just pick th
-00012510: 6520 6c65 6173 7420 6275 7379 2077 6f72  e least busy wor
-00012520: 6b65 722e 0a20 2020 2020 2020 2023 204e  ker..        # N
-00012530: 4f54 453a 2074 6869 7320 7769 6c6c 206c  OTE: this will l
-00012540: 6561 6420 746f 2077 6f72 7374 2d63 6173  ead to worst-cas
-00012550: 6520 7363 6865 6475 6c69 6e67 2077 6974  e scheduling wit
-00012560: 6820 7265 6761 7264 7320 746f 2063 6f2d  h regards to co-
-00012570: 6173 7369 676e 6d65 6e74 2e0a 2020 2020  assignment..    
-00012580: 2020 2020 7773 203d 206d 696e 280a 2020      ws = min(.  
-00012590: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-000125a0: 646c 655f 7461 736b 5f63 6f75 6e74 2c0a  dle_task_count,.
-000125b0: 2020 2020 2020 2020 2020 2020 6b65 793d              key=
-000125c0: 6c61 6d62 6461 2077 733a 206c 656e 2877  lambda ws: len(w
-000125d0: 732e 7072 6f63 6573 7369 6e67 2920 2f20  s.processing) / 
-000125e0: 7773 2e6e 7468 7265 6164 732c 0a20 2020  ws.nthreads,.   
-000125f0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00012600: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00012610: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00012620: 6572 7420 6e6f 7420 5f77 6f72 6b65 725f  ert not _worker_
-00012630: 6675 6c6c 2877 732c 2073 656c 662e 574f  full(ws, self.WO
-00012640: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
-00012650: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00012660: 2020 2020 7773 2c0a 2020 2020 2020 2020      ws,.        
-00012670: 2020 2020 2020 2020 5f74 6173 6b5f 736c          _task_sl
-00012680: 6f74 735f 6176 6169 6c61 626c 6528 7773  ots_available(ws
-00012690: 2c20 7365 6c66 2e57 4f52 4b45 525f 5341  , self.WORKER_SA
-000126a0: 5455 5241 5449 4f4e 292c 0a20 2020 2020  TURATION),.     
-000126b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000126c0: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
-000126d0: 6e20 7365 6c66 2e72 756e 6e69 6e67 2c20  n self.running, 
-000126e0: 2877 732c 2073 656c 662e 7275 6e6e 696e  (ws, self.runnin
-000126f0: 6729 0a0a 2020 2020 2020 2020 6966 2073  g)..        if s
-00012700: 656c 662e 7661 6c69 6461 7465 2061 6e64  elf.validate and
-00012710: 2077 7320 6973 206e 6f74 204e 6f6e 653a   ws is not None:
-00012720: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00012730: 6572 7420 7365 6c66 2e77 6f72 6b65 7273  ert self.workers
-00012740: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
-00012750: 2069 7320 7773 0a20 2020 2020 2020 2020   is ws.         
-00012760: 2020 2061 7373 6572 7420 7773 2069 6e20     assert ws in 
-00012770: 7365 6c66 2e72 756e 6e69 6e67 2c20 2877  self.running, (w
-00012780: 732c 2073 656c 662e 7275 6e6e 696e 6729  s, self.running)
-00012790: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000127a0: 2077 730a 0a20 2020 2064 6566 2064 6563   ws..    def dec
-000127b0: 6964 655f 776f 726b 6572 5f6e 6f6e 5f72  ide_worker_non_r
-000127c0: 6f6f 7469 7368 2873 656c 662c 2074 733a  ootish(self, ts:
-000127d0: 2054 6173 6b53 7461 7465 2920 2d3e 2057   TaskState) -> W
-000127e0: 6f72 6b65 7253 7461 7465 207c 204e 6f6e  orkerState | Non
-000127f0: 653a 0a20 2020 2020 2020 2022 2222 5069  e:.        """Pi
-00012800: 636b 2061 2077 6f72 6b65 7220 666f 7220  ck a worker for 
-00012810: 6120 7275 6e6e 6162 6c65 206e 6f6e 2d72  a runnable non-r
-00012820: 6f6f 7420 7461 736b 2c20 636f 6e73 6964  oot task, consid
-00012830: 6572 696e 6720 6465 7065 6e64 656e 6369  ering dependenci
-00012840: 6573 2061 6e64 0a20 2020 2020 2020 2072  es and.        r
-00012850: 6573 7472 6963 7469 6f6e 732e 0a0a 2020  estrictions...  
-00012860: 2020 2020 2020 4f75 7420 6f66 2065 6c69        Out of eli
-00012870: 6769 626c 6520 776f 726b 6572 7320 686f  gible workers ho
-00012880: 6c64 696e 6720 6465 7065 6e64 656e 6369  lding dependenci
-00012890: 6573 206f 6620 6060 7473 6060 2c20 7365  es of ``ts``, se
-000128a0: 6c65 6374 7320 7468 6520 776f 726b 6572  lects the worker
-000128b0: 0a20 2020 2020 2020 2077 6865 7265 2c20  .        where, 
-000128c0: 636f 6e73 6964 6572 696e 6720 776f 726b  considering work
-000128d0: 6572 2062 6163 6b6c 6f6e 6720 616e 6420  er backlong and 
-000128e0: 6461 7461 2d74 7261 6e73 6665 7220 636f  data-transfer co
-000128f0: 7374 732c 2074 6865 2074 6173 6b20 6973  sts, the task is
-00012900: 0a20 2020 2020 2020 2065 7374 696d 6174  .        estimat
-00012910: 6564 2074 6f20 7374 6172 7420 7275 6e6e  ed to start runn
-00012920: 696e 6720 7468 6520 736f 6f6e 6573 742e  ing the soonest.
-00012930: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-00012940: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00012950: 2d0a 2020 2020 2020 2020 7773 3a20 576f  -.        ws: Wo
-00012960: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
-00012970: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-00012980: 2077 6f72 6b65 7220 746f 2061 7373 6967   worker to assig
-00012990: 6e20 7468 6520 7461 736b 2074 6f2e 2049  n the task to. I
-000129a0: 6620 6e6f 2077 6f72 6b65 7273 2073 6174  f no workers sat
-000129b0: 6973 6679 2074 6865 2072 6573 7472 6963  isfy the restric
-000129c0: 7469 6f6e 7320 6f66 0a20 2020 2020 2020  tions of.       
-000129d0: 2020 2020 2060 6074 7360 6020 6f72 2074       ``ts`` or t
-000129e0: 6865 7265 2061 7265 206e 6f20 7275 6e6e  here are no runn
-000129f0: 696e 6720 776f 726b 6572 732c 2072 6574  ing workers, ret
-00012a00: 7572 6e73 204e 6f6e 652c 2069 6e20 7768  urns None, in wh
-00012a10: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
-00012a20: 6b0a 2020 2020 2020 2020 2020 2020 7368  k.            sh
-00012a30: 6f75 6c64 2062 6520 7472 616e 7369 7469  ould be transiti
-00012a40: 6f6e 6564 2074 6f20 6060 6e6f 2d77 6f72  oned to ``no-wor
-00012a50: 6b65 7260 602e 0a20 2020 2020 2020 2022  ker``..        "
-00012a60: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-00012a70: 7420 7365 6c66 2e72 756e 6e69 6e67 3a0a  t self.running:.
-00012a80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012a90: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
-00012aa0: 2076 616c 6964 5f77 6f72 6b65 7273 203d   valid_workers =
-00012ab0: 2073 656c 662e 7661 6c69 645f 776f 726b   self.valid_work
-00012ac0: 6572 7328 7473 290a 2020 2020 2020 2020  ers(ts).        
-00012ad0: 6966 2076 616c 6964 5f77 6f72 6b65 7273  if valid_workers
-00012ae0: 2069 7320 4e6f 6e65 2061 6e64 206c 656e   is None and len
-00012af0: 2873 656c 662e 7275 6e6e 696e 6729 203c  (self.running) <
-00012b00: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
-00012b10: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00012b20: 6966 206e 6f74 2073 656c 662e 7275 6e6e  if not self.runn
-00012b30: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00012b40: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00012b50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00012b60: 4966 2074 6865 7265 2077 6572 6520 6e6f  If there were no
-00012b70: 2072 6573 7472 6963 7469 6f6e 732c 2060   restrictions, `
-00012b80: 7661 6c69 645f 776f 726b 6572 7328 2960  valid_workers()`
-00012b90: 2064 6964 6e27 7420 7375 6273 6574 2062   didn't subset b
-00012ba0: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
-00012bb0: 6072 756e 6e69 6e67 602e 0a20 2020 2020  `running`..     
-00012bc0: 2020 2020 2020 2076 616c 6964 5f77 6f72         valid_wor
-00012bd0: 6b65 7273 203d 2073 656c 662e 7275 6e6e  kers = self.runn
-00012be0: 696e 670a 0a20 2020 2020 2020 2069 6620  ing..        if 
-00012bf0: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
-00012c00: 6f72 2076 616c 6964 5f77 6f72 6b65 7273  or valid_workers
-00012c10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00012c20: 2020 2020 2020 2020 2020 7773 203d 2064            ws = d
-00012c30: 6563 6964 655f 776f 726b 6572 280a 2020  ecide_worker(.  
-00012c40: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00012c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012c60: 2020 7365 6c66 2e72 756e 6e69 6e67 2c0a    self.running,.
-00012c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c80: 7661 6c69 645f 776f 726b 6572 732c 0a20  valid_workers,. 
-00012c90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00012ca0: 6172 7469 616c 2873 656c 662e 776f 726b  artial(self.work
-00012cb0: 6572 5f6f 626a 6563 7469 7665 2c20 7473  er_objective, ts
-00012cc0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-00012cd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00012ce0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-00012cf0: 4f20 6966 2060 6973 5f72 6f6f 7469 7368  O if `is_rootish
-00012d00: 6020 776f 756c 6420 616c 7761 7973 2072  ` would always r
-00012d10: 6574 7572 6e20 5472 7565 2066 6f72 2074  eturn True for t
-00012d20: 6173 6b73 2077 6974 686f 7574 0a20 2020  asks without.   
-00012d30: 2020 2020 2020 2020 2023 2064 6570 656e           # depen
-00012d40: 6465 6e63 6965 732c 2077 6520 636f 756c  dencies, we coul
-00012d50: 6420 7265 6d6f 7665 2061 6c6c 2074 6869  d remove all thi
-00012d60: 7320 6c6f 6769 632e 2054 6865 2072 6f6f  s logic. The roo
-00012d70: 7469 7368 2061 7373 6967 6e6d 656e 7420  tish assignment 
-00012d80: 6c6f 6769 630a 2020 2020 2020 2020 2020  logic.          
-00012d90: 2020 2320 776f 756c 6420 6265 6861 7665    # would behave
-00012da0: 206d 6f72 6520 6f72 206c 6573 7320 7468   more or less th
-00012db0: 6520 7361 6d65 2061 7320 7468 6973 2c20  e same as this, 
-00012dc0: 6d61 7962 6520 7769 7468 6f75 7420 6775  maybe without gu
-00012dd0: 6172 616e 7465 6564 0a20 2020 2020 2020  aranteed.       
-00012de0: 2020 2020 2023 2072 6f75 6e64 2d72 6f62       # round-rob
-00012df0: 696e 2074 686f 7567 683f 2054 6869 7320  in though? This 
-00012e00: 7061 7468 2069 7320 6f6e 6c79 2072 6561  path is only rea
-00012e10: 6368 6162 6c65 2077 6865 6e20 6074 7360  chable when `ts`
-00012e20: 2064 6f65 736e 2774 2068 6176 650a 2020   doesn't have.  
-00012e30: 2020 2020 2020 2020 2020 2320 6465 7065            # depe
-00012e40: 6e64 656e 6369 6573 2c20 6275 7420 6974  ndencies, but it
-00012e50: 7320 6772 6f75 7020 6973 2061 6c73 6f20  s group is also 
-00012e60: 736d 616c 6c65 7220 7468 616e 2074 6865  smaller than the
-00012e70: 2063 6c75 7374 6572 2e0a 0a20 2020 2020   cluster...     
-00012e80: 2020 2020 2020 2023 2046 6173 7470 6174         # Fastpat
-00012e90: 6820 7768 656e 2074 6865 7265 2061 7265  h when there are
-00012ea0: 206e 6f20 7265 6c61 7465 6420 7461 736b   no related task
-00012eb0: 7320 6f72 2072 6573 7472 6963 7469 6f6e  s or restriction
-00012ec0: 730a 2020 2020 2020 2020 2020 2020 776f  s.            wo
-00012ed0: 726b 6572 5f70 6f6f 6c20 3d20 7365 6c66  rker_pool = self
-00012ee0: 2e69 646c 6520 6f72 2073 656c 662e 776f  .idle or self.wo
-00012ef0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-00012f00: 2020 2320 4649 584d 4520 6964 6c65 2061    # FIXME idle a
-00012f10: 6e64 2077 6f72 6b65 7273 2061 7265 2053  nd workers are S
-00012f20: 6f72 7465 6444 6963 7427 7320 6465 636c  ortedDict's decl
-00012f30: 6172 6564 2061 7320 6469 6374 730a 2020  ared as dicts.  
-00012f40: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00012f50: 2020 6265 6361 7573 6520 736f 7274 6564    because sorted
-00012f60: 636f 6e74 6169 6e65 7273 2069 7320 6e6f  containers is no
-00012f70: 7420 616e 6e6f 7461 7465 640a 2020 2020  t annotated.    
-00012f80: 2020 2020 2020 2020 7770 5f76 616c 7320          wp_vals 
-00012f90: 3d20 6361 7374 2822 5365 7175 656e 6365  = cast("Sequence
-00012fa0: 5b57 6f72 6b65 7253 7461 7465 5d22 2c20  [WorkerState]", 
-00012fb0: 776f 726b 6572 5f70 6f6f 6c2e 7661 6c75  worker_pool.valu
-00012fc0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-00012fd0: 2020 6e5f 776f 726b 6572 7320 3d20 6c65    n_workers = le
-00012fe0: 6e28 7770 5f76 616c 7329 0a20 2020 2020  n(wp_vals).     
-00012ff0: 2020 2020 2020 2069 6620 6e5f 776f 726b         if n_work
-00013000: 6572 7320 3c20 3230 3a20 2023 2073 6d61  ers < 20:  # sma
-00013010: 7274 2062 7574 206c 696e 6561 7220 696e  rt but linear in
-00013020: 2073 6d61 6c6c 2063 6173 650a 2020 2020   small case.    
-00013030: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-00013040: 206d 696e 2877 705f 7661 6c73 2c20 6b65   min(wp_vals, ke
-00013050: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
-00013060: 6574 7465 7228 226f 6363 7570 616e 6379  etter("occupancy
-00013070: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
-00013080: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
-00013090: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000130a0: 2077 732e 6f63 6375 7061 6e63 7920 3d3d   ws.occupancy ==
-000130b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000130c0: 2020 2020 2020 2020 2320 7370 6563 6961          # specia
-000130d0: 6c20 6361 7365 2074 6f20 7573 6520 726f  l case to use ro
-000130e0: 756e 642d 726f 6269 6e3b 206c 696e 6561  und-robin; linea
-000130f0: 7220 7365 6172 6368 0a20 2020 2020 2020  r search.       
-00013100: 2020 2020 2020 2020 2020 2020 2023 2066               # f
-00013110: 6f72 206e 6578 7420 776f 726b 6572 2077  or next worker w
-00013120: 6974 6820 7a65 726f 206f 6363 7570 616e  ith zero occupan
-00013130: 6379 2028 6f72 206a 7573 740a 2020 2020  cy (or just.    
-00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013150: 2320 6c61 6e64 2062 6163 6b20 7768 6572  # land back wher
-00013160: 6520 7765 2073 7461 7274 6564 292e 0a20  e we started).. 
-00013170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013180: 2020 2073 7461 7274 203d 2073 656c 662e     start = self.
-00013190: 6e5f 7461 736b 7320 2520 6e5f 776f 726b  n_tasks % n_work
-000131a0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-000131b0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-000131c0: 2072 616e 6765 286e 5f77 6f72 6b65 7273   range(n_workers
-000131d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000131e0: 2020 2020 2020 2020 2020 2077 705f 6920             wp_i 
-000131f0: 3d20 7770 5f76 616c 735b 2869 202b 2073  = wp_vals[(i + s
-00013200: 7461 7274 2920 2520 6e5f 776f 726b 6572  tart) % n_worker
-00013210: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
-00013220: 2020 2020 2020 2020 2020 2069 6620 7770             if wp
-00013230: 5f69 2e6f 6363 7570 616e 6379 203d 3d20  _i.occupancy == 
-00013240: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00013250: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00013260: 7320 3d20 7770 5f69 0a20 2020 2020 2020  s = wp_i.       
-00013270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013280: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-00013290: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
-000132a0: 6475 6d62 2062 7574 2066 6173 7420 696e  dumb but fast in
-000132b0: 206c 6172 6765 2063 6173 650a 2020 2020   large case.    
-000132c0: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-000132d0: 2077 705f 7661 6c73 5b73 656c 662e 6e5f   wp_vals[self.n_
-000132e0: 7461 736b 7320 2520 6e5f 776f 726b 6572  tasks % n_worker
-000132f0: 735d 0a0a 2020 2020 2020 2020 6966 2073  s]..        if s
-00013300: 656c 662e 7661 6c69 6461 7465 2061 6e64  elf.validate and
-00013310: 2077 7320 6973 206e 6f74 204e 6f6e 653a   ws is not None:
-00013320: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00013330: 6572 7420 7365 6c66 2e77 6f72 6b65 7273  ert self.workers
-00013340: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
-00013350: 2069 7320 7773 0a20 2020 2020 2020 2020   is ws.         
-00013360: 2020 2061 7373 6572 7420 7773 2069 6e20     assert ws in 
-00013370: 7365 6c66 2e72 756e 6e69 6e67 2c20 2877  self.running, (w
-00013380: 732c 2073 656c 662e 7275 6e6e 696e 6729  s, self.running)
-00013390: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000133a0: 2077 730a 0a20 2020 2064 6566 2074 7261   ws..    def tra
-000133b0: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
-000133c0: 7072 6f63 6573 7369 6e67 2873 656c 662c  processing(self,
-000133d0: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
-000133e0: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-000133f0: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-00013400: 2020 2222 2250 6f73 7369 626c 7920 7363    """Possibly sc
-00013410: 6865 6475 6c65 2061 2072 6561 6479 2074  hedule a ready t
-00013420: 6173 6b2e 2054 6869 7320 6973 2074 6865  ask. This is the
-00013430: 2070 7269 6d61 7279 2064 6973 7061 7463   primary dispatc
-00013440: 6820 666f 7220 7265 6164 7920 7461 736b  h for ready task
-00013450: 732e 0a0a 2020 2020 2020 2020 4966 2074  s...        If t
-00013460: 6865 7265 2773 206e 6f20 6170 7072 6f70  here's no approp
-00013470: 7269 6174 6520 776f 726b 6572 2066 6f72  riate worker for
-00013480: 2074 6865 2074 6173 6b20 2862 7574 2074   the task (but t
-00013490: 6865 2074 6173 6b20 6973 206f 7468 6572  he task is other
-000134a0: 7769 7365 0a20 2020 2020 2020 2072 756e  wise.        run
-000134b0: 6e61 626c 6529 2c20 6974 2077 696c 6c20  nable), it will 
-000134c0: 6265 2072 6563 6f6d 6d65 6e64 6564 2074  be recommended t
-000134d0: 6f20 6060 6e6f 2d77 6f72 6b65 7260 6020  o ``no-worker`` 
-000134e0: 6f72 2060 6071 7565 7565 6460 602e 0a20  or ``queued``.. 
-000134f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00013500: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00013510: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
-00013520: 2069 6620 7365 6c66 2e69 735f 726f 6f74   if self.is_root
-00013530: 6973 6828 7473 293a 0a20 2020 2020 2020  ish(ts):.       
-00013540: 2020 2020 2023 204e 4f54 453a 2068 6176       # NOTE: hav
-00013550: 696e 6720 7477 6f20 726f 6f74 2d69 7368  ing two root-ish
-00013560: 206d 6574 686f 6473 2069 7320 7465 6d70   methods is temp
-00013570: 6f72 6172 792e 2057 6865 6e20 7468 6520  orary. When the 
-00013580: 6665 6174 7572 6520 666c 6167 2069 730a  feature flag is.
-00013590: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-000135a0: 6d6f 7665 642c 2074 6865 7265 2073 686f  moved, there sho
-000135b0: 756c 6420 6f6e 6c79 2062 6520 6f6e 652c  uld only be one,
-000135c0: 2077 6869 6368 2063 6f6d 6269 6e65 7320   which combines 
-000135d0: 636f 2d61 7373 6967 6e6d 656e 7420 616e  co-assignment an
-000135e0: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-000135f0: 7175 6575 696e 672e 2045 7665 6e74 7561  queuing. Eventua
-00013600: 6c6c 792c 2073 7065 6369 616c 2d63 6173  lly, special-cas
-00013610: 696e 6720 726f 6f74 2074 6173 6b73 206d  ing root tasks m
-00013620: 6967 6874 2062 6520 7265 6d6f 7665 6420  ight be removed 
-00013630: 656e 7469 7265 6c79 2c0a 2020 2020 2020  entirely,.      
-00013640: 2020 2020 2020 2320 7769 7468 2062 6574        # with bet
-00013650: 7465 7220 6865 7572 6973 7469 6373 2e0a  ter heuristics..
-00013660: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00013670: 6174 682e 6973 696e 6628 7365 6c66 2e57  ath.isinf(self.W
-00013680: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-00013690: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000136a0: 2020 2069 6620 6e6f 7420 2877 7320 3a3d     if not (ws :=
-000136b0: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
-000136c0: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
-000136d0: 696e 675f 6469 7361 626c 6564 2874 7329  ing_disabled(ts)
-000136e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000136f0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
-00013700: 732e 6b65 793a 2022 6e6f 2d77 6f72 6b65  s.key: "no-worke
-00013710: 7222 7d2c 207b 7d2c 207b 7d0a 2020 2020  r"}, {}, {}.    
-00013720: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00013730: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00013740: 206e 6f74 2028 7773 203a 3d20 7365 6c66   not (ws := self
-00013750: 2e64 6563 6964 655f 776f 726b 6572 5f72  .decide_worker_r
-00013760: 6f6f 7469 7368 5f71 7565 7569 6e67 5f65  ootish_queuing_e
-00013770: 6e61 626c 6564 2829 293a 0a20 2020 2020  nabled()):.     
-00013780: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00013790: 6574 7572 6e20 7b74 732e 6b65 793a 2022  eturn {ts.key: "
-000137a0: 7175 6575 6564 227d 2c20 7b7d 2c20 7b7d  queued"}, {}, {}
-000137b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000137c0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000137d0: 7420 2877 7320 3a3d 2073 656c 662e 6465  t (ws := self.de
-000137e0: 6369 6465 5f77 6f72 6b65 725f 6e6f 6e5f  cide_worker_non_
-000137f0: 726f 6f74 6973 6828 7473 2929 3a0a 2020  rootish(ts)):.  
-00013800: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00013810: 7475 726e 207b 7473 2e6b 6579 3a20 226e  turn {ts.key: "n
-00013820: 6f2d 776f 726b 6572 227d 2c20 7b7d 2c20  o-worker"}, {}, 
-00013830: 7b7d 0a0a 2020 2020 2020 2020 776f 726b  {}..        work
-00013840: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
-00013850: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
-00013860: 6728 7473 2c20 7773 290a 2020 2020 2020  g(ts, ws).      
-00013870: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-00013880: 2077 6f72 6b65 725f 6d73 6773 0a0a 2020   worker_msgs..  
-00013890: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-000138a0: 5f77 6169 7469 6e67 5f6d 656d 6f72 7928  _waiting_memory(
-000138b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000138c0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
-000138d0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-000138e0: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
-000138f0: 2020 202a 2c0a 2020 2020 2020 2020 6e62     *,.        nb
-00013900: 7974 6573 3a20 696e 7420 7c20 4e6f 6e65  ytes: int | None
-00013910: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00013920: 2074 7970 653a 2062 7974 6573 207c 204e   type: bytes | N
-00013930: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00013940: 2020 2020 7479 7065 6e61 6d65 3a20 7374      typename: st
-00013950: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-00013960: 0a20 2020 2020 2020 2077 6f72 6b65 723a  .        worker:
-00013970: 2073 7472 2c0a 2020 2020 2020 2020 2a2a   str,.        **
-00013980: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-00013990: 2029 202d 3e20 5265 6373 4d73 6773 3a0a   ) -> RecsMsgs:.
-000139a0: 2020 2020 2020 2020 2222 2254 6869 7320          """This 
-000139b0: 7472 616e 7369 7469 6f6e 2065 7863 6c75  transition exclu
-000139c0: 7369 7665 6c79 2068 6170 7065 6e73 2069  sively happens i
-000139d0: 6e20 6120 7261 6365 2063 6f6e 6469 7469  n a race conditi
-000139e0: 6f6e 2077 6865 7265 2074 6865 2073 6368  on where the sch
-000139f0: 6564 756c 6572 0a20 2020 2020 2020 2062  eduler.        b
-00013a00: 656c 6965 7665 7320 7468 6174 2074 6865  elieves that the
-00013a10: 206f 6e6c 7920 636f 7079 206f 6620 6120   only copy of a 
-00013a20: 6465 7065 6e64 656e 6379 2074 6173 6b20  dependency task 
-00013a30: 6861 7320 6a75 7374 2062 6565 6e20 6c6f  has just been lo
-00013a40: 7374 2c20 736f 2069 740a 2020 2020 2020  st, so it.      
-00013a50: 2020 7472 616e 7369 7469 6f6e 7320 616c    transitions al
-00013a60: 6c20 6465 7065 6e64 656e 7473 2062 6163  l dependents bac
-00013a70: 6b20 746f 2077 6169 7469 6e67 2c20 6275  k to waiting, bu
-00013a80: 7420 6163 7475 616c 6c79 2061 2072 6570  t actually a rep
-00013a90: 6c69 6361 2068 6173 2061 6c72 6561 6479  lica has already
-00013aa0: 0a20 2020 2020 2020 2062 6565 6e20 6163  .        been ac
-00013ab0: 7175 6972 6564 2062 7920 6120 776f 726b  quired by a work
-00013ac0: 6572 2063 6f6d 7075 7469 6e67 2074 6865  er computing the
-00013ad0: 2064 6570 656e 6465 6e63 7920 2d20 7468   dependency - th
-00013ae0: 6520 7363 6865 6475 6c65 7220 6a75 7374  e scheduler just
-00013af0: 2064 6f65 736e 2774 0a20 2020 2020 2020   doesn't.       
-00013b00: 206b 6e6f 7720 7965 7420 2d20 616e 6420   know yet - and 
-00013b10: 7468 6520 6578 6563 7574 696f 6e20 6669  the execution fi
-00013b20: 6e69 7368 6573 2062 6566 6f72 6520 7468  nishes before th
-00013b30: 6520 6361 6e63 656c 6c61 7469 6f6e 206d  e cancellation m
-00013b40: 6573 7361 6765 2066 726f 6d20 7468 650a  essage from the.
-00013b50: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-00013b60: 7220 6861 7320 6120 6368 616e 6365 2074  r has a chance t
-00013b70: 6f20 7265 6163 6820 7468 6520 776f 726b  o reach the work
-00013b80: 6572 2e20 5368 6f72 746c 792c 2074 6865  er. Shortly, the
-00013b90: 2063 616e 6365 6c6c 6174 696f 6e20 7265   cancellation re
-00013ba0: 7175 6573 740a 2020 2020 2020 2020 7769  quest.        wi
-00013bb0: 6c6c 2072 6561 6368 2074 6865 2077 6f72  ll reach the wor
-00013bc0: 6b65 722c 2074 6875 7320 6465 6c65 7469  ker, thus deleti
-00013bd0: 6e67 2074 6865 2064 6174 6120 6672 6f6d  ng the data from
-00013be0: 206d 656d 6f72 792e 0a20 2020 2020 2020   memory..       
-00013bf0: 2022 2222 0a20 2020 2020 2020 2074 7320   """.        ts 
-00013c00: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00013c10: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00013c20: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00013c30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00013c40: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00013c50: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00013c60: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
-00013c70: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-00013c80: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-00013c90: 6520 3d3d 2022 7761 6974 696e 6722 0a0a  e == "waiting"..
-00013ca0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00013cb0: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2064  }, {}, {}..    d
-00013cc0: 6566 2074 7261 6e73 6974 696f 6e5f 7072  ef transition_pr
-00013cd0: 6f63 6573 7369 6e67 5f6d 656d 6f72 7928  ocessing_memory(
-00013ce0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00013cf0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
-00013d00: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00013d10: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
-00013d20: 2020 202a 2c0a 2020 2020 2020 2020 6e62     *,.        nb
-00013d30: 7974 6573 3a20 696e 7420 7c20 4e6f 6e65  ytes: int | None
-00013d40: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00013d50: 2074 7970 653a 2062 7974 6573 207c 204e   type: bytes | N
-00013d60: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00013d70: 2020 2020 7479 7065 6e61 6d65 3a20 7374      typename: st
-00013d80: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-00013d90: 0a20 2020 2020 2020 2077 6f72 6b65 723a  .        worker:
-00013da0: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
-00013db0: 6172 7473 746f 7073 3a20 6c69 7374 5b64  artstops: list[d
-00013dc0: 6963 745d 207c 204e 6f6e 6520 3d20 4e6f  ict] | None = No
-00013dd0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
-00013de0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
-00013df0: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00013e00: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00013e10: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00013e20: 2020 2020 6173 7365 7274 2077 6f72 6b65      assert worke
-00013e30: 720a 2020 2020 2020 2020 6173 7365 7274  r.        assert
-00013e40: 2069 7369 6e73 7461 6e63 6528 776f 726b   isinstance(work
-00013e50: 6572 2c20 7374 7229 0a0a 2020 2020 2020  er, str)..      
-00013e60: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00013e70: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00013e80: 6173 7365 7274 2074 732e 7072 6f63 6573  assert ts.proces
-00013e90: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-00013ea0: 2020 2020 7773 7320 3d20 7473 2e70 726f      wss = ts.pro
-00013eb0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-00013ec0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-00013ed0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-00013ee0: 7365 7274 2074 7320 696e 2077 7373 2e70  sert ts in wss.p
-00013ef0: 726f 6365 7373 696e 670a 2020 2020 2020  rocessing.      
-00013f00: 2020 2020 2020 6465 6c20 7773 730a 2020        del wss.  
-00013f10: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00013f20: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-00013f30: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-00013f40: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-00013f50: 5f68 6173 2c20 2874 732c 2074 732e 7768  _has, (ts, ts.wh
-00013f60: 6f5f 6861 7329 0a20 2020 2020 2020 2020  o_has).         
-00013f70: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00013f80: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00013f90: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00013fa0: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
-00013fb0: 2270 726f 6365 7373 696e 6722 0a0a 2020  "processing"..  
-00013fc0: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00013fd0: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
-00013fe0: 6572 290a 2020 2020 2020 2020 6966 2077  er).        if w
-00013ff0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00014000: 2020 2020 2020 2072 6574 7572 6e20 7b6b         return {k
-00014010: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
-00014020: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
-00014030: 2069 6620 7773 2021 3d20 7473 2e70 726f   if ws != ts.pro
-00014040: 6365 7373 696e 675f 6f6e 3a20 2023 2070  cessing_on:  # p
-00014050: 7261 676d 613a 206e 6f63 6f76 6572 0a20  ragma: nocover. 
-00014060: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014070: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00014080: 6f6e 0a20 2020 2020 2020 2020 2020 2072  on.            r
-00014090: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-000140a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000140b0: 2020 2066 2254 6173 6b20 7b74 732e 6b65     f"Task {ts.ke
-000140c0: 7921 727d 2074 7261 6e73 6974 696f 6e65  y!r} transitione
-000140d0: 6420 6672 6f6d 2070 726f 6365 7373 696e  d from processin
-000140e0: 6720 746f 206d 656d 6f72 7920 6f6e 2077  g to memory on w
-000140f0: 6f72 6b65 7220 220a 2020 2020 2020 2020  orker ".        
-00014100: 2020 2020 2020 2020 6622 7b77 737d 2c20          f"{ws}, 
-00014110: 7768 696c 6520 6974 2077 6173 2065 7870  while it was exp
-00014120: 6563 7465 6420 6672 6f6d 207b 7473 2e70  ected from {ts.p
-00014130: 726f 6365 7373 696e 675f 6f6e 7d2e 2054  rocessing_on}. T
-00014140: 6869 7320 7368 6f75 6c64 2022 0a20 2020  his should ".   
-00014150: 2020 2020 2020 2020 2020 2020 2066 2262               f"b
-00014160: 6520 696d 706f 7373 6962 6c65 2e20 7b73  e impossible. {s
-00014170: 7469 6d75 6c75 735f 6964 3d7d 2c20 7374  timulus_id=}, st
-00014180: 6f72 793d 7b73 656c 662e 7374 6f72 7928  ory={self.story(
-00014190: 7473 297d 220a 2020 2020 2020 2020 2020  ts)}".          
-000141a0: 2020 290a 0a20 2020 2020 2020 2023 2323    )..        ###
-000141b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000141c0: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
-000141d0: 2020 2023 2055 7064 6174 6520 5469 6d69     # Update Timi
-000141e0: 6e67 2049 6e66 6f72 6d61 7469 6f6e 2023  ng Information #
-000141f0: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
-00014200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014210: 2323 2323 2323 0a20 2020 2020 2020 2069  ######.        i
-00014220: 6620 7374 6172 7473 746f 7073 3a0a 2020  f startstops:.  
-00014230: 2020 2020 2020 2020 2020 666f 7220 7374            for st
-00014240: 6172 7473 746f 7020 696e 2073 7461 7274  artstop in start
-00014250: 7374 6f70 733a 0a20 2020 2020 2020 2020  stops:.         
-00014260: 2020 2020 2020 2074 732e 6772 6f75 702e         ts.group.
-00014270: 6164 645f 6475 7261 7469 6f6e 280a 2020  add_duration(.  
-00014280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014290: 2020 7374 6f70 3d73 7461 7274 7374 6f70    stop=startstop
-000142a0: 5b22 7374 6f70 225d 2c0a 2020 2020 2020  ["stop"],.      
-000142b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000142c0: 6172 743d 7374 6172 7473 746f 705b 2273  art=startstop["s
-000142d0: 7461 7274 225d 2c0a 2020 2020 2020 2020  tart"],.        
-000142e0: 2020 2020 2020 2020 2020 2020 6163 7469              acti
-000142f0: 6f6e 3d73 7461 7274 7374 6f70 5b22 6163  on=startstop["ac
-00014300: 7469 6f6e 225d 2c0a 2020 2020 2020 2020  tion"],.        
-00014310: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00014320: 2020 2073 203d 2073 656c 662e 756e 6b6e     s = self.unkn
-00014330: 6f77 6e5f 6475 7261 7469 6f6e 732e 706f  own_durations.po
-00014340: 7028 7473 2e70 7265 6669 782e 6e61 6d65  p(ts.prefix.name
-00014350: 2c20 7365 7428 2929 0a20 2020 2020 2020  , set()).       
-00014360: 2073 7465 616c 203d 2073 656c 662e 6578   steal = self.ex
-00014370: 7465 6e73 696f 6e73 2e67 6574 2822 7374  tensions.get("st
-00014380: 6561 6c69 6e67 2229 0a20 2020 2020 2020  ealing").       
-00014390: 2069 6620 7374 6561 6c3a 0a20 2020 2020   if steal:.     
-000143a0: 2020 2020 2020 2066 6f72 2074 7473 2069         for tts i
-000143b0: 6e20 733a 0a20 2020 2020 2020 2020 2020  n s:.           
-000143c0: 2020 2020 2069 6620 7474 732e 7072 6f63       if tts.proc
-000143d0: 6573 7369 6e67 5f6f 6e3a 0a20 2020 2020  essing_on:.     
-000143e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000143f0: 7465 616c 2e72 6563 616c 6375 6c61 7465  teal.recalculate
-00014400: 5f63 6f73 7428 7474 7329 0a0a 2020 2020  _cost(tts)..    
-00014410: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00014420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014430: 0a20 2020 2020 2020 2023 2055 7064 6174  .        # Updat
-00014440: 6520 5374 6174 6520 496e 666f 726d 6174  e State Informat
-00014450: 696f 6e20 230a 2020 2020 2020 2020 2323  ion #.        ##
-00014460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014470: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
-00014480: 2020 2069 6620 6e62 7974 6573 2069 7320     if nbytes is 
-00014490: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000144a0: 2020 2020 2020 7473 2e73 6574 5f6e 6279        ts.set_nby
-000144b0: 7465 7328 6e62 7974 6573 290a 0a20 2020  tes(nbytes)..   
-000144c0: 2020 2020 2073 656c 662e 5f65 7869 745f       self._exit_
-000144d0: 7072 6f63 6573 7369 6e67 5f63 6f6d 6d6f  processing_commo
-000144e0: 6e28 7473 290a 0a20 2020 2020 2020 2072  n(ts)..        r
-000144f0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-00014500: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
-00014510: 2020 636c 6965 6e74 5f6d 7367 733a 204d    client_msgs: M
-00014520: 7367 7320 3d20 7b7d 0a20 2020 2020 2020  sgs = {}.       
-00014530: 2073 656c 662e 5f61 6464 5f74 6f5f 6d65   self._add_to_me
-00014540: 6d6f 7279 280a 2020 2020 2020 2020 2020  mory(.          
-00014550: 2020 7473 2c20 7773 2c20 7265 636f 6d6d    ts, ws, recomm
-00014560: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00014570: 745f 6d73 6773 2c20 7479 7065 3d74 7970  t_msgs, type=typ
-00014580: 652c 2074 7970 656e 616d 653d 7479 7065  e, typename=type
-00014590: 6e61 6d65 0a20 2020 2020 2020 2029 0a0a  name.        )..
-000145a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000145b0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-000145c0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-000145d0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-000145e0: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-000145f0: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-00014600: 696e 675f 6f6e 0a0a 2020 2020 2020 2020  ing_on..        
-00014610: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
-00014620: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00014630: 7367 732c 207b 7d0a 0a20 2020 2064 6566  sgs, {}..    def
-00014640: 2074 7261 6e73 6974 696f 6e5f 6d65 6d6f   transition_memo
-00014650: 7279 5f72 656c 6561 7365 6428 0a20 2020  ry_released(.   
-00014660: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
-00014670: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-00014680: 3a20 7374 722c 202a 2c20 7361 6665 3a20  : str, *, safe: 
-00014690: 626f 6f6c 203d 2046 616c 7365 0a20 2020  bool = False.   
-000146a0: 2029 202d 3e20 5265 6373 4d73 6773 3a0a   ) -> RecsMsgs:.
-000146b0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-000146c0: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
-000146d0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-000146e0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-000146f0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00014700: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-00014710: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014720: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00014730: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00014740: 2069 6620 7361 6665 3a0a 2020 2020 2020   if safe:.      
-00014750: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00014760: 206e 6f74 2074 732e 7761 6974 6572 730a   not ts.waiters.
-00014770: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
-00014780: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
-00014790: 2020 666f 7220 7773 2069 6e20 7473 2e77    for ws in ts.w
-000147a0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-000147b0: 2020 2020 2020 2020 7773 2e61 6374 6f72          ws.actor
-000147c0: 732e 6469 7363 6172 6428 7473 290a 2020  s.discard(ts).  
-000147d0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-000147e0: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-000147f0: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
-00014800: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-00014810: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-00014820: 2020 2074 732e 6578 6365 7074 696f 6e20     ts.exception 
-00014830: 3d20 5365 7269 616c 697a 6564 280a 2020  = Serialized(.  
-00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014850: 2020 2a73 6572 6961 6c69 7a65 2856 616c    *serialize(Val
-00014860: 7565 4572 726f 7228 2257 6f72 6b65 7220  ueError("Worker 
-00014870: 686f 6c64 696e 6720 4163 746f 7220 7761  holding Actor wa
-00014880: 7320 6c6f 7374 2229 290a 2020 2020 2020  s lost")).      
-00014890: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000148a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000148b0: 726e 207b 7473 2e6b 6579 3a20 2265 7272  rn {ts.key: "err
-000148c0: 6564 227d 2c20 7b7d 2c20 7b7d 2020 2320  ed"}, {}, {}  # 
-000148d0: 646f 6e27 7420 7472 7920 746f 2072 6563  don't try to rec
-000148e0: 7265 6174 650a 0a20 2020 2020 2020 2072  reate..        r
-000148f0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-00014900: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
-00014910: 2020 636c 6965 6e74 5f6d 7367 733a 204d    client_msgs: M
-00014920: 7367 7320 3d20 7b7d 0a20 2020 2020 2020  sgs = {}.       
-00014930: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
-00014940: 6773 203d 207b 7d0a 0a20 2020 2020 2020  gs = {}..       
-00014950: 2023 2058 5858 2066 6163 746f 7220 7468   # XXX factor th
-00014960: 6973 206f 7574 3f0a 2020 2020 2020 2020  is out?.        
-00014970: 776f 726b 6572 5f6d 7367 203d 207b 0a20  worker_msg = {. 
-00014980: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-00014990: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
-000149a0: 2020 2020 2020 2020 2020 226b 6579 7322            "keys"
-000149b0: 3a20 5b6b 6579 5d2c 0a20 2020 2020 2020  : [key],.       
-000149c0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
-000149d0: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
-000149e0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-000149f0: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
-00014a00: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-00014a10: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00014a20: 5b77 732e 6164 6472 6573 735d 203d 205b  [ws.address] = [
-00014a30: 776f 726b 6572 5f6d 7367 5d0a 2020 2020  worker_msg].    
-00014a40: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-00014a50: 616c 6c5f 7265 706c 6963 6173 2874 7329  all_replicas(ts)
-00014a60: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
-00014a70: 7465 203d 2022 7265 6c65 6173 6564 220a  te = "released".
-00014a80: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
-00014a90: 6d73 6720 3d20 7b22 6f70 223a 2022 6c6f  msg = {"op": "lo
-00014aa0: 7374 2d64 6174 6122 2c20 226b 6579 223a  st-data", "key":
-00014ab0: 206b 6579 7d0a 2020 2020 2020 2020 666f   key}.        fo
-00014ac0: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
-00014ad0: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-00014ae0: 2020 636c 6965 6e74 5f6d 7367 735b 6373    client_msgs[cs
-00014af0: 2e63 6c69 656e 745f 6b65 795d 203d 205b  .client_key] = [
-00014b00: 7265 706f 7274 5f6d 7367 5d0a 0a20 2020  report_msg]..   
-00014b10: 2020 2020 2069 6620 6e6f 7420 7473 2e72       if not ts.r
-00014b20: 756e 5f73 7065 633a 2020 2320 7075 7265  un_spec:  # pure
-00014b30: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-00014b40: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00014b50: 735b 6b65 795d 203d 2022 666f 7267 6f74  s[key] = "forgot
-00014b60: 7465 6e22 0a20 2020 2020 2020 2065 6c69  ten".        eli
-00014b70: 6620 7473 2e68 6173 5f6c 6f73 745f 6465  f ts.has_lost_de
-00014b80: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-00014b90: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00014ba0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
-00014bb0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
-00014bc0: 2020 2065 6c69 6620 7473 2e77 686f 5f77     elif ts.who_w
-00014bd0: 616e 7473 206f 7220 7473 2e77 6169 7465  ants or ts.waite
-00014be0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00014bf0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-00014c00: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
-00014c10: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-00014c20: 7320 696e 2074 732e 7761 6974 6572 733a  s in ts.waiters:
-00014c30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00014c40: 6474 732e 7374 6174 6520 696e 2028 226e  dts.state in ("n
-00014c50: 6f2d 776f 726b 6572 222c 2022 7072 6f63  o-worker", "proc
-00014c60: 6573 7369 6e67 2229 3a0a 2020 2020 2020  essing"):.      
-00014c70: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00014c80: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
-00014c90: 795d 203d 2022 7761 6974 696e 6722 0a20  y] = "waiting". 
-00014ca0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00014cb0: 6474 732e 7374 6174 6520 3d3d 2022 7761  dts.state == "wa
-00014cc0: 6974 696e 6722 3a0a 2020 2020 2020 2020  iting":.        
-00014cd0: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-00014ce0: 696e 675f 6f6e 2e61 6464 2874 7329 0a0a  ing_on.add(ts)..
-00014cf0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00014d00: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00014d10: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00014d20: 2074 732e 7761 6974 696e 675f 6f6e 0a0a   ts.waiting_on..
-00014d30: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00014d40: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-00014d50: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-00014d60: 6b65 725f 6d73 6773 0a0a 2020 2020 6465  ker_msgs..    de
-00014d70: 6620 7472 616e 7369 7469 6f6e 5f72 656c  f transition_rel
-00014d80: 6561 7365 645f 6572 7265 6428 7365 6c66  eased_erred(self
-00014d90: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
-00014da0: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
-00014db0: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-00014dc0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00014dd0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-00014de0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-00014df0: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
-00014e00: 2020 2063 6c69 656e 745f 6d73 6773 3a20     client_msgs: 
-00014e10: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
-00014e20: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00014e30: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00014e40: 2077 6974 6820 6c6f 675f 6572 726f 7273   with log_errors
-00014e50: 2870 6462 3d4c 4f47 5f50 4442 293a 0a20  (pdb=LOG_PDB):. 
-00014e60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00014e70: 7373 6572 7420 7473 2e65 7863 6570 7469  ssert ts.excepti
-00014e80: 6f6e 5f62 6c61 6d65 0a20 2020 2020 2020  on_blame.       
-00014e90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014ea0: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00014ec0: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00014ed0: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
-00014ee0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00014ef0: 6f74 2074 732e 7761 6974 6572 730a 0a20  ot ts.waiters.. 
-00014f00: 2020 2020 2020 2066 6169 6c69 6e67 5f74         failing_t
-00014f10: 7320 3d20 7473 2e65 7863 6570 7469 6f6e  s = ts.exception
-00014f20: 5f62 6c61 6d65 0a20 2020 2020 2020 2061  _blame.        a
-00014f30: 7373 6572 7420 6661 696c 696e 675f 7473  ssert failing_ts
-00014f40: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-00014f50: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00014f60: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00014f70: 6474 732e 6578 6365 7074 696f 6e5f 626c  dts.exception_bl
-00014f80: 616d 6520 3d20 6661 696c 696e 675f 7473  ame = failing_ts
-00014f90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00014fa0: 6e6f 7420 6474 732e 7768 6f5f 6861 733a  not dts.who_has:
-00014fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014fc0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00014fd0: 5b64 7473 2e6b 6579 5d20 3d20 2265 7272  [dts.key] = "err
-00014fe0: 6564 220a 0a20 2020 2020 2020 2072 6570  ed"..        rep
-00014ff0: 6f72 745f 6d73 6720 3d20 7b0a 2020 2020  ort_msg = {.    
-00015000: 2020 2020 2020 2020 226f 7022 3a20 2274          "op": "t
-00015010: 6173 6b2d 6572 7265 6422 2c0a 2020 2020  ask-erred",.    
-00015020: 2020 2020 2020 2020 226b 6579 223a 206b          "key": k
-00015030: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00015040: 2265 7863 6570 7469 6f6e 223a 2066 6169  "exception": fai
-00015050: 6c69 6e67 5f74 732e 6578 6365 7074 696f  ling_ts.exceptio
-00015060: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
-00015070: 7472 6163 6562 6163 6b22 3a20 6661 696c  traceback": fail
-00015080: 696e 675f 7473 2e74 7261 6365 6261 636b  ing_ts.traceback
-00015090: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-000150a0: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
-000150b0: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-000150c0: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-000150d0: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
-000150e0: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
-000150f0: 5d0a 0a20 2020 2020 2020 2074 732e 7374  ]..        ts.st
-00015100: 6174 6520 3d20 2265 7272 6564 220a 0a20  ate = "erred".. 
-00015110: 2020 2020 2020 2023 2054 4f44 4f3a 2077         # TODO: w
-00015120: 6169 7469 6e67 2064 6174 613f 0a20 2020  aiting data?.   
-00015130: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00015140: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00015150: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
-00015160: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00015170: 5f65 7272 6564 5f72 656c 6561 7365 6428  _erred_released(
-00015180: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00015190: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-000151a0: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-000151b0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000151c0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-000151d0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000151e0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-000151f0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-00015200: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
-00015210: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
-00015220: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
-00015230: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-00015240: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-00015250: 2020 2020 7769 7468 206c 6f67 5f65 7272      with log_err
-00015260: 6f72 7328 7064 623d 4c4f 475f 5044 4229  ors(pdb=LOG_PDB)
-00015270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015280: 2020 6173 7365 7274 2074 732e 6578 6365    assert ts.exce
-00015290: 7074 696f 6e5f 626c 616d 650a 2020 2020  ption_blame.    
-000152a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000152b0: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
-000152c0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000152d0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-000152e0: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
-000152f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00015300: 7420 6e6f 7420 7473 2e77 6169 7465 7273  t not ts.waiters
-00015310: 0a0a 2020 2020 2020 2020 7473 2e65 7863  ..        ts.exc
-00015320: 6570 7469 6f6e 203d 204e 6f6e 650a 2020  eption = None.  
-00015330: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
-00015340: 6f6e 5f62 6c61 6d65 203d 204e 6f6e 650a  on_blame = None.
-00015350: 2020 2020 2020 2020 7473 2e74 7261 6365          ts.trace
-00015360: 6261 636b 203d 204e 6f6e 650a 0a20 2020  back = None..   
-00015370: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-00015380: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
-00015390: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-000153a0: 732e 7374 6174 6520 3d3d 2022 6572 7265  s.state == "erre
-000153b0: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-000153c0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000153d0: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
-000153e0: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
-000153f0: 2020 775f 6d73 6720 3d20 7b0a 2020 2020    w_msg = {.    
-00015400: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
-00015410: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
-00015420: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
-00015430: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
-00015440: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-00015450: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-00015460: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00015470: 666f 7220 7773 5f61 6464 7220 696e 2074  for ws_addr in t
-00015480: 732e 6572 7265 645f 6f6e 3a0a 2020 2020  s.erred_on:.    
-00015490: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-000154a0: 7367 735b 7773 5f61 6464 725d 203d 205b  sgs[ws_addr] = [
-000154b0: 775f 6d73 675d 0a20 2020 2020 2020 2074  w_msg].        t
-000154c0: 732e 6572 7265 645f 6f6e 2e63 6c65 6172  s.erred_on.clear
-000154d0: 2829 0a0a 2020 2020 2020 2020 7265 706f  ()..        repo
-000154e0: 7274 5f6d 7367 203d 207b 226f 7022 3a20  rt_msg = {"op": 
-000154f0: 2274 6173 6b2d 7265 7472 6965 6422 2c20  "task-retried", 
-00015500: 226b 6579 223a 206b 6579 7d0a 2020 2020  "key": key}.    
-00015510: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
-00015520: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-00015530: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-00015540: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
-00015550: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
-00015560: 5d0a 0a20 2020 2020 2020 2074 732e 7374  ]..        ts.st
-00015570: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
-00015580: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00015590: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000155a0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-000155b0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
-000155c0: 6465 6620 7472 616e 7369 7469 6f6e 5f77  def transition_w
-000155d0: 6169 7469 6e67 5f72 656c 6561 7365 6428  aiting_released(
-000155e0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-000155f0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00015600: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-00015610: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00015620: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-00015630: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00015640: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
-00015650: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00015660: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00015670: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00015680: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-00015690: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000156a0: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
-000156b0: 5f6f 6e0a 0a20 2020 2020 2020 2066 6f72  _on..        for
-000156c0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-000156d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-000156e0: 2020 2020 2069 6620 7473 2069 6e20 6474       if ts in dt
-000156f0: 732e 7761 6974 6572 733a 0a20 2020 2020  s.waiters:.     
-00015700: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
-00015710: 6169 7465 7273 2e64 6973 6361 7264 2874  aiters.discard(t
-00015720: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00015730: 2020 2069 6620 6e6f 7420 6474 732e 7761     if not dts.wa
-00015740: 6974 6572 7320 616e 6420 6e6f 7420 6474  iters and not dt
-00015750: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
-00015760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015770: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015780: 5b64 7473 2e6b 6579 5d20 3d20 2272 656c  [dts.key] = "rel
-00015790: 6561 7365 6422 0a20 2020 2020 2020 2074  eased".        t
-000157a0: 732e 7761 6974 696e 675f 6f6e 2e63 6c65  s.waiting_on.cle
-000157b0: 6172 2829 0a0a 2020 2020 2020 2020 7473  ar()..        ts
-000157c0: 2e73 7461 7465 203d 2022 7265 6c65 6173  .state = "releas
-000157d0: 6564 220a 0a20 2020 2020 2020 2069 6620  ed"..        if 
-000157e0: 7473 2e68 6173 5f6c 6f73 745f 6465 7065  ts.has_lost_depe
-000157f0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-00015800: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00015810: 7469 6f6e 735b 6b65 795d 203d 2022 666f  tions[key] = "fo
-00015820: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
-00015830: 2065 6c69 6620 6e6f 7420 7473 2e65 7863   elif not ts.exc
-00015840: 6570 7469 6f6e 5f62 6c61 6d65 2061 6e64  eption_blame and
-00015850: 2028 7473 2e77 686f 5f77 616e 7473 206f   (ts.who_wants o
-00015860: 7220 7473 2e77 6169 7465 7273 293a 0a20  r ts.waiters):. 
-00015870: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00015880: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
-00015890: 3d20 2277 6169 7469 6e67 220a 2020 2020  = "waiting".    
-000158a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000158b0: 2020 2020 2020 7473 2e77 6169 7465 7273        ts.waiters
-000158c0: 2e63 6c65 6172 2829 0a0a 2020 2020 2020  .clear()..      
-000158d0: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-000158e0: 6e64 6174 696f 6e73 2c20 7b7d 2c20 7b7d  ndations, {}, {}
-000158f0: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00015900: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
-00015910: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-00015920: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
-00015930: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00015940: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00015950: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00015960: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-00015970: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00015980: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
-00015990: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
-000159a0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-000159b0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-000159c0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-000159d0: 7365 7274 2074 732e 7072 6f63 6573 7369  sert ts.processi
-000159e0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-000159f0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00015a00: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-00015a10: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00015a20: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-00015a30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015a40: 7473 2e73 7461 7465 203d 3d20 2270 726f  ts.state == "pro
-00015a50: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
-00015a60: 2020 7773 203d 2073 656c 662e 5f65 7869    ws = self._exi
-00015a70: 745f 7072 6f63 6573 7369 6e67 5f63 6f6d  t_processing_com
-00015a80: 6d6f 6e28 7473 290a 2020 2020 2020 2020  mon(ts).        
-00015a90: 6966 2077 733a 0a20 2020 2020 2020 2020  if ws:.         
-00015aa0: 2020 2077 6f72 6b65 725f 6d73 6773 5b77     worker_msgs[w
-00015ab0: 732e 6164 6472 6573 735d 203d 205b 0a20  s.address] = [. 
-00015ac0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00015ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ae0: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
-00015af0: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
-00015b00: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-00015b10: 7322 3a20 5b6b 6579 5d2c 0a20 2020 2020  s": [key],.     
-00015b20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00015b30: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-00015b40: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-00015b50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00015b60: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
-00015b70: 2020 2020 7365 6c66 2e5f 7072 6f70 6167      self._propag
-00015b80: 6174 655f 7265 6c65 6173 6564 2874 732c  ate_released(ts,
-00015b90: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015ba0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00015bb0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015bc0: 2c20 7b7d 2c20 776f 726b 6572 5f6d 7367  , {}, worker_msg
-00015bd0: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00015be0: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
-00015bf0: 5f65 7272 6564 280a 2020 2020 2020 2020  _erred(.        
-00015c00: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-00015c10: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
-00015c20: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00015c30: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00015c40: 2020 2020 2077 6f72 6b65 723a 2073 7472       worker: str
-00015c50: 2c0a 2020 2020 2020 2020 6361 7573 653a  ,.        cause:
-00015c60: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-00015c70: 6e65 2c0a 2020 2020 2020 2020 6578 6365  ne,.        exce
-00015c80: 7074 696f 6e3a 2053 6572 6961 6c69 7a65  ption: Serialize
-00015c90: 6420 7c20 4e6f 6e65 203d 204e 6f6e 652c  d | None = None,
-00015ca0: 0a20 2020 2020 2020 2074 7261 6365 6261  .        traceba
-00015cb0: 636b 3a20 5365 7269 616c 697a 6564 207c  ck: Serialized |
-00015cc0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00015cd0: 2020 2020 2020 6578 6365 7074 696f 6e5f        exception_
-00015ce0: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
-00015cf0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00015d00: 2074 7261 6365 6261 636b 5f74 6578 743a   traceback_text:
-00015d10: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-00015d20: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
-00015d30: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
-00015d40: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00015d50: 2020 2020 2020 2222 2250 726f 6365 7373        """Process
-00015d60: 6564 2061 2072 6563 6f6d 6d65 6e64 6564  ed a recommended
-00015d70: 2074 7261 6e73 6974 696f 6e20 7072 6f63   transition proc
-00015d80: 6573 7369 6e67 202d 3e20 6572 7265 642e  essing -> erred.
-00015d90: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-00015da0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-00015db0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00015dc0: 6b65 790a 2020 2020 2020 2020 2020 204b  key.           K
-00015dd0: 6579 206f 6620 7468 6520 7461 736b 2074  ey of the task t
-00015de0: 6f20 7472 616e 7369 7469 6f6e 0a20 2020  o transition.   
-00015df0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00015e00: 0a20 2020 2020 2020 2020 2020 2049 4420  .            ID 
-00015e10: 6f66 2074 6865 2073 7469 6d75 6c75 7320  of the stimulus 
-00015e20: 6361 7573 696e 6720 7468 6520 7472 616e  causing the tran
-00015e30: 7369 7469 6f6e 0a20 2020 2020 2020 2077  sition.        w
-00015e40: 6f72 6b65 720a 2020 2020 2020 2020 2020  orker.          
-00015e50: 2020 4164 6472 6573 7320 6f66 2074 6865    Address of the
-00015e60: 2077 6f72 6b65 7220 7768 6572 6520 7468   worker where th
-00015e70: 6520 7461 736b 2065 7272 6564 2e0a 2020  e task erred..  
-00015e80: 2020 2020 2020 2020 2020 4e6f 7420 6e65            Not ne
-00015e90: 6365 7373 6172 696c 7920 6060 7473 2e70  cessarily ``ts.p
-00015ea0: 726f 6365 7373 696e 675f 6f6e 6060 2e0a  rocessing_on``..
-00015eb0: 2020 2020 2020 2020 6361 7573 650a 2020          cause.  
-00015ec0: 2020 2020 2020 2020 2020 4164 6472 6573            Addres
-00015ed0: 7320 6f66 2074 6865 2074 6173 6b20 7468  s of the task th
-00015ee0: 6174 2063 6175 7365 6420 7468 6973 2074  at caused this t
-00015ef0: 6173 6b20 746f 2062 6520 7472 616e 7369  ask to be transi
-00015f00: 7469 6f6e 6564 2074 6f20 6572 7265 640a  tioned to erred.
-00015f10: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-00015f20: 6e0a 2020 2020 2020 2020 2020 2020 4578  n.            Ex
-00015f30: 6365 7074 696f 6e20 6361 7573 6564 2062  ception caused b
-00015f40: 7920 7468 6520 7461 736b 0a20 2020 2020  y the task.     
-00015f50: 2020 2074 7261 6365 6261 636b 0a20 2020     traceback.   
-00015f60: 2020 2020 2020 2020 2054 7261 6365 6261           Traceba
-00015f70: 636b 2063 6175 7365 6420 6279 2074 6865  ck caused by the
-00015f80: 2074 6173 6b0a 2020 2020 2020 2020 6578   task.        ex
-00015f90: 6365 7074 696f 6e5f 7465 7874 0a20 2020  ception_text.   
-00015fa0: 2020 2020 2020 2020 2053 7472 696e 6720           String 
-00015fb0: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
-00015fc0: 6620 7468 6520 6578 6365 7074 696f 6e0a  f the exception.
-00015fd0: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
-00015fe0: 6b5f 7465 7874 0a20 2020 2020 2020 2020  k_text.         
-00015ff0: 2020 2053 7472 696e 6720 7265 7072 6573     String repres
-00016000: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
-00016010: 7472 6163 6562 6163 6b0a 0a20 2020 2020  traceback..     
-00016020: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-00016030: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00016040: 2020 2052 6563 6f6d 6d65 6e64 6174 696f     Recommendatio
-00016050: 6e73 2c20 636c 6965 6e74 206d 6573 7361  ns, client messa
-00016060: 6765 7320 616e 6420 776f 726b 6572 206d  ges and worker m
-00016070: 6573 7361 6765 7320 746f 2070 726f 6365  essages to proce
-00016080: 7373 0a20 2020 2020 2020 2022 2222 0a20  ss.        """. 
-00016090: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000160a0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-000160b0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000160c0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-000160d0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-000160e0: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
-000160f0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00016100: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00016110: 2020 2020 2061 7373 6572 7420 6361 7573       assert caus
-00016120: 6520 6f72 2074 732e 6578 6365 7074 696f  e or ts.exceptio
-00016130: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
-00016140: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
-00016150: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-00016160: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00016170: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-00016180: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00016190: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-000161a0: 6f6e 0a0a 2020 2020 2020 2020 6966 2074  on..        if t
-000161b0: 732e 6163 746f 723a 0a20 2020 2020 2020  s.actor:.       
-000161c0: 2020 2020 2077 7320 3d20 7473 2e70 726f       ws = ts.pro
-000161d0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-000161e0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-000161f0: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
-00016200: 6163 746f 7273 2e72 656d 6f76 6528 7473  actors.remove(ts
-00016210: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00016220: 5f65 7869 745f 7072 6f63 6573 7369 6e67  _exit_processing
-00016230: 5f63 6f6d 6d6f 6e28 7473 290a 0a20 2020  _common(ts)..   
-00016240: 2020 2020 2074 732e 6572 7265 645f 6f6e       ts.erred_on
-00016250: 2e61 6464 2877 6f72 6b65 7229 0a20 2020  .add(worker).   
-00016260: 2020 2020 2069 6620 6578 6365 7074 696f       if exceptio
-00016270: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-00016280: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
-00016290: 6365 7074 696f 6e20 3d20 6578 6365 7074  ception = except
-000162a0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-000162b0: 7473 2e65 7863 6570 7469 6f6e 5f74 6578  ts.exception_tex
-000162c0: 7420 3d20 6578 6365 7074 696f 6e5f 7465  t = exception_te
-000162d0: 7874 2020 2320 7479 7065 3a20 6967 6e6f  xt  # type: igno
-000162e0: 7265 0a20 2020 2020 2020 2069 6620 7472  re.        if tr
-000162f0: 6163 6562 6163 6b20 6973 206e 6f74 204e  aceback is not N
-00016300: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00016310: 2074 732e 7472 6163 6562 6163 6b20 3d20   ts.traceback = 
-00016320: 7472 6163 6562 6163 6b0a 2020 2020 2020  traceback.      
-00016330: 2020 2020 2020 7473 2e74 7261 6365 6261        ts.traceba
-00016340: 636b 5f74 6578 7420 3d20 7472 6163 6562  ck_text = traceb
-00016350: 6163 6b5f 7465 7874 2020 2320 7479 7065  ack_text  # type
-00016360: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00016370: 2069 6620 6361 7573 6520 6973 206e 6f74   if cause is not
-00016380: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00016390: 2020 2066 6169 6c69 6e67 5f74 7320 3d20     failing_ts = 
-000163a0: 7365 6c66 2e74 6173 6b73 5b63 6175 7365  self.tasks[cause
-000163b0: 5d0a 2020 2020 2020 2020 2020 2020 7473  ].            ts
-000163c0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-000163d0: 203d 2066 6169 6c69 6e67 5f74 730a 2020   = failing_ts.  
-000163e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000163f0: 2020 2020 2020 2020 6661 696c 696e 675f          failing_
-00016400: 7473 203d 2074 732e 6578 6365 7074 696f  ts = ts.exceptio
-00016410: 6e5f 626c 616d 6520 2023 2074 7970 653a  n_blame  # type:
-00016420: 2069 676e 6f72 650a 0a20 2020 2020 2020   ignore..       
-00016430: 2073 656c 662e 6572 7265 645f 7461 736b   self.erred_task
-00016440: 732e 6170 7065 6e64 6c65 6674 280a 2020  s.appendleft(.  
-00016450: 2020 2020 2020 2020 2020 4572 7265 6454            ErredT
-00016460: 6173 6b28 0a20 2020 2020 2020 2020 2020  ask(.           
-00016470: 2020 2020 2074 732e 6b65 792c 0a20 2020       ts.key,.   
-00016480: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-00016490: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
-000164a0: 2020 2020 2074 732e 6572 7265 645f 6f6e       ts.erred_on
-000164b0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-000164c0: 2020 2020 2020 2020 2065 7863 6570 7469           excepti
-000164d0: 6f6e 5f74 6578 7420 6f72 2022 222c 0a20  on_text or "",. 
-000164e0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000164f0: 7261 6365 6261 636b 5f74 6578 7420 6f72  raceback_text or
-00016500: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
-00016510: 2029 0a20 2020 2020 2020 2029 0a0a 2020   ).        )..  
-00016520: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-00016530: 2074 732e 6465 7065 6e64 656e 7473 3a0a   ts.dependents:.
-00016540: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
-00016550: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
-00016560: 3d20 6661 696c 696e 675f 7473 0a20 2020  = failing_ts.   
-00016570: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00016580: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-00016590: 5d20 3d20 2265 7272 6564 220a 0a20 2020  ] = "erred"..   
-000165a0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-000165b0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-000165c0: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
-000165d0: 2e77 6169 7465 7273 2e64 6973 6361 7264  .waiters.discard
-000165e0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-000165f0: 2069 6620 6e6f 7420 6474 732e 7761 6974   if not dts.wait
-00016600: 6572 7320 616e 6420 6e6f 7420 6474 732e  ers and not dts.
-00016610: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-00016620: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00016630: 6d65 6e64 6174 696f 6e73 5b64 7473 2e6b  mendations[dts.k
-00016640: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
-00016650: 0a0a 2020 2020 2020 2020 7473 2e77 6169  ..        ts.wai
-00016660: 7465 7273 2e63 6c65 6172 2829 2020 2320  ters.clear()  # 
-00016670: 646f 2061 6e79 7468 696e 6720 7769 7468  do anything with
-00016680: 2074 6869 733f 0a0a 2020 2020 2020 2020   this?..        
-00016690: 7473 2e73 7461 7465 203d 2022 6572 7265  ts.state = "erre
-000166a0: 6422 0a0a 2020 2020 2020 2020 7265 706f  d"..        repo
-000166b0: 7274 5f6d 7367 203d 207b 0a20 2020 2020  rt_msg = {.     
-000166c0: 2020 2020 2020 2022 6f70 223a 2022 7461         "op": "ta
-000166d0: 736b 2d65 7272 6564 222c 0a20 2020 2020  sk-erred",.     
-000166e0: 2020 2020 2020 2022 6b65 7922 3a20 6b65         "key": ke
-000166f0: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-00016700: 6578 6365 7074 696f 6e22 3a20 6661 696c  exception": fail
-00016710: 696e 675f 7473 2e65 7863 6570 7469 6f6e  ing_ts.exception
-00016720: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-00016730: 7261 6365 6261 636b 223a 2066 6169 6c69  raceback": faili
-00016740: 6e67 5f74 732e 7472 6163 6562 6163 6b2c  ng_ts.traceback,
-00016750: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00016760: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
-00016770: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-00016780: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-00016790: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
-000167a0: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
-000167b0: 0a0a 2020 2020 2020 2020 6373 203d 2073  ..        cs = s
-000167c0: 656c 662e 636c 6965 6e74 735b 2266 6972  elf.clients["fir
-000167d0: 652d 616e 642d 666f 7267 6574 225d 0a20  e-and-forget"]. 
-000167e0: 2020 2020 2020 2069 6620 7473 2069 6e20         if ts in 
-000167f0: 6373 2e77 616e 7473 5f77 6861 743a 0a20  cs.wants_what:. 
-00016800: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016810: 5f63 6c69 656e 745f 7265 6c65 6173 6573  _client_releases
-00016820: 5f6b 6579 7328 0a20 2020 2020 2020 2020  _keys(.         
-00016830: 2020 2020 2020 2063 733d 6373 2c0a 2020         cs=cs,.  
-00016840: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00016850: 7973 3d5b 6b65 795d 2c0a 2020 2020 2020  ys=[key],.      
-00016860: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00016870: 656e 6461 7469 6f6e 733d 7265 636f 6d6d  endations=recomm
-00016880: 656e 6461 7469 6f6e 732c 0a20 2020 2020  endations,.     
-00016890: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000168a0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-000168b0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-000168c0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-000168d0: 6f63 6573 7369 6e67 5f6f 6e0a 0a20 2020  ocessing_on..   
-000168e0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-000168f0: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00016900: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
-00016910: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00016920: 5f6e 6f5f 776f 726b 6572 5f72 656c 6561  _no_worker_relea
-00016930: 7365 6428 7365 6c66 2c20 6b65 793a 2073  sed(self, key: s
-00016940: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
-00016950: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
-00016960: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
-00016970: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00016980: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00016990: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-000169a0: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
-000169b0: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 7374  lf.tasks[key].st
-000169c0: 6174 6520 3d3d 2022 6e6f 2d77 6f72 6b65  ate == "no-worke
-000169d0: 7222 0a20 2020 2020 2020 2020 2020 2061  r".            a
-000169e0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-000169f0: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00016a00: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00016a10: 6169 7469 6e67 5f6f 6e0a 0a20 2020 2020  aiting_on..     
-00016a20: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
-00016a30: 6c65 2e72 656d 6f76 6528 7473 290a 2020  le.remove(ts).  
-00016a40: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
-00016a50: 2022 7265 6c65 6173 6564 220a 0a20 2020   "released"..   
-00016a60: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-00016a70: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-00016a80: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
-00016a90: 2e77 6169 7465 7273 2e64 6973 6361 7264  .waiters.discard
-00016aa0: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
-00016ab0: 2e77 6169 7465 7273 2e63 6c65 6172 2829  .waiters.clear()
-00016ac0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00016ad0: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
-00016ae0: 2064 6566 2074 7261 6e73 6974 696f 6e5f   def transition_
-00016af0: 7761 6974 696e 675f 7175 6575 6564 2873  waiting_queued(s
-00016b00: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
-00016b10: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-00016b20: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00016b30: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00016b40: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00016b50: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00016b60: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00016b70: 2020 6173 7365 7274 206e 6f74 2073 656c    assert not sel
-00016b80: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
-00016b90: 742c 2028 7473 2c20 7365 6c66 2e69 646c  t, (ts, self.idl
-00016ba0: 655f 7461 736b 5f63 6f75 6e74 290a 2020  e_task_count).  
-00016bb0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00016bc0: 7661 6c69 6461 7465 5f72 6561 6479 2874  validate_ready(t
-00016bd0: 7329 0a0a 2020 2020 2020 2020 7473 2e73  s)..        ts.s
-00016be0: 7461 7465 203d 2022 7175 6575 6564 220a  tate = "queued".
-00016bf0: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
-00016c00: 7565 642e 6164 6428 7473 290a 0a20 2020  ued.add(ts)..   
-00016c10: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
-00016c20: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
-00016c30: 7472 616e 7369 7469 6f6e 5f77 6169 7469  transition_waiti
-00016c40: 6e67 5f6e 6f5f 776f 726b 6572 2873 656c  ng_no_worker(sel
-00016c50: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-00016c60: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00016c70: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00016c80: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00016c90: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-00016ca0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00016cb0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00016cc0: 7365 6c66 2e5f 7661 6c69 6461 7465 5f72  self._validate_r
-00016cd0: 6561 6479 2874 7329 0a0a 2020 2020 2020  eady(ts)..      
-00016ce0: 2020 7473 2e73 7461 7465 203d 2022 6e6f    ts.state = "no
-00016cf0: 2d77 6f72 6b65 7222 0a20 2020 2020 2020  -worker".       
-00016d00: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
-00016d10: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
-00016d20: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-00016d30: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
-00016d40: 6e73 6974 696f 6e5f 7175 6575 6564 5f72  nsition_queued_r
-00016d50: 656c 6561 7365 6428 7365 6c66 2c20 6b65  eleased(self, ke
-00016d60: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
-00016d70: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
-00016d80: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-00016d90: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00016da0: 6579 5d0a 0a20 2020 2020 2020 2069 6620  ey]..        if 
-00016db0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-00016dc0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00016dd0: 7420 7473 2069 6e20 7365 6c66 2e71 7565  t ts in self.que
-00016de0: 7565 640a 2020 2020 2020 2020 2020 2020  ued.            
-00016df0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-00016e00: 6f63 6573 7369 6e67 5f6f 6e0a 0a20 2020  ocessing_on..   
-00016e10: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
-00016e20: 2e72 656d 6f76 6528 7473 290a 0a20 2020  .remove(ts)..   
-00016e30: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00016e40: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00016e50: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-00016e60: 6f70 6167 6174 655f 7265 6c65 6173 6564  opagate_released
-00016e70: 2874 732c 2072 6563 6f6d 6d65 6e64 6174  (ts, recommendat
-00016e80: 696f 6e73 290a 2020 2020 2020 2020 7265  ions).        re
-00016e90: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-00016ea0: 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a 2020  ions, {}, {}..  
-00016eb0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00016ec0: 5f71 7565 7565 645f 7072 6f63 6573 7369  _queued_processi
-00016ed0: 6e67 2873 656c 662c 206b 6579 3a20 7374  ng(self, key: st
-00016ee0: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-00016ef0: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
-00016f00: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-00016f10: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-00016f20: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00016f30: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
-00016f40: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
-00016f50: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-00016f60: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00016f70: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-00016f80: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00016f90: 6f74 2074 732e 6163 746f 722c 2066 2241  ot ts.actor, f"A
-00016fa0: 6374 6f72 7320 6361 6e27 7420 6265 2071  ctors can't be q
-00016fb0: 7565 7565 643a 207b 7473 7d22 0a20 2020  ueued: {ts}".   
-00016fc0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00016fd0: 7473 2069 6e20 7365 6c66 2e71 7565 7565  ts in self.queue
-00016fe0: 640a 0a20 2020 2020 2020 2069 6620 7773  d..        if ws
-00016ff0: 203a 3d20 7365 6c66 2e64 6563 6964 655f   := self.decide_
-00017000: 776f 726b 6572 5f72 6f6f 7469 7368 5f71  worker_rootish_q
-00017010: 7565 7569 6e67 5f65 6e61 626c 6564 2829  ueuing_enabled()
-00017020: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00017030: 6c66 2e71 7565 7565 642e 6469 7363 6172  lf.queued.discar
-00017040: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00017050: 2020 776f 726b 6572 5f6d 7367 7320 3d20    worker_msgs = 
-00017060: 7365 6c66 2e5f 6164 645f 746f 5f70 726f  self._add_to_pro
-00017070: 6365 7373 696e 6728 7473 2c20 7773 290a  cessing(ts, ws).
-00017080: 2020 2020 2020 2020 2320 4966 206e 6f20          # If no 
-00017090: 776f 726b 6572 2c20 7461 736b 206a 7573  worker, task jus
-000170a0: 7420 7374 6179 7320 6071 7565 7565 6460  t stays `queued`
-000170b0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000170c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000170d0: 2c20 7b7d 2c20 776f 726b 6572 5f6d 7367  , {}, worker_msg
-000170e0: 730a 0a20 2020 2064 6566 205f 7265 6d6f  s..    def _remo
-000170f0: 7665 5f6b 6579 2873 656c 662c 206b 6579  ve_key(self, key
-00017100: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-00017110: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00017120: 662e 7461 736b 732e 706f 7028 6b65 7929  f.tasks.pop(key)
-00017130: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00017140: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
-00017150: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
-00017160: 7365 6c66 2e75 6e72 756e 6e61 626c 652e  self.unrunnable.
-00017170: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-00017180: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
-00017190: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-000171a0: 2020 2020 2020 2020 6373 2e77 616e 7473          cs.wants
-000171b0: 5f77 6861 742e 7265 6d6f 7665 2874 7329  _what.remove(ts)
-000171c0: 0a20 2020 2020 2020 2074 732e 7768 6f5f  .        ts.who_
-000171d0: 7761 6e74 732e 636c 6561 7228 290a 2020  wants.clear().  
-000171e0: 2020 2020 2020 7473 2e70 726f 6365 7373        ts.process
-000171f0: 696e 675f 6f6e 203d 204e 6f6e 650a 2020  ing_on = None.  
-00017200: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
-00017210: 6f6e 5f62 6c61 6d65 203d 2074 732e 6578  on_blame = ts.ex
-00017220: 6365 7074 696f 6e20 3d20 7473 2e74 7261  ception = ts.tra
-00017230: 6365 6261 636b 203d 204e 6f6e 650a 2020  ceback = None.  
-00017240: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-00017250: 6d65 7461 6461 7461 2e70 6f70 286b 6579  metadata.pop(key
-00017260: 2c20 4e6f 6e65 290a 0a20 2020 2064 6566  , None)..    def
-00017270: 2074 7261 6e73 6974 696f 6e5f 6d65 6d6f   transition_memo
-00017280: 7279 5f66 6f72 676f 7474 656e 2873 656c  ry_forgotten(sel
-00017290: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-000172a0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-000172b0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-000172c0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-000172d0: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-000172e0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-000172f0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00017300: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-00017310: 3d3d 2022 6d65 6d6f 7279 220a 2020 2020  == "memory".    
-00017320: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00017330: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
-00017340: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-00017350: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-00017360: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-00017370: 2020 2020 2069 6620 6e6f 7420 7473 2e72       if not ts.r
-00017380: 756e 5f73 7065 633a 0a20 2020 2020 2020  un_spec:.       
-00017390: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
-000173a0: 6f6b 2074 6f20 666f 7267 6574 2061 2070  ok to forget a p
-000173b0: 7572 6520 6461 7461 2074 6173 6b0a 2020  ure data task.  
-000173c0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-000173d0: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-000173e0: 6c69 6620 7473 2e68 6173 5f6c 6f73 745f  lif ts.has_lost_
-000173f0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-00017400: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017410: 4974 2773 206f 6b20 746f 2066 6f72 6765  It's ok to forge
-00017420: 7420 6120 7461 736b 2077 6974 6820 666f  t a task with fo
-00017430: 7267 6f74 7465 6e20 6465 7065 6e64 656e  rgotten dependen
-00017440: 6369 6573 0a20 2020 2020 2020 2020 2020  cies.           
-00017450: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-00017460: 2020 2020 2020 656c 6966 206e 6f74 2074        elif not t
-00017470: 732e 7768 6f5f 7761 6e74 7320 616e 6420  s.who_wants and 
-00017480: 6e6f 7420 7473 2e77 6169 7465 7273 2061  not ts.waiters a
-00017490: 6e64 206e 6f74 2074 732e 6465 7065 6e64  nd not ts.depend
-000174a0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-000174b0: 2020 2020 2020 2320 4974 2773 206f 6b20        # It's ok 
-000174c0: 746f 2066 6f72 6765 7420 6120 7461 736b  to forget a task
-000174d0: 2074 6861 7420 6e6f 626f 6479 206e 6565   that nobody nee
-000174e0: 6473 0a20 2020 2020 2020 2020 2020 2020  ds.             
-000174f0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00017500: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00017510: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00017520: 4173 7365 7274 696f 6e45 7272 6f72 2822  AssertionError("
-00017530: 556e 7265 6163 6861 626c 6522 2c20 7473  Unreachable", ts
-00017540: 2920 2023 2070 7261 676d 613a 206e 6f63  )  # pragma: noc
-00017550: 6f76 6572 0a0a 2020 2020 2020 2020 6966  over..        if
-00017560: 2074 732e 6163 746f 723a 0a20 2020 2020   ts.actor:.     
-00017570: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
-00017580: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
-00017590: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
-000175a0: 6163 746f 7273 2e64 6973 6361 7264 2874  actors.discard(t
-000175b0: 7329 0a0a 2020 2020 2020 2020 7265 636f  s)..        reco
-000175c0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-000175d0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
-000175e0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
-000175f0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00017600: 6c66 2e5f 7072 6f70 6167 6174 655f 666f  lf._propagate_fo
-00017610: 7267 6f74 7465 6e28 7473 2c20 7265 636f  rgotten(ts, reco
-00017620: 6d6d 656e 6461 7469 6f6e 732c 2077 6f72  mmendations, wor
-00017630: 6b65 725f 6d73 6773 2c20 7374 696d 756c  ker_msgs, stimul
-00017640: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
-00017650: 636c 6965 6e74 5f6d 7367 7320 3d20 5f74  client_msgs = _t
-00017660: 6173 6b5f 746f 5f63 6c69 656e 745f 6d73  ask_to_client_ms
-00017670: 6773 2874 7329 0a20 2020 2020 2020 2073  gs(ts).        s
-00017680: 656c 662e 5f72 656d 6f76 655f 6b65 7928  elf._remove_key(
-00017690: 6b65 7929 0a0a 2020 2020 2020 2020 7265  key)..        re
-000176a0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-000176b0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-000176c0: 732c 2077 6f72 6b65 725f 6d73 6773 0a0a  s, worker_msgs..
-000176d0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-000176e0: 6f6e 5f72 656c 6561 7365 645f 666f 7267  on_released_forg
-000176f0: 6f74 7465 6e28 7365 6c66 2c20 6b65 793a  otten(self, key:
-00017700: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00017710: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00017720: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00017730: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00017740: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00017750: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00017760: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017770: 7473 2e73 7461 7465 2069 6e20 2822 7265  ts.state in ("re
-00017780: 6c65 6173 6564 222c 2022 6572 7265 6422  leased", "erred"
-00017790: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-000177a0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-000177b0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-000177c0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-000177d0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-000177e0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-000177f0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
-00017800: 6575 6564 0a20 2020 2020 2020 2020 2020  eued.           
-00017810: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00017820: 6169 7469 6e67 5f6f 6e2c 2028 7473 2c20  aiting_on, (ts, 
-00017830: 7473 2e77 6169 7469 6e67 5f6f 6e29 0a20  ts.waiting_on). 
-00017840: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00017850: 7420 7473 2e72 756e 5f73 7065 633a 0a20  t ts.run_spec:. 
-00017860: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00017870: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
-00017880: 6574 2061 2070 7572 6520 6461 7461 2074  et a pure data t
-00017890: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
-000178a0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-000178b0: 2020 2020 2065 6c69 6620 7473 2e68 6173       elif ts.has
-000178c0: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
-000178d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000178e0: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
-000178f0: 2066 6f72 6765 7420 6120 7461 736b 2077   forget a task w
-00017900: 6974 6820 666f 7267 6f74 7465 6e20 6465  ith forgotten de
-00017910: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
-00017920: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00017930: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00017940: 206e 6f74 2074 732e 7768 6f5f 7761 6e74   not ts.who_want
-00017950: 7320 616e 6420 6e6f 7420 7473 2e77 6169  s and not ts.wai
-00017960: 7465 7273 2061 6e64 206e 6f74 2074 732e  ters and not ts.
-00017970: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
-00017980: 2020 2020 2020 2020 2020 2020 2320 4974              # It
-00017990: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
-000179a0: 6120 7461 736b 2074 6861 7420 6e6f 626f  a task that nobo
-000179b0: 6479 206e 6565 6473 0a20 2020 2020 2020  dy needs.       
-000179c0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-000179d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000179e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179f0: 7261 6973 6520 4173 7365 7274 696f 6e45  raise AssertionE
-00017a00: 7272 6f72 2822 556e 7265 6163 6861 626c  rror("Unreachabl
-00017a10: 6522 2c20 7374 7228 7473 2929 2020 2320  e", str(ts))  # 
-00017a20: 7072 6167 6d61 3a20 6e6f 636f 7665 720a  pragma: nocover.
-00017a30: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00017a40: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00017a50: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
-00017a60: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
-00017a70: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-00017a80: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
-00017a90: 7474 656e 2874 732c 2072 6563 6f6d 6d65  tten(ts, recomme
-00017aa0: 6e64 6174 696f 6e73 2c20 776f 726b 6572  ndations, worker
-00017ab0: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
-00017ac0: 6964 290a 0a20 2020 2020 2020 2063 6c69  id)..        cli
-00017ad0: 656e 745f 6d73 6773 203d 205f 7461 736b  ent_msgs = _task
-00017ae0: 5f74 6f5f 636c 6965 6e74 5f6d 7367 7328  _to_client_msgs(
-00017af0: 7473 290a 2020 2020 2020 2020 7365 6c66  ts).        self
-00017b00: 2e5f 7265 6d6f 7665 5f6b 6579 286b 6579  ._remove_key(key
-00017b10: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00017b20: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-00017b30: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-00017b40: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
-00017b50: 2023 207b 0a20 2020 2023 2020 2020 2028   # {.    #     (
-00017b60: 7374 6172 742c 2066 696e 6973 6829 3a0a  start, finish):.
-00017b70: 2020 2020 2320 2020 2020 7472 616e 7369      #     transi
-00017b80: 7469 6f6e 5f3c 7374 6172 743e 5f3c 6669  tion_<start>_<fi
-00017b90: 6e69 7368 3e28 0a20 2020 2023 2020 2020  nish>(.    #    
-00017ba0: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
-00017bb0: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-00017bc0: 3a20 7374 722c 202a 2a6b 7761 7267 730a  : str, **kwargs.
-00017bd0: 2020 2020 2320 2020 2020 2920 2d3e 2028      #     ) -> (
-00017be0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00017bf0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
-00017c00: 726b 6572 5f6d 7367 7329 0a20 2020 2023  rker_msgs).    #
-00017c10: 207d 0a20 2020 205f 5452 414e 5349 5449   }.    _TRANSITI
-00017c20: 4f4e 535f 5441 424c 453a 2043 6c61 7373  ONS_TABLE: Class
-00017c30: 5661 725b 0a20 2020 2020 2020 204d 6170  Var[.        Map
-00017c40: 7069 6e67 5b0a 2020 2020 2020 2020 2020  ping[.          
-00017c50: 2020 7475 706c 655b 5461 736b 5374 6174    tuple[TaskStat
-00017c60: 6553 7461 7465 2c20 5461 736b 5374 6174  eState, TaskStat
-00017c70: 6553 7461 7465 5d2c 0a20 2020 2020 2020  eState],.       
-00017c80: 2020 2020 2043 616c 6c61 626c 655b 2e2e       Callable[..
-00017c90: 2e2c 2052 6563 734d 7367 735d 2c0a 2020  ., RecsMsgs],.  
-00017ca0: 2020 2020 2020 5d0a 2020 2020 5d20 3d20        ].    ] = 
-00017cb0: 7b0a 2020 2020 2020 2020 2822 7265 6c65  {.        ("rele
-00017cc0: 6173 6564 222c 2022 7761 6974 696e 6722  ased", "waiting"
-00017cd0: 293a 2074 7261 6e73 6974 696f 6e5f 7265  ): transition_re
-00017ce0: 6c65 6173 6564 5f77 6169 7469 6e67 2c0a  leased_waiting,.
-00017cf0: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
-00017d00: 6722 2c20 2272 656c 6561 7365 6422 293a  g", "released"):
-00017d10: 2074 7261 6e73 6974 696f 6e5f 7761 6974   transition_wait
-00017d20: 696e 675f 7265 6c65 6173 6564 2c0a 2020  ing_released,.  
-00017d30: 2020 2020 2020 2822 7761 6974 696e 6722        ("waiting"
-00017d40: 2c20 2270 726f 6365 7373 696e 6722 293a  , "processing"):
-00017d50: 2074 7261 6e73 6974 696f 6e5f 7761 6974   transition_wait
-00017d60: 696e 675f 7072 6f63 6573 7369 6e67 2c0a  ing_processing,.
-00017d70: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
-00017d80: 6722 2c20 226e 6f2d 776f 726b 6572 2229  g", "no-worker")
-00017d90: 3a20 7472 616e 7369 7469 6f6e 5f77 6169  : transition_wai
-00017da0: 7469 6e67 5f6e 6f5f 776f 726b 6572 2c0a  ting_no_worker,.
-00017db0: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
-00017dc0: 6722 2c20 2271 7565 7565 6422 293a 2074  g", "queued"): t
-00017dd0: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
-00017de0: 675f 7175 6575 6564 2c0a 2020 2020 2020  g_queued,.      
-00017df0: 2020 2822 7761 6974 696e 6722 2c20 226d    ("waiting", "m
-00017e00: 656d 6f72 7922 293a 2074 7261 6e73 6974  emory"): transit
-00017e10: 696f 6e5f 7761 6974 696e 675f 6d65 6d6f  ion_waiting_memo
-00017e20: 7279 2c0a 2020 2020 2020 2020 2822 7175  ry,.        ("qu
-00017e30: 6575 6564 222c 2022 7265 6c65 6173 6564  eued", "released
-00017e40: 2229 3a20 7472 616e 7369 7469 6f6e 5f71  "): transition_q
-00017e50: 7565 7565 645f 7265 6c65 6173 6564 2c0a  ueued_released,.
-00017e60: 2020 2020 2020 2020 2822 7175 6575 6564          ("queued
-00017e70: 222c 2022 7072 6f63 6573 7369 6e67 2229  ", "processing")
-00017e80: 3a20 7472 616e 7369 7469 6f6e 5f71 7565  : transition_que
-00017e90: 7565 645f 7072 6f63 6573 7369 6e67 2c0a  ued_processing,.
-00017ea0: 2020 2020 2020 2020 2822 7072 6f63 6573          ("proces
-00017eb0: 7369 6e67 222c 2022 7265 6c65 6173 6564  sing", "released
-00017ec0: 2229 3a20 7472 616e 7369 7469 6f6e 5f70  "): transition_p
-00017ed0: 726f 6365 7373 696e 675f 7265 6c65 6173  rocessing_releas
-00017ee0: 6564 2c0a 2020 2020 2020 2020 2822 7072  ed,.        ("pr
-00017ef0: 6f63 6573 7369 6e67 222c 2022 6d65 6d6f  ocessing", "memo
-00017f00: 7279 2229 3a20 7472 616e 7369 7469 6f6e  ry"): transition
-00017f10: 5f70 726f 6365 7373 696e 675f 6d65 6d6f  _processing_memo
-00017f20: 7279 2c0a 2020 2020 2020 2020 2822 7072  ry,.        ("pr
-00017f30: 6f63 6573 7369 6e67 222c 2022 6572 7265  ocessing", "erre
-00017f40: 6422 293a 2074 7261 6e73 6974 696f 6e5f  d"): transition_
-00017f50: 7072 6f63 6573 7369 6e67 5f65 7272 6564  processing_erred
-00017f60: 2c0a 2020 2020 2020 2020 2822 6e6f 2d77  ,.        ("no-w
-00017f70: 6f72 6b65 7222 2c20 2272 656c 6561 7365  orker", "release
-00017f80: 6422 293a 2074 7261 6e73 6974 696f 6e5f  d"): transition_
-00017f90: 6e6f 5f77 6f72 6b65 725f 7265 6c65 6173  no_worker_releas
-00017fa0: 6564 2c0a 2020 2020 2020 2020 2822 6e6f  ed,.        ("no
-00017fb0: 2d77 6f72 6b65 7222 2c20 2270 726f 6365  -worker", "proce
-00017fc0: 7373 696e 6722 293a 2074 7261 6e73 6974  ssing"): transit
-00017fd0: 696f 6e5f 6e6f 5f77 6f72 6b65 725f 7072  ion_no_worker_pr
-00017fe0: 6f63 6573 7369 6e67 2c0a 2020 2020 2020  ocessing,.      
-00017ff0: 2020 2822 7265 6c65 6173 6564 222c 2022    ("released", "
-00018000: 666f 7267 6f74 7465 6e22 293a 2074 7261  forgotten"): tra
-00018010: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
-00018020: 5f66 6f72 676f 7474 656e 2c0a 2020 2020  _forgotten,.    
-00018030: 2020 2020 2822 6d65 6d6f 7279 222c 2022      ("memory", "
-00018040: 666f 7267 6f74 7465 6e22 293a 2074 7261  forgotten"): tra
-00018050: 6e73 6974 696f 6e5f 6d65 6d6f 7279 5f66  nsition_memory_f
-00018060: 6f72 676f 7474 656e 2c0a 2020 2020 2020  orgotten,.      
-00018070: 2020 2822 6572 7265 6422 2c20 2272 656c    ("erred", "rel
-00018080: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
-00018090: 696f 6e5f 6572 7265 645f 7265 6c65 6173  ion_erred_releas
-000180a0: 6564 2c0a 2020 2020 2020 2020 2822 6d65  ed,.        ("me
-000180b0: 6d6f 7279 222c 2022 7265 6c65 6173 6564  mory", "released
-000180c0: 2229 3a20 7472 616e 7369 7469 6f6e 5f6d  "): transition_m
-000180d0: 656d 6f72 795f 7265 6c65 6173 6564 2c0a  emory_released,.
-000180e0: 2020 2020 2020 2020 2822 7265 6c65 6173          ("releas
-000180f0: 6564 222c 2022 6572 7265 6422 293a 2074  ed", "erred"): t
-00018100: 7261 6e73 6974 696f 6e5f 7265 6c65 6173  ransition_releas
-00018110: 6564 5f65 7272 6564 2c0a 2020 2020 7d0a  ed_erred,.    }.
-00018120: 0a20 2020 2064 6566 2073 746f 7279 2873  .    def story(s
-00018130: 656c 662c 202a 6b65 7973 5f6f 725f 7461  elf, *keys_or_ta
-00018140: 736b 735f 6f72 5f73 7469 6d75 6c69 3a20  sks_or_stimuli: 
-00018150: 7374 7220 7c20 5461 736b 5374 6174 6529  str | TaskState)
-00018160: 202d 3e20 6c69 7374 5b54 7261 6e73 6974   -> list[Transit
-00018170: 696f 6e5d 3a0a 2020 2020 2020 2020 2222  ion]:.        ""
-00018180: 2247 6574 2061 6c6c 2074 7261 6e73 6974  "Get all transit
-00018190: 696f 6e73 2074 6861 7420 746f 7563 6820  ions that touch 
-000181a0: 6f6e 6520 6f66 2074 6865 2069 6e70 7574  one of the input
-000181b0: 206b 6579 7320 6f72 2073 7469 6d75 6c75   keys or stimulu
-000181c0: 735f 6964 2773 2222 220a 2020 2020 2020  s_id's""".      
-000181d0: 2020 6b65 7973 5f6f 725f 7374 696d 756c    keys_or_stimul
-000181e0: 6920 3d20 7b0a 2020 2020 2020 2020 2020  i = {.          
-000181f0: 2020 6b65 792e 6b65 7920 6966 2069 7369    key.key if isi
-00018200: 6e73 7461 6e63 6528 6b65 792c 2054 6173  nstance(key, Tas
-00018210: 6b53 7461 7465 2920 656c 7365 206b 6579  kState) else key
-00018220: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00018230: 206b 6579 2069 6e20 6b65 7973 5f6f 725f   key in keys_or_
-00018240: 7461 736b 735f 6f72 5f73 7469 6d75 6c69  tasks_or_stimuli
-00018250: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00018260: 2020 2072 6574 7572 6e20 7363 6865 6475     return schedu
-00018270: 6c65 725f 7374 6f72 7928 6b65 7973 5f6f  ler_story(keys_o
-00018280: 725f 7374 696d 756c 692c 2073 656c 662e  r_stimuli, self.
-00018290: 7472 616e 7369 7469 6f6e 5f6c 6f67 290a  transition_log).
-000182a0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-000182b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000182c0: 2323 230a 2020 2020 2320 4173 7369 676e  ###.    # Assign
-000182d0: 696e 6720 5461 736b 7320 746f 2057 6f72  ing Tasks to Wor
-000182e0: 6b65 7273 2023 0a20 2020 2023 2323 2323  kers #.    #####
-000182f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018300: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
-00018310: 6566 2069 735f 726f 6f74 6973 6828 7365  ef is_rootish(se
-00018320: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-00018330: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
-00018340: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00018350: 5768 6574 6865 7220 6060 7473 6060 2069  Whether ``ts`` i
-00018360: 7320 6120 726f 6f74 206f 7220 726f 6f74  s a root or root
-00018370: 2d6c 696b 6520 7461 736b 2e0a 0a20 2020  -like task...   
-00018380: 2020 2020 2052 6f6f 742d 6973 6820 7461       Root-ish ta
-00018390: 736b 7320 6172 6520 7061 7274 206f 6620  sks are part of 
-000183a0: 6120 6772 6f75 7020 7468 6174 2773 206d  a group that's m
-000183b0: 7563 6820 6c61 7267 6572 2074 6861 6e20  uch larger than 
-000183c0: 7468 6520 636c 7573 7465 722c 0a20 2020  the cluster,.   
-000183d0: 2020 2020 2061 6e64 2068 6176 6520 6665       and have fe
-000183e0: 7720 6f72 206e 6f20 6465 7065 6e64 656e  w or no dependen
-000183f0: 6369 6573 2e0a 2020 2020 2020 2020 2222  cies..        ""
-00018400: 220a 2020 2020 2020 2020 6966 2074 732e  ".        if ts.
-00018410: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-00018420: 7469 6f6e 7320 6f72 2074 732e 776f 726b  tions or ts.work
-00018430: 6572 5f72 6573 7472 6963 7469 6f6e 7320  er_restrictions 
-00018440: 6f72 2074 732e 686f 7374 5f72 6573 7472  or ts.host_restr
-00018450: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
-00018460: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00018470: 650a 2020 2020 2020 2020 7467 203d 2074  e.        tg = t
-00018480: 732e 6772 6f75 700a 2020 2020 2020 2020  s.group.        
-00018490: 2320 544f 444f 2073 686f 7274 2d63 6972  # TODO short-cir
-000184a0: 6375 6974 2074 6f20 5472 7565 2069 6620  cuit to True if 
-000184b0: 606e 6f74 2074 732e 6465 7065 6e64 656e  `not ts.dependen
-000184c0: 6369 6573 603f 0a20 2020 2020 2020 2072  cies`?.        r
-000184d0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
-000184e0: 2020 2020 6c65 6e28 7467 2920 3e20 7365      len(tg) > se
-000184f0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
-00018500: 7320 2a20 320a 2020 2020 2020 2020 2020  s * 2.          
-00018510: 2020 616e 6420 6c65 6e28 7467 2e64 6570    and len(tg.dep
-00018520: 656e 6465 6e63 6965 7329 203c 2035 0a20  endencies) < 5. 
-00018530: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
-00018540: 756d 286d 6170 286c 656e 2c20 7467 2e64  um(map(len, tg.d
-00018550: 6570 656e 6465 6e63 6965 7329 2920 3c20  ependencies)) < 
-00018560: 350a 2020 2020 2020 2020 290a 0a20 2020  5.        )..   
-00018570: 2064 6566 2063 6865 636b 5f69 646c 655f   def check_idle_
-00018580: 7361 7475 7261 7465 6428 7365 6c66 2c20  saturated(self, 
-00018590: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
-000185a0: 206f 6363 3a20 666c 6f61 7420 3d20 2d31   occ: float = -1
-000185b0: 2e30 2920 2d3e 204e 6f6e 653a 0a20 2020  .0) -> None:.   
-000185c0: 2020 2020 2022 2222 5570 6461 7465 2074       """Update t
-000185d0: 6865 2073 7461 7475 7320 6f66 2074 6865  he status of the
-000185e0: 2069 646c 6520 616e 6420 7361 7475 7261   idle and satura
-000185f0: 7465 6420 7374 6174 650a 0a20 2020 2020  ted state..     
-00018600: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
-00018610: 206b 6565 7073 2074 7261 636b 206f 6620   keeps track of 
-00018620: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
-00018630: 202e 2e0a 0a20 2020 2020 2020 202d 2020   ....        -  
-00018640: 5361 7475 7261 7465 643a 2068 6176 6520  Saturated: have 
-00018650: 656e 6f75 6768 2077 6f72 6b20 746f 2073  enough work to s
-00018660: 7461 7920 6275 7379 0a20 2020 2020 2020  tay busy.       
-00018670: 202d 2020 4964 6c65 3a20 646f 206e 6f74   -  Idle: do not
-00018680: 2068 6176 6520 656e 6f75 6768 2077 6f72   have enough wor
-00018690: 6b20 746f 2073 7461 7920 6275 7379 0a0a  k to stay busy..
-000186a0: 2020 2020 2020 2020 5468 6579 2061 7265          They are
-000186b0: 2063 6f6e 7369 6465 7265 6420 7361 7475   considered satu
-000186c0: 7261 7465 6420 6966 2074 6865 7920 626f  rated if they bo
-000186d0: 7468 2068 6176 6520 656e 6f75 6768 2074  th have enough t
-000186e0: 6173 6b73 2074 6f20 6f63 6375 7079 0a20  asks to occupy. 
-000186f0: 2020 2020 2020 2061 6c6c 206f 6620 7468         all of th
-00018700: 6569 7220 7468 7265 6164 732c 2061 6e64  eir threads, and
-00018710: 2069 6620 7468 6520 6578 7065 6374 6564   if the expected
-00018720: 2072 756e 7469 6d65 206f 6620 7468 6f73   runtime of thos
-00018730: 6520 7461 736b 7320 6973 0a20 2020 2020  e tasks is.     
-00018740: 2020 206c 6172 6765 2065 6e6f 7567 682e     large enough.
-00018750: 0a0a 2020 2020 2020 2020 4966 2060 6064  ..        If ``d
-00018760: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-00018770: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
-00018780: 7261 7469 6f6e 6060 2069 7320 6e6f 7420  ration`` is not 
-00018790: 6060 696e 6660 600a 2020 2020 2020 2020  ``inf``.        
-000187a0: 2873 6368 6564 756c 6572 2d73 6964 6520  (scheduler-side 
-000187b0: 7175 6575 696e 6720 6973 2065 6e61 626c  queuing is enabl
-000187c0: 6564 292c 2074 6865 7920 6172 6520 636f  ed), they are co
-000187d0: 6e73 6964 6572 6564 2069 646c 650a 2020  nsidered idle.  
-000187e0: 2020 2020 2020 6966 2074 6865 7920 6861        if they ha
-000187f0: 7665 2066 6577 6572 2074 6173 6b73 2070  ve fewer tasks p
-00018800: 726f 6365 7373 696e 6720 7468 616e 2074  rocessing than t
-00018810: 6865 2060 6077 6f72 6b65 722d 7361 7475  he ``worker-satu
-00018820: 7261 7469 6f6e 6060 0a20 2020 2020 2020  ration``.       
-00018830: 2074 6872 6573 686f 6c64 2064 6963 7461   threshold dicta
-00018840: 7465 732e 0a0a 2020 2020 2020 2020 4f74  tes...        Ot
-00018850: 6865 7277 6973 652c 2074 6865 7920 6172  herwise, they ar
-00018860: 6520 636f 6e73 6964 6572 6564 2069 646c  e considered idl
-00018870: 6520 6966 2074 6865 7920 6861 7665 2066  e if they have f
-00018880: 6577 6572 2074 6173 6b73 2070 726f 6365  ewer tasks proce
-00018890: 7373 696e 670a 2020 2020 2020 2020 7468  ssing.        th
-000188a0: 616e 2074 6872 6561 6473 2c20 6f72 2069  an threads, or i
-000188b0: 6620 7468 6569 7220 7461 736b 7327 2074  f their tasks' t
-000188c0: 6f74 616c 2065 7870 6563 7465 6420 7275  otal expected ru
-000188d0: 6e74 696d 6520 6973 206c 6573 7320 7468  ntime is less th
-000188e0: 616e 2068 616c 660a 2020 2020 2020 2020  an half.        
-000188f0: 7468 6520 6578 7065 6374 6564 2072 756e  the expected run
-00018900: 7469 6d65 206f 6620 7468 6520 7361 6d65  time of the same
-00018910: 206e 756d 6265 7220 6f66 2061 7665 7261   number of avera
-00018920: 6765 2074 6173 6b73 2e0a 0a20 2020 2020  ge tasks...     
-00018930: 2020 2054 6869 7320 6973 2075 7365 6675     This is usefu
-00018940: 6c20 666f 7220 6c6f 6164 2062 616c 616e  l for load balan
-00018950: 6369 6e67 2061 6e64 2061 6461 7074 6976  cing and adaptiv
-00018960: 6974 792e 0a20 2020 2020 2020 2022 2222  ity..        """
-00018970: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00018980: 2e74 6f74 616c 5f6e 7468 7265 6164 7320  .total_nthreads 
-00018990: 3d3d 2030 206f 7220 7773 2e73 7461 7475  == 0 or ws.statu
-000189a0: 7320 3d3d 2053 7461 7475 732e 636c 6f73  s == Status.clos
-000189b0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-000189c0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-000189d0: 6620 6f63 6320 3c20 303a 0a20 2020 2020  f occ < 0:.     
-000189e0: 2020 2020 2020 206f 6363 203d 2077 732e         occ = ws.
-000189f0: 6f63 6375 7061 6e63 790a 0a20 2020 2020  occupancy..     
-00018a00: 2020 2070 203d 206c 656e 2877 732e 7072     p = len(ws.pr
-00018a10: 6f63 6573 7369 6e67 290a 0a20 2020 2020  ocessing)..     
-00018a20: 2020 2073 656c 662e 7361 7475 7261 7465     self.saturate
-00018a30: 642e 6469 7363 6172 6428 7773 290a 2020  d.discard(ws).  
-00018a40: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
-00018a50: 7573 2021 3d20 5374 6174 7573 2e72 756e  us != Status.run
-00018a60: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
-00018a70: 2020 7365 6c66 2e69 646c 652e 706f 7028    self.idle.pop(
-00018a80: 7773 2e61 6464 7265 7373 2c20 4e6f 6e65  ws.address, None
-00018a90: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-00018aa0: 656c 662e 6973 5f75 6e6f 6363 7570 6965  elf.is_unoccupie
-00018ab0: 6428 7773 2c20 6f63 632c 2070 293a 0a20  d(ws, occ, p):. 
-00018ac0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00018ad0: 6964 6c65 5b77 732e 6164 6472 6573 735d  idle[ws.address]
-00018ae0: 203d 2077 730a 2020 2020 2020 2020 656c   = ws.        el
-00018af0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00018b00: 7365 6c66 2e69 646c 652e 706f 7028 7773  self.idle.pop(ws
-00018b10: 2e61 6464 7265 7373 2c20 4e6f 6e65 290a  .address, None).
-00018b20: 2020 2020 2020 2020 2020 2020 6e63 203d              nc =
-00018b30: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
-00018b40: 2020 2020 2020 2020 2069 6620 7020 3e20           if p > 
-00018b50: 6e63 3a0a 2020 2020 2020 2020 2020 2020  nc:.            
-00018b60: 2020 2020 7065 6e64 696e 6720 3d20 6f63      pending = oc
-00018b70: 6320 2a20 2870 202d 206e 6329 202f 2028  c * (p - nc) / (
-00018b80: 7020 2a20 6e63 290a 2020 2020 2020 2020  p * nc).        
-00018b90: 2020 2020 2020 2020 6966 2030 2e34 203c          if 0.4 <
-00018ba0: 2070 656e 6469 6e67 203e 2031 2e39 202a   pending > 1.9 *
-00018bb0: 2028 7365 6c66 2e74 6f74 616c 5f6f 6363   (self.total_occ
-00018bc0: 7570 616e 6379 202f 2073 656c 662e 746f  upancy / self.to
-00018bd0: 7461 6c5f 6e74 6872 6561 6473 293a 0a20  tal_nthreads):. 
-00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bf0: 2020 2073 656c 662e 7361 7475 7261 7465     self.saturate
-00018c00: 642e 6164 6428 7773 290a 0a20 2020 2020  d.add(ws)..     
-00018c10: 2020 2069 6620 6e6f 7420 5f77 6f72 6b65     if not _worke
-00018c20: 725f 6675 6c6c 2877 732c 2073 656c 662e  r_full(ws, self.
-00018c30: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
-00018c40: 4e29 2061 6e64 2077 732e 7374 6174 7573  N) and ws.status
-00018c50: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-00018c60: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00018c70: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-00018c80: 6f75 6e74 2e61 6464 2877 7329 0a20 2020  ount.add(ws).   
-00018c90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000103e0: 2020 2066 2249 6d70 6f73 7369 626c 6520     f"Impossible 
+000103f0: 7472 616e 7369 7469 6f6e 2066 726f 6d20  transition from 
+00010400: 7b73 7461 7274 7d20 746f 207b 6669 6e69  {start} to {fini
+00010410: 7368 7d20 666f 7220 7b6b 6579 2172 7d3a  sh} for {key!r}:
+00010420: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00010430: 2020 2020 2020 2066 227b 7374 696d 756c         f"{stimul
+00010440: 7573 5f69 643d 7d2c 207b 6b77 6172 6773  us_id=}, {kwargs
+00010450: 3d7d 2c20 7374 6f72 793d 7b73 656c 662e  =}, story={self.
+00010460: 7374 6f72 7928 7473 297d 220a 2020 2020  story(ts)}".    
+00010470: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00010480: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00010490: 7420 7374 696d 756c 7573 5f69 643a 0a20  t stimulus_id:. 
+000104a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000104b0: 7469 6d75 6c75 735f 6964 203d 2053 5449  timulus_id = STI
+000104c0: 4d55 4c55 535f 4944 5f55 4e53 4554 0a0a  MULUS_ID_UNSET..
+000104d0: 2020 2020 2020 2020 2020 2020 6163 7475              actu
+000104e0: 616c 5f66 696e 6973 6820 3d20 7473 2e5f  al_finish = ts._
+000104f0: 7374 6174 650a 2020 2020 2020 2020 2020  state.          
+00010500: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
+00010510: 6e5f 6c6f 672e 6170 7065 6e64 280a 2020  n_log.append(.  
+00010520: 2020 2020 2020 2020 2020 2020 2020 5472                Tr
+00010530: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+00010540: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00010550: 792c 2073 7461 7274 2c20 6163 7475 616c  y, start, actual
+00010560: 5f66 696e 6973 682c 2072 6563 6f6d 6d65  _finish, recomme
+00010570: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
+00010580: 7573 5f69 642c 2074 696d 6528 290a 2020  us_id, time().  
+00010590: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000105a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000105b0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000105c0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+000105d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000105e0: 7469 6d75 6c75 735f 6964 203d 3d20 5354  timulus_id == ST
+000105f0: 494d 554c 5553 5f49 445f 554e 5345 543a  IMULUS_ID_UNSET:
+00010600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010610: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00010620: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
+00010630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010640: 2022 7374 696d 756c 7573 5f69 6420 6e6f   "stimulus_id no
+00010650: 7420 7365 7420 6475 7269 6e67 2053 6368  t set during Sch
+00010660: 6564 756c 6572 2074 7261 6e73 6974 696f  eduler transitio
+00010670: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+00010680: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010690: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+000106a0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+000106b0: 2020 2020 2020 2020 2020 2022 5472 616e             "Tran
+000106c0: 7369 7469 6f6e 6564 2025 7220 2573 2d3e  sitioned %r %s->
+000106d0: 2573 2028 6163 7475 616c 3a20 2573 292e  %s (actual: %s).
+000106e0: 2020 436f 6e73 6571 7565 6e63 653a 2025    Consequence: %
+000106f0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00010700: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+00010710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010720: 2073 7461 7274 2c0a 2020 2020 2020 2020   start,.        
+00010730: 2020 2020 2020 2020 2020 2020 6669 6e69              fini
+00010740: 7368 2c0a 2020 2020 2020 2020 2020 2020  sh,.            
+00010750: 2020 2020 2020 2020 6163 7475 616c 5f66          actual_f
+00010760: 696e 6973 682c 0a20 2020 2020 2020 2020  inish,.         
+00010770: 2020 2020 2020 2020 2020 2064 6963 7428             dict(
+00010780: 7265 636f 6d6d 656e 6461 7469 6f6e 7329  recommendations)
+00010790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000107a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000107b0: 6966 2073 656c 662e 706c 7567 696e 733a  if self.plugins:
+000107c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000107d0: 2023 2054 656d 706f 7261 7269 6c79 2070   # Temporarily p
+000107e0: 7574 2062 6163 6b20 666f 7267 6f74 7465  ut back forgotte
+000107f0: 6e20 6b65 7920 666f 7220 706c 7567 696e  n key for plugin
+00010800: 2074 6f20 7265 7472 6965 7665 2069 740a   to retrieve it.
+00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010820: 6966 2074 732e 5f73 7461 7465 203d 3d20  if ts._state == 
+00010830: 2266 6f72 676f 7474 656e 223a 0a20 2020  "forgotten":.   
+00010840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010850: 2074 732e 6465 7065 6e64 656e 7473 203d   ts.dependents =
+00010860: 2064 6570 656e 6465 6e74 730a 2020 2020   dependents.    
+00010870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010880: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
+00010890: 3d20 6465 7065 6e64 656e 6369 6573 0a20  = dependencies. 
+000108a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108b0: 2020 2073 656c 662e 7461 736b 735b 7473     self.tasks[ts
+000108c0: 2e6b 6579 5d20 3d20 7473 0a20 2020 2020  .key] = ts.     
+000108d0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
+000108e0: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
+000108f0: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+00010900: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+00010910: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00010920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010930: 2020 2020 2020 2070 6c75 6769 6e2e 7472         plugin.tr
+00010940: 616e 7369 7469 6f6e 286b 6579 2c20 7374  ansition(key, st
+00010950: 6172 742c 2061 6374 7561 6c5f 6669 6e69  art, actual_fini
+00010960: 7368 2c20 2a2a 6b77 6172 6773 290a 2020  sh, **kwargs).  
+00010970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010980: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00010990: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+000109a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000109b0: 6572 2e69 6e66 6f28 2250 6c75 6769 6e20  er.info("Plugin 
+000109c0: 6661 696c 6564 2077 6974 6820 6578 6365  failed with exce
+000109d0: 7074 696f 6e22 2c20 6578 635f 696e 666f  ption", exc_info
+000109e0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+000109f0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+00010a00: 7465 203d 3d20 2266 6f72 676f 7474 656e  te == "forgotten
+00010a10: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00010a20: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+00010a30: 7461 736b 735b 7473 2e6b 6579 5d0a 0a20  tasks[ts.key].. 
+00010a40: 2020 2020 2020 2020 2020 2074 6720 3d20             tg = 
+00010a50: 7473 2e67 726f 7570 0a20 2020 2020 2020  ts.group.       
+00010a60: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
+00010a70: 203d 3d20 2266 6f72 676f 7474 656e 2220   == "forgotten" 
+00010a80: 616e 6420 7467 2e6e 616d 6520 696e 2073  and tg.name in s
+00010a90: 656c 662e 7461 736b 5f67 726f 7570 733a  elf.task_groups:
+00010aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ab0: 2023 2052 656d 6f76 6520 5461 736b 4772   # Remove TaskGr
+00010ac0: 6f75 7020 6966 2061 6c6c 2074 6173 6b73  oup if all tasks
+00010ad0: 2061 7265 2069 6e20 7468 6520 666f 7267   are in the forg
+00010ae0: 6f74 7465 6e20 7374 6174 650a 2020 2020  otten state.    
+00010af0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+00010b00: 6c6c 2876 203d 3d20 3020 6f72 206b 203d  ll(v == 0 or k =
+00010b10: 3d20 2266 6f72 676f 7474 656e 2220 666f  = "forgotten" fo
+00010b20: 7220 6b2c 2076 2069 6e20 7467 2e73 7461  r k, v in tg.sta
+00010b30: 7465 732e 6974 656d 7328 2929 3a0a 2020  tes.items()):.  
+00010b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b50: 2020 7473 2e70 7265 6669 782e 6772 6f75    ts.prefix.grou
+00010b60: 7073 2e72 656d 6f76 6528 7467 290a 2020  ps.remove(tg).  
+00010b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b80: 2020 6465 6c20 7365 6c66 2e74 6173 6b5f    del self.task_
+00010b90: 6772 6f75 7073 5b74 672e 6e61 6d65 5d0a  groups[tg.name].
+00010ba0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010bb0: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+00010bc0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+00010bd0: 2c20 776f 726b 6572 5f6d 7367 730a 2020  , worker_msgs.  
+00010be0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00010bf0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00010c00: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+00010c10: 7469 6f6e 2822 4572 726f 7220 7472 616e  tion("Error tran
+00010c20: 7369 7469 6f6e 696e 6720 2572 2066 726f  sitioning %r fro
+00010c30: 6d20 2572 2074 6f20 2572 222c 206b 6579  m %r to %r", key
+00010c40: 2c20 7374 6172 742c 2066 696e 6973 6829  , start, finish)
+00010c50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010c60: 4c4f 475f 5044 423a 0a20 2020 2020 2020  LOG_PDB:.       
+00010c70: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+00010c80: 7064 620a 0a20 2020 2020 2020 2020 2020  pdb..           
+00010c90: 2020 2020 2070 6462 2e73 6574 5f74 7261       pdb.set_tra
+00010ca0: 6365 2829 0a20 2020 2020 2020 2020 2020  ce().           
+00010cb0: 2072 6169 7365 0a0a 2020 2020 6465 6620   raise..    def 
+00010cc0: 5f74 7261 6e73 6974 696f 6e73 280a 2020  _transitions(.  
+00010cd0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00010ce0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00010cf0: 6f6e 733a 2052 6563 732c 0a20 2020 2020  ons: Recs,.     
+00010d00: 2020 2063 6c69 656e 745f 6d73 6773 3a20     client_msgs: 
+00010d10: 4d73 6773 2c0a 2020 2020 2020 2020 776f  Msgs,.        wo
+00010d20: 726b 6572 5f6d 7367 733a 204d 7367 732c  rker_msgs: Msgs,
+00010d30: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00010d40: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
+00010d50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00010d60: 2020 2222 2250 726f 6365 7373 2074 7261    """Process tra
+00010d70: 6e73 6974 696f 6e73 2075 6e74 696c 206e  nsitions until n
+00010d80: 6f6e 6520 6172 6520 6c65 6674 0a0a 2020  one are left..  
+00010d90: 2020 2020 2020 5468 6973 2069 6e63 6c75        This inclu
+00010da0: 6465 7320 6665 6564 6261 636b 2066 726f  des feedback fro
+00010db0: 6d20 7072 6576 696f 7573 2074 7261 6e73  m previous trans
+00010dc0: 6974 696f 6e73 2061 6e64 2063 6f6e 7469  itions and conti
+00010dd0: 6e75 6573 2075 6e74 696c 2077 650a 2020  nues until we.  
+00010de0: 2020 2020 2020 7265 6163 6820 6120 7374        reach a st
+00010df0: 6561 6479 2073 7461 7465 0a20 2020 2020  eady state.     
+00010e00: 2020 2022 2222 0a20 2020 2020 2020 206b     """.        k
+00010e10: 6579 733a 2073 6574 5b73 7472 5d20 3d20  eys: set[str] = 
+00010e20: 7365 7428 290a 2020 2020 2020 2020 7265  set().        re
+00010e30: 636f 6d6d 656e 6461 7469 6f6e 7320 3d20  commendations = 
+00010e40: 7265 636f 6d6d 656e 6461 7469 6f6e 732e  recommendations.
+00010e50: 636f 7079 2829 0a0a 2020 2020 2020 2020  copy()..        
+00010e60: 7768 696c 6520 7265 636f 6d6d 656e 6461  while recommenda
+00010e70: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00010e80: 2020 206b 6579 2c20 6669 6e69 7368 203d     key, finish =
+00010e90: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00010ea0: 2e70 6f70 6974 656d 2829 0a20 2020 2020  .popitem().     
+00010eb0: 2020 2020 2020 206b 6579 732e 6164 6428         keys.add(
+00010ec0: 6b65 7929 0a0a 2020 2020 2020 2020 2020  key)..          
+00010ed0: 2020 6e65 775f 7265 6373 2c20 6e65 775f    new_recs, new_
+00010ee0: 636d 7367 732c 206e 6577 5f77 6d73 6773  cmsgs, new_wmsgs
+00010ef0: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
+00010f00: 696f 6e28 6b65 792c 2066 696e 6973 682c  ion(key, finish,
+00010f10: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
+00010f20: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00010f30: 6d65 6e64 6174 696f 6e73 2e75 7064 6174  mendations.updat
+00010f40: 6528 6e65 775f 7265 6373 290a 2020 2020  e(new_recs).    
+00010f50: 2020 2020 2020 2020 666f 7220 632c 206e          for c, n
+00010f60: 6577 5f6d 7367 7320 696e 206e 6577 5f63  ew_msgs in new_c
+00010f70: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
+00010f80: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00010f90: 6965 6e74 5f6d 7367 732e 7365 7464 6566  ient_msgs.setdef
+00010fa0: 6175 6c74 2863 2c20 5b5d 292e 6578 7465  ault(c, []).exte
+00010fb0: 6e64 286e 6577 5f6d 7367 7329 0a20 2020  nd(new_msgs).   
+00010fc0: 2020 2020 2020 2020 2066 6f72 2077 2c20           for w, 
+00010fd0: 6e65 775f 6d73 6773 2069 6e20 6e65 775f  new_msgs in new_
+00010fe0: 776d 7367 732e 6974 656d 7328 293a 0a20  wmsgs.items():. 
+00010ff0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00011000: 6f72 6b65 725f 6d73 6773 2e73 6574 6465  orker_msgs.setde
+00011010: 6661 756c 7428 772c 205b 5d29 2e65 7874  fault(w, []).ext
+00011020: 656e 6428 6e65 775f 6d73 6773 290a 0a20  end(new_msgs).. 
+00011030: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00011040: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00011050: 2020 2020 2023 2046 4958 4d45 2064 6f77       # FIXME dow
+00011060: 6e63 6173 7420 616e 7469 7061 7474 6572  ncast antipatter
+00011070: 6e0a 2020 2020 2020 2020 2020 2020 7363  n.            sc
+00011080: 6865 6475 6c65 7220 3d20 6361 7374 2853  heduler = cast(S
+00011090: 6368 6564 756c 6572 2c20 7365 6c66 290a  cheduler, self).
+000110a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000110b0: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
+000110c0: 2020 2020 2020 2020 2020 2020 2073 6368               sch
+000110d0: 6564 756c 6572 2e76 616c 6964 6174 655f  eduler.validate_
+000110e0: 6b65 7928 6b65 7929 0a0a 2020 2020 6465  key(key)..    de
+000110f0: 6620 7472 616e 7369 7469 6f6e 5f72 656c  f transition_rel
+00011100: 6561 7365 645f 7761 6974 696e 6728 7365  eased_waiting(se
+00011110: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
+00011120: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
+00011130: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
+00011140: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00011150: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
+00011160: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00011170: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00011180: 2061 7373 6572 7420 7473 2e72 756e 5f73   assert ts.run_s
+00011190: 7065 630a 2020 2020 2020 2020 2020 2020  pec.            
+000111a0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+000111b0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+000111c0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+000111d0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+000111e0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+000111f0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00011200: 6f6e 0a20 2020 2020 2020 2020 2020 2066  on.            f
+00011210: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+00011220: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00011230: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00011240: 7420 6474 732e 7374 6174 6520 6e6f 7420  t dts.state not 
+00011250: 696e 207b 2266 6f72 676f 7474 656e 222c  in {"forgotten",
+00011260: 2022 6572 7265 6422 7d0a 0a20 2020 2020   "erred"}..     
+00011270: 2020 2069 6620 7473 2e68 6173 5f6c 6f73     if ts.has_los
+00011280: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
+00011290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000112a0: 726e 207b 6b65 793a 2022 666f 7267 6f74  rn {key: "forgot
+000112b0: 7465 6e22 7d2c 207b 7d2c 207b 7d0a 0a20  ten"}, {}, {}.. 
+000112c0: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+000112d0: 3d20 2277 6169 7469 6e67 220a 0a20 2020  = "waiting"..   
+000112e0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+000112f0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00011300: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+00011310: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00011320: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00011330: 2069 6620 6e6f 7420 6474 732e 7768 6f5f   if not dts.who_
+00011340: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+00011350: 2020 2020 2074 732e 7761 6974 696e 675f       ts.waiting_
+00011360: 6f6e 2e61 6464 2864 7473 290a 2020 2020  on.add(dts).    
+00011370: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
+00011380: 7461 7465 203d 3d20 2272 656c 6561 7365  tate == "release
+00011390: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
+000113a0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000113b0: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
+000113c0: 7761 6974 696e 6722 0a20 2020 2020 2020  waiting".       
+000113d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000113e0: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
+000113f0: 6169 7465 7273 2e61 6464 2874 7329 0a0a  aiters.add(ts)..
+00011400: 2020 2020 2020 2020 7473 2e77 6169 7465          ts.waite
+00011410: 7273 203d 207b 6474 7320 666f 7220 6474  rs = {dts for dt
+00011420: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00011430: 7473 2069 6620 6474 732e 7374 6174 6520  ts if dts.state 
+00011440: 3d3d 2022 7761 6974 696e 6722 7d0a 0a20  == "waiting"}.. 
+00011450: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+00011460: 2e77 6169 7469 6e67 5f6f 6e3a 0a20 2020  .waiting_on:.   
+00011470: 2020 2020 2020 2020 2023 204e 4f54 453a           # NOTE:
+00011480: 2077 6169 7469 6e67 2d3e 7072 6f63 6573   waiting->proces
+00011490: 7369 6e67 2077 696c 6c20 7365 6e64 2074  sing will send t
+000114a0: 6173 6b73 2074 6f20 7175 6575 6564 206f  asks to queued o
+000114b0: 7220 6e6f 2d77 6f72 6b65 7220 6173 0a20  r no-worker as. 
+000114c0: 2020 2020 2020 2020 2020 2023 206e 6563             # nec
+000114d0: 6573 7361 7279 0a20 2020 2020 2020 2020  essary.         
+000114e0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+000114f0: 6e73 5b6b 6579 5d20 3d20 2270 726f 6365  ns[key] = "proce
+00011500: 7373 696e 6722 0a0a 2020 2020 2020 2020  ssing"..        
+00011510: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00011520: 6174 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a  ations, {}, {}..
+00011530: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+00011540: 6f6e 5f6e 6f5f 776f 726b 6572 5f70 726f  on_no_worker_pro
+00011550: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
+00011560: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
+00011570: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00011580: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+00011590: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+000115a0: 6579 5d0a 2020 2020 2020 2020 776f 726b  ey].        work
+000115b0: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+000115c0: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
+000115d0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+000115e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000115f0: 206e 6f74 2074 732e 6163 746f 722c 2066   not ts.actor, f
+00011600: 2241 6374 6f72 7320 6361 6e27 7420 6265  "Actors can't be
+00011610: 2069 6e20 606e 6f2d 776f 726b 6572 603a   in `no-worker`:
+00011620: 207b 7473 7d22 0a20 2020 2020 2020 2020   {ts}".         
+00011630: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00011640: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
+00011650: 0a20 2020 2020 2020 2069 6620 7773 203a  .        if ws :
+00011660: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
+00011670: 726b 6572 5f6e 6f6e 5f72 6f6f 7469 7368  rker_non_rootish
+00011680: 2874 7329 3a0a 2020 2020 2020 2020 2020  (ts):.          
+00011690: 2020 7365 6c66 2e75 6e72 756e 6e61 626c    self.unrunnabl
+000116a0: 652e 6469 7363 6172 6428 7473 290a 2020  e.discard(ts).  
+000116b0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+000116c0: 5f6d 7367 7320 3d20 7365 6c66 2e5f 6164  _msgs = self._ad
+000116d0: 645f 746f 5f70 726f 6365 7373 696e 6728  d_to_processing(
+000116e0: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
+000116f0: 2320 4966 206e 6f20 776f 726b 6572 2c20  # If no worker, 
+00011700: 7461 736b 206a 7573 7420 7374 6179 7320  task just stays 
+00011710: 696e 2060 6e6f 2d77 6f72 6b65 7260 0a0a  in `no-worker`..
+00011720: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00011730: 7d2c 207b 7d2c 2077 6f72 6b65 725f 6d73  }, {}, worker_ms
+00011740: 6773 0a0a 2020 2020 6465 6620 6465 6369  gs..    def deci
+00011750: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
+00011760: 685f 7175 6575 696e 675f 6469 7361 626c  h_queuing_disabl
+00011770: 6564 280a 2020 2020 2020 2020 7365 6c66  ed(.        self
+00011780: 2c20 7473 3a20 5461 736b 5374 6174 650a  , ts: TaskState.
+00011790: 2020 2020 2920 2d3e 2057 6f72 6b65 7253      ) -> WorkerS
+000117a0: 7461 7465 207c 204e 6f6e 653a 0a20 2020  tate | None:.   
+000117b0: 2020 2020 2022 2222 5069 636b 2061 2077       """Pick a w
+000117c0: 6f72 6b65 7220 666f 7220 6120 7275 6e6e  orker for a runn
+000117d0: 6162 6c65 2072 6f6f 742d 6973 6820 7461  able root-ish ta
+000117e0: 736b 2c20 7769 7468 6f75 7420 7175 6575  sk, without queu
+000117f0: 696e 672e 0a0a 2020 2020 2020 2020 5468  ing...        Th
+00011800: 6973 2061 7474 656d 7074 7320 746f 2073  is attempts to s
+00011810: 6368 6564 756c 6520 7369 626c 696e 6720  chedule sibling 
+00011820: 7461 736b 7320 6f6e 2074 6865 2073 616d  tasks on the sam
+00011830: 6520 776f 726b 6572 2c20 7265 6475 6369  e worker, reduci
+00011840: 6e67 2066 7574 7572 6520 6461 7461 0a20  ng future data. 
+00011850: 2020 2020 2020 2074 7261 6e73 6665 722e         transfer.
+00011860: 2049 7420 646f 6573 206e 6f74 2063 6f6e   It does not con
+00011870: 7369 6465 7220 7468 6520 6c6f 6361 7469  sider the locati
+00011880: 6f6e 206f 6620 6465 7065 6e64 656e 6369  on of dependenci
+00011890: 6573 2c20 7369 6e63 6520 7468 6579 276c  es, since they'l
+000118a0: 6c20 656e 640a 2020 2020 2020 2020 7570  l end.        up
+000118b0: 206f 6e20 6576 6572 7920 776f 726b 6572   on every worker
+000118c0: 2061 6e79 7761 792e 0a0a 2020 2020 2020   anyway...      
+000118d0: 2020 4974 2061 7373 756d 6573 2069 7427    It assumes it'
+000118e0: 7320 6265 696e 6720 6361 6c6c 6564 206f  s being called o
+000118f0: 6e20 6120 6261 7463 6820 6f66 2074 6173  n a batch of tas
+00011900: 6b73 2069 6e20 7072 696f 7269 7479 206f  ks in priority o
+00011910: 7264 6572 2c20 616e 640a 2020 2020 2020  rder, and.      
+00011920: 2020 6d61 696e 7461 696e 7320 7374 6174    maintains stat
+00011930: 6520 696e 2060 5363 6865 6475 6c65 7253  e in `SchedulerS
+00011940: 7461 7465 2e6c 6173 745f 726f 6f74 5f77  tate.last_root_w
+00011950: 6f72 6b65 7260 2061 6e64 0a20 2020 2020  orker` and.     
+00011960: 2020 2060 5363 6865 6475 6c65 7253 7461     `SchedulerSta
+00011970: 7465 2e6c 6173 745f 726f 6f74 5f77 6f72  te.last_root_wor
+00011980: 6b65 725f 7461 736b 735f 6c65 6674 6020  ker_tasks_left` 
+00011990: 746f 2061 6368 6965 7665 2074 6869 732e  to achieve this.
+000119a0: 0a0a 2020 2020 2020 2020 5468 6973 2077  ..        This w
+000119b0: 696c 6c20 7365 6e64 2065 7665 7279 2072  ill send every r
+000119c0: 756e 6e61 626c 6520 7461 736b 2074 6f20  unnable task to 
+000119d0: 6120 776f 726b 6572 2c20 6f66 7465 6e20  a worker, often 
+000119e0: 6361 7573 696e 6720 726f 6f74 2074 6173  causing root tas
+000119f0: 6b0a 2020 2020 2020 2020 6f76 6572 7072  k.        overpr
+00011a00: 6f64 7563 7469 6f6e 2e0a 0a20 2020 2020  oduction...     
+00011a10: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00011a20: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00011a30: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
+00011a40: 7465 207c 204e 6f6e 650a 2020 2020 2020  te | None.      
+00011a50: 2020 2020 2020 5468 6520 776f 726b 6572        The worker
+00011a60: 2074 6f20 6173 7369 676e 2074 6865 2074   to assign the t
+00011a70: 6173 6b20 746f 2e20 4966 2074 6865 7265  ask to. If there
+00011a80: 2061 7265 206e 6f20 776f 726b 6572 7320   are no workers 
+00011a90: 696e 2074 6865 2063 6c75 7374 6572 2c0a  in the cluster,.
+00011aa0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00011ab0: 726e 7320 4e6f 6e65 2c20 696e 2077 6869  rns None, in whi
+00011ac0: 6368 2063 6173 6520 7468 6520 7461 736b  ch case the task
+00011ad0: 2073 686f 756c 6420 6265 2074 7261 6e73   should be trans
+00011ae0: 6974 696f 6e65 6420 746f 0a20 2020 2020  itioned to.     
+00011af0: 2020 2020 2020 2060 606e 6f2d 776f 726b         ``no-work
+00011b00: 6572 6060 2e0a 2020 2020 2020 2020 2222  er``..        ""
+00011b10: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+00011b20: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+00011b30: 2020 2020 2020 2020 2320 5365 6520 726f          # See ro
+00011b40: 6f74 2d69 7368 2d6e 6573 7320 6e6f 7465  ot-ish-ness note
+00011b50: 2062 656c 6f77 2069 6e20 6064 6563 6964   below in `decid
+00011b60: 655f 776f 726b 6572 5f72 6f6f 7469 7368  e_worker_rootish
+00011b70: 5f71 7565 7569 6e67 5f65 6e61 626c 6564  _queuing_enabled
+00011b80: 600a 2020 2020 2020 2020 2020 2020 6173  `.            as
+00011b90: 7365 7274 206d 6174 682e 6973 696e 6628  sert math.isinf(
+00011ba0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+00011bb0: 5241 5449 4f4e 290a 0a20 2020 2020 2020  RATION)..       
+00011bc0: 2070 6f6f 6c20 3d20 7365 6c66 2e69 646c   pool = self.idl
+00011bd0: 652e 7661 6c75 6573 2829 2069 6620 7365  e.values() if se
+00011be0: 6c66 2e69 646c 6520 656c 7365 2073 656c  lf.idle else sel
+00011bf0: 662e 7275 6e6e 696e 670a 2020 2020 2020  f.running.      
+00011c00: 2020 6966 206e 6f74 2070 6f6f 6c3a 0a20    if not pool:. 
+00011c10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00011c20: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+00011c30: 7467 203d 2074 732e 6772 6f75 700a 2020  tg = ts.group.  
+00011c40: 2020 2020 2020 6c77 7320 3d20 7467 2e6c        lws = tg.l
+00011c50: 6173 745f 776f 726b 6572 0a20 2020 2020  ast_worker.     
+00011c60: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+00011c70: 2020 2020 6c77 730a 2020 2020 2020 2020      lws.        
+00011c80: 2020 2020 616e 6420 7467 2e6c 6173 745f      and tg.last_
+00011c90: 776f 726b 6572 5f74 6173 6b73 5f6c 6566  worker_tasks_lef
+00011ca0: 740a 2020 2020 2020 2020 2020 2020 616e  t.            an
+00011cb0: 6420 6c77 732e 7374 6174 7573 203d 3d20  d lws.status == 
+00011cc0: 5374 6174 7573 2e72 756e 6e69 6e67 0a20  Status.running. 
+00011cd0: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
+00011ce0: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
+00011cf0: 6c77 732e 6164 6472 6573 7329 2069 7320  lws.address) is 
+00011d00: 6c77 730a 2020 2020 2020 2020 293a 0a20  lws.        ):. 
+00011d10: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
+00011d20: 6c77 730a 2020 2020 2020 2020 656c 7365  lws.        else
+00011d30: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00011d40: 4c61 7374 2d75 7365 6420 776f 726b 6572  Last-used worker
+00011d50: 2069 7320 6675 6c6c 2c20 756e 6b6e 6f77   is full, unknow
+00011d60: 6e2c 2072 6574 6972 696e 672c 206f 7220  n, retiring, or 
+00011d70: 7061 7573 6564 3b0a 2020 2020 2020 2020  paused;.        
+00011d80: 2020 2020 2320 7069 636b 2061 206e 6577      # pick a new
+00011d90: 2077 6f72 6b65 7220 666f 7220 7468 6520   worker for the 
+00011da0: 6e65 7874 2066 6577 2074 6173 6b73 0a20  next few tasks. 
+00011db0: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
+00011dc0: 6d69 6e28 706f 6f6c 2c20 6b65 793d 7061  min(pool, key=pa
+00011dd0: 7274 6961 6c28 7365 6c66 2e77 6f72 6b65  rtial(self.worke
+00011de0: 725f 6f62 6a65 6374 6976 652c 2074 7329  r_objective, ts)
+00011df0: 290a 2020 2020 2020 2020 2020 2020 7467  ).            tg
+00011e00: 2e6c 6173 745f 776f 726b 6572 5f74 6173  .last_worker_tas
+00011e10: 6b73 5f6c 6566 7420 3d20 6d61 7468 2e66  ks_left = math.f
+00011e20: 6c6f 6f72 280a 2020 2020 2020 2020 2020  loor(.          
+00011e30: 2020 2020 2020 286c 656e 2874 6729 202f        (len(tg) /
+00011e40: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
+00011e50: 6561 6473 2920 2a20 7773 2e6e 7468 7265  eads) * ws.nthre
+00011e60: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
+00011e70: 290a 0a20 2020 2020 2020 2023 2052 6563  )..        # Rec
+00011e80: 6f72 6420 606c 6173 745f 776f 726b 6572  ord `last_worker
+00011e90: 602c 206f 7220 636c 6561 7220 6974 206f  `, or clear it o
+00011ea0: 6e20 7468 6520 6669 6e61 6c20 7461 736b  n the final task
+00011eb0: 0a20 2020 2020 2020 2074 672e 6c61 7374  .        tg.last
+00011ec0: 5f77 6f72 6b65 7220 3d20 280a 2020 2020  _worker = (.    
+00011ed0: 2020 2020 2020 2020 7773 2069 6620 7467          ws if tg
+00011ee0: 2e73 7461 7465 735b 2272 656c 6561 7365  .states["release
+00011ef0: 6422 5d20 2b20 7467 2e73 7461 7465 735b  d"] + tg.states[
+00011f00: 2277 6169 7469 6e67 225d 203e 2031 2065  "waiting"] > 1 e
+00011f10: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+00011f20: 2029 0a20 2020 2020 2020 2074 672e 6c61   ).        tg.la
+00011f30: 7374 5f77 6f72 6b65 725f 7461 736b 735f  st_worker_tasks_
+00011f40: 6c65 6674 202d 3d20 310a 0a20 2020 2020  left -= 1..     
+00011f50: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00011f60: 6174 6520 616e 6420 7773 2069 7320 6e6f  ate and ws is no
+00011f70: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00011f80: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+00011f90: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
+00011fa0: 6464 7265 7373 2920 6973 2077 730a 2020  ddress) is ws.  
+00011fb0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00011fc0: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
+00011fd0: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
+00011fe0: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
+00011ff0: 2072 6574 7572 6e20 7773 0a0a 2020 2020   return ws..    
+00012000: 6465 6620 6465 6369 6465 5f77 6f72 6b65  def decide_worke
+00012010: 725f 726f 6f74 6973 685f 7175 6575 696e  r_rootish_queuin
+00012020: 675f 656e 6162 6c65 6428 7365 6c66 2920  g_enabled(self) 
+00012030: 2d3e 2057 6f72 6b65 7253 7461 7465 207c  -> WorkerState |
+00012040: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00012050: 2222 5069 636b 2061 2077 6f72 6b65 7220  ""Pick a worker 
+00012060: 666f 7220 6120 7275 6e6e 6162 6c65 2072  for a runnable r
+00012070: 6f6f 742d 6973 6820 7461 736b 2c20 6966  oot-ish task, if
+00012080: 206e 6f74 2061 6c6c 2061 7265 2062 7573   not all are bus
+00012090: 792e 0a0a 2020 2020 2020 2020 5069 636b  y...        Pick
+000120a0: 7320 7468 6520 6c65 6173 742d 6275 7379  s the least-busy
+000120b0: 2077 6f72 6b65 7220 6f75 7420 6f66 2074   worker out of t
+000120c0: 6865 2060 6069 646c 6560 6020 776f 726b  he ``idle`` work
+000120d0: 6572 7320 2869 646c 6520 776f 726b 6572  ers (idle worker
+000120e0: 7320 6861 7665 2066 6577 6572 0a20 2020  s have fewer.   
+000120f0: 2020 2020 2074 6173 6b73 2072 756e 6e69       tasks runni
+00012100: 6e67 2074 6861 6e20 7468 7265 6164 732c  ng than threads,
+00012110: 2061 7320 7365 7420 6279 2060 6064 6973   as set by ``dis
+00012120: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+00012130: 6572 2e77 6f72 6b65 722d 7361 7475 7261  er.worker-satura
+00012140: 7469 6f6e 6060 292e 0a20 2020 2020 2020  tion``)..       
+00012150: 2049 7420 646f 6573 206e 6f74 2063 6f6e   It does not con
+00012160: 7369 6465 7220 7468 6520 6c6f 6361 7469  sider the locati
+00012170: 6f6e 206f 6620 6465 7065 6e64 656e 6369  on of dependenci
+00012180: 6573 2c20 7369 6e63 6520 7468 6579 276c  es, since they'l
+00012190: 6c20 656e 6420 7570 206f 6e20 6576 6572  l end up on ever
+000121a0: 790a 2020 2020 2020 2020 776f 726b 6572  y.        worker
+000121b0: 2061 6e79 7761 792e 0a0a 2020 2020 2020   anyway...      
+000121c0: 2020 4966 2061 6c6c 2077 6f72 6b65 7273    If all workers
+000121d0: 2061 7265 2066 756c 6c2c 2072 6574 7572   are full, retur
+000121e0: 6e73 204e 6f6e 652c 206d 6561 6e69 6e67  ns None, meaning
+000121f0: 2074 6865 2074 6173 6b20 7368 6f75 6c64   the task should
+00012200: 2074 7261 6e73 6974 696f 6e20 746f 0a20   transition to. 
+00012210: 2020 2020 2020 2060 6071 7565 7565 6460         ``queued`
+00012220: 602e 2054 6865 2073 6368 6564 756c 6572  `. The scheduler
+00012230: 2077 696c 6c20 7761 6974 2074 6f20 7365   will wait to se
+00012240: 6e64 2069 7420 746f 2061 2077 6f72 6b65  nd it to a worke
+00012250: 7220 756e 7469 6c20 6120 7468 7265 6164  r until a thread
+00012260: 206f 7065 6e73 0a20 2020 2020 2020 2075   opens.        u
+00012270: 702e 2054 6869 7320 656e 7375 7265 7320  p. This ensures 
+00012280: 7468 6174 2064 6f77 6e73 7472 6561 6d20  that downstream 
+00012290: 7461 736b 7320 616c 7761 7973 2072 756e  tasks always run
+000122a0: 2062 6566 6f72 6520 6e65 7720 726f 6f74   before new root
+000122b0: 2074 6173 6b73 2061 7265 0a20 2020 2020   tasks are.     
+000122c0: 2020 2073 7461 7274 6564 2e0a 0a20 2020     started...   
+000122d0: 2020 2020 2054 6869 7320 646f 6573 206e       This does n
+000122e0: 6f74 2074 7279 2074 6f20 7363 6865 6475  ot try to schedu
+000122f0: 6c65 2073 6962 6c69 6e67 2074 6173 6b73  le sibling tasks
+00012300: 206f 6e20 7468 6520 7361 6d65 2077 6f72   on the same wor
+00012310: 6b65 723b 2069 6e20 6661 6374 2c20 6974  ker; in fact, it
+00012320: 0a20 2020 2020 2020 2075 7375 616c 6c79  .        usually
+00012330: 2064 6f65 7320 7468 6520 6f70 706f 7369   does the opposi
+00012340: 7465 2e20 4576 656e 2074 686f 7567 6820  te. Even though 
+00012350: 7468 6973 2069 6e63 7265 6173 6573 2073  this increases s
+00012360: 7562 7365 7175 656e 7420 6461 7461 2074  ubsequent data t
+00012370: 7261 6e73 6665 722c 0a20 2020 2020 2020  ransfer,.       
+00012380: 2069 7420 7479 7069 6361 6c6c 7920 7265   it typically re
+00012390: 6475 6365 7320 6f76 6572 616c 6c20 6d65  duces overall me
+000123a0: 6d6f 7279 2075 7365 2062 7920 656c 696d  mory use by elim
+000123b0: 696e 6174 696e 6720 726f 6f74 2074 6173  inating root tas
+000123c0: 6b20 6f76 6572 7072 6f64 7563 7469 6f6e  k overproduction
+000123d0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+000123e0: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
+000123f0: 2d2d 0a20 2020 2020 2020 2077 733a 2057  --.        ws: W
+00012400: 6f72 6b65 7253 7461 7465 207c 204e 6f6e  orkerState | Non
+00012410: 650a 2020 2020 2020 2020 2020 2020 5468  e.            Th
+00012420: 6520 776f 726b 6572 2074 6f20 6173 7369  e worker to assi
+00012430: 676e 2074 6865 2074 6173 6b20 746f 2e20  gn the task to. 
+00012440: 4966 2074 6865 7265 2061 7265 206e 6f20  If there are no 
+00012450: 6964 6c65 2077 6f72 6b65 7273 2c20 7265  idle workers, re
+00012460: 7475 726e 730a 2020 2020 2020 2020 2020  turns.          
+00012470: 2020 4e6f 6e65 2c20 696e 2077 6869 6368    None, in which
+00012480: 2063 6173 6520 7468 6520 7461 736b 2073   case the task s
+00012490: 686f 756c 6420 6265 2074 7261 6e73 6974  hould be transit
+000124a0: 696f 6e65 6420 746f 2060 6071 7565 7565  ioned to ``queue
+000124b0: 6460 602e 0a0a 2020 2020 2020 2020 2222  d``...        ""
+000124c0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+000124d0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+000124e0: 2020 2020 2020 2020 2320 5765 2064 6f6e          # We don
+000124f0: 2774 2060 6173 7365 7274 2073 656c 662e  't `assert self.
+00012500: 6973 5f72 6f6f 7469 7368 2874 7329 6020  is_rootish(ts)` 
+00012510: 6865 7265 2c20 6265 6361 7573 6520 7468  here, because th
+00012520: 6174 2063 6865 636b 2069 730a 2020 2020  at check is.    
+00012530: 2020 2020 2020 2020 2320 6465 7065 6e64          # depend
+00012540: 656e 7420 6f6e 2063 6c75 7374 6572 2073  ent on cluster s
+00012550: 697a 652e 2049 7427 7320 706f 7373 6962  ize. It's possib
+00012560: 6c65 2061 2074 6173 6b20 6c6f 6f6b 6564  le a task looked
+00012570: 2072 6f6f 742d 6973 6820 7768 656e 2069   root-ish when i
+00012580: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00012590: 7761 7320 7175 6575 6564 2c20 6275 7420  was queued, but 
+000125a0: 7468 6520 636c 7573 7465 7220 6861 7320  the cluster has 
+000125b0: 7369 6e63 6520 7363 616c 6564 2075 7020  since scaled up 
+000125c0: 616e 6420 6974 206e 6f20 6c6f 6e67 6572  and it no longer
+000125d0: 2064 6f65 7320 7768 656e 0a20 2020 2020   does when.     
+000125e0: 2020 2020 2020 2023 2063 6f6d 696e 6720         # coming 
+000125f0: 6f75 7420 6f66 2074 6865 2071 7565 7565  out of the queue
+00012600: 2e20 4966 2060 6973 5f72 6f6f 7469 7368  . If `is_rootish
+00012610: 6020 6368 616e 6765 7320 746f 2061 2073  ` changes to a s
+00012620: 7461 7469 6320 6465 6669 6e69 7469 6f6e  tatic definition
+00012630: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00012640: 7468 656e 2061 6464 2074 6861 7420 6173  then add that as
+00012650: 7365 7274 696f 6e20 6865 7265 2028 616e  sertion here (an
+00012660: 6420 6163 7475 616c 6c79 2070 6173 7320  d actually pass 
+00012670: 696e 2074 6865 2074 6173 6b29 2e0a 2020  in the task)..  
+00012680: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00012690: 206e 6f74 206d 6174 682e 6973 696e 6628   not math.isinf(
+000126a0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+000126b0: 5241 5449 4f4e 290a 0a20 2020 2020 2020  RATION)..       
+000126c0: 2069 6620 6e6f 7420 7365 6c66 2e69 646c   if not self.idl
+000126d0: 655f 7461 736b 5f63 6f75 6e74 3a0a 2020  e_task_count:.  
+000126e0: 2020 2020 2020 2020 2020 2320 416c 6c20            # All 
+000126f0: 776f 726b 6572 7320 6275 7379 3f20 5461  workers busy? Ta
+00012700: 736b 2067 6574 732f 7374 6179 7320 7175  sk gets/stays qu
+00012710: 6575 6564 2e0a 2020 2020 2020 2020 2020  eued..          
+00012720: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00012730: 2020 2020 2020 2023 204a 7573 7420 7069         # Just pi
+00012740: 636b 2074 6865 206c 6561 7374 2062 7573  ck the least bus
+00012750: 7920 776f 726b 6572 2e0a 2020 2020 2020  y worker..      
+00012760: 2020 2320 4e4f 5445 3a20 7468 6973 2077    # NOTE: this w
+00012770: 696c 6c20 6c65 6164 2074 6f20 776f 7273  ill lead to wors
+00012780: 742d 6361 7365 2073 6368 6564 756c 696e  t-case schedulin
+00012790: 6720 7769 7468 2072 6567 6172 6473 2074  g with regards t
+000127a0: 6f20 636f 2d61 7373 6967 6e6d 656e 742e  o co-assignment.
+000127b0: 0a20 2020 2020 2020 2077 7320 3d20 6d69  .        ws = mi
+000127c0: 6e28 0a20 2020 2020 2020 2020 2020 2073  n(.            s
+000127d0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+000127e0: 756e 742c 0a20 2020 2020 2020 2020 2020  unt,.           
+000127f0: 206b 6579 3d6c 616d 6264 6120 7773 3a20   key=lambda ws: 
+00012800: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
+00012810: 6729 202f 2077 732e 6e74 6872 6561 6473  g) / ws.nthreads
+00012820: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00012830: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00012840: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00012850: 2020 6173 7365 7274 206e 6f74 205f 776f    assert not _wo
+00012860: 726b 6572 5f66 756c 6c28 7773 2c20 7365  rker_full(ws, se
+00012870: 6c66 2e57 4f52 4b45 525f 5341 5455 5241  lf.WORKER_SATURA
+00012880: 5449 4f4e 292c 2028 0a20 2020 2020 2020  TION), (.       
+00012890: 2020 2020 2020 2020 2077 732c 0a20 2020           ws,.   
+000128a0: 2020 2020 2020 2020 2020 2020 205f 7461               _ta
+000128b0: 736b 5f73 6c6f 7473 5f61 7661 696c 6162  sk_slots_availab
+000128c0: 6c65 2877 732c 2073 656c 662e 574f 524b  le(ws, self.WORK
+000128d0: 4552 5f53 4154 5552 4154 494f 4e29 2c0a  ER_SATURATION),.
+000128e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000128f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00012900: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
+00012910: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
+00012920: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
+00012930: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00012940: 6520 616e 6420 7773 2069 7320 6e6f 7420  e and ws is not 
+00012950: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00012960: 2020 6173 7365 7274 2073 656c 662e 776f    assert self.wo
+00012970: 726b 6572 732e 6765 7428 7773 2e61 6464  rkers.get(ws.add
+00012980: 7265 7373 2920 6973 2077 730a 2020 2020  ress) is ws.    
+00012990: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+000129a0: 7320 696e 2073 656c 662e 7275 6e6e 696e  s in self.runnin
+000129b0: 672c 2028 7773 2c20 7365 6c66 2e72 756e  g, (ws, self.run
+000129c0: 6e69 6e67 290a 0a20 2020 2020 2020 2072  ning)..        r
+000129d0: 6574 7572 6e20 7773 0a0a 2020 2020 6465  eturn ws..    de
+000129e0: 6620 6465 6369 6465 5f77 6f72 6b65 725f  f decide_worker_
+000129f0: 6e6f 6e5f 726f 6f74 6973 6828 7365 6c66  non_rootish(self
+00012a00: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+00012a10: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
+00012a20: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+00012a30: 2222 2250 6963 6b20 6120 776f 726b 6572  """Pick a worker
+00012a40: 2066 6f72 2061 2072 756e 6e61 626c 6520   for a runnable 
+00012a50: 6e6f 6e2d 726f 6f74 2074 6173 6b2c 2063  non-root task, c
+00012a60: 6f6e 7369 6465 7269 6e67 2064 6570 656e  onsidering depen
+00012a70: 6465 6e63 6965 7320 616e 640a 2020 2020  dencies and.    
+00012a80: 2020 2020 7265 7374 7269 6374 696f 6e73      restrictions
+00012a90: 2e0a 0a20 2020 2020 2020 204f 7574 206f  ...        Out o
+00012aa0: 6620 656c 6967 6962 6c65 2077 6f72 6b65  f eligible worke
+00012ab0: 7273 2068 6f6c 6469 6e67 2064 6570 656e  rs holding depen
+00012ac0: 6465 6e63 6965 7320 6f66 2060 6074 7360  dencies of ``ts`
+00012ad0: 602c 2073 656c 6563 7473 2074 6865 2077  `, selects the w
+00012ae0: 6f72 6b65 720a 2020 2020 2020 2020 7768  orker.        wh
+00012af0: 6572 652c 2063 6f6e 7369 6465 7269 6e67  ere, considering
+00012b00: 2077 6f72 6b65 7220 6261 636b 6c6f 6e67   worker backlong
+00012b10: 2061 6e64 2064 6174 612d 7472 616e 7366   and data-transf
+00012b20: 6572 2063 6f73 7473 2c20 7468 6520 7461  er costs, the ta
+00012b30: 736b 2069 730a 2020 2020 2020 2020 6573  sk is.        es
+00012b40: 7469 6d61 7465 6420 746f 2073 7461 7274  timated to start
+00012b50: 2072 756e 6e69 6e67 2074 6865 2073 6f6f   running the soo
+00012b60: 6e65 7374 2e0a 0a20 2020 2020 2020 2052  nest...        R
+00012b70: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+00012b80: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
+00012b90: 733a 2057 6f72 6b65 7253 7461 7465 207c  s: WorkerState |
+00012ba0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00012bb0: 2020 5468 6520 776f 726b 6572 2074 6f20    The worker to 
+00012bc0: 6173 7369 676e 2074 6865 2074 6173 6b20  assign the task 
+00012bd0: 746f 2e20 4966 206e 6f20 776f 726b 6572  to. If no worker
+00012be0: 7320 7361 7469 7366 7920 7468 6520 7265  s satisfy the re
+00012bf0: 7374 7269 6374 696f 6e73 206f 660a 2020  strictions of.  
+00012c00: 2020 2020 2020 2020 2020 6060 7473 6060            ``ts``
+00012c10: 206f 7220 7468 6572 6520 6172 6520 6e6f   or there are no
+00012c20: 2072 756e 6e69 6e67 2077 6f72 6b65 7273   running workers
+00012c30: 2c20 7265 7475 726e 7320 4e6f 6e65 2c20  , returns None, 
+00012c40: 696e 2077 6869 6368 2063 6173 6520 7468  in which case th
+00012c50: 6520 7461 736b 0a20 2020 2020 2020 2020  e task.         
+00012c60: 2020 2073 686f 756c 6420 6265 2074 7261     should be tra
+00012c70: 6e73 6974 696f 6e65 6420 746f 2060 606e  nsitioned to ``n
+00012c80: 6f2d 776f 726b 6572 6060 2e0a 2020 2020  o-worker``..    
+00012c90: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00012ca0: 6966 206e 6f74 2073 656c 662e 7275 6e6e  if not self.runn
+00012cb0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00012cc0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+00012cd0: 2020 2020 2020 7661 6c69 645f 776f 726b        valid_work
+00012ce0: 6572 7320 3d20 7365 6c66 2e76 616c 6964  ers = self.valid
+00012cf0: 5f77 6f72 6b65 7273 2874 7329 0a20 2020  _workers(ts).   
+00012d00: 2020 2020 2069 6620 7661 6c69 645f 776f       if valid_wo
+00012d10: 726b 6572 7320 6973 204e 6f6e 6520 616e  rkers is None an
+00012d20: 6420 6c65 6e28 7365 6c66 2e72 756e 6e69  d len(self.runni
+00012d30: 6e67 2920 3c20 6c65 6e28 7365 6c66 2e77  ng) < len(self.w
+00012d40: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
+00012d50: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00012d60: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+00012d70: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00012d80: 204e 6f6e 650a 0a20 2020 2020 2020 2020   None..         
+00012d90: 2020 2023 2049 6620 7468 6572 6520 7765     # If there we
+00012da0: 7265 206e 6f20 7265 7374 7269 6374 696f  re no restrictio
+00012db0: 6e73 2c20 6076 616c 6964 5f77 6f72 6b65  ns, `valid_worke
+00012dc0: 7273 2829 6020 6469 646e 2774 2073 7562  rs()` didn't sub
+00012dd0: 7365 7420 6279 0a20 2020 2020 2020 2020  set by.         
+00012de0: 2020 2023 2060 7275 6e6e 696e 6760 2e0a     # `running`..
+00012df0: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
+00012e00: 645f 776f 726b 6572 7320 3d20 7365 6c66  d_workers = self
+00012e10: 2e72 756e 6e69 6e67 0a0a 2020 2020 2020  .running..      
+00012e20: 2020 6966 2074 732e 6465 7065 6e64 656e    if ts.dependen
+00012e30: 6369 6573 206f 7220 7661 6c69 645f 776f  cies or valid_wo
+00012e40: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+00012e50: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00012e60: 7320 3d20 6465 6369 6465 5f77 6f72 6b65  s = decide_worke
+00012e70: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00012e80: 2020 2074 732c 0a20 2020 2020 2020 2020     ts,.         
+00012e90: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
+00012ea0: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
+00012eb0: 2020 2020 2076 616c 6964 5f77 6f72 6b65       valid_worke
+00012ec0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00012ed0: 2020 2020 7061 7274 6961 6c28 7365 6c66      partial(self
+00012ee0: 2e77 6f72 6b65 725f 6f62 6a65 6374 6976  .worker_objectiv
+00012ef0: 652c 2074 7329 2c0a 2020 2020 2020 2020  e, ts),.        
+00012f00: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00012f10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00012f20: 2320 544f 444f 2069 6620 6069 735f 726f  # TODO if `is_ro
+00012f30: 6f74 6973 6860 2077 6f75 6c64 2061 6c77  otish` would alw
+00012f40: 6179 7320 7265 7475 726e 2054 7275 6520  ays return True 
+00012f50: 666f 7220 7461 736b 7320 7769 7468 6f75  for tasks withou
+00012f60: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00012f70: 6465 7065 6e64 656e 6369 6573 2c20 7765  dependencies, we
+00012f80: 2063 6f75 6c64 2072 656d 6f76 6520 616c   could remove al
+00012f90: 6c20 7468 6973 206c 6f67 6963 2e20 5468  l this logic. Th
+00012fa0: 6520 726f 6f74 6973 6820 6173 7369 676e  e rootish assign
+00012fb0: 6d65 6e74 206c 6f67 6963 0a20 2020 2020  ment logic.     
+00012fc0: 2020 2020 2020 2023 2077 6f75 6c64 2062         # would b
+00012fd0: 6568 6176 6520 6d6f 7265 206f 7220 6c65  ehave more or le
+00012fe0: 7373 2074 6865 2073 616d 6520 6173 2074  ss the same as t
+00012ff0: 6869 732c 206d 6179 6265 2077 6974 686f  his, maybe witho
+00013000: 7574 2067 7561 7261 6e74 6565 640a 2020  ut guaranteed.  
+00013010: 2020 2020 2020 2020 2020 2320 726f 756e            # roun
+00013020: 642d 726f 6269 6e20 7468 6f75 6768 3f20  d-robin though? 
+00013030: 5468 6973 2070 6174 6820 6973 206f 6e6c  This path is onl
+00013040: 7920 7265 6163 6861 626c 6520 7768 656e  y reachable when
+00013050: 2060 7473 6020 646f 6573 6e27 7420 6861   `ts` doesn't ha
+00013060: 7665 0a20 2020 2020 2020 2020 2020 2023  ve.            #
+00013070: 2064 6570 656e 6465 6e63 6965 732c 2062   dependencies, b
+00013080: 7574 2069 7473 2067 726f 7570 2069 7320  ut its group is 
+00013090: 616c 736f 2073 6d61 6c6c 6572 2074 6861  also smaller tha
+000130a0: 6e20 7468 6520 636c 7573 7465 722e 0a0a  n the cluster...
+000130b0: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
+000130c0: 7374 7061 7468 2077 6865 6e20 7468 6572  stpath when ther
+000130d0: 6520 6172 6520 6e6f 2072 656c 6174 6564  e are no related
+000130e0: 2074 6173 6b73 206f 7220 7265 7374 7269   tasks or restri
+000130f0: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
+00013100: 2020 2077 6f72 6b65 725f 706f 6f6c 203d     worker_pool =
+00013110: 2073 656c 662e 6964 6c65 206f 7220 7365   self.idle or se
+00013120: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+00013130: 2020 2020 2020 2023 2046 4958 4d45 2069         # FIXME i
+00013140: 646c 6520 616e 6420 776f 726b 6572 7320  dle and workers 
+00013150: 6172 6520 536f 7274 6564 4469 6374 2773  are SortedDict's
+00013160: 2064 6563 6c61 7265 6420 6173 2064 6963   declared as dic
+00013170: 7473 0a20 2020 2020 2020 2020 2020 2023  ts.            #
+00013180: 2020 2020 2020 2062 6563 6175 7365 2073         because s
+00013190: 6f72 7465 6463 6f6e 7461 696e 6572 7320  ortedcontainers 
+000131a0: 6973 206e 6f74 2061 6e6e 6f74 6174 6564  is not annotated
+000131b0: 0a20 2020 2020 2020 2020 2020 2077 705f  .            wp_
+000131c0: 7661 6c73 203d 2063 6173 7428 2253 6571  vals = cast("Seq
+000131d0: 7565 6e63 655b 576f 726b 6572 5374 6174  uence[WorkerStat
+000131e0: 655d 222c 2077 6f72 6b65 725f 706f 6f6c  e]", worker_pool
+000131f0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+00013200: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
+00013210: 203d 206c 656e 2877 705f 7661 6c73 290a   = len(wp_vals).
+00013220: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00013230: 5f77 6f72 6b65 7273 203c 2032 303a 2020  _workers < 20:  
+00013240: 2320 736d 6172 7420 6275 7420 6c69 6e65  # smart but line
+00013250: 6172 2069 6e20 736d 616c 6c20 6361 7365  ar in small case
+00013260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013270: 2077 7320 3d20 6d69 6e28 7770 5f76 616c   ws = min(wp_val
+00013280: 732c 206b 6579 3d6f 7065 7261 746f 722e  s, key=operator.
+00013290: 6174 7472 6765 7474 6572 2822 6f63 6375  attrgetter("occu
+000132a0: 7061 6e63 7922 2929 0a20 2020 2020 2020  pancy")).       
+000132b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000132c0: 7773 0a20 2020 2020 2020 2020 2020 2020  ws.             
+000132d0: 2020 2069 6620 7773 2e6f 6363 7570 616e     if ws.occupan
+000132e0: 6379 203d 3d20 303a 0a20 2020 2020 2020  cy == 0:.       
+000132f0: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+00013300: 7065 6369 616c 2063 6173 6520 746f 2075  pecial case to u
+00013310: 7365 2072 6f75 6e64 2d72 6f62 696e 3b20  se round-robin; 
+00013320: 6c69 6e65 6172 2073 6561 7263 680a 2020  linear search.  
+00013330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013340: 2020 2320 666f 7220 6e65 7874 2077 6f72    # for next wor
+00013350: 6b65 7220 7769 7468 207a 6572 6f20 6f63  ker with zero oc
+00013360: 6375 7061 6e63 7920 286f 7220 6a75 7374  cupancy (or just
+00013370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013380: 2020 2020 2023 206c 616e 6420 6261 636b       # land back
+00013390: 2077 6865 7265 2077 6520 7374 6172 7465   where we starte
+000133a0: 6429 2e0a 2020 2020 2020 2020 2020 2020  d)..            
+000133b0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+000133c0: 7365 6c66 2e6e 5f74 6173 6b73 2025 206e  self.n_tasks % n
+000133d0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+000133e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000133f0: 2069 2069 6e20 7261 6e67 6528 6e5f 776f   i in range(n_wo
+00013400: 726b 6572 7329 3a0a 2020 2020 2020 2020  rkers):.        
+00013410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013420: 7770 5f69 203d 2077 705f 7661 6c73 5b28  wp_i = wp_vals[(
+00013430: 6920 2b20 7374 6172 7429 2025 206e 5f77  i + start) % n_w
+00013440: 6f72 6b65 7273 5d0a 2020 2020 2020 2020  orkers].        
+00013450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013460: 6966 2077 705f 692e 6f63 6375 7061 6e63  if wp_i.occupanc
+00013470: 7920 3d3d 2030 3a0a 2020 2020 2020 2020  y == 0:.        
+00013480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013490: 2020 2020 7773 203d 2077 705f 690a 2020      ws = wp_i.  
+000134a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134b0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+000134c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000134d0: 3a20 2023 2064 756d 6220 6275 7420 6661  :  # dumb but fa
+000134e0: 7374 2069 6e20 6c61 7267 6520 6361 7365  st in large case
+000134f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013500: 2077 7320 3d20 7770 5f76 616c 735b 7365   ws = wp_vals[se
+00013510: 6c66 2e6e 5f74 6173 6b73 2025 206e 5f77  lf.n_tasks % n_w
+00013520: 6f72 6b65 7273 5d0a 0a20 2020 2020 2020  orkers]..       
+00013530: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00013540: 6520 616e 6420 7773 2069 7320 6e6f 7420  e and ws is not 
+00013550: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00013560: 2020 6173 7365 7274 2073 656c 662e 776f    assert self.wo
+00013570: 726b 6572 732e 6765 7428 7773 2e61 6464  rkers.get(ws.add
+00013580: 7265 7373 2920 6973 2077 730a 2020 2020  ress) is ws.    
+00013590: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+000135a0: 7320 696e 2073 656c 662e 7275 6e6e 696e  s in self.runnin
+000135b0: 672c 2028 7773 2c20 7365 6c66 2e72 756e  g, (ws, self.run
+000135c0: 6e69 6e67 290a 0a20 2020 2020 2020 2072  ning)..        r
+000135d0: 6574 7572 6e20 7773 0a0a 2020 2020 6465  eturn ws..    de
+000135e0: 6620 7472 616e 7369 7469 6f6e 5f77 6169  f transition_wai
+000135f0: 7469 6e67 5f70 726f 6365 7373 696e 6728  ting_processing(
+00013600: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00013610: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00013620: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+00013630: 2020 2020 2020 2022 2222 506f 7373 6962         """Possib
+00013640: 6c79 2073 6368 6564 756c 6520 6120 7265  ly schedule a re
+00013650: 6164 7920 7461 736b 2e20 5468 6973 2069  ady task. This i
+00013660: 7320 7468 6520 7072 696d 6172 7920 6469  s the primary di
+00013670: 7370 6174 6368 2066 6f72 2072 6561 6479  spatch for ready
+00013680: 2074 6173 6b73 2e0a 0a20 2020 2020 2020   tasks...       
+00013690: 2049 6620 7468 6572 6527 7320 6e6f 2061   If there's no a
+000136a0: 7070 726f 7072 6961 7465 2077 6f72 6b65  ppropriate worke
+000136b0: 7220 666f 7220 7468 6520 7461 736b 2028  r for the task (
+000136c0: 6275 7420 7468 6520 7461 736b 2069 7320  but the task is 
+000136d0: 6f74 6865 7277 6973 650a 2020 2020 2020  otherwise.      
+000136e0: 2020 7275 6e6e 6162 6c65 292c 2069 7420    runnable), it 
+000136f0: 7769 6c6c 2062 6520 7265 636f 6d6d 656e  will be recommen
+00013700: 6465 6420 746f 2060 606e 6f2d 776f 726b  ded to ``no-work
+00013710: 6572 6060 206f 7220 6060 7175 6575 6564  er`` or ``queued
+00013720: 6060 2e0a 2020 2020 2020 2020 2222 220a  ``..        """.
+00013730: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00013740: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
+00013750: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
+00013760: 5f72 6f6f 7469 7368 2874 7329 3a0a 2020  _rootish(ts):.  
+00013770: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00013780: 3a20 6861 7669 6e67 2074 776f 2072 6f6f  : having two roo
+00013790: 742d 6973 6820 6d65 7468 6f64 7320 6973  t-ish methods is
+000137a0: 2074 656d 706f 7261 7279 2e20 5768 656e   temporary. When
+000137b0: 2074 6865 2066 6561 7475 7265 2066 6c61   the feature fla
+000137c0: 6720 6973 0a20 2020 2020 2020 2020 2020  g is.           
+000137d0: 2023 2072 656d 6f76 6564 2c20 7468 6572   # removed, ther
+000137e0: 6520 7368 6f75 6c64 206f 6e6c 7920 6265  e should only be
+000137f0: 206f 6e65 2c20 7768 6963 6820 636f 6d62   one, which comb
+00013800: 696e 6573 2063 6f2d 6173 7369 676e 6d65  ines co-assignme
+00013810: 6e74 2061 6e64 0a20 2020 2020 2020 2020  nt and.         
+00013820: 2020 2023 2071 7565 7569 6e67 2e20 4576     # queuing. Ev
+00013830: 656e 7475 616c 6c79 2c20 7370 6563 6961  entually, specia
+00013840: 6c2d 6361 7369 6e67 2072 6f6f 7420 7461  l-casing root ta
+00013850: 736b 7320 6d69 6768 7420 6265 2072 656d  sks might be rem
+00013860: 6f76 6564 2065 6e74 6972 656c 792c 0a20  oved entirely,. 
+00013870: 2020 2020 2020 2020 2020 2023 2077 6974             # wit
+00013880: 6820 6265 7474 6572 2068 6575 7269 7374  h better heurist
+00013890: 6963 732e 0a20 2020 2020 2020 2020 2020  ics..           
+000138a0: 2069 6620 6d61 7468 2e69 7369 6e66 2873   if math.isinf(s
+000138b0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
+000138c0: 4154 494f 4e29 3a0a 2020 2020 2020 2020  ATION):.        
+000138d0: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
+000138e0: 7773 203a 3d20 7365 6c66 2e64 6563 6964  ws := self.decid
+000138f0: 655f 776f 726b 6572 5f72 6f6f 7469 7368  e_worker_rootish
+00013900: 5f71 7565 7569 6e67 5f64 6973 6162 6c65  _queuing_disable
+00013910: 6428 7473 2929 3a0a 2020 2020 2020 2020  d(ts)):.        
+00013920: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00013930: 726e 207b 7473 2e6b 6579 3a20 226e 6f2d  rn {ts.key: "no-
+00013940: 776f 726b 6572 227d 2c20 7b7d 2c20 7b7d  worker"}, {}, {}
+00013950: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00013960: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00013970: 2020 2069 6620 6e6f 7420 2877 7320 3a3d     if not (ws :=
+00013980: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
+00013990: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
+000139a0: 696e 675f 656e 6162 6c65 6428 2929 3a0a  ing_enabled()):.
+000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139c0: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
+000139d0: 6579 3a20 2271 7565 7565 6422 7d2c 207b  ey: "queued"}, {
+000139e0: 7d2c 207b 7d0a 2020 2020 2020 2020 656c  }, {}.        el
+000139f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00013a00: 6966 206e 6f74 2028 7773 203a 3d20 7365  if not (ws := se
+00013a10: 6c66 2e64 6563 6964 655f 776f 726b 6572  lf.decide_worker
+00013a20: 5f6e 6f6e 5f72 6f6f 7469 7368 2874 7329  _non_rootish(ts)
+00013a30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00013a40: 2020 2072 6574 7572 6e20 7b74 732e 6b65     return {ts.ke
+00013a50: 793a 2022 6e6f 2d77 6f72 6b65 7222 7d2c  y: "no-worker"},
+00013a60: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
+00013a70: 2077 6f72 6b65 725f 6d73 6773 203d 2073   worker_msgs = s
+00013a80: 656c 662e 5f61 6464 5f74 6f5f 7072 6f63  elf._add_to_proc
+00013a90: 6573 7369 6e67 2874 732c 2077 7329 0a20  essing(ts, ws). 
+00013aa0: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+00013ab0: 2c20 7b7d 2c20 776f 726b 6572 5f6d 7367  , {}, worker_msg
+00013ac0: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
+00013ad0: 6974 696f 6e5f 7761 6974 696e 675f 6d65  ition_waiting_me
+00013ae0: 6d6f 7279 280a 2020 2020 2020 2020 7365  mory(.        se
+00013af0: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
+00013b00: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+00013b10: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
+00013b20: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00013b30: 2020 206e 6279 7465 733a 2069 6e74 207c     nbytes: int |
+00013b40: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00013b50: 2020 2020 2020 7479 7065 3a20 6279 7465        type: byte
+00013b60: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
+00013b70: 0a20 2020 2020 2020 2074 7970 656e 616d  .        typenam
+00013b80: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+00013b90: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+00013ba0: 726b 6572 3a20 7374 722c 0a20 2020 2020  rker: str,.     
+00013bb0: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+00013bc0: 2c0a 2020 2020 2920 2d3e 2052 6563 734d  ,.    ) -> RecsM
+00013bd0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
+00013be0: 5468 6973 2074 7261 6e73 6974 696f 6e20  This transition 
+00013bf0: 6578 636c 7573 6976 656c 7920 6861 7070  exclusively happ
+00013c00: 656e 7320 696e 2061 2072 6163 6520 636f  ens in a race co
+00013c10: 6e64 6974 696f 6e20 7768 6572 6520 7468  ndition where th
+00013c20: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
+00013c30: 2020 2020 6265 6c69 6576 6573 2074 6861      believes tha
+00013c40: 7420 7468 6520 6f6e 6c79 2063 6f70 7920  t the only copy 
+00013c50: 6f66 2061 2064 6570 656e 6465 6e63 7920  of a dependency 
+00013c60: 7461 736b 2068 6173 206a 7573 7420 6265  task has just be
+00013c70: 656e 206c 6f73 742c 2073 6f20 6974 0a20  en lost, so it. 
+00013c80: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
+00013c90: 6e73 2061 6c6c 2064 6570 656e 6465 6e74  ns all dependent
+00013ca0: 7320 6261 636b 2074 6f20 7761 6974 696e  s back to waitin
+00013cb0: 672c 2062 7574 2061 6374 7561 6c6c 7920  g, but actually 
+00013cc0: 6120 7265 706c 6963 6120 6861 7320 616c  a replica has al
+00013cd0: 7265 6164 790a 2020 2020 2020 2020 6265  ready.        be
+00013ce0: 656e 2061 6371 7569 7265 6420 6279 2061  en acquired by a
+00013cf0: 2077 6f72 6b65 7220 636f 6d70 7574 696e   worker computin
+00013d00: 6720 7468 6520 6465 7065 6e64 656e 6379  g the dependency
+00013d10: 202d 2074 6865 2073 6368 6564 756c 6572   - the scheduler
+00013d20: 206a 7573 7420 646f 6573 6e27 740a 2020   just doesn't.  
+00013d30: 2020 2020 2020 6b6e 6f77 2079 6574 202d        know yet -
+00013d40: 2061 6e64 2074 6865 2065 7865 6375 7469   and the executi
+00013d50: 6f6e 2066 696e 6973 6865 7320 6265 666f  on finishes befo
+00013d60: 7265 2074 6865 2063 616e 6365 6c6c 6174  re the cancellat
+00013d70: 696f 6e20 6d65 7373 6167 6520 6672 6f6d  ion message from
+00013d80: 2074 6865 0a20 2020 2020 2020 2073 6368   the.        sch
+00013d90: 6564 756c 6572 2068 6173 2061 2063 6861  eduler has a cha
+00013da0: 6e63 6520 746f 2072 6561 6368 2074 6865  nce to reach the
+00013db0: 2077 6f72 6b65 722e 2053 686f 7274 6c79   worker. Shortly
+00013dc0: 2c20 7468 6520 6361 6e63 656c 6c61 7469  , the cancellati
+00013dd0: 6f6e 2072 6571 7565 7374 0a20 2020 2020  on request.     
+00013de0: 2020 2077 696c 6c20 7265 6163 6820 7468     will reach th
+00013df0: 6520 776f 726b 6572 2c20 7468 7573 2064  e worker, thus d
+00013e00: 656c 6574 696e 6720 7468 6520 6461 7461  eleting the data
+00013e10: 2066 726f 6d20 6d65 6d6f 7279 2e0a 2020   from memory..  
+00013e20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00013e30: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+00013e40: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
+00013e50: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+00013e60: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00013e70: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00013e80: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+00013e90: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00013ea0: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
+00013eb0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00013ec0: 2e73 7461 7465 203d 3d20 2277 6169 7469  .state == "waiti
+00013ed0: 6e67 220a 0a20 2020 2020 2020 2072 6574  ng"..        ret
+00013ee0: 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a  urn {}, {}, {}..
+00013ef0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+00013f00: 6f6e 5f70 726f 6365 7373 696e 675f 6d65  on_processing_me
+00013f10: 6d6f 7279 280a 2020 2020 2020 2020 7365  mory(.        se
+00013f20: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
+00013f30: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+00013f40: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
+00013f50: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00013f60: 2020 206e 6279 7465 733a 2069 6e74 207c     nbytes: int |
+00013f70: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00013f80: 2020 2020 2020 7479 7065 3a20 6279 7465        type: byte
+00013f90: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
+00013fa0: 0a20 2020 2020 2020 2074 7970 656e 616d  .        typenam
+00013fb0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+00013fc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+00013fd0: 726b 6572 3a20 7374 722c 0a20 2020 2020  rker: str,.     
+00013fe0: 2020 2073 7461 7274 7374 6f70 733a 206c     startstops: l
+00013ff0: 6973 745b 6469 6374 5d20 7c20 4e6f 6e65  ist[dict] | None
+00014000: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00014010: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00014020: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
+00014030: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00014040: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00014050: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00014060: 776f 726b 6572 0a20 2020 2020 2020 2061  worker.        a
+00014070: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00014080: 2877 6f72 6b65 722c 2073 7472 290a 0a20  (worker, str).. 
+00014090: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+000140a0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+000140b0: 2020 2020 2061 7373 6572 7420 7473 2e70       assert ts.p
+000140c0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+000140d0: 2020 2020 2020 2020 2077 7373 203d 2074           wss = t
+000140e0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+000140f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00014100: 7274 2077 7373 0a20 2020 2020 2020 2020  rt wss.         
+00014110: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00014120: 7773 732e 7072 6f63 6573 7369 6e67 0a20  wss.processing. 
+00014130: 2020 2020 2020 2020 2020 2064 656c 2077             del w
+00014140: 7373 0a20 2020 2020 2020 2020 2020 2061  ss.            a
+00014150: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+00014160: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
+00014170: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00014180: 732e 7768 6f5f 6861 732c 2028 7473 2c20  s.who_has, (ts, 
+00014190: 7473 2e77 686f 5f68 6173 290a 2020 2020  ts.who_has).    
+000141a0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000141b0: 6f74 2074 732e 6578 6365 7074 696f 6e5f  ot ts.exception_
+000141c0: 626c 616d 650a 2020 2020 2020 2020 2020  blame.          
+000141d0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+000141e0: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
+000141f0: 220a 0a20 2020 2020 2020 2077 7320 3d20  "..        ws = 
+00014200: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
+00014210: 2877 6f72 6b65 7229 0a20 2020 2020 2020  (worker).       
+00014220: 2069 6620 7773 2069 7320 4e6f 6e65 3a0a   if ws is None:.
+00014230: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00014240: 726e 207b 6b65 793a 2022 7265 6c65 6173  rn {key: "releas
+00014250: 6564 227d 2c20 7b7d 2c20 7b7d 0a0a 2020  ed"}, {}, {}..  
+00014260: 2020 2020 2020 6966 2077 7320 213d 2074        if ws != t
+00014270: 732e 7072 6f63 6573 7369 6e67 5f6f 6e3a  s.processing_on:
+00014280: 2020 2320 7072 6167 6d61 3a20 6e6f 636f    # pragma: noco
+00014290: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
+000142a0: 6173 7365 7274 2074 732e 7072 6f63 6573  assert ts.proces
+000142b0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+000142c0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+000142d0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+000142e0: 2020 2020 2020 2020 6622 5461 736b 207b          f"Task {
+000142f0: 7473 2e6b 6579 2172 7d20 7472 616e 7369  ts.key!r} transi
+00014300: 7469 6f6e 6564 2066 726f 6d20 7072 6f63  tioned from proc
+00014310: 6573 7369 6e67 2074 6f20 6d65 6d6f 7279  essing to memory
+00014320: 206f 6e20 776f 726b 6572 2022 0a20 2020   on worker ".   
+00014330: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00014340: 7773 7d2c 2077 6869 6c65 2069 7420 7761  ws}, while it wa
+00014350: 7320 6578 7065 6374 6564 2066 726f 6d20  s expected from 
+00014360: 7b74 732e 7072 6f63 6573 7369 6e67 5f6f  {ts.processing_o
+00014370: 6e7d 2e20 5468 6973 2073 686f 756c 6420  n}. This should 
+00014380: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00014390: 2020 6622 6265 2069 6d70 6f73 7369 626c    f"be impossibl
+000143a0: 652e 207b 7374 696d 756c 7573 5f69 643d  e. {stimulus_id=
+000143b0: 7d2c 2073 746f 7279 3d7b 7365 6c66 2e73  }, story={self.s
+000143c0: 746f 7279 2874 7329 7d22 0a20 2020 2020  tory(ts)}".     
+000143d0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000143e0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+000143f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00014400: 2020 2020 2020 2020 2320 5570 6461 7465          # Update
+00014410: 2054 696d 696e 6720 496e 666f 726d 6174   Timing Informat
+00014420: 696f 6e20 230a 2020 2020 2020 2020 2323  ion #.        ##
+00014430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014440: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+00014450: 2020 2020 6966 2073 7461 7274 7374 6f70      if startstop
+00014460: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+00014470: 6f72 2073 7461 7274 7374 6f70 2069 6e20  or startstop in 
+00014480: 7374 6172 7473 746f 7073 3a0a 2020 2020  startstops:.    
+00014490: 2020 2020 2020 2020 2020 2020 7473 2e67              ts.g
+000144a0: 726f 7570 2e61 6464 5f64 7572 6174 696f  roup.add_duratio
+000144b0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+000144c0: 2020 2020 2020 2073 746f 703d 7374 6172         stop=star
+000144d0: 7473 746f 705b 2273 746f 7022 5d2c 0a20  tstop["stop"],. 
+000144e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144f0: 2020 2073 7461 7274 3d73 7461 7274 7374     start=startst
+00014500: 6f70 5b22 7374 6172 7422 5d2c 0a20 2020  op["start"],.   
+00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014520: 2061 6374 696f 6e3d 7374 6172 7473 746f   action=startsto
+00014530: 705b 2261 6374 696f 6e22 5d2c 0a20 2020  p["action"],.   
+00014540: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00014550: 2020 2020 2020 2020 7320 3d20 7365 6c66          s = self
+00014560: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
+00014570: 6e73 2e70 6f70 2874 732e 7072 6566 6978  ns.pop(ts.prefix
+00014580: 2e6e 616d 652c 2073 6574 2829 290a 2020  .name, set()).  
+00014590: 2020 2020 2020 7374 6561 6c20 3d20 7365        steal = se
+000145a0: 6c66 2e65 7874 656e 7369 6f6e 732e 6765  lf.extensions.ge
+000145b0: 7428 2273 7465 616c 696e 6722 290a 2020  t("stealing").  
+000145c0: 2020 2020 2020 6966 2073 7465 616c 3a0a        if steal:.
+000145d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000145e0: 7474 7320 696e 2073 3a0a 2020 2020 2020  tts in s:.      
+000145f0: 2020 2020 2020 2020 2020 6966 2074 7473            if tts
+00014600: 2e70 726f 6365 7373 696e 675f 6f6e 3a0a  .processing_on:.
+00014610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014620: 2020 2020 7374 6561 6c2e 7265 6361 6c63      steal.recalc
+00014630: 756c 6174 655f 636f 7374 2874 7473 290a  ulate_cost(tts).
+00014640: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+00014650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014660: 2323 2323 230a 2020 2020 2020 2020 2320  #####.        # 
+00014670: 5570 6461 7465 2053 7461 7465 2049 6e66  Update State Inf
+00014680: 6f72 6d61 7469 6f6e 2023 0a20 2020 2020  ormation #.     
+00014690: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+000146a0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+000146b0: 2020 2020 2020 2020 6966 206e 6279 7465          if nbyte
+000146c0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+000146d0: 2020 2020 2020 2020 2020 2074 732e 7365             ts.se
+000146e0: 745f 6e62 7974 6573 286e 6279 7465 7329  t_nbytes(nbytes)
+000146f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+00014700: 6578 6974 5f70 726f 6365 7373 696e 675f  exit_processing_
+00014710: 636f 6d6d 6f6e 2874 7329 0a0a 2020 2020  common(ts)..    
+00014720: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00014730: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+00014740: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+00014750: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
+00014760: 2020 2020 2020 7365 6c66 2e5f 6164 645f        self._add_
+00014770: 746f 5f6d 656d 6f72 7928 0a20 2020 2020  to_memory(.     
+00014780: 2020 2020 2020 2074 732c 2077 732c 2072         ts, ws, r
+00014790: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+000147a0: 636c 6965 6e74 5f6d 7367 732c 2074 7970  client_msgs, typ
+000147b0: 653d 7479 7065 2c20 7479 7065 6e61 6d65  e=type, typename
+000147c0: 3d74 7970 656e 616d 650a 2020 2020 2020  =typename.      
+000147d0: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+000147e0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+000147f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014800: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+00014810: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
+00014820: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00014830: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
+00014840: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+00014850: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+00014860: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
+00014870: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00014880: 5f6d 656d 6f72 795f 7265 6c65 6173 6564  _memory_released
+00014890: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+000148a0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
+000148b0: 7573 5f69 643a 2073 7472 2c20 2a2c 2073  us_id: str, *, s
+000148c0: 6166 653a 2062 6f6f 6c20 3d20 4661 6c73  afe: bool = Fals
+000148d0: 650a 2020 2020 2920 2d3e 2052 6563 734d  e.    ) -> RecsM
+000148e0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+000148f0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00014900: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00014910: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00014920: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00014930: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
+00014940: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00014950: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00014960: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+00014970: 2020 2020 2020 6966 2073 6166 653a 0a20        if safe:. 
+00014980: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00014990: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+000149a0: 7465 7273 0a0a 2020 2020 2020 2020 6966  ters..        if
+000149b0: 2074 732e 6163 746f 723a 0a20 2020 2020   ts.actor:.     
+000149c0: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+000149d0: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
+000149e0: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
+000149f0: 6163 746f 7273 2e64 6973 6361 7264 2874  actors.discard(t
+00014a00: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
+00014a10: 6620 7473 2e77 686f 5f77 616e 7473 3a0a  f ts.who_wants:.
+00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a30: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+00014a40: 6d65 203d 2074 730a 2020 2020 2020 2020  me = ts.        
+00014a50: 2020 2020 2020 2020 7473 2e65 7863 6570          ts.excep
+00014a60: 7469 6f6e 203d 2053 6572 6961 6c69 7a65  tion = Serialize
+00014a70: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00014a80: 2020 2020 2020 202a 7365 7269 616c 697a         *serializ
+00014a90: 6528 5661 6c75 6545 7272 6f72 2822 576f  e(ValueError("Wo
+00014aa0: 726b 6572 2068 6f6c 6469 6e67 2041 6374  rker holding Act
+00014ab0: 6f72 2077 6173 206c 6f73 7422 2929 0a20  or was lost")). 
+00014ac0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00014ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ae0: 2072 6574 7572 6e20 7b74 732e 6b65 793a   return {ts.key:
+00014af0: 2022 6572 7265 6422 7d2c 207b 7d2c 207b   "erred"}, {}, {
+00014b00: 7d20 2023 2064 6f6e 2774 2074 7279 2074  }  # don't try t
+00014b10: 6f20 7265 6372 6561 7465 0a0a 2020 2020  o recreate..    
+00014b20: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00014b30: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+00014b40: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+00014b50: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
+00014b60: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00014b70: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
+00014b80: 2020 2020 2020 2320 5858 5820 6661 6374        # XXX fact
+00014b90: 6f72 2074 6869 7320 6f75 743f 0a20 2020  or this out?.   
+00014ba0: 2020 2020 2077 6f72 6b65 725f 6d73 6720       worker_msg 
+00014bb0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00014bc0: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
+00014bd0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00014be0: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
+00014bf0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+00014c00: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+00014c10: 735f 6964 2c0a 2020 2020 2020 2020 7d0a  s_id,.        }.
+00014c20: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+00014c30: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+00014c40: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00014c50: 5f6d 7367 735b 7773 2e61 6464 7265 7373  _msgs[ws.address
+00014c60: 5d20 3d20 5b77 6f72 6b65 725f 6d73 675d  ] = [worker_msg]
+00014c70: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00014c80: 6d6f 7665 5f61 6c6c 5f72 6570 6c69 6361  move_all_replica
+00014c90: 7328 7473 290a 0a20 2020 2020 2020 2074  s(ts)..        t
+00014ca0: 732e 7374 6174 6520 3d20 2272 656c 6561  s.state = "relea
+00014cb0: 7365 6422 0a0a 2020 2020 2020 2020 7265  sed"..        re
+00014cc0: 706f 7274 5f6d 7367 203d 207b 226f 7022  port_msg = {"op"
+00014cd0: 3a20 226c 6f73 742d 6461 7461 222c 2022  : "lost-data", "
+00014ce0: 6b65 7922 3a20 6b65 797d 0a20 2020 2020  key": key}.     
+00014cf0: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
+00014d00: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+00014d10: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+00014d20: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
+00014d30: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
+00014d40: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00014d50: 2074 732e 7275 6e5f 7370 6563 3a20 2023   ts.run_spec:  #
+00014d60: 2070 7572 6520 6461 7461 0a20 2020 2020   pure data.     
+00014d70: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00014d80: 6174 696f 6e73 5b6b 6579 5d20 3d20 2266  ations[key] = "f
+00014d90: 6f72 676f 7474 656e 220a 2020 2020 2020  orgotten".      
+00014da0: 2020 656c 6966 2074 732e 6861 735f 6c6f    elif ts.has_lo
+00014db0: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
+00014dc0: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+00014dd0: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
+00014de0: 5d20 3d20 2266 6f72 676f 7474 656e 220a  ] = "forgotten".
+00014df0: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
+00014e00: 7768 6f5f 7761 6e74 7320 6f72 2074 732e  who_wants or ts.
+00014e10: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
+00014e20: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00014e30: 696f 6e73 5b6b 6579 5d20 3d20 2277 6169  ions[key] = "wai
+00014e40: 7469 6e67 220a 0a20 2020 2020 2020 2066  ting"..        f
+00014e50: 6f72 2064 7473 2069 6e20 7473 2e77 6169  or dts in ts.wai
+00014e60: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
+00014e70: 2020 6966 2064 7473 2e73 7461 7465 2069    if dts.state i
+00014e80: 6e20 2822 6e6f 2d77 6f72 6b65 7222 2c20  n ("no-worker", 
+00014e90: 2270 726f 6365 7373 696e 6722 293a 0a20  "processing"):. 
+00014ea0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00014eb0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+00014ec0: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
+00014ed0: 6e67 220a 2020 2020 2020 2020 2020 2020  ng".            
+00014ee0: 656c 6966 2064 7473 2e73 7461 7465 203d  elif dts.state =
+00014ef0: 3d20 2277 6169 7469 6e67 223a 0a20 2020  = "waiting":.   
+00014f00: 2020 2020 2020 2020 2020 2020 2064 7473               dts
+00014f10: 2e77 6169 7469 6e67 5f6f 6e2e 6164 6428  .waiting_on.add(
+00014f20: 7473 290a 0a20 2020 2020 2020 2069 6620  ts)..        if 
+00014f30: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00014f40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014f50: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+00014f60: 5f6f 6e0a 0a20 2020 2020 2020 2072 6574  _on..        ret
+00014f70: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+00014f80: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+00014f90: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
+00014fa0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+00014fb0: 6e5f 7265 6c65 6173 6564 5f65 7272 6564  n_released_erred
+00014fc0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+00014fd0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00014fe0: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00014ff0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00015000: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+00015010: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00015020: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00015030: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00015040: 7367 733a 204d 7367 7320 3d20 7b7d 0a0a  sgs: Msgs = {}..
+00015050: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00015060: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00015070: 2020 2020 2020 7769 7468 206c 6f67 5f65        with log_e
+00015080: 7272 6f72 7328 7064 623d 4c4f 475f 5044  rrors(pdb=LOG_PD
+00015090: 4229 3a0a 2020 2020 2020 2020 2020 2020  B):.            
+000150a0: 2020 2020 6173 7365 7274 2074 732e 6578      assert ts.ex
+000150b0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
+000150c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+000150d0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+000150e0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+000150f0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00015100: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00015110: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00015120: 6572 7420 6e6f 7420 7473 2e77 6169 7465  ert not ts.waite
+00015130: 7273 0a0a 2020 2020 2020 2020 6661 696c  rs..        fail
+00015140: 696e 675f 7473 203d 2074 732e 6578 6365  ing_ts = ts.exce
+00015150: 7074 696f 6e5f 626c 616d 650a 2020 2020  ption_blame.    
+00015160: 2020 2020 6173 7365 7274 2066 6169 6c69      assert faili
+00015170: 6e67 5f74 730a 0a20 2020 2020 2020 2066  ng_ts..        f
+00015180: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+00015190: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
+000151a0: 2020 2020 2064 7473 2e65 7863 6570 7469       dts.excepti
+000151b0: 6f6e 5f62 6c61 6d65 203d 2066 6169 6c69  on_blame = faili
+000151c0: 6e67 5f74 730a 2020 2020 2020 2020 2020  ng_ts.          
+000151d0: 2020 6966 206e 6f74 2064 7473 2e77 686f    if not dts.who
+000151e0: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+000151f0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00015200: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
+00015210: 2022 6572 7265 6422 0a0a 2020 2020 2020   "erred"..      
+00015220: 2020 7265 706f 7274 5f6d 7367 203d 207b    report_msg = {
+00015230: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
+00015240: 223a 2022 7461 736b 2d65 7272 6564 222c  ": "task-erred",
+00015250: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
+00015260: 7922 3a20 6b65 792c 0a20 2020 2020 2020  y": key,.       
+00015270: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
+00015280: 3a20 6661 696c 696e 675f 7473 2e65 7863  : failing_ts.exc
+00015290: 6570 7469 6f6e 2c0a 2020 2020 2020 2020  eption,.        
+000152a0: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
+000152b0: 2066 6169 6c69 6e67 5f74 732e 7472 6163   failing_ts.trac
+000152c0: 6562 6163 6b2c 0a20 2020 2020 2020 207d  eback,.        }
+000152d0: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
+000152e0: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
+000152f0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00015300: 656e 745f 6d73 6773 5b63 732e 636c 6965  ent_msgs[cs.clie
+00015310: 6e74 5f6b 6579 5d20 3d20 5b72 6570 6f72  nt_key] = [repor
+00015320: 745f 6d73 675d 0a0a 2020 2020 2020 2020  t_msg]..        
+00015330: 7473 2e73 7461 7465 203d 2022 6572 7265  ts.state = "erre
+00015340: 6422 0a0a 2020 2020 2020 2020 2320 544f  d"..        # TO
+00015350: 444f 3a20 7761 6974 696e 6720 6461 7461  DO: waiting data
+00015360: 3f0a 2020 2020 2020 2020 7265 7475 726e  ?.        return
+00015370: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015380: 2c20 636c 6965 6e74 5f6d 7367 732c 207b  , client_msgs, {
+00015390: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
+000153a0: 6974 696f 6e5f 6572 7265 645f 7265 6c65  ition_erred_rele
+000153b0: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
+000153c0: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+000153d0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+000153e0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+000153f0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00015400: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00015410: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00015420: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
+00015430: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
+00015440: 7b7d 0a20 2020 2020 2020 2077 6f72 6b65  {}.        worke
+00015450: 725f 6d73 6773 3a20 4d73 6773 203d 207b  r_msgs: Msgs = {
+00015460: 7d0a 0a20 2020 2020 2020 2069 6620 7365  }..        if se
+00015470: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00015480: 2020 2020 2020 2020 2077 6974 6820 6c6f           with lo
+00015490: 675f 6572 726f 7273 2870 6462 3d4c 4f47  g_errors(pdb=LOG
+000154a0: 5f50 4442 293a 0a20 2020 2020 2020 2020  _PDB):.         
+000154b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000154c0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+000154d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000154e0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+000154f0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+00015500: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00015510: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015530: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+00015540: 6974 6572 730a 0a20 2020 2020 2020 2074  iters..        t
+00015550: 732e 6578 6365 7074 696f 6e20 3d20 4e6f  s.exception = No
+00015560: 6e65 0a20 2020 2020 2020 2074 732e 6578  ne.        ts.ex
+00015570: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
+00015580: 4e6f 6e65 0a20 2020 2020 2020 2074 732e  None.        ts.
+00015590: 7472 6163 6562 6163 6b20 3d20 4e6f 6e65  traceback = None
+000155a0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+000155b0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+000155c0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+000155d0: 6966 2064 7473 2e73 7461 7465 203d 3d20  if dts.state == 
+000155e0: 2265 7272 6564 223a 0a20 2020 2020 2020  "erred":.       
+000155f0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+00015600: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
+00015610: 5d20 3d20 2277 6169 7469 6e67 220a 0a20  ] = "waiting".. 
+00015620: 2020 2020 2020 2077 5f6d 7367 203d 207b         w_msg = {
+00015630: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
+00015640: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
+00015650: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+00015660: 7322 3a20 5b6b 6579 5d2c 0a20 2020 2020  s": [key],.     
+00015670: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+00015680: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+00015690: 642c 0a20 2020 2020 2020 207d 0a20 2020  d,.        }.   
+000156a0: 2020 2020 2066 6f72 2077 735f 6164 6472       for ws_addr
+000156b0: 2069 6e20 7473 2e65 7272 6564 5f6f 6e3a   in ts.erred_on:
+000156c0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+000156d0: 6b65 725f 6d73 6773 5b77 735f 6164 6472  ker_msgs[ws_addr
+000156e0: 5d20 3d20 5b77 5f6d 7367 5d0a 2020 2020  ] = [w_msg].    
+000156f0: 2020 2020 7473 2e65 7272 6564 5f6f 6e2e      ts.erred_on.
+00015700: 636c 6561 7228 290a 0a20 2020 2020 2020  clear()..       
+00015710: 2072 6570 6f72 745f 6d73 6720 3d20 7b22   report_msg = {"
+00015720: 6f70 223a 2022 7461 736b 2d72 6574 7269  op": "task-retri
+00015730: 6564 222c 2022 6b65 7922 3a20 6b65 797d  ed", "key": key}
+00015740: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
+00015750: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
+00015760: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00015770: 656e 745f 6d73 6773 5b63 732e 636c 6965  ent_msgs[cs.clie
+00015780: 6e74 5f6b 6579 5d20 3d20 5b72 6570 6f72  nt_key] = [repor
+00015790: 745f 6d73 675d 0a0a 2020 2020 2020 2020  t_msg]..        
+000157a0: 7473 2e73 7461 7465 203d 2022 7265 6c65  ts.state = "rele
+000157b0: 6173 6564 220a 0a20 2020 2020 2020 2072  ased"..        r
+000157c0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+000157d0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
+000157e0: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
+000157f0: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
+00015800: 696f 6e5f 7761 6974 696e 675f 7265 6c65  ion_waiting_rele
+00015810: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
+00015820: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+00015830: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+00015840: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+00015850: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00015860: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00015870: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00015880: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
+00015890: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+000158a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000158b0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+000158c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000158d0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+000158e0: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
+000158f0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00015900: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+00015910: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+00015920: 696e 2064 7473 2e77 6169 7465 7273 3a0a  in dts.waiters:.
+00015930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015940: 6474 732e 7761 6974 6572 732e 6469 7363  dts.waiters.disc
+00015950: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
+00015960: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+00015970: 7473 2e77 6169 7465 7273 2061 6e64 206e  ts.waiters and n
+00015980: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
+00015990: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000159a0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+000159b0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
+000159c0: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
+000159d0: 2020 2020 7473 2e77 6169 7469 6e67 5f6f      ts.waiting_o
+000159e0: 6e2e 636c 6561 7228 290a 0a20 2020 2020  n.clear()..     
+000159f0: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
+00015a00: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
+00015a10: 2020 6966 2074 732e 6861 735f 6c6f 7374    if ts.has_lost
+00015a20: 5f64 6570 656e 6465 6e63 6965 733a 0a20  _dependencies:. 
+00015a30: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00015a40: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
+00015a50: 3d20 2266 6f72 676f 7474 656e 220a 2020  = "forgotten".  
+00015a60: 2020 2020 2020 656c 6966 206e 6f74 2074        elif not t
+00015a70: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00015a80: 6520 616e 6420 2874 732e 7768 6f5f 7761  e and (ts.who_wa
+00015a90: 6e74 7320 6f72 2074 732e 7761 6974 6572  nts or ts.waiter
+00015aa0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00015ab0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+00015ac0: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+00015ad0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00015ae0: 2020 2020 2020 2020 2020 2074 732e 7761             ts.wa
+00015af0: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
+00015b00: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00015b10: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
+00015b20: 7d2c 207b 7d0a 0a20 2020 2064 6566 2074  }, {}..    def t
+00015b30: 7261 6e73 6974 696f 6e5f 7072 6f63 6573  ransition_proces
+00015b40: 7369 6e67 5f72 656c 6561 7365 6428 7365  sing_released(se
+00015b50: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
+00015b60: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
+00015b70: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
+00015b80: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00015b90: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+00015ba0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00015bb0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+00015bc0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00015bd0: 3a20 4d73 6773 203d 207b 7d0a 0a20 2020  : Msgs = {}..   
+00015be0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00015bf0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00015c00: 2020 2061 7373 6572 7420 7473 2e70 726f     assert ts.pro
+00015c10: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00015c20: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00015c30: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+00015c40: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015c50: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
+00015c60: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00015c70: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
+00015c80: 2022 7072 6f63 6573 7369 6e67 220a 0a20   "processing".. 
+00015c90: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
+00015ca0: 2e5f 6578 6974 5f70 726f 6365 7373 696e  ._exit_processin
+00015cb0: 675f 636f 6d6d 6f6e 2874 7329 0a20 2020  g_common(ts).   
+00015cc0: 2020 2020 2069 6620 7773 3a0a 2020 2020       if ws:.    
+00015cd0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+00015ce0: 7367 735b 7773 2e61 6464 7265 7373 5d20  sgs[ws.address] 
+00015cf0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00015d00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00015d10: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+00015d20: 2266 7265 652d 6b65 7973 222c 0a20 2020  "free-keys",.   
+00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d40: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
+00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d60: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
+00015d70: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
+00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d90: 7d0a 2020 2020 2020 2020 2020 2020 5d0a  }.            ].
+00015da0: 0a20 2020 2020 2020 2073 656c 662e 5f70  .        self._p
+00015db0: 726f 7061 6761 7465 5f72 656c 6561 7365  ropagate_release
+00015dc0: 6428 7473 2c20 7265 636f 6d6d 656e 6461  d(ts, recommenda
+00015dd0: 7469 6f6e 7329 0a20 2020 2020 2020 2072  tions).        r
+00015de0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+00015df0: 7469 6f6e 732c 207b 7d2c 2077 6f72 6b65  tions, {}, worke
+00015e00: 725f 6d73 6773 0a0a 2020 2020 6465 6620  r_msgs..    def 
+00015e10: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
+00015e20: 7373 696e 675f 6572 7265 6428 0a20 2020  ssing_erred(.   
+00015e30: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00015e40: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
+00015e50: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00015e60: 3a20 7374 722c 0a20 2020 2020 2020 202a  : str,.        *
+00015e70: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+00015e80: 3a20 7374 722c 0a20 2020 2020 2020 2063  : str,.        c
+00015e90: 6175 7365 3a20 7374 7220 7c20 4e6f 6e65  ause: str | None
+00015ea0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00015eb0: 2065 7863 6570 7469 6f6e 3a20 5365 7269   exception: Seri
+00015ec0: 616c 697a 6564 207c 204e 6f6e 6520 3d20  alized | None = 
+00015ed0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
+00015ee0: 6163 6562 6163 6b3a 2053 6572 6961 6c69  aceback: Seriali
+00015ef0: 7a65 6420 7c20 4e6f 6e65 203d 204e 6f6e  zed | None = Non
+00015f00: 652c 0a20 2020 2020 2020 2065 7863 6570  e,.        excep
+00015f10: 7469 6f6e 5f74 6578 743a 2073 7472 207c  tion_text: str |
+00015f20: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00015f30: 2020 2020 2020 7472 6163 6562 6163 6b5f        traceback_
+00015f40: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
+00015f50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00015f60: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00015f70: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
+00015f80: 733a 0a20 2020 2020 2020 2022 2222 5072  s:.        """Pr
+00015f90: 6f63 6573 7365 6420 6120 7265 636f 6d6d  ocessed a recomm
+00015fa0: 656e 6465 6420 7472 616e 7369 7469 6f6e  ended transition
+00015fb0: 2070 726f 6365 7373 696e 6720 2d3e 2065   processing -> e
+00015fc0: 7272 6564 2e0a 0a20 2020 2020 2020 2050  rred...        P
+00015fd0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00015fe0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00015ff0: 2020 2020 206b 6579 0a20 2020 2020 2020       key.       
+00016000: 2020 2020 4b65 7920 6f66 2074 6865 2074      Key of the t
+00016010: 6173 6b20 746f 2074 7261 6e73 6974 696f  ask to transitio
+00016020: 6e0a 2020 2020 2020 2020 7374 696d 756c  n.        stimul
+00016030: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+00016040: 2020 4944 206f 6620 7468 6520 7374 696d    ID of the stim
+00016050: 756c 7573 2063 6175 7369 6e67 2074 6865  ulus causing the
+00016060: 2074 7261 6e73 6974 696f 6e0a 2020 2020   transition.    
+00016070: 2020 2020 776f 726b 6572 0a20 2020 2020      worker.     
+00016080: 2020 2020 2020 2041 6464 7265 7373 206f         Address o
+00016090: 6620 7468 6520 776f 726b 6572 2077 6865  f the worker whe
+000160a0: 7265 2074 6865 2074 6173 6b20 6572 7265  re the task erre
+000160b0: 642e 0a20 2020 2020 2020 2020 2020 204e  d..            N
+000160c0: 6f74 206e 6563 6573 7361 7269 6c79 2060  ot necessarily `
+000160d0: 6074 732e 7072 6f63 6573 7369 6e67 5f6f  `ts.processing_o
+000160e0: 6e60 602e 0a20 2020 2020 2020 2063 6175  n``..        cau
+000160f0: 7365 0a20 2020 2020 2020 2020 2020 2041  se.            A
+00016100: 6464 7265 7373 206f 6620 7468 6520 7461  ddress of the ta
+00016110: 736b 2074 6861 7420 6361 7573 6564 2074  sk that caused t
+00016120: 6869 7320 7461 736b 2074 6f20 6265 2074  his task to be t
+00016130: 7261 6e73 6974 696f 6e65 6420 746f 2065  ransitioned to e
+00016140: 7272 6564 0a20 2020 2020 2020 2065 7863  rred.        exc
+00016150: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
+00016160: 2020 2045 7863 6570 7469 6f6e 2063 6175     Exception cau
+00016170: 7365 6420 6279 2074 6865 2074 6173 6b0a  sed by the task.
+00016180: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
+00016190: 6b0a 2020 2020 2020 2020 2020 2020 5472  k.            Tr
+000161a0: 6163 6562 6163 6b20 6361 7573 6564 2062  aceback caused b
+000161b0: 7920 7468 6520 7461 736b 0a20 2020 2020  y the task.     
+000161c0: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
+000161d0: 740a 2020 2020 2020 2020 2020 2020 5374  t.            St
+000161e0: 7269 6e67 2072 6570 7265 7365 6e74 6174  ring representat
+000161f0: 696f 6e20 6f66 2074 6865 2065 7863 6570  ion of the excep
+00016200: 7469 6f6e 0a20 2020 2020 2020 2074 7261  tion.        tra
+00016210: 6365 6261 636b 5f74 6578 740a 2020 2020  ceback_text.    
+00016220: 2020 2020 2020 2020 5374 7269 6e67 2072          String r
+00016230: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
+00016240: 2074 6865 2074 7261 6365 6261 636b 0a0a   the traceback..
+00016250: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
+00016260: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+00016270: 2020 2020 2020 2020 5265 636f 6d6d 656e          Recommen
+00016280: 6461 7469 6f6e 732c 2063 6c69 656e 7420  dations, client 
+00016290: 6d65 7373 6167 6573 2061 6e64 2077 6f72  messages and wor
+000162a0: 6b65 7220 6d65 7373 6167 6573 2074 6f20  ker messages to 
+000162b0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+000162c0: 2222 220a 2020 2020 2020 2020 7473 203d  """.        ts =
+000162d0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+000162e0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+000162f0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00016300: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
+00016310: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
+00016320: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
+00016330: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00016340: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00016350: 2063 6175 7365 206f 7220 7473 2e65 7863   cause or ts.exc
+00016360: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+00016370: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00016380: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00016390: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000163a0: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+000163b0: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
+000163c0: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+000163d0: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
+000163e0: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
+000163f0: 2020 2020 2020 2020 2020 7773 203d 2074            ws = t
+00016400: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+00016410: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00016420: 7274 2077 730a 2020 2020 2020 2020 2020  rt ws.          
+00016430: 2020 7773 2e61 6374 6f72 732e 7265 6d6f    ws.actors.remo
+00016440: 7665 2874 7329 0a0a 2020 2020 2020 2020  ve(ts)..        
+00016450: 7365 6c66 2e5f 6578 6974 5f70 726f 6365  self._exit_proce
+00016460: 7373 696e 675f 636f 6d6d 6f6e 2874 7329  ssing_common(ts)
+00016470: 0a0a 2020 2020 2020 2020 7473 2e65 7272  ..        ts.err
+00016480: 6564 5f6f 6e2e 6164 6428 776f 726b 6572  ed_on.add(worker
+00016490: 290a 2020 2020 2020 2020 6966 2065 7863  ).        if exc
+000164a0: 6570 7469 6f6e 2069 7320 6e6f 7420 4e6f  eption is not No
+000164b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000164c0: 7473 2e65 7863 6570 7469 6f6e 203d 2065  ts.exception = e
+000164d0: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
+000164e0: 2020 2020 2074 732e 6578 6365 7074 696f       ts.exceptio
+000164f0: 6e5f 7465 7874 203d 2065 7863 6570 7469  n_text = excepti
+00016500: 6f6e 5f74 6578 7420 2023 2074 7970 653a  on_text  # type:
+00016510: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+00016520: 6966 2074 7261 6365 6261 636b 2069 7320  if traceback is 
+00016530: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00016540: 2020 2020 2020 7473 2e74 7261 6365 6261        ts.traceba
+00016550: 636b 203d 2074 7261 6365 6261 636b 0a20  ck = traceback. 
+00016560: 2020 2020 2020 2020 2020 2074 732e 7472             ts.tr
+00016570: 6163 6562 6163 6b5f 7465 7874 203d 2074  aceback_text = t
+00016580: 7261 6365 6261 636b 5f74 6578 7420 2023  raceback_text  #
+00016590: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+000165a0: 2020 2020 2020 6966 2063 6175 7365 2069        if cause i
+000165b0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000165c0: 2020 2020 2020 2020 6661 696c 696e 675f          failing_
+000165d0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+000165e0: 6361 7573 655d 0a20 2020 2020 2020 2020  cause].         
+000165f0: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
+00016600: 626c 616d 6520 3d20 6661 696c 696e 675f  blame = failing_
+00016610: 7473 0a20 2020 2020 2020 2065 6c73 653a  ts.        else:
+00016620: 0a20 2020 2020 2020 2020 2020 2066 6169  .            fai
+00016630: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
+00016640: 6570 7469 6f6e 5f62 6c61 6d65 2020 2320  eption_blame  # 
+00016650: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
+00016660: 2020 2020 2020 7365 6c66 2e65 7272 6564        self.erred
+00016670: 5f74 6173 6b73 2e61 7070 656e 646c 6566  _tasks.appendlef
+00016680: 7428 0a20 2020 2020 2020 2020 2020 2045  t(.            E
+00016690: 7272 6564 5461 736b 280a 2020 2020 2020  rredTask(.      
+000166a0: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
+000166b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000166c0: 2020 7469 6d65 2829 2c0a 2020 2020 2020    time(),.      
+000166d0: 2020 2020 2020 2020 2020 7473 2e65 7272            ts.err
+000166e0: 6564 5f6f 6e2e 636f 7079 2829 2c0a 2020  ed_on.copy(),.  
+000166f0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00016700: 6365 7074 696f 6e5f 7465 7874 206f 7220  ception_text or 
+00016710: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00016720: 2020 2020 7472 6163 6562 6163 6b5f 7465      traceback_te
+00016730: 7874 206f 7220 2222 2c0a 2020 2020 2020  xt or "",.      
+00016740: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00016750: 290a 0a20 2020 2020 2020 2066 6f72 2064  )..        for d
+00016760: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+00016770: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00016780: 2064 7473 2e65 7863 6570 7469 6f6e 5f62   dts.exception_b
+00016790: 6c61 6d65 203d 2066 6169 6c69 6e67 5f74  lame = failing_t
+000167a0: 730a 2020 2020 2020 2020 2020 2020 7265  s.            re
+000167b0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+000167c0: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
+000167d0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+000167e0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+000167f0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00016800: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
+00016810: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
+00016820: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
+00016830: 2e77 6169 7465 7273 2061 6e64 206e 6f74  .waiters and not
+00016840: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
+00016850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016860: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+00016870: 6474 732e 6b65 795d 203d 2022 7265 6c65  dts.key] = "rele
+00016880: 6173 6564 220a 0a20 2020 2020 2020 2074  ased"..        t
+00016890: 732e 7761 6974 6572 732e 636c 6561 7228  s.waiters.clear(
+000168a0: 2920 2023 2064 6f20 616e 7974 6869 6e67  )  # do anything
+000168b0: 2077 6974 6820 7468 6973 3f0a 0a20 2020   with this?..   
+000168c0: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
+000168d0: 2265 7272 6564 220a 0a20 2020 2020 2020  "erred"..       
+000168e0: 2072 6570 6f72 745f 6d73 6720 3d20 7b0a   report_msg = {.
+000168f0: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+00016900: 3a20 2274 6173 6b2d 6572 7265 6422 2c0a  : "task-erred",.
+00016910: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+00016920: 223a 206b 6579 2c0a 2020 2020 2020 2020  ": key,.        
+00016930: 2020 2020 2265 7863 6570 7469 6f6e 223a      "exception":
+00016940: 2066 6169 6c69 6e67 5f74 732e 6578 6365   failing_ts.exce
+00016950: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
+00016960: 2020 2022 7472 6163 6562 6163 6b22 3a20     "traceback": 
+00016970: 6661 696c 696e 675f 7473 2e74 7261 6365  failing_ts.trace
+00016980: 6261 636b 2c0a 2020 2020 2020 2020 7d0a  back,.        }.
+00016990: 2020 2020 2020 2020 666f 7220 6373 2069          for cs i
+000169a0: 6e20 7473 2e77 686f 5f77 616e 7473 3a0a  n ts.who_wants:.
+000169b0: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+000169c0: 6e74 5f6d 7367 735b 6373 2e63 6c69 656e  nt_msgs[cs.clien
+000169d0: 745f 6b65 795d 203d 205b 7265 706f 7274  t_key] = [report
+000169e0: 5f6d 7367 5d0a 0a20 2020 2020 2020 2063  _msg]..        c
+000169f0: 7320 3d20 7365 6c66 2e63 6c69 656e 7473  s = self.clients
+00016a00: 5b22 6669 7265 2d61 6e64 2d66 6f72 6765  ["fire-and-forge
+00016a10: 7422 5d0a 2020 2020 2020 2020 6966 2074  t"].        if t
+00016a20: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
+00016a30: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
+00016a40: 7365 6c66 2e5f 636c 6965 6e74 5f72 656c  self._client_rel
+00016a50: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
+00016a60: 2020 2020 2020 2020 2020 2020 6373 3d63              cs=c
+00016a70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00016a80: 2020 206b 6579 733d 5b6b 6579 5d2c 0a20     keys=[key],. 
+00016a90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00016aa0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3d72  ecommendations=r
+00016ab0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c0a  ecommendations,.
+00016ac0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00016ad0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00016ae0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00016af0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00016b00: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00016b10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00016b20: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00016b30: 2c20 636c 6965 6e74 5f6d 7367 732c 207b  , client_msgs, {
+00016b40: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
+00016b50: 6974 696f 6e5f 6e6f 5f77 6f72 6b65 725f  ition_no_worker_
+00016b60: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
+00016b70: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00016b80: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00016b90: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00016ba0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00016bb0: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
+00016bc0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00016bd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00016be0: 7274 2073 656c 662e 7461 736b 735b 6b65  rt self.tasks[ke
+00016bf0: 795d 2e73 7461 7465 203d 3d20 226e 6f2d  y].state == "no-
+00016c00: 776f 726b 6572 220a 2020 2020 2020 2020  worker".        
+00016c10: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00016c20: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00016c30: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00016c40: 2074 732e 7761 6974 696e 675f 6f6e 0a0a   ts.waiting_on..
+00016c50: 2020 2020 2020 2020 7365 6c66 2e75 6e72          self.unr
+00016c60: 756e 6e61 626c 652e 7265 6d6f 7665 2874  unnable.remove(t
+00016c70: 7329 0a20 2020 2020 2020 2074 732e 7374  s).        ts.st
+00016c80: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
+00016c90: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+00016ca0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00016cb0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00016cc0: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
+00016cd0: 7363 6172 6428 7473 290a 0a20 2020 2020  scard(ts)..     
+00016ce0: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
+00016cf0: 6561 7228 290a 0a20 2020 2020 2020 2072  ear()..        r
+00016d00: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d  eturn {}, {}, {}
+00016d10: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00016d20: 7469 6f6e 5f77 6169 7469 6e67 5f71 7565  tion_waiting_que
+00016d30: 7565 6428 7365 6c66 2c20 6b65 793a 2073  ued(self, key: s
+00016d40: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
+00016d50: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00016d60: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00016d70: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00016d80: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00016d90: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00016da0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00016db0: 7420 7365 6c66 2e69 646c 655f 7461 736b  t self.idle_task
+00016dc0: 5f63 6f75 6e74 2c20 2874 732c 2073 656c  _count, (ts, sel
+00016dd0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+00016de0: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
+00016df0: 656c 662e 5f76 616c 6964 6174 655f 7265  elf._validate_re
+00016e00: 6164 7928 7473 290a 0a20 2020 2020 2020  ady(ts)..       
+00016e10: 2074 732e 7374 6174 6520 3d20 2271 7565   ts.state = "que
+00016e20: 7565 6422 0a20 2020 2020 2020 2073 656c  ued".        sel
+00016e30: 662e 7175 6575 6564 2e61 6464 2874 7329  f.queued.add(ts)
+00016e40: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00016e50: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
+00016e60: 2064 6566 2074 7261 6e73 6974 696f 6e5f   def transition_
+00016e70: 7761 6974 696e 675f 6e6f 5f77 6f72 6b65  waiting_no_worke
+00016e80: 7228 7365 6c66 2c20 6b65 793a 2073 7472  r(self, key: str
+00016e90: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00016ea0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+00016eb0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00016ec0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00016ed0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00016ee0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00016ef0: 2020 2020 2073 656c 662e 5f76 616c 6964       self._valid
+00016f00: 6174 655f 7265 6164 7928 7473 290a 0a20  ate_ready(ts).. 
+00016f10: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+00016f20: 3d20 226e 6f2d 776f 726b 6572 220a 2020  = "no-worker".  
+00016f30: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
+00016f40: 6e61 626c 652e 6164 6428 7473 290a 0a20  nable.add(ts).. 
+00016f50: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+00016f60: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 6465  , {}, {}..    de
+00016f70: 6620 7472 616e 7369 7469 6f6e 5f71 7565  f transition_que
+00016f80: 7565 645f 7265 6c65 6173 6564 2873 656c  ued_released(sel
+00016f90: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+00016fa0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00016fb0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+00016fc0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00016fd0: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
+00016fe0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00016ff0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00017000: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
+00017010: 662e 7175 6575 6564 0a20 2020 2020 2020  f.queued.       
+00017020: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00017030: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00017040: 0a0a 2020 2020 2020 2020 7365 6c66 2e71  ..        self.q
+00017050: 7565 7565 642e 7265 6d6f 7665 2874 7329  ueued.remove(ts)
+00017060: 0a0a 2020 2020 2020 2020 7265 636f 6d6d  ..        recomm
+00017070: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+00017080: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+00017090: 662e 5f70 726f 7061 6761 7465 5f72 656c  f._propagate_rel
+000170a0: 6561 7365 6428 7473 2c20 7265 636f 6d6d  eased(ts, recomm
+000170b0: 656e 6461 7469 6f6e 7329 0a20 2020 2020  endations).     
+000170c0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+000170d0: 656e 6461 7469 6f6e 732c 207b 7d2c 207b  endations, {}, {
+000170e0: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
+000170f0: 6974 696f 6e5f 7175 6575 6564 5f70 726f  ition_queued_pro
+00017100: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
+00017110: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
+00017120: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00017130: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+00017140: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00017150: 6579 5d0a 2020 2020 2020 2020 7265 636f  ey].        reco
+00017160: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00017170: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+00017180: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00017190: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
+000171a0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+000171b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000171c0: 6572 7420 6e6f 7420 7473 2e61 6374 6f72  ert not ts.actor
+000171d0: 2c20 6622 4163 746f 7273 2063 616e 2774  , f"Actors can't
+000171e0: 2062 6520 7175 6575 6564 3a20 7b74 737d   be queued: {ts}
+000171f0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
+00017200: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
+00017210: 7175 6575 6564 0a0a 2020 2020 2020 2020  queued..        
+00017220: 6966 2077 7320 3a3d 2073 656c 662e 6465  if ws := self.de
+00017230: 6369 6465 5f77 6f72 6b65 725f 726f 6f74  cide_worker_root
+00017240: 6973 685f 7175 6575 696e 675f 656e 6162  ish_queuing_enab
+00017250: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
+00017260: 2020 2073 656c 662e 7175 6575 6564 2e64     self.queued.d
+00017270: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
+00017280: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+00017290: 6773 203d 2073 656c 662e 5f61 6464 5f74  gs = self._add_t
+000172a0: 6f5f 7072 6f63 6573 7369 6e67 2874 732c  o_processing(ts,
+000172b0: 2077 7329 0a20 2020 2020 2020 2023 2049   ws).        # I
+000172c0: 6620 6e6f 2077 6f72 6b65 722c 2074 6173  f no worker, tas
+000172d0: 6b20 6a75 7374 2073 7461 7973 2060 7175  k just stays `qu
+000172e0: 6575 6564 600a 0a20 2020 2020 2020 2072  eued`..        r
+000172f0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+00017300: 7469 6f6e 732c 207b 7d2c 2077 6f72 6b65  tions, {}, worke
+00017310: 725f 6d73 6773 0a0a 2020 2020 6465 6620  r_msgs..    def 
+00017320: 5f72 656d 6f76 655f 6b65 7928 7365 6c66  _remove_key(self
+00017330: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
+00017340: 6f6e 653a 0a20 2020 2020 2020 2074 7320  one:.        ts 
+00017350: 3d20 7365 6c66 2e74 6173 6b73 2e70 6f70  = self.tasks.pop
+00017360: 286b 6579 290a 2020 2020 2020 2020 6173  (key).        as
+00017370: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
+00017380: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
+00017390: 2020 2020 2073 656c 662e 756e 7275 6e6e       self.unrunn
+000173a0: 6162 6c65 2e64 6973 6361 7264 2874 7329  able.discard(ts)
+000173b0: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
+000173c0: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
+000173d0: 0a20 2020 2020 2020 2020 2020 2063 732e  .            cs.
+000173e0: 7761 6e74 735f 7768 6174 2e72 656d 6f76  wants_what.remov
+000173f0: 6528 7473 290a 2020 2020 2020 2020 7473  e(ts).        ts
+00017400: 2e77 686f 5f77 616e 7473 2e63 6c65 6172  .who_wants.clear
+00017410: 2829 0a20 2020 2020 2020 2074 732e 7072  ().        ts.pr
+00017420: 6f63 6573 7369 6e67 5f6f 6e20 3d20 4e6f  ocessing_on = No
+00017430: 6e65 0a20 2020 2020 2020 2074 732e 6578  ne.        ts.ex
+00017440: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
+00017450: 7473 2e65 7863 6570 7469 6f6e 203d 2074  ts.exception = t
+00017460: 732e 7472 6163 6562 6163 6b20 3d20 4e6f  s.traceback = No
+00017470: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+00017480: 7461 736b 5f6d 6574 6164 6174 612e 706f  task_metadata.po
+00017490: 7028 6b65 792c 204e 6f6e 6529 0a0a 2020  p(key, None)..  
+000174a0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+000174b0: 5f6d 656d 6f72 795f 666f 7267 6f74 7465  _memory_forgotte
+000174c0: 6e28 7365 6c66 2c20 6b65 793a 2073 7472  n(self, key: str
+000174d0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+000174e0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+000174f0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00017500: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00017510: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00017520: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00017530: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
+00017540: 7461 7465 203d 3d20 226d 656d 6f72 7922  tate == "memory"
+00017550: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017560: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00017570: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+00017580: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00017590: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
+000175a0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000175b0: 2074 732e 7275 6e5f 7370 6563 3a0a 2020   ts.run_spec:.  
+000175c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000175d0: 4974 2773 206f 6b20 746f 2066 6f72 6765  It's ok to forge
+000175e0: 7420 6120 7075 7265 2064 6174 6120 7461  t a pure data ta
+000175f0: 736b 0a20 2020 2020 2020 2020 2020 2020  sk.             
+00017600: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00017610: 2020 2020 656c 6966 2074 732e 6861 735f      elif ts.has_
+00017620: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
+00017630: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00017640: 2020 2023 2049 7427 7320 6f6b 2074 6f20     # It's ok to 
+00017650: 666f 7267 6574 2061 2074 6173 6b20 7769  forget a task wi
+00017660: 7468 2066 6f72 676f 7474 656e 2064 6570  th forgotten dep
+00017670: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
+00017680: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00017690: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000176a0: 6e6f 7420 7473 2e77 686f 5f77 616e 7473  not ts.who_wants
+000176b0: 2061 6e64 206e 6f74 2074 732e 7761 6974   and not ts.wait
+000176c0: 6572 7320 616e 6420 6e6f 7420 7473 2e64  ers and not ts.d
+000176d0: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
+000176e0: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
+000176f0: 7320 6f6b 2074 6f20 666f 7267 6574 2061  s ok to forget a
+00017700: 2074 6173 6b20 7468 6174 206e 6f62 6f64   task that nobod
+00017710: 7920 6e65 6564 730a 2020 2020 2020 2020  y needs.        
+00017720: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00017730: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00017740: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00017750: 6169 7365 2041 7373 6572 7469 6f6e 4572  aise AssertionEr
+00017760: 726f 7228 2255 6e72 6561 6368 6162 6c65  ror("Unreachable
+00017770: 222c 2074 7329 2020 2320 7072 6167 6d61  ", ts)  # pragma
+00017780: 3a20 6e6f 636f 7665 720a 0a20 2020 2020  : nocover..     
+00017790: 2020 2069 6620 7473 2e61 6374 6f72 3a0a     if ts.actor:.
+000177a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000177b0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+000177c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000177d0: 2020 7773 2e61 6374 6f72 732e 6469 7363    ws.actors.disc
+000177e0: 6172 6428 7473 290a 0a20 2020 2020 2020  ard(ts)..       
+000177f0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00017800: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
+00017810: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
+00017820: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
+00017830: 2020 2073 656c 662e 5f70 726f 7061 6761     self._propaga
+00017840: 7465 5f66 6f72 676f 7474 656e 2874 732c  te_forgotten(ts,
+00017850: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00017860: 2c20 776f 726b 6572 5f6d 7367 732c 2073  , worker_msgs, s
+00017870: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+00017880: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
+00017890: 203d 205f 7461 736b 5f74 6f5f 636c 6965   = _task_to_clie
+000178a0: 6e74 5f6d 7367 7328 7473 290a 2020 2020  nt_msgs(ts).    
+000178b0: 2020 2020 7365 6c66 2e5f 7265 6d6f 7665      self._remove
+000178c0: 5f6b 6579 286b 6579 290a 0a20 2020 2020  _key(key)..     
+000178d0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+000178e0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+000178f0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+00017900: 7367 730a 0a20 2020 2064 6566 2074 7261  sgs..    def tra
+00017910: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
+00017920: 5f66 6f72 676f 7474 656e 2873 656c 662c  _forgotten(self,
+00017930: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
+00017940: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
+00017950: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
+00017960: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+00017970: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
+00017980: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+00017990: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+000179a0: 7365 7274 2074 732e 7374 6174 6520 696e  sert ts.state in
+000179b0: 2028 2272 656c 6561 7365 6422 2c20 2265   ("released", "e
+000179c0: 7272 6564 2229 0a20 2020 2020 2020 2020  rred").         
+000179d0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+000179e0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+000179f0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00017a00: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00017a10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017a20: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+00017a30: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
+00017a40: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00017a50: 2074 732e 7761 6974 696e 675f 6f6e 2c20   ts.waiting_on, 
+00017a60: 2874 732c 2074 732e 7761 6974 696e 675f  (ts, ts.waiting_
+00017a70: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00017a80: 6966 206e 6f74 2074 732e 7275 6e5f 7370  if not ts.run_sp
+00017a90: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
+00017aa0: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
+00017ab0: 2066 6f72 6765 7420 6120 7075 7265 2064   forget a pure d
+00017ac0: 6174 6120 7461 736b 0a20 2020 2020 2020  ata task.       
+00017ad0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00017ae0: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
+00017af0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
+00017b00: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+00017b10: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
+00017b20: 6f6b 2074 6f20 666f 7267 6574 2061 2074  ok to forget a t
+00017b30: 6173 6b20 7769 7468 2066 6f72 676f 7474  ask with forgott
+00017b40: 656e 2064 6570 656e 6465 6e63 6965 730a  en dependencies.
+00017b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b60: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+00017b70: 2065 6c69 6620 6e6f 7420 7473 2e77 686f   elif not ts.who
+00017b80: 5f77 616e 7473 2061 6e64 206e 6f74 2074  _wants and not t
+00017b90: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
+00017ba0: 7420 7473 2e64 6570 656e 6465 6e74 733a  t ts.dependents:
+00017bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017bc0: 2023 2049 7427 7320 6f6b 2074 6f20 666f   # It's ok to fo
+00017bd0: 7267 6574 2061 2074 6173 6b20 7468 6174  rget a task that
+00017be0: 206e 6f62 6f64 7920 6e65 6564 730a 2020   nobody needs.  
+00017bf0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00017c00: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
+00017c10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00017c20: 2020 2020 2072 6169 7365 2041 7373 6572       raise Asser
+00017c30: 7469 6f6e 4572 726f 7228 2255 6e72 6561  tionError("Unrea
+00017c40: 6368 6162 6c65 222c 2073 7472 2874 7329  chable", str(ts)
+00017c50: 2920 2023 2070 7261 676d 613a 206e 6f63  )  # pragma: noc
+00017c60: 6f76 6572 0a0a 2020 2020 2020 2020 7265  over..        re
+00017c70: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+00017c80: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
+00017c90: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
+00017ca0: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
+00017cb0: 7365 6c66 2e5f 7072 6f70 6167 6174 655f  self._propagate_
+00017cc0: 666f 7267 6f74 7465 6e28 7473 2c20 7265  forgotten(ts, re
+00017cd0: 636f 6d6d 656e 6461 7469 6f6e 732c 2077  commendations, w
+00017ce0: 6f72 6b65 725f 6d73 6773 2c20 7374 696d  orker_msgs, stim
+00017cf0: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
+00017d00: 2020 636c 6965 6e74 5f6d 7367 7320 3d20    client_msgs = 
+00017d10: 5f74 6173 6b5f 746f 5f63 6c69 656e 745f  _task_to_client_
+00017d20: 6d73 6773 2874 7329 0a20 2020 2020 2020  msgs(ts).       
+00017d30: 2073 656c 662e 5f72 656d 6f76 655f 6b65   self._remove_ke
+00017d40: 7928 6b65 7929 0a0a 2020 2020 2020 2020  y(key)..        
+00017d50: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00017d60: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+00017d70: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+00017d80: 0a0a 2020 2020 2320 7b0a 2020 2020 2320  ..    # {.    # 
+00017d90: 2020 2020 2873 7461 7274 2c20 6669 6e69      (start, fini
+00017da0: 7368 293a 0a20 2020 2023 2020 2020 2074  sh):.    #     t
+00017db0: 7261 6e73 6974 696f 6e5f 3c73 7461 7274  ransition_<start
+00017dc0: 3e5f 3c66 696e 6973 683e 280a 2020 2020  >_<finish>(.    
+00017dd0: 2320 2020 2020 2020 2020 7365 6c66 2c20  #         self, 
+00017de0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
+00017df0: 7573 5f69 643a 2073 7472 2c20 2a2a 6b77  us_id: str, **kw
+00017e00: 6172 6773 0a20 2020 2023 2020 2020 2029  args.    #     )
+00017e10: 202d 3e20 2872 6563 6f6d 6d65 6e64 6174   -> (recommendat
+00017e20: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+00017e30: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
+00017e40: 2020 2020 2320 7d0a 2020 2020 5f54 5241      # }.    _TRA
+00017e50: 4e53 4954 494f 4e53 5f54 4142 4c45 3a20  NSITIONS_TABLE: 
+00017e60: 436c 6173 7356 6172 5b0a 2020 2020 2020  ClassVar[.      
+00017e70: 2020 4d61 7070 696e 675b 0a20 2020 2020    Mapping[.     
+00017e80: 2020 2020 2020 2074 7570 6c65 5b54 6173         tuple[Tas
+00017e90: 6b53 7461 7465 5374 6174 652c 2054 6173  kStateState, Tas
+00017ea0: 6b53 7461 7465 5374 6174 655d 2c0a 2020  kStateState],.  
+00017eb0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
+00017ec0: 6c65 5b2e 2e2e 2c20 5265 6373 4d73 6773  le[..., RecsMsgs
+00017ed0: 5d2c 0a20 2020 2020 2020 205d 0a20 2020  ],.        ].   
+00017ee0: 205d 203d 207b 0a20 2020 2020 2020 2028   ] = {.        (
+00017ef0: 2272 656c 6561 7365 6422 2c20 2277 6169  "released", "wai
+00017f00: 7469 6e67 2229 3a20 7472 616e 7369 7469  ting"): transiti
+00017f10: 6f6e 5f72 656c 6561 7365 645f 7761 6974  on_released_wait
+00017f20: 696e 672c 0a20 2020 2020 2020 2028 2277  ing,.        ("w
+00017f30: 6169 7469 6e67 222c 2022 7265 6c65 6173  aiting", "releas
+00017f40: 6564 2229 3a20 7472 616e 7369 7469 6f6e  ed"): transition
+00017f50: 5f77 6169 7469 6e67 5f72 656c 6561 7365  _waiting_release
+00017f60: 642c 0a20 2020 2020 2020 2028 2277 6169  d,.        ("wai
+00017f70: 7469 6e67 222c 2022 7072 6f63 6573 7369  ting", "processi
+00017f80: 6e67 2229 3a20 7472 616e 7369 7469 6f6e  ng"): transition
+00017f90: 5f77 6169 7469 6e67 5f70 726f 6365 7373  _waiting_process
+00017fa0: 696e 672c 0a20 2020 2020 2020 2028 2277  ing,.        ("w
+00017fb0: 6169 7469 6e67 222c 2022 6e6f 2d77 6f72  aiting", "no-wor
+00017fc0: 6b65 7222 293a 2074 7261 6e73 6974 696f  ker"): transitio
+00017fd0: 6e5f 7761 6974 696e 675f 6e6f 5f77 6f72  n_waiting_no_wor
+00017fe0: 6b65 722c 0a20 2020 2020 2020 2028 2277  ker,.        ("w
+00017ff0: 6169 7469 6e67 222c 2022 7175 6575 6564  aiting", "queued
+00018000: 2229 3a20 7472 616e 7369 7469 6f6e 5f77  "): transition_w
+00018010: 6169 7469 6e67 5f71 7565 7565 642c 0a20  aiting_queued,. 
+00018020: 2020 2020 2020 2028 2277 6169 7469 6e67         ("waiting
+00018030: 222c 2022 6d65 6d6f 7279 2229 3a20 7472  ", "memory"): tr
+00018040: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
+00018050: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
+00018060: 2028 2271 7565 7565 6422 2c20 2272 656c   ("queued", "rel
+00018070: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
+00018080: 696f 6e5f 7175 6575 6564 5f72 656c 6561  ion_queued_relea
+00018090: 7365 642c 0a20 2020 2020 2020 2028 2271  sed,.        ("q
+000180a0: 7565 7565 6422 2c20 2270 726f 6365 7373  ueued", "process
+000180b0: 696e 6722 293a 2074 7261 6e73 6974 696f  ing"): transitio
+000180c0: 6e5f 7175 6575 6564 5f70 726f 6365 7373  n_queued_process
+000180d0: 696e 672c 0a20 2020 2020 2020 2028 2270  ing,.        ("p
+000180e0: 726f 6365 7373 696e 6722 2c20 2272 656c  rocessing", "rel
+000180f0: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
+00018100: 696f 6e5f 7072 6f63 6573 7369 6e67 5f72  ion_processing_r
+00018110: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
+00018120: 2028 2270 726f 6365 7373 696e 6722 2c20   ("processing", 
+00018130: 226d 656d 6f72 7922 293a 2074 7261 6e73  "memory"): trans
+00018140: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
+00018150: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
+00018160: 2028 2270 726f 6365 7373 696e 6722 2c20   ("processing", 
+00018170: 2265 7272 6564 2229 3a20 7472 616e 7369  "erred"): transi
+00018180: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
+00018190: 6572 7265 642c 0a20 2020 2020 2020 2028  erred,.        (
+000181a0: 226e 6f2d 776f 726b 6572 222c 2022 7265  "no-worker", "re
+000181b0: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
+000181c0: 7469 6f6e 5f6e 6f5f 776f 726b 6572 5f72  tion_no_worker_r
+000181d0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
+000181e0: 2028 226e 6f2d 776f 726b 6572 222c 2022   ("no-worker", "
+000181f0: 7072 6f63 6573 7369 6e67 2229 3a20 7472  processing"): tr
+00018200: 616e 7369 7469 6f6e 5f6e 6f5f 776f 726b  ansition_no_work
+00018210: 6572 5f70 726f 6365 7373 696e 672c 0a20  er_processing,. 
+00018220: 2020 2020 2020 2028 2272 656c 6561 7365         ("release
+00018230: 6422 2c20 2266 6f72 676f 7474 656e 2229  d", "forgotten")
+00018240: 3a20 7472 616e 7369 7469 6f6e 5f72 656c  : transition_rel
+00018250: 6561 7365 645f 666f 7267 6f74 7465 6e2c  eased_forgotten,
+00018260: 0a20 2020 2020 2020 2028 226d 656d 6f72  .        ("memor
+00018270: 7922 2c20 2266 6f72 676f 7474 656e 2229  y", "forgotten")
+00018280: 3a20 7472 616e 7369 7469 6f6e 5f6d 656d  : transition_mem
+00018290: 6f72 795f 666f 7267 6f74 7465 6e2c 0a20  ory_forgotten,. 
+000182a0: 2020 2020 2020 2028 2265 7272 6564 222c         ("erred",
+000182b0: 2022 7265 6c65 6173 6564 2229 3a20 7472   "released"): tr
+000182c0: 616e 7369 7469 6f6e 5f65 7272 6564 5f72  ansition_erred_r
+000182d0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
+000182e0: 2028 226d 656d 6f72 7922 2c20 2272 656c   ("memory", "rel
+000182f0: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
+00018300: 696f 6e5f 6d65 6d6f 7279 5f72 656c 6561  ion_memory_relea
+00018310: 7365 642c 0a20 2020 2020 2020 2028 2272  sed,.        ("r
+00018320: 656c 6561 7365 6422 2c20 2265 7272 6564  eleased", "erred
+00018330: 2229 3a20 7472 616e 7369 7469 6f6e 5f72  "): transition_r
+00018340: 656c 6561 7365 645f 6572 7265 642c 0a20  eleased_erred,. 
+00018350: 2020 207d 0a0a 2020 2020 6465 6620 7374     }..    def st
+00018360: 6f72 7928 7365 6c66 2c20 2a6b 6579 735f  ory(self, *keys_
+00018370: 6f72 5f74 6173 6b73 5f6f 725f 7374 696d  or_tasks_or_stim
+00018380: 756c 693a 2073 7472 207c 2054 6173 6b53  uli: str | TaskS
+00018390: 7461 7465 2920 2d3e 206c 6973 745b 5472  tate) -> list[Tr
+000183a0: 616e 7369 7469 6f6e 5d3a 0a20 2020 2020  ansition]:.     
+000183b0: 2020 2022 2222 4765 7420 616c 6c20 7472     """Get all tr
+000183c0: 616e 7369 7469 6f6e 7320 7468 6174 2074  ansitions that t
+000183d0: 6f75 6368 206f 6e65 206f 6620 7468 6520  ouch one of the 
+000183e0: 696e 7075 7420 6b65 7973 206f 7220 7374  input keys or st
+000183f0: 696d 756c 7573 5f69 6427 7322 2222 0a20  imulus_id's""". 
+00018400: 2020 2020 2020 206b 6579 735f 6f72 5f73         keys_or_s
+00018410: 7469 6d75 6c69 203d 207b 0a20 2020 2020  timuli = {.     
+00018420: 2020 2020 2020 206b 6579 2e6b 6579 2069         key.key i
+00018430: 6620 6973 696e 7374 616e 6365 286b 6579  f isinstance(key
+00018440: 2c20 5461 736b 5374 6174 6529 2065 6c73  , TaskState) els
+00018450: 6520 6b65 790a 2020 2020 2020 2020 2020  e key.          
+00018460: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+00018470: 735f 6f72 5f74 6173 6b73 5f6f 725f 7374  s_or_tasks_or_st
+00018480: 696d 756c 690a 2020 2020 2020 2020 7d0a  imuli.        }.
+00018490: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000184a0: 6368 6564 756c 6572 5f73 746f 7279 286b  cheduler_story(k
+000184b0: 6579 735f 6f72 5f73 7469 6d75 6c69 2c20  eys_or_stimuli, 
+000184c0: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
+000184d0: 6c6f 6729 0a0a 2020 2020 2323 2323 2323  log)..    ######
+000184e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000184f0: 2323 2323 2323 2323 0a20 2020 2023 2041  ########.    # A
+00018500: 7373 6967 6e69 6e67 2054 6173 6b73 2074  ssigning Tasks t
+00018510: 6f20 576f 726b 6572 7320 230a 2020 2020  o Workers #.    
+00018520: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018530: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
+00018540: 2020 2020 6465 6620 6973 5f72 6f6f 7469      def is_rooti
+00018550: 7368 2873 656c 662c 2074 733a 2054 6173  sh(self, ts: Tas
+00018560: 6b53 7461 7465 2920 2d3e 2062 6f6f 6c3a  kState) -> bool:
+00018570: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00018580: 2020 2020 2057 6865 7468 6572 2060 6074       Whether ``t
+00018590: 7360 6020 6973 2061 2072 6f6f 7420 6f72  s`` is a root or
+000185a0: 2072 6f6f 742d 6c69 6b65 2074 6173 6b2e   root-like task.
+000185b0: 0a0a 2020 2020 2020 2020 526f 6f74 2d69  ..        Root-i
+000185c0: 7368 2074 6173 6b73 2061 7265 2070 6172  sh tasks are par
+000185d0: 7420 6f66 2061 2067 726f 7570 2074 6861  t of a group tha
+000185e0: 7427 7320 6d75 6368 206c 6172 6765 7220  t's much larger 
+000185f0: 7468 616e 2074 6865 2063 6c75 7374 6572  than the cluster
+00018600: 2c0a 2020 2020 2020 2020 616e 6420 6861  ,.        and ha
+00018610: 7665 2066 6577 206f 7220 6e6f 2064 6570  ve few or no dep
+00018620: 656e 6465 6e63 6965 732e 0a20 2020 2020  endencies..     
+00018630: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+00018640: 6620 7473 2e72 6573 6f75 7263 655f 7265  f ts.resource_re
+00018650: 7374 7269 6374 696f 6e73 206f 7220 7473  strictions or ts
+00018660: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
+00018670: 696f 6e73 206f 7220 7473 2e68 6f73 745f  ions or ts.host_
+00018680: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
+00018690: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000186a0: 2046 616c 7365 0a20 2020 2020 2020 2074   False.        t
+000186b0: 6720 3d20 7473 2e67 726f 7570 0a20 2020  g = ts.group.   
+000186c0: 2020 2020 2023 2054 4f44 4f20 7368 6f72       # TODO shor
+000186d0: 742d 6369 7263 7569 7420 746f 2054 7275  t-circuit to Tru
+000186e0: 6520 6966 2060 6e6f 7420 7473 2e64 6570  e if `not ts.dep
+000186f0: 656e 6465 6e63 6965 7360 3f0a 2020 2020  endencies`?.    
+00018700: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00018710: 2020 2020 2020 2020 206c 656e 2874 6729           len(tg)
+00018720: 203e 2073 656c 662e 746f 7461 6c5f 6e74   > self.total_nt
+00018730: 6872 6561 6473 202a 2032 0a20 2020 2020  hreads * 2.     
+00018740: 2020 2020 2020 2061 6e64 206c 656e 2874         and len(t
+00018750: 672e 6465 7065 6e64 656e 6369 6573 2920  g.dependencies) 
+00018760: 3c20 350a 2020 2020 2020 2020 2020 2020  < 5.            
+00018770: 616e 6420 7375 6d28 6d61 7028 6c65 6e2c  and sum(map(len,
+00018780: 2074 672e 6465 7065 6e64 656e 6369 6573   tg.dependencies
+00018790: 2929 203c 2035 0a20 2020 2020 2020 2029  )) < 5.        )
+000187a0: 0a0a 2020 2020 6465 6620 6368 6563 6b5f  ..    def check_
+000187b0: 6964 6c65 5f73 6174 7572 6174 6564 2873  idle_saturated(s
+000187c0: 656c 662c 2077 733a 2057 6f72 6b65 7253  elf, ws: WorkerS
+000187d0: 7461 7465 2c20 6f63 633a 2066 6c6f 6174  tate, occ: float
+000187e0: 203d 202d 312e 3029 202d 3e20 4e6f 6e65   = -1.0) -> None
+000187f0: 3a0a 2020 2020 2020 2020 2222 2255 7064  :.        """Upd
+00018800: 6174 6520 7468 6520 7374 6174 7573 206f  ate the status o
+00018810: 6620 7468 6520 6964 6c65 2061 6e64 2073  f the idle and s
+00018820: 6174 7572 6174 6564 2073 7461 7465 0a0a  aturated state..
+00018830: 2020 2020 2020 2020 5468 6520 7363 6865          The sche
+00018840: 6475 6c65 7220 6b65 6570 7320 7472 6163  duler keeps trac
+00018850: 6b20 6f66 2077 6f72 6b65 7273 2074 6861  k of workers tha
+00018860: 7420 6172 6520 2e2e 0a0a 2020 2020 2020  t are ....      
+00018870: 2020 2d20 2053 6174 7572 6174 6564 3a20    -  Saturated: 
+00018880: 6861 7665 2065 6e6f 7567 6820 776f 726b  have enough work
+00018890: 2074 6f20 7374 6179 2062 7573 790a 2020   to stay busy.  
+000188a0: 2020 2020 2020 2d20 2049 646c 653a 2064        -  Idle: d
+000188b0: 6f20 6e6f 7420 6861 7665 2065 6e6f 7567  o not have enoug
+000188c0: 6820 776f 726b 2074 6f20 7374 6179 2062  h work to stay b
+000188d0: 7573 790a 0a20 2020 2020 2020 2054 6865  usy..        The
+000188e0: 7920 6172 6520 636f 6e73 6964 6572 6564  y are considered
+000188f0: 2073 6174 7572 6174 6564 2069 6620 7468   saturated if th
+00018900: 6579 2062 6f74 6820 6861 7665 2065 6e6f  ey both have eno
+00018910: 7567 6820 7461 736b 7320 746f 206f 6363  ugh tasks to occ
+00018920: 7570 790a 2020 2020 2020 2020 616c 6c20  upy.        all 
+00018930: 6f66 2074 6865 6972 2074 6872 6561 6473  of their threads
+00018940: 2c20 616e 6420 6966 2074 6865 2065 7870  , and if the exp
+00018950: 6563 7465 6420 7275 6e74 696d 6520 6f66  ected runtime of
+00018960: 2074 686f 7365 2074 6173 6b73 2069 730a   those tasks is.
+00018970: 2020 2020 2020 2020 6c61 7267 6520 656e          large en
+00018980: 6f75 6768 2e0a 0a20 2020 2020 2020 2049  ough...        I
+00018990: 6620 6060 6469 7374 7269 6275 7465 642e  f ``distributed.
+000189a0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+000189b0: 2d73 6174 7572 6174 696f 6e60 6020 6973  -saturation`` is
+000189c0: 206e 6f74 2060 6069 6e66 6060 0a20 2020   not ``inf``.   
+000189d0: 2020 2020 2028 7363 6865 6475 6c65 722d       (scheduler-
+000189e0: 7369 6465 2071 7565 7569 6e67 2069 7320  side queuing is 
+000189f0: 656e 6162 6c65 6429 2c20 7468 6579 2061  enabled), they a
+00018a00: 7265 2063 6f6e 7369 6465 7265 6420 6964  re considered id
+00018a10: 6c65 0a20 2020 2020 2020 2069 6620 7468  le.        if th
+00018a20: 6579 2068 6176 6520 6665 7765 7220 7461  ey have fewer ta
+00018a30: 736b 7320 7072 6f63 6573 7369 6e67 2074  sks processing t
+00018a40: 6861 6e20 7468 6520 6060 776f 726b 6572  han the ``worker
+00018a50: 2d73 6174 7572 6174 696f 6e60 600a 2020  -saturation``.  
+00018a60: 2020 2020 2020 7468 7265 7368 6f6c 6420        threshold 
+00018a70: 6469 6374 6174 6573 2e0a 0a20 2020 2020  dictates...     
+00018a80: 2020 204f 7468 6572 7769 7365 2c20 7468     Otherwise, th
+00018a90: 6579 2061 7265 2063 6f6e 7369 6465 7265  ey are considere
+00018aa0: 6420 6964 6c65 2069 6620 7468 6579 2068  d idle if they h
+00018ab0: 6176 6520 6665 7765 7220 7461 736b 7320  ave fewer tasks 
+00018ac0: 7072 6f63 6573 7369 6e67 0a20 2020 2020  processing.     
+00018ad0: 2020 2074 6861 6e20 7468 7265 6164 732c     than threads,
+00018ae0: 206f 7220 6966 2074 6865 6972 2074 6173   or if their tas
+00018af0: 6b73 2720 746f 7461 6c20 6578 7065 6374  ks' total expect
+00018b00: 6564 2072 756e 7469 6d65 2069 7320 6c65  ed runtime is le
+00018b10: 7373 2074 6861 6e20 6861 6c66 0a20 2020  ss than half.   
+00018b20: 2020 2020 2074 6865 2065 7870 6563 7465       the expecte
+00018b30: 6420 7275 6e74 696d 6520 6f66 2074 6865  d runtime of the
+00018b40: 2073 616d 6520 6e75 6d62 6572 206f 6620   same number of 
+00018b50: 6176 6572 6167 6520 7461 736b 732e 0a0a  average tasks...
+00018b60: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
+00018b70: 7573 6566 756c 2066 6f72 206c 6f61 6420  useful for load 
+00018b80: 6261 6c61 6e63 696e 6720 616e 6420 6164  balancing and ad
+00018b90: 6170 7469 7669 7479 2e0a 2020 2020 2020  aptivity..      
+00018ba0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00018bb0: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
+00018bc0: 6561 6473 203d 3d20 3020 6f72 2077 732e  eads == 0 or ws.
+00018bd0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00018be0: 2e63 6c6f 7365 643a 0a20 2020 2020 2020  .closed:.       
+00018bf0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00018c00: 2020 2020 6966 206f 6363 203c 2030 3a0a      if occ < 0:.
+00018c10: 2020 2020 2020 2020 2020 2020 6f63 6320              occ 
+00018c20: 3d20 7773 2e6f 6363 7570 616e 6379 0a0a  = ws.occupancy..
+00018c30: 2020 2020 2020 2020 7020 3d20 6c65 6e28          p = len(
+00018c40: 7773 2e70 726f 6365 7373 696e 6729 0a0a  ws.processing)..
+00018c50: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
+00018c60: 7572 6174 6564 2e64 6973 6361 7264 2877  urated.discard(w
+00018c70: 7329 0a20 2020 2020 2020 2069 6620 7773  s).        if ws
+00018c80: 2e73 7461 7475 7320 213d 2053 7461 7475  .status != Statu
+00018c90: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
 00018ca0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00018cb0: 5f74 6173 6b5f 636f 756e 742e 6469 7363  _task_count.disc
-00018cc0: 6172 6428 7773 290a 0a20 2020 2064 6566  ard(ws)..    def
-00018cd0: 2069 735f 756e 6f63 6375 7069 6564 280a   is_unoccupied(.
-00018ce0: 2020 2020 2020 2020 7365 6c66 2c20 7773          self, ws
-00018cf0: 3a20 576f 726b 6572 5374 6174 652c 206f  : WorkerState, o
-00018d00: 6363 7570 616e 6379 3a20 666c 6f61 742c  ccupancy: float,
-00018d10: 206e 7072 6f63 6573 7369 6e67 3a20 696e   nprocessing: in
-00018d20: 740a 2020 2020 2920 2d3e 2062 6f6f 6c3a  t.    ) -> bool:
-00018d30: 0a20 2020 2020 2020 206e 7468 7265 6164  .        nthread
-00018d40: 7320 3d20 7773 2e6e 7468 7265 6164 730a  s = ws.nthreads.
-00018d50: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00018d60: 0a20 2020 2020 2020 2020 2020 206e 7072  .            npr
-00018d70: 6f63 6573 7369 6e67 203c 206e 7468 7265  ocessing < nthre
-00018d80: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-00018d90: 6f72 206f 6363 7570 616e 6379 203c 206e  or occupancy < n
-00018da0: 7468 7265 6164 7320 2a20 2873 656c 662e  threads * (self.
-00018db0: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
-00018dc0: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
-00018dd0: 7265 6164 7329 202f 2032 0a20 2020 2020  reads) / 2.     
-00018de0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
-00018df0: 745f 636f 6d6d 5f63 6f73 7428 7365 6c66  t_comm_cost(self
-00018e00: 2c20 7473 3a20 5461 736b 5374 6174 652c  , ts: TaskState,
-00018e10: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
-00018e20: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
-00018e30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00018e40: 4765 7420 7468 6520 6573 7469 6d61 7465  Get the estimate
-00018e50: 6420 636f 6d6d 756e 6963 6174 696f 6e20  d communication 
-00018e60: 636f 7374 2028 696e 2073 2e29 2074 6f20  cost (in s.) to 
-00018e70: 636f 6d70 7574 6520 7468 6520 7461 736b  compute the task
-00018e80: 0a20 2020 2020 2020 206f 6e20 7468 6520  .        on the 
-00018e90: 6769 7665 6e20 776f 726b 6572 2e0a 2020  given worker..  
-00018ea0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00018eb0: 2020 6966 2031 3020 2a20 6c65 6e28 7473    if 10 * len(ts
-00018ec0: 2e64 6570 656e 6465 6e63 6965 7329 203c  .dependencies) <
-00018ed0: 206c 656e 2877 732e 6861 735f 7768 6174   len(ws.has_what
-00018ee0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-00018ef0: 2049 6e20 7468 6520 636f 6d6d 6f6e 2063   In the common c
-00018f00: 6173 6520 7768 6572 6520 7468 6520 6e75  ase where the nu
-00018f10: 6d62 6572 206f 6620 6465 7065 6e64 656e  mber of dependen
-00018f20: 6369 6573 2069 730a 2020 2020 2020 2020  cies is.        
-00018f30: 2020 2020 2320 6d75 6368 206c 6573 7320      # much less 
-00018f40: 7468 616e 2074 6865 206e 756d 6265 7220  than the number 
-00018f50: 6f66 2074 6173 6b73 2074 6861 7420 7765  of tasks that we
-00018f60: 2068 6176 652c 0a20 2020 2020 2020 2020   have,.         
-00018f70: 2020 2023 2063 6f6e 7374 7275 6374 2074     # construct t
-00018f80: 6865 2073 6574 206f 6620 6465 7073 2074  he set of deps t
-00018f90: 6861 7420 7265 7175 6972 6520 636f 6d6d  hat require comm
-00018fa0: 756e 6963 6174 696f 6e20 696e 0a20 2020  unication in.   
-00018fb0: 2020 2020 2020 2020 2023 204f 286c 656e           # O(len
-00018fc0: 2864 6570 656e 6465 6e63 6965 7329 2920  (dependencies)) 
-00018fd0: 7261 7468 6572 2074 6861 6e20 4f28 6c65  rather than O(le
-00018fe0: 6e28 6861 735f 7768 6174 2929 2074 696d  n(has_what)) tim
-00018ff0: 652e 0a20 2020 2020 2020 2020 2020 2023  e..            #
-00019000: 2046 6163 746f 7220 6f66 2031 3020 6973   Factor of 10 is
-00019010: 2061 2067 7565 7373 2061 7420 7468 6520   a guess at the 
-00019020: 6f76 6572 6865 6164 206f 6620 6578 706c  overhead of expl
-00019030: 6963 6974 0a20 2020 2020 2020 2020 2020  icit.           
-00019040: 2023 2069 7465 7261 7469 6f6e 2061 7320   # iteration as 
-00019050: 6f70 706f 7365 6420 746f 206a 7573 7420  opposed to just 
-00019060: 6361 6c6c 696e 6720 7365 742e 6469 6666  calling set.diff
-00019070: 6572 656e 6365 0a20 2020 2020 2020 2020  erence.         
-00019080: 2020 2064 6570 7320 3d20 7b64 6570 2066     deps = {dep f
-00019090: 6f72 2064 6570 2069 6e20 7473 2e64 6570  or dep in ts.dep
-000190a0: 656e 6465 6e63 6965 7320 6966 2064 6570  endencies if dep
-000190b0: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
-000190c0: 6861 747d 0a20 2020 2020 2020 2065 6c73  hat}.        els
-000190d0: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
-000190e0: 6570 7320 3d20 7473 2e64 6570 656e 6465  eps = ts.depende
-000190f0: 6e63 6965 732e 6469 6666 6572 656e 6365  ncies.difference
-00019100: 2877 732e 6861 735f 7768 6174 290a 2020  (ws.has_what).  
-00019110: 2020 2020 2020 6e62 7974 6573 203d 2073        nbytes = s
-00019120: 756d 2864 7473 2e6e 6279 7465 7320 666f  um(dts.nbytes fo
-00019130: 7220 6474 7320 696e 2064 6570 7329 0a20  r dts in deps). 
-00019140: 2020 2020 2020 2072 6574 7572 6e20 6e62         return nb
-00019150: 7974 6573 202f 2073 656c 662e 6261 6e64  ytes / self.band
-00019160: 7769 6474 680a 0a20 2020 2064 6566 2067  width..    def g
-00019170: 6574 5f74 6173 6b5f 6475 7261 7469 6f6e  et_task_duration
-00019180: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-00019190: 7461 7465 2920 2d3e 2066 6c6f 6174 3a0a  tate) -> float:.
-000191a0: 2020 2020 2020 2020 2222 2247 6574 2074          """Get t
-000191b0: 6865 2065 7374 696d 6174 6564 2063 6f6d  he estimated com
-000191c0: 7075 7461 7469 6f6e 2063 6f73 7420 6f66  putation cost of
-000191d0: 2074 6865 2067 6976 656e 2074 6173 6b20   the given task 
-000191e0: 286e 6f74 2069 6e63 6c75 6469 6e67 0a20  (not including. 
-000191f0: 2020 2020 2020 2061 6e79 2063 6f6d 6d75         any commu
-00019200: 6e69 6361 7469 6f6e 2063 6f73 7429 2e0a  nication cost)..
-00019210: 0a20 2020 2020 2020 2049 6620 6e6f 2064  .        If no d
-00019220: 6174 6120 6861 7320 6265 656e 206f 6273  ata has been obs
-00019230: 6572 7665 642c 2076 616c 7565 206f 660a  erved, value of.
-00019240: 2020 2020 2020 2020 6064 6973 7472 6962          `distrib
-00019250: 7574 6564 2e73 6368 6564 756c 6572 2e64  uted.scheduler.d
-00019260: 6566 6175 6c74 2d74 6173 6b2d 6475 7261  efault-task-dura
-00019270: 7469 6f6e 7360 2061 7265 2075 7365 642e  tions` are used.
-00019280: 2049 6620 6e6f 6e65 2069 7320 7365 740a   If none is set.
-00019290: 2020 2020 2020 2020 666f 7220 7468 6973          for this
-000192a0: 2074 6173 6b2c 2060 6469 7374 7269 6275   task, `distribu
-000192b0: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
-000192c0: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
-000192d0: 696f 6e60 2069 7320 7573 6564 0a20 2020  ion` is used.   
-000192e0: 2020 2020 2069 6e73 7465 6164 2e0a 2020       instead..  
-000192f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00019300: 2020 6475 7261 7469 6f6e 3a20 666c 6f61    duration: floa
-00019310: 7420 3d20 7473 2e70 7265 6669 782e 6475  t = ts.prefix.du
-00019320: 7261 7469 6f6e 5f61 7665 7261 6765 0a20  ration_average. 
-00019330: 2020 2020 2020 2069 6620 6475 7261 7469         if durati
-00019340: 6f6e 203e 3d20 303a 0a20 2020 2020 2020  on >= 0:.       
-00019350: 2020 2020 2072 6574 7572 6e20 6475 7261       return dura
-00019360: 7469 6f6e 0a0a 2020 2020 2020 2020 7320  tion..        s 
-00019370: 3d20 7365 6c66 2e75 6e6b 6e6f 776e 5f64  = self.unknown_d
-00019380: 7572 6174 696f 6e73 2e67 6574 2874 732e  urations.get(ts.
-00019390: 7072 6566 6978 2e6e 616d 6529 0a20 2020  prefix.name).   
-000193a0: 2020 2020 2069 6620 7320 6973 204e 6f6e       if s is Non
-000193b0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000193c0: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
-000193d0: 7469 6f6e 735b 7473 2e70 7265 6669 782e  tions[ts.prefix.
-000193e0: 6e61 6d65 5d20 3d20 7320 3d20 7365 7428  name] = s = set(
-000193f0: 290a 2020 2020 2020 2020 732e 6164 6428  ).        s.add(
-00019400: 7473 290a 2020 2020 2020 2020 7265 7475  ts).        retu
-00019410: 726e 2073 656c 662e 554e 4b4e 4f57 4e5f  rn self.UNKNOWN_
-00019420: 5441 534b 5f44 5552 4154 494f 4e0a 0a20  TASK_DURATION.. 
-00019430: 2020 2064 6566 2076 616c 6964 5f77 6f72     def valid_wor
-00019440: 6b65 7273 2873 656c 662c 2074 733a 2054  kers(self, ts: T
-00019450: 6173 6b53 7461 7465 2920 2d3e 2073 6574  askState) -> set
-00019460: 5b57 6f72 6b65 7253 7461 7465 5d20 7c20  [WorkerState] | 
-00019470: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00019480: 2252 6574 7572 6e20 7365 7420 6f66 2063  "Return set of c
-00019490: 7572 7265 6e74 6c79 2076 616c 6964 2077  urrently valid w
-000194a0: 6f72 6b65 7273 2066 6f72 206b 6579 0a0a  orkers for key..
-000194b0: 2020 2020 2020 2020 4966 2061 6c6c 2077          If all w
-000194c0: 6f72 6b65 7273 2061 7265 2076 616c 6964  orkers are valid
-000194d0: 2074 6865 6e20 7468 6973 2072 6574 7572   then this retur
-000194e0: 6e73 2060 604e 6f6e 6560 602c 2069 6e20  ns ``None``, in 
-000194f0: 7768 6963 6820 6361 7365 0a20 2020 2020  which case.     
-00019500: 2020 2061 6e79 202a 7275 6e6e 696e 672a     any *running*
-00019510: 2077 6f72 6b65 7220 6361 6e20 6265 2075   worker can be u
-00019520: 7365 642e 0a20 2020 2020 2020 204f 7468  sed..        Oth
-00019530: 6572 7769 7365 2c20 7468 6520 7375 6273  erwise, the subs
-00019540: 6574 206f 6620 7275 6e6e 696e 6720 776f  et of running wo
-00019550: 726b 6572 7320 7661 6c69 6420 666f 7220  rkers valid for 
-00019560: 7468 6973 2074 6173 6b0a 2020 2020 2020  this task.      
-00019570: 2020 6973 2072 6574 7572 6e65 642e 0a20    is returned.. 
-00019580: 2020 2020 2020 2054 6869 7320 6368 6563         This chec
-00019590: 6b73 2074 7261 636b 7320 7468 6520 666f  ks tracks the fo
-000195a0: 6c6c 6f77 696e 6720 7374 6174 653a 0a0a  llowing state:..
-000195b0: 2020 2020 2020 2020 2a20 2077 6f72 6b65          *  worke
-000195c0: 725f 7265 7374 7269 6374 696f 6e73 0a20  r_restrictions. 
-000195d0: 2020 2020 2020 202a 2020 686f 7374 5f72         *  host_r
-000195e0: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
-000195f0: 2020 2020 2a20 2072 6573 6f75 7263 655f      *  resource_
-00019600: 7265 7374 7269 6374 696f 6e73 0a20 2020  restrictions.   
-00019610: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00019620: 2073 3a20 7365 745b 7374 725d 207c 204e   s: set[str] | N
-00019630: 6f6e 6520 3d20 4e6f 6e65 0a0a 2020 2020  one = None..    
-00019640: 2020 2020 6966 2074 732e 776f 726b 6572      if ts.worker
-00019650: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
-00019660: 2020 2020 2020 2020 2020 2073 203d 207b             s = {
-00019670: 6164 6472 2066 6f72 2061 6464 7220 696e  addr for addr in
-00019680: 2074 732e 776f 726b 6572 5f72 6573 7472   ts.worker_restr
-00019690: 6963 7469 6f6e 7320 6966 2061 6464 7220  ictions if addr 
-000196a0: 696e 2073 656c 662e 776f 726b 6572 737d  in self.workers}
-000196b0: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
-000196c0: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
-000196d0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-000196e0: 2052 6573 6f6c 7665 2074 6865 2061 6c69   Resolve the ali
-000196f0: 6173 2068 6572 6520 7261 7468 6572 2074  as here rather t
-00019700: 6861 6e20 6561 726c 792c 2066 6f72 2074  han early, for t
-00019710: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
-00019720: 2020 2020 2020 2320 6d61 7920 6e6f 7420        # may not 
-00019730: 6265 2063 6f6e 6e65 6374 6564 2077 6865  be connected whe
-00019740: 6e20 686f 7374 5f72 6573 7472 6963 7469  n host_restricti
-00019750: 6f6e 7320 6973 2070 6f70 756c 6174 6564  ons is populated
-00019760: 0a20 2020 2020 2020 2020 2020 2068 7220  .            hr 
-00019770: 3d20 5b73 656c 662e 636f 6572 6365 5f68  = [self.coerce_h
-00019780: 6f73 746e 616d 6528 6829 2066 6f72 2068  ostname(h) for h
-00019790: 2069 6e20 7473 2e68 6f73 745f 7265 7374   in ts.host_rest
-000197a0: 7269 6374 696f 6e73 5d0a 2020 2020 2020  rictions].      
-000197b0: 2020 2020 2020 2320 5858 5820 6e65 6564        # XXX need
-000197c0: 2048 6f73 7453 7461 7465 3f0a 2020 2020   HostState?.    
-000197d0: 2020 2020 2020 2020 736c 203d 205b 5d0a          sl = [].
-000197e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000197f0: 6820 696e 2068 723a 0a20 2020 2020 2020  h in hr:.       
-00019800: 2020 2020 2020 2020 2064 6820 3d20 7365           dh = se
-00019810: 6c66 2e68 6f73 745f 696e 666f 2e67 6574  lf.host_info.get
-00019820: 2868 290a 2020 2020 2020 2020 2020 2020  (h).            
-00019830: 2020 2020 6966 2064 6820 6973 206e 6f74      if dh is not
-00019840: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00019850: 2020 2020 2020 2020 2020 2073 6c2e 6170             sl.ap
-00019860: 7065 6e64 2864 685b 2261 6464 7265 7373  pend(dh["address
-00019870: 6573 225d 290a 0a20 2020 2020 2020 2020  es"])..         
-00019880: 2020 2073 7320 3d20 7365 742e 756e 696f     ss = set.unio
-00019890: 6e28 2a73 6c29 2069 6620 736c 2065 6c73  n(*sl) if sl els
-000198a0: 6520 7365 7428 290a 2020 2020 2020 2020  e set().        
-000198b0: 2020 2020 6966 2073 2069 7320 4e6f 6e65      if s is None
-000198c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000198d0: 2020 7320 3d20 7373 0a20 2020 2020 2020    s = ss.       
-000198e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000198f0: 2020 2020 2020 2020 2020 2073 207c 3d20             s |= 
-00019900: 7373 0a0a 2020 2020 2020 2020 6966 2074  ss..        if t
-00019910: 732e 7265 736f 7572 6365 5f72 6573 7472  s.resource_restr
-00019920: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
-00019930: 2020 2020 2064 7720 3d20 7b7d 0a20 2020       dw = {}.   
-00019940: 2020 2020 2020 2020 2066 6f72 2072 6573           for res
-00019950: 6f75 7263 652c 2072 6571 7569 7265 6420  ource, required 
-00019960: 696e 2074 732e 7265 736f 7572 6365 5f72  in ts.resource_r
-00019970: 6573 7472 6963 7469 6f6e 732e 6974 656d  estrictions.item
-00019980: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00019990: 2020 2020 2064 7220 3d20 7365 6c66 2e72       dr = self.r
-000199a0: 6573 6f75 7263 6573 2e67 6574 2872 6573  esources.get(res
-000199b0: 6f75 7263 6529 0a20 2020 2020 2020 2020  ource).         
-000199c0: 2020 2020 2020 2069 6620 6472 2069 7320         if dr is 
-000199d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000199e0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000199f0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
-00019a00: 655d 203d 2064 7220 3d20 7b7d 0a0a 2020  e] = dr = {}..  
-00019a10: 2020 2020 2020 2020 2020 2020 2020 7377                sw
-00019a20: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00019a30: 2020 2020 2020 2020 2066 6f72 2061 6464           for add
-00019a40: 722c 2073 7570 706c 6965 6420 696e 2064  r, supplied in d
-00019a50: 722e 6974 656d 7328 293a 0a20 2020 2020  r.items():.     
-00019a60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00019a70: 6620 7375 7070 6c69 6564 203e 3d20 7265  f supplied >= re
-00019a80: 7175 6972 6564 3a0a 2020 2020 2020 2020  quired:.        
-00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019aa0: 7377 2e61 6464 2861 6464 7229 0a0a 2020  sw.add(addr)..  
-00019ab0: 2020 2020 2020 2020 2020 2020 2020 6477                dw
-00019ac0: 5b72 6573 6f75 7263 655d 203d 2073 770a  [resource] = sw.
-00019ad0: 0a20 2020 2020 2020 2020 2020 2077 7720  .            ww 
-00019ae0: 3d20 7365 742e 696e 7465 7273 6563 7469  = set.intersecti
-00019af0: 6f6e 282a 6477 2e76 616c 7565 7328 2929  on(*dw.values())
-00019b00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00019b10: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00019b20: 2020 2020 2020 2020 2020 2073 203d 2077             s = w
-00019b30: 770a 2020 2020 2020 2020 2020 2020 656c  w.            el
-00019b40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00019b50: 2020 2020 7320 263d 2077 770a 0a20 2020      s &= ww..   
-00019b60: 2020 2020 2069 6620 7320 6973 204e 6f6e       if s is Non
-00019b70: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00019b80: 6574 7572 6e20 4e6f 6e65 2020 2320 416c  eturn None  # Al
-00019b90: 6c20 776f 726b 6572 7320 6172 6520 7661  l workers are va
-00019ba0: 6c69 640a 2020 2020 2020 2020 6966 206e  lid.        if n
-00019bb0: 6f74 2073 3a0a 2020 2020 2020 2020 2020  ot s:.          
-00019bc0: 2020 7265 7475 726e 2073 6574 2829 2020    return set()  
-00019bd0: 2320 4e6f 2077 6f72 6b65 7273 2061 7265  # No workers are
-00019be0: 2076 616c 6964 0a0a 2020 2020 2020 2020   valid..        
-00019bf0: 2320 536f 6d65 2077 6f72 6b65 7273 2061  # Some workers a
-00019c00: 7265 2076 616c 6964 0a20 2020 2020 2020  re valid.       
-00019c10: 2073 5f77 7320 3d20 7b73 656c 662e 776f   s_ws = {self.wo
-00019c20: 726b 6572 735b 6164 6472 5d20 666f 7220  rkers[addr] for 
-00019c30: 6164 6472 2069 6e20 737d 0a20 2020 2020  addr in s}.     
-00019c40: 2020 2069 6620 6c65 6e28 7365 6c66 2e72     if len(self.r
-00019c50: 756e 6e69 6e67 2920 3c20 6c65 6e28 7365  unning) < len(se
-00019c60: 6c66 2e77 6f72 6b65 7273 293a 0a20 2020  lf.workers):.   
-00019c70: 2020 2020 2020 2020 2073 5f77 7320 263d           s_ws &=
-00019c80: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
-00019c90: 2020 2020 2020 7265 7475 726e 2073 5f77        return s_w
-00019ca0: 730a 0a20 2020 2064 6566 2061 6371 7569  s..    def acqui
-00019cb0: 7265 5f72 6573 6f75 7263 6573 2873 656c  re_resources(sel
-00019cc0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-00019cd0: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
-00019ce0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-00019cf0: 2020 2020 666f 7220 722c 2072 6571 7569      for r, requi
-00019d00: 7265 6420 696e 2074 732e 7265 736f 7572  red in ts.resour
-00019d10: 6365 5f72 6573 7472 6963 7469 6f6e 732e  ce_restrictions.
-00019d20: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00019d30: 2020 2020 2077 732e 7573 6564 5f72 6573       ws.used_res
-00019d40: 6f75 7263 6573 5b72 5d20 2b3d 2072 6571  ources[r] += req
-00019d50: 7569 7265 640a 0a20 2020 2064 6566 2072  uired..    def r
-00019d60: 656c 6561 7365 5f72 6573 6f75 7263 6573  elease_resources
-00019d70: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-00019d80: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
-00019d90: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00019da0: 2020 2020 2020 2020 666f 7220 722c 2072          for r, r
-00019db0: 6571 7569 7265 6420 696e 2074 732e 7265  equired in ts.re
-00019dc0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
-00019dd0: 6f6e 732e 6974 656d 7328 293a 0a20 2020  ons.items():.   
-00019de0: 2020 2020 2020 2020 2077 732e 7573 6564           ws.used
-00019df0: 5f72 6573 6f75 7263 6573 5b72 5d20 2d3d  _resources[r] -=
-00019e00: 2072 6571 7569 7265 640a 0a20 2020 2064   required..    d
-00019e10: 6566 2063 6f65 7263 655f 686f 7374 6e61  ef coerce_hostna
-00019e20: 6d65 2873 656c 662c 2068 6f73 743a 2048  me(self, host: H
-00019e30: 6173 6861 626c 6529 202d 3e20 7374 723a  ashable) -> str:
-00019e40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00019e50: 2020 2020 2043 6f65 7263 6520 7468 6520       Coerce the 
-00019e60: 686f 7374 6e61 6d65 206f 6620 6120 776f  hostname of a wo
-00019e70: 726b 6572 2e0a 2020 2020 2020 2020 2222  rker..        ""
-00019e80: 220a 2020 2020 2020 2020 616c 6961 7320  ".        alias 
-00019e90: 3d20 7365 6c66 2e61 6c69 6173 6573 2e67  = self.aliases.g
-00019ea0: 6574 2868 6f73 7429 0a20 2020 2020 2020  et(host).       
-00019eb0: 2069 6620 616c 6961 7320 6973 206e 6f74   if alias is not
-00019ec0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00019ed0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
-00019ee0: 6b65 7273 5b61 6c69 6173 5d0a 2020 2020  kers[alias].    
-00019ef0: 2020 2020 2020 2020 7265 7475 726e 2077          return w
-00019f00: 732e 686f 7374 0a20 2020 2020 2020 2065  s.host.        e
-00019f10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019f20: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00019f30: 6365 2868 6f73 742c 2073 7472 290a 2020  ce(host, str).  
-00019f40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00019f50: 2068 6f73 740a 0a20 2020 2064 6566 2077   host..    def w
-00019f60: 6f72 6b65 725f 6f62 6a65 6374 6976 6528  orker_objective(
-00019f70: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-00019f80: 6174 652c 2077 733a 2057 6f72 6b65 7253  ate, ws: WorkerS
-00019f90: 7461 7465 2920 2d3e 2074 7570 6c65 3a0a  tate) -> tuple:.
-00019fa0: 2020 2020 2020 2020 2222 224f 626a 6563          """Objec
-00019fb0: 7469 7665 2066 756e 6374 696f 6e20 746f  tive function to
-00019fc0: 2064 6574 6572 6d69 6e65 2077 6869 6368   determine which
-00019fd0: 2077 6f72 6b65 7220 7368 6f75 6c64 2067   worker should g
-00019fe0: 6574 2074 6865 2074 6173 6b0a 0a20 2020  et the task..   
-00019ff0: 2020 2020 204d 696e 696d 697a 6520 6578       Minimize ex
-0001a000: 7065 6374 6564 2073 7461 7274 2074 696d  pected start tim
-0001a010: 652e 2020 4966 2061 2074 6965 2074 6865  e.  If a tie the
-0001a020: 6e20 6272 6561 6b20 7769 7468 2064 6174  n break with dat
-0001a030: 6120 7374 6f72 6167 652e 0a20 2020 2020  a storage..     
-0001a040: 2020 2022 2222 0a20 2020 2020 2020 2063     """.        c
-0001a050: 6f6d 6d5f 6279 7465 7320 3d20 7375 6d28  omm_bytes = sum(
-0001a060: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
-0001a070: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
-0001a080: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0001a090: 6e64 656e 6369 6573 2069 6620 7773 206e  ndencies if ws n
-0001a0a0: 6f74 2069 6e20 6474 732e 7768 6f5f 6861  ot in dts.who_ha
-0001a0b0: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
-0001a0c0: 2020 2020 2073 7461 636b 5f74 696d 6520       stack_time 
-0001a0d0: 3d20 7773 2e6f 6363 7570 616e 6379 202f  = ws.occupancy /
-0001a0e0: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
-0001a0f0: 2020 2020 2073 7461 7274 5f74 696d 6520       start_time 
-0001a100: 3d20 7374 6163 6b5f 7469 6d65 202b 2063  = stack_time + c
-0001a110: 6f6d 6d5f 6279 7465 7320 2f20 7365 6c66  omm_bytes / self
-0001a120: 2e62 616e 6477 6964 7468 0a0a 2020 2020  .bandwidth..    
-0001a130: 2020 2020 6966 2074 732e 6163 746f 723a      if ts.actor:
-0001a140: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a150: 7572 6e20 286c 656e 2877 732e 6163 746f  urn (len(ws.acto
-0001a160: 7273 292c 2073 7461 7274 5f74 696d 652c  rs), start_time,
-0001a170: 2077 732e 6e62 7974 6573 290a 2020 2020   ws.nbytes).    
-0001a180: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001a190: 2020 2020 2020 7265 7475 726e 2028 7374        return (st
-0001a1a0: 6172 745f 7469 6d65 2c20 7773 2e6e 6279  art_time, ws.nby
-0001a1b0: 7465 7329 0a0a 2020 2020 6465 6620 6164  tes)..    def ad
-0001a1c0: 645f 7265 706c 6963 6128 7365 6c66 2c20  d_replica(self, 
-0001a1d0: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
-0001a1e0: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
-0001a1f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0001a200: 2022 2222 4e6f 7465 2074 6861 7420 6120   """Note that a 
-0001a210: 776f 726b 6572 2068 6f6c 6473 2061 2072  worker holds a r
-0001a220: 6570 6c69 6361 206f 6620 6120 7461 736b  eplica of a task
-0001a230: 2077 6974 6820 7374 6174 653d 276d 656d   with state='mem
-0001a240: 6f72 7927 2222 220a 2020 2020 2020 2020  ory'""".        
-0001a250: 7773 2e61 6464 5f72 6570 6c69 6361 2874  ws.add_replica(t
-0001a260: 7329 0a20 2020 2020 2020 2069 6620 6c65  s).        if le
-0001a270: 6e28 7473 2e77 686f 5f68 6173 2920 3d3d  n(ts.who_has) ==
-0001a280: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-0001a290: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
-0001a2a0: 7461 736b 732e 6164 6428 7473 290a 0a20  tasks.add(ts).. 
-0001a2b0: 2020 2064 6566 2072 656d 6f76 655f 7265     def remove_re
-0001a2c0: 706c 6963 6128 7365 6c66 2c20 7473 3a20  plica(self, ts: 
-0001a2d0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
-0001a2e0: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
-0001a2f0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0001a300: 4e6f 7465 2074 6861 7420 6120 776f 726b  Note that a work
-0001a310: 6572 206e 6f20 6c6f 6e67 6572 2068 6f6c  er no longer hol
-0001a320: 6473 2061 2072 6570 6c69 6361 206f 6620  ds a replica of 
-0001a330: 6120 7461 736b 2222 220a 2020 2020 2020  a task""".      
-0001a340: 2020 7773 2e72 656d 6f76 655f 7265 706c    ws.remove_repl
-0001a350: 6963 6128 7473 290a 2020 2020 2020 2020  ica(ts).        
-0001a360: 6966 206c 656e 2874 732e 7768 6f5f 6861  if len(ts.who_ha
-0001a370: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
-0001a380: 2020 2020 2073 656c 662e 7265 706c 6963       self.replic
-0001a390: 6174 6564 5f74 6173 6b73 2e72 656d 6f76  ated_tasks.remov
-0001a3a0: 6528 7473 290a 0a20 2020 2064 6566 2072  e(ts)..    def r
-0001a3b0: 656d 6f76 655f 616c 6c5f 7265 706c 6963  emove_all_replic
-0001a3c0: 6173 2873 656c 662c 2074 733a 2054 6173  as(self, ts: Tas
-0001a3d0: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
-0001a3e0: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
-0001a3f0: 7665 2061 6c6c 2072 6570 6c69 6361 7320  ve all replicas 
-0001a400: 6f66 2061 2074 6173 6b20 6672 6f6d 2061  of a task from a
-0001a410: 6c6c 2077 6f72 6b65 7273 2222 220a 2020  ll workers""".  
-0001a420: 2020 2020 2020 6e62 7974 6573 203d 2074        nbytes = t
-0001a430: 732e 6765 745f 6e62 7974 6573 2829 0a20  s.get_nbytes(). 
-0001a440: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
-0001a450: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
-0001a460: 2020 2020 2020 2020 2077 732e 6e62 7974           ws.nbyt
-0001a470: 6573 202d 3d20 6e62 7974 6573 0a20 2020  es -= nbytes.   
-0001a480: 2020 2020 2020 2020 2064 656c 2077 732e           del ws.
-0001a490: 5f68 6173 5f77 6861 745b 7473 5d0a 2020  _has_what[ts].  
-0001a4a0: 2020 2020 2020 6966 206c 656e 2874 732e        if len(ts.
-0001a4b0: 7768 6f5f 6861 7329 203e 2031 3a0a 2020  who_has) > 1:.  
-0001a4c0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-0001a4d0: 6570 6c69 6361 7465 645f 7461 736b 732e  eplicated_tasks.
-0001a4e0: 7265 6d6f 7665 2874 7329 0a20 2020 2020  remove(ts).     
-0001a4f0: 2020 2074 732e 7768 6f5f 6861 732e 636c     ts.who_has.cl
-0001a500: 6561 7228 290a 0a20 2020 2064 6566 2062  ear()..    def b
-0001a510: 756c 6b5f 7363 6865 6475 6c65 5f75 6e72  ulk_schedule_unr
-0001a520: 756e 6e61 626c 655f 6166 7465 725f 6164  unnable_after_ad
-0001a530: 6469 6e67 5f77 6f72 6b65 7228 7365 6c66  ding_worker(self
-0001a540: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
-0001a550: 6529 202d 3e20 5265 6373 3a0a 2020 2020  e) -> Recs:.    
-0001a560: 2020 2020 2222 2253 656e 6420 6060 6e6f      """Send ``no
-0001a570: 2d77 6f72 6b65 7260 6020 7461 736b 7320  -worker`` tasks 
-0001a580: 746f 2060 6070 726f 6365 7373 696e 6760  to ``processing`
-0001a590: 6020 7468 6174 2074 6869 7320 776f 726b  ` that this work
-0001a5a0: 6572 2063 616e 2068 616e 646c 652e 0a0a  er can handle...
-0001a5b0: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
-0001a5c0: 7072 696f 7269 7479 2d6f 7264 6572 6564  priority-ordered
-0001a5d0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001a5e0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0001a5f0: 2020 2020 2020 7275 6e6e 6162 6c65 3a20        runnable: 
-0001a600: 6c69 7374 5b54 6173 6b53 7461 7465 5d20  list[TaskState] 
-0001a610: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0001a620: 2074 7320 696e 2073 656c 662e 756e 7275   ts in self.unru
-0001a630: 6e6e 6162 6c65 3a0a 2020 2020 2020 2020  nnable:.        
-0001a640: 2020 2020 7661 6c69 6420 3d20 7365 6c66      valid = self
-0001a650: 2e76 616c 6964 5f77 6f72 6b65 7273 2874  .valid_workers(t
-0001a660: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0001a670: 6620 7661 6c69 6420 6973 204e 6f6e 6520  f valid is None 
-0001a680: 6f72 2077 7320 696e 2076 616c 6964 3a0a  or ws in valid:.
-0001a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6a0: 7275 6e6e 6162 6c65 2e61 7070 656e 6428  runnable.append(
-0001a6b0: 7473 290a 0a20 2020 2020 2020 2023 2052  ts)..        # R
-0001a6c0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2061  ecommendations a
-0001a6d0: 7265 2070 726f 6365 7373 6564 204c 4946  re processed LIF
-0001a6e0: 4f2c 2068 656e 6365 2074 6865 2072 6576  O, hence the rev
-0001a6f0: 6572 7365 6420 6f72 6465 720a 2020 2020  ersed order.    
-0001a700: 2020 2020 7275 6e6e 6162 6c65 2e73 6f72      runnable.sor
-0001a710: 7428 6b65 793d 6f70 6572 6174 6f72 2e61  t(key=operator.a
-0001a720: 7474 7267 6574 7465 7228 2270 7269 6f72  ttrgetter("prior
-0001a730: 6974 7922 292c 2072 6576 6572 7365 3d54  ity"), reverse=T
-0001a740: 7275 6529 0a20 2020 2020 2020 2072 6574  rue).        ret
-0001a750: 7572 6e20 7b74 732e 6b65 793a 2022 7072  urn {ts.key: "pr
-0001a760: 6f63 6573 7369 6e67 2220 666f 7220 7473  ocessing" for ts
-0001a770: 2069 6e20 7275 6e6e 6162 6c65 7d0a 0a20   in runnable}.. 
-0001a780: 2020 2064 6566 205f 7661 6c69 6461 7465     def _validate
-0001a790: 5f72 6561 6479 2873 656c 662c 2074 733a  _ready(self, ts:
-0001a7a0: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-0001a7b0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0001a7c0: 5661 6c69 6461 7469 6f6e 2066 6f72 2072  Validation for r
-0001a7d0: 6561 6479 2073 7461 7465 7320 2870 726f  eady states (pro
-0001a7e0: 6365 7373 696e 672c 2071 7565 7565 642c  cessing, queued,
-0001a7f0: 206e 6f2d 776f 726b 6572 2922 2222 0a20   no-worker)""". 
-0001a800: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0001a810: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-0001a820: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0001a830: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-0001a840: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0001a850: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
-0001a860: 616d 650a 2020 2020 2020 2020 6173 7365  ame.        asse
-0001a870: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
-0001a880: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0001a890: 6173 7365 7274 206e 6f74 2074 732e 6861  assert not ts.ha
-0001a8a0: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
-0001a8b0: 6965 730a 2020 2020 2020 2020 6173 7365  ies.        asse
-0001a8c0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
-0001a8d0: 662e 756e 7275 6e6e 6162 6c65 0a20 2020  f.unrunnable.   
-0001a8e0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-0001a8f0: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
-0001a900: 640a 2020 2020 2020 2020 6173 7365 7274  d.        assert
-0001a910: 2061 6c6c 2864 7473 2e77 686f 5f68 6173   all(dts.who_has
-0001a920: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-0001a930: 6570 656e 6465 6e63 6965 7329 0a0a 2020  ependencies)..  
-0001a940: 2020 6465 6620 5f61 6464 5f74 6f5f 7072    def _add_to_pr
-0001a950: 6f63 6573 7369 6e67 2873 656c 662c 2074  ocessing(self, t
-0001a960: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
-0001a970: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
-0001a980: 3e20 4d73 6773 3a0a 2020 2020 2020 2020  > Msgs:.        
-0001a990: 2222 2253 6574 2061 2074 6173 6b20 6173  """Set a task as
-0001a9a0: 2070 726f 6365 7373 696e 6720 6f6e 2061   processing on a
-0001a9b0: 2077 6f72 6b65 7220 616e 6420 7265 7475   worker and retu
-0001a9c0: 726e 2074 6865 2077 6f72 6b65 7220 6d65  rn the worker me
-0001a9d0: 7373 6167 6573 2074 6f20 7365 6e64 2222  ssages to send""
-0001a9e0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-0001a9f0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-0001aa00: 2020 2020 2020 2020 7365 6c66 2e5f 7661          self._va
-0001aa10: 6c69 6461 7465 5f72 6561 6479 2874 7329  lidate_ready(ts)
-0001aa20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001aa30: 6572 7420 7773 2069 6e20 7365 6c66 2e72  ert ws in self.r
-0001aa40: 756e 6e69 6e67 2c20 7365 6c66 2e72 756e  unning, self.run
-0001aa50: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
-0001aa60: 2061 7373 6572 7420 286f 203a 3d20 7365   assert (o := se
-0001aa70: 6c66 2e77 6f72 6b65 7273 2e67 6574 2877  lf.workers.get(w
-0001aa80: 732e 6164 6472 6573 7329 2920 6973 2077  s.address)) is w
-0001aa90: 732c 2028 7773 2c20 6f29 0a0a 2020 2020  s, (ws, o)..    
-0001aaa0: 2020 2020 7773 2e61 6464 5f74 6f5f 7072      ws.add_to_pr
-0001aab0: 6f63 6573 7369 6e67 2874 7329 0a20 2020  ocessing(ts).   
-0001aac0: 2020 2020 2074 732e 7072 6f63 6573 7369       ts.processi
-0001aad0: 6e67 5f6f 6e20 3d20 7773 0a20 2020 2020  ng_on = ws.     
-0001aae0: 2020 2074 732e 7374 6174 6520 3d20 2270     ts.state = "p
-0001aaf0: 726f 6365 7373 696e 6722 0a20 2020 2020  rocessing".     
-0001ab00: 2020 2073 656c 662e 6163 7175 6972 655f     self.acquire_
-0001ab10: 7265 736f 7572 6365 7328 7473 2c20 7773  resources(ts, ws
-0001ab20: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0001ab30: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
-0001ab40: 7465 6428 7773 290a 2020 2020 2020 2020  ted(ws).        
-0001ab50: 7365 6c66 2e6e 5f74 6173 6b73 202b 3d20  self.n_tasks += 
-0001ab60: 310a 0a20 2020 2020 2020 2069 6620 7473  1..        if ts
-0001ab70: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
-0001ab80: 2020 2020 7773 2e61 6374 6f72 732e 6164      ws.actors.ad
-0001ab90: 6428 7473 290a 0a20 2020 2020 2020 2072  d(ts)..        r
-0001aba0: 6574 7572 6e20 7b77 732e 6164 6472 6573  eturn {ws.addres
-0001abb0: 733a 205b 7365 6c66 2e5f 7461 736b 5f74  s: [self._task_t
-0001abc0: 6f5f 6d73 6728 7473 295d 7d0a 0a20 2020  o_msg(ts)]}..   
-0001abd0: 2064 6566 205f 6578 6974 5f70 726f 6365   def _exit_proce
-0001abe0: 7373 696e 675f 636f 6d6d 6f6e 2873 656c  ssing_common(sel
-0001abf0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-0001ac00: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
-0001ac10: 207c 204e 6f6e 653a 0a20 2020 2020 2020   | None:.       
-0001ac20: 2022 2222 5265 6d6f 7665 202a 7473 2a20   """Remove *ts* 
-0001ac30: 6672 6f6d 2074 6865 2073 6574 206f 6620  from the set of 
-0001ac40: 7072 6f63 6573 7369 6e67 2074 6173 6b73  processing tasks
-0001ac50: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-0001ac60: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
-0001ac70: 2d2d 0a20 2020 2020 2020 2057 6f72 6b65  --.        Worke
-0001ac80: 7220 7374 6174 6520 6f66 2074 6865 2077  r state of the w
-0001ac90: 6f72 6b65 7220 7468 6174 2070 726f 6365  orker that proce
-0001aca0: 7373 6564 202a 7473 2a20 6966 2074 6865  ssed *ts* if the
-0001acb0: 2077 6f72 6b65 7220 6973 2063 7572 7265   worker is curre
-0001acc0: 6e74 2c0a 2020 2020 2020 2020 4e6f 6e65  nt,.        None
-0001acd0: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
-0001ace0: 7320 7374 616c 652e 0a0a 2020 2020 2020  s stale...      
-0001acf0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-0001ad00: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-0001ad10: 2020 2020 5363 6865 6475 6c65 722e 5f73      Scheduler._s
-0001ad20: 6574 5f64 7572 6174 696f 6e5f 6573 7469  et_duration_esti
-0001ad30: 6d61 7465 0a20 2020 2020 2020 2022 2222  mate.        """
-0001ad40: 0a20 2020 2020 2020 2077 7320 3d20 7473  .        ws = ts
-0001ad50: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-0001ad60: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-0001ad70: 0a20 2020 2020 2020 2074 732e 7072 6f63  .        ts.proc
-0001ad80: 6573 7369 6e67 5f6f 6e20 3d20 4e6f 6e65  essing_on = None
-0001ad90: 0a0a 2020 2020 2020 2020 7773 2e72 656d  ..        ws.rem
-0001ada0: 6f76 655f 6672 6f6d 5f70 726f 6365 7373  ove_from_process
-0001adb0: 696e 6728 7473 290a 2020 2020 2020 2020  ing(ts).        
-0001adc0: 6966 2073 656c 662e 776f 726b 6572 732e  if self.workers.
-0001add0: 6765 7428 7773 2e61 6464 7265 7373 2920  get(ws.address) 
-0001ade0: 6973 206e 6f74 2077 733a 2020 2320 6d61  is not ws:  # ma
-0001adf0: 7920 6861 7665 2062 6565 6e20 7265 6d6f  y have been remo
-0001ae00: 7665 640a 2020 2020 2020 2020 2020 2020  ved.            
-0001ae10: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-0001ae20: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
-0001ae30: 6964 6c65 5f73 6174 7572 6174 6564 2877  idle_saturated(w
-0001ae40: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-0001ae50: 7265 6c65 6173 655f 7265 736f 7572 6365  release_resource
-0001ae60: 7328 7473 2c20 7773 290a 0a20 2020 2020  s(ts, ws)..     
-0001ae70: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
-0001ae80: 2020 6465 6620 5f61 6464 5f74 6f5f 6d65    def _add_to_me
-0001ae90: 6d6f 7279 280a 2020 2020 2020 2020 7365  mory(.        se
-0001aea0: 6c66 2c0a 2020 2020 2020 2020 7473 3a20  lf,.        ts: 
-0001aeb0: 5461 736b 5374 6174 652c 0a20 2020 2020  TaskState,.     
-0001aec0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
-0001aed0: 7465 2c0a 2020 2020 2020 2020 7265 636f  te,.        reco
-0001aee0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-0001aef0: 732c 0a20 2020 2020 2020 2063 6c69 656e  s,.        clien
-0001af00: 745f 6d73 6773 3a20 4d73 6773 2c0a 2020  t_msgs: Msgs,.  
-0001af10: 2020 2020 2020 7479 7065 3a20 6279 7465        type: byte
-0001af20: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
-0001af30: 0a20 2020 2020 2020 2074 7970 656e 616d  .        typenam
-0001af40: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
-0001af50: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 204e  None,.    ) -> N
-0001af60: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0001af70: 4164 6420 7473 2074 6f20 7468 6520 7365  Add ts to the se
-0001af80: 7420 6f66 2069 6e2d 6d65 6d6f 7279 2074  t of in-memory t
-0001af90: 6173 6b73 2222 220a 2020 2020 2020 2020  asks""".        
-0001afa0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-0001afb0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0001afc0: 7365 7274 2074 7320 6e6f 7420 696e 2077  sert ts not in w
-0001afd0: 732e 6861 735f 7768 6174 0a0a 2020 2020  s.has_what..    
-0001afe0: 2020 2020 7365 6c66 2e61 6464 5f72 6570      self.add_rep
-0001aff0: 6c69 6361 2874 732c 2077 7329 0a0a 2020  lica(ts, ws)..  
-0001b000: 2020 2020 2020 6465 7073 203d 206c 6973        deps = lis
-0001b010: 7428 7473 2e64 6570 656e 6465 6e74 7329  t(ts.dependents)
-0001b020: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0001b030: 6465 7073 2920 3e20 313a 0a20 2020 2020  deps) > 1:.     
-0001b040: 2020 2020 2020 2064 6570 732e 736f 7274         deps.sort
-0001b050: 286b 6579 3d6f 7065 7261 746f 722e 6174  (key=operator.at
-0001b060: 7472 6765 7474 6572 2822 7072 696f 7269  trgetter("priori
-0001b070: 7479 2229 2c20 7265 7665 7273 653d 5472  ty"), reverse=Tr
-0001b080: 7565 290a 0a20 2020 2020 2020 2066 6f72  ue)..        for
-0001b090: 2064 7473 2069 6e20 6465 7073 3a0a 2020   dts in deps:.  
-0001b0a0: 2020 2020 2020 2020 2020 7320 3d20 6474            s = dt
-0001b0b0: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-0001b0c0: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-0001b0d0: 6e20 733a 0a20 2020 2020 2020 2020 2020  n s:.           
-0001b0e0: 2020 2020 2073 2e64 6973 6361 7264 2874       s.discard(t
-0001b0f0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0001b100: 2020 2069 6620 6e6f 7420 733a 2020 2320     if not s:  # 
-0001b110: 6e65 7720 7461 736b 2072 6561 6479 2074  new task ready t
-0001b120: 6f20 7275 6e0a 2020 2020 2020 2020 2020  o run.          
-0001b130: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0001b140: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
-0001b150: 795d 203d 2022 7072 6f63 6573 7369 6e67  y] = "processing
-0001b160: 220a 0a20 2020 2020 2020 2066 6f72 2064  "..        for d
-0001b170: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-0001b180: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-0001b190: 2020 2073 203d 2064 7473 2e77 6169 7465     s = dts.waite
-0001b1a0: 7273 0a20 2020 2020 2020 2020 2020 2073  rs.            s
-0001b1b0: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
-0001b1c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001b1d0: 7320 616e 6420 6e6f 7420 6474 732e 7768  s and not dts.wh
-0001b1e0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-0001b1f0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0001b200: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-0001b210: 5d20 3d20 2272 656c 6561 7365 6422 0a0a  ] = "released"..
-0001b220: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-0001b230: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
-0001b240: 7420 7473 2e77 686f 5f77 616e 7473 3a0a  t ts.who_wants:.
-0001b250: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001b260: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
-0001b270: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
-0001b280: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001b290: 2020 2020 2020 2020 2020 2072 6570 6f72             repor
-0001b2a0: 745f 6d73 673a 2064 6963 745b 7374 722c  t_msg: dict[str,
-0001b2b0: 2041 6e79 5d20 3d20 7b22 6f70 223a 2022   Any] = {"op": "
-0001b2c0: 6b65 792d 696e 2d6d 656d 6f72 7922 2c20  key-in-memory", 
-0001b2d0: 226b 6579 223a 2074 732e 6b65 797d 0a20  "key": ts.key}. 
-0001b2e0: 2020 2020 2020 2020 2020 2069 6620 7479             if ty
-0001b2f0: 7065 2069 7320 6e6f 7420 4e6f 6e65 3a0a  pe is not None:.
-0001b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b310: 7265 706f 7274 5f6d 7367 5b22 7479 7065  report_msg["type
-0001b320: 225d 203d 2074 7970 650a 2020 2020 2020  "] = type.      
-0001b330: 2020 2020 2020 666f 7220 6373 2069 6e20        for cs in 
-0001b340: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001b350: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0001b360: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
-0001b370: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
-0001b380: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
-0001b390: 2074 732e 7374 6174 6520 3d20 226d 656d   ts.state = "mem
-0001b3a0: 6f72 7922 0a20 2020 2020 2020 2074 732e  ory".        ts.
-0001b3b0: 7479 7065 203d 2074 7970 656e 616d 6520  type = typename 
-0001b3c0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0001b3d0: 2020 2020 2020 2020 7473 2e67 726f 7570          ts.group
-0001b3e0: 2e74 7970 6573 2e61 6464 2874 7970 656e  .types.add(typen
-0001b3f0: 616d 6529 2020 2320 7479 7065 3a20 6967  ame)  # type: ig
-0001b400: 6e6f 7265 0a0a 2020 2020 2020 2020 6373  nore..        cs
-0001b410: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
-0001b420: 2266 6972 652d 616e 642d 666f 7267 6574  "fire-and-forget
-0001b430: 225d 0a20 2020 2020 2020 2069 6620 7473  "].        if ts
-0001b440: 2069 6e20 6373 2e77 616e 7473 5f77 6861   in cs.wants_wha
-0001b450: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
-0001b460: 656c 662e 5f63 6c69 656e 745f 7265 6c65  elf._client_rele
-0001b470: 6173 6573 5f6b 6579 7328 0a20 2020 2020  ases_keys(.     
-0001b480: 2020 2020 2020 2020 2020 2063 733d 6373             cs=cs
-0001b490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b4a0: 2020 6b65 7973 3d5b 7473 2e6b 6579 5d2c    keys=[ts.key],
-0001b4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b4c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001b4d0: 3d72 6563 6f6d 6d65 6e64 6174 696f 6e73  =recommendations
-0001b4e0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0001b4f0: 0a20 2020 2064 6566 205f 7072 6f70 6167  .    def _propag
-0001b500: 6174 655f 7265 6c65 6173 6564 2873 656c  ate_released(sel
-0001b510: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-0001b520: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-0001b530: 733a 2052 6563 7329 202d 3e20 4e6f 6e65  s: Recs) -> None
-0001b540: 3a0a 2020 2020 2020 2020 7473 2e73 7461  :.        ts.sta
-0001b550: 7465 203d 2022 7265 6c65 6173 6564 220a  te = "released".
-0001b560: 2020 2020 2020 2020 6b65 7920 3d20 7473          key = ts
-0001b570: 2e6b 6579 0a0a 2020 2020 2020 2020 6966  .key..        if
-0001b580: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
-0001b590: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0001b5a0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-0001b5b0: 6174 696f 6e73 5b6b 6579 5d20 3d20 2266  ations[key] = "f
-0001b5c0: 6f72 676f 7474 656e 220a 2020 2020 2020  orgotten".      
-0001b5d0: 2020 656c 6966 2074 732e 7761 6974 6572    elif ts.waiter
-0001b5e0: 7320 6f72 2074 732e 7768 6f5f 7761 6e74  s or ts.who_want
-0001b5f0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-0001b600: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-0001b610: 6579 5d20 3d20 2277 6169 7469 6e67 220a  ey] = "waiting".
-0001b620: 0a20 2020 2020 2020 2069 6620 7265 636f  .        if reco
-0001b630: 6d6d 656e 6461 7469 6f6e 732e 6765 7428  mmendations.get(
-0001b640: 6b65 7929 2021 3d20 2277 6169 7469 6e67  key) != "waiting
-0001b650: 223a 0a20 2020 2020 2020 2020 2020 2066  ":.            f
-0001b660: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0001b670: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0001b680: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-0001b690: 732e 7374 6174 6520 213d 2022 7265 6c65  s.state != "rele
-0001b6a0: 6173 6564 223a 0a20 2020 2020 2020 2020  ased":.         
-0001b6b0: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
-0001b6c0: 6169 7465 7273 2e64 6973 6361 7264 2874  aiters.discard(t
-0001b6d0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0001b6e0: 2020 2020 2020 2069 6620 6e6f 7420 6474         if not dt
-0001b6f0: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
-0001b700: 7420 6474 732e 7768 6f5f 7761 6e74 733a  t dts.who_wants:
-0001b710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b720: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0001b730: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-0001b740: 5d20 3d20 2272 656c 6561 7365 6422 0a20  ] = "released". 
-0001b750: 2020 2020 2020 2020 2020 2074 732e 7761             ts.wa
-0001b760: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
-0001b770: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-0001b780: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-0001b790: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0001b7a0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0001b7b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001b7c0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-0001b7d0: 6c66 2e71 7565 7565 640a 0a20 2020 2064  lf.queued..    d
-0001b7e0: 6566 205f 7072 6f70 6167 6174 655f 666f  ef _propagate_fo
-0001b7f0: 7267 6f74 7465 6e28 0a20 2020 2020 2020  rgotten(.       
-0001b800: 2073 656c 662c 0a20 2020 2020 2020 2074   self,.        t
-0001b810: 733a 2054 6173 6b53 7461 7465 2c0a 2020  s: TaskState,.  
-0001b820: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001b830: 7469 6f6e 733a 2052 6563 732c 0a20 2020  tions: Recs,.   
-0001b840: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-0001b850: 3a20 4d73 6773 2c0a 2020 2020 2020 2020  : Msgs,.        
-0001b860: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-0001b870: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-0001b880: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
-0001b890: 6520 3d20 2266 6f72 676f 7474 656e 220a  e = "forgotten".
-0001b8a0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0001b8b0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
-0001b8c0: 3a0a 2020 2020 2020 2020 2020 2020 6474  :.            dt
-0001b8d0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
-0001b8e0: 6465 6e63 6965 7320 3d20 5472 7565 0a20  dencies = True. 
-0001b8f0: 2020 2020 2020 2020 2020 2064 7473 2e64             dts.d
-0001b900: 6570 656e 6465 6e63 6965 732e 7265 6d6f  ependencies.remo
-0001b910: 7665 2874 7329 0a20 2020 2020 2020 2020  ve(ts).         
-0001b920: 2020 2064 7473 2e77 6169 7469 6e67 5f6f     dts.waiting_o
-0001b930: 6e2e 6469 7363 6172 6428 7473 290a 2020  n.discard(ts).  
-0001b940: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
-0001b950: 2e73 7461 7465 206e 6f74 2069 6e20 2822  .state not in ("
-0001b960: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
-0001b970: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001b980: 2020 2023 2043 616e 6e6f 7420 636f 6d70     # Cannot comp
-0001b990: 7574 6520 7461 736b 2061 6e79 6d6f 7265  ute task anymore
-0001b9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b9b0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001b9c0: 5b64 7473 2e6b 6579 5d20 3d20 2266 6f72  [dts.key] = "for
-0001b9d0: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
-0001b9e0: 7473 2e64 6570 656e 6465 6e74 732e 636c  ts.dependents.cl
-0001b9f0: 6561 7228 290a 2020 2020 2020 2020 7473  ear().        ts
-0001ba00: 2e77 6169 7465 7273 2e63 6c65 6172 2829  .waiters.clear()
-0001ba10: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-0001ba20: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001ba30: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0001ba40: 2020 6474 732e 6465 7065 6e64 656e 7473    dts.dependents
-0001ba50: 2e72 656d 6f76 6528 7473 290a 2020 2020  .remove(ts).    
-0001ba60: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-0001ba70: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
-0001ba80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001ba90: 6f74 2064 7473 2e64 6570 656e 6465 6e74  ot dts.dependent
-0001baa0: 7320 616e 6420 6e6f 7420 6474 732e 7768  s and not dts.wh
-0001bab0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-0001bac0: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
-0001bad0: 6e6f 7420 6e65 6564 6564 2061 6e79 6d6f  not needed anymo
-0001bae0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
-0001baf0: 2020 2061 7373 6572 7420 6474 7320 6973     assert dts is
-0001bb00: 206e 6f74 2074 730a 2020 2020 2020 2020   not ts.        
-0001bb10: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001bb20: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-0001bb30: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
-0001bb40: 2020 2020 2020 2074 732e 6465 7065 6e64         ts.depend
-0001bb50: 656e 6369 6573 2e63 6c65 6172 2829 0a20  encies.clear(). 
-0001bb60: 2020 2020 2020 2074 732e 7761 6974 696e         ts.waitin
-0001bb70: 675f 6f6e 2e63 6c65 6172 2829 0a0a 2020  g_on.clear()..  
-0001bb80: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-0001bb90: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
-0001bba0: 2020 2020 2020 2020 6966 2077 732e 6164          if ws.ad
-0001bbb0: 6472 6573 7320 696e 2073 656c 662e 776f  dress in self.wo
-0001bbc0: 726b 6572 733a 2020 2320 696e 2063 6173  rkers:  # in cas
-0001bbd0: 6520 776f 726b 6572 2068 6173 2064 6965  e worker has die
-0001bbe0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0001bbf0: 2020 776f 726b 6572 5f6d 7367 735b 7773    worker_msgs[ws
-0001bc00: 2e61 6464 7265 7373 5d20 3d20 5b0a 2020  .address] = [.  
-0001bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc20: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0001bc30: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
-0001bc40: 3a20 2266 7265 652d 6b65 7973 222c 0a20  : "free-keys",. 
-0001bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc60: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
-0001bc70: 7473 2e6b 6579 5d2c 0a20 2020 2020 2020  ts.key],.       
-0001bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc90: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
-0001bca0: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
-0001bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bcc0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0001bcd0: 2020 205d 0a20 2020 2020 2020 2073 656c     ].        sel
-0001bce0: 662e 7265 6d6f 7665 5f61 6c6c 5f72 6570  f.remove_all_rep
-0001bcf0: 6c69 6361 7328 7473 290a 0a20 2020 2064  licas(ts)..    d
-0001bd00: 6566 205f 636c 6965 6e74 5f72 656c 6561  ef _client_relea
-0001bd10: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
-0001bd20: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0001bd30: 6b65 7973 3a20 436f 6c6c 6563 7469 6f6e  keys: Collection
-0001bd40: 5b73 7472 5d2c 0a20 2020 2020 2020 2063  [str],.        c
-0001bd50: 733a 2043 6c69 656e 7453 7461 7465 2c0a  s: ClientState,.
-0001bd60: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001bd70: 6461 7469 6f6e 733a 2052 6563 732c 0a20  dations: Recs,. 
-0001bd80: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-0001bd90: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-0001bda0: 6b65 7973 2066 726f 6d20 636c 6965 6e74  keys from client
-0001bdb0: 2064 6573 6972 6564 206c 6973 7422 2222   desired list"""
-0001bdc0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0001bdd0: 6465 6275 6728 2243 6c69 656e 7420 2573  debug("Client %s
-0001bde0: 2072 656c 6561 7365 7320 6b65 7973 3a20   releases keys: 
-0001bdf0: 2573 222c 2063 732e 636c 6965 6e74 5f6b  %s", cs.client_k
-0001be00: 6579 2c20 6b65 7973 290a 2020 2020 2020  ey, keys).      
-0001be10: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-0001be20: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-0001be30: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
-0001be40: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-0001be50: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
-0001be60: 204e 6f6e 6520 616e 6420 7473 2069 6e20   None and ts in 
-0001be70: 6373 2e77 616e 7473 5f77 6861 743a 0a20  cs.wants_what:. 
-0001be80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001be90: 732e 7761 6e74 735f 7768 6174 2e72 656d  s.wants_what.rem
-0001bea0: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
-0001beb0: 2020 2020 2020 2020 7473 2e77 686f 5f77          ts.who_w
-0001bec0: 616e 7473 2e72 656d 6f76 6528 6373 290a  ants.remove(cs).
-0001bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bee0: 6966 206e 6f74 2074 732e 7768 6f5f 7761  if not ts.who_wa
-0001bef0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001bf00: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001bf10: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
-0001bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf30: 2020 2020 2020 2023 204e 6f20 6c69 7665         # No live
-0001bf40: 2064 6570 656e 6465 6e74 732c 2063 616e   dependents, can
-0001bf50: 2066 6f72 6765 740a 2020 2020 2020 2020   forget.        
-0001bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf70: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-0001bf80: 7473 2e6b 6579 5d20 3d20 2266 6f72 676f  ts.key] = "forgo
-0001bf90: 7474 656e 220a 2020 2020 2020 2020 2020  tten".          
-0001bfa0: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
-0001bfb0: 732e 7374 6174 6520 213d 2022 6572 7265  s.state != "erre
-0001bfc0: 6422 2061 6e64 206e 6f74 2074 732e 7761  d" and not ts.wa
-0001bfd0: 6974 6572 733a 0a20 2020 2020 2020 2020  iters:.         
-0001bfe0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001bff0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b74  ecommendations[t
-0001c000: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
-0001c010: 6564 220a 0a20 2020 2064 6566 205f 7461  ed"..    def _ta
-0001c020: 736b 5f74 6f5f 6d73 6728 7365 6c66 2c20  sk_to_msg(self, 
-0001c030: 7473 3a20 5461 736b 5374 6174 652c 2064  ts: TaskState, d
-0001c040: 7572 6174 696f 6e3a 2066 6c6f 6174 203d  uration: float =
-0001c050: 202d 3129 202d 3e20 6469 6374 5b73 7472   -1) -> dict[str
-0001c060: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
-0001c070: 2222 2243 6f6e 7665 7274 2061 2073 696e  """Convert a sin
-0001c080: 676c 6520 636f 6d70 7574 6174 696f 6e61  gle computationa
-0001c090: 6c20 7461 736b 2074 6f20 6120 6d65 7373  l task to a mess
-0001c0a0: 6167 6522 2222 0a20 2020 2020 2020 2023  age""".        #
-0001c0b0: 2046 4958 4d45 3a20 5468 6520 6475 7261   FIXME: The dura
-0001c0c0: 7469 6f6e 2061 7474 7269 6275 7465 2069  tion attribute i
-0001c0d0: 7320 6e6f 7420 7573 6564 206f 6e20 776f  s not used on wo
-0001c0e0: 726b 6572 2e20 5765 2063 6f75 6c64 2073  rker. We could s
-0001c0f0: 6176 6520 6f75 7273 656c 7665 7320 7468  ave ourselves th
-0001c100: 650a 2020 2020 2020 2020 2320 2020 2020  e.        #     
-0001c110: 2020 2074 696d 6520 746f 2063 6f6d 7075     time to compu
-0001c120: 7465 2061 6e64 2073 7562 6d69 7420 7468  te and submit th
-0001c130: 6973 0a20 2020 2020 2020 2069 6620 6475  is.        if du
-0001c140: 7261 7469 6f6e 203c 2030 3a0a 2020 2020  ration < 0:.    
-0001c150: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-0001c160: 203d 2073 656c 662e 6765 745f 7461 736b   = self.get_task
-0001c170: 5f64 7572 6174 696f 6e28 7473 290a 2020  _duration(ts).  
-0001c180: 2020 2020 2020 7473 2e72 756e 5f69 6420        ts.run_id 
-0001c190: 3d20 6e65 7874 2854 6173 6b53 7461 7465  = next(TaskState
-0001c1a0: 2e5f 7275 6e5f 6964 5f69 7465 7261 746f  ._run_id_iterato
-0001c1b0: 7229 0a20 2020 2020 2020 2061 7373 6572  r).        asser
-0001c1c0: 7420 7473 2e70 7269 6f72 6974 792c 2074  t ts.priority, t
-0001c1d0: 730a 2020 2020 2020 2020 6d73 673a 2064  s.        msg: d
-0001c1e0: 6963 745b 7374 722c 2041 6e79 5d20 3d20  ict[str, Any] = 
-0001c1f0: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
-0001c200: 7022 3a20 2263 6f6d 7075 7465 2d74 6173  p": "compute-tas
-0001c210: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
-0001c220: 226b 6579 223a 2074 732e 6b65 792c 0a20  "key": ts.key,. 
-0001c230: 2020 2020 2020 2020 2020 2022 7275 6e5f             "run_
-0001c240: 6964 223a 2074 732e 7275 6e5f 6964 2c0a  id": ts.run_id,.
-0001c250: 2020 2020 2020 2020 2020 2020 2270 7269              "pri
-0001c260: 6f72 6974 7922 3a20 7473 2e70 7269 6f72  ority": ts.prior
-0001c270: 6974 792c 0a20 2020 2020 2020 2020 2020  ity,.           
-0001c280: 2022 6475 7261 7469 6f6e 223a 2064 7572   "duration": dur
-0001c290: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
-0001c2a0: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-0001c2b0: 3a20 6622 636f 6d70 7574 652d 7461 736b  : f"compute-task
-0001c2c0: 2d7b 7469 6d65 2829 7d22 2c0a 2020 2020  -{time()}",.    
-0001c2d0: 2020 2020 2020 2020 2277 686f 5f68 6173          "who_has
-0001c2e0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-0001c2f0: 2020 2020 2064 7473 2e6b 6579 3a20 5b77       dts.key: [w
-0001c300: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
-0001c310: 2069 6e20 6474 732e 7768 6f5f 6861 735d   in dts.who_has]
-0001c320: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-0001c330: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
-0001c340: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0001c350: 2020 2020 2020 2022 6e62 7974 6573 223a         "nbytes":
-0001c360: 207b 6474 732e 6b65 793a 2064 7473 2e6e   {dts.key: dts.n
-0001c370: 6279 7465 7320 666f 7220 6474 7320 696e  bytes for dts in
-0001c380: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-0001c390: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
-0001c3a0: 7275 6e5f 7370 6563 223a 204e 6f6e 652c  run_spec": None,
-0001c3b0: 0a20 2020 2020 2020 2020 2020 2022 6675  .            "fu
-0001c3c0: 6e63 7469 6f6e 223a 204e 6f6e 652c 0a20  nction": None,. 
-0001c3d0: 2020 2020 2020 2020 2020 2022 6172 6773             "args
-0001c3e0: 223a 204e 6f6e 652c 0a20 2020 2020 2020  ": None,.       
-0001c3f0: 2020 2020 2022 6b77 6172 6773 223a 204e       "kwargs": N
-0001c400: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0001c410: 2022 7265 736f 7572 6365 5f72 6573 7472   "resource_restr
-0001c420: 6963 7469 6f6e 7322 3a20 7473 2e72 6573  ictions": ts.res
-0001c430: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-0001c440: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0001c450: 2261 6374 6f72 223a 2074 732e 6163 746f  "actor": ts.acto
-0001c460: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
-0001c470: 616e 6e6f 7461 7469 6f6e 7322 3a20 7473  annotations": ts
-0001c480: 2e61 6e6e 6f74 6174 696f 6e73 2c0a 2020  .annotations,.  
-0001c490: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0001c4a0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-0001c4b0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0001c4c0: 7365 7274 2061 6c6c 286d 7367 5b22 7768  sert all(msg["wh
-0001c4d0: 6f5f 6861 7322 5d2e 7661 6c75 6573 2829  o_has"].values()
-0001c4e0: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
-0001c4f0: 696e 7374 616e 6365 2874 732e 7275 6e5f  instance(ts.run_
-0001c500: 7370 6563 2c20 6469 6374 293a 0a20 2020  spec, dict):.   
-0001c510: 2020 2020 2020 2020 206d 7367 2e75 7064           msg.upd
-0001c520: 6174 6528 7473 2e72 756e 5f73 7065 6329  ate(ts.run_spec)
-0001c530: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001c540: 2020 2020 2020 2020 2020 206d 7367 5b22             msg["
-0001c550: 7275 6e5f 7370 6563 225d 203d 2074 732e  run_spec"] = ts.
-0001c560: 7275 6e5f 7370 6563 0a0a 2020 2020 2020  run_spec..      
-0001c570: 2020 7265 7475 726e 206d 7367 0a0a 0a63    return msg...c
-0001c580: 6c61 7373 2053 6368 6564 756c 6572 2853  lass Scheduler(S
-0001c590: 6368 6564 756c 6572 5374 6174 652c 2053  chedulerState, S
-0001c5a0: 6572 7665 724e 6f64 6529 3a0a 2020 2020  erverNode):.    
-0001c5b0: 2222 2244 796e 616d 6963 2064 6973 7472  """Dynamic distr
-0001c5c0: 6962 7574 6564 2074 6173 6b20 7363 6865  ibuted task sche
-0001c5d0: 6475 6c65 720a 0a20 2020 2054 6865 2073  duler..    The s
-0001c5e0: 6368 6564 756c 6572 2074 7261 636b 7320  cheduler tracks 
-0001c5f0: 7468 6520 6375 7272 656e 7420 7374 6174  the current stat
-0001c600: 6520 6f66 2077 6f72 6b65 7273 2c20 6461  e of workers, da
-0001c610: 7461 2c20 616e 6420 636f 6d70 7574 6174  ta, and computat
-0001c620: 696f 6e73 2e0a 2020 2020 5468 6520 7363  ions..    The sc
-0001c630: 6865 6475 6c65 7220 6c69 7374 656e 7320  heduler listens 
-0001c640: 666f 7220 6576 656e 7473 2061 6e64 2072  for events and r
-0001c650: 6573 706f 6e64 7320 6279 2063 6f6e 7472  esponds by contr
-0001c660: 6f6c 6c69 6e67 2077 6f72 6b65 7273 0a20  olling workers. 
-0001c670: 2020 2061 7070 726f 7072 6961 7465 6c79     appropriately
-0001c680: 2e20 2049 7420 636f 6e74 696e 756f 7573  .  It continuous
-0001c690: 6c79 2074 7269 6573 2074 6f20 7573 6520  ly tries to use 
-0001c6a0: 7468 6520 776f 726b 6572 7320 746f 2065  the workers to e
-0001c6b0: 7865 6375 7465 2061 6e20 6576 6572 0a20  xecute an ever. 
-0001c6c0: 2020 2067 726f 7769 6e67 2064 6173 6b20     growing dask 
-0001c6d0: 6772 6170 682e 0a0a 2020 2020 416c 6c20  graph...    All 
-0001c6e0: 6576 656e 7473 2061 7265 2068 616e 646c  events are handl
-0001c6f0: 6564 2071 7569 636b 6c79 2c20 696e 206c  ed quickly, in l
-0001c700: 696e 6561 7220 7469 6d65 2077 6974 6820  inear time with 
-0001c710: 7265 7370 6563 7420 746f 2074 6865 6972  respect to their
-0001c720: 2069 6e70 7574 0a20 2020 2028 7768 6963   input.    (whic
-0001c730: 6820 6973 206f 6674 656e 206f 6620 636f  h is often of co
-0001c740: 6e73 7461 6e74 2073 697a 6529 2061 6e64  nstant size) and
-0001c750: 2067 656e 6572 616c 6c79 2077 6974 6869   generally withi
-0001c760: 6e20 6120 6d69 6c6c 6973 6563 6f6e 642e  n a millisecond.
-0001c770: 2020 546f 0a20 2020 2061 6363 6f6d 706c    To.    accompl
-0001c780: 6973 6820 7468 6973 2074 6865 2073 6368  ish this the sch
-0001c790: 6564 756c 6572 2074 7261 636b 7320 6120  eduler tracks a 
-0001c7a0: 6c6f 7420 6f66 2073 7461 7465 2e20 2045  lot of state.  E
-0001c7b0: 7665 7279 206f 7065 7261 7469 6f6e 0a20  very operation. 
-0001c7c0: 2020 206d 6169 6e74 6169 6e73 2074 6865     maintains the
-0001c7d0: 2063 6f6e 7369 7374 656e 6379 206f 6620   consistency of 
-0001c7e0: 7468 6973 2073 7461 7465 2e0a 0a20 2020  this state...   
-0001c7f0: 2054 6865 2073 6368 6564 756c 6572 2063   The scheduler c
-0001c800: 6f6d 6d75 6e69 6361 7465 7320 7769 7468  ommunicates with
-0001c810: 2074 6865 206f 7574 7369 6465 2077 6f72   the outside wor
-0001c820: 6c64 2074 6872 6f75 6768 2043 6f6d 6d20  ld through Comm 
-0001c830: 6f62 6a65 6374 732e 0a20 2020 2049 7420  objects..    It 
-0001c840: 6d61 696e 7461 696e 7320 6120 636f 6e73  maintains a cons
-0001c850: 6973 7465 6e74 2061 6e64 2076 616c 6964  istent and valid
-0001c860: 2076 6965 7720 6f66 2074 6865 2077 6f72   view of the wor
-0001c870: 6c64 2065 7665 6e20 7768 656e 206c 6973  ld even when lis
-0001c880: 7465 6e69 6e67 0a20 2020 2074 6f20 7365  tening.    to se
-0001c890: 7665 7261 6c20 636c 6965 6e74 7320 6174  veral clients at
-0001c8a0: 206f 6e63 652e 0a0a 2020 2020 4120 5363   once...    A Sc
-0001c8b0: 6865 6475 6c65 7220 6973 2074 7970 6963  heduler is typic
-0001c8c0: 616c 6c79 2073 7461 7274 6564 2065 6974  ally started eit
-0001c8d0: 6865 7220 7769 7468 2074 6865 2060 6064  her with the ``d
-0001c8e0: 6173 6b20 7363 6865 6475 6c65 7260 600a  ask scheduler``.
-0001c8f0: 2020 2020 6578 6563 7574 6162 6c65 3a3a      executable::
-0001c900: 0a0a 2020 2020 2020 2020 2024 2064 6173  ..         $ das
-0001c910: 6b20 7363 6865 6475 6c65 720a 2020 2020  k scheduler.    
-0001c920: 2020 2020 2053 6368 6564 756c 6572 2073       Scheduler s
-0001c930: 7461 7274 6564 2061 7420 3132 372e 302e  tarted at 127.0.
-0001c940: 302e 313a 3837 3836 0a0a 2020 2020 4f72  0.1:8786..    Or
-0001c950: 2077 6974 6869 6e20 6120 4c6f 6361 6c43   within a LocalC
-0001c960: 6c75 7374 6572 2061 2043 6c69 656e 7420  luster a Client 
-0001c970: 7374 6172 7473 2075 7020 7769 7468 6f75  starts up withou
-0001c980: 7420 636f 6e6e 6563 7469 6f6e 0a20 2020  t connection.   
-0001c990: 2069 6e66 6f72 6d61 7469 6f6e 3a3a 0a0a   information::..
-0001c9a0: 2020 2020 2020 2020 3e3e 3e20 6320 3d20          >>> c = 
-0001c9b0: 436c 6965 6e74 2829 2020 2320 646f 6374  Client()  # doct
-0001c9c0: 6573 743a 202b 534b 4950 0a20 2020 2020  est: +SKIP.     
-0001c9d0: 2020 203e 3e3e 2063 2e63 6c75 7374 6572     >>> c.cluster
-0001c9e0: 2e73 6368 6564 756c 6572 2020 2320 646f  .scheduler  # do
-0001c9f0: 6374 6573 743a 202b 534b 4950 0a20 2020  ctest: +SKIP.   
-0001ca00: 2020 2020 2053 6368 6564 756c 6572 282e       Scheduler(.
-0001ca10: 2e2e 290a 0a20 2020 2055 7365 7273 2074  ..)..    Users t
-0001ca20: 7970 6963 616c 6c79 2064 6f20 6e6f 7420  ypically do not 
-0001ca30: 696e 7465 7261 6374 2077 6974 6820 7468  interact with th
-0001ca40: 6520 7363 6865 6475 6c65 7220 6469 7265  e scheduler dire
-0001ca50: 6374 6c79 2062 7574 2072 6174 6865 7220  ctly but rather 
-0001ca60: 7769 7468 0a20 2020 2074 6865 2063 6c69  with.    the cli
-0001ca70: 656e 7420 6f62 6a65 6374 2060 6043 6c69  ent object ``Cli
-0001ca80: 656e 7460 602e 0a0a 2020 2020 5468 6520  ent``...    The 
-0001ca90: 6060 636f 6e74 6163 745f 6164 6472 6573  ``contact_addres
-0001caa0: 7360 6020 7061 7261 6d65 7465 7220 616c  s`` parameter al
-0001cab0: 6c6f 7773 2074 6f20 6164 7665 7274 6973  lows to advertis
-0001cac0: 6520 6120 7370 6563 6966 6963 2061 6464  e a specific add
-0001cad0: 7265 7373 2074 6f0a 2020 2020 7468 6520  ress to.    the 
-0001cae0: 776f 726b 6572 7320 666f 7220 636f 6d6d  workers for comm
-0001caf0: 756e 6963 6174 696f 6e20 7769 7468 2074  unication with t
-0001cb00: 6865 2073 6368 6564 756c 6572 2c20 7768  he scheduler, wh
-0001cb10: 6963 6820 6973 2064 6966 6665 7265 6e74  ich is different
-0001cb20: 2074 6861 6e0a 2020 2020 7468 6520 6164   than.    the ad
-0001cb30: 6472 6573 7320 7468 6520 7363 6865 6475  dress the schedu
-0001cb40: 6c65 7220 6269 6e64 7320 746f 2e20 5468  ler binds to. Th
-0001cb50: 6973 2069 7320 7573 6566 756c 2077 6865  is is useful whe
-0001cb60: 6e20 7468 6520 7363 6865 6475 6c65 720a  n the scheduler.
-0001cb70: 2020 2020 6c69 7374 656e 7320 6f6e 2061      listens on a
-0001cb80: 2070 7269 7661 7465 2061 6464 7265 7373   private address
-0001cb90: 2c20 7768 6963 6820 7468 6572 6566 6f72  , which therefor
-0001cba0: 6520 6361 6e6e 6f74 2062 6520 7573 6564  e cannot be used
-0001cbb0: 2062 7920 7468 6520 776f 726b 6572 730a   by the workers.
-0001cbc0: 2020 2020 746f 2063 6f6e 7461 6374 2069      to contact i
-0001cbd0: 742e 0a0a 2020 2020 2a2a 5374 6174 652a  t...    **State*
-0001cbe0: 2a0a 0a20 2020 2054 6865 2073 6368 6564  *..    The sched
-0001cbf0: 756c 6572 2063 6f6e 7461 696e 7320 7468  uler contains th
-0001cc00: 6520 666f 6c6c 6f77 696e 6720 7374 6174  e following stat
-0001cc10: 6520 7661 7269 6162 6c65 732e 2020 4561  e variables.  Ea
-0001cc20: 6368 2076 6172 6961 626c 6520 6973 0a20  ch variable is. 
-0001cc30: 2020 206c 6973 7465 6420 616c 6f6e 6720     listed along 
-0001cc40: 7769 7468 2077 6861 7420 6974 2073 746f  with what it sto
-0001cc50: 7265 7320 616e 6420 6120 6272 6965 6620  res and a brief 
-0001cc60: 6465 7363 7269 7074 696f 6e2e 0a0a 2020  description...  
-0001cc70: 2020 2a20 2a2a 7461 736b 733a 2a2a 2060    * **tasks:** `
-0001cc80: 607b 7461 736b 206b 6579 3a20 5461 736b  `{task key: Task
-0001cc90: 5374 6174 657d 6060 0a20 2020 2020 2020  State}``.       
-0001cca0: 2054 6173 6b73 2063 7572 7265 6e74 6c79   Tasks currently
-0001ccb0: 206b 6e6f 776e 2074 6f20 7468 6520 7363   known to the sc
-0001ccc0: 6865 6475 6c65 720a 2020 2020 2a20 2a2a  heduler.    * **
-0001ccd0: 756e 7275 6e6e 6162 6c65 3a2a 2a20 6060  unrunnable:** ``
-0001cce0: 7b54 6173 6b53 7461 7465 7d60 600a 2020  {TaskState}``.  
-0001ccf0: 2020 2020 2020 5461 736b 7320 696e 2074        Tasks in t
-0001cd00: 6865 2022 6e6f 2d77 6f72 6b65 7222 2073  he "no-worker" s
-0001cd10: 7461 7465 0a0a 2020 2020 2a20 2a2a 776f  tate..    * **wo
-0001cd20: 726b 6572 733a 2a2a 2060 607b 776f 726b  rkers:** ``{work
-0001cd30: 6572 206b 6579 3a20 576f 726b 6572 5374  er key: WorkerSt
-0001cd40: 6174 657d 6060 0a20 2020 2020 2020 2057  ate}``.        W
-0001cd50: 6f72 6b65 7273 2063 7572 7265 6e74 6c79  orkers currently
-0001cd60: 2063 6f6e 6e65 6374 6564 2074 6f20 7468   connected to th
-0001cd70: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
-0001cd80: 2a20 2a2a 6964 6c65 3a2a 2a20 6060 7b57  * **idle:** ``{W
-0001cd90: 6f72 6b65 7253 7461 7465 7d60 603a 0a20  orkerState}``:. 
-0001cda0: 2020 2020 2020 2053 6574 206f 6620 776f         Set of wo
-0001cdb0: 726b 6572 7320 7468 6174 2061 7265 206e  rkers that are n
-0001cdc0: 6f74 2066 756c 6c79 2075 7469 6c69 7a65  ot fully utilize
-0001cdd0: 640a 2020 2020 2a20 2a2a 7361 7475 7261  d.    * **satura
-0001cde0: 7465 643a 2a2a 2060 607b 576f 726b 6572  ted:** ``{Worker
-0001cdf0: 5374 6174 657d 6060 3a0a 2020 2020 2020  State}``:.      
-0001ce00: 2020 5365 7420 6f66 2077 6f72 6b65 7273    Set of workers
-0001ce10: 2074 6861 7420 6172 6520 6e6f 7420 6f76   that are not ov
-0001ce20: 6572 2d75 7469 6c69 7a65 640a 0a20 2020  er-utilized..   
-0001ce30: 202a 202a 2a68 6f73 745f 696e 666f 3a2a   * **host_info:*
-0001ce40: 2a20 6060 7b68 6f73 746e 616d 653a 2064  * ``{hostname: d
-0001ce50: 6963 747d 6060 3a0a 2020 2020 2020 2020  ict}``:.        
-0001ce60: 496e 666f 726d 6174 696f 6e20 6162 6f75  Information abou
-0001ce70: 7420 6561 6368 2077 6f72 6b65 7220 686f  t each worker ho
-0001ce80: 7374 0a0a 2020 2020 2a20 2a2a 636c 6965  st..    * **clie
-0001ce90: 6e74 733a 2a2a 2060 607b 636c 6965 6e74  nts:** ``{client
-0001cea0: 206b 6579 3a20 436c 6965 6e74 5374 6174   key: ClientStat
-0001ceb0: 657d 6060 0a20 2020 2020 2020 2043 6c69  e}``.        Cli
-0001cec0: 656e 7473 2063 7572 7265 6e74 6c79 2063  ents currently c
-0001ced0: 6f6e 6e65 6374 6564 2074 6f20 7468 6520  onnected to the 
-0001cee0: 7363 6865 6475 6c65 720a 0a20 2020 202a  scheduler..    *
-0001cef0: 202a 2a73 6572 7669 6365 733a 2a2a 2060   **services:** `
-0001cf00: 607b 7374 723a 2070 6f72 747d 6060 3a0a  `{str: port}``:.
-0001cf10: 2020 2020 2020 2020 4f74 6865 7220 7365          Other se
-0001cf20: 7276 6963 6573 2072 756e 6e69 6e67 206f  rvices running o
-0001cf30: 6e20 7468 6973 2073 6368 6564 756c 6572  n this scheduler
-0001cf40: 2c20 6c69 6b65 2042 6f6b 6568 0a20 2020  , like Bokeh.   
-0001cf50: 202a 202a 2a6c 6f6f 703a 2a2a 2060 6049   * **loop:** ``I
-0001cf60: 4f4c 6f6f 7060 603a 0a20 2020 2020 2020  OLoop``:.       
-0001cf70: 2054 6865 2072 756e 6e69 6e67 2054 6f72   The running Tor
-0001cf80: 6e61 646f 2049 4f4c 6f6f 700a 2020 2020  nado IOLoop.    
-0001cf90: 2a20 2a2a 636c 6965 6e74 5f63 6f6d 6d73  * **client_comms
-0001cfa0: 3a2a 2a20 6060 7b63 6c69 656e 7420 6b65  :** ``{client ke
-0001cfb0: 793a 2043 6f6d 6d7d 6060 0a20 2020 2020  y: Comm}``.     
-0001cfc0: 2020 2046 6f72 2065 6163 6820 636c 6965     For each clie
-0001cfd0: 6e74 2c20 6120 436f 6d6d 206f 626a 6563  nt, a Comm objec
-0001cfe0: 7420 7573 6564 2074 6f20 7265 6365 6976  t used to receiv
-0001cff0: 6520 7461 736b 2072 6571 7565 7374 7320  e task requests 
-0001d000: 616e 640a 2020 2020 2020 2020 7265 706f  and.        repo
-0001d010: 7274 2074 6173 6b20 7374 6174 7573 2075  rt task status u
-0001d020: 7064 6174 6573 2e0a 2020 2020 2a20 2a2a  pdates..    * **
-0001d030: 7374 7265 616d 5f63 6f6d 6d73 3a2a 2a20  stream_comms:** 
-0001d040: 6060 7b77 6f72 6b65 7220 6b65 793a 2043  ``{worker key: C
-0001d050: 6f6d 6d7d 6060 0a20 2020 2020 2020 2046  omm}``.        F
-0001d060: 6f72 2065 6163 6820 776f 726b 6572 2c20  or each worker, 
-0001d070: 6120 436f 6d6d 206f 626a 6563 7420 6672  a Comm object fr
-0001d080: 6f6d 2077 6869 6368 2077 6520 626f 7468  om which we both
-0001d090: 2061 6363 6570 7420 7374 696d 756c 6920   accept stimuli 
-0001d0a0: 616e 640a 2020 2020 2020 2020 7265 706f  and.        repo
-0001d0b0: 7274 2072 6573 756c 7473 0a20 2020 202a  rt results.    *
-0001d0c0: 202a 2a74 6173 6b5f 6475 7261 7469 6f6e   **task_duration
-0001d0d0: 3a2a 2a20 6060 7b6b 6579 2d70 7265 6669  :** ``{key-prefi
-0001d0e0: 783a 2074 696d 657d 6060 0a20 2020 2020  x: time}``.     
-0001d0f0: 2020 2054 696d 6520 7765 2065 7870 6563     Time we expec
-0001d100: 7420 6365 7274 6169 6e20 6675 6e63 7469  t certain functi
-0001d110: 6f6e 7320 746f 2074 616b 652c 2065 2e67  ons to take, e.g
-0001d120: 2e20 6060 7b27 7375 6d27 3a20 302e 3235  . ``{'sum': 0.25
-0001d130: 7d60 600a 2020 2020 2222 220a 0a20 2020  }``.    """..   
-0001d140: 2064 6566 6175 6c74 5f70 6f72 7420 3d20   default_port = 
-0001d150: 3837 3836 0a20 2020 205f 696e 7374 616e  8786.    _instan
-0001d160: 6365 733a 2043 6c61 7373 5661 725b 7765  ces: ClassVar[we
-0001d170: 616b 7265 662e 5765 616b 5365 745b 5363  akref.WeakSet[Sc
-0001d180: 6865 6475 6c65 725d 5d20 3d20 7765 616b  heduler]] = weak
-0001d190: 7265 662e 5765 616b 5365 7428 290a 0a20  ref.WeakSet().. 
-0001d1a0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-0001d1b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0001d1c0: 2020 2020 2020 206c 6f6f 703d 4e6f 6e65         loop=None
-0001d1d0: 2c0a 2020 2020 2020 2020 6465 6c65 7465  ,.        delete
-0001d1e0: 5f69 6e74 6572 7661 6c3d 2235 3030 6d73  _interval="500ms
-0001d1f0: 222c 0a20 2020 2020 2020 2073 796e 6368  ",.        synch
-0001d200: 726f 6e69 7a65 5f77 6f72 6b65 725f 696e  ronize_worker_in
-0001d210: 7465 7276 616c 3d22 3630 7322 2c0a 2020  terval="60s",.  
-0001d220: 2020 2020 2020 7365 7276 6963 6573 3d4e        services=N
-0001d230: 6f6e 652c 0a20 2020 2020 2020 2073 6572  one,.        ser
-0001d240: 7669 6365 5f6b 7761 7267 733d 4e6f 6e65  vice_kwargs=None
-0001d250: 2c0a 2020 2020 2020 2020 616c 6c6f 7765  ,.        allowe
-0001d260: 645f 6661 696c 7572 6573 3d4e 6f6e 652c  d_failures=None,
-0001d270: 0a20 2020 2020 2020 2065 7874 656e 7369  .        extensi
-0001d280: 6f6e 733d 4e6f 6e65 2c0a 2020 2020 2020  ons=None,.      
-0001d290: 2020 7661 6c69 6461 7465 3d4e 6f6e 652c    validate=None,
-0001d2a0: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
-0001d2b0: 6572 5f66 696c 653d 4e6f 6e65 2c0a 2020  er_file=None,.  
-0001d2c0: 2020 2020 2020 7365 6375 7269 7479 3d4e        security=N
-0001d2d0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
-0001d2e0: 6b65 725f 7474 6c3d 4e6f 6e65 2c0a 2020  ker_ttl=None,.  
-0001d2f0: 2020 2020 2020 6964 6c65 5f74 696d 656f        idle_timeo
-0001d300: 7574 3d4e 6f6e 652c 0a20 2020 2020 2020  ut=None,.       
-0001d310: 2069 6e74 6572 6661 6365 3d4e 6f6e 652c   interface=None,
-0001d320: 0a20 2020 2020 2020 2068 6f73 743d 4e6f  .        host=No
-0001d330: 6e65 2c0a 2020 2020 2020 2020 706f 7274  ne,.        port
-0001d340: 3d30 2c0a 2020 2020 2020 2020 7072 6f74  =0,.        prot
-0001d350: 6f63 6f6c 3d4e 6f6e 652c 0a20 2020 2020  ocol=None,.     
-0001d360: 2020 2064 6173 6862 6f61 7264 5f61 6464     dashboard_add
-0001d370: 7265 7373 3d4e 6f6e 652c 0a20 2020 2020  ress=None,.     
-0001d380: 2020 2064 6173 6862 6f61 7264 3d4e 6f6e     dashboard=Non
-0001d390: 652c 0a20 2020 2020 2020 2068 7474 705f  e,.        http_
-0001d3a0: 7072 6566 6978 3d22 2f22 2c0a 2020 2020  prefix="/",.    
-0001d3b0: 2020 2020 7072 656c 6f61 643d 4e6f 6e65      preload=None
-0001d3c0: 2c0a 2020 2020 2020 2020 7072 656c 6f61  ,.        preloa
-0001d3d0: 645f 6172 6776 3d28 292c 0a20 2020 2020  d_argv=(),.     
-0001d3e0: 2020 2070 6c75 6769 6e73 3d28 292c 0a20     plugins=(),. 
-0001d3f0: 2020 2020 2020 2063 6f6e 7461 6374 5f61         contact_a
-0001d400: 6464 7265 7373 3d4e 6f6e 652c 0a20 2020  ddress=None,.   
-0001d410: 2020 2020 2074 7261 6e73 6974 696f 6e5f       transition_
-0001d420: 636f 756e 7465 725f 6d61 783d 4661 6c73  counter_max=Fals
-0001d430: 652c 0a20 2020 2020 2020 206a 7570 7974  e,.        jupyt
-0001d440: 6572 3d46 616c 7365 2c0a 2020 2020 2020  er=False,.      
-0001d450: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0001d460: 293a 0a20 2020 2020 2020 2069 6620 6c6f  ):.        if lo
-0001d470: 6f70 2069 7320 6e6f 7420 4e6f 6e65 3a0a  op is not None:.
-0001d480: 2020 2020 2020 2020 2020 2020 7761 726e              warn
-0001d490: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
-0001d4a0: 2020 2020 2020 2020 2020 2022 7468 6520             "the 
-0001d4b0: 6c6f 6f70 206b 7761 7267 2074 6f20 5363  loop kwarg to Sc
-0001d4c0: 6865 6475 6c65 7220 6973 2064 6570 7265  heduler is depre
-0001d4d0: 6361 7465 6422 2c0a 2020 2020 2020 2020  cated",.        
-0001d4e0: 2020 2020 2020 2020 4465 7072 6563 6174          Deprecat
-0001d4f0: 696f 6e57 6172 6e69 6e67 2c0a 2020 2020  ionWarning,.    
-0001d500: 2020 2020 2020 2020 2020 2020 7374 6163              stac
-0001d510: 6b6c 6576 656c 3d32 2c0a 2020 2020 2020  klevel=2,.      
-0001d520: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001d530: 2073 656c 662e 6c6f 6f70 203d 2073 656c   self.loop = sel
-0001d540: 662e 696f 5f6c 6f6f 7020 3d20 494f 4c6f  f.io_loop = IOLo
-0001d550: 6f70 2e63 7572 7265 6e74 2829 0a20 2020  op.current().   
-0001d560: 2020 2020 2073 656c 662e 5f73 6574 7570       self._setup
-0001d570: 5f6c 6f67 6769 6e67 286c 6f67 6765 7229  _logging(logger)
-0001d580: 0a0a 2020 2020 2020 2020 2320 4174 7472  ..        # Attr
-0001d590: 6962 7574 6573 0a20 2020 2020 2020 2069  ibutes.        i
-0001d5a0: 6620 636f 6e74 6163 745f 6164 6472 6573  f contact_addres
-0001d5b0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0001d5c0: 2020 2020 2020 2063 6f6e 7461 6374 5f61         contact_a
-0001d5d0: 6464 7265 7373 203d 2064 6173 6b2e 636f  ddress = dask.co
-0001d5e0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0001d5f0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0001d600: 636f 6e74 6163 742d 6164 6472 6573 7322  contact-address"
-0001d610: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0001d620: 6f6e 7461 6374 5f61 6464 7265 7373 203d  ontact_address =
-0001d630: 2063 6f6e 7461 6374 5f61 6464 7265 7373   contact_address
-0001d640: 0a20 2020 2020 2020 2069 6620 616c 6c6f  .        if allo
-0001d650: 7765 645f 6661 696c 7572 6573 2069 7320  wed_failures is 
-0001d660: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001d670: 2020 616c 6c6f 7765 645f 6661 696c 7572    allowed_failur
-0001d680: 6573 203d 2064 6173 6b2e 636f 6e66 6967  es = dask.config
-0001d690: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0001d6a0: 642e 7363 6865 6475 6c65 722e 616c 6c6f  d.scheduler.allo
-0001d6b0: 7765 642d 6661 696c 7572 6573 2229 0a20  wed-failures"). 
-0001d6c0: 2020 2020 2020 2073 656c 662e 616c 6c6f         self.allo
-0001d6d0: 7765 645f 6661 696c 7572 6573 203d 2061  wed_failures = a
-0001d6e0: 6c6c 6f77 6564 5f66 6169 6c75 7265 730a  llowed_failures.
-0001d6f0: 2020 2020 2020 2020 6966 2076 616c 6964          if valid
-0001d700: 6174 6520 6973 204e 6f6e 653a 0a20 2020  ate is None:.   
-0001d710: 2020 2020 2020 2020 2076 616c 6964 6174           validat
-0001d720: 6520 3d20 6461 736b 2e63 6f6e 6669 672e  e = dask.config.
-0001d730: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0001d740: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
-0001d750: 6174 6522 290a 2020 2020 2020 2020 7365  ate").        se
-0001d760: 6c66 2e70 726f 6320 3d20 7073 7574 696c  lf.proc = psutil
-0001d770: 2e50 726f 6365 7373 2829 0a20 2020 2020  .Process().     
-0001d780: 2020 2073 656c 662e 6465 6c65 7465 5f69     self.delete_i
-0001d790: 6e74 6572 7661 6c20 3d20 7061 7273 655f  nterval = parse_
-0001d7a0: 7469 6d65 6465 6c74 6128 6465 6c65 7465  timedelta(delete
-0001d7b0: 5f69 6e74 6572 7661 6c2c 2064 6566 6175  _interval, defau
-0001d7c0: 6c74 3d22 6d73 2229 0a20 2020 2020 2020  lt="ms").       
-0001d7d0: 2073 656c 662e 7379 6e63 6872 6f6e 697a   self.synchroniz
-0001d7e0: 655f 776f 726b 6572 5f69 6e74 6572 7661  e_worker_interva
-0001d7f0: 6c20 3d20 7061 7273 655f 7469 6d65 6465  l = parse_timede
-0001d800: 6c74 6128 0a20 2020 2020 2020 2020 2020  lta(.           
-0001d810: 2073 796e 6368 726f 6e69 7a65 5f77 6f72   synchronize_wor
-0001d820: 6b65 725f 696e 7465 7276 616c 2c20 6465  ker_interval, de
-0001d830: 6661 756c 743d 226d 7322 0a20 2020 2020  fault="ms".     
-0001d840: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0001d850: 662e 7365 7276 6963 655f 7370 6563 7320  f.service_specs 
-0001d860: 3d20 7365 7276 6963 6573 206f 7220 7b7d  = services or {}
-0001d870: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-0001d880: 7276 6963 655f 6b77 6172 6773 203d 2073  rvice_kwargs = s
-0001d890: 6572 7669 6365 5f6b 7761 7267 7320 6f72  ervice_kwargs or
-0001d8a0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0001d8b0: 2e73 6572 7669 6365 7320 3d20 7b7d 0a20  .services = {}. 
-0001d8c0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-0001d8d0: 6475 6c65 725f 6669 6c65 203d 2073 6368  duler_file = sch
-0001d8e0: 6564 756c 6572 5f66 696c 650a 2020 2020  eduler_file.    
-0001d8f0: 2020 2020 776f 726b 6572 5f74 746c 203d      worker_ttl =
-0001d900: 2077 6f72 6b65 725f 7474 6c20 6f72 2064   worker_ttl or d
-0001d910: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0001d920: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-0001d930: 6475 6c65 722e 776f 726b 6572 2d74 746c  duler.worker-ttl
-0001d940: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0001d950: 776f 726b 6572 5f74 746c 203d 2070 6172  worker_ttl = par
-0001d960: 7365 5f74 696d 6564 656c 7461 2877 6f72  se_timedelta(wor
-0001d970: 6b65 725f 7474 6c29 2069 6620 776f 726b  ker_ttl) if work
-0001d980: 6572 5f74 746c 2065 6c73 6520 4e6f 6e65  er_ttl else None
-0001d990: 0a20 2020 2020 2020 2069 646c 655f 7469  .        idle_ti
-0001d9a0: 6d65 6f75 7420 3d20 6964 6c65 5f74 696d  meout = idle_tim
-0001d9b0: 656f 7574 206f 7220 6461 736b 2e63 6f6e  eout or dask.con
-0001d9c0: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-0001d9d0: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
-0001d9e0: 642e 7363 6865 6475 6c65 722e 6964 6c65  d.scheduler.idle
-0001d9f0: 2d74 696d 656f 7574 220a 2020 2020 2020  -timeout".      
-0001da00: 2020 290a 2020 2020 2020 2020 6966 2069    ).        if i
-0001da10: 646c 655f 7469 6d65 6f75 743a 0a20 2020  dle_timeout:.   
-0001da20: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-0001da30: 6c65 5f74 696d 656f 7574 203d 2070 6172  le_timeout = par
-0001da40: 7365 5f74 696d 6564 656c 7461 2869 646c  se_timedelta(idl
-0001da50: 655f 7469 6d65 6f75 7429 0a20 2020 2020  e_timeout).     
-0001da60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001da70: 2020 2020 2073 656c 662e 6964 6c65 5f74       self.idle_t
-0001da80: 696d 656f 7574 203d 204e 6f6e 650a 2020  imeout = None.  
-0001da90: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
-0001daa0: 7369 6e63 6520 3d20 7469 6d65 2829 0a20  since = time(). 
-0001dab0: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
-0001dac0: 5f73 7461 7274 6564 203d 2073 656c 662e  _started = self.
-0001dad0: 6964 6c65 5f73 696e 6365 2020 2320 636f  idle_since  # co
-0001dae0: 6d70 6174 6962 696c 6974 7920 666f 7220  mpatibility for 
-0001daf0: 6461 736b 2d67 6174 6577 6179 0a20 2020  dask-gateway.   
-0001db00: 2020 2020 2073 656c 662e 5f6c 6f63 6b20       self._lock 
-0001db10: 3d20 6173 796e 6369 6f2e 4c6f 636b 2829  = asyncio.Lock()
-0001db20: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
-0001db30: 6e64 7769 6474 685f 776f 726b 6572 7320  ndwidth_workers 
-0001db40: 3d20 6465 6661 756c 7464 6963 7428 666c  = defaultdict(fl
-0001db50: 6f61 7429 0a20 2020 2020 2020 2073 656c  oat).        sel
-0001db60: 662e 6261 6e64 7769 6474 685f 7479 7065  f.bandwidth_type
-0001db70: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-0001db80: 666c 6f61 7429 0a0a 2020 2020 2020 2020  float)..        
-0001db90: 7365 6c66 2e63 756d 756c 6174 6976 655f  self.cumulative_
-0001dba0: 776f 726b 6572 5f6d 6574 7269 6373 203d  worker_metrics =
-0001dbb0: 2064 6566 6175 6c74 6469 6374 2866 6c6f   defaultdict(flo
-0001dbc0: 6174 290a 0a20 2020 2020 2020 2069 6620  at)..        if 
-0001dbd0: 6e6f 7420 7072 656c 6f61 643a 0a20 2020  not preload:.   
-0001dbe0: 2020 2020 2020 2020 2070 7265 6c6f 6164           preload
-0001dbf0: 203d 2064 6173 6b2e 636f 6e66 6967 2e67   = dask.config.g
-0001dc00: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0001dc10: 7363 6865 6475 6c65 722e 7072 656c 6f61  scheduler.preloa
-0001dc20: 6422 290a 2020 2020 2020 2020 6966 206e  d").        if n
-0001dc30: 6f74 2070 7265 6c6f 6164 5f61 7267 763a  ot preload_argv:
-0001dc40: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-0001dc50: 6c6f 6164 5f61 7267 7620 3d20 6461 736b  load_argv = dask
-0001dc60: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0001dc70: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0001dc80: 6572 2e70 7265 6c6f 6164 2d61 7267 7622  er.preload-argv"
-0001dc90: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
-0001dca0: 7265 6c6f 6164 7320 3d20 7072 656c 6f61  reloads = preloa
-0001dcb0: 6469 6e67 2e70 726f 6365 7373 5f70 7265  ding.process_pre
-0001dcc0: 6c6f 6164 7328 7365 6c66 2c20 7072 656c  loads(self, prel
-0001dcd0: 6f61 642c 2070 7265 6c6f 6164 5f61 7267  oad, preload_arg
-0001dce0: 7629 0a0a 2020 2020 2020 2020 6966 2069  v)..        if i
-0001dcf0: 7369 6e73 7461 6e63 6528 7365 6375 7269  sinstance(securi
-0001dd00: 7479 2c20 6469 6374 293a 0a20 2020 2020  ty, dict):.     
-0001dd10: 2020 2020 2020 2073 6563 7572 6974 7920         security 
-0001dd20: 3d20 5365 6375 7269 7479 282a 2a73 6563  = Security(**sec
-0001dd30: 7572 6974 7929 0a20 2020 2020 2020 2073  urity).        s
-0001dd40: 656c 662e 7365 6375 7269 7479 203d 2073  elf.security = s
-0001dd50: 6563 7572 6974 7920 6f72 2053 6563 7572  ecurity or Secur
-0001dd60: 6974 7928 290a 2020 2020 2020 2020 6173  ity().        as
-0001dd70: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0001dd80: 7365 6c66 2e73 6563 7572 6974 792c 2053  self.security, S
-0001dd90: 6563 7572 6974 7929 0a20 2020 2020 2020  ecurity).       
-0001dda0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0001ddb0: 5f61 7267 7320 3d20 7365 6c66 2e73 6563  _args = self.sec
-0001ddc0: 7572 6974 792e 6765 745f 636f 6e6e 6563  urity.get_connec
-0001ddd0: 7469 6f6e 5f61 7267 7328 2273 6368 6564  tion_args("sched
-0001dde0: 756c 6572 2229 0a20 2020 2020 2020 2073  uler").        s
-0001ddf0: 656c 662e 636f 6e6e 6563 7469 6f6e 5f61  elf.connection_a
-0001de00: 7267 735b 2268 616e 6473 6861 6b65 5f6f  rgs["handshake_o
-0001de10: 7665 7272 6964 6573 225d 203d 207b 2020  verrides"] = {  
-0001de20: 2320 636f 6d6d 6f6e 2064 656e 6f6d 696e  # common denomin
-0001de30: 6174 6f72 0a20 2020 2020 2020 2020 2020  ator.           
-0001de40: 2022 7069 636b 6c65 2d70 726f 746f 636f   "pickle-protoco
-0001de50: 6c22 3a20 340a 2020 2020 2020 2020 7d0a  l": 4.        }.
-0001de60: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
-0001de70: 7461 7274 5f61 6464 7265 7373 203d 2061  tart_address = a
-0001de80: 6464 7265 7373 6573 5f66 726f 6d5f 7573  ddresses_from_us
-0001de90: 6572 5f61 7267 7328 0a20 2020 2020 2020  er_args(.       
-0001dea0: 2020 2020 2068 6f73 743d 686f 7374 2c0a       host=host,.
-0001deb0: 2020 2020 2020 2020 2020 2020 706f 7274              port
-0001dec0: 3d70 6f72 742c 0a20 2020 2020 2020 2020  =port,.         
-0001ded0: 2020 2069 6e74 6572 6661 6365 3d69 6e74     interface=int
-0001dee0: 6572 6661 6365 2c0a 2020 2020 2020 2020  erface,.        
-0001def0: 2020 2020 7072 6f74 6f63 6f6c 3d70 726f      protocol=pro
-0001df00: 746f 636f 6c2c 0a20 2020 2020 2020 2020  tocol,.         
-0001df10: 2020 2073 6563 7572 6974 793d 7365 6375     security=secu
-0001df20: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
-0001df30: 2020 6465 6661 756c 745f 706f 7274 3d73    default_port=s
-0001df40: 656c 662e 6465 6661 756c 745f 706f 7274  elf.default_port
-0001df50: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0001df60: 2020 2020 2068 7474 705f 7365 7276 6572       http_server
-0001df70: 5f6d 6f64 756c 6573 203d 2064 6173 6b2e  _modules = dask.
-0001df80: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0001df90: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0001dfa0: 722e 6874 7470 2e72 6f75 7465 7322 290a  r.http.routes").
-0001dfb0: 2020 2020 2020 2020 7368 6f77 5f64 6173          show_das
-0001dfc0: 6862 6f61 7264 203d 2064 6173 6862 6f61  hboard = dashboa
-0001dfd0: 7264 206f 7220 2864 6173 6862 6f61 7264  rd or (dashboard
-0001dfe0: 2069 7320 4e6f 6e65 2061 6e64 2064 6173   is None and das
-0001dff0: 6862 6f61 7264 5f61 6464 7265 7373 290a  hboard_address).
-0001e000: 2020 2020 2020 2020 2320 696e 7374 616c          # instal
-0001e010: 6c20 7661 6e69 6c6c 6120 726f 7574 6520  l vanilla route 
-0001e020: 6966 2073 686f 775f 6461 7368 626f 6172  if show_dashboar
-0001e030: 6420 6275 7420 626f 6b65 6820 6973 206e  d but bokeh is n
-0001e040: 6f74 2069 6e73 7461 6c6c 6564 0a20 2020  ot installed.   
-0001e050: 2020 2020 2069 6620 7368 6f77 5f64 6173       if show_das
-0001e060: 6862 6f61 7264 3a0a 2020 2020 2020 2020  hboard:.        
-0001e070: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001e080: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
-0001e090: 6469 7374 7269 6275 7465 642e 6461 7368  distributed.dash
-0001e0a0: 626f 6172 642e 7363 6865 6475 6c65 720a  board.scheduler.
-0001e0b0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0001e0c0: 7074 2049 6d70 6f72 7445 7272 6f72 3a0a  pt ImportError:.
-0001e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0e0: 7368 6f77 5f64 6173 6862 6f61 7264 203d  show_dashboard =
-0001e0f0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0001e100: 2020 2020 2020 2068 7474 705f 7365 7276         http_serv
-0001e110: 6572 5f6d 6f64 756c 6573 2e61 7070 656e  er_modules.appen
-0001e120: 6428 2264 6973 7472 6962 7574 6564 2e68  d("distributed.h
-0001e130: 7474 702e 7363 6865 6475 6c65 722e 6d69  ttp.scheduler.mi
-0001e140: 7373 696e 675f 626f 6b65 6822 290a 2020  ssing_bokeh").  
-0001e150: 2020 2020 2020 726f 7574 6573 203d 2067        routes = g
-0001e160: 6574 5f68 616e 646c 6572 7328 0a20 2020  et_handlers(.   
-0001e170: 2020 2020 2020 2020 2073 6572 7665 723d           server=
-0001e180: 7365 6c66 2c20 6d6f 6475 6c65 733d 6874  self, modules=ht
-0001e190: 7470 5f73 6572 7665 725f 6d6f 6475 6c65  tp_server_module
-0001e1a0: 732c 2070 7265 6669 783d 6874 7470 5f70  s, prefix=http_p
-0001e1b0: 7265 6669 780a 2020 2020 2020 2020 290a  refix.        ).
-0001e1c0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-0001e1d0: 7274 5f68 7474 705f 7365 7276 6572 2872  rt_http_server(r
-0001e1e0: 6f75 7465 732c 2064 6173 6862 6f61 7264  outes, dashboard
-0001e1f0: 5f61 6464 7265 7373 2c20 6465 6661 756c  _address, defaul
-0001e200: 745f 706f 7274 3d38 3738 3729 0a20 2020  t_port=8787).   
-0001e210: 2020 2020 2073 656c 662e 6a75 7079 7465       self.jupyte
-0001e220: 7220 3d20 6a75 7079 7465 720a 2020 2020  r = jupyter.    
-0001e230: 2020 2020 6966 2073 686f 775f 6461 7368      if show_dash
-0001e240: 626f 6172 643a 0a20 2020 2020 2020 2020  board:.         
-0001e250: 2020 2064 6973 7472 6962 7574 6564 2e64     distributed.d
-0001e260: 6173 6862 6f61 7264 2e73 6368 6564 756c  ashboard.schedul
-0001e270: 6572 2e63 6f6e 6e65 6374 280a 2020 2020  er.connect(.    
-0001e280: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001e290: 2e68 7474 705f 6170 706c 6963 6174 696f  .http_applicatio
-0001e2a0: 6e2c 2073 656c 662e 6874 7470 5f73 6572  n, self.http_ser
-0001e2b0: 7665 722c 2073 656c 662c 2070 7265 6669  ver, self, prefi
-0001e2c0: 783d 6874 7470 5f70 7265 6669 780a 2020  x=http_prefix.  
-0001e2d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001e2e0: 2020 2020 6966 2073 656c 662e 6a75 7079      if self.jupy
-0001e2f0: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
-0001e300: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001e310: 2020 2020 2020 6672 6f6d 206a 7570 7974        from jupyt
-0001e320: 6572 5f73 6572 7665 722e 7365 7276 6572  er_server.server
-0001e330: 6170 7020 696d 706f 7274 2053 6572 7665  app import Serve
-0001e340: 7241 7070 0a20 2020 2020 2020 2020 2020  rApp.           
-0001e350: 2065 7863 6570 7420 496d 706f 7274 4572   except ImportEr
-0001e360: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0001e370: 2020 2020 2072 6169 7365 2049 6d70 6f72       raise Impor
-0001e380: 7445 7272 6f72 280a 2020 2020 2020 2020  tError(.        
-0001e390: 2020 2020 2020 2020 2020 2020 2249 6e20              "In 
-0001e3a0: 6f72 6465 7220 746f 2075 7365 2074 6865  order to use the
-0001e3b0: 2044 6173 6b20 6a75 7079 7465 7220 6f70   Dask jupyter op
-0001e3c0: 7469 6f6e 2079 6f75 2022 0a20 2020 2020  tion you ".     
-0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001e3e0: 6e65 6564 2074 6f20 6861 7665 206a 7570  need to have jup
-0001e3f0: 7974 6572 6c61 6220 696e 7374 616c 6c65  yterlab installe
-0001e400: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
-0001e410: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001e420: 2066 726f 6d20 7472 6169 746c 6574 732e   from traitlets.
-0001e430: 636f 6e66 6967 2069 6d70 6f72 7420 436f  config import Co
-0001e440: 6e66 6967 0a0a 2020 2020 2020 2020 2020  nfig..          
-0001e450: 2020 6a20 3d20 5365 7276 6572 4170 702e    j = ServerApp.
-0001e460: 696e 7374 616e 6365 280a 2020 2020 2020  instance(.      
-0001e470: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-0001e480: 3d43 6f6e 6669 6728 0a20 2020 2020 2020  =Config(.       
-0001e490: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-0001e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4b0: 2020 2020 2020 2022 5365 7276 6572 4170         "ServerAp
-0001e4c0: 7022 3a20 7b0a 2020 2020 2020 2020 2020  p": {.          
-0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4e0: 2020 2262 6173 655f 7572 6c22 3a20 226a    "base_url": "j
-0001e4f0: 7570 7974 6572 222c 0a20 2020 2020 2020  upyter",.       
-0001e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e510: 2020 2020 2023 2053 4543 5552 4954 593a       # SECURITY:
-0001e520: 2057 6520 7573 7561 6c6c 7920 6578 7065   We usually expe
-0001e530: 6374 2074 6865 2064 6173 6862 6f61 7264  ct the dashboard
-0001e540: 2074 6f20 6265 2061 2072 6561 642d 6f6e   to be a read-on
-0001e550: 6c79 2076 6965 7720 696e 746f 0a20 2020  ly view into.   
-0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e570: 2020 2020 2020 2020 2023 2074 6865 2073           # the s
-0001e580: 6368 6564 756c 6572 2061 6374 6976 6974  cheduler activit
-0001e590: 792e 2048 6f77 6576 6572 2c20 6279 2061  y. However, by a
-0001e5a0: 6464 696e 6720 616e 206f 7065 6e20 4a75  dding an open Ju
-0001e5b0: 7079 7465 7220 6170 706c 6963 6174 696f  pyter applicatio
-0001e5c0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0001e5d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001e5e0: 7765 2061 7265 2061 6c6c 6f77 696e 6720  we are allowing 
-0001e5f0: 6172 6269 7472 6172 7920 7265 6d6f 7465  arbitrary remote
-0001e600: 2063 6f64 6520 6578 6563 7574 696f 6e20   code execution 
-0001e610: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
-0001e620: 2076 6961 2074 6865 0a20 2020 2020 2020   via the.       
-0001e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e640: 2020 2020 2023 2064 6173 6862 6f61 7264       # dashboard
-0001e650: 2073 6572 7665 722e 2054 6869 7320 6f70   server. This op
-0001e660: 7469 6f6e 2073 686f 756c 6420 6f6e 6c79  tion should only
-0001e670: 2062 6520 7573 6564 2077 6865 6e20 7468   be used when th
-0001e680: 6520 6461 7368 626f 6172 6420 6973 0a20  e dashboard is. 
-0001e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6a0: 2020 2020 2020 2020 2020 2023 2070 726f             # pro
-0001e6b0: 7465 6374 6564 2076 6961 206f 7468 6572  tected via other
-0001e6c0: 206d 6561 6e73 2c20 6f72 2077 6865 6e20   means, or when 
-0001e6d0: 796f 7520 646f 6e27 7420 6361 7265 2061  you don't care a
-0001e6e0: 626f 7574 2063 6c75 7374 6572 2073 6563  bout cluster sec
-0001e6f0: 7572 6974 792e 0a20 2020 2020 2020 2020  urity..         
+00018cb0: 2e70 6f70 2877 732e 6164 6472 6573 732c  .pop(ws.address,
+00018cc0: 204e 6f6e 6529 0a20 2020 2020 2020 2065   None).        e
+00018cd0: 6c69 6620 7365 6c66 2e69 735f 756e 6f63  lif self.is_unoc
+00018ce0: 6375 7069 6564 2877 732c 206f 6363 2c20  cupied(ws, occ, 
+00018cf0: 7029 3a0a 2020 2020 2020 2020 2020 2020  p):.            
+00018d00: 7365 6c66 2e69 646c 655b 7773 2e61 6464  self.idle[ws.add
+00018d10: 7265 7373 5d20 3d20 7773 0a20 2020 2020  ress] = ws.     
+00018d20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00018d30: 2020 2020 2073 656c 662e 6964 6c65 2e70       self.idle.p
+00018d40: 6f70 2877 732e 6164 6472 6573 732c 204e  op(ws.address, N
+00018d50: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+00018d60: 206e 6320 3d20 7773 2e6e 7468 7265 6164   nc = ws.nthread
+00018d70: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+00018d80: 2070 203e 206e 633a 0a20 2020 2020 2020   p > nc:.       
+00018d90: 2020 2020 2020 2020 2070 656e 6469 6e67           pending
+00018da0: 203d 206f 6363 202a 2028 7020 2d20 6e63   = occ * (p - nc
+00018db0: 2920 2f20 2870 202a 206e 6329 0a20 2020  ) / (p * nc).   
+00018dc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00018dd0: 302e 3420 3c20 7065 6e64 696e 6720 3e20  0.4 < pending > 
+00018de0: 312e 3920 2a20 2873 656c 662e 746f 7461  1.9 * (self.tota
+00018df0: 6c5f 6f63 6375 7061 6e63 7920 2f20 7365  l_occupancy / se
+00018e00: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
+00018e10: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00018e20: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
+00018e30: 7572 6174 6564 2e61 6464 2877 7329 0a0a  urated.add(ws)..
+00018e40: 2020 2020 2020 2020 6966 206e 6f74 205f          if not _
+00018e50: 776f 726b 6572 5f66 756c 6c28 7773 2c20  worker_full(ws, 
+00018e60: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+00018e70: 5241 5449 4f4e 2920 616e 6420 7773 2e73  RATION) and ws.s
+00018e80: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+00018e90: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+00018ea0: 2020 2020 2073 656c 662e 6964 6c65 5f74       self.idle_t
+00018eb0: 6173 6b5f 636f 756e 742e 6164 6428 7773  ask_count.add(ws
+00018ec0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00018ed0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00018ee0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+00018ef0: 2e64 6973 6361 7264 2877 7329 0a0a 2020  .discard(ws)..  
+00018f00: 2020 6465 6620 6973 5f75 6e6f 6363 7570    def is_unoccup
+00018f10: 6965 6428 0a20 2020 2020 2020 2073 656c  ied(.        sel
+00018f20: 662c 2077 733a 2057 6f72 6b65 7253 7461  f, ws: WorkerSta
+00018f30: 7465 2c20 6f63 6375 7061 6e63 793a 2066  te, occupancy: f
+00018f40: 6c6f 6174 2c20 6e70 726f 6365 7373 696e  loat, nprocessin
+00018f50: 673a 2069 6e74 0a20 2020 2029 202d 3e20  g: int.    ) -> 
+00018f60: 626f 6f6c 3a0a 2020 2020 2020 2020 6e74  bool:.        nt
+00018f70: 6872 6561 6473 203d 2077 732e 6e74 6872  hreads = ws.nthr
+00018f80: 6561 6473 0a20 2020 2020 2020 2072 6574  eads.        ret
+00018f90: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
+00018fa0: 2020 6e70 726f 6365 7373 696e 6720 3c20    nprocessing < 
+00018fb0: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
+00018fc0: 2020 2020 206f 7220 6f63 6375 7061 6e63       or occupanc
+00018fd0: 7920 3c20 6e74 6872 6561 6473 202a 2028  y < nthreads * (
+00018fe0: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
+00018ff0: 616e 6379 202f 2073 656c 662e 746f 7461  ancy / self.tota
+00019000: 6c5f 6e74 6872 6561 6473 2920 2f20 320a  l_nthreads) / 2.
+00019010: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00019020: 6566 2067 6574 5f63 6f6d 6d5f 636f 7374  ef get_comm_cost
+00019030: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+00019040: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
+00019050: 5374 6174 6529 202d 3e20 666c 6f61 743a  State) -> float:
+00019060: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00019070: 2020 2020 2047 6574 2074 6865 2065 7374       Get the est
+00019080: 696d 6174 6564 2063 6f6d 6d75 6e69 6361  imated communica
+00019090: 7469 6f6e 2063 6f73 7420 2869 6e20 732e  tion cost (in s.
+000190a0: 2920 746f 2063 6f6d 7075 7465 2074 6865  ) to compute the
+000190b0: 2074 6173 6b0a 2020 2020 2020 2020 6f6e   task.        on
+000190c0: 2074 6865 2067 6976 656e 2077 6f72 6b65   the given worke
+000190d0: 722e 0a20 2020 2020 2020 2022 2222 0a20  r..        """. 
+000190e0: 2020 2020 2020 2069 6620 3130 202a 206c         if 10 * l
+000190f0: 656e 2874 732e 6465 7065 6e64 656e 6369  en(ts.dependenci
+00019100: 6573 2920 3c20 6c65 6e28 7773 2e68 6173  es) < len(ws.has
+00019110: 5f77 6861 7429 3a0a 2020 2020 2020 2020  _what):.        
+00019120: 2020 2020 2320 496e 2074 6865 2063 6f6d      # In the com
+00019130: 6d6f 6e20 6361 7365 2077 6865 7265 2074  mon case where t
+00019140: 6865 206e 756d 6265 7220 6f66 2064 6570  he number of dep
+00019150: 656e 6465 6e63 6965 7320 6973 0a20 2020  endencies is.   
+00019160: 2020 2020 2020 2020 2023 206d 7563 6820           # much 
+00019170: 6c65 7373 2074 6861 6e20 7468 6520 6e75  less than the nu
+00019180: 6d62 6572 206f 6620 7461 736b 7320 7468  mber of tasks th
+00019190: 6174 2077 6520 6861 7665 2c0a 2020 2020  at we have,.    
+000191a0: 2020 2020 2020 2020 2320 636f 6e73 7472          # constr
+000191b0: 7563 7420 7468 6520 7365 7420 6f66 2064  uct the set of d
+000191c0: 6570 7320 7468 6174 2072 6571 7569 7265  eps that require
+000191d0: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2069   communication i
+000191e0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+000191f0: 4f28 6c65 6e28 6465 7065 6e64 656e 6369  O(len(dependenci
+00019200: 6573 2929 2072 6174 6865 7220 7468 616e  es)) rather than
+00019210: 204f 286c 656e 2868 6173 5f77 6861 7429   O(len(has_what)
+00019220: 2920 7469 6d65 2e0a 2020 2020 2020 2020  ) time..        
+00019230: 2020 2020 2320 4661 6374 6f72 206f 6620      # Factor of 
+00019240: 3130 2069 7320 6120 6775 6573 7320 6174  10 is a guess at
+00019250: 2074 6865 206f 7665 7268 6561 6420 6f66   the overhead of
+00019260: 2065 7870 6c69 6369 740a 2020 2020 2020   explicit.      
+00019270: 2020 2020 2020 2320 6974 6572 6174 696f        # iteratio
+00019280: 6e20 6173 206f 7070 6f73 6564 2074 6f20  n as opposed to 
+00019290: 6a75 7374 2063 616c 6c69 6e67 2073 6574  just calling set
+000192a0: 2e64 6966 6665 7265 6e63 650a 2020 2020  .difference.    
+000192b0: 2020 2020 2020 2020 6465 7073 203d 207b          deps = {
+000192c0: 6465 7020 666f 7220 6465 7020 696e 2074  dep for dep in t
+000192d0: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
+000192e0: 6620 6465 7020 6e6f 7420 696e 2077 732e  f dep not in ws.
+000192f0: 6861 735f 7768 6174 7d0a 2020 2020 2020  has_what}.      
+00019300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019310: 2020 2020 6465 7073 203d 2074 732e 6465      deps = ts.de
+00019320: 7065 6e64 656e 6369 6573 2e64 6966 6665  pendencies.diffe
+00019330: 7265 6e63 6528 7773 2e68 6173 5f77 6861  rence(ws.has_wha
+00019340: 7429 0a20 2020 2020 2020 206e 6279 7465  t).        nbyte
+00019350: 7320 3d20 7375 6d28 6474 732e 6e62 7974  s = sum(dts.nbyt
+00019360: 6573 2066 6f72 2064 7473 2069 6e20 6465  es for dts in de
+00019370: 7073 290a 2020 2020 2020 2020 7265 7475  ps).        retu
+00019380: 726e 206e 6279 7465 7320 2f20 7365 6c66  rn nbytes / self
+00019390: 2e62 616e 6477 6964 7468 0a0a 2020 2020  .bandwidth..    
+000193a0: 6465 6620 6765 745f 7461 736b 5f64 7572  def get_task_dur
+000193b0: 6174 696f 6e28 7365 6c66 2c20 7473 3a20  ation(self, ts: 
+000193c0: 5461 736b 5374 6174 6529 202d 3e20 666c  TaskState) -> fl
+000193d0: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
+000193e0: 4765 7420 7468 6520 6573 7469 6d61 7465  Get the estimate
+000193f0: 6420 636f 6d70 7574 6174 696f 6e20 636f  d computation co
+00019400: 7374 206f 6620 7468 6520 6769 7665 6e20  st of the given 
+00019410: 7461 736b 2028 6e6f 7420 696e 636c 7564  task (not includ
+00019420: 696e 670a 2020 2020 2020 2020 616e 7920  ing.        any 
+00019430: 636f 6d6d 756e 6963 6174 696f 6e20 636f  communication co
+00019440: 7374 292e 0a0a 2020 2020 2020 2020 4966  st)...        If
+00019450: 206e 6f20 6461 7461 2068 6173 2062 6565   no data has bee
+00019460: 6e20 6f62 7365 7276 6564 2c20 7661 6c75  n observed, valu
+00019470: 6520 6f66 0a20 2020 2020 2020 2060 6469  e of.        `di
+00019480: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00019490: 6c65 722e 6465 6661 756c 742d 7461 736b  ler.default-task
+000194a0: 2d64 7572 6174 696f 6e73 6020 6172 6520  -durations` are 
+000194b0: 7573 6564 2e20 4966 206e 6f6e 6520 6973  used. If none is
+000194c0: 2073 6574 0a20 2020 2020 2020 2066 6f72   set.        for
+000194d0: 2074 6869 7320 7461 736b 2c20 6064 6973   this task, `dis
+000194e0: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+000194f0: 6572 2e75 6e6b 6e6f 776e 2d74 6173 6b2d  er.unknown-task-
+00019500: 6475 7261 7469 6f6e 6020 6973 2075 7365  duration` is use
+00019510: 640a 2020 2020 2020 2020 696e 7374 6561  d.        instea
+00019520: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+00019530: 2020 2020 2020 2064 7572 6174 696f 6e3a         duration:
+00019540: 2066 6c6f 6174 203d 2074 732e 7072 6566   float = ts.pref
+00019550: 6978 2e64 7572 6174 696f 6e5f 6176 6572  ix.duration_aver
+00019560: 6167 650a 2020 2020 2020 2020 6966 2064  age.        if d
+00019570: 7572 6174 696f 6e20 3e3d 2030 3a0a 2020  uration >= 0:.  
+00019580: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00019590: 2064 7572 6174 696f 6e0a 0a20 2020 2020   duration..     
+000195a0: 2020 2073 203d 2073 656c 662e 756e 6b6e     s = self.unkn
+000195b0: 6f77 6e5f 6475 7261 7469 6f6e 732e 6765  own_durations.ge
+000195c0: 7428 7473 2e70 7265 6669 782e 6e61 6d65  t(ts.prefix.name
+000195d0: 290a 2020 2020 2020 2020 6966 2073 2069  ).        if s i
+000195e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000195f0: 2020 2020 7365 6c66 2e75 6e6b 6e6f 776e      self.unknown
+00019600: 5f64 7572 6174 696f 6e73 5b74 732e 7072  _durations[ts.pr
+00019610: 6566 6978 2e6e 616d 655d 203d 2073 203d  efix.name] = s =
+00019620: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
+00019630: 2e61 6464 2874 7329 0a20 2020 2020 2020  .add(ts).       
+00019640: 2072 6574 7572 6e20 7365 6c66 2e55 4e4b   return self.UNK
+00019650: 4e4f 574e 5f54 4153 4b5f 4455 5241 5449  NOWN_TASK_DURATI
+00019660: 4f4e 0a0a 2020 2020 6465 6620 7661 6c69  ON..    def vali
+00019670: 645f 776f 726b 6572 7328 7365 6c66 2c20  d_workers(self, 
+00019680: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+00019690: 3e20 7365 745b 576f 726b 6572 5374 6174  > set[WorkerStat
+000196a0: 655d 207c 204e 6f6e 653a 0a20 2020 2020  e] | None:.     
+000196b0: 2020 2022 2222 5265 7475 726e 2073 6574     """Return set
+000196c0: 206f 6620 6375 7272 656e 746c 7920 7661   of currently va
+000196d0: 6c69 6420 776f 726b 6572 7320 666f 7220  lid workers for 
+000196e0: 6b65 790a 0a20 2020 2020 2020 2049 6620  key..        If 
+000196f0: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
+00019700: 7661 6c69 6420 7468 656e 2074 6869 7320  valid then this 
+00019710: 7265 7475 726e 7320 6060 4e6f 6e65 6060  returns ``None``
+00019720: 2c20 696e 2077 6869 6368 2063 6173 650a  , in which case.
+00019730: 2020 2020 2020 2020 616e 7920 2a72 756e          any *run
+00019740: 6e69 6e67 2a20 776f 726b 6572 2063 616e  ning* worker can
+00019750: 2062 6520 7573 6564 2e0a 2020 2020 2020   be used..      
+00019760: 2020 4f74 6865 7277 6973 652c 2074 6865    Otherwise, the
+00019770: 2073 7562 7365 7420 6f66 2072 756e 6e69   subset of runni
+00019780: 6e67 2077 6f72 6b65 7273 2076 616c 6964  ng workers valid
+00019790: 2066 6f72 2074 6869 7320 7461 736b 0a20   for this task. 
+000197a0: 2020 2020 2020 2069 7320 7265 7475 726e         is return
+000197b0: 6564 2e0a 2020 2020 2020 2020 5468 6973  ed..        This
+000197c0: 2063 6865 636b 7320 7472 6163 6b73 2074   checks tracks t
+000197d0: 6865 2066 6f6c 6c6f 7769 6e67 2073 7461  he following sta
+000197e0: 7465 3a0a 0a20 2020 2020 2020 202a 2020  te:..        *  
+000197f0: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+00019800: 6f6e 730a 2020 2020 2020 2020 2a20 2068  ons.        *  h
+00019810: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+00019820: 0a20 2020 2020 2020 202a 2020 7265 736f  .        *  reso
+00019830: 7572 6365 5f72 6573 7472 6963 7469 6f6e  urce_restriction
+00019840: 730a 2020 2020 2020 2020 2222 220a 2020  s.        """.  
+00019850: 2020 2020 2020 733a 2073 6574 5b73 7472        s: set[str
+00019860: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
+00019870: 0a20 2020 2020 2020 2069 6620 7473 2e77  .        if ts.w
+00019880: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+00019890: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+000198a0: 7320 3d20 7b61 6464 7220 666f 7220 6164  s = {addr for ad
+000198b0: 6472 2069 6e20 7473 2e77 6f72 6b65 725f  dr in ts.worker_
+000198c0: 7265 7374 7269 6374 696f 6e73 2069 6620  restrictions if 
+000198d0: 6164 6472 2069 6e20 7365 6c66 2e77 6f72  addr in self.wor
+000198e0: 6b65 7273 7d0a 0a20 2020 2020 2020 2069  kers}..        i
+000198f0: 6620 7473 2e68 6f73 745f 7265 7374 7269  f ts.host_restri
+00019900: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+00019910: 2020 2020 2320 5265 736f 6c76 6520 7468      # Resolve th
+00019920: 6520 616c 6961 7320 6865 7265 2072 6174  e alias here rat
+00019930: 6865 7220 7468 616e 2065 6172 6c79 2c20  her than early, 
+00019940: 666f 7220 7468 6520 776f 726b 6572 0a20  for the worker. 
+00019950: 2020 2020 2020 2020 2020 2023 206d 6179             # may
+00019960: 206e 6f74 2062 6520 636f 6e6e 6563 7465   not be connecte
+00019970: 6420 7768 656e 2068 6f73 745f 7265 7374  d when host_rest
+00019980: 7269 6374 696f 6e73 2069 7320 706f 7075  rictions is popu
+00019990: 6c61 7465 640a 2020 2020 2020 2020 2020  lated.          
+000199a0: 2020 6872 203d 205b 7365 6c66 2e63 6f65    hr = [self.coe
+000199b0: 7263 655f 686f 7374 6e61 6d65 2868 2920  rce_hostname(h) 
+000199c0: 666f 7220 6820 696e 2074 732e 686f 7374  for h in ts.host
+000199d0: 5f72 6573 7472 6963 7469 6f6e 735d 0a20  _restrictions]. 
+000199e0: 2020 2020 2020 2020 2020 2023 2058 5858             # XXX
+000199f0: 206e 6565 6420 486f 7374 5374 6174 653f   need HostState?
+00019a00: 0a20 2020 2020 2020 2020 2020 2073 6c20  .            sl 
+00019a10: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00019a20: 2066 6f72 2068 2069 6e20 6872 3a0a 2020   for h in hr:.  
+00019a30: 2020 2020 2020 2020 2020 2020 2020 6468                dh
+00019a40: 203d 2073 656c 662e 686f 7374 5f69 6e66   = self.host_inf
+00019a50: 6f2e 6765 7428 6829 0a20 2020 2020 2020  o.get(h).       
+00019a60: 2020 2020 2020 2020 2069 6620 6468 2069           if dh i
+00019a70: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00019a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a90: 736c 2e61 7070 656e 6428 6468 5b22 6164  sl.append(dh["ad
+00019aa0: 6472 6573 7365 7322 5d29 0a0a 2020 2020  dresses"])..    
+00019ab0: 2020 2020 2020 2020 7373 203d 2073 6574          ss = set
+00019ac0: 2e75 6e69 6f6e 282a 736c 2920 6966 2073  .union(*sl) if s
+00019ad0: 6c20 656c 7365 2073 6574 2829 0a20 2020  l else set().   
+00019ae0: 2020 2020 2020 2020 2069 6620 7320 6973           if s is
+00019af0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00019b00: 2020 2020 2020 2073 203d 2073 730a 2020         s = ss.  
+00019b10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00019b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b30: 7320 7c3d 2073 730a 0a20 2020 2020 2020  s |= ss..       
+00019b40: 2069 6620 7473 2e72 6573 6f75 7263 655f   if ts.resource_
+00019b50: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
+00019b60: 2020 2020 2020 2020 2020 6477 203d 207b            dw = {
+00019b70: 7d0a 2020 2020 2020 2020 2020 2020 666f  }.            fo
+00019b80: 7220 7265 736f 7572 6365 2c20 7265 7175  r resource, requ
+00019b90: 6972 6564 2069 6e20 7473 2e72 6573 6f75  ired in ts.resou
+00019ba0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+00019bb0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00019bc0: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
+00019bd0: 656c 662e 7265 736f 7572 6365 732e 6765  elf.resources.ge
+00019be0: 7428 7265 736f 7572 6365 290a 2020 2020  t(resource).    
+00019bf0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00019c00: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
+00019c10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00019c20: 656c 662e 7265 736f 7572 6365 735b 7265  elf.resources[re
+00019c30: 736f 7572 6365 5d20 3d20 6472 203d 207b  source] = dr = {
+00019c40: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00019c50: 2020 2073 7720 3d20 7365 7428 290a 2020     sw = set().  
+00019c60: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00019c70: 7220 6164 6472 2c20 7375 7070 6c69 6564  r addr, supplied
+00019c80: 2069 6e20 6472 2e69 7465 6d73 2829 3a0a   in dr.items():.
+00019c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ca0: 2020 2020 6966 2073 7570 706c 6965 6420      if supplied 
+00019cb0: 3e3d 2072 6571 7569 7265 643a 0a20 2020  >= required:.   
+00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cd0: 2020 2020 2073 772e 6164 6428 6164 6472       sw.add(addr
+00019ce0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00019cf0: 2020 2064 775b 7265 736f 7572 6365 5d20     dw[resource] 
+00019d00: 3d20 7377 0a0a 2020 2020 2020 2020 2020  = sw..          
+00019d10: 2020 7777 203d 2073 6574 2e69 6e74 6572    ww = set.inter
+00019d20: 7365 6374 696f 6e28 2a64 772e 7661 6c75  section(*dw.valu
+00019d30: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+00019d40: 2020 6966 2073 2069 7320 4e6f 6e65 3a0a    if s is None:.
+00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d60: 7320 3d20 7777 0a20 2020 2020 2020 2020  s = ww.         
+00019d70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00019d80: 2020 2020 2020 2020 2073 2026 3d20 7777           s &= ww
+00019d90: 0a0a 2020 2020 2020 2020 6966 2073 2069  ..        if s i
+00019da0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00019db0: 2020 2020 7265 7475 726e 204e 6f6e 6520      return None 
+00019dc0: 2023 2041 6c6c 2077 6f72 6b65 7273 2061   # All workers a
+00019dd0: 7265 2076 616c 6964 0a20 2020 2020 2020  re valid.       
+00019de0: 2069 6620 6e6f 7420 733a 0a20 2020 2020   if not s:.     
+00019df0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00019e00: 7428 2920 2023 204e 6f20 776f 726b 6572  t()  # No worker
+00019e10: 7320 6172 6520 7661 6c69 640a 0a20 2020  s are valid..   
+00019e20: 2020 2020 2023 2053 6f6d 6520 776f 726b       # Some work
+00019e30: 6572 7320 6172 6520 7661 6c69 640a 2020  ers are valid.  
+00019e40: 2020 2020 2020 735f 7773 203d 207b 7365        s_ws = {se
+00019e50: 6c66 2e77 6f72 6b65 7273 5b61 6464 725d  lf.workers[addr]
+00019e60: 2066 6f72 2061 6464 7220 696e 2073 7d0a   for addr in s}.
+00019e70: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+00019e80: 656c 662e 7275 6e6e 696e 6729 203c 206c  elf.running) < l
+00019e90: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
+00019ea0: 3a0a 2020 2020 2020 2020 2020 2020 735f  :.            s_
+00019eb0: 7773 2026 3d20 7365 6c66 2e72 756e 6e69  ws &= self.runni
+00019ec0: 6e67 0a20 2020 2020 2020 2072 6574 7572  ng.        retur
+00019ed0: 6e20 735f 7773 0a0a 2020 2020 6465 6620  n s_ws..    def 
+00019ee0: 6163 7175 6972 655f 7265 736f 7572 6365  acquire_resource
+00019ef0: 7328 7365 6c66 2c20 7473 3a20 5461 736b  s(self, ts: Task
+00019f00: 5374 6174 652c 2077 733a 2057 6f72 6b65  State, ws: Worke
+00019f10: 7253 7461 7465 2920 2d3e 204e 6f6e 653a  rState) -> None:
+00019f20: 0a20 2020 2020 2020 2066 6f72 2072 2c20  .        for r, 
+00019f30: 7265 7175 6972 6564 2069 6e20 7473 2e72  required in ts.r
+00019f40: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
+00019f50: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
+00019f60: 2020 2020 2020 2020 2020 7773 2e75 7365            ws.use
+00019f70: 645f 7265 736f 7572 6365 735b 725d 202b  d_resources[r] +
+00019f80: 3d20 7265 7175 6972 6564 0a0a 2020 2020  = required..    
+00019f90: 6465 6620 7265 6c65 6173 655f 7265 736f  def release_reso
+00019fa0: 7572 6365 7328 7365 6c66 2c20 7473 3a20  urces(self, ts: 
+00019fb0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
+00019fc0: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
+00019fd0: 6f6e 653a 0a20 2020 2020 2020 2066 6f72  one:.        for
+00019fe0: 2072 2c20 7265 7175 6972 6564 2069 6e20   r, required in 
+00019ff0: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
+0001a000: 7269 6374 696f 6e73 2e69 7465 6d73 2829  rictions.items()
+0001a010: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+0001a020: 2e75 7365 645f 7265 736f 7572 6365 735b  .used_resources[
+0001a030: 725d 202d 3d20 7265 7175 6972 6564 0a0a  r] -= required..
+0001a040: 2020 2020 6465 6620 636f 6572 6365 5f68      def coerce_h
+0001a050: 6f73 746e 616d 6528 7365 6c66 2c20 686f  ostname(self, ho
+0001a060: 7374 3a20 4861 7368 6162 6c65 2920 2d3e  st: Hashable) ->
+0001a070: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
+0001a080: 220a 2020 2020 2020 2020 436f 6572 6365  ".        Coerce
+0001a090: 2074 6865 2068 6f73 746e 616d 6520 6f66   the hostname of
+0001a0a0: 2061 2077 6f72 6b65 722e 0a20 2020 2020   a worker..     
+0001a0b0: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
+0001a0c0: 6c69 6173 203d 2073 656c 662e 616c 6961  lias = self.alia
+0001a0d0: 7365 732e 6765 7428 686f 7374 290a 2020  ses.get(host).  
+0001a0e0: 2020 2020 2020 6966 2061 6c69 6173 2069        if alias i
+0001a0f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001a100: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
+0001a110: 662e 776f 726b 6572 735b 616c 6961 735d  f.workers[alias]
+0001a120: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001a130: 7572 6e20 7773 2e68 6f73 740a 2020 2020  urn ws.host.    
+0001a140: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001a150: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0001a160: 6e73 7461 6e63 6528 686f 7374 2c20 7374  nstance(host, st
+0001a170: 7229 0a20 2020 2020 2020 2020 2020 2072  r).            r
+0001a180: 6574 7572 6e20 686f 7374 0a0a 2020 2020  eturn host..    
+0001a190: 6465 6620 776f 726b 6572 5f6f 626a 6563  def worker_objec
+0001a1a0: 7469 7665 2873 656c 662c 2074 733a 2054  tive(self, ts: T
+0001a1b0: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
+0001a1c0: 726b 6572 5374 6174 6529 202d 3e20 7475  rkerState) -> tu
+0001a1d0: 706c 653a 0a20 2020 2020 2020 2022 2222  ple:.        """
+0001a1e0: 4f62 6a65 6374 6976 6520 6675 6e63 7469  Objective functi
+0001a1f0: 6f6e 2074 6f20 6465 7465 726d 696e 6520  on to determine 
+0001a200: 7768 6963 6820 776f 726b 6572 2073 686f  which worker sho
+0001a210: 756c 6420 6765 7420 7468 6520 7461 736b  uld get the task
+0001a220: 0a0a 2020 2020 2020 2020 4d69 6e69 6d69  ..        Minimi
+0001a230: 7a65 2065 7870 6563 7465 6420 7374 6172  ze expected star
+0001a240: 7420 7469 6d65 2e20 2049 6620 6120 7469  t time.  If a ti
+0001a250: 6520 7468 656e 2062 7265 616b 2077 6974  e then break wit
+0001a260: 6820 6461 7461 2073 746f 7261 6765 2e0a  h data storage..
+0001a270: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001a280: 2020 2020 636f 6d6d 5f62 7974 6573 203d      comm_bytes =
+0001a290: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
+0001a2a0: 2020 6474 732e 6765 745f 6e62 7974 6573    dts.get_nbytes
+0001a2b0: 2829 2066 6f72 2064 7473 2069 6e20 7473  () for dts in ts
+0001a2c0: 2e64 6570 656e 6465 6e63 6965 7320 6966  .dependencies if
+0001a2d0: 2077 7320 6e6f 7420 696e 2064 7473 2e77   ws not in dts.w
+0001a2e0: 686f 5f68 6173 0a20 2020 2020 2020 2029  ho_has.        )
+0001a2f0: 0a0a 2020 2020 2020 2020 7374 6163 6b5f  ..        stack_
+0001a300: 7469 6d65 203d 2077 732e 6f63 6375 7061  time = ws.occupa
+0001a310: 6e63 7920 2f20 7773 2e6e 7468 7265 6164  ncy / ws.nthread
+0001a320: 730a 2020 2020 2020 2020 7374 6172 745f  s.        start_
+0001a330: 7469 6d65 203d 2073 7461 636b 5f74 696d  time = stack_tim
+0001a340: 6520 2b20 636f 6d6d 5f62 7974 6573 202f  e + comm_bytes /
+0001a350: 2073 656c 662e 6261 6e64 7769 6474 680a   self.bandwidth.
+0001a360: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
+0001a370: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
+0001a380: 2020 7265 7475 726e 2028 6c65 6e28 7773    return (len(ws
+0001a390: 2e61 6374 6f72 7329 2c20 7374 6172 745f  .actors), start_
+0001a3a0: 7469 6d65 2c20 7773 2e6e 6279 7465 7329  time, ws.nbytes)
+0001a3b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001a3c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001a3d0: 6e20 2873 7461 7274 5f74 696d 652c 2077  n (start_time, w
+0001a3e0: 732e 6e62 7974 6573 290a 0a20 2020 2064  s.nbytes)..    d
+0001a3f0: 6566 2061 6464 5f72 6570 6c69 6361 2873  ef add_replica(s
+0001a400: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+0001a410: 7465 2c20 7773 3a20 576f 726b 6572 5374  te, ws: WorkerSt
+0001a420: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+0001a430: 2020 2020 2020 2222 224e 6f74 6520 7468        """Note th
+0001a440: 6174 2061 2077 6f72 6b65 7220 686f 6c64  at a worker hold
+0001a450: 7320 6120 7265 706c 6963 6120 6f66 2061  s a replica of a
+0001a460: 2074 6173 6b20 7769 7468 2073 7461 7465   task with state
+0001a470: 3d27 6d65 6d6f 7279 2722 2222 0a20 2020  ='memory'""".   
+0001a480: 2020 2020 2077 732e 6164 645f 7265 706c       ws.add_repl
+0001a490: 6963 6128 7473 290a 2020 2020 2020 2020  ica(ts).        
+0001a4a0: 6966 206c 656e 2874 732e 7768 6f5f 6861  if len(ts.who_ha
+0001a4b0: 7329 203d 3d20 323a 0a20 2020 2020 2020  s) == 2:.       
+0001a4c0: 2020 2020 2073 656c 662e 7265 706c 6963       self.replic
+0001a4d0: 6174 6564 5f74 6173 6b73 2e61 6464 2874  ated_tasks.add(t
+0001a4e0: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
+0001a4f0: 7665 5f72 6570 6c69 6361 2873 656c 662c  ve_replica(self,
+0001a500: 2074 733a 2054 6173 6b53 7461 7465 2c20   ts: TaskState, 
+0001a510: 7773 3a20 576f 726b 6572 5374 6174 6529  ws: WorkerState)
+0001a520: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001a530: 2020 2222 224e 6f74 6520 7468 6174 2061    """Note that a
+0001a540: 2077 6f72 6b65 7220 6e6f 206c 6f6e 6765   worker no longe
+0001a550: 7220 686f 6c64 7320 6120 7265 706c 6963  r holds a replic
+0001a560: 6120 6f66 2061 2074 6173 6b22 2222 0a20  a of a task""". 
+0001a570: 2020 2020 2020 2077 732e 7265 6d6f 7665         ws.remove
+0001a580: 5f72 6570 6c69 6361 2874 7329 0a20 2020  _replica(ts).   
+0001a590: 2020 2020 2069 6620 6c65 6e28 7473 2e77       if len(ts.w
+0001a5a0: 686f 5f68 6173 2920 3d3d 2031 3a0a 2020  ho_has) == 1:.  
+0001a5b0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+0001a5c0: 6570 6c69 6361 7465 645f 7461 736b 732e  eplicated_tasks.
+0001a5d0: 7265 6d6f 7665 2874 7329 0a0a 2020 2020  remove(ts)..    
+0001a5e0: 6465 6620 7265 6d6f 7665 5f61 6c6c 5f72  def remove_all_r
+0001a5f0: 6570 6c69 6361 7328 7365 6c66 2c20 7473  eplicas(self, ts
+0001a600: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+0001a610: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0001a620: 2252 656d 6f76 6520 616c 6c20 7265 706c  "Remove all repl
+0001a630: 6963 6173 206f 6620 6120 7461 736b 2066  icas of a task f
+0001a640: 726f 6d20 616c 6c20 776f 726b 6572 7322  rom all workers"
+0001a650: 2222 0a20 2020 2020 2020 206e 6279 7465  "".        nbyte
+0001a660: 7320 3d20 7473 2e67 6574 5f6e 6279 7465  s = ts.get_nbyte
+0001a670: 7328 290a 2020 2020 2020 2020 666f 7220  s().        for 
+0001a680: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+0001a690: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+0001a6a0: 2e6e 6279 7465 7320 2d3d 206e 6279 7465  .nbytes -= nbyte
+0001a6b0: 730a 2020 2020 2020 2020 2020 2020 6465  s.            de
+0001a6c0: 6c20 7773 2e5f 6861 735f 7768 6174 5b74  l ws._has_what[t
+0001a6d0: 735d 0a20 2020 2020 2020 2069 6620 6c65  s].        if le
+0001a6e0: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
+0001a6f0: 313a 0a20 2020 2020 2020 2020 2020 2073  1:.            s
+0001a700: 656c 662e 7265 706c 6963 6174 6564 5f74  elf.replicated_t
+0001a710: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
+0001a720: 2020 2020 2020 2020 7473 2e77 686f 5f68          ts.who_h
+0001a730: 6173 2e63 6c65 6172 2829 0a0a 2020 2020  as.clear()..    
+0001a740: 6465 6620 6275 6c6b 5f73 6368 6564 756c  def bulk_schedul
+0001a750: 655f 756e 7275 6e6e 6162 6c65 5f61 6674  e_unrunnable_aft
+0001a760: 6572 5f61 6464 696e 675f 776f 726b 6572  er_adding_worker
+0001a770: 2873 656c 662c 2077 733a 2057 6f72 6b65  (self, ws: Worke
+0001a780: 7253 7461 7465 2920 2d3e 2052 6563 733a  rState) -> Recs:
+0001a790: 0a20 2020 2020 2020 2022 2222 5365 6e64  .        """Send
+0001a7a0: 2060 606e 6f2d 776f 726b 6572 6060 2074   ``no-worker`` t
+0001a7b0: 6173 6b73 2074 6f20 6060 7072 6f63 6573  asks to ``proces
+0001a7c0: 7369 6e67 6060 2074 6861 7420 7468 6973  sing`` that this
+0001a7d0: 2077 6f72 6b65 7220 6361 6e20 6861 6e64   worker can hand
+0001a7e0: 6c65 2e0a 0a20 2020 2020 2020 2052 6574  le...        Ret
+0001a7f0: 7572 6e73 2070 7269 6f72 6974 792d 6f72  urns priority-or
+0001a800: 6465 7265 6420 7265 636f 6d6d 656e 6461  dered recommenda
+0001a810: 7469 6f6e 732e 0a20 2020 2020 2020 2022  tions..        "
+0001a820: 2222 0a20 2020 2020 2020 2072 756e 6e61  "".        runna
+0001a830: 626c 653a 206c 6973 745b 5461 736b 5374  ble: list[TaskSt
+0001a840: 6174 655d 203d 205b 5d0a 2020 2020 2020  ate] = [].      
+0001a850: 2020 666f 7220 7473 2069 6e20 7365 6c66    for ts in self
+0001a860: 2e75 6e72 756e 6e61 626c 653a 0a20 2020  .unrunnable:.   
+0001a870: 2020 2020 2020 2020 2076 616c 6964 203d           valid =
+0001a880: 2073 656c 662e 7661 6c69 645f 776f 726b   self.valid_work
+0001a890: 6572 7328 7473 290a 2020 2020 2020 2020  ers(ts).        
+0001a8a0: 2020 2020 6966 2076 616c 6964 2069 7320      if valid is 
+0001a8b0: 4e6f 6e65 206f 7220 7773 2069 6e20 7661  None or ws in va
+0001a8c0: 6c69 643a 0a20 2020 2020 2020 2020 2020  lid:.           
+0001a8d0: 2020 2020 2072 756e 6e61 626c 652e 6170       runnable.ap
+0001a8e0: 7065 6e64 2874 7329 0a0a 2020 2020 2020  pend(ts)..      
+0001a8f0: 2020 2320 5265 636f 6d6d 656e 6461 7469    # Recommendati
+0001a900: 6f6e 7320 6172 6520 7072 6f63 6573 7365  ons are processe
+0001a910: 6420 4c49 464f 2c20 6865 6e63 6520 7468  d LIFO, hence th
+0001a920: 6520 7265 7665 7273 6564 206f 7264 6572  e reversed order
+0001a930: 0a20 2020 2020 2020 2072 756e 6e61 626c  .        runnabl
+0001a940: 652e 736f 7274 286b 6579 3d6f 7065 7261  e.sort(key=opera
+0001a950: 746f 722e 6174 7472 6765 7474 6572 2822  tor.attrgetter("
+0001a960: 7072 696f 7269 7479 2229 2c20 7265 7665  priority"), reve
+0001a970: 7273 653d 5472 7565 290a 2020 2020 2020  rse=True).      
+0001a980: 2020 7265 7475 726e 207b 7473 2e6b 6579    return {ts.key
+0001a990: 3a20 2270 726f 6365 7373 696e 6722 2066  : "processing" f
+0001a9a0: 6f72 2074 7320 696e 2072 756e 6e61 626c  or ts in runnabl
+0001a9b0: 657d 0a0a 2020 2020 6465 6620 5f76 616c  e}..    def _val
+0001a9c0: 6964 6174 655f 7265 6164 7928 7365 6c66  idate_ready(self
+0001a9d0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+0001a9e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001a9f0: 2020 2222 2256 616c 6964 6174 696f 6e20    """Validation 
+0001aa00: 666f 7220 7265 6164 7920 7374 6174 6573  for ready states
+0001aa10: 2028 7072 6f63 6573 7369 6e67 2c20 7175   (processing, qu
+0001aa20: 6575 6564 2c20 6e6f 2d77 6f72 6b65 7229  eued, no-worker)
+0001aa30: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
+0001aa40: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+0001aa50: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
+0001aa60: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+0001aa70: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
+0001aa80: 7420 6e6f 7420 7473 2e65 7863 6570 7469  t not ts.excepti
+0001aa90: 6f6e 5f62 6c61 6d65 0a20 2020 2020 2020  on_blame.       
+0001aaa0: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
+0001aab0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+0001aac0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0001aad0: 7473 2e68 6173 5f6c 6f73 745f 6465 7065  ts.has_lost_depe
+0001aae0: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+0001aaf0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
+0001ab00: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
+0001ab10: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
+0001ab20: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
+0001ab30: 7175 6575 6564 0a20 2020 2020 2020 2061  queued.        a
+0001ab40: 7373 6572 7420 616c 6c28 6474 732e 7768  ssert all(dts.wh
+0001ab50: 6f5f 6861 7320 666f 7220 6474 7320 696e  o_has for dts in
+0001ab60: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+0001ab70: 290a 0a20 2020 2064 6566 205f 6164 645f  )..    def _add_
+0001ab80: 746f 5f70 726f 6365 7373 696e 6728 7365  to_processing(se
+0001ab90: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+0001aba0: 652c 2077 733a 2057 6f72 6b65 7253 7461  e, ws: WorkerSta
+0001abb0: 7465 2920 2d3e 204d 7367 733a 0a20 2020  te) -> Msgs:.   
+0001abc0: 2020 2020 2022 2222 5365 7420 6120 7461       """Set a ta
+0001abd0: 736b 2061 7320 7072 6f63 6573 7369 6e67  sk as processing
+0001abe0: 206f 6e20 6120 776f 726b 6572 2061 6e64   on a worker and
+0001abf0: 2072 6574 7572 6e20 7468 6520 776f 726b   return the work
+0001ac00: 6572 206d 6573 7361 6765 7320 746f 2073  er messages to s
+0001ac10: 656e 6422 2222 0a20 2020 2020 2020 2069  end""".        i
+0001ac20: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+0001ac30: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001ac40: 662e 5f76 616c 6964 6174 655f 7265 6164  f._validate_read
+0001ac50: 7928 7473 290a 2020 2020 2020 2020 2020  y(ts).          
+0001ac60: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
+0001ac70: 656c 662e 7275 6e6e 696e 672c 2073 656c  elf.running, sel
+0001ac80: 662e 7275 6e6e 696e 670a 2020 2020 2020  f.running.      
+0001ac90: 2020 2020 2020 6173 7365 7274 2028 6f20        assert (o 
+0001aca0: 3a3d 2073 656c 662e 776f 726b 6572 732e  := self.workers.
+0001acb0: 6765 7428 7773 2e61 6464 7265 7373 2929  get(ws.address))
+0001acc0: 2069 7320 7773 2c20 2877 732c 206f 290a   is ws, (ws, o).
+0001acd0: 0a20 2020 2020 2020 2077 732e 6164 645f  .        ws.add_
+0001ace0: 746f 5f70 726f 6365 7373 696e 6728 7473  to_processing(ts
+0001acf0: 290a 2020 2020 2020 2020 7473 2e70 726f  ).        ts.pro
+0001ad00: 6365 7373 696e 675f 6f6e 203d 2077 730a  cessing_on = ws.
+0001ad10: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+0001ad20: 203d 2022 7072 6f63 6573 7369 6e67 220a   = "processing".
+0001ad30: 2020 2020 2020 2020 7365 6c66 2e61 6371          self.acq
+0001ad40: 7569 7265 5f72 6573 6f75 7263 6573 2874  uire_resources(t
+0001ad50: 732c 2077 7329 0a20 2020 2020 2020 2073  s, ws).        s
+0001ad60: 656c 662e 6368 6563 6b5f 6964 6c65 5f73  elf.check_idle_s
+0001ad70: 6174 7572 6174 6564 2877 7329 0a20 2020  aturated(ws).   
+0001ad80: 2020 2020 2073 656c 662e 6e5f 7461 736b       self.n_task
+0001ad90: 7320 2b3d 2031 0a0a 2020 2020 2020 2020  s += 1..        
+0001ada0: 6966 2074 732e 6163 746f 723a 0a20 2020  if ts.actor:.   
+0001adb0: 2020 2020 2020 2020 2077 732e 6163 746f           ws.acto
+0001adc0: 7273 2e61 6464 2874 7329 0a0a 2020 2020  rs.add(ts)..    
+0001add0: 2020 2020 7265 7475 726e 207b 7773 2e61      return {ws.a
+0001ade0: 6464 7265 7373 3a20 5b73 656c 662e 5f74  ddress: [self._t
+0001adf0: 6173 6b5f 746f 5f6d 7367 2874 7329 5d7d  ask_to_msg(ts)]}
+0001ae00: 0a0a 2020 2020 6465 6620 5f65 7869 745f  ..    def _exit_
+0001ae10: 7072 6f63 6573 7369 6e67 5f63 6f6d 6d6f  processing_commo
+0001ae20: 6e28 7365 6c66 2c20 7473 3a20 5461 736b  n(self, ts: Task
+0001ae30: 5374 6174 6529 202d 3e20 576f 726b 6572  State) -> Worker
+0001ae40: 5374 6174 6520 7c20 4e6f 6e65 3a0a 2020  State | None:.  
+0001ae50: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+0001ae60: 2a74 732a 2066 726f 6d20 7468 6520 7365  *ts* from the se
+0001ae70: 7420 6f66 2070 726f 6365 7373 696e 6720  t of processing 
+0001ae80: 7461 736b 732e 0a0a 2020 2020 2020 2020  tasks...        
+0001ae90: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
+0001aea0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0001aeb0: 576f 726b 6572 2073 7461 7465 206f 6620  Worker state of 
+0001aec0: 7468 6520 776f 726b 6572 2074 6861 7420  the worker that 
+0001aed0: 7072 6f63 6573 7365 6420 2a74 732a 2069  processed *ts* i
+0001aee0: 6620 7468 6520 776f 726b 6572 2069 7320  f the worker is 
+0001aef0: 6375 7272 656e 742c 0a20 2020 2020 2020  current,.       
+0001af00: 204e 6f6e 6520 6966 2074 6865 2077 6f72   None if the wor
+0001af10: 6b65 7220 6973 2073 7461 6c65 2e0a 0a20  ker is stale... 
+0001af20: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
+0001af30: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+0001af40: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
+0001af50: 6572 2e5f 7365 745f 6475 7261 7469 6f6e  er._set_duration
+0001af60: 5f65 7374 696d 6174 650a 2020 2020 2020  _estimate.      
+0001af70: 2020 2222 220a 2020 2020 2020 2020 7773    """.        ws
+0001af80: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
+0001af90: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
+0001afa0: 7274 2077 730a 2020 2020 2020 2020 7473  rt ws.        ts
+0001afb0: 2e70 726f 6365 7373 696e 675f 6f6e 203d  .processing_on =
+0001afc0: 204e 6f6e 650a 0a20 2020 2020 2020 2077   None..        w
+0001afd0: 732e 7265 6d6f 7665 5f66 726f 6d5f 7072  s.remove_from_pr
+0001afe0: 6f63 6573 7369 6e67 2874 7329 0a20 2020  ocessing(ts).   
+0001aff0: 2020 2020 2069 6620 7365 6c66 2e77 6f72       if self.wor
+0001b000: 6b65 7273 2e67 6574 2877 732e 6164 6472  kers.get(ws.addr
+0001b010: 6573 7329 2069 7320 6e6f 7420 7773 3a20  ess) is not ws: 
+0001b020: 2023 206d 6179 2068 6176 6520 6265 656e   # may have been
+0001b030: 2072 656d 6f76 6564 0a20 2020 2020 2020   removed.       
+0001b040: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+0001b050: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+0001b060: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
+0001b070: 7465 6428 7773 290a 2020 2020 2020 2020  ted(ws).        
+0001b080: 7365 6c66 2e72 656c 6561 7365 5f72 6573  self.release_res
+0001b090: 6f75 7263 6573 2874 732c 2077 7329 0a0a  ources(ts, ws)..
+0001b0a0: 2020 2020 2020 2020 7265 7475 726e 2077          return w
+0001b0b0: 730a 0a20 2020 2064 6566 205f 6164 645f  s..    def _add_
+0001b0c0: 746f 5f6d 656d 6f72 7928 0a20 2020 2020  to_memory(.     
+0001b0d0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0001b0e0: 2074 733a 2054 6173 6b53 7461 7465 2c0a   ts: TaskState,.
+0001b0f0: 2020 2020 2020 2020 7773 3a20 576f 726b          ws: Work
+0001b100: 6572 5374 6174 652c 0a20 2020 2020 2020  erState,.       
+0001b110: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001b120: 3a20 5265 6373 2c0a 2020 2020 2020 2020  : Recs,.        
+0001b130: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+0001b140: 732c 0a20 2020 2020 2020 2074 7970 653a  s,.        type:
+0001b150: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
+0001b160: 4e6f 6e65 2c0a 2020 2020 2020 2020 7479  None,.        ty
+0001b170: 7065 6e61 6d65 3a20 7374 7220 7c20 4e6f  pename: str | No
+0001b180: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+0001b190: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001b1a0: 2020 2222 2241 6464 2074 7320 746f 2074    """Add ts to t
+0001b1b0: 6865 2073 6574 206f 6620 696e 2d6d 656d  he set of in-mem
+0001b1c0: 6f72 7920 7461 736b 7322 2222 0a20 2020  ory tasks""".   
+0001b1d0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+0001b1e0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+0001b1f0: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+0001b200: 2069 6e20 7773 2e68 6173 5f77 6861 740a   in ws.has_what.
+0001b210: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001b220: 645f 7265 706c 6963 6128 7473 2c20 7773  d_replica(ts, ws
+0001b230: 290a 0a20 2020 2020 2020 2064 6570 7320  )..        deps 
+0001b240: 3d20 6c69 7374 2874 732e 6465 7065 6e64  = list(ts.depend
+0001b250: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
+0001b260: 206c 656e 2864 6570 7329 203e 2031 3a0a   len(deps) > 1:.
+0001b270: 2020 2020 2020 2020 2020 2020 6465 7073              deps
+0001b280: 2e73 6f72 7428 6b65 793d 6f70 6572 6174  .sort(key=operat
+0001b290: 6f72 2e61 7474 7267 6574 7465 7228 2270  or.attrgetter("p
+0001b2a0: 7269 6f72 6974 7922 292c 2072 6576 6572  riority"), rever
+0001b2b0: 7365 3d54 7275 6529 0a0a 2020 2020 2020  se=True)..      
+0001b2c0: 2020 666f 7220 6474 7320 696e 2064 6570    for dts in dep
+0001b2d0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+0001b2e0: 203d 2064 7473 2e77 6169 7469 6e67 5f6f   = dts.waiting_o
+0001b2f0: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+0001b300: 2074 7320 696e 2073 3a0a 2020 2020 2020   ts in s:.      
+0001b310: 2020 2020 2020 2020 2020 732e 6469 7363            s.disc
+0001b320: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
+0001b330: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0001b340: 3a20 2023 206e 6577 2074 6173 6b20 7265  :  # new task re
+0001b350: 6164 7920 746f 2072 756e 0a20 2020 2020  ady to run.     
+0001b360: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001b370: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+0001b380: 7473 2e6b 6579 5d20 3d20 2270 726f 6365  ts.key] = "proce
+0001b390: 7373 696e 6722 0a0a 2020 2020 2020 2020  ssing"..        
+0001b3a0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0001b3b0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0001b3c0: 2020 2020 2020 2020 7320 3d20 6474 732e          s = dts.
+0001b3d0: 7761 6974 6572 730a 2020 2020 2020 2020  waiters.        
+0001b3e0: 2020 2020 732e 6469 7363 6172 6428 7473      s.discard(ts
+0001b3f0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001b400: 206e 6f74 2073 2061 6e64 206e 6f74 2064   not s and not d
+0001b410: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
+0001b420: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001b430: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+0001b440: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
+0001b450: 6564 220a 0a20 2020 2020 2020 2069 6620  ed"..        if 
+0001b460: 6e6f 7420 7473 2e77 6169 7465 7273 2061  not ts.waiters a
+0001b470: 6e64 206e 6f74 2074 732e 7768 6f5f 7761  nd not ts.who_wa
+0001b480: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0001b490: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001b4a0: 5b74 732e 6b65 795d 203d 2022 7265 6c65  [ts.key] = "rele
+0001b4b0: 6173 6564 220a 2020 2020 2020 2020 656c  ased".        el
+0001b4c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001b4d0: 7265 706f 7274 5f6d 7367 3a20 6469 6374  report_msg: dict
+0001b4e0: 5b73 7472 2c20 416e 795d 203d 207b 226f  [str, Any] = {"o
+0001b4f0: 7022 3a20 226b 6579 2d69 6e2d 6d65 6d6f  p": "key-in-memo
+0001b500: 7279 222c 2022 6b65 7922 3a20 7473 2e6b  ry", "key": ts.k
+0001b510: 6579 7d0a 2020 2020 2020 2020 2020 2020  ey}.            
+0001b520: 6966 2074 7970 6520 6973 206e 6f74 204e  if type is not N
+0001b530: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001b540: 2020 2020 2072 6570 6f72 745f 6d73 675b       report_msg[
+0001b550: 2274 7970 6522 5d20 3d20 7479 7065 0a20  "type"] = type. 
+0001b560: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+0001b570: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
+0001b580: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001b590: 2020 2063 6c69 656e 745f 6d73 6773 5b63     client_msgs[c
+0001b5a0: 732e 636c 6965 6e74 5f6b 6579 5d20 3d20  s.client_key] = 
+0001b5b0: 5b72 6570 6f72 745f 6d73 675d 0a0a 2020  [report_msg]..  
+0001b5c0: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
+0001b5d0: 2022 6d65 6d6f 7279 220a 2020 2020 2020   "memory".      
+0001b5e0: 2020 7473 2e74 7970 6520 3d20 7479 7065    ts.type = type
+0001b5f0: 6e61 6d65 2020 2320 7479 7065 3a20 6967  name  # type: ig
+0001b600: 6e6f 7265 0a20 2020 2020 2020 2074 732e  nore.        ts.
+0001b610: 6772 6f75 702e 7479 7065 732e 6164 6428  group.types.add(
+0001b620: 7479 7065 6e61 6d65 2920 2023 2074 7970  typename)  # typ
+0001b630: 653a 2069 676e 6f72 650a 0a20 2020 2020  e: ignore..     
+0001b640: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
+0001b650: 656e 7473 5b22 6669 7265 2d61 6e64 2d66  ents["fire-and-f
+0001b660: 6f72 6765 7422 5d0a 2020 2020 2020 2020  orget"].        
+0001b670: 6966 2074 7320 696e 2063 732e 7761 6e74  if ts in cs.want
+0001b680: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
+0001b690: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
+0001b6a0: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
+0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6c0: 6373 3d63 732c 0a20 2020 2020 2020 2020  cs=cs,.         
+0001b6d0: 2020 2020 2020 206b 6579 733d 5b74 732e         keys=[ts.
+0001b6e0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
+0001b6f0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0001b700: 7469 6f6e 733d 7265 636f 6d6d 656e 6461  tions=recommenda
+0001b710: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0001b720: 2020 2029 0a0a 2020 2020 6465 6620 5f70     )..    def _p
+0001b730: 726f 7061 6761 7465 5f72 656c 6561 7365  ropagate_release
+0001b740: 6428 7365 6c66 2c20 7473 3a20 5461 736b  d(self, ts: Task
+0001b750: 5374 6174 652c 2072 6563 6f6d 6d65 6e64  State, recommend
+0001b760: 6174 696f 6e73 3a20 5265 6373 2920 2d3e  ations: Recs) ->
+0001b770: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+0001b780: 732e 7374 6174 6520 3d20 2272 656c 6561  s.state = "relea
+0001b790: 7365 6422 0a20 2020 2020 2020 206b 6579  sed".        key
+0001b7a0: 203d 2074 732e 6b65 790a 0a20 2020 2020   = ts.key..     
+0001b7b0: 2020 2069 6620 7473 2e68 6173 5f6c 6f73     if ts.has_los
+0001b7c0: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
+0001b7d0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0001b7e0: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
+0001b7f0: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
+0001b800: 2020 2020 2020 2065 6c69 6620 7473 2e77         elif ts.w
+0001b810: 6169 7465 7273 206f 7220 7473 2e77 686f  aiters or ts.who
+0001b820: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+0001b830: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001b840: 6f6e 735b 6b65 795d 203d 2022 7761 6974  ons[key] = "wait
+0001b850: 696e 6722 0a0a 2020 2020 2020 2020 6966  ing"..        if
+0001b860: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001b870: 2e67 6574 286b 6579 2920 213d 2022 7761  .get(key) != "wa
+0001b880: 6974 696e 6722 3a0a 2020 2020 2020 2020  iting":.        
+0001b890: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+0001b8a0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+0001b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8c0: 6966 2064 7473 2e73 7461 7465 2021 3d20  if dts.state != 
+0001b8d0: 2272 656c 6561 7365 6422 3a0a 2020 2020  "released":.    
+0001b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8f0: 6474 732e 7761 6974 6572 732e 6469 7363  dts.waiters.disc
+0001b900: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
+0001b910: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0001b920: 6f74 2064 7473 2e77 6169 7465 7273 2061  ot dts.waiters a
+0001b930: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
+0001b940: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+0001b950: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001b960: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+0001b970: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
+0001b980: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
+0001b990: 7473 2e77 6169 7465 7273 2e63 6c65 6172  ts.waiters.clear
+0001b9a0: 2829 0a0a 2020 2020 2020 2020 6966 2073  ()..        if s
+0001b9b0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+0001b9c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001b9d0: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
+0001b9e0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+0001b9f0: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0001ba00: 696e 2073 656c 662e 7175 6575 6564 0a0a  in self.queued..
+0001ba10: 2020 2020 6465 6620 5f70 726f 7061 6761      def _propaga
+0001ba20: 7465 5f66 6f72 676f 7474 656e 280a 2020  te_forgotten(.  
+0001ba30: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001ba40: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+0001ba50: 652c 0a20 2020 2020 2020 2072 6563 6f6d  e,.        recom
+0001ba60: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0001ba70: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+0001ba80: 5f6d 7367 733a 204d 7367 732c 0a20 2020  _msgs: Msgs,.   
+0001ba90: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0001baa0: 3a20 7374 722c 0a20 2020 2029 202d 3e20  : str,.    ) -> 
+0001bab0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+0001bac0: 2e73 7461 7465 203d 2022 666f 7267 6f74  .state = "forgot
+0001bad0: 7465 6e22 0a20 2020 2020 2020 2066 6f72  ten".        for
+0001bae0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0001baf0: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
+0001bb00: 2020 2064 7473 2e68 6173 5f6c 6f73 745f     dts.has_lost_
+0001bb10: 6465 7065 6e64 656e 6369 6573 203d 2054  dependencies = T
+0001bb20: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0001bb30: 6474 732e 6465 7065 6e64 656e 6369 6573  dts.dependencies
+0001bb40: 2e72 656d 6f76 6528 7473 290a 2020 2020  .remove(ts).    
+0001bb50: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
+0001bb60: 696e 675f 6f6e 2e64 6973 6361 7264 2874  ing_on.discard(t
+0001bb70: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
+0001bb80: 6620 6474 732e 7374 6174 6520 6e6f 7420  f dts.state not 
+0001bb90: 696e 2028 226d 656d 6f72 7922 2c20 2265  in ("memory", "e
+0001bba0: 7272 6564 2229 3a0a 2020 2020 2020 2020  rred"):.        
+0001bbb0: 2020 2020 2020 2020 2320 4361 6e6e 6f74          # Cannot
+0001bbc0: 2063 6f6d 7075 7465 2074 6173 6b20 616e   compute task an
+0001bbd0: 796d 6f72 650a 2020 2020 2020 2020 2020  ymore.          
+0001bbe0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0001bbf0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
+0001bc00: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
+0001bc10: 2020 2020 2074 732e 6465 7065 6e64 656e       ts.dependen
+0001bc20: 7473 2e63 6c65 6172 2829 0a20 2020 2020  ts.clear().     
+0001bc30: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
+0001bc40: 6561 7228 290a 0a20 2020 2020 2020 2066  ear()..        f
+0001bc50: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0001bc60: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0001bc70: 2020 2020 2020 2064 7473 2e64 6570 656e         dts.depen
+0001bc80: 6465 6e74 732e 7265 6d6f 7665 2874 7329  dents.remove(ts)
+0001bc90: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
+0001bca0: 2e77 6169 7465 7273 2e64 6973 6361 7264  .waiters.discard
+0001bcb0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+0001bcc0: 2069 6620 6e6f 7420 6474 732e 6465 7065   if not dts.depe
+0001bcd0: 6e64 656e 7473 2061 6e64 206e 6f74 2064  ndents and not d
+0001bce0: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
+0001bcf0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001bd00: 5461 736b 206e 6f74 206e 6565 6465 6420  Task not needed 
+0001bd10: 616e 796d 6f72 650a 2020 2020 2020 2020  anymore.        
+0001bd20: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+0001bd30: 7473 2069 7320 6e6f 7420 7473 0a20 2020  ts is not ts.   
+0001bd40: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0001bd50: 6f6d 6d65 6e64 6174 696f 6e73 5b64 7473  ommendations[dts
+0001bd60: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
+0001bd70: 656e 220a 2020 2020 2020 2020 7473 2e64  en".        ts.d
+0001bd80: 6570 656e 6465 6e63 6965 732e 636c 6561  ependencies.clea
+0001bd90: 7228 290a 2020 2020 2020 2020 7473 2e77  r().        ts.w
+0001bda0: 6169 7469 6e67 5f6f 6e2e 636c 6561 7228  aiting_on.clear(
+0001bdb0: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
+0001bdc0: 7320 696e 2074 732e 7768 6f5f 6861 733a  s in ts.who_has:
+0001bdd0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001bde0: 7773 2e61 6464 7265 7373 2069 6e20 7365  ws.address in se
+0001bdf0: 6c66 2e77 6f72 6b65 7273 3a20 2023 2069  lf.workers:  # i
+0001be00: 6e20 6361 7365 2077 6f72 6b65 7220 6861  n case worker ha
+0001be10: 7320 6469 6564 0a20 2020 2020 2020 2020  s died.         
+0001be20: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+0001be30: 6773 5b77 732e 6164 6472 6573 735d 203d  gs[ws.address] =
+0001be40: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0001be50: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0001be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be70: 2022 6f70 223a 2022 6672 6565 2d6b 6579   "op": "free-key
+0001be80: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+0001be90: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+0001bea0: 7322 3a20 5b74 732e 6b65 795d 2c0a 2020  s": [ts.key],.  
+0001beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bec0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
+0001bed0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
+0001bee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001bef0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0001bf00: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0001bf10: 2020 7365 6c66 2e72 656d 6f76 655f 616c    self.remove_al
+0001bf20: 6c5f 7265 706c 6963 6173 2874 7329 0a0a  l_replicas(ts)..
+0001bf30: 2020 2020 6465 6620 5f63 6c69 656e 745f      def _client_
+0001bf40: 7265 6c65 6173 6573 5f6b 6579 7328 0a20  releases_keys(. 
+0001bf50: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001bf60: 2020 2020 206b 6579 733a 2043 6f6c 6c65       keys: Colle
+0001bf70: 6374 696f 6e5b 7374 725d 2c0a 2020 2020  ction[str],.    
+0001bf80: 2020 2020 6373 3a20 436c 6965 6e74 5374      cs: ClientSt
+0001bf90: 6174 652c 0a20 2020 2020 2020 2072 6563  ate,.        rec
+0001bfa0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+0001bfb0: 6373 2c0a 2020 2020 2920 2d3e 204e 6f6e  cs,.    ) -> Non
+0001bfc0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+0001bfd0: 6d6f 7665 206b 6579 7320 6672 6f6d 2063  move keys from c
+0001bfe0: 6c69 656e 7420 6465 7369 7265 6420 6c69  lient desired li
+0001bff0: 7374 2222 220a 2020 2020 2020 2020 6c6f  st""".        lo
+0001c000: 6767 6572 2e64 6562 7567 2822 436c 6965  gger.debug("Clie
+0001c010: 6e74 2025 7320 7265 6c65 6173 6573 206b  nt %s releases k
+0001c020: 6579 733a 2025 7322 2c20 6373 2e63 6c69  eys: %s", cs.cli
+0001c030: 656e 745f 6b65 792c 206b 6579 7329 0a20  ent_key, keys). 
+0001c040: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0001c050: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+0001c060: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0001c070: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0001c080: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+0001c090: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
+0001c0a0: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
+0001c0b0: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
+0001c0c0: 2020 2020 6373 2e77 616e 7473 5f77 6861      cs.wants_wha
+0001c0d0: 742e 7265 6d6f 7665 2874 7329 0a20 2020  t.remove(ts).   
+0001c0e0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0001c0f0: 7768 6f5f 7761 6e74 732e 7265 6d6f 7665  who_wants.remove
+0001c100: 2863 7329 0a20 2020 2020 2020 2020 2020  (cs).           
+0001c110: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
+0001c120: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+0001c130: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001c140: 206e 6f74 2074 732e 6465 7065 6e64 656e   not ts.dependen
+0001c150: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001c160: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+0001c170: 206c 6976 6520 6465 7065 6e64 656e 7473   live dependents
+0001c180: 2c20 6361 6e20 666f 7267 6574 0a20 2020  , can forget.   
+0001c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c1a0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001c1b0: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
+0001c1c0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
+0001c1d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001c1e0: 6c69 6620 7473 2e73 7461 7465 2021 3d20  lif ts.state != 
+0001c1f0: 2265 7272 6564 2220 616e 6420 6e6f 7420  "erred" and not 
+0001c200: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
+0001c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c220: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001c230: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2272  ons[ts.key] = "r
+0001c240: 656c 6561 7365 6422 0a0a 2020 2020 6465  eleased"..    de
+0001c250: 6620 5f74 6173 6b5f 746f 5f6d 7367 2873  f _task_to_msg(s
+0001c260: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+0001c270: 7465 2c20 6475 7261 7469 6f6e 3a20 666c  te, duration: fl
+0001c280: 6f61 7420 3d20 2d31 2920 2d3e 2064 6963  oat = -1) -> dic
+0001c290: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
+0001c2a0: 2020 2020 2022 2222 436f 6e76 6572 7420       """Convert 
+0001c2b0: 6120 7369 6e67 6c65 2063 6f6d 7075 7461  a single computa
+0001c2c0: 7469 6f6e 616c 2074 6173 6b20 746f 2061  tional task to a
+0001c2d0: 206d 6573 7361 6765 2222 220a 2020 2020   message""".    
+0001c2e0: 2020 2020 2320 4649 584d 453a 2054 6865      # FIXME: The
+0001c2f0: 2064 7572 6174 696f 6e20 6174 7472 6962   duration attrib
+0001c300: 7574 6520 6973 206e 6f74 2075 7365 6420  ute is not used 
+0001c310: 6f6e 2077 6f72 6b65 722e 2057 6520 636f  on worker. We co
+0001c320: 756c 6420 7361 7665 206f 7572 7365 6c76  uld save ourselv
+0001c330: 6573 2074 6865 0a20 2020 2020 2020 2023  es the.        #
+0001c340: 2020 2020 2020 2020 7469 6d65 2074 6f20          time to 
+0001c350: 636f 6d70 7574 6520 616e 6420 7375 626d  compute and subm
+0001c360: 6974 2074 6869 730a 2020 2020 2020 2020  it this.        
+0001c370: 6966 2064 7572 6174 696f 6e20 3c20 303a  if duration < 0:
+0001c380: 0a20 2020 2020 2020 2020 2020 2064 7572  .            dur
+0001c390: 6174 696f 6e20 3d20 7365 6c66 2e67 6574  ation = self.get
+0001c3a0: 5f74 6173 6b5f 6475 7261 7469 6f6e 2874  _task_duration(t
+0001c3b0: 7329 0a20 2020 2020 2020 2074 732e 7275  s).        ts.ru
+0001c3c0: 6e5f 6964 203d 206e 6578 7428 5461 736b  n_id = next(Task
+0001c3d0: 5374 6174 652e 5f72 756e 5f69 645f 6974  State._run_id_it
+0001c3e0: 6572 6174 6f72 290a 2020 2020 2020 2020  erator).        
+0001c3f0: 6173 7365 7274 2074 732e 7072 696f 7269  assert ts.priori
+0001c400: 7479 2c20 7473 0a20 2020 2020 2020 206d  ty, ts.        m
+0001c410: 7367 3a20 6469 6374 5b73 7472 2c20 416e  sg: dict[str, An
+0001c420: 795d 203d 207b 0a20 2020 2020 2020 2020  y] = {.         
+0001c430: 2020 2022 6f70 223a 2022 636f 6d70 7574     "op": "comput
+0001c440: 652d 7461 736b 222c 0a20 2020 2020 2020  e-task",.       
+0001c450: 2020 2020 2022 6b65 7922 3a20 7473 2e6b       "key": ts.k
+0001c460: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+0001c470: 2272 756e 5f69 6422 3a20 7473 2e72 756e  "run_id": ts.run
+0001c480: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+0001c490: 2022 7072 696f 7269 7479 223a 2074 732e   "priority": ts.
+0001c4a0: 7072 696f 7269 7479 2c0a 2020 2020 2020  priority,.      
+0001c4b0: 2020 2020 2020 2264 7572 6174 696f 6e22        "duration"
+0001c4c0: 3a20 6475 7261 7469 6f6e 2c0a 2020 2020  : duration,.    
+0001c4d0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+0001c4e0: 735f 6964 223a 2066 2263 6f6d 7075 7465  s_id": f"compute
+0001c4f0: 2d74 6173 6b2d 7b74 696d 6528 297d 222c  -task-{time()}",
+0001c500: 0a20 2020 2020 2020 2020 2020 2022 7768  .            "wh
+0001c510: 6f5f 6861 7322 3a20 7b0a 2020 2020 2020  o_has": {.      
+0001c520: 2020 2020 2020 2020 2020 6474 732e 6b65            dts.ke
+0001c530: 793a 205b 7773 2e61 6464 7265 7373 2066  y: [ws.address f
+0001c540: 6f72 2077 7320 696e 2064 7473 2e77 686f  or ws in dts.who
+0001c550: 5f68 6173 5d20 666f 7220 6474 7320 696e  _has] for dts in
+0001c560: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+0001c570: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0001c580: 2020 2020 2020 2020 2020 2020 226e 6279              "nby
+0001c590: 7465 7322 3a20 7b64 7473 2e6b 6579 3a20  tes": {dts.key: 
+0001c5a0: 6474 732e 6e62 7974 6573 2066 6f72 2064  dts.nbytes for d
+0001c5b0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+0001c5c0: 6e63 6965 737d 2c0a 2020 2020 2020 2020  ncies},.        
+0001c5d0: 2020 2020 2272 756e 5f73 7065 6322 3a20      "run_spec": 
+0001c5e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001c5f0: 2020 2266 756e 6374 696f 6e22 3a20 4e6f    "function": No
+0001c600: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001c610: 2261 7267 7322 3a20 4e6f 6e65 2c0a 2020  "args": None,.  
+0001c620: 2020 2020 2020 2020 2020 226b 7761 7267            "kwarg
+0001c630: 7322 3a20 4e6f 6e65 2c0a 2020 2020 2020  s": None,.      
+0001c640: 2020 2020 2020 2272 6573 6f75 7263 655f        "resource_
+0001c650: 7265 7374 7269 6374 696f 6e73 223a 2074  restrictions": t
+0001c660: 732e 7265 736f 7572 6365 5f72 6573 7472  s.resource_restr
+0001c670: 6963 7469 6f6e 732c 0a20 2020 2020 2020  ictions,.       
+0001c680: 2020 2020 2022 6163 746f 7222 3a20 7473       "actor": ts
+0001c690: 2e61 6374 6f72 2c0a 2020 2020 2020 2020  .actor,.        
+0001c6a0: 2020 2020 2261 6e6e 6f74 6174 696f 6e73      "annotations
+0001c6b0: 223a 2074 732e 616e 6e6f 7461 7469 6f6e  ": ts.annotation
+0001c6c0: 732c 0a20 2020 2020 2020 207d 0a20 2020  s,.        }.   
+0001c6d0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+0001c6e0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+0001c6f0: 2020 2061 7373 6572 7420 616c 6c28 6d73     assert all(ms
+0001c700: 675b 2277 686f 5f68 6173 225d 2e76 616c  g["who_has"].val
+0001c710: 7565 7328 2929 0a0a 2020 2020 2020 2020  ues())..        
+0001c720: 6966 2069 7369 6e73 7461 6e63 6528 7473  if isinstance(ts
+0001c730: 2e72 756e 5f73 7065 632c 2064 6963 7429  .run_spec, dict)
+0001c740: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+0001c750: 672e 7570 6461 7465 2874 732e 7275 6e5f  g.update(ts.run_
+0001c760: 7370 6563 290a 2020 2020 2020 2020 656c  spec).        el
+0001c770: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c780: 6d73 675b 2272 756e 5f73 7065 6322 5d20  msg["run_spec"] 
+0001c790: 3d20 7473 2e72 756e 5f73 7065 630a 0a20  = ts.run_spec.. 
+0001c7a0: 2020 2020 2020 2072 6574 7572 6e20 6d73         return ms
+0001c7b0: 670a 0a0a 636c 6173 7320 5363 6865 6475  g...class Schedu
+0001c7c0: 6c65 7228 5363 6865 6475 6c65 7253 7461  ler(SchedulerSta
+0001c7d0: 7465 2c20 5365 7276 6572 4e6f 6465 293a  te, ServerNode):
+0001c7e0: 0a20 2020 2022 2222 4479 6e61 6d69 6320  .    """Dynamic 
+0001c7f0: 6469 7374 7269 6275 7465 6420 7461 736b  distributed task
+0001c800: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+0001c810: 5468 6520 7363 6865 6475 6c65 7220 7472  The scheduler tr
+0001c820: 6163 6b73 2074 6865 2063 7572 7265 6e74  acks the current
+0001c830: 2073 7461 7465 206f 6620 776f 726b 6572   state of worker
+0001c840: 732c 2064 6174 612c 2061 6e64 2063 6f6d  s, data, and com
+0001c850: 7075 7461 7469 6f6e 732e 0a20 2020 2054  putations..    T
+0001c860: 6865 2073 6368 6564 756c 6572 206c 6973  he scheduler lis
+0001c870: 7465 6e73 2066 6f72 2065 7665 6e74 7320  tens for events 
+0001c880: 616e 6420 7265 7370 6f6e 6473 2062 7920  and responds by 
+0001c890: 636f 6e74 726f 6c6c 696e 6720 776f 726b  controlling work
+0001c8a0: 6572 730a 2020 2020 6170 7072 6f70 7269  ers.    appropri
+0001c8b0: 6174 656c 792e 2020 4974 2063 6f6e 7469  ately.  It conti
+0001c8c0: 6e75 6f75 736c 7920 7472 6965 7320 746f  nuously tries to
+0001c8d0: 2075 7365 2074 6865 2077 6f72 6b65 7273   use the workers
+0001c8e0: 2074 6f20 6578 6563 7574 6520 616e 2065   to execute an e
+0001c8f0: 7665 720a 2020 2020 6772 6f77 696e 6720  ver.    growing 
+0001c900: 6461 736b 2067 7261 7068 2e0a 0a20 2020  dask graph...   
+0001c910: 2041 6c6c 2065 7665 6e74 7320 6172 6520   All events are 
+0001c920: 6861 6e64 6c65 6420 7175 6963 6b6c 792c  handled quickly,
+0001c930: 2069 6e20 6c69 6e65 6172 2074 696d 6520   in linear time 
+0001c940: 7769 7468 2072 6573 7065 6374 2074 6f20  with respect to 
+0001c950: 7468 6569 7220 696e 7075 740a 2020 2020  their input.    
+0001c960: 2877 6869 6368 2069 7320 6f66 7465 6e20  (which is often 
+0001c970: 6f66 2063 6f6e 7374 616e 7420 7369 7a65  of constant size
+0001c980: 2920 616e 6420 6765 6e65 7261 6c6c 7920  ) and generally 
+0001c990: 7769 7468 696e 2061 206d 696c 6c69 7365  within a millise
+0001c9a0: 636f 6e64 2e20 2054 6f0a 2020 2020 6163  cond.  To.    ac
+0001c9b0: 636f 6d70 6c69 7368 2074 6869 7320 7468  complish this th
+0001c9c0: 6520 7363 6865 6475 6c65 7220 7472 6163  e scheduler trac
+0001c9d0: 6b73 2061 206c 6f74 206f 6620 7374 6174  ks a lot of stat
+0001c9e0: 652e 2020 4576 6572 7920 6f70 6572 6174  e.  Every operat
+0001c9f0: 696f 6e0a 2020 2020 6d61 696e 7461 696e  ion.    maintain
+0001ca00: 7320 7468 6520 636f 6e73 6973 7465 6e63  s the consistenc
+0001ca10: 7920 6f66 2074 6869 7320 7374 6174 652e  y of this state.
+0001ca20: 0a0a 2020 2020 5468 6520 7363 6865 6475  ..    The schedu
+0001ca30: 6c65 7220 636f 6d6d 756e 6963 6174 6573  ler communicates
+0001ca40: 2077 6974 6820 7468 6520 6f75 7473 6964   with the outsid
+0001ca50: 6520 776f 726c 6420 7468 726f 7567 6820  e world through 
+0001ca60: 436f 6d6d 206f 626a 6563 7473 2e0a 2020  Comm objects..  
+0001ca70: 2020 4974 206d 6169 6e74 6169 6e73 2061    It maintains a
+0001ca80: 2063 6f6e 7369 7374 656e 7420 616e 6420   consistent and 
+0001ca90: 7661 6c69 6420 7669 6577 206f 6620 7468  valid view of th
+0001caa0: 6520 776f 726c 6420 6576 656e 2077 6865  e world even whe
+0001cab0: 6e20 6c69 7374 656e 696e 670a 2020 2020  n listening.    
+0001cac0: 746f 2073 6576 6572 616c 2063 6c69 656e  to several clien
+0001cad0: 7473 2061 7420 6f6e 6365 2e0a 0a20 2020  ts at once...   
+0001cae0: 2041 2053 6368 6564 756c 6572 2069 7320   A Scheduler is 
+0001caf0: 7479 7069 6361 6c6c 7920 7374 6172 7465  typically starte
+0001cb00: 6420 6569 7468 6572 2077 6974 6820 7468  d either with th
+0001cb10: 6520 6060 6461 736b 2073 6368 6564 756c  e ``dask schedul
+0001cb20: 6572 6060 0a20 2020 2065 7865 6375 7461  er``.    executa
+0001cb30: 626c 653a 3a0a 0a20 2020 2020 2020 2020  ble::..         
+0001cb40: 2420 6461 736b 2073 6368 6564 756c 6572  $ dask scheduler
+0001cb50: 0a20 2020 2020 2020 2020 5363 6865 6475  .         Schedu
+0001cb60: 6c65 7220 7374 6172 7465 6420 6174 2031  ler started at 1
+0001cb70: 3237 2e30 2e30 2e31 3a38 3738 360a 0a20  27.0.0.1:8786.. 
+0001cb80: 2020 204f 7220 7769 7468 696e 2061 204c     Or within a L
+0001cb90: 6f63 616c 436c 7573 7465 7220 6120 436c  ocalCluster a Cl
+0001cba0: 6965 6e74 2073 7461 7274 7320 7570 2077  ient starts up w
+0001cbb0: 6974 686f 7574 2063 6f6e 6e65 6374 696f  ithout connectio
+0001cbc0: 6e0a 2020 2020 696e 666f 726d 6174 696f  n.    informatio
+0001cbd0: 6e3a 3a0a 0a20 2020 2020 2020 203e 3e3e  n::..        >>>
+0001cbe0: 2063 203d 2043 6c69 656e 7428 2920 2023   c = Client()  #
+0001cbf0: 2064 6f63 7465 7374 3a20 2b53 4b49 500a   doctest: +SKIP.
+0001cc00: 2020 2020 2020 2020 3e3e 3e20 632e 636c          >>> c.cl
+0001cc10: 7573 7465 722e 7363 6865 6475 6c65 7220  uster.scheduler 
+0001cc20: 2023 2064 6f63 7465 7374 3a20 2b53 4b49   # doctest: +SKI
+0001cc30: 500a 2020 2020 2020 2020 5363 6865 6475  P.        Schedu
+0001cc40: 6c65 7228 2e2e 2e29 0a0a 2020 2020 5573  ler(...)..    Us
+0001cc50: 6572 7320 7479 7069 6361 6c6c 7920 646f  ers typically do
+0001cc60: 206e 6f74 2069 6e74 6572 6163 7420 7769   not interact wi
+0001cc70: 7468 2074 6865 2073 6368 6564 756c 6572  th the scheduler
+0001cc80: 2064 6972 6563 746c 7920 6275 7420 7261   directly but ra
+0001cc90: 7468 6572 2077 6974 680a 2020 2020 7468  ther with.    th
+0001cca0: 6520 636c 6965 6e74 206f 626a 6563 7420  e client object 
+0001ccb0: 6060 436c 6965 6e74 6060 2e0a 0a20 2020  ``Client``...   
+0001ccc0: 2054 6865 2060 6063 6f6e 7461 6374 5f61   The ``contact_a
+0001ccd0: 6464 7265 7373 6060 2070 6172 616d 6574  ddress`` paramet
+0001cce0: 6572 2061 6c6c 6f77 7320 746f 2061 6476  er allows to adv
+0001ccf0: 6572 7469 7365 2061 2073 7065 6369 6669  ertise a specifi
+0001cd00: 6320 6164 6472 6573 7320 746f 0a20 2020  c address to.   
+0001cd10: 2074 6865 2077 6f72 6b65 7273 2066 6f72   the workers for
+0001cd20: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2077   communication w
+0001cd30: 6974 6820 7468 6520 7363 6865 6475 6c65  ith the schedule
+0001cd40: 722c 2077 6869 6368 2069 7320 6469 6666  r, which is diff
+0001cd50: 6572 656e 7420 7468 616e 0a20 2020 2074  erent than.    t
+0001cd60: 6865 2061 6464 7265 7373 2074 6865 2073  he address the s
+0001cd70: 6368 6564 756c 6572 2062 696e 6473 2074  cheduler binds t
+0001cd80: 6f2e 2054 6869 7320 6973 2075 7365 6675  o. This is usefu
+0001cd90: 6c20 7768 656e 2074 6865 2073 6368 6564  l when the sched
+0001cda0: 756c 6572 0a20 2020 206c 6973 7465 6e73  uler.    listens
+0001cdb0: 206f 6e20 6120 7072 6976 6174 6520 6164   on a private ad
+0001cdc0: 6472 6573 732c 2077 6869 6368 2074 6865  dress, which the
+0001cdd0: 7265 666f 7265 2063 616e 6e6f 7420 6265  refore cannot be
+0001cde0: 2075 7365 6420 6279 2074 6865 2077 6f72   used by the wor
+0001cdf0: 6b65 7273 0a20 2020 2074 6f20 636f 6e74  kers.    to cont
+0001ce00: 6163 7420 6974 2e0a 0a20 2020 202a 2a53  act it...    **S
+0001ce10: 7461 7465 2a2a 0a0a 2020 2020 5468 6520  tate**..    The 
+0001ce20: 7363 6865 6475 6c65 7220 636f 6e74 6169  scheduler contai
+0001ce30: 6e73 2074 6865 2066 6f6c 6c6f 7769 6e67  ns the following
+0001ce40: 2073 7461 7465 2076 6172 6961 626c 6573   state variables
+0001ce50: 2e20 2045 6163 6820 7661 7269 6162 6c65  .  Each variable
+0001ce60: 2069 730a 2020 2020 6c69 7374 6564 2061   is.    listed a
+0001ce70: 6c6f 6e67 2077 6974 6820 7768 6174 2069  long with what i
+0001ce80: 7420 7374 6f72 6573 2061 6e64 2061 2062  t stores and a b
+0001ce90: 7269 6566 2064 6573 6372 6970 7469 6f6e  rief description
+0001cea0: 2e0a 0a20 2020 202a 202a 2a74 6173 6b73  ...    * **tasks
+0001ceb0: 3a2a 2a20 6060 7b74 6173 6b20 6b65 793a  :** ``{task key:
+0001cec0: 2054 6173 6b53 7461 7465 7d60 600a 2020   TaskState}``.  
+0001ced0: 2020 2020 2020 5461 736b 7320 6375 7272        Tasks curr
+0001cee0: 656e 746c 7920 6b6e 6f77 6e20 746f 2074  ently known to t
+0001cef0: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
+0001cf00: 202a 202a 2a75 6e72 756e 6e61 626c 653a   * **unrunnable:
+0001cf10: 2a2a 2060 607b 5461 736b 5374 6174 657d  ** ``{TaskState}
+0001cf20: 6060 0a20 2020 2020 2020 2054 6173 6b73  ``.        Tasks
+0001cf30: 2069 6e20 7468 6520 226e 6f2d 776f 726b   in the "no-work
+0001cf40: 6572 2220 7374 6174 650a 0a20 2020 202a  er" state..    *
+0001cf50: 202a 2a77 6f72 6b65 7273 3a2a 2a20 6060   **workers:** ``
+0001cf60: 7b77 6f72 6b65 7220 6b65 793a 2057 6f72  {worker key: Wor
+0001cf70: 6b65 7253 7461 7465 7d60 600a 2020 2020  kerState}``.    
+0001cf80: 2020 2020 576f 726b 6572 7320 6375 7272      Workers curr
+0001cf90: 656e 746c 7920 636f 6e6e 6563 7465 6420  ently connected 
+0001cfa0: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
+0001cfb0: 0a20 2020 202a 202a 2a69 646c 653a 2a2a  .    * **idle:**
+0001cfc0: 2060 607b 576f 726b 6572 5374 6174 657d   ``{WorkerState}
+0001cfd0: 6060 3a0a 2020 2020 2020 2020 5365 7420  ``:.        Set 
+0001cfe0: 6f66 2077 6f72 6b65 7273 2074 6861 7420  of workers that 
+0001cff0: 6172 6520 6e6f 7420 6675 6c6c 7920 7574  are not fully ut
+0001d000: 696c 697a 6564 0a20 2020 202a 202a 2a73  ilized.    * **s
+0001d010: 6174 7572 6174 6564 3a2a 2a20 6060 7b57  aturated:** ``{W
+0001d020: 6f72 6b65 7253 7461 7465 7d60 603a 0a20  orkerState}``:. 
+0001d030: 2020 2020 2020 2053 6574 206f 6620 776f         Set of wo
+0001d040: 726b 6572 7320 7468 6174 2061 7265 206e  rkers that are n
+0001d050: 6f74 206f 7665 722d 7574 696c 697a 6564  ot over-utilized
+0001d060: 0a0a 2020 2020 2a20 2a2a 686f 7374 5f69  ..    * **host_i
+0001d070: 6e66 6f3a 2a2a 2060 607b 686f 7374 6e61  nfo:** ``{hostna
+0001d080: 6d65 3a20 6469 6374 7d60 603a 0a20 2020  me: dict}``:.   
+0001d090: 2020 2020 2049 6e66 6f72 6d61 7469 6f6e       Information
+0001d0a0: 2061 626f 7574 2065 6163 6820 776f 726b   about each work
+0001d0b0: 6572 2068 6f73 740a 0a20 2020 202a 202a  er host..    * *
+0001d0c0: 2a63 6c69 656e 7473 3a2a 2a20 6060 7b63  *clients:** ``{c
+0001d0d0: 6c69 656e 7420 6b65 793a 2043 6c69 656e  lient key: Clien
+0001d0e0: 7453 7461 7465 7d60 600a 2020 2020 2020  tState}``.      
+0001d0f0: 2020 436c 6965 6e74 7320 6375 7272 656e    Clients curren
+0001d100: 746c 7920 636f 6e6e 6563 7465 6420 746f  tly connected to
+0001d110: 2074 6865 2073 6368 6564 756c 6572 0a0a   the scheduler..
+0001d120: 2020 2020 2a20 2a2a 7365 7276 6963 6573      * **services
+0001d130: 3a2a 2a20 6060 7b73 7472 3a20 706f 7274  :** ``{str: port
+0001d140: 7d60 603a 0a20 2020 2020 2020 204f 7468  }``:.        Oth
+0001d150: 6572 2073 6572 7669 6365 7320 7275 6e6e  er services runn
+0001d160: 696e 6720 6f6e 2074 6869 7320 7363 6865  ing on this sche
+0001d170: 6475 6c65 722c 206c 696b 6520 426f 6b65  duler, like Boke
+0001d180: 680a 2020 2020 2a20 2a2a 6c6f 6f70 3a2a  h.    * **loop:*
+0001d190: 2a20 6060 494f 4c6f 6f70 6060 3a0a 2020  * ``IOLoop``:.  
+0001d1a0: 2020 2020 2020 5468 6520 7275 6e6e 696e        The runnin
+0001d1b0: 6720 546f 726e 6164 6f20 494f 4c6f 6f70  g Tornado IOLoop
+0001d1c0: 0a20 2020 202a 202a 2a63 6c69 656e 745f  .    * **client_
+0001d1d0: 636f 6d6d 733a 2a2a 2060 607b 636c 6965  comms:** ``{clie
+0001d1e0: 6e74 206b 6579 3a20 436f 6d6d 7d60 600a  nt key: Comm}``.
+0001d1f0: 2020 2020 2020 2020 466f 7220 6561 6368          For each
+0001d200: 2063 6c69 656e 742c 2061 2043 6f6d 6d20   client, a Comm 
+0001d210: 6f62 6a65 6374 2075 7365 6420 746f 2072  object used to r
+0001d220: 6563 6569 7665 2074 6173 6b20 7265 7175  eceive task requ
+0001d230: 6573 7473 2061 6e64 0a20 2020 2020 2020  ests and.       
+0001d240: 2072 6570 6f72 7420 7461 736b 2073 7461   report task sta
+0001d250: 7475 7320 7570 6461 7465 732e 0a20 2020  tus updates..   
+0001d260: 202a 202a 2a73 7472 6561 6d5f 636f 6d6d   * **stream_comm
+0001d270: 733a 2a2a 2060 607b 776f 726b 6572 206b  s:** ``{worker k
+0001d280: 6579 3a20 436f 6d6d 7d60 600a 2020 2020  ey: Comm}``.    
+0001d290: 2020 2020 466f 7220 6561 6368 2077 6f72      For each wor
+0001d2a0: 6b65 722c 2061 2043 6f6d 6d20 6f62 6a65  ker, a Comm obje
+0001d2b0: 6374 2066 726f 6d20 7768 6963 6820 7765  ct from which we
+0001d2c0: 2062 6f74 6820 6163 6365 7074 2073 7469   both accept sti
+0001d2d0: 6d75 6c69 2061 6e64 0a20 2020 2020 2020  muli and.       
+0001d2e0: 2072 6570 6f72 7420 7265 7375 6c74 730a   report results.
+0001d2f0: 2020 2020 2a20 2a2a 7461 736b 5f64 7572      * **task_dur
+0001d300: 6174 696f 6e3a 2a2a 2060 607b 6b65 792d  ation:** ``{key-
+0001d310: 7072 6566 6978 3a20 7469 6d65 7d60 600a  prefix: time}``.
+0001d320: 2020 2020 2020 2020 5469 6d65 2077 6520          Time we 
+0001d330: 6578 7065 6374 2063 6572 7461 696e 2066  expect certain f
+0001d340: 756e 6374 696f 6e73 2074 6f20 7461 6b65  unctions to take
+0001d350: 2c20 652e 672e 2060 607b 2773 756d 273a  , e.g. ``{'sum':
+0001d360: 2030 2e32 357d 6060 0a20 2020 2022 2222   0.25}``.    """
+0001d370: 0a0a 2020 2020 6465 6661 756c 745f 706f  ..    default_po
+0001d380: 7274 203d 2038 3738 360a 2020 2020 5f69  rt = 8786.    _i
+0001d390: 6e73 7461 6e63 6573 3a20 436c 6173 7356  nstances: ClassV
+0001d3a0: 6172 5b77 6561 6b72 6566 2e57 6561 6b53  ar[weakref.WeakS
+0001d3b0: 6574 5b53 6368 6564 756c 6572 5d5d 203d  et[Scheduler]] =
+0001d3c0: 2077 6561 6b72 6566 2e57 6561 6b53 6574   weakref.WeakSet
+0001d3d0: 2829 0a0a 2020 2020 6465 6620 5f5f 696e  ()..    def __in
+0001d3e0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
+0001d3f0: 6c66 2c0a 2020 2020 2020 2020 6c6f 6f70  lf,.        loop
+0001d400: 3d4e 6f6e 652c 0a20 2020 2020 2020 2064  =None,.        d
+0001d410: 656c 6574 655f 696e 7465 7276 616c 3d22  elete_interval="
+0001d420: 3530 306d 7322 2c0a 2020 2020 2020 2020  500ms",.        
+0001d430: 7379 6e63 6872 6f6e 697a 655f 776f 726b  synchronize_work
+0001d440: 6572 5f69 6e74 6572 7661 6c3d 2236 3073  er_interval="60s
+0001d450: 222c 0a20 2020 2020 2020 2073 6572 7669  ",.        servi
+0001d460: 6365 733d 4e6f 6e65 2c0a 2020 2020 2020  ces=None,.      
+0001d470: 2020 7365 7276 6963 655f 6b77 6172 6773    service_kwargs
+0001d480: 3d4e 6f6e 652c 0a20 2020 2020 2020 2061  =None,.        a
+0001d490: 6c6c 6f77 6564 5f66 6169 6c75 7265 733d  llowed_failures=
+0001d4a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6578  None,.        ex
+0001d4b0: 7465 6e73 696f 6e73 3d4e 6f6e 652c 0a20  tensions=None,. 
+0001d4c0: 2020 2020 2020 2076 616c 6964 6174 653d         validate=
+0001d4d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7363  None,.        sc
+0001d4e0: 6865 6475 6c65 725f 6669 6c65 3d4e 6f6e  heduler_file=Non
+0001d4f0: 652c 0a20 2020 2020 2020 2073 6563 7572  e,.        secur
+0001d500: 6974 793d 4e6f 6e65 2c0a 2020 2020 2020  ity=None,.      
+0001d510: 2020 776f 726b 6572 5f74 746c 3d4e 6f6e    worker_ttl=Non
+0001d520: 652c 0a20 2020 2020 2020 2069 646c 655f  e,.        idle_
+0001d530: 7469 6d65 6f75 743d 4e6f 6e65 2c0a 2020  timeout=None,.  
+0001d540: 2020 2020 2020 696e 7465 7266 6163 653d        interface=
+0001d550: 4e6f 6e65 2c0a 2020 2020 2020 2020 686f  None,.        ho
+0001d560: 7374 3d4e 6f6e 652c 0a20 2020 2020 2020  st=None,.       
+0001d570: 2070 6f72 743d 302c 0a20 2020 2020 2020   port=0,.       
+0001d580: 2070 726f 746f 636f 6c3d 4e6f 6e65 2c0a   protocol=None,.
+0001d590: 2020 2020 2020 2020 6461 7368 626f 6172          dashboar
+0001d5a0: 645f 6164 6472 6573 733d 4e6f 6e65 2c0a  d_address=None,.
+0001d5b0: 2020 2020 2020 2020 6461 7368 626f 6172          dashboar
+0001d5c0: 643d 4e6f 6e65 2c0a 2020 2020 2020 2020  d=None,.        
+0001d5d0: 6874 7470 5f70 7265 6669 783d 222f 222c  http_prefix="/",
+0001d5e0: 0a20 2020 2020 2020 2070 7265 6c6f 6164  .        preload
+0001d5f0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2070  =None,.        p
+0001d600: 7265 6c6f 6164 5f61 7267 763d 2829 2c0a  reload_argv=(),.
+0001d610: 2020 2020 2020 2020 706c 7567 696e 733d          plugins=
+0001d620: 2829 2c0a 2020 2020 2020 2020 636f 6e74  (),.        cont
+0001d630: 6163 745f 6164 6472 6573 733d 4e6f 6e65  act_address=None
+0001d640: 2c0a 2020 2020 2020 2020 7472 616e 7369  ,.        transi
+0001d650: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
+0001d660: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0001d670: 6a75 7079 7465 723d 4661 6c73 652c 0a20  jupyter=False,. 
+0001d680: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0001d690: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0001d6a0: 6966 206c 6f6f 7020 6973 206e 6f74 204e  if loop is not N
+0001d6b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001d6c0: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
+0001d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6e0: 2274 6865 206c 6f6f 7020 6b77 6172 6720  "the loop kwarg 
+0001d6f0: 746f 2053 6368 6564 756c 6572 2069 7320  to Scheduler is 
+0001d700: 6465 7072 6563 6174 6564 222c 0a20 2020  deprecated",.   
+0001d710: 2020 2020 2020 2020 2020 2020 2044 6570               Dep
+0001d720: 7265 6361 7469 6f6e 5761 726e 696e 672c  recationWarning,
+0001d730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d740: 2073 7461 636b 6c65 7665 6c3d 322c 0a20   stacklevel=2,. 
+0001d750: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0001d760: 2020 2020 2020 7365 6c66 2e6c 6f6f 7020        self.loop 
+0001d770: 3d20 7365 6c66 2e69 6f5f 6c6f 6f70 203d  = self.io_loop =
+0001d780: 2049 4f4c 6f6f 702e 6375 7272 656e 7428   IOLoop.current(
+0001d790: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+0001d7a0: 7365 7475 705f 6c6f 6767 696e 6728 6c6f  setup_logging(lo
+0001d7b0: 6767 6572 290a 0a20 2020 2020 2020 2023  gger)..        #
+0001d7c0: 2041 7474 7269 6275 7465 730a 2020 2020   Attributes.    
+0001d7d0: 2020 2020 6966 2063 6f6e 7461 6374 5f61      if contact_a
+0001d7e0: 6464 7265 7373 2069 7320 4e6f 6e65 3a0a  ddress is None:.
+0001d7f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001d800: 6163 745f 6164 6472 6573 7320 3d20 6461  act_address = da
+0001d810: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0001d820: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0001d830: 756c 6572 2e63 6f6e 7461 6374 2d61 6464  uler.contact-add
+0001d840: 7265 7373 2229 0a20 2020 2020 2020 2073  ress").        s
+0001d850: 656c 662e 636f 6e74 6163 745f 6164 6472  elf.contact_addr
+0001d860: 6573 7320 3d20 636f 6e74 6163 745f 6164  ess = contact_ad
+0001d870: 6472 6573 730a 2020 2020 2020 2020 6966  dress.        if
+0001d880: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
+0001d890: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0001d8a0: 2020 2020 2020 2061 6c6c 6f77 6564 5f66         allowed_f
+0001d8b0: 6169 6c75 7265 7320 3d20 6461 736b 2e63  ailures = dask.c
+0001d8c0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0001d8d0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0001d8e0: 2e61 6c6c 6f77 6564 2d66 6169 6c75 7265  .allowed-failure
+0001d8f0: 7322 290a 2020 2020 2020 2020 7365 6c66  s").        self
+0001d900: 2e61 6c6c 6f77 6564 5f66 6169 6c75 7265  .allowed_failure
+0001d910: 7320 3d20 616c 6c6f 7765 645f 6661 696c  s = allowed_fail
+0001d920: 7572 6573 0a20 2020 2020 2020 2069 6620  ures.        if 
+0001d930: 7661 6c69 6461 7465 2069 7320 4e6f 6e65  validate is None
+0001d940: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
+0001d950: 6c69 6461 7465 203d 2064 6173 6b2e 636f  lidate = dask.co
+0001d960: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+0001d970: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0001d980: 7661 6c69 6461 7465 2229 0a20 2020 2020  validate").     
+0001d990: 2020 2073 656c 662e 7072 6f63 203d 2070     self.proc = p
+0001d9a0: 7375 7469 6c2e 5072 6f63 6573 7328 290a  sutil.Process().
+0001d9b0: 2020 2020 2020 2020 7365 6c66 2e64 656c          self.del
+0001d9c0: 6574 655f 696e 7465 7276 616c 203d 2070  ete_interval = p
+0001d9d0: 6172 7365 5f74 696d 6564 656c 7461 2864  arse_timedelta(d
+0001d9e0: 656c 6574 655f 696e 7465 7276 616c 2c20  elete_interval, 
+0001d9f0: 6465 6661 756c 743d 226d 7322 290a 2020  default="ms").  
+0001da00: 2020 2020 2020 7365 6c66 2e73 796e 6368        self.synch
+0001da10: 726f 6e69 7a65 5f77 6f72 6b65 725f 696e  ronize_worker_in
+0001da20: 7465 7276 616c 203d 2070 6172 7365 5f74  terval = parse_t
+0001da30: 696d 6564 656c 7461 280a 2020 2020 2020  imedelta(.      
+0001da40: 2020 2020 2020 7379 6e63 6872 6f6e 697a        synchroniz
+0001da50: 655f 776f 726b 6572 5f69 6e74 6572 7661  e_worker_interva
+0001da60: 6c2c 2064 6566 6175 6c74 3d22 6d73 220a  l, default="ms".
+0001da70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001da80: 2020 7365 6c66 2e73 6572 7669 6365 5f73    self.service_s
+0001da90: 7065 6373 203d 2073 6572 7669 6365 7320  pecs = services 
+0001daa0: 6f72 207b 7d0a 2020 2020 2020 2020 7365  or {}.        se
+0001dab0: 6c66 2e73 6572 7669 6365 5f6b 7761 7267  lf.service_kwarg
+0001dac0: 7320 3d20 7365 7276 6963 655f 6b77 6172  s = service_kwar
+0001dad0: 6773 206f 7220 7b7d 0a20 2020 2020 2020  gs or {}.       
+0001dae0: 2073 656c 662e 7365 7276 6963 6573 203d   self.services =
+0001daf0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+0001db00: 2e73 6368 6564 756c 6572 5f66 696c 6520  .scheduler_file 
+0001db10: 3d20 7363 6865 6475 6c65 725f 6669 6c65  = scheduler_file
+0001db20: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+0001db30: 7474 6c20 3d20 776f 726b 6572 5f74 746c  ttl = worker_ttl
+0001db40: 206f 7220 6461 736b 2e63 6f6e 6669 672e   or dask.config.
+0001db50: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0001db60: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+0001db70: 722d 7474 6c22 290a 2020 2020 2020 2020  r-ttl").        
+0001db80: 7365 6c66 2e77 6f72 6b65 725f 7474 6c20  self.worker_ttl 
+0001db90: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+0001dba0: 6128 776f 726b 6572 5f74 746c 2920 6966  a(worker_ttl) if
+0001dbb0: 2077 6f72 6b65 725f 7474 6c20 656c 7365   worker_ttl else
+0001dbc0: 204e 6f6e 650a 2020 2020 2020 2020 6964   None.        id
+0001dbd0: 6c65 5f74 696d 656f 7574 203d 2069 646c  le_timeout = idl
+0001dbe0: 655f 7469 6d65 6f75 7420 6f72 2064 6173  e_timeout or das
+0001dbf0: 6b2e 636f 6e66 6967 2e67 6574 280a 2020  k.config.get(.  
+0001dc00: 2020 2020 2020 2020 2020 2264 6973 7472            "distr
+0001dc10: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0001dc20: 2e69 646c 652d 7469 6d65 6f75 7422 0a20  .idle-timeout". 
+0001dc30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001dc40: 2069 6620 6964 6c65 5f74 696d 656f 7574   if idle_timeout
+0001dc50: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001dc60: 6c66 2e69 646c 655f 7469 6d65 6f75 7420  lf.idle_timeout 
+0001dc70: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+0001dc80: 6128 6964 6c65 5f74 696d 656f 7574 290a  a(idle_timeout).
+0001dc90: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001dca0: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+0001dcb0: 646c 655f 7469 6d65 6f75 7420 3d20 4e6f  dle_timeout = No
+0001dcc0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+0001dcd0: 6964 6c65 5f73 696e 6365 203d 2074 696d  idle_since = tim
+0001dce0: 6528 290a 2020 2020 2020 2020 7365 6c66  e().        self
+0001dcf0: 2e74 696d 655f 7374 6172 7465 6420 3d20  .time_started = 
+0001dd00: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+0001dd10: 2023 2063 6f6d 7061 7469 6269 6c69 7479   # compatibility
+0001dd20: 2066 6f72 2064 6173 6b2d 6761 7465 7761   for dask-gatewa
+0001dd30: 790a 2020 2020 2020 2020 7365 6c66 2e5f  y.        self._
+0001dd40: 6c6f 636b 203d 2061 7379 6e63 696f 2e4c  lock = asyncio.L
+0001dd50: 6f63 6b28 290a 2020 2020 2020 2020 7365  ock().        se
+0001dd60: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
+0001dd70: 6b65 7273 203d 2064 6566 6175 6c74 6469  kers = defaultdi
+0001dd80: 6374 2866 6c6f 6174 290a 2020 2020 2020  ct(float).      
+0001dd90: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
+0001dda0: 5f74 7970 6573 203d 2064 6566 6175 6c74  _types = default
+0001ddb0: 6469 6374 2866 6c6f 6174 290a 0a20 2020  dict(float)..   
+0001ddc0: 2020 2020 2073 656c 662e 6375 6d75 6c61       self.cumula
+0001ddd0: 7469 7665 5f77 6f72 6b65 725f 6d65 7472  tive_worker_metr
+0001dde0: 6963 7320 3d20 6465 6661 756c 7464 6963  ics = defaultdic
+0001ddf0: 7428 666c 6f61 7429 0a0a 2020 2020 2020  t(float)..      
+0001de00: 2020 6966 206e 6f74 2070 7265 6c6f 6164    if not preload
+0001de10: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+0001de20: 656c 6f61 6420 3d20 6461 736b 2e63 6f6e  eload = dask.con
+0001de30: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0001de40: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+0001de50: 7265 6c6f 6164 2229 0a20 2020 2020 2020  reload").       
+0001de60: 2069 6620 6e6f 7420 7072 656c 6f61 645f   if not preload_
+0001de70: 6172 6776 3a0a 2020 2020 2020 2020 2020  argv:.          
+0001de80: 2020 7072 656c 6f61 645f 6172 6776 203d    preload_argv =
+0001de90: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+0001dea0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0001deb0: 6865 6475 6c65 722e 7072 656c 6f61 642d  heduler.preload-
+0001dec0: 6172 6776 2229 0a20 2020 2020 2020 2073  argv").        s
+0001ded0: 656c 662e 7072 656c 6f61 6473 203d 2070  elf.preloads = p
+0001dee0: 7265 6c6f 6164 696e 672e 7072 6f63 6573  reloading.proces
+0001def0: 735f 7072 656c 6f61 6473 2873 656c 662c  s_preloads(self,
+0001df00: 2070 7265 6c6f 6164 2c20 7072 656c 6f61   preload, preloa
+0001df10: 645f 6172 6776 290a 0a20 2020 2020 2020  d_argv)..       
+0001df20: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+0001df30: 6563 7572 6974 792c 2064 6963 7429 3a0a  ecurity, dict):.
+0001df40: 2020 2020 2020 2020 2020 2020 7365 6375              secu
+0001df50: 7269 7479 203d 2053 6563 7572 6974 7928  rity = Security(
+0001df60: 2a2a 7365 6375 7269 7479 290a 2020 2020  **security).    
+0001df70: 2020 2020 7365 6c66 2e73 6563 7572 6974      self.securit
+0001df80: 7920 3d20 7365 6375 7269 7479 206f 7220  y = security or 
+0001df90: 5365 6375 7269 7479 2829 0a20 2020 2020  Security().     
+0001dfa0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0001dfb0: 616e 6365 2873 656c 662e 7365 6375 7269  ance(self.securi
+0001dfc0: 7479 2c20 5365 6375 7269 7479 290a 2020  ty, Security).  
+0001dfd0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+0001dfe0: 6374 696f 6e5f 6172 6773 203d 2073 656c  ction_args = sel
+0001dff0: 662e 7365 6375 7269 7479 2e67 6574 5f63  f.security.get_c
+0001e000: 6f6e 6e65 6374 696f 6e5f 6172 6773 2822  onnection_args("
+0001e010: 7363 6865 6475 6c65 7222 290a 2020 2020  scheduler").    
+0001e020: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0001e030: 696f 6e5f 6172 6773 5b22 6861 6e64 7368  ion_args["handsh
+0001e040: 616b 655f 6f76 6572 7269 6465 7322 5d20  ake_overrides"] 
+0001e050: 3d20 7b20 2023 2063 6f6d 6d6f 6e20 6465  = {  # common de
+0001e060: 6e6f 6d69 6e61 746f 720a 2020 2020 2020  nominator.      
+0001e070: 2020 2020 2020 2270 6963 6b6c 652d 7072        "pickle-pr
+0001e080: 6f74 6f63 6f6c 223a 2034 0a20 2020 2020  otocol": 4.     
+0001e090: 2020 207d 0a0a 2020 2020 2020 2020 7365     }..        se
+0001e0a0: 6c66 2e5f 7374 6172 745f 6164 6472 6573  lf._start_addres
+0001e0b0: 7320 3d20 6164 6472 6573 7365 735f 6672  s = addresses_fr
+0001e0c0: 6f6d 5f75 7365 725f 6172 6773 280a 2020  om_user_args(.  
+0001e0d0: 2020 2020 2020 2020 2020 686f 7374 3d68            host=h
+0001e0e0: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
+0001e0f0: 2070 6f72 743d 706f 7274 2c0a 2020 2020   port=port,.    
+0001e100: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+0001e110: 653d 696e 7465 7266 6163 652c 0a20 2020  e=interface,.   
+0001e120: 2020 2020 2020 2020 2070 726f 746f 636f           protoco
+0001e130: 6c3d 7072 6f74 6f63 6f6c 2c0a 2020 2020  l=protocol,.    
+0001e140: 2020 2020 2020 2020 7365 6375 7269 7479          security
+0001e150: 3d73 6563 7572 6974 792c 0a20 2020 2020  =security,.     
+0001e160: 2020 2020 2020 2064 6566 6175 6c74 5f70         default_p
+0001e170: 6f72 743d 7365 6c66 2e64 6566 6175 6c74  ort=self.default
+0001e180: 5f70 6f72 742c 0a20 2020 2020 2020 2029  _port,.        )
+0001e190: 0a0a 2020 2020 2020 2020 6874 7470 5f73  ..        http_s
+0001e1a0: 6572 7665 725f 6d6f 6475 6c65 7320 3d20  erver_modules = 
+0001e1b0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0001e1c0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+0001e1d0: 6564 756c 6572 2e68 7474 702e 726f 7574  eduler.http.rout
+0001e1e0: 6573 2229 0a20 2020 2020 2020 2073 686f  es").        sho
+0001e1f0: 775f 6461 7368 626f 6172 6420 3d20 6461  w_dashboard = da
+0001e200: 7368 626f 6172 6420 6f72 2028 6461 7368  shboard or (dash
+0001e210: 626f 6172 6420 6973 204e 6f6e 6520 616e  board is None an
+0001e220: 6420 6461 7368 626f 6172 645f 6164 6472  d dashboard_addr
+0001e230: 6573 7329 0a20 2020 2020 2020 2023 2069  ess).        # i
+0001e240: 6e73 7461 6c6c 2076 616e 696c 6c61 2072  nstall vanilla r
+0001e250: 6f75 7465 2069 6620 7368 6f77 5f64 6173  oute if show_das
+0001e260: 6862 6f61 7264 2062 7574 2062 6f6b 6568  hboard but bokeh
+0001e270: 2069 7320 6e6f 7420 696e 7374 616c 6c65   is not installe
+0001e280: 640a 2020 2020 2020 2020 6966 2073 686f  d.        if sho
+0001e290: 775f 6461 7368 626f 6172 643a 0a20 2020  w_dashboard:.   
+0001e2a0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0001e2b0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0001e2c0: 706f 7274 2064 6973 7472 6962 7574 6564  port distributed
+0001e2d0: 2e64 6173 6862 6f61 7264 2e73 6368 6564  .dashboard.sched
+0001e2e0: 756c 6572 0a20 2020 2020 2020 2020 2020  uler.           
+0001e2f0: 2065 7863 6570 7420 496d 706f 7274 4572   except ImportEr
+0001e300: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0001e310: 2020 2020 2073 686f 775f 6461 7368 626f       show_dashbo
+0001e320: 6172 6420 3d20 4661 6c73 650a 2020 2020  ard = False.    
+0001e330: 2020 2020 2020 2020 2020 2020 6874 7470              http
+0001e340: 5f73 6572 7665 725f 6d6f 6475 6c65 732e  _server_modules.
+0001e350: 6170 7065 6e64 2822 6469 7374 7269 6275  append("distribu
+0001e360: 7465 642e 6874 7470 2e73 6368 6564 756c  ted.http.schedul
+0001e370: 6572 2e6d 6973 7369 6e67 5f62 6f6b 6568  er.missing_bokeh
+0001e380: 2229 0a20 2020 2020 2020 2072 6f75 7465  ").        route
+0001e390: 7320 3d20 6765 745f 6861 6e64 6c65 7273  s = get_handlers
+0001e3a0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0001e3b0: 7276 6572 3d73 656c 662c 206d 6f64 756c  rver=self, modul
+0001e3c0: 6573 3d68 7474 705f 7365 7276 6572 5f6d  es=http_server_m
+0001e3d0: 6f64 756c 6573 2c20 7072 6566 6978 3d68  odules, prefix=h
+0001e3e0: 7474 705f 7072 6566 6978 0a20 2020 2020  ttp_prefix.     
+0001e3f0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0001e400: 662e 7374 6172 745f 6874 7470 5f73 6572  f.start_http_ser
+0001e410: 7665 7228 726f 7574 6573 2c20 6461 7368  ver(routes, dash
+0001e420: 626f 6172 645f 6164 6472 6573 732c 2064  board_address, d
+0001e430: 6566 6175 6c74 5f70 6f72 743d 3837 3837  efault_port=8787
+0001e440: 290a 2020 2020 2020 2020 7365 6c66 2e6a  ).        self.j
+0001e450: 7570 7974 6572 203d 206a 7570 7974 6572  upyter = jupyter
+0001e460: 0a20 2020 2020 2020 2069 6620 7368 6f77  .        if show
+0001e470: 5f64 6173 6862 6f61 7264 3a0a 2020 2020  _dashboard:.    
+0001e480: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+0001e490: 7465 642e 6461 7368 626f 6172 642e 7363  ted.dashboard.sc
+0001e4a0: 6865 6475 6c65 722e 636f 6e6e 6563 7428  heduler.connect(
+0001e4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e4c0: 2073 656c 662e 6874 7470 5f61 7070 6c69   self.http_appli
+0001e4d0: 6361 7469 6f6e 2c20 7365 6c66 2e68 7474  cation, self.htt
+0001e4e0: 705f 7365 7276 6572 2c20 7365 6c66 2c20  p_server, self, 
+0001e4f0: 7072 6566 6978 3d68 7474 705f 7072 6566  prefix=http_pref
+0001e500: 6978 0a20 2020 2020 2020 2020 2020 2029  ix.            )
+0001e510: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001e520: 2e6a 7570 7974 6572 3a0a 2020 2020 2020  .jupyter:.      
+0001e530: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001e540: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0001e550: 6a75 7079 7465 725f 7365 7276 6572 2e73  jupyter_server.s
+0001e560: 6572 7665 7261 7070 2069 6d70 6f72 7420  erverapp import 
+0001e570: 5365 7276 6572 4170 700a 2020 2020 2020  ServerApp.      
+0001e580: 2020 2020 2020 6578 6365 7074 2049 6d70        except Imp
+0001e590: 6f72 7445 7272 6f72 3a0a 2020 2020 2020  ortError:.      
+0001e5a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001e5b0: 496d 706f 7274 4572 726f 7228 0a20 2020  ImportError(.   
+0001e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5d0: 2022 496e 206f 7264 6572 2074 6f20 7573   "In order to us
+0001e5e0: 6520 7468 6520 4461 736b 206a 7570 7974  e the Dask jupyt
+0001e5f0: 6572 206f 7074 696f 6e20 796f 7520 220a  er option you ".
+0001e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e610: 2020 2020 226e 6565 6420 746f 2068 6176      "need to hav
+0001e620: 6520 6a75 7079 7465 726c 6162 2069 6e73  e jupyterlab ins
+0001e630: 7461 6c6c 6564 220a 2020 2020 2020 2020  talled".        
+0001e640: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001e650: 2020 2020 2020 6672 6f6d 2074 7261 6974        from trait
+0001e660: 6c65 7473 2e63 6f6e 6669 6720 696d 706f  lets.config impo
+0001e670: 7274 2043 6f6e 6669 670a 0a20 2020 2020  rt Config..     
+0001e680: 2020 2020 2020 206a 203d 2053 6572 7665         j = Serve
+0001e690: 7241 7070 2e69 6e73 7461 6e63 6528 0a20  rApp.instance(. 
+0001e6a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001e6b0: 6f6e 6669 673d 436f 6e66 6967 280a 2020  onfig=Config(.  
+0001e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0001e6e0: 2020 2020 2020 2020 2020 2020 2253 6572              "Ser
+0001e6f0: 7665 7241 7070 223a 207b 0a20 2020 2020  verApp": {.     
 0001e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e710: 2020 2022 746f 6b65 6e22 3a20 2222 2c0a     "token": "",.
-0001e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e730: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
-0001e740: 6f77 5f72 656d 6f74 655f 6163 6365 7373  ow_remote_access
-0001e750: 223a 2054 7275 652c 0a20 2020 2020 2020  ": True,.       
-0001e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e770: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0001e780: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0001e790: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001e7a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001e7b0: 2020 2020 206a 2e69 6e69 7469 616c 697a       j.initializ
-0001e7c0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001e7d0: 2020 206e 6577 5f68 7474 7073 6572 7665     new_httpserve
-0001e7e0: 723d 4661 6c73 652c 0a20 2020 2020 2020  r=False,.       
-0001e7f0: 2020 2020 2020 2020 2061 7267 763d 5b5d           argv=[]
-0001e800: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0001e810: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001e820: 2e5f 6a75 7079 7465 725f 7365 7276 6572  ._jupyter_server
-0001e830: 5f61 7070 6c69 6361 7469 6f6e 203d 206a  _application = j
-0001e840: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001e850: 662e 6874 7470 5f61 7070 6c69 6361 7469  f.http_applicati
-0001e860: 6f6e 2e61 6464 5f61 7070 6c69 6361 7469  on.add_applicati
-0001e870: 6f6e 286a 2e77 6562 5f61 7070 290a 0a20  on(j.web_app).. 
-0001e880: 2020 2020 2020 2023 2043 6f6d 6d75 6e69         # Communi
-0001e890: 6361 7469 6f6e 2073 7461 7465 0a20 2020  cation state.   
-0001e8a0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0001e8b0: 5f63 6f6d 6d73 203d 207b 7d0a 2020 2020  _comms = {}.    
-0001e8c0: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
-0001e8d0: 636f 6d6d 7320 3d20 7b7d 0a0a 2020 2020  comms = {}..    
-0001e8e0: 2020 2020 2320 5461 736b 2073 7461 7465      # Task state
-0001e8f0: 0a20 2020 2020 2020 2074 6173 6b73 203d  .        tasks =
-0001e900: 207b 7d0a 0a20 2020 2020 2020 2073 656c   {}..        sel
-0001e910: 662e 6765 6e65 7261 7469 6f6e 203d 2030  f.generation = 0
-0001e920: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-0001e930: 6173 745f 636c 6965 6e74 203d 204e 6f6e  ast_client = Non
-0001e940: 650a 2020 2020 2020 2020 7365 6c66 2e5f  e.        self._
-0001e950: 6c61 7374 5f74 696d 6520 3d20 300a 2020  last_time = 0.  
-0001e960: 2020 2020 2020 756e 7275 6e6e 6162 6c65        unrunnable
-0001e970: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0001e980: 2071 7565 7565 643a 2048 6561 7053 6574   queued: HeapSet
-0001e990: 5b54 6173 6b53 7461 7465 5d20 3d20 4865  [TaskState] = He
-0001e9a0: 6170 5365 7428 6b65 793d 6f70 6572 6174  apSet(key=operat
-0001e9b0: 6f72 2e61 7474 7267 6574 7465 7228 2270  or.attrgetter("p
-0001e9c0: 7269 6f72 6974 7922 2929 0a0a 2020 2020  riority"))..    
-0001e9d0: 2020 2020 7365 6c66 2e64 6174 6173 6574      self.dataset
-0001e9e0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-0001e9f0: 2320 5072 6566 6978 2d6b 6579 6564 2063  # Prefix-keyed c
-0001ea00: 6f6e 7461 696e 6572 730a 0a20 2020 2020  ontainers..     
-0001ea10: 2020 2023 2043 6c69 656e 7420 7374 6174     # Client stat
-0001ea20: 650a 2020 2020 2020 2020 636c 6965 6e74  e.        client
-0001ea30: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-0001ea40: 2320 576f 726b 6572 2073 7461 7465 0a20  # Worker state. 
-0001ea50: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-0001ea60: 2053 6f72 7465 6444 6963 7428 290a 0a20   SortedDict().. 
-0001ea70: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
-0001ea80: 203d 207b 7d0a 2020 2020 2020 2020 7265   = {}.        re
-0001ea90: 736f 7572 6365 7320 3d20 7b7d 0a20 2020  sources = {}.   
-0001eaa0: 2020 2020 2061 6c69 6173 6573 203d 207b       aliases = {
-0001eab0: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
-0001eac0: 5f77 6f72 6b65 725f 636f 6c6c 6563 7469  _worker_collecti
-0001ead0: 6f6e 7320 3d20 5b0a 2020 2020 2020 2020  ons = [.        
-0001eae0: 2020 2020 776f 726b 6572 732c 0a20 2020      workers,.   
-0001eaf0: 2020 2020 2020 2020 2068 6f73 745f 696e           host_in
-0001eb00: 666f 2c0a 2020 2020 2020 2020 2020 2020  fo,.            
-0001eb10: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
-0001eb20: 2020 2020 2020 2061 6c69 6173 6573 2c0a         aliases,.
-0001eb30: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
-0001eb40: 2020 2073 656c 662e 6576 656e 7473 203d     self.events =
-0001eb50: 2064 6566 6175 6c74 6469 6374 280a 2020   defaultdict(.  
-0001eb60: 2020 2020 2020 2020 2020 7061 7274 6961            partia
-0001eb70: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-0001eb80: 2020 2064 6571 7565 2c20 6d61 786c 656e     deque, maxlen
-0001eb90: 3d64 6173 6b2e 636f 6e66 6967 2e67 6574  =dask.config.get
-0001eba0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
-0001ebb0: 6865 6475 6c65 722e 6576 656e 7473 2d6c  heduler.events-l
-0001ebc0: 6f67 2d6c 656e 6774 6822 290a 2020 2020  og-length").    
-0001ebd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001ebe0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-0001ebf0: 2e65 7665 6e74 5f63 6f75 6e74 7320 3d20  .event_counts = 
-0001ec00: 6465 6661 756c 7464 6963 7428 696e 7429  defaultdict(int)
-0001ec10: 0a20 2020 2020 2020 2073 656c 662e 6576  .        self.ev
-0001ec20: 656e 745f 7375 6273 6372 6962 6572 203d  ent_subscriber =
-0001ec30: 2064 6566 6175 6c74 6469 6374 2873 6574   defaultdict(set
-0001ec40: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
-0001ec50: 6f72 6b65 725f 706c 7567 696e 7320 3d20  orker_plugins = 
-0001ec60: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-0001ec70: 6e61 6e6e 795f 706c 7567 696e 7320 3d20  nanny_plugins = 
-0001ec80: 7b7d 0a0a 2020 2020 2020 2020 776f 726b  {}..        work
-0001ec90: 6572 5f68 616e 646c 6572 7320 3d20 7b0a  er_handlers = {.
-0001eca0: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
-0001ecb0: 6b2d 6669 6e69 7368 6564 223a 2073 656c  k-finished": sel
-0001ecc0: 662e 6861 6e64 6c65 5f74 6173 6b5f 6669  f.handle_task_fi
-0001ecd0: 6e69 7368 6564 2c0a 2020 2020 2020 2020  nished,.        
-0001ece0: 2020 2020 2274 6173 6b2d 6572 7265 6422      "task-erred"
-0001ecf0: 3a20 7365 6c66 2e68 616e 646c 655f 7461  : self.handle_ta
-0001ed00: 736b 5f65 7272 6564 2c0a 2020 2020 2020  sk_erred,.      
-0001ed10: 2020 2020 2020 2272 656c 6561 7365 2d77        "release-w
-0001ed20: 6f72 6b65 722d 6461 7461 223a 2073 656c  orker-data": sel
-0001ed30: 662e 7265 6c65 6173 655f 776f 726b 6572  f.release_worker
-0001ed40: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
-0001ed50: 2020 2022 6164 642d 6b65 7973 223a 2073     "add-keys": s
-0001ed60: 656c 662e 6164 645f 6b65 7973 2c0a 2020  elf.add_keys,.  
-0001ed70: 2020 2020 2020 2020 2020 226c 6f6e 672d            "long-
-0001ed80: 7275 6e6e 696e 6722 3a20 7365 6c66 2e68  running": self.h
-0001ed90: 616e 646c 655f 6c6f 6e67 5f72 756e 6e69  andle_long_runni
-0001eda0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-0001edb0: 2272 6573 6368 6564 756c 6522 3a20 7365  "reschedule": se
-0001edc0: 6c66 2e5f 7265 7363 6865 6475 6c65 2c0a  lf._reschedule,.
-0001edd0: 2020 2020 2020 2020 2020 2020 226b 6565              "kee
-0001ede0: 702d 616c 6976 6522 3a20 6c61 6d62 6461  p-alive": lambda
-0001edf0: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-0001ee00: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-0001ee10: 2020 2020 226c 6f67 2d65 7665 6e74 223a      "log-event":
-0001ee20: 2073 656c 662e 6c6f 675f 776f 726b 6572   self.log_worker
-0001ee30: 5f65 7665 6e74 2c0a 2020 2020 2020 2020  _event,.        
-0001ee40: 2020 2020 2277 6f72 6b65 722d 7374 6174      "worker-stat
-0001ee50: 7573 2d63 6861 6e67 6522 3a20 7365 6c66  us-change": self
-0001ee60: 2e68 616e 646c 655f 776f 726b 6572 5f73  .handle_worker_s
-0001ee70: 7461 7475 735f 6368 616e 6765 2c0a 2020  tatus_change,.  
-0001ee80: 2020 2020 2020 2020 2020 2272 6571 7565            "reque
-0001ee90: 7374 2d72 6566 7265 7368 2d77 686f 2d68  st-refresh-who-h
-0001eea0: 6173 223a 2073 656c 662e 6861 6e64 6c65  as": self.handle
-0001eeb0: 5f72 6571 7565 7374 5f72 6566 7265 7368  _request_refresh
-0001eec0: 5f77 686f 5f68 6173 2c0a 2020 2020 2020  _who_has,.      
-0001eed0: 2020 7d0a 0a20 2020 2020 2020 2063 6c69    }..        cli
-0001eee0: 656e 745f 6861 6e64 6c65 7273 203d 207b  ent_handlers = {
-0001eef0: 0a20 2020 2020 2020 2020 2020 2022 7570  .            "up
-0001ef00: 6461 7465 2d67 7261 7068 223a 2073 656c  date-graph": sel
-0001ef10: 662e 7570 6461 7465 5f67 7261 7068 2c0a  f.update_graph,.
-0001ef20: 2020 2020 2020 2020 2020 2020 2263 6c69              "cli
-0001ef30: 656e 742d 6465 7369 7265 732d 6b65 7973  ent-desires-keys
-0001ef40: 223a 2073 656c 662e 636c 6965 6e74 5f64  ": self.client_d
-0001ef50: 6573 6972 6573 5f6b 6579 732c 0a20 2020  esires_keys,.   
-0001ef60: 2020 2020 2020 2020 2022 7570 6461 7465           "update
-0001ef70: 2d64 6174 6122 3a20 7365 6c66 2e75 7064  -data": self.upd
-0001ef80: 6174 655f 6461 7461 2c0a 2020 2020 2020  ate_data,.      
-0001ef90: 2020 2020 2020 2272 6570 6f72 742d 6b65        "report-ke
-0001efa0: 7922 3a20 7365 6c66 2e72 6570 6f72 745f  y": self.report_
-0001efb0: 6f6e 5f6b 6579 2c0a 2020 2020 2020 2020  on_key,.        
-0001efc0: 2020 2020 2263 6c69 656e 742d 7265 6c65      "client-rele
-0001efd0: 6173 6573 2d6b 6579 7322 3a20 7365 6c66  ases-keys": self
-0001efe0: 2e63 6c69 656e 745f 7265 6c65 6173 6573  .client_releases
-0001eff0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
-0001f000: 2020 2022 6865 6172 7462 6561 742d 636c     "heartbeat-cl
-0001f010: 6965 6e74 223a 2073 656c 662e 636c 6965  ient": self.clie
-0001f020: 6e74 5f68 6561 7274 6265 6174 2c0a 2020  nt_heartbeat,.  
-0001f030: 2020 2020 2020 2020 2020 2263 6c6f 7365            "close
-0001f040: 2d63 6c69 656e 7422 3a20 7365 6c66 2e72  -client": self.r
-0001f050: 656d 6f76 655f 636c 6965 6e74 2c0a 2020  emove_client,.  
-0001f060: 2020 2020 2020 2020 2020 2273 7562 7363            "subsc
-0001f070: 7269 6265 2d74 6f70 6963 223a 2073 656c  ribe-topic": sel
-0001f080: 662e 7375 6273 6372 6962 655f 746f 7069  f.subscribe_topi
-0001f090: 632c 0a20 2020 2020 2020 2020 2020 2022  c,.            "
-0001f0a0: 756e 7375 6273 6372 6962 652d 746f 7069  unsubscribe-topi
-0001f0b0: 6322 3a20 7365 6c66 2e75 6e73 7562 7363  c": self.unsubsc
-0001f0c0: 7269 6265 5f74 6f70 6963 2c0a 2020 2020  ribe_topic,.    
-0001f0d0: 2020 2020 2020 2020 2263 616e 6365 6c2d          "cancel-
-0001f0e0: 6b65 7973 223a 2073 656c 662e 7374 696d  keys": self.stim
-0001f0f0: 756c 7573 5f63 616e 6365 6c2c 0a20 2020  ulus_cancel,.   
-0001f100: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0001f110: 7365 6c66 2e68 616e 646c 6572 7320 3d20  self.handlers = 
-0001f120: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
-0001f130: 6567 6973 7465 722d 636c 6965 6e74 223a  egister-client":
-0001f140: 2073 656c 662e 6164 645f 636c 6965 6e74   self.add_client
-0001f150: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0001f160: 6361 7474 6572 223a 2073 656c 662e 7363  catter": self.sc
-0001f170: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
-0001f180: 2020 2022 7265 6769 7374 6572 2d77 6f72     "register-wor
-0001f190: 6b65 7222 3a20 7365 6c66 2e61 6464 5f77  ker": self.add_w
-0001f1a0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-0001f1b0: 2020 2022 7265 6769 7374 6572 5f6e 616e     "register_nan
-0001f1c0: 6e79 223a 2073 656c 662e 6164 645f 6e61  ny": self.add_na
-0001f1d0: 6e6e 792c 0a20 2020 2020 2020 2020 2020  nny,.           
-0001f1e0: 2022 756e 7265 6769 7374 6572 223a 2073   "unregister": s
-0001f1f0: 656c 662e 7265 6d6f 7665 5f77 6f72 6b65  elf.remove_worke
-0001f200: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
-0001f210: 6761 7468 6572 223a 2073 656c 662e 6761  gather": self.ga
-0001f220: 7468 6572 2c0a 2020 2020 2020 2020 2020  ther,.          
-0001f230: 2020 2272 6574 7279 223a 2073 656c 662e    "retry": self.
-0001f240: 7374 696d 756c 7573 5f72 6574 7279 2c0a  stimulus_retry,.
-0001f250: 2020 2020 2020 2020 2020 2020 2266 6565              "fee
-0001f260: 6422 3a20 7365 6c66 2e66 6565 642c 0a20  d": self.feed,. 
-0001f270: 2020 2020 2020 2020 2020 2022 7465 726d             "term
-0001f280: 696e 6174 6522 3a20 7365 6c66 2e63 6c6f  inate": self.clo
-0001f290: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-0001f2a0: 2262 726f 6164 6361 7374 223a 2073 656c  "broadcast": sel
-0001f2b0: 662e 6272 6f61 6463 6173 742c 0a20 2020  f.broadcast,.   
-0001f2c0: 2020 2020 2020 2020 2022 7072 6f78 7922           "proxy"
-0001f2d0: 3a20 7365 6c66 2e70 726f 7879 2c0a 2020  : self.proxy,.  
-0001f2e0: 2020 2020 2020 2020 2020 226e 636f 7265            "ncore
-0001f2f0: 7322 3a20 7365 6c66 2e67 6574 5f6e 636f  s": self.get_nco
-0001f300: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
-0001f310: 2022 6e63 6f72 6573 5f72 756e 6e69 6e67   "ncores_running
-0001f320: 223a 2073 656c 662e 6765 745f 6e63 6f72  ": self.get_ncor
-0001f330: 6573 5f72 756e 6e69 6e67 2c0a 2020 2020  es_running,.    
-0001f340: 2020 2020 2020 2020 2268 6173 5f77 6861          "has_wha
-0001f350: 7422 3a20 7365 6c66 2e67 6574 5f68 6173  t": self.get_has
-0001f360: 5f77 6861 742c 0a20 2020 2020 2020 2020  _what,.         
-0001f370: 2020 2022 7768 6f5f 6861 7322 3a20 7365     "who_has": se
-0001f380: 6c66 2e67 6574 5f77 686f 5f68 6173 2c0a  lf.get_who_has,.
-0001f390: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
-0001f3a0: 6365 7373 696e 6722 3a20 7365 6c66 2e67  cessing": self.g
-0001f3b0: 6574 5f70 726f 6365 7373 696e 672c 0a20  et_processing,. 
-0001f3c0: 2020 2020 2020 2020 2020 2022 6361 6c6c             "call
-0001f3d0: 5f73 7461 636b 223a 2073 656c 662e 6765  _stack": self.ge
-0001f3e0: 745f 6361 6c6c 5f73 7461 636b 2c0a 2020  t_call_stack,.  
-0001f3f0: 2020 2020 2020 2020 2020 2270 726f 6669            "profi
-0001f400: 6c65 223a 2073 656c 662e 6765 745f 7072  le": self.get_pr
-0001f410: 6f66 696c 652c 0a20 2020 2020 2020 2020  ofile,.         
-0001f420: 2020 2022 7065 7266 6f72 6d61 6e63 655f     "performance_
-0001f430: 7265 706f 7274 223a 2073 656c 662e 7065  report": self.pe
-0001f440: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
-0001f450: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
-0001f460: 6574 5f6c 6f67 7322 3a20 7365 6c66 2e67  et_logs": self.g
-0001f470: 6574 5f6c 6f67 732c 0a20 2020 2020 2020  et_logs,.       
-0001f480: 2020 2020 2022 6c6f 6773 223a 2073 656c       "logs": sel
-0001f490: 662e 6765 745f 6c6f 6773 2c0a 2020 2020  f.get_logs,.    
-0001f4a0: 2020 2020 2020 2020 2277 6f72 6b65 725f          "worker_
-0001f4b0: 6c6f 6773 223a 2073 656c 662e 6765 745f  logs": self.get_
-0001f4c0: 776f 726b 6572 5f6c 6f67 732c 0a20 2020  worker_logs,.   
-0001f4d0: 2020 2020 2020 2020 2022 6c6f 675f 6576           "log_ev
-0001f4e0: 656e 7422 3a20 7365 6c66 2e6c 6f67 5f65  ent": self.log_e
-0001f4f0: 7665 6e74 2c0a 2020 2020 2020 2020 2020  vent,.          
-0001f500: 2020 2265 7665 6e74 7322 3a20 7365 6c66    "events": self
-0001f510: 2e67 6574 5f65 7665 6e74 732c 0a20 2020  .get_events,.   
-0001f520: 2020 2020 2020 2020 2022 6e62 7974 6573           "nbytes
-0001f530: 223a 2073 656c 662e 6765 745f 6e62 7974  ": self.get_nbyt
-0001f540: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0001f550: 2276 6572 7369 6f6e 7322 3a20 7365 6c66  "versions": self
-0001f560: 2e76 6572 7369 6f6e 732c 0a20 2020 2020  .versions,.     
-0001f570: 2020 2020 2020 2022 6164 645f 6b65 7973         "add_keys
-0001f580: 223a 2073 656c 662e 6164 645f 6b65 7973  ": self.add_keys
-0001f590: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-0001f5a0: 6562 616c 616e 6365 223a 2073 656c 662e  ebalance": self.
-0001f5b0: 7265 6261 6c61 6e63 652c 0a20 2020 2020  rebalance,.     
-0001f5c0: 2020 2020 2020 2022 7265 706c 6963 6174         "replicat
-0001f5d0: 6522 3a20 7365 6c66 2e72 6570 6c69 6361  e": self.replica
-0001f5e0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
-0001f5f0: 2272 756e 5f66 756e 6374 696f 6e22 3a20  "run_function": 
-0001f600: 7365 6c66 2e72 756e 5f66 756e 6374 696f  self.run_functio
-0001f610: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
-0001f620: 7265 7374 6172 7422 3a20 7365 6c66 2e72  restart": self.r
-0001f630: 6573 7461 7274 2c0a 2020 2020 2020 2020  estart,.        
-0001f640: 2020 2020 2275 7064 6174 655f 6461 7461      "update_data
-0001f650: 223a 2073 656c 662e 7570 6461 7465 5f64  ": self.update_d
-0001f660: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
-0001f670: 2022 7365 745f 7265 736f 7572 6365 7322   "set_resources"
-0001f680: 3a20 7365 6c66 2e61 6464 5f72 6573 6f75  : self.add_resou
-0001f690: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
-0001f6a0: 2020 2272 6574 6972 655f 776f 726b 6572    "retire_worker
-0001f6b0: 7322 3a20 7365 6c66 2e72 6574 6972 655f  s": self.retire_
-0001f6c0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
-0001f6d0: 2020 2020 2022 6765 745f 6d65 7461 6461       "get_metada
-0001f6e0: 7461 223a 2073 656c 662e 6765 745f 6d65  ta": self.get_me
-0001f6f0: 7461 6461 7461 2c0a 2020 2020 2020 2020  tadata,.        
-0001f700: 2020 2020 2273 6574 5f6d 6574 6164 6174      "set_metadat
-0001f710: 6122 3a20 7365 6c66 2e73 6574 5f6d 6574  a": self.set_met
-0001f720: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-0001f730: 2020 2022 7365 745f 7265 7374 7269 6374     "set_restrict
-0001f740: 696f 6e73 223a 2073 656c 662e 7365 745f  ions": self.set_
-0001f750: 7265 7374 7269 6374 696f 6e73 2c0a 2020  restrictions,.  
-0001f760: 2020 2020 2020 2020 2020 2268 6561 7274            "heart
-0001f770: 6265 6174 5f77 6f72 6b65 7222 3a20 7365  beat_worker": se
-0001f780: 6c66 2e68 6561 7274 6265 6174 5f77 6f72  lf.heartbeat_wor
-0001f790: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-0001f7a0: 2022 6765 745f 7461 736b 5f73 7461 7475   "get_task_statu
-0001f7b0: 7322 3a20 7365 6c66 2e67 6574 5f74 6173  s": self.get_tas
-0001f7c0: 6b5f 7374 6174 7573 2c0a 2020 2020 2020  k_status,.      
-0001f7d0: 2020 2020 2020 2267 6574 5f74 6173 6b5f        "get_task_
-0001f7e0: 7374 7265 616d 223a 2073 656c 662e 6765  stream": self.ge
-0001f7f0: 745f 7461 736b 5f73 7472 6561 6d2c 0a20  t_task_stream,. 
-0001f800: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-0001f810: 7461 736b 5f70 7265 6669 785f 7374 6174  task_prefix_stat
-0001f820: 6573 223a 2073 656c 662e 6765 745f 7461  es": self.get_ta
-0001f830: 736b 5f70 7265 6669 785f 7374 6174 6573  sk_prefix_states
-0001f840: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-0001f850: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
-0001f860: 725f 706c 7567 696e 223a 2073 656c 662e  r_plugin": self.
-0001f870: 7265 6769 7374 6572 5f73 6368 6564 756c  register_schedul
-0001f880: 6572 5f70 6c75 6769 6e2c 0a20 2020 2020  er_plugin,.     
-0001f890: 2020 2020 2020 2022 7265 6769 7374 6572         "register
-0001f8a0: 5f77 6f72 6b65 725f 706c 7567 696e 223a  _worker_plugin":
-0001f8b0: 2073 656c 662e 7265 6769 7374 6572 5f77   self.register_w
-0001f8c0: 6f72 6b65 725f 706c 7567 696e 2c0a 2020  orker_plugin,.  
-0001f8d0: 2020 2020 2020 2020 2020 2275 6e72 6567            "unreg
-0001f8e0: 6973 7465 725f 776f 726b 6572 5f70 6c75  ister_worker_plu
-0001f8f0: 6769 6e22 3a20 7365 6c66 2e75 6e72 6567  gin": self.unreg
-0001f900: 6973 7465 725f 776f 726b 6572 5f70 6c75  ister_worker_plu
-0001f910: 6769 6e2c 0a20 2020 2020 2020 2020 2020  gin,.           
-0001f920: 2022 7265 6769 7374 6572 5f6e 616e 6e79   "register_nanny
-0001f930: 5f70 6c75 6769 6e22 3a20 7365 6c66 2e72  _plugin": self.r
-0001f940: 6567 6973 7465 725f 6e61 6e6e 795f 706c  egister_nanny_pl
-0001f950: 7567 696e 2c0a 2020 2020 2020 2020 2020  ugin,.          
-0001f960: 2020 2275 6e72 6567 6973 7465 725f 6e61    "unregister_na
-0001f970: 6e6e 795f 706c 7567 696e 223a 2073 656c  nny_plugin": sel
-0001f980: 662e 756e 7265 6769 7374 6572 5f6e 616e  f.unregister_nan
-0001f990: 6e79 5f70 6c75 6769 6e2c 0a20 2020 2020  ny_plugin,.     
-0001f9a0: 2020 2020 2020 2022 6164 6170 7469 7665         "adaptive
-0001f9b0: 5f74 6172 6765 7422 3a20 7365 6c66 2e61  _target": self.a
-0001f9c0: 6461 7074 6976 655f 7461 7267 6574 2c0a  daptive_target,.
-0001f9d0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-0001f9e0: 6b65 7273 5f74 6f5f 636c 6f73 6522 3a20  kers_to_close": 
-0001f9f0: 7365 6c66 2e77 6f72 6b65 7273 5f74 6f5f  self.workers_to_
-0001fa00: 636c 6f73 652c 0a20 2020 2020 2020 2020  close,.         
-0001fa10: 2020 2022 7375 6273 6372 6962 655f 776f     "subscribe_wo
-0001fa20: 726b 6572 5f73 7461 7475 7322 3a20 7365  rker_status": se
-0001fa30: 6c66 2e73 7562 7363 7269 6265 5f77 6f72  lf.subscribe_wor
-0001fa40: 6b65 725f 7374 6174 7573 2c0a 2020 2020  ker_status,.    
-0001fa50: 2020 2020 2020 2020 2273 7461 7274 5f74          "start_t
-0001fa60: 6173 6b5f 6d65 7461 6461 7461 223a 2073  ask_metadata": s
-0001fa70: 656c 662e 7374 6172 745f 7461 736b 5f6d  elf.start_task_m
-0001fa80: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
-0001fa90: 2020 2020 2022 7374 6f70 5f74 6173 6b5f       "stop_task_
-0001faa0: 6d65 7461 6461 7461 223a 2073 656c 662e  metadata": self.
-0001fab0: 7374 6f70 5f74 6173 6b5f 6d65 7461 6461  stop_task_metada
-0001fac0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-0001fad0: 2267 6574 5f63 6c75 7374 6572 5f73 7461  "get_cluster_sta
-0001fae0: 7465 223a 2073 656c 662e 6765 745f 636c  te": self.get_cl
-0001faf0: 7573 7465 725f 7374 6174 652c 0a20 2020  uster_state,.   
-0001fb00: 2020 2020 2020 2020 2022 6475 6d70 5f63           "dump_c
-0001fb10: 6c75 7374 6572 5f73 7461 7465 5f74 6f5f  luster_state_to_
-0001fb20: 7572 6c22 3a20 7365 6c66 2e64 756d 705f  url": self.dump_
-0001fb30: 636c 7573 7465 725f 7374 6174 655f 746f  cluster_state_to
-0001fb40: 5f75 726c 2c0a 2020 2020 2020 2020 2020  _url,.          
-0001fb50: 2020 2262 656e 6368 6d61 726b 5f68 6172    "benchmark_har
-0001fb60: 6477 6172 6522 3a20 7365 6c66 2e62 656e  dware": self.ben
-0001fb70: 6368 6d61 726b 5f68 6172 6477 6172 652c  chmark_hardware,
-0001fb80: 0a20 2020 2020 2020 2020 2020 2022 6765  .            "ge
-0001fb90: 745f 7374 6f72 7922 3a20 7365 6c66 2e67  t_story": self.g
-0001fba0: 6574 5f73 746f 7279 2c0a 2020 2020 2020  et_story,.      
-0001fbb0: 2020 2020 2020 2263 6865 636b 5f69 646c        "check_idl
-0001fbc0: 6522 3a20 7365 6c66 2e63 6865 636b 5f69  e": self.check_i
-0001fbd0: 646c 652c 0a20 2020 2020 2020 207d 0a0a  dle,.        }..
-0001fbe0: 2020 2020 2020 2020 636f 6e6e 6563 7469          connecti
-0001fbf0: 6f6e 5f6c 696d 6974 203d 2067 6574 5f66  on_limit = get_f
-0001fc00: 696c 656e 6f5f 6c69 6d69 7428 2920 2f20  ileno_limit() / 
-0001fc10: 320a 0a20 2020 2020 2020 2053 6368 6564  2..        Sched
-0001fc20: 756c 6572 5374 6174 652e 5f5f 696e 6974  ulerState.__init
-0001fc30: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
-0001fc40: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-0001fc50: 2020 616c 6961 7365 733d 616c 6961 7365    aliases=aliase
-0001fc60: 732c 0a20 2020 2020 2020 2020 2020 2063  s,.            c
-0001fc70: 6c69 656e 7473 3d63 6c69 656e 7473 2c0a  lients=clients,.
-0001fc80: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0001fc90: 6572 733d 776f 726b 6572 732c 0a20 2020  ers=workers,.   
-0001fca0: 2020 2020 2020 2020 2068 6f73 745f 696e           host_in
-0001fcb0: 666f 3d68 6f73 745f 696e 666f 2c0a 2020  fo=host_info,.  
-0001fcc0: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-0001fcd0: 6365 733d 7265 736f 7572 6365 732c 0a20  ces=resources,. 
-0001fce0: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-0001fcf0: 3d74 6173 6b73 2c0a 2020 2020 2020 2020  =tasks,.        
-0001fd00: 2020 2020 756e 7275 6e6e 6162 6c65 3d75      unrunnable=u
-0001fd10: 6e72 756e 6e61 626c 652c 0a20 2020 2020  nrunnable,.     
-0001fd20: 2020 2020 2020 2071 7565 7565 643d 7175         queued=qu
-0001fd30: 6575 6564 2c0a 2020 2020 2020 2020 2020  eued,.          
-0001fd40: 2020 7661 6c69 6461 7465 3d76 616c 6964    validate=valid
-0001fd50: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
-0001fd60: 2070 6c75 6769 6e73 3d70 6c75 6769 6e73   plugins=plugins
-0001fd70: 2c0a 2020 2020 2020 2020 2020 2020 7472  ,.            tr
-0001fd80: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-0001fd90: 5f6d 6178 3d74 7261 6e73 6974 696f 6e5f  _max=transition_
-0001fda0: 636f 756e 7465 725f 6d61 782c 0a20 2020  counter_max,.   
-0001fdb0: 2020 2020 2029 0a20 2020 2020 2020 2053       ).        S
-0001fdc0: 6572 7665 724e 6f64 652e 5f5f 696e 6974  erverNode.__init
-0001fdd0: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
-0001fde0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-0001fdf0: 2020 6861 6e64 6c65 7273 3d73 656c 662e    handlers=self.
-0001fe00: 6861 6e64 6c65 7273 2c0a 2020 2020 2020  handlers,.      
-0001fe10: 2020 2020 2020 7374 7265 616d 5f68 616e        stream_han
-0001fe20: 646c 6572 733d 6d65 7267 6528 776f 726b  dlers=merge(work
-0001fe30: 6572 5f68 616e 646c 6572 732c 2063 6c69  er_handlers, cli
-0001fe40: 656e 745f 6861 6e64 6c65 7273 292c 0a20  ent_handlers),. 
-0001fe50: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
-0001fe60: 6374 696f 6e5f 6c69 6d69 743d 636f 6e6e  ction_limit=conn
-0001fe70: 6563 7469 6f6e 5f6c 696d 6974 2c0a 2020  ection_limit,.  
-0001fe80: 2020 2020 2020 2020 2020 6465 7365 7269            deseri
-0001fe90: 616c 697a 653d 4661 6c73 652c 0a20 2020  alize=False,.   
-0001fea0: 2020 2020 2020 2020 2063 6f6e 6e65 6374           connect
-0001feb0: 696f 6e5f 6172 6773 3d73 656c 662e 636f  ion_args=self.co
-0001fec0: 6e6e 6563 7469 6f6e 5f61 7267 732c 0a20  nnection_args,. 
-0001fed0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-0001fee0: 7267 732c 0a20 2020 2020 2020 2029 0a0a  rgs,.        )..
-0001fef0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001ff00: 776f 726b 6572 5f74 746c 3a0a 2020 2020  worker_ttl:.    
-0001ff10: 2020 2020 2020 2020 7063 203d 2050 6572          pc = Per
-0001ff20: 696f 6469 6343 616c 6c62 6163 6b28 7365  iodicCallback(se
-0001ff30: 6c66 2e63 6865 636b 5f77 6f72 6b65 725f  lf.check_worker_
-0001ff40: 7474 6c2c 2073 656c 662e 776f 726b 6572  ttl, self.worker
-0001ff50: 5f74 746c 202a 2031 3030 3029 0a20 2020  _ttl * 1000).   
-0001ff60: 2020 2020 2020 2020 2073 656c 662e 7065           self.pe
-0001ff70: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
-0001ff80: 5b22 776f 726b 6572 2d74 746c 225d 203d  ["worker-ttl"] =
-0001ff90: 2070 630a 0a20 2020 2020 2020 2070 6320   pc..        pc 
-0001ffa0: 3d20 5065 7269 6f64 6963 4361 6c6c 6261  = PeriodicCallba
-0001ffb0: 636b 2873 656c 662e 6368 6563 6b5f 6964  ck(self.check_id
-0001ffc0: 6c65 2c20 2873 656c 662e 6964 6c65 5f74  le, (self.idle_t
-0001ffd0: 696d 656f 7574 206f 7220 3129 202a 2031  imeout or 1) * 1
-0001ffe0: 3030 3020 2f20 3429 0a20 2020 2020 2020  000 / 4).       
-0001fff0: 2073 656c 662e 7065 7269 6f64 6963 5f63   self.periodic_c
-00020000: 616c 6c62 6163 6b73 5b22 6964 6c65 2d74  allbacks["idle-t
-00020010: 696d 656f 7574 225d 203d 2070 630a 0a20  imeout"] = pc.. 
-00020020: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
-00020030: 696f 6e73 2069 7320 4e6f 6e65 3a0a 2020  ions is None:.  
-00020040: 2020 2020 2020 2020 2020 6578 7465 6e73            extens
-00020050: 696f 6e73 203d 2044 4546 4155 4c54 5f45  ions = DEFAULT_E
-00020060: 5854 454e 5349 4f4e 532e 636f 7079 2829  XTENSIONS.copy()
-00020070: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00020080: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
-00020090: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-000200a0: 2e73 6368 6564 756c 6572 2e77 6f72 6b2d  .scheduler.work-
-000200b0: 7374 6561 6c69 6e67 2229 3a0a 2020 2020  stealing"):.    
-000200c0: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-000200d0: 7374 6561 6c69 6e67 2220 696e 2065 7874  stealing" in ext
-000200e0: 656e 7369 6f6e 733a 0a20 2020 2020 2020  ensions:.       
-000200f0: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00020100: 2065 7874 656e 7369 6f6e 735b 2273 7465   extensions["ste
-00020110: 616c 696e 6722 5d0a 0a20 2020 2020 2020  aling"]..       
-00020120: 2066 6f72 206e 616d 652c 2065 7874 656e   for name, exten
-00020130: 7369 6f6e 2069 6e20 6578 7465 6e73 696f  sion in extensio
-00020140: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
-00020150: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
-00020160: 656e 7369 6f6e 735b 6e61 6d65 5d20 3d20  ensions[name] = 
-00020170: 6578 7465 6e73 696f 6e28 7365 6c66 290a  extension(self).
-00020180: 0a20 2020 2020 2020 2073 6574 7072 6f63  .        setproc
-00020190: 7469 746c 6528 2264 6173 6b20 7363 6865  title("dask sche
-000201a0: 6475 6c65 7220 5b6e 6f74 2073 7461 7274  duler [not start
-000201b0: 6564 5d22 290a 2020 2020 2020 2020 5363  ed]").        Sc
-000201c0: 6865 6475 6c65 722e 5f69 6e73 7461 6e63  heduler._instanc
-000201d0: 6573 2e61 6464 2873 656c 6629 0a20 2020  es.add(self).   
-000201e0: 2020 2020 2073 656c 662e 7270 632e 616c       self.rpc.al
-000201f0: 6c6f 775f 6f66 666c 6f61 6420 3d20 4661  low_offload = Fa
-00020200: 6c73 650a 0a20 2020 2023 2323 2323 2323  lse..    #######
-00020210: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00020220: 2320 4164 6d69 6e69 7374 7261 7469 6f6e  # Administration
-00020230: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
-00020240: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
-00020250: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-00020260: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00020270: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-00020280: 6622 3c53 6368 6564 756c 6572 207b 7365  f"<Scheduler {se
-00020290: 6c66 2e61 6464 7265 7373 5f73 6166 6521  lf.address_safe!
-000202a0: 727d 2c20 220a 2020 2020 2020 2020 2020  r}, ".          
-000202b0: 2020 6622 776f 726b 6572 733a 207b 6c65    f"workers: {le
-000202c0: 6e28 7365 6c66 2e77 6f72 6b65 7273 297d  n(self.workers)}
-000202d0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-000202e0: 6622 636f 7265 733a 207b 7365 6c66 2e74  f"cores: {self.t
-000202f0: 6f74 616c 5f6e 7468 7265 6164 737d 2c20  otal_nthreads}, 
-00020300: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00020310: 7461 736b 733a 207b 6c65 6e28 7365 6c66  tasks: {len(self
-00020320: 2e74 6173 6b73 297d 3e22 0a20 2020 2020  .tasks)}>".     
-00020330: 2020 2029 0a0a 2020 2020 6465 6620 5f72     )..    def _r
-00020340: 6570 725f 6874 6d6c 5f28 7365 6c66 293a  epr_html_(self):
-00020350: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020360: 6765 745f 7465 6d70 6c61 7465 2822 7363  get_template("sc
-00020370: 6865 6475 6c65 722e 6874 6d6c 2e6a 3222  heduler.html.j2"
-00020380: 292e 7265 6e64 6572 280a 2020 2020 2020  ).render(.      
-00020390: 2020 2020 2020 6164 6472 6573 733d 7365        address=se
-000203a0: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
-000203b0: 2020 2020 2020 2020 776f 726b 6572 733d          workers=
-000203c0: 7365 6c66 2e77 6f72 6b65 7273 2c0a 2020  self.workers,.  
-000203d0: 2020 2020 2020 2020 2020 7468 7265 6164            thread
-000203e0: 733d 7365 6c66 2e74 6f74 616c 5f6e 7468  s=self.total_nth
-000203f0: 7265 6164 732c 0a20 2020 2020 2020 2020  reads,.         
-00020400: 2020 2074 6173 6b73 3d73 656c 662e 7461     tasks=self.ta
-00020410: 736b 732c 0a20 2020 2020 2020 2029 0a0a  sks,.        )..
-00020420: 2020 2020 6465 6620 6964 656e 7469 7479      def identity
-00020430: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00020440: 2222 2242 6173 6963 2069 6e66 6f72 6d61  """Basic informa
-00020450: 7469 6f6e 2061 626f 7574 206f 7572 7365  tion about ourse
-00020460: 6c76 6573 2061 6e64 206f 7572 2063 6c75  lves and our clu
-00020470: 7374 6572 2222 220a 2020 2020 2020 2020  ster""".        
-00020480: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
-00020490: 2020 2274 7970 6522 3a20 7479 7065 2873    "type": type(s
-000204a0: 656c 6629 2e5f 5f6e 616d 655f 5f2c 0a20  elf).__name__,. 
-000204b0: 2020 2020 2020 2020 2020 2022 6964 223a             "id":
-000204c0: 2073 7472 2873 656c 662e 6964 292c 0a20   str(self.id),. 
-000204d0: 2020 2020 2020 2020 2020 2022 6164 6472             "addr
-000204e0: 6573 7322 3a20 7365 6c66 2e61 6464 7265  ess": self.addre
-000204f0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-00020500: 2273 6572 7669 6365 7322 3a20 7b6b 6579  "services": {key
-00020510: 3a20 762e 706f 7274 2066 6f72 2028 6b65  : v.port for (ke
-00020520: 792c 2076 2920 696e 2073 656c 662e 7365  y, v) in self.se
-00020530: 7276 6963 6573 2e69 7465 6d73 2829 7d2c  rvices.items()},
-00020540: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-00020550: 6172 7465 6422 3a20 7365 6c66 2e74 696d  arted": self.tim
-00020560: 655f 7374 6172 7465 642c 0a20 2020 2020  e_started,.     
-00020570: 2020 2020 2020 2022 776f 726b 6572 7322         "workers"
-00020580: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00020590: 2020 2020 776f 726b 6572 2e61 6464 7265      worker.addre
-000205a0: 7373 3a20 776f 726b 6572 2e69 6465 6e74  ss: worker.ident
-000205b0: 6974 7928 2920 666f 7220 776f 726b 6572  ity() for worker
-000205c0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-000205d0: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
-000205e0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-000205f0: 207d 0a20 2020 2020 2020 2072 6574 7572   }.        retur
-00020600: 6e20 640a 0a20 2020 2064 6566 205f 746f  n d..    def _to
-00020610: 5f64 6963 7428 7365 6c66 2c20 2a2c 2065  _dict(self, *, e
-00020620: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
-00020630: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
-00020640: 6469 6374 3a0a 2020 2020 2020 2020 2222  dict:.        ""
-00020650: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
-00020660: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
-00020670: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
-00020680: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
-00020690: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
-000206a0: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
-000206b0: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
-000206c0: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-000206d0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-000206e0: 2020 2020 2020 2053 6572 7665 722e 6964         Server.id
-000206f0: 656e 7469 7479 0a20 2020 2020 2020 2043  entity.        C
-00020700: 6c69 656e 742e 6475 6d70 5f63 6c75 7374  lient.dump_clust
-00020710: 6572 5f73 7461 7465 0a20 2020 2020 2020  er_state.       
-00020720: 2064 6973 7472 6962 7574 6564 2e75 7469   distributed.uti
-00020730: 6c73 2e72 6563 7572 7369 7665 5f74 6f5f  ls.recursive_to_
-00020740: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
-00020750: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
-00020760: 7375 7065 7228 292e 5f74 6f5f 6469 6374  super()._to_dict
-00020770: 2865 7863 6c75 6465 3d65 7863 6c75 6465  (exclude=exclude
-00020780: 290a 2020 2020 2020 2020 6578 7472 6120  ).        extra 
-00020790: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-000207a0: 2274 7261 6e73 6974 696f 6e5f 6c6f 6722  "transition_log"
-000207b0: 3a20 7365 6c66 2e74 7261 6e73 6974 696f  : self.transitio
-000207c0: 6e5f 6c6f 672c 0a20 2020 2020 2020 2020  n_log,.         
-000207d0: 2020 2022 7472 616e 7369 7469 6f6e 5f63     "transition_c
-000207e0: 6f75 6e74 6572 223a 2073 656c 662e 7472  ounter": self.tr
-000207f0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00020800: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-00020810: 6173 6b73 223a 2073 656c 662e 7461 736b  asks": self.task
-00020820: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-00020830: 7461 736b 5f67 726f 7570 7322 3a20 7365  task_groups": se
-00020840: 6c66 2e74 6173 6b5f 6772 6f75 7073 2c0a  lf.task_groups,.
-00020850: 2020 2020 2020 2020 2020 2020 2320 4f76              # Ov
-00020860: 6572 7772 6974 6520 6469 6374 206f 6620  erwrite dict of 
-00020870: 576f 726b 6572 5374 6174 652e 6964 656e  WorkerState.iden
-00020880: 7469 7479 2066 726f 6d20 696e 666f 0a20  tity from info. 
-00020890: 2020 2020 2020 2020 2020 2022 776f 726b             "work
-000208a0: 6572 7322 3a20 7365 6c66 2e77 6f72 6b65  ers": self.worke
-000208b0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-000208c0: 2263 6c69 656e 7473 223a 2073 656c 662e  "clients": self.
-000208d0: 636c 6965 6e74 732c 0a20 2020 2020 2020  clients,.       
-000208e0: 2020 2020 2022 6d65 6d6f 7279 223a 2073       "memory": s
-000208f0: 656c 662e 6d65 6d6f 7279 2c0a 2020 2020  elf.memory,.    
-00020900: 2020 2020 2020 2020 2265 7665 6e74 7322          "events"
-00020910: 3a20 7365 6c66 2e65 7665 6e74 732c 0a20  : self.events,. 
-00020920: 2020 2020 2020 2020 2020 2022 6578 7465             "exte
-00020930: 6e73 696f 6e73 223a 2073 656c 662e 6578  nsions": self.ex
-00020940: 7465 6e73 696f 6e73 2c0a 2020 2020 2020  tensions,.      
-00020950: 2020 7d0a 2020 2020 2020 2020 6578 7472    }.        extr
-00020960: 6120 3d20 7b6b 3a20 7620 666f 7220 6b2c  a = {k: v for k,
-00020970: 2076 2069 6e20 6578 7472 612e 6974 656d   v in extra.item
-00020980: 7328 2920 6966 206b 206e 6f74 2069 6e20  s() if k not in 
-00020990: 6578 636c 7564 657d 0a20 2020 2020 2020  exclude}.       
-000209a0: 2069 6e66 6f2e 7570 6461 7465 2872 6563   info.update(rec
-000209b0: 7572 7369 7665 5f74 6f5f 6469 6374 2865  ursive_to_dict(e
-000209c0: 7874 7261 2c20 6578 636c 7564 653d 6578  xtra, exclude=ex
-000209d0: 636c 7564 6529 290a 2020 2020 2020 2020  clude)).        
-000209e0: 7265 7475 726e 2069 6e66 6f0a 0a20 2020  return info..   
-000209f0: 2061 7379 6e63 2064 6566 2067 6574 5f63   async def get_c
-00020a00: 6c75 7374 6572 5f73 7461 7465 280a 2020  luster_state(.  
-00020a10: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00020a20: 2020 2020 6578 636c 7564 653a 2022 436f      exclude: "Co
-00020a30: 6c6c 6563 7469 6f6e 5b73 7472 5d22 2c0a  llection[str]",.
-00020a40: 2020 2020 2920 2d3e 2064 6963 743a 0a20      ) -> dict:. 
-00020a50: 2020 2020 2020 2022 5072 6f64 7563 6520         "Produce 
-00020a60: 7468 6520 7374 6174 6520 6469 6374 2075  the state dict u
-00020a70: 7365 6420 696e 2061 2063 6c75 7374 6572  sed in a cluster
-00020a80: 2073 7461 7465 2064 756d 7022 0a20 2020   state dump".   
-00020a90: 2020 2020 2023 204b 6963 6b20 6f66 6620       # Kick off 
-00020aa0: 7374 6174 652d 6475 6d70 696e 6720 6f6e  state-dumping on
-00020ab0: 2077 6f72 6b65 7273 2062 6566 6f72 6520   workers before 
-00020ac0: 7765 2062 6c6f 636b 2074 6865 2065 7665  we block the eve
-00020ad0: 6e74 206c 6f6f 7020 696e 2060 7365 6c66  nt loop in `self
-00020ae0: 2e5f 746f 5f64 6963 7460 2e0a 2020 2020  ._to_dict`..    
-00020af0: 2020 2020 776f 726b 6572 735f 6675 7475      workers_futu
-00020b00: 7265 203d 2061 7379 6e63 696f 2e67 6174  re = asyncio.gat
-00020b10: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00020b20: 2073 656c 662e 6272 6f61 6463 6173 7428   self.broadcast(
-00020b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020b40: 206d 7367 3d7b 226f 7022 3a20 2264 756d   msg={"op": "dum
-00020b50: 705f 7374 6174 6522 2c20 2265 7863 6c75  p_state", "exclu
-00020b60: 6465 223a 2065 7863 6c75 6465 7d2c 0a20  de": exclude},. 
-00020b70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00020b80: 6e5f 6572 726f 723d 2272 6574 7572 6e22  n_error="return"
-00020b90: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-00020ba0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020bb0: 662e 6272 6f61 6463 6173 7428 0a20 2020  f.broadcast(.   
-00020bc0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00020bd0: 3d7b 226f 7022 3a20 2276 6572 7369 6f6e  ={"op": "version
-00020be0: 7322 7d2c 0a20 2020 2020 2020 2020 2020  s"},.           
-00020bf0: 2020 2020 206f 6e5f 6572 726f 723d 2269       on_error="i
-00020c00: 676e 6f72 6522 2c0a 2020 2020 2020 2020  gnore",.        
-00020c10: 2020 2020 292c 0a20 2020 2020 2020 2029      ),.        )
-00020c20: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00020c30: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
-00020c40: 6c65 725f 7374 6174 6520 3d20 7365 6c66  ler_state = self
-00020c50: 2e5f 746f 5f64 6963 7428 6578 636c 7564  ._to_dict(exclud
-00020c60: 653d 6578 636c 7564 6529 0a0a 2020 2020  e=exclude)..    
-00020c70: 2020 2020 2020 2020 776f 726b 6572 5f73          worker_s
-00020c80: 7461 7465 732c 2077 6f72 6b65 725f 7665  tates, worker_ve
-00020c90: 7273 696f 6e73 203d 2061 7761 6974 2077  rsions = await w
-00020ca0: 6f72 6b65 7273 5f66 7574 7572 650a 2020  orkers_future.  
-00020cb0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
-00020cc0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-00020cd0: 7572 6520 7468 6520 7461 736b 7320 6172  ure the tasks ar
-00020ce0: 656e 2774 206c 6566 7420 7275 6e6e 696e  en't left runnin
-00020cf0: 6720 6966 2061 6e79 7468 696e 6720 6661  g if anything fa
-00020d00: 696c 732e 0a20 2020 2020 2020 2020 2020  ils..           
-00020d10: 2023 2053 6f6d 6564 6179 2028 7079 332e   # Someday (py3.
-00020d20: 3131 292c 2075 7365 2061 2074 7269 6f2d  11), use a trio-
-00020d30: 7374 796c 6520 5461 736b 4772 6f75 7020  style TaskGroup 
-00020d40: 666f 7220 7468 6973 2e0a 2020 2020 2020  for this..      
-00020d50: 2020 2020 2020 776f 726b 6572 735f 6675        workers_fu
-00020d60: 7475 7265 2e63 616e 6365 6c28 290a 0a20  ture.cancel().. 
-00020d70: 2020 2020 2020 2023 2043 6f6e 7665 7274         # Convert
-00020d80: 2061 6e79 2052 5043 2065 7272 6f72 7320   any RPC errors 
-00020d90: 746f 2073 7472 696e 6773 0a20 2020 2020  to strings.     
-00020da0: 2020 2077 6f72 6b65 725f 7374 6174 6573     worker_states
-00020db0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00020dc0: 206b 3a20 7265 7072 2876 2920 6966 2069   k: repr(v) if i
-00020dd0: 7369 6e73 7461 6e63 6528 762c 2045 7863  sinstance(v, Exc
-00020de0: 6570 7469 6f6e 2920 656c 7365 2076 0a20  eption) else v. 
-00020df0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00020e00: 2c20 7620 696e 2077 6f72 6b65 725f 7374  , v in worker_st
-00020e10: 6174 6573 2e69 7465 6d73 2829 0a20 2020  ates.items().   
-00020e20: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00020e30: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
-00020e40: 2020 2020 2022 7363 6865 6475 6c65 7222       "scheduler"
-00020e50: 3a20 7363 6865 6475 6c65 725f 7374 6174  : scheduler_stat
-00020e60: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-00020e70: 776f 726b 6572 7322 3a20 776f 726b 6572  workers": worker
-00020e80: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
-00020e90: 2020 2020 2022 7665 7273 696f 6e73 223a       "versions":
-00020ea0: 207b 2273 6368 6564 756c 6572 223a 2073   {"scheduler": s
-00020eb0: 656c 662e 7665 7273 696f 6e73 2829 2c20  elf.versions(), 
-00020ec0: 2277 6f72 6b65 7273 223a 2077 6f72 6b65  "workers": worke
-00020ed0: 725f 7665 7273 696f 6e73 7d2c 0a20 2020  r_versions},.   
-00020ee0: 2020 2020 207d 0a0a 2020 2020 6173 796e       }..    asyn
-00020ef0: 6320 6465 6620 6475 6d70 5f63 6c75 7374  c def dump_clust
-00020f00: 6572 5f73 7461 7465 5f74 6f5f 7572 6c28  er_state_to_url(
-00020f10: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00020f20: 2020 2020 2020 2075 726c 3a20 7374 722c         url: str,
-00020f30: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
-00020f40: 3a20 2243 6f6c 6c65 6374 696f 6e5b 7374  : "Collection[st
-00020f50: 725d 222c 0a20 2020 2020 2020 2066 6f72  r]",.        for
-00020f60: 6d61 743a 204c 6974 6572 616c 5b22 6d73  mat: Literal["ms
-00020f70: 6770 6163 6b22 2c20 2279 616d 6c22 5d2c  gpack", "yaml"],
-00020f80: 0a20 2020 2020 2020 202a 2a73 746f 7261  .        **stora
-00020f90: 6765 5f6f 7074 696f 6e73 3a20 6469 6374  ge_options: dict
-00020fa0: 5b73 7472 2c20 416e 795d 2c0a 2020 2020  [str, Any],.    
-00020fb0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00020fc0: 2020 2022 5772 6974 6520 6120 636c 7573     "Write a clus
-00020fd0: 7465 7220 7374 6174 6520 6475 6d70 2074  ter state dump t
-00020fe0: 6f20 616e 2066 7373 7065 632d 636f 6d70  o an fsspec-comp
-00020ff0: 6174 6962 6c65 2055 524c 2e22 0a20 2020  atible URL.".   
-00021000: 2020 2020 2061 7761 6974 2063 6c75 7374       await clust
-00021010: 6572 5f64 756d 702e 7772 6974 655f 7374  er_dump.write_st
-00021020: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-00021030: 2070 6172 7469 616c 2873 656c 662e 6765   partial(self.ge
-00021040: 745f 636c 7573 7465 725f 7374 6174 652c  t_cluster_state,
-00021050: 2065 7863 6c75 6465 292c 2075 726c 2c20   exclude), url, 
-00021060: 666f 726d 6174 2c20 2a2a 7374 6f72 6167  format, **storag
-00021070: 655f 6f70 7469 6f6e 730a 2020 2020 2020  e_options.      
-00021080: 2020 290a 0a20 2020 2064 6566 2067 6574    )..    def get
-00021090: 5f77 6f72 6b65 725f 7365 7276 6963 655f  _worker_service_
-000210a0: 6164 6472 280a 2020 2020 2020 2020 7365  addr(.        se
-000210b0: 6c66 2c20 776f 726b 6572 3a20 7374 722c  lf, worker: str,
-000210c0: 2073 6572 7669 6365 5f6e 616d 653a 2073   service_name: s
-000210d0: 7472 2c20 7072 6f74 6f63 6f6c 3a20 626f  tr, protocol: bo
-000210e0: 6f6c 203d 2046 616c 7365 0a20 2020 2029  ol = False.    )
-000210f0: 202d 3e20 7475 706c 655b 7374 722c 2069   -> tuple[str, i
-00021100: 6e74 5d20 7c20 7374 7220 7c20 4e6f 6e65  nt] | str | None
-00021110: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00021120: 2020 2020 2020 4765 7420 7468 6520 2868        Get the (h
-00021130: 6f73 742c 2070 6f72 7429 2061 6464 7265  ost, port) addre
-00021140: 7373 206f 6620 7468 6520 6e61 6d65 6420  ss of the named 
-00021150: 7365 7276 6963 6520 6f6e 2074 6865 202a  service on the *
-00021160: 776f 726b 6572 2a2e 0a20 2020 2020 2020  worker*..       
-00021170: 2052 6574 7572 6e73 204e 6f6e 6520 6966   Returns None if
-00021180: 2074 6865 2073 6572 7669 6365 2064 6f65   the service doe
-00021190: 736e 2774 2065 7869 7374 2e0a 0a20 2020  sn't exist...   
-000211a0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-000211b0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-000211c0: 2d2d 0a20 2020 2020 2020 2077 6f72 6b65  --.        worke
-000211d0: 7220 3a20 6164 6472 6573 730a 2020 2020  r : address.    
-000211e0: 2020 2020 7365 7276 6963 655f 6e61 6d65      service_name
-000211f0: 203a 2073 7472 0a20 2020 2020 2020 2020   : str.         
-00021200: 2020 2043 6f6d 6d6f 6e20 7365 7276 6963     Common servic
-00021210: 6573 2069 6e63 6c75 6465 2027 626f 6b65  es include 'boke
-00021220: 6827 2061 6e64 2027 6e61 6e6e 7927 0a20  h' and 'nanny'. 
-00021230: 2020 2020 2020 2070 726f 746f 636f 6c20         protocol 
-00021240: 3a20 626f 6f6c 6561 6e0a 2020 2020 2020  : boolean.      
-00021250: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
-00021260: 206e 6f74 2074 6f20 696e 636c 7564 6520   not to include 
-00021270: 6120 6675 6c6c 2061 6464 7265 7373 2077  a full address w
-00021280: 6974 6820 7072 6f74 6f63 6f6c 2028 5472  ith protocol (Tr
-00021290: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-000212a0: 6f72 206a 7573 7420 6120 2868 6f73 742c  or just a (host,
-000212b0: 2070 6f72 7429 2070 6169 720a 2020 2020   port) pair.    
-000212c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000212d0: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
-000212e0: 735b 776f 726b 6572 5d0a 2020 2020 2020  s[worker].      
-000212f0: 2020 706f 7274 203d 2077 732e 7365 7276    port = ws.serv
-00021300: 6963 6573 2e67 6574 2873 6572 7669 6365  ices.get(service
-00021310: 5f6e 616d 6529 0a20 2020 2020 2020 2069  _name).        i
-00021320: 6620 706f 7274 2069 7320 4e6f 6e65 3a0a  f port is None:.
-00021330: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00021340: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
-00021350: 656c 6966 2070 726f 746f 636f 6c3a 0a20  elif protocol:. 
-00021360: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00021370: 6e20 2225 2870 726f 746f 636f 6c29 733a  n "%(protocol)s:
-00021380: 2f2f 2528 686f 7374 2973 3a25 2870 6f72  //%(host)s:%(por
-00021390: 7429 6422 2025 207b 0a20 2020 2020 2020  t)d" % {.       
-000213a0: 2020 2020 2020 2020 2022 7072 6f74 6f63           "protoc
-000213b0: 6f6c 223a 2077 732e 6164 6472 6573 732e  ol": ws.address.
-000213c0: 7370 6c69 7428 223a 2f2f 2229 5b30 5d2c  split("://")[0],
-000213d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000213e0: 2022 686f 7374 223a 2077 732e 686f 7374   "host": ws.host
-000213f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021400: 2020 2270 6f72 7422 3a20 706f 7274 2c0a    "port": port,.
-00021410: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00021420: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00021430: 2020 2020 2020 2020 7265 7475 726e 2077          return w
-00021440: 732e 686f 7374 2c20 706f 7274 0a0a 2020  s.host, port..  
-00021450: 2020 6173 796e 6320 6465 6620 7374 6172    async def star
-00021460: 745f 756e 7361 6665 2873 656c 6629 3a0a  t_unsafe(self):.
-00021470: 2020 2020 2020 2020 2222 2243 6c65 6172          """Clear
-00021480: 206f 7574 206f 6c64 2073 7461 7465 2061   out old state a
-00021490: 6e64 2072 6573 7461 7274 2061 6c6c 2072  nd restart all r
-000214a0: 756e 6e69 6e67 2063 6f72 6f75 7469 6e65  unning coroutine
-000214b0: 7322 2222 0a20 2020 2020 2020 2061 7761  s""".        awa
-000214c0: 6974 2073 7570 6572 2829 2e73 7461 7274  it super().start
-000214d0: 5f75 6e73 6166 6528 290a 0a20 2020 2020  _unsafe()..     
-000214e0: 2020 2065 6e61 626c 655f 6763 5f64 6961     enable_gc_dia
-000214f0: 676e 6f73 6973 2829 0a0a 2020 2020 2020  gnosis()..      
-00021500: 2020 7365 6c66 2e5f 636c 6561 725f 7461    self._clear_ta
-00021510: 736b 5f73 7461 7465 2829 0a0a 2020 2020  sk_state()..    
-00021520: 2020 2020 666f 7220 6164 6472 2069 6e20      for addr in 
-00021530: 7365 6c66 2e5f 7374 6172 745f 6164 6472  self._start_addr
-00021540: 6573 733a 0a20 2020 2020 2020 2020 2020  ess:.           
-00021550: 2061 7761 6974 2073 656c 662e 6c69 7374   await self.list
-00021560: 656e 280a 2020 2020 2020 2020 2020 2020  en(.            
-00021570: 2020 2020 6164 6472 2c0a 2020 2020 2020      addr,.      
-00021580: 2020 2020 2020 2020 2020 616c 6c6f 775f            allow_
-00021590: 6f66 666c 6f61 643d 4661 6c73 652c 0a20  offload=False,. 
-000215a0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-000215b0: 616e 6473 6861 6b65 5f6f 7665 7272 6964  andshake_overrid
-000215c0: 6573 3d7b 2270 6963 6b6c 652d 7072 6f74  es={"pickle-prot
-000215d0: 6f63 6f6c 223a 2034 2c20 2263 6f6d 7072  ocol": 4, "compr
-000215e0: 6573 7369 6f6e 223a 204e 6f6e 657d 2c0a  ession": None},.
-000215f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021600: 2a2a 7365 6c66 2e73 6563 7572 6974 792e  **self.security.
-00021610: 6765 745f 6c69 7374 656e 5f61 7267 7328  get_listen_args(
-00021620: 2273 6368 6564 756c 6572 2229 2c0a 2020  "scheduler"),.  
-00021630: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00021640: 2020 2020 2020 2020 7365 6c66 2e69 7020          self.ip 
-00021650: 3d20 6765 745f 6164 6472 6573 735f 686f  = get_address_ho
-00021660: 7374 2873 656c 662e 6c69 7374 656e 5f61  st(self.listen_a
-00021670: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
-00021680: 2020 2020 6c69 7374 656e 5f69 7020 3d20      listen_ip = 
-00021690: 7365 6c66 2e69 700a 0a20 2020 2020 2020  self.ip..       
-000216a0: 2020 2020 2069 6620 6c69 7374 656e 5f69       if listen_i
-000216b0: 7020 3d3d 2022 302e 302e 302e 3022 3a0a  p == "0.0.0.0":.
-000216c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000216d0: 6c69 7374 656e 5f69 7020 3d20 2222 0a0a  listen_ip = ""..
-000216e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000216f0: 6164 6472 6573 732e 7374 6172 7473 7769  address.startswi
-00021700: 7468 2822 696e 7072 6f63 3a2f 2f22 293a  th("inproc://"):
-00021710: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
-00021720: 7465 6e5f 6970 203d 2022 6c6f 6361 6c68  ten_ip = "localh
-00021730: 6f73 7422 0a0a 2020 2020 2020 2020 2320  ost"..        # 
-00021740: 5365 7276 6963 6573 206c 6973 7465 6e20  Services listen 
-00021750: 6f6e 2061 6c6c 2061 6464 7265 7373 6573  on all addresses
-00021760: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-00021770: 6172 745f 7365 7276 6963 6573 286c 6973  art_services(lis
-00021780: 7465 6e5f 6970 290a 0a20 2020 2020 2020  ten_ip)..       
-00021790: 2066 6f72 206c 6973 7465 6e65 7220 696e   for listener in
-000217a0: 2073 656c 662e 6c69 7374 656e 6572 733a   self.listeners:
-000217b0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-000217c0: 6765 722e 696e 666f 2822 2020 5363 6865  ger.info("  Sche
-000217d0: 6475 6c65 7220 6174 3a20 2532 3573 222c  duler at: %25s",
-000217e0: 206c 6973 7465 6e65 722e 636f 6e74 6163   listener.contac
-000217f0: 745f 6164 6472 6573 7329 0a20 2020 2020  t_address).     
-00021800: 2020 2066 6f72 206e 616d 652c 2073 6572     for name, ser
-00021810: 7665 7220 696e 2073 656c 662e 7365 7276  ver in self.serv
-00021820: 6963 6573 2e69 7465 6d73 2829 3a0a 2020  ices.items():.  
-00021830: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
-00021840: 6520 3d3d 2022 6461 7368 626f 6172 6422  e == "dashboard"
-00021850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021860: 2020 6164 6472 203d 2067 6574 5f61 6464    addr = get_add
-00021870: 7265 7373 5f68 6f73 7428 6c69 7374 656e  ress_host(listen
-00021880: 6572 2e63 6f6e 7461 6374 5f61 6464 7265  er.contact_addre
-00021890: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
-000218a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000218b0: 2020 2020 2020 2020 2020 2020 206c 696e               lin
-000218c0: 6b20 3d20 666f 726d 6174 5f64 6173 6862  k = format_dashb
-000218d0: 6f61 7264 5f6c 696e 6b28 6164 6472 2c20  oard_link(addr, 
-000218e0: 7365 7276 6572 2e70 6f72 7429 0a20 2020  server.port).   
-000218f0: 2020 2020 2020 2020 2020 2020 2023 2066               # f
-00021900: 6f72 6d61 7474 696e 6720 6461 7368 626f  ormatting dashbo
-00021910: 6172 6420 6c69 6e6b 2063 616e 2066 6169  ard link can fai
-00021920: 6c20 6966 2064 6973 7472 6962 7574 6564  l if distributed
-00021930: 2e64 6173 6862 6f61 7264 2e6c 696e 6b0a  .dashboard.link.
-00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021950: 2320 7265 6665 7273 2074 6f20 6e6f 6e2d  # refers to non-
-00021960: 6578 6973 7461 6e74 2065 6e76 2076 6172  existant env var
-00021970: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
-00021980: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-00021990: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-000219a0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000219b0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-000219c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219d0: 2020 2020 2066 2246 6169 6c65 6420 746f       f"Failed to
-000219e0: 2066 6f72 6d61 7420 6461 7368 626f 6172   format dashboar
-000219f0: 6420 6c69 6e6b 2c20 756e 6b6e 6f77 6e20  d link, unknown 
-00021a00: 7661 6c75 653a 207b 657d 220a 2020 2020  value: {e}".    
-00021a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00021a30: 2020 2020 2020 6c69 6e6b 203d 2066 223a        link = f":
-00021a40: 7b73 6572 7665 722e 706f 7274 7d22 0a20  {server.port}". 
-00021a50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00021a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021a70: 206c 696e 6b20 3d20 6622 7b6c 6973 7465   link = f"{liste
-00021a80: 6e5f 6970 7d3a 7b73 6572 7665 722e 706f  n_ip}:{server.po
-00021a90: 7274 7d22 0a20 2020 2020 2020 2020 2020  rt}".           
-00021aa0: 206c 6f67 6765 722e 696e 666f 2822 2531   logger.info("%1
-00021ab0: 3173 2061 743a 2020 2532 3573 222c 206e  1s at:  %25s", n
-00021ac0: 616d 652c 206c 696e 6b29 0a0a 2020 2020  ame, link)..    
-00021ad0: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
-00021ae0: 6475 6c65 725f 6669 6c65 3a0a 2020 2020  duler_file:.    
-00021af0: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
-00021b00: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
-00021b10: 5f66 696c 652c 2022 7722 2920 6173 2066  _file, "w") as f
-00021b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021b30: 2020 6a73 6f6e 2e64 756d 7028 7365 6c66    json.dump(self
-00021b40: 2e69 6465 6e74 6974 7928 292c 2066 2c20  .identity(), f, 
-00021b50: 696e 6465 6e74 3d32 290a 0a20 2020 2020  indent=2)..     
-00021b60: 2020 2020 2020 2066 6e20 3d20 7365 6c66         fn = self
-00021b70: 2e73 6368 6564 756c 6572 5f66 696c 6520  .scheduler_file 
-00021b80: 2023 2072 656d 6f76 6520 6669 6c65 2077   # remove file w
-00021b90: 6865 6e20 7765 2063 6c6f 7365 2074 6865  hen we close the
-00021ba0: 2070 726f 6365 7373 0a0a 2020 2020 2020   process..      
-00021bb0: 2020 2020 2020 6465 6620 6465 6c5f 7363        def del_sc
-00021bc0: 6865 6475 6c65 725f 6669 6c65 2829 3a0a  heduler_file():.
+0001e710: 2020 2020 2020 2022 6261 7365 5f75 726c         "base_url
+0001e720: 223a 2022 6a75 7079 7465 7222 2c0a 2020  ": "jupyter",.  
+0001e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e740: 2020 2020 2020 2020 2020 2320 5345 4355            # SECU
+0001e750: 5249 5459 3a20 5765 2075 7375 616c 6c79  RITY: We usually
+0001e760: 2065 7870 6563 7420 7468 6520 6461 7368   expect the dash
+0001e770: 626f 6172 6420 746f 2062 6520 6120 7265  board to be a re
+0001e780: 6164 2d6f 6e6c 7920 7669 6577 2069 6e74  ad-only view int
+0001e790: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
+0001e7a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001e7b0: 7468 6520 7363 6865 6475 6c65 7220 6163  the scheduler ac
+0001e7c0: 7469 7669 7479 2e20 486f 7765 7665 722c  tivity. However,
+0001e7d0: 2062 7920 6164 6469 6e67 2061 6e20 6f70   by adding an op
+0001e7e0: 656e 204a 7570 7974 6572 2061 7070 6c69  en Jupyter appli
+0001e7f0: 6361 7469 6f6e 0a20 2020 2020 2020 2020  cation.         
+0001e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e810: 2020 2023 2077 6520 6172 6520 616c 6c6f     # we are allo
+0001e820: 7769 6e67 2061 7262 6974 7261 7279 2072  wing arbitrary r
+0001e830: 656d 6f74 6520 636f 6465 2065 7865 6375  emote code execu
+0001e840: 7469 6f6e 206f 6e20 7468 6520 7363 6865  tion on the sche
+0001e850: 6475 6c65 7220 7669 6120 7468 650a 2020  duler via the.  
+0001e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e870: 2020 2020 2020 2020 2020 2320 6461 7368            # dash
+0001e880: 626f 6172 6420 7365 7276 6572 2e20 5468  board server. Th
+0001e890: 6973 206f 7074 696f 6e20 7368 6f75 6c64  is option should
+0001e8a0: 206f 6e6c 7920 6265 2075 7365 6420 7768   only be used wh
+0001e8b0: 656e 2074 6865 2064 6173 6862 6f61 7264  en the dashboard
+0001e8c0: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+0001e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8e0: 2320 7072 6f74 6563 7465 6420 7669 6120  # protected via 
+0001e8f0: 6f74 6865 7220 6d65 616e 732c 206f 7220  other means, or 
+0001e900: 7768 656e 2079 6f75 2064 6f6e 2774 2063  when you don't c
+0001e910: 6172 6520 6162 6f75 7420 636c 7573 7465  are about cluste
+0001e920: 7220 7365 6375 7269 7479 2e0a 2020 2020  r security..    
+0001e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e940: 2020 2020 2020 2020 2274 6f6b 656e 223a          "token":
+0001e950: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
+0001e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e970: 2022 616c 6c6f 775f 7265 6d6f 7465 5f61   "allow_remote_a
+0001e980: 6363 6573 7322 3a20 5472 7565 2c0a 2020  ccess": True,.  
+0001e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0001e9b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0001e9c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001e9d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001e9e0: 2020 2020 2020 2020 2020 6a2e 696e 6974            j.init
+0001e9f0: 6961 6c69 7a65 280a 2020 2020 2020 2020  ialize(.        
+0001ea00: 2020 2020 2020 2020 6e65 775f 6874 7470          new_http
+0001ea10: 7365 7276 6572 3d46 616c 7365 2c0a 2020  server=False,.  
+0001ea20: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0001ea30: 6776 3d5b 5d2c 0a20 2020 2020 2020 2020  gv=[],.         
+0001ea40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001ea50: 2073 656c 662e 5f6a 7570 7974 6572 5f73   self._jupyter_s
+0001ea60: 6572 7665 725f 6170 706c 6963 6174 696f  erver_applicatio
+0001ea70: 6e20 3d20 6a0a 2020 2020 2020 2020 2020  n = j.          
+0001ea80: 2020 7365 6c66 2e68 7474 705f 6170 706c    self.http_appl
+0001ea90: 6963 6174 696f 6e2e 6164 645f 6170 706c  ication.add_appl
+0001eaa0: 6963 6174 696f 6e28 6a2e 7765 625f 6170  ication(j.web_ap
+0001eab0: 7029 0a0a 2020 2020 2020 2020 2320 436f  p)..        # Co
+0001eac0: 6d6d 756e 6963 6174 696f 6e20 7374 6174  mmunication stat
+0001ead0: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
+0001eae0: 6c69 656e 745f 636f 6d6d 7320 3d20 7b7d  lient_comms = {}
+0001eaf0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+0001eb00: 7265 616d 5f63 6f6d 6d73 203d 207b 7d0a  ream_comms = {}.
+0001eb10: 0a20 2020 2020 2020 2023 2054 6173 6b20  .        # Task 
+0001eb20: 7374 6174 650a 2020 2020 2020 2020 7461  state.        ta
+0001eb30: 736b 7320 3d20 7b7d 0a0a 2020 2020 2020  sks = {}..      
+0001eb40: 2020 7365 6c66 2e67 656e 6572 6174 696f    self.generatio
+0001eb50: 6e20 3d20 300a 2020 2020 2020 2020 7365  n = 0.        se
+0001eb60: 6c66 2e5f 6c61 7374 5f63 6c69 656e 7420  lf._last_client 
+0001eb70: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0001eb80: 656c 662e 5f6c 6173 745f 7469 6d65 203d  elf._last_time =
+0001eb90: 2030 0a20 2020 2020 2020 2075 6e72 756e   0.        unrun
+0001eba0: 6e61 626c 6520 3d20 7365 7428 290a 2020  nable = set().  
+0001ebb0: 2020 2020 2020 7175 6575 6564 3a20 4865        queued: He
+0001ebc0: 6170 5365 745b 5461 736b 5374 6174 655d  apSet[TaskState]
+0001ebd0: 203d 2048 6561 7053 6574 286b 6579 3d6f   = HeapSet(key=o
+0001ebe0: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+0001ebf0: 6572 2822 7072 696f 7269 7479 2229 290a  er("priority")).
+0001ec00: 0a20 2020 2020 2020 2073 656c 662e 6461  .        self.da
+0001ec10: 7461 7365 7473 203d 207b 7d0a 0a20 2020  tasets = {}..   
+0001ec20: 2020 2020 2023 2050 7265 6669 782d 6b65       # Prefix-ke
+0001ec30: 7965 6420 636f 6e74 6169 6e65 7273 0a0a  yed containers..
+0001ec40: 2020 2020 2020 2020 2320 436c 6965 6e74          # Client
+0001ec50: 2073 7461 7465 0a20 2020 2020 2020 2063   state.        c
+0001ec60: 6c69 656e 7473 203d 207b 7d0a 0a20 2020  lients = {}..   
+0001ec70: 2020 2020 2023 2057 6f72 6b65 7220 7374       # Worker st
+0001ec80: 6174 650a 2020 2020 2020 2020 776f 726b  ate.        work
+0001ec90: 6572 7320 3d20 536f 7274 6564 4469 6374  ers = SortedDict
+0001eca0: 2829 0a0a 2020 2020 2020 2020 686f 7374  ()..        host
+0001ecb0: 5f69 6e66 6f20 3d20 7b7d 0a20 2020 2020  _info = {}.     
+0001ecc0: 2020 2072 6573 6f75 7263 6573 203d 207b     resources = {
+0001ecd0: 7d0a 2020 2020 2020 2020 616c 6961 7365  }.        aliase
+0001ece0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+0001ecf0: 7365 6c66 2e5f 776f 726b 6572 5f63 6f6c  self._worker_col
+0001ed00: 6c65 6374 696f 6e73 203d 205b 0a20 2020  lections = [.   
+0001ed10: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+0001ed20: 2c0a 2020 2020 2020 2020 2020 2020 686f  ,.            ho
+0001ed30: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
+0001ed40: 2020 2020 2072 6573 6f75 7263 6573 2c0a       resources,.
+0001ed50: 2020 2020 2020 2020 2020 2020 616c 6961              alia
+0001ed60: 7365 732c 0a20 2020 2020 2020 205d 0a0a  ses,.        ]..
+0001ed70: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+0001ed80: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
+0001ed90: 7428 0a20 2020 2020 2020 2020 2020 2070  t(.            p
+0001eda0: 6172 7469 616c 280a 2020 2020 2020 2020  artial(.        
+0001edb0: 2020 2020 2020 2020 6465 7175 652c 206d          deque, m
+0001edc0: 6178 6c65 6e3d 6461 736b 2e63 6f6e 6669  axlen=dask.confi
+0001edd0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+0001ede0: 6564 2e73 6368 6564 756c 6572 2e65 7665  ed.scheduler.eve
+0001edf0: 6e74 732d 6c6f 672d 6c65 6e67 7468 2229  nts-log-length")
+0001ee00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001ee10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001ee20: 2073 656c 662e 6576 656e 745f 636f 756e   self.event_coun
+0001ee30: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
+0001ee40: 2869 6e74 290a 2020 2020 2020 2020 7365  (int).        se
+0001ee50: 6c66 2e65 7665 6e74 5f73 7562 7363 7269  lf.event_subscri
+0001ee60: 6265 7220 3d20 6465 6661 756c 7464 6963  ber = defaultdic
+0001ee70: 7428 7365 7429 0a20 2020 2020 2020 2073  t(set).        s
+0001ee80: 656c 662e 776f 726b 6572 5f70 6c75 6769  elf.worker_plugi
+0001ee90: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
+0001eea0: 7365 6c66 2e6e 616e 6e79 5f70 6c75 6769  self.nanny_plugi
+0001eeb0: 6e73 203d 207b 7d0a 0a20 2020 2020 2020  ns = {}..       
+0001eec0: 2077 6f72 6b65 725f 6861 6e64 6c65 7273   worker_handlers
+0001eed0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001eee0: 2022 7461 736b 2d66 696e 6973 6865 6422   "task-finished"
+0001eef0: 3a20 7365 6c66 2e68 616e 646c 655f 7461  : self.handle_ta
+0001ef00: 736b 5f66 696e 6973 6865 642c 0a20 2020  sk_finished,.   
+0001ef10: 2020 2020 2020 2020 2022 7461 736b 2d65           "task-e
+0001ef20: 7272 6564 223a 2073 656c 662e 6861 6e64  rred": self.hand
+0001ef30: 6c65 5f74 6173 6b5f 6572 7265 642c 0a20  le_task_erred,. 
+0001ef40: 2020 2020 2020 2020 2020 2022 7265 6c65             "rele
+0001ef50: 6173 652d 776f 726b 6572 2d64 6174 6122  ase-worker-data"
+0001ef60: 3a20 7365 6c66 2e72 656c 6561 7365 5f77  : self.release_w
+0001ef70: 6f72 6b65 725f 6461 7461 2c0a 2020 2020  orker_data,.    
+0001ef80: 2020 2020 2020 2020 2261 6464 2d6b 6579          "add-key
+0001ef90: 7322 3a20 7365 6c66 2e61 6464 5f6b 6579  s": self.add_key
+0001efa0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0001efb0: 6c6f 6e67 2d72 756e 6e69 6e67 223a 2073  long-running": s
+0001efc0: 656c 662e 6861 6e64 6c65 5f6c 6f6e 675f  elf.handle_long_
+0001efd0: 7275 6e6e 696e 672c 0a20 2020 2020 2020  running,.       
+0001efe0: 2020 2020 2022 7265 7363 6865 6475 6c65       "reschedule
+0001eff0: 223a 2073 656c 662e 5f72 6573 6368 6564  ": self._resched
+0001f000: 756c 652c 0a20 2020 2020 2020 2020 2020  ule,.           
+0001f010: 2022 6b65 6570 2d61 6c69 7665 223a 206c   "keep-alive": l
+0001f020: 616d 6264 6120 2a61 7267 732c 202a 2a6b  ambda *args, **k
+0001f030: 7761 7267 733a 204e 6f6e 652c 0a20 2020  wargs: None,.   
+0001f040: 2020 2020 2020 2020 2022 6c6f 672d 6576           "log-ev
+0001f050: 656e 7422 3a20 7365 6c66 2e6c 6f67 5f77  ent": self.log_w
+0001f060: 6f72 6b65 725f 6576 656e 742c 0a20 2020  orker_event,.   
+0001f070: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
+0001f080: 2d73 7461 7475 732d 6368 616e 6765 223a  -status-change":
+0001f090: 2073 656c 662e 6861 6e64 6c65 5f77 6f72   self.handle_wor
+0001f0a0: 6b65 725f 7374 6174 7573 5f63 6861 6e67  ker_status_chang
+0001f0b0: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+0001f0c0: 7265 7175 6573 742d 7265 6672 6573 682d  request-refresh-
+0001f0d0: 7768 6f2d 6861 7322 3a20 7365 6c66 2e68  who-has": self.h
+0001f0e0: 616e 646c 655f 7265 7175 6573 745f 7265  andle_request_re
+0001f0f0: 6672 6573 685f 7768 6f5f 6861 732c 0a20  fresh_who_has,. 
+0001f100: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0001f110: 2020 636c 6965 6e74 5f68 616e 646c 6572    client_handler
+0001f120: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+0001f130: 2020 2275 7064 6174 652d 6772 6170 6822    "update-graph"
+0001f140: 3a20 7365 6c66 2e75 7064 6174 655f 6772  : self.update_gr
+0001f150: 6170 682c 0a20 2020 2020 2020 2020 2020  aph,.           
+0001f160: 2022 636c 6965 6e74 2d64 6573 6972 6573   "client-desires
+0001f170: 2d6b 6579 7322 3a20 7365 6c66 2e63 6c69  -keys": self.cli
+0001f180: 656e 745f 6465 7369 7265 735f 6b65 7973  ent_desires_keys
+0001f190: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+0001f1a0: 7064 6174 652d 6461 7461 223a 2073 656c  pdate-data": sel
+0001f1b0: 662e 7570 6461 7465 5f64 6174 612c 0a20  f.update_data,. 
+0001f1c0: 2020 2020 2020 2020 2020 2022 7265 706f             "repo
+0001f1d0: 7274 2d6b 6579 223a 2073 656c 662e 7265  rt-key": self.re
+0001f1e0: 706f 7274 5f6f 6e5f 6b65 792c 0a20 2020  port_on_key,.   
+0001f1f0: 2020 2020 2020 2020 2022 636c 6965 6e74           "client
+0001f200: 2d72 656c 6561 7365 732d 6b65 7973 223a  -releases-keys":
+0001f210: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
+0001f220: 6561 7365 735f 6b65 7973 2c0a 2020 2020  eases_keys,.    
+0001f230: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
+0001f240: 6174 2d63 6c69 656e 7422 3a20 7365 6c66  at-client": self
+0001f250: 2e63 6c69 656e 745f 6865 6172 7462 6561  .client_heartbea
+0001f260: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
+0001f270: 636c 6f73 652d 636c 6965 6e74 223a 2073  close-client": s
+0001f280: 656c 662e 7265 6d6f 7665 5f63 6c69 656e  elf.remove_clien
+0001f290: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
+0001f2a0: 7375 6273 6372 6962 652d 746f 7069 6322  subscribe-topic"
+0001f2b0: 3a20 7365 6c66 2e73 7562 7363 7269 6265  : self.subscribe
+0001f2c0: 5f74 6f70 6963 2c0a 2020 2020 2020 2020  _topic,.        
+0001f2d0: 2020 2020 2275 6e73 7562 7363 7269 6265      "unsubscribe
+0001f2e0: 2d74 6f70 6963 223a 2073 656c 662e 756e  -topic": self.un
+0001f2f0: 7375 6273 6372 6962 655f 746f 7069 632c  subscribe_topic,
+0001f300: 0a20 2020 2020 2020 2020 2020 2022 6361  .            "ca
+0001f310: 6e63 656c 2d6b 6579 7322 3a20 7365 6c66  ncel-keys": self
+0001f320: 2e73 7469 6d75 6c75 735f 6361 6e63 656c  .stimulus_cancel
+0001f330: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+0001f340: 2020 2020 2073 656c 662e 6861 6e64 6c65       self.handle
+0001f350: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
+0001f360: 2020 2022 7265 6769 7374 6572 2d63 6c69     "register-cli
+0001f370: 656e 7422 3a20 7365 6c66 2e61 6464 5f63  ent": self.add_c
+0001f380: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+0001f390: 2020 2022 7363 6174 7465 7222 3a20 7365     "scatter": se
+0001f3a0: 6c66 2e73 6361 7474 6572 2c0a 2020 2020  lf.scatter,.    
+0001f3b0: 2020 2020 2020 2020 2272 6567 6973 7465          "registe
+0001f3c0: 722d 776f 726b 6572 223a 2073 656c 662e  r-worker": self.
+0001f3d0: 6164 645f 776f 726b 6572 2c0a 2020 2020  add_worker,.    
+0001f3e0: 2020 2020 2020 2020 2272 6567 6973 7465          "registe
+0001f3f0: 725f 6e61 6e6e 7922 3a20 7365 6c66 2e61  r_nanny": self.a
+0001f400: 6464 5f6e 616e 6e79 2c0a 2020 2020 2020  dd_nanny,.      
+0001f410: 2020 2020 2020 2275 6e72 6567 6973 7465        "unregiste
+0001f420: 7222 3a20 7365 6c66 2e72 656d 6f76 655f  r": self.remove_
+0001f430: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
+0001f440: 2020 2020 2267 6174 6865 7222 3a20 7365      "gather": se
+0001f450: 6c66 2e67 6174 6865 722c 0a20 2020 2020  lf.gather,.     
+0001f460: 2020 2020 2020 2022 7265 7472 7922 3a20         "retry": 
+0001f470: 7365 6c66 2e73 7469 6d75 6c75 735f 7265  self.stimulus_re
+0001f480: 7472 792c 0a20 2020 2020 2020 2020 2020  try,.           
+0001f490: 2022 6665 6564 223a 2073 656c 662e 6665   "feed": self.fe
+0001f4a0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+0001f4b0: 2274 6572 6d69 6e61 7465 223a 2073 656c  "terminate": sel
+0001f4c0: 662e 636c 6f73 652c 0a20 2020 2020 2020  f.close,.       
+0001f4d0: 2020 2020 2022 6272 6f61 6463 6173 7422       "broadcast"
+0001f4e0: 3a20 7365 6c66 2e62 726f 6164 6361 7374  : self.broadcast
+0001f4f0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0001f500: 726f 7879 223a 2073 656c 662e 7072 6f78  roxy": self.prox
+0001f510: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+0001f520: 6e63 6f72 6573 223a 2073 656c 662e 6765  ncores": self.ge
+0001f530: 745f 6e63 6f72 6573 2c0a 2020 2020 2020  t_ncores,.      
+0001f540: 2020 2020 2020 226e 636f 7265 735f 7275        "ncores_ru
+0001f550: 6e6e 696e 6722 3a20 7365 6c66 2e67 6574  nning": self.get
+0001f560: 5f6e 636f 7265 735f 7275 6e6e 696e 672c  _ncores_running,
+0001f570: 0a20 2020 2020 2020 2020 2020 2022 6861  .            "ha
+0001f580: 735f 7768 6174 223a 2073 656c 662e 6765  s_what": self.ge
+0001f590: 745f 6861 735f 7768 6174 2c0a 2020 2020  t_has_what,.    
+0001f5a0: 2020 2020 2020 2020 2277 686f 5f68 6173          "who_has
+0001f5b0: 223a 2073 656c 662e 6765 745f 7768 6f5f  ": self.get_who_
+0001f5c0: 6861 732c 0a20 2020 2020 2020 2020 2020  has,.           
+0001f5d0: 2022 7072 6f63 6573 7369 6e67 223a 2073   "processing": s
+0001f5e0: 656c 662e 6765 745f 7072 6f63 6573 7369  elf.get_processi
+0001f5f0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+0001f600: 2263 616c 6c5f 7374 6163 6b22 3a20 7365  "call_stack": se
+0001f610: 6c66 2e67 6574 5f63 616c 6c5f 7374 6163  lf.get_call_stac
+0001f620: 6b2c 0a20 2020 2020 2020 2020 2020 2022  k,.            "
+0001f630: 7072 6f66 696c 6522 3a20 7365 6c66 2e67  profile": self.g
+0001f640: 6574 5f70 726f 6669 6c65 2c0a 2020 2020  et_profile,.    
+0001f650: 2020 2020 2020 2020 2270 6572 666f 726d          "perform
+0001f660: 616e 6365 5f72 6570 6f72 7422 3a20 7365  ance_report": se
+0001f670: 6c66 2e70 6572 666f 726d 616e 6365 5f72  lf.performance_r
+0001f680: 6570 6f72 742c 0a20 2020 2020 2020 2020  eport,.         
+0001f690: 2020 2022 6765 745f 6c6f 6773 223a 2073     "get_logs": s
+0001f6a0: 656c 662e 6765 745f 6c6f 6773 2c0a 2020  elf.get_logs,.  
+0001f6b0: 2020 2020 2020 2020 2020 226c 6f67 7322            "logs"
+0001f6c0: 3a20 7365 6c66 2e67 6574 5f6c 6f67 732c  : self.get_logs,
+0001f6d0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
+0001f6e0: 726b 6572 5f6c 6f67 7322 3a20 7365 6c66  rker_logs": self
+0001f6f0: 2e67 6574 5f77 6f72 6b65 725f 6c6f 6773  .get_worker_logs
+0001f700: 2c0a 2020 2020 2020 2020 2020 2020 226c  ,.            "l
+0001f710: 6f67 5f65 7665 6e74 223a 2073 656c 662e  og_event": self.
+0001f720: 6c6f 675f 6576 656e 742c 0a20 2020 2020  log_event,.     
+0001f730: 2020 2020 2020 2022 6576 656e 7473 223a         "events":
+0001f740: 2073 656c 662e 6765 745f 6576 656e 7473   self.get_events
+0001f750: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
+0001f760: 6279 7465 7322 3a20 7365 6c66 2e67 6574  bytes": self.get
+0001f770: 5f6e 6279 7465 732c 0a20 2020 2020 2020  _nbytes,.       
+0001f780: 2020 2020 2022 7665 7273 696f 6e73 223a       "versions":
+0001f790: 2073 656c 662e 7665 7273 696f 6e73 2c0a   self.versions,.
+0001f7a0: 2020 2020 2020 2020 2020 2020 2261 6464              "add
+0001f7b0: 5f6b 6579 7322 3a20 7365 6c66 2e61 6464  _keys": self.add
+0001f7c0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+0001f7d0: 2020 2022 7265 6261 6c61 6e63 6522 3a20     "rebalance": 
+0001f7e0: 7365 6c66 2e72 6562 616c 616e 6365 2c0a  self.rebalance,.
+0001f7f0: 2020 2020 2020 2020 2020 2020 2272 6570              "rep
+0001f800: 6c69 6361 7465 223a 2073 656c 662e 7265  licate": self.re
+0001f810: 706c 6963 6174 652c 0a20 2020 2020 2020  plicate,.       
+0001f820: 2020 2020 2022 7275 6e5f 6675 6e63 7469       "run_functi
+0001f830: 6f6e 223a 2073 656c 662e 7275 6e5f 6675  on": self.run_fu
+0001f840: 6e63 7469 6f6e 2c0a 2020 2020 2020 2020  nction,.        
+0001f850: 2020 2020 2272 6573 7461 7274 223a 2073      "restart": s
+0001f860: 656c 662e 7265 7374 6172 742c 0a20 2020  elf.restart,.   
+0001f870: 2020 2020 2020 2020 2022 7570 6461 7465           "update
+0001f880: 5f64 6174 6122 3a20 7365 6c66 2e75 7064  _data": self.upd
+0001f890: 6174 655f 6461 7461 2c0a 2020 2020 2020  ate_data,.      
+0001f8a0: 2020 2020 2020 2273 6574 5f72 6573 6f75        "set_resou
+0001f8b0: 7263 6573 223a 2073 656c 662e 6164 645f  rces": self.add_
+0001f8c0: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
+0001f8d0: 2020 2020 2020 2022 7265 7469 7265 5f77         "retire_w
+0001f8e0: 6f72 6b65 7273 223a 2073 656c 662e 7265  orkers": self.re
+0001f8f0: 7469 7265 5f77 6f72 6b65 7273 2c0a 2020  tire_workers,.  
+0001f900: 2020 2020 2020 2020 2020 2267 6574 5f6d            "get_m
+0001f910: 6574 6164 6174 6122 3a20 7365 6c66 2e67  etadata": self.g
+0001f920: 6574 5f6d 6574 6164 6174 612c 0a20 2020  et_metadata,.   
+0001f930: 2020 2020 2020 2020 2022 7365 745f 6d65           "set_me
+0001f940: 7461 6461 7461 223a 2073 656c 662e 7365  tadata": self.se
+0001f950: 745f 6d65 7461 6461 7461 2c0a 2020 2020  t_metadata,.    
+0001f960: 2020 2020 2020 2020 2273 6574 5f72 6573          "set_res
+0001f970: 7472 6963 7469 6f6e 7322 3a20 7365 6c66  trictions": self
+0001f980: 2e73 6574 5f72 6573 7472 6963 7469 6f6e  .set_restriction
+0001f990: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0001f9a0: 6865 6172 7462 6561 745f 776f 726b 6572  heartbeat_worker
+0001f9b0: 223a 2073 656c 662e 6865 6172 7462 6561  ": self.heartbea
+0001f9c0: 745f 776f 726b 6572 2c0a 2020 2020 2020  t_worker,.      
+0001f9d0: 2020 2020 2020 2267 6574 5f74 6173 6b5f        "get_task_
+0001f9e0: 7374 6174 7573 223a 2073 656c 662e 6765  status": self.ge
+0001f9f0: 745f 7461 736b 5f73 7461 7475 732c 0a20  t_task_status,. 
+0001fa00: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+0001fa10: 7461 736b 5f73 7472 6561 6d22 3a20 7365  task_stream": se
+0001fa20: 6c66 2e67 6574 5f74 6173 6b5f 7374 7265  lf.get_task_stre
+0001fa30: 616d 2c0a 2020 2020 2020 2020 2020 2020  am,.            
+0001fa40: 2267 6574 5f74 6173 6b5f 7072 6566 6978  "get_task_prefix
+0001fa50: 5f73 7461 7465 7322 3a20 7365 6c66 2e67  _states": self.g
+0001fa60: 6574 5f74 6173 6b5f 7072 6566 6978 5f73  et_task_prefix_s
+0001fa70: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+0001fa80: 2020 2022 7265 6769 7374 6572 5f73 6368     "register_sch
+0001fa90: 6564 756c 6572 5f70 6c75 6769 6e22 3a20  eduler_plugin": 
+0001faa0: 7365 6c66 2e72 6567 6973 7465 725f 7363  self.register_sc
+0001fab0: 6865 6475 6c65 725f 706c 7567 696e 2c0a  heduler_plugin,.
+0001fac0: 2020 2020 2020 2020 2020 2020 2272 6567              "reg
+0001fad0: 6973 7465 725f 776f 726b 6572 5f70 6c75  ister_worker_plu
+0001fae0: 6769 6e22 3a20 7365 6c66 2e72 6567 6973  gin": self.regis
+0001faf0: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
+0001fb00: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
+0001fb10: 756e 7265 6769 7374 6572 5f77 6f72 6b65  unregister_worke
+0001fb20: 725f 706c 7567 696e 223a 2073 656c 662e  r_plugin": self.
+0001fb30: 756e 7265 6769 7374 6572 5f77 6f72 6b65  unregister_worke
+0001fb40: 725f 706c 7567 696e 2c0a 2020 2020 2020  r_plugin,.      
+0001fb50: 2020 2020 2020 2272 6567 6973 7465 725f        "register_
+0001fb60: 6e61 6e6e 795f 706c 7567 696e 223a 2073  nanny_plugin": s
+0001fb70: 656c 662e 7265 6769 7374 6572 5f6e 616e  elf.register_nan
+0001fb80: 6e79 5f70 6c75 6769 6e2c 0a20 2020 2020  ny_plugin,.     
+0001fb90: 2020 2020 2020 2022 756e 7265 6769 7374         "unregist
+0001fba0: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e22  er_nanny_plugin"
+0001fbb0: 3a20 7365 6c66 2e75 6e72 6567 6973 7465  : self.unregiste
+0001fbc0: 725f 6e61 6e6e 795f 706c 7567 696e 2c0a  r_nanny_plugin,.
+0001fbd0: 2020 2020 2020 2020 2020 2020 2261 6461              "ada
+0001fbe0: 7074 6976 655f 7461 7267 6574 223a 2073  ptive_target": s
+0001fbf0: 656c 662e 6164 6170 7469 7665 5f74 6172  elf.adaptive_tar
+0001fc00: 6765 742c 0a20 2020 2020 2020 2020 2020  get,.           
+0001fc10: 2022 776f 726b 6572 735f 746f 5f63 6c6f   "workers_to_clo
+0001fc20: 7365 223a 2073 656c 662e 776f 726b 6572  se": self.worker
+0001fc30: 735f 746f 5f63 6c6f 7365 2c0a 2020 2020  s_to_close,.    
+0001fc40: 2020 2020 2020 2020 2273 7562 7363 7269          "subscri
+0001fc50: 6265 5f77 6f72 6b65 725f 7374 6174 7573  be_worker_status
+0001fc60: 223a 2073 656c 662e 7375 6273 6372 6962  ": self.subscrib
+0001fc70: 655f 776f 726b 6572 5f73 7461 7475 732c  e_worker_status,
+0001fc80: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0001fc90: 6172 745f 7461 736b 5f6d 6574 6164 6174  art_task_metadat
+0001fca0: 6122 3a20 7365 6c66 2e73 7461 7274 5f74  a": self.start_t
+0001fcb0: 6173 6b5f 6d65 7461 6461 7461 2c0a 2020  ask_metadata,.  
+0001fcc0: 2020 2020 2020 2020 2020 2273 746f 705f            "stop_
+0001fcd0: 7461 736b 5f6d 6574 6164 6174 6122 3a20  task_metadata": 
+0001fce0: 7365 6c66 2e73 746f 705f 7461 736b 5f6d  self.stop_task_m
+0001fcf0: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
+0001fd00: 2020 2020 2022 6765 745f 636c 7573 7465       "get_cluste
+0001fd10: 725f 7374 6174 6522 3a20 7365 6c66 2e67  r_state": self.g
+0001fd20: 6574 5f63 6c75 7374 6572 5f73 7461 7465  et_cluster_state
+0001fd30: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
+0001fd40: 756d 705f 636c 7573 7465 725f 7374 6174  ump_cluster_stat
+0001fd50: 655f 746f 5f75 726c 223a 2073 656c 662e  e_to_url": self.
+0001fd60: 6475 6d70 5f63 6c75 7374 6572 5f73 7461  dump_cluster_sta
+0001fd70: 7465 5f74 6f5f 7572 6c2c 0a20 2020 2020  te_to_url,.     
+0001fd80: 2020 2020 2020 2022 6265 6e63 686d 6172         "benchmar
+0001fd90: 6b5f 6861 7264 7761 7265 223a 2073 656c  k_hardware": sel
+0001fda0: 662e 6265 6e63 686d 6172 6b5f 6861 7264  f.benchmark_hard
+0001fdb0: 7761 7265 2c0a 2020 2020 2020 2020 2020  ware,.          
+0001fdc0: 2020 2267 6574 5f73 746f 7279 223a 2073    "get_story": s
+0001fdd0: 656c 662e 6765 745f 7374 6f72 792c 0a20  elf.get_story,. 
+0001fde0: 2020 2020 2020 2020 2020 2022 6368 6563             "chec
+0001fdf0: 6b5f 6964 6c65 223a 2073 656c 662e 6368  k_idle": self.ch
+0001fe00: 6563 6b5f 6964 6c65 2c0a 2020 2020 2020  eck_idle,.      
+0001fe10: 2020 7d0a 0a20 2020 2020 2020 2063 6f6e    }..        con
+0001fe20: 6e65 6374 696f 6e5f 6c69 6d69 7420 3d20  nection_limit = 
+0001fe30: 6765 745f 6669 6c65 6e6f 5f6c 696d 6974  get_fileno_limit
+0001fe40: 2829 202f 2032 0a0a 2020 2020 2020 2020  () / 2..        
+0001fe50: 5363 6865 6475 6c65 7253 7461 7465 2e5f  SchedulerState._
+0001fe60: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+0001fe70: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0001fe80: 2020 2020 2020 2061 6c69 6173 6573 3d61         aliases=a
+0001fe90: 6c69 6173 6573 2c0a 2020 2020 2020 2020  liases,.        
+0001fea0: 2020 2020 636c 6965 6e74 733d 636c 6965      clients=clie
+0001feb0: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
+0001fec0: 2077 6f72 6b65 7273 3d77 6f72 6b65 7273   workers=workers
+0001fed0: 2c0a 2020 2020 2020 2020 2020 2020 686f  ,.            ho
+0001fee0: 7374 5f69 6e66 6f3d 686f 7374 5f69 6e66  st_info=host_inf
+0001fef0: 6f2c 0a20 2020 2020 2020 2020 2020 2072  o,.            r
+0001ff00: 6573 6f75 7263 6573 3d72 6573 6f75 7263  esources=resourc
+0001ff10: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0001ff20: 7461 736b 733d 7461 736b 732c 0a20 2020  tasks=tasks,.   
+0001ff30: 2020 2020 2020 2020 2075 6e72 756e 6e61           unrunna
+0001ff40: 626c 653d 756e 7275 6e6e 6162 6c65 2c0a  ble=unrunnable,.
+0001ff50: 2020 2020 2020 2020 2020 2020 7175 6575              queu
+0001ff60: 6564 3d71 7565 7565 642c 0a20 2020 2020  ed=queued,.     
+0001ff70: 2020 2020 2020 2076 616c 6964 6174 653d         validate=
+0001ff80: 7661 6c69 6461 7465 2c0a 2020 2020 2020  validate,.      
+0001ff90: 2020 2020 2020 706c 7567 696e 733d 706c        plugins=pl
+0001ffa0: 7567 696e 732c 0a20 2020 2020 2020 2020  ugins,.         
+0001ffb0: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
+0001ffc0: 756e 7465 725f 6d61 783d 7472 616e 7369  unter_max=transi
+0001ffd0: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
+0001ffe0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001fff0: 2020 2020 5365 7276 6572 4e6f 6465 2e5f      ServerNode._
+00020000: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+00020010: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00020020: 2020 2020 2020 2068 616e 646c 6572 733d         handlers=
+00020030: 7365 6c66 2e68 616e 646c 6572 732c 0a20  self.handlers,. 
+00020040: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+00020050: 6d5f 6861 6e64 6c65 7273 3d6d 6572 6765  m_handlers=merge
+00020060: 2877 6f72 6b65 725f 6861 6e64 6c65 7273  (worker_handlers
+00020070: 2c20 636c 6965 6e74 5f68 616e 646c 6572  , client_handler
+00020080: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00020090: 636f 6e6e 6563 7469 6f6e 5f6c 696d 6974  connection_limit
+000200a0: 3d63 6f6e 6e65 6374 696f 6e5f 6c69 6d69  =connection_limi
+000200b0: 742c 0a20 2020 2020 2020 2020 2020 2064  t,.            d
+000200c0: 6573 6572 6961 6c69 7a65 3d46 616c 7365  eserialize=False
+000200d0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+000200e0: 6e6e 6563 7469 6f6e 5f61 7267 733d 7365  nnection_args=se
+000200f0: 6c66 2e63 6f6e 6e65 6374 696f 6e5f 6172  lf.connection_ar
+00020100: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00020110: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+00020120: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+00020130: 7365 6c66 2e77 6f72 6b65 725f 7474 6c3a  self.worker_ttl:
+00020140: 0a20 2020 2020 2020 2020 2020 2070 6320  .            pc 
+00020150: 3d20 5065 7269 6f64 6963 4361 6c6c 6261  = PeriodicCallba
+00020160: 636b 2873 656c 662e 6368 6563 6b5f 776f  ck(self.check_wo
+00020170: 726b 6572 5f74 746c 2c20 7365 6c66 2e77  rker_ttl, self.w
+00020180: 6f72 6b65 725f 7474 6c20 2a20 3130 3030  orker_ttl * 1000
+00020190: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000201a0: 6c66 2e70 6572 696f 6469 635f 6361 6c6c  lf.periodic_call
+000201b0: 6261 636b 735b 2277 6f72 6b65 722d 7474  backs["worker-tt
+000201c0: 6c22 5d20 3d20 7063 0a0a 2020 2020 2020  l"] = pc..      
+000201d0: 2020 7063 203d 2050 6572 696f 6469 6343    pc = PeriodicC
+000201e0: 616c 6c62 6163 6b28 7365 6c66 2e63 6865  allback(self.che
+000201f0: 636b 5f69 646c 652c 2028 7365 6c66 2e69  ck_idle, (self.i
+00020200: 646c 655f 7469 6d65 6f75 7420 6f72 2031  dle_timeout or 1
+00020210: 2920 2a20 3130 3030 202f 2034 290a 2020  ) * 1000 / 4).  
+00020220: 2020 2020 2020 7365 6c66 2e70 6572 696f        self.perio
+00020230: 6469 635f 6361 6c6c 6261 636b 735b 2269  dic_callbacks["i
+00020240: 646c 652d 7469 6d65 6f75 7422 5d20 3d20  dle-timeout"] = 
+00020250: 7063 0a0a 2020 2020 2020 2020 6966 2065  pc..        if e
+00020260: 7874 656e 7369 6f6e 7320 6973 204e 6f6e  xtensions is Non
+00020270: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+00020280: 7874 656e 7369 6f6e 7320 3d20 4445 4641  xtensions = DEFA
+00020290: 554c 545f 4558 5445 4e53 494f 4e53 2e63  ULT_EXTENSIONS.c
+000202a0: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+000202b0: 2020 6966 206e 6f74 2064 6173 6b2e 636f    if not dask.co
+000202c0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+000202d0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+000202e0: 776f 726b 2d73 7465 616c 696e 6722 293a  work-stealing"):
+000202f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020300: 2069 6620 2273 7465 616c 696e 6722 2069   if "stealing" i
+00020310: 6e20 6578 7465 6e73 696f 6e73 3a0a 2020  n extensions:.  
+00020320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020330: 2020 6465 6c20 6578 7465 6e73 696f 6e73    del extensions
+00020340: 5b22 7374 6561 6c69 6e67 225d 0a0a 2020  ["stealing"]..  
+00020350: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
+00020360: 6578 7465 6e73 696f 6e20 696e 2065 7874  extension in ext
+00020370: 656e 7369 6f6e 732e 6974 656d 7328 293a  ensions.items():
+00020380: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00020390: 662e 6578 7465 6e73 696f 6e73 5b6e 616d  f.extensions[nam
+000203a0: 655d 203d 2065 7874 656e 7369 6f6e 2873  e] = extension(s
+000203b0: 656c 6629 0a0a 2020 2020 2020 2020 7365  elf)..        se
+000203c0: 7470 726f 6374 6974 6c65 2822 6461 736b  tproctitle("dask
+000203d0: 2073 6368 6564 756c 6572 205b 6e6f 7420   scheduler [not 
+000203e0: 7374 6172 7465 645d 2229 0a20 2020 2020  started]").     
+000203f0: 2020 2053 6368 6564 756c 6572 2e5f 696e     Scheduler._in
+00020400: 7374 616e 6365 732e 6164 6428 7365 6c66  stances.add(self
+00020410: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+00020420: 7063 2e61 6c6c 6f77 5f6f 6666 6c6f 6164  pc.allow_offload
+00020430: 203d 2046 616c 7365 0a0a 2020 2020 2323   = False..    ##
+00020440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020450: 0a20 2020 2023 2041 646d 696e 6973 7472  .    # Administr
+00020460: 6174 696f 6e20 230a 2020 2020 2323 2323  ation #.    ####
+00020470: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
+00020480: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
+00020490: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000204a0: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
+000204b0: 2020 2020 2066 223c 5363 6865 6475 6c65       f"<Schedule
+000204c0: 7220 7b73 656c 662e 6164 6472 6573 735f  r {self.address_
+000204d0: 7361 6665 2172 7d2c 2022 0a20 2020 2020  safe!r}, ".     
+000204e0: 2020 2020 2020 2066 2277 6f72 6b65 7273         f"workers
+000204f0: 3a20 7b6c 656e 2873 656c 662e 776f 726b  : {len(self.work
+00020500: 6572 7329 7d2c 2022 0a20 2020 2020 2020  ers)}, ".       
+00020510: 2020 2020 2066 2263 6f72 6573 3a20 7b73       f"cores: {s
+00020520: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
+00020530: 6473 7d2c 2022 0a20 2020 2020 2020 2020  ds}, ".         
+00020540: 2020 2066 2274 6173 6b73 3a20 7b6c 656e     f"tasks: {len
+00020550: 2873 656c 662e 7461 736b 7329 7d3e 220a  (self.tasks)}>".
+00020560: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00020570: 6566 205f 7265 7072 5f68 746d 6c5f 2873  ef _repr_html_(s
+00020580: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+00020590: 7475 726e 2067 6574 5f74 656d 706c 6174  turn get_templat
+000205a0: 6528 2273 6368 6564 756c 6572 2e68 746d  e("scheduler.htm
+000205b0: 6c2e 6a32 2229 2e72 656e 6465 7228 0a20  l.j2").render(. 
+000205c0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+000205d0: 7373 3d73 656c 662e 6164 6472 6573 732c  ss=self.address,
+000205e0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+000205f0: 6b65 7273 3d73 656c 662e 776f 726b 6572  kers=self.worker
+00020600: 732c 0a20 2020 2020 2020 2020 2020 2074  s,.            t
+00020610: 6872 6561 6473 3d73 656c 662e 746f 7461  hreads=self.tota
+00020620: 6c5f 6e74 6872 6561 6473 2c0a 2020 2020  l_nthreads,.    
+00020630: 2020 2020 2020 2020 7461 736b 733d 7365          tasks=se
+00020640: 6c66 2e74 6173 6b73 2c0a 2020 2020 2020  lf.tasks,.      
+00020650: 2020 290a 0a20 2020 2064 6566 2069 6465    )..    def ide
+00020660: 6e74 6974 7928 7365 6c66 293a 0a20 2020  ntity(self):.   
+00020670: 2020 2020 2022 2222 4261 7369 6320 696e       """Basic in
+00020680: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+00020690: 6f75 7273 656c 7665 7320 616e 6420 6f75  ourselves and ou
+000206a0: 7220 636c 7573 7465 7222 2222 0a20 2020  r cluster""".   
+000206b0: 2020 2020 2064 203d 207b 0a20 2020 2020       d = {.     
+000206c0: 2020 2020 2020 2022 7479 7065 223a 2074         "type": t
+000206d0: 7970 6528 7365 6c66 292e 5f5f 6e61 6d65  ype(self).__name
+000206e0: 5f5f 2c0a 2020 2020 2020 2020 2020 2020  __,.            
+000206f0: 2269 6422 3a20 7374 7228 7365 6c66 2e69  "id": str(self.i
+00020700: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+00020710: 2261 6464 7265 7373 223a 2073 656c 662e  "address": self.
+00020720: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+00020730: 2020 2020 2022 7365 7276 6963 6573 223a       "services":
+00020740: 207b 6b65 793a 2076 2e70 6f72 7420 666f   {key: v.port fo
+00020750: 7220 286b 6579 2c20 7629 2069 6e20 7365  r (key, v) in se
+00020760: 6c66 2e73 6572 7669 6365 732e 6974 656d  lf.services.item
+00020770: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
+00020780: 2020 2273 7461 7274 6564 223a 2073 656c    "started": sel
+00020790: 662e 7469 6d65 5f73 7461 7274 6564 2c0a  f.time_started,.
+000207a0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
+000207b0: 6b65 7273 223a 207b 0a20 2020 2020 2020  kers": {.       
+000207c0: 2020 2020 2020 2020 2077 6f72 6b65 722e           worker.
+000207d0: 6164 6472 6573 733a 2077 6f72 6b65 722e  address: worker.
+000207e0: 6964 656e 7469 7479 2829 2066 6f72 2077  identity() for w
+000207f0: 6f72 6b65 7220 696e 2073 656c 662e 776f  orker in self.wo
+00020800: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
+00020810: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00020820: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00020830: 7265 7475 726e 2064 0a0a 2020 2020 6465  return d..    de
+00020840: 6620 5f74 6f5f 6469 6374 2873 656c 662c  f _to_dict(self,
+00020850: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
+00020860: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
+00020870: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
+00020880: 2020 2022 2222 4469 6374 696f 6e61 7279     """Dictionary
+00020890: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
+000208a0: 666f 7220 6465 6275 6767 696e 6720 7075  for debugging pu
+000208b0: 7270 6f73 6573 2e0a 2020 2020 2020 2020  rposes..        
+000208c0: 4e6f 7420 7479 7065 2073 7461 626c 6520  Not type stable 
+000208d0: 616e 6420 6e6f 7420 696e 7465 6e64 6564  and not intended
+000208e0: 2066 6f72 2072 6f75 6e64 7472 6970 732e   for roundtrips.
+000208f0: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
+00020900: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+00020910: 2d2d 2d0a 2020 2020 2020 2020 5365 7276  ---.        Serv
+00020920: 6572 2e69 6465 6e74 6974 790a 2020 2020  er.identity.    
+00020930: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
+00020940: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
+00020950: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+00020960: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
+00020970: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
+00020980: 2020 2222 220a 2020 2020 2020 2020 696e    """.        in
+00020990: 666f 203d 2073 7570 6572 2829 2e5f 746f  fo = super()._to
+000209a0: 5f64 6963 7428 6578 636c 7564 653d 6578  _dict(exclude=ex
+000209b0: 636c 7564 6529 0a20 2020 2020 2020 2065  clude).        e
+000209c0: 7874 7261 203d 207b 0a20 2020 2020 2020  xtra = {.       
+000209d0: 2020 2020 2022 7472 616e 7369 7469 6f6e       "transition
+000209e0: 5f6c 6f67 223a 2073 656c 662e 7472 616e  _log": self.tran
+000209f0: 7369 7469 6f6e 5f6c 6f67 2c0a 2020 2020  sition_log,.    
+00020a00: 2020 2020 2020 2020 2274 7261 6e73 6974          "transit
+00020a10: 696f 6e5f 636f 756e 7465 7222 3a20 7365  ion_counter": se
+00020a20: 6c66 2e74 7261 6e73 6974 696f 6e5f 636f  lf.transition_co
+00020a30: 756e 7465 722c 0a20 2020 2020 2020 2020  unter,.         
+00020a40: 2020 2022 7461 736b 7322 3a20 7365 6c66     "tasks": self
+00020a50: 2e74 6173 6b73 2c0a 2020 2020 2020 2020  .tasks,.        
+00020a60: 2020 2020 2274 6173 6b5f 6772 6f75 7073      "task_groups
+00020a70: 223a 2073 656c 662e 7461 736b 5f67 726f  ": self.task_gro
+00020a80: 7570 732c 0a20 2020 2020 2020 2020 2020  ups,.           
+00020a90: 2023 204f 7665 7277 7269 7465 2064 6963   # Overwrite dic
+00020aa0: 7420 6f66 2057 6f72 6b65 7253 7461 7465  t of WorkerState
+00020ab0: 2e69 6465 6e74 6974 7920 6672 6f6d 2069  .identity from i
+00020ac0: 6e66 6f0a 2020 2020 2020 2020 2020 2020  nfo.            
+00020ad0: 2277 6f72 6b65 7273 223a 2073 656c 662e  "workers": self.
+00020ae0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
+00020af0: 2020 2020 2022 636c 6965 6e74 7322 3a20       "clients": 
+00020b00: 7365 6c66 2e63 6c69 656e 7473 2c0a 2020  self.clients,.  
+00020b10: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00020b20: 7922 3a20 7365 6c66 2e6d 656d 6f72 792c  y": self.memory,
+00020b30: 0a20 2020 2020 2020 2020 2020 2022 6576  .            "ev
+00020b40: 656e 7473 223a 2073 656c 662e 6576 656e  ents": self.even
+00020b50: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+00020b60: 2265 7874 656e 7369 6f6e 7322 3a20 7365  "extensions": se
+00020b70: 6c66 2e65 7874 656e 7369 6f6e 732c 0a20  lf.extensions,. 
+00020b80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00020b90: 2065 7874 7261 203d 207b 6b3a 2076 2066   extra = {k: v f
+00020ba0: 6f72 206b 2c20 7620 696e 2065 7874 7261  or k, v in extra
+00020bb0: 2e69 7465 6d73 2829 2069 6620 6b20 6e6f  .items() if k no
+00020bc0: 7420 696e 2065 7863 6c75 6465 7d0a 2020  t in exclude}.  
+00020bd0: 2020 2020 2020 696e 666f 2e75 7064 6174        info.updat
+00020be0: 6528 7265 6375 7273 6976 655f 746f 5f64  e(recursive_to_d
+00020bf0: 6963 7428 6578 7472 612c 2065 7863 6c75  ict(extra, exclu
+00020c00: 6465 3d65 7863 6c75 6465 2929 0a20 2020  de=exclude)).   
+00020c10: 2020 2020 2072 6574 7572 6e20 696e 666f       return info
+00020c20: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00020c30: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
+00020c40: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+00020c50: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
+00020c60: 3a20 2243 6f6c 6c65 6374 696f 6e5b 7374  : "Collection[st
+00020c70: 725d 222c 0a20 2020 2029 202d 3e20 6469  r]",.    ) -> di
+00020c80: 6374 3a0a 2020 2020 2020 2020 2250 726f  ct:.        "Pro
+00020c90: 6475 6365 2074 6865 2073 7461 7465 2064  duce the state d
+00020ca0: 6963 7420 7573 6564 2069 6e20 6120 636c  ict used in a cl
+00020cb0: 7573 7465 7220 7374 6174 6520 6475 6d70  uster state dump
+00020cc0: 220a 2020 2020 2020 2020 2320 4b69 636b  ".        # Kick
+00020cd0: 206f 6666 2073 7461 7465 2d64 756d 7069   off state-dumpi
+00020ce0: 6e67 206f 6e20 776f 726b 6572 7320 6265  ng on workers be
+00020cf0: 666f 7265 2077 6520 626c 6f63 6b20 7468  fore we block th
+00020d00: 6520 6576 656e 7420 6c6f 6f70 2069 6e20  e event loop in 
+00020d10: 6073 656c 662e 5f74 6f5f 6469 6374 602e  `self._to_dict`.
+00020d20: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+00020d30: 5f66 7574 7572 6520 3d20 6173 796e 6369  _future = asynci
+00020d40: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00020d50: 2020 2020 2020 7365 6c66 2e62 726f 6164        self.broad
+00020d60: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
+00020d70: 2020 2020 2020 6d73 673d 7b22 6f70 223a        msg={"op":
+00020d80: 2022 6475 6d70 5f73 7461 7465 222c 2022   "dump_state", "
+00020d90: 6578 636c 7564 6522 3a20 6578 636c 7564  exclude": exclud
+00020da0: 657d 2c0a 2020 2020 2020 2020 2020 2020  e},.            
+00020db0: 2020 2020 6f6e 5f65 7272 6f72 3d22 7265      on_error="re
+00020dc0: 7475 726e 222c 0a20 2020 2020 2020 2020  turn",.         
+00020dd0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00020de0: 2020 7365 6c66 2e62 726f 6164 6361 7374    self.broadcast
+00020df0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00020e00: 2020 6d73 673d 7b22 6f70 223a 2022 7665    msg={"op": "ve
+00020e10: 7273 696f 6e73 227d 2c0a 2020 2020 2020  rsions"},.      
+00020e20: 2020 2020 2020 2020 2020 6f6e 5f65 7272            on_err
+00020e30: 6f72 3d22 6967 6e6f 7265 222c 0a20 2020  or="ignore",.   
+00020e40: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00020e50: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
+00020e60: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00020e70: 6368 6564 756c 6572 5f73 7461 7465 203d  cheduler_state =
+00020e80: 2073 656c 662e 5f74 6f5f 6469 6374 2865   self._to_dict(e
+00020e90: 7863 6c75 6465 3d65 7863 6c75 6465 290a  xclude=exclude).
+00020ea0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+00020eb0: 6b65 725f 7374 6174 6573 2c20 776f 726b  ker_states, work
+00020ec0: 6572 5f76 6572 7369 6f6e 7320 3d20 6177  er_versions = aw
+00020ed0: 6169 7420 776f 726b 6572 735f 6675 7475  ait workers_futu
+00020ee0: 7265 0a20 2020 2020 2020 2066 696e 616c  re.        final
+00020ef0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+00020f00: 2320 456e 7375 7265 2074 6865 2074 6173  # Ensure the tas
+00020f10: 6b73 2061 7265 6e27 7420 6c65 6674 2072  ks aren't left r
+00020f20: 756e 6e69 6e67 2069 6620 616e 7974 6869  unning if anythi
+00020f30: 6e67 2066 6169 6c73 2e0a 2020 2020 2020  ng fails..      
+00020f40: 2020 2020 2020 2320 536f 6d65 6461 7920        # Someday 
+00020f50: 2870 7933 2e31 3129 2c20 7573 6520 6120  (py3.11), use a 
+00020f60: 7472 696f 2d73 7479 6c65 2054 6173 6b47  trio-style TaskG
+00020f70: 726f 7570 2066 6f72 2074 6869 732e 0a20  roup for this.. 
+00020f80: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00020f90: 7273 5f66 7574 7572 652e 6361 6e63 656c  rs_future.cancel
+00020fa0: 2829 0a0a 2020 2020 2020 2020 2320 436f  ()..        # Co
+00020fb0: 6e76 6572 7420 616e 7920 5250 4320 6572  nvert any RPC er
+00020fc0: 726f 7273 2074 6f20 7374 7269 6e67 730a  rors to strings.
+00020fd0: 2020 2020 2020 2020 776f 726b 6572 5f73          worker_s
+00020fe0: 7461 7465 7320 3d20 7b0a 2020 2020 2020  tates = {.      
+00020ff0: 2020 2020 2020 6b3a 2072 6570 7228 7629        k: repr(v)
+00021000: 2069 6620 6973 696e 7374 616e 6365 2876   if isinstance(v
+00021010: 2c20 4578 6365 7074 696f 6e29 2065 6c73  , Exception) els
+00021020: 6520 760a 2020 2020 2020 2020 2020 2020  e v.            
+00021030: 666f 7220 6b2c 2076 2069 6e20 776f 726b  for k, v in work
+00021040: 6572 5f73 7461 7465 732e 6974 656d 7328  er_states.items(
+00021050: 290a 2020 2020 2020 2020 7d0a 0a20 2020  ).        }..   
+00021060: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+00021070: 2020 2020 2020 2020 2020 2273 6368 6564            "sched
+00021080: 756c 6572 223a 2073 6368 6564 756c 6572  uler": scheduler
+00021090: 5f73 7461 7465 2c0a 2020 2020 2020 2020  _state,.        
+000210a0: 2020 2020 2277 6f72 6b65 7273 223a 2077      "workers": w
+000210b0: 6f72 6b65 725f 7374 6174 6573 2c0a 2020  orker_states,.  
+000210c0: 2020 2020 2020 2020 2020 2276 6572 7369            "versi
+000210d0: 6f6e 7322 3a20 7b22 7363 6865 6475 6c65  ons": {"schedule
+000210e0: 7222 3a20 7365 6c66 2e76 6572 7369 6f6e  r": self.version
+000210f0: 7328 292c 2022 776f 726b 6572 7322 3a20  s(), "workers": 
+00021100: 776f 726b 6572 5f76 6572 7369 6f6e 737d  worker_versions}
+00021110: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+00021120: 2061 7379 6e63 2064 6566 2064 756d 705f   async def dump_
+00021130: 636c 7573 7465 725f 7374 6174 655f 746f  cluster_state_to
+00021140: 5f75 726c 280a 2020 2020 2020 2020 7365  _url(.        se
+00021150: 6c66 2c0a 2020 2020 2020 2020 7572 6c3a  lf,.        url:
+00021160: 2073 7472 2c0a 2020 2020 2020 2020 6578   str,.        ex
+00021170: 636c 7564 653a 2022 436f 6c6c 6563 7469  clude: "Collecti
+00021180: 6f6e 5b73 7472 5d22 2c0a 2020 2020 2020  on[str]",.      
+00021190: 2020 666f 726d 6174 3a20 4c69 7465 7261    format: Litera
+000211a0: 6c5b 226d 7367 7061 636b 222c 2022 7961  l["msgpack", "ya
+000211b0: 6d6c 225d 2c0a 2020 2020 2020 2020 2a2a  ml"],.        **
+000211c0: 7374 6f72 6167 655f 6f70 7469 6f6e 733a  storage_options:
+000211d0: 2064 6963 745b 7374 722c 2041 6e79 5d2c   dict[str, Any],
+000211e0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+000211f0: 2020 2020 2020 2020 2257 7269 7465 2061          "Write a
+00021200: 2063 6c75 7374 6572 2073 7461 7465 2064   cluster state d
+00021210: 756d 7020 746f 2061 6e20 6673 7370 6563  ump to an fsspec
+00021220: 2d63 6f6d 7061 7469 626c 6520 5552 4c2e  -compatible URL.
+00021230: 220a 2020 2020 2020 2020 6177 6169 7420  ".        await 
+00021240: 636c 7573 7465 725f 6475 6d70 2e77 7269  cluster_dump.wri
+00021250: 7465 5f73 7461 7465 280a 2020 2020 2020  te_state(.      
+00021260: 2020 2020 2020 7061 7274 6961 6c28 7365        partial(se
+00021270: 6c66 2e67 6574 5f63 6c75 7374 6572 5f73  lf.get_cluster_s
+00021280: 7461 7465 2c20 6578 636c 7564 6529 2c20  tate, exclude), 
+00021290: 7572 6c2c 2066 6f72 6d61 742c 202a 2a73  url, format, **s
+000212a0: 746f 7261 6765 5f6f 7074 696f 6e73 0a20  torage_options. 
+000212b0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+000212c0: 6620 6765 745f 776f 726b 6572 5f73 6572  f get_worker_ser
+000212d0: 7669 6365 5f61 6464 7228 0a20 2020 2020  vice_addr(.     
+000212e0: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
+000212f0: 2073 7472 2c20 7365 7276 6963 655f 6e61   str, service_na
+00021300: 6d65 3a20 7374 722c 2070 726f 746f 636f  me: str, protoco
+00021310: 6c3a 2062 6f6f 6c20 3d20 4661 6c73 650a  l: bool = False.
+00021320: 2020 2020 2920 2d3e 2074 7570 6c65 5b73      ) -> tuple[s
+00021330: 7472 2c20 696e 745d 207c 2073 7472 207c  tr, int] | str |
+00021340: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00021350: 2222 0a20 2020 2020 2020 2047 6574 2074  "".        Get t
+00021360: 6865 2028 686f 7374 2c20 706f 7274 2920  he (host, port) 
+00021370: 6164 6472 6573 7320 6f66 2074 6865 206e  address of the n
+00021380: 616d 6564 2073 6572 7669 6365 206f 6e20  amed service on 
+00021390: 7468 6520 2a77 6f72 6b65 722a 2e0a 2020  the *worker*..  
+000213a0: 2020 2020 2020 5265 7475 726e 7320 4e6f        Returns No
+000213b0: 6e65 2069 6620 7468 6520 7365 7276 6963  ne if the servic
+000213c0: 6520 646f 6573 6e27 7420 6578 6973 742e  e doesn't exist.
+000213d0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+000213e0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+000213f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00021400: 776f 726b 6572 203a 2061 6464 7265 7373  worker : address
+00021410: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
+00021420: 5f6e 616d 6520 3a20 7374 720a 2020 2020  _name : str.    
+00021430: 2020 2020 2020 2020 436f 6d6d 6f6e 2073          Common s
+00021440: 6572 7669 6365 7320 696e 636c 7564 6520  ervices include 
+00021450: 2762 6f6b 6568 2720 616e 6420 276e 616e  'bokeh' and 'nan
+00021460: 6e79 270a 2020 2020 2020 2020 7072 6f74  ny'.        prot
+00021470: 6f63 6f6c 203a 2062 6f6f 6c65 616e 0a20  ocol : boolean. 
+00021480: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
+00021490: 6572 206f 7220 6e6f 7420 746f 2069 6e63  er or not to inc
+000214a0: 6c75 6465 2061 2066 756c 6c20 6164 6472  lude a full addr
+000214b0: 6573 7320 7769 7468 2070 726f 746f 636f  ess with protoco
+000214c0: 6c20 2854 7275 6529 0a20 2020 2020 2020  l (True).       
+000214d0: 2020 2020 206f 7220 6a75 7374 2061 2028       or just a (
+000214e0: 686f 7374 2c20 706f 7274 2920 7061 6972  host, port) pair
+000214f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00021500: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
+00021510: 6f72 6b65 7273 5b77 6f72 6b65 725d 0a20  orkers[worker]. 
+00021520: 2020 2020 2020 2070 6f72 7420 3d20 7773         port = ws
+00021530: 2e73 6572 7669 6365 732e 6765 7428 7365  .services.get(se
+00021540: 7276 6963 655f 6e61 6d65 290a 2020 2020  rvice_name).    
+00021550: 2020 2020 6966 2070 6f72 7420 6973 204e      if port is N
+00021560: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00021570: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
+00021580: 2020 2020 2065 6c69 6620 7072 6f74 6f63       elif protoc
+00021590: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
+000215a0: 7265 7475 726e 2022 2528 7072 6f74 6f63  return "%(protoc
+000215b0: 6f6c 2973 3a2f 2f25 2868 6f73 7429 733a  ol)s://%(host)s:
+000215c0: 2528 706f 7274 2964 2220 2520 7b0a 2020  %(port)d" % {.  
+000215d0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+000215e0: 726f 746f 636f 6c22 3a20 7773 2e61 6464  rotocol": ws.add
+000215f0: 7265 7373 2e73 706c 6974 2822 3a2f 2f22  ress.split("://"
+00021600: 295b 305d 2c0a 2020 2020 2020 2020 2020  )[0],.          
+00021610: 2020 2020 2020 2268 6f73 7422 3a20 7773        "host": ws
+00021620: 2e68 6f73 742c 0a20 2020 2020 2020 2020  .host,.         
+00021630: 2020 2020 2020 2022 706f 7274 223a 2070         "port": p
+00021640: 6f72 742c 0a20 2020 2020 2020 2020 2020  ort,.           
+00021650: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
+00021660: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00021670: 7572 6e20 7773 2e68 6f73 742c 2070 6f72  urn ws.host, por
+00021680: 740a 0a20 2020 2061 7379 6e63 2064 6566  t..    async def
+00021690: 2073 7461 7274 5f75 6e73 6166 6528 7365   start_unsafe(se
+000216a0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+000216b0: 436c 6561 7220 6f75 7420 6f6c 6420 7374  Clear out old st
+000216c0: 6174 6520 616e 6420 7265 7374 6172 7420  ate and restart 
+000216d0: 616c 6c20 7275 6e6e 696e 6720 636f 726f  all running coro
+000216e0: 7574 696e 6573 2222 220a 2020 2020 2020  utines""".      
+000216f0: 2020 6177 6169 7420 7375 7065 7228 292e    await super().
+00021700: 7374 6172 745f 756e 7361 6665 2829 0a0a  start_unsafe()..
+00021710: 2020 2020 2020 2020 656e 6162 6c65 5f67          enable_g
+00021720: 635f 6469 6167 6e6f 7369 7328 290a 0a20  c_diagnosis().. 
+00021730: 2020 2020 2020 2073 656c 662e 5f63 6c65         self._cle
+00021740: 6172 5f74 6173 6b5f 7374 6174 6528 290a  ar_task_state().
+00021750: 0a20 2020 2020 2020 2066 6f72 2061 6464  .        for add
+00021760: 7220 696e 2073 656c 662e 5f73 7461 7274  r in self._start
+00021770: 5f61 6464 7265 7373 3a0a 2020 2020 2020  _address:.      
+00021780: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00021790: 2e6c 6973 7465 6e28 0a20 2020 2020 2020  .listen(.       
+000217a0: 2020 2020 2020 2020 2061 6464 722c 0a20           addr,. 
+000217b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000217c0: 6c6c 6f77 5f6f 6666 6c6f 6164 3d46 616c  llow_offload=Fal
+000217d0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+000217e0: 2020 2020 6861 6e64 7368 616b 655f 6f76      handshake_ov
+000217f0: 6572 7269 6465 733d 7b22 7069 636b 6c65  errides={"pickle
+00021800: 2d70 726f 746f 636f 6c22 3a20 342c 2022  -protocol": 4, "
+00021810: 636f 6d70 7265 7373 696f 6e22 3a20 4e6f  compression": No
+00021820: 6e65 7d2c 0a20 2020 2020 2020 2020 2020  ne},.           
+00021830: 2020 2020 202a 2a73 656c 662e 7365 6375       **self.secu
+00021840: 7269 7479 2e67 6574 5f6c 6973 7465 6e5f  rity.get_listen_
+00021850: 6172 6773 2822 7363 6865 6475 6c65 7222  args("scheduler"
+00021860: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00021870: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00021880: 662e 6970 203d 2067 6574 5f61 6464 7265  f.ip = get_addre
+00021890: 7373 5f68 6f73 7428 7365 6c66 2e6c 6973  ss_host(self.lis
+000218a0: 7465 6e5f 6164 6472 6573 7329 0a20 2020  ten_address).   
+000218b0: 2020 2020 2020 2020 206c 6973 7465 6e5f           listen_
+000218c0: 6970 203d 2073 656c 662e 6970 0a0a 2020  ip = self.ip..  
+000218d0: 2020 2020 2020 2020 2020 6966 206c 6973            if lis
+000218e0: 7465 6e5f 6970 203d 3d20 2230 2e30 2e30  ten_ip == "0.0.0
+000218f0: 2e30 223a 0a20 2020 2020 2020 2020 2020  .0":.           
+00021900: 2020 2020 206c 6973 7465 6e5f 6970 203d       listen_ip =
+00021910: 2022 220a 0a20 2020 2020 2020 2069 6620   ""..        if 
+00021920: 7365 6c66 2e61 6464 7265 7373 2e73 7461  self.address.sta
+00021930: 7274 7377 6974 6828 2269 6e70 726f 633a  rtswith("inproc:
+00021940: 2f2f 2229 3a0a 2020 2020 2020 2020 2020  //"):.          
+00021950: 2020 6c69 7374 656e 5f69 7020 3d20 226c    listen_ip = "l
+00021960: 6f63 616c 686f 7374 220a 0a20 2020 2020  ocalhost"..     
+00021970: 2020 2023 2053 6572 7669 6365 7320 6c69     # Services li
+00021980: 7374 656e 206f 6e20 616c 6c20 6164 6472  sten on all addr
+00021990: 6573 7365 730a 2020 2020 2020 2020 7365  esses.        se
+000219a0: 6c66 2e73 7461 7274 5f73 6572 7669 6365  lf.start_service
+000219b0: 7328 6c69 7374 656e 5f69 7029 0a0a 2020  s(listen_ip)..  
+000219c0: 2020 2020 2020 666f 7220 6c69 7374 656e        for listen
+000219d0: 6572 2069 6e20 7365 6c66 2e6c 6973 7465  er in self.liste
+000219e0: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
+000219f0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2220    logger.info(" 
+00021a00: 2053 6368 6564 756c 6572 2061 743a 2025   Scheduler at: %
+00021a10: 3235 7322 2c20 6c69 7374 656e 6572 2e63  25s", listener.c
+00021a20: 6f6e 7461 6374 5f61 6464 7265 7373 290a  ontact_address).
+00021a30: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+00021a40: 2c20 7365 7276 6572 2069 6e20 7365 6c66  , server in self
+00021a50: 2e73 6572 7669 6365 732e 6974 656d 7328  .services.items(
+00021a60: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00021a70: 6620 6e61 6d65 203d 3d20 2264 6173 6862  f name == "dashb
+00021a80: 6f61 7264 223a 0a20 2020 2020 2020 2020  oard":.         
+00021a90: 2020 2020 2020 2061 6464 7220 3d20 6765         addr = ge
+00021aa0: 745f 6164 6472 6573 735f 686f 7374 286c  t_address_host(l
+00021ab0: 6973 7465 6e65 722e 636f 6e74 6163 745f  istener.contact_
+00021ac0: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+00021ad0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00021ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021af0: 2020 6c69 6e6b 203d 2066 6f72 6d61 745f    link = format_
+00021b00: 6461 7368 626f 6172 645f 6c69 6e6b 2861  dashboard_link(a
+00021b10: 6464 722c 2073 6572 7665 722e 706f 7274  ddr, server.port
+00021b20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00021b30: 2020 2320 666f 726d 6174 7469 6e67 2064    # formatting d
+00021b40: 6173 6862 6f61 7264 206c 696e 6b20 6361  ashboard link ca
+00021b50: 6e20 6661 696c 2069 6620 6469 7374 7269  n fail if distri
+00021b60: 6275 7465 642e 6461 7368 626f 6172 642e  buted.dashboard.
+00021b70: 6c69 6e6b 0a20 2020 2020 2020 2020 2020  link.           
+00021b80: 2020 2020 2023 2072 6566 6572 7320 746f       # refers to
+00021b90: 206e 6f6e 2d65 7869 7374 616e 7420 656e   non-existant en
+00021ba0: 7620 7661 7273 2e0a 2020 2020 2020 2020  v vars..        
+00021bb0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00021bc0: 6579 4572 726f 7220 6173 2065 3a0a 2020  eyError as e:.  
 00021bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021be0: 6966 206f 732e 7061 7468 2e65 7869 7374  if os.path.exist
-00021bf0: 7328 666e 293a 0a20 2020 2020 2020 2020  s(fn):.         
-00021c00: 2020 2020 2020 2020 2020 206f 732e 7265             os.re
-00021c10: 6d6f 7665 2866 6e29 0a0a 2020 2020 2020  move(fn)..      
-00021c20: 2020 2020 2020 7765 616b 7265 662e 6669        weakref.fi
-00021c30: 6e61 6c69 7a65 2873 656c 662c 2064 656c  nalize(self, del
-00021c40: 5f73 6368 6564 756c 6572 5f66 696c 6529  _scheduler_file)
-00021c50: 0a0a 2020 2020 2020 2020 666f 7220 7072  ..        for pr
-00021c60: 656c 6f61 6420 696e 2073 656c 662e 7072  eload in self.pr
-00021c70: 656c 6f61 6473 3a0a 2020 2020 2020 2020  eloads:.        
-00021c80: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00021c90: 2020 2020 2020 2020 2061 7761 6974 2070           await p
-00021ca0: 7265 6c6f 6164 2e73 7461 7274 2829 0a20  reload.start(). 
-00021cb0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00021cc0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
-00021cd0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00021ce0: 6765 722e 6578 6365 7074 696f 6e28 2246  ger.exception("F
-00021cf0: 6169 6c65 6420 746f 2073 7461 7274 2070  ailed to start p
-00021d00: 7265 6c6f 6164 2229 0a0a 2020 2020 2020  reload")..      
-00021d10: 2020 6966 2073 656c 662e 6a75 7079 7465    if self.jupyte
-00021d20: 723a 0a20 2020 2020 2020 2020 2020 2023  r:.            #
-00021d30: 2041 6c6c 6f77 2069 6e73 6563 7572 6520   Allow insecure 
-00021d40: 636f 6d6d 756e 6963 6174 696f 6e73 2066  communications f
-00021d50: 726f 6d20 6c6f 6361 6c20 7573 6572 730a  rom local users.
-00021d60: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00021d70: 656c 662e 6164 6472 6573 732e 7374 6172  elf.address.star
-00021d80: 7473 7769 7468 2822 746c 733a 2f2f 2229  tswith("tls://")
-00021d90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021da0: 2020 6177 6169 7420 7365 6c66 2e6c 6973    await self.lis
-00021db0: 7465 6e28 2274 6370 3a2f 2f6c 6f63 616c  ten("tcp://local
-00021dc0: 686f 7374 3a30 2229 0a20 2020 2020 2020  host:0").       
-00021dd0: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
-00021de0: 2244 4153 4b5f 5343 4845 4455 4c45 525f  "DASK_SCHEDULER_
-00021df0: 4144 4452 4553 5322 5d20 3d20 7365 6c66  ADDRESS"] = self
-00021e00: 2e6c 6973 7465 6e65 7273 5b2d 315d 2e63  .listeners[-1].c
-00021e10: 6f6e 7461 6374 5f61 6464 7265 7373 0a0a  ontact_address..
-00021e20: 2020 2020 2020 2020 6177 6169 7420 6173          await as
-00021e30: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
-00021e40: 2020 2020 2020 2020 2020 2a5b 706c 7567            *[plug
-00021e50: 696e 2e73 7461 7274 2873 656c 6629 2066  in.start(self) f
-00021e60: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
-00021e70: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
-00021e80: 616c 7565 7328 2929 5d0a 2020 2020 2020  alues())].      
-00021e90: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00021ea0: 662e 7374 6172 745f 7065 7269 6f64 6963  f.start_periodic
-00021eb0: 5f63 616c 6c62 6163 6b73 2829 0a0a 2020  _callbacks()..  
-00021ec0: 2020 2020 2020 7365 7470 726f 6374 6974        setproctit
-00021ed0: 6c65 2866 2264 6173 6b20 7363 6865 6475  le(f"dask schedu
-00021ee0: 6c65 7220 5b7b 7365 6c66 2e61 6464 7265  ler [{self.addre
-00021ef0: 7373 7d5d 2229 0a20 2020 2020 2020 2072  ss}]").        r
-00021f00: 6574 7572 6e20 7365 6c66 0a0a 2020 2020  eturn self..    
-00021f10: 6173 796e 6320 6465 6620 636c 6f73 6528  async def close(
-00021f20: 7365 6c66 2c20 6661 7374 3d4e 6f6e 652c  self, fast=None,
-00021f30: 2063 6c6f 7365 5f77 6f72 6b65 7273 3d4e   close_workers=N
-00021f40: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
-00021f50: 2253 656e 6420 636c 6561 6e75 7020 7369  "Send cleanup si
-00021f60: 676e 616c 2074 6f20 616c 6c20 636f 726f  gnal to all coro
-00021f70: 7574 696e 6573 2074 6865 6e20 7761 6974  utines then wait
-00021f80: 2075 6e74 696c 2066 696e 6973 6865 640a   until finished.
-00021f90: 0a20 2020 2020 2020 2053 6565 2041 6c73  .        See Als
-00021fa0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-00021fb0: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
-00021fc0: 756c 6572 2e63 6c65 616e 7570 0a20 2020  uler.cleanup.   
-00021fd0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00021fe0: 2069 6620 6661 7374 2069 7320 6e6f 7420   if fast is not 
-00021ff0: 4e6f 6e65 206f 7220 636c 6f73 655f 776f  None or close_wo
-00022000: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
-00022010: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00022020: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
-00022030: 2020 2020 2020 2020 2020 2020 2020 2254                "T
-00022040: 6865 2027 6661 7374 2720 616e 6420 2763  he 'fast' and 'c
-00022050: 6c6f 7365 5f77 6f72 6b65 7273 2720 7061  lose_workers' pa
-00022060: 7261 6d65 7465 7273 2069 6e20 5363 6865  rameters in Sche
-00022070: 6475 6c65 722e 636c 6f73 6520 6861 7665  duler.close have
-00022080: 206e 6f20 6566 6665 6374 2061 6e64 2077   no effect and w
-00022090: 696c 6c20 6265 2072 656d 6f76 6564 2069  ill be removed i
-000220a0: 6e20 6120 6675 7475 7265 2076 6572 7369  n a future versi
-000220b0: 6f6e 206f 6620 6469 7374 7269 6275 7465  on of distribute
-000220c0: 642e 222c 0a20 2020 2020 2020 2020 2020  d.",.           
-000220d0: 2020 2020 2046 7574 7572 6557 6172 6e69       FutureWarni
-000220e0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-000220f0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-00022100: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
-00022110: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
-00022120: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
-00022130: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-00022140: 656c 662e 6669 6e69 7368 6564 2829 0a20  elf.finished(). 
-00022150: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00022160: 6e0a 0a20 2020 2020 2020 2061 7379 6e63  n..        async
-00022170: 2064 6566 206c 6f67 5f65 7272 6f72 7328   def log_errors(
-00022180: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
-00022190: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000221a0: 2020 2020 2020 2020 6177 6169 7420 6675          await fu
-000221b0: 6e63 2829 0a20 2020 2020 2020 2020 2020  nc().           
-000221c0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-000221d0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-000221e0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
-000221f0: 696f 6e28 2250 6c75 6769 6e20 6361 6c6c  ion("Plugin call
-00022200: 2066 6169 6c65 6420 6475 7269 6e67 2073   failed during s
-00022210: 6368 6564 756c 6572 2e63 6c6f 7365 2229  cheduler.close")
-00022220: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
-00022230: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-00022240: 2020 2020 2020 2020 2020 2020 2a5b 6c6f              *[lo
-00022250: 675f 6572 726f 7273 2870 6c75 6769 6e2e  g_errors(plugin.
-00022260: 6265 666f 7265 5f63 6c6f 7365 2920 666f  before_close) fo
-00022270: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
-00022280: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
-00022290: 6c75 6573 2829 295d 0a20 2020 2020 2020  lues())].       
-000222a0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-000222b0: 2e73 7461 7475 7320 3d20 5374 6174 7573  .status = Status
-000222c0: 2e63 6c6f 7369 6e67 0a0a 2020 2020 2020  .closing..      
-000222d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2253    logger.info("S
-000222e0: 6368 6564 756c 6572 2063 6c6f 7369 6e67  cheduler closing
-000222f0: 2e2e 2e22 290a 2020 2020 2020 2020 7365  ...").        se
-00022300: 7470 726f 6374 6974 6c65 2822 6461 736b  tproctitle("dask
-00022310: 2073 6368 6564 756c 6572 205b 636c 6f73   scheduler [clos
-00022320: 696e 675d 2229 0a0a 2020 2020 2020 2020  ing]")..        
-00022330: 666f 7220 7072 656c 6f61 6420 696e 2073  for preload in s
-00022340: 656c 662e 7072 656c 6f61 6473 3a0a 2020  elf.preloads:.  
-00022350: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00022360: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00022370: 7761 6974 2070 7265 6c6f 6164 2e74 6561  wait preload.tea
-00022380: 7264 6f77 6e28 290a 2020 2020 2020 2020  rdown().        
-00022390: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000223a0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-000223b0: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-000223c0: 6570 7469 6f6e 2822 4661 696c 6564 2074  eption("Failed t
-000223d0: 6f20 7465 6172 2064 6f77 6e20 7072 656c  o tear down prel
-000223e0: 6f61 6422 290a 0a20 2020 2020 2020 2061  oad")..        a
-000223f0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00022400: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00022410: 202a 5b6c 6f67 5f65 7272 6f72 7328 706c   *[log_errors(pl
-00022420: 7567 696e 2e63 6c6f 7365 2920 666f 7220  ugin.close) for 
-00022430: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
-00022440: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-00022450: 6573 2829 295d 0a20 2020 2020 2020 2029  es())].        )
-00022460: 0a0a 2020 2020 2020 2020 666f 7220 7063  ..        for pc
-00022470: 2069 6e20 7365 6c66 2e70 6572 696f 6469   in self.periodi
-00022480: 635f 6361 6c6c 6261 636b 732e 7661 6c75  c_callbacks.valu
-00022490: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-000224a0: 2020 7063 2e73 746f 7028 290a 2020 2020    pc.stop().    
-000224b0: 2020 2020 7365 6c66 2e70 6572 696f 6469      self.periodi
-000224c0: 635f 6361 6c6c 6261 636b 732e 636c 6561  c_callbacks.clea
-000224d0: 7228 290a 0a20 2020 2020 2020 2073 656c  r()..        sel
-000224e0: 662e 7374 6f70 5f73 6572 7669 6365 7328  f.stop_services(
-000224f0: 290a 0a20 2020 2020 2020 2066 6f72 2065  )..        for e
-00022500: 7874 2069 6e20 7365 6c66 2e65 7874 656e  xt in self.exten
-00022510: 7369 6f6e 732e 7661 6c75 6573 2829 3a0a  sions.values():.
-00022520: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00022530: 2073 7570 7072 6573 7328 4174 7472 6962   suppress(Attrib
-00022540: 7574 6545 7272 6f72 293a 0a20 2020 2020  uteError):.     
-00022550: 2020 2020 2020 2020 2020 2065 7874 2e74             ext.t
-00022560: 6561 7264 6f77 6e28 290a 2020 2020 2020  eardown().      
-00022570: 2020 6c6f 6767 6572 2e69 6e66 6f28 2253    logger.info("S
-00022580: 6368 6564 756c 6572 2063 6c6f 7369 6e67  cheduler closing
-00022590: 2061 6c6c 2063 6f6d 6d73 2229 0a0a 2020   all comms")..  
-000225a0: 2020 2020 2020 6675 7475 7265 7320 3d20        futures = 
-000225b0: 5b5d 0a20 2020 2020 2020 2066 6f72 205f  [].        for _
-000225c0: 2c20 636f 6d6d 2069 6e20 6c69 7374 2873  , comm in list(s
-000225d0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-000225e0: 2e69 7465 6d73 2829 293a 0a20 2020 2020  .items()):.     
-000225f0: 2020 2020 2020 2023 2046 4958 4d45 2075         # FIXME u
-00022600: 7365 2060 7365 6c66 2e72 656d 6f76 655f  se `self.remove_
-00022610: 776f 726b 6572 2829 6020 696e 7374 6561  worker()` instea
-00022620: 6420 6166 7465 7220 6874 7470 733a 2f2f  d after https://
-00022630: 6769 7468 7562 2e63 6f6d 2f64 6173 6b2f  github.com/dask/
-00022640: 6469 7374 7269 6275 7465 642f 6973 7375  distributed/issu
-00022650: 6573 2f36 3339 300a 2020 2020 2020 2020  es/6390.        
-00022660: 2020 2020 6966 206e 6f74 2063 6f6d 6d2e      if not comm.
-00022670: 636c 6f73 6564 2829 3a0a 2020 2020 2020  closed():.      
-00022680: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-00022690: 2063 6c6f 7365 7320 7468 6520 576f 726b   closes the Work
-000226a0: 6572 2061 6e64 2065 6e73 7572 6573 2074  er and ensures t
-000226b0: 6861 7420 6966 2061 204e 616e 6e79 2069  hat if a Nanny i
-000226c0: 7320 6172 6f75 6e64 2c0a 2020 2020 2020  s around,.      
-000226d0: 2020 2020 2020 2020 2020 2320 6974 2069            # it i
-000226e0: 7320 636c 6f73 6564 2061 7320 7765 6c6c  s closed as well
-000226f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022700: 2063 6f6d 6d2e 7365 6e64 287b 226f 7022   comm.send({"op"
-00022710: 3a20 2263 6c6f 7365 222c 2022 7265 6173  : "close", "reas
-00022720: 6f6e 223a 2022 7363 6865 6475 6c65 722d  on": "scheduler-
-00022730: 636c 6f73 6522 7d29 0a20 2020 2020 2020  close"}).       
-00022740: 2020 2020 2020 2020 2063 6f6d 6d2e 7365           comm.se
-00022750: 6e64 287b 226f 7022 3a20 2263 6c6f 7365  nd({"op": "close
-00022760: 2d73 7472 6561 6d22 7d29 0a20 2020 2020  -stream"}).     
-00022770: 2020 2020 2020 2020 2020 2023 205e 2054             # ^ T
-00022780: 4f44 4f20 7265 6d6f 7665 3f20 6057 6f72  ODO remove? `Wor
-00022790: 6b65 722e 636c 6f73 6560 2077 696c 6c20  ker.close` will 
-000227a0: 636c 6f73 6520 7468 6520 7374 7265 616d  close the stream
-000227b0: 2061 6e79 7761 792e 0a20 2020 2020 2020   anyway..       
-000227c0: 2020 2020 2077 6974 6820 7375 7070 7265       with suppre
-000227d0: 7373 2841 7474 7269 6275 7465 4572 726f  ss(AttributeErro
-000227e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000227f0: 2020 2020 6675 7475 7265 732e 6170 7065      futures.appe
-00022800: 6e64 2863 6f6d 6d2e 636c 6f73 6528 2929  nd(comm.close())
-00022810: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
-00022820: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
-00022830: 6675 7475 7265 7329 0a0a 2020 2020 2020  futures)..      
-00022840: 2020 6966 2073 656c 662e 6a75 7079 7465    if self.jupyte
-00022850: 723a 0a20 2020 2020 2020 2020 2020 2061  r:.            a
-00022860: 7761 6974 2073 656c 662e 5f6a 7570 7974  wait self._jupyt
-00022870: 6572 5f73 6572 7665 725f 6170 706c 6963  er_server_applic
-00022880: 6174 696f 6e2e 5f63 6c65 616e 7570 2829  ation._cleanup()
-00022890: 0a0a 2020 2020 2020 2020 666f 7220 636f  ..        for co
-000228a0: 6d6d 2069 6e20 7365 6c66 2e63 6c69 656e  mm in self.clien
-000228b0: 745f 636f 6d6d 732e 7661 6c75 6573 2829  t_comms.values()
-000228c0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-000228d0: 6d6d 2e61 626f 7274 2829 0a0a 2020 2020  mm.abort()..    
-000228e0: 2020 2020 6177 6169 7420 7365 6c66 2e72      await self.r
-000228f0: 7063 2e63 6c6f 7365 2829 0a0a 2020 2020  pc.close()..    
-00022900: 2020 2020 7365 6c66 2e73 7461 7475 7320      self.status 
-00022910: 3d20 5374 6174 7573 2e63 6c6f 7365 640a  = Status.closed.
-00022920: 2020 2020 2020 2020 7365 6c66 2e73 746f          self.sto
-00022930: 7028 290a 2020 2020 2020 2020 6177 6169  p().        awai
-00022940: 7420 7375 7065 7228 292e 636c 6f73 6528  t super().close(
-00022950: 290a 0a20 2020 2020 2020 2073 6574 7072  )..        setpr
-00022960: 6f63 7469 746c 6528 2264 6173 6b20 7363  octitle("dask sc
-00022970: 6865 6475 6c65 7220 5b63 6c6f 7365 645d  heduler [closed]
-00022980: 2229 0a20 2020 2020 2020 2064 6973 6162  ").        disab
-00022990: 6c65 5f67 635f 6469 6167 6e6f 7369 7328  le_gc_diagnosis(
-000229a0: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
-000229b0: 2323 0a20 2020 2023 2053 7469 6d75 6c69  ##.    # Stimuli
-000229c0: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
-000229d0: 2323 0a0a 2020 2020 6465 6620 6865 6172  ##..    def hear
-000229e0: 7462 6561 745f 776f 726b 6572 280a 2020  tbeat_worker(.  
-000229f0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00022a00: 2020 2020 2a2c 0a20 2020 2020 2020 2061      *,.        a
-00022a10: 6464 7265 7373 3a20 7374 722c 0a20 2020  ddress: str,.   
-00022a20: 2020 2020 2072 6573 6f6c 7665 5f61 6464       resolve_add
-00022a30: 7265 7373 3a20 626f 6f6c 203d 2054 7275  ress: bool = Tru
-00022a40: 652c 0a20 2020 2020 2020 206e 6f77 3a20  e,.        now: 
-00022a50: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
-00022a60: 6f6e 652c 0a20 2020 2020 2020 2072 6573  one,.        res
-00022a70: 6f75 7263 6573 3a20 6469 6374 5b73 7472  ources: dict[str
-00022a80: 2c20 666c 6f61 745d 207c 204e 6f6e 6520  , float] | None 
-00022a90: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00022aa0: 686f 7374 5f69 6e66 6f3a 2064 6963 7420  host_info: dict 
-00022ab0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00022ac0: 2020 2020 2020 206d 6574 7269 6373 3a20         metrics: 
-00022ad0: 6469 6374 2c0a 2020 2020 2020 2020 6578  dict,.        ex
-00022ae0: 6563 7574 696e 673a 2064 6963 745b 7374  ecuting: dict[st
-00022af0: 722c 2066 6c6f 6174 5d20 7c20 4e6f 6e65  r, float] | None
-00022b00: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00022b10: 2065 7874 656e 7369 6f6e 733a 2064 6963   extensions: dic
-00022b20: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-00022b30: 0a20 2020 2029 202d 3e20 6469 6374 5b73  .    ) -> dict[s
-00022b40: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
-00022b50: 2020 6164 6472 6573 7320 3d20 7365 6c66    address = self
-00022b60: 2e63 6f65 7263 655f 6164 6472 6573 7328  .coerce_address(
-00022b70: 6164 6472 6573 732c 2072 6573 6f6c 7665  address, resolve
-00022b80: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
-00022b90: 2020 6164 6472 6573 7320 3d20 6e6f 726d    address = norm
-00022ba0: 616c 697a 655f 6164 6472 6573 7328 6164  alize_address(ad
-00022bb0: 6472 6573 7329 0a20 2020 2020 2020 2077  dress).        w
-00022bc0: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-00022bd0: 2e67 6574 2861 6464 7265 7373 290a 2020  .get(address).  
-00022be0: 2020 2020 2020 6966 2077 7320 6973 204e        if ws is N
-00022bf0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00022c00: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00022c10: 6622 5265 6365 6976 6564 2068 6561 7274  f"Received heart
-00022c20: 6265 6174 2066 726f 6d20 756e 7265 6769  beat from unregi
-00022c30: 7374 6572 6564 2077 6f72 6b65 7220 7b61  stered worker {a
-00022c40: 6464 7265 7373 2172 7d2e 2229 0a20 2020  ddress!r}.").   
-00022c50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00022c60: 7b22 7374 6174 7573 223a 2022 6d69 7373  {"status": "miss
-00022c70: 696e 6722 7d0a 0a20 2020 2020 2020 2068  ing"}..        h
-00022c80: 6f73 7420 3d20 6765 745f 6164 6472 6573  ost = get_addres
-00022c90: 735f 686f 7374 2861 6464 7265 7373 290a  s_host(address).
-00022ca0: 2020 2020 2020 2020 6c6f 6361 6c5f 6e6f          local_no
-00022cb0: 7720 3d20 7469 6d65 2829 0a20 2020 2020  w = time().     
-00022cc0: 2020 2068 6f73 745f 696e 666f 203d 2068     host_info = h
-00022cd0: 6f73 745f 696e 666f 206f 7220 7b7d 0a0a  ost_info or {}..
-00022ce0: 2020 2020 2020 2020 6468 3a20 6469 6374          dh: dict
-00022cf0: 203d 2073 656c 662e 686f 7374 5f69 6e66   = self.host_inf
-00022d00: 6f2e 7365 7464 6566 6175 6c74 2868 6f73  o.setdefault(hos
-00022d10: 742c 207b 7d29 0a20 2020 2020 2020 2064  t, {}).        d
-00022d20: 685b 226c 6173 742d 7365 656e 225d 203d  h["last-seen"] =
-00022d30: 206c 6f63 616c 5f6e 6f77 0a0a 2020 2020   local_now..    
-00022d40: 2020 2020 6672 6163 203d 2031 202f 206c      frac = 1 / l
-00022d50: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-00022d60: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
-00022d70: 6e64 7769 6474 6820 3d20 280a 2020 2020  ndwidth = (.    
-00022d80: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-00022d90: 6477 6964 7468 202a 2028 3120 2d20 6672  dwidth * (1 - fr
-00022da0: 6163 2920 2b20 6d65 7472 6963 735b 2262  ac) + metrics["b
-00022db0: 616e 6477 6964 7468 225d 5b22 746f 7461  andwidth"]["tota
-00022dc0: 6c22 5d20 2a20 6672 6163 0a20 2020 2020  l"] * frac.     
-00022dd0: 2020 2029 0a20 2020 2020 2020 2066 6f72     ).        for
-00022de0: 206f 7468 6572 2c20 2862 772c 2063 6f75   other, (bw, cou
-00022df0: 6e74 2920 696e 206d 6574 7269 6373 5b22  nt) in metrics["
-00022e00: 6261 6e64 7769 6474 6822 5d5b 2277 6f72  bandwidth"]["wor
-00022e10: 6b65 7273 225d 2e69 7465 6d73 2829 3a0a  kers"].items():.
-00022e20: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00022e30: 6164 6472 6573 732c 206f 7468 6572 2920  address, other) 
-00022e40: 6e6f 7420 696e 2073 656c 662e 6261 6e64  not in self.band
-00022e50: 7769 6474 685f 776f 726b 6572 733a 0a20  width_workers:. 
-00022e60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00022e70: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
-00022e80: 726b 6572 735b 6164 6472 6573 732c 206f  rkers[address, o
-00022e90: 7468 6572 5d20 3d20 6277 202f 2063 6f75  ther] = bw / cou
-00022ea0: 6e74 0a20 2020 2020 2020 2020 2020 2065  nt.            e
-00022eb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00022ec0: 2020 2020 2061 6c70 6861 203d 2028 3120       alpha = (1 
-00022ed0: 2d20 6672 6163 2920 2a2a 2063 6f75 6e74  - frac) ** count
-00022ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022ef0: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
-00022f00: 776f 726b 6572 735b 6164 6472 6573 732c  workers[address,
-00022f10: 206f 7468 6572 5d20 3d20 7365 6c66 2e62   other] = self.b
-00022f20: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
-00022f30: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00022f40: 2020 2020 2020 6164 6472 6573 732c 206f        address, o
-00022f50: 7468 6572 0a20 2020 2020 2020 2020 2020  ther.           
-00022f60: 2020 2020 205d 202a 2061 6c70 6861 202b       ] * alpha +
-00022f70: 2062 7720 2a20 2831 202d 2061 6c70 6861   bw * (1 - alpha
-00022f80: 290a 2020 2020 2020 2020 666f 7220 7479  ).        for ty
-00022f90: 702c 2028 6277 2c20 636f 756e 7429 2069  p, (bw, count) i
-00022fa0: 6e20 6d65 7472 6963 735b 2262 616e 6477  n metrics["bandw
-00022fb0: 6964 7468 225d 5b22 7479 7065 7322 5d2e  idth"]["types"].
-00022fc0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00022fd0: 2020 2020 2069 6620 7479 7020 6e6f 7420       if typ not 
-00022fe0: 696e 2073 656c 662e 6261 6e64 7769 6474  in self.bandwidt
-00022ff0: 685f 7479 7065 733a 0a20 2020 2020 2020  h_types:.       
-00023000: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-00023010: 6e64 7769 6474 685f 7479 7065 735b 7479  ndwidth_types[ty
-00023020: 705d 203d 2062 7720 2f20 636f 756e 740a  p] = bw / count.
-00023030: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00023040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023050: 2020 616c 7068 6120 3d20 2831 202d 2066    alpha = (1 - f
-00023060: 7261 6329 202a 2a20 636f 756e 740a 2020  rac) ** count.  
-00023070: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00023080: 6c66 2e62 616e 6477 6964 7468 5f74 7970  lf.bandwidth_typ
-00023090: 6573 5b74 7970 5d20 3d20 7365 6c66 2e62  es[typ] = self.b
-000230a0: 616e 6477 6964 7468 5f74 7970 6573 5b74  andwidth_types[t
-000230b0: 7970 5d20 2a20 616c 7068 6120 2b20 6277  yp] * alpha + bw
-000230c0: 202a 2028 0a20 2020 2020 2020 2020 2020   * (.           
-000230d0: 2020 2020 2020 2020 2031 202d 2061 6c70           1 - alp
-000230e0: 6861 0a20 2020 2020 2020 2020 2020 2020  ha.             
-000230f0: 2020 2029 0a0a 2020 2020 2020 2020 7773     )..        ws
-00023100: 2e6c 6173 745f 7365 656e 203d 206c 6f63  .last_seen = loc
-00023110: 616c 5f6e 6f77 0a20 2020 2020 2020 2069  al_now.        i
-00023120: 6620 6578 6563 7574 696e 6720 6973 206e  f executing is n
-00023130: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00023140: 2020 2020 2023 204e 4f54 453a 2074 6865       # NOTE: the
-00023150: 2065 7865 6375 7469 6e67 2064 6963 7420   executing dict 
-00023160: 6973 2075 6e75 7365 640a 2020 2020 2020  is unused.      
-00023170: 2020 2020 2020 7773 2e65 7865 6375 7469        ws.executi
-00023180: 6e67 203d 207b 7d0a 2020 2020 2020 2020  ng = {}.        
-00023190: 2020 2020 666f 7220 6b65 792c 2064 7572      for key, dur
-000231a0: 6174 696f 6e20 696e 2065 7865 6375 7469  ation in executi
-000231b0: 6e67 2e69 7465 6d73 2829 3a0a 2020 2020  ng.items():.    
-000231c0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000231d0: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
-000231e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000231f0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00023200: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
-00023210: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00023220: 732e 6578 6563 7574 696e 675b 7473 5d20  s.executing[ts] 
-00023230: 3d20 6475 7261 7469 6f6e 0a20 2020 2020  = duration.     
-00023240: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00023250: 732e 7072 6566 6978 2e61 6464 5f65 7865  s.prefix.add_exe
-00023260: 635f 7469 6d65 2864 7572 6174 696f 6e29  c_time(duration)
-00023270: 0a0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
-00023280: 6d65 2c20 7661 6c75 6520 696e 206d 6574  me, value in met
-00023290: 7269 6373 5b22 6469 6765 7374 735f 746f  rics["digests_to
-000232a0: 7461 6c5f 7369 6e63 655f 6865 6172 7462  tal_since_heartb
-000232b0: 6561 7422 5d2e 6974 656d 7328 293a 0a20  eat"].items():. 
-000232c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000232d0: 6375 6d75 6c61 7469 7665 5f77 6f72 6b65  cumulative_worke
-000232e0: 725f 6d65 7472 6963 735b 6e61 6d65 5d20  r_metrics[name] 
-000232f0: 2b3d 2076 616c 7565 0a0a 2020 2020 2020  += value..      
-00023300: 2020 7773 2e6d 6574 7269 6373 203d 206d    ws.metrics = m
-00023310: 6574 7269 6373 0a0a 2020 2020 2020 2020  etrics..        
-00023320: 2320 4361 6c63 756c 6174 6520 5253 5320  # Calculate RSS 
-00023330: 2d20 6461 736b 206b 6579 732c 2073 6570  - dask keys, sep
-00023340: 6172 6174 696e 6720 226f 6c64 2220 616e  arating "old" an
-00023350: 6420 226e 6577 2220 7573 6167 650a 2020  d "new" usage.  
-00023360: 2020 2020 2020 2320 5365 6520 4d65 6d6f        # See Memo
-00023370: 7279 5374 6174 6520 666f 7220 6465 7461  ryState for deta
-00023380: 696c 730a 2020 2020 2020 2020 6d61 785f  ils.        max_
-00023390: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-000233a0: 5f6f 6c64 5f68 6973 745f 6167 6520 3d20  _old_hist_age = 
-000233b0: 6c6f 6361 6c5f 6e6f 7720 2d20 7365 6c66  local_now - self
-000233c0: 2e4d 454d 4f52 595f 5245 4345 4e54 5f54  .MEMORY_RECENT_T
-000233d0: 4f5f 4f4c 445f 5449 4d45 0a20 2020 2020  O_OLD_TIME.     
-000233e0: 2020 206d 656d 6f72 795f 756e 6d61 6e61     memory_unmana
-000233f0: 6765 645f 6f6c 6420 3d20 7773 2e5f 6d65  ged_old = ws._me
-00023400: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00023410: 6c64 0a20 2020 2020 2020 2077 6869 6c65  ld.        while
-00023420: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
-00023430: 6e61 6765 645f 6869 7374 6f72 793a 0a20  naged_history:. 
-00023440: 2020 2020 2020 2020 2020 2074 696d 6573             times
-00023450: 7461 6d70 2c20 7369 7a65 203d 2077 732e  tamp, size = ws.
-00023460: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
-00023470: 645f 6869 7374 6f72 795b 305d 0a20 2020  d_history[0].   
-00023480: 2020 2020 2020 2020 2069 6620 7469 6d65           if time
-00023490: 7374 616d 7020 3e3d 206d 6178 5f6d 656d  stamp >= max_mem
-000234a0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
-000234b0: 645f 6869 7374 5f61 6765 3a0a 2020 2020  d_hist_age:.    
-000234c0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-000234d0: 6b0a 2020 2020 2020 2020 2020 2020 7773  k.            ws
-000234e0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
-000234f0: 6564 5f68 6973 746f 7279 2e70 6f70 6c65  ed_history.pople
-00023500: 6674 2829 0a20 2020 2020 2020 2020 2020  ft().           
-00023510: 2069 6620 7369 7a65 203d 3d20 6d65 6d6f   if size == memo
-00023520: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-00023530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023540: 2020 6d65 6d6f 7279 5f75 6e6d 616e 6167    memory_unmanag
-00023550: 6564 5f6f 6c64 203d 2030 2020 2320 7265  ed_old = 0  # re
-00023560: 6361 6c63 756c 6174 6520 6d69 6e28 290a  calculate min().
-00023570: 0a20 2020 2020 2020 2023 2077 732e 5f6e  .        # ws._n
-00023580: 6279 7465 7320 6973 2075 7064 6174 6564  bytes is updated
-00023590: 2061 7420 6120 6469 6666 6572 656e 7420   at a different 
-000235a0: 7469 6d65 2061 6e64 2073 697a 656f 6628  time and sizeof(
-000235b0: 2920 6d61 7920 6e6f 7420 6265 2061 6363  ) may not be acc
-000235c0: 7572 6174 652c 0a20 2020 2020 2020 2023  urate,.        #
-000235d0: 2073 6f20 7369 7a65 206d 6179 2062 6520   so size may be 
-000235e0: 2874 656d 706f 7261 7269 6c79 2920 6e65  (temporarily) ne
-000235f0: 6761 7469 7665 3b20 666c 6f6f 7220 6974  gative; floor it
-00023600: 2074 6f20 7a65 726f 2e0a 2020 2020 2020   to zero..      
-00023610: 2020 7369 7a65 203d 206d 6178 280a 2020    size = max(.  
-00023620: 2020 2020 2020 2020 2020 302c 206d 6574            0, met
-00023630: 7269 6373 5b22 6d65 6d6f 7279 225d 202d  rics["memory"] -
-00023640: 2077 732e 6e62 7974 6573 202b 206d 6574   ws.nbytes + met
-00023650: 7269 6373 5b22 7370 696c 6c65 645f 6279  rics["spilled_by
-00023660: 7465 7322 5d5b 226d 656d 6f72 7922 5d0a  tes"]["memory"].
-00023670: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00023680: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
-00023690: 6d61 6e61 6765 645f 6869 7374 6f72 792e  managed_history.
-000236a0: 6170 7065 6e64 2828 6c6f 6361 6c5f 6e6f  append((local_no
-000236b0: 772c 2073 697a 6529 290a 2020 2020 2020  w, size)).      
-000236c0: 2020 6966 206e 6f74 206d 656d 6f72 795f    if not memory_
-000236d0: 756e 6d61 6e61 6765 645f 6f6c 643a 0a20  unmanaged_old:. 
-000236e0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-000236f0: 2077 6f72 6b65 7220 6861 7320 6a75 7374   worker has just
-00023700: 2062 6565 6e20 7374 6172 7465 6420 6f72   been started or
-00023710: 2074 6865 2070 7265 7669 6f75 7320 6d69   the previous mi
-00023720: 6e69 6d75 6d20 6861 7320 6265 656e 2065  nimum has been e
-00023730: 7870 756e 6765 640a 2020 2020 2020 2020  xpunged.        
-00023740: 2020 2020 2320 6265 6361 7573 6520 746f      # because to
-00023750: 6f20 6f6c 642e 0a20 2020 2020 2020 2020  o old..         
-00023760: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
-00023770: 616c 676f 7269 7468 6d20 6973 2063 6170  algorithm is cap
-00023780: 7065 6420 746f 2032 3030 202a 204d 454d  ped to 200 * MEM
-00023790: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
-000237a0: 445f 5449 4d45 2065 6c65 6d65 6e74 730a  D_TIME elements.
-000237b0: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
-000237c0: 7573 7465 722d 7769 6465 2062 7920 6865  uster-wide by he
-000237d0: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
-000237e0: 2829 2c20 7265 6761 7264 6c65 7373 206f  (), regardless o
-000237f0: 6620 7468 6520 6e75 6d62 6572 206f 6620  f the number of 
-00023800: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
-00023810: 2020 2020 7773 2e5f 6d65 6d6f 7279 5f75      ws._memory_u
-00023820: 6e6d 616e 6167 6564 5f6f 6c64 203d 206d  nmanaged_old = m
-00023830: 696e 286d 6170 2873 6563 6f6e 642c 2077  in(map(second, w
-00023840: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
-00023850: 6765 645f 6869 7374 6f72 7929 290a 2020  ged_history)).  
-00023860: 2020 2020 2020 656c 6966 2073 697a 6520        elif size 
-00023870: 3c20 6d65 6d6f 7279 5f75 6e6d 616e 6167  < memory_unmanag
-00023880: 6564 5f6f 6c64 3a0a 2020 2020 2020 2020  ed_old:.        
-00023890: 2020 2020 7773 2e5f 6d65 6d6f 7279 5f75      ws._memory_u
-000238a0: 6e6d 616e 6167 6564 5f6f 6c64 203d 2073  nmanaged_old = s
-000238b0: 697a 650a 0a20 2020 2020 2020 2069 6620  ize..        if 
-000238c0: 686f 7374 5f69 6e66 6f3a 0a20 2020 2020  host_info:.     
-000238d0: 2020 2020 2020 2064 6820 3d20 7365 6c66         dh = self
-000238e0: 2e68 6f73 745f 696e 666f 2e73 6574 6465  .host_info.setde
-000238f0: 6661 756c 7428 686f 7374 2c20 7b7d 290a  fault(host, {}).
-00023900: 2020 2020 2020 2020 2020 2020 6468 2e75              dh.u
-00023910: 7064 6174 6528 686f 7374 5f69 6e66 6f29  pdate(host_info)
-00023920: 0a0a 2020 2020 2020 2020 6966 206e 6f77  ..        if now
-00023930: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
-00023940: 2e74 696d 655f 6465 6c61 7920 3d20 6c6f  .time_delay = lo
-00023950: 6361 6c5f 6e6f 7720 2d20 6e6f 770a 0a20  cal_now - now.. 
-00023960: 2020 2020 2020 2069 6620 7265 736f 7572         if resour
-00023970: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-00023980: 2073 656c 662e 6164 645f 7265 736f 7572   self.add_resour
-00023990: 6365 7328 776f 726b 6572 3d61 6464 7265  ces(worker=addre
-000239a0: 7373 2c20 7265 736f 7572 6365 733d 7265  ss, resources=re
-000239b0: 736f 7572 6365 7329 0a0a 2020 2020 2020  sources)..      
-000239c0: 2020 6966 2065 7874 656e 7369 6f6e 733a    if extensions:
-000239d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000239e0: 206e 616d 652c 2064 6174 6120 696e 2065   name, data in e
-000239f0: 7874 656e 7369 6f6e 732e 6974 656d 7328  xtensions.items(
-00023a00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00023a10: 2020 2073 656c 662e 6578 7465 6e73 696f     self.extensio
-00023a20: 6e73 5b6e 616d 655d 2e68 6561 7274 6265  ns[name].heartbe
-00023a30: 6174 2877 732c 2064 6174 6129 0a0a 2020  at(ws, data)..  
-00023a40: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
-00023a50: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00023a60: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
-00023a70: 2020 2020 2020 2022 7469 6d65 223a 206c         "time": l
-00023a80: 6f63 616c 5f6e 6f77 2c0a 2020 2020 2020  ocal_now,.      
-00023a90: 2020 2020 2020 2268 6561 7274 6265 6174        "heartbeat
-00023aa0: 2d69 6e74 6572 7661 6c22 3a20 6865 6172  -interval": hear
-00023ab0: 7462 6561 745f 696e 7465 7276 616c 286c  tbeat_interval(l
-00023ac0: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-00023ad0: 292c 0a20 2020 2020 2020 207d 0a0a 2020  ),.        }..  
-00023ae0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-00023af0: 2020 6173 796e 6320 6465 6620 6164 645f    async def add_
-00023b00: 776f 726b 6572 280a 2020 2020 2020 2020  worker(.        
-00023b10: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
-00023b20: 6d6d 3a20 436f 6d6d 2c0a 2020 2020 2020  mm: Comm,.      
-00023b30: 2020 2a2c 0a20 2020 2020 2020 2061 6464    *,.        add
-00023b40: 7265 7373 3a20 7374 722c 0a20 2020 2020  ress: str,.     
-00023b50: 2020 2073 7461 7475 733a 2073 7472 2c0a     status: str,.
-00023b60: 2020 2020 2020 2020 7365 7276 6572 5f69          server_i
-00023b70: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
-00023b80: 6e74 6872 6561 6473 3a20 696e 742c 0a20  nthreads: int,. 
-00023b90: 2020 2020 2020 206e 616d 653a 2073 7472         name: str
-00023ba0: 2c0a 2020 2020 2020 2020 7265 736f 6c76  ,.        resolv
-00023bb0: 655f 6164 6472 6573 733a 2062 6f6f 6c20  e_address: bool 
-00023bc0: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-00023bd0: 6e6f 773a 2066 6c6f 6174 2c0a 2020 2020  now: float,.    
-00023be0: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
-00023bf0: 6963 745b 7374 722c 2066 6c6f 6174 5d2c  ict[str, float],
-00023c00: 0a20 2020 2020 2020 2023 2046 4958 4d45  .        # FIXME
-00023c10: 3a20 5468 6973 2069 7320 6e65 7665 7220  : This is never 
-00023c20: 7375 626d 6974 7465 6420 6279 2074 6865  submitted by the
-00023c30: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
-00023c40: 686f 7374 5f69 6e66 6f3a 204e 6f6e 6520  host_info: None 
-00023c50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00023c60: 6d65 6d6f 7279 5f6c 696d 6974 3a20 696e  memory_limit: in
-00023c70: 7420 7c20 4e6f 6e65 2c0a 2020 2020 2020  t | None,.      
-00023c80: 2020 6d65 7472 6963 733a 2064 6963 745b    metrics: dict[
-00023c90: 7374 722c 2041 6e79 5d2c 0a20 2020 2020  str, Any],.     
-00023ca0: 2020 2070 6964 3a20 696e 7420 3d20 302c     pid: int = 0,
-00023cb0: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
-00023cc0: 733a 2064 6963 745b 7374 722c 2069 6e74  s: dict[str, int
-00023cd0: 5d2c 0a20 2020 2020 2020 206c 6f63 616c  ],.        local
-00023ce0: 5f64 6972 6563 746f 7279 3a20 7374 722c  _directory: str,
-00023cf0: 0a20 2020 2020 2020 2076 6572 7369 6f6e  .        version
-00023d00: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
-00023d10: 5d2c 0a20 2020 2020 2020 206e 616e 6e79  ],.        nanny
-00023d20: 3a20 7374 722c 0a20 2020 2020 2020 2065  : str,.        e
-00023d30: 7874 7261 3a20 6469 6374 2c0a 2020 2020  xtra: dict,.    
-00023d40: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
-00023d50: 2073 7472 2c0a 2020 2020 2920 2d3e 204e   str,.    ) -> N
-00023d60: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00023d70: 4164 6420 6120 6e65 7720 776f 726b 6572  Add a new worker
-00023d80: 2074 6f20 7468 6520 636c 7573 7465 7222   to the cluster"
-00023d90: 2222 0a20 2020 2020 2020 2061 6464 7265  "".        addre
-00023da0: 7373 203d 2073 656c 662e 636f 6572 6365  ss = self.coerce
-00023db0: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
-00023dc0: 2c20 7265 736f 6c76 655f 6164 6472 6573  , resolve_addres
-00023dd0: 7329 0a20 2020 2020 2020 2061 6464 7265  s).        addre
-00023de0: 7373 203d 206e 6f72 6d61 6c69 7a65 5f61  ss = normalize_a
-00023df0: 6464 7265 7373 2861 6464 7265 7373 290a  ddress(address).
-00023e00: 2020 2020 2020 2020 686f 7374 203d 2067          host = g
-00023e10: 6574 5f61 6464 7265 7373 5f68 6f73 7428  et_address_host(
-00023e20: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
-00023e30: 2020 6966 2061 6464 7265 7373 2069 6e20    if address in 
-00023e40: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
-00023e50: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00023e60: 5661 6c75 6545 7272 6f72 2822 576f 726b  ValueError("Work
-00023e70: 6572 2061 6c72 6561 6479 2065 7869 7374  er already exist
-00023e80: 7320 2573 2220 2520 6164 6472 6573 7329  s %s" % address)
-00023e90: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
-00023ea0: 6520 696e 2073 656c 662e 616c 6961 7365  e in self.aliase
-00023eb0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-00023ec0: 6f67 6765 722e 7761 726e 696e 6728 2257  ogger.warning("W
-00023ed0: 6f72 6b65 7220 7472 6965 6420 746f 2063  orker tried to c
-00023ee0: 6f6e 6e65 6374 2077 6974 6820 6120 6475  onnect with a du
-00023ef0: 706c 6963 6174 6520 6e61 6d65 3a20 2573  plicate name: %s
-00023f00: 222c 206e 616d 6529 0a20 2020 2020 2020  ", name).       
-00023f10: 2020 2020 206d 7367 203d 207b 0a20 2020       msg = {.   
-00023f20: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-00023f30: 6174 7573 223a 2022 6572 726f 7222 2c0a  atus": "error",.
-00023f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f50: 226d 6573 7361 6765 223a 2022 6e61 6d65  "message": "name
-00023f60: 2074 616b 656e 2c20 2573 2220 2520 6e61   taken, %s" % na
-00023f70: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00023f80: 2020 2020 2274 696d 6522 3a20 7469 6d65      "time": time
-00023f90: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-00023fa0: 7d0a 2020 2020 2020 2020 2020 2020 6177  }.            aw
-00023fb0: 6169 7420 636f 6d6d 2e77 7269 7465 286d  ait comm.write(m
-00023fc0: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-00023fd0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-00023fe0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2861  self.log_event(a
-00023ff0: 6464 7265 7373 2c20 7b22 6163 7469 6f6e  ddress, {"action
-00024000: 223a 2022 6164 642d 776f 726b 6572 227d  ": "add-worker"}
-00024010: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-00024020: 6f67 5f65 7665 6e74 2822 616c 6c22 2c20  og_event("all", 
-00024030: 7b22 6163 7469 6f6e 223a 2022 6164 642d  {"action": "add-
-00024040: 776f 726b 6572 222c 2022 776f 726b 6572  worker", "worker
-00024050: 223a 2061 6464 7265 7373 7d29 0a0a 2020  ": address})..  
-00024060: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-00024070: 7273 5b61 6464 7265 7373 5d20 3d20 7773  rs[address] = ws
-00024080: 203d 2057 6f72 6b65 7253 7461 7465 280a   = WorkerState(.
-00024090: 2020 2020 2020 2020 2020 2020 6164 6472              addr
-000240a0: 6573 733d 6164 6472 6573 732c 0a20 2020  ess=address,.   
-000240b0: 2020 2020 2020 2020 2073 7461 7475 733d           status=
-000240c0: 5374 6174 7573 2e6c 6f6f 6b75 705b 7374  Status.lookup[st
-000240d0: 6174 7573 5d2c 2020 2320 7479 7065 3a20  atus],  # type: 
-000240e0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
-000240f0: 2020 2070 6964 3d70 6964 2c0a 2020 2020     pid=pid,.    
-00024100: 2020 2020 2020 2020 6e74 6872 6561 6473          nthreads
-00024110: 3d6e 7468 7265 6164 732c 0a20 2020 2020  =nthreads,.     
-00024120: 2020 2020 2020 206d 656d 6f72 795f 6c69         memory_li
-00024130: 6d69 743d 6d65 6d6f 7279 5f6c 696d 6974  mit=memory_limit
-00024140: 206f 7220 302c 0a20 2020 2020 2020 2020   or 0,.         
-00024150: 2020 206e 616d 653d 6e61 6d65 2c0a 2020     name=name,.  
-00024160: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
-00024170: 6469 7265 6374 6f72 793d 6c6f 6361 6c5f  directory=local_
-00024180: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
-00024190: 2020 2020 2020 2073 6572 7669 6365 733d         services=
-000241a0: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
-000241b0: 2020 2020 2020 7665 7273 696f 6e73 3d76        versions=v
-000241c0: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
-000241d0: 2020 2020 206e 616e 6e79 3d6e 616e 6e79       nanny=nanny
-000241e0: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
-000241f0: 7472 613d 6578 7472 612c 0a20 2020 2020  tra=extra,.     
-00024200: 2020 2020 2020 2073 6572 7665 725f 6964         server_id
-00024210: 3d73 6572 7665 725f 6964 2c0a 2020 2020  =server_id,.    
-00024220: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-00024230: 723d 7365 6c66 2c0a 2020 2020 2020 2020  r=self,.        
-00024240: 290a 2020 2020 2020 2020 6966 2077 732e  ).        if ws.
-00024250: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-00024260: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-00024270: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-00024280: 6e67 2e61 6464 2877 7329 0a0a 2020 2020  ng.add(ws)..    
-00024290: 2020 2020 6468 203d 2073 656c 662e 686f      dh = self.ho
-000242a0: 7374 5f69 6e66 6f2e 6765 7428 686f 7374  st_info.get(host
-000242b0: 290a 2020 2020 2020 2020 6966 2064 6820  ).        if dh 
-000242c0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000242d0: 2020 2020 2073 656c 662e 686f 7374 5f69       self.host_i
-000242e0: 6e66 6f5b 686f 7374 5d20 3d20 6468 203d  nfo[host] = dh =
-000242f0: 207b 7d0a 0a20 2020 2020 2020 2064 685f   {}..        dh_
-00024300: 6164 6472 6573 7365 7320 3d20 6468 2e67  addresses = dh.g
-00024310: 6574 2822 6164 6472 6573 7365 7322 290a  et("addresses").
-00024320: 2020 2020 2020 2020 6966 2064 685f 6164          if dh_ad
-00024330: 6472 6573 7365 7320 6973 204e 6f6e 653a  dresses is None:
-00024340: 0a20 2020 2020 2020 2020 2020 2064 685b  .            dh[
-00024350: 2261 6464 7265 7373 6573 225d 203d 2064  "addresses"] = d
-00024360: 685f 6164 6472 6573 7365 7320 3d20 7365  h_addresses = se
-00024370: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-00024380: 6468 5b22 6e74 6872 6561 6473 225d 203d  dh["nthreads"] =
-00024390: 2030 0a0a 2020 2020 2020 2020 6468 5f61   0..        dh_a
-000243a0: 6464 7265 7373 6573 2e61 6464 2861 6464  ddresses.add(add
-000243b0: 7265 7373 290a 2020 2020 2020 2020 6468  ress).        dh
-000243c0: 5b22 6e74 6872 6561 6473 225d 202b 3d20  ["nthreads"] += 
-000243d0: 6e74 6872 6561 6473 0a0a 2020 2020 2020  nthreads..      
-000243e0: 2020 7365 6c66 2e74 6f74 616c 5f6e 7468    self.total_nth
-000243f0: 7265 6164 7320 2b3d 206e 7468 7265 6164  reads += nthread
-00024400: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
-00024410: 6c69 6173 6573 5b6e 616d 655d 203d 2061  liases[name] = a
-00024420: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
-00024430: 7365 6c66 2e68 6561 7274 6265 6174 5f77  self.heartbeat_w
-00024440: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
-00024450: 2020 2061 6464 7265 7373 3d61 6464 7265     address=addre
-00024460: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-00024470: 7265 736f 6c76 655f 6164 6472 6573 733d  resolve_address=
-00024480: 7265 736f 6c76 655f 6164 6472 6573 732c  resolve_address,
-00024490: 0a20 2020 2020 2020 2020 2020 206e 6f77  .            now
-000244a0: 3d6e 6f77 2c0a 2020 2020 2020 2020 2020  =now,.          
-000244b0: 2020 7265 736f 7572 6365 733d 7265 736f    resources=reso
-000244c0: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
-000244d0: 2020 2068 6f73 745f 696e 666f 3d68 6f73     host_info=hos
-000244e0: 745f 696e 666f 2c0a 2020 2020 2020 2020  t_info,.        
-000244f0: 2020 2020 6d65 7472 6963 733d 6d65 7472      metrics=metr
-00024500: 6963 732c 0a20 2020 2020 2020 2029 0a0a  ics,.        )..
-00024510: 2020 2020 2020 2020 2320 446f 206e 6f74          # Do not
-00024520: 206e 6565 6420 746f 2061 646a 7573 7420   need to adjust 
-00024530: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
-00024540: 616e 6379 2061 7320 7365 6c66 2e6f 6363  ancy as self.occ
-00024550: 7570 616e 6379 5b77 735d 2063 616e 6e6f  upancy[ws] canno
-00024560: 740a 2020 2020 2020 2020 2320 6578 6973  t.        # exis
-00024570: 7420 6265 666f 7265 2074 6869 732e 0a20  t before this.. 
-00024580: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
-00024590: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
-000245a0: 2877 7329 0a0a 2020 2020 2020 2020 7365  (ws)..        se
-000245b0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-000245c0: 6164 6472 6573 735d 203d 2042 6174 6368  address] = Batch
-000245d0: 6564 5365 6e64 2869 6e74 6572 7661 6c3d  edSend(interval=
-000245e0: 2235 6d73 222c 206c 6f6f 703d 7365 6c66  "5ms", loop=self
-000245f0: 2e6c 6f6f 7029 0a0a 2020 2020 2020 2020  .loop)..        
-00024600: 6177 6169 7461 626c 6573 203d 205b 5d0a  awaitables = [].
-00024610: 2020 2020 2020 2020 666f 7220 706c 7567          for plug
-00024620: 696e 2069 6e20 6c69 7374 2873 656c 662e  in in list(self.
-00024630: 706c 7567 696e 732e 7661 6c75 6573 2829  plugins.values()
-00024640: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-00024650: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00024660: 2020 2020 7265 7375 6c74 203d 2070 6c75      result = plu
-00024670: 6769 6e2e 6164 645f 776f 726b 6572 2873  gin.add_worker(s
-00024680: 6368 6564 756c 6572 3d73 656c 662c 2077  cheduler=self, w
-00024690: 6f72 6b65 723d 6164 6472 6573 7329 0a20  orker=address). 
-000246a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000246b0: 6620 7265 7375 6c74 2069 7320 6e6f 7420  f result is not 
-000246c0: 4e6f 6e65 2061 6e64 2069 6e73 7065 6374  None and inspect
-000246d0: 2e69 7361 7761 6974 6162 6c65 2872 6573  .isawaitable(res
-000246e0: 756c 7429 3a0a 2020 2020 2020 2020 2020  ult):.          
-000246f0: 2020 2020 2020 2020 2020 6177 6169 7461            awaita
-00024700: 626c 6573 2e61 7070 656e 6428 7265 7375  bles.append(resu
-00024710: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-00024720: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00024730: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00024740: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-00024750: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
-00024760: 2020 2020 706c 7567 696e 5f6d 7367 7320      plugin_msgs 
-00024770: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-00024780: 6761 7468 6572 282a 6177 6169 7461 626c  gather(*awaitabl
-00024790: 6573 2c20 7265 7475 726e 5f65 7863 6570  es, return_excep
-000247a0: 7469 6f6e 733d 5472 7565 290a 2020 2020  tions=True).    
-000247b0: 2020 2020 706c 7567 696e 735f 6578 6365      plugins_exce
-000247c0: 7074 696f 6e73 203d 205b 6d73 6720 666f  ptions = [msg fo
-000247d0: 7220 6d73 6720 696e 2070 6c75 6769 6e5f  r msg in plugin_
-000247e0: 6d73 6773 2069 6620 6973 696e 7374 616e  msgs if isinstan
-000247f0: 6365 286d 7367 2c20 4578 6365 7074 696f  ce(msg, Exceptio
-00024800: 6e29 5d0a 2020 2020 2020 2020 666f 7220  n)].        for 
-00024810: 6578 6320 696e 2070 6c75 6769 6e73 5f65  exc in plugins_e
-00024820: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
-00024830: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-00024840: 6365 7074 696f 6e28 6578 632c 2065 7863  ception(exc, exc
-00024850: 5f69 6e66 6f3d 6578 6329 0a0a 2020 2020  _info=exc)..    
-00024860: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
-00024870: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-00024880: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00024890: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
-000248a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000248b0: 2020 7365 6c66 2e62 756c 6b5f 7363 6865    self.bulk_sche
-000248c0: 6475 6c65 5f75 6e72 756e 6e61 626c 655f  dule_unrunnable_
-000248d0: 6166 7465 725f 6164 6469 6e67 5f77 6f72  after_adding_wor
-000248e0: 6b65 7228 7773 292c 2073 7469 6d75 6c75  ker(ws), stimulu
-000248f0: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
-00024900: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-00024910: 656c 662e 7374 696d 756c 7573 5f71 7565  elf.stimulus_que
-00024920: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
-00024930: 7065 6e65 6428 7374 696d 756c 7573 5f69  pened(stimulus_i
-00024940: 643d 7374 696d 756c 7573 5f69 6429 0a0a  d=stimulus_id)..
-00024950: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00024960: 6e66 6f28 2252 6567 6973 7465 7220 776f  nfo("Register wo
-00024970: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
-00024980: 2020 2020 2020 206d 7367 203d 207b 0a20         msg = {. 
-00024990: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-000249a0: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
-000249b0: 2020 2020 2020 2022 7469 6d65 223a 2074         "time": t
-000249c0: 696d 6528 292c 0a20 2020 2020 2020 2020  ime(),.         
-000249d0: 2020 2022 6865 6172 7462 6561 742d 696e     "heartbeat-in
-000249e0: 7465 7276 616c 223a 2068 6561 7274 6265  terval": heartbe
-000249f0: 6174 5f69 6e74 6572 7661 6c28 6c65 6e28  at_interval(len(
-00024a00: 7365 6c66 2e77 6f72 6b65 7273 2929 2c0a  self.workers)),.
-00024a10: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-00024a20: 6b65 722d 706c 7567 696e 7322 3a20 7365  ker-plugins": se
-00024a30: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
-00024a40: 732c 0a20 2020 2020 2020 207d 0a0a 2020  s,.        }..  
-00024a50: 2020 2020 2020 7665 7273 696f 6e5f 7761        version_wa
-00024a60: 726e 696e 6720 3d20 7665 7273 696f 6e5f  rning = version_
-00024a70: 6d6f 6475 6c65 2e65 7272 6f72 5f6d 6573  module.error_mes
-00024a80: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
-00024a90: 2020 7665 7273 696f 6e5f 6d6f 6475 6c65    version_module
-00024aa0: 2e67 6574 5f76 6572 7369 6f6e 7328 292c  .get_versions(),
-00024ab0: 0a20 2020 2020 2020 2020 2020 207b 773a  .            {w:
-00024ac0: 2077 732e 7665 7273 696f 6e73 2066 6f72   ws.versions for
-00024ad0: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-00024ae0: 6f72 6b65 7273 2e69 7465 6d73 2829 7d2c  orkers.items()},
-00024af0: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
-00024b00: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
-00024b10: 2020 2073 6f75 7263 655f 6e61 6d65 3d73     source_name=s
-00024b20: 7472 2877 732e 7365 7276 6572 5f69 6429  tr(ws.server_id)
-00024b30: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00024b40: 2020 2020 6d73 672e 7570 6461 7465 2876      msg.update(v
-00024b50: 6572 7369 6f6e 5f77 6172 6e69 6e67 290a  ersion_warning).
-00024b60: 0a20 2020 2020 2020 2061 7761 6974 2063  .        await c
-00024b70: 6f6d 6d2e 7772 6974 6528 6d73 6729 0a20  omm.write(msg). 
-00024b80: 2020 2020 2020 2023 2054 6869 7320 7769         # This wi
-00024b90: 6c6c 206b 6565 7020 7275 6e6e 696e 6720  ll keep running 
-00024ba0: 756e 7469 6c20 7468 6520 776f 726b 6572  until the worker
-00024bb0: 2069 7320 7265 6d6f 7665 640a 2020 2020   is removed.    
-00024bc0: 2020 2020 6177 6169 7420 7365 6c66 2e68      await self.h
-00024bd0: 616e 646c 655f 776f 726b 6572 2863 6f6d  andle_worker(com
-00024be0: 6d2c 2061 6464 7265 7373 290a 0a20 2020  m, address)..   
-00024bf0: 2061 7379 6e63 2064 6566 2061 6464 5f6e   async def add_n
-00024c00: 616e 6e79 2873 656c 6629 202d 3e20 6469  anny(self) -> di
-00024c10: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
-00024c20: 2020 2020 2020 6d73 6720 3d20 7b0a 2020        msg = {.  
-00024c30: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-00024c40: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-00024c50: 2020 2020 2020 226e 616e 6e79 2d70 6c75        "nanny-plu
-00024c60: 6769 6e73 223a 2073 656c 662e 6e61 6e6e  gins": self.nann
-00024c70: 795f 706c 7567 696e 732c 0a20 2020 2020  y_plugins,.     
-00024c80: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-00024c90: 7572 6e20 6d73 670a 0a20 2020 2064 6566  urn msg..    def
-00024ca0: 2075 7064 6174 655f 6772 6170 6828 0a20   update_graph(. 
-00024cb0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00024cc0: 2020 2020 2063 6c69 656e 743a 2073 7472       client: str
-00024cd0: 2c0a 2020 2020 2020 2020 6772 6170 685f  ,.        graph_
-00024ce0: 6865 6164 6572 3a20 6469 6374 2c0a 2020  header: dict,.  
-00024cf0: 2020 2020 2020 6772 6170 685f 6672 616d        graph_fram
-00024d00: 6573 3a20 6c69 7374 5b62 7974 6573 5d2c  es: list[bytes],
-00024d10: 0a20 2020 2020 2020 206b 6579 733a 206c  .        keys: l
-00024d20: 6973 745b 7374 725d 2c0a 2020 2020 2020  ist[str],.      
-00024d30: 2020 696e 7465 726e 616c 5f70 7269 6f72    internal_prior
-00024d40: 6974 793a 2064 6963 745b 7374 722c 2069  ity: dict[str, i
-00024d50: 6e74 5d20 7c20 4e6f 6e65 2c0a 2020 2020  nt] | None,.    
-00024d60: 2020 2020 7375 626d 6974 7469 6e67 5f74      submitting_t
-00024d70: 6173 6b3a 2073 7472 207c 204e 6f6e 652c  ask: str | None,
-00024d80: 0a20 2020 2020 2020 2075 7365 725f 7072  .        user_pr
-00024d90: 696f 7269 7479 3a20 696e 7420 7c20 6469  iority: int | di
-00024da0: 6374 5b73 7472 2c20 696e 745d 203d 2030  ct[str, int] = 0
-00024db0: 2c0a 2020 2020 2020 2020 6163 746f 7273  ,.        actors
-00024dc0: 3a20 626f 6f6c 207c 206c 6973 745b 7374  : bool | list[st
-00024dd0: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
-00024de0: 2c0a 2020 2020 2020 2020 6669 666f 5f74  ,.        fifo_t
-00024df0: 696d 656f 7574 3a20 666c 6f61 7420 3d20  imeout: float = 
-00024e00: 302e 302c 0a20 2020 2020 2020 2063 6f64  0.0,.        cod
-00024e10: 653a 2074 7570 6c65 5b73 7472 5d20 7c20  e: tuple[str] | 
-00024e20: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00024e30: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
-00024e40: 3a20 6469 6374 207c 204e 6f6e 6520 3d20  : dict | None = 
-00024e50: 4e6f 6e65 2c0a 2020 2020 2020 2020 7374  None,.        st
-00024e60: 696d 756c 7573 5f69 643a 2073 7472 207c  imulus_id: str |
-00024e70: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00024e80: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00024e90: 2020 2020 2073 7461 7274 203d 2074 696d       start = tim
-00024ea0: 6528 290a 2020 2020 2020 2020 7472 793a  e().        try:
-00024eb0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00024ec0: 4f44 4f3a 2064 6573 6572 6961 6c69 7a61  ODO: deserializa
-00024ed0: 7469 6f6e 202b 206d 6174 6572 6961 6c69  tion + materiali
-00024ee0: 7a61 7469 6f6e 2073 686f 756c 6420 6265  zation should be
-00024ef0: 206f 6666 6c6f 6164 6564 2074 6f20 610a   offloaded to a.
-00024f00: 2020 2020 2020 2020 2020 2020 2320 7468              # th
-00024f10: 7265 6164 2073 696e 6365 2074 6869 7320  read since this 
-00024f20: 6973 206e 6f6e 2d74 7269 7669 616c 2063  is non-trivial c
-00024f30: 6f6d 7075 7465 2074 696d 6520 7468 6174  ompute time that
-00024f40: 2062 6c6f 636b 7320 7468 650a 2020 2020   blocks the.    
-00024f50: 2020 2020 2020 2020 2320 6576 656e 7420          # event 
-00024f60: 6c6f 6f70 2e20 5468 6973 206c 696b 656c  loop. This likel
-00024f70: 7920 7265 7175 6972 6573 2075 7320 746f  y requires us to
-00024f80: 2075 7365 2061 206c 6f63 6b20 7369 6e63   use a lock sinc
-00024f90: 6520 7765 206e 6565 6420 746f 0a20 2020  e we need to.   
-00024fa0: 2020 2020 2020 2020 2023 2067 7561 7261           # guara
-00024fb0: 6e74 6565 206f 7264 6572 696e 6720 6f66  ntee ordering of
-00024fc0: 2075 7064 6174 655f 6772 6170 6820 6361   update_graph ca
-00024fd0: 6c6c 7320 2861 7320 6c6f 6e67 2061 7320  lls (as long as 
-00024fe0: 7468 6572 6520 6973 206a 7573 740a 2020  there is just.  
-00024ff0: 2020 2020 2020 2020 2020 2320 6120 7369            # a si
-00025000: 6e67 6c65 206f 6666 6c6f 6164 2074 6872  ngle offload thr
-00025010: 6561 642c 2074 6869 7320 6973 206e 6f74  ead, this is not
-00025020: 2061 2070 726f 626c 656d 290a 2020 2020   a problem).    
-00025030: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-00025040: 7472 6962 7574 6564 2e70 726f 746f 636f  tributed.protoco
-00025050: 6c20 696d 706f 7274 2064 6573 6572 6961  l import deseria
-00025060: 6c69 7a65 0a0a 2020 2020 2020 2020 2020  lize..          
-00025070: 2020 6772 6170 6820 3d20 6465 7365 7269    graph = deseri
-00025080: 616c 697a 6528 6772 6170 685f 6865 6164  alize(graph_head
-00025090: 6572 2c20 6772 6170 685f 6672 616d 6573  er, graph_frames
-000250a0: 292e 6461 7461 0a20 2020 2020 2020 2065  ).data.        e
-000250b0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-000250c0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-000250d0: 2020 6d73 6720 3d20 2222 225c 0a20 2020    msg = """\.   
-000250e0: 2020 2020 2020 2020 2020 2020 2045 7272               Err
-000250f0: 6f72 2064 7572 696e 6720 6465 7365 7269  or during deseri
-00025100: 616c 697a 6174 696f 6e20 6f66 2074 6865  alization of the
-00025110: 2074 6173 6b20 6772 6170 682e 2054 6869   task graph. Thi
-00025120: 7320 6672 6571 7565 6e74 6c79 206f 6363  s frequently occ
-00025130: 7572 7320 6966 2074 6865 2053 6368 6564  urs if the Sched
-00025140: 756c 6572 2061 6e64 2043 6c69 656e 7420  uler and Client 
-00025150: 6861 7665 2064 6966 6665 7265 6e74 2065  have different e
-00025160: 6e76 6972 6f6e 6d65 6e74 732e 2046 6f72  nvironments. For
-00025170: 206d 6f72 6520 696e 666f 726d 6174 696f   more informatio
-00025180: 6e2c 2073 6565 2068 7474 7073 3a2f 2f64  n, see https://d
-00025190: 6f63 732e 6461 736b 2e6f 7267 2f65 6e2f  ocs.dask.org/en/
-000251a0: 7374 6162 6c65 2f64 6570 6c6f 796d 656e  stable/deploymen
-000251b0: 742d 636f 6e73 6964 6572 6174 696f 6e73  t-considerations
-000251c0: 2e68 746d 6c23 636f 6e73 6973 7465 6e74  .html#consistent
-000251d0: 2d73 6f66 7477 6172 652d 656e 7669 726f  -software-enviro
-000251e0: 6e6d 656e 7473 0a20 2020 2020 2020 2020  nments.         
-000251f0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
-00025200: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00025210: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00025220: 6e74 696d 6545 7272 6f72 2874 6578 7477  ntimeError(textw
-00025230: 7261 702e 6465 6465 6e74 286d 7367 2929  rap.dedent(msg))
-00025240: 2066 726f 6d20 650a 2020 2020 2020 2020   from e.        
-00025250: 2020 2020 6578 6365 7074 2052 756e 7469      except Runti
-00025260: 6d65 4572 726f 7220 6173 2065 3a0a 2020  meError as e:.  
-00025270: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00025280: 7220 3d20 6572 726f 725f 6d65 7373 6167  r = error_messag
-00025290: 6528 6529 0a20 2020 2020 2020 2020 2020  e(e).           
-000252a0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-000252b0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-000252c0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000252d0: 6570 6f72 7428 0a20 2020 2020 2020 2020  eport(.         
-000252e0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-000252f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025300: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-00025310: 223a 2022 7461 736b 2d65 7272 6564 222c  ": "task-erred",
-00025320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025330: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-00025340: 7922 3a20 6b65 792c 0a20 2020 2020 2020  y": key,.       
-00025350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025360: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
-00025370: 3a20 6572 725b 2265 7863 6570 7469 6f6e  : err["exception
-00025380: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00025390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253a0: 2274 7261 6365 6261 636b 223a 2065 7272  "traceback": err
-000253b0: 5b22 7472 6163 6562 6163 6b22 5d2c 0a20  ["traceback"],. 
-000253c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253d0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000253e0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-000253f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00025400: 726e 0a20 2020 2020 2020 2061 6e6e 6f74  rn.        annot
-00025410: 6174 696f 6e73 203d 2061 6e6e 6f74 6174  ations = annotat
-00025420: 696f 6e73 206f 7220 7b7d 0a20 2020 2020  ions or {}.     
-00025430: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00025440: 2861 6e6e 6f74 6174 696f 6e73 2c20 546f  (annotations, To
-00025450: 5069 636b 6c65 293a 2020 2320 7479 7065  Pickle):  # type
-00025460: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00025470: 2020 2020 2023 2046 4958 4d45 3a20 7768       # FIXME: wh
-00025480: 6174 2074 6865 2068 6563 6b3f 0a20 2020  at the heck?.   
-00025490: 2020 2020 2020 2020 2061 6e6e 6f74 6174           annotat
-000254a0: 696f 6e73 203d 2061 6e6e 6f74 6174 696f  ions = annotatio
-000254b0: 6e73 2e64 6174 6120 2023 2074 7970 653a  ns.data  # type:
-000254c0: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
-000254d0: 7374 696d 756c 7573 5f69 6420 3d20 7374  stimulus_id = st
-000254e0: 696d 756c 7573 5f69 6420 6f72 2066 2275  imulus_id or f"u
-000254f0: 7064 6174 652d 6772 6170 682d 7b74 696d  pdate-graph-{tim
-00025500: 6528 297d 220a 2020 2020 2020 2020 280a  e()}".        (.
-00025510: 2020 2020 2020 2020 2020 2020 6473 6b2c              dsk,
-00025520: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
-00025530: 656e 6465 6e63 6965 732c 0a20 2020 2020  endencies,.     
-00025540: 2020 2020 2020 206c 6179 6572 5f61 6e6e         layer_ann
-00025550: 6f74 6174 696f 6e73 2c0a 2020 2020 2020  otations,.      
-00025560: 2020 2020 2020 7072 655f 7374 7269 6e67        pre_string
-00025570: 6966 6965 645f 6b65 7973 2c0a 2020 2020  ified_keys,.    
-00025580: 2020 2020 2920 3d20 7365 6c66 2e6d 6174      ) = self.mat
-00025590: 6572 6961 6c69 7a65 5f67 7261 7068 2867  erialize_graph(g
-000255a0: 7261 7068 290a 0a20 2020 2020 2020 2072  raph)..        r
-000255b0: 6571 7565 7374 6564 5f6b 6579 7320 3d20  equested_keys = 
-000255c0: 7365 7428 6b65 7973 290a 2020 2020 2020  set(keys).      
-000255d0: 2020 6465 6c20 6b65 7973 0a20 2020 2020    del keys.     
-000255e0: 2020 2069 6620 6c65 6e28 6473 6b29 203e     if len(dsk) >
-000255f0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00025600: 7365 6c66 2e6c 6f67 5f65 7665 6e74 280a  self.log_event(.
+00021be0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00021bf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00021c00: 2020 2020 2020 2020 2020 6622 4661 696c            f"Fail
+00021c10: 6564 2074 6f20 666f 726d 6174 2064 6173  ed to format das
+00021c20: 6862 6f61 7264 206c 696e 6b2c 2075 6e6b  hboard link, unk
+00021c30: 6e6f 776e 2076 616c 7565 3a20 7b65 7d22  nown value: {e}"
+00021c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021c50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00021c60: 2020 2020 2020 2020 2020 206c 696e 6b20             link 
+00021c70: 3d20 6622 3a7b 7365 7276 6572 2e70 6f72  = f":{server.por
+00021c80: 747d 220a 2020 2020 2020 2020 2020 2020  t}".            
+00021c90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00021ca0: 2020 2020 2020 6c69 6e6b 203d 2066 227b        link = f"{
+00021cb0: 6c69 7374 656e 5f69 707d 3a7b 7365 7276  listen_ip}:{serv
+00021cc0: 6572 2e70 6f72 747d 220a 2020 2020 2020  er.port}".      
+00021cd0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00021ce0: 6f28 2225 3131 7320 6174 3a20 2025 3235  o("%11s at:  %25
+00021cf0: 7322 2c20 6e61 6d65 2c20 6c69 6e6b 290a  s", name, link).
+00021d00: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00021d10: 2e73 6368 6564 756c 6572 5f66 696c 653a  .scheduler_file:
+00021d20: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00021d30: 6820 6f70 656e 2873 656c 662e 7363 6865  h open(self.sche
+00021d40: 6475 6c65 725f 6669 6c65 2c20 2277 2229  duler_file, "w")
+00021d50: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+00021d60: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
+00021d70: 2873 656c 662e 6964 656e 7469 7479 2829  (self.identity()
+00021d80: 2c20 662c 2069 6e64 656e 743d 3229 0a0a  , f, indent=2)..
+00021d90: 2020 2020 2020 2020 2020 2020 666e 203d              fn =
+00021da0: 2073 656c 662e 7363 6865 6475 6c65 725f   self.scheduler_
+00021db0: 6669 6c65 2020 2320 7265 6d6f 7665 2066  file  # remove f
+00021dc0: 696c 6520 7768 656e 2077 6520 636c 6f73  ile when we clos
+00021dd0: 6520 7468 6520 7072 6f63 6573 730a 0a20  e the process.. 
+00021de0: 2020 2020 2020 2020 2020 2064 6566 2064             def d
+00021df0: 656c 5f73 6368 6564 756c 6572 5f66 696c  el_scheduler_fil
+00021e00: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+00021e10: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
+00021e20: 6578 6973 7473 2866 6e29 3a0a 2020 2020  exists(fn):.    
+00021e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e40: 6f73 2e72 656d 6f76 6528 666e 290a 0a20  os.remove(fn).. 
+00021e50: 2020 2020 2020 2020 2020 2077 6561 6b72             weakr
+00021e60: 6566 2e66 696e 616c 697a 6528 7365 6c66  ef.finalize(self
+00021e70: 2c20 6465 6c5f 7363 6865 6475 6c65 725f  , del_scheduler_
+00021e80: 6669 6c65 290a 0a20 2020 2020 2020 2066  file)..        f
+00021e90: 6f72 2070 7265 6c6f 6164 2069 6e20 7365  or preload in se
+00021ea0: 6c66 2e70 7265 6c6f 6164 733a 0a20 2020  lf.preloads:.   
+00021eb0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00021ec0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00021ed0: 6169 7420 7072 656c 6f61 642e 7374 6172  ait preload.star
+00021ee0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00021ef0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00021f00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021f10: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+00021f20: 6f6e 2822 4661 696c 6564 2074 6f20 7374  on("Failed to st
+00021f30: 6172 7420 7072 656c 6f61 6422 290a 0a20  art preload").. 
+00021f40: 2020 2020 2020 2069 6620 7365 6c66 2e6a         if self.j
+00021f50: 7570 7974 6572 3a0a 2020 2020 2020 2020  upyter:.        
+00021f60: 2020 2020 2320 416c 6c6f 7720 696e 7365      # Allow inse
+00021f70: 6375 7265 2063 6f6d 6d75 6e69 6361 7469  cure communicati
+00021f80: 6f6e 7320 6672 6f6d 206c 6f63 616c 2075  ons from local u
+00021f90: 7365 7273 0a20 2020 2020 2020 2020 2020  sers.           
+00021fa0: 2069 6620 7365 6c66 2e61 6464 7265 7373   if self.address
+00021fb0: 2e73 7461 7274 7377 6974 6828 2274 6c73  .startswith("tls
+00021fc0: 3a2f 2f22 293a 0a20 2020 2020 2020 2020  ://"):.         
+00021fd0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+00021fe0: 662e 6c69 7374 656e 2822 7463 703a 2f2f  f.listen("tcp://
+00021ff0: 6c6f 6361 6c68 6f73 743a 3022 290a 2020  localhost:0").  
+00022000: 2020 2020 2020 2020 2020 6f73 2e65 6e76            os.env
+00022010: 6972 6f6e 5b22 4441 534b 5f53 4348 4544  iron["DASK_SCHED
+00022020: 554c 4552 5f41 4444 5245 5353 225d 203d  ULER_ADDRESS"] =
+00022030: 2073 656c 662e 6c69 7374 656e 6572 735b   self.listeners[
+00022040: 2d31 5d2e 636f 6e74 6163 745f 6164 6472  -1].contact_addr
+00022050: 6573 730a 0a20 2020 2020 2020 2061 7761  ess..        awa
+00022060: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+00022070: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+00022080: 5b70 6c75 6769 6e2e 7374 6172 7428 7365  [plugin.start(se
+00022090: 6c66 2920 666f 7220 706c 7567 696e 2069  lf) for plugin i
+000220a0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+000220b0: 696e 732e 7661 6c75 6573 2829 295d 0a20  ins.values())]. 
+000220c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000220d0: 2020 7365 6c66 2e73 7461 7274 5f70 6572    self.start_per
+000220e0: 696f 6469 635f 6361 6c6c 6261 636b 7328  iodic_callbacks(
+000220f0: 290a 0a20 2020 2020 2020 2073 6574 7072  )..        setpr
+00022100: 6f63 7469 746c 6528 6622 6461 736b 2073  octitle(f"dask s
+00022110: 6368 6564 756c 6572 205b 7b73 656c 662e  cheduler [{self.
+00022120: 6164 6472 6573 737d 5d22 290a 2020 2020  address}]").    
+00022130: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
+00022140: 0a20 2020 2061 7379 6e63 2064 6566 2063  .    async def c
+00022150: 6c6f 7365 2873 656c 662c 2066 6173 743d  lose(self, fast=
+00022160: 4e6f 6e65 2c20 636c 6f73 655f 776f 726b  None, close_work
+00022170: 6572 733d 4e6f 6e65 293a 0a20 2020 2020  ers=None):.     
+00022180: 2020 2022 2222 5365 6e64 2063 6c65 616e     """Send clean
+00022190: 7570 2073 6967 6e61 6c20 746f 2061 6c6c  up signal to all
+000221a0: 2063 6f72 6f75 7469 6e65 7320 7468 656e   coroutines then
+000221b0: 2077 6169 7420 756e 7469 6c20 6669 6e69   wait until fini
+000221c0: 7368 6564 0a0a 2020 2020 2020 2020 5365  shed..        Se
+000221d0: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
+000221e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+000221f0: 5363 6865 6475 6c65 722e 636c 6561 6e75  Scheduler.cleanu
+00022200: 700a 2020 2020 2020 2020 2222 220a 2020  p.        """.  
+00022210: 2020 2020 2020 6966 2066 6173 7420 6973        if fast is
+00022220: 206e 6f74 204e 6f6e 6520 6f72 2063 6c6f   not None or clo
+00022230: 7365 5f77 6f72 6b65 7273 2069 7320 6e6f  se_workers is no
+00022240: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00022250: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00022260: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00022270: 2020 2022 5468 6520 2766 6173 7427 2061     "The 'fast' a
+00022280: 6e64 2027 636c 6f73 655f 776f 726b 6572  nd 'close_worker
+00022290: 7327 2070 6172 616d 6574 6572 7320 696e  s' parameters in
+000222a0: 2053 6368 6564 756c 6572 2e63 6c6f 7365   Scheduler.close
+000222b0: 2068 6176 6520 6e6f 2065 6666 6563 7420   have no effect 
+000222c0: 616e 6420 7769 6c6c 2062 6520 7265 6d6f  and will be remo
+000222d0: 7665 6420 696e 2061 2066 7574 7572 6520  ved in a future 
+000222e0: 7665 7273 696f 6e20 6f66 2064 6973 7472  version of distr
+000222f0: 6962 7574 6564 2e22 2c0a 2020 2020 2020  ibuted.",.      
+00022300: 2020 2020 2020 2020 2020 4675 7475 7265            Future
+00022310: 5761 726e 696e 672c 0a20 2020 2020 2020  Warning,.       
+00022320: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+00022330: 6620 7365 6c66 2e73 7461 7475 7320 696e  f self.status in
+00022340: 2028 5374 6174 7573 2e63 6c6f 7369 6e67   (Status.closing
+00022350: 2c20 5374 6174 7573 2e63 6c6f 7365 6429  , Status.closed)
+00022360: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00022370: 6169 7420 7365 6c66 2e66 696e 6973 6865  ait self.finishe
+00022380: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
+00022390: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+000223a0: 6173 796e 6320 6465 6620 6c6f 675f 6572  async def log_er
+000223b0: 726f 7273 2866 756e 6329 3a0a 2020 2020  rors(func):.    
+000223c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000223d0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+000223e0: 6974 2066 756e 6328 290a 2020 2020 2020  it func().      
+000223f0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00022400: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00022410: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+00022420: 7863 6570 7469 6f6e 2822 506c 7567 696e  xception("Plugin
+00022430: 2063 616c 6c20 6661 696c 6564 2064 7572   call failed dur
+00022440: 696e 6720 7363 6865 6475 6c65 722e 636c  ing scheduler.cl
+00022450: 6f73 6522 290a 0a20 2020 2020 2020 2061  ose")..        a
+00022460: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+00022470: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
+00022480: 202a 5b6c 6f67 5f65 7272 6f72 7328 706c   *[log_errors(pl
+00022490: 7567 696e 2e62 6566 6f72 655f 636c 6f73  ugin.before_clos
+000224a0: 6529 2066 6f72 2070 6c75 6769 6e20 696e  e) for plugin in
+000224b0: 206c 6973 7428 7365 6c66 2e70 6c75 6769   list(self.plugi
+000224c0: 6e73 2e76 616c 7565 7328 2929 5d0a 2020  ns.values())].  
+000224d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000224e0: 2073 656c 662e 7374 6174 7573 203d 2053   self.status = S
+000224f0: 7461 7475 732e 636c 6f73 696e 670a 0a20  tatus.closing.. 
+00022500: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00022510: 666f 2822 5363 6865 6475 6c65 7220 636c  fo("Scheduler cl
+00022520: 6f73 696e 672e 2e2e 2229 0a20 2020 2020  osing...").     
+00022530: 2020 2073 6574 7072 6f63 7469 746c 6528     setproctitle(
+00022540: 2264 6173 6b20 7363 6865 6475 6c65 7220  "dask scheduler 
+00022550: 5b63 6c6f 7369 6e67 5d22 290a 0a20 2020  [closing]")..   
+00022560: 2020 2020 2066 6f72 2070 7265 6c6f 6164       for preload
+00022570: 2069 6e20 7365 6c66 2e70 7265 6c6f 6164   in self.preload
+00022580: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+00022590: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000225a0: 2020 2020 6177 6169 7420 7072 656c 6f61      await preloa
+000225b0: 642e 7465 6172 646f 776e 2829 0a20 2020  d.teardown().   
+000225c0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+000225d0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+000225e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000225f0: 722e 6578 6365 7074 696f 6e28 2246 6169  r.exception("Fai
+00022600: 6c65 6420 746f 2074 6561 7220 646f 776e  led to tear down
+00022610: 2070 7265 6c6f 6164 2229 0a0a 2020 2020   preload")..    
+00022620: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+00022630: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00022640: 2020 2020 2020 2a5b 6c6f 675f 6572 726f        *[log_erro
+00022650: 7273 2870 6c75 6769 6e2e 636c 6f73 6529  rs(plugin.close)
+00022660: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
+00022670: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
+00022680: 2e76 616c 7565 7328 2929 5d0a 2020 2020  .values())].    
+00022690: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
+000226a0: 6f72 2070 6320 696e 2073 656c 662e 7065  or pc in self.pe
+000226b0: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
+000226c0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+000226d0: 2020 2020 2020 2070 632e 7374 6f70 2829         pc.stop()
+000226e0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+000226f0: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
+00022700: 2e63 6c65 6172 2829 0a0a 2020 2020 2020  .clear()..      
+00022710: 2020 7365 6c66 2e73 746f 705f 7365 7276    self.stop_serv
+00022720: 6963 6573 2829 0a0a 2020 2020 2020 2020  ices()..        
+00022730: 666f 7220 6578 7420 696e 2073 656c 662e  for ext in self.
+00022740: 6578 7465 6e73 696f 6e73 2e76 616c 7565  extensions.value
+00022750: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00022760: 2077 6974 6820 7375 7070 7265 7373 2841   with suppress(A
+00022770: 7474 7269 6275 7465 4572 726f 7229 3a0a  ttributeError):.
+00022780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022790: 6578 742e 7465 6172 646f 776e 2829 0a20  ext.teardown(). 
+000227a0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+000227b0: 666f 2822 5363 6865 6475 6c65 7220 636c  fo("Scheduler cl
+000227c0: 6f73 696e 6720 616c 6c20 636f 6d6d 7322  osing all comms"
+000227d0: 290a 0a20 2020 2020 2020 2066 7574 7572  )..        futur
+000227e0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+000227f0: 666f 7220 5f2c 2063 6f6d 6d20 696e 206c  for _, comm in l
+00022800: 6973 7428 7365 6c66 2e73 7472 6561 6d5f  ist(self.stream_
+00022810: 636f 6d6d 732e 6974 656d 7328 2929 3a0a  comms.items()):.
+00022820: 2020 2020 2020 2020 2020 2020 2320 4649              # FI
+00022830: 584d 4520 7573 6520 6073 656c 662e 7265  XME use `self.re
+00022840: 6d6f 7665 5f77 6f72 6b65 7228 2960 2069  move_worker()` i
+00022850: 6e73 7465 6164 2061 6674 6572 2068 7474  nstead after htt
+00022860: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00022870: 6461 736b 2f64 6973 7472 6962 7574 6564  dask/distributed
+00022880: 2f69 7373 7565 732f 3633 3930 0a20 2020  /issues/6390.   
+00022890: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000228a0: 636f 6d6d 2e63 6c6f 7365 6428 293a 0a20  comm.closed():. 
+000228b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000228c0: 2054 6869 7320 636c 6f73 6573 2074 6865   This closes the
+000228d0: 2057 6f72 6b65 7220 616e 6420 656e 7375   Worker and ensu
+000228e0: 7265 7320 7468 6174 2069 6620 6120 4e61  res that if a Na
+000228f0: 6e6e 7920 6973 2061 726f 756e 642c 0a20  nny is around,. 
+00022900: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00022910: 2069 7420 6973 2063 6c6f 7365 6420 6173   it is closed as
+00022920: 2077 656c 6c0a 2020 2020 2020 2020 2020   well.          
+00022930: 2020 2020 2020 636f 6d6d 2e73 656e 6428        comm.send(
+00022940: 7b22 6f70 223a 2022 636c 6f73 6522 2c20  {"op": "close", 
+00022950: 2272 6561 736f 6e22 3a20 2273 6368 6564  "reason": "sched
+00022960: 756c 6572 2d63 6c6f 7365 227d 290a 2020  uler-close"}).  
+00022970: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00022980: 6d6d 2e73 656e 6428 7b22 6f70 223a 2022  mm.send({"op": "
+00022990: 636c 6f73 652d 7374 7265 616d 227d 290a  close-stream"}).
+000229a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000229b0: 2320 5e20 544f 444f 2072 656d 6f76 653f  # ^ TODO remove?
+000229c0: 2060 576f 726b 6572 2e63 6c6f 7365 6020   `Worker.close` 
+000229d0: 7769 6c6c 2063 6c6f 7365 2074 6865 2073  will close the s
+000229e0: 7472 6561 6d20 616e 7977 6179 2e0a 2020  tream anyway..  
+000229f0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+00022a00: 7570 7072 6573 7328 4174 7472 6962 7574  uppress(Attribut
+00022a10: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00022a20: 2020 2020 2020 2020 2066 7574 7572 6573           futures
+00022a30: 2e61 7070 656e 6428 636f 6d6d 2e63 6c6f  .append(comm.clo
+00022a40: 7365 2829 290a 0a20 2020 2020 2020 2061  se())..        a
+00022a50: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+00022a60: 6865 7228 2a66 7574 7572 6573 290a 0a20  her(*futures).. 
+00022a70: 2020 2020 2020 2069 6620 7365 6c66 2e6a         if self.j
+00022a80: 7570 7974 6572 3a0a 2020 2020 2020 2020  upyter:.        
+00022a90: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
+00022aa0: 6a75 7079 7465 725f 7365 7276 6572 5f61  jupyter_server_a
+00022ab0: 7070 6c69 6361 7469 6f6e 2e5f 636c 6561  pplication._clea
+00022ac0: 6e75 7028 290a 0a20 2020 2020 2020 2066  nup()..        f
+00022ad0: 6f72 2063 6f6d 6d20 696e 2073 656c 662e  or comm in self.
+00022ae0: 636c 6965 6e74 5f63 6f6d 6d73 2e76 616c  client_comms.val
+00022af0: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
+00022b00: 2020 2063 6f6d 6d2e 6162 6f72 7428 290a     comm.abort().
+00022b10: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+00022b20: 656c 662e 7270 632e 636c 6f73 6528 290a  elf.rpc.close().
+00022b30: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00022b40: 6174 7573 203d 2053 7461 7475 732e 636c  atus = Status.cl
+00022b50: 6f73 6564 0a20 2020 2020 2020 2073 656c  osed.        sel
+00022b60: 662e 7374 6f70 2829 0a20 2020 2020 2020  f.stop().       
+00022b70: 2061 7761 6974 2073 7570 6572 2829 2e63   await super().c
+00022b80: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
+00022b90: 7365 7470 726f 6374 6974 6c65 2822 6461  setproctitle("da
+00022ba0: 736b 2073 6368 6564 756c 6572 205b 636c  sk scheduler [cl
+00022bb0: 6f73 6564 5d22 290a 2020 2020 2020 2020  osed]").        
+00022bc0: 6469 7361 626c 655f 6763 5f64 6961 676e  disable_gc_diagn
+00022bd0: 6f73 6973 2829 0a0a 2020 2020 2323 2323  osis()..    ####
+00022be0: 2323 2323 2323 230a 2020 2020 2320 5374  #######.    # St
+00022bf0: 696d 756c 6920 230a 2020 2020 2323 2323  imuli #.    ####
+00022c00: 2323 2323 2323 230a 0a20 2020 2064 6566  #######..    def
+00022c10: 2068 6561 7274 6265 6174 5f77 6f72 6b65   heartbeat_worke
+00022c20: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
+00022c30: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00022c40: 2020 2020 6164 6472 6573 733a 2073 7472      address: str
+00022c50: 2c0a 2020 2020 2020 2020 7265 736f 6c76  ,.        resolv
+00022c60: 655f 6164 6472 6573 733a 2062 6f6f 6c20  e_address: bool 
+00022c70: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+00022c80: 6e6f 773a 2066 6c6f 6174 207c 204e 6f6e  now: float | Non
+00022c90: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00022ca0: 2020 7265 736f 7572 6365 733a 2064 6963    resources: dic
+00022cb0: 745b 7374 722c 2066 6c6f 6174 5d20 7c20  t[str, float] | 
+00022cc0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00022cd0: 2020 2020 2068 6f73 745f 696e 666f 3a20       host_info: 
+00022ce0: 6469 6374 207c 204e 6f6e 6520 3d20 4e6f  dict | None = No
+00022cf0: 6e65 2c0a 2020 2020 2020 2020 6d65 7472  ne,.        metr
+00022d00: 6963 733a 2064 6963 742c 0a20 2020 2020  ics: dict,.     
+00022d10: 2020 2065 7865 6375 7469 6e67 3a20 6469     executing: di
+00022d20: 6374 5b73 7472 2c20 666c 6f61 745d 207c  ct[str, float] |
+00022d30: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00022d40: 2020 2020 2020 6578 7465 6e73 696f 6e73        extensions
+00022d50: 3a20 6469 6374 207c 204e 6f6e 6520 3d20  : dict | None = 
+00022d60: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2064  None,.    ) -> d
+00022d70: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+00022d80: 2020 2020 2020 2061 6464 7265 7373 203d         address =
+00022d90: 2073 656c 662e 636f 6572 6365 5f61 6464   self.coerce_add
+00022da0: 7265 7373 2861 6464 7265 7373 2c20 7265  ress(address, re
+00022db0: 736f 6c76 655f 6164 6472 6573 7329 0a20  solve_address). 
+00022dc0: 2020 2020 2020 2061 6464 7265 7373 203d         address =
+00022dd0: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
+00022de0: 7373 2861 6464 7265 7373 290a 2020 2020  ss(address).    
+00022df0: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
+00022e00: 726b 6572 732e 6765 7428 6164 6472 6573  rkers.get(addres
+00022e10: 7329 0a20 2020 2020 2020 2069 6620 7773  s).        if ws
+00022e20: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00022e30: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00022e40: 6e69 6e67 2866 2252 6563 6569 7665 6420  ning(f"Received 
+00022e50: 6865 6172 7462 6561 7420 6672 6f6d 2075  heartbeat from u
+00022e60: 6e72 6567 6973 7465 7265 6420 776f 726b  nregistered work
+00022e70: 6572 207b 6164 6472 6573 7321 727d 2e22  er {address!r}."
+00022e80: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00022e90: 7475 726e 207b 2273 7461 7475 7322 3a20  turn {"status": 
+00022ea0: 226d 6973 7369 6e67 227d 0a0a 2020 2020  "missing"}..    
+00022eb0: 2020 2020 686f 7374 203d 2067 6574 5f61      host = get_a
+00022ec0: 6464 7265 7373 5f68 6f73 7428 6164 6472  ddress_host(addr
+00022ed0: 6573 7329 0a20 2020 2020 2020 206c 6f63  ess).        loc
+00022ee0: 616c 5f6e 6f77 203d 2074 696d 6528 290a  al_now = time().
+00022ef0: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
+00022f00: 6f20 3d20 686f 7374 5f69 6e66 6f20 6f72  o = host_info or
+00022f10: 207b 7d0a 0a20 2020 2020 2020 2064 683a   {}..        dh:
+00022f20: 2064 6963 7420 3d20 7365 6c66 2e68 6f73   dict = self.hos
+00022f30: 745f 696e 666f 2e73 6574 6465 6661 756c  t_info.setdefaul
+00022f40: 7428 686f 7374 2c20 7b7d 290a 2020 2020  t(host, {}).    
+00022f50: 2020 2020 6468 5b22 6c61 7374 2d73 6565      dh["last-see
+00022f60: 6e22 5d20 3d20 6c6f 6361 6c5f 6e6f 770a  n"] = local_now.
+00022f70: 0a20 2020 2020 2020 2066 7261 6320 3d20  .        frac = 
+00022f80: 3120 2f20 6c65 6e28 7365 6c66 2e77 6f72  1 / len(self.wor
+00022f90: 6b65 7273 290a 2020 2020 2020 2020 7365  kers).        se
+00022fa0: 6c66 2e62 616e 6477 6964 7468 203d 2028  lf.bandwidth = (
+00022fb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00022fc0: 662e 6261 6e64 7769 6474 6820 2a20 2831  f.bandwidth * (1
+00022fd0: 202d 2066 7261 6329 202b 206d 6574 7269   - frac) + metri
+00022fe0: 6373 5b22 6261 6e64 7769 6474 6822 5d5b  cs["bandwidth"][
+00022ff0: 2274 6f74 616c 225d 202a 2066 7261 630a  "total"] * frac.
+00023000: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00023010: 2020 666f 7220 6f74 6865 722c 2028 6277    for other, (bw
+00023020: 2c20 636f 756e 7429 2069 6e20 6d65 7472  , count) in metr
+00023030: 6963 735b 2262 616e 6477 6964 7468 225d  ics["bandwidth"]
+00023040: 5b22 776f 726b 6572 7322 5d2e 6974 656d  ["workers"].item
+00023050: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00023060: 2069 6620 2861 6464 7265 7373 2c20 6f74   if (address, ot
+00023070: 6865 7229 206e 6f74 2069 6e20 7365 6c66  her) not in self
+00023080: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
+00023090: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+000230a0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+000230b0: 7468 5f77 6f72 6b65 7273 5b61 6464 7265  th_workers[addre
+000230c0: 7373 2c20 6f74 6865 725d 203d 2062 7720  ss, other] = bw 
+000230d0: 2f20 636f 756e 740a 2020 2020 2020 2020  / count.        
+000230e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000230f0: 2020 2020 2020 2020 2020 616c 7068 6120            alpha 
+00023100: 3d20 2831 202d 2066 7261 6329 202a 2a20  = (1 - frac) ** 
+00023110: 636f 756e 740a 2020 2020 2020 2020 2020  count.          
+00023120: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
+00023130: 6964 7468 5f77 6f72 6b65 7273 5b61 6464  idth_workers[add
+00023140: 7265 7373 2c20 6f74 6865 725d 203d 2073  ress, other] = s
+00023150: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
+00023160: 726b 6572 735b 0a20 2020 2020 2020 2020  rkers[.         
+00023170: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00023180: 7373 2c20 6f74 6865 720a 2020 2020 2020  ss, other.      
+00023190: 2020 2020 2020 2020 2020 5d20 2a20 616c            ] * al
+000231a0: 7068 6120 2b20 6277 202a 2028 3120 2d20  pha + bw * (1 - 
+000231b0: 616c 7068 6129 0a20 2020 2020 2020 2066  alpha).        f
+000231c0: 6f72 2074 7970 2c20 2862 772c 2063 6f75  or typ, (bw, cou
+000231d0: 6e74 2920 696e 206d 6574 7269 6373 5b22  nt) in metrics["
+000231e0: 6261 6e64 7769 6474 6822 5d5b 2274 7970  bandwidth"]["typ
+000231f0: 6573 225d 2e69 7465 6d73 2829 3a0a 2020  es"].items():.  
+00023200: 2020 2020 2020 2020 2020 6966 2074 7970            if typ
+00023210: 206e 6f74 2069 6e20 7365 6c66 2e62 616e   not in self.ban
+00023220: 6477 6964 7468 5f74 7970 6573 3a0a 2020  dwidth_types:.  
+00023230: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00023240: 6c66 2e62 616e 6477 6964 7468 5f74 7970  lf.bandwidth_typ
+00023250: 6573 5b74 7970 5d20 3d20 6277 202f 2063  es[typ] = bw / c
+00023260: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
+00023270: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00023280: 2020 2020 2020 2061 6c70 6861 203d 2028         alpha = (
+00023290: 3120 2d20 6672 6163 2920 2a2a 2063 6f75  1 - frac) ** cou
+000232a0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+000232b0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+000232c0: 685f 7479 7065 735b 7479 705d 203d 2073  h_types[typ] = s
+000232d0: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
+000232e0: 7065 735b 7479 705d 202a 2061 6c70 6861  pes[typ] * alpha
+000232f0: 202b 2062 7720 2a20 280a 2020 2020 2020   + bw * (.      
+00023300: 2020 2020 2020 2020 2020 2020 2020 3120                1 
+00023310: 2d20 616c 7068 610a 2020 2020 2020 2020  - alpha.        
+00023320: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00023330: 2020 2077 732e 6c61 7374 5f73 6565 6e20     ws.last_seen 
+00023340: 3d20 6c6f 6361 6c5f 6e6f 770a 2020 2020  = local_now.    
+00023350: 2020 2020 6966 2065 7865 6375 7469 6e67      if executing
+00023360: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00023370: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00023380: 3a20 7468 6520 6578 6563 7574 696e 6720  : the executing 
+00023390: 6469 6374 2069 7320 756e 7573 6564 0a20  dict is unused. 
+000233a0: 2020 2020 2020 2020 2020 2077 732e 6578             ws.ex
+000233b0: 6563 7574 696e 6720 3d20 7b7d 0a20 2020  ecuting = {}.   
+000233c0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+000233d0: 2c20 6475 7261 7469 6f6e 2069 6e20 6578  , duration in ex
+000233e0: 6563 7574 696e 672e 6974 656d 7328 293a  ecuting.items():
+000233f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023400: 2069 6620 6b65 7920 696e 2073 656c 662e   if key in self.
+00023410: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+00023420: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+00023430: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00023440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023450: 2020 2020 7773 2e65 7865 6375 7469 6e67      ws.executing
+00023460: 5b74 735d 203d 2064 7572 6174 696f 6e0a  [ts] = duration.
+00023470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023480: 2020 2020 7473 2e70 7265 6669 782e 6164      ts.prefix.ad
+00023490: 645f 6578 6563 5f74 696d 6528 6475 7261  d_exec_time(dura
+000234a0: 7469 6f6e 290a 0a20 2020 2020 2020 2066  tion)..        f
+000234b0: 6f72 206e 616d 652c 2076 616c 7565 2069  or name, value i
+000234c0: 6e20 6d65 7472 6963 735b 2264 6967 6573  n metrics["diges
+000234d0: 7473 5f74 6f74 616c 5f73 696e 6365 5f68  ts_total_since_h
+000234e0: 6561 7274 6265 6174 225d 2e69 7465 6d73  eartbeat"].items
+000234f0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00023500: 7365 6c66 2e63 756d 756c 6174 6976 655f  self.cumulative_
+00023510: 776f 726b 6572 5f6d 6574 7269 6373 5b6e  worker_metrics[n
+00023520: 616d 655d 202b 3d20 7661 6c75 650a 0a20  ame] += value.. 
+00023530: 2020 2020 2020 2077 732e 6d65 7472 6963         ws.metric
+00023540: 7320 3d20 6d65 7472 6963 730a 0a20 2020  s = metrics..   
+00023550: 2020 2020 2023 2043 616c 6375 6c61 7465       # Calculate
+00023560: 2052 5353 202d 2064 6173 6b20 6b65 7973   RSS - dask keys
+00023570: 2c20 7365 7061 7261 7469 6e67 2022 6f6c  , separating "ol
+00023580: 6422 2061 6e64 2022 6e65 7722 2075 7361  d" and "new" usa
+00023590: 6765 0a20 2020 2020 2020 2023 2053 6565  ge.        # See
+000235a0: 204d 656d 6f72 7953 7461 7465 2066 6f72   MemoryState for
+000235b0: 2064 6574 6169 6c73 0a20 2020 2020 2020   details.       
+000235c0: 206d 6178 5f6d 656d 6f72 795f 756e 6d61   max_memory_unma
+000235d0: 6e61 6765 645f 6f6c 645f 6869 7374 5f61  naged_old_hist_a
+000235e0: 6765 203d 206c 6f63 616c 5f6e 6f77 202d  ge = local_now -
+000235f0: 2073 656c 662e 4d45 4d4f 5259 5f52 4543   self.MEMORY_REC
+00023600: 454e 545f 544f 5f4f 4c44 5f54 494d 450a  ENT_TO_OLD_TIME.
+00023610: 2020 2020 2020 2020 6d65 6d6f 7279 5f75          memory_u
+00023620: 6e6d 616e 6167 6564 5f6f 6c64 203d 2077  nmanaged_old = w
+00023630: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
+00023640: 6765 645f 6f6c 640a 2020 2020 2020 2020  ged_old.        
+00023650: 7768 696c 6520 7773 2e5f 6d65 6d6f 7279  while ws._memory
+00023660: 5f75 6e6d 616e 6167 6564 5f68 6973 746f  _unmanaged_histo
+00023670: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00023680: 7469 6d65 7374 616d 702c 2073 697a 6520  timestamp, size 
+00023690: 3d20 7773 2e5f 6d65 6d6f 7279 5f75 6e6d  = ws._memory_unm
+000236a0: 616e 6167 6564 5f68 6973 746f 7279 5b30  anaged_history[0
+000236b0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+000236c0: 2074 696d 6573 7461 6d70 203e 3d20 6d61   timestamp >= ma
+000236d0: 785f 6d65 6d6f 7279 5f75 6e6d 616e 6167  x_memory_unmanag
+000236e0: 6564 5f6f 6c64 5f68 6973 745f 6167 653a  ed_old_hist_age:
+000236f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023700: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+00023710: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
+00023720: 6d61 6e61 6765 645f 6869 7374 6f72 792e  managed_history.
+00023730: 706f 706c 6566 7428 290a 2020 2020 2020  popleft().      
+00023740: 2020 2020 2020 6966 2073 697a 6520 3d3d        if size ==
+00023750: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
+00023760: 645f 6f6c 643a 0a20 2020 2020 2020 2020  d_old:.         
+00023770: 2020 2020 2020 206d 656d 6f72 795f 756e         memory_un
+00023780: 6d61 6e61 6765 645f 6f6c 6420 3d20 3020  managed_old = 0 
+00023790: 2023 2072 6563 616c 6375 6c61 7465 206d   # recalculate m
+000237a0: 696e 2829 0a0a 2020 2020 2020 2020 2320  in()..        # 
+000237b0: 7773 2e5f 6e62 7974 6573 2069 7320 7570  ws._nbytes is up
+000237c0: 6461 7465 6420 6174 2061 2064 6966 6665  dated at a diffe
+000237d0: 7265 6e74 2074 696d 6520 616e 6420 7369  rent time and si
+000237e0: 7a65 6f66 2829 206d 6179 206e 6f74 2062  zeof() may not b
+000237f0: 6520 6163 6375 7261 7465 2c0a 2020 2020  e accurate,.    
+00023800: 2020 2020 2320 736f 2073 697a 6520 6d61      # so size ma
+00023810: 7920 6265 2028 7465 6d70 6f72 6172 696c  y be (temporaril
+00023820: 7929 206e 6567 6174 6976 653b 2066 6c6f  y) negative; flo
+00023830: 6f72 2069 7420 746f 207a 6572 6f2e 0a20  or it to zero.. 
+00023840: 2020 2020 2020 2073 697a 6520 3d20 6d61         size = ma
+00023850: 7828 0a20 2020 2020 2020 2020 2020 2030  x(.            0
+00023860: 2c20 6d65 7472 6963 735b 226d 656d 6f72  , metrics["memor
+00023870: 7922 5d20 2d20 7773 2e6e 6279 7465 7320  y"] - ws.nbytes 
+00023880: 2b20 6d65 7472 6963 735b 2273 7069 6c6c  + metrics["spill
+00023890: 6564 5f62 7974 6573 225d 5b22 6d65 6d6f  ed_bytes"]["memo
+000238a0: 7279 225d 0a20 2020 2020 2020 2029 0a0a  ry"].        )..
+000238b0: 2020 2020 2020 2020 7773 2e5f 6d65 6d6f          ws._memo
+000238c0: 7279 5f75 6e6d 616e 6167 6564 5f68 6973  ry_unmanaged_his
+000238d0: 746f 7279 2e61 7070 656e 6428 286c 6f63  tory.append((loc
+000238e0: 616c 5f6e 6f77 2c20 7369 7a65 2929 0a20  al_now, size)). 
+000238f0: 2020 2020 2020 2069 6620 6e6f 7420 6d65         if not me
+00023900: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00023910: 6c64 3a0a 2020 2020 2020 2020 2020 2020  ld:.            
+00023920: 2320 5468 6520 776f 726b 6572 2068 6173  # The worker has
+00023930: 206a 7573 7420 6265 656e 2073 7461 7274   just been start
+00023940: 6564 206f 7220 7468 6520 7072 6576 696f  ed or the previo
+00023950: 7573 206d 696e 696d 756d 2068 6173 2062  us minimum has b
+00023960: 6565 6e20 6578 7075 6e67 6564 0a20 2020  een expunged.   
+00023970: 2020 2020 2020 2020 2023 2062 6563 6175           # becau
+00023980: 7365 2074 6f6f 206f 6c64 2e0a 2020 2020  se too old..    
+00023990: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
+000239a0: 7468 6973 2061 6c67 6f72 6974 686d 2069  this algorithm i
+000239b0: 7320 6361 7070 6564 2074 6f20 3230 3020  s capped to 200 
+000239c0: 2a20 4d45 4d4f 5259 5f52 4543 454e 545f  * MEMORY_RECENT_
+000239d0: 544f 5f4f 4c44 5f54 494d 4520 656c 656d  TO_OLD_TIME elem
+000239e0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
+000239f0: 2023 2063 6c75 7374 6572 2d77 6964 6520   # cluster-wide 
+00023a00: 6279 2068 6561 7274 6265 6174 5f69 6e74  by heartbeat_int
+00023a10: 6572 7661 6c28 292c 2072 6567 6172 646c  erval(), regardl
+00023a20: 6573 7320 6f66 2074 6865 206e 756d 6265  ess of the numbe
+00023a30: 7220 6f66 2077 6f72 6b65 7273 0a20 2020  r of workers.   
+00023a40: 2020 2020 2020 2020 2077 732e 5f6d 656d           ws._mem
+00023a50: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+00023a60: 6420 3d20 6d69 6e28 6d61 7028 7365 636f  d = min(map(seco
+00023a70: 6e64 2c20 7773 2e5f 6d65 6d6f 7279 5f75  nd, ws._memory_u
+00023a80: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
+00023a90: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
+00023aa0: 7369 7a65 203c 206d 656d 6f72 795f 756e  size < memory_un
+00023ab0: 6d61 6e61 6765 645f 6f6c 643a 0a20 2020  managed_old:.   
+00023ac0: 2020 2020 2020 2020 2077 732e 5f6d 656d           ws._mem
+00023ad0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+00023ae0: 6420 3d20 7369 7a65 0a0a 2020 2020 2020  d = size..      
+00023af0: 2020 6966 2068 6f73 745f 696e 666f 3a0a    if host_info:.
+00023b00: 2020 2020 2020 2020 2020 2020 6468 203d              dh =
+00023b10: 2073 656c 662e 686f 7374 5f69 6e66 6f2e   self.host_info.
+00023b20: 7365 7464 6566 6175 6c74 2868 6f73 742c  setdefault(host,
+00023b30: 207b 7d29 0a20 2020 2020 2020 2020 2020   {}).           
+00023b40: 2064 682e 7570 6461 7465 2868 6f73 745f   dh.update(host_
+00023b50: 696e 666f 290a 0a20 2020 2020 2020 2069  info)..        i
+00023b60: 6620 6e6f 773a 0a20 2020 2020 2020 2020  f now:.         
+00023b70: 2020 2077 732e 7469 6d65 5f64 656c 6179     ws.time_delay
+00023b80: 203d 206c 6f63 616c 5f6e 6f77 202d 206e   = local_now - n
+00023b90: 6f77 0a0a 2020 2020 2020 2020 6966 2072  ow..        if r
+00023ba0: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
+00023bb0: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
+00023bc0: 6573 6f75 7263 6573 2877 6f72 6b65 723d  esources(worker=
+00023bd0: 6164 6472 6573 732c 2072 6573 6f75 7263  address, resourc
+00023be0: 6573 3d72 6573 6f75 7263 6573 290a 0a20  es=resources).. 
+00023bf0: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
+00023c00: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00023c10: 2020 666f 7220 6e61 6d65 2c20 6461 7461    for name, data
+00023c20: 2069 6e20 6578 7465 6e73 696f 6e73 2e69   in extensions.i
+00023c30: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00023c40: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
+00023c50: 656e 7369 6f6e 735b 6e61 6d65 5d2e 6865  ensions[name].he
+00023c60: 6172 7462 6561 7428 7773 2c20 6461 7461  artbeat(ws, data
+00023c70: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00023c80: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
+00023c90: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
+00023ca0: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
+00023cb0: 6522 3a20 6c6f 6361 6c5f 6e6f 772c 0a20  e": local_now,. 
+00023cc0: 2020 2020 2020 2020 2020 2022 6865 6172             "hear
+00023cd0: 7462 6561 742d 696e 7465 7276 616c 223a  tbeat-interval":
+00023ce0: 2068 6561 7274 6265 6174 5f69 6e74 6572   heartbeat_inter
+00023cf0: 7661 6c28 6c65 6e28 7365 6c66 2e77 6f72  val(len(self.wor
+00023d00: 6b65 7273 2929 2c0a 2020 2020 2020 2020  kers)),.        
+00023d10: 7d0a 0a20 2020 2040 6c6f 675f 6572 726f  }..    @log_erro
+00023d20: 7273 0a20 2020 2061 7379 6e63 2064 6566  rs.    async def
+00023d30: 2061 6464 5f77 6f72 6b65 7228 0a20 2020   add_worker(.   
+00023d40: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00023d50: 2020 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20     comm: Comm,. 
+00023d60: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+00023d70: 2020 6164 6472 6573 733a 2073 7472 2c0a    address: str,.
+00023d80: 2020 2020 2020 2020 7374 6174 7573 3a20          status: 
+00023d90: 7374 722c 0a20 2020 2020 2020 2073 6572  str,.        ser
+00023da0: 7665 725f 6964 3a20 7374 722c 0a20 2020  ver_id: str,.   
+00023db0: 2020 2020 206e 7468 7265 6164 733a 2069       nthreads: i
+00023dc0: 6e74 2c0a 2020 2020 2020 2020 6e61 6d65  nt,.        name
+00023dd0: 3a20 7374 722c 0a20 2020 2020 2020 2072  : str,.        r
+00023de0: 6573 6f6c 7665 5f61 6464 7265 7373 3a20  esolve_address: 
+00023df0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+00023e00: 2020 2020 206e 6f77 3a20 666c 6f61 742c       now: float,
+00023e10: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
+00023e20: 6573 3a20 6469 6374 5b73 7472 2c20 666c  es: dict[str, fl
+00023e30: 6f61 745d 2c0a 2020 2020 2020 2020 2320  oat],.        # 
+00023e40: 4649 584d 453a 2054 6869 7320 6973 206e  FIXME: This is n
+00023e50: 6576 6572 2073 7562 6d69 7474 6564 2062  ever submitted b
+00023e60: 7920 7468 6520 776f 726b 6572 0a20 2020  y the worker.   
+00023e70: 2020 2020 2068 6f73 745f 696e 666f 3a20       host_info: 
+00023e80: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00023e90: 2020 2020 206d 656d 6f72 795f 6c69 6d69       memory_limi
+00023ea0: 743a 2069 6e74 207c 204e 6f6e 652c 0a20  t: int | None,. 
+00023eb0: 2020 2020 2020 206d 6574 7269 6373 3a20         metrics: 
+00023ec0: 6469 6374 5b73 7472 2c20 416e 795d 2c0a  dict[str, Any],.
+00023ed0: 2020 2020 2020 2020 7069 643a 2069 6e74          pid: int
+00023ee0: 203d 2030 2c0a 2020 2020 2020 2020 7365   = 0,.        se
+00023ef0: 7276 6963 6573 3a20 6469 6374 5b73 7472  rvices: dict[str
+00023f00: 2c20 696e 745d 2c0a 2020 2020 2020 2020  , int],.        
+00023f10: 6c6f 6361 6c5f 6469 7265 6374 6f72 793a  local_directory:
+00023f20: 2073 7472 2c0a 2020 2020 2020 2020 7665   str,.        ve
+00023f30: 7273 696f 6e73 3a20 6469 6374 5b73 7472  rsions: dict[str
+00023f40: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
+00023f50: 6e61 6e6e 793a 2073 7472 2c0a 2020 2020  nanny: str,.    
+00023f60: 2020 2020 6578 7472 613a 2064 6963 742c      extra: dict,
+00023f70: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00023f80: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
+00023f90: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00023fa0: 2020 2222 2241 6464 2061 206e 6577 2077    """Add a new w
+00023fb0: 6f72 6b65 7220 746f 2074 6865 2063 6c75  orker to the clu
+00023fc0: 7374 6572 2222 220a 2020 2020 2020 2020  ster""".        
+00023fd0: 6164 6472 6573 7320 3d20 7365 6c66 2e63  address = self.c
+00023fe0: 6f65 7263 655f 6164 6472 6573 7328 6164  oerce_address(ad
+00023ff0: 6472 6573 732c 2072 6573 6f6c 7665 5f61  dress, resolve_a
+00024000: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00024010: 6164 6472 6573 7320 3d20 6e6f 726d 616c  address = normal
+00024020: 697a 655f 6164 6472 6573 7328 6164 6472  ize_address(addr
+00024030: 6573 7329 0a20 2020 2020 2020 2068 6f73  ess).        hos
+00024040: 7420 3d20 6765 745f 6164 6472 6573 735f  t = get_address_
+00024050: 686f 7374 2861 6464 7265 7373 290a 0a20  host(address).. 
+00024060: 2020 2020 2020 2069 6620 6164 6472 6573         if addres
+00024070: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+00024080: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00024090: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000240a0: 2257 6f72 6b65 7220 616c 7265 6164 7920  "Worker already 
+000240b0: 6578 6973 7473 2025 7322 2025 2061 6464  exists %s" % add
+000240c0: 7265 7373 290a 0a20 2020 2020 2020 2069  ress)..        i
+000240d0: 6620 6e61 6d65 2069 6e20 7365 6c66 2e61  f name in self.a
+000240e0: 6c69 6173 6573 3a0a 2020 2020 2020 2020  liases:.        
+000240f0: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
+00024100: 6e67 2822 576f 726b 6572 2074 7269 6564  ng("Worker tried
+00024110: 2074 6f20 636f 6e6e 6563 7420 7769 7468   to connect with
+00024120: 2061 2064 7570 6c69 6361 7465 206e 616d   a duplicate nam
+00024130: 653a 2025 7322 2c20 6e61 6d65 290a 2020  e: %s", name).  
+00024140: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00024150: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00024160: 2020 2273 7461 7475 7322 3a20 2265 7272    "status": "err
+00024170: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+00024180: 2020 2020 2022 6d65 7373 6167 6522 3a20       "message": 
+00024190: 226e 616d 6520 7461 6b65 6e2c 2025 7322  "name taken, %s"
+000241a0: 2025 206e 616d 652c 0a20 2020 2020 2020   % name,.       
+000241b0: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
+000241c0: 2074 696d 6528 292c 0a20 2020 2020 2020   time(),.       
+000241d0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000241e0: 2020 2061 7761 6974 2063 6f6d 6d2e 7772     await comm.wr
+000241f0: 6974 6528 6d73 6729 0a20 2020 2020 2020  ite(msg).       
+00024200: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00024210: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
+00024220: 656e 7428 6164 6472 6573 732c 207b 2261  ent(address, {"a
+00024230: 6374 696f 6e22 3a20 2261 6464 2d77 6f72  ction": "add-wor
+00024240: 6b65 7222 7d29 0a20 2020 2020 2020 2073  ker"}).        s
+00024250: 656c 662e 6c6f 675f 6576 656e 7428 2261  elf.log_event("a
+00024260: 6c6c 222c 207b 2261 6374 696f 6e22 3a20  ll", {"action": 
+00024270: 2261 6464 2d77 6f72 6b65 7222 2c20 2277  "add-worker", "w
+00024280: 6f72 6b65 7222 3a20 6164 6472 6573 737d  orker": address}
+00024290: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000242a0: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
+000242b0: 203d 2077 7320 3d20 576f 726b 6572 5374   = ws = WorkerSt
+000242c0: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+000242d0: 2061 6464 7265 7373 3d61 6464 7265 7373   address=address
+000242e0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+000242f0: 6174 7573 3d53 7461 7475 732e 6c6f 6f6b  atus=Status.look
+00024300: 7570 5b73 7461 7475 735d 2c20 2023 2074  up[status],  # t
+00024310: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+00024320: 2020 2020 2020 2020 7069 643d 7069 642c          pid=pid,
+00024330: 0a20 2020 2020 2020 2020 2020 206e 7468  .            nth
+00024340: 7265 6164 733d 6e74 6872 6561 6473 2c0a  reads=nthreads,.
+00024350: 2020 2020 2020 2020 2020 2020 6d65 6d6f              memo
+00024360: 7279 5f6c 696d 6974 3d6d 656d 6f72 795f  ry_limit=memory_
+00024370: 6c69 6d69 7420 6f72 2030 2c0a 2020 2020  limit or 0,.    
+00024380: 2020 2020 2020 2020 6e61 6d65 3d6e 616d          name=nam
+00024390: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
+000243a0: 6f63 616c 5f64 6972 6563 746f 7279 3d6c  ocal_directory=l
+000243b0: 6f63 616c 5f64 6972 6563 746f 7279 2c0a  ocal_directory,.
+000243c0: 2020 2020 2020 2020 2020 2020 7365 7276              serv
+000243d0: 6963 6573 3d73 6572 7669 6365 732c 0a20  ices=services,. 
+000243e0: 2020 2020 2020 2020 2020 2076 6572 7369             versi
+000243f0: 6f6e 733d 7665 7273 696f 6e73 2c0a 2020  ons=versions,.  
+00024400: 2020 2020 2020 2020 2020 6e61 6e6e 793d            nanny=
+00024410: 6e61 6e6e 792c 0a20 2020 2020 2020 2020  nanny,.         
+00024420: 2020 2065 7874 7261 3d65 7874 7261 2c0a     extra=extra,.
+00024430: 2020 2020 2020 2020 2020 2020 7365 7276              serv
+00024440: 6572 5f69 643d 7365 7276 6572 5f69 642c  er_id=server_id,
+00024450: 0a20 2020 2020 2020 2020 2020 2073 6368  .            sch
+00024460: 6564 756c 6572 3d73 656c 662c 0a20 2020  eduler=self,.   
+00024470: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+00024480: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
+00024490: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+000244a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000244b0: 7275 6e6e 696e 672e 6164 6428 7773 290a  running.add(ws).
+000244c0: 0a20 2020 2020 2020 2064 6820 3d20 7365  .        dh = se
+000244d0: 6c66 2e68 6f73 745f 696e 666f 2e67 6574  lf.host_info.get
+000244e0: 2868 6f73 7429 0a20 2020 2020 2020 2069  (host).        i
+000244f0: 6620 6468 2069 7320 4e6f 6e65 3a0a 2020  f dh is None:.  
+00024500: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+00024510: 6f73 745f 696e 666f 5b68 6f73 745d 203d  ost_info[host] =
+00024520: 2064 6820 3d20 7b7d 0a0a 2020 2020 2020   dh = {}..      
+00024530: 2020 6468 5f61 6464 7265 7373 6573 203d    dh_addresses =
+00024540: 2064 682e 6765 7428 2261 6464 7265 7373   dh.get("address
+00024550: 6573 2229 0a20 2020 2020 2020 2069 6620  es").        if 
+00024560: 6468 5f61 6464 7265 7373 6573 2069 7320  dh_addresses is 
+00024570: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00024580: 2020 6468 5b22 6164 6472 6573 7365 7322    dh["addresses"
+00024590: 5d20 3d20 6468 5f61 6464 7265 7373 6573  ] = dh_addresses
+000245a0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+000245b0: 2020 2020 2064 685b 226e 7468 7265 6164       dh["nthread
+000245c0: 7322 5d20 3d20 300a 0a20 2020 2020 2020  s"] = 0..       
+000245d0: 2064 685f 6164 6472 6573 7365 732e 6164   dh_addresses.ad
+000245e0: 6428 6164 6472 6573 7329 0a20 2020 2020  d(address).     
+000245f0: 2020 2064 685b 226e 7468 7265 6164 7322     dh["nthreads"
+00024600: 5d20 2b3d 206e 7468 7265 6164 730a 0a20  ] += nthreads.. 
+00024610: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
+00024620: 6c5f 6e74 6872 6561 6473 202b 3d20 6e74  l_nthreads += nt
+00024630: 6872 6561 6473 0a20 2020 2020 2020 2073  hreads.        s
+00024640: 656c 662e 616c 6961 7365 735b 6e61 6d65  elf.aliases[name
+00024650: 5d20 3d20 6164 6472 6573 730a 0a20 2020  ] = address..   
+00024660: 2020 2020 2073 656c 662e 6865 6172 7462       self.heartb
+00024670: 6561 745f 776f 726b 6572 280a 2020 2020  eat_worker(.    
+00024680: 2020 2020 2020 2020 6164 6472 6573 733d          address=
+00024690: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+000246a0: 2020 2020 2072 6573 6f6c 7665 5f61 6464       resolve_add
+000246b0: 7265 7373 3d72 6573 6f6c 7665 5f61 6464  ress=resolve_add
+000246c0: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+000246d0: 2020 6e6f 773d 6e6f 772c 0a20 2020 2020    now=now,.     
+000246e0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+000246f0: 3d72 6573 6f75 7263 6573 2c0a 2020 2020  =resources,.    
+00024700: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
+00024710: 6f3d 686f 7374 5f69 6e66 6f2c 0a20 2020  o=host_info,.   
+00024720: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
+00024730: 3d6d 6574 7269 6373 2c0a 2020 2020 2020  =metrics,.      
+00024740: 2020 290a 0a20 2020 2020 2020 2023 2044    )..        # D
+00024750: 6f20 6e6f 7420 6e65 6564 2074 6f20 6164  o not need to ad
+00024760: 6a75 7374 2073 656c 662e 746f 7461 6c5f  just self.total_
+00024770: 6f63 6375 7061 6e63 7920 6173 2073 656c  occupancy as sel
+00024780: 662e 6f63 6375 7061 6e63 795b 7773 5d20  f.occupancy[ws] 
+00024790: 6361 6e6e 6f74 0a20 2020 2020 2020 2023  cannot.        #
+000247a0: 2065 7869 7374 2062 6566 6f72 6520 7468   exist before th
+000247b0: 6973 2e0a 2020 2020 2020 2020 7365 6c66  is..        self
+000247c0: 2e63 6865 636b 5f69 646c 655f 7361 7475  .check_idle_satu
+000247d0: 7261 7465 6428 7773 290a 0a20 2020 2020  rated(ws)..     
+000247e0: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
+000247f0: 6f6d 6d73 5b61 6464 7265 7373 5d20 3d20  omms[address] = 
+00024800: 4261 7463 6865 6453 656e 6428 696e 7465  BatchedSend(inte
+00024810: 7276 616c 3d22 356d 7322 2c20 6c6f 6f70  rval="5ms", loop
+00024820: 3d73 656c 662e 6c6f 6f70 290a 0a20 2020  =self.loop)..   
+00024830: 2020 2020 2061 7761 6974 6162 6c65 7320       awaitables 
+00024840: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+00024850: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+00024860: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+00024870: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
+00024880: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00024890: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+000248a0: 3d20 706c 7567 696e 2e61 6464 5f77 6f72  = plugin.add_wor
+000248b0: 6b65 7228 7363 6865 6475 6c65 723d 7365  ker(scheduler=se
+000248c0: 6c66 2c20 776f 726b 6572 3d61 6464 7265  lf, worker=addre
+000248d0: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
+000248e0: 2020 2020 6966 2072 6573 756c 7420 6973      if result is
+000248f0: 206e 6f74 204e 6f6e 6520 616e 6420 696e   not None and in
+00024900: 7370 6563 742e 6973 6177 6169 7461 626c  spect.isawaitabl
+00024910: 6528 7265 7375 6c74 293a 0a20 2020 2020  e(result):.     
+00024920: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00024930: 7761 6974 6162 6c65 732e 6170 7065 6e64  waitables.append
+00024940: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
+00024950: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00024960: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00024970: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00024980: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
+00024990: 0a20 2020 2020 2020 2070 6c75 6769 6e5f  .        plugin_
+000249a0: 6d73 6773 203d 2061 7761 6974 2061 7379  msgs = await asy
+000249b0: 6e63 696f 2e67 6174 6865 7228 2a61 7761  ncio.gather(*awa
+000249c0: 6974 6162 6c65 732c 2072 6574 7572 6e5f  itables, return_
+000249d0: 6578 6365 7074 696f 6e73 3d54 7275 6529  exceptions=True)
+000249e0: 0a20 2020 2020 2020 2070 6c75 6769 6e73  .        plugins
+000249f0: 5f65 7863 6570 7469 6f6e 7320 3d20 5b6d  _exceptions = [m
+00024a00: 7367 2066 6f72 206d 7367 2069 6e20 706c  sg for msg in pl
+00024a10: 7567 696e 5f6d 7367 7320 6966 2069 7369  ugin_msgs if isi
+00024a20: 6e73 7461 6e63 6528 6d73 672c 2045 7863  nstance(msg, Exc
+00024a30: 6570 7469 6f6e 295d 0a20 2020 2020 2020  eption)].       
+00024a40: 2066 6f72 2065 7863 2069 6e20 706c 7567   for exc in plug
+00024a50: 696e 735f 6578 6365 7074 696f 6e73 3a0a  ins_exceptions:.
+00024a60: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00024a70: 6572 2e65 7863 6570 7469 6f6e 2865 7863  er.exception(exc
+00024a80: 2c20 6578 635f 696e 666f 3d65 7863 290a  , exc_info=exc).
+00024a90: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
+00024aa0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+00024ab0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+00024ac0: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
+00024ad0: 7469 6f6e 7328 0a20 2020 2020 2020 2020  tions(.         
+00024ae0: 2020 2020 2020 2073 656c 662e 6275 6c6b         self.bulk
+00024af0: 5f73 6368 6564 756c 655f 756e 7275 6e6e  _schedule_unrunn
+00024b00: 6162 6c65 5f61 6674 6572 5f61 6464 696e  able_after_addin
+00024b10: 675f 776f 726b 6572 2877 7329 2c20 7374  g_worker(ws), st
+00024b20: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
+00024b30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00024b40: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
+00024b50: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
+00024b60: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
+00024b70: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+00024b80: 6964 290a 0a20 2020 2020 2020 206c 6f67  id)..        log
+00024b90: 6765 722e 696e 666f 2822 5265 6769 7374  ger.info("Regist
+00024ba0: 6572 2077 6f72 6b65 7220 2573 222c 2077  er worker %s", w
+00024bb0: 7329 0a0a 2020 2020 2020 2020 6d73 6720  s)..        msg 
+00024bc0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00024bd0: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
+00024be0: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
+00024bf0: 6522 3a20 7469 6d65 2829 2c0a 2020 2020  e": time(),.    
+00024c00: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
+00024c10: 6174 2d69 6e74 6572 7661 6c22 3a20 6865  at-interval": he
+00024c20: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
+00024c30: 286c 656e 2873 656c 662e 776f 726b 6572  (len(self.worker
+00024c40: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
+00024c50: 2022 776f 726b 6572 2d70 6c75 6769 6e73   "worker-plugins
+00024c60: 223a 2073 656c 662e 776f 726b 6572 5f70  ": self.worker_p
+00024c70: 6c75 6769 6e73 2c0a 2020 2020 2020 2020  lugins,.        
+00024c80: 7d0a 0a20 2020 2020 2020 2076 6572 7369  }..        versi
+00024c90: 6f6e 5f77 6172 6e69 6e67 203d 2076 6572  on_warning = ver
+00024ca0: 7369 6f6e 5f6d 6f64 756c 652e 6572 726f  sion_module.erro
+00024cb0: 725f 6d65 7373 6167 6528 0a20 2020 2020  r_message(.     
+00024cc0: 2020 2020 2020 2076 6572 7369 6f6e 5f6d         version_m
+00024cd0: 6f64 756c 652e 6765 745f 7665 7273 696f  odule.get_versio
+00024ce0: 6e73 2829 2c0a 2020 2020 2020 2020 2020  ns(),.          
+00024cf0: 2020 7b77 3a20 7773 2e76 6572 7369 6f6e    {w: ws.version
+00024d00: 7320 666f 7220 772c 2077 7320 696e 2073  s for w, ws in s
+00024d10: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
+00024d20: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
+00024d30: 2020 7665 7273 696f 6e73 2c0a 2020 2020    versions,.    
+00024d40: 2020 2020 2020 2020 736f 7572 6365 5f6e          source_n
+00024d50: 616d 653d 7374 7228 7773 2e73 6572 7665  ame=str(ws.serve
+00024d60: 725f 6964 292c 0a20 2020 2020 2020 2029  r_id),.        )
+00024d70: 0a20 2020 2020 2020 206d 7367 2e75 7064  .        msg.upd
+00024d80: 6174 6528 7665 7273 696f 6e5f 7761 726e  ate(version_warn
+00024d90: 696e 6729 0a0a 2020 2020 2020 2020 6177  ing)..        aw
+00024da0: 6169 7420 636f 6d6d 2e77 7269 7465 286d  ait comm.write(m
+00024db0: 7367 290a 2020 2020 2020 2020 2320 5468  sg).        # Th
+00024dc0: 6973 2077 696c 6c20 6b65 6570 2072 756e  is will keep run
+00024dd0: 6e69 6e67 2075 6e74 696c 2074 6865 2077  ning until the w
+00024de0: 6f72 6b65 7220 6973 2072 656d 6f76 6564  orker is removed
+00024df0: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+00024e00: 656c 662e 6861 6e64 6c65 5f77 6f72 6b65  elf.handle_worke
+00024e10: 7228 636f 6d6d 2c20 6164 6472 6573 7329  r(comm, address)
+00024e20: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00024e30: 6164 645f 6e61 6e6e 7928 7365 6c66 2920  add_nanny(self) 
+00024e40: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
+00024e50: 5d3a 0a20 2020 2020 2020 206d 7367 203d  ]:.        msg =
+00024e60: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00024e70: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
+00024e80: 2020 2020 2020 2020 2020 2022 6e61 6e6e             "nann
+00024e90: 792d 706c 7567 696e 7322 3a20 7365 6c66  y-plugins": self
+00024ea0: 2e6e 616e 6e79 5f70 6c75 6769 6e73 2c0a  .nanny_plugins,.
+00024eb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00024ec0: 2020 7265 7475 726e 206d 7367 0a0a 2020    return msg..  
+00024ed0: 2020 6465 6620 7570 6461 7465 5f67 7261    def update_gra
+00024ee0: 7068 280a 2020 2020 2020 2020 7365 6c66  ph(.        self
+00024ef0: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
+00024f00: 3a20 7374 722c 0a20 2020 2020 2020 2067  : str,.        g
+00024f10: 7261 7068 5f68 6561 6465 723a 2064 6963  raph_header: dic
+00024f20: 742c 0a20 2020 2020 2020 2067 7261 7068  t,.        graph
+00024f30: 5f66 7261 6d65 733a 206c 6973 745b 6279  _frames: list[by
+00024f40: 7465 735d 2c0a 2020 2020 2020 2020 6b65  tes],.        ke
+00024f50: 7973 3a20 6c69 7374 5b73 7472 5d2c 0a20  ys: list[str],. 
+00024f60: 2020 2020 2020 2069 6e74 6572 6e61 6c5f         internal_
+00024f70: 7072 696f 7269 7479 3a20 6469 6374 5b73  priority: dict[s
+00024f80: 7472 2c20 696e 745d 207c 204e 6f6e 652c  tr, int] | None,
+00024f90: 0a20 2020 2020 2020 2073 7562 6d69 7474  .        submitt
+00024fa0: 696e 675f 7461 736b 3a20 7374 7220 7c20  ing_task: str | 
+00024fb0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7573  None,.        us
+00024fc0: 6572 5f70 7269 6f72 6974 793a 2069 6e74  er_priority: int
+00024fd0: 207c 2064 6963 745b 7374 722c 2069 6e74   | dict[str, int
+00024fe0: 5d20 3d20 302c 0a20 2020 2020 2020 2061  ] = 0,.        a
+00024ff0: 6374 6f72 733a 2062 6f6f 6c20 7c20 6c69  ctors: bool | li
+00025000: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
+00025010: 204e 6f6e 652c 0a20 2020 2020 2020 2066   None,.        f
+00025020: 6966 6f5f 7469 6d65 6f75 743a 2066 6c6f  ifo_timeout: flo
+00025030: 6174 203d 2030 2e30 2c0a 2020 2020 2020  at = 0.0,.      
+00025040: 2020 636f 6465 3a20 7475 706c 655b 7374    code: tuple[st
+00025050: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
+00025060: 2c0a 2020 2020 2020 2020 616e 6e6f 7461  ,.        annota
+00025070: 7469 6f6e 733a 2064 6963 7420 7c20 4e6f  tions: dict | No
+00025080: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00025090: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
+000250a0: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+000250b0: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
+000250c0: 3a0a 2020 2020 2020 2020 7374 6172 7420  :.        start 
+000250d0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+000250e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000250f0: 2020 2320 544f 444f 3a20 6465 7365 7269    # TODO: deseri
+00025100: 616c 697a 6174 696f 6e20 2b20 6d61 7465  alization + mate
+00025110: 7269 616c 697a 6174 696f 6e20 7368 6f75  rialization shou
+00025120: 6c64 2062 6520 6f66 666c 6f61 6465 6420  ld be offloaded 
+00025130: 746f 2061 0a20 2020 2020 2020 2020 2020  to a.           
+00025140: 2023 2074 6872 6561 6420 7369 6e63 6520   # thread since 
+00025150: 7468 6973 2069 7320 6e6f 6e2d 7472 6976  this is non-triv
+00025160: 6961 6c20 636f 6d70 7574 6520 7469 6d65  ial compute time
+00025170: 2074 6861 7420 626c 6f63 6b73 2074 6865   that blocks the
+00025180: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+00025190: 7665 6e74 206c 6f6f 702e 2054 6869 7320  vent loop. This 
+000251a0: 6c69 6b65 6c79 2072 6571 7569 7265 7320  likely requires 
+000251b0: 7573 2074 6f20 7573 6520 6120 6c6f 636b  us to use a lock
+000251c0: 2073 696e 6365 2077 6520 6e65 6564 2074   since we need t
+000251d0: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+000251e0: 6775 6172 616e 7465 6520 6f72 6465 7269  guarantee orderi
+000251f0: 6e67 206f 6620 7570 6461 7465 5f67 7261  ng of update_gra
+00025200: 7068 2063 616c 6c73 2028 6173 206c 6f6e  ph calls (as lon
+00025210: 6720 6173 2074 6865 7265 2069 7320 6a75  g as there is ju
+00025220: 7374 0a20 2020 2020 2020 2020 2020 2023  st.            #
+00025230: 2061 2073 696e 676c 6520 6f66 666c 6f61   a single offloa
+00025240: 6420 7468 7265 6164 2c20 7468 6973 2069  d thread, this i
+00025250: 7320 6e6f 7420 6120 7072 6f62 6c65 6d29  s not a problem)
+00025260: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+00025270: 6d20 6469 7374 7269 6275 7465 642e 7072  m distributed.pr
+00025280: 6f74 6f63 6f6c 2069 6d70 6f72 7420 6465  otocol import de
+00025290: 7365 7269 616c 697a 650a 0a20 2020 2020  serialize..     
+000252a0: 2020 2020 2020 2067 7261 7068 203d 2064         graph = d
+000252b0: 6573 6572 6961 6c69 7a65 2867 7261 7068  eserialize(graph
+000252c0: 5f68 6561 6465 722c 2067 7261 7068 5f66  _header, graph_f
+000252d0: 7261 6d65 7329 2e64 6174 610a 2020 2020  rames).data.    
+000252e0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000252f0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00025300: 2020 2020 2020 206d 7367 203d 2022 2222         msg = """
+00025310: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00025320: 2020 4572 726f 7220 6475 7269 6e67 2064    Error during d
+00025330: 6573 6572 6961 6c69 7a61 7469 6f6e 206f  eserialization o
+00025340: 6620 7468 6520 7461 736b 2067 7261 7068  f the task graph
+00025350: 2e20 5468 6973 2066 7265 7175 656e 746c  . This frequentl
+00025360: 7920 6f63 6375 7273 2069 6620 7468 6520  y occurs if the 
+00025370: 5363 6865 6475 6c65 7220 616e 6420 436c  Scheduler and Cl
+00025380: 6965 6e74 2068 6176 6520 6469 6666 6572  ient have differ
+00025390: 656e 7420 656e 7669 726f 6e6d 656e 7473  ent environments
+000253a0: 2e20 466f 7220 6d6f 7265 2069 6e66 6f72  . For more infor
+000253b0: 6d61 7469 6f6e 2c20 7365 6520 6874 7470  mation, see http
+000253c0: 733a 2f2f 646f 6373 2e64 6173 6b2e 6f72  s://docs.dask.or
+000253d0: 672f 656e 2f73 7461 626c 652f 6465 706c  g/en/stable/depl
+000253e0: 6f79 6d65 6e74 2d63 6f6e 7369 6465 7261  oyment-considera
+000253f0: 7469 6f6e 732e 6874 6d6c 2363 6f6e 7369  tions.html#consi
+00025400: 7374 656e 742d 736f 6674 7761 7265 2d65  stent-software-e
+00025410: 6e76 6972 6f6e 6d65 6e74 730a 2020 2020  nvironments.    
+00025420: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00025430: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00025440: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00025450: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00025460: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
+00025470: 6d73 6729 2920 6672 6f6d 2065 0a20 2020  msg)) from e.   
+00025480: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00025490: 5275 6e74 696d 6545 7272 6f72 2061 7320  RuntimeError as 
+000254a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000254b0: 2020 2065 7272 203d 2065 7272 6f72 5f6d     err = error_m
+000254c0: 6573 7361 6765 2865 290a 2020 2020 2020  essage(e).      
+000254d0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
+000254e0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+000254f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00025500: 656c 662e 7265 706f 7274 280a 2020 2020  elf.report(.    
+00025510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025520: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00025530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025540: 2020 226f 7022 3a20 2274 6173 6b2d 6572    "op": "task-er
+00025550: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
+00025560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025570: 2020 226b 6579 223a 206b 6579 2c0a 2020    "key": key,.  
+00025580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025590: 2020 2020 2020 2020 2020 2265 7863 6570            "excep
+000255a0: 7469 6f6e 223a 2065 7272 5b22 6578 6365  tion": err["exce
+000255b0: 7074 696f 6e22 5d2c 0a20 2020 2020 2020  ption"],.       
+000255c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000255d0: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
+000255e0: 3a20 6572 725b 2274 7261 6365 6261 636b  : err["traceback
+000255f0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00025600: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
 00025610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025620: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
-00025630: 207b 2261 6374 696f 6e22 3a20 2275 7064   {"action": "upd
-00025640: 6174 655f 6772 6170 6822 2c20 2263 6f75  ate_graph", "cou
-00025650: 6e74 223a 206c 656e 2864 736b 297d 0a20  nt": len(dsk)}. 
-00025660: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00025670: 2020 2020 2073 656c 662e 5f70 6f70 5f6b       self._pop_k
-00025680: 6e6f 776e 5f74 6173 6b73 2864 736b 2c20  nown_tasks(dsk, 
-00025690: 6465 7065 6e64 656e 6369 6573 290a 0a20  dependencies).. 
-000256a0: 2020 2020 2020 2069 6620 6c6f 7374 5f6b         if lost_k
-000256b0: 6579 7320 3a3d 2073 656c 662e 5f70 6f70  eys := self._pop
-000256c0: 5f6c 6f73 745f 7461 736b 7328 6473 6b2c  _lost_tasks(dsk,
-000256d0: 2064 6570 656e 6465 6e63 6965 732c 2072   dependencies, r
-000256e0: 6571 7565 7374 6564 5f6b 6579 7329 3a0a  equested_keys):.
-000256f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00025700: 2e72 6570 6f72 7428 7b22 6f70 223a 2022  .report({"op": "
-00025710: 6361 6e63 656c 6c65 642d 6b65 7973 222c  cancelled-keys",
-00025720: 2022 6b65 7973 223a 206c 6f73 745f 6b65   "keys": lost_ke
-00025730: 7973 7d2c 2063 6c69 656e 743d 636c 6965  ys}, client=clie
-00025740: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-00025750: 7365 6c66 2e63 6c69 656e 745f 7265 6c65  self.client_rele
-00025760: 6173 6573 5f6b 6579 7328 0a20 2020 2020  ases_keys(.     
-00025770: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
-00025780: 6c6f 7374 5f6b 6579 732c 2063 6c69 656e  lost_keys, clien
-00025790: 743d 636c 6965 6e74 2c20 7374 696d 756c  t=client, stimul
-000257a0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-000257b0: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
-000257c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000257d0: 2e74 6f74 616c 5f6f 6363 7570 616e 6379  .total_occupancy
-000257e0: 203e 2031 652d 3920 616e 6420 7365 6c66   > 1e-9 and self
-000257f0: 2e63 6f6d 7075 7461 7469 6f6e 733a 0a20  .computations:. 
-00025800: 2020 2020 2020 2020 2020 2023 2053 7469             # Sti
-00025810: 6c6c 2077 6f72 6b69 6e67 206f 6e20 736f  ll working on so
-00025820: 6d65 7468 696e 672e 2041 7373 6967 6e20  mething. Assign 
-00025830: 6e65 7720 7461 736b 7320 746f 2073 616d  new tasks to sam
-00025840: 6520 636f 6d70 7574 6174 696f 6e0a 2020  e computation.  
-00025850: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
-00025860: 6174 696f 6e20 3d20 7365 6c66 2e63 6f6d  ation = self.com
-00025870: 7075 7461 7469 6f6e 735b 2d31 5d0a 2020  putations[-1].  
-00025880: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00025890: 2020 2020 2020 2020 636f 6d70 7574 6174          computat
-000258a0: 696f 6e20 3d20 436f 6d70 7574 6174 696f  ion = Computatio
-000258b0: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
-000258c0: 7365 6c66 2e63 6f6d 7075 7461 7469 6f6e  self.computation
-000258d0: 732e 6170 7065 6e64 2863 6f6d 7075 7461  s.append(computa
-000258e0: 7469 6f6e 290a 0a20 2020 2020 2020 2069  tion)..        i
-000258f0: 6620 636f 6465 3a20 2023 2061 6464 206e  f code:  # add n
-00025900: 6577 2063 6f64 6520 626c 6f63 6b73 0a20  ew code blocks. 
-00025910: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
-00025920: 7461 7469 6f6e 2e63 6f64 652e 6164 6428  tation.code.add(
-00025930: 636f 6465 290a 2020 2020 2020 2020 6966  code).        if
-00025940: 2061 6e6e 6f74 6174 696f 6e73 3a0a 2020   annotations:.  
-00025950: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
-00025960: 6174 696f 6e2e 616e 6e6f 7461 7469 6f6e  ation.annotation
-00025970: 732e 7570 6461 7465 2861 6e6e 6f74 6174  s.update(annotat
-00025980: 696f 6e73 290a 0a20 2020 2020 2020 2072  ions)..        r
-00025990: 756e 6e61 626c 652c 2074 6f75 6368 6564  unnable, touched
-000259a0: 5f74 6173 6b73 2c20 6e65 775f 7461 736b  _tasks, new_task
-000259b0: 7320 3d20 7365 6c66 2e5f 6765 6e65 7261  s = self._genera
-000259c0: 7465 5f74 6173 6b73 7461 7465 7328 0a20  te_taskstates(. 
-000259d0: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
-000259e0: 7265 7175 6573 7465 645f 6b65 7973 2c0a  requested_keys,.
-000259f0: 2020 2020 2020 2020 2020 2020 6473 6b3d              dsk=
-00025a00: 6473 6b2c 0a20 2020 2020 2020 2020 2020  dsk,.           
-00025a10: 2064 6570 656e 6465 6e63 6965 733d 6465   dependencies=de
-00025a20: 7065 6e64 656e 6369 6573 2c0a 2020 2020  pendencies,.    
-00025a30: 2020 2020 2020 2020 636f 6d70 7574 6174          computat
-00025a40: 696f 6e3d 636f 6d70 7574 6174 696f 6e2c  ion=computation,
-00025a50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00025a60: 2020 2023 2046 4958 4d45 3a20 5468 6573     # FIXME: Thes
-00025a70: 6520 2272 6573 6f6c 7665 645f 616e 6e6f  e "resolved_anno
-00025a80: 7461 7469 6f6e 7322 2061 7265 2061 2062  tations" are a b
-00025a90: 6967 2064 7570 6c69 6361 7469 6f6e 2061  ig duplication a
-00025aa0: 6e64 2061 7265 206f 6e6c 790a 2020 2020  nd are only.    
-00025ab0: 2020 2020 2320 7265 7175 6972 6564 2074      # required t
-00025ac0: 6f20 7361 7469 7366 7920 7468 6520 6375  o satisfy the cu
-00025ad0: 7272 656e 7420 706c 7567 696e 2041 5049  rrent plugin API
-00025ae0: 2e20 5468 6973 2073 686f 756c 6420 6265  . This should be
-00025af0: 0a20 2020 2020 2020 2023 2072 6563 6f6e  .        # recon
-00025b00: 7369 6465 7265 642e 0a20 2020 2020 2020  sidered..       
-00025b10: 2072 6573 6f6c 7665 645f 616e 6e6f 7461   resolved_annota
-00025b20: 7469 6f6e 7320 3d20 7365 6c66 2e5f 7061  tions = self._pa
-00025b30: 7273 655f 616e 645f 6170 706c 795f 616e  rse_and_apply_an
-00025b40: 6e6f 7461 7469 6f6e 7328 0a20 2020 2020  notations(.     
-00025b50: 2020 2020 2020 2074 6173 6b73 3d6e 6577         tasks=new
-00025b60: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-00025b70: 2020 2020 616e 6e6f 7461 7469 6f6e 733d      annotations=
-00025b80: 616e 6e6f 7461 7469 6f6e 732c 0a20 2020  annotations,.   
-00025b90: 2020 2020 2020 2020 206c 6179 6572 5f61           layer_a
-00025ba0: 6e6e 6f74 6174 696f 6e73 3d6c 6179 6572  nnotations=layer
-00025bb0: 5f61 6e6e 6f74 6174 696f 6e73 2c0a 2020  _annotations,.  
-00025bc0: 2020 2020 2020 2020 2020 7072 655f 7374            pre_st
-00025bd0: 7269 6e67 6966 6965 645f 6b65 7973 3d70  ringified_keys=p
-00025be0: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
-00025bf0: 6579 732c 0a20 2020 2020 2020 2029 0a0a  eys,.        )..
-00025c00: 2020 2020 2020 2020 7365 6c66 2e5f 7365          self._se
-00025c10: 745f 7072 696f 7269 7469 6573 280a 2020  t_priorities(.  
-00025c20: 2020 2020 2020 2020 2020 696e 7465 726e            intern
-00025c30: 616c 5f70 7269 6f72 6974 793d 696e 7465  al_priority=inte
-00025c40: 726e 616c 5f70 7269 6f72 6974 792c 0a20  rnal_priority,. 
-00025c50: 2020 2020 2020 2020 2020 2073 7562 6d69             submi
-00025c60: 7474 696e 675f 7461 736b 3d73 7562 6d69  tting_task=submi
-00025c70: 7474 696e 675f 7461 736b 2c0a 2020 2020  tting_task,.    
-00025c80: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
-00025c90: 6f72 6974 793d 7573 6572 5f70 7269 6f72  ority=user_prior
-00025ca0: 6974 792c 0a20 2020 2020 2020 2020 2020  ity,.           
-00025cb0: 2066 6966 6f5f 7469 6d65 6f75 743d 6669   fifo_timeout=fi
-00025cc0: 666f 5f74 696d 656f 7574 2c0a 2020 2020  fo_timeout,.    
-00025cd0: 2020 2020 2020 2020 7374 6172 743d 7374          start=st
-00025ce0: 6172 742c 0a20 2020 2020 2020 2020 2020  art,.           
-00025cf0: 2064 736b 3d64 736b 2c0a 2020 2020 2020   dsk=dsk,.      
-00025d00: 2020 2020 2020 7461 736b 733d 7275 6e6e        tasks=runn
-00025d10: 6162 6c65 2c0a 2020 2020 2020 2020 2020  able,.          
-00025d20: 2020 6465 7065 6e64 656e 6369 6573 3d64    dependencies=d
-00025d30: 6570 656e 6465 6e63 6965 732c 0a20 2020  ependencies,.   
-00025d40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00025d50: 7365 6c66 2e63 6c69 656e 745f 6465 7369  self.client_desi
-00025d60: 7265 735f 6b65 7973 286b 6579 733d 7265  res_keys(keys=re
-00025d70: 7175 6573 7465 645f 6b65 7973 2c20 636c  quested_keys, cl
-00025d80: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
-00025d90: 2020 2020 2020 2320 4164 6420 6163 746f        # Add acto
-00025da0: 7273 0a20 2020 2020 2020 2069 6620 6163  rs.        if ac
-00025db0: 746f 7273 2069 7320 5472 7565 3a0a 2020  tors is True:.  
-00025dc0: 2020 2020 2020 2020 2020 6163 746f 7273            actors
-00025dd0: 203d 206c 6973 7428 7265 7175 6573 7465   = list(requeste
-00025de0: 645f 6b65 7973 290a 2020 2020 2020 2020  d_keys).        
-00025df0: 666f 7220 6163 746f 7220 696e 2061 6374  for actor in act
-00025e00: 6f72 7320 6f72 205b 5d3a 0a20 2020 2020  ors or []:.     
-00025e10: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00025e20: 2e74 6173 6b73 5b61 6374 6f72 5d0a 2020  .tasks[actor].  
-00025e30: 2020 2020 2020 2020 2020 7473 2e61 6374            ts.act
-00025e40: 6f72 203d 2054 7275 650a 0a20 2020 2020  or = True..     
-00025e50: 2020 2023 2043 6f6d 7075 7465 2072 6563     # Compute rec
-00025e60: 6f6d 6d65 6e64 6174 696f 6e73 0a20 2020  ommendations.   
-00025e70: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00025e80: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00025e90: 2020 2020 2020 2020 7072 696f 7269 7479          priority
-00025ea0: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
-00025eb0: 2020 666f 7220 7473 2069 6e20 736f 7274    for ts in sort
-00025ec0: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
-00025ed0: 7275 6e6e 6162 6c65 2c0a 2020 2020 2020  runnable,.      
-00025ee0: 2020 2020 2020 6b65 793d 6f70 6572 6174        key=operat
-00025ef0: 6f72 2e61 7474 7267 6574 7465 7228 2270  or.attrgetter("p
-00025f00: 7269 6f72 6974 7922 292c 0a20 2020 2020  riority"),.     
-00025f10: 2020 2020 2020 2072 6576 6572 7365 3d54         reverse=T
-00025f20: 7275 652c 0a20 2020 2020 2020 2029 3a0a  rue,.        ):.
-00025f30: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00025f40: 7274 2074 732e 7072 696f 7269 7479 2020  rt ts.priority  
-00025f50: 2320 6d79 7079 0a20 2020 2020 2020 2020  # mypy.         
-00025f60: 2020 2070 7269 6f72 6974 795b 7473 2e6b     priority[ts.k
-00025f70: 6579 5d20 3d20 7473 2e70 7269 6f72 6974  ey] = ts.priorit
-00025f80: 790a 2020 2020 2020 2020 2020 2020 6173  y.            as
-00025f90: 7365 7274 2074 732e 7275 6e5f 7370 6563  sert ts.run_spec
-00025fa0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00025fb0: 7473 2e73 7461 7465 203d 3d20 2272 656c  ts.state == "rel
-00025fc0: 6561 7365 6422 3a0a 2020 2020 2020 2020  eased":.        
-00025fd0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00025fe0: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
-00025ff0: 3d20 2277 6169 7469 6e67 220a 0a20 2020  = "waiting"..   
-00026000: 2020 2020 2066 6f72 2074 7320 696e 2072       for ts in r
-00026010: 756e 6e61 626c 653a 0a20 2020 2020 2020  unnable:.       
-00026020: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-00026030: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-00026040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026050: 2069 6620 6474 732e 6578 6365 7074 696f   if dts.exceptio
-00026060: 6e5f 626c 616d 653a 0a20 2020 2020 2020  n_blame:.       
-00026070: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00026080: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
-00026090: 3d20 6474 732e 6578 6365 7074 696f 6e5f  = dts.exception_
-000260a0: 626c 616d 650a 2020 2020 2020 2020 2020  blame.          
-000260b0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-000260c0: 656e 6461 7469 6f6e 735b 7473 2e6b 6579  endations[ts.key
-000260d0: 5d20 3d20 2265 7272 6564 220a 2020 2020  ] = "erred".    
-000260e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000260f0: 6272 6561 6b0a 0a20 2020 2020 2020 2066  break..        f
-00026100: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
-00026110: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
-00026120: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
-00026130: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00026140: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
-00026150: 6e2e 7570 6461 7465 5f67 7261 7068 280a  n.update_graph(.
-00026160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026170: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00026180: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00026190: 6965 6e74 3d63 6c69 656e 742c 0a20 2020  ient=client,.   
-000261a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000261b0: 2074 6173 6b73 3d5b 7473 2e6b 6579 2066   tasks=[ts.key f
-000261c0: 6f72 2074 7320 696e 2074 6f75 6368 6564  or ts in touched
-000261d0: 5f74 6173 6b73 5d2c 0a20 2020 2020 2020  _tasks],.       
-000261e0: 2020 2020 2020 2020 2020 2020 206b 6579               key
-000261f0: 733d 7265 7175 6573 7465 645f 6b65 7973  s=requested_keys
-00026200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00026210: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-00026220: 6573 3d64 6570 656e 6465 6e63 6965 732c  es=dependencies,
-00026230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026240: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
-00026250: 3d72 6573 6f6c 7665 645f 616e 6e6f 7461  =resolved_annota
-00026260: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-00026270: 2020 2020 2020 2020 2020 2070 7269 6f72             prior
-00026280: 6974 793d 7072 696f 7269 7479 2c0a 2020  ity=priority,.  
-00026290: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000262a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000262b0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-000262c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000262d0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
-000262e0: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
-000262f0: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
-00026300: 2872 6563 6f6d 6d65 6e64 6174 696f 6e73  (recommendations
-00026310: 2c20 7374 696d 756c 7573 5f69 6429 0a0a  , stimulus_id)..
-00026320: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
-00026330: 6e20 746f 7563 6865 645f 7461 736b 733a  n touched_tasks:
-00026340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00026350: 7473 2e73 7461 7465 2069 6e20 2822 6d65  ts.state in ("me
-00026360: 6d6f 7279 222c 2022 6572 7265 6422 293a  mory", "erred"):
-00026370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026380: 2073 656c 662e 7265 706f 7274 5f6f 6e5f   self.report_on_
-00026390: 6b65 7928 7473 3d74 732c 2063 6c69 656e  key(ts=ts, clien
-000263a0: 743d 636c 6965 6e74 290a 0a20 2020 2020  t=client)..     
-000263b0: 2020 2065 6e64 203d 2074 696d 6528 290a     end = time().
-000263c0: 2020 2020 2020 2020 7365 6c66 2e64 6967          self.dig
-000263d0: 6573 745f 6d65 7472 6963 2822 7570 6461  est_metric("upda
-000263e0: 7465 2d67 7261 7068 2d64 7572 6174 696f  te-graph-duratio
-000263f0: 6e22 2c20 656e 6420 2d20 7374 6172 7429  n", end - start)
-00026400: 0a0a 2020 2020 6465 6620 5f67 656e 6572  ..    def _gener
-00026410: 6174 655f 7461 736b 7374 6174 6573 280a  ate_taskstates(.
-00026420: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-00026430: 7973 3a20 7365 745b 7374 725d 2c20 6473  ys: set[str], ds
-00026440: 6b3a 2064 6963 742c 2064 6570 656e 6465  k: dict, depende
-00026450: 6e63 6965 733a 2064 6963 742c 2063 6f6d  ncies: dict, com
-00026460: 7075 7461 7469 6f6e 3a20 436f 6d70 7574  putation: Comput
-00026470: 6174 696f 6e0a 2020 2020 2920 2d3e 2074  ation.    ) -> t
-00026480: 7570 6c65 3a0a 2020 2020 2020 2020 2320  uple:.        # 
-00026490: 4765 7420 6f72 2063 7265 6174 6520 7461  Get or create ta
-000264a0: 736b 2073 7461 7465 730a 2020 2020 2020  sk states.      
-000264b0: 2020 7275 6e6e 6162 6c65 203d 205b 5d0a    runnable = [].
-000264c0: 2020 2020 2020 2020 6e65 775f 7461 736b          new_task
-000264d0: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
-000264e0: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
-000264f0: 290a 2020 2020 2020 2020 7461 736b 7320  ).        tasks 
-00026500: 3d20 5b5d 0a20 2020 2020 2020 2074 6f75  = [].        tou
-00026510: 6368 6564 5f6b 6579 7320 3d20 7365 7428  ched_keys = set(
-00026520: 290a 2020 2020 2020 2020 746f 7563 6865  ).        touche
-00026530: 645f 7461 736b 7320 3d20 5b5d 0a20 2020  d_tasks = [].   
-00026540: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
-00026550: 3a0a 2020 2020 2020 2020 2020 2020 6b20  :.            k 
-00026560: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
-00026570: 2020 2020 2020 2020 2020 6966 206b 2069            if k i
-00026580: 6e20 746f 7563 6865 645f 6b65 7973 3a0a  n touched_keys:.
-00026590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000265a0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-000265b0: 2020 2020 2023 2058 5858 2048 6176 6520       # XXX Have 
-000265c0: 6120 6d65 7468 6f64 2067 6574 5f74 6173  a method get_tas
-000265d0: 6b5f 7374 6174 6528 7365 6c66 2c20 6b29  k_state(self, k)
-000265e0: 203f 0a20 2020 2020 2020 2020 2020 2074   ?.            t
-000265f0: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
-00026600: 6574 286b 290a 2020 2020 2020 2020 2020  et(k).          
-00026610: 2020 7461 736b 732e 6170 7065 6e64 2874    tasks.append(t
-00026620: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-00026630: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-00026640: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00026650: 203d 2073 656c 662e 6e65 775f 7461 736b   = self.new_task
-00026660: 286b 2c20 6473 6b2e 6765 7428 6b29 2c20  (k, dsk.get(k), 
-00026670: 2272 656c 6561 7365 6422 2c20 636f 6d70  "released", comp
-00026680: 7574 6174 696f 6e3d 636f 6d70 7574 6174  utation=computat
-00026690: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
-000266a0: 2020 2020 206e 6577 5f74 6173 6b73 2e61       new_tasks.a
-000266b0: 7070 656e 6428 7473 290a 2020 2020 2020  ppend(ts).      
-000266c0: 2020 2020 2020 656c 6966 206e 6f74 2074        elif not t
-000266d0: 732e 7275 6e5f 7370 6563 3a0a 2020 2020  s.run_spec:.    
-000266e0: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
-000266f0: 756e 5f73 7065 6320 3d20 6473 6b2e 6765  un_spec = dsk.ge
-00026700: 7428 6b29 0a0a 2020 2020 2020 2020 2020  t(k)..          
-00026710: 2020 6966 2074 732e 7275 6e5f 7370 6563    if ts.run_spec
-00026720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026730: 2020 7275 6e6e 6162 6c65 2e61 7070 656e    runnable.appen
-00026740: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00026750: 2020 746f 7563 6865 645f 6b65 7973 2e61    touched_keys.a
-00026760: 6464 286b 290a 2020 2020 2020 2020 2020  dd(k).          
-00026770: 2020 746f 7563 6865 645f 7461 736b 732e    touched_tasks.
-00026780: 6170 7065 6e64 2874 7329 0a20 2020 2020  append(ts).     
-00026790: 2020 2020 2020 2073 7461 636b 2e65 7874         stack.ext
-000267a0: 656e 6428 6465 7065 6e64 656e 6369 6573  end(dependencies
-000267b0: 2e67 6574 286b 2c20 2829 2929 0a0a 2020  .get(k, ()))..  
-000267c0: 2020 2020 2020 2320 4164 6420 6465 7065        # Add depe
-000267d0: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
-000267e0: 2066 6f72 206b 6579 2c20 6465 7073 2069   for key, deps i
-000267f0: 6e20 6465 7065 6e64 656e 6369 6573 2e69  n dependencies.i
-00026800: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00026810: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00026820: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-00026830: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-00026840: 7320 4e6f 6e65 206f 7220 7473 2e64 6570  s None or ts.dep
-00026850: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00026860: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00026870: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00026880: 666f 7220 6465 7020 696e 2064 6570 733a  for dep in deps:
-00026890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000268a0: 2064 7473 203d 2073 656c 662e 7461 736b   dts = self.task
-000268b0: 735b 6465 705d 0a20 2020 2020 2020 2020  s[dep].         
-000268c0: 2020 2020 2020 2074 732e 6164 645f 6465         ts.add_de
-000268d0: 7065 6e64 656e 6379 2864 7473 290a 0a20  pendency(dts).. 
-000268e0: 2020 2020 2020 2069 6620 6c65 6e28 746f         if len(to
-000268f0: 7563 6865 645f 7461 736b 7329 203c 206c  uched_tasks) < l
-00026900: 656e 286b 6579 7329 3a0a 2020 2020 2020  en(keys):.      
-00026910: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00026920: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00026930: 2020 2022 5375 626d 6974 7465 6420 6772     "Submitted gr
-00026940: 6170 6820 7769 7468 206c 656e 6774 6820  aph with length 
-00026950: 2573 2062 7574 2072 6571 7565 7374 6564  %s but requested
-00026960: 2067 7261 7068 206f 6e6c 7920 696e 636c   graph only incl
-00026970: 7564 6573 2025 7320 6b65 7973 222c 0a20  udes %s keys",. 
-00026980: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00026990: 656e 2874 6f75 6368 6564 5f74 6173 6b73  en(touched_tasks
-000269a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000269b0: 2020 206c 656e 286b 6579 7329 2c0a 2020     len(keys),.  
-000269c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000269d0: 2020 2020 7265 7475 726e 2072 756e 6e61      return runna
-000269e0: 626c 652c 2074 6f75 6368 6564 5f74 6173  ble, touched_tas
-000269f0: 6b73 2c20 6e65 775f 7461 736b 730a 0a20  ks, new_tasks.. 
-00026a00: 2020 2064 6566 205f 7061 7273 655f 616e     def _parse_an
-00026a10: 645f 6170 706c 795f 616e 6e6f 7461 7469  d_apply_annotati
-00026a20: 6f6e 7328 0a20 2020 2020 2020 2073 656c  ons(.        sel
-00026a30: 662c 0a20 2020 2020 2020 2074 6173 6b73  f,.        tasks
-00026a40: 3a20 4974 6572 6162 6c65 5b54 6173 6b53  : Iterable[TaskS
-00026a50: 7461 7465 5d2c 0a20 2020 2020 2020 2061  tate],.        a
-00026a60: 6e6e 6f74 6174 696f 6e73 3a20 6469 6374  nnotations: dict
-00026a70: 2c0a 2020 2020 2020 2020 6c61 7965 725f  ,.        layer_
-00026a80: 616e 6e6f 7461 7469 6f6e 733a 2064 6963  annotations: dic
-00026a90: 745b 7374 722c 2064 6963 745d 2c0a 2020  t[str, dict],.  
-00026aa0: 2020 2020 2020 7072 655f 7374 7269 6e67        pre_string
-00026ab0: 6966 6965 645f 6b65 7973 3a20 6469 6374  ified_keys: dict
-00026ac0: 5b48 6173 6861 626c 652c 2073 7472 5d2c  [Hashable, str],
-00026ad0: 0a20 2020 2029 202d 3e20 6469 6374 5b73  .    ) -> dict[s
-00026ae0: 7472 2c20 6469 6374 5b73 7472 2c20 416e  tr, dict[str, An
-00026af0: 795d 5d3a 0a20 2020 2020 2020 2022 2222  y]]:.        """
-00026b00: 4170 706c 7920 7468 6520 7072 6f76 6964  Apply the provid
-00026b10: 6564 2061 6e6e 6f74 6174 696f 6e73 2074  ed annotations t
-00026b20: 6f20 7468 6520 7072 6f76 6964 6564 2060  o the provided `
-00026b30: 5461 736b 5374 6174 6560 206f 626a 6563  TaskState` objec
-00026b40: 7473 2e0a 0a20 2020 2020 2020 2054 6865  ts...        The
-00026b50: 2072 6177 2061 6e6e 6f74 6174 696f 6e73   raw annotations
-00026b60: 2077 696c 6c20 6265 2073 746f 7265 6420   will be stored 
-00026b70: 696e 2074 6865 2060 616e 6e6f 7461 7469  in the `annotati
-00026b80: 6f6e 7360 2061 7474 7269 6275 7465 2e0a  ons` attribute..
-00026b90: 0a20 2020 2020 2020 204c 6179 6572 202f  .        Layer /
-00026ba0: 206b 6579 2073 7065 6369 6669 6320 616e   key specific an
-00026bb0: 6e6f 7461 7469 6f6e 7320 7769 6c6c 2074  notations will t
-00026bc0: 616b 6520 7072 6563 6564 656e 6365 206f  ake precedence o
-00026bd0: 7665 7220 676c 6f62 616c 202f 2067 656e  ver global / gen
-00026be0: 6572 6963 2061 6e6e 6f74 6174 696f 6e73  eric annotations
-00026bf0: 2e0a 0a20 2020 2020 2020 2050 6172 616d  ...        Param
-00026c00: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
-00026c10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00026c20: 2074 6173 6b73 203a 2049 7465 7261 626c   tasks : Iterabl
-00026c30: 655b 5461 736b 5374 6174 655d 0a20 2020  e[TaskState].   
-00026c40: 2020 2020 2020 2020 205f 6465 7363 7269           _descri
-00026c50: 7074 696f 6e5f 0a20 2020 2020 2020 2061  ption_.        a
-00026c60: 6e6e 6f74 6174 696f 6e73 203a 2064 6963  nnotations : dic
-00026c70: 740a 2020 2020 2020 2020 2020 2020 5f64  t.            _d
-00026c80: 6573 6372 6970 7469 6f6e 5f0a 2020 2020  escription_.    
-00026c90: 2020 2020 6c61 7965 725f 616e 6e6f 7461      layer_annota
-00026ca0: 7469 6f6e 7320 3a20 6469 6374 5b73 7472  tions : dict[str
-00026cb0: 2c20 6469 6374 5d0a 2020 2020 2020 2020  , dict].        
-00026cc0: 2020 2020 5f64 6573 6372 6970 7469 6f6e      _description
-00026cd0: 5f0a 0a20 2020 2020 2020 2052 6574 7572  _..        Retur
-00026ce0: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
-00026cf0: 2d2d 0a20 2020 2020 2020 2072 6573 6f6c  --.        resol
-00026d00: 7665 645f 616e 6e6f 7461 7469 6f6e 733a  ved_annotations:
-00026d10: 2064 6963 740a 2020 2020 2020 2020 2020   dict.          
-00026d20: 2020 4120 6d61 7070 696e 6720 6f66 2061    A mapping of a
-00026d30: 6c6c 2072 6573 6f6c 7665 6420 616e 6e6f  ll resolved anno
-00026d40: 7461 7469 6f6e 7320 696e 2074 6865 2066  tations in the f
-00026d50: 6f72 6d61 743a 3a0a 0a20 2020 2020 2020  ormat::..       
-00026d60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00026d70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00026d80: 616e 6e6f 7461 7469 6f6e 223a 207b 0a20  annotation": {. 
-00026d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026da0: 2020 2020 2020 2022 6b65 7922 3a20 7661         "key": va
-00026db0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-00026dc0: 2020 2020 2020 2020 2020 2020 202e 2e2e               ...
-00026dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026de0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00026df0: 2020 2020 2020 2020 2020 2020 2e2e 2e0a              ....
-00026e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026e10: 7d0a 2020 2020 2020 2020 2222 220a 2020  }.        """.  
-00026e20: 2020 2020 2020 7265 736f 6c76 6564 5f61        resolved_a
-00026e30: 6e6e 6f74 6174 696f 6e73 3a20 6469 6374  nnotations: dict
-00026e40: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-00026e50: 416e 795d 5d20 3d20 6465 6661 756c 7464  Any]] = defaultd
-00026e60: 6963 7428 6469 6374 290a 2020 2020 2020  ict(dict).      
-00026e70: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
-00026e80: 733a 0a20 2020 2020 2020 2020 2020 206b  s:.            k
-00026e90: 6579 203d 2074 732e 6b65 790a 2020 2020  ey = ts.key.    
-00026ea0: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
-00026eb0: 6f75 6c64 2062 6520 6120 7479 7065 6420  ould be a typed 
-00026ec0: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
-00026ed0: 2069 6620 6e6f 7420 616e 6e6f 7461 7469   if not annotati
-00026ee0: 6f6e 7320 616e 6420 6b65 7920 6e6f 7420  ons and key not 
-00026ef0: 696e 206c 6179 6572 5f61 6e6e 6f74 6174  in layer_annotat
-00026f00: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00026f10: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00026f20: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-00026f30: 2061 6e6e 6f74 6174 696f 6e73 2e63 6f70   annotations.cop
-00026f40: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00026f50: 6f75 742e 7570 6461 7465 286c 6179 6572  out.update(layer
-00026f60: 5f61 6e6e 6f74 6174 696f 6e73 2e67 6574  _annotations.get
-00026f70: 286b 6579 2c20 7b7d 2929 0a20 2020 2020  (key, {})).     
-00026f80: 2020 2020 2020 2066 6f72 2061 6e6e 6f74         for annot
-00026f90: 2c20 7661 6c75 6520 696e 206f 7574 2e69  , value in out.i
-00026fa0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00026fb0: 2020 2020 2020 2020 2320 506f 7020 7468          # Pop th
-00026fc0: 6520 6b65 7920 7369 6e63 6520 6e61 6d65  e key since name
-00026fd0: 7320 646f 6e27 7420 616c 7761 7973 206d  s don't always m
-00026fe0: 6174 6368 2061 7474 7269 6275 7465 730a  atch attributes.
-00026ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027000: 6966 2063 616c 6c61 626c 6528 7661 6c75  if callable(valu
-00027010: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00027020: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-00027030: 7661 6c75 6528 7072 655f 7374 7269 6e67  value(pre_string
-00027040: 6966 6965 645f 6b65 7973 5b6b 6579 5d29  ified_keys[key])
-00027050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027060: 206f 7574 5b61 6e6e 6f74 5d20 3d20 7661   out[annot] = va
-00027070: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-00027080: 2020 2020 7265 736f 6c76 6564 5f61 6e6e      resolved_ann
-00027090: 6f74 6174 696f 6e73 5b61 6e6e 6f74 5d5b  otations[annot][
-000270a0: 6b65 795d 203d 2076 616c 7565 0a0a 2020  key] = value..  
-000270b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000270c0: 2061 6e6e 6f74 2069 6e20 2822 7265 7374   annot in ("rest
-000270d0: 7269 6374 696f 6e73 222c 2022 776f 726b  rictions", "work
-000270e0: 6572 7322 293a 0a20 2020 2020 2020 2020  ers"):.         
+00025620: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00025630: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00025640: 616e 6e6f 7461 7469 6f6e 7320 3d20 616e  annotations = an
+00025650: 6e6f 7461 7469 6f6e 7320 6f72 207b 7d0a  notations or {}.
+00025660: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00025670: 7461 6e63 6528 616e 6e6f 7461 7469 6f6e  tance(annotation
+00025680: 732c 2054 6f50 6963 6b6c 6529 3a20 2023  s, ToPickle):  #
+00025690: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+000256a0: 2020 2020 2020 2020 2020 2320 4649 584d            # FIXM
+000256b0: 453a 2077 6861 7420 7468 6520 6865 636b  E: what the heck
+000256c0: 3f0a 2020 2020 2020 2020 2020 2020 616e  ?.            an
+000256d0: 6e6f 7461 7469 6f6e 7320 3d20 616e 6e6f  notations = anno
+000256e0: 7461 7469 6f6e 732e 6461 7461 2020 2320  tations.data  # 
+000256f0: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+00025700: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00025710: 203d 2073 7469 6d75 6c75 735f 6964 206f   = stimulus_id o
+00025720: 7220 6622 7570 6461 7465 2d67 7261 7068  r f"update-graph
+00025730: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
+00025740: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
+00025750: 2064 736b 2c0a 2020 2020 2020 2020 2020   dsk,.          
+00025760: 2020 6465 7065 6e64 656e 6369 6573 2c0a    dependencies,.
+00025770: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00025780: 725f 616e 6e6f 7461 7469 6f6e 732c 0a20  r_annotations,. 
+00025790: 2020 2020 2020 2020 2020 2070 7265 5f73             pre_s
+000257a0: 7472 696e 6769 6669 6564 5f6b 6579 732c  tringified_keys,
+000257b0: 0a20 2020 2020 2020 2029 203d 2073 656c  .        ) = sel
+000257c0: 662e 6d61 7465 7269 616c 697a 655f 6772  f.materialize_gr
+000257d0: 6170 6828 6772 6170 6829 0a0a 2020 2020  aph(graph)..    
+000257e0: 2020 2020 7265 7175 6573 7465 645f 6b65      requested_ke
+000257f0: 7973 203d 2073 6574 286b 6579 7329 0a20  ys = set(keys). 
+00025800: 2020 2020 2020 2064 656c 206b 6579 730a         del keys.
+00025810: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
+00025820: 736b 2920 3e20 313a 0a20 2020 2020 2020  sk) > 1:.       
+00025830: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
+00025840: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
+00025850: 2020 2020 205b 2261 6c6c 222c 2063 6c69       ["all", cli
+00025860: 656e 745d 2c20 7b22 6163 7469 6f6e 223a  ent], {"action":
+00025870: 2022 7570 6461 7465 5f67 7261 7068 222c   "update_graph",
+00025880: 2022 636f 756e 7422 3a20 6c65 6e28 6473   "count": len(ds
+00025890: 6b29 7d0a 2020 2020 2020 2020 2020 2020  k)}.            
+000258a0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+000258b0: 706f 705f 6b6e 6f77 6e5f 7461 736b 7328  pop_known_tasks(
+000258c0: 6473 6b2c 2064 6570 656e 6465 6e63 6965  dsk, dependencie
+000258d0: 7329 0a0a 2020 2020 2020 2020 6966 206c  s)..        if l
+000258e0: 6f73 745f 6b65 7973 203a 3d20 7365 6c66  ost_keys := self
+000258f0: 2e5f 706f 705f 6c6f 7374 5f74 6173 6b73  ._pop_lost_tasks
+00025900: 2864 736b 2c20 6465 7065 6e64 656e 6369  (dsk, dependenci
+00025910: 6573 2c20 7265 7175 6573 7465 645f 6b65  es, requested_ke
+00025920: 7973 293a 0a20 2020 2020 2020 2020 2020  ys):.           
+00025930: 2073 656c 662e 7265 706f 7274 287b 226f   self.report({"o
+00025940: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
+00025950: 6579 7322 2c20 226b 6579 7322 3a20 6c6f  eys", "keys": lo
+00025960: 7374 5f6b 6579 737d 2c20 636c 6965 6e74  st_keys}, client
+00025970: 3d63 6c69 656e 7429 0a20 2020 2020 2020  =client).       
+00025980: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00025990: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
+000259a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000259b0: 6b65 7973 3d6c 6f73 745f 6b65 7973 2c20  keys=lost_keys, 
+000259c0: 636c 6965 6e74 3d63 6c69 656e 742c 2073  client=client, s
+000259d0: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+000259e0: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
+000259f0: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
+00025a00: 206e 6f74 2073 656c 662e 6973 5f69 646c   not self.is_idl
+00025a10: 6520 616e 6420 7365 6c66 2e63 6f6d 7075  e and self.compu
+00025a20: 7461 7469 6f6e 733a 0a20 2020 2020 2020  tations:.       
+00025a30: 2020 2020 2023 2053 7469 6c6c 2077 6f72       # Still wor
+00025a40: 6b69 6e67 206f 6e20 736f 6d65 7468 696e  king on somethin
+00025a50: 672e 2041 7373 6967 6e20 6e65 7720 7461  g. Assign new ta
+00025a60: 736b 7320 746f 2073 616d 6520 636f 6d70  sks to same comp
+00025a70: 7574 6174 696f 6e0a 2020 2020 2020 2020  utation.        
+00025a80: 2020 2020 636f 6d70 7574 6174 696f 6e20      computation 
+00025a90: 3d20 7365 6c66 2e63 6f6d 7075 7461 7469  = self.computati
+00025aa0: 6f6e 735b 2d31 5d0a 2020 2020 2020 2020  ons[-1].        
+00025ab0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00025ac0: 2020 636f 6d70 7574 6174 696f 6e20 3d20    computation = 
+00025ad0: 436f 6d70 7574 6174 696f 6e28 290a 2020  Computation().  
+00025ae0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00025af0: 6f6d 7075 7461 7469 6f6e 732e 6170 7065  omputations.appe
+00025b00: 6e64 2863 6f6d 7075 7461 7469 6f6e 290a  nd(computation).
+00025b10: 0a20 2020 2020 2020 2069 6620 636f 6465  .        if code
+00025b20: 3a20 2023 2061 6464 206e 6577 2063 6f64  :  # add new cod
+00025b30: 6520 626c 6f63 6b73 0a20 2020 2020 2020  e blocks.       
+00025b40: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
+00025b50: 2e63 6f64 652e 6164 6428 636f 6465 290a  .code.add(code).
+00025b60: 2020 2020 2020 2020 6966 2061 6e6e 6f74          if annot
+00025b70: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
+00025b80: 2020 2020 636f 6d70 7574 6174 696f 6e2e      computation.
+00025b90: 616e 6e6f 7461 7469 6f6e 732e 7570 6461  annotations.upda
+00025ba0: 7465 2861 6e6e 6f74 6174 696f 6e73 290a  te(annotations).
+00025bb0: 0a20 2020 2020 2020 2072 756e 6e61 626c  .        runnabl
+00025bc0: 652c 2074 6f75 6368 6564 5f74 6173 6b73  e, touched_tasks
+00025bd0: 2c20 6e65 775f 7461 736b 7320 3d20 7365  , new_tasks = se
+00025be0: 6c66 2e5f 6765 6e65 7261 7465 5f74 6173  lf._generate_tas
+00025bf0: 6b73 7461 7465 7328 0a20 2020 2020 2020  kstates(.       
+00025c00: 2020 2020 206b 6579 733d 7265 7175 6573       keys=reques
+00025c10: 7465 645f 6b65 7973 2c0a 2020 2020 2020  ted_keys,.      
+00025c20: 2020 2020 2020 6473 6b3d 6473 6b2c 0a20        dsk=dsk,. 
+00025c30: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00025c40: 6465 6e63 6965 733d 6465 7065 6e64 656e  dencies=dependen
+00025c50: 6369 6573 2c0a 2020 2020 2020 2020 2020  cies,.          
+00025c60: 2020 636f 6d70 7574 6174 696f 6e3d 636f    computation=co
+00025c70: 6d70 7574 6174 696f 6e2c 0a20 2020 2020  mputation,.     
+00025c80: 2020 2029 0a20 2020 2020 2020 2023 2046     ).        # F
+00025c90: 4958 4d45 3a20 5468 6573 6520 2272 6573  IXME: These "res
+00025ca0: 6f6c 7665 645f 616e 6e6f 7461 7469 6f6e  olved_annotation
+00025cb0: 7322 2061 7265 2061 2062 6967 2064 7570  s" are a big dup
+00025cc0: 6c69 6361 7469 6f6e 2061 6e64 2061 7265  lication and are
+00025cd0: 206f 6e6c 790a 2020 2020 2020 2020 2320   only.        # 
+00025ce0: 7265 7175 6972 6564 2074 6f20 7361 7469  required to sati
+00025cf0: 7366 7920 7468 6520 6375 7272 656e 7420  sfy the current 
+00025d00: 706c 7567 696e 2041 5049 2e20 5468 6973  plugin API. This
+00025d10: 2073 686f 756c 6420 6265 0a20 2020 2020   should be.     
+00025d20: 2020 2023 2072 6563 6f6e 7369 6465 7265     # reconsidere
+00025d30: 642e 0a20 2020 2020 2020 2072 6573 6f6c  d..        resol
+00025d40: 7665 645f 616e 6e6f 7461 7469 6f6e 7320  ved_annotations 
+00025d50: 3d20 7365 6c66 2e5f 7061 7273 655f 616e  = self._parse_an
+00025d60: 645f 6170 706c 795f 616e 6e6f 7461 7469  d_apply_annotati
+00025d70: 6f6e 7328 0a20 2020 2020 2020 2020 2020  ons(.           
+00025d80: 2074 6173 6b73 3d6e 6577 5f74 6173 6b73   tasks=new_tasks
+00025d90: 2c0a 2020 2020 2020 2020 2020 2020 616e  ,.            an
+00025da0: 6e6f 7461 7469 6f6e 733d 616e 6e6f 7461  notations=annota
+00025db0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+00025dc0: 2020 206c 6179 6572 5f61 6e6e 6f74 6174     layer_annotat
+00025dd0: 696f 6e73 3d6c 6179 6572 5f61 6e6e 6f74  ions=layer_annot
+00025de0: 6174 696f 6e73 2c0a 2020 2020 2020 2020  ations,.        
+00025df0: 2020 2020 7072 655f 7374 7269 6e67 6966      pre_stringif
+00025e00: 6965 645f 6b65 7973 3d70 7265 5f73 7472  ied_keys=pre_str
+00025e10: 696e 6769 6669 6564 5f6b 6579 732c 0a20  ingified_keys,. 
+00025e20: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00025e30: 2020 7365 6c66 2e5f 7365 745f 7072 696f    self._set_prio
+00025e40: 7269 7469 6573 280a 2020 2020 2020 2020  rities(.        
+00025e50: 2020 2020 696e 7465 726e 616c 5f70 7269      internal_pri
+00025e60: 6f72 6974 793d 696e 7465 726e 616c 5f70  ority=internal_p
+00025e70: 7269 6f72 6974 792c 0a20 2020 2020 2020  riority,.       
+00025e80: 2020 2020 2073 7562 6d69 7474 696e 675f       submitting_
+00025e90: 7461 736b 3d73 7562 6d69 7474 696e 675f  task=submitting_
+00025ea0: 7461 736b 2c0a 2020 2020 2020 2020 2020  task,.          
+00025eb0: 2020 7573 6572 5f70 7269 6f72 6974 793d    user_priority=
+00025ec0: 7573 6572 5f70 7269 6f72 6974 792c 0a20  user_priority,. 
+00025ed0: 2020 2020 2020 2020 2020 2066 6966 6f5f             fifo_
+00025ee0: 7469 6d65 6f75 743d 6669 666f 5f74 696d  timeout=fifo_tim
+00025ef0: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
+00025f00: 2020 7374 6172 743d 7374 6172 742c 0a20    start=start,. 
+00025f10: 2020 2020 2020 2020 2020 2064 736b 3d64             dsk=d
+00025f20: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00025f30: 7461 736b 733d 7275 6e6e 6162 6c65 2c0a  tasks=runnable,.
+00025f40: 2020 2020 2020 2020 2020 2020 6465 7065              depe
+00025f50: 6e64 656e 6369 6573 3d64 6570 656e 6465  ndencies=depende
+00025f60: 6e63 6965 732c 0a20 2020 2020 2020 2029  ncies,.        )
+00025f70: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+00025f80: 6c69 656e 745f 6465 7369 7265 735f 6b65  lient_desires_ke
+00025f90: 7973 286b 6579 733d 7265 7175 6573 7465  ys(keys=requeste
+00025fa0: 645f 6b65 7973 2c20 636c 6965 6e74 3d63  d_keys, client=c
+00025fb0: 6c69 656e 7429 0a0a 2020 2020 2020 2020  lient)..        
+00025fc0: 2320 4164 6420 6163 746f 7273 0a20 2020  # Add actors.   
+00025fd0: 2020 2020 2069 6620 6163 746f 7273 2069       if actors i
+00025fe0: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
+00025ff0: 2020 2020 6163 746f 7273 203d 206c 6973      actors = lis
+00026000: 7428 7265 7175 6573 7465 645f 6b65 7973  t(requested_keys
+00026010: 290a 2020 2020 2020 2020 666f 7220 6163  ).        for ac
+00026020: 746f 7220 696e 2061 6374 6f72 7320 6f72  tor in actors or
+00026030: 205b 5d3a 0a20 2020 2020 2020 2020 2020   []:.           
+00026040: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00026050: 5b61 6374 6f72 5d0a 2020 2020 2020 2020  [actor].        
+00026060: 2020 2020 7473 2e61 6374 6f72 203d 2054      ts.actor = T
+00026070: 7275 650a 0a20 2020 2020 2020 2023 2043  rue..        # C
+00026080: 6f6d 7075 7465 2072 6563 6f6d 6d65 6e64  ompute recommend
+00026090: 6174 696f 6e73 0a20 2020 2020 2020 2072  ations.        r
+000260a0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+000260b0: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
+000260c0: 2020 7072 696f 7269 7479 203d 2064 6963    priority = dic
+000260d0: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+000260e0: 7473 2069 6e20 736f 7274 6564 280a 2020  ts in sorted(.  
+000260f0: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
+00026100: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00026110: 6b65 793d 6f70 6572 6174 6f72 2e61 7474  key=operator.att
+00026120: 7267 6574 7465 7228 2270 7269 6f72 6974  rgetter("priorit
+00026130: 7922 292c 0a20 2020 2020 2020 2020 2020  y"),.           
+00026140: 2072 6576 6572 7365 3d54 7275 652c 0a20   reverse=True,. 
+00026150: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00026160: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00026170: 7072 696f 7269 7479 2020 2320 6d79 7079  priority  # mypy
+00026180: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00026190: 6f72 6974 795b 7473 2e6b 6579 5d20 3d20  ority[ts.key] = 
+000261a0: 7473 2e70 7269 6f72 6974 790a 2020 2020  ts.priority.    
+000261b0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000261c0: 732e 7275 6e5f 7370 6563 0a20 2020 2020  s.run_spec.     
+000261d0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+000261e0: 7465 203d 3d20 2272 656c 6561 7365 6422  te == "released"
+000261f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026200: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00026210: 735b 7473 2e6b 6579 5d20 3d20 2277 6169  s[ts.key] = "wai
+00026220: 7469 6e67 220a 0a20 2020 2020 2020 2066  ting"..        f
+00026230: 6f72 2074 7320 696e 2072 756e 6e61 626c  or ts in runnabl
+00026240: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00026250: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+00026260: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00026270: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
+00026280: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00026290: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000262a0: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
+000262b0: 696f 6e5f 626c 616d 6520 3d20 6474 732e  ion_blame = dts.
+000262c0: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
+000262d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000262e0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000262f0: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2265  ons[ts.key] = "e
+00026300: 7272 6564 220a 2020 2020 2020 2020 2020  rred".          
+00026310: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00026320: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
+00026330: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
+00026340: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
+00026350: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00026360: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00026370: 2020 2020 2070 6c75 6769 6e2e 7570 6461       plugin.upda
+00026380: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
+00026390: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000263a0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+000263b0: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
+000263c0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+000263d0: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
+000263e0: 3d5b 7473 2e6b 6579 2066 6f72 2074 7320  =[ts.key for ts 
+000263f0: 696e 2074 6f75 6368 6564 5f74 6173 6b73  in touched_tasks
+00026400: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00026410: 2020 2020 2020 206b 6579 733d 7265 7175         keys=requ
+00026420: 6573 7465 645f 6b65 7973 2c0a 2020 2020  ested_keys,.    
+00026430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026440: 6465 7065 6e64 656e 6369 6573 3d64 6570  dependencies=dep
+00026450: 656e 6465 6e63 6965 732c 0a20 2020 2020  endencies,.     
+00026460: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00026470: 6e6e 6f74 6174 696f 6e73 3d72 6573 6f6c  nnotations=resol
+00026480: 7665 645f 616e 6e6f 7461 7469 6f6e 732c  ved_annotations,
+00026490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000264a0: 2020 2020 2070 7269 6f72 6974 793d 7072       priority=pr
+000264b0: 696f 7269 7479 2c0a 2020 2020 2020 2020  iority,.        
+000264c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000264d0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+000264e0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+000264f0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00026500: 6765 722e 6578 6365 7074 696f 6e28 6529  ger.exception(e)
+00026510: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
+00026520: 7261 6e73 6974 696f 6e73 2872 6563 6f6d  ransitions(recom
+00026530: 6d65 6e64 6174 696f 6e73 2c20 7374 696d  mendations, stim
+00026540: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
+00026550: 2020 666f 7220 7473 2069 6e20 746f 7563    for ts in touc
+00026560: 6865 645f 7461 736b 733a 0a20 2020 2020  hed_tasks:.     
+00026570: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+00026580: 7465 2069 6e20 2822 6d65 6d6f 7279 222c  te in ("memory",
+00026590: 2022 6572 7265 6422 293a 0a20 2020 2020   "erred"):.     
+000265a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000265b0: 7265 706f 7274 5f6f 6e5f 6b65 7928 7473  report_on_key(ts
+000265c0: 3d74 732c 2063 6c69 656e 743d 636c 6965  =ts, client=clie
+000265d0: 6e74 290a 0a20 2020 2020 2020 2065 6e64  nt)..        end
+000265e0: 203d 2074 696d 6528 290a 2020 2020 2020   = time().      
+000265f0: 2020 7365 6c66 2e64 6967 6573 745f 6d65    self.digest_me
+00026600: 7472 6963 2822 7570 6461 7465 2d67 7261  tric("update-gra
+00026610: 7068 2d64 7572 6174 696f 6e22 2c20 656e  ph-duration", en
+00026620: 6420 2d20 7374 6172 7429 0a0a 2020 2020  d - start)..    
+00026630: 6465 6620 5f67 656e 6572 6174 655f 7461  def _generate_ta
+00026640: 736b 7374 6174 6573 280a 2020 2020 2020  skstates(.      
+00026650: 2020 7365 6c66 2c20 6b65 7973 3a20 7365    self, keys: se
+00026660: 745b 7374 725d 2c20 6473 6b3a 2064 6963  t[str], dsk: dic
+00026670: 742c 2064 6570 656e 6465 6e63 6965 733a  t, dependencies:
+00026680: 2064 6963 742c 2063 6f6d 7075 7461 7469   dict, computati
+00026690: 6f6e 3a20 436f 6d70 7574 6174 696f 6e0a  on: Computation.
+000266a0: 2020 2020 2920 2d3e 2074 7570 6c65 3a0a      ) -> tuple:.
+000266b0: 2020 2020 2020 2020 2320 4765 7420 6f72          # Get or
+000266c0: 2063 7265 6174 6520 7461 736b 2073 7461   create task sta
+000266d0: 7465 730a 2020 2020 2020 2020 7275 6e6e  tes.        runn
+000266e0: 6162 6c65 203d 205b 5d0a 2020 2020 2020  able = [].      
+000266f0: 2020 6e65 775f 7461 736b 7320 3d20 5b5d    new_tasks = []
+00026700: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
+00026710: 206c 6973 7428 6b65 7973 290a 2020 2020   list(keys).    
+00026720: 2020 2020 7461 736b 7320 3d20 5b5d 0a20      tasks = []. 
+00026730: 2020 2020 2020 2074 6f75 6368 6564 5f6b         touched_k
+00026740: 6579 7320 3d20 7365 7428 290a 2020 2020  eys = set().    
+00026750: 2020 2020 746f 7563 6865 645f 7461 736b      touched_task
+00026760: 7320 3d20 5b5d 0a20 2020 2020 2020 2077  s = [].        w
+00026770: 6869 6c65 2073 7461 636b 3a0a 2020 2020  hile stack:.    
+00026780: 2020 2020 2020 2020 6b20 3d20 7374 6163          k = stac
+00026790: 6b2e 706f 7028 290a 2020 2020 2020 2020  k.pop().        
+000267a0: 2020 2020 6966 206b 2069 6e20 746f 7563      if k in touc
+000267b0: 6865 645f 6b65 7973 3a0a 2020 2020 2020  hed_keys:.      
+000267c0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+000267d0: 7565 0a20 2020 2020 2020 2020 2020 2023  ue.            #
+000267e0: 2058 5858 2048 6176 6520 6120 6d65 7468   XXX Have a meth
+000267f0: 6f64 2067 6574 5f74 6173 6b5f 7374 6174  od get_task_stat
+00026800: 6528 7365 6c66 2c20 6b29 203f 0a20 2020  e(self, k) ?.   
+00026810: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+00026820: 6c66 2e74 6173 6b73 2e67 6574 286b 290a  lf.tasks.get(k).
+00026830: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00026840: 732e 6170 7065 6e64 2874 7329 0a20 2020  s.append(ts).   
+00026850: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+00026860: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00026870: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00026880: 662e 6e65 775f 7461 736b 286b 2c20 6473  f.new_task(k, ds
+00026890: 6b2e 6765 7428 6b29 2c20 2272 656c 6561  k.get(k), "relea
+000268a0: 7365 6422 2c20 636f 6d70 7574 6174 696f  sed", computatio
+000268b0: 6e3d 636f 6d70 7574 6174 696f 6e29 0a20  n=computation). 
+000268c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000268d0: 6577 5f74 6173 6b73 2e61 7070 656e 6428  ew_tasks.append(
+000268e0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+000268f0: 656c 6966 206e 6f74 2074 732e 7275 6e5f  elif not ts.run_
+00026900: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
+00026910: 2020 2020 2020 7473 2e72 756e 5f73 7065        ts.run_spe
+00026920: 6320 3d20 6473 6b2e 6765 7428 6b29 0a0a  c = dsk.get(k)..
+00026930: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00026940: 732e 7275 6e5f 7370 6563 3a0a 2020 2020  s.run_spec:.    
+00026950: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+00026960: 6162 6c65 2e61 7070 656e 6428 7473 290a  able.append(ts).
+00026970: 2020 2020 2020 2020 2020 2020 746f 7563              touc
+00026980: 6865 645f 6b65 7973 2e61 6464 286b 290a  hed_keys.add(k).
+00026990: 2020 2020 2020 2020 2020 2020 746f 7563              touc
+000269a0: 6865 645f 7461 736b 732e 6170 7065 6e64  hed_tasks.append
+000269b0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+000269c0: 2073 7461 636b 2e65 7874 656e 6428 6465   stack.extend(de
+000269d0: 7065 6e64 656e 6369 6573 2e67 6574 286b  pendencies.get(k
+000269e0: 2c20 2829 2929 0a0a 2020 2020 2020 2020  , ()))..        
+000269f0: 2320 4164 6420 6465 7065 6e64 656e 6369  # Add dependenci
+00026a00: 6573 0a20 2020 2020 2020 2066 6f72 206b  es.        for k
+00026a10: 6579 2c20 6465 7073 2069 6e20 6465 7065  ey, deps in depe
+00026a20: 6e64 656e 6369 6573 2e69 7465 6d73 2829  ndencies.items()
+00026a30: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+00026a40: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
+00026a50: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
+00026a60: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
+00026a70: 206f 7220 7473 2e64 6570 656e 6465 6e63   or ts.dependenc
+00026a80: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00026a90: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00026aa0: 2020 2020 2020 2020 2020 666f 7220 6465            for de
+00026ab0: 7020 696e 2064 6570 733a 0a20 2020 2020  p in deps:.     
+00026ac0: 2020 2020 2020 2020 2020 2064 7473 203d             dts =
+00026ad0: 2073 656c 662e 7461 736b 735b 6465 705d   self.tasks[dep]
+00026ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026af0: 2074 732e 6164 645f 6465 7065 6e64 656e   ts.add_dependen
+00026b00: 6379 2864 7473 290a 0a20 2020 2020 2020  cy(dts)..       
+00026b10: 2069 6620 6c65 6e28 746f 7563 6865 645f   if len(touched_
+00026b20: 7461 736b 7329 203c 206c 656e 286b 6579  tasks) < len(key
+00026b30: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00026b40: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+00026b50: 2020 2020 2020 2020 2020 2020 2022 5375               "Su
+00026b60: 626d 6974 7465 6420 6772 6170 6820 7769  bmitted graph wi
+00026b70: 7468 206c 656e 6774 6820 2573 2062 7574  th length %s but
+00026b80: 2072 6571 7565 7374 6564 2067 7261 7068   requested graph
+00026b90: 206f 6e6c 7920 696e 636c 7564 6573 2025   only includes %
+00026ba0: 7320 6b65 7973 222c 0a20 2020 2020 2020  s keys",.       
+00026bb0: 2020 2020 2020 2020 206c 656e 2874 6f75           len(tou
+00026bc0: 6368 6564 5f74 6173 6b73 292c 0a20 2020  ched_tasks),.   
+00026bd0: 2020 2020 2020 2020 2020 2020 206c 656e               len
+00026be0: 286b 6579 7329 2c0a 2020 2020 2020 2020  (keys),.        
+00026bf0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00026c00: 7475 726e 2072 756e 6e61 626c 652c 2074  turn runnable, t
+00026c10: 6f75 6368 6564 5f74 6173 6b73 2c20 6e65  ouched_tasks, ne
+00026c20: 775f 7461 736b 730a 0a20 2020 2064 6566  w_tasks..    def
+00026c30: 205f 7061 7273 655f 616e 645f 6170 706c   _parse_and_appl
+00026c40: 795f 616e 6e6f 7461 7469 6f6e 7328 0a20  y_annotations(. 
+00026c50: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00026c60: 2020 2020 2074 6173 6b73 3a20 4974 6572       tasks: Iter
+00026c70: 6162 6c65 5b54 6173 6b53 7461 7465 5d2c  able[TaskState],
+00026c80: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
+00026c90: 696f 6e73 3a20 6469 6374 2c0a 2020 2020  ions: dict,.    
+00026ca0: 2020 2020 6c61 7965 725f 616e 6e6f 7461      layer_annota
+00026cb0: 7469 6f6e 733a 2064 6963 745b 7374 722c  tions: dict[str,
+00026cc0: 2064 6963 745d 2c0a 2020 2020 2020 2020   dict],.        
+00026cd0: 7072 655f 7374 7269 6e67 6966 6965 645f  pre_stringified_
+00026ce0: 6b65 7973 3a20 6469 6374 5b48 6173 6861  keys: dict[Hasha
+00026cf0: 626c 652c 2073 7472 5d2c 0a20 2020 2029  ble, str],.    )
+00026d00: 202d 3e20 6469 6374 5b73 7472 2c20 6469   -> dict[str, di
+00026d10: 6374 5b73 7472 2c20 416e 795d 5d3a 0a20  ct[str, Any]]:. 
+00026d20: 2020 2020 2020 2022 2222 4170 706c 7920         """Apply 
+00026d30: 7468 6520 7072 6f76 6964 6564 2061 6e6e  the provided ann
+00026d40: 6f74 6174 696f 6e73 2074 6f20 7468 6520  otations to the 
+00026d50: 7072 6f76 6964 6564 2060 5461 736b 5374  provided `TaskSt
+00026d60: 6174 6560 206f 626a 6563 7473 2e0a 0a20  ate` objects... 
+00026d70: 2020 2020 2020 2054 6865 2072 6177 2061         The raw a
+00026d80: 6e6e 6f74 6174 696f 6e73 2077 696c 6c20  nnotations will 
+00026d90: 6265 2073 746f 7265 6420 696e 2074 6865  be stored in the
+00026da0: 2060 616e 6e6f 7461 7469 6f6e 7360 2061   `annotations` a
+00026db0: 7474 7269 6275 7465 2e0a 0a20 2020 2020  ttribute...     
+00026dc0: 2020 204c 6179 6572 202f 206b 6579 2073     Layer / key s
+00026dd0: 7065 6369 6669 6320 616e 6e6f 7461 7469  pecific annotati
+00026de0: 6f6e 7320 7769 6c6c 2074 616b 6520 7072  ons will take pr
+00026df0: 6563 6564 656e 6365 206f 7665 7220 676c  ecedence over gl
+00026e00: 6f62 616c 202f 2067 656e 6572 6963 2061  obal / generic a
+00026e10: 6e6e 6f74 6174 696f 6e73 2e0a 0a20 2020  nnotations...   
+00026e20: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+00026e30: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00026e40: 2d2d 0a20 2020 2020 2020 2074 6173 6b73  --.        tasks
+00026e50: 203a 2049 7465 7261 626c 655b 5461 736b   : Iterable[Task
+00026e60: 5374 6174 655d 0a20 2020 2020 2020 2020  State].         
+00026e70: 2020 205f 6465 7363 7269 7074 696f 6e5f     _description_
+00026e80: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
+00026e90: 696f 6e73 203a 2064 6963 740a 2020 2020  ions : dict.    
+00026ea0: 2020 2020 2020 2020 5f64 6573 6372 6970          _descrip
+00026eb0: 7469 6f6e 5f0a 2020 2020 2020 2020 6c61  tion_.        la
+00026ec0: 7965 725f 616e 6e6f 7461 7469 6f6e 7320  yer_annotations 
+00026ed0: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
+00026ee0: 5d0a 2020 2020 2020 2020 2020 2020 5f64  ].            _d
+00026ef0: 6573 6372 6970 7469 6f6e 5f0a 0a20 2020  escription_..   
+00026f00: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+00026f10: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+00026f20: 2020 2020 2072 6573 6f6c 7665 645f 616e       resolved_an
+00026f30: 6e6f 7461 7469 6f6e 733a 2064 6963 740a  notations: dict.
+00026f40: 2020 2020 2020 2020 2020 2020 4120 6d61              A ma
+00026f50: 7070 696e 6720 6f66 2061 6c6c 2072 6573  pping of all res
+00026f60: 6f6c 7665 6420 616e 6e6f 7461 7469 6f6e  olved annotation
+00026f70: 7320 696e 2074 6865 2066 6f72 6d61 743a  s in the format:
+00026f80: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
+00026f90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00026fa0: 2020 2020 2020 2020 2022 616e 6e6f 7461           "annota
+00026fb0: 7469 6f6e 223a 207b 0a20 2020 2020 2020  tion": {.       
+00026fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026fd0: 2022 6b65 7922 3a20 7661 6c75 652c 0a20   "key": value,. 
+00026fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ff0: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
+00027000: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00027010: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027020: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
+00027030: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00027040: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00027050: 7265 736f 6c76 6564 5f61 6e6e 6f74 6174  resolved_annotat
+00027060: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
+00027070: 6469 6374 5b73 7472 2c20 416e 795d 5d20  dict[str, Any]] 
+00027080: 3d20 6465 6661 756c 7464 6963 7428 6469  = defaultdict(di
+00027090: 6374 290a 2020 2020 2020 2020 666f 7220  ct).        for 
+000270a0: 7473 2069 6e20 7461 736b 733a 0a20 2020  ts in tasks:.   
+000270b0: 2020 2020 2020 2020 206b 6579 203d 2074           key = t
+000270c0: 732e 6b65 790a 2020 2020 2020 2020 2020  s.key.          
+000270d0: 2020 2320 5468 6973 2063 6f75 6c64 2062    # This could b
+000270e0: 6520 6120 7479 7065 6420 6469 6374 0a20  e a typed dict. 
 000270f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00027100: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
-00027110: 7565 2c20 286c 6973 742c 2074 7570 6c65  ue, (list, tuple
-00027120: 2c20 7365 7429 293a 0a20 2020 2020 2020  , set)):.       
+00027100: 7420 616e 6e6f 7461 7469 6f6e 7320 616e  t annotations an
+00027110: 6420 6b65 7920 6e6f 7420 696e 206c 6179  d key not in lay
+00027120: 6572 5f61 6e6e 6f74 6174 696f 6e73 3a0a  er_annotations:.
 00027130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027140: 2076 616c 7565 203d 205b 7661 6c75 655d   value = [value]
-00027150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027160: 2020 2020 2068 6f73 745f 7265 7374 7269       host_restri
-00027170: 6374 696f 6e73 203d 2073 6574 2829 0a20  ctions = set(). 
-00027180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027190: 2020 2077 6f72 6b65 725f 7265 7374 7269     worker_restri
-000271a0: 6374 696f 6e73 203d 2073 6574 2829 0a20  ctions = set(). 
-000271b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271c0: 2020 2066 6f72 2077 2069 6e20 7661 6c75     for w in valu
-000271d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000271e0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-000271f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027200: 2020 2020 2020 2020 2020 2020 7720 3d20              w = 
-00027210: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
-00027220: 6573 7328 7729 0a20 2020 2020 2020 2020  ess(w).         
-00027230: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00027240: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
-00027250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027260: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00027270: 4e6f 7420 6120 7661 6c69 6420 6164 6472  Not a valid addr
-00027280: 6573 732c 2062 7574 2070 6572 6861 7073  ess, but perhaps
-00027290: 2069 7427 7320 6120 686f 7374 6e61 6d65   it's a hostname
-000272a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000272b0: 2020 2020 2020 2020 2020 2020 2068 6f73               hos
-000272c0: 745f 7265 7374 7269 6374 696f 6e73 2e61  t_restrictions.a
-000272d0: 6464 2877 290a 2020 2020 2020 2020 2020  dd(w).          
-000272e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000272f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00027300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027310: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
-00027320: 6f6e 732e 6164 6428 7729 0a20 2020 2020  ons.add(w).     
-00027330: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027340: 6620 686f 7374 5f72 6573 7472 6963 7469  f host_restricti
-00027350: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00027360: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00027370: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
-00027380: 7320 3d20 686f 7374 5f72 6573 7472 6963  s = host_restric
-00027390: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
-000273a0: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
-000273b0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-000273c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000273d0: 2020 2020 2020 2020 2020 7473 2e77 6f72            ts.wor
-000273e0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-000273f0: 203d 2077 6f72 6b65 725f 7265 7374 7269   = worker_restri
-00027400: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
-00027410: 2020 2020 2020 2065 6c69 6620 616e 6e6f         elif anno
-00027420: 7420 696e 2028 226c 6f6f 7365 5f72 6573  t in ("loose_res
-00027430: 7472 6963 7469 6f6e 7322 2c20 2261 6c6c  trictions", "all
-00027440: 6f77 5f6f 7468 6572 5f77 6f72 6b65 7273  ow_other_workers
-00027450: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00027460: 2020 2020 2020 2020 7473 2e6c 6f6f 7365          ts.loose
-00027470: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
-00027480: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00027490: 2020 2020 2020 656c 6966 2061 6e6e 6f74        elif annot
-000274a0: 203d 3d20 2272 6573 6f75 7263 6573 223a   == "resources":
-000274b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000274c0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-000274d0: 7374 616e 6365 2876 616c 7565 2c20 6469  stance(value, di
-000274e0: 6374 290a 2020 2020 2020 2020 2020 2020  ct).            
-000274f0: 2020 2020 2020 2020 7473 2e72 6573 6f75          ts.resou
-00027500: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-00027510: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
-00027520: 2020 2020 2020 2020 2065 6c69 6620 616e           elif an
-00027530: 6e6f 7420 3d3d 2022 7072 696f 7269 7479  not == "priority
-00027540: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00027550: 2020 2020 2020 2023 2053 6565 2053 6368         # See Sch
-00027560: 6564 756c 6572 2e5f 7365 745f 7072 696f  eduler._set_prio
-00027570: 7269 7469 6573 0a20 2020 2020 2020 2020  rities.         
-00027580: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00027590: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-000275a0: 2020 2020 656c 6966 2061 6e6e 6f74 203d      elif annot =
-000275b0: 3d20 2272 6574 7269 6573 223a 0a20 2020  = "retries":.   
+00027140: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00027150: 2020 2020 206f 7574 203d 2061 6e6e 6f74       out = annot
+00027160: 6174 696f 6e73 2e63 6f70 7928 290a 2020  ations.copy().  
+00027170: 2020 2020 2020 2020 2020 6f75 742e 7570            out.up
+00027180: 6461 7465 286c 6179 6572 5f61 6e6e 6f74  date(layer_annot
+00027190: 6174 696f 6e73 2e67 6574 286b 6579 2c20  ations.get(key, 
+000271a0: 7b7d 2929 0a20 2020 2020 2020 2020 2020  {})).           
+000271b0: 2066 6f72 2061 6e6e 6f74 2c20 7661 6c75   for annot, valu
+000271c0: 6520 696e 206f 7574 2e69 7465 6d73 2829  e in out.items()
+000271d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000271e0: 2020 2320 506f 7020 7468 6520 6b65 7920    # Pop the key 
+000271f0: 7369 6e63 6520 6e61 6d65 7320 646f 6e27  since names don'
+00027200: 7420 616c 7761 7973 206d 6174 6368 2061  t always match a
+00027210: 7474 7269 6275 7465 730a 2020 2020 2020  ttributes.      
+00027220: 2020 2020 2020 2020 2020 6966 2063 616c            if cal
+00027230: 6c61 626c 6528 7661 6c75 6529 3a0a 2020  lable(value):.  
+00027240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027250: 2020 7661 6c75 6520 3d20 7661 6c75 6528    value = value(
+00027260: 7072 655f 7374 7269 6e67 6966 6965 645f  pre_stringified_
+00027270: 6b65 7973 5b6b 6579 5d29 0a20 2020 2020  keys[key]).     
+00027280: 2020 2020 2020 2020 2020 206f 7574 5b61             out[a
+00027290: 6e6e 6f74 5d20 3d20 7661 6c75 650a 2020  nnot] = value.  
+000272a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000272b0: 736f 6c76 6564 5f61 6e6e 6f74 6174 696f  solved_annotatio
+000272c0: 6e73 5b61 6e6e 6f74 5d5b 6b65 795d 203d  ns[annot][key] =
+000272d0: 2076 616c 7565 0a0a 2020 2020 2020 2020   value..        
+000272e0: 2020 2020 2020 2020 6966 2061 6e6e 6f74          if annot
+000272f0: 2069 6e20 2822 7265 7374 7269 6374 696f   in ("restrictio
+00027300: 6e73 222c 2022 776f 726b 6572 7322 293a  ns", "workers"):
+00027310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027320: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00027330: 7374 616e 6365 2876 616c 7565 2c20 286c  stance(value, (l
+00027340: 6973 742c 2074 7570 6c65 2c20 7365 7429  ist, tuple, set)
+00027350: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00027360: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00027370: 203d 205b 7661 6c75 655d 0a20 2020 2020   = [value].     
+00027380: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00027390: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+000273a0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+000273b0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+000273c0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+000273d0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+000273e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000273f0: 2077 2069 6e20 7661 6c75 653a 0a20 2020   w in value:.   
+00027400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027410: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00027420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027430: 2020 2020 2020 7720 3d20 7365 6c66 2e63        w = self.c
+00027440: 6f65 7263 655f 6164 6472 6573 7328 7729  oerce_address(w)
+00027450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027460: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00027470: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+00027480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027490: 2020 2020 2020 2020 2320 4e6f 7420 6120          # Not a 
+000274a0: 7661 6c69 6420 6164 6472 6573 732c 2062  valid address, b
+000274b0: 7574 2070 6572 6861 7073 2069 7427 7320  ut perhaps it's 
+000274c0: 6120 686f 7374 6e61 6d65 0a20 2020 2020  a hostname.     
+000274d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274e0: 2020 2020 2020 2068 6f73 745f 7265 7374         host_rest
+000274f0: 7269 6374 696f 6e73 2e61 6464 2877 290a  rictions.add(w).
+00027500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027510: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00027520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027530: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00027540: 5f72 6573 7472 6963 7469 6f6e 732e 6164  _restrictions.ad
+00027550: 6428 7729 0a20 2020 2020 2020 2020 2020  d(w).           
+00027560: 2020 2020 2020 2020 2069 6620 686f 7374           if host
+00027570: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
+00027580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027590: 2020 2020 2020 2074 732e 686f 7374 5f72         ts.host_r
+000275a0: 6573 7472 6963 7469 6f6e 7320 3d20 686f  estrictions = ho
+000275b0: 7374 5f72 6573 7472 6963 7469 6f6e 730a  st_restrictions.
 000275c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000275d0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-000275e0: 6365 2876 616c 7565 2c20 696e 7429 0a20  ce(value, int). 
+000275d0: 2020 2020 6966 2077 6f72 6b65 725f 7265      if worker_re
+000275e0: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
 000275f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027600: 2020 2074 732e 7265 7472 6965 7320 3d20     ts.retries = 
-00027610: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00027620: 2020 7473 2e61 6e6e 6f74 6174 696f 6e73    ts.annotations
-00027630: 203d 206f 7574 0a20 2020 2020 2020 2072   = out.        r
-00027640: 6574 7572 6e20 6469 6374 2872 6573 6f6c  eturn dict(resol
-00027650: 7665 645f 616e 6e6f 7461 7469 6f6e 7329  ved_annotations)
-00027660: 0a0a 2020 2020 6465 6620 5f73 6574 5f70  ..    def _set_p
-00027670: 7269 6f72 6974 6965 7328 0a20 2020 2020  riorities(.     
-00027680: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00027690: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
-000276a0: 7479 3a20 6469 6374 5b73 7472 2c20 696e  ty: dict[str, in
-000276b0: 745d 207c 204e 6f6e 652c 0a20 2020 2020  t] | None,.     
-000276c0: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
-000276d0: 736b 3a20 7374 7220 7c20 4e6f 6e65 2c0a  sk: str | None,.
-000276e0: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
-000276f0: 6f72 6974 793a 2069 6e74 207c 2064 6963  ority: int | dic
-00027700: 745b 7374 722c 2069 6e74 5d2c 0a20 2020  t[str, int],.   
-00027710: 2020 2020 2066 6966 6f5f 7469 6d65 6f75       fifo_timeou
-00027720: 743a 2069 6e74 207c 2066 6c6f 6174 207c  t: int | float |
-00027730: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
-00027740: 6172 743a 2066 6c6f 6174 2c0a 2020 2020  art: float,.    
-00027750: 2020 2020 6473 6b3a 2064 6963 742c 0a20      dsk: dict,. 
-00027760: 2020 2020 2020 2074 6173 6b73 3a20 6c69         tasks: li
-00027770: 7374 5b54 6173 6b53 7461 7465 5d2c 0a20  st[TaskState],. 
-00027780: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00027790: 6965 733a 2064 6963 742c 0a20 2020 2029  ies: dict,.    )
-000277a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000277b0: 2020 6669 666f 5f74 696d 656f 7574 203d    fifo_timeout =
-000277c0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-000277d0: 2866 6966 6f5f 7469 6d65 6f75 7429 0a20  (fifo_timeout). 
-000277e0: 2020 2020 2020 2069 6620 7375 626d 6974         if submit
-000277f0: 7469 6e67 5f74 6173 6b3a 2020 2320 7375  ting_task:  # su
-00027800: 622d 7461 736b 7320 6765 7420 6265 7474  b-tasks get bett
-00027810: 6572 2070 7269 6f72 6974 7920 7468 616e  er priority than
-00027820: 2070 6172 656e 7420 7461 736b 730a 2020   parent tasks.  
-00027830: 2020 2020 2020 2020 2020 7374 7320 3d20            sts = 
-00027840: 7365 6c66 2e74 6173 6b73 2e67 6574 2873  self.tasks.get(s
-00027850: 7562 6d69 7474 696e 675f 7461 736b 290a  ubmitting_task).
-00027860: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00027870: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
-00027880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027890: 6173 7365 7274 2073 7473 2e70 7269 6f72  assert sts.prior
-000278a0: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
-000278b0: 2020 2020 6765 6e65 7261 7469 6f6e 203d      generation =
-000278c0: 2073 7473 2e70 7269 6f72 6974 795b 305d   sts.priority[0]
-000278d0: 202d 2030 2e30 310a 2020 2020 2020 2020   - 0.01.        
-000278e0: 2020 2020 656c 7365 3a20 2023 2073 7570      else:  # sup
-000278f0: 6572 2d74 6173 6b20 616c 7265 6164 7920  er-task already 
-00027900: 636c 6561 6e65 6420 7570 0a20 2020 2020  cleaned up.     
-00027910: 2020 2020 2020 2020 2020 2067 656e 6572             gener
-00027920: 6174 696f 6e20 3d20 7365 6c66 2e67 656e  ation = self.gen
-00027930: 6572 6174 696f 6e0a 2020 2020 2020 2020  eration.        
-00027940: 656c 6966 2073 656c 662e 5f6c 6173 745f  elif self._last_
-00027950: 7469 6d65 202b 2066 6966 6f5f 7469 6d65  time + fifo_time
-00027960: 6f75 7420 3c20 7374 6172 743a 0a20 2020  out < start:.   
-00027970: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00027980: 6e65 7261 7469 6f6e 202b 3d20 3120 2023  neration += 1  #
-00027990: 206f 6c64 6572 2067 7261 7068 2067 656e   older graph gen
-000279a0: 6572 6174 696f 6e73 2074 616b 6520 7072  erations take pr
-000279b0: 6563 6564 656e 6365 0a20 2020 2020 2020  ecedence.       
-000279c0: 2020 2020 2067 656e 6572 6174 696f 6e20       generation 
-000279d0: 3d20 7365 6c66 2e67 656e 6572 6174 696f  = self.generatio
-000279e0: 6e0a 2020 2020 2020 2020 2020 2020 7365  n.            se
-000279f0: 6c66 2e5f 6c61 7374 5f74 696d 6520 3d20  lf._last_time = 
-00027a00: 7374 6172 740a 2020 2020 2020 2020 656c  start.        el
-00027a10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00027a20: 6765 6e65 7261 7469 6f6e 203d 2073 656c  generation = sel
-00027a30: 662e 6765 6e65 7261 7469 6f6e 0a0a 2020  f.generation..  
-00027a40: 2020 2020 2020 6966 2069 6e74 6572 6e61        if interna
-00027a50: 6c5f 7072 696f 7269 7479 2069 7320 4e6f  l_priority is No
-00027a60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00027a70: 2320 5265 6d6f 7669 6e67 2061 6c6c 206e  # Removing all n
-00027a80: 6f6e 2d6c 6f63 616c 206b 6579 7320 6265  on-local keys be
-00027a90: 666f 7265 2063 616c 6c69 6e67 206f 7264  fore calling ord
-00027aa0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00027ab0: 2064 736b 5f6b 6579 7320 3d20 7365 7428   dsk_keys = set(
-00027ac0: 6473 6b29 2020 2320 696e 7465 7273 6563  dsk)  # intersec
-00027ad0: 7469 6f6e 2829 206f 6620 7365 7473 2069  tion() of sets i
-00027ae0: 7320 6d75 6368 2066 6173 7465 7220 7468  s much faster th
-00027af0: 616e 2064 6963 745f 6b65 7973 0a20 2020  an dict_keys.   
-00027b00: 2020 2020 2020 2020 2073 7472 6970 7065           strippe
-00027b10: 645f 6465 7073 203d 207b 0a20 2020 2020  d_deps = {.     
-00027b20: 2020 2020 2020 2020 2020 206b 3a20 762e             k: v.
-00027b30: 696e 7465 7273 6563 7469 6f6e 2864 736b  intersection(dsk
-00027b40: 5f6b 6579 7329 0a20 2020 2020 2020 2020  _keys).         
-00027b50: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-00027b60: 696e 2064 6570 656e 6465 6e63 6965 732e  in dependencies.
-00027b70: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-00027b80: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
-00027b90: 6473 6b5f 6b65 7973 0a20 2020 2020 2020  dsk_keys.       
-00027ba0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00027bb0: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
-00027bc0: 7269 7479 203d 2064 6173 6b2e 6f72 6465  rity = dask.orde
-00027bd0: 722e 6f72 6465 7228 6473 6b2c 2064 6570  r.order(dsk, dep
-00027be0: 656e 6465 6e63 6965 733d 7374 7269 7070  endencies=stripp
-00027bf0: 6564 5f64 6570 7329 0a0a 2020 2020 2020  ed_deps)..      
-00027c00: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
-00027c10: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-00027c20: 204e 6f74 653a 2055 6e64 6572 2077 6869   Note: Under whi
-00027c30: 6368 2063 6972 6375 6d73 7461 6e63 6573  ch circumstances
-00027c40: 2077 6f75 6c64 2061 2074 6173 6b20 6e6f   would a task no
-00027c50: 7420 6861 7665 2061 0a20 2020 2020 2020  t have a.       
-00027c60: 2020 2020 2023 2070 7269 6f72 6974 6979       # prioritiy
-00027c70: 2061 7373 6967 6e65 6420 6279 206e 6f77   assigned by now
-00027c80: 3f20 4172 6520 7468 6573 6520 7363 6174  ? Are these scat
-00027c90: 7465 7265 6420 7461 736b 730a 2020 2020  tered tasks.    
-00027ca0: 2020 2020 2020 2020 2320 6578 636c 7573          # exclus
-00027cb0: 6976 656c 7920 6f72 2073 6f6d 6574 6869  ively or somethi
-00027cc0: 6e67 2065 6c73 653f 0a20 2020 2020 2020  ng else?.       
-00027cd0: 2020 2020 2074 6173 6b5f 7573 6572 5f70       task_user_p
-00027ce0: 7269 6f20 3d20 7573 6572 5f70 7269 6f72  rio = user_prior
-00027cf0: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
-00027d00: 6966 2069 7369 6e73 7461 6e63 6528 7573  if isinstance(us
-00027d10: 6572 5f70 7269 6f72 6974 792c 2064 6963  er_priority, dic
-00027d20: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00027d30: 2020 2020 7461 736b 5f75 7365 725f 7072      task_user_pr
-00027d40: 696f 203d 2075 7365 725f 7072 696f 7269  io = user_priori
-00027d50: 7479 2e67 6574 2874 732e 6b65 792c 2030  ty.get(ts.key, 0
-00027d60: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-00027d70: 6e6f 7461 7465 645f 7072 696f 203d 2074  notated_prio = t
-00027d80: 732e 616e 6e6f 7461 7469 6f6e 732e 6765  s.annotations.ge
-00027d90: 7428 2270 7269 6f72 6974 7922 2c20 7b7d  t("priority", {}
-00027da0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00027db0: 206e 6f74 2061 6e6e 6f74 6174 6564 5f70   not annotated_p
-00027dc0: 7269 6f3a 0a20 2020 2020 2020 2020 2020  rio:.           
-00027dd0: 2020 2020 2061 6e6e 6f74 6174 6564 5f70       annotated_p
-00027de0: 7269 6f20 3d20 7461 736b 5f75 7365 725f  rio = task_user_
-00027df0: 7072 696f 0a0a 2020 2020 2020 2020 2020  prio..          
-00027e00: 2020 6966 206e 6f74 2074 732e 7072 696f    if not ts.prio
-00027e10: 7269 7479 2061 6e64 2074 732e 6b65 7920  rity and ts.key 
-00027e20: 696e 2069 6e74 6572 6e61 6c5f 7072 696f  in internal_prio
-00027e30: 7269 7479 3a0a 2020 2020 2020 2020 2020  rity:.          
-00027e40: 2020 2020 2020 7473 2e70 7269 6f72 6974        ts.priorit
-00027e50: 7920 3d20 280a 2020 2020 2020 2020 2020  y = (.          
-00027e60: 2020 2020 2020 2020 2020 2d61 6e6e 6f74            -annot
-00027e70: 6174 6564 5f70 7269 6f2c 0a20 2020 2020  ated_prio,.     
-00027e80: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00027e90: 656e 6572 6174 696f 6e2c 0a20 2020 2020  eneration,.     
-00027ea0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027eb0: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
-00027ec0: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
-00027ed0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00027ee0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00027ef0: 2e76 616c 6964 6174 6520 616e 6420 7473  .validate and ts
-00027f00: 2e72 756e 5f73 7065 633a 0a20 2020 2020  .run_spec:.     
-00027f10: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00027f20: 7420 6973 696e 7374 616e 6365 2874 732e  t isinstance(ts.
-00027f30: 7072 696f 7269 7479 2c20 7475 706c 6529  priority, tuple)
-00027f40: 2061 6e64 2061 6c6c 280a 2020 2020 2020   and all(.      
-00027f50: 2020 2020 2020 2020 2020 2020 2020 6973                is
-00027f60: 696e 7374 616e 6365 2865 6c2c 2028 696e  instance(el, (in
-00027f70: 742c 2066 6c6f 6174 2929 2066 6f72 2065  t, float)) for e
-00027f80: 6c20 696e 2074 732e 7072 696f 7269 7479  l in ts.priority
-00027f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027fa0: 2029 0a0a 2020 2020 6465 6620 5f70 6f70   )..    def _pop
-00027fb0: 5f6c 6f73 745f 7461 736b 7328 0a20 2020  _lost_tasks(.   
-00027fc0: 2020 2020 2073 656c 662c 2064 736b 3a20       self, dsk: 
-00027fd0: 6469 6374 2c20 6465 7065 6e64 656e 6369  dict, dependenci
-00027fe0: 6573 3a20 6469 6374 2c20 6b65 7973 3a20  es: dict, keys: 
-00027ff0: 7365 745b 7374 725d 0a20 2020 2029 202d  set[str].    ) -
-00028000: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
-00028010: 2020 2020 6e20 3d20 300a 2020 2020 2020      n = 0.      
-00028020: 2020 6f75 7420 3d20 7365 7428 290a 2020    out = set().  
-00028030: 2020 2020 2020 7768 696c 6520 6c65 6e28        while len(
-00028040: 6473 6b29 2021 3d20 6e3a 2020 2320 7761  dsk) != n:  # wa
-00028050: 6c6b 2074 6872 6f75 6768 206e 6577 2074  lk through new t
-00028060: 6173 6b73 2c20 6361 6e63 656c 2061 6e79  asks, cancel any
-00028070: 2062 6164 2064 6570 730a 2020 2020 2020   bad deps.      
-00028080: 2020 2020 2020 6e20 3d20 6c65 6e28 6473        n = len(ds
-00028090: 6b29 0a20 2020 2020 2020 2020 2020 2066  k).            f
-000280a0: 6f72 206b 2c20 6465 7073 2069 6e20 6c69  or k, deps in li
-000280b0: 7374 2864 6570 656e 6465 6e63 6965 732e  st(dependencies.
-000280c0: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
-000280d0: 2020 2020 2020 2020 2020 6966 2061 6e79            if any
-000280e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000280f0: 2020 2020 2020 6465 7020 6e6f 7420 696e        dep not in
-00028100: 2073 656c 662e 7461 736b 7320 616e 6420   self.tasks and 
-00028110: 6465 7020 6e6f 7420 696e 2064 736b 2066  dep not in dsk f
-00028120: 6f72 2064 6570 2069 6e20 6465 7073 0a20  or dep in deps. 
-00028130: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00028140: 3a20 2023 2062 6164 206b 6579 0a20 2020  :  # bad key.   
-00028150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028160: 206f 7574 2e61 6464 286b 290a 2020 2020   out.add(k).    
-00028170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028180: 6c6f 6767 6572 2e69 6e66 6f28 2255 7365  logger.info("Use
-00028190: 7220 6173 6b65 6420 666f 7220 636f 6d70  r asked for comp
-000281a0: 7574 6174 696f 6e20 6f6e 206c 6f73 7420  utation on lost 
-000281b0: 6461 7461 2c20 2573 222c 206b 290a 2020  data, %s", k).  
-000281c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000281d0: 2020 6465 6c20 6473 6b5b 6b5d 0a20 2020    del dsk[k].   
-000281e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000281f0: 2064 656c 2064 6570 656e 6465 6e63 6965   del dependencie
-00028200: 735b 6b5d 0a20 2020 2020 2020 2020 2020  s[k].           
-00028210: 2020 2020 2020 2020 2069 6620 6b20 696e           if k in
-00028220: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
-00028230: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00028240: 6579 732e 7265 6d6f 7665 286b 290a 2020  eys.remove(k).  
-00028250: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-00028260: 0a0a 2020 2020 6465 6620 5f70 6f70 5f6b  ..    def _pop_k
-00028270: 6e6f 776e 5f74 6173 6b73 2873 656c 662c  nown_tasks(self,
-00028280: 2064 736b 3a20 6469 6374 2c20 6465 7065   dsk: dict, depe
-00028290: 6e64 656e 6369 6573 3a20 6469 6374 2920  ndencies: dict) 
-000282a0: 2d3e 2073 6574 5b73 7472 5d3a 0a20 2020  -> set[str]:.   
-000282b0: 2020 2020 2023 2041 766f 6964 2063 6f6d       # Avoid com
-000282c0: 7075 7461 7469 6f6e 2074 6861 7420 6973  putation that is
-000282d0: 2061 6c72 6561 6479 2066 696e 6973 6865   already finishe
-000282e0: 640a 2020 2020 2020 2020 616c 7265 6164  d.        alread
-000282f0: 795f 696e 5f6d 656d 6f72 7920 3d20 7365  y_in_memory = se
-00028300: 7428 2920 2023 2074 6173 6b73 2074 6861  t()  # tasks tha
-00028310: 7420 6172 6520 616c 7265 6164 7920 646f  t are already do
-00028320: 6e65 0a20 2020 2020 2020 2066 6f72 206b  ne.        for k
-00028330: 2c20 7620 696e 2064 6570 656e 6465 6e63  , v in dependenc
-00028340: 6965 732e 6974 656d 7328 293a 0a20 2020  ies.items():.   
-00028350: 2020 2020 2020 2020 2069 6620 7620 616e           if v an
-00028360: 6420 6b20 696e 2073 656c 662e 7461 736b  d k in self.task
-00028370: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00028380: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00028390: 6b73 5b6b 5d0a 2020 2020 2020 2020 2020  ks[k].          
-000283a0: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-000283b0: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
-000283c0: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
-000283d0: 2020 2020 2020 2020 2020 2020 2020 616c                al
-000283e0: 7265 6164 795f 696e 5f6d 656d 6f72 792e  ready_in_memory.
-000283f0: 6164 6428 6b29 0a0a 2020 2020 2020 2020  add(k)..        
-00028400: 646f 6e65 203d 2073 6574 2861 6c72 6561  done = set(alrea
-00028410: 6479 5f69 6e5f 6d65 6d6f 7279 290a 2020  dy_in_memory).  
-00028420: 2020 2020 2020 6966 2061 6c72 6561 6479        if already
-00028430: 5f69 6e5f 6d65 6d6f 7279 3a0a 2020 2020  _in_memory:.    
-00028440: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
-00028450: 7473 203d 2064 6173 6b2e 636f 7265 2e72  ts = dask.core.r
-00028460: 6576 6572 7365 5f64 6963 7428 6465 7065  everse_dict(depe
-00028470: 6e64 656e 6369 6573 290a 2020 2020 2020  ndencies).      
-00028480: 2020 2020 2020 7374 6163 6b20 3d20 6c69        stack = li
-00028490: 7374 2861 6c72 6561 6479 5f69 6e5f 6d65  st(already_in_me
-000284a0: 6d6f 7279 290a 2020 2020 2020 2020 2020  mory).          
-000284b0: 2020 7768 696c 6520 7374 6163 6b3a 2020    while stack:  
-000284c0: 2320 7265 6d6f 7665 2075 6e6e 6563 6573  # remove unneces
-000284d0: 7361 7279 2064 6570 656e 6465 6e63 6965  sary dependencie
-000284e0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000284f0: 2020 6b65 7920 3d20 7374 6163 6b2e 706f    key = stack.po
-00028500: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00028510: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00028520: 2020 2020 2020 2020 2020 2020 2064 6570               dep
-00028530: 7320 3d20 6465 7065 6e64 656e 6369 6573  s = dependencies
-00028540: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
-00028550: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-00028560: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00028570: 2020 2020 2020 2020 2020 2064 6570 7320             deps 
-00028580: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00028590: 5d2e 6465 7065 6e64 656e 6369 6573 0a20  ].dependencies. 
-000285a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000285b0: 6f72 2064 6570 2069 6e20 6465 7073 3a0a  or dep in deps:.
+00027600: 2020 2020 7473 2e77 6f72 6b65 725f 7265      ts.worker_re
+00027610: 7374 7269 6374 696f 6e73 203d 2077 6f72  strictions = wor
+00027620: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+00027630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027640: 2065 6c69 6620 616e 6e6f 7420 696e 2028   elif annot in (
+00027650: 226c 6f6f 7365 5f72 6573 7472 6963 7469  "loose_restricti
+00027660: 6f6e 7322 2c20 2261 6c6c 6f77 5f6f 7468  ons", "allow_oth
+00027670: 6572 5f77 6f72 6b65 7273 2229 3a0a 2020  er_workers"):.  
+00027680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027690: 2020 7473 2e6c 6f6f 7365 5f72 6573 7472    ts.loose_restr
+000276a0: 6963 7469 6f6e 7320 3d20 7661 6c75 650a  ictions = value.
+000276b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000276c0: 656c 6966 2061 6e6e 6f74 203d 3d20 2272  elif annot == "r
+000276d0: 6573 6f75 7263 6573 223a 0a20 2020 2020  esources":.     
+000276e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000276f0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00027700: 2876 616c 7565 2c20 6469 6374 290a 2020  (value, dict).  
+00027710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027720: 2020 7473 2e72 6573 6f75 7263 655f 7265    ts.resource_re
+00027730: 7374 7269 6374 696f 6e73 203d 2076 616c  strictions = val
+00027740: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00027750: 2020 2065 6c69 6620 616e 6e6f 7420 3d3d     elif annot ==
+00027760: 2022 7072 696f 7269 7479 223a 0a20 2020   "priority":.   
+00027770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027780: 2023 2053 6565 2053 6368 6564 756c 6572   # See Scheduler
+00027790: 2e5f 7365 745f 7072 696f 7269 7469 6573  ._set_priorities
+000277a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000277b0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+000277c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000277d0: 6966 2061 6e6e 6f74 203d 3d20 2272 6574  if annot == "ret
+000277e0: 7269 6573 223a 0a20 2020 2020 2020 2020  ries":.         
+000277f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00027800: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
+00027810: 7565 2c20 696e 7429 0a20 2020 2020 2020  ue, int).       
+00027820: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+00027830: 7265 7472 6965 7320 3d20 7661 6c75 650a  retries = value.
+00027840: 2020 2020 2020 2020 2020 2020 7473 2e61              ts.a
+00027850: 6e6e 6f74 6174 696f 6e73 203d 206f 7574  nnotations = out
+00027860: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00027870: 6469 6374 2872 6573 6f6c 7665 645f 616e  dict(resolved_an
+00027880: 6e6f 7461 7469 6f6e 7329 0a0a 2020 2020  notations)..    
+00027890: 6465 6620 5f73 6574 5f70 7269 6f72 6974  def _set_priorit
+000278a0: 6965 7328 0a20 2020 2020 2020 2073 656c  ies(.        sel
+000278b0: 662c 0a20 2020 2020 2020 2069 6e74 6572  f,.        inter
+000278c0: 6e61 6c5f 7072 696f 7269 7479 3a20 6469  nal_priority: di
+000278d0: 6374 5b73 7472 2c20 696e 745d 207c 204e  ct[str, int] | N
+000278e0: 6f6e 652c 0a20 2020 2020 2020 2073 7562  one,.        sub
+000278f0: 6d69 7474 696e 675f 7461 736b 3a20 7374  mitting_task: st
+00027900: 7220 7c20 4e6f 6e65 2c0a 2020 2020 2020  r | None,.      
+00027910: 2020 7573 6572 5f70 7269 6f72 6974 793a    user_priority:
+00027920: 2069 6e74 207c 2064 6963 745b 7374 722c   int | dict[str,
+00027930: 2069 6e74 5d2c 0a20 2020 2020 2020 2066   int],.        f
+00027940: 6966 6f5f 7469 6d65 6f75 743a 2069 6e74  ifo_timeout: int
+00027950: 207c 2066 6c6f 6174 207c 2073 7472 2c0a   | float | str,.
+00027960: 2020 2020 2020 2020 7374 6172 743a 2066          start: f
+00027970: 6c6f 6174 2c0a 2020 2020 2020 2020 6473  loat,.        ds
+00027980: 6b3a 2064 6963 742c 0a20 2020 2020 2020  k: dict,.       
+00027990: 2074 6173 6b73 3a20 6c69 7374 5b54 6173   tasks: list[Tas
+000279a0: 6b53 7461 7465 5d2c 0a20 2020 2020 2020  kState],.       
+000279b0: 2064 6570 656e 6465 6e63 6965 733a 2064   dependencies: d
+000279c0: 6963 742c 0a20 2020 2029 202d 3e20 4e6f  ict,.    ) -> No
+000279d0: 6e65 3a0a 2020 2020 2020 2020 6669 666f  ne:.        fifo
+000279e0: 5f74 696d 656f 7574 203d 2070 6172 7365  _timeout = parse
+000279f0: 5f74 696d 6564 656c 7461 2866 6966 6f5f  _timedelta(fifo_
+00027a00: 7469 6d65 6f75 7429 0a20 2020 2020 2020  timeout).       
+00027a10: 2069 6620 7375 626d 6974 7469 6e67 5f74   if submitting_t
+00027a20: 6173 6b3a 2020 2320 7375 622d 7461 736b  ask:  # sub-task
+00027a30: 7320 6765 7420 6265 7474 6572 2070 7269  s get better pri
+00027a40: 6f72 6974 7920 7468 616e 2070 6172 656e  ority than paren
+00027a50: 7420 7461 736b 730a 2020 2020 2020 2020  t tasks.        
+00027a60: 2020 2020 7374 7320 3d20 7365 6c66 2e74      sts = self.t
+00027a70: 6173 6b73 2e67 6574 2873 7562 6d69 7474  asks.get(submitt
+00027a80: 696e 675f 7461 736b 290a 2020 2020 2020  ing_task).      
+00027a90: 2020 2020 2020 6966 2073 7473 2069 7320        if sts is 
+00027aa0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00027ab0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00027ac0: 2073 7473 2e70 7269 6f72 6974 790a 2020   sts.priority.  
+00027ad0: 2020 2020 2020 2020 2020 2020 2020 6765                ge
+00027ae0: 6e65 7261 7469 6f6e 203d 2073 7473 2e70  neration = sts.p
+00027af0: 7269 6f72 6974 795b 305d 202d 2030 2e30  riority[0] - 0.0
+00027b00: 310a 2020 2020 2020 2020 2020 2020 656c  1.            el
+00027b10: 7365 3a20 2023 2073 7570 6572 2d74 6173  se:  # super-tas
+00027b20: 6b20 616c 7265 6164 7920 636c 6561 6e65  k already cleane
+00027b30: 6420 7570 0a20 2020 2020 2020 2020 2020  d up.           
+00027b40: 2020 2020 2067 656e 6572 6174 696f 6e20       generation 
+00027b50: 3d20 7365 6c66 2e67 656e 6572 6174 696f  = self.generatio
+00027b60: 6e0a 2020 2020 2020 2020 656c 6966 2073  n.        elif s
+00027b70: 656c 662e 5f6c 6173 745f 7469 6d65 202b  elf._last_time +
+00027b80: 2066 6966 6f5f 7469 6d65 6f75 7420 3c20   fifo_timeout < 
+00027b90: 7374 6172 743a 0a20 2020 2020 2020 2020  start:.         
+00027ba0: 2020 2073 656c 662e 6765 6e65 7261 7469     self.generati
+00027bb0: 6f6e 202b 3d20 3120 2023 206f 6c64 6572  on += 1  # older
+00027bc0: 2067 7261 7068 2067 656e 6572 6174 696f   graph generatio
+00027bd0: 6e73 2074 616b 6520 7072 6563 6564 656e  ns take preceden
+00027be0: 6365 0a20 2020 2020 2020 2020 2020 2067  ce.            g
+00027bf0: 656e 6572 6174 696f 6e20 3d20 7365 6c66  eneration = self
+00027c00: 2e67 656e 6572 6174 696f 6e0a 2020 2020  .generation.    
+00027c10: 2020 2020 2020 2020 7365 6c66 2e5f 6c61          self._la
+00027c20: 7374 5f74 696d 6520 3d20 7374 6172 740a  st_time = start.
+00027c30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00027c40: 2020 2020 2020 2020 2020 6765 6e65 7261            genera
+00027c50: 7469 6f6e 203d 2073 656c 662e 6765 6e65  tion = self.gene
+00027c60: 7261 7469 6f6e 0a0a 2020 2020 2020 2020  ration..        
+00027c70: 6966 2069 6e74 6572 6e61 6c5f 7072 696f  if internal_prio
+00027c80: 7269 7479 2069 7320 4e6f 6e65 3a0a 2020  rity is None:.  
+00027c90: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
+00027ca0: 7669 6e67 2061 6c6c 206e 6f6e 2d6c 6f63  ving all non-loc
+00027cb0: 616c 206b 6579 7320 6265 666f 7265 2063  al keys before c
+00027cc0: 616c 6c69 6e67 206f 7264 6572 2829 0a20  alling order(). 
+00027cd0: 2020 2020 2020 2020 2020 2064 736b 5f6b             dsk_k
+00027ce0: 6579 7320 3d20 7365 7428 6473 6b29 2020  eys = set(dsk)  
+00027cf0: 2320 696e 7465 7273 6563 7469 6f6e 2829  # intersection()
+00027d00: 206f 6620 7365 7473 2069 7320 6d75 6368   of sets is much
+00027d10: 2066 6173 7465 7220 7468 616e 2064 6963   faster than dic
+00027d20: 745f 6b65 7973 0a20 2020 2020 2020 2020  t_keys.         
+00027d30: 2020 2073 7472 6970 7065 645f 6465 7073     stripped_deps
+00027d40: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00027d50: 2020 2020 206b 3a20 762e 696e 7465 7273       k: v.inters
+00027d60: 6563 7469 6f6e 2864 736b 5f6b 6579 7329  ection(dsk_keys)
+00027d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027d80: 2066 6f72 206b 2c20 7620 696e 2064 6570   for k, v in dep
+00027d90: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
+00027da0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00027db0: 2020 6966 206b 2069 6e20 6473 6b5f 6b65    if k in dsk_ke
+00027dc0: 7973 0a20 2020 2020 2020 2020 2020 207d  ys.            }
+00027dd0: 0a20 2020 2020 2020 2020 2020 2069 6e74  .            int
+00027de0: 6572 6e61 6c5f 7072 696f 7269 7479 203d  ernal_priority =
+00027df0: 2064 6173 6b2e 6f72 6465 722e 6f72 6465   dask.order.orde
+00027e00: 7228 6473 6b2c 2064 6570 656e 6465 6e63  r(dsk, dependenc
+00027e10: 6965 733d 7374 7269 7070 6564 5f64 6570  ies=stripped_dep
+00027e20: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
+00027e30: 7473 2069 6e20 7461 736b 733a 0a20 2020  ts in tasks:.   
+00027e40: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
+00027e50: 2055 6e64 6572 2077 6869 6368 2063 6972   Under which cir
+00027e60: 6375 6d73 7461 6e63 6573 2077 6f75 6c64  cumstances would
+00027e70: 2061 2074 6173 6b20 6e6f 7420 6861 7665   a task not have
+00027e80: 2061 0a20 2020 2020 2020 2020 2020 2023   a.            #
+00027e90: 2070 7269 6f72 6974 6979 2061 7373 6967   prioritiy assig
+00027ea0: 6e65 6420 6279 206e 6f77 3f20 4172 6520  ned by now? Are 
+00027eb0: 7468 6573 6520 7363 6174 7465 7265 6420  these scattered 
+00027ec0: 7461 736b 730a 2020 2020 2020 2020 2020  tasks.          
+00027ed0: 2020 2320 6578 636c 7573 6976 656c 7920    # exclusively 
+00027ee0: 6f72 2073 6f6d 6574 6869 6e67 2065 6c73  or something els
+00027ef0: 653f 0a20 2020 2020 2020 2020 2020 2074  e?.            t
+00027f00: 6173 6b5f 7573 6572 5f70 7269 6f20 3d20  ask_user_prio = 
+00027f10: 7573 6572 5f70 7269 6f72 6974 790a 2020  user_priority.  
+00027f20: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00027f30: 6e73 7461 6e63 6528 7573 6572 5f70 7269  nstance(user_pri
+00027f40: 6f72 6974 792c 2064 6963 7429 3a0a 2020  ority, dict):.  
+00027f50: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00027f60: 736b 5f75 7365 725f 7072 696f 203d 2075  sk_user_prio = u
+00027f70: 7365 725f 7072 696f 7269 7479 2e67 6574  ser_priority.get
+00027f80: 2874 732e 6b65 792c 2030 290a 2020 2020  (ts.key, 0).    
+00027f90: 2020 2020 2020 2020 616e 6e6f 7461 7465          annotate
+00027fa0: 645f 7072 696f 203d 2074 732e 616e 6e6f  d_prio = ts.anno
+00027fb0: 7461 7469 6f6e 732e 6765 7428 2270 7269  tations.get("pri
+00027fc0: 6f72 6974 7922 2c20 7b7d 290a 2020 2020  ority", {}).    
+00027fd0: 2020 2020 2020 2020 6966 206e 6f74 2061          if not a
+00027fe0: 6e6e 6f74 6174 6564 5f70 7269 6f3a 0a20  nnotated_prio:. 
+00027ff0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00028000: 6e6e 6f74 6174 6564 5f70 7269 6f20 3d20  nnotated_prio = 
+00028010: 7461 736b 5f75 7365 725f 7072 696f 0a0a  task_user_prio..
+00028020: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00028030: 6f74 2074 732e 7072 696f 7269 7479 2061  ot ts.priority a
+00028040: 6e64 2074 732e 6b65 7920 696e 2069 6e74  nd ts.key in int
+00028050: 6572 6e61 6c5f 7072 696f 7269 7479 3a0a  ernal_priority:.
+00028060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028070: 7473 2e70 7269 6f72 6974 7920 3d20 280a  ts.priority = (.
+00028080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028090: 2020 2020 2d61 6e6e 6f74 6174 6564 5f70      -annotated_p
+000280a0: 7269 6f2c 0a20 2020 2020 2020 2020 2020  rio,.           
+000280b0: 2020 2020 2020 2020 2067 656e 6572 6174           generat
+000280c0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+000280d0: 2020 2020 2020 2020 2069 6e74 6572 6e61           interna
+000280e0: 6c5f 7072 696f 7269 7479 5b74 732e 6b65  l_priority[ts.ke
+000280f0: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
+00028100: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00028110: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00028120: 6174 6520 616e 6420 7473 2e72 756e 5f73  ate and ts.run_s
+00028130: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
+00028140: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00028150: 7374 616e 6365 2874 732e 7072 696f 7269  stance(ts.priori
+00028160: 7479 2c20 7475 706c 6529 2061 6e64 2061  ty, tuple) and a
+00028170: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
+00028180: 2020 2020 2020 2020 6973 696e 7374 616e          isinstan
+00028190: 6365 2865 6c2c 2028 696e 742c 2066 6c6f  ce(el, (int, flo
+000281a0: 6174 2929 2066 6f72 2065 6c20 696e 2074  at)) for el in t
+000281b0: 732e 7072 696f 7269 7479 0a20 2020 2020  s.priority.     
+000281c0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000281d0: 2020 6465 6620 5f70 6f70 5f6c 6f73 745f    def _pop_lost_
+000281e0: 7461 736b 7328 0a20 2020 2020 2020 2073  tasks(.        s
+000281f0: 656c 662c 2064 736b 3a20 6469 6374 2c20  elf, dsk: dict, 
+00028200: 6465 7065 6e64 656e 6369 6573 3a20 6469  dependencies: di
+00028210: 6374 2c20 6b65 7973 3a20 7365 745b 7374  ct, keys: set[st
+00028220: 725d 0a20 2020 2029 202d 3e20 7365 745b  r].    ) -> set[
+00028230: 7374 725d 3a0a 2020 2020 2020 2020 6e20  str]:.        n 
+00028240: 3d20 300a 2020 2020 2020 2020 6f75 7420  = 0.        out 
+00028250: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00028260: 7768 696c 6520 6c65 6e28 6473 6b29 2021  while len(dsk) !
+00028270: 3d20 6e3a 2020 2320 7761 6c6b 2074 6872  = n:  # walk thr
+00028280: 6f75 6768 206e 6577 2074 6173 6b73 2c20  ough new tasks, 
+00028290: 6361 6e63 656c 2061 6e79 2062 6164 2064  cancel any bad d
+000282a0: 6570 730a 2020 2020 2020 2020 2020 2020  eps.            
+000282b0: 6e20 3d20 6c65 6e28 6473 6b29 0a20 2020  n = len(dsk).   
+000282c0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+000282d0: 6465 7073 2069 6e20 6c69 7374 2864 6570  deps in list(dep
+000282e0: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
+000282f0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00028300: 2020 2020 6966 2061 6e79 280a 2020 2020      if any(.    
+00028310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028320: 6465 7020 6e6f 7420 696e 2073 656c 662e  dep not in self.
+00028330: 7461 736b 7320 616e 6420 6465 7020 6e6f  tasks and dep no
+00028340: 7420 696e 2064 736b 2066 6f72 2064 6570  t in dsk for dep
+00028350: 2069 6e20 6465 7073 0a20 2020 2020 2020   in deps.       
+00028360: 2020 2020 2020 2020 2029 3a20 2023 2062           ):  # b
+00028370: 6164 206b 6579 0a20 2020 2020 2020 2020  ad key.         
+00028380: 2020 2020 2020 2020 2020 206f 7574 2e61             out.a
+00028390: 6464 286b 290a 2020 2020 2020 2020 2020  dd(k).          
+000283a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000283b0: 2e69 6e66 6f28 2255 7365 7220 6173 6b65  .info("User aske
+000283c0: 6420 666f 7220 636f 6d70 7574 6174 696f  d for computatio
+000283d0: 6e20 6f6e 206c 6f73 7420 6461 7461 2c20  n on lost data, 
+000283e0: 2573 222c 206b 290a 2020 2020 2020 2020  %s", k).        
+000283f0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00028400: 6473 6b5b 6b5d 0a20 2020 2020 2020 2020  dsk[k].         
+00028410: 2020 2020 2020 2020 2020 2064 656c 2064             del d
+00028420: 6570 656e 6465 6e63 6965 735b 6b5d 0a20  ependencies[k]. 
+00028430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028440: 2020 2069 6620 6b20 696e 206b 6579 733a     if k in keys:
+00028450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028460: 2020 2020 2020 2020 206b 6579 732e 7265           keys.re
+00028470: 6d6f 7665 286b 290a 2020 2020 2020 2020  move(k).        
+00028480: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
+00028490: 6465 6620 5f70 6f70 5f6b 6e6f 776e 5f74  def _pop_known_t
+000284a0: 6173 6b73 2873 656c 662c 2064 736b 3a20  asks(self, dsk: 
+000284b0: 6469 6374 2c20 6465 7065 6e64 656e 6369  dict, dependenci
+000284c0: 6573 3a20 6469 6374 2920 2d3e 2073 6574  es: dict) -> set
+000284d0: 5b73 7472 5d3a 0a20 2020 2020 2020 2023  [str]:.        #
+000284e0: 2041 766f 6964 2063 6f6d 7075 7461 7469   Avoid computati
+000284f0: 6f6e 2074 6861 7420 6973 2061 6c72 6561  on that is alrea
+00028500: 6479 2066 696e 6973 6865 640a 2020 2020  dy finished.    
+00028510: 2020 2020 616c 7265 6164 795f 696e 5f6d      already_in_m
+00028520: 656d 6f72 7920 3d20 7365 7428 2920 2023  emory = set()  #
+00028530: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
+00028540: 616c 7265 6164 7920 646f 6e65 0a20 2020  already done.   
+00028550: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+00028560: 2064 6570 656e 6465 6e63 6965 732e 6974   dependencies.it
+00028570: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00028580: 2020 2069 6620 7620 616e 6420 6b20 696e     if v and k in
+00028590: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
+000285a0: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
+000285b0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 5d0a  = self.tasks[k].
 000285c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285d0: 2020 2020 6966 2064 6570 2069 6e20 6465      if dep in de
-000285e0: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
-000285f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028600: 2020 6368 696c 645f 6465 7073 203d 2064    child_deps = d
-00028610: 6570 656e 6465 6e74 735b 6465 705d 0a20  ependents[dep]. 
-00028620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028630: 2020 2065 6c69 6620 6465 7020 696e 2073     elif dep in s
-00028640: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
-00028650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028660: 2020 2063 6869 6c64 5f64 6570 7320 3d20     child_deps = 
-00028670: 7365 6c66 2e74 6173 6b73 5b64 6570 5d2e  self.tasks[dep].
-00028680: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-00028690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000286a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000286b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000286c0: 6869 6c64 5f64 6570 7320 3d20 7365 7428  hild_deps = set(
-000286d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000286e0: 2020 2020 2020 6966 2061 6c6c 2864 2069        if all(d i
-000286f0: 6e20 646f 6e65 2066 6f72 2064 2069 6e20  n done for d in 
-00028700: 6368 696c 645f 6465 7073 293a 0a20 2020  child_deps):.   
-00028710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028720: 2020 2020 2069 6620 6465 7020 696e 2073       if dep in s
-00028730: 656c 662e 7461 736b 7320 616e 6420 6465  elf.tasks and de
-00028740: 7020 6e6f 7420 696e 2064 6f6e 653a 0a20  p not in done:. 
-00028750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028760: 2020 2020 2020 2020 2020 2064 6f6e 652e             done.
-00028770: 6164 6428 6465 7029 0a20 2020 2020 2020  add(dep).       
-00028780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028790: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
-000287a0: 6428 6465 7029 0a20 2020 2020 2020 2066  d(dep).        f
-000287b0: 6f72 2061 6e63 2069 6e20 646f 6e65 3a0a  or anc in done:.
-000287c0: 2020 2020 2020 2020 2020 2020 6473 6b2e              dsk.
-000287d0: 706f 7028 616e 632c 204e 6f6e 6529 0a20  pop(anc, None). 
-000287e0: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-000287f0: 6465 6e63 6965 732e 706f 7028 616e 632c  dencies.pop(anc,
-00028800: 204e 6f6e 6529 0a20 2020 2020 2020 2072   None).        r
-00028810: 6574 7572 6e20 646f 6e65 0a0a 2020 2020  eturn done..    
-00028820: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00028830: 2020 6465 6620 6d61 7465 7269 616c 697a    def materializ
-00028840: 655f 6772 6170 6828 686c 673a 2048 6967  e_graph(hlg: Hig
-00028850: 684c 6576 656c 4772 6170 6829 202d 3e20  hLevelGraph) -> 
-00028860: 7475 706c 655b 6469 6374 2c20 6469 6374  tuple[dict, dict
-00028870: 2c20 6469 6374 2c20 6469 6374 5d3a 0a20  , dict, dict]:. 
-00028880: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
-00028890: 7269 6275 7465 642e 776f 726b 6572 2069  ributed.worker i
-000288a0: 6d70 6f72 7420 6475 6d70 735f 7461 736b  mport dumps_task
-000288b0: 0a0a 2020 2020 2020 2020 6b65 795f 616e  ..        key_an
-000288c0: 6e6f 7461 7469 6f6e 7320 3d20 7b7d 0a20  notations = {}. 
-000288d0: 2020 2020 2020 2064 736b 203d 2064 6173         dsk = das
-000288e0: 6b2e 7574 696c 732e 656e 7375 7265 5f64  k.utils.ensure_d
-000288f0: 6963 7428 686c 6729 0a0a 2020 2020 2020  ict(hlg)..      
-00028900: 2020 666f 7220 6c61 7965 7220 696e 2068    for layer in h
-00028910: 6c67 2e6c 6179 6572 732e 7661 6c75 6573  lg.layers.values
-00028920: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00028930: 6966 206c 6179 6572 2e61 6e6e 6f74 6174  if layer.annotat
-00028940: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00028950: 2020 2020 2020 616e 6e6f 7420 3d20 6c61        annot = la
-00028960: 7965 722e 616e 6e6f 7461 7469 6f6e 730a  yer.annotations.
-00028970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028980: 6b65 795f 616e 6e6f 7461 7469 6f6e 732e  key_annotations.
-00028990: 7570 6461 7465 287b 7374 7269 6e67 6966  update({stringif
-000289a0: 7928 6b29 3a20 616e 6e6f 7420 666f 7220  y(k): annot for 
-000289b0: 6b20 696e 206c 6179 6572 7d29 0a0a 2020  k in layer})..  
-000289c0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-000289d0: 6573 2c20 5f20 3d20 6765 745f 6465 7073  es, _ = get_deps
-000289e0: 2864 736b 290a 0a20 2020 2020 2020 2023  (dsk)..        #
-000289f0: 2052 656d 6f76 6520 6046 7574 7572 6560   Remove `Future`
-00028a00: 206f 626a 6563 7473 2066 726f 6d20 6772   objects from gr
-00028a10: 6170 6820 616e 6420 6e6f 7465 2061 6e79  aph and note any
-00028a20: 2066 7574 7572 6520 6465 7065 6e64 656e   future dependen
-00028a30: 6369 6573 0a20 2020 2020 2020 2064 736b  cies.        dsk
-00028a40: 3220 3d20 7b7d 0a20 2020 2020 2020 2066  2 = {}.        f
-00028a50: 7574 5f64 6570 7320 3d20 7b7d 0a20 2020  ut_deps = {}.   
-00028a60: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
-00028a70: 2064 736b 2e69 7465 6d73 2829 3a0a 2020   dsk.items():.  
-00028a80: 2020 2020 2020 2020 2020 6473 6b32 5b6b            dsk2[k
-00028a90: 5d2c 2066 7574 7320 3d20 756e 7061 636b  ], futs = unpack
-00028aa0: 5f72 656d 6f74 6564 6174 6128 762c 2062  _remotedata(v, b
-00028ab0: 7974 655f 6b65 7973 3d54 7275 6529 0a20  yte_keys=True). 
-00028ac0: 2020 2020 2020 2020 2020 2069 6620 6675             if fu
-00028ad0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00028ae0: 2020 2020 6675 745f 6465 7073 5b6b 5d20      fut_deps[k] 
-00028af0: 3d20 6675 7473 0a20 2020 2020 2020 2064  = futs.        d
-00028b00: 736b 203d 2064 736b 320a 0a20 2020 2020  sk = dsk2..     
-00028b10: 2020 2023 202d 2041 6464 2069 6e20 6465     # - Add in de
-00028b20: 7073 2066 6f72 2061 6e79 2074 6173 6b73  ps for any tasks
-00028b30: 2074 6861 7420 6465 7065 6e64 206f 6e20   that depend on 
-00028b40: 6675 7475 7265 730a 2020 2020 2020 2020  futures.        
-00028b50: 666f 7220 6b2c 2066 7574 7572 6573 2069  for k, futures i
-00028b60: 6e20 6675 745f 6465 7073 2e69 7465 6d73  n fut_deps.items
-00028b70: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00028b80: 6465 7065 6e64 656e 6369 6573 5b6b 5d2e  dependencies[k].
-00028b90: 7570 6461 7465 2866 2e6b 6579 2066 6f72  update(f.key for
-00028ba0: 2066 2069 6e20 6675 7475 7265 7329 0a20   f in futures). 
-00028bb0: 2020 2020 2020 206e 6577 5f64 736b 203d         new_dsk =
-00028bc0: 207b 7d0a 2020 2020 2020 2020 2320 416e   {}.        # An
-00028bd0: 6e6f 7461 7469 6f6e 2063 616c 6c61 626c  notation callabl
-00028be0: 6573 2061 7265 2065 7661 6c75 6174 6564  es are evaluated
-00028bf0: 206f 6e20 7468 6520 6e6f 6e2d 7374 7269   on the non-stri
-00028c00: 6e67 6966 6965 6420 7665 7273 696f 6e20  ngified version 
-00028c10: 6f66 0a20 2020 2020 2020 2023 2074 6865  of.        # the
-00028c20: 206b 6579 730a 2020 2020 2020 2020 7072   keys.        pr
-00028c30: 655f 7374 7269 6e67 6966 6965 645f 6b65  e_stringified_ke
-00028c40: 7973 203d 207b 7d0a 2020 2020 2020 2020  ys = {}.        
-00028c50: 6578 636c 7573 6976 6520 3d20 7365 7428  exclusive = set(
-00028c60: 686c 6729 0a20 2020 2020 2020 2066 6f72  hlg).        for
-00028c70: 206b 2c20 7620 696e 2064 736b 2e69 7465   k, v in dsk.ite
-00028c80: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00028c90: 2020 6e65 775f 6b20 3d20 7374 7269 6e67    new_k = string
-00028ca0: 6966 7928 6b29 0a20 2020 2020 2020 2020  ify(k).         
-00028cb0: 2020 2070 7265 5f73 7472 696e 6769 6669     pre_stringifi
-00028cc0: 6564 5f6b 6579 735b 6e65 775f 6b5d 203d  ed_keys[new_k] =
-00028cd0: 206b 0a20 2020 2020 2020 2020 2020 206e   k.            n
-00028ce0: 6577 5f64 736b 5b6e 6577 5f6b 5d20 3d20  ew_dsk[new_k] = 
-00028cf0: 7374 7269 6e67 6966 7928 762c 2065 7863  stringify(v, exc
-00028d00: 6c75 7369 7665 3d65 7863 6c75 7369 7665  lusive=exclusive
-00028d10: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00028d20: 206c 656e 286e 6577 5f64 736b 2920 3d3d   len(new_dsk) ==
-00028d30: 206c 656e 2870 7265 5f73 7472 696e 6769   len(pre_stringi
-00028d40: 6669 6564 5f6b 6579 7329 0a20 2020 2020  fied_keys).     
-00028d50: 2020 2064 736b 203d 206e 6577 5f64 736b     dsk = new_dsk
-00028d60: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
-00028d70: 6e63 6965 7320 3d20 7b0a 2020 2020 2020  ncies = {.      
-00028d80: 2020 2020 2020 7374 7269 6e67 6966 7928        stringify(
-00028d90: 6b29 3a20 7b73 7472 696e 6769 6679 2864  k): {stringify(d
-00028da0: 6570 2920 666f 7220 6465 7020 696e 2064  ep) for dep in d
-00028db0: 6570 737d 0a20 2020 2020 2020 2020 2020  eps}.           
-00028dc0: 2066 6f72 206b 2c20 6465 7073 2069 6e20   for k, deps in 
-00028dd0: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
-00028de0: 6d73 2829 0a20 2020 2020 2020 207d 0a0a  ms().        }..
-00028df0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-00028e00: 2061 6e79 2073 656c 662d 6465 7065 6e64   any self-depend
-00028e10: 656e 6369 6573 2028 6861 7070 656e 7320  encies (happens 
-00028e20: 6f6e 2074 6573 745f 7075 626c 6973 685f  on test_publish_
-00028e30: 6261 6728 2920 616e 6420 6f74 6865 7273  bag() and others
-00028e40: 290a 2020 2020 2020 2020 666f 7220 6b2c  ).        for k,
-00028e50: 2076 2069 6e20 6465 7065 6e64 656e 6369   v in dependenci
-00028e60: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
-00028e70: 2020 2020 2020 2020 6465 7073 203d 2073          deps = s
-00028e80: 6574 2876 290a 2020 2020 2020 2020 2020  et(v).          
-00028e90: 2020 6966 206b 2069 6e20 6465 7073 3a0a    if k in deps:.
-00028ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028eb0: 6465 7073 2e72 656d 6f76 6528 6b29 0a20  deps.remove(k). 
-00028ec0: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00028ed0: 6465 6e63 6965 735b 6b5d 203d 2064 6570  dencies[k] = dep
-00028ee0: 730a 0a20 2020 2020 2020 2023 2052 656d  s..        # Rem
-00028ef0: 6f76 6520 616c 6961 7365 730a 2020 2020  ove aliases.    
-00028f00: 2020 2020 666f 7220 6b20 696e 206c 6973      for k in lis
-00028f10: 7428 6473 6b29 3a0a 2020 2020 2020 2020  t(dsk):.        
-00028f20: 2020 2020 6966 2064 736b 5b6b 5d20 6973      if dsk[k] is
-00028f30: 206b 3a0a 2020 2020 2020 2020 2020 2020   k:.            
-00028f40: 2020 2020 6465 6c20 6473 6b5b 6b5d 0a20      del dsk[k]. 
-00028f50: 2020 2020 2020 2064 736b 203d 2076 616c         dsk = val
-00028f60: 6d61 7028 6475 6d70 735f 7461 736b 2c20  map(dumps_task, 
-00028f70: 6473 6b29 0a20 2020 2020 2020 2072 6574  dsk).        ret
-00028f80: 7572 6e20 6473 6b2c 2064 6570 656e 6465  urn dsk, depende
-00028f90: 6e63 6965 732c 206b 6579 5f61 6e6e 6f74  ncies, key_annot
-00028fa0: 6174 696f 6e73 2c20 7072 655f 7374 7269  ations, pre_stri
-00028fb0: 6e67 6966 6965 645f 6b65 7973 0a0a 2020  ngified_keys..  
-00028fc0: 2020 6465 6620 7374 696d 756c 7573 5f71    def stimulus_q
-00028fd0: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
-00028fe0: 5f6f 7065 6e65 6428 7365 6c66 2c20 2a2c  _opened(self, *,
-00028ff0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00029000: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-00029010: 2020 2020 2222 2252 6573 706f 6e64 2074      """Respond t
-00029020: 6f20 616e 2065 7665 6e74 2077 6869 6368  o an event which
-00029030: 206d 6179 2068 6176 6520 6f70 656e 6564   may have opened
-00029040: 2073 706f 7473 206f 6e20 776f 726b 6572   spots on worker
-00029050: 2074 6872 6561 6470 6f6f 6c73 0a0a 2020   threadpools..  
-00029060: 2020 2020 2020 5365 6c65 6374 7320 7468        Selects th
-00029070: 6520 6170 7072 6f70 7269 6174 6520 6e75  e appropriate nu
-00029080: 6d62 6572 206f 6620 7461 736b 7320 6672  mber of tasks fr
-00029090: 6f6d 2074 6865 2066 726f 6e74 206f 6620  om the front of 
-000290a0: 7468 6520 7175 6575 6520 6163 636f 7264  the queue accord
-000290b0: 696e 6720 746f 0a20 2020 2020 2020 2074  ing to.        t
-000290c0: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-000290d0: 6f66 2074 6173 6b20 736c 6f74 7320 6176  of task slots av
-000290e0: 6169 6c61 626c 6520 6f6e 2077 6f72 6b65  ailable on worke
-000290f0: 7273 2028 706f 7465 6e74 6961 6c6c 7920  rs (potentially 
-00029100: 3029 2c20 616e 640a 2020 2020 2020 2020  0), and.        
-00029110: 7472 616e 7369 7469 6f6e 7320 7468 656d  transitions them
-00029120: 2074 6f20 6060 7072 6f63 6573 7369 6e67   to ``processing
-00029130: 6060 2e0a 0a20 2020 2020 2020 204e 6f74  ``...        Not
-00029140: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
-00029150: 0a20 2020 2020 2020 204f 7468 6572 2074  .        Other t
-00029160: 7261 6e73 6974 696f 6e73 2072 656c 6174  ransitions relat
-00029170: 6564 2074 6f20 7468 6973 2073 7469 6d75  ed to this stimu
-00029180: 6c75 7320 7368 6f75 6c64 2062 6520 6675  lus should be fu
-00029190: 6c6c 7920 7072 6f63 6573 7365 6420 6265  lly processed be
-000291a0: 666f 7265 6861 6e64 2c0a 2020 2020 2020  forehand,.      
-000291b0: 2020 736f 2061 6e79 2074 6173 6b73 2074    so any tasks t
-000291c0: 6861 7420 6265 6361 6d65 2072 756e 6e61  hat became runna
-000291d0: 626c 6520 6172 6520 616c 7265 6164 7920  ble are already 
-000291e0: 696e 2060 6070 726f 6365 7373 696e 6760  in ``processing`
-000291f0: 602e 204f 7468 6572 7769 7365 2c0a 2020  `. Otherwise,.  
-00029200: 2020 2020 2020 6f76 6572 7072 6f64 7563        overproduc
-00029210: 7469 6f6e 2063 616e 206f 6363 7572 2069  tion can occur i
-00029220: 6620 7175 6575 6564 2074 6173 6b73 2067  f queued tasks g
-00029230: 6574 2073 6368 6564 756c 6564 2062 6566  et scheduled bef
-00029240: 6f72 6520 646f 776e 7374 7265 616d 2074  ore downstream t
-00029250: 6173 6b73 2e0a 0a20 2020 2020 2020 204d  asks...        M
-00029260: 7573 7420 6265 2063 616c 6c65 6420 6166  ust be called af
-00029270: 7465 7220 6063 6865 636b 5f69 646c 655f  ter `check_idle_
-00029280: 7361 7475 7261 7465 6460 3b20 692e 652e  saturated`; i.e.
-00029290: 2060 6964 6c65 5f74 6173 6b5f 636f 756e   `idle_task_coun
-000292a0: 7460 206d 7573 7420 6265 2075 700a 2020  t` must be up.  
-000292b0: 2020 2020 2020 746f 2064 6174 652e 0a20        to date.. 
-000292c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000292d0: 2020 2069 6620 6e6f 7420 7365 6c66 2e71     if not self.q
-000292e0: 7565 7565 643a 0a20 2020 2020 2020 2020  ueued:.         
-000292f0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00029300: 2020 736c 6f74 735f 6176 6169 6c61 626c    slots_availabl
-00029310: 6520 3d20 7375 6d28 0a20 2020 2020 2020  e = sum(.       
-00029320: 2020 2020 205f 7461 736b 5f73 6c6f 7473       _task_slots
-00029330: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
-00029340: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-00029350: 4154 494f 4e29 0a20 2020 2020 2020 2020  ATION).         
-00029360: 2020 2066 6f72 2077 7320 696e 2073 656c     for ws in sel
-00029370: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
-00029380: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
-00029390: 2020 2020 6966 2073 6c6f 7473 5f61 7661      if slots_ava
-000293a0: 696c 6162 6c65 203d 3d20 303a 0a20 2020  ilable == 0:.   
-000293b0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000293c0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-000293d0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-000293e0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-000293f0: 7174 7320 696e 2073 656c 662e 7175 6575  qts in self.queu
-00029400: 6564 2e70 6565 6b6e 2873 6c6f 7473 5f61  ed.peekn(slots_a
-00029410: 7661 696c 6162 6c65 293a 0a20 2020 2020  vailable):.     
-00029420: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00029430: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00029440: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00029450: 7174 732e 7374 6174 6520 3d3d 2022 7175  qts.state == "qu
-00029460: 6575 6564 222c 2071 7473 2e73 7461 7465  eued", qts.state
-00029470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029480: 2061 7373 6572 7420 6e6f 7420 7174 732e   assert not qts.
-00029490: 7072 6f63 6573 7369 6e67 5f6f 6e2c 2028  processing_on, (
-000294a0: 7174 732c 2071 7473 2e70 726f 6365 7373  qts, qts.process
-000294b0: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
-000294c0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000294d0: 6f74 2071 7473 2e77 6169 7469 6e67 5f6f  ot qts.waiting_o
-000294e0: 6e2c 2028 7174 732c 2071 7473 2e70 726f  n, (qts, qts.pro
-000294f0: 6365 7373 696e 675f 6f6e 290a 2020 2020  cessing_on).    
-00029500: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00029510: 7274 2071 7473 2e77 686f 5f77 616e 7473  rt qts.who_wants
-00029520: 206f 7220 7174 732e 7761 6974 6572 732c   or qts.waiters,
-00029530: 2071 7473 0a20 2020 2020 2020 2020 2020   qts.           
-00029540: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00029550: 5b71 7473 2e6b 6579 5d20 3d20 2270 726f  [qts.key] = "pro
-00029560: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
-00029570: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-00029580: 6e73 2872 6563 6f6d 6d65 6e64 6174 696f  ns(recommendatio
-00029590: 6e73 2c20 7374 696d 756c 7573 5f69 6429  ns, stimulus_id)
-000295a0: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
-000295b0: 7573 5f74 6173 6b5f 6669 6e69 7368 6564  us_task_finished
-000295c0: 2873 656c 662c 206b 6579 2c20 776f 726b  (self, key, work
-000295d0: 6572 2c20 7374 696d 756c 7573 5f69 642c  er, stimulus_id,
-000295e0: 2072 756e 5f69 642c 202a 2a6b 7761 7267   run_id, **kwarg
-000295f0: 7329 3a0a 2020 2020 2020 2020 2222 224d  s):.        """M
-00029600: 6172 6b20 7468 6174 2061 2074 6173 6b20  ark that a task 
-00029610: 6861 7320 6669 6e69 7368 6564 2065 7865  has finished exe
-00029620: 6375 7469 6f6e 206f 6e20 6120 7061 7274  cution on a part
-00029630: 6963 756c 6172 2077 6f72 6b65 7222 2222  icular worker"""
-00029640: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-00029650: 6465 6275 6728 2253 7469 6d75 6c75 7320  debug("Stimulus 
-00029660: 7461 736b 2066 696e 6973 6865 6420 2573  task finished %s
-00029670: 5b25 645d 2025 7322 2c20 6b65 792c 2072  [%d] %s", key, r
-00029680: 756e 5f69 642c 2077 6f72 6b65 7229 0a0a  un_id, worker)..
-00029690: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-000296a0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
-000296b0: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
-000296c0: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
-000296d0: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
-000296e0: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-000296f0: 0a0a 2020 2020 2020 2020 7773 3a20 576f  ..        ws: Wo
-00029700: 726b 6572 5374 6174 6520 3d20 7365 6c66  rkerState = self
-00029710: 2e77 6f72 6b65 7273 5b77 6f72 6b65 725d  .workers[worker]
-00029720: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-00029730: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
-00029740: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-00029750: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-00029760: 6e65 206f 7220 7473 2e73 7461 7465 2069  ne or ts.state i
-00029770: 6e20 2822 7265 6c65 6173 6564 222c 2022  n ("released", "
-00029780: 7175 6575 6564 2229 3a0a 2020 2020 2020  queued"):.      
-00029790: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-000297a0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-000297b0: 2020 2020 2252 6563 6569 7665 6420 616c      "Received al
-000297c0: 7265 6164 7920 636f 6d70 7574 6564 2074  ready computed t
-000297d0: 6173 6b2c 2077 6f72 6b65 723a 2025 732c  ask, worker: %s,
-000297e0: 2073 7461 7465 3a20 2573 220a 2020 2020   state: %s".    
-000297f0: 2020 2020 2020 2020 2020 2020 222c 206b              ", k
-00029800: 6579 3a20 2573 2c20 7768 6f5f 6861 733a  ey: %s, who_has:
-00029810: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
-00029820: 2020 2020 2020 776f 726b 6572 2c0a 2020        worker,.  
-00029830: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00029840: 2e73 7461 7465 2069 6620 7473 2065 6c73  .state if ts els
-00029850: 6520 2266 6f72 676f 7474 656e 222c 0a20  e "forgotten",. 
-00029860: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00029870: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00029880: 2020 2020 7473 2e77 686f 5f68 6173 2069      ts.who_has i
-00029890: 6620 7473 2065 6c73 6520 7b7d 2c0a 2020  f ts else {},.  
-000298a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000298b0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-000298c0: 7367 735b 776f 726b 6572 5d20 3d20 5b0a  sgs[worker] = [.
-000298d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000298e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000298f0: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
-00029900: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
-00029910: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-00029920: 7973 223a 205b 6b65 795d 2c0a 2020 2020  ys": [key],.    
-00029930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029940: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
-00029950: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
-00029960: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00029970: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00029980: 2020 2020 656c 6966 2074 732e 7275 6e5f      elif ts.run_
-00029990: 6964 2021 3d20 7275 6e5f 6964 3a0a 2020  id != run_id:.  
-000299a0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000299b0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-000299c0: 6e20 6f72 2074 732e 7072 6f63 6573 7369  n or ts.processi
-000299d0: 6e67 5f6f 6e2e 6164 6472 6573 7320 213d  ng_on.address !=
-000299e0: 2077 6f72 6b65 723a 0a20 2020 2020 2020   worker:.       
-000299f0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00029a00: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00029a10: 2020 2020 2020 2020 2020 2022 5265 6365             "Rece
-00029a20: 6976 6564 2073 7461 6c65 2074 6173 6b20  ived stale task 
-00029a30: 7275 6e2c 2077 6f72 6b65 723a 2025 732c  run, worker: %s,
-00029a40: 206b 6579 3a20 2573 2c20 7275 6e5f 6964   key: %s, run_id
-00029a50: 3a20 2564 2028 2564 2922 2c0a 2020 2020  : %d (%d)",.    
-00029a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a70: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
-00029a80: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
-00029a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029aa0: 2020 2020 2072 756e 5f69 642c 0a20 2020       run_id,.   
-00029ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ac0: 2074 732e 7275 6e5f 6964 2c0a 2020 2020   ts.run_id,.    
-00029ad0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00029ae0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00029af0: 726b 6572 5f6d 7367 735b 776f 726b 6572  rker_msgs[worker
-00029b00: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
-00029b10: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00029b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b30: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
-00029b40: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
-00029b50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00029b60: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
-00029b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b80: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-00029b90: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-00029ba0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029bb0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00029bc0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00029bd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00029be0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00029bf0: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
-00029c00: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
-00029c10: 0a20 2020 2020 2020 2065 6c69 6620 7473  .        elif ts
-00029c20: 2e73 7461 7465 203d 3d20 226d 656d 6f72  .state == "memor
-00029c30: 7922 3a0a 2020 2020 2020 2020 2020 2020  y":.            
-00029c40: 7365 6c66 2e61 6464 5f6b 6579 7328 776f  self.add_keys(wo
-00029c50: 726b 6572 3d77 6f72 6b65 722c 206b 6579  rker=worker, key
-00029c60: 733d 5b6b 6579 5d29 0a20 2020 2020 2020  s=[key]).       
-00029c70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00029c80: 2020 2074 732e 6d65 7461 6461 7461 2e75     ts.metadata.u
-00029c90: 7064 6174 6528 6b77 6172 6773 5b22 6d65  pdate(kwargs["me
-00029ca0: 7461 6461 7461 225d 290a 2020 2020 2020  tadata"]).      
-00029cb0: 2020 2020 2020 723a 2074 7570 6c65 203d        r: tuple =
-00029cc0: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
-00029cd0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00029ce0: 2020 206b 6579 2c20 226d 656d 6f72 7922     key, "memory"
-00029cf0: 2c20 7374 696d 756c 7573 5f69 642c 2077  , stimulus_id, w
-00029d00: 6f72 6b65 723d 776f 726b 6572 2c20 2a2a  orker=worker, **
-00029d10: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
-00029d20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00029d30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00029d40: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-00029d50: 6f72 6b65 725f 6d73 6773 203d 2072 0a0a  orker_msgs = r..
-00029d60: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00029d70: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-00029d80: 7279 223a 0a20 2020 2020 2020 2020 2020  ry":.           
-00029d90: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
-00029da0: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
-00029db0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00029dc0: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00029dd0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-00029de0: 5f6d 7367 730a 0a20 2020 2064 6566 2073  _msgs..    def s
-00029df0: 7469 6d75 6c75 735f 7461 736b 5f65 7272  timulus_task_err
-00029e00: 6564 280a 2020 2020 2020 2020 7365 6c66  ed(.        self
-00029e10: 2c0a 2020 2020 2020 2020 6b65 793d 4e6f  ,.        key=No
-00029e20: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
-00029e30: 6572 3d4e 6f6e 652c 0a20 2020 2020 2020  er=None,.       
-00029e40: 2065 7863 6570 7469 6f6e 3d4e 6f6e 652c   exception=None,
-00029e50: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00029e60: 735f 6964 3d4e 6f6e 652c 0a20 2020 2020  s_id=None,.     
-00029e70: 2020 2074 7261 6365 6261 636b 3d4e 6f6e     traceback=Non
-00029e80: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00029e90: 7267 732c 0a20 2020 2029 3a0a 2020 2020  rgs,.    ):.    
-00029ea0: 2020 2020 2222 224d 6172 6b20 7468 6174      """Mark that
-00029eb0: 2061 2074 6173 6b20 6861 7320 6572 7265   a task has erre
-00029ec0: 6420 6f6e 2061 2070 6172 7469 6375 6c61  d on a particula
-00029ed0: 7220 776f 726b 6572 2222 220a 2020 2020  r worker""".    
-00029ee0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00029ef0: 2822 5374 696d 756c 7573 2074 6173 6b20  ("Stimulus task 
-00029f00: 6572 7265 6420 2573 2c20 2573 222c 206b  erred %s, %s", k
-00029f10: 6579 2c20 776f 726b 6572 290a 0a20 2020  ey, worker)..   
-00029f20: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-00029f30: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
-00029f40: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-00029f50: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
-00029f60: 7220 7473 2e73 7461 7465 2021 3d20 2270  r ts.state != "p
-00029f70: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
-00029f80: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00029f90: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
-00029fa0: 2020 2069 6620 7473 2e72 6574 7269 6573     if ts.retries
-00029fb0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00029fc0: 2020 7473 2e72 6574 7269 6573 202d 3d20    ts.retries -= 
-00029fd0: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
-00029fe0: 7475 726e 2073 656c 662e 5f74 7261 6e73  turn self._trans
-00029ff0: 6974 696f 6e28 6b65 792c 2022 7761 6974  ition(key, "wait
-0002a000: 696e 6722 2c20 7374 696d 756c 7573 5f69  ing", stimulus_i
-0002a010: 6429 0a20 2020 2020 2020 2065 6c73 653a  d).        else:
-0002a020: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002a030: 7572 6e20 7365 6c66 2e5f 7472 616e 7369  urn self._transi
-0002a040: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0002a050: 2020 2020 2020 6b65 792c 0a20 2020 2020        key,.     
-0002a060: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
-0002a070: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-0002a080: 2020 2020 7374 696d 756c 7573 5f69 642c      stimulus_id,
-0002a090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a0a0: 2063 6175 7365 3d6b 6579 2c0a 2020 2020   cause=key,.    
-0002a0b0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0002a0c0: 7074 696f 6e3d 6578 6365 7074 696f 6e2c  ption=exception,
-0002a0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a0e0: 2074 7261 6365 6261 636b 3d74 7261 6365   traceback=trace
-0002a0f0: 6261 636b 2c0a 2020 2020 2020 2020 2020  back,.          
-0002a100: 2020 2020 2020 776f 726b 6572 3d77 6f72        worker=wor
-0002a110: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-0002a120: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0002a130: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0002a140: 2020 6465 6620 7374 696d 756c 7573 5f72    def stimulus_r
-0002a150: 6574 7279 2873 656c 662c 206b 6579 732c  etry(self, keys,
-0002a160: 2063 6c69 656e 743d 4e6f 6e65 293a 0a20   client=None):. 
-0002a170: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0002a180: 666f 2822 436c 6965 6e74 2025 7320 7265  fo("Client %s re
-0002a190: 7175 6573 7473 2074 6f20 7265 7472 7920  quests to retry 
-0002a1a0: 2564 206b 6579 7322 2c20 636c 6965 6e74  %d keys", client
-0002a1b0: 2c20 6c65 6e28 6b65 7973 2929 0a20 2020  , len(keys)).   
-0002a1c0: 2020 2020 2069 6620 636c 6965 6e74 3a0a       if client:.
-0002a1d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002a1e0: 2e6c 6f67 5f65 7665 6e74 2863 6c69 656e  .log_event(clien
-0002a1f0: 742c 207b 2261 6374 696f 6e22 3a20 2272  t, {"action": "r
-0002a200: 6574 7279 222c 2022 636f 756e 7422 3a20  etry", "count": 
-0002a210: 6c65 6e28 6b65 7973 297d 290a 0a20 2020  len(keys)})..   
-0002a220: 2020 2020 2073 7461 636b 203d 206c 6973       stack = lis
-0002a230: 7428 6b65 7973 290a 2020 2020 2020 2020  t(keys).        
-0002a240: 7365 656e 203d 2073 6574 2829 0a20 2020  seen = set().   
-0002a250: 2020 2020 2072 6f6f 7473 203d 205b 5d0a       roots = [].
-0002a260: 2020 2020 2020 2020 7768 696c 6520 7374          while st
-0002a270: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-0002a280: 206b 6579 203d 2073 7461 636b 2e70 6f70   key = stack.pop
-0002a290: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-0002a2a0: 6565 6e2e 6164 6428 6b65 7929 0a20 2020  een.add(key).   
-0002a2b0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0002a2c0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-0002a2d0: 2020 2020 2020 2020 2020 6572 7265 645f            erred_
-0002a2e0: 6465 7073 203d 205b 6474 732e 6b65 7920  deps = [dts.key 
-0002a2f0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-0002a300: 7065 6e64 656e 6369 6573 2069 6620 6474  pendencies if dt
-0002a310: 732e 7374 6174 6520 3d3d 2022 6572 7265  s.state == "erre
-0002a320: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-0002a330: 6966 2065 7272 6564 5f64 6570 733a 0a20  if erred_deps:. 
-0002a340: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002a350: 7461 636b 2e65 7874 656e 6428 6572 7265  tack.extend(erre
-0002a360: 645f 6465 7073 290a 2020 2020 2020 2020  d_deps).        
-0002a370: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002a380: 2020 2020 2020 2020 2020 726f 6f74 732e            roots.
-0002a390: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
-0002a3a0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0002a3b0: 696f 6e73 3a20 5265 6373 203d 207b 6b65  ions: Recs = {ke
-0002a3c0: 793a 2022 7761 6974 696e 6722 2066 6f72  y: "waiting" for
-0002a3d0: 206b 6579 2069 6e20 726f 6f74 737d 0a20   key in roots}. 
-0002a3e0: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-0002a3f0: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
-0002a400: 6461 7469 6f6e 732c 2066 2273 7469 6d75  dations, f"stimu
-0002a410: 6c75 732d 7265 7472 792d 7b74 696d 6528  lus-retry-{time(
-0002a420: 297d 2229 0a0a 2020 2020 2020 2020 6966  )}")..        if
-0002a430: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-0002a440: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002a450: 6b65 7920 696e 2073 6565 6e3a 0a20 2020  key in seen:.   
-0002a460: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0002a470: 6572 7420 6e6f 7420 7365 6c66 2e74 6173  ert not self.tas
-0002a480: 6b73 5b6b 6579 5d2e 6578 6365 7074 696f  ks[key].exceptio
-0002a490: 6e5f 626c 616d 650a 0a20 2020 2020 2020  n_blame..       
-0002a4a0: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
-0002a4b0: 656e 290a 0a20 2020 2064 6566 2063 6c6f  en)..    def clo
-0002a4c0: 7365 5f77 6f72 6b65 7228 7365 6c66 2c20  se_worker(self, 
-0002a4d0: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
-0002a4e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0002a4f0: 2241 736b 2061 2077 6f72 6b65 7220 746f  "Ask a worker to
-0002a500: 2073 6875 7420 6974 7365 6c66 2064 6f77   shut itself dow
-0002a510: 6e2e 2044 6f20 6e6f 7420 7761 6974 2066  n. Do not wait f
-0002a520: 6f72 2069 7420 746f 2074 616b 6520 6566  or it to take ef
-0002a530: 6665 6374 2e0a 2020 2020 2020 2020 4e6f  fect..        No
-0002a540: 7465 2074 6861 7420 7468 6572 6520 6973  te that there is
-0002a550: 206e 6f20 6775 6172 616e 7465 6520 7468   no guarantee th
-0002a560: 6174 2074 6865 2077 6f72 6b65 7220 7769  at the worker wi
-0002a570: 6c6c 2061 6374 7561 6c6c 7920 6163 6365  ll actually acce
-0002a580: 7074 2074 6865 0a20 2020 2020 2020 2063  pt the.        c
-0002a590: 6f6d 6d61 6e64 2e0a 0a20 2020 2020 2020  ommand...       
-0002a5a0: 204e 6f74 6520 7468 6174 203a 6d65 7468   Note that :meth
-0002a5b0: 3a60 7265 6d6f 7665 5f77 6f72 6b65 7260  :`remove_worker`
-0002a5c0: 2073 656e 6473 2074 6865 2073 616d 6520   sends the same 
-0002a5d0: 636f 6d6d 616e 6420 696e 7465 726e 616c  command internal
-0002a5e0: 6c79 2069 6620 636c 6f73 653d 5472 7565  ly if close=True
-0002a5f0: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-0002a600: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0002a610: 2d2d 2d2d 0a20 2020 2020 2020 2072 6574  ----.        ret
-0002a620: 6972 655f 776f 726b 6572 730a 2020 2020  ire_workers.    
-0002a630: 2020 2020 7265 6d6f 7665 5f77 6f72 6b65      remove_worke
-0002a640: 720a 2020 2020 2020 2020 2222 220a 2020  r.        """.  
-0002a650: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
-0002a660: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
-0002a670: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0002a680: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-0002a690: 206c 6f67 6765 722e 696e 666f 2822 436c   logger.info("Cl
-0002a6a0: 6f73 696e 6720 776f 726b 6572 2025 7322  osing worker %s"
-0002a6b0: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
-0002a6c0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-0002a6d0: 2877 6f72 6b65 722c 207b 2261 6374 696f  (worker, {"actio
-0002a6e0: 6e22 3a20 2263 6c6f 7365 2d77 6f72 6b65  n": "close-worke
-0002a6f0: 7222 7d29 0a20 2020 2020 2020 2073 656c  r"}).        sel
-0002a700: 662e 776f 726b 6572 5f73 656e 6428 776f  f.worker_send(wo
-0002a710: 726b 6572 2c20 7b22 6f70 223a 2022 636c  rker, {"op": "cl
-0002a720: 6f73 6522 2c20 2272 6561 736f 6e22 3a20  ose", "reason": 
-0002a730: 2273 6368 6564 756c 6572 2d63 6c6f 7365  "scheduler-close
-0002a740: 2d77 6f72 6b65 7222 7d29 0a0a 2020 2020  -worker"})..    
-0002a750: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-0002a760: 6173 796e 6320 6465 6620 7265 6d6f 7665  async def remove
-0002a770: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-0002a780: 2073 656c 662c 2061 6464 7265 7373 3a20   self, address: 
-0002a790: 7374 722c 202a 2c20 7374 696d 756c 7573  str, *, stimulus
-0002a7a0: 5f69 643a 2073 7472 2c20 7361 6665 3a20  _id: str, safe: 
-0002a7b0: 626f 6f6c 203d 2046 616c 7365 2c20 636c  bool = False, cl
-0002a7c0: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
-0002a7d0: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
-0002a7e0: 6c5b 224f 4b22 2c20 2261 6c72 6561 6479  l["OK", "already
-0002a7f0: 2d72 656d 6f76 6564 225d 3a0a 2020 2020  -removed"]:.    
-0002a800: 2020 2020 2222 2252 656d 6f76 6520 776f      """Remove wo
-0002a810: 726b 6572 2066 726f 6d20 636c 7573 7465  rker from cluste
-0002a820: 722e 0a0a 2020 2020 2020 2020 5765 2064  r...        We d
-0002a830: 6f20 7468 6973 2077 6865 6e20 6120 776f  o this when a wo
-0002a840: 726b 6572 2072 6570 6f72 7473 2074 6861  rker reports tha
-0002a850: 7420 6974 2070 6c61 6e73 2074 6f20 6c65  t it plans to le
-0002a860: 6176 6520 6f72 2077 6865 6e20 6974 2061  ave or when it a
-0002a870: 7070 6561 7273 2074 6f20 6265 0a20 2020  ppears to be.   
-0002a880: 2020 2020 2075 6e72 6573 706f 6e73 6976       unresponsiv
-0002a890: 652e 2054 6869 7320 6d61 7920 7365 6e64  e. This may send
-0002a8a0: 2069 7473 2074 6173 6b73 2062 6163 6b20   its tasks back 
-0002a8b0: 746f 2061 2072 656c 6561 7365 6420 7374  to a released st
-0002a8c0: 6174 652e 0a0a 2020 2020 2020 2020 5365  ate...        Se
-0002a8d0: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-0002a8e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0002a8f0: 7265 7469 7265 5f77 6f72 6b65 7273 0a20  retire_workers. 
-0002a900: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
-0002a910: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
-0002a920: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0002a930: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-0002a940: 2e63 6c6f 7365 643a 0a20 2020 2020 2020  .closed:.       
-0002a950: 2020 2020 2072 6574 7572 6e20 2261 6c72       return "alr
-0002a960: 6561 6479 2d72 656d 6f76 6564 220a 0a20  eady-removed".. 
-0002a970: 2020 2020 2020 2061 6464 7265 7373 203d         address =
-0002a980: 2073 656c 662e 636f 6572 6365 5f61 6464   self.coerce_add
-0002a990: 7265 7373 2861 6464 7265 7373 290a 0a20  ress(address).. 
-0002a9a0: 2020 2020 2020 2069 6620 6164 6472 6573         if addres
-0002a9b0: 7320 6e6f 7420 696e 2073 656c 662e 776f  s not in self.wo
-0002a9c0: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
-0002a9d0: 2020 2072 6574 7572 6e20 2261 6c72 6561     return "alrea
-0002a9e0: 6479 2d72 656d 6f76 6564 220a 0a20 2020  dy-removed"..   
-0002a9f0: 2020 2020 2068 6f73 7420 3d20 6765 745f       host = get_
-0002aa00: 6164 6472 6573 735f 686f 7374 2861 6464  address_host(add
-0002aa10: 7265 7373 290a 0a20 2020 2020 2020 2077  ress)..        w
-0002aa20: 733a 2057 6f72 6b65 7253 7461 7465 203d  s: WorkerState =
-0002aa30: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
-0002aa40: 6472 6573 735d 0a0a 2020 2020 2020 2020  dress]..        
-0002aa50: 6576 656e 745f 6d73 6720 3d20 7b0a 2020  event_msg = {.  
-0002aa60: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-0002aa70: 6e22 3a20 2272 656d 6f76 652d 776f 726b  n": "remove-work
-0002aa80: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-0002aa90: 2022 7072 6f63 6573 7369 6e67 2d74 6173   "processing-tas
-0002aaa0: 6b73 223a 207b 7473 2e6b 6579 2066 6f72  ks": {ts.key for
-0002aab0: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
-0002aac0: 7369 6e67 7d2c 0a20 2020 2020 2020 207d  sing},.        }
-0002aad0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0002aae0: 675f 6576 656e 7428 6164 6472 6573 732c  g_event(address,
-0002aaf0: 2065 7665 6e74 5f6d 7367 2e63 6f70 7928   event_msg.copy(
-0002ab00: 2929 0a20 2020 2020 2020 2065 7665 6e74  )).        event
-0002ab10: 5f6d 7367 5b22 776f 726b 6572 225d 203d  _msg["worker"] =
-0002ab20: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-0002ab30: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-0002ab40: 2261 6c6c 222c 2065 7665 6e74 5f6d 7367  "all", event_msg
-0002ab50: 290a 0a20 2020 2020 2020 206c 6f67 6765  )..        logge
-0002ab60: 722e 696e 666f 2822 5265 6d6f 7665 2077  r.info("Remove w
-0002ab70: 6f72 6b65 7220 2573 222c 2077 7329 0a20  orker %s", ws). 
-0002ab80: 2020 2020 2020 2069 6620 636c 6f73 653a         if close:
-0002ab90: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-0002aba0: 6820 7375 7070 7265 7373 2841 7474 7269  h suppress(Attri
-0002abb0: 6275 7465 4572 726f 722c 2043 6f6d 6d43  buteError, CommC
-0002abc0: 6c6f 7365 6445 7272 6f72 293a 0a20 2020  losedError):.   
-0002abd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0002abe0: 662e 7374 7265 616d 5f63 6f6d 6d73 5b61  f.stream_comms[a
-0002abf0: 6464 7265 7373 5d2e 7365 6e64 280a 2020  ddress].send(.  
-0002ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac10: 2020 7b22 6f70 223a 2022 636c 6f73 6522    {"op": "close"
-0002ac20: 2c20 2272 6561 736f 6e22 3a20 2273 6368  , "reason": "sch
-0002ac30: 6564 756c 6572 2d72 656d 6f76 652d 776f  eduler-remove-wo
-0002ac40: 726b 6572 227d 0a20 2020 2020 2020 2020  rker"}.         
-0002ac50: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0002ac60: 2020 7365 6c66 2e72 656d 6f76 655f 7265    self.remove_re
-0002ac70: 736f 7572 6365 7328 6164 6472 6573 7329  sources(address)
-0002ac80: 0a0a 2020 2020 2020 2020 6468 3a20 6469  ..        dh: di
-0002ac90: 6374 203d 2073 656c 662e 686f 7374 5f69  ct = self.host_i
-0002aca0: 6e66 6f5b 686f 7374 5d0a 2020 2020 2020  nfo[host].      
-0002acb0: 2020 6468 5f61 6464 7265 7373 6573 3a20    dh_addresses: 
-0002acc0: 7365 7420 3d20 6468 5b22 6164 6472 6573  set = dh["addres
-0002acd0: 7365 7322 5d0a 2020 2020 2020 2020 6468  ses"].        dh
-0002ace0: 5f61 6464 7265 7373 6573 2e72 656d 6f76  _addresses.remov
-0002acf0: 6528 6164 6472 6573 7329 0a20 2020 2020  e(address).     
-0002ad00: 2020 2064 685b 226e 7468 7265 6164 7322     dh["nthreads"
-0002ad10: 5d20 2d3d 2077 732e 6e74 6872 6561 6473  ] -= ws.nthreads
-0002ad20: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
-0002ad30: 7461 6c5f 6e74 6872 6561 6473 202d 3d20  tal_nthreads -= 
-0002ad40: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
-0002ad50: 2020 2020 6966 206e 6f74 2064 685f 6164      if not dh_ad
-0002ad60: 6472 6573 7365 733a 0a20 2020 2020 2020  dresses:.       
-0002ad70: 2020 2020 2064 656c 2073 656c 662e 686f       del self.ho
-0002ad80: 7374 5f69 6e66 6f5b 686f 7374 5d0a 0a20  st_info[host].. 
-0002ad90: 2020 2020 2020 2073 656c 662e 7270 632e         self.rpc.
-0002ada0: 7265 6d6f 7665 2861 6464 7265 7373 290a  remove(address).
-0002adb0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-0002adc0: 2e73 7472 6561 6d5f 636f 6d6d 735b 6164  .stream_comms[ad
-0002add0: 6472 6573 735d 0a20 2020 2020 2020 2064  dress].        d
-0002ade0: 656c 2073 656c 662e 616c 6961 7365 735b  el self.aliases[
-0002adf0: 7773 2e6e 616d 655d 0a20 2020 2020 2020  ws.name].       
-0002ae00: 2073 656c 662e 6964 6c65 2e70 6f70 2877   self.idle.pop(w
-0002ae10: 732e 6164 6472 6573 732c 204e 6f6e 6529  s.address, None)
-0002ae20: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
-0002ae30: 6c65 5f74 6173 6b5f 636f 756e 742e 6469  le_task_count.di
-0002ae40: 7363 6172 6428 7773 290a 2020 2020 2020  scard(ws).      
-0002ae50: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-0002ae60: 2e64 6973 6361 7264 2877 7329 0a20 2020  .discard(ws).   
-0002ae70: 2020 2020 2064 656c 2073 656c 662e 776f       del self.wo
-0002ae80: 726b 6572 735b 6164 6472 6573 735d 0a20  rkers[address]. 
-0002ae90: 2020 2020 2020 2077 732e 7374 6174 7573         ws.status
-0002aea0: 203d 2053 7461 7475 732e 636c 6f73 6564   = Status.closed
-0002aeb0: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
-0002aec0: 6e6e 696e 672e 6469 7363 6172 6428 7773  nning.discard(ws
-0002aed0: 290a 0a20 2020 2020 2020 2072 6563 6f6d  )..        recom
-0002aee0: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-0002aef0: 203d 207b 7d0a 0a20 2020 2020 2020 2074   = {}..        t
-0002af00: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
-0002af10: 2020 2020 2066 6f72 2074 7320 696e 206c       for ts in l
-0002af20: 6973 7428 7773 2e70 726f 6365 7373 696e  ist(ws.processin
-0002af30: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
-0002af40: 6b20 3d20 7473 2e6b 6579 0a20 2020 2020  k = ts.key.     
-0002af50: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-0002af60: 6174 696f 6e73 5b6b 5d20 3d20 2272 656c  ations[k] = "rel
-0002af70: 6561 7365 6422 0a20 2020 2020 2020 2020  eased".         
-0002af80: 2020 2069 6620 6e6f 7420 7361 6665 3a0a     if not safe:.
-0002af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002afa0: 7473 2e73 7573 7069 6369 6f75 7320 2b3d  ts.suspicious +=
-0002afb0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-0002afc0: 2020 2074 732e 7072 6566 6978 2e73 7573     ts.prefix.sus
-0002afd0: 7069 6369 6f75 7320 2b3d 2031 0a20 2020  picious += 1.   
-0002afe0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002aff0: 7473 2e73 7573 7069 6369 6f75 7320 3e20  ts.suspicious > 
-0002b000: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
-0002b010: 6c75 7265 733a 0a20 2020 2020 2020 2020  lures:.         
-0002b020: 2020 2020 2020 2020 2020 2064 656c 2072             del r
-0002b030: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-0002b040: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0002b050: 2020 2020 2020 6520 3d20 7069 636b 6c65        e = pickle
-0002b060: 2e64 756d 7073 280a 2020 2020 2020 2020  .dumps(.        
-0002b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b080: 4b69 6c6c 6564 576f 726b 6572 280a 2020  KilledWorker(.  
-0002b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0a0: 2020 2020 2020 2020 2020 7461 736b 3d6b            task=k
-0002b0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b0c0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0002b0d0: 7374 5f77 6f72 6b65 723d 7773 2e63 6c65  st_worker=ws.cle
-0002b0e0: 616e 2829 2c0a 2020 2020 2020 2020 2020  an(),.          
-0002b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b100: 2020 616c 6c6f 7765 645f 6661 696c 7572    allowed_failur
-0002b110: 6573 3d73 656c 662e 616c 6c6f 7765 645f  es=self.allowed_
-0002b120: 6661 696c 7572 6573 2c0a 2020 2020 2020  failures,.      
-0002b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b140: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-0002b150: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002b160: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002b170: 203d 2073 656c 662e 7472 616e 7369 7469   = self.transiti
-0002b180: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0002b190: 2020 2020 2020 2020 2020 2020 6b2c 0a20              k,. 
-0002b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1b0: 2020 2020 2020 2022 6572 7265 6422 2c0a         "erred",.
-0002b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1d0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0002b1e0: 6e3d 652c 0a20 2020 2020 2020 2020 2020  n=e,.           
-0002b1f0: 2020 2020 2020 2020 2020 2020 2063 6175               cau
-0002b200: 7365 3d6b 2c0a 2020 2020 2020 2020 2020  se=k,.          
-0002b210: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002b220: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-0002b230: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-0002b240: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0002b250: 6f72 6b65 723d 6164 6472 6573 732c 0a20  orker=address,. 
-0002b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b270: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002b280: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0002b290: 6e64 6174 696f 6e73 2e75 7064 6174 6528  ndations.update(
-0002b2a0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0002b2b0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0002b2c0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-0002b2d0: 2020 2020 2020 2020 2020 2020 2254 6173              "Tas
-0002b2e0: 6b20 2573 206d 6172 6b65 6420 6173 2066  k %s marked as f
-0002b2f0: 6169 6c65 6420 6265 6361 7573 6520 2564  ailed because %d
-0002b300: 2077 6f72 6b65 7273 2064 6965 6422 0a20   workers died". 
+000285d0: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
+000285e0: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
+000285f0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00028600: 2020 2020 2020 2020 616c 7265 6164 795f          already_
+00028610: 696e 5f6d 656d 6f72 792e 6164 6428 6b29  in_memory.add(k)
+00028620: 0a0a 2020 2020 2020 2020 646f 6e65 203d  ..        done =
+00028630: 2073 6574 2861 6c72 6561 6479 5f69 6e5f   set(already_in_
+00028640: 6d65 6d6f 7279 290a 2020 2020 2020 2020  memory).        
+00028650: 6966 2061 6c72 6561 6479 5f69 6e5f 6d65  if already_in_me
+00028660: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
+00028670: 2020 6465 7065 6e64 656e 7473 203d 2064    dependents = d
+00028680: 6173 6b2e 636f 7265 2e72 6576 6572 7365  ask.core.reverse
+00028690: 5f64 6963 7428 6465 7065 6e64 656e 6369  _dict(dependenci
+000286a0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000286b0: 7374 6163 6b20 3d20 6c69 7374 2861 6c72  stack = list(alr
+000286c0: 6561 6479 5f69 6e5f 6d65 6d6f 7279 290a  eady_in_memory).
+000286d0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+000286e0: 6520 7374 6163 6b3a 2020 2320 7265 6d6f  e stack:  # remo
+000286f0: 7665 2075 6e6e 6563 6573 7361 7279 2064  ve unnecessary d
+00028700: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
+00028710: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
+00028720: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
+00028730: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00028740: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00028750: 2020 2020 2020 2064 6570 7320 3d20 6465         deps = de
+00028760: 7065 6e64 656e 6369 6573 5b6b 6579 5d0a  pendencies[key].
+00028770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028780: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+00028790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000287a0: 2020 2020 2064 6570 7320 3d20 7365 6c66       deps = self
+000287b0: 2e74 6173 6b73 5b6b 6579 5d2e 6465 7065  .tasks[key].depe
+000287c0: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+000287d0: 2020 2020 2020 2020 2066 6f72 2064 6570           for dep
+000287e0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
+000287f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00028800: 2064 6570 2069 6e20 6465 7065 6e64 656e   dep in dependen
+00028810: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00028820: 2020 2020 2020 2020 2020 2020 6368 696c              chil
+00028830: 645f 6465 7073 203d 2064 6570 656e 6465  d_deps = depende
+00028840: 6e74 735b 6465 705d 0a20 2020 2020 2020  nts[dep].       
+00028850: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00028860: 6620 6465 7020 696e 2073 656c 662e 7461  f dep in self.ta
+00028870: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00028880: 2020 2020 2020 2020 2020 2020 2063 6869               chi
+00028890: 6c64 5f64 6570 7320 3d20 7365 6c66 2e74  ld_deps = self.t
+000288a0: 6173 6b73 5b64 6570 5d2e 6465 7065 6e64  asks[dep].depend
+000288b0: 656e 6369 6573 0a20 2020 2020 2020 2020  encies.         
+000288c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000288d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000288e0: 2020 2020 2020 2020 2063 6869 6c64 5f64           child_d
+000288f0: 6570 7320 3d20 7365 7428 290a 2020 2020  eps = set().    
+00028900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028910: 6966 2061 6c6c 2864 2069 6e20 646f 6e65  if all(d in done
+00028920: 2066 6f72 2064 2069 6e20 6368 696c 645f   for d in child_
+00028930: 6465 7073 293a 0a20 2020 2020 2020 2020  deps):.         
+00028940: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00028950: 6620 6465 7020 696e 2073 656c 662e 7461  f dep in self.ta
+00028960: 736b 7320 616e 6420 6465 7020 6e6f 7420  sks and dep not 
+00028970: 696e 2064 6f6e 653a 0a20 2020 2020 2020  in done:.       
+00028980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028990: 2020 2020 2064 6f6e 652e 6164 6428 6465       done.add(de
+000289a0: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
+000289b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000289c0: 7461 636b 2e61 7070 656e 6428 6465 7029  tack.append(dep)
+000289d0: 0a20 2020 2020 2020 2066 6f72 2061 6e63  .        for anc
+000289e0: 2069 6e20 646f 6e65 3a0a 2020 2020 2020   in done:.      
+000289f0: 2020 2020 2020 6473 6b2e 706f 7028 616e        dsk.pop(an
+00028a00: 632c 204e 6f6e 6529 0a20 2020 2020 2020  c, None).       
+00028a10: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
+00028a20: 732e 706f 7028 616e 632c 204e 6f6e 6529  s.pop(anc, None)
+00028a30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00028a40: 646f 6e65 0a0a 2020 2020 4073 7461 7469  done..    @stati
+00028a50: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+00028a60: 6d61 7465 7269 616c 697a 655f 6772 6170  materialize_grap
+00028a70: 6828 686c 673a 2048 6967 684c 6576 656c  h(hlg: HighLevel
+00028a80: 4772 6170 6829 202d 3e20 7475 706c 655b  Graph) -> tuple[
+00028a90: 6469 6374 2c20 6469 6374 2c20 6469 6374  dict, dict, dict
+00028aa0: 2c20 6469 6374 5d3a 0a20 2020 2020 2020  , dict]:.       
+00028ab0: 2066 726f 6d20 6469 7374 7269 6275 7465   from distribute
+00028ac0: 642e 776f 726b 6572 2069 6d70 6f72 7420  d.worker import 
+00028ad0: 6475 6d70 735f 7461 736b 0a0a 2020 2020  dumps_task..    
+00028ae0: 2020 2020 6b65 795f 616e 6e6f 7461 7469      key_annotati
+00028af0: 6f6e 7320 3d20 7b7d 0a20 2020 2020 2020  ons = {}.       
+00028b00: 2064 736b 203d 2064 6173 6b2e 7574 696c   dsk = dask.util
+00028b10: 732e 656e 7375 7265 5f64 6963 7428 686c  s.ensure_dict(hl
+00028b20: 6729 0a0a 2020 2020 2020 2020 666f 7220  g)..        for 
+00028b30: 6c61 7965 7220 696e 2068 6c67 2e6c 6179  layer in hlg.lay
+00028b40: 6572 732e 7661 6c75 6573 2829 3a0a 2020  ers.values():.  
+00028b50: 2020 2020 2020 2020 2020 6966 206c 6179            if lay
+00028b60: 6572 2e61 6e6e 6f74 6174 696f 6e73 3a0a  er.annotations:.
+00028b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b80: 616e 6e6f 7420 3d20 6c61 7965 722e 616e  annot = layer.an
+00028b90: 6e6f 7461 7469 6f6e 730a 2020 2020 2020  notations.      
+00028ba0: 2020 2020 2020 2020 2020 6b65 795f 616e            key_an
+00028bb0: 6e6f 7461 7469 6f6e 732e 7570 6461 7465  notations.update
+00028bc0: 287b 7374 7269 6e67 6966 7928 6b29 3a20  ({stringify(k): 
+00028bd0: 616e 6e6f 7420 666f 7220 6b20 696e 206c  annot for k in l
+00028be0: 6179 6572 7d29 0a0a 2020 2020 2020 2020  ayer})..        
+00028bf0: 6465 7065 6e64 656e 6369 6573 2c20 5f20  dependencies, _ 
+00028c00: 3d20 6765 745f 6465 7073 2864 736b 290a  = get_deps(dsk).
+00028c10: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
+00028c20: 6520 6046 7574 7572 6560 206f 626a 6563  e `Future` objec
+00028c30: 7473 2066 726f 6d20 6772 6170 6820 616e  ts from graph an
+00028c40: 6420 6e6f 7465 2061 6e79 2066 7574 7572  d note any futur
+00028c50: 6520 6465 7065 6e64 656e 6369 6573 0a20  e dependencies. 
+00028c60: 2020 2020 2020 2064 736b 3220 3d20 7b7d         dsk2 = {}
+00028c70: 0a20 2020 2020 2020 2066 7574 5f64 6570  .        fut_dep
+00028c80: 7320 3d20 7b7d 0a20 2020 2020 2020 2066  s = {}.        f
+00028c90: 6f72 206b 2c20 7620 696e 2064 736b 2e69  or k, v in dsk.i
+00028ca0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00028cb0: 2020 2020 6473 6b32 5b6b 5d2c 2066 7574      dsk2[k], fut
+00028cc0: 7320 3d20 756e 7061 636b 5f72 656d 6f74  s = unpack_remot
+00028cd0: 6564 6174 6128 762c 2062 7974 655f 6b65  edata(v, byte_ke
+00028ce0: 7973 3d54 7275 6529 0a20 2020 2020 2020  ys=True).       
+00028cf0: 2020 2020 2069 6620 6675 7473 3a0a 2020       if futs:.  
+00028d00: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+00028d10: 745f 6465 7073 5b6b 5d20 3d20 6675 7473  t_deps[k] = futs
+00028d20: 0a20 2020 2020 2020 2064 736b 203d 2064  .        dsk = d
+00028d30: 736b 320a 0a20 2020 2020 2020 2023 202d  sk2..        # -
+00028d40: 2041 6464 2069 6e20 6465 7073 2066 6f72   Add in deps for
+00028d50: 2061 6e79 2074 6173 6b73 2074 6861 7420   any tasks that 
+00028d60: 6465 7065 6e64 206f 6e20 6675 7475 7265  depend on future
+00028d70: 730a 2020 2020 2020 2020 666f 7220 6b2c  s.        for k,
+00028d80: 2066 7574 7572 6573 2069 6e20 6675 745f   futures in fut_
+00028d90: 6465 7073 2e69 7465 6d73 2829 3a0a 2020  deps.items():.  
+00028da0: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
+00028db0: 656e 6369 6573 5b6b 5d2e 7570 6461 7465  encies[k].update
+00028dc0: 2866 2e6b 6579 2066 6f72 2066 2069 6e20  (f.key for f in 
+00028dd0: 6675 7475 7265 7329 0a20 2020 2020 2020  futures).       
+00028de0: 206e 6577 5f64 736b 203d 207b 7d0a 2020   new_dsk = {}.  
+00028df0: 2020 2020 2020 2320 416e 6e6f 7461 7469        # Annotati
+00028e00: 6f6e 2063 616c 6c61 626c 6573 2061 7265  on callables are
+00028e10: 2065 7661 6c75 6174 6564 206f 6e20 7468   evaluated on th
+00028e20: 6520 6e6f 6e2d 7374 7269 6e67 6966 6965  e non-stringifie
+00028e30: 6420 7665 7273 696f 6e20 6f66 0a20 2020  d version of.   
+00028e40: 2020 2020 2023 2074 6865 206b 6579 730a       # the keys.
+00028e50: 2020 2020 2020 2020 7072 655f 7374 7269          pre_stri
+00028e60: 6e67 6966 6965 645f 6b65 7973 203d 207b  ngified_keys = {
+00028e70: 7d0a 2020 2020 2020 2020 6578 636c 7573  }.        exclus
+00028e80: 6976 6520 3d20 7365 7428 686c 6729 0a20  ive = set(hlg). 
+00028e90: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+00028ea0: 696e 2064 736b 2e69 7465 6d73 2829 3a0a  in dsk.items():.
+00028eb0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+00028ec0: 6b20 3d20 7374 7269 6e67 6966 7928 6b29  k = stringify(k)
+00028ed0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+00028ee0: 5f73 7472 696e 6769 6669 6564 5f6b 6579  _stringified_key
+00028ef0: 735b 6e65 775f 6b5d 203d 206b 0a20 2020  s[new_k] = k.   
+00028f00: 2020 2020 2020 2020 206e 6577 5f64 736b           new_dsk
+00028f10: 5b6e 6577 5f6b 5d20 3d20 7374 7269 6e67  [new_k] = string
+00028f20: 6966 7928 762c 2065 7863 6c75 7369 7665  ify(v, exclusive
+00028f30: 3d65 7863 6c75 7369 7665 290a 2020 2020  =exclusive).    
+00028f40: 2020 2020 6173 7365 7274 206c 656e 286e      assert len(n
+00028f50: 6577 5f64 736b 2920 3d3d 206c 656e 2870  ew_dsk) == len(p
+00028f60: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
+00028f70: 6579 7329 0a20 2020 2020 2020 2064 736b  eys).        dsk
+00028f80: 203d 206e 6577 5f64 736b 0a20 2020 2020   = new_dsk.     
+00028f90: 2020 2064 6570 656e 6465 6e63 6965 7320     dependencies 
+00028fa0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00028fb0: 7374 7269 6e67 6966 7928 6b29 3a20 7b73  stringify(k): {s
+00028fc0: 7472 696e 6769 6679 2864 6570 2920 666f  tringify(dep) fo
+00028fd0: 7220 6465 7020 696e 2064 6570 737d 0a20  r dep in deps}. 
+00028fe0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00028ff0: 2c20 6465 7073 2069 6e20 6465 7065 6e64  , deps in depend
+00029000: 656e 6369 6573 2e69 7465 6d73 2829 0a20  encies.items(). 
+00029010: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00029020: 2020 2320 5265 6d6f 7665 2061 6e79 2073    # Remove any s
+00029030: 656c 662d 6465 7065 6e64 656e 6369 6573  elf-dependencies
+00029040: 2028 6861 7070 656e 7320 6f6e 2074 6573   (happens on tes
+00029050: 745f 7075 626c 6973 685f 6261 6728 2920  t_publish_bag() 
+00029060: 616e 6420 6f74 6865 7273 290a 2020 2020  and others).    
+00029070: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+00029080: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
+00029090: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+000290a0: 2020 6465 7073 203d 2073 6574 2876 290a    deps = set(v).
+000290b0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+000290c0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
+000290d0: 2020 2020 2020 2020 2020 6465 7073 2e72            deps.r
+000290e0: 656d 6f76 6528 6b29 0a20 2020 2020 2020  emove(k).       
+000290f0: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
+00029100: 735b 6b5d 203d 2064 6570 730a 0a20 2020  s[k] = deps..   
+00029110: 2020 2020 2023 2052 656d 6f76 6520 616c       # Remove al
+00029120: 6961 7365 730a 2020 2020 2020 2020 666f  iases.        fo
+00029130: 7220 6b20 696e 206c 6973 7428 6473 6b29  r k in list(dsk)
+00029140: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00029150: 2064 736b 5b6b 5d20 6973 206b 3a0a 2020   dsk[k] is k:.  
+00029160: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00029170: 6c20 6473 6b5b 6b5d 0a20 2020 2020 2020  l dsk[k].       
+00029180: 2064 736b 203d 2076 616c 6d61 7028 6475   dsk = valmap(du
+00029190: 6d70 735f 7461 736b 2c20 6473 6b29 0a20  mps_task, dsk). 
+000291a0: 2020 2020 2020 2072 6574 7572 6e20 6473         return ds
+000291b0: 6b2c 2064 6570 656e 6465 6e63 6965 732c  k, dependencies,
+000291c0: 206b 6579 5f61 6e6e 6f74 6174 696f 6e73   key_annotations
+000291d0: 2c20 7072 655f 7374 7269 6e67 6966 6965  , pre_stringifie
+000291e0: 645f 6b65 7973 0a0a 2020 2020 6465 6620  d_keys..    def 
+000291f0: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
+00029200: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
+00029210: 6428 7365 6c66 2c20 2a2c 2073 7469 6d75  d(self, *, stimu
+00029220: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
+00029230: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00029240: 2252 6573 706f 6e64 2074 6f20 616e 2065  "Respond to an e
+00029250: 7665 6e74 2077 6869 6368 206d 6179 2068  vent which may h
+00029260: 6176 6520 6f70 656e 6564 2073 706f 7473  ave opened spots
+00029270: 206f 6e20 776f 726b 6572 2074 6872 6561   on worker threa
+00029280: 6470 6f6f 6c73 0a0a 2020 2020 2020 2020  dpools..        
+00029290: 5365 6c65 6374 7320 7468 6520 6170 7072  Selects the appr
+000292a0: 6f70 7269 6174 6520 6e75 6d62 6572 206f  opriate number o
+000292b0: 6620 7461 736b 7320 6672 6f6d 2074 6865  f tasks from the
+000292c0: 2066 726f 6e74 206f 6620 7468 6520 7175   front of the qu
+000292d0: 6575 6520 6163 636f 7264 696e 6720 746f  eue according to
+000292e0: 0a20 2020 2020 2020 2074 6865 2074 6f74  .        the tot
+000292f0: 616c 206e 756d 6265 7220 6f66 2074 6173  al number of tas
+00029300: 6b20 736c 6f74 7320 6176 6169 6c61 626c  k slots availabl
+00029310: 6520 6f6e 2077 6f72 6b65 7273 2028 706f  e on workers (po
+00029320: 7465 6e74 6961 6c6c 7920 3029 2c20 616e  tentially 0), an
+00029330: 640a 2020 2020 2020 2020 7472 616e 7369  d.        transi
+00029340: 7469 6f6e 7320 7468 656d 2074 6f20 6060  tions them to ``
+00029350: 7072 6f63 6573 7369 6e67 6060 2e0a 0a20  processing``... 
+00029360: 2020 2020 2020 204e 6f74 6573 0a20 2020         Notes.   
+00029370: 2020 2020 202d 2d2d 2d2d 0a20 2020 2020       -----.     
+00029380: 2020 204f 7468 6572 2074 7261 6e73 6974     Other transit
+00029390: 696f 6e73 2072 656c 6174 6564 2074 6f20  ions related to 
+000293a0: 7468 6973 2073 7469 6d75 6c75 7320 7368  this stimulus sh
+000293b0: 6f75 6c64 2062 6520 6675 6c6c 7920 7072  ould be fully pr
+000293c0: 6f63 6573 7365 6420 6265 666f 7265 6861  ocessed beforeha
+000293d0: 6e64 2c0a 2020 2020 2020 2020 736f 2061  nd,.        so a
+000293e0: 6e79 2074 6173 6b73 2074 6861 7420 6265  ny tasks that be
+000293f0: 6361 6d65 2072 756e 6e61 626c 6520 6172  came runnable ar
+00029400: 6520 616c 7265 6164 7920 696e 2060 6070  e already in ``p
+00029410: 726f 6365 7373 696e 6760 602e 204f 7468  rocessing``. Oth
+00029420: 6572 7769 7365 2c0a 2020 2020 2020 2020  erwise,.        
+00029430: 6f76 6572 7072 6f64 7563 7469 6f6e 2063  overproduction c
+00029440: 616e 206f 6363 7572 2069 6620 7175 6575  an occur if queu
+00029450: 6564 2074 6173 6b73 2067 6574 2073 6368  ed tasks get sch
+00029460: 6564 756c 6564 2062 6566 6f72 6520 646f  eduled before do
+00029470: 776e 7374 7265 616d 2074 6173 6b73 2e0a  wnstream tasks..
+00029480: 0a20 2020 2020 2020 204d 7573 7420 6265  .        Must be
+00029490: 2063 616c 6c65 6420 6166 7465 7220 6063   called after `c
+000294a0: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
+000294b0: 7465 6460 3b20 692e 652e 2060 6964 6c65  ted`; i.e. `idle
+000294c0: 5f74 6173 6b5f 636f 756e 7460 206d 7573  _task_count` mus
+000294d0: 7420 6265 2075 700a 2020 2020 2020 2020  t be up.        
+000294e0: 746f 2064 6174 652e 0a20 2020 2020 2020  to date..       
+000294f0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00029500: 6e6f 7420 7365 6c66 2e71 7565 7565 643a  not self.queued:
+00029510: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00029520: 7572 6e0a 2020 2020 2020 2020 736c 6f74  urn.        slot
+00029530: 735f 6176 6169 6c61 626c 6520 3d20 7375  s_available = su
+00029540: 6d28 0a20 2020 2020 2020 2020 2020 205f  m(.            _
+00029550: 7461 736b 5f73 6c6f 7473 5f61 7661 696c  task_slots_avail
+00029560: 6162 6c65 2877 732c 2073 656c 662e 574f  able(ws, self.WO
+00029570: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
+00029580: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00029590: 2077 7320 696e 2073 656c 662e 6964 6c65   ws in self.idle
+000295a0: 5f74 6173 6b5f 636f 756e 740a 2020 2020  _task_count.    
+000295b0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+000295c0: 2073 6c6f 7473 5f61 7661 696c 6162 6c65   slots_available
+000295d0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+000295e0: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+000295f0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00029600: 6e73 3a20 5265 6373 203d 207b 7d0a 2020  ns: Recs = {}.  
+00029610: 2020 2020 2020 666f 7220 7174 7320 696e        for qts in
+00029620: 2073 656c 662e 7175 6575 6564 2e70 6565   self.queued.pee
+00029630: 6b6e 2873 6c6f 7473 5f61 7661 696c 6162  kn(slots_availab
+00029640: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+00029650: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00029660: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00029670: 2020 2061 7373 6572 7420 7174 732e 7374     assert qts.st
+00029680: 6174 6520 3d3d 2022 7175 6575 6564 222c  ate == "queued",
+00029690: 2071 7473 2e73 7461 7465 0a20 2020 2020   qts.state.     
+000296a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000296b0: 7420 6e6f 7420 7174 732e 7072 6f63 6573  t not qts.proces
+000296c0: 7369 6e67 5f6f 6e2c 2028 7174 732c 2071  sing_on, (qts, q
+000296d0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+000296e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000296f0: 2020 6173 7365 7274 206e 6f74 2071 7473    assert not qts
+00029700: 2e77 6169 7469 6e67 5f6f 6e2c 2028 7174  .waiting_on, (qt
+00029710: 732c 2071 7473 2e70 726f 6365 7373 696e  s, qts.processin
+00029720: 675f 6f6e 290a 2020 2020 2020 2020 2020  g_on).          
+00029730: 2020 2020 2020 6173 7365 7274 2071 7473        assert qts
+00029740: 2e77 686f 5f77 616e 7473 206f 7220 7174  .who_wants or qt
+00029750: 732e 7761 6974 6572 732c 2071 7473 0a20  s.waiters, qts. 
+00029760: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00029770: 6d65 6e64 6174 696f 6e73 5b71 7473 2e6b  mendations[qts.k
+00029780: 6579 5d20 3d20 2270 726f 6365 7373 696e  ey] = "processin
+00029790: 6722 0a0a 2020 2020 2020 2020 7365 6c66  g"..        self
+000297a0: 2e74 7261 6e73 6974 696f 6e73 2872 6563  .transitions(rec
+000297b0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
+000297c0: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
+000297d0: 6465 6620 7374 696d 756c 7573 5f74 6173  def stimulus_tas
+000297e0: 6b5f 6669 6e69 7368 6564 2873 656c 662c  k_finished(self,
+000297f0: 206b 6579 2c20 776f 726b 6572 2c20 7374   key, worker, st
+00029800: 696d 756c 7573 5f69 642c 2072 756e 5f69  imulus_id, run_i
+00029810: 642c 202a 2a6b 7761 7267 7329 3a0a 2020  d, **kwargs):.  
+00029820: 2020 2020 2020 2222 224d 6172 6b20 7468        """Mark th
+00029830: 6174 2061 2074 6173 6b20 6861 7320 6669  at a task has fi
+00029840: 6e69 7368 6564 2065 7865 6375 7469 6f6e  nished execution
+00029850: 206f 6e20 6120 7061 7274 6963 756c 6172   on a particular
+00029860: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
+00029870: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00029880: 2253 7469 6d75 6c75 7320 7461 736b 2066  "Stimulus task f
+00029890: 696e 6973 6865 6420 2573 5b25 645d 2025  inished %s[%d] %
+000298a0: 7322 2c20 6b65 792c 2072 756e 5f69 642c  s", key, run_id,
+000298b0: 2077 6f72 6b65 7229 0a0a 2020 2020 2020   worker)..      
+000298c0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+000298d0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+000298e0: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
+000298f0: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
+00029900: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
+00029910: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
+00029920: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
+00029930: 6174 6520 3d20 7365 6c66 2e77 6f72 6b65  ate = self.worke
+00029940: 7273 5b77 6f72 6b65 725d 0a20 2020 2020  rs[worker].     
+00029950: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
+00029960: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
+00029970: 7428 6b65 7929 0a20 2020 2020 2020 2069  t(key).        i
+00029980: 6620 7473 2069 7320 4e6f 6e65 206f 7220  f ts is None or 
+00029990: 7473 2e73 7461 7465 2069 6e20 2822 7265  ts.state in ("re
+000299a0: 6c65 6173 6564 222c 2022 7175 6575 6564  leased", "queued
+000299b0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+000299c0: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+000299d0: 2020 2020 2020 2020 2020 2020 2020 2252                "R
+000299e0: 6563 6569 7665 6420 616c 7265 6164 7920  eceived already 
+000299f0: 636f 6d70 7574 6564 2074 6173 6b2c 2077  computed task, w
+00029a00: 6f72 6b65 723a 2025 732c 2073 7461 7465  orker: %s, state
+00029a10: 3a20 2573 220a 2020 2020 2020 2020 2020  : %s".          
+00029a20: 2020 2020 2020 222c 206b 6579 3a20 2573        ", key: %s
+00029a30: 2c20 7768 6f5f 6861 733a 2025 7322 2c0a  , who_has: %s",.
+00029a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a50: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
+00029a60: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+00029a70: 2069 6620 7473 2065 6c73 6520 2266 6f72   if ts else "for
+00029a80: 676f 7474 656e 222c 0a20 2020 2020 2020  gotten",.       
+00029a90: 2020 2020 2020 2020 206b 6579 2c0a 2020           key,.  
+00029aa0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00029ab0: 2e77 686f 5f68 6173 2069 6620 7473 2065  .who_has if ts e
+00029ac0: 6c73 6520 7b7d 2c0a 2020 2020 2020 2020  lse {},.        
+00029ad0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00029ae0: 2020 776f 726b 6572 5f6d 7367 735b 776f    worker_msgs[wo
+00029af0: 726b 6572 5d20 3d20 5b0a 2020 2020 2020  rker] = [.      
+00029b00: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00029b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b20: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
+00029b30: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00029b40: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
+00029b50: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
+00029b60: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+00029b70: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+00029b80: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+00029b90: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00029ba0: 2020 2020 5d0a 2020 2020 2020 2020 656c      ].        el
+00029bb0: 6966 2074 732e 7275 6e5f 6964 2021 3d20  if ts.run_id != 
+00029bc0: 7275 6e5f 6964 3a0a 2020 2020 2020 2020  run_id:.        
+00029bd0: 2020 2020 6966 206e 6f74 2074 732e 7072      if not ts.pr
+00029be0: 6f63 6573 7369 6e67 5f6f 6e20 6f72 2074  ocessing_on or t
+00029bf0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e2e  s.processing_on.
+00029c00: 6164 6472 6573 7320 213d 2077 6f72 6b65  address != worke
+00029c10: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00029c20: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00029c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029c40: 2020 2020 2022 5265 6365 6976 6564 2073       "Received s
+00029c50: 7461 6c65 2074 6173 6b20 7275 6e2c 2077  tale task run, w
+00029c60: 6f72 6b65 723a 2025 732c 206b 6579 3a20  orker: %s, key: 
+00029c70: 2573 2c20 7275 6e5f 6964 3a20 2564 2028  %s, run_id: %d (
+00029c80: 2564 2922 2c0a 2020 2020 2020 2020 2020  %d)",.          
+00029c90: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00029ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029cb0: 2020 2020 2020 6b65 792c 0a20 2020 2020        key,.     
+00029cc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00029cd0: 756e 5f69 642c 0a20 2020 2020 2020 2020  un_id,.         
+00029ce0: 2020 2020 2020 2020 2020 2074 732e 7275             ts.ru
+00029cf0: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
+00029d00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00029d10: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+00029d20: 7367 735b 776f 726b 6572 5d20 3d20 5b0a  sgs[worker] = [.
+00029d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00029d50: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+00029d60: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
+00029d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029d80: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
+00029d90: 205b 6b65 795d 2c0a 2020 2020 2020 2020   [key],.        
+00029da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029db0: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
+00029dc0: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029de0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00029df0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00029e00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00029e10: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00029e20: 7469 6f6e 735b 7473 2e6b 6579 5d20 3d20  tions[ts.key] = 
+00029e30: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
+00029e40: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
+00029e50: 203d 3d20 226d 656d 6f72 7922 3a0a 2020   == "memory":.  
+00029e60: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00029e70: 6464 5f6b 6579 7328 776f 726b 6572 3d77  dd_keys(worker=w
+00029e80: 6f72 6b65 722c 206b 6579 733d 5b6b 6579  orker, keys=[key
+00029e90: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
+00029ea0: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+00029eb0: 6d65 7461 6461 7461 2e75 7064 6174 6528  metadata.update(
+00029ec0: 6b77 6172 6773 5b22 6d65 7461 6461 7461  kwargs["metadata
+00029ed0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+00029ee0: 723a 2074 7570 6c65 203d 2073 656c 662e  r: tuple = self.
+00029ef0: 5f74 7261 6e73 6974 696f 6e28 0a20 2020  _transition(.   
+00029f00: 2020 2020 2020 2020 2020 2020 206b 6579               key
+00029f10: 2c20 226d 656d 6f72 7922 2c20 7374 696d  , "memory", stim
+00029f20: 756c 7573 5f69 642c 2077 6f72 6b65 723d  ulus_id, worker=
+00029f30: 776f 726b 6572 2c20 2a2a 6b77 6172 6773  worker, **kwargs
+00029f40: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00029f50: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00029f60: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
+00029f70: 6e74 5f6d 7367 732c 2077 6f72 6b65 725f  nt_msgs, worker_
+00029f80: 6d73 6773 203d 2072 0a0a 2020 2020 2020  msgs = r..      
+00029f90: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
+00029fa0: 6520 3d3d 2022 6d65 6d6f 7279 223a 0a20  e == "memory":. 
+00029fb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00029fc0: 7373 6572 7420 7773 2069 6e20 7473 2e77  ssert ws in ts.w
+00029fd0: 686f 5f68 6173 0a20 2020 2020 2020 2072  ho_has.        r
+00029fe0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+00029ff0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
+0002a000: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
+0002a010: 0a20 2020 2064 6566 2073 7469 6d75 6c75  .    def stimulu
+0002a020: 735f 7461 736b 5f65 7272 6564 280a 2020  s_task_erred(.  
+0002a030: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0002a040: 2020 2020 6b65 793d 4e6f 6e65 2c0a 2020      key=None,.  
+0002a050: 2020 2020 2020 776f 726b 6572 3d4e 6f6e        worker=Non
+0002a060: 652c 0a20 2020 2020 2020 2065 7863 6570  e,.        excep
+0002a070: 7469 6f6e 3d4e 6f6e 652c 0a20 2020 2020  tion=None,.     
+0002a080: 2020 2073 7469 6d75 6c75 735f 6964 3d4e     stimulus_id=N
+0002a090: 6f6e 652c 0a20 2020 2020 2020 2074 7261  one,.        tra
+0002a0a0: 6365 6261 636b 3d4e 6f6e 652c 0a20 2020  ceback=None,.   
+0002a0b0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+0002a0c0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+0002a0d0: 224d 6172 6b20 7468 6174 2061 2074 6173  "Mark that a tas
+0002a0e0: 6b20 6861 7320 6572 7265 6420 6f6e 2061  k has erred on a
+0002a0f0: 2070 6172 7469 6375 6c61 7220 776f 726b   particular work
+0002a100: 6572 2222 220a 2020 2020 2020 2020 6c6f  er""".        lo
+0002a110: 6767 6572 2e64 6562 7567 2822 5374 696d  gger.debug("Stim
+0002a120: 756c 7573 2074 6173 6b20 6572 7265 6420  ulus task erred 
+0002a130: 2573 2c20 2573 222c 206b 6579 2c20 776f  %s, %s", key, wo
+0002a140: 726b 6572 290a 0a20 2020 2020 2020 2074  rker)..        t
+0002a150: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
+0002a160: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+0002a170: 7929 0a20 2020 2020 2020 2069 6620 7473  y).        if ts
+0002a180: 2069 7320 4e6f 6e65 206f 7220 7473 2e73   is None or ts.s
+0002a190: 7461 7465 2021 3d20 2270 726f 6365 7373  tate != "process
+0002a1a0: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
+0002a1b0: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
+0002a1c0: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
+0002a1d0: 7473 2e72 6574 7269 6573 203e 2030 3a0a  ts.retries > 0:.
+0002a1e0: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
+0002a1f0: 6574 7269 6573 202d 3d20 310a 2020 2020  etries -= 1.    
+0002a200: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0002a210: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
+0002a220: 6b65 792c 2022 7761 6974 696e 6722 2c20  key, "waiting", 
+0002a230: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
+0002a240: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002a250: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0002a260: 6c66 2e5f 7472 616e 7369 7469 6f6e 280a  lf._transition(.
+0002a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a280: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+0002a290: 2020 2020 2022 6572 7265 6422 2c0a 2020       "erred",.  
+0002a2a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002a2b0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+0002a2c0: 2020 2020 2020 2020 2020 2063 6175 7365             cause
+0002a2d0: 3d6b 6579 2c0a 2020 2020 2020 2020 2020  =key,.          
+0002a2e0: 2020 2020 2020 6578 6365 7074 696f 6e3d        exception=
+0002a2f0: 6578 6365 7074 696f 6e2c 0a20 2020 2020  exception,.     
+0002a300: 2020 2020 2020 2020 2020 2074 7261 6365             trace
+0002a310: 6261 636b 3d74 7261 6365 6261 636b 2c0a  back=traceback,.
+0002a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a330: 776f 726b 6572 3d77 6f72 6b65 722c 0a20  worker=worker,. 
+0002a340: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0002a350: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0002a360: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0002a370: 7374 696d 756c 7573 5f72 6574 7279 2873  stimulus_retry(s
+0002a380: 656c 662c 206b 6579 732c 2063 6c69 656e  elf, keys, clien
+0002a390: 743d 4e6f 6e65 293a 0a20 2020 2020 2020  t=None):.       
+0002a3a0: 206c 6f67 6765 722e 696e 666f 2822 436c   logger.info("Cl
+0002a3b0: 6965 6e74 2025 7320 7265 7175 6573 7473  ient %s requests
+0002a3c0: 2074 6f20 7265 7472 7920 2564 206b 6579   to retry %d key
+0002a3d0: 7322 2c20 636c 6965 6e74 2c20 6c65 6e28  s", client, len(
+0002a3e0: 6b65 7973 2929 0a20 2020 2020 2020 2069  keys)).        i
+0002a3f0: 6620 636c 6965 6e74 3a0a 2020 2020 2020  f client:.      
+0002a400: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+0002a410: 7665 6e74 2863 6c69 656e 742c 207b 2261  vent(client, {"a
+0002a420: 6374 696f 6e22 3a20 2272 6574 7279 222c  ction": "retry",
+0002a430: 2022 636f 756e 7422 3a20 6c65 6e28 6b65   "count": len(ke
+0002a440: 7973 297d 290a 0a20 2020 2020 2020 2073  ys)})..        s
+0002a450: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
+0002a460: 290a 2020 2020 2020 2020 7365 656e 203d  ).        seen =
+0002a470: 2073 6574 2829 0a20 2020 2020 2020 2072   set().        r
+0002a480: 6f6f 7473 203d 205b 5d0a 2020 2020 2020  oots = [].      
+0002a490: 2020 7768 696c 6520 7374 6163 6b3a 0a20    while stack:. 
+0002a4a0: 2020 2020 2020 2020 2020 206b 6579 203d             key =
+0002a4b0: 2073 7461 636b 2e70 6f70 2829 0a20 2020   stack.pop().   
+0002a4c0: 2020 2020 2020 2020 2073 6565 6e2e 6164           seen.ad
+0002a4d0: 6428 6b65 7929 0a20 2020 2020 2020 2020  d(key).         
+0002a4e0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+0002a4f0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+0002a500: 2020 2020 6572 7265 645f 6465 7073 203d      erred_deps =
+0002a510: 205b 6474 732e 6b65 7920 666f 7220 6474   [dts.key for dt
+0002a520: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0002a530: 6369 6573 2069 6620 6474 732e 7374 6174  cies if dts.stat
+0002a540: 6520 3d3d 2022 6572 7265 6422 5d0a 2020  e == "erred"].  
+0002a550: 2020 2020 2020 2020 2020 6966 2065 7272            if err
+0002a560: 6564 5f64 6570 733a 0a20 2020 2020 2020  ed_deps:.       
+0002a570: 2020 2020 2020 2020 2073 7461 636b 2e65           stack.e
+0002a580: 7874 656e 6428 6572 7265 645f 6465 7073  xtend(erred_deps
+0002a590: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0002a5a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002a5b0: 2020 2020 726f 6f74 732e 6170 7065 6e64      roots.append
+0002a5c0: 286b 6579 290a 0a20 2020 2020 2020 2072  (key)..        r
+0002a5d0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+0002a5e0: 5265 6373 203d 207b 6b65 793a 2022 7761  Recs = {key: "wa
+0002a5f0: 6974 696e 6722 2066 6f72 206b 6579 2069  iting" for key i
+0002a600: 6e20 726f 6f74 737d 0a20 2020 2020 2020  n roots}.       
+0002a610: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+0002a620: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
+0002a630: 732c 2066 2273 7469 6d75 6c75 732d 7265  s, f"stimulus-re
+0002a640: 7472 792d 7b74 696d 6528 297d 2229 0a0a  try-{time()}")..
+0002a650: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0002a660: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+0002a670: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+0002a680: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
+0002a690: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002a6a0: 7420 7365 6c66 2e74 6173 6b73 5b6b 6579  t self.tasks[key
+0002a6b0: 5d2e 6578 6365 7074 696f 6e5f 626c 616d  ].exception_blam
+0002a6c0: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
+0002a6d0: 6e20 7475 706c 6528 7365 656e 290a 0a20  n tuple(seen).. 
+0002a6e0: 2020 2064 6566 2063 6c6f 7365 5f77 6f72     def close_wor
+0002a6f0: 6b65 7228 7365 6c66 2c20 776f 726b 6572  ker(self, worker
+0002a700: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+0002a710: 2020 2020 2020 2020 2222 2241 736b 2061          """Ask a
+0002a720: 2077 6f72 6b65 7220 746f 2073 6875 7420   worker to shut 
+0002a730: 6974 7365 6c66 2064 6f77 6e2e 2044 6f20  itself down. Do 
+0002a740: 6e6f 7420 7761 6974 2066 6f72 2069 7420  not wait for it 
+0002a750: 746f 2074 616b 6520 6566 6665 6374 2e0a  to take effect..
+0002a760: 2020 2020 2020 2020 4e6f 7465 2074 6861          Note tha
+0002a770: 7420 7468 6572 6520 6973 206e 6f20 6775  t there is no gu
+0002a780: 6172 616e 7465 6520 7468 6174 2074 6865  arantee that the
+0002a790: 2077 6f72 6b65 7220 7769 6c6c 2061 6374   worker will act
+0002a7a0: 7561 6c6c 7920 6163 6365 7074 2074 6865  ually accept the
+0002a7b0: 0a20 2020 2020 2020 2063 6f6d 6d61 6e64  .        command
+0002a7c0: 2e0a 0a20 2020 2020 2020 204e 6f74 6520  ...        Note 
+0002a7d0: 7468 6174 203a 6d65 7468 3a60 7265 6d6f  that :meth:`remo
+0002a7e0: 7665 5f77 6f72 6b65 7260 2073 656e 6473  ve_worker` sends
+0002a7f0: 2074 6865 2073 616d 6520 636f 6d6d 616e   the same comman
+0002a800: 6420 696e 7465 726e 616c 6c79 2069 6620  d internally if 
+0002a810: 636c 6f73 653d 5472 7565 2e0a 0a20 2020  close=True...   
+0002a820: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
+0002a830: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+0002a840: 2020 2020 2020 2072 6574 6972 655f 776f         retire_wo
+0002a850: 726b 6572 730a 2020 2020 2020 2020 7265  rkers.        re
+0002a860: 6d6f 7665 5f77 6f72 6b65 720a 2020 2020  move_worker.    
+0002a870: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002a880: 6966 2077 6f72 6b65 7220 6e6f 7420 696e  if worker not in
+0002a890: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
+0002a8a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002a8b0: 6e0a 0a20 2020 2020 2020 206c 6f67 6765  n..        logge
+0002a8c0: 722e 696e 666f 2822 436c 6f73 696e 6720  r.info("Closing 
+0002a8d0: 776f 726b 6572 2025 7322 2c20 776f 726b  worker %s", work
+0002a8e0: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
+0002a8f0: 2e6c 6f67 5f65 7665 6e74 2877 6f72 6b65  .log_event(worke
+0002a900: 722c 207b 2261 6374 696f 6e22 3a20 2263  r, {"action": "c
+0002a910: 6c6f 7365 2d77 6f72 6b65 7222 7d29 0a20  lose-worker"}). 
+0002a920: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
+0002a930: 6572 5f73 656e 6428 776f 726b 6572 2c20  er_send(worker, 
+0002a940: 7b22 6f70 223a 2022 636c 6f73 6522 2c20  {"op": "close", 
+0002a950: 2272 6561 736f 6e22 3a20 2273 6368 6564  "reason": "sched
+0002a960: 756c 6572 2d63 6c6f 7365 2d77 6f72 6b65  uler-close-worke
+0002a970: 7222 7d29 0a0a 2020 2020 406c 6f67 5f65  r"})..    @log_e
+0002a980: 7272 6f72 730a 2020 2020 6173 796e 6320  rrors.    async 
+0002a990: 6465 6620 7265 6d6f 7665 5f77 6f72 6b65  def remove_worke
+0002a9a0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
+0002a9b0: 2061 6464 7265 7373 3a20 7374 722c 202a   address: str, *
+0002a9c0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0002a9d0: 7472 2c20 7361 6665 3a20 626f 6f6c 203d  tr, safe: bool =
+0002a9e0: 2046 616c 7365 2c20 636c 6f73 653a 2062   False, close: b
+0002a9f0: 6f6f 6c20 3d20 5472 7565 0a20 2020 2029  ool = True.    )
+0002aa00: 202d 3e20 4c69 7465 7261 6c5b 224f 4b22   -> Literal["OK"
+0002aa10: 2c20 2261 6c72 6561 6479 2d72 656d 6f76  , "already-remov
+0002aa20: 6564 225d 3a0a 2020 2020 2020 2020 2222  ed"]:.        ""
+0002aa30: 2252 656d 6f76 6520 776f 726b 6572 2066  "Remove worker f
+0002aa40: 726f 6d20 636c 7573 7465 722e 0a0a 2020  rom cluster...  
+0002aa50: 2020 2020 2020 5765 2064 6f20 7468 6973        We do this
+0002aa60: 2077 6865 6e20 6120 776f 726b 6572 2072   when a worker r
+0002aa70: 6570 6f72 7473 2074 6861 7420 6974 2070  eports that it p
+0002aa80: 6c61 6e73 2074 6f20 6c65 6176 6520 6f72  lans to leave or
+0002aa90: 2077 6865 6e20 6974 2061 7070 6561 7273   when it appears
+0002aaa0: 2074 6f20 6265 0a20 2020 2020 2020 2075   to be.        u
+0002aab0: 6e72 6573 706f 6e73 6976 652e 2054 6869  nresponsive. Thi
+0002aac0: 7320 6d61 7920 7365 6e64 2069 7473 2074  s may send its t
+0002aad0: 6173 6b73 2062 6163 6b20 746f 2061 2072  asks back to a r
+0002aae0: 656c 6561 7365 6420 7374 6174 652e 0a0a  eleased state...
+0002aaf0: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+0002ab00: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0002ab10: 2d0a 2020 2020 2020 2020 7265 7469 7265  -.        retire
+0002ab20: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+0002ab30: 2063 6c6f 7365 5f77 6f72 6b65 720a 2020   close_worker.  
+0002ab40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0002ab50: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
+0002ab60: 203d 3d20 5374 6174 7573 2e63 6c6f 7365   == Status.close
+0002ab70: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+0002ab80: 6574 7572 6e20 2261 6c72 6561 6479 2d72  eturn "already-r
+0002ab90: 656d 6f76 6564 220a 0a20 2020 2020 2020  emoved"..       
+0002aba0: 2061 6464 7265 7373 203d 2073 656c 662e   address = self.
+0002abb0: 636f 6572 6365 5f61 6464 7265 7373 2861  coerce_address(a
+0002abc0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
+0002abd0: 2069 6620 6164 6472 6573 7320 6e6f 7420   if address not 
+0002abe0: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
+0002abf0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002ac00: 7572 6e20 2261 6c72 6561 6479 2d72 656d  urn "already-rem
+0002ac10: 6f76 6564 220a 0a20 2020 2020 2020 2068  oved"..        h
+0002ac20: 6f73 7420 3d20 6765 745f 6164 6472 6573  ost = get_addres
+0002ac30: 735f 686f 7374 2861 6464 7265 7373 290a  s_host(address).
+0002ac40: 0a20 2020 2020 2020 2077 733a 2057 6f72  .        ws: Wor
+0002ac50: 6b65 7253 7461 7465 203d 2073 656c 662e  kerState = self.
+0002ac60: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
+0002ac70: 0a0a 2020 2020 2020 2020 6576 656e 745f  ..        event_
+0002ac80: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+0002ac90: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
+0002aca0: 656d 6f76 652d 776f 726b 6572 222c 0a20  emove-worker",. 
+0002acb0: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
+0002acc0: 6573 7369 6e67 2d74 6173 6b73 223a 207b  essing-tasks": {
+0002acd0: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+0002ace0: 2077 732e 7072 6f63 6573 7369 6e67 7d2c   ws.processing},
+0002acf0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+0002ad00: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0002ad10: 7428 6164 6472 6573 732c 2065 7665 6e74  t(address, event
+0002ad20: 5f6d 7367 2e63 6f70 7928 2929 0a20 2020  _msg.copy()).   
+0002ad30: 2020 2020 2065 7665 6e74 5f6d 7367 5b22       event_msg["
+0002ad40: 776f 726b 6572 225d 203d 2061 6464 7265  worker"] = addre
+0002ad50: 7373 0a20 2020 2020 2020 2073 656c 662e  ss.        self.
+0002ad60: 6c6f 675f 6576 656e 7428 2261 6c6c 222c  log_event("all",
+0002ad70: 2065 7665 6e74 5f6d 7367 290a 0a20 2020   event_msg)..   
+0002ad80: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0002ad90: 2822 5265 6d6f 7665 2077 6f72 6b65 7220  ("Remove worker 
+0002ada0: 2573 222c 2077 7329 0a20 2020 2020 2020  %s", ws).       
+0002adb0: 2069 6620 636c 6f73 653a 0a20 2020 2020   if close:.     
+0002adc0: 2020 2020 2020 2077 6974 6820 7375 7070         with supp
+0002add0: 7265 7373 2841 7474 7269 6275 7465 4572  ress(AttributeEr
+0002ade0: 726f 722c 2043 6f6d 6d43 6c6f 7365 6445  ror, CommClosedE
+0002adf0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0002ae00: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+0002ae10: 616d 5f63 6f6d 6d73 5b61 6464 7265 7373  am_comms[address
+0002ae20: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
+0002ae30: 2020 2020 2020 2020 2020 2020 7b22 6f70              {"op
+0002ae40: 223a 2022 636c 6f73 6522 2c20 2272 6561  ": "close", "rea
+0002ae50: 736f 6e22 3a20 2273 6368 6564 756c 6572  son": "scheduler
+0002ae60: 2d72 656d 6f76 652d 776f 726b 6572 227d  -remove-worker"}
+0002ae70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ae80: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+0002ae90: 2e72 656d 6f76 655f 7265 736f 7572 6365  .remove_resource
+0002aea0: 7328 6164 6472 6573 7329 0a0a 2020 2020  s(address)..    
+0002aeb0: 2020 2020 6468 3a20 6469 6374 203d 2073      dh: dict = s
+0002aec0: 656c 662e 686f 7374 5f69 6e66 6f5b 686f  elf.host_info[ho
+0002aed0: 7374 5d0a 2020 2020 2020 2020 6468 5f61  st].        dh_a
+0002aee0: 6464 7265 7373 6573 3a20 7365 7420 3d20  ddresses: set = 
+0002aef0: 6468 5b22 6164 6472 6573 7365 7322 5d0a  dh["addresses"].
+0002af00: 2020 2020 2020 2020 6468 5f61 6464 7265          dh_addre
+0002af10: 7373 6573 2e72 656d 6f76 6528 6164 6472  sses.remove(addr
+0002af20: 6573 7329 0a20 2020 2020 2020 2064 685b  ess).        dh[
+0002af30: 226e 7468 7265 6164 7322 5d20 2d3d 2077  "nthreads"] -= w
+0002af40: 732e 6e74 6872 6561 6473 0a20 2020 2020  s.nthreads.     
+0002af50: 2020 2073 656c 662e 746f 7461 6c5f 6e74     self.total_nt
+0002af60: 6872 6561 6473 202d 3d20 7773 2e6e 7468  hreads -= ws.nth
+0002af70: 7265 6164 730a 2020 2020 2020 2020 6966  reads.        if
+0002af80: 206e 6f74 2064 685f 6164 6472 6573 7365   not dh_addresse
+0002af90: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
+0002afa0: 656c 2073 656c 662e 686f 7374 5f69 6e66  el self.host_inf
+0002afb0: 6f5b 686f 7374 5d0a 0a20 2020 2020 2020  o[host]..       
+0002afc0: 2073 656c 662e 7270 632e 7265 6d6f 7665   self.rpc.remove
+0002afd0: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
+0002afe0: 2020 6465 6c20 7365 6c66 2e73 7472 6561    del self.strea
+0002aff0: 6d5f 636f 6d6d 735b 6164 6472 6573 735d  m_comms[address]
+0002b000: 0a20 2020 2020 2020 2064 656c 2073 656c  .        del sel
+0002b010: 662e 616c 6961 7365 735b 7773 2e6e 616d  f.aliases[ws.nam
+0002b020: 655d 0a20 2020 2020 2020 2073 656c 662e  e].        self.
+0002b030: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
+0002b040: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
+0002b050: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
+0002b060: 6b5f 636f 756e 742e 6469 7363 6172 6428  k_count.discard(
+0002b070: 7773 290a 2020 2020 2020 2020 7365 6c66  ws).        self
+0002b080: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
+0002b090: 7264 2877 7329 0a20 2020 2020 2020 2064  rd(ws).        d
+0002b0a0: 656c 2073 656c 662e 776f 726b 6572 735b  el self.workers[
+0002b0b0: 6164 6472 6573 735d 0a20 2020 2020 2020  address].       
+0002b0c0: 2077 732e 7374 6174 7573 203d 2053 7461   ws.status = Sta
+0002b0d0: 7475 732e 636c 6f73 6564 0a20 2020 2020  tus.closed.     
+0002b0e0: 2020 2073 656c 662e 7275 6e6e 696e 672e     self.running.
+0002b0f0: 6469 7363 6172 6428 7773 290a 0a20 2020  discard(ws)..   
+0002b100: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0002b110: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+0002b120: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
+0002b130: 6b53 7461 7465 0a20 2020 2020 2020 2066  kState.        f
+0002b140: 6f72 2074 7320 696e 206c 6973 7428 7773  or ts in list(ws
+0002b150: 2e70 726f 6365 7373 696e 6729 3a0a 2020  .processing):.  
+0002b160: 2020 2020 2020 2020 2020 6b20 3d20 7473            k = ts
+0002b170: 2e6b 6579 0a20 2020 2020 2020 2020 2020  .key.           
+0002b180: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0002b190: 5b6b 5d20 3d20 2272 656c 6561 7365 6422  [k] = "released"
+0002b1a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002b1b0: 6e6f 7420 7361 6665 3a0a 2020 2020 2020  not safe:.      
+0002b1c0: 2020 2020 2020 2020 2020 7473 2e73 7573            ts.sus
+0002b1d0: 7069 6369 6f75 7320 2b3d 2031 0a20 2020  picious += 1.   
+0002b1e0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0002b1f0: 7072 6566 6978 2e73 7573 7069 6369 6f75  prefix.suspiciou
+0002b200: 7320 2b3d 2031 0a20 2020 2020 2020 2020  s += 1.         
+0002b210: 2020 2020 2020 2069 6620 7473 2e73 7573         if ts.sus
+0002b220: 7069 6369 6f75 7320 3e20 7365 6c66 2e61  picious > self.a
+0002b230: 6c6c 6f77 6564 5f66 6169 6c75 7265 733a  llowed_failures:
+0002b240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b250: 2020 2020 2064 656c 2072 6563 6f6d 6d65       del recomme
+0002b260: 6e64 6174 696f 6e73 5b6b 5d0a 2020 2020  ndations[k].    
+0002b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b280: 6520 3d20 7069 636b 6c65 2e64 756d 7073  e = pickle.dumps
+0002b290: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002b2a0: 2020 2020 2020 2020 2020 4b69 6c6c 6564            Killed
+0002b2b0: 576f 726b 6572 280a 2020 2020 2020 2020  Worker(.        
+0002b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b2d0: 2020 2020 7461 736b 3d6b 2c0a 2020 2020      task=k,.    
+0002b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b2f0: 2020 2020 2020 2020 6c61 7374 5f77 6f72          last_wor
+0002b300: 6b65 723d 7773 2e63 6c65 616e 2829 2c0a  ker=ws.clean(),.
 0002b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b320: 2020 2020 2020 2022 2077 6869 6c65 2074         " while t
-0002b330: 7279 696e 6720 746f 2072 756e 2069 7422  rying to run it"
-0002b340: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b350: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
-0002b360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b370: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-0002b380: 6c6c 6f77 6564 5f66 6169 6c75 7265 732c  llowed_failures,
-0002b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b3a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0002b3b0: 666f 7220 7473 2069 6e20 6c69 7374 2877  for ts in list(w
-0002b3c0: 732e 6861 735f 7768 6174 293a 0a20 2020  s.has_what):.   
-0002b3d0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0002b3e0: 6d6f 7665 5f72 6570 6c69 6361 2874 732c  move_replica(ts,
-0002b3f0: 2077 7329 0a20 2020 2020 2020 2020 2020   ws).           
-0002b400: 2069 6620 6e6f 7420 7473 2e77 686f 5f68   if not ts.who_h
-0002b410: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0002b420: 2020 2020 6966 2074 732e 7275 6e5f 7370      if ts.run_sp
-0002b430: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-0002b440: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0002b450: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
-0002b460: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
-0002b470: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002b480: 653a 2020 2320 7075 7265 2064 6174 610a  e:  # pure data.
-0002b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4a0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002b4b0: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2266  ons[ts.key] = "f
-0002b4c0: 6f72 676f 7474 656e 220a 0a20 2020 2020  orgotten"..     
-0002b4d0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-0002b4e0: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
-0002b4f0: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
-0002b500: 3d73 7469 6d75 6c75 735f 6964 290a 0a20  =stimulus_id).. 
-0002b510: 2020 2020 2020 2061 7761 6974 6162 6c65         awaitable
-0002b520: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
-0002b530: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
-0002b540: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
-0002b550: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
-0002b560: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002b570: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-0002b580: 7420 3d20 706c 7567 696e 2e72 656d 6f76  t = plugin.remov
-0002b590: 655f 776f 726b 6572 2873 6368 6564 756c  e_worker(schedul
-0002b5a0: 6572 3d73 656c 662c 2077 6f72 6b65 723d  er=self, worker=
-0002b5b0: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-0002b5c0: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
-0002b5d0: 6563 742e 6973 6177 6169 7461 626c 6528  ect.isawaitable(
-0002b5e0: 7265 7375 6c74 293a 0a20 2020 2020 2020  result):.       
-0002b5f0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-0002b600: 6974 6162 6c65 732e 6170 7065 6e64 2872  itables.append(r
-0002b610: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
-0002b620: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0002b630: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0002b640: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002b650: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-0002b660: 2020 2020 2020 2070 6c75 6769 6e5f 6d73         plugin_ms
-0002b670: 6773 203d 2061 7761 6974 2061 7379 6e63  gs = await async
-0002b680: 696f 2e67 6174 6865 7228 2a61 7761 6974  io.gather(*await
-0002b690: 6162 6c65 732c 2072 6574 7572 6e5f 6578  ables, return_ex
-0002b6a0: 6365 7074 696f 6e73 3d54 7275 6529 0a20  ceptions=True). 
-0002b6b0: 2020 2020 2020 2070 6c75 6769 6e73 5f65         plugins_e
-0002b6c0: 7863 6570 7469 6f6e 7320 3d20 5b6d 7367  xceptions = [msg
-0002b6d0: 2066 6f72 206d 7367 2069 6e20 706c 7567   for msg in plug
-0002b6e0: 696e 5f6d 7367 7320 6966 2069 7369 6e73  in_msgs if isins
-0002b6f0: 7461 6e63 6528 6d73 672c 2045 7863 6570  tance(msg, Excep
-0002b700: 7469 6f6e 295d 0a20 2020 2020 2020 2066  tion)].        f
-0002b710: 6f72 2065 7863 2069 6e20 706c 7567 696e  or exc in plugin
-0002b720: 735f 6578 6365 7074 696f 6e73 3a0a 2020  s_exceptions:.  
-0002b730: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002b740: 2e65 7863 6570 7469 6f6e 2865 7863 2c20  .exception(exc, 
-0002b750: 6578 635f 696e 666f 3d65 7863 290a 0a20  exc_info=exc).. 
-0002b760: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-0002b770: 6c66 2e77 6f72 6b65 7273 3a0a 2020 2020  lf.workers:.    
-0002b780: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0002b790: 6e66 6f28 224c 6f73 7420 616c 6c20 776f  nfo("Lost all wo
-0002b7a0: 726b 6572 7322 290a 0a20 2020 2020 2020  rkers")..       
-0002b7b0: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
-0002b7c0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-0002b7d0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-0002b7e0: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
-0002b7f0: 6164 6472 6573 732c 2077 292c 204e 6f6e  address, w), Non
-0002b800: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-0002b810: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
-0002b820: 726b 6572 732e 706f 7028 2877 2c20 6164  rkers.pop((w, ad
-0002b830: 6472 6573 7329 2c20 4e6f 6e65 290a 0a20  dress), None).. 
-0002b840: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-0002b850: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
-0002b860: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
-0002b870: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002b880: 2020 2320 4966 2074 6865 2077 6f72 6b65    # If the worke
-0002b890: 7220 6973 6e27 7420 7265 6769 7374 6572  r isn't register
-0002b8a0: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
-0002b8b0: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
-0002b8c0: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
-0002b8d0: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
-0002b8e0: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
-0002b8f0: 662e 776f 726b 6572 7320 616e 6420 6164  f.workers and ad
-0002b900: 6472 6573 7320 696e 2073 656c 662e 6576  dress in self.ev
-0002b910: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-0002b920: 2020 2020 2020 6465 6c20 7365 6c66 2e65        del self.e
-0002b930: 7665 6e74 735b 6164 6472 6573 735d 0a0a  vents[address]..
-0002b940: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
-0002b950: 6465 6c61 7920 3d20 7061 7273 655f 7469  delay = parse_ti
-0002b960: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
-0002b970: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
-0002b980: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0002b990: 642e 7363 6865 6475 6c65 722e 6576 656e  d.scheduler.even
-0002b9a0: 7473 2d63 6c65 616e 7570 2d64 656c 6179  ts-cleanup-delay
-0002b9b0: 2229 0a20 2020 2020 2020 2029 0a0a 2020  ").        )..  
-0002b9c0: 2020 2020 2020 7365 6c66 2e5f 6f6e 676f        self._ongo
-0002b9d0: 696e 675f 6261 636b 6772 6f75 6e64 5f74  ing_background_t
-0002b9e0: 6173 6b73 2e63 616c 6c5f 6c61 7465 7228  asks.call_later(
-0002b9f0: 0a20 2020 2020 2020 2020 2020 2063 6c65  .            cle
-0002ba00: 616e 7570 5f64 656c 6179 2c20 7265 6d6f  anup_delay, remo
-0002ba10: 7665 5f77 6f72 6b65 725f 6672 6f6d 5f65  ve_worker_from_e
-0002ba20: 7665 6e74 730a 2020 2020 2020 2020 290a  vents.        ).
-0002ba30: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-0002ba40: 6562 7567 2822 5265 6d6f 7665 6420 776f  ebug("Removed wo
-0002ba50: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
-0002ba60: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
-0002ba70: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
-0002ba80: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
-0002ba90: 6f72 6b65 725f 7365 6e64 280a 2020 2020  orker_send(.    
-0002baa0: 2020 2020 2020 2020 2020 2020 772c 0a20              w,. 
-0002bab0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0002bac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bad0: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
-0002bae0: 7665 2d77 6f72 6b65 7222 2c0a 2020 2020  ve-worker",.    
-0002baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb00: 2277 6f72 6b65 7222 3a20 6164 6472 6573  "worker": addres
-0002bb10: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002bb20: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-0002bb30: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-0002bb40: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0002bb50: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0002bb60: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-0002bb70: 7572 6e20 224f 4b22 0a0a 2020 2020 6465  urn "OK"..    de
-0002bb80: 6620 7374 696d 756c 7573 5f63 616e 6365  f stimulus_cance
-0002bb90: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
-0002bba0: 206b 6579 733a 2053 6571 7565 6e63 655b   keys: Sequence[
-0002bbb0: 7374 725d 2c20 636c 6965 6e74 3a20 7374  str], client: st
-0002bbc0: 722c 2066 6f72 6365 3a20 626f 6f6c 203d  r, force: bool =
-0002bbd0: 2046 616c 7365 0a20 2020 2029 202d 3e20   False.    ) -> 
-0002bbe0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0002bbf0: 2253 746f 7020 6578 6563 7574 696f 6e20  "Stop execution 
-0002bc00: 6f6e 2061 206c 6973 7420 6f66 206b 6579  on a list of key
-0002bc10: 7322 2222 0a20 2020 2020 2020 206c 6f67  s""".        log
-0002bc20: 6765 722e 696e 666f 2822 436c 6965 6e74  ger.info("Client
-0002bc30: 2025 7320 7265 7175 6573 7473 2074 6f20   %s requests to 
-0002bc40: 6361 6e63 656c 2025 6420 6b65 7973 222c  cancel %d keys",
-0002bc50: 2063 6c69 656e 742c 206c 656e 286b 6579   client, len(key
-0002bc60: 7329 290a 2020 2020 2020 2020 6966 2063  s)).        if c
-0002bc70: 6c69 656e 743a 0a20 2020 2020 2020 2020  lient:.         
-0002bc80: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-0002bc90: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002bca0: 2020 2063 6c69 656e 742c 207b 2261 6374     client, {"act
-0002bcb0: 696f 6e22 3a20 2263 616e 6365 6c22 2c20  ion": "cancel", 
-0002bcc0: 2263 6f75 6e74 223a 206c 656e 286b 6579  "count": len(key
-0002bcd0: 7329 2c20 2266 6f72 6365 223a 2066 6f72  s), "force": for
-0002bce0: 6365 7d0a 2020 2020 2020 2020 2020 2020  ce}.            
-0002bcf0: 290a 2020 2020 2020 2020 6361 6e63 656c  ).        cancel
-0002bd00: 6c65 645f 6b65 7973 203d 205b 5d0a 2020  led_keys = [].  
-0002bd10: 2020 2020 2020 636c 6965 6e74 7320 3d20        clients = 
-0002bd20: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
-0002bd30: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-0002bd40: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
-0002bd50: 5374 6174 6520 7c20 4e6f 6e65 203d 2073  State | None = s
-0002bd60: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-0002bd70: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-0002bd80: 6620 6e6f 7420 7473 3a0a 2020 2020 2020  f not ts:.      
-0002bd90: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0002bda0: 7565 0a20 2020 2020 2020 2020 2020 2074  ue.            t
-0002bdb0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002bdc0: 2020 2020 6373 3a20 436c 6965 6e74 5374      cs: ClientSt
-0002bdd0: 6174 6520 3d20 7365 6c66 2e63 6c69 656e  ate = self.clien
-0002bde0: 7473 5b63 6c69 656e 745d 0a20 2020 2020  ts[client].     
-0002bdf0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-0002be00: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-0002be10: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0002be20: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-0002be30: 6f72 6365 206f 7220 7473 2e77 686f 5f77  orce or ts.who_w
-0002be40: 616e 7473 203d 3d20 7b63 737d 3a20 2023  ants == {cs}:  #
-0002be50: 206e 6f20 6f6e 6520 656c 7365 2077 616e   no one else wan
-0002be60: 7473 2074 6869 7320 6b65 790a 2020 2020  ts this key.    
-0002be70: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0002be80: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
-0002be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bea0: 2020 7365 6c66 2e73 7469 6d75 6c75 735f    self.stimulus_
-0002beb0: 6361 6e63 656c 280a 2020 2020 2020 2020  cancel(.        
-0002bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bed0: 5b64 7473 2e6b 6579 2066 6f72 2064 7473  [dts.key for dts
-0002bee0: 2069 6e20 7473 2e64 6570 656e 6465 6e74   in ts.dependent
-0002bef0: 735d 2c20 636c 6965 6e74 2c20 666f 7263  s], client, forc
-0002bf00: 653d 666f 7263 650a 2020 2020 2020 2020  e=force.        
-0002bf10: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002bf20: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002bf30: 6767 6572 2e69 6e66 6f28 2253 6368 6564  gger.info("Sched
-0002bf40: 756c 6572 2063 616e 6365 6c73 206b 6579  uler cancels key
-0002bf50: 2025 732e 2020 466f 7263 653d 2573 222c   %s.  Force=%s",
-0002bf60: 206b 6579 2c20 666f 7263 6529 0a20 2020   key, force).   
-0002bf70: 2020 2020 2020 2020 2020 2020 2063 616e               can
-0002bf80: 6365 6c6c 6564 5f6b 6579 732e 6170 7065  celled_keys.appe
-0002bf90: 6e64 286b 6579 290a 2020 2020 2020 2020  nd(key).        
-0002bfa0: 2020 2020 636c 6965 6e74 732e 6578 7465      clients.exte
-0002bfb0: 6e64 286c 6973 7428 7473 2e77 686f 5f77  nd(list(ts.who_w
-0002bfc0: 616e 7473 2920 6966 2066 6f72 6365 2065  ants) if force e
-0002bfd0: 6c73 6520 5b63 735d 290a 2020 2020 2020  lse [cs]).      
-0002bfe0: 2020 666f 7220 6373 2069 6e20 636c 6965    for cs in clie
-0002bff0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0002c000: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
-0002c010: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
-0002c020: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-0002c030: 3d63 616e 6365 6c6c 6564 5f6b 6579 732c  =cancelled_keys,
-0002c040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c050: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
-0002c060: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
-0002c070: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002c080: 6964 3d66 2263 616e 6365 6c2d 6b65 792d  id=f"cancel-key-
-0002c090: 7b74 696d 6528 297d 222c 0a20 2020 2020  {time()}",.     
-0002c0a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002c0b0: 2073 656c 662e 7265 706f 7274 287b 226f   self.report({"o
-0002c0c0: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
-0002c0d0: 6579 7322 2c20 226b 6579 7322 3a20 6361  eys", "keys": ca
-0002c0e0: 6e63 656c 6c65 645f 6b65 7973 7d29 0a0a  ncelled_keys})..
-0002c0f0: 2020 2020 6465 6620 636c 6965 6e74 5f64      def client_d
-0002c100: 6573 6972 6573 5f6b 6579 7328 7365 6c66  esires_keys(self
-0002c110: 2c20 6b65 7973 3d4e 6f6e 652c 2063 6c69  , keys=None, cli
-0002c120: 656e 743d 4e6f 6e65 293a 0a20 2020 2020  ent=None):.     
-0002c130: 2020 2063 733a 2043 6c69 656e 7453 7461     cs: ClientSta
-0002c140: 7465 203d 2073 656c 662e 636c 6965 6e74  te = self.client
-0002c150: 732e 6765 7428 636c 6965 6e74 290a 2020  s.get(client).  
-0002c160: 2020 2020 2020 6966 2063 7320 6973 204e        if cs is N
-0002c170: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002c180: 2023 2046 6f72 2070 7562 6c69 7368 2c20   # For publish, 
-0002c190: 7175 6575 6573 2065 7463 2e0a 2020 2020  queues etc..    
-0002c1a0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0002c1b0: 656e 7473 5b63 6c69 656e 745d 203d 2063  ents[client] = c
-0002c1c0: 7320 3d20 436c 6965 6e74 5374 6174 6528  s = ClientState(
-0002c1d0: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002c1e0: 666f 7220 6b20 696e 206b 6579 733a 0a20  for k in keys:. 
-0002c1f0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-0002c200: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
-0002c210: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002c220: 2074 7320 6973 204e 6f6e 653a 0a20 2020   ts is None:.   
-0002c230: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-0002c240: 6f72 2070 7562 6c69 7368 2c20 7175 6575  or publish, queu
-0002c250: 6573 2065 7463 2e0a 2020 2020 2020 2020  es etc..        
-0002c260: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0002c270: 662e 6e65 775f 7461 736b 286b 2c20 4e6f  f.new_task(k, No
-0002c280: 6e65 2c20 2272 656c 6561 7365 6422 290a  ne, "released").
-0002c290: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
-0002c2a0: 686f 5f77 616e 7473 2e61 6464 2863 7329  ho_wants.add(cs)
-0002c2b0: 0a20 2020 2020 2020 2020 2020 2063 732e  .            cs.
-0002c2c0: 7761 6e74 735f 7768 6174 2e61 6464 2874  wants_what.add(t
-0002c2d0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0002c2e0: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
-0002c2f0: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
-0002c300: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0002c310: 2020 2020 7365 6c66 2e72 6570 6f72 745f      self.report_
-0002c320: 6f6e 5f6b 6579 2874 733d 7473 2c20 636c  on_key(ts=ts, cl
-0002c330: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
-0002c340: 2020 6465 6620 636c 6965 6e74 5f72 656c    def client_rel
-0002c350: 6561 7365 735f 6b65 7973 2873 656c 662c  eases_keys(self,
-0002c360: 206b 6579 733d 4e6f 6e65 2c20 636c 6965   keys=None, clie
-0002c370: 6e74 3d4e 6f6e 652c 2073 7469 6d75 6c75  nt=None, stimulu
-0002c380: 735f 6964 3d4e 6f6e 6529 3a0a 2020 2020  s_id=None):.    
-0002c390: 2020 2020 2222 2252 656d 6f76 6520 6b65      """Remove ke
-0002c3a0: 7973 2066 726f 6d20 636c 6965 6e74 2064  ys from client d
-0002c3b0: 6573 6972 6564 206c 6973 7422 2222 0a20  esired list""". 
-0002c3c0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002c3d0: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
-0002c3e0: 206f 7220 6622 636c 6965 6e74 2d72 656c   or f"client-rel
-0002c3f0: 6561 7365 732d 6b65 7973 2d7b 7469 6d65  eases-keys-{time
-0002c400: 2829 7d22 0a20 2020 2020 2020 2069 6620  ()}".        if 
-0002c410: 6e6f 7420 6973 696e 7374 616e 6365 286b  not isinstance(k
-0002c420: 6579 732c 206c 6973 7429 3a0a 2020 2020  eys, list):.    
-0002c430: 2020 2020 2020 2020 6b65 7973 203d 206c          keys = l
-0002c440: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
-0002c450: 2020 6373 203d 2073 656c 662e 636c 6965    cs = self.clie
-0002c460: 6e74 735b 636c 6965 6e74 5d0a 2020 2020  nts[client].    
-0002c470: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002c480: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
-0002c490: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-0002c4a0: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
-0002c4b0: 7973 286b 6579 733d 6b65 7973 2c20 6373  ys(keys=keys, cs
-0002c4c0: 3d63 732c 2072 6563 6f6d 6d65 6e64 6174  =cs, recommendat
-0002c4d0: 696f 6e73 3d72 6563 6f6d 6d65 6e64 6174  ions=recommendat
-0002c4e0: 696f 6e73 290a 2020 2020 2020 2020 7365  ions).        se
-0002c4f0: 6c66 2e74 7261 6e73 6974 696f 6e73 2872  lf.transitions(r
-0002c500: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-0002c510: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-0002c520: 2020 2020 2020 7365 6c66 2e73 7469 6d75        self.stimu
-0002c530: 6c75 735f 7175 6575 655f 736c 6f74 735f  lus_queue_slots_
-0002c540: 6d61 7962 655f 6f70 656e 6564 2873 7469  maybe_opened(sti
-0002c550: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-0002c560: 735f 6964 290a 0a20 2020 2064 6566 2063  s_id)..    def c
-0002c570: 6c69 656e 745f 6865 6172 7462 6561 7428  lient_heartbeat(
-0002c580: 7365 6c66 2c20 636c 6965 6e74 3d4e 6f6e  self, client=Non
-0002c590: 6529 3a0a 2020 2020 2020 2020 2222 2248  e):.        """H
-0002c5a0: 616e 646c 6520 6865 6172 7462 6561 7473  andle heartbeats
-0002c5b0: 2066 726f 6d20 436c 6965 6e74 2222 220a   from Client""".
-0002c5c0: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
-0002c5d0: 6e74 5374 6174 6520 3d20 7365 6c66 2e63  ntState = self.c
-0002c5e0: 6c69 656e 7473 5b63 6c69 656e 745d 0a20  lients[client]. 
-0002c5f0: 2020 2020 2020 2063 732e 6c61 7374 5f73         cs.last_s
-0002c600: 6565 6e20 3d20 7469 6d65 2829 0a0a 2020  een = time()..  
-0002c610: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0002c620: 2323 2323 230a 2020 2020 2320 5461 736b  #####.    # Task
-0002c630: 2056 616c 6964 6174 696f 6e20 230a 2020   Validation #.  
-0002c640: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0002c650: 2323 2323 230a 0a20 2020 2064 6566 2076  #####..    def v
-0002c660: 616c 6964 6174 655f 7265 6c65 6173 6564  alidate_released
-0002c670: 2873 656c 662c 206b 6579 3a20 7374 7229  (self, key: str)
-0002c680: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002c690: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002c6a0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-0002c6b0: 5d0a 2020 2020 2020 2020 6173 7365 7274  ].        assert
-0002c6c0: 2074 732e 7374 6174 6520 3d3d 2022 7265   ts.state == "re
-0002c6d0: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
-0002c6e0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0002c6f0: 6974 6572 730a 2020 2020 2020 2020 6173  iters.        as
-0002c700: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-0002c710: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0002c720: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-0002c730: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-0002c740: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-0002c750: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-0002c760: 2061 7373 6572 7420 6e6f 7420 616e 7928   assert not any(
-0002c770: 5b74 7320 696e 2064 7473 2e77 6169 7465  [ts in dts.waite
-0002c780: 7273 2066 6f72 2064 7473 2069 6e20 7473  rs for dts in ts
-0002c790: 2e64 6570 656e 6465 6e63 6965 735d 290a  .dependencies]).
-0002c7a0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002c7b0: 7320 6e6f 7420 696e 2073 656c 662e 756e  s not in self.un
-0002c7c0: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-0002c7d0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0002c7e0: 6e20 7365 6c66 2e71 7565 7565 640a 0a20  n self.queued.. 
-0002c7f0: 2020 2064 6566 2076 616c 6964 6174 655f     def validate_
-0002c800: 7761 6974 696e 6728 7365 6c66 2c20 6b65  waiting(self, ke
-0002c810: 793a 2073 7472 2920 2d3e 204e 6f6e 653a  y: str) -> None:
-0002c820: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0002c830: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
-0002c840: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0002c850: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
-0002c860: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
-0002c870: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-0002c880: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
-0002c890: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
-0002c8a0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0002c8b0: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
-0002c8c0: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
-0002c8d0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002c8e0: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
-0002c8f0: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
-0002c900: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0002c910: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-0002c920: 2020 2020 2020 2320 5765 2061 7265 2077        # We are w
-0002c930: 6169 7469 6e67 206f 6e20 6120 6465 7065  aiting on a depe
-0002c940: 6e64 656e 6379 2069 6666 2069 7427 7320  ndency iff it's 
-0002c950: 6e6f 7420 7374 6f72 6564 0a20 2020 2020  not stored.     
-0002c960: 2020 2020 2020 2061 7373 6572 7420 626f         assert bo
-0002c970: 6f6c 2864 7473 2e77 686f 5f68 6173 2920  ol(dts.who_has) 
-0002c980: 213d 2028 6474 7320 696e 2074 732e 7761  != (dts in ts.wa
-0002c990: 6974 696e 675f 6f6e 290a 2020 2020 2020  iting_on).      
-0002c9a0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002c9b0: 696e 2064 7473 2e77 6169 7465 7273 2020  in dts.waiters  
-0002c9c0: 2320 5858 5820 6576 656e 2069 6620 6474  # XXX even if dt
-0002c9d0: 732e 5f77 686f 5f68 6173 3f0a 0a20 2020  s._who_has?..   
-0002c9e0: 2064 6566 2076 616c 6964 6174 655f 7175   def validate_qu
-0002c9f0: 6575 6564 2873 656c 662c 206b 6579 3a20  eued(self, key: 
-0002ca00: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-0002ca10: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
-0002ca20: 6174 6520 3d20 7365 6c66 2e74 6173 6b73  ate = self.tasks
-0002ca30: 5b6b 6579 5d0a 2020 2020 2020 2020 6474  [key].        dt
-0002ca40: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
-0002ca50: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-0002ca60: 6e20 7365 6c66 2e71 7565 7565 640a 2020  n self.queued.  
-0002ca70: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002ca80: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
-0002ca90: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002caa0: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-0002cab0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002cac0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0002cad0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002cae0: 6e6f 7420 280a 2020 2020 2020 2020 2020  not (.          
-0002caf0: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
-0002cb00: 7269 6374 696f 6e73 206f 7220 7473 2e68  rictions or ts.h
-0002cb10: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-0002cb20: 206f 7220 7473 2e72 6573 6f75 7263 655f   or ts.resource_
-0002cb30: 7265 7374 7269 6374 696f 6e73 0a20 2020  restrictions.   
-0002cb40: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
-0002cb50: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0002cb60: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0002cb70: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-0002cb80: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0002cb90: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002cba0: 696e 2064 7473 2e77 6169 7465 7273 0a0a  in dts.waiters..
-0002cbb0: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
-0002cbc0: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
-0002cbd0: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
-0002cbe0: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
-0002cbf0: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
-0002cc00: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-0002cc10: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
-0002cc20: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
-0002cc30: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-0002cc40: 675f 6f6e 0a20 2020 2020 2020 2077 7320  g_on.        ws 
-0002cc50: 3d20 7473 2e70 726f 6365 7373 696e 675f  = ts.processing_
-0002cc60: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0002cc70: 7420 7773 0a20 2020 2020 2020 2061 7373  t ws.        ass
-0002cc80: 6572 7420 7473 2069 6e20 7773 2e70 726f  ert ts in ws.pro
-0002cc90: 6365 7373 696e 670a 2020 2020 2020 2020  cessing.        
-0002cca0: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-0002ccb0: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
-0002ccc0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0002ccd0: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-0002cce0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0002ccf0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-0002cd00: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002cd10: 7420 6474 732e 7768 6f5f 6861 730a 2020  t dts.who_has.  
-0002cd20: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002cd30: 2074 7320 696e 2064 7473 2e77 6169 7465   ts in dts.waite
-0002cd40: 7273 0a0a 2020 2020 6465 6620 7661 6c69  rs..    def vali
-0002cd50: 6461 7465 5f6d 656d 6f72 7928 7365 6c66  date_memory(self
-0002cd60: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
-0002cd70: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
-0002cd80: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
-0002cd90: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-0002cda0: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
-0002cdb0: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
-0002cdc0: 7274 2074 732e 7768 6f5f 6861 730a 2020  rt ts.who_has.  
-0002cdd0: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
-0002cde0: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
-0002cdf0: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
-0002ce00: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
-0002ce10: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
-0002ce20: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-0002ce30: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-0002ce40: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-0002ce50: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-0002ce60: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-0002ce70: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
-0002ce80: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
-0002ce90: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0002cea0: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-0002ceb0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0002cec0: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
-0002ced0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002cee0: 2864 7473 2069 6e20 7473 2e77 6169 7465  (dts in ts.waite
-0002cef0: 7273 2920 3d3d 2028 0a20 2020 2020 2020  rs) == (.       
-0002cf00: 2020 2020 2020 2020 2064 7473 2e73 7461           dts.sta
-0002cf10: 7465 2069 6e20 2822 7761 6974 696e 6722  te in ("waiting"
-0002cf20: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
-0002cf30: 6365 7373 696e 6722 2c20 226e 6f2d 776f  cessing", "no-wo
-0002cf40: 726b 6572 2229 0a20 2020 2020 2020 2020  rker").         
-0002cf50: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002cf60: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0002cf70: 6e20 6474 732e 7761 6974 696e 675f 6f6e  n dts.waiting_on
-0002cf80: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002cf90: 7465 5f6e 6f5f 776f 726b 6572 2873 656c  te_no_worker(sel
-0002cfa0: 662c 206b 6579 3a20 7374 7229 202d 3e20  f, key: str) -> 
-0002cfb0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-0002cfc0: 3a20 5461 736b 5374 6174 6520 3d20 7365  : TaskState = se
-0002cfd0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-0002cfe0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002cff0: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
-0002d000: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
-0002d010: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-0002d020: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-0002d030: 7274 2074 7320 696e 2073 656c 662e 756e  rt ts in self.un
-0002d040: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-0002d050: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-0002d060: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-0002d070: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002d080: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0002d090: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0002d0a0: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
-0002d0b0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0002d0c0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0002d0d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002d0e0: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
-0002d0f0: 6173 0a0a 2020 2020 6465 6620 7661 6c69  as..    def vali
-0002d100: 6461 7465 5f65 7272 6564 2873 656c 662c  date_erred(self,
-0002d110: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
-0002d120: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
-0002d130: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
-0002d140: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0002d150: 2020 2020 6173 7365 7274 2074 732e 6578      assert ts.ex
-0002d160: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
-0002d170: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002d180: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-0002d190: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-0002d1a0: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
-0002d1b0: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002d1c0: 7465 5f6b 6579 2873 656c 662c 206b 6579  te_key(self, key
-0002d1d0: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
-0002d1e0: 7461 7465 207c 204e 6f6e 6520 3d20 4e6f  tate | None = No
-0002d1f0: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
-0002d200: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002d210: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
-0002d220: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002d230: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-0002d240: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-0002d250: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-0002d260: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002d270: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002d280: 6465 6275 6728 224b 6579 206c 6f73 743a  debug("Key lost:
-0002d290: 2025 7322 2c20 6b65 7929 0a20 2020 2020   %s", key).     
-0002d2a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002d2b0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002d2c0: 7661 6c69 6461 7465 2829 0a20 2020 2020  validate().     
-0002d2d0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2f0: 2020 2020 6675 6e63 203d 2067 6574 6174      func = getat
-0002d300: 7472 2873 656c 662c 2022 7661 6c69 6461  tr(self, "valida
-0002d310: 7465 5f22 202b 2074 732e 7374 6174 652e  te_" + ts.state.
-0002d320: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
-0002d330: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0002d340: 2020 2065 7863 6570 7420 4174 7472 6962     except Attrib
-0002d350: 7574 6545 7272 6f72 3a0a 2020 2020 2020  uteError:.      
-0002d360: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002d370: 6767 6572 2e65 7272 6f72 280a 2020 2020  gger.error(.    
-0002d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d390: 2020 2020 2273 656c 662e 7661 6c69 6461      "self.valida
-0002d3a0: 7465 5f25 7320 6e6f 7420 666f 756e 6422  te_%s not found"
-0002d3b0: 2c20 7473 2e73 7461 7465 2e72 6570 6c61  , ts.state.repla
-0002d3c0: 6365 2822 2d22 2c20 225f 2229 0a20 2020  ce("-", "_").   
-0002d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d3e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0002d3f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002d400: 2020 2020 2020 2020 2020 2020 2066 756e               fun
-0002d410: 6328 6b65 7929 0a20 2020 2020 2020 2065  c(key).        e
-0002d420: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0002d430: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0002d440: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-0002d450: 6f6e 2865 290a 2020 2020 2020 2020 2020  on(e).          
-0002d460: 2020 6966 204c 4f47 5f50 4442 3a0a 2020    if LOG_PDB:.  
-0002d470: 2020 2020 2020 2020 2020 2020 2020 696d                im
-0002d480: 706f 7274 2070 6462 0a0a 2020 2020 2020  port pdb..      
-0002d490: 2020 2020 2020 2020 2020 7064 622e 7365            pdb.se
-0002d4a0: 745f 7472 6163 6528 290a 2020 2020 2020  t_trace().      
-0002d4b0: 2020 2020 2020 7261 6973 650a 0a20 2020        raise..   
-0002d4c0: 2064 6566 2076 616c 6964 6174 655f 7374   def validate_st
-0002d4d0: 6174 6528 7365 6c66 2c20 616c 6c6f 775f  ate(self, allow_
-0002d4e0: 6f76 6572 6c61 703a 2062 6f6f 6c20 3d20  overlap: bool = 
-0002d4f0: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
-0002d500: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
-0002d510: 5f73 7461 7465 2873 656c 662e 7461 736b  _state(self.task
-0002d520: 732c 2073 656c 662e 776f 726b 6572 732c  s, self.workers,
-0002d530: 2073 656c 662e 636c 6965 6e74 7329 0a0a   self.clients)..
-0002d540: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
-0002d550: 7365 7428 7365 6c66 2e77 6f72 6b65 7273  set(self.workers
-0002d560: 2920 3d3d 2073 6574 2873 656c 662e 7374  ) == set(self.st
-0002d570: 7265 616d 5f63 6f6d 6d73 2929 3a0a 2020  ream_comms)):.  
-0002d580: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002d590: 5661 6c75 6545 7272 6f72 2822 576f 726b  ValueError("Work
-0002d5a0: 6572 7320 6e6f 7420 7468 6520 7361 6d65  ers not the same
-0002d5b0: 2069 6e20 616c 6c20 636f 6c6c 6563 7469   in all collecti
-0002d5c0: 6f6e 7322 290a 0a20 2020 2020 2020 2061  ons")..        a
-0002d5d0: 7373 6572 7420 7365 6c66 2e72 756e 6e69  ssert self.runni
-0002d5e0: 6e67 2e69 7373 7570 6572 7365 7428 7365  ng.issuperset(se
-0002d5f0: 6c66 2e69 646c 652e 7661 6c75 6573 2829  lf.idle.values()
-0002d600: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-0002d610: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
-0002d620: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-0002d630: 2020 7365 7428 7365 6c66 2e69 646c 652e    set(self.idle.
-0002d640: 7661 6c75 6573 2829 292c 0a20 2020 2020  values()),.     
-0002d650: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-0002d660: 6572 7420 7365 6c66 2e72 756e 6e69 6e67  ert self.running
-0002d670: 2e69 7373 7570 6572 7365 7428 7365 6c66  .issuperset(self
-0002d680: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
-0002d690: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-0002d6a0: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
-0002d6b0: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-0002d6c0: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
-0002d6d0: 5f63 6f75 6e74 2e63 6f70 7928 292c 0a20  _count.copy(),. 
-0002d6e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002d6f0: 2061 7373 6572 7420 7365 6c66 2e72 756e   assert self.run
-0002d700: 6e69 6e67 2e69 7373 7570 6572 7365 7428  ning.issuperset(
-0002d710: 7365 6c66 2e73 6174 7572 6174 6564 292c  self.saturated),
-0002d720: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
-0002d730: 656c 662e 7275 6e6e 696e 672e 636f 7079  elf.running.copy
-0002d740: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0002d750: 7365 6c66 2e73 6174 7572 6174 6564 2e63  self.saturated.c
-0002d760: 6f70 7928 292c 0a20 2020 2020 2020 2029  opy(),.        )
-0002d770: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d780: 7365 6c66 2e73 6174 7572 6174 6564 2e69  self.saturated.i
-0002d790: 7364 6973 6a6f 696e 7428 7365 6c66 2e69  sdisjoint(self.i
-0002d7a0: 646c 652e 7661 6c75 6573 2829 292c 2028  dle.values()), (
-0002d7b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002d7c0: 662e 7361 7475 7261 7465 642e 636f 7079  f.saturated.copy
-0002d7d0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0002d7e0: 7365 7428 7365 6c66 2e69 646c 652e 7661  set(self.idle.va
-0002d7f0: 6c75 6573 2829 292c 0a20 2020 2020 2020  lues()),.       
-0002d800: 2029 0a0a 2020 2020 2020 2020 7461 736b   )..        task
-0002d810: 5f70 7265 6669 785f 636f 756e 7473 3a20  _prefix_counts: 
-0002d820: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
-0002d830: 2069 6e74 5d20 3d20 6465 6661 756c 7464   int] = defaultd
-0002d840: 6963 7428 696e 7429 0a20 2020 2020 2020  ict(int).       
-0002d850: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
-0002d860: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
-0002d870: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002d880: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0002d890: 6528 772c 2073 7472 292c 2028 7479 7065  e(w, str), (type
-0002d8a0: 2877 292c 2077 290a 2020 2020 2020 2020  (w), w).        
-0002d8b0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0002d8c0: 7461 6e63 6528 7773 2c20 576f 726b 6572  tance(ws, Worker
-0002d8d0: 5374 6174 6529 2c20 2874 7970 6528 7773  State), (type(ws
-0002d8e0: 292c 2077 7329 0a20 2020 2020 2020 2020  ), ws).         
-0002d8f0: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
-0002d900: 7265 7373 203d 3d20 770a 0a20 2020 2020  ress == w..     
-0002d910: 2020 2020 2020 2069 6620 7773 2e73 7461         if ws.sta
-0002d920: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0002d930: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-0002d940: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-0002d950: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
-0002d960: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002d970: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002d980: 2020 2061 7373 6572 7420 7773 206e 6f74     assert ws not
-0002d990: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
-0002d9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d9b0: 2061 7373 6572 7420 7773 2e61 6464 7265   assert ws.addre
-0002d9c0: 7373 206e 6f74 2069 6e20 7365 6c66 2e69  ss not in self.i
-0002d9d0: 646c 650a 2020 2020 2020 2020 2020 2020  dle.            
-0002d9e0: 2020 2020 6173 7365 7274 2077 7320 6e6f      assert ws no
-0002d9f0: 7420 696e 2073 656c 662e 7361 7475 7261  t in self.satura
-0002da00: 7465 640a 0a20 2020 2020 2020 2020 2020  ted..           
-0002da10: 2061 7373 6572 7420 7773 2e6c 6f6e 675f   assert ws.long_
-0002da20: 7275 6e6e 696e 672e 6973 7375 6273 6574  running.issubset
-0002da30: 2877 732e 7072 6f63 6573 7369 6e67 290a  (ws.processing).
-0002da40: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002da50: 6f74 2077 732e 7072 6f63 6573 7369 6e67  ot ws.processing
-0002da60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002da70: 2020 6173 7365 7274 206e 6f74 2077 732e    assert not ws.
-0002da80: 6f63 6375 7061 6e63 790a 2020 2020 2020  occupancy.      
-0002da90: 2020 2020 2020 2020 2020 6966 2077 732e            if ws.
-0002daa0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-0002dab0: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-0002dac0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0002dad0: 7365 7274 2077 732e 6164 6472 6573 7320  sert ws.address 
-0002dae0: 696e 2073 656c 662e 6964 6c65 0a20 2020  in self.idle.   
-0002daf0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002db00: 6e6f 7420 7773 2e6e 6565 6473 5f77 6861  not ws.needs_wha
-0002db10: 742e 6b65 7973 2829 2026 2077 732e 6861  t.keys() & ws.ha
-0002db20: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
-0002db30: 2020 2061 6374 7561 6c5f 6e65 6564 735f     actual_needs_
-0002db40: 7768 6174 3a20 6465 6661 756c 7464 6963  what: defaultdic
-0002db50: 745b 5461 736b 5374 6174 652c 2069 6e74  t[TaskState, int
-0002db60: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
-0002db70: 696e 7429 0a20 2020 2020 2020 2020 2020  int).           
-0002db80: 2066 6f72 2074 7320 696e 2077 732e 7072   for ts in ws.pr
-0002db90: 6f63 6573 7369 6e67 3a0a 2020 2020 2020  ocessing:.      
-0002dba0: 2020 2020 2020 2020 2020 666f 7220 7473            for ts
-0002dbb0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0002dbc0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0002dbd0: 2020 2020 2020 2020 2020 6966 2074 7373            if tss
-0002dbe0: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
-0002dbf0: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
-0002dc00: 2020 2020 2020 2020 2020 2020 2061 6374               act
-0002dc10: 7561 6c5f 6e65 6564 735f 7768 6174 5b74  ual_needs_what[t
-0002dc20: 7373 5d20 2b3d 2031 0a20 2020 2020 2020  ss] += 1.       
-0002dc30: 2020 2020 2061 7373 6572 7420 6163 7475       assert actu
-0002dc40: 616c 5f6e 6565 6473 5f77 6861 7420 3d3d  al_needs_what ==
-0002dc50: 2077 732e 6e65 6564 735f 7768 6174 0a20   ws.needs_what. 
-0002dc60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002dc70: 7420 2877 732e 7374 6174 7573 203d 3d20  t (ws.status == 
-0002dc80: 5374 6174 7573 2e72 756e 6e69 6e67 2920  Status.running) 
-0002dc90: 3d3d 2028 7773 2069 6e20 7365 6c66 2e72  == (ws in self.r
-0002dca0: 756e 6e69 6e67 290a 2020 2020 2020 2020  unning).        
-0002dcb0: 2020 2020 666f 7220 6e61 6d65 2c20 636f      for name, co
-0002dcc0: 756e 7420 696e 2077 732e 7461 736b 5f70  unt in ws.task_p
-0002dcd0: 7265 6669 785f 636f 756e 742e 6974 656d  refix_count.item
-0002dce0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0002dcf0: 2020 2020 2074 6173 6b5f 7072 6566 6978       task_prefix
-0002dd00: 5f63 6f75 6e74 735b 6e61 6d65 5d20 2b3d  _counts[name] +=
-0002dd10: 2063 6f75 6e74 0a0a 2020 2020 2020 2020   count..        
-0002dd20: 6173 7365 7274 2074 6173 6b5f 7072 6566  assert task_pref
-0002dd30: 6978 5f63 6f75 6e74 732e 6b65 7973 2829  ix_counts.keys()
-0002dd40: 203d 3d20 7365 6c66 2e5f 7461 736b 5f70   == self._task_p
-0002dd50: 7265 6669 785f 636f 756e 745f 676c 6f62  refix_count_glob
-0002dd60: 616c 2e6b 6579 7328 290a 2020 2020 2020  al.keys().      
-0002dd70: 2020 666f 7220 6e61 6d65 2c20 676c 6f62    for name, glob
-0002dd80: 616c 5f63 6f75 6e74 2069 6e20 7365 6c66  al_count in self
-0002dd90: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
-0002dda0: 756e 745f 676c 6f62 616c 2e69 7465 6d73  unt_global.items
-0002ddb0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002ddc0: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
-0002ddd0: 2020 2020 2020 2020 2074 6173 6b5f 7072           task_pr
-0002dde0: 6566 6978 5f63 6f75 6e74 735b 6e61 6d65  efix_counts[name
-0002ddf0: 5d20 3d3d 2067 6c6f 6261 6c5f 636f 756e  ] == global_coun
-0002de00: 740a 2020 2020 2020 2020 2020 2020 292c  t.            ),
-0002de10: 2066 227b 6e61 6d65 7d3a 207b 7461 736b   f"{name}: {task
-0002de20: 5f70 7265 6669 785f 636f 756e 7473 5b6e  _prefix_counts[n
-0002de30: 616d 655d 7d20 2877 7373 292c 207b 676c  ame]} (wss), {gl
-0002de40: 6f62 616c 5f63 6f75 6e74 7d20 2867 6c6f  obal_count} (glo
-0002de50: 6261 6c29 220a 0a20 2020 2020 2020 2066  bal)"..        f
-0002de60: 6f72 2077 7320 696e 2073 656c 662e 7275  or ws in self.ru
-0002de70: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-0002de80: 2020 2061 7373 6572 7420 7773 2e73 7461     assert ws.sta
-0002de90: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0002dea0: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0002deb0: 2020 6173 7365 7274 2077 732e 6164 6472    assert ws.addr
-0002dec0: 6573 7320 696e 2073 656c 662e 776f 726b  ess in self.work
-0002ded0: 6572 730a 0a20 2020 2020 2020 2066 6f72  ers..        for
-0002dee0: 206b 2c20 7473 2069 6e20 7365 6c66 2e74   k, ts in self.t
-0002def0: 6173 6b73 2e69 7465 6d73 2829 3a0a 2020  asks.items():.  
-0002df00: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002df10: 2069 7369 6e73 7461 6e63 6528 7473 2c20   isinstance(ts, 
-0002df20: 5461 736b 5374 6174 6529 2c20 2874 7970  TaskState), (typ
-0002df30: 6528 7473 292c 2074 7329 0a20 2020 2020  e(ts), ts).     
-0002df40: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0002df50: 2e6b 6579 203d 3d20 6b0a 2020 2020 2020  .key == k.      
-0002df60: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
-0002df70: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
-0002df80: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
-0002df90: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
-0002dfa0: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
-0002dfb0: 2020 2020 7365 6c66 2e76 616c 6964 6174      self.validat
-0002dfc0: 655f 6b65 7928 6b2c 2074 7329 0a0a 2020  e_key(k, ts)..  
-0002dfd0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0002dfe0: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
-0002dff0: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
-0002e000: 2020 2061 7373 6572 7420 7473 2e73 7461     assert ts.sta
-0002e010: 7465 203d 3d20 226d 656d 6f72 7922 0a20  te == "memory". 
-0002e020: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002e030: 7420 7473 2e6b 6579 2069 6e20 7365 6c66  t ts.key in self
-0002e040: 2e74 6173 6b73 0a0a 2020 2020 2020 2020  .tasks..        
-0002e050: 666f 7220 632c 2063 7320 696e 2073 656c  for c, cs in sel
-0002e060: 662e 636c 6965 6e74 732e 6974 656d 7328  f.clients.items(
-0002e070: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0002e080: 2063 6c69 656e 743d 4e6f 6e65 2069 7320   client=None is 
-0002e090: 6f66 7465 6e20 7573 6564 2069 6e20 7465  often used in te
-0002e0a0: 7374 732e 2e2e 0a20 2020 2020 2020 2020  sts....         
-0002e0b0: 2020 2061 7373 6572 7420 6320 6973 204e     assert c is N
-0002e0c0: 6f6e 6520 6f72 2074 7970 6528 6329 203d  one or type(c) =
-0002e0d0: 3d20 7374 722c 2028 7479 7065 2863 292c  = str, (type(c),
-0002e0e0: 2063 290a 2020 2020 2020 2020 2020 2020   c).            
-0002e0f0: 6173 7365 7274 2074 7970 6528 6373 2920  assert type(cs) 
-0002e100: 3d3d 2043 6c69 656e 7453 7461 7465 2c20  == ClientState, 
-0002e110: 2874 7970 6528 6373 292c 2063 7329 0a20  (type(cs), cs). 
-0002e120: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002e130: 7420 6373 2e63 6c69 656e 745f 6b65 7920  t cs.client_key 
-0002e140: 3d3d 2063 0a0a 2020 2020 2020 2020 6120  == c..        a 
-0002e150: 3d20 7b77 3a20 7773 2e6e 6279 7465 7320  = {w: ws.nbytes 
-0002e160: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
-0002e170: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
-0002e180: 297d 0a20 2020 2020 2020 2062 203d 207b  )}.        b = {
-0002e190: 0a20 2020 2020 2020 2020 2020 2077 3a20  .            w: 
-0002e1a0: 7375 6d28 7473 2e67 6574 5f6e 6279 7465  sum(ts.get_nbyte
-0002e1b0: 7328 2920 666f 7220 7473 2069 6e20 7773  s() for ts in ws
-0002e1c0: 2e68 6173 5f77 6861 7429 0a20 2020 2020  .has_what).     
-0002e1d0: 2020 2020 2020 2066 6f72 2077 2c20 7773         for w, ws
-0002e1e0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0002e1f0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-0002e200: 207d 0a20 2020 2020 2020 2061 7373 6572   }.        asser
-0002e210: 7420 6120 3d3d 2062 2c20 2861 2c20 6229  t a == b, (a, b)
-0002e220: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0002e230: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-0002e240: 6e74 6572 5f6d 6178 3a0a 2020 2020 2020  nter_max:.      
-0002e250: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0002e260: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-0002e270: 6e74 6572 203c 2073 656c 662e 7472 616e  nter < self.tran
-0002e280: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
-0002e290: 6178 0a0a 2020 2020 2323 2323 2323 2323  ax..    ########
-0002e2a0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0002e2b0: 2320 4d61 6e61 6765 204d 6573 7361 6765  # Manage Message
-0002e2c0: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
-0002e2d0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-0002e2e0: 2064 6566 2072 6570 6f72 7428 0a20 2020   def report(.   
-0002e2f0: 2020 2020 2073 656c 662c 206d 7367 3a20       self, msg: 
-0002e300: 6469 6374 2c20 7473 3a20 5461 736b 5374  dict, ts: TaskSt
-0002e310: 6174 6520 7c20 4e6f 6e65 203d 204e 6f6e  ate | None = Non
-0002e320: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
-0002e330: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
-0002e340: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-0002e350: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002e360: 5075 626c 6973 6820 7570 6461 7465 7320  Publish updates 
-0002e370: 746f 2061 6c6c 206c 6973 7465 6e69 6e67  to all listening
-0002e380: 2051 7565 7565 7320 616e 6420 436f 6d6d   Queues and Comm
-0002e390: 730a 0a20 2020 2020 2020 2049 6620 7468  s..        If th
-0002e3a0: 6520 6d65 7373 6167 6520 636f 6e74 6169  e message contai
-0002e3b0: 6e73 2061 206b 6579 2074 6865 6e20 7765  ns a key then we
-0002e3c0: 206f 6e6c 7920 7365 6e64 2074 6865 206d   only send the m
-0002e3d0: 6573 7361 6765 2074 6f20 7468 6f73 650a  essage to those.
-0002e3e0: 2020 2020 2020 2020 636f 6d6d 7320 7468          comms th
-0002e3f0: 6174 2063 6172 6520 6162 6f75 7420 7468  at care about th
-0002e400: 6520 6b65 792e 0a20 2020 2020 2020 2022  e key..        "
-0002e410: 2222 0a20 2020 2020 2020 2069 6620 7473  "".        if ts
-0002e420: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002e430: 2020 2020 2020 6d73 675f 6b65 7920 3d20        msg_key = 
-0002e440: 6d73 672e 6765 7428 226b 6579 2229 0a20  msg.get("key"). 
-0002e450: 2020 2020 2020 2020 2020 2069 6620 6d73             if ms
-0002e460: 675f 6b65 7920 6973 206e 6f74 204e 6f6e  g_key is not Non
-0002e470: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002e480: 2020 2074 6173 6b73 3a20 6469 6374 203d     tasks: dict =
-0002e490: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
-0002e4a0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-0002e4b0: 2074 6173 6b73 2e67 6574 286d 7367 5f6b   tasks.get(msg_k
-0002e4c0: 6579 290a 0a20 2020 2020 2020 2063 6c69  ey)..        cli
-0002e4d0: 656e 745f 636f 6d6d 733a 2064 6963 7420  ent_comms: dict 
-0002e4e0: 3d20 7365 6c66 2e63 6c69 656e 745f 636f  = self.client_co
-0002e4f0: 6d6d 730a 2020 2020 2020 2020 6966 2074  mms.        if t
-0002e500: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0002e510: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
-0002e520: 616c 6c20 636c 6965 6e74 730a 2020 2020  all clients.    
-0002e530: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
-0002e540: 6579 7320 3d20 6c69 7374 2863 6c69 656e  eys = list(clien
-0002e550: 745f 636f 6d6d 7329 0a20 2020 2020 2020  t_comms).       
-0002e560: 2065 6c69 6620 636c 6965 6e74 2069 7320   elif client is 
-0002e570: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002e580: 2020 2320 4e6f 7469 6679 2063 6c69 656e    # Notify clien
-0002e590: 7473 2069 6e74 6572 6573 7465 6420 696e  ts interested in
-0002e5a0: 206b 6579 0a20 2020 2020 2020 2020 2020   key.           
-0002e5b0: 2063 6c69 656e 745f 6b65 7973 203d 205b   client_keys = [
-0002e5c0: 6373 2e63 6c69 656e 745f 6b65 7920 666f  cs.client_key fo
-0002e5d0: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
-0002e5e0: 616e 7473 5d0a 2020 2020 2020 2020 656c  ants].        el
-0002e5f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002e600: 2320 4e6f 7469 6679 2063 6c69 656e 7473  # Notify clients
-0002e610: 2069 6e74 6572 6573 7465 6420 696e 206b   interested in k
-0002e620: 6579 2028 696e 636c 7564 696e 6720 6063  ey (including `c
-0002e630: 6c69 656e 7460 290a 2020 2020 2020 2020  lient`).        
-0002e640: 2020 2020 636c 6965 6e74 5f6b 6579 7320      client_keys 
-0002e650: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0002e660: 2020 2020 6373 2e63 6c69 656e 745f 6b65      cs.client_ke
-0002e670: 7920 666f 7220 6373 2069 6e20 7473 2e77  y for cs in ts.w
-0002e680: 686f 5f77 616e 7473 2069 6620 6373 2e63  ho_wants if cs.c
-0002e690: 6c69 656e 745f 6b65 7920 213d 2063 6c69  lient_key != cli
-0002e6a0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-0002e6b0: 5d0a 2020 2020 2020 2020 2020 2020 636c  ].            cl
-0002e6c0: 6965 6e74 5f6b 6579 732e 6170 7065 6e64  ient_keys.append
-0002e6d0: 2863 6c69 656e 7429 0a0a 2020 2020 2020  (client)..      
-0002e6e0: 2020 6b3a 2073 7472 0a20 2020 2020 2020    k: str.       
-0002e6f0: 2066 6f72 206b 2069 6e20 636c 6965 6e74   for k in client
-0002e700: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
-0002e710: 2020 2063 203d 2063 6c69 656e 745f 636f     c = client_co
-0002e720: 6d6d 732e 6765 7428 6b29 0a20 2020 2020  mms.get(k).     
-0002e730: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
-0002e740: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002e750: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0002e760: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0002e770: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002e780: 2e73 656e 6428 6d73 6729 0a20 2020 2020  .send(msg).     
-0002e790: 2020 2020 2020 2020 2020 2023 206c 6f67             # log
-0002e7a0: 6765 722e 6465 6275 6728 2253 6368 6564  ger.debug("Sched
-0002e7b0: 756c 6572 2073 656e 6473 206d 6573 7361  uler sends messa
-0002e7c0: 6765 2074 6f20 636c 6965 6e74 2025 7322  ge to client %s"
-0002e7d0: 2c20 6d73 6729 0a20 2020 2020 2020 2020  , msg).         
-0002e7e0: 2020 2065 7863 6570 7420 436f 6d6d 436c     except CommCl
-0002e7f0: 6f73 6564 4572 726f 723a 0a20 2020 2020  osedError:.     
-0002e800: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0002e810: 6c66 2e73 7461 7475 7320 3d3d 2053 7461  lf.status == Sta
-0002e820: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
-0002e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e840: 206c 6f67 6765 722e 6372 6974 6963 616c   logger.critical
-0002e850: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002e860: 2020 2020 2020 2020 2020 2243 6c6f 7365            "Close
-0002e870: 6420 636f 6d6d 2025 7220 7768 696c 6520  d comm %r while 
-0002e880: 7472 7969 6e67 2074 6f20 7772 6974 6520  trying to write 
-0002e890: 2573 222c 2063 2c20 6d73 672c 2065 7863  %s", c, msg, exc
-0002e8a0: 5f69 6e66 6f3d 5472 7565 0a20 2020 2020  _info=True.     
-0002e8b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002e8c0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-0002e8d0: 6164 645f 636c 6965 6e74 280a 2020 2020  add_client(.    
-0002e8e0: 2020 2020 7365 6c66 2c20 636f 6d6d 3a20      self, comm: 
-0002e8f0: 436f 6d6d 2c20 636c 6965 6e74 3a20 7374  Comm, client: st
-0002e900: 722c 2076 6572 7369 6f6e 733a 2064 6963  r, versions: dic
-0002e910: 745b 7374 722c 2041 6e79 5d0a 2020 2020  t[str, Any].    
-0002e920: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002e930: 2020 2022 2222 4164 6420 636c 6965 6e74     """Add client
-0002e940: 2074 6f20 6e65 7477 6f72 6b0a 0a20 2020   to network..   
-0002e950: 2020 2020 2057 6520 6c69 7374 656e 2074       We listen t
-0002e960: 6f20 616c 6c20 6675 7475 7265 206d 6573  o all future mes
-0002e970: 7361 6765 7320 6672 6f6d 2074 6869 7320  sages from this 
-0002e980: 436f 6d6d 2e0a 2020 2020 2020 2020 2222  Comm..        ""
-0002e990: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-0002e9a0: 2063 6c69 656e 7420 6973 206e 6f74 204e   client is not N
-0002e9b0: 6f6e 650a 2020 2020 2020 2020 636f 6d6d  one.        comm
-0002e9c0: 2e6e 616d 6520 3d20 2253 6368 6564 756c  .name = "Schedul
-0002e9d0: 6572 2d3e 436c 6965 6e74 220a 2020 2020  er->Client".    
-0002e9e0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0002e9f0: 2252 6563 6569 7665 2063 6c69 656e 7420  "Receive client 
-0002ea00: 636f 6e6e 6563 7469 6f6e 3a20 2573 222c  connection: %s",
-0002ea10: 2063 6c69 656e 7429 0a20 2020 2020 2020   client).       
-0002ea20: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-0002ea30: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
-0002ea40: 207b 2261 6374 696f 6e22 3a20 2261 6464   {"action": "add
-0002ea50: 2d63 6c69 656e 7422 2c20 2263 6c69 656e  -client", "clien
-0002ea60: 7422 3a20 636c 6965 6e74 7d29 0a20 2020  t": client}).   
-0002ea70: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0002ea80: 735b 636c 6965 6e74 5d20 3d20 436c 6965  s[client] = Clie
-0002ea90: 6e74 5374 6174 6528 636c 6965 6e74 2c20  ntState(client, 
-0002eaa0: 7665 7273 696f 6e73 3d76 6572 7369 6f6e  versions=version
-0002eab0: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
-0002eac0: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
-0002ead0: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-0002eae0: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
-0002eaf0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0002eb00: 2020 2020 2020 2020 706c 7567 696e 2e61          plugin.a
-0002eb10: 6464 5f63 6c69 656e 7428 7363 6865 6475  dd_client(schedu
-0002eb20: 6c65 723d 7365 6c66 2c20 636c 6965 6e74  ler=self, client
-0002eb30: 3d63 6c69 656e 7429 0a20 2020 2020 2020  =client).       
-0002eb40: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0002eb50: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-0002eb60: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002eb70: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
-0002eb80: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0002eb90: 2020 2020 2020 2020 2020 6263 6f6d 6d20            bcomm 
-0002eba0: 3d20 4261 7463 6865 6453 656e 6428 696e  = BatchedSend(in
-0002ebb0: 7465 7276 616c 3d22 326d 7322 2c20 6c6f  terval="2ms", lo
-0002ebc0: 6f70 3d73 656c 662e 6c6f 6f70 290a 2020  op=self.loop).  
-0002ebd0: 2020 2020 2020 2020 2020 6263 6f6d 6d2e            bcomm.
-0002ebe0: 7374 6172 7428 636f 6d6d 290a 2020 2020  start(comm).    
-0002ebf0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0002ec00: 656e 745f 636f 6d6d 735b 636c 6965 6e74  ent_comms[client
-0002ec10: 5d20 3d20 6263 6f6d 6d0a 2020 2020 2020  ] = bcomm.      
-0002ec20: 2020 2020 2020 6d73 6720 3d20 7b22 6f70        msg = {"op
-0002ec30: 223a 2022 7374 7265 616d 2d73 7461 7274  ": "stream-start
-0002ec40: 227d 0a20 2020 2020 2020 2020 2020 2076  "}.            v
-0002ec50: 6572 7369 6f6e 5f77 6172 6e69 6e67 203d  ersion_warning =
-0002ec60: 2076 6572 7369 6f6e 5f6d 6f64 756c 652e   version_module.
-0002ec70: 6572 726f 725f 6d65 7373 6167 6528 0a20  error_message(. 
-0002ec80: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0002ec90: 6572 7369 6f6e 5f6d 6f64 756c 652e 6765  ersion_module.ge
-0002eca0: 745f 7665 7273 696f 6e73 2829 2c0a 2020  t_versions(),.  
-0002ecb0: 2020 2020 2020 2020 2020 2020 2020 7b77                {w
-0002ecc0: 3a20 7773 2e76 6572 7369 6f6e 7320 666f  : ws.versions fo
-0002ecd0: 7220 772c 2077 7320 696e 2073 656c 662e  r w, ws in self.
-0002ece0: 776f 726b 6572 732e 6974 656d 7328 297d  workers.items()}
-0002ecf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ed00: 2020 7665 7273 696f 6e73 2c0a 2020 2020    versions,.    
-0002ed10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002ed20: 2020 2020 2020 6d73 672e 7570 6461 7465        msg.update
-0002ed30: 2876 6572 7369 6f6e 5f77 6172 6e69 6e67  (version_warning
-0002ed40: 290a 2020 2020 2020 2020 2020 2020 6263  ).            bc
-0002ed50: 6f6d 6d2e 7365 6e64 286d 7367 290a 0a20  omm.send(msg).. 
-0002ed60: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed80: 6177 6169 7420 7365 6c66 2e68 616e 646c  await self.handl
-0002ed90: 655f 7374 7265 616d 2863 6f6d 6d3d 636f  e_stream(comm=co
-0002eda0: 6d6d 2c20 6578 7472 613d 7b22 636c 6965  mm, extra={"clie
-0002edb0: 6e74 223a 2063 6c69 656e 747d 290a 2020  nt": client}).  
-0002edc0: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
-0002edd0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0002ede0: 2020 2073 656c 662e 7265 6d6f 7665 5f63     self.remove_c
-0002edf0: 6c69 656e 7428 636c 6965 6e74 3d63 6c69  lient(client=cli
-0002ee00: 656e 742c 2073 7469 6d75 6c75 735f 6964  ent, stimulus_id
-0002ee10: 3d66 2272 656d 6f76 652d 636c 6965 6e74  =f"remove-client
-0002ee20: 2d7b 7469 6d65 2829 7d22 290a 2020 2020  -{time()}").    
-0002ee30: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002ee40: 6572 2e64 6562 7567 2822 4669 6e69 7368  er.debug("Finish
-0002ee50: 6564 2068 616e 646c 696e 6720 636c 6965  ed handling clie
-0002ee60: 6e74 2025 7322 2c20 636c 6965 6e74 290a  nt %s", client).
-0002ee70: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-0002ee80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002ee90: 6e6f 7420 636f 6d6d 2e63 6c6f 7365 6428  not comm.closed(
-0002eea0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002eeb0: 2020 2073 656c 662e 636c 6965 6e74 5f63     self.client_c
-0002eec0: 6f6d 6d73 5b63 6c69 656e 745d 2e73 656e  omms[client].sen
-0002eed0: 6428 7b22 6f70 223a 2022 7374 7265 616d  d({"op": "stream
-0002eee0: 2d63 6c6f 7365 6422 7d29 0a20 2020 2020  -closed"}).     
-0002eef0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0002ef00: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002ef10: 6f74 2073 7973 2e69 735f 6669 6e61 6c69  ot sys.is_finali
-0002ef20: 7a69 6e67 2829 3a0a 2020 2020 2020 2020  zing():.        
-0002ef30: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0002ef40: 7420 7365 6c66 2e63 6c69 656e 745f 636f  t self.client_co
-0002ef50: 6d6d 735b 636c 6965 6e74 5d2e 636c 6f73  mms[client].clos
-0002ef60: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0002ef70: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-0002ef80: 2e63 6c69 656e 745f 636f 6d6d 735b 636c  .client_comms[cl
-0002ef90: 6965 6e74 5d0a 2020 2020 2020 2020 2020  ient].          
-0002efa0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0002efb0: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
-0002efc0: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-0002efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002efe0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0002eff0: 2243 6c6f 7365 2063 6c69 656e 7420 636f  "Close client co
-0002f000: 6e6e 6563 7469 6f6e 3a20 2573 222c 2063  nnection: %s", c
-0002f010: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
-0002f020: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
-0002f030: 726f 723a 2020 2320 636f 6d6d 2062 6563  ror:  # comm bec
-0002f040: 6f6d 6573 204e 6f6e 6520 6475 7269 6e67  omes None during
-0002f050: 2047 430a 2020 2020 2020 2020 2020 2020   GC.            
-0002f060: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
-0002f070: 6620 7265 6d6f 7665 5f63 6c69 656e 7428  f remove_client(
-0002f080: 7365 6c66 2c20 636c 6965 6e74 3a20 7374  self, client: st
-0002f090: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-0002f0a0: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0002f0b0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0002f0c0: 2020 2020 2222 2252 656d 6f76 6520 636c      """Remove cl
-0002f0d0: 6965 6e74 2066 726f 6d20 6e65 7477 6f72  ient from networ
-0002f0e0: 6b22 2222 0a20 2020 2020 2020 2073 7469  k""".        sti
-0002f0f0: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
-0002f100: 6c75 735f 6964 206f 7220 6622 7265 6d6f  lus_id or f"remo
-0002f110: 7665 2d63 6c69 656e 742d 7b74 696d 6528  ve-client-{time(
-0002f120: 297d 220a 2020 2020 2020 2020 6966 2073  )}".        if s
-0002f130: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
-0002f140: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
-0002f150: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002f160: 2e69 6e66 6f28 2252 656d 6f76 6520 636c  .info("Remove cl
-0002f170: 6965 6e74 2025 7322 2c20 636c 6965 6e74  ient %s", client
-0002f180: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-0002f190: 6f67 5f65 7665 6e74 285b 2261 6c6c 222c  og_event(["all",
-0002f1a0: 2063 6c69 656e 745d 2c20 7b22 6163 7469   client], {"acti
-0002f1b0: 6f6e 223a 2022 7265 6d6f 7665 2d63 6c69  on": "remove-cli
-0002f1c0: 656e 7422 2c20 2263 6c69 656e 7422 3a20  ent", "client": 
-0002f1d0: 636c 6965 6e74 7d29 0a20 2020 2020 2020  client}).       
-0002f1e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002f1f0: 2020 6373 3a20 436c 6965 6e74 5374 6174    cs: ClientStat
-0002f200: 6520 3d20 7365 6c66 2e63 6c69 656e 7473  e = self.clients
-0002f210: 5b63 6c69 656e 745d 0a20 2020 2020 2020  [client].       
-0002f220: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0002f230: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002f240: 5858 5820 6973 2074 6869 7320 6120 6c65  XXX is this a le
-0002f250: 6769 7469 6d61 7465 2063 6f6e 6469 7469  gitimate conditi
-0002f260: 6f6e 3f0a 2020 2020 2020 2020 2020 2020  on?.            
-0002f270: 7061 7373 0a20 2020 2020 2020 2065 6c73  pass.        els
-0002f280: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0002f290: 656c 662e 636c 6965 6e74 5f72 656c 6561  elf.client_relea
-0002f2a0: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
-0002f2b0: 2020 2020 2020 2020 2020 6b65 7973 3d5b            keys=[
-0002f2c0: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
-0002f2d0: 2063 732e 7761 6e74 735f 7768 6174 5d2c   cs.wants_what],
-0002f2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f2f0: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
-0002f300: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
+0002b320: 2020 2020 2020 2020 2020 2020 616c 6c6f              allo
+0002b330: 7765 645f 6661 696c 7572 6573 3d73 656c  wed_failures=sel
+0002b340: 662e 616c 6c6f 7765 645f 6661 696c 7572  f.allowed_failur
+0002b350: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0002b360: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+0002b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b380: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002b390: 2020 2020 2020 2020 2072 203d 2073 656c           r = sel
+0002b3a0: 662e 7472 616e 7369 7469 6f6e 280a 2020  f.transition(.  
+0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3c0: 2020 2020 2020 6b2c 0a20 2020 2020 2020        k,.       
+0002b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3e0: 2022 6572 7265 6422 2c0a 2020 2020 2020   "erred",.      
+0002b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b400: 2020 6578 6365 7074 696f 6e3d 652c 0a20    exception=e,. 
+0002b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b420: 2020 2020 2020 2063 6175 7365 3d6b 2c0a         cause=k,.
+0002b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b440: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0002b450: 5f69 643d 7374 696d 756c 7573 5f69 642c  _id=stimulus_id,
+0002b460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b470: 2020 2020 2020 2020 2077 6f72 6b65 723d           worker=
+0002b480: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+0002b490: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0002b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b4b0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002b4c0: 6e73 2e75 7064 6174 6528 7229 0a20 2020  ns.update(r).   
+0002b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b4e0: 206c 6f67 6765 722e 696e 666f 280a 2020   logger.info(.  
+0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b500: 2020 2020 2020 2254 6173 6b20 2573 206d        "Task %s m
+0002b510: 6172 6b65 6420 6173 2066 6169 6c65 6420  arked as failed 
+0002b520: 6265 6361 7573 6520 2564 2077 6f72 6b65  because %d worke
+0002b530: 7273 2064 6965 6422 0a20 2020 2020 2020  rs died".       
+0002b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b550: 2022 2077 6869 6c65 2074 7279 696e 6720   " while trying 
+0002b560: 746f 2072 756e 2069 7422 2c0a 2020 2020  to run it",.    
+0002b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b580: 2020 2020 7473 2e6b 6579 2c0a 2020 2020      ts.key,.    
+0002b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5a0: 2020 2020 7365 6c66 2e61 6c6c 6f77 6564      self.allowed
+0002b5b0: 5f66 6169 6c75 7265 732c 0a20 2020 2020  _failures,.     
+0002b5c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0002b5d0: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
+0002b5e0: 2069 6e20 6c69 7374 2877 732e 6861 735f   in list(ws.has_
+0002b5f0: 7768 6174 293a 0a20 2020 2020 2020 2020  what):.         
+0002b600: 2020 2073 656c 662e 7265 6d6f 7665 5f72     self.remove_r
+0002b610: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
+0002b620: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002b630: 7420 7473 2e77 686f 5f68 6173 3a0a 2020  t ts.who_has:.  
+0002b640: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002b650: 2074 732e 7275 6e5f 7370 6563 3a0a 2020   ts.run_spec:.  
+0002b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b670: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0002b680: 735b 7473 2e6b 6579 5d20 3d20 2272 656c  s[ts.key] = "rel
+0002b690: 6561 7365 6422 0a20 2020 2020 2020 2020  eased".         
+0002b6a0: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
+0002b6b0: 7075 7265 2064 6174 610a 2020 2020 2020  pure data.      
+0002b6c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002b6d0: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
+0002b6e0: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
+0002b6f0: 656e 220a 0a20 2020 2020 2020 2073 656c  en"..        sel
+0002b700: 662e 7472 616e 7369 7469 6f6e 7328 7265  f.transitions(re
+0002b710: 636f 6d6d 656e 6461 7469 6f6e 732c 2073  commendations, s
+0002b720: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+0002b730: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
+0002b740: 2061 7761 6974 6162 6c65 7320 3d20 5b5d   awaitables = []
+0002b750: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
+0002b760: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
+0002b770: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
+0002b780: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0002b790: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0002b7a0: 2020 2020 2072 6573 756c 7420 3d20 706c       result = pl
+0002b7b0: 7567 696e 2e72 656d 6f76 655f 776f 726b  ugin.remove_work
+0002b7c0: 6572 2873 6368 6564 756c 6572 3d73 656c  er(scheduler=sel
+0002b7d0: 662c 2077 6f72 6b65 723d 6164 6472 6573  f, worker=addres
+0002b7e0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0002b7f0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
+0002b800: 6177 6169 7461 626c 6528 7265 7375 6c74  awaitable(result
+0002b810: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002b820: 2020 2020 2020 2061 7761 6974 6162 6c65         awaitable
+0002b830: 732e 6170 7065 6e64 2872 6573 756c 7429  s.append(result)
+0002b840: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0002b850: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0002b860: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0002b870: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+0002b880: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
+0002b890: 2070 6c75 6769 6e5f 6d73 6773 203d 2061   plugin_msgs = a
+0002b8a0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+0002b8b0: 6865 7228 2a61 7761 6974 6162 6c65 732c  her(*awaitables,
+0002b8c0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+0002b8d0: 6e73 3d54 7275 6529 0a20 2020 2020 2020  ns=True).       
+0002b8e0: 2070 6c75 6769 6e73 5f65 7863 6570 7469   plugins_excepti
+0002b8f0: 6f6e 7320 3d20 5b6d 7367 2066 6f72 206d  ons = [msg for m
+0002b900: 7367 2069 6e20 706c 7567 696e 5f6d 7367  sg in plugin_msg
+0002b910: 7320 6966 2069 7369 6e73 7461 6e63 6528  s if isinstance(
+0002b920: 6d73 672c 2045 7863 6570 7469 6f6e 295d  msg, Exception)]
+0002b930: 0a20 2020 2020 2020 2066 6f72 2065 7863  .        for exc
+0002b940: 2069 6e20 706c 7567 696e 735f 6578 6365   in plugins_exce
+0002b950: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
+0002b960: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+0002b970: 7469 6f6e 2865 7863 2c20 6578 635f 696e  tion(exc, exc_in
+0002b980: 666f 3d65 7863 290a 0a20 2020 2020 2020  fo=exc)..       
+0002b990: 2069 6620 6e6f 7420 7365 6c66 2e77 6f72   if not self.wor
+0002b9a0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+0002b9b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 224c    logger.info("L
+0002b9c0: 6f73 7420 616c 6c20 776f 726b 6572 7322  ost all workers"
+0002b9d0: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
+0002b9e0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0002b9f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002ba00: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
+0002ba10: 6b65 7273 2e70 6f70 2828 6164 6472 6573  kers.pop((addres
+0002ba20: 732c 2077 292c 204e 6f6e 6529 0a20 2020  s, w), None).   
+0002ba30: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+0002ba40: 6e64 7769 6474 685f 776f 726b 6572 732e  ndwidth_workers.
+0002ba50: 706f 7028 2877 2c20 6164 6472 6573 7329  pop((w, address)
+0002ba60: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
+0002ba70: 2061 7379 6e63 2064 6566 2072 656d 6f76   async def remov
+0002ba80: 655f 776f 726b 6572 5f66 726f 6d5f 6576  e_worker_from_ev
+0002ba90: 656e 7473 2829 202d 3e20 4e6f 6e65 3a0a  ents() -> None:.
+0002baa0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002bab0: 2074 6865 2077 6f72 6b65 7220 6973 6e27   the worker isn'
+0002bac0: 7420 7265 6769 7374 6572 6564 2061 6e79  t registered any
+0002bad0: 6d6f 7265 2061 6674 6572 2074 6865 2064  more after the d
+0002bae0: 656c 6179 2c20 7265 6d6f 7665 2066 726f  elay, remove fro
+0002baf0: 6d20 6576 656e 7473 0a20 2020 2020 2020  m events.       
+0002bb00: 2020 2020 2069 6620 6164 6472 6573 7320       if address 
+0002bb10: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
+0002bb20: 6572 7320 616e 6420 6164 6472 6573 7320  ers and address 
+0002bb30: 696e 2073 656c 662e 6576 656e 7473 3a0a  in self.events:.
+0002bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb50: 6465 6c20 7365 6c66 2e65 7665 6e74 735b  del self.events[
+0002bb60: 6164 6472 6573 735d 0a0a 2020 2020 2020  address]..      
+0002bb70: 2020 636c 6561 6e75 705f 6465 6c61 7920    cleanup_delay 
+0002bb80: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+0002bb90: 6128 0a20 2020 2020 2020 2020 2020 2064  a(.            d
+0002bba0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+0002bbb0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+0002bbc0: 6475 6c65 722e 6576 656e 7473 2d63 6c65  duler.events-cle
+0002bbd0: 616e 7570 2d64 656c 6179 2229 0a20 2020  anup-delay").   
+0002bbe0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0002bbf0: 7365 6c66 2e5f 6f6e 676f 696e 675f 6261  self._ongoing_ba
+0002bc00: 636b 6772 6f75 6e64 5f74 6173 6b73 2e63  ckground_tasks.c
+0002bc10: 616c 6c5f 6c61 7465 7228 0a20 2020 2020  all_later(.     
+0002bc20: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
+0002bc30: 656c 6179 2c20 7265 6d6f 7665 5f77 6f72  elay, remove_wor
+0002bc40: 6b65 725f 6672 6f6d 5f65 7665 6e74 730a  ker_from_events.
+0002bc50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002bc60: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+0002bc70: 5265 6d6f 7665 6420 776f 726b 6572 2025  Removed worker %
+0002bc80: 7322 2c20 7773 290a 0a20 2020 2020 2020  s", ws)..       
+0002bc90: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
+0002bca0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+0002bcb0: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
+0002bcc0: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
+0002bcd0: 2020 2020 2020 772c 0a20 2020 2020 2020        w,.       
+0002bce0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0002bcf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002bd00: 6f70 223a 2022 7265 6d6f 7665 2d77 6f72  op": "remove-wor
+0002bd10: 6b65 7222 2c0a 2020 2020 2020 2020 2020  ker",.          
+0002bd20: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+0002bd30: 7222 3a20 6164 6472 6573 732c 0a20 2020  r": address,.   
+0002bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd50: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+0002bd60: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+0002bd70: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+0002bd80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0002bd90: 2020 2020 2020 2072 6574 7572 6e20 224f         return "O
+0002bda0: 4b22 0a0a 2020 2020 6465 6620 7374 696d  K"..    def stim
+0002bdb0: 756c 7573 5f63 616e 6365 6c28 0a20 2020  ulus_cancel(.   
+0002bdc0: 2020 2020 2073 656c 662c 206b 6579 733a       self, keys:
+0002bdd0: 2053 6571 7565 6e63 655b 7374 725d 2c20   Sequence[str], 
+0002bde0: 636c 6965 6e74 3a20 7374 722c 2066 6f72  client: str, for
+0002bdf0: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
+0002be00: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+0002be10: 2020 2020 2020 2020 2222 2253 746f 7020          """Stop 
+0002be20: 6578 6563 7574 696f 6e20 6f6e 2061 206c  execution on a l
+0002be30: 6973 7420 6f66 206b 6579 7322 2222 0a20  ist of keys""". 
+0002be40: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0002be50: 666f 2822 436c 6965 6e74 2025 7320 7265  fo("Client %s re
+0002be60: 7175 6573 7473 2074 6f20 6361 6e63 656c  quests to cancel
+0002be70: 2025 6420 6b65 7973 222c 2063 6c69 656e   %d keys", clien
+0002be80: 742c 206c 656e 286b 6579 7329 290a 2020  t, len(keys)).  
+0002be90: 2020 2020 2020 6966 2063 6c69 656e 743a        if client:
+0002bea0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002beb0: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
+0002bec0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+0002bed0: 656e 742c 207b 2261 6374 696f 6e22 3a20  ent, {"action": 
+0002bee0: 2263 616e 6365 6c22 2c20 2263 6f75 6e74  "cancel", "count
+0002bef0: 223a 206c 656e 286b 6579 7329 2c20 2266  ": len(keys), "f
+0002bf00: 6f72 6365 223a 2066 6f72 6365 7d0a 2020  orce": force}.  
+0002bf10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002bf20: 2020 2020 6361 6e63 656c 6c65 645f 6b65      cancelled_ke
+0002bf30: 7973 203d 205b 5d0a 2020 2020 2020 2020  ys = [].        
+0002bf40: 636c 6965 6e74 7320 3d20 5b5d 0a20 2020  clients = [].   
+0002bf50: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+0002bf60: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+0002bf70: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
+0002bf80: 7c20 4e6f 6e65 203d 2073 656c 662e 7461  | None = self.ta
+0002bf90: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0002bfa0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0002bfb0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0002bfc0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+0002bfd0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0002bfe0: 2020 2020 2020 2020 2020 2020 2020 6373                cs
+0002bff0: 3a20 436c 6965 6e74 5374 6174 6520 3d20  : ClientState = 
+0002c000: 7365 6c66 2e63 6c69 656e 7473 5b63 6c69  self.clients[cli
+0002c010: 656e 745d 0a20 2020 2020 2020 2020 2020  ent].           
+0002c020: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+0002c030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002c040: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+0002c050: 2020 2020 2020 6966 2066 6f72 6365 206f        if force o
+0002c060: 7220 7473 2e77 686f 5f77 616e 7473 203d  r ts.who_wants =
+0002c070: 3d20 7b63 737d 3a20 2023 206e 6f20 6f6e  = {cs}:  # no on
+0002c080: 6520 656c 7365 2077 616e 7473 2074 6869  e else wants thi
+0002c090: 7320 6b65 790a 2020 2020 2020 2020 2020  s key.          
+0002c0a0: 2020 2020 2020 6966 2074 732e 6465 7065        if ts.depe
+0002c0b0: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
+0002c0c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002c0d0: 2e73 7469 6d75 6c75 735f 6361 6e63 656c  .stimulus_cancel
+0002c0e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002c0f0: 2020 2020 2020 2020 2020 5b64 7473 2e6b            [dts.k
+0002c100: 6579 2066 6f72 2064 7473 2069 6e20 7473  ey for dts in ts
+0002c110: 2e64 6570 656e 6465 6e74 735d 2c20 636c  .dependents], cl
+0002c120: 6965 6e74 2c20 666f 7263 653d 666f 7263  ient, force=forc
+0002c130: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0002c140: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002c150: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0002c160: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
+0002c170: 616e 6365 6c73 206b 6579 2025 732e 2020  ancels key %s.  
+0002c180: 466f 7263 653d 2573 222c 206b 6579 2c20  Force=%s", key, 
+0002c190: 666f 7263 6529 0a20 2020 2020 2020 2020  force).         
+0002c1a0: 2020 2020 2020 2063 616e 6365 6c6c 6564         cancelled
+0002c1b0: 5f6b 6579 732e 6170 7065 6e64 286b 6579  _keys.append(key
+0002c1c0: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0002c1d0: 6965 6e74 732e 6578 7465 6e64 286c 6973  ients.extend(lis
+0002c1e0: 7428 7473 2e77 686f 5f77 616e 7473 2920  t(ts.who_wants) 
+0002c1f0: 6966 2066 6f72 6365 2065 6c73 6520 5b63  if force else [c
+0002c200: 735d 290a 2020 2020 2020 2020 666f 7220  s]).        for 
+0002c210: 6373 2069 6e20 636c 6965 6e74 733a 0a20  cs in clients:. 
+0002c220: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002c230: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
+0002c240: 6b65 7973 280a 2020 2020 2020 2020 2020  keys(.          
+0002c250: 2020 2020 2020 6b65 7973 3d63 616e 6365        keys=cance
+0002c260: 6c6c 6564 5f6b 6579 732c 0a20 2020 2020  lled_keys,.     
+0002c270: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0002c280: 743d 6373 2e63 6c69 656e 745f 6b65 792c  t=cs.client_key,
+0002c290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c2a0: 2073 7469 6d75 6c75 735f 6964 3d66 2263   stimulus_id=f"c
+0002c2b0: 616e 6365 6c2d 6b65 792d 7b74 696d 6528  ancel-key-{time(
+0002c2c0: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
+0002c2d0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0002c2e0: 7265 706f 7274 287b 226f 7022 3a20 2263  report({"op": "c
+0002c2f0: 616e 6365 6c6c 6564 2d6b 6579 7322 2c20  ancelled-keys", 
+0002c300: 226b 6579 7322 3a20 6361 6e63 656c 6c65  "keys": cancelle
+0002c310: 645f 6b65 7973 7d29 0a0a 2020 2020 6465  d_keys})..    de
+0002c320: 6620 636c 6965 6e74 5f64 6573 6972 6573  f client_desires
+0002c330: 5f6b 6579 7328 7365 6c66 2c20 6b65 7973  _keys(self, keys
+0002c340: 3d4e 6f6e 652c 2063 6c69 656e 743d 4e6f  =None, client=No
+0002c350: 6e65 293a 0a20 2020 2020 2020 2063 733a  ne):.        cs:
+0002c360: 2043 6c69 656e 7453 7461 7465 203d 2073   ClientState = s
+0002c370: 656c 662e 636c 6965 6e74 732e 6765 7428  elf.clients.get(
+0002c380: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+0002c390: 6966 2063 7320 6973 204e 6f6e 653a 0a20  if cs is None:. 
+0002c3a0: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
+0002c3b0: 2070 7562 6c69 7368 2c20 7175 6575 6573   publish, queues
+0002c3c0: 2065 7463 2e0a 2020 2020 2020 2020 2020   etc..          
+0002c3d0: 2020 7365 6c66 2e63 6c69 656e 7473 5b63    self.clients[c
+0002c3e0: 6c69 656e 745d 203d 2063 7320 3d20 436c  lient] = cs = Cl
+0002c3f0: 6965 6e74 5374 6174 6528 636c 6965 6e74  ientState(client
+0002c400: 290a 2020 2020 2020 2020 666f 7220 6b20  ).        for k 
+0002c410: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
+0002c420: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0002c430: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
+0002c440: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+0002c450: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0002c460: 2020 2020 2020 2023 2046 6f72 2070 7562         # For pub
+0002c470: 6c69 7368 2c20 7175 6575 6573 2065 7463  lish, queues etc
+0002c480: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002c490: 2020 7473 203d 2073 656c 662e 6e65 775f    ts = self.new_
+0002c4a0: 7461 736b 286b 2c20 4e6f 6e65 2c20 2272  task(k, None, "r
+0002c4b0: 656c 6561 7365 6422 290a 2020 2020 2020  eleased").      
+0002c4c0: 2020 2020 2020 7473 2e77 686f 5f77 616e        ts.who_wan
+0002c4d0: 7473 2e61 6464 2863 7329 0a20 2020 2020  ts.add(cs).     
+0002c4e0: 2020 2020 2020 2063 732e 7761 6e74 735f         cs.wants_
+0002c4f0: 7768 6174 2e61 6464 2874 7329 0a0a 2020  what.add(ts)..  
+0002c500: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+0002c510: 7374 6174 6520 696e 2028 226d 656d 6f72  state in ("memor
+0002c520: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
+0002c530: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0002c540: 6c66 2e72 6570 6f72 745f 6f6e 5f6b 6579  lf.report_on_key
+0002c550: 2874 733d 7473 2c20 636c 6965 6e74 3d63  (ts=ts, client=c
+0002c560: 6c69 656e 7429 0a0a 2020 2020 6465 6620  lient)..    def 
+0002c570: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
+0002c580: 6b65 7973 2873 656c 662c 206b 6579 733d  keys(self, keys=
+0002c590: 4e6f 6e65 2c20 636c 6965 6e74 3d4e 6f6e  None, client=Non
+0002c5a0: 652c 2073 7469 6d75 6c75 735f 6964 3d4e  e, stimulus_id=N
+0002c5b0: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
+0002c5c0: 2252 656d 6f76 6520 6b65 7973 2066 726f  "Remove keys fro
+0002c5d0: 6d20 636c 6965 6e74 2064 6573 6972 6564  m client desired
+0002c5e0: 206c 6973 7422 2222 0a20 2020 2020 2020   list""".       
+0002c5f0: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
+0002c600: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
+0002c610: 636c 6965 6e74 2d72 656c 6561 7365 732d  client-releases-
+0002c620: 6b65 7973 2d7b 7469 6d65 2829 7d22 0a20  keys-{time()}". 
+0002c630: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0002c640: 696e 7374 616e 6365 286b 6579 732c 206c  instance(keys, l
+0002c650: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
+0002c660: 2020 6b65 7973 203d 206c 6973 7428 6b65    keys = list(ke
+0002c670: 7973 290a 2020 2020 2020 2020 6373 203d  ys).        cs =
+0002c680: 2073 656c 662e 636c 6965 6e74 735b 636c   self.clients[cl
+0002c690: 6965 6e74 5d0a 2020 2020 2020 2020 7265  ient].        re
+0002c6a0: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+0002c6b0: 6563 7320 3d20 7b7d 0a0a 2020 2020 2020  ecs = {}..      
+0002c6c0: 2020 7365 6c66 2e5f 636c 6965 6e74 5f72    self._client_r
+0002c6d0: 656c 6561 7365 735f 6b65 7973 286b 6579  eleases_keys(key
+0002c6e0: 733d 6b65 7973 2c20 6373 3d63 732c 2072  s=keys, cs=cs, r
+0002c6f0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3d72  ecommendations=r
+0002c700: 6563 6f6d 6d65 6e64 6174 696f 6e73 290a  ecommendations).
+0002c710: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+0002c720: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
+0002c730: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
+0002c740: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
+0002c750: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
+0002c760: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
+0002c770: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
+0002c780: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
+0002c790: 0a20 2020 2064 6566 2063 6c69 656e 745f  .    def client_
+0002c7a0: 6865 6172 7462 6561 7428 7365 6c66 2c20  heartbeat(self, 
+0002c7b0: 636c 6965 6e74 3d4e 6f6e 6529 3a0a 2020  client=None):.  
+0002c7c0: 2020 2020 2020 2222 2248 616e 646c 6520        """Handle 
+0002c7d0: 6865 6172 7462 6561 7473 2066 726f 6d20  heartbeats from 
+0002c7e0: 436c 6965 6e74 2222 220a 2020 2020 2020  Client""".      
+0002c7f0: 2020 6373 3a20 436c 6965 6e74 5374 6174    cs: ClientStat
+0002c800: 6520 3d20 7365 6c66 2e63 6c69 656e 7473  e = self.clients
+0002c810: 5b63 6c69 656e 745d 0a20 2020 2020 2020  [client].       
+0002c820: 2063 732e 6c61 7374 5f73 6565 6e20 3d20   cs.last_seen = 
+0002c830: 7469 6d65 2829 0a0a 2020 2020 2323 2323  time()..    ####
+0002c840: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0002c850: 2020 2020 2320 5461 736b 2056 616c 6964      # Task Valid
+0002c860: 6174 696f 6e20 230a 2020 2020 2323 2323  ation #.    ####
+0002c870: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0002c880: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
+0002c890: 655f 7265 6c65 6173 6564 2873 656c 662c  e_released(self,
+0002c8a0: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
+0002c8b0: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
+0002c8c0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
+0002c8d0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+0002c8e0: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
+0002c8f0: 6174 6520 3d3d 2022 7265 6c65 6173 6564  ate == "released
+0002c900: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
+0002c910: 206e 6f74 2074 732e 7761 6974 6572 730a   not ts.waiters.
+0002c920: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002c930: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
+0002c940: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002c950: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+0002c960: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002c970: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+0002c980: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0002c990: 7420 6e6f 7420 616e 7928 5b74 7320 696e  t not any([ts in
+0002c9a0: 2064 7473 2e77 6169 7465 7273 2066 6f72   dts.waiters for
+0002c9b0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0002c9c0: 6465 6e63 6965 735d 290a 2020 2020 2020  dencies]).      
+0002c9d0: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0002c9e0: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
+0002c9f0: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
+0002ca00: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+0002ca10: 2e71 7565 7565 640a 0a20 2020 2064 6566  .queued..    def
+0002ca20: 2076 616c 6964 6174 655f 7761 6974 696e   validate_waitin
+0002ca30: 6728 7365 6c66 2c20 6b65 793a 2073 7472  g(self, key: str
+0002ca40: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002ca50: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
+0002ca60: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+0002ca70: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
+0002ca80: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+0002ca90: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002caa0: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
+0002cab0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002cac0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002cad0: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
+0002cae0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
+0002caf0: 756e 7275 6e6e 6162 6c65 0a20 2020 2020  unrunnable.     
+0002cb00: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+0002cb10: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
+0002cb20: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+0002cb30: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0002cb40: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0002cb50: 2320 5765 2061 7265 2077 6169 7469 6e67  # We are waiting
+0002cb60: 206f 6e20 6120 6465 7065 6e64 656e 6379   on a dependency
+0002cb70: 2069 6666 2069 7427 7320 6e6f 7420 7374   iff it's not st
+0002cb80: 6f72 6564 0a20 2020 2020 2020 2020 2020  ored.           
+0002cb90: 2061 7373 6572 7420 626f 6f6c 2864 7473   assert bool(dts
+0002cba0: 2e77 686f 5f68 6173 2920 213d 2028 6474  .who_has) != (dt
+0002cbb0: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
+0002cbc0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+0002cbd0: 6173 7365 7274 2074 7320 696e 2064 7473  assert ts in dts
+0002cbe0: 2e77 6169 7465 7273 2020 2320 5858 5820  .waiters  # XXX 
+0002cbf0: 6576 656e 2069 6620 6474 732e 5f77 686f  even if dts._who
+0002cc00: 5f68 6173 3f0a 0a20 2020 2064 6566 2076  _has?..    def v
+0002cc10: 616c 6964 6174 655f 7175 6575 6564 2873  alidate_queued(s
+0002cc20: 656c 662c 206b 6579 3a20 7374 7229 202d  elf, key: str) -
+0002cc30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0002cc40: 7473 3a20 5461 736b 5374 6174 6520 3d20  ts: TaskState = 
+0002cc50: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+0002cc60: 2020 2020 2020 2020 6474 733a 2054 6173          dts: Tas
+0002cc70: 6b53 7461 7465 0a20 2020 2020 2020 2061  kState.        a
+0002cc80: 7373 6572 7420 7473 2069 6e20 7365 6c66  ssert ts in self
+0002cc90: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
+0002cca0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+0002ccb0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+0002ccc0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+0002ccd0: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
+0002cce0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+0002ccf0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+0002cd00: 2020 2061 7373 6572 7420 6e6f 7420 280a     assert not (.
+0002cd10: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+0002cd20: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+0002cd30: 6e73 206f 7220 7473 2e68 6f73 745f 7265  ns or ts.host_re
+0002cd40: 7374 7269 6374 696f 6e73 206f 7220 7473  strictions or ts
+0002cd50: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
+0002cd60: 6374 696f 6e73 0a20 2020 2020 2020 2029  ctions.        )
+0002cd70: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+0002cd80: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+0002cd90: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+0002cda0: 2061 7373 6572 7420 6474 732e 7768 6f5f   assert dts.who_
+0002cdb0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+0002cdc0: 6173 7365 7274 2074 7320 696e 2064 7473  assert ts in dts
+0002cdd0: 2e77 6169 7465 7273 0a0a 2020 2020 6465  .waiters..    de
+0002cde0: 6620 7661 6c69 6461 7465 5f70 726f 6365  f validate_proce
+0002cdf0: 7373 696e 6728 7365 6c66 2c20 6b65 793a  ssing(self, key:
+0002ce00: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+0002ce10: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
+0002ce20: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
+0002ce30: 735b 6b65 795d 0a20 2020 2020 2020 2064  s[key].        d
+0002ce40: 7473 3a20 5461 736b 5374 6174 650a 2020  ts: TaskState.  
+0002ce50: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002ce60: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
+0002ce70: 2020 2020 2020 2077 7320 3d20 7473 2e70         ws = ts.p
+0002ce80: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+0002ce90: 2020 2020 2061 7373 6572 7420 7773 0a20       assert ws. 
+0002cea0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002ceb0: 2069 6e20 7773 2e70 726f 6365 7373 696e   in ws.processin
+0002cec0: 670a 2020 2020 2020 2020 6173 7365 7274  g.        assert
+0002ced0: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
+0002cee0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002cef0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+0002cf00: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
+0002cf10: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0002cf20: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+0002cf30: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
+0002cf40: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+0002cf50: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+0002cf60: 2064 7473 2e77 6169 7465 7273 0a0a 2020   dts.waiters..  
+0002cf70: 2020 6465 6620 7661 6c69 6461 7465 5f6d    def validate_m
+0002cf80: 656d 6f72 7928 7365 6c66 2c20 6b65 793a  emory(self, key:
+0002cf90: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+0002cfa0: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
+0002cfb0: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
+0002cfc0: 735b 6b65 795d 0a20 2020 2020 2020 2064  s[key].        d
+0002cfd0: 7473 3a20 5461 736b 5374 6174 650a 2020  ts: TaskState.  
+0002cfe0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+0002cff0: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+0002d000: 6173 7365 7274 2062 6f6f 6c28 7473 2069  assert bool(ts i
+0002d010: 6e20 7365 6c66 2e72 6570 6c69 6361 7465  n self.replicate
+0002d020: 645f 7461 736b 7329 203d 3d20 286c 656e  d_tasks) == (len
+0002d030: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
+0002d040: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0002d050: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
+0002d060: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+0002d070: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+0002d080: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+0002d090: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+0002d0a0: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
+0002d0b0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002d0c0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+0002d0d0: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
+0002d0e0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0002d0f0: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
+0002d100: 2020 2061 7373 6572 7420 2864 7473 2069     assert (dts i
+0002d110: 6e20 7473 2e77 6169 7465 7273 2920 3d3d  n ts.waiters) ==
+0002d120: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0002d130: 2020 2064 7473 2e73 7461 7465 2069 6e20     dts.state in 
+0002d140: 2822 7761 6974 696e 6722 2c20 2271 7565  ("waiting", "que
+0002d150: 7565 6422 2c20 2270 726f 6365 7373 696e  ued", "processin
+0002d160: 6722 2c20 226e 6f2d 776f 726b 6572 2229  g", "no-worker")
+0002d170: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0002d180: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002d190: 7420 7473 206e 6f74 2069 6e20 6474 732e  t ts not in dts.
+0002d1a0: 7761 6974 696e 675f 6f6e 0a0a 2020 2020  waiting_on..    
+0002d1b0: 6465 6620 7661 6c69 6461 7465 5f6e 6f5f  def validate_no_
+0002d1c0: 776f 726b 6572 2873 656c 662c 206b 6579  worker(self, key
+0002d1d0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+0002d1e0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+0002d1f0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
+0002d200: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+0002d210: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
+0002d220: 662e 756e 7275 6e6e 6162 6c65 0a20 2020  f.unrunnable.   
+0002d230: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002d240: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
+0002d250: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0002d260: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
+0002d270: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
+0002d280: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+0002d290: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+0002d2a0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+0002d2b0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
+0002d2c0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+0002d2d0: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
+0002d2e0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+0002d2f0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+0002d300: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002d310: 2064 7473 2e77 686f 5f68 6173 0a0a 2020   dts.who_has..  
+0002d320: 2020 6465 6620 7661 6c69 6461 7465 5f65    def validate_e
+0002d330: 7272 6564 2873 656c 662c 206b 6579 3a20  rred(self, key: 
+0002d340: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+0002d350: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
+0002d360: 6174 6520 3d20 7365 6c66 2e74 6173 6b73  ate = self.tasks
+0002d370: 5b6b 6579 5d0a 2020 2020 2020 2020 6173  [key].        as
+0002d380: 7365 7274 2074 732e 6578 6365 7074 696f  sert ts.exceptio
+0002d390: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
+0002d3a0: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+0002d3b0: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
+0002d3c0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+0002d3d0: 656c 662e 7175 6575 6564 0a0a 2020 2020  elf.queued..    
+0002d3e0: 6465 6620 7661 6c69 6461 7465 5f6b 6579  def validate_key
+0002d3f0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+0002d400: 2074 733a 2054 6173 6b53 7461 7465 207c   ts: TaskState |
+0002d410: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
+0002d420: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+0002d430: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0002d440: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
+0002d450: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002d460: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+0002d470: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+0002d480: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+0002d490: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002d4a0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0002d4b0: 224b 6579 206c 6f73 743a 2025 7322 2c20  "Key lost: %s", 
+0002d4c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0002d4d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002d4e0: 2020 2020 2020 2074 732e 7661 6c69 6461         ts.valida
+0002d4f0: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
+0002d500: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002d510: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+0002d520: 6e63 203d 2067 6574 6174 7472 2873 656c  nc = getattr(sel
+0002d530: 662c 2022 7661 6c69 6461 7465 5f22 202b  f, "validate_" +
+0002d540: 2074 732e 7374 6174 652e 7265 706c 6163   ts.state.replac
+0002d550: 6528 222d 222c 2022 5f22 2929 0a20 2020  e("-", "_")).   
+0002d560: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0002d570: 6570 7420 4174 7472 6962 7574 6545 7272  ept AttributeErr
+0002d580: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0002d590: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+0002d5a0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0002d5b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0002d5c0: 656c 662e 7661 6c69 6461 7465 5f25 7320  elf.validate_%s 
+0002d5d0: 6e6f 7420 666f 756e 6422 2c20 7473 2e73  not found", ts.s
+0002d5e0: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
+0002d5f0: 2c20 225f 2229 0a20 2020 2020 2020 2020  , "_").         
+0002d600: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002d610: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0002d620: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002d630: 2020 2020 2020 2066 756e 6328 6b65 7929         func(key)
+0002d640: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0002d650: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0002d660: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002d670: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
+0002d680: 2020 2020 2020 2020 2020 2020 6966 204c              if L
+0002d690: 4f47 5f50 4442 3a0a 2020 2020 2020 2020  OG_PDB:.        
+0002d6a0: 2020 2020 2020 2020 696d 706f 7274 2070          import p
+0002d6b0: 6462 0a0a 2020 2020 2020 2020 2020 2020  db..            
+0002d6c0: 2020 2020 7064 622e 7365 745f 7472 6163      pdb.set_trac
+0002d6d0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0002d6e0: 7261 6973 650a 0a20 2020 2064 6566 2076  raise..    def v
+0002d6f0: 616c 6964 6174 655f 7374 6174 6528 7365  alidate_state(se
+0002d700: 6c66 2c20 616c 6c6f 775f 6f76 6572 6c61  lf, allow_overla
+0002d710: 703a 2062 6f6f 6c20 3d20 4661 6c73 6529  p: bool = False)
+0002d720: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002d730: 2020 7661 6c69 6461 7465 5f73 7461 7465    validate_state
+0002d740: 2873 656c 662e 7461 736b 732c 2073 656c  (self.tasks, sel
+0002d750: 662e 776f 726b 6572 732c 2073 656c 662e  f.workers, self.
+0002d760: 636c 6965 6e74 7329 0a0a 2020 2020 2020  clients)..      
+0002d770: 2020 6966 206e 6f74 2028 7365 7428 7365    if not (set(se
+0002d780: 6c66 2e77 6f72 6b65 7273 2920 3d3d 2073  lf.workers) == s
+0002d790: 6574 2873 656c 662e 7374 7265 616d 5f63  et(self.stream_c
+0002d7a0: 6f6d 6d73 2929 3a0a 2020 2020 2020 2020  omms)):.        
+0002d7b0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0002d7c0: 7272 6f72 2822 576f 726b 6572 7320 6e6f  rror("Workers no
+0002d7d0: 7420 7468 6520 7361 6d65 2069 6e20 616c  t the same in al
+0002d7e0: 6c20 636f 6c6c 6563 7469 6f6e 7322 290a  l collections").
+0002d7f0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002d800: 7365 6c66 2e72 756e 6e69 6e67 2e69 7373  self.running.iss
+0002d810: 7570 6572 7365 7428 7365 6c66 2e69 646c  uperset(self.idl
+0002d820: 652e 7661 6c75 6573 2829 292c 2028 0a20  e.values()), (. 
+0002d830: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002d840: 7275 6e6e 696e 672e 636f 7079 2829 2c0a  running.copy(),.
+0002d850: 2020 2020 2020 2020 2020 2020 7365 7428              set(
+0002d860: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
+0002d870: 2829 292c 0a20 2020 2020 2020 2029 0a20  ()),.        ). 
+0002d880: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+0002d890: 6c66 2e72 756e 6e69 6e67 2e69 7373 7570  lf.running.issup
+0002d8a0: 6572 7365 7428 7365 6c66 2e69 646c 655f  erset(self.idle_
+0002d8b0: 7461 736b 5f63 6f75 6e74 292c 2028 0a20  task_count), (. 
+0002d8c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002d8d0: 7275 6e6e 696e 672e 636f 7079 2829 2c0a  running.copy(),.
+0002d8e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002d8f0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+0002d900: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
+0002d910: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+0002d920: 7420 7365 6c66 2e72 756e 6e69 6e67 2e69  t self.running.i
+0002d930: 7373 7570 6572 7365 7428 7365 6c66 2e73  ssuperset(self.s
+0002d940: 6174 7572 6174 6564 292c 2028 0a20 2020  aturated), (.   
+0002d950: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
+0002d960: 6e6e 696e 672e 636f 7079 2829 2c0a 2020  nning.copy(),.  
+0002d970: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0002d980: 6174 7572 6174 6564 2e63 6f70 7928 292c  aturated.copy(),
+0002d990: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0002d9a0: 2020 2061 7373 6572 7420 7365 6c66 2e73     assert self.s
+0002d9b0: 6174 7572 6174 6564 2e69 7364 6973 6a6f  aturated.isdisjo
+0002d9c0: 696e 7428 7365 6c66 2e69 646c 652e 7661  int(self.idle.va
+0002d9d0: 6c75 6573 2829 292c 2028 0a20 2020 2020  lues()), (.     
+0002d9e0: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
+0002d9f0: 7261 7465 642e 636f 7079 2829 2c0a 2020  rated.copy(),.  
+0002da00: 2020 2020 2020 2020 2020 7365 7428 7365            set(se
+0002da10: 6c66 2e69 646c 652e 7661 6c75 6573 2829  lf.idle.values()
+0002da20: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+0002da30: 2020 2020 2020 7461 736b 5f70 7265 6669        task_prefi
+0002da40: 785f 636f 756e 7473 3a20 6465 6661 756c  x_counts: defaul
+0002da50: 7464 6963 745b 7374 722c 2069 6e74 5d20  tdict[str, int] 
+0002da60: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
+0002da70: 7429 0a20 2020 2020 2020 2066 6f72 2077  t).        for w
+0002da80: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
+0002da90: 6b65 7273 2e69 7465 6d73 2829 3a0a 2020  kers.items():.  
+0002daa0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002dab0: 2069 7369 6e73 7461 6e63 6528 772c 2073   isinstance(w, s
+0002dac0: 7472 292c 2028 7479 7065 2877 292c 2077  tr), (type(w), w
+0002dad0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+0002dae0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0002daf0: 7773 2c20 576f 726b 6572 5374 6174 6529  ws, WorkerState)
+0002db00: 2c20 2874 7970 6528 7773 292c 2077 7329  , (type(ws), ws)
+0002db10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002db20: 6572 7420 7773 2e61 6464 7265 7373 203d  ert ws.address =
+0002db30: 3d20 770a 0a20 2020 2020 2020 2020 2020  = w..           
+0002db40: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
+0002db50: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+0002db60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002db70: 2061 7373 6572 7420 7773 2069 6e20 7365   assert ws in se
+0002db80: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+0002db90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002dba0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0002dbb0: 6572 7420 7773 206e 6f74 2069 6e20 7365  ert ws not in se
+0002dbc0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+0002dbd0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002dbe0: 7420 7773 2e61 6464 7265 7373 206e 6f74  t ws.address not
+0002dbf0: 2069 6e20 7365 6c66 2e69 646c 650a 2020   in self.idle.  
+0002dc00: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0002dc10: 7365 7274 2077 7320 6e6f 7420 696e 2073  sert ws not in s
+0002dc20: 656c 662e 7361 7475 7261 7465 640a 0a20  elf.saturated.. 
+0002dc30: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002dc40: 7420 7773 2e6c 6f6e 675f 7275 6e6e 696e  t ws.long_runnin
+0002dc50: 672e 6973 7375 6273 6574 2877 732e 7072  g.issubset(ws.pr
+0002dc60: 6f63 6573 7369 6e67 290a 2020 2020 2020  ocessing).      
+0002dc70: 2020 2020 2020 6966 206e 6f74 2077 732e        if not ws.
+0002dc80: 7072 6f63 6573 7369 6e67 3a0a 2020 2020  processing:.    
+0002dc90: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002dca0: 7274 206e 6f74 2077 732e 6f63 6375 7061  rt not ws.occupa
+0002dcb0: 6e63 790a 2020 2020 2020 2020 2020 2020  ncy.            
+0002dcc0: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
+0002dcd0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+0002dce0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0002dcf0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+0002dd00: 732e 6164 6472 6573 7320 696e 2073 656c  s.address in sel
+0002dd10: 662e 6964 6c65 0a20 2020 2020 2020 2020  f.idle.         
+0002dd20: 2020 2061 7373 6572 7420 6e6f 7420 7773     assert not ws
+0002dd30: 2e6e 6565 6473 5f77 6861 742e 6b65 7973  .needs_what.keys
+0002dd40: 2829 2026 2077 732e 6861 735f 7768 6174  () & ws.has_what
+0002dd50: 0a20 2020 2020 2020 2020 2020 2061 6374  .            act
+0002dd60: 7561 6c5f 6e65 6564 735f 7768 6174 3a20  ual_needs_what: 
+0002dd70: 6465 6661 756c 7464 6963 745b 5461 736b  defaultdict[Task
+0002dd80: 5374 6174 652c 2069 6e74 5d20 3d20 6465  State, int] = de
+0002dd90: 6661 756c 7464 6963 7428 696e 7429 0a20  faultdict(int). 
+0002dda0: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0002ddb0: 7320 696e 2077 732e 7072 6f63 6573 7369  s in ws.processi
+0002ddc0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0002ddd0: 2020 2020 666f 7220 7473 7320 696e 2074      for tss in t
+0002dde0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+0002ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de00: 2020 2020 6966 2074 7373 206e 6f74 2069      if tss not i
+0002de10: 6e20 7773 2e68 6173 5f77 6861 743a 0a20  n ws.has_what:. 
+0002de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de30: 2020 2020 2020 2061 6374 7561 6c5f 6e65         actual_ne
+0002de40: 6564 735f 7768 6174 5b74 7373 5d20 2b3d  eds_what[tss] +=
+0002de50: 2031 0a20 2020 2020 2020 2020 2020 2061   1.            a
+0002de60: 7373 6572 7420 6163 7475 616c 5f6e 6565  ssert actual_nee
+0002de70: 6473 5f77 6861 7420 3d3d 2077 732e 6e65  ds_what == ws.ne
+0002de80: 6564 735f 7768 6174 0a20 2020 2020 2020  eds_what.       
+0002de90: 2020 2020 2061 7373 6572 7420 2877 732e       assert (ws.
+0002dea0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+0002deb0: 2e72 756e 6e69 6e67 2920 3d3d 2028 7773  .running) == (ws
+0002dec0: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
+0002ded0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0002dee0: 7220 6e61 6d65 2c20 636f 756e 7420 696e  r name, count in
+0002def0: 2077 732e 7461 736b 5f70 7265 6669 785f   ws.task_prefix_
+0002df00: 636f 756e 742e 6974 656d 7328 293a 0a20  count.items():. 
+0002df10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002df20: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+0002df30: 735b 6e61 6d65 5d20 2b3d 2063 6f75 6e74  s[name] += count
+0002df40: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
+0002df50: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
+0002df60: 6e74 732e 6b65 7973 2829 203d 3d20 7365  nts.keys() == se
+0002df70: 6c66 2e5f 7461 736b 5f70 7265 6669 785f  lf._task_prefix_
+0002df80: 636f 756e 745f 676c 6f62 616c 2e6b 6579  count_global.key
+0002df90: 7328 290a 2020 2020 2020 2020 666f 7220  s().        for 
+0002dfa0: 6e61 6d65 2c20 676c 6f62 616c 5f63 6f75  name, global_cou
+0002dfb0: 6e74 2069 6e20 7365 6c66 2e5f 7461 736b  nt in self._task
+0002dfc0: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
+0002dfd0: 6f62 616c 2e69 7465 6d73 2829 3a0a 2020  obal.items():.  
+0002dfe0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002dff0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0002e000: 2020 2074 6173 6b5f 7072 6566 6978 5f63     task_prefix_c
+0002e010: 6f75 6e74 735b 6e61 6d65 5d20 3d3d 2067  ounts[name] == g
+0002e020: 6c6f 6261 6c5f 636f 756e 740a 2020 2020  lobal_count.    
+0002e030: 2020 2020 2020 2020 292c 2066 227b 6e61          ), f"{na
+0002e040: 6d65 7d3a 207b 7461 736b 5f70 7265 6669  me}: {task_prefi
+0002e050: 785f 636f 756e 7473 5b6e 616d 655d 7d20  x_counts[name]} 
+0002e060: 2877 7373 292c 207b 676c 6f62 616c 5f63  (wss), {global_c
+0002e070: 6f75 6e74 7d20 2867 6c6f 6261 6c29 220a  ount} (global)".
+0002e080: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
+0002e090: 696e 2073 656c 662e 7275 6e6e 696e 673a  in self.running:
+0002e0a0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002e0b0: 6572 7420 7773 2e73 7461 7475 7320 3d3d  ert ws.status ==
+0002e0c0: 2053 7461 7475 732e 7275 6e6e 696e 670a   Status.running.
+0002e0d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002e0e0: 7274 2077 732e 6164 6472 6573 7320 696e  rt ws.address in
+0002e0f0: 2073 656c 662e 776f 726b 6572 730a 0a20   self.workers.. 
+0002e100: 2020 2020 2020 2066 6f72 206b 2c20 7473         for k, ts
+0002e110: 2069 6e20 7365 6c66 2e74 6173 6b73 2e69   in self.tasks.i
+0002e120: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+0002e130: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0002e140: 7461 6e63 6528 7473 2c20 5461 736b 5374  tance(ts, TaskSt
+0002e150: 6174 6529 2c20 2874 7970 6528 7473 292c  ate), (type(ts),
+0002e160: 2074 7329 0a20 2020 2020 2020 2020 2020   ts).           
+0002e170: 2061 7373 6572 7420 7473 2e6b 6579 203d   assert ts.key =
+0002e180: 3d20 6b0a 2020 2020 2020 2020 2020 2020  = k.            
+0002e190: 6173 7365 7274 2062 6f6f 6c28 7473 2069  assert bool(ts i
+0002e1a0: 6e20 7365 6c66 2e72 6570 6c69 6361 7465  n self.replicate
+0002e1b0: 645f 7461 736b 7329 203d 3d20 286c 656e  d_tasks) == (len
+0002e1c0: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
+0002e1d0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0002e1e0: 6c66 2e76 616c 6964 6174 655f 6b65 7928  lf.validate_key(
+0002e1f0: 6b2c 2074 7329 0a0a 2020 2020 2020 2020  k, ts)..        
+0002e200: 666f 7220 7473 2069 6e20 7365 6c66 2e72  for ts in self.r
+0002e210: 6570 6c69 6361 7465 645f 7461 736b 733a  eplicated_tasks:
+0002e220: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002e230: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
+0002e240: 226d 656d 6f72 7922 0a20 2020 2020 2020  "memory".       
+0002e250: 2020 2020 2061 7373 6572 7420 7473 2e6b       assert ts.k
+0002e260: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+0002e270: 0a0a 2020 2020 2020 2020 666f 7220 632c  ..        for c,
+0002e280: 2063 7320 696e 2073 656c 662e 636c 6965   cs in self.clie
+0002e290: 6e74 732e 6974 656d 7328 293a 0a20 2020  nts.items():.   
+0002e2a0: 2020 2020 2020 2020 2023 2063 6c69 656e           # clien
+0002e2b0: 743d 4e6f 6e65 2069 7320 6f66 7465 6e20  t=None is often 
+0002e2c0: 7573 6564 2069 6e20 7465 7374 732e 2e2e  used in tests...
+0002e2d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002e2e0: 6572 7420 6320 6973 204e 6f6e 6520 6f72  ert c is None or
+0002e2f0: 2074 7970 6528 6329 203d 3d20 7374 722c   type(c) == str,
+0002e300: 2028 7479 7065 2863 292c 2063 290a 2020   (type(c), c).  
+0002e310: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002e320: 2074 7970 6528 6373 2920 3d3d 2043 6c69   type(cs) == Cli
+0002e330: 656e 7453 7461 7465 2c20 2874 7970 6528  entState, (type(
+0002e340: 6373 292c 2063 7329 0a20 2020 2020 2020  cs), cs).       
+0002e350: 2020 2020 2061 7373 6572 7420 6373 2e63       assert cs.c
+0002e360: 6c69 656e 745f 6b65 7920 3d3d 2063 0a0a  lient_key == c..
+0002e370: 2020 2020 2020 2020 6120 3d20 7b77 3a20          a = {w: 
+0002e380: 7773 2e6e 6279 7465 7320 666f 7220 772c  ws.nbytes for w,
+0002e390: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
+0002e3a0: 6572 732e 6974 656d 7328 297d 0a20 2020  ers.items()}.   
+0002e3b0: 2020 2020 2062 203d 207b 0a20 2020 2020       b = {.     
+0002e3c0: 2020 2020 2020 2077 3a20 7375 6d28 7473         w: sum(ts
+0002e3d0: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
+0002e3e0: 7220 7473 2069 6e20 7773 2e68 6173 5f77  r ts in ws.has_w
+0002e3f0: 6861 7429 0a20 2020 2020 2020 2020 2020  hat).           
+0002e400: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
+0002e410: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
+0002e420: 2829 0a20 2020 2020 2020 207d 0a20 2020  ().        }.   
+0002e430: 2020 2020 2061 7373 6572 7420 6120 3d3d       assert a ==
+0002e440: 2062 2c20 2861 2c20 6229 0a0a 2020 2020   b, (a, b)..    
+0002e450: 2020 2020 6966 2073 656c 662e 7472 616e      if self.tran
+0002e460: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
+0002e470: 6178 3a0a 2020 2020 2020 2020 2020 2020  ax:.            
+0002e480: 6173 7365 7274 2073 656c 662e 7472 616e  assert self.tran
+0002e490: 7369 7469 6f6e 5f63 6f75 6e74 6572 203c  sition_counter <
+0002e4a0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+0002e4b0: 5f63 6f75 6e74 6572 5f6d 6178 0a0a 2020  _counter_max..  
+0002e4c0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0002e4d0: 2323 2323 230a 2020 2020 2320 4d61 6e61  #####.    # Mana
+0002e4e0: 6765 204d 6573 7361 6765 7320 230a 2020  ge Messages #.  
+0002e4f0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0002e500: 2323 2323 230a 0a20 2020 2064 6566 2072  #####..    def r
+0002e510: 6570 6f72 7428 0a20 2020 2020 2020 2073  eport(.        s
+0002e520: 656c 662c 206d 7367 3a20 6469 6374 2c20  elf, msg: dict, 
+0002e530: 7473 3a20 5461 736b 5374 6174 6520 7c20  ts: TaskState | 
+0002e540: 4e6f 6e65 203d 204e 6f6e 652c 2063 6c69  None = None, cli
+0002e550: 656e 743a 2073 7472 207c 204e 6f6e 6520  ent: str | None 
+0002e560: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+0002e570: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0002e580: 220a 2020 2020 2020 2020 5075 626c 6973  ".        Publis
+0002e590: 6820 7570 6461 7465 7320 746f 2061 6c6c  h updates to all
+0002e5a0: 206c 6973 7465 6e69 6e67 2051 7565 7565   listening Queue
+0002e5b0: 7320 616e 6420 436f 6d6d 730a 0a20 2020  s and Comms..   
+0002e5c0: 2020 2020 2049 6620 7468 6520 6d65 7373       If the mess
+0002e5d0: 6167 6520 636f 6e74 6169 6e73 2061 206b  age contains a k
+0002e5e0: 6579 2074 6865 6e20 7765 206f 6e6c 7920  ey then we only 
+0002e5f0: 7365 6e64 2074 6865 206d 6573 7361 6765  send the message
+0002e600: 2074 6f20 7468 6f73 650a 2020 2020 2020   to those.      
+0002e610: 2020 636f 6d6d 7320 7468 6174 2063 6172    comms that car
+0002e620: 6520 6162 6f75 7420 7468 6520 6b65 792e  e about the key.
+0002e630: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0002e640: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+0002e650: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002e660: 6d73 675f 6b65 7920 3d20 6d73 672e 6765  msg_key = msg.ge
+0002e670: 7428 226b 6579 2229 0a20 2020 2020 2020  t("key").       
+0002e680: 2020 2020 2069 6620 6d73 675f 6b65 7920       if msg_key 
+0002e690: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0002e6a0: 2020 2020 2020 2020 2020 2020 2074 6173               tas
+0002e6b0: 6b73 3a20 6469 6374 203d 2073 656c 662e  ks: dict = self.
+0002e6c0: 7461 736b 730a 2020 2020 2020 2020 2020  tasks.          
+0002e6d0: 2020 2020 2020 7473 203d 2074 6173 6b73        ts = tasks
+0002e6e0: 2e67 6574 286d 7367 5f6b 6579 290a 0a20  .get(msg_key).. 
+0002e6f0: 2020 2020 2020 2063 6c69 656e 745f 636f         client_co
+0002e700: 6d6d 733a 2064 6963 7420 3d20 7365 6c66  mms: dict = self
+0002e710: 2e63 6c69 656e 745f 636f 6d6d 730a 2020  .client_comms.  
+0002e720: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0002e730: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002e740: 2023 204e 6f74 6966 7920 616c 6c20 636c   # Notify all cl
+0002e750: 6965 6e74 730a 2020 2020 2020 2020 2020  ients.          
+0002e760: 2020 636c 6965 6e74 5f6b 6579 7320 3d20    client_keys = 
+0002e770: 6c69 7374 2863 6c69 656e 745f 636f 6d6d  list(client_comm
+0002e780: 7329 0a20 2020 2020 2020 2065 6c69 6620  s).        elif 
+0002e790: 636c 6965 6e74 2069 7320 4e6f 6e65 3a0a  client is None:.
+0002e7a0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+0002e7b0: 7469 6679 2063 6c69 656e 7473 2069 6e74  tify clients int
+0002e7c0: 6572 6573 7465 6420 696e 206b 6579 0a20  erested in key. 
+0002e7d0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0002e7e0: 745f 6b65 7973 203d 205b 6373 2e63 6c69  t_keys = [cs.cli
+0002e7f0: 656e 745f 6b65 7920 666f 7220 6373 2069  ent_key for cs i
+0002e800: 6e20 7473 2e77 686f 5f77 616e 7473 5d0a  n ts.who_wants].
+0002e810: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002e820: 2020 2020 2020 2020 2020 2320 4e6f 7469            # Noti
+0002e830: 6679 2063 6c69 656e 7473 2069 6e74 6572  fy clients inter
+0002e840: 6573 7465 6420 696e 206b 6579 2028 696e  ested in key (in
+0002e850: 636c 7564 696e 6720 6063 6c69 656e 7460  cluding `client`
+0002e860: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0002e870: 6965 6e74 5f6b 6579 7320 3d20 5b0a 2020  ient_keys = [.  
+0002e880: 2020 2020 2020 2020 2020 2020 2020 6373                cs
+0002e890: 2e63 6c69 656e 745f 6b65 7920 666f 7220  .client_key for 
+0002e8a0: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
+0002e8b0: 7473 2069 6620 6373 2e63 6c69 656e 745f  ts if cs.client_
+0002e8c0: 6b65 7920 213d 2063 6c69 656e 740a 2020  key != client.  
+0002e8d0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0002e8e0: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
+0002e8f0: 6579 732e 6170 7065 6e64 2863 6c69 656e  eys.append(clien
+0002e900: 7429 0a0a 2020 2020 2020 2020 6b3a 2073  t)..        k: s
+0002e910: 7472 0a20 2020 2020 2020 2066 6f72 206b  tr.        for k
+0002e920: 2069 6e20 636c 6965 6e74 5f6b 6579 733a   in client_keys:
+0002e930: 0a20 2020 2020 2020 2020 2020 2063 203d  .            c =
+0002e940: 2063 6c69 656e 745f 636f 6d6d 732e 6765   client_comms.ge
+0002e950: 7428 6b29 0a20 2020 2020 2020 2020 2020  t(k).           
+0002e960: 2069 6620 6320 6973 204e 6f6e 653a 0a20   if c is None:. 
+0002e970: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002e980: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+0002e990: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0002e9a0: 2020 2020 2020 2020 2063 2e73 656e 6428           c.send(
+0002e9b0: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0002e9c0: 2020 2020 2023 206c 6f67 6765 722e 6465       # logger.de
+0002e9d0: 6275 6728 2253 6368 6564 756c 6572 2073  bug("Scheduler s
+0002e9e0: 656e 6473 206d 6573 7361 6765 2074 6f20  ends message to 
+0002e9f0: 636c 6965 6e74 2025 7322 2c20 6d73 6729  client %s", msg)
+0002ea00: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0002ea10: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
+0002ea20: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0002ea30: 2020 2020 2069 6620 7365 6c66 2e73 7461       if self.sta
+0002ea40: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
+0002ea50: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
+0002ea60: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0002ea70: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
+0002ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ea90: 2020 2020 2243 6c6f 7365 6420 636f 6d6d      "Closed comm
+0002eaa0: 2025 7220 7768 696c 6520 7472 7969 6e67   %r while trying
+0002eab0: 2074 6f20 7772 6974 6520 2573 222c 2063   to write %s", c
+0002eac0: 2c20 6d73 672c 2065 7863 5f69 6e66 6f3d  , msg, exc_info=
+0002ead0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0002eae0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0002eaf0: 6173 796e 6320 6465 6620 6164 645f 636c  async def add_cl
+0002eb00: 6965 6e74 280a 2020 2020 2020 2020 7365  ient(.        se
+0002eb10: 6c66 2c20 636f 6d6d 3a20 436f 6d6d 2c20  lf, comm: Comm, 
+0002eb20: 636c 6965 6e74 3a20 7374 722c 2076 6572  client: str, ver
+0002eb30: 7369 6f6e 733a 2064 6963 745b 7374 722c  sions: dict[str,
+0002eb40: 2041 6e79 5d0a 2020 2020 2920 2d3e 204e   Any].    ) -> N
+0002eb50: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0002eb60: 4164 6420 636c 6965 6e74 2074 6f20 6e65  Add client to ne
+0002eb70: 7477 6f72 6b0a 0a20 2020 2020 2020 2057  twork..        W
+0002eb80: 6520 6c69 7374 656e 2074 6f20 616c 6c20  e listen to all 
+0002eb90: 6675 7475 7265 206d 6573 7361 6765 7320  future messages 
+0002eba0: 6672 6f6d 2074 6869 7320 436f 6d6d 2e0a  from this Comm..
+0002ebb0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0002ebc0: 2020 2020 6173 7365 7274 2063 6c69 656e      assert clien
+0002ebd0: 7420 6973 206e 6f74 204e 6f6e 650a 2020  t is not None.  
+0002ebe0: 2020 2020 2020 636f 6d6d 2e6e 616d 6520        comm.name 
+0002ebf0: 3d20 2253 6368 6564 756c 6572 2d3e 436c  = "Scheduler->Cl
+0002ec00: 6965 6e74 220a 2020 2020 2020 2020 6c6f  ient".        lo
+0002ec10: 6767 6572 2e69 6e66 6f28 2252 6563 6569  gger.info("Recei
+0002ec20: 7665 2063 6c69 656e 7420 636f 6e6e 6563  ve client connec
+0002ec30: 7469 6f6e 3a20 2573 222c 2063 6c69 656e  tion: %s", clien
+0002ec40: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0002ec50: 6c6f 675f 6576 656e 7428 5b22 616c 6c22  log_event(["all"
+0002ec60: 2c20 636c 6965 6e74 5d2c 207b 2261 6374  , client], {"act
+0002ec70: 696f 6e22 3a20 2261 6464 2d63 6c69 656e  ion": "add-clien
+0002ec80: 7422 2c20 2263 6c69 656e 7422 3a20 636c  t", "client": cl
+0002ec90: 6965 6e74 7d29 0a20 2020 2020 2020 2073  ient}).        s
+0002eca0: 656c 662e 636c 6965 6e74 735b 636c 6965  elf.clients[clie
+0002ecb0: 6e74 5d20 3d20 436c 6965 6e74 5374 6174  nt] = ClientStat
+0002ecc0: 6528 636c 6965 6e74 2c20 7665 7273 696f  e(client, versio
+0002ecd0: 6e73 3d76 6572 7369 6f6e 7329 0a0a 2020  ns=versions)..  
+0002ece0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
+0002ecf0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
+0002ed00: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
+0002ed10: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0002ed20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ed30: 2020 706c 7567 696e 2e61 6464 5f63 6c69    plugin.add_cli
+0002ed40: 656e 7428 7363 6865 6475 6c65 723d 7365  ent(scheduler=se
+0002ed50: 6c66 2c20 636c 6965 6e74 3d63 6c69 656e  lf, client=clien
+0002ed60: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
+0002ed70: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+0002ed80: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0002ed90: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
+0002eda0: 6570 7469 6f6e 2865 290a 0a20 2020 2020  eption(e)..     
+0002edb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0002edc0: 2020 2020 6263 6f6d 6d20 3d20 4261 7463      bcomm = Batc
+0002edd0: 6865 6453 656e 6428 696e 7465 7276 616c  hedSend(interval
+0002ede0: 3d22 326d 7322 2c20 6c6f 6f70 3d73 656c  ="2ms", loop=sel
+0002edf0: 662e 6c6f 6f70 290a 2020 2020 2020 2020  f.loop).        
+0002ee00: 2020 2020 6263 6f6d 6d2e 7374 6172 7428      bcomm.start(
+0002ee10: 636f 6d6d 290a 2020 2020 2020 2020 2020  comm).          
+0002ee20: 2020 7365 6c66 2e63 6c69 656e 745f 636f    self.client_co
+0002ee30: 6d6d 735b 636c 6965 6e74 5d20 3d20 6263  mms[client] = bc
+0002ee40: 6f6d 6d0a 2020 2020 2020 2020 2020 2020  omm.            
+0002ee50: 6d73 6720 3d20 7b22 6f70 223a 2022 7374  msg = {"op": "st
+0002ee60: 7265 616d 2d73 7461 7274 227d 0a20 2020  ream-start"}.   
+0002ee70: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
+0002ee80: 5f77 6172 6e69 6e67 203d 2076 6572 7369  _warning = versi
+0002ee90: 6f6e 5f6d 6f64 756c 652e 6572 726f 725f  on_module.error_
+0002eea0: 6d65 7373 6167 6528 0a20 2020 2020 2020  message(.       
+0002eeb0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
+0002eec0: 5f6d 6f64 756c 652e 6765 745f 7665 7273  _module.get_vers
+0002eed0: 696f 6e73 2829 2c0a 2020 2020 2020 2020  ions(),.        
+0002eee0: 2020 2020 2020 2020 7b77 3a20 7773 2e76          {w: ws.v
+0002eef0: 6572 7369 6f6e 7320 666f 7220 772c 2077  ersions for w, w
+0002ef00: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+0002ef10: 732e 6974 656d 7328 297d 2c0a 2020 2020  s.items()},.    
+0002ef20: 2020 2020 2020 2020 2020 2020 7665 7273              vers
+0002ef30: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0002ef40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002ef50: 6d73 672e 7570 6461 7465 2876 6572 7369  msg.update(versi
+0002ef60: 6f6e 5f77 6172 6e69 6e67 290a 2020 2020  on_warning).    
+0002ef70: 2020 2020 2020 2020 6263 6f6d 6d2e 7365          bcomm.se
+0002ef80: 6e64 286d 7367 290a 0a20 2020 2020 2020  nd(msg)..       
+0002ef90: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002efa0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0002efb0: 7365 6c66 2e68 616e 646c 655f 7374 7265  self.handle_stre
+0002efc0: 616d 2863 6f6d 6d3d 636f 6d6d 2c20 6578  am(comm=comm, ex
+0002efd0: 7472 613d 7b22 636c 6965 6e74 223a 2063  tra={"client": c
+0002efe0: 6c69 656e 747d 290a 2020 2020 2020 2020  lient}).        
+0002eff0: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+0002f000: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0002f010: 662e 7265 6d6f 7665 5f63 6c69 656e 7428  f.remove_client(
+0002f020: 636c 6965 6e74 3d63 6c69 656e 742c 2073  client=client, s
+0002f030: 7469 6d75 6c75 735f 6964 3d66 2272 656d  timulus_id=f"rem
+0002f040: 6f76 652d 636c 6965 6e74 2d7b 7469 6d65  ove-client-{time
+0002f050: 2829 7d22 290a 2020 2020 2020 2020 2020  ()}").          
+0002f060: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+0002f070: 7567 2822 4669 6e69 7368 6564 2068 616e  ug("Finished han
+0002f080: 646c 696e 6720 636c 6965 6e74 2025 7322  dling client %s"
+0002f090: 2c20 636c 6965 6e74 290a 2020 2020 2020  , client).      
+0002f0a0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+0002f0b0: 2020 2020 2020 2069 6620 6e6f 7420 636f         if not co
+0002f0c0: 6d6d 2e63 6c6f 7365 6428 293a 0a20 2020  mm.closed():.   
+0002f0d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0002f0e0: 662e 636c 6965 6e74 5f63 6f6d 6d73 5b63  f.client_comms[c
+0002f0f0: 6c69 656e 745d 2e73 656e 6428 7b22 6f70  lient].send({"op
+0002f100: 223a 2022 7374 7265 616d 2d63 6c6f 7365  ": "stream-close
+0002f110: 6422 7d29 0a20 2020 2020 2020 2020 2020  d"}).           
+0002f120: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002f130: 2020 2020 2020 6966 206e 6f74 2073 7973        if not sys
+0002f140: 2e69 735f 6669 6e61 6c69 7a69 6e67 2829  .is_finalizing()
+0002f150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f160: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+0002f170: 2e63 6c69 656e 745f 636f 6d6d 735b 636c  .client_comms[cl
+0002f180: 6965 6e74 5d2e 636c 6f73 6528 290a 2020  ient].close().  
+0002f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1a0: 2020 6465 6c20 7365 6c66 2e63 6c69 656e    del self.clien
+0002f1b0: 745f 636f 6d6d 735b 636c 6965 6e74 5d0a  t_comms[client].
+0002f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1d0: 2020 2020 6966 2073 656c 662e 7374 6174      if self.stat
+0002f1e0: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+0002f1f0: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+0002f200: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0002f210: 6767 6572 2e69 6e66 6f28 2243 6c6f 7365  gger.info("Close
+0002f220: 2063 6c69 656e 7420 636f 6e6e 6563 7469   client connecti
+0002f230: 6f6e 3a20 2573 222c 2063 6c69 656e 7429  on: %s", client)
+0002f240: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0002f250: 6570 7420 5479 7065 4572 726f 723a 2020  ept TypeError:  
+0002f260: 2320 636f 6d6d 2062 6563 6f6d 6573 204e  # comm becomes N
+0002f270: 6f6e 6520 6475 7269 6e67 2047 430a 2020  one during GC.  
+0002f280: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0002f290: 7373 0a0a 2020 2020 6465 6620 7265 6d6f  ss..    def remo
+0002f2a0: 7665 5f63 6c69 656e 7428 7365 6c66 2c20  ve_client(self, 
+0002f2b0: 636c 6965 6e74 3a20 7374 722c 2073 7469  client: str, sti
+0002f2c0: 6d75 6c75 735f 6964 3a20 7374 7220 7c20  mulus_id: str | 
+0002f2d0: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
+0002f2e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0002f2f0: 2252 656d 6f76 6520 636c 6965 6e74 2066  "Remove client f
+0002f300: 726f 6d20 6e65 7477 6f72 6b22 2222 0a20  rom network""". 
 0002f310: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002f320: 6964 3d73 7469 6d75 6c75 735f 6964 2c0a  id=stimulus_id,.
-0002f330: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002f340: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-0002f350: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
-0002f360: 745d 0a0a 2020 2020 2020 2020 2020 2020  t]..            
-0002f370: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
-0002f380: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
-0002f390: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
-0002f3a0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002f3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3c0: 2020 2020 706c 7567 696e 2e72 656d 6f76      plugin.remov
-0002f3d0: 655f 636c 6965 6e74 2873 6368 6564 756c  e_client(schedul
-0002f3e0: 6572 3d73 656c 662c 2063 6c69 656e 743d  er=self, client=
-0002f3f0: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002f400: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0002f410: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-0002f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f430: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
-0002f440: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
-0002f450: 6173 796e 6320 6465 6620 7265 6d6f 7665  async def remove
-0002f460: 5f63 6c69 656e 745f 6672 6f6d 5f65 7665  _client_from_eve
-0002f470: 6e74 7328 293a 0a20 2020 2020 2020 2020  nts():.         
-0002f480: 2020 2023 2049 6620 7468 6520 636c 6965     # If the clie
-0002f490: 6e74 2069 736e 2774 2072 6567 6973 7465  nt isn't registe
-0002f4a0: 7265 6420 616e 796d 6f72 6520 6166 7465  red anymore afte
-0002f4b0: 7220 7468 6520 6465 6c61 792c 2072 656d  r the delay, rem
-0002f4c0: 6f76 6520 6672 6f6d 2065 7665 6e74 730a  ove from events.
-0002f4d0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0002f4e0: 6c69 656e 7420 6e6f 7420 696e 2073 656c  lient not in sel
-0002f4f0: 662e 636c 6965 6e74 7320 616e 6420 636c  f.clients and cl
-0002f500: 6965 6e74 2069 6e20 7365 6c66 2e65 7665  ient in self.eve
-0002f510: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0002f520: 2020 2020 2064 656c 2073 656c 662e 6576       del self.ev
-0002f530: 656e 7473 5b63 6c69 656e 745d 0a0a 2020  ents[client]..  
-0002f540: 2020 2020 2020 636c 6561 6e75 705f 6465        cleanup_de
-0002f550: 6c61 7920 3d20 7061 7273 655f 7469 6d65  lay = parse_time
-0002f560: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
-0002f570: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
-0002f580: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0002f590: 7363 6865 6475 6c65 722e 6576 656e 7473  scheduler.events
-0002f5a0: 2d63 6c65 616e 7570 2d64 656c 6179 2229  -cleanup-delay")
-0002f5b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0002f5c0: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
-0002f5d0: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
-0002f5e0: 6e64 5f74 6173 6b73 2e63 6c6f 7365 643a  nd_tasks.closed:
-0002f5f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002f600: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
-0002f610: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
-0002f620: 5f6c 6174 6572 280a 2020 2020 2020 2020  _later(.        
-0002f630: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
-0002f640: 6465 6c61 792c 2072 656d 6f76 655f 636c  delay, remove_cl
-0002f650: 6965 6e74 5f66 726f 6d5f 6576 656e 7473  ient_from_events
-0002f660: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0002f670: 2020 2020 6465 6620 7365 6e64 5f74 6173      def send_tas
-0002f680: 6b5f 746f 5f77 6f72 6b65 7228 0a20 2020  k_to_worker(.   
-0002f690: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-0002f6a0: 723a 2073 7472 2c20 7473 3a20 5461 736b  r: str, ts: Task
-0002f6b0: 5374 6174 652c 2064 7572 6174 696f 6e3a  State, duration:
-0002f6c0: 2066 6c6f 6174 203d 202d 310a 2020 2020   float = -1.    
-0002f6d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002f6e0: 2020 2022 2222 5365 6e64 2061 2073 696e     """Send a sin
-0002f6f0: 676c 6520 636f 6d70 7574 6174 696f 6e61  gle computationa
-0002f700: 6c20 7461 736b 2074 6f20 6120 776f 726b  l task to a work
-0002f710: 6572 2222 220a 2020 2020 2020 2020 7472  er""".        tr
-0002f720: 793a 0a20 2020 2020 2020 2020 2020 206d  y:.            m
-0002f730: 7367 3a20 6469 6374 203d 2073 656c 662e  sg: dict = self.
-0002f740: 5f74 6173 6b5f 746f 5f6d 7367 2874 732c  _task_to_msg(ts,
-0002f750: 2064 7572 6174 696f 6e29 0a20 2020 2020   duration).     
-0002f760: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-0002f770: 6572 5f73 656e 6428 776f 726b 6572 2c20  er_send(worker, 
-0002f780: 6d73 6729 0a20 2020 2020 2020 2065 7863  msg).        exc
-0002f790: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0002f7a0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0002f7b0: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
-0002f7c0: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
-0002f7d0: 6966 204c 4f47 5f50 4442 3a0a 2020 2020  if LOG_PDB:.    
-0002f7e0: 2020 2020 2020 2020 2020 2020 696d 706f              impo
-0002f7f0: 7274 2070 6462 0a0a 2020 2020 2020 2020  rt pdb..        
-0002f800: 2020 2020 2020 2020 7064 622e 7365 745f          pdb.set_
-0002f810: 7472 6163 6528 290a 2020 2020 2020 2020  trace().        
-0002f820: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
-0002f830: 6566 2068 616e 646c 655f 756e 6361 7567  ef handle_uncaug
-0002f840: 6874 5f65 7272 6f72 2873 656c 662c 202a  ht_error(self, *
-0002f850: 2a6d 7367 3a20 416e 7929 202d 3e20 4e6f  *msg: Any) -> No
-0002f860: 6e65 3a0a 2020 2020 2020 2020 6c6f 6767  ne:.        logg
-0002f870: 6572 2e65 7863 6570 7469 6f6e 2863 6c65  er.exception(cle
-0002f880: 616e 5f65 7863 6570 7469 6f6e 282a 2a6d  an_exception(**m
-0002f890: 7367 295b 315d 290a 0a20 2020 2064 6566  sg)[1])..    def
-0002f8a0: 2068 616e 646c 655f 7461 736b 5f66 696e   handle_task_fin
-0002f8b0: 6973 6865 6428 0a20 2020 2020 2020 2073  ished(.        s
-0002f8c0: 656c 662c 206b 6579 3a20 7374 722c 2077  elf, key: str, w
-0002f8d0: 6f72 6b65 723a 2073 7472 2c20 7374 696d  orker: str, stim
-0002f8e0: 756c 7573 5f69 643a 2073 7472 2c20 2a2a  ulus_id: str, **
-0002f8f0: 6d73 673a 2041 6e79 0a20 2020 2029 202d  msg: Any.    ) -
-0002f900: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0002f910: 6966 2077 6f72 6b65 7220 6e6f 7420 696e  if worker not in
-0002f920: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
-0002f930: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002f940: 6e0a 2020 2020 2020 2020 7661 6c69 6461  n.        valida
-0002f950: 7465 5f6b 6579 286b 6579 290a 0a20 2020  te_key(key)..   
-0002f960: 2020 2020 2072 3a20 7475 706c 6520 3d20       r: tuple = 
-0002f970: 7365 6c66 2e73 7469 6d75 6c75 735f 7461  self.stimulus_ta
-0002f980: 736b 5f66 696e 6973 6865 6428 0a20 2020  sk_finished(.   
-0002f990: 2020 2020 2020 2020 206b 6579 3d6b 6579           key=key
-0002f9a0: 2c20 776f 726b 6572 3d77 6f72 6b65 722c  , worker=worker,
-0002f9b0: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-0002f9c0: 6d75 6c75 735f 6964 2c20 2a2a 6d73 670a  mulus_id, **msg.
-0002f9d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002f9e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0002f9f0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-0002fa00: 776f 726b 6572 5f6d 7367 7320 3d20 720a  worker_msgs = r.
-0002fa10: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
-0002fa20: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
-0002fa30: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-0002fa40: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-0002fa50: 7367 732c 2073 7469 6d75 6c75 735f 6964  sgs, stimulus_id
-0002fa60: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0002fa70: 656e 645f 616c 6c28 636c 6965 6e74 5f6d  end_all(client_m
-0002fa80: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-0002fa90: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0002faa0: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
-0002fab0: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
-0002fac0: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
-0002fad0: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-0002fae0: 6465 6620 6861 6e64 6c65 5f74 6173 6b5f  def handle_task_
-0002faf0: 6572 7265 6428 7365 6c66 2c20 6b65 793a  erred(self, key:
+0002f320: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
+0002f330: 206f 7220 6622 7265 6d6f 7665 2d63 6c69   or f"remove-cli
+0002f340: 656e 742d 7b74 696d 6528 297d 220a 2020  ent-{time()}".  
+0002f350: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+0002f360: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
+0002f370: 756e 6e69 6e67 3a0a 2020 2020 2020 2020  unning:.        
+0002f380: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002f390: 2252 656d 6f76 6520 636c 6965 6e74 2025  "Remove client %
+0002f3a0: 7322 2c20 636c 6965 6e74 290a 2020 2020  s", client).    
+0002f3b0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+0002f3c0: 6e74 285b 2261 6c6c 222c 2063 6c69 656e  nt(["all", clien
+0002f3d0: 745d 2c20 7b22 6163 7469 6f6e 223a 2022  t], {"action": "
+0002f3e0: 7265 6d6f 7665 2d63 6c69 656e 7422 2c20  remove-client", 
+0002f3f0: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
+0002f400: 7d29 0a20 2020 2020 2020 2074 7279 3a0a  }).        try:.
+0002f410: 2020 2020 2020 2020 2020 2020 6373 3a20              cs: 
+0002f420: 436c 6965 6e74 5374 6174 6520 3d20 7365  ClientState = se
+0002f430: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
+0002f440: 745d 0a20 2020 2020 2020 2065 7863 6570  t].        excep
+0002f450: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+0002f460: 2020 2020 2020 2020 2320 5858 5820 6973          # XXX is
+0002f470: 2074 6869 7320 6120 6c65 6769 7469 6d61   this a legitima
+0002f480: 7465 2063 6f6e 6469 7469 6f6e 3f0a 2020  te condition?.  
+0002f490: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+0002f4a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002f4b0: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+0002f4c0: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
+0002f4d0: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
+0002f4e0: 2020 2020 6b65 7973 3d5b 7473 2e6b 6579      keys=[ts.key
+0002f4f0: 2066 6f72 2074 7320 696e 2063 732e 7761   for ts in cs.wa
+0002f500: 6e74 735f 7768 6174 5d2c 0a20 2020 2020  nts_what],.     
+0002f510: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0002f520: 743d 6373 2e63 6c69 656e 745f 6b65 792c  t=cs.client_key,
+0002f530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f540: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+0002f550: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0002f560: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002f570: 2020 2020 6465 6c20 7365 6c66 2e63 6c69      del self.cli
+0002f580: 656e 7473 5b63 6c69 656e 745d 0a0a 2020  ents[client]..  
+0002f590: 2020 2020 2020 2020 2020 666f 7220 706c            for pl
+0002f5a0: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
+0002f5b0: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
+0002f5c0: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+0002f5d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002f5e0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+0002f5f0: 7567 696e 2e72 656d 6f76 655f 636c 6965  ugin.remove_clie
+0002f600: 6e74 2873 6368 6564 756c 6572 3d73 656c  nt(scheduler=sel
+0002f610: 662c 2063 6c69 656e 743d 636c 6965 6e74  f, client=client
+0002f620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002f630: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0002f640: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0002f650: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002f660: 6765 722e 6578 6365 7074 696f 6e28 6529  ger.exception(e)
+0002f670: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+0002f680: 6465 6620 7265 6d6f 7665 5f63 6c69 656e  def remove_clien
+0002f690: 745f 6672 6f6d 5f65 7665 6e74 7328 293a  t_from_events():
+0002f6a0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+0002f6b0: 6620 7468 6520 636c 6965 6e74 2069 736e  f the client isn
+0002f6c0: 2774 2072 6567 6973 7465 7265 6420 616e  't registered an
+0002f6d0: 796d 6f72 6520 6166 7465 7220 7468 6520  ymore after the 
+0002f6e0: 6465 6c61 792c 2072 656d 6f76 6520 6672  delay, remove fr
+0002f6f0: 6f6d 2065 7665 6e74 730a 2020 2020 2020  om events.      
+0002f700: 2020 2020 2020 6966 2063 6c69 656e 7420        if client 
+0002f710: 6e6f 7420 696e 2073 656c 662e 636c 6965  not in self.clie
+0002f720: 6e74 7320 616e 6420 636c 6965 6e74 2069  nts and client i
+0002f730: 6e20 7365 6c66 2e65 7665 6e74 733a 0a20  n self.events:. 
+0002f740: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002f750: 656c 2073 656c 662e 6576 656e 7473 5b63  el self.events[c
+0002f760: 6c69 656e 745d 0a0a 2020 2020 2020 2020  lient]..        
+0002f770: 636c 6561 6e75 705f 6465 6c61 7920 3d20  cleanup_delay = 
+0002f780: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
+0002f790: 0a20 2020 2020 2020 2020 2020 2064 6173  .            das
+0002f7a0: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+0002f7b0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0002f7c0: 6c65 722e 6576 656e 7473 2d63 6c65 616e  ler.events-clean
+0002f7d0: 7570 2d64 656c 6179 2229 0a20 2020 2020  up-delay").     
+0002f7e0: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
+0002f7f0: 6e6f 7420 7365 6c66 2e5f 6f6e 676f 696e  not self._ongoin
+0002f800: 675f 6261 636b 6772 6f75 6e64 5f74 6173  g_background_tas
+0002f810: 6b73 2e63 6c6f 7365 643a 0a20 2020 2020  ks.closed:.     
+0002f820: 2020 2020 2020 2073 656c 662e 5f6f 6e67         self._ong
+0002f830: 6f69 6e67 5f62 6163 6b67 726f 756e 645f  oing_background_
+0002f840: 7461 736b 732e 6361 6c6c 5f6c 6174 6572  tasks.call_later
+0002f850: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002f860: 2020 636c 6561 6e75 705f 6465 6c61 792c    cleanup_delay,
+0002f870: 2072 656d 6f76 655f 636c 6965 6e74 5f66   remove_client_f
+0002f880: 726f 6d5f 6576 656e 7473 0a20 2020 2020  rom_events.     
+0002f890: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0002f8a0: 6620 7365 6e64 5f74 6173 6b5f 746f 5f77  f send_task_to_w
+0002f8b0: 6f72 6b65 7228 0a20 2020 2020 2020 2073  orker(.        s
+0002f8c0: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
+0002f8d0: 2c20 7473 3a20 5461 736b 5374 6174 652c  , ts: TaskState,
+0002f8e0: 2064 7572 6174 696f 6e3a 2066 6c6f 6174   duration: float
+0002f8f0: 203d 202d 310a 2020 2020 2920 2d3e 204e   = -1.    ) -> N
+0002f900: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0002f910: 5365 6e64 2061 2073 696e 676c 6520 636f  Send a single co
+0002f920: 6d70 7574 6174 696f 6e61 6c20 7461 736b  mputational task
+0002f930: 2074 6f20 6120 776f 726b 6572 2222 220a   to a worker""".
+0002f940: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0002f950: 2020 2020 2020 2020 206d 7367 3a20 6469           msg: di
+0002f960: 6374 203d 2073 656c 662e 5f74 6173 6b5f  ct = self._task_
+0002f970: 746f 5f6d 7367 2874 732c 2064 7572 6174  to_msg(ts, durat
+0002f980: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+0002f990: 2073 656c 662e 776f 726b 6572 5f73 656e   self.worker_sen
+0002f9a0: 6428 776f 726b 6572 2c20 6d73 6729 0a20  d(worker, msg). 
+0002f9b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0002f9c0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0002f9d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002f9e0: 2e65 7863 6570 7469 6f6e 2865 290a 2020  .exception(e).  
+0002f9f0: 2020 2020 2020 2020 2020 6966 204c 4f47            if LOG
+0002fa00: 5f50 4442 3a0a 2020 2020 2020 2020 2020  _PDB:.          
+0002fa10: 2020 2020 2020 696d 706f 7274 2070 6462        import pdb
+0002fa20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002fa30: 2020 7064 622e 7365 745f 7472 6163 6528    pdb.set_trace(
+0002fa40: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
+0002fa50: 6973 650a 0a20 2020 2064 6566 2068 616e  ise..    def han
+0002fa60: 646c 655f 756e 6361 7567 6874 5f65 7272  dle_uncaught_err
+0002fa70: 6f72 2873 656c 662c 202a 2a6d 7367 3a20  or(self, **msg: 
+0002fa80: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
+0002fa90: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
+0002faa0: 6570 7469 6f6e 2863 6c65 616e 5f65 7863  eption(clean_exc
+0002fab0: 6570 7469 6f6e 282a 2a6d 7367 295b 315d  eption(**msg)[1]
+0002fac0: 290a 0a20 2020 2064 6566 2068 616e 646c  )..    def handl
+0002fad0: 655f 7461 736b 5f66 696e 6973 6865 6428  e_task_finished(
+0002fae0: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
+0002faf0: 6579 3a20 7374 722c 2077 6f72 6b65 723a  ey: str, worker:
 0002fb00: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
 0002fb10: 643a 2073 7472 2c20 2a2a 6d73 673a 2041  d: str, **msg: A
-0002fb20: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-0002fb30: 2020 2020 2072 3a20 7475 706c 6520 3d20       r: tuple = 
-0002fb40: 7365 6c66 2e73 7469 6d75 6c75 735f 7461  self.stimulus_ta
-0002fb50: 736b 5f65 7272 6564 286b 6579 3d6b 6579  sk_erred(key=key
-0002fb60: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-0002fb70: 696d 756c 7573 5f69 642c 202a 2a6d 7367  imulus_id, **msg
-0002fb80: 290a 2020 2020 2020 2020 7265 636f 6d6d  ).        recomm
-0002fb90: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-0002fba0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-0002fbb0: 7367 7320 3d20 720a 2020 2020 2020 2020  sgs = r.        
-0002fbc0: 7365 6c66 2e5f 7472 616e 7369 7469 6f6e  self._transition
-0002fbd0: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
-0002fbe0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-0002fbf0: 776f 726b 6572 5f6d 7367 732c 2073 7469  worker_msgs, sti
-0002fc00: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
-0002fc10: 2020 7365 6c66 2e73 656e 645f 616c 6c28    self.send_all(
-0002fc20: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-0002fc30: 6b65 725f 6d73 6773 290a 0a20 2020 2020  ker_msgs)..     
-0002fc40: 2020 2073 656c 662e 7374 696d 756c 7573     self.stimulus
-0002fc50: 5f71 7565 7565 5f73 6c6f 7473 5f6d 6179  _queue_slots_may
-0002fc60: 6265 5f6f 7065 6e65 6428 7374 696d 756c  be_opened(stimul
-0002fc70: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-0002fc80: 6429 0a0a 2020 2020 6465 6620 7265 6c65  d)..    def rele
-0002fc90: 6173 655f 776f 726b 6572 5f64 6174 6128  ase_worker_data(
-0002fca0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-0002fcb0: 776f 726b 6572 3a20 7374 722c 2073 7469  worker: str, sti
-0002fcc0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-0002fcd0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0002fce0: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-0002fcf0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0002fd00: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-0002fd10: 7273 2e67 6574 2877 6f72 6b65 7229 0a20  rs.get(worker). 
-0002fd20: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-0002fd30: 206f 7220 6e6f 7420 7773 206f 7220 7773   or not ws or ws
-0002fd40: 206e 6f74 2069 6e20 7473 2e77 686f 5f68   not in ts.who_h
-0002fd50: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0002fd60: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-0002fd70: 7365 6c66 2e72 656d 6f76 655f 7265 706c  self.remove_repl
-0002fd80: 6963 6128 7473 2c20 7773 290a 2020 2020  ica(ts, ws).    
-0002fd90: 2020 2020 6966 206e 6f74 2074 732e 7768      if not ts.wh
-0002fda0: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
-0002fdb0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-0002fdc0: 6f6e 7328 7b6b 6579 3a20 2272 656c 6561  ons({key: "relea
-0002fdd0: 7365 6422 7d2c 2073 7469 6d75 6c75 735f  sed"}, stimulus_
-0002fde0: 6964 290a 0a20 2020 2064 6566 2068 616e  id)..    def han
-0002fdf0: 646c 655f 6c6f 6e67 5f72 756e 6e69 6e67  dle_long_running
-0002fe00: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0002fe10: 6b65 793a 2073 7472 2c20 776f 726b 6572  key: str, worker
-0002fe20: 3a20 7374 722c 2063 6f6d 7075 7465 5f64  : str, compute_d
-0002fe30: 7572 6174 696f 6e3a 2066 6c6f 6174 207c  uration: float |
-0002fe40: 204e 6f6e 652c 2073 7469 6d75 6c75 735f   None, stimulus_
-0002fe50: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-0002fe60: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0002fe70: 2222 4120 7461 736b 2068 6173 2073 6563  ""A task has sec
-0002fe80: 6564 6564 2066 726f 6d20 7468 6520 7468  eded from the th
-0002fe90: 7265 6164 2070 6f6f 6c0a 0a20 2020 2020  read pool..     
-0002fea0: 2020 2057 6520 7374 6f70 2074 6865 2074     We stop the t
-0002feb0: 6173 6b20 6672 6f6d 2062 6569 6e67 2073  ask from being s
-0002fec0: 746f 6c65 6e20 696e 2074 6865 2066 7574  tolen in the fut
-0002fed0: 7572 652c 2061 6e64 2063 6861 6e67 6520  ure, and change 
-0002fee0: 7461 736b 0a20 2020 2020 2020 2064 7572  task.        dur
-0002fef0: 6174 696f 6e20 6163 636f 756e 7469 6e67  ation accounting
-0002ff00: 2061 7320 6966 2074 6865 2074 6173 6b20   as if the task 
-0002ff10: 6861 7320 7374 6f70 7065 642e 0a20 2020  has stopped..   
-0002ff20: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0002ff30: 2069 6620 6b65 7920 6e6f 7420 696e 2073   if key not in s
-0002ff40: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
-0002ff50: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-0002ff60: 6275 6728 2253 6b69 7070 696e 6720 6c6f  bug("Skipping lo
-0002ff70: 6e67 5f72 756e 6e69 6e67 2073 696e 6365  ng_running since
-0002ff80: 206b 6579 2025 7320 7761 7320 616c 7265   key %s was alre
-0002ff90: 6164 7920 7265 6c65 6173 6564 222c 206b  ady released", k
-0002ffa0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0002ffb0: 7265 7475 726e 0a20 2020 2020 2020 2074  return.        t
-0002ffc0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-0002ffd0: 6579 5d0a 2020 2020 2020 2020 7374 6561  ey].        stea
-0002ffe0: 6c20 3d20 7365 6c66 2e65 7874 656e 7369  l = self.extensi
-0002fff0: 6f6e 732e 6765 7428 2273 7465 616c 696e  ons.get("stealin
-00030000: 6722 290a 2020 2020 2020 2020 6966 2073  g").        if s
-00030010: 7465 616c 2069 7320 6e6f 7420 4e6f 6e65  teal is not None
-00030020: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-00030030: 6561 6c2e 7265 6d6f 7665 5f6b 6579 5f66  eal.remove_key_f
-00030040: 726f 6d5f 7374 6561 6c61 626c 6528 7473  rom_stealable(ts
-00030050: 290a 0a20 2020 2020 2020 2077 7320 3d20  )..        ws = 
-00030060: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00030070: 0a20 2020 2020 2020 2069 6620 7773 2069  .        if ws i
-00030080: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00030090: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-000300a0: 2822 5265 6365 6976 6564 206c 6f6e 672d  ("Received long-
-000300b0: 7275 6e6e 696e 6720 7369 676e 616c 2066  running signal f
-000300c0: 726f 6d20 6475 706c 6963 6174 6520 7461  rom duplicate ta
-000300d0: 736b 2e20 4967 6e6f 7269 6e67 2e22 290a  sk. Ignoring.").
-000300e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000300f0: 726e 0a0a 2020 2020 2020 2020 6966 2063  rn..        if c
-00030100: 6f6d 7075 7465 5f64 7572 6174 696f 6e20  ompute_duration 
-00030110: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00030120: 2020 2020 2020 2020 206f 6c64 5f64 7572           old_dur
-00030130: 6174 696f 6e20 3d20 7473 2e70 7265 6669  ation = ts.prefi
-00030140: 782e 6475 7261 7469 6f6e 5f61 7665 7261  x.duration_avera
-00030150: 6765 0a20 2020 2020 2020 2020 2020 2069  ge.            i
-00030160: 6620 6f6c 645f 6475 7261 7469 6f6e 203c  f old_duration <
-00030170: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00030180: 2020 2020 7473 2e70 7265 6669 782e 6475      ts.prefix.du
-00030190: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
-000301a0: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
-000301b0: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
-000301c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000301d0: 2020 2020 7473 2e70 7265 6669 782e 6475      ts.prefix.du
-000301e0: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
-000301f0: 2028 6f6c 645f 6475 7261 7469 6f6e 202b   (old_duration +
-00030200: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
-00030210: 6e29 202f 2032 0a0a 2020 2020 2020 2020  n) / 2..        
-00030220: 7773 2e61 6464 5f74 6f5f 6c6f 6e67 5f72  ws.add_to_long_r
-00030230: 756e 6e69 6e67 2874 7329 0a20 2020 2020  unning(ts).     
-00030240: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
-00030250: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
-00030260: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-00030270: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
-00030280: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
-00030290: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
-000302a0: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
-000302b0: 6566 2068 616e 646c 655f 776f 726b 6572  ef handle_worker
-000302c0: 5f73 7461 7475 735f 6368 616e 6765 280a  _status_change(.
-000302d0: 2020 2020 2020 2020 7365 6c66 2c20 7374          self, st
-000302e0: 6174 7573 3a20 7374 7220 7c20 5374 6174  atus: str | Stat
-000302f0: 7573 2c20 776f 726b 6572 3a20 7374 7220  us, worker: str 
-00030300: 7c20 576f 726b 6572 5374 6174 652c 2073  | WorkerState, s
-00030310: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
-00030320: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00030330: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
-00030340: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
-00030350: 6b65 7229 2069 6620 6973 696e 7374 616e  ker) if isinstan
-00030360: 6365 2877 6f72 6b65 722c 2073 7472 2920  ce(worker, str) 
-00030370: 656c 7365 2077 6f72 6b65 720a 2020 2020  else worker.    
-00030380: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
-00030390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000303a0: 6e0a 2020 2020 2020 2020 7072 6576 5f73  n.        prev_s
-000303b0: 7461 7475 7320 3d20 7773 2e73 7461 7475  tatus = ws.statu
-000303c0: 730a 2020 2020 2020 2020 7773 2e73 7461  s.        ws.sta
-000303d0: 7475 7320 3d20 5374 6174 7573 5b73 7461  tus = Status[sta
-000303e0: 7475 735d 2069 6620 6973 696e 7374 616e  tus] if isinstan
-000303f0: 6365 2873 7461 7475 732c 2073 7472 2920  ce(status, str) 
-00030400: 656c 7365 2073 7461 7475 730a 2020 2020  else status.    
-00030410: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
-00030420: 203d 3d20 7072 6576 5f73 7461 7475 733a   == prev_status:
-00030430: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00030440: 7572 6e0a 0a20 2020 2020 2020 2073 656c  urn..        sel
-00030450: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-00030460: 2020 2020 2020 2020 2077 732e 6164 6472           ws.addr
-00030470: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00030480: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00030490: 2020 2022 6163 7469 6f6e 223a 2022 776f     "action": "wo
-000304a0: 726b 6572 2d73 7461 7475 732d 6368 616e  rker-status-chan
-000304b0: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
-000304c0: 2020 2020 2022 7072 6576 2d73 7461 7475       "prev-statu
-000304d0: 7322 3a20 7072 6576 5f73 7461 7475 732e  s": prev_status.
-000304e0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-000304f0: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-00030500: 7773 2e73 7461 7475 732e 6e61 6d65 2c0a  ws.status.name,.
-00030510: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00030520: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00030530: 206c 6f67 6765 722e 6465 6275 6728 6622   logger.debug(f"
-00030540: 576f 726b 6572 2073 7461 7475 7320 7b70  Worker status {p
-00030550: 7265 765f 7374 6174 7573 2e6e 616d 657d  rev_status.name}
-00030560: 202d 3e20 7b73 7461 7475 737d 202d 207b   -> {status} - {
-00030570: 7773 7d22 290a 0a20 2020 2020 2020 2069  ws}")..        i
-00030580: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-00030590: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-000305a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000305b0: 7275 6e6e 696e 672e 6164 6428 7773 290a  running.add(ws).
-000305c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000305d0: 2e63 6865 636b 5f69 646c 655f 7361 7475  .check_idle_satu
-000305e0: 7261 7465 6428 7773 290a 2020 2020 2020  rated(ws).      
-000305f0: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
-00030600: 6974 696f 6e73 280a 2020 2020 2020 2020  itions(.        
-00030610: 2020 2020 2020 2020 7365 6c66 2e62 756c          self.bul
-00030620: 6b5f 7363 6865 6475 6c65 5f75 6e72 756e  k_schedule_unrun
-00030630: 6e61 626c 655f 6166 7465 725f 6164 6469  nable_after_addi
-00030640: 6e67 5f77 6f72 6b65 7228 7773 292c 2073  ng_worker(ws), s
-00030650: 7469 6d75 6c75 735f 6964 0a20 2020 2020  timulus_id.     
-00030660: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00030670: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
-00030680: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
-00030690: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
-000306a0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-000306b0: 5f69 6429 0a20 2020 2020 2020 2065 6c73  _id).        els
-000306c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000306d0: 656c 662e 7275 6e6e 696e 672e 6469 7363  elf.running.disc
-000306e0: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
-000306f0: 2020 2020 7365 6c66 2e69 646c 652e 706f      self.idle.po
-00030700: 7028 7773 2e61 6464 7265 7373 2c20 4e6f  p(ws.address, No
-00030710: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-00030720: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-00030730: 6f75 6e74 2e64 6973 6361 7264 2877 7329  ount.discard(ws)
-00030740: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00030750: 662e 7361 7475 7261 7465 642e 6469 7363  f.saturated.disc
-00030760: 6172 6428 7773 290a 0a20 2020 2061 7379  ard(ws)..    asy
-00030770: 6e63 2064 6566 2068 616e 646c 655f 7265  nc def handle_re
-00030780: 7175 6573 745f 7265 6672 6573 685f 7768  quest_refresh_wh
-00030790: 6f5f 6861 7328 0a20 2020 2020 2020 2073  o_has(.        s
-000307a0: 656c 662c 206b 6579 733a 2049 7465 7261  elf, keys: Itera
-000307b0: 626c 655b 7374 725d 2c20 776f 726b 6572  ble[str], worker
-000307c0: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-000307d0: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-000307e0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-000307f0: 2222 4173 796e 6368 726f 6e6f 7573 2072  ""Asynchronous r
-00030800: 6571 7565 7374 2028 7468 726f 7567 6820  equest (through 
-00030810: 6275 6c6b 2063 6f6d 6d73 2920 6672 6f6d  bulk comms) from
-00030820: 2061 2057 6f72 6b65 7220 746f 2072 6566   a Worker to ref
-00030830: 7265 7368 2074 6865 0a20 2020 2020 2020  resh the.       
-00030840: 2077 686f 5f68 6173 2066 6f72 2073 6f6d   who_has for som
-00030850: 6520 6b65 7973 2e20 4e6f 7420 746f 2062  e keys. Not to b
-00030860: 6520 636f 6e66 7573 6564 2077 6974 6820  e confused with 
-00030870: 7363 6865 6475 6c65 722e 7768 6f5f 6861  scheduler.who_ha
-00030880: 732c 2077 6869 6368 2069 7320 610a 2020  s, which is a.  
-00030890: 2020 2020 2020 7379 6e63 6872 6f6e 6f75        synchronou
-000308a0: 7320 5250 4320 7265 7175 6573 7420 6672  s RPC request fr
-000308b0: 6f6d 2061 2043 6c69 656e 742e 0a20 2020  om a Client..   
-000308c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000308d0: 2077 686f 5f68 6173 203d 207b 7d0a 2020   who_has = {}.  
-000308e0: 2020 2020 2020 6672 6565 5f6b 6579 7320        free_keys 
-000308f0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00030900: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
-00030910: 2020 2020 2020 2020 2020 6966 206b 6579            if key
-00030920: 2069 6e20 7365 6c66 2e74 6173 6b73 3a0a   in self.tasks:.
-00030930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030940: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
-00030950: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
-00030960: 7320 696e 2073 656c 662e 7461 736b 735b  s in self.tasks[
-00030970: 6b65 795d 2e77 686f 5f68 6173 5d0a 2020  key].who_has].  
-00030980: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00030990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309a0: 6672 6565 5f6b 6579 732e 6170 7065 6e64  free_keys.append
-000309b0: 286b 6579 290a 0a20 2020 2020 2020 2069  (key)..        i
-000309c0: 6620 7768 6f5f 6861 733a 0a20 2020 2020  f who_has:.     
-000309d0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-000309e0: 616d 5f63 6f6d 6d73 5b77 6f72 6b65 725d  am_comms[worker]
-000309f0: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
-00030a00: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00030a10: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-00030a20: 223a 2022 7265 6672 6573 682d 7768 6f2d  ": "refresh-who-
-00030a30: 6861 7322 2c0a 2020 2020 2020 2020 2020  has",.          
-00030a40: 2020 2020 2020 2020 2020 2277 686f 5f68            "who_h
-00030a50: 6173 223a 2077 686f 5f68 6173 2c0a 2020  as": who_has,.  
-00030a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a70: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-00030a80: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-00030a90: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00030aa0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00030ab0: 2020 2020 2020 6966 2066 7265 655f 6b65        if free_ke
-00030ac0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00030ad0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00030ae0: 735b 776f 726b 6572 5d2e 7365 6e64 280a  s[worker].send(.
-00030af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00030b10: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
-00030b20: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
-00030b30: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-00030b40: 7973 223a 2066 7265 655f 6b65 7973 2c0a  ys": free_keys,.
-00030b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b60: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-00030b70: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-00030b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b90: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
-00030ba0: 0a20 2020 2061 7379 6e63 2064 6566 2068  .    async def h
-00030bb0: 616e 646c 655f 776f 726b 6572 2873 656c  andle_worker(sel
-00030bc0: 662c 2063 6f6d 6d3a 2043 6f6d 6d2c 2077  f, comm: Comm, w
-00030bd0: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
-00030be0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00030bf0: 0a20 2020 2020 2020 204c 6973 7465 6e20  .        Listen 
-00030c00: 746f 2072 6573 706f 6e73 6573 2066 726f  to responses fro
-00030c10: 6d20 6120 7369 6e67 6c65 2077 6f72 6b65  m a single worke
-00030c20: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
-00030c30: 6973 2074 6865 206d 6169 6e20 6c6f 6f70  is the main loop
-00030c40: 2066 6f72 2073 6368 6564 756c 6572 2d77   for scheduler-w
-00030c50: 6f72 6b65 7220 696e 7465 7261 6374 696f  orker interactio
-00030c60: 6e0a 0a20 2020 2020 2020 2053 6565 2041  n..        See A
-00030c70: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-00030c80: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-00030c90: 6564 756c 6572 2e68 616e 646c 655f 636c  eduler.handle_cl
-00030ca0: 6965 6e74 3a20 4571 7569 7661 6c65 6e74  ient: Equivalent
-00030cb0: 2063 6f72 6f75 7469 6e65 2066 6f72 2063   coroutine for c
-00030cc0: 6c69 656e 7473 0a20 2020 2020 2020 2022  lients.        "
-00030cd0: 2222 0a20 2020 2020 2020 2063 6f6d 6d2e  "".        comm.
-00030ce0: 6e61 6d65 203d 2022 5363 6865 6475 6c65  name = "Schedule
-00030cf0: 7220 636f 6e6e 6563 7469 6f6e 2074 6f20  r connection to 
-00030d00: 776f 726b 6572 220a 2020 2020 2020 2020  worker".        
-00030d10: 776f 726b 6572 5f63 6f6d 6d20 3d20 7365  worker_comm = se
-00030d20: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-00030d30: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-00030d40: 776f 726b 6572 5f63 6f6d 6d2e 7374 6172  worker_comm.star
-00030d50: 7428 636f 6d6d 290a 2020 2020 2020 2020  t(comm).        
-00030d60: 6c6f 6767 6572 2e69 6e66 6f28 2253 7461  logger.info("Sta
-00030d70: 7274 696e 6720 776f 726b 6572 2063 6f6d  rting worker com
-00030d80: 7075 7465 2073 7472 6561 6d2c 2025 7322  pute stream, %s"
-00030d90: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
-00030da0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00030db0: 2020 2061 7761 6974 2073 656c 662e 6861     await self.ha
-00030dc0: 6e64 6c65 5f73 7472 6561 6d28 636f 6d6d  ndle_stream(comm
-00030dd0: 3d63 6f6d 6d2c 2065 7874 7261 3d7b 2277  =comm, extra={"w
-00030de0: 6f72 6b65 7222 3a20 776f 726b 6572 7d29  orker": worker})
-00030df0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-00030e00: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00030e10: 2077 6f72 6b65 7220 696e 2073 656c 662e   worker in self.
-00030e20: 7374 7265 616d 5f63 6f6d 6d73 3a0a 2020  stream_comms:.  
-00030e30: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00030e40: 726b 6572 5f63 6f6d 6d2e 6162 6f72 7428  rker_comm.abort(
-00030e50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00030e60: 2020 6177 6169 7420 7365 6c66 2e72 656d    await self.rem
-00030e70: 6f76 655f 776f 726b 6572 280a 2020 2020  ove_worker(.    
-00030e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e90: 776f 726b 6572 2c20 7374 696d 756c 7573  worker, stimulus
-00030ea0: 5f69 643d 6622 6861 6e64 6c65 2d77 6f72  _id=f"handle-wor
-00030eb0: 6b65 722d 636c 6561 6e75 702d 7b74 696d  ker-cleanup-{tim
-00030ec0: 6528 297d 220a 2020 2020 2020 2020 2020  e()}".          
-00030ed0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00030ee0: 2061 6464 5f70 6c75 6769 6e28 0a20 2020   add_plugin(.   
-00030ef0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00030f00: 2020 2070 6c75 6769 6e3a 2053 6368 6564     plugin: Sched
-00030f10: 756c 6572 506c 7567 696e 2c0a 2020 2020  ulerPlugin,.    
-00030f20: 2020 2020 2a2c 0a20 2020 2020 2020 2069      *,.        i
-00030f30: 6465 6d70 6f74 656e 743a 2062 6f6f 6c20  dempotent: bool 
-00030f40: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-00030f50: 206e 616d 653a 2073 7472 207c 204e 6f6e   name: str | Non
-00030f60: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00030f70: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
-00030f80: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00030f90: 2020 2020 2020 2020 2222 2241 6464 2065          """Add e
-00030fa0: 7874 6572 6e61 6c20 706c 7567 696e 2074  xternal plugin t
-00030fb0: 6f20 7363 6865 6475 6c65 722e 0a0a 2020  o scheduler...  
-00030fc0: 2020 2020 2020 5365 6520 6874 7470 733a        See https:
-00030fd0: 2f2f 6469 7374 7269 6275 7465 642e 7265  //distributed.re
-00030fe0: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
-00030ff0: 6c61 7465 7374 2f70 6c75 6769 6e73 2e68  latest/plugins.h
-00031000: 746d 6c0a 0a20 2020 2020 2020 2050 6172  tml..        Par
-00031010: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00031020: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00031030: 2020 2070 6c75 6769 6e20 3a20 5363 6865     plugin : Sche
-00031040: 6475 6c65 7250 6c75 6769 6e0a 2020 2020  dulerPlugin.    
-00031050: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
-00031060: 7250 6c75 6769 6e20 696e 7374 616e 6365  rPlugin instance
-00031070: 2074 6f20 6164 640a 2020 2020 2020 2020   to add.        
-00031080: 6964 656d 706f 7465 6e74 203a 2062 6f6f  idempotent : boo
-00031090: 6c0a 2020 2020 2020 2020 2020 2020 4966  l.            If
-000310a0: 2074 7275 652c 2074 6865 2070 6c75 6769   true, the plugi
-000310b0: 6e20 6973 2061 7373 756d 6564 2074 6f20  n is assumed to 
-000310c0: 616c 7265 6164 7920 6578 6973 7420 616e  already exist an
-000310d0: 6420 6e6f 0a20 2020 2020 2020 2020 2020  d no.           
-000310e0: 2061 6374 696f 6e20 6973 2074 616b 656e   action is taken
-000310f0: 2e0a 2020 2020 2020 2020 6e61 6d65 203a  ..        name :
-00031100: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-00031110: 2041 206e 616d 6520 666f 7220 7468 6520   A name for the 
-00031120: 706c 7567 696e 2c20 6966 204e 6f6e 652c  plugin, if None,
-00031130: 2074 6865 206e 616d 6520 6174 7472 6962   the name attrib
-00031140: 7574 6520 6973 0a20 2020 2020 2020 2020  ute is.         
-00031150: 2020 2063 6865 636b 6564 206f 6e20 7468     checked on th
-00031160: 6520 506c 7567 696e 2069 6e73 7461 6e63  e Plugin instanc
-00031170: 6520 616e 6420 6765 6e65 7261 7465 6420  e and generated 
-00031180: 6966 206e 6f74 0a20 2020 2020 2020 2020  if not.         
-00031190: 2020 2064 6973 636f 7665 7265 642e 0a20     discovered.. 
-000311a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000311b0: 2020 2069 6620 6e61 6d65 2069 7320 4e6f     if name is No
-000311c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000311d0: 6e61 6d65 203d 205f 6765 745f 706c 7567  name = _get_plug
-000311e0: 696e 5f6e 616d 6528 706c 7567 696e 290a  in_name(plugin).
-000311f0: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
-00031200: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
-00031210: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00031220: 2069 6465 6d70 6f74 656e 743a 0a20 2020   idempotent:.   
-00031230: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00031240: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-00031250: 7761 726e 696e 6773 2e77 6172 6e28 0a20  warnings.warn(. 
-00031260: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00031270: 2253 6368 6564 756c 6572 2061 6c72 6561  "Scheduler alrea
-00031280: 6479 2063 6f6e 7461 696e 7320 6120 706c  dy contains a pl
-00031290: 7567 696e 2077 6974 6820 6e61 6d65 207b  ugin with name {
-000312a0: 6e61 6d65 7d3b 206f 7665 7277 7269 7469  name}; overwriti
-000312b0: 6e67 2e22 2c0a 2020 2020 2020 2020 2020  ng.",.          
-000312c0: 2020 2020 2020 6361 7465 676f 7279 3d55        category=U
-000312d0: 7365 7257 6172 6e69 6e67 2c0a 2020 2020  serWarning,.    
-000312e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000312f0: 2020 2073 656c 662e 706c 7567 696e 735b     self.plugins[
-00031300: 6e61 6d65 5d20 3d20 706c 7567 696e 0a0a  name] = plugin..
-00031310: 2020 2020 6465 6620 7265 6d6f 7665 5f70      def remove_p
-00031320: 6c75 6769 6e28 0a20 2020 2020 2020 2073  lugin(.        s
-00031330: 656c 662c 0a20 2020 2020 2020 206e 616d  elf,.        nam
-00031340: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
-00031350: 4e6f 6e65 2c0a 2020 2020 2020 2020 706c  None,.        pl
-00031360: 7567 696e 3a20 5363 6865 6475 6c65 7250  ugin: SchedulerP
-00031370: 6c75 6769 6e20 7c20 4e6f 6e65 203d 204e  lugin | None = N
-00031380: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
-00031390: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
-000313a0: 656d 6f76 6520 6578 7465 726e 616c 2070  emove external p
-000313b0: 6c75 6769 6e20 6672 6f6d 2073 6368 6564  lugin from sched
-000313c0: 756c 6572 0a0a 2020 2020 2020 2020 5061  uler..        Pa
-000313d0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-000313e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-000313f0: 2020 2020 6e61 6d65 203a 2073 7472 0a20      name : str. 
-00031400: 2020 2020 2020 2020 2020 204e 616d 6520             Name 
-00031410: 6f66 2074 6865 2070 6c75 6769 6e20 746f  of the plugin to
-00031420: 2072 656d 6f76 650a 2020 2020 2020 2020   remove.        
-00031430: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
-00031440: 7274 206e 616d 6520 6973 206e 6f74 204e  rt name is not N
-00031450: 6f6e 650a 0a20 2020 2020 2020 2074 7279  one..        try
-00031460: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-00031470: 6c20 7365 6c66 2e70 6c75 6769 6e73 5b6e  l self.plugins[n
-00031480: 616d 655d 0a20 2020 2020 2020 2065 7863  ame].        exc
-00031490: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-000314a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000314b0: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-000314c0: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
-000314d0: 756c 6420 6e6f 7420 6669 6e64 2070 6c75  uld not find plu
-000314e0: 6769 6e20 7b6e 616d 6521 727d 2061 6d6f  gin {name!r} amo
-000314f0: 6e67 2074 6865 2063 7572 7265 6e74 2073  ng the current s
-00031500: 6368 6564 756c 6572 2070 6c75 6769 6e73  cheduler plugins
-00031510: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00031520: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-00031530: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
-00031540: 725f 706c 7567 696e 280a 2020 2020 2020  r_plugin(.      
-00031550: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00031560: 706c 7567 696e 3a20 6279 7465 7320 7c20  plugin: bytes | 
-00031570: 5363 6865 6475 6c65 7250 6c75 6769 6e2c  SchedulerPlugin,
-00031580: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
-00031590: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-000315a0: 2c0a 2020 2020 2020 2020 6964 656d 706f  ,.        idempo
-000315b0: 7465 6e74 3a20 626f 6f6c 203d 2046 616c  tent: bool = Fal
-000315c0: 7365 2c0a 2020 2020 2920 2d3e 204e 6f6e  se,.    ) -> Non
-000315d0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-000315e0: 6769 7374 6572 2061 2070 6c75 6769 6e20  gister a plugin 
-000315f0: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
-00031600: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
-00031610: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
-00031620: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-00031630: 2e73 6368 6564 756c 6572 2e70 6963 6b6c  .scheduler.pickl
-00031640: 6522 293a 0a20 2020 2020 2020 2020 2020  e"):.           
-00031650: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00031660: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00031670: 2020 2022 4361 6e6e 6f74 2072 6567 6973     "Cannot regis
-00031680: 7465 7220 6120 7363 6865 6475 6c65 7220  ter a scheduler 
-00031690: 706c 7567 696e 2061 7320 7468 6520 7363  plugin as the sc
-000316a0: 6865 6475 6c65 7220 220a 2020 2020 2020  heduler ".      
-000316b0: 2020 2020 2020 2020 2020 2268 6173 2062            "has b
-000316c0: 6565 6e20 6578 706c 6963 6974 6c79 2064  een explicitly d
-000316d0: 6973 616c 6c6f 7765 6420 6672 6f6d 2064  isallowed from d
-000316e0: 6573 6572 6961 6c69 7a69 6e67 2022 0a20  eserializing ". 
-000316f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00031700: 6172 6269 7472 6172 7920 6279 7465 7374  arbitrary bytest
-00031710: 7269 6e67 7320 7573 696e 6720 7069 636b  rings using pick
-00031720: 6c65 2076 6961 2074 6865 2022 0a20 2020  le via the ".   
-00031730: 2020 2020 2020 2020 2020 2020 2022 2764               "'d
-00031740: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-00031750: 756c 6572 2e70 6963 6b6c 6527 2063 6f6e  uler.pickle' con
-00031760: 6669 6775 7261 7469 6f6e 2073 6574 7469  figuration setti
-00031770: 6e67 2e22 0a20 2020 2020 2020 2020 2020  ng.".           
-00031780: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
-00031790: 7420 6973 696e 7374 616e 6365 2870 6c75  t isinstance(plu
-000317a0: 6769 6e2c 2053 6368 6564 756c 6572 506c  gin, SchedulerPl
-000317b0: 7567 696e 293a 0a20 2020 2020 2020 2020  ugin):.         
-000317c0: 2020 2070 6c75 6769 6e20 3d20 6c6f 6164     plugin = load
-000317d0: 7328 706c 7567 696e 290a 2020 2020 2020  s(plugin).      
-000317e0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-000317f0: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
-00031800: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
-00031810: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
-00031820: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-00031830: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
-00031840: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
-00031850: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
-00031860: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
-00031870: 706c 7567 696e 7320 616e 6420 6964 656d  plugins and idem
-00031880: 706f 7465 6e74 3a0a 2020 2020 2020 2020  potent:.        
-00031890: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-000318a0: 2020 2020 6966 2068 6173 6174 7472 2870      if hasattr(p
-000318b0: 6c75 6769 6e2c 2022 7374 6172 7422 293a  lugin, "start"):
-000318c0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-000318d0: 756c 7420 3d20 706c 7567 696e 2e73 7461  ult = plugin.sta
-000318e0: 7274 2873 656c 6629 0a20 2020 2020 2020  rt(self).       
-000318f0: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
-00031900: 6973 6177 6169 7461 626c 6528 7265 7375  isawaitable(resu
-00031910: 6c74 293a 0a20 2020 2020 2020 2020 2020  lt):.           
-00031920: 2020 2020 2061 7761 6974 2072 6573 756c       await resul
-00031930: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
-00031940: 6164 645f 706c 7567 696e 2870 6c75 6769  add_plugin(plugi
-00031950: 6e2c 206e 616d 653d 6e61 6d65 2c20 6964  n, name=name, id
-00031960: 656d 706f 7465 6e74 3d69 6465 6d70 6f74  empotent=idempot
-00031970: 656e 7429 0a0a 2020 2020 6465 6620 776f  ent)..    def wo
-00031980: 726b 6572 5f73 656e 6428 7365 6c66 2c20  rker_send(self, 
-00031990: 776f 726b 6572 3a20 7374 722c 206d 7367  worker: str, msg
-000319a0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
-000319b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-000319c0: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
-000319d0: 6765 2074 6f20 776f 726b 6572 0a0a 2020  ge to worker..  
-000319e0: 2020 2020 2020 5468 6973 2061 6c73 6f20        This also 
-000319f0: 6861 6e64 6c65 7320 636f 6e6e 6563 7469  handles connecti
-00031a00: 6f6e 2066 6169 6c75 7265 7320 6279 2061  on failures by a
-00031a10: 6464 696e 6720 6120 6361 6c6c 6261 636b  dding a callback
-00031a20: 2074 6f20 7265 6d6f 7665 0a20 2020 2020   to remove.     
-00031a30: 2020 2074 6865 2077 6f72 6b65 7220 6f6e     the worker on
-00031a40: 2074 6865 206e 6578 7420 6379 636c 652e   the next cycle.
-00031a50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00031a60: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
-00031a70: 733a 2064 6963 7420 3d20 7365 6c66 2e73  s: dict = self.s
-00031a80: 7472 6561 6d5f 636f 6d6d 730a 2020 2020  tream_comms.    
-00031a90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00031aa0: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
-00031ab0: 735b 776f 726b 6572 5d2e 7365 6e64 286d  s[worker].send(m
-00031ac0: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
-00031ad0: 7074 2028 436f 6d6d 436c 6f73 6564 4572  pt (CommClosedEr
-00031ae0: 726f 722c 2041 7474 7269 6275 7465 4572  ror, AttributeEr
-00031af0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00031b00: 2020 7365 6c66 2e5f 6f6e 676f 696e 675f    self._ongoing_
-00031b10: 6261 636b 6772 6f75 6e64 5f74 6173 6b73  background_tasks
-00031b20: 2e63 616c 6c5f 736f 6f6e 280a 2020 2020  .call_soon(.    
-00031b30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00031b40: 2e72 656d 6f76 655f 776f 726b 6572 2c0a  .remove_worker,.
-00031b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b60: 6164 6472 6573 733d 776f 726b 6572 2c0a  address=worker,.
-00031b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b80: 7374 696d 756c 7573 5f69 643d 6622 776f  stimulus_id=f"wo
-00031b90: 726b 6572 2d73 656e 642d 636f 6d6d 2d66  rker-send-comm-f
-00031ba0: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
-00031bb0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00031bc0: 2020 6465 6620 636c 6965 6e74 5f73 656e    def client_sen
-00031bd0: 6428 7365 6c66 2c20 636c 6965 6e74 2c20  d(self, client, 
-00031be0: 6d73 6729 3a0a 2020 2020 2020 2020 2222  msg):.        ""
-00031bf0: 2253 656e 6420 6d65 7373 6167 6520 746f  "Send message to
-00031c00: 2063 6c69 656e 7422 2222 0a20 2020 2020   client""".     
-00031c10: 2020 2063 6c69 656e 745f 636f 6d6d 733a     client_comms:
-00031c20: 2064 6963 7420 3d20 7365 6c66 2e63 6c69   dict = self.cli
-00031c30: 656e 745f 636f 6d6d 730a 2020 2020 2020  ent_comms.      
-00031c40: 2020 6320 3d20 636c 6965 6e74 5f63 6f6d    c = client_com
-00031c50: 6d73 2e67 6574 2863 6c69 656e 7429 0a20  ms.get(client). 
-00031c60: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
-00031c70: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00031c80: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00031c90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00031ca0: 2063 2e73 656e 6428 6d73 6729 0a20 2020   c.send(msg).   
-00031cb0: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
-00031cc0: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
-00031cd0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00031ce0: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-00031cf0: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
-00031d00: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00031d10: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
-00031d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d30: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
-00031d40: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
-00031d50: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
-00031d60: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
-00031d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031d80: 2029 0a0a 2020 2020 6465 6620 7365 6e64   )..    def send
-00031d90: 5f61 6c6c 2873 656c 662c 2063 6c69 656e  _all(self, clien
-00031da0: 745f 6d73 6773 3a20 4d73 6773 2c20 776f  t_msgs: Msgs, wo
-00031db0: 726b 6572 5f6d 7367 733a 204d 7367 7329  rker_msgs: Msgs)
-00031dc0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00031dd0: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
-00031de0: 6573 2074 6f20 636c 6965 6e74 2061 6e64  es to client and
-00031df0: 2077 6f72 6b65 7273 2222 220a 0a20 2020   workers"""..   
-00031e00: 2020 2020 2066 6f72 2063 6c69 656e 742c       for client,
-00031e10: 206d 7367 7320 696e 2063 6c69 656e 745f   msgs in client_
-00031e20: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
-00031e30: 2020 2020 2020 2020 2020 6320 3d20 7365            c = se
-00031e40: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
-00031e50: 6765 7428 636c 6965 6e74 290a 2020 2020  get(client).    
-00031e60: 2020 2020 2020 2020 6966 2063 2069 7320          if c is 
-00031e70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00031e80: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00031e90: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00031ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031eb0: 632e 7365 6e64 282a 6d73 6773 290a 2020  c.send(*msgs).  
-00031ec0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00031ed0: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
-00031ee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031ef0: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
-00031f00: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-00031f10: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00031f20: 2020 2020 2020 2020 6c6f 6767 6572 2e63          logger.c
-00031f30: 7269 7469 6361 6c28 0a20 2020 2020 2020  ritical(.       
-00031f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031f50: 2022 436c 6f73 6564 2063 6f6d 6d20 2572   "Closed comm %r
-00031f60: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
-00031f70: 2077 7269 7465 2025 7322 2c0a 2020 2020   write %s",.    
-00031f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031f90: 2020 2020 632c 0a20 2020 2020 2020 2020      c,.         
-00031fa0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00031fb0: 7367 732c 0a20 2020 2020 2020 2020 2020  sgs,.           
-00031fc0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00031fd0: 5f69 6e66 6f3d 5472 7565 2c0a 2020 2020  _info=True,.    
-00031fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ff0: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
-00032000: 6f72 6b65 722c 206d 7367 7320 696e 2077  orker, msgs in w
-00032010: 6f72 6b65 725f 6d73 6773 2e69 7465 6d73  orker_msgs.items
-00032020: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00032030: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00032040: 2020 2020 2077 203d 2073 656c 662e 7374       w = self.st
-00032050: 7265 616d 5f63 6f6d 6d73 5b77 6f72 6b65  ream_comms[worke
-00032060: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
-00032070: 2020 2077 2e73 656e 6428 2a6d 7367 7329     w.send(*msgs)
-00032080: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00032090: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-000320a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000320b0: 776f 726b 6572 2061 6c72 6561 6479 2067  worker already g
-000320c0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-000320d0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-000320e0: 2020 2020 2065 7863 6570 7420 2843 6f6d       except (Com
-000320f0: 6d43 6c6f 7365 6445 7272 6f72 2c20 4174  mClosedError, At
-00032100: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
-00032110: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00032120: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
-00032130: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
-00032140: 6c6c 5f73 6f6f 6e28 0a20 2020 2020 2020  ll_soon(.       
-00032150: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00032160: 662e 7265 6d6f 7665 5f77 6f72 6b65 722c  f.remove_worker,
-00032170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032180: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
-00032190: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-000321a0: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
-000321b0: 735f 6964 3d66 2273 656e 642d 616c 6c2d  s_id=f"send-all-
-000321c0: 636f 6d6d 2d66 6169 6c2d 7b74 696d 6528  comm-fail-{time(
-000321d0: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
-000321e0: 2020 2020 2029 0a0a 2020 2020 2323 2323       )..    ####
-000321f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00032200: 2323 2323 2323 2323 0a20 2020 2023 204c  ########.    # L
-00032210: 6573 7320 636f 6d6d 6f6e 2069 6e74 6572  ess common inter
-00032220: 6163 7469 6f6e 7320 230a 2020 2020 2323  actions #.    ##
-00032230: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00032240: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-00032250: 6173 796e 6320 6465 6620 7363 6174 7465  async def scatte
-00032260: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-00032270: 0a20 2020 2020 2020 2063 6f6d 6d3d 4e6f  .        comm=No
-00032280: 6e65 2c0a 2020 2020 2020 2020 6461 7461  ne,.        data
-00032290: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-000322a0: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
-000322b0: 2020 2020 2063 6c69 656e 743d 4e6f 6e65       client=None
-000322c0: 2c0a 2020 2020 2020 2020 6272 6f61 6463  ,.        broadc
-000322d0: 6173 743d 4661 6c73 652c 0a20 2020 2020  ast=False,.     
-000322e0: 2020 2074 696d 656f 7574 3d32 2c0a 2020     timeout=2,.  
-000322f0: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
-00032300: 5365 6e64 2064 6174 6120 6f75 7420 746f  Send data out to
-00032310: 2077 6f72 6b65 7273 0a0a 2020 2020 2020   workers..      
-00032320: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-00032330: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00032340: 2020 2020 5363 6865 6475 6c65 722e 6272      Scheduler.br
-00032350: 6f61 6463 6173 743a 0a20 2020 2020 2020  oadcast:.       
-00032360: 2022 2222 0a20 2020 2020 2020 2073 7461   """.        sta
-00032370: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
-00032380: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
-00032390: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000323a0: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-000323b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323c0: 7773 7320 3d20 7365 6c66 2e72 756e 6e69  wss = self.runni
-000323d0: 6e67 0a20 2020 2020 2020 2020 2020 2065  ng.            e
-000323e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000323f0: 2020 2020 2077 6f72 6b65 7273 203d 205b       workers = [
-00032400: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
-00032410: 6573 7328 7729 2066 6f72 2077 2069 6e20  ess(w) for w in 
-00032420: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
-00032430: 2020 2020 2020 2020 2077 7373 203d 207b           wss = {
-00032440: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d20  self.workers[w] 
-00032450: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
-00032460: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00032470: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
-00032480: 7773 2069 6e20 7773 7320 6966 2077 732e  ws in wss if ws.
-00032490: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-000324a0: 2e72 756e 6e69 6e67 7d0a 0a20 2020 2020  .running}..     
-000324b0: 2020 2020 2020 2069 6620 7773 733a 0a20         if wss:. 
-000324c0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000324d0: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
-000324e0: 2069 6620 7469 6d65 2829 203e 2073 7461   if time() > sta
-000324f0: 7274 202b 2074 696d 656f 7574 3a0a 2020  rt + timeout:.  
-00032500: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00032510: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
-00032520: 2822 4e6f 2076 616c 6964 2077 6f72 6b65  ("No valid worke
-00032530: 7273 2066 6f75 6e64 2229 0a20 2020 2020  rs found").     
-00032540: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00032550: 6e63 696f 2e73 6c65 6570 2830 2e31 290a  ncio.sleep(0.1).
-00032560: 0a20 2020 2020 2020 206e 7468 7265 6164  .        nthread
-00032570: 7320 3d20 7b77 732e 6164 6472 6573 733a  s = {ws.address:
-00032580: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
-00032590: 2077 7320 696e 2077 7373 7d0a 0a20 2020   ws in wss}..   
-000325a0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-000325b0: 7374 616e 6365 2864 6174 612c 2064 6963  stance(data, dic
-000325c0: 7429 0a0a 2020 2020 2020 2020 6b65 7973  t)..        keys
-000325d0: 2c20 7768 6f5f 6861 732c 206e 6279 7465  , who_has, nbyte
-000325e0: 7320 3d20 6177 6169 7420 7363 6174 7465  s = await scatte
-000325f0: 725f 746f 5f77 6f72 6b65 7273 286e 7468  r_to_workers(nth
-00032600: 7265 6164 732c 2064 6174 612c 2072 7063  reads, data, rpc
-00032610: 3d73 656c 662e 7270 6329 0a0a 2020 2020  =self.rpc)..    
-00032620: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
-00032630: 6461 7461 2877 686f 5f68 6173 3d77 686f  data(who_has=who
-00032640: 5f68 6173 2c20 6e62 7974 6573 3d6e 6279  _has, nbytes=nby
-00032650: 7465 732c 2063 6c69 656e 743d 636c 6965  tes, client=clie
-00032660: 6e74 290a 0a20 2020 2020 2020 2069 6620  nt)..        if 
-00032670: 6272 6f61 6463 6173 743a 0a20 2020 2020  broadcast:.     
-00032680: 2020 2020 2020 206e 203d 206c 656e 286e         n = len(n
-00032690: 7468 7265 6164 7329 2069 6620 6272 6f61  threads) if broa
-000326a0: 6463 6173 7420 6973 2054 7275 6520 656c  dcast is True el
-000326b0: 7365 2062 726f 6164 6361 7374 0a20 2020  se broadcast.   
-000326c0: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-000326d0: 656c 662e 7265 706c 6963 6174 6528 6b65  elf.replicate(ke
-000326e0: 7973 3d6b 6579 732c 2077 6f72 6b65 7273  ys=keys, workers
-000326f0: 3d77 6f72 6b65 7273 2c20 6e3d 6e29 0a0a  =workers, n=n)..
-00032700: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00032710: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-00032720: 2020 2020 5b63 6c69 656e 742c 2022 616c      [client, "al
-00032730: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
-00032740: 2273 6361 7474 6572 222c 2022 636c 6965  "scatter", "clie
-00032750: 6e74 223a 2063 6c69 656e 742c 2022 636f  nt": client, "co
-00032760: 756e 7422 3a20 6c65 6e28 6461 7461 297d  unt": len(data)}
-00032770: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00032780: 2020 2072 6574 7572 6e20 6b65 7973 0a0a     return keys..
-00032790: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
-000327a0: 7468 6572 2873 656c 662c 206b 6579 732c  ther(self, keys,
-000327b0: 2073 6572 6961 6c69 7a65 7273 3d4e 6f6e   serializers=Non
-000327c0: 6529 3a0a 2020 2020 2020 2020 2222 2243  e):.        """C
-000327d0: 6f6c 6c65 6374 2064 6174 6120 6672 6f6d  ollect data from
-000327e0: 2077 6f72 6b65 7273 2074 6f20 7468 6520   workers to the 
-000327f0: 7363 6865 6475 6c65 7222 2222 0a20 2020  scheduler""".   
-00032800: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00032810: 203d 2066 2267 6174 6865 722d 7b74 696d   = f"gather-{tim
-00032820: 6528 297d 220a 2020 2020 2020 2020 6b65  e()}".        ke
-00032830: 7973 203d 206c 6973 7428 6b65 7973 290a  ys = list(keys).
-00032840: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
-00032850: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-00032860: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
-00032870: 2020 2020 2020 2020 2020 7473 3a20 5461            ts: Ta
-00032880: 736b 5374 6174 6520 3d20 7365 6c66 2e74  skState = self.t
-00032890: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-000328a0: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-000328b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000328c0: 2020 2020 2020 2020 2020 2020 2077 686f               who
-000328d0: 5f68 6173 5b6b 6579 5d20 3d20 5b77 732e  _has[key] = [ws.
-000328e0: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
-000328f0: 6e20 7473 2e77 686f 5f68 6173 5d0a 2020  n ts.who_has].  
-00032900: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00032910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032920: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
-00032930: 5d0a 0a20 2020 2020 2020 2064 6174 612c  ]..        data,
-00032940: 206d 6973 7369 6e67 5f6b 6579 732c 206d   missing_keys, m
-00032950: 6973 7369 6e67 5f77 6f72 6b65 7273 203d  issing_workers =
-00032960: 2061 7761 6974 2067 6174 6865 725f 6672   await gather_fr
-00032970: 6f6d 5f77 6f72 6b65 7273 280a 2020 2020  om_workers(.    
-00032980: 2020 2020 2020 2020 7768 6f5f 6861 732c          who_has,
-00032990: 2072 7063 3d73 656c 662e 7270 632c 2063   rpc=self.rpc, c
-000329a0: 6c6f 7365 3d46 616c 7365 2c20 7365 7269  lose=False, seri
-000329b0: 616c 697a 6572 733d 7365 7269 616c 697a  alizers=serializ
-000329c0: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
-000329d0: 2020 2020 2020 6966 206e 6f74 206d 6973        if not mis
-000329e0: 7369 6e67 5f6b 6579 733a 0a20 2020 2020  sing_keys:.     
-000329f0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00032a00: 7b22 7374 6174 7573 223a 2022 4f4b 222c  {"status": "OK",
-00032a10: 2022 6461 7461 223a 2064 6174 617d 0a20   "data": data}. 
-00032a20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00032a30: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
-00032a40: 5f73 7461 7465 7320 3d20 5b0a 2020 2020  _states = [.    
-00032a50: 2020 2020 2020 2020 2020 2020 2873 656c              (sel
-00032a60: 662e 7461 736b 735b 6b65 795d 2e73 7461  f.tasks[key].sta
-00032a70: 7465 2069 6620 6b65 7920 696e 2073 656c  te if key in sel
-00032a80: 662e 7461 736b 7320 656c 7365 204e 6f6e  f.tasks else Non
-00032a90: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00032aa0: 2020 2066 6f72 206b 6579 2069 6e20 6d69     for key in mi
-00032ab0: 7373 696e 675f 6b65 7973 0a20 2020 2020  ssing_keys.     
-00032ac0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00032ad0: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00032ae0: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-00032af0: 2020 2020 2020 2022 436f 756c 646e 2774         "Couldn't
-00032b00: 2067 6174 6865 7220 6b65 7973 2025 7320   gather keys %s 
-00032b10: 7374 6174 653a 2025 7320 776f 726b 6572  state: %s worker
-00032b20: 733a 2025 7322 2c0a 2020 2020 2020 2020  s: %s",.        
-00032b30: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-00032b40: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
-00032b50: 2020 2020 2020 6d69 7373 696e 675f 7374        missing_st
-00032b60: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
-00032b70: 2020 2020 2020 6d69 7373 696e 675f 776f        missing_wo
-00032b80: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
-00032b90: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00032ba0: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
-00032bb0: 7573 223a 2022 6572 726f 7222 2c20 226b  us": "error", "k
-00032bc0: 6579 7322 3a20 6d69 7373 696e 675f 6b65  eys": missing_ke
-00032bd0: 7973 7d0a 2020 2020 2020 2020 2020 2020  ys}.            
-00032be0: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
-00032bf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00032c00: 2020 2023 2052 656d 6f76 6520 7375 7370     # Remove susp
-00032c10: 6963 696f 7573 2077 6f72 6b65 7273 2066  icious workers f
-00032c20: 726f 6d20 7468 6520 7363 6865 6475 6c65  rom the schedule
-00032c30: 7220 616e 6420 7368 7574 2074 6865 6d20  r and shut them 
-00032c40: 646f 776e 2e0a 2020 2020 2020 2020 2020  down..          
-00032c50: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-00032c60: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-00032c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c80: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
-00032c90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00032ca0: 7265 6d6f 7665 5f77 6f72 6b65 7228 0a20  remove_worker(. 
-00032cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032cc0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-00032cd0: 7373 3d77 6f72 6b65 722c 2063 6c6f 7365  ss=worker, close
-00032ce0: 3d54 7275 652c 2073 7469 6d75 6c75 735f  =True, stimulus_
-00032cf0: 6964 3d73 7469 6d75 6c75 735f 6964 0a20  id=stimulus_id. 
-00032d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032d10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00032d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032d30: 2066 6f72 2077 6f72 6b65 7220 696e 206d   for worker in m
-00032d40: 6973 7369 6e67 5f77 6f72 6b65 7273 0a20  issing_workers. 
-00032d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032d60: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00032d70: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00032d80: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
-00032d90: 776f 726b 6572 7320 696e 206d 6973 7369  workers in missi
-00032da0: 6e67 5f6b 6579 732e 6974 656d 7328 293a  ng_keys.items():
-00032db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032dc0: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00032dd0: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-00032de0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00032df0: 5368 7574 2064 6f77 6e20 776f 726b 6572  Shut down worker
-00032e00: 7320 7468 6174 2064 6f6e 2774 2068 6176  s that don't hav
-00032e10: 6520 7072 6f6d 6973 6564 206b 6579 3a20  e promised key: 
-00032e20: 2573 2c20 2573 222c 0a20 2020 2020 2020  %s, %s",.       
-00032e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e40: 2073 7472 2877 6f72 6b65 7273 292c 0a20   str(workers),. 
-00032e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e60: 2020 2020 2020 2073 7472 286b 6579 292c         str(key),
-00032e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032e80: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00032e90: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2822  self.log_event("
-00032ea0: 616c 6c22 2c20 7b22 6163 7469 6f6e 223a  all", {"action":
-00032eb0: 2022 6761 7468 6572 222c 2022 636f 756e   "gather", "coun
-00032ec0: 7422 3a20 6c65 6e28 6b65 7973 297d 290a  t": len(keys)}).
-00032ed0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00032ee0: 6573 756c 740a 0a20 2020 2040 6c6f 675f  esult..    @log_
-00032ef0: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-00032f00: 2064 6566 2072 6573 7461 7274 2873 656c   def restart(sel
-00032f10: 662c 2063 6c69 656e 743d 4e6f 6e65 2c20  f, client=None, 
-00032f20: 7469 6d65 6f75 743d 3330 2c20 7761 6974  timeout=30, wait
-00032f30: 5f66 6f72 5f77 6f72 6b65 7273 3d54 7275  _for_workers=Tru
-00032f40: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
-00032f50: 2020 2020 2020 2020 5265 7374 6172 7420          Restart 
-00032f60: 616c 6c20 776f 726b 6572 732e 2052 6573  all workers. Res
-00032f70: 6574 206c 6f63 616c 2073 7461 7465 2e20  et local state. 
-00032f80: 4f70 7469 6f6e 616c 6c79 2077 6169 7420  Optionally wait 
-00032f90: 666f 7220 776f 726b 6572 7320 746f 2072  for workers to r
-00032fa0: 6574 7572 6e2e 0a0a 2020 2020 2020 2020  eturn...        
-00032fb0: 576f 726b 6572 7320 7769 7468 6f75 7420  Workers without 
-00032fc0: 6e61 6e6e 6965 7320 6172 6520 7368 7574  nannies are shut
-00032fd0: 2064 6f77 6e2c 2068 6f70 696e 6720 616e   down, hoping an
-00032fe0: 2065 7874 6572 6e61 6c20 6465 706c 6f79   external deploy
-00032ff0: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
-00033000: 2020 2020 7769 6c6c 2072 6573 7461 7274      will restart
-00033010: 2074 6865 6d2e 2054 6865 7265 666f 7265   them. Therefore
-00033020: 2c20 6966 206e 6f74 2075 7369 6e67 206e  , if not using n
-00033030: 616e 6e69 6573 2061 6e64 2079 6f75 7220  annies and your 
-00033040: 6465 706c 6f79 6d65 6e74 2073 7973 7465  deployment syste
-00033050: 6d0a 2020 2020 2020 2020 646f 6573 206e  m.        does n
-00033060: 6f74 2061 7574 6f6d 6174 6963 616c 6c79  ot automatically
-00033070: 2072 6573 7461 7274 2077 6f72 6b65 7273   restart workers
-00033080: 2c20 6060 7265 7374 6172 7460 6020 7769  , ``restart`` wi
-00033090: 6c6c 206a 7573 7420 7368 7574 2064 6f77  ll just shut dow
-000330a0: 6e20 616c 6c0a 2020 2020 2020 2020 776f  n all.        wo
-000330b0: 726b 6572 732c 2074 6865 6e20 7469 6d65  rkers, then time
-000330c0: 206f 7574 210a 0a20 2020 2020 2020 2041   out!..        A
-000330d0: 6674 6572 2060 6072 6573 7461 7274 6060  fter ``restart``
-000330e0: 2c20 616c 6c20 636f 6e6e 6563 7465 6420  , all connected 
-000330f0: 776f 726b 6572 7320 6172 6520 6e65 772c  workers are new,
-00033100: 2072 6567 6172 646c 6573 7320 6f66 2077   regardless of w
-00033110: 6865 7468 6572 2060 6054 696d 656f 7574  hether ``Timeout
-00033120: 4572 726f 7260 600a 2020 2020 2020 2020  Error``.        
-00033130: 7761 7320 7261 6973 6564 2e20 416e 7920  was raised. Any 
-00033140: 776f 726b 6572 7320 7468 6174 2066 6169  workers that fai
-00033150: 6c65 6420 746f 2073 6875 7420 646f 776e  led to shut down
-00033160: 2069 6e20 7469 6d65 2061 7265 2072 656d   in time are rem
-00033170: 6f76 6564 2c20 616e 640a 2020 2020 2020  oved, and.      
-00033180: 2020 6d61 7920 6f72 206d 6179 206e 6f74    may or may not
-00033190: 2073 6875 7420 646f 776e 206f 6e20 7468   shut down on th
-000331a0: 6569 7220 6f77 6e20 696e 2074 6865 2066  eir own in the f
-000331b0: 7574 7572 652e 0a0a 2020 2020 2020 2020  uture...        
-000331c0: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
-000331d0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-000331e0: 2020 2020 2020 7469 6d65 6f75 743a 0a20        timeout:. 
-000331f0: 2020 2020 2020 2020 2020 2048 6f77 206c             How l
-00033200: 6f6e 6720 746f 2077 6169 7420 666f 7220  ong to wait for 
-00033210: 776f 726b 6572 7320 746f 2073 6875 7420  workers to shut 
-00033220: 646f 776e 2061 6e64 2063 6f6d 6520 6261  down and come ba
-00033230: 636b 2c20 6966 2060 6077 6169 745f 666f  ck, if ``wait_fo
-00033240: 725f 776f 726b 6572 7360 600a 2020 2020  r_workers``.    
-00033250: 2020 2020 2020 2020 6973 2054 7275 652c          is True,
-00033260: 206f 7468 6572 7769 7365 206a 7573 7420   otherwise just 
-00033270: 686f 7720 6c6f 6e67 2074 6f20 7761 6974  how long to wait
-00033280: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
-00033290: 7368 7574 2064 6f77 6e2e 0a20 2020 2020  shut down..     
-000332a0: 2020 2020 2020 2052 6169 7365 7320 6060         Raises ``
-000332b0: 6173 796e 6369 6f2e 5469 6d65 6f75 7445  asyncio.TimeoutE
-000332c0: 7272 6f72 6060 2069 6620 7468 6973 2069  rror`` if this i
-000332d0: 7320 6578 6365 6564 6564 2e0a 2020 2020  s exceeded..    
-000332e0: 2020 2020 7761 6974 5f66 6f72 5f77 6f72      wait_for_wor
-000332f0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-00033300: 2020 5768 6574 6865 7220 746f 2077 6169    Whether to wai
-00033310: 7420 666f 7220 616c 6c20 776f 726b 6572  t for all worker
-00033320: 7320 746f 2072 6563 6f6e 6e65 6374 2c20  s to reconnect, 
-00033330: 6f72 206a 7573 7420 666f 7220 7468 656d  or just for them
-00033340: 2074 6f20 7368 7574 2064 6f77 6e0a 2020   to shut down.  
-00033350: 2020 2020 2020 2020 2020 2864 6566 6175            (defau
-00033360: 6c74 2054 7275 6529 2e20 5573 6520 6060  lt True). Use ``
-00033370: 7265 7374 6172 7428 7761 6974 5f66 6f72  restart(wait_for
-00033380: 5f77 6f72 6b65 7273 3d46 616c 7365 2960  _workers=False)`
-00033390: 6020 636f 6d62 696e 6564 2077 6974 680a  ` combined with.
-000333a0: 2020 2020 2020 2020 2020 2020 3a6d 6574              :met
-000333b0: 683a 6043 6c69 656e 742e 7761 6974 5f66  h:`Client.wait_f
-000333c0: 6f72 5f77 6f72 6b65 7273 6020 666f 7220  or_workers` for 
-000333d0: 6772 616e 756c 6172 2063 6f6e 7472 6f6c  granular control
-000333e0: 206f 7665 7220 686f 7720 6d61 6e79 2077   over how many w
-000333f0: 6f72 6b65 7273 2074 6f0a 2020 2020 2020  orkers to.      
-00033400: 2020 2020 2020 7761 6974 2066 6f72 2e0a        wait for..
-00033410: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-00033420: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-00033430: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
-00033440: 742e 7265 7374 6172 740a 2020 2020 2020  t.restart.      
-00033450: 2020 436c 6965 6e74 2e72 6573 7461 7274    Client.restart
-00033460: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-00033470: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
-00033480: 6d75 6c75 735f 6964 203d 2066 2272 6573  mulus_id = f"res
-00033490: 7461 7274 2d7b 7469 6d65 2829 7d22 0a0a  tart-{time()}"..
-000334a0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-000334b0: 6e66 6f28 2252 6573 7461 7274 696e 6720  nfo("Restarting 
-000334c0: 776f 726b 6572 7320 616e 6420 7265 6c65  workers and rele
-000334d0: 6173 696e 6720 616c 6c20 6b65 7973 2e22  asing all keys."
-000334e0: 290a 2020 2020 2020 2020 666f 7220 6373  ).        for cs
-000334f0: 2069 6e20 7365 6c66 2e63 6c69 656e 7473   in self.clients
-00033500: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-00033510: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00033520: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
-00033530: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00033540: 2020 6b65 7973 3d5b 7473 2e6b 6579 2066    keys=[ts.key f
-00033550: 6f72 2074 7320 696e 2063 732e 7761 6e74  or ts in cs.want
-00033560: 735f 7768 6174 5d2c 0a20 2020 2020 2020  s_what],.       
-00033570: 2020 2020 2020 2020 2063 6c69 656e 743d           client=
-00033580: 6373 2e63 6c69 656e 745f 6b65 792c 0a20  cs.client_key,. 
-00033590: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000335a0: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-000335b0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-000335c0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-000335d0: 656c 662e 5f63 6c65 6172 5f74 6173 6b5f  elf._clear_task_
-000335e0: 7374 6174 6528 290a 2020 2020 2020 2020  state().        
-000335f0: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
-00033600: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
-00033610: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
-00033620: 2022 7265 7374 6172 7422 7d29 0a0a 2020   "restart"})..  
-00033630: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
-00033640: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-00033650: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
-00033660: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00033670: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00033680: 2020 706c 7567 696e 2e72 6573 7461 7274    plugin.restart
-00033690: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
-000336a0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000336b0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-000336c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000336d0: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-000336e0: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
-000336f0: 203d 206c 656e 2873 656c 662e 776f 726b   = len(self.work
-00033700: 6572 7329 0a20 2020 2020 2020 206e 616e  ers).        nan
-00033710: 6e79 5f77 6f72 6b65 7273 203d 207b 0a20  ny_workers = {. 
-00033720: 2020 2020 2020 2020 2020 2061 6464 723a             addr:
-00033730: 2077 732e 6e61 6e6e 7920 666f 7220 6164   ws.nanny for ad
-00033740: 6472 2c20 7773 2069 6e20 7365 6c66 2e77  dr, ws in self.w
-00033750: 6f72 6b65 7273 2e69 7465 6d73 2829 2069  orkers.items() i
-00033760: 6620 7773 2e6e 616e 6e79 0a20 2020 2020  f ws.nanny.     
-00033770: 2020 207d 0a20 2020 2020 2020 2023 2043     }.        # C
-00033780: 6c6f 7365 206e 6f6e 2d4e 616e 6e79 2077  lose non-Nanny w
-00033790: 6f72 6b65 7273 2e20 5765 2068 6176 6520  orkers. We have 
-000337a0: 6e6f 2077 6179 2074 6f20 7265 7374 6172  no way to restar
-000337b0: 7420 7468 656d 2c20 736f 2077 6520 6a75  t them, so we ju
-000337c0: 7374 206c 6574 2074 6865 6d20 676f 2c0a  st let them go,.
-000337d0: 2020 2020 2020 2020 2320 616e 6420 6173          # and as
-000337e0: 7375 6d65 2061 2064 6570 6c6f 796d 656e  sume a deploymen
-000337f0: 7420 7379 7374 656d 2069 7320 676f 696e  t system is goin
-00033800: 6720 746f 2072 6573 7461 7274 2074 6865  g to restart the
-00033810: 6d20 666f 7220 7573 2e0a 2020 2020 2020  m for us..      
-00033820: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-00033830: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00033840: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
-00033850: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-00033860: 7665 5f77 6f72 6b65 7228 6164 6472 6573  ve_worker(addres
-00033870: 733d 6164 6472 2c20 7374 696d 756c 7573  s=addr, stimulus
-00033880: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
-00033890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000338a0: 2066 6f72 2061 6464 7220 696e 2073 656c   for addr in sel
-000338b0: 662e 776f 726b 6572 730a 2020 2020 2020  f.workers.      
-000338c0: 2020 2020 2020 2020 2020 6966 2061 6464            if add
-000338d0: 7220 6e6f 7420 696e 206e 616e 6e79 5f77  r not in nanny_w
-000338e0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-000338f0: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
-00033900: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-00033910: 6562 7567 2822 5365 6e64 206b 696c 6c20  ebug("Send kill 
-00033920: 7369 676e 616c 2074 6f20 6e61 6e6e 6965  signal to nannie
-00033930: 733a 2025 7322 2c20 6e61 6e6e 795f 776f  s: %s", nanny_wo
-00033940: 726b 6572 7329 0a20 2020 2020 2020 2061  rkers).        a
-00033950: 7379 6e63 2077 6974 6820 636f 6e74 6578  sync with contex
-00033960: 746c 6962 2e41 7379 6e63 4578 6974 5374  tlib.AsyncExitSt
-00033970: 6163 6b28 2920 6173 2073 7461 636b 3a0a  ack() as stack:.
-00033980: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
-00033990: 6965 7320 3d20 6177 6169 7420 6173 796e  ies = await asyn
-000339a0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-000339b0: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
-000339c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000339d0: 2020 2073 7461 636b 2e65 6e74 6572 5f61     stack.enter_a
-000339e0: 7379 6e63 5f63 6f6e 7465 7874 280a 2020  sync_context(.  
-000339f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033a00: 2020 2020 2020 7270 6328 6e61 6e6e 795f        rpc(nanny_
-00033a10: 6164 6472 6573 732c 2063 6f6e 6e65 6374  address, connect
-00033a20: 696f 6e5f 6172 6773 3d73 656c 662e 636f  ion_args=self.co
-00033a30: 6e6e 6563 7469 6f6e 5f61 7267 7329 0a20  nnection_args). 
-00033a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033a50: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00033a60: 2020 2020 2020 2020 2066 6f72 206e 616e           for nan
-00033a70: 6e79 5f61 6464 7265 7373 2069 6e20 6e61  ny_address in na
-00033a80: 6e6e 795f 776f 726b 6572 732e 7661 6c75  nny_workers.valu
-00033a90: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-00033aa0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00033ab0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00033ac0: 2020 7374 6172 7420 3d20 6d6f 6e6f 746f    start = monoto
-00033ad0: 6e69 6328 290a 2020 2020 2020 2020 2020  nic().          
-00033ae0: 2020 7265 7370 7320 3d20 6177 6169 7420    resps = await 
-00033af0: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-00033b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033b10: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
-00033b20: 2020 2020 2020 2077 6169 745f 666f 7228         wait_for(
-00033b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033b40: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-00033b50: 2064 6f65 7320 6e6f 7420 7261 6973 6520   does not raise 
-00033b60: 6966 2074 6865 2070 726f 6365 7373 2066  if the process f
-00033b70: 6169 6c73 2074 6f20 7368 7574 2064 6f77  ails to shut dow
-00033b80: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-00033b90: 2020 2020 2020 2020 2020 2023 2073 6565             # see
-00033ba0: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-00033bb0: 636f 6d2f 6461 736b 2f64 6973 7472 6962  com/dask/distrib
-00033bc0: 7574 6564 2f70 756c 6c2f 3634 3237 2f66  uted/pull/6427/f
-00033bd0: 696c 6573 2372 3839 3439 3137 3432 340a  iles#r894917424.
-00033be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033bf0: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
-00033c00: 4e61 6e6e 7920 7769 6c6c 2061 7574 6f6d  Nanny will autom
-00033c10: 6174 6963 616c 6c79 2072 6573 7461 7274  atically restart
-00033c20: 2077 6f72 6b65 7220 7072 6f63 6573 7320   worker process 
-00033c30: 7768 656e 2069 7427 7320 6b69 6c6c 6564  when it's killed
-00033c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033c50: 2020 2020 2020 2020 206e 616e 6e79 2e6b           nanny.k
-00033c60: 696c 6c28 0a20 2020 2020 2020 2020 2020  ill(.           
-00033c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033c80: 2072 6561 736f 6e3d 2273 6368 6564 756c   reason="schedul
-00033c90: 6572 2d72 6573 7461 7274 222c 0a20 2020  er-restart",.   
-00033ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033cb0: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
-00033cc0: 3d74 696d 656f 7574 2c0a 2020 2020 2020  =timeout,.      
-00033cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ce0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00033cf0: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-00033d00: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
-00033d10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00033d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033d30: 666f 7220 6e61 6e6e 7920 696e 206e 616e  for nanny in nan
-00033d40: 6e69 6573 0a20 2020 2020 2020 2020 2020  nies.           
-00033d50: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00033d60: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
-00033d70: 7863 6570 7469 6f6e 733d 5472 7565 2c0a  xceptions=True,.
-00033d80: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00033d90: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-00033da0: 3a20 7468 6520 6057 6f72 6b65 7253 7461  : the `WorkerSta
-00033db0: 7465 6020 656e 7472 6965 7320 666f 7220  te` entries for 
-00033dc0: 7468 6573 6520 776f 726b 6572 7320 7769  these workers wi
-00033dd0: 6c6c 2062 6520 7265 6d6f 7665 640a 2020  ll be removed.  
-00033de0: 2020 2020 2020 2020 2020 2320 6e61 7475            # natu
-00033df0: 7261 6c6c 7920 7768 656e 2074 6865 7920  rally when they 
-00033e00: 6469 7363 6f6e 6e65 6374 2066 726f 6d20  disconnect from 
-00033e10: 7468 6520 7363 6865 6475 6c65 722e 0a0a  the scheduler...
-00033e20: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-00033e30: 6d6f 7665 2061 6e79 2077 6f72 6b65 7273  move any workers
-00033e40: 2074 6861 7420 6661 696c 6564 2074 6f20   that failed to 
-00033e50: 7368 7574 2064 6f77 6e2c 2073 6f20 7765  shut down, so we
-00033e60: 2063 616e 2067 7561 7261 6e74 6565 0a20   can guarantee. 
-00033e70: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
-00033e80: 7420 6166 7465 7220 6072 6573 7461 7274  t after `restart
-00033e90: 602c 2074 6865 7265 2061 7265 206e 6f20  `, there are no 
-00033ea0: 6f6c 6420 776f 726b 6572 7320 6172 6f75  old workers arou
-00033eb0: 6e64 2e0a 2020 2020 2020 2020 2020 2020  nd..            
-00033ec0: 6261 645f 6e61 6e6e 6965 7320 3d20 5b0a  bad_nannies = [.
+0002fb20: 6e79 0a20 2020 2029 202d 3e20 4e6f 6e65  ny.    ) -> None
+0002fb30: 3a0a 2020 2020 2020 2020 6966 2077 6f72  :.        if wor
+0002fb40: 6b65 7220 6e6f 7420 696e 2073 656c 662e  ker not in self.
+0002fb50: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0002fb60: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0002fb70: 2020 2020 7661 6c69 6461 7465 5f6b 6579      validate_key
+0002fb80: 286b 6579 290a 0a20 2020 2020 2020 2072  (key)..        r
+0002fb90: 3a20 7475 706c 6520 3d20 7365 6c66 2e73  : tuple = self.s
+0002fba0: 7469 6d75 6c75 735f 7461 736b 5f66 696e  timulus_task_fin
+0002fbb0: 6973 6865 6428 0a20 2020 2020 2020 2020  ished(.         
+0002fbc0: 2020 206b 6579 3d6b 6579 2c20 776f 726b     key=key, work
+0002fbd0: 6572 3d77 6f72 6b65 722c 2073 7469 6d75  er=worker, stimu
+0002fbe0: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+0002fbf0: 6964 2c20 2a2a 6d73 670a 2020 2020 2020  id, **msg.      
+0002fc00: 2020 290a 2020 2020 2020 2020 7265 636f    ).        reco
+0002fc10: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+0002fc20: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+0002fc30: 5f6d 7367 7320 3d20 720a 2020 2020 2020  _msgs = r.      
+0002fc40: 2020 7365 6c66 2e5f 7472 616e 7369 7469    self._transiti
+0002fc50: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
+0002fc60: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+0002fc70: 2c20 776f 726b 6572 5f6d 7367 732c 2073  , worker_msgs, s
+0002fc80: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
+0002fc90: 2020 2020 7365 6c66 2e73 656e 645f 616c      self.send_al
+0002fca0: 6c28 636c 6965 6e74 5f6d 7367 732c 2077  l(client_msgs, w
+0002fcb0: 6f72 6b65 725f 6d73 6773 290a 0a20 2020  orker_msgs)..   
+0002fcc0: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
+0002fcd0: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
+0002fce0: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
+0002fcf0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+0002fd00: 5f69 6429 0a0a 2020 2020 6465 6620 6861  _id)..    def ha
+0002fd10: 6e64 6c65 5f74 6173 6b5f 6572 7265 6428  ndle_task_erred(
+0002fd20: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+0002fd30: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+0002fd40: 2c20 2a2a 6d73 673a 2041 6e79 2920 2d3e  , **msg: Any) ->
+0002fd50: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
+0002fd60: 3a20 7475 706c 6520 3d20 7365 6c66 2e73  : tuple = self.s
+0002fd70: 7469 6d75 6c75 735f 7461 736b 5f65 7272  timulus_task_err
+0002fd80: 6564 286b 6579 3d6b 6579 2c20 7374 696d  ed(key=key, stim
+0002fd90: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+0002fda0: 5f69 642c 202a 2a6d 7367 290a 2020 2020  _id, **msg).    
+0002fdb0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0002fdc0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+0002fdd0: 2c20 776f 726b 6572 5f6d 7367 7320 3d20  , worker_msgs = 
+0002fde0: 720a 2020 2020 2020 2020 7365 6c66 2e5f  r.        self._
+0002fdf0: 7472 616e 7369 7469 6f6e 7328 7265 636f  transitions(reco
+0002fe00: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+0002fe10: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+0002fe20: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
+0002fe30: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
+0002fe40: 2e73 656e 645f 616c 6c28 636c 6965 6e74  .send_all(client
+0002fe50: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+0002fe60: 6773 290a 0a20 2020 2020 2020 2073 656c  gs)..        sel
+0002fe70: 662e 7374 696d 756c 7573 5f71 7565 7565  f.stimulus_queue
+0002fe80: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
+0002fe90: 6e65 6428 7374 696d 756c 7573 5f69 643d  ned(stimulus_id=
+0002fea0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+0002feb0: 2020 6465 6620 7265 6c65 6173 655f 776f    def release_wo
+0002fec0: 726b 6572 5f64 6174 6128 7365 6c66 2c20  rker_data(self, 
+0002fed0: 6b65 793a 2073 7472 2c20 776f 726b 6572  key: str, worker
+0002fee0: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
+0002fef0: 6964 3a20 7374 7229 202d 3e20 4e6f 6e65  id: str) -> None
+0002ff00: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+0002ff10: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+0002ff20: 7929 0a20 2020 2020 2020 2077 7320 3d20  y).        ws = 
+0002ff30: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
+0002ff40: 2877 6f72 6b65 7229 0a20 2020 2020 2020  (worker).       
+0002ff50: 2069 6620 6e6f 7420 7473 206f 7220 6e6f   if not ts or no
+0002ff60: 7420 7773 206f 7220 7773 206e 6f74 2069  t ws or ws not i
+0002ff70: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+0002ff80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002ff90: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+0002ffa0: 656d 6f76 655f 7265 706c 6963 6128 7473  emove_replica(ts
+0002ffb0: 2c20 7773 290a 2020 2020 2020 2020 6966  , ws).        if
+0002ffc0: 206e 6f74 2074 732e 7768 6f5f 6861 733a   not ts.who_has:
+0002ffd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002ffe0: 662e 7472 616e 7369 7469 6f6e 7328 7b6b  f.transitions({k
+0002fff0: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
+00030000: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
+00030010: 2020 2064 6566 2068 616e 646c 655f 6c6f     def handle_lo
+00030020: 6e67 5f72 756e 6e69 6e67 280a 2020 2020  ng_running(.    
+00030030: 2020 2020 7365 6c66 2c20 6b65 793a 2073      self, key: s
+00030040: 7472 2c20 776f 726b 6572 3a20 7374 722c  tr, worker: str,
+00030050: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
+00030060: 6e3a 2066 6c6f 6174 207c 204e 6f6e 652c  n: float | None,
+00030070: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00030080: 720a 2020 2020 2920 2d3e 204e 6f6e 653a  r.    ) -> None:
+00030090: 0a20 2020 2020 2020 2022 2222 4120 7461  .        """A ta
+000300a0: 736b 2068 6173 2073 6563 6564 6564 2066  sk has seceded f
+000300b0: 726f 6d20 7468 6520 7468 7265 6164 2070  rom the thread p
+000300c0: 6f6f 6c0a 0a20 2020 2020 2020 2057 6520  ool..        We 
+000300d0: 7374 6f70 2074 6865 2074 6173 6b20 6672  stop the task fr
+000300e0: 6f6d 2062 6569 6e67 2073 746f 6c65 6e20  om being stolen 
+000300f0: 696e 2074 6865 2066 7574 7572 652c 2061  in the future, a
+00030100: 6e64 2063 6861 6e67 6520 7461 736b 0a20  nd change task. 
+00030110: 2020 2020 2020 2064 7572 6174 696f 6e20         duration 
+00030120: 6163 636f 756e 7469 6e67 2061 7320 6966  accounting as if
+00030130: 2074 6865 2074 6173 6b20 6861 7320 7374   the task has st
+00030140: 6f70 7065 642e 0a20 2020 2020 2020 2022  opped..        "
+00030150: 2222 0a20 2020 2020 2020 2069 6620 6b65  "".        if ke
+00030160: 7920 6e6f 7420 696e 2073 656c 662e 7461  y not in self.ta
+00030170: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00030180: 206c 6f67 6765 722e 6465 6275 6728 2253   logger.debug("S
+00030190: 6b69 7070 696e 6720 6c6f 6e67 5f72 756e  kipping long_run
+000301a0: 6e69 6e67 2073 696e 6365 206b 6579 2025  ning since key %
+000301b0: 7320 7761 7320 616c 7265 6164 7920 7265  s was already re
+000301c0: 6c65 6173 6564 222c 206b 6579 290a 2020  leased", key).  
+000301d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000301e0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+000301f0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+00030200: 2020 2020 2020 7374 6561 6c20 3d20 7365        steal = se
+00030210: 6c66 2e65 7874 656e 7369 6f6e 732e 6765  lf.extensions.ge
+00030220: 7428 2273 7465 616c 696e 6722 290a 2020  t("stealing").  
+00030230: 2020 2020 2020 6966 2073 7465 616c 2069        if steal i
+00030240: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00030250: 2020 2020 2020 2020 7374 6561 6c2e 7265          steal.re
+00030260: 6d6f 7665 5f6b 6579 5f66 726f 6d5f 7374  move_key_from_st
+00030270: 6561 6c61 626c 6528 7473 290a 0a20 2020  ealable(ts)..   
+00030280: 2020 2020 2077 7320 3d20 7473 2e70 726f       ws = ts.pro
+00030290: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+000302a0: 2020 2069 6620 7773 2069 7320 4e6f 6e65     if ws is None
+000302b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000302c0: 6767 6572 2e64 6562 7567 2822 5265 6365  gger.debug("Rece
+000302d0: 6976 6564 206c 6f6e 672d 7275 6e6e 696e  ived long-runnin
+000302e0: 6720 7369 676e 616c 2066 726f 6d20 6475  g signal from du
+000302f0: 706c 6963 6174 6520 7461 736b 2e20 4967  plicate task. Ig
+00030300: 6e6f 7269 6e67 2e22 290a 2020 2020 2020  noring.").      
+00030310: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00030320: 2020 2020 2020 6966 2063 6f6d 7075 7465        if compute
+00030330: 5f64 7572 6174 696f 6e20 6973 206e 6f74  _duration is not
+00030340: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00030350: 2020 206f 6c64 5f64 7572 6174 696f 6e20     old_duration 
+00030360: 3d20 7473 2e70 7265 6669 782e 6475 7261  = ts.prefix.dura
+00030370: 7469 6f6e 5f61 7665 7261 6765 0a20 2020  tion_average.   
+00030380: 2020 2020 2020 2020 2069 6620 6f6c 645f           if old_
+00030390: 6475 7261 7469 6f6e 203c 2030 3a0a 2020  duration < 0:.  
+000303a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+000303b0: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
+000303c0: 5f61 7665 7261 6765 203d 2063 6f6d 7075  _average = compu
+000303d0: 7465 5f64 7572 6174 696f 6e0a 2020 2020  te_duration.    
+000303e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000303f0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00030400: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
+00030410: 5f61 7665 7261 6765 203d 2028 6f6c 645f  _average = (old_
+00030420: 6475 7261 7469 6f6e 202b 2063 6f6d 7075  duration + compu
+00030430: 7465 5f64 7572 6174 696f 6e29 202f 2032  te_duration) / 2
+00030440: 0a0a 2020 2020 2020 2020 7773 2e61 6464  ..        ws.add
+00030450: 5f74 6f5f 6c6f 6e67 5f72 756e 6e69 6e67  _to_long_running
+00030460: 2874 7329 0a20 2020 2020 2020 2073 656c  (ts).        sel
+00030470: 662e 6368 6563 6b5f 6964 6c65 5f73 6174  f.check_idle_sat
+00030480: 7572 6174 6564 2877 7329 0a0a 2020 2020  urated(ws)..    
+00030490: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
+000304a0: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
+000304b0: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
+000304c0: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+000304d0: 6964 290a 0a20 2020 2064 6566 2068 616e  id)..    def han
+000304e0: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
+000304f0: 735f 6368 616e 6765 280a 2020 2020 2020  s_change(.      
+00030500: 2020 7365 6c66 2c20 7374 6174 7573 3a20    self, status: 
+00030510: 7374 7220 7c20 5374 6174 7573 2c20 776f  str | Status, wo
+00030520: 726b 6572 3a20 7374 7220 7c20 576f 726b  rker: str | Work
+00030530: 6572 5374 6174 652c 2073 7469 6d75 6c75  erState, stimulu
+00030540: 735f 6964 3a20 7374 720a 2020 2020 2920  s_id: str.    ) 
+00030550: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00030560: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
+00030570: 7273 2e67 6574 2877 6f72 6b65 7229 2069  rs.get(worker) i
+00030580: 6620 6973 696e 7374 616e 6365 2877 6f72  f isinstance(wor
+00030590: 6b65 722c 2073 7472 2920 656c 7365 2077  ker, str) else w
+000305a0: 6f72 6b65 720a 2020 2020 2020 2020 6966  orker.        if
+000305b0: 206e 6f74 2077 733a 0a20 2020 2020 2020   not ws:.       
+000305c0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+000305d0: 2020 2020 7072 6576 5f73 7461 7475 7320      prev_status 
+000305e0: 3d20 7773 2e73 7461 7475 730a 2020 2020  = ws.status.    
+000305f0: 2020 2020 7773 2e73 7461 7475 7320 3d20      ws.status = 
+00030600: 5374 6174 7573 5b73 7461 7475 735d 2069  Status[status] i
+00030610: 6620 6973 696e 7374 616e 6365 2873 7461  f isinstance(sta
+00030620: 7475 732c 2073 7472 2920 656c 7365 2073  tus, str) else s
+00030630: 7461 7475 730a 2020 2020 2020 2020 6966  tatus.        if
+00030640: 2077 732e 7374 6174 7573 203d 3d20 7072   ws.status == pr
+00030650: 6576 5f73 7461 7475 733a 0a20 2020 2020  ev_status:.     
+00030660: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00030670: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+00030680: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
+00030690: 2020 2077 732e 6164 6472 6573 732c 0a20     ws.address,. 
+000306a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000306b0: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
+000306c0: 7469 6f6e 223a 2022 776f 726b 6572 2d73  tion": "worker-s
+000306d0: 7461 7475 732d 6368 616e 6765 222c 0a20  tatus-change",. 
+000306e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000306f0: 7072 6576 2d73 7461 7475 7322 3a20 7072  prev-status": pr
+00030700: 6576 5f73 7461 7475 732e 6e61 6d65 2c0a  ev_status.name,.
+00030710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030720: 2273 7461 7475 7322 3a20 7773 2e73 7461  "status": ws.sta
+00030730: 7475 732e 6e61 6d65 2c0a 2020 2020 2020  tus.name,.      
+00030740: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00030750: 2029 0a20 2020 2020 2020 206c 6f67 6765   ).        logge
+00030760: 722e 6465 6275 6728 6622 576f 726b 6572  r.debug(f"Worker
+00030770: 2073 7461 7475 7320 7b70 7265 765f 7374   status {prev_st
+00030780: 6174 7573 2e6e 616d 657d 202d 3e20 7b73  atus.name} -> {s
+00030790: 7461 7475 737d 202d 207b 7773 7d22 290a  tatus} - {ws}").
+000307a0: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
+000307b0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+000307c0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+000307d0: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
+000307e0: 672e 6164 6428 7773 290a 2020 2020 2020  g.add(ws).      
+000307f0: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
+00030800: 5f69 646c 655f 7361 7475 7261 7465 6428  _idle_saturated(
+00030810: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
+00030820: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
+00030830: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00030840: 2020 7365 6c66 2e62 756c 6b5f 7363 6865    self.bulk_sche
+00030850: 6475 6c65 5f75 6e72 756e 6e61 626c 655f  dule_unrunnable_
+00030860: 6166 7465 725f 6164 6469 6e67 5f77 6f72  after_adding_wor
+00030870: 6b65 7228 7773 292c 2073 7469 6d75 6c75  ker(ws), stimulu
+00030880: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
+00030890: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+000308a0: 656c 662e 7374 696d 756c 7573 5f71 7565  elf.stimulus_que
+000308b0: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
+000308c0: 7065 6e65 6428 7374 696d 756c 7573 5f69  pened(stimulus_i
+000308d0: 643d 7374 696d 756c 7573 5f69 6429 0a20  d=stimulus_id). 
+000308e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000308f0: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
+00030900: 6e6e 696e 672e 6469 7363 6172 6428 7773  nning.discard(ws
+00030910: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00030920: 6c66 2e69 646c 652e 706f 7028 7773 2e61  lf.idle.pop(ws.a
+00030930: 6464 7265 7373 2c20 4e6f 6e65 290a 2020  ddress, None).  
+00030940: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+00030950: 646c 655f 7461 736b 5f63 6f75 6e74 2e64  dle_task_count.d
+00030960: 6973 6361 7264 2877 7329 0a20 2020 2020  iscard(ws).     
+00030970: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
+00030980: 7261 7465 642e 6469 7363 6172 6428 7773  rated.discard(ws
+00030990: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+000309a0: 2068 616e 646c 655f 7265 7175 6573 745f   handle_request_
+000309b0: 7265 6672 6573 685f 7768 6f5f 6861 7328  refresh_who_has(
+000309c0: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
+000309d0: 6579 733a 2049 7465 7261 626c 655b 7374  eys: Iterable[st
+000309e0: 725d 2c20 776f 726b 6572 3a20 7374 722c  r], worker: str,
+000309f0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00030a00: 720a 2020 2020 2920 2d3e 204e 6f6e 653a  r.    ) -> None:
+00030a10: 0a20 2020 2020 2020 2022 2222 4173 796e  .        """Asyn
+00030a20: 6368 726f 6e6f 7573 2072 6571 7565 7374  chronous request
+00030a30: 2028 7468 726f 7567 6820 6275 6c6b 2063   (through bulk c
+00030a40: 6f6d 6d73 2920 6672 6f6d 2061 2057 6f72  omms) from a Wor
+00030a50: 6b65 7220 746f 2072 6566 7265 7368 2074  ker to refresh t
+00030a60: 6865 0a20 2020 2020 2020 2077 686f 5f68  he.        who_h
+00030a70: 6173 2066 6f72 2073 6f6d 6520 6b65 7973  as for some keys
+00030a80: 2e20 4e6f 7420 746f 2062 6520 636f 6e66  . Not to be conf
+00030a90: 7573 6564 2077 6974 6820 7363 6865 6475  used with schedu
+00030aa0: 6c65 722e 7768 6f5f 6861 732c 2077 6869  ler.who_has, whi
+00030ab0: 6368 2069 7320 610a 2020 2020 2020 2020  ch is a.        
+00030ac0: 7379 6e63 6872 6f6e 6f75 7320 5250 4320  synchronous RPC 
+00030ad0: 7265 7175 6573 7420 6672 6f6d 2061 2043  request from a C
+00030ae0: 6c69 656e 742e 0a20 2020 2020 2020 2022  lient..        "
+00030af0: 2222 0a20 2020 2020 2020 2077 686f 5f68  "".        who_h
+00030b00: 6173 203d 207b 7d0a 2020 2020 2020 2020  as = {}.        
+00030b10: 6672 6565 5f6b 6579 7320 3d20 5b5d 0a20  free_keys = []. 
+00030b20: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00030b30: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00030b40: 2020 2020 6966 206b 6579 2069 6e20 7365      if key in se
+00030b50: 6c66 2e74 6173 6b73 3a0a 2020 2020 2020  lf.tasks:.      
+00030b60: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
+00030b70: 735b 6b65 795d 203d 205b 7773 2e61 6464  s[key] = [ws.add
+00030b80: 7265 7373 2066 6f72 2077 7320 696e 2073  ress for ws in s
+00030b90: 656c 662e 7461 736b 735b 6b65 795d 2e77  elf.tasks[key].w
+00030ba0: 686f 5f68 6173 5d0a 2020 2020 2020 2020  ho_has].        
+00030bb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030bc0: 2020 2020 2020 2020 2020 6672 6565 5f6b            free_k
+00030bd0: 6579 732e 6170 7065 6e64 286b 6579 290a  eys.append(key).
+00030be0: 0a20 2020 2020 2020 2069 6620 7768 6f5f  .        if who_
+00030bf0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+00030c00: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
+00030c10: 6d73 5b77 6f72 6b65 725d 2e73 656e 6428  ms[worker].send(
+00030c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00030c40: 2020 2020 2020 2022 6f70 223a 2022 7265         "op": "re
+00030c50: 6672 6573 682d 7768 6f2d 6861 7322 2c0a  fresh-who-has",.
+00030c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c70: 2020 2020 2277 686f 5f68 6173 223a 2077      "who_has": w
+00030c80: 686f 5f68 6173 2c0a 2020 2020 2020 2020  ho_has,.        
+00030c90: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+00030ca0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+00030cb0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+00030cc0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00030cd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00030ce0: 6966 2066 7265 655f 6b65 7973 3a0a 2020  if free_keys:.  
+00030cf0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00030d00: 7472 6561 6d5f 636f 6d6d 735b 776f 726b  tream_comms[work
+00030d10: 6572 5d2e 7365 6e64 280a 2020 2020 2020  er].send(.      
+00030d20: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00030d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d40: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
+00030d50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00030d60: 2020 2020 2020 2022 6b65 7973 223a 2066         "keys": f
+00030d70: 7265 655f 6b65 7973 2c0a 2020 2020 2020  ree_keys,.      
+00030d80: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00030d90: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+00030da0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+00030db0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00030dc0: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
+00030dd0: 7379 6e63 2064 6566 2068 616e 646c 655f  sync def handle_
+00030de0: 776f 726b 6572 2873 656c 662c 2063 6f6d  worker(self, com
+00030df0: 6d3a 2043 6f6d 6d2c 2077 6f72 6b65 723a  m: Comm, worker:
+00030e00: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+00030e10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00030e20: 2020 204c 6973 7465 6e20 746f 2072 6573     Listen to res
+00030e30: 706f 6e73 6573 2066 726f 6d20 6120 7369  ponses from a si
+00030e40: 6e67 6c65 2077 6f72 6b65 720a 0a20 2020  ngle worker..   
+00030e50: 2020 2020 2054 6869 7320 6973 2074 6865       This is the
+00030e60: 206d 6169 6e20 6c6f 6f70 2066 6f72 2073   main loop for s
+00030e70: 6368 6564 756c 6572 2d77 6f72 6b65 7220  cheduler-worker 
+00030e80: 696e 7465 7261 6374 696f 6e0a 0a20 2020  interaction..   
+00030e90: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
+00030ea0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+00030eb0: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
+00030ec0: 2e68 616e 646c 655f 636c 6965 6e74 3a20  .handle_client: 
+00030ed0: 4571 7569 7661 6c65 6e74 2063 6f72 6f75  Equivalent corou
+00030ee0: 7469 6e65 2066 6f72 2063 6c69 656e 7473  tine for clients
+00030ef0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00030f00: 2020 2020 2063 6f6d 6d2e 6e61 6d65 203d       comm.name =
+00030f10: 2022 5363 6865 6475 6c65 7220 636f 6e6e   "Scheduler conn
+00030f20: 6563 7469 6f6e 2074 6f20 776f 726b 6572  ection to worker
+00030f30: 220a 2020 2020 2020 2020 776f 726b 6572  ".        worker
+00030f40: 5f63 6f6d 6d20 3d20 7365 6c66 2e73 7472  _comm = self.str
+00030f50: 6561 6d5f 636f 6d6d 735b 776f 726b 6572  eam_comms[worker
+00030f60: 5d0a 2020 2020 2020 2020 776f 726b 6572  ].        worker
+00030f70: 5f63 6f6d 6d2e 7374 6172 7428 636f 6d6d  _comm.start(comm
+00030f80: 290a 2020 2020 2020 2020 6c6f 6767 6572  ).        logger
+00030f90: 2e69 6e66 6f28 2253 7461 7274 696e 6720  .info("Starting 
+00030fa0: 776f 726b 6572 2063 6f6d 7075 7465 2073  worker compute s
+00030fb0: 7472 6561 6d2c 2025 7322 2c20 776f 726b  tream, %s", work
+00030fc0: 6572 290a 2020 2020 2020 2020 7472 793a  er).        try:
+00030fd0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00030fe0: 6974 2073 656c 662e 6861 6e64 6c65 5f73  it self.handle_s
+00030ff0: 7472 6561 6d28 636f 6d6d 3d63 6f6d 6d2c  tream(comm=comm,
+00031000: 2065 7874 7261 3d7b 2277 6f72 6b65 7222   extra={"worker"
+00031010: 3a20 776f 726b 6572 7d29 0a20 2020 2020  : worker}).     
+00031020: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+00031030: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+00031040: 7220 696e 2073 656c 662e 7374 7265 616d  r in self.stream
+00031050: 5f63 6f6d 6d73 3a0a 2020 2020 2020 2020  _comms:.        
+00031060: 2020 2020 2020 2020 776f 726b 6572 5f63          worker_c
+00031070: 6f6d 6d2e 6162 6f72 7428 290a 2020 2020  omm.abort().    
+00031080: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00031090: 7420 7365 6c66 2e72 656d 6f76 655f 776f  t self.remove_wo
+000310a0: 726b 6572 280a 2020 2020 2020 2020 2020  rker(.          
+000310b0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+000310c0: 2c20 7374 696d 756c 7573 5f69 643d 6622  , stimulus_id=f"
+000310d0: 6861 6e64 6c65 2d77 6f72 6b65 722d 636c  handle-worker-cl
+000310e0: 6561 6e75 702d 7b74 696d 6528 297d 220a  eanup-{time()}".
+000310f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031100: 290a 0a20 2020 2064 6566 2061 6464 5f70  )..    def add_p
+00031110: 6c75 6769 6e28 0a20 2020 2020 2020 2073  lugin(.        s
+00031120: 656c 662c 0a20 2020 2020 2020 2070 6c75  elf,.        plu
+00031130: 6769 6e3a 2053 6368 6564 756c 6572 506c  gin: SchedulerPl
+00031140: 7567 696e 2c0a 2020 2020 2020 2020 2a2c  ugin,.        *,
+00031150: 0a20 2020 2020 2020 2069 6465 6d70 6f74  .        idempot
+00031160: 656e 743a 2062 6f6f 6c20 3d20 4661 6c73  ent: bool = Fals
+00031170: 652c 0a20 2020 2020 2020 206e 616d 653a  e,.        name:
+00031180: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00031190: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+000311a0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
+000311b0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000311c0: 2020 2222 2241 6464 2065 7874 6572 6e61    """Add externa
+000311d0: 6c20 706c 7567 696e 2074 6f20 7363 6865  l plugin to sche
+000311e0: 6475 6c65 722e 0a0a 2020 2020 2020 2020  duler...        
+000311f0: 5365 6520 6874 7470 733a 2f2f 6469 7374  See https://dist
+00031200: 7269 6275 7465 642e 7265 6164 7468 6564  ributed.readthed
+00031210: 6f63 732e 696f 2f65 6e2f 6c61 7465 7374  ocs.io/en/latest
+00031220: 2f70 6c75 6769 6e73 2e68 746d 6c0a 0a20  /plugins.html.. 
+00031230: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00031240: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00031250: 2d2d 2d2d 0a20 2020 2020 2020 2070 6c75  ----.        plu
+00031260: 6769 6e20 3a20 5363 6865 6475 6c65 7250  gin : SchedulerP
+00031270: 6c75 6769 6e0a 2020 2020 2020 2020 2020  lugin.          
+00031280: 2020 5363 6865 6475 6c65 7250 6c75 6769    SchedulerPlugi
+00031290: 6e20 696e 7374 616e 6365 2074 6f20 6164  n instance to ad
+000312a0: 640a 2020 2020 2020 2020 6964 656d 706f  d.        idempo
+000312b0: 7465 6e74 203a 2062 6f6f 6c0a 2020 2020  tent : bool.    
+000312c0: 2020 2020 2020 2020 4966 2074 7275 652c          If true,
+000312d0: 2074 6865 2070 6c75 6769 6e20 6973 2061   the plugin is a
+000312e0: 7373 756d 6564 2074 6f20 616c 7265 6164  ssumed to alread
+000312f0: 7920 6578 6973 7420 616e 6420 6e6f 0a20  y exist and no. 
+00031300: 2020 2020 2020 2020 2020 2061 6374 696f             actio
+00031310: 6e20 6973 2074 616b 656e 2e0a 2020 2020  n is taken..    
+00031320: 2020 2020 6e61 6d65 203a 2073 7472 0a20      name : str. 
+00031330: 2020 2020 2020 2020 2020 2041 206e 616d             A nam
+00031340: 6520 666f 7220 7468 6520 706c 7567 696e  e for the plugin
+00031350: 2c20 6966 204e 6f6e 652c 2074 6865 206e  , if None, the n
+00031360: 616d 6520 6174 7472 6962 7574 6520 6973  ame attribute is
+00031370: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
+00031380: 636b 6564 206f 6e20 7468 6520 506c 7567  cked on the Plug
+00031390: 696e 2069 6e73 7461 6e63 6520 616e 6420  in instance and 
+000313a0: 6765 6e65 7261 7465 6420 6966 206e 6f74  generated if not
+000313b0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
+000313c0: 636f 7665 7265 642e 0a20 2020 2020 2020  covered..       
+000313d0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+000313e0: 6e61 6d65 2069 7320 4e6f 6e65 3a0a 2020  name is None:.  
+000313f0: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
+00031400: 205f 6765 745f 706c 7567 696e 5f6e 616d   _get_plugin_nam
+00031410: 6528 706c 7567 696e 290a 0a20 2020 2020  e(plugin)..     
+00031420: 2020 2069 6620 6e61 6d65 2069 6e20 7365     if name in se
+00031430: 6c66 2e70 6c75 6769 6e73 3a0a 2020 2020  lf.plugins:.    
+00031440: 2020 2020 2020 2020 6966 2069 6465 6d70          if idemp
+00031450: 6f74 656e 743a 0a20 2020 2020 2020 2020  otent:.         
+00031460: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00031470: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
+00031480: 6773 2e77 6172 6e28 0a20 2020 2020 2020  gs.warn(.       
+00031490: 2020 2020 2020 2020 2066 2253 6368 6564           f"Sched
+000314a0: 756c 6572 2061 6c72 6561 6479 2063 6f6e  uler already con
+000314b0: 7461 696e 7320 6120 706c 7567 696e 2077  tains a plugin w
+000314c0: 6974 6820 6e61 6d65 207b 6e61 6d65 7d3b  ith name {name};
+000314d0: 206f 7665 7277 7269 7469 6e67 2e22 2c0a   overwriting.",.
+000314e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314f0: 6361 7465 676f 7279 3d55 7365 7257 6172  category=UserWar
+00031500: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+00031510: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00031520: 662e 706c 7567 696e 735b 6e61 6d65 5d20  f.plugins[name] 
+00031530: 3d20 706c 7567 696e 0a0a 2020 2020 6465  = plugin..    de
+00031540: 6620 7265 6d6f 7665 5f70 6c75 6769 6e28  f remove_plugin(
+00031550: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00031560: 2020 2020 2020 206e 616d 653a 2073 7472         name: str
+00031570: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00031580: 2020 2020 2020 2020 706c 7567 696e 3a20          plugin: 
+00031590: 5363 6865 6475 6c65 7250 6c75 6769 6e20  SchedulerPlugin 
+000315a0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000315b0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+000315c0: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+000315d0: 6578 7465 726e 616c 2070 6c75 6769 6e20  external plugin 
+000315e0: 6672 6f6d 2073 6368 6564 756c 6572 0a0a  from scheduler..
+000315f0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+00031600: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+00031610: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6e61  -----.        na
+00031620: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
+00031630: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
+00031640: 2070 6c75 6769 6e20 746f 2072 656d 6f76   plugin to remov
+00031650: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+00031660: 2020 2020 2020 6173 7365 7274 206e 616d        assert nam
+00031670: 6520 6973 206e 6f74 204e 6f6e 650a 0a20  e is not None.. 
+00031680: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00031690: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+000316a0: 2e70 6c75 6769 6e73 5b6e 616d 655d 0a20  .plugins[name]. 
+000316b0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+000316c0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+000316d0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000316e0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000316f0: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
+00031700: 7420 6669 6e64 2070 6c75 6769 6e20 7b6e  t find plugin {n
+00031710: 616d 6521 727d 2061 6d6f 6e67 2074 6865  ame!r} among the
+00031720: 2063 7572 7265 6e74 2073 6368 6564 756c   current schedul
+00031730: 6572 2070 6c75 6769 6e73 220a 2020 2020  er plugins".    
+00031740: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
+00031750: 7379 6e63 2064 6566 2072 6567 6973 7465  sync def registe
+00031760: 725f 7363 6865 6475 6c65 725f 706c 7567  r_scheduler_plug
+00031770: 696e 280a 2020 2020 2020 2020 7365 6c66  in(.        self
+00031780: 2c0a 2020 2020 2020 2020 706c 7567 696e  ,.        plugin
+00031790: 3a20 6279 7465 7320 7c20 5363 6865 6475  : bytes | Schedu
+000317a0: 6c65 7250 6c75 6769 6e2c 0a20 2020 2020  lerPlugin,.     
+000317b0: 2020 206e 616d 653a 2073 7472 207c 204e     name: str | N
+000317c0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+000317d0: 2020 2020 6964 656d 706f 7465 6e74 3a20      idempotent: 
+000317e0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+000317f0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00031800: 2020 2020 2022 2222 5265 6769 7374 6572       """Register
+00031810: 2061 2070 6c75 6769 6e20 6f6e 2074 6865   a plugin on the
+00031820: 2073 6368 6564 756c 6572 2e22 2222 0a20   scheduler.""". 
+00031830: 2020 2020 2020 2069 6620 6e6f 7420 6461         if not da
+00031840: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+00031850: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+00031860: 756c 6572 2e70 6963 6b6c 6522 293a 0a20  uler.pickle"):. 
+00031870: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00031880: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00031890: 2020 2020 2020 2020 2020 2020 2022 4361               "Ca
+000318a0: 6e6e 6f74 2072 6567 6973 7465 7220 6120  nnot register a 
+000318b0: 7363 6865 6475 6c65 7220 706c 7567 696e  scheduler plugin
+000318c0: 2061 7320 7468 6520 7363 6865 6475 6c65   as the schedule
+000318d0: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
+000318e0: 2020 2020 2268 6173 2062 6565 6e20 6578      "has been ex
+000318f0: 706c 6963 6974 6c79 2064 6973 616c 6c6f  plicitly disallo
+00031900: 7765 6420 6672 6f6d 2064 6573 6572 6961  wed from deseria
+00031910: 6c69 7a69 6e67 2022 0a20 2020 2020 2020  lizing ".       
+00031920: 2020 2020 2020 2020 2022 6172 6269 7472           "arbitr
+00031930: 6172 7920 6279 7465 7374 7269 6e67 7320  ary bytestrings 
+00031940: 7573 696e 6720 7069 636b 6c65 2076 6961  using pickle via
+00031950: 2074 6865 2022 0a20 2020 2020 2020 2020   the ".         
+00031960: 2020 2020 2020 2022 2764 6973 7472 6962         "'distrib
+00031970: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+00031980: 6963 6b6c 6527 2063 6f6e 6669 6775 7261  ickle' configura
+00031990: 7469 6f6e 2073 6574 7469 6e67 2e22 0a20  tion setting.". 
+000319a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000319b0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+000319c0: 7374 616e 6365 2870 6c75 6769 6e2c 2053  stance(plugin, S
+000319d0: 6368 6564 756c 6572 506c 7567 696e 293a  chedulerPlugin):
+000319e0: 0a20 2020 2020 2020 2020 2020 2070 6c75  .            plu
+000319f0: 6769 6e20 3d20 6c6f 6164 7328 706c 7567  gin = loads(plug
+00031a00: 696e 290a 2020 2020 2020 2020 2020 2020  in).            
+00031a10: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00031a20: 6528 706c 7567 696e 2c20 5363 6865 6475  e(plugin, Schedu
+00031a30: 6c65 7250 6c75 6769 6e29 0a0a 2020 2020  lerPlugin)..    
+00031a40: 2020 2020 6966 206e 616d 6520 6973 204e      if name is N
+00031a50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00031a60: 206e 616d 6520 3d20 5f67 6574 5f70 6c75   name = _get_plu
+00031a70: 6769 6e5f 6e61 6d65 2870 6c75 6769 6e29  gin_name(plugin)
+00031a80: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
+00031a90: 6520 696e 2073 656c 662e 706c 7567 696e  e in self.plugin
+00031aa0: 7320 616e 6420 6964 656d 706f 7465 6e74  s and idempotent
+00031ab0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00031ac0: 7475 726e 0a0a 2020 2020 2020 2020 6966  turn..        if
+00031ad0: 2068 6173 6174 7472 2870 6c75 6769 6e2c   hasattr(plugin,
+00031ae0: 2022 7374 6172 7422 293a 0a20 2020 2020   "start"):.     
+00031af0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00031b00: 706c 7567 696e 2e73 7461 7274 2873 656c  plugin.start(sel
+00031b10: 6629 0a20 2020 2020 2020 2020 2020 2069  f).            i
+00031b20: 6620 696e 7370 6563 742e 6973 6177 6169  f inspect.isawai
+00031b30: 7461 626c 6528 7265 7375 6c74 293a 0a20  table(result):. 
+00031b40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00031b50: 7761 6974 2072 6573 756c 740a 0a20 2020  wait result..   
+00031b60: 2020 2020 2073 656c 662e 6164 645f 706c       self.add_pl
+00031b70: 7567 696e 2870 6c75 6769 6e2c 206e 616d  ugin(plugin, nam
+00031b80: 653d 6e61 6d65 2c20 6964 656d 706f 7465  e=name, idempote
+00031b90: 6e74 3d69 6465 6d70 6f74 656e 7429 0a0a  nt=idempotent)..
+00031ba0: 2020 2020 6465 6620 776f 726b 6572 5f73      def worker_s
+00031bb0: 656e 6428 7365 6c66 2c20 776f 726b 6572  end(self, worker
+00031bc0: 3a20 7374 722c 206d 7367 3a20 6469 6374  : str, msg: dict
+00031bd0: 5b73 7472 2c20 416e 795d 2920 2d3e 204e  [str, Any]) -> N
+00031be0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00031bf0: 5365 6e64 206d 6573 7361 6765 2074 6f20  Send message to 
+00031c00: 776f 726b 6572 0a0a 2020 2020 2020 2020  worker..        
+00031c10: 5468 6973 2061 6c73 6f20 6861 6e64 6c65  This also handle
+00031c20: 7320 636f 6e6e 6563 7469 6f6e 2066 6169  s connection fai
+00031c30: 6c75 7265 7320 6279 2061 6464 696e 6720  lures by adding 
+00031c40: 6120 6361 6c6c 6261 636b 2074 6f20 7265  a callback to re
+00031c50: 6d6f 7665 0a20 2020 2020 2020 2074 6865  move.        the
+00031c60: 2077 6f72 6b65 7220 6f6e 2074 6865 206e   worker on the n
+00031c70: 6578 7420 6379 636c 652e 0a20 2020 2020  ext cycle..     
+00031c80: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
+00031c90: 7472 6561 6d5f 636f 6d6d 733a 2064 6963  tream_comms: dic
+00031ca0: 7420 3d20 7365 6c66 2e73 7472 6561 6d5f  t = self.stream_
+00031cb0: 636f 6d6d 730a 2020 2020 2020 2020 7472  comms.        tr
+00031cc0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00031cd0: 7472 6561 6d5f 636f 6d6d 735b 776f 726b  tream_comms[work
+00031ce0: 6572 5d2e 7365 6e64 286d 7367 290a 2020  er].send(msg).  
+00031cf0: 2020 2020 2020 6578 6365 7074 2028 436f        except (Co
+00031d00: 6d6d 436c 6f73 6564 4572 726f 722c 2041  mmClosedError, A
+00031d10: 7474 7269 6275 7465 4572 726f 7229 3a0a  ttributeError):.
+00031d20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031d30: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
+00031d40: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
+00031d50: 736f 6f6e 280a 2020 2020 2020 2020 2020  soon(.          
+00031d60: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+00031d70: 655f 776f 726b 6572 2c0a 2020 2020 2020  e_worker,.      
+00031d80: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+00031d90: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
+00031da0: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
+00031db0: 7573 5f69 643d 6622 776f 726b 6572 2d73  us_id=f"worker-s
+00031dc0: 656e 642d 636f 6d6d 2d66 6169 6c2d 7b74  end-comm-fail-{t
+00031dd0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
+00031de0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00031df0: 636c 6965 6e74 5f73 656e 6428 7365 6c66  client_send(self
+00031e00: 2c20 636c 6965 6e74 2c20 6d73 6729 3a0a  , client, msg):.
+00031e10: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
+00031e20: 6d65 7373 6167 6520 746f 2063 6c69 656e  message to clien
+00031e30: 7422 2222 0a20 2020 2020 2020 2063 6c69  t""".        cli
+00031e40: 656e 745f 636f 6d6d 733a 2064 6963 7420  ent_comms: dict 
+00031e50: 3d20 7365 6c66 2e63 6c69 656e 745f 636f  = self.client_co
+00031e60: 6d6d 730a 2020 2020 2020 2020 6320 3d20  mms.        c = 
+00031e70: 636c 6965 6e74 5f63 6f6d 6d73 2e67 6574  client_comms.get
+00031e80: 2863 6c69 656e 7429 0a20 2020 2020 2020  (client).       
+00031e90: 2069 6620 6320 6973 204e 6f6e 653a 0a20   if c is None:. 
+00031ea0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00031eb0: 6e0a 2020 2020 2020 2020 7472 793a 0a20  n.        try:. 
+00031ec0: 2020 2020 2020 2020 2020 2063 2e73 656e             c.sen
+00031ed0: 6428 6d73 6729 0a20 2020 2020 2020 2065  d(msg).        e
+00031ee0: 7863 6570 7420 436f 6d6d 436c 6f73 6564  xcept CommClosed
+00031ef0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00031f00: 2020 2069 6620 7365 6c66 2e73 7461 7475     if self.statu
+00031f10: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
+00031f20: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00031f30: 2020 2020 206c 6f67 6765 722e 6372 6974       logger.crit
+00031f40: 6963 616c 280a 2020 2020 2020 2020 2020  ical(.          
+00031f50: 2020 2020 2020 2020 2020 2243 6c6f 7365            "Close
+00031f60: 6420 636f 6d6d 2025 7220 7768 696c 6520  d comm %r while 
+00031f70: 7472 7969 6e67 2074 6f20 7772 6974 6520  trying to write 
+00031f80: 2573 222c 2063 2c20 6d73 672c 2065 7863  %s", c, msg, exc
+00031f90: 5f69 6e66 6f3d 5472 7565 0a20 2020 2020  _info=True.     
+00031fa0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00031fb0: 2020 6465 6620 7365 6e64 5f61 6c6c 2873    def send_all(s
+00031fc0: 656c 662c 2063 6c69 656e 745f 6d73 6773  elf, client_msgs
+00031fd0: 3a20 4d73 6773 2c20 776f 726b 6572 5f6d  : Msgs, worker_m
+00031fe0: 7367 733a 204d 7367 7329 202d 3e20 4e6f  sgs: Msgs) -> No
+00031ff0: 6e65 3a0a 2020 2020 2020 2020 2222 2253  ne:.        """S
+00032000: 656e 6420 6d65 7373 6167 6573 2074 6f20  end messages to 
+00032010: 636c 6965 6e74 2061 6e64 2077 6f72 6b65  client and worke
+00032020: 7273 2222 220a 0a20 2020 2020 2020 2066  rs"""..        f
+00032030: 6f72 2063 6c69 656e 742c 206d 7367 7320  or client, msgs 
+00032040: 696e 2063 6c69 656e 745f 6d73 6773 2e69  in client_msgs.i
+00032050: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00032060: 2020 2020 6320 3d20 7365 6c66 2e63 6c69      c = self.cli
+00032070: 656e 745f 636f 6d6d 732e 6765 7428 636c  ent_comms.get(cl
+00032080: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
+00032090: 2020 6966 2063 2069 7320 4e6f 6e65 3a0a    if c is None:.
+000320a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000320b0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+000320c0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000320d0: 2020 2020 2020 2020 2020 632e 7365 6e64            c.send
+000320e0: 282a 6d73 6773 290a 2020 2020 2020 2020  (*msgs).        
+000320f0: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
+00032100: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
+00032110: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00032120: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
+00032130: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
+00032140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032150: 2020 6c6f 6767 6572 2e63 7269 7469 6361    logger.critica
+00032160: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+00032170: 2020 2020 2020 2020 2020 2022 436c 6f73             "Clos
+00032180: 6564 2063 6f6d 6d20 2572 2077 6869 6c65  ed comm %r while
+00032190: 2074 7279 696e 6720 746f 2077 7269 7465   trying to write
+000321a0: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
+000321b0: 2020 2020 2020 2020 2020 2020 2020 632c                c,
+000321c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000321d0: 2020 2020 2020 2020 206d 7367 732c 0a20           msgs,. 
+000321e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000321f0: 2020 2020 2020 2065 7863 5f69 6e66 6f3d         exc_info=
+00032200: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00032210: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00032220: 2020 2020 2066 6f72 2077 6f72 6b65 722c       for worker,
+00032230: 206d 7367 7320 696e 2077 6f72 6b65 725f   msgs in worker_
+00032240: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
+00032250: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00032260: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00032270: 203d 2073 656c 662e 7374 7265 616d 5f63   = self.stream_c
+00032280: 6f6d 6d73 5b77 6f72 6b65 725d 0a20 2020  omms[worker].   
+00032290: 2020 2020 2020 2020 2020 2020 2077 2e73               w.s
+000322a0: 656e 6428 2a6d 7367 7329 0a20 2020 2020  end(*msgs).     
+000322b0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+000322c0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+000322d0: 2020 2020 2020 2020 2320 776f 726b 6572          # worker
+000322e0: 2061 6c72 6561 6479 2067 6f6e 650a 2020   already gone.  
+000322f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00032300: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
+00032310: 7863 6570 7420 2843 6f6d 6d43 6c6f 7365  xcept (CommClose
+00032320: 6445 7272 6f72 2c20 4174 7472 6962 7574  dError, Attribut
+00032330: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00032340: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
+00032350: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
+00032360: 645f 7461 736b 732e 6361 6c6c 5f73 6f6f  d_tasks.call_soo
+00032370: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00032380: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+00032390: 7665 5f77 6f72 6b65 722c 0a20 2020 2020  ve_worker,.     
+000323a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000323b0: 6464 7265 7373 3d77 6f72 6b65 722c 0a20  ddress=worker,. 
+000323c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000323d0: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
+000323e0: 2273 656e 642d 616c 6c2d 636f 6d6d 2d66  "send-all-comm-f
+000323f0: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
+00032400: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00032410: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+00032420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00032430: 2323 0a20 2020 2023 204c 6573 7320 636f  ##.    # Less co
+00032440: 6d6d 6f6e 2069 6e74 6572 6163 7469 6f6e  mmon interaction
+00032450: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
+00032460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00032470: 2323 2323 0a0a 2020 2020 6173 796e 6320  ####..    async 
+00032480: 6465 6620 7363 6174 7465 7228 0a20 2020  def scatter(.   
+00032490: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000324a0: 2020 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020     comm=None,.  
+000324b0: 2020 2020 2020 6461 7461 3d4e 6f6e 652c        data=None,
+000324c0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+000324d0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2063  =None,.        c
+000324e0: 6c69 656e 743d 4e6f 6e65 2c0a 2020 2020  lient=None,.    
+000324f0: 2020 2020 6272 6f61 6463 6173 743d 4661      broadcast=Fa
+00032500: 6c73 652c 0a20 2020 2020 2020 2074 696d  lse,.        tim
+00032510: 656f 7574 3d32 2c0a 2020 2020 293a 0a20  eout=2,.    ):. 
+00032520: 2020 2020 2020 2022 2222 5365 6e64 2064         """Send d
+00032530: 6174 6120 6f75 7420 746f 2077 6f72 6b65  ata out to worke
+00032540: 7273 0a0a 2020 2020 2020 2020 5365 6520  rs..        See 
+00032550: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
+00032560: 2d2d 2d2d 2d0a 2020 2020 2020 2020 5363  -----.        Sc
+00032570: 6865 6475 6c65 722e 6272 6f61 6463 6173  heduler.broadcas
+00032580: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
+00032590: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+000325a0: 696d 6528 290a 2020 2020 2020 2020 7768  ime().        wh
+000325b0: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
+000325c0: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
+000325d0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000325e0: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
+000325f0: 7365 6c66 2e72 756e 6e69 6e67 0a20 2020  self.running.   
+00032600: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00032610: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00032620: 6f72 6b65 7273 203d 205b 7365 6c66 2e63  orkers = [self.c
+00032630: 6f65 7263 655f 6164 6472 6573 7328 7729  oerce_address(w)
+00032640: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
+00032650: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+00032660: 2020 2077 7373 203d 207b 7365 6c66 2e77     wss = {self.w
+00032670: 6f72 6b65 7273 5b77 5d20 666f 7220 7720  orkers[w] for w 
+00032680: 696e 2077 6f72 6b65 7273 7d0a 2020 2020  in workers}.    
+00032690: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
+000326a0: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
+000326b0: 7773 7320 6966 2077 732e 7374 6174 7573  wss if ws.status
+000326c0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+000326d0: 6e67 7d0a 0a20 2020 2020 2020 2020 2020  ng}..           
+000326e0: 2069 6620 7773 733a 0a20 2020 2020 2020   if wss:.       
+000326f0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+00032700: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
+00032710: 6d65 2829 203e 2073 7461 7274 202b 2074  me() > start + t
+00032720: 696d 656f 7574 3a0a 2020 2020 2020 2020  imeout:.        
+00032730: 2020 2020 2020 2020 7261 6973 6520 5469          raise Ti
+00032740: 6d65 6f75 7445 7272 6f72 2822 4e6f 2076  meoutError("No v
+00032750: 616c 6964 2077 6f72 6b65 7273 2066 6f75  alid workers fou
+00032760: 6e64 2229 0a20 2020 2020 2020 2020 2020  nd").           
+00032770: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
+00032780: 6c65 6570 2830 2e31 290a 0a20 2020 2020  leep(0.1)..     
+00032790: 2020 206e 7468 7265 6164 7320 3d20 7b77     nthreads = {w
+000327a0: 732e 6164 6472 6573 733a 2077 732e 6e74  s.address: ws.nt
+000327b0: 6872 6561 6473 2066 6f72 2077 7320 696e  hreads for ws in
+000327c0: 2077 7373 7d0a 0a20 2020 2020 2020 2061   wss}..        a
+000327d0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+000327e0: 2864 6174 612c 2064 6963 7429 0a0a 2020  (data, dict)..  
+000327f0: 2020 2020 2020 6b65 7973 2c20 7768 6f5f        keys, who_
+00032800: 6861 732c 206e 6279 7465 7320 3d20 6177  has, nbytes = aw
+00032810: 6169 7420 7363 6174 7465 725f 746f 5f77  ait scatter_to_w
+00032820: 6f72 6b65 7273 286e 7468 7265 6164 732c  orkers(nthreads,
+00032830: 2064 6174 612c 2072 7063 3d73 656c 662e   data, rpc=self.
+00032840: 7270 6329 0a0a 2020 2020 2020 2020 7365  rpc)..        se
+00032850: 6c66 2e75 7064 6174 655f 6461 7461 2877  lf.update_data(w
+00032860: 686f 5f68 6173 3d77 686f 5f68 6173 2c20  ho_has=who_has, 
+00032870: 6e62 7974 6573 3d6e 6279 7465 732c 2063  nbytes=nbytes, c
+00032880: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
+00032890: 2020 2020 2020 2069 6620 6272 6f61 6463         if broadc
+000328a0: 6173 743a 0a20 2020 2020 2020 2020 2020  ast:.           
+000328b0: 206e 203d 206c 656e 286e 7468 7265 6164   n = len(nthread
+000328c0: 7329 2069 6620 6272 6f61 6463 6173 7420  s) if broadcast 
+000328d0: 6973 2054 7275 6520 656c 7365 2062 726f  is True else bro
+000328e0: 6164 6361 7374 0a20 2020 2020 2020 2020  adcast.         
+000328f0: 2020 2061 7761 6974 2073 656c 662e 7265     await self.re
+00032900: 706c 6963 6174 6528 6b65 7973 3d6b 6579  plicate(keys=key
+00032910: 732c 2077 6f72 6b65 7273 3d77 6f72 6b65  s, workers=worke
+00032920: 7273 2c20 6e3d 6e29 0a0a 2020 2020 2020  rs, n=n)..      
+00032930: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00032940: 280a 2020 2020 2020 2020 2020 2020 5b63  (.            [c
+00032950: 6c69 656e 742c 2022 616c 6c22 5d2c 207b  lient, "all"], {
+00032960: 2261 6374 696f 6e22 3a20 2273 6361 7474  "action": "scatt
+00032970: 6572 222c 2022 636c 6965 6e74 223a 2063  er", "client": c
+00032980: 6c69 656e 742c 2022 636f 756e 7422 3a20  lient, "count": 
+00032990: 6c65 6e28 6461 7461 297d 0a20 2020 2020  len(data)}.     
+000329a0: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+000329b0: 7572 6e20 6b65 7973 0a0a 2020 2020 6173  urn keys..    as
+000329c0: 796e 6320 6465 6620 6761 7468 6572 2873  ync def gather(s
+000329d0: 656c 662c 206b 6579 732c 2073 6572 6961  elf, keys, seria
+000329e0: 6c69 7a65 7273 3d4e 6f6e 6529 3a0a 2020  lizers=None):.  
+000329f0: 2020 2020 2020 2222 2243 6f6c 6c65 6374        """Collect
+00032a00: 2064 6174 6120 6672 6f6d 2077 6f72 6b65   data from worke
+00032a10: 7273 2074 6f20 7468 6520 7363 6865 6475  rs to the schedu
+00032a20: 6c65 7222 2222 0a20 2020 2020 2020 2073  ler""".        s
+00032a30: 7469 6d75 6c75 735f 6964 203d 2066 2267  timulus_id = f"g
+00032a40: 6174 6865 722d 7b74 696d 6528 297d 220a  ather-{time()}".
+00032a50: 2020 2020 2020 2020 6b65 7973 203d 206c          keys = l
+00032a60: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
+00032a70: 2020 7768 6f5f 6861 7320 3d20 7b7d 0a20    who_has = {}. 
+00032a80: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00032a90: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00032aa0: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+00032ab0: 6520 3d20 7365 6c66 2e74 6173 6b73 2e67  e = self.tasks.g
+00032ac0: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+00032ad0: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
+00032ae0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00032af0: 2020 2020 2020 2077 686f 5f68 6173 5b6b         who_has[k
+00032b00: 6579 5d20 3d20 5b77 732e 6164 6472 6573  ey] = [ws.addres
+00032b10: 7320 666f 7220 7773 2069 6e20 7473 2e77  s for ws in ts.w
+00032b20: 686f 5f68 6173 5d0a 2020 2020 2020 2020  ho_has].        
+00032b30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00032b40: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
+00032b50: 735b 6b65 795d 203d 205b 5d0a 0a20 2020  s[key] = []..   
+00032b60: 2020 2020 2064 6174 612c 206d 6973 7369       data, missi
+00032b70: 6e67 5f6b 6579 732c 206d 6973 7369 6e67  ng_keys, missing
+00032b80: 5f77 6f72 6b65 7273 203d 2061 7761 6974  _workers = await
+00032b90: 2067 6174 6865 725f 6672 6f6d 5f77 6f72   gather_from_wor
+00032ba0: 6b65 7273 280a 2020 2020 2020 2020 2020  kers(.          
+00032bb0: 2020 7768 6f5f 6861 732c 2072 7063 3d73    who_has, rpc=s
+00032bc0: 656c 662e 7270 632c 2063 6c6f 7365 3d46  elf.rpc, close=F
+00032bd0: 616c 7365 2c20 7365 7269 616c 697a 6572  alse, serializer
+00032be0: 733d 7365 7269 616c 697a 6572 730a 2020  s=serializers.  
+00032bf0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00032c00: 6966 206e 6f74 206d 6973 7369 6e67 5f6b  if not missing_k
+00032c10: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+00032c20: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
+00032c30: 7573 223a 2022 4f4b 222c 2022 6461 7461  us": "OK", "data
+00032c40: 223a 2064 6174 617d 0a20 2020 2020 2020  ": data}.       
+00032c50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00032c60: 2020 206d 6973 7369 6e67 5f73 7461 7465     missing_state
+00032c70: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00032c80: 2020 2020 2020 2873 656c 662e 7461 736b        (self.task
+00032c90: 735b 6b65 795d 2e73 7461 7465 2069 6620  s[key].state if 
+00032ca0: 6b65 7920 696e 2073 656c 662e 7461 736b  key in self.task
+00032cb0: 7320 656c 7365 204e 6f6e 6529 0a20 2020  s else None).   
+00032cc0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00032cd0: 206b 6579 2069 6e20 6d69 7373 696e 675f   key in missing_
+00032ce0: 6b65 7973 0a20 2020 2020 2020 2020 2020  keys.           
+00032cf0: 205d 0a20 2020 2020 2020 2020 2020 206c   ].            l
+00032d00: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+00032d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032d20: 2022 436f 756c 646e 2774 2067 6174 6865   "Couldn't gathe
+00032d30: 7220 6b65 7973 2025 7320 7374 6174 653a  r keys %s state:
+00032d40: 2025 7320 776f 726b 6572 733a 2025 7322   %s workers: %s"
+00032d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032d60: 2020 6d69 7373 696e 675f 6b65 7973 2c0a    missing_keys,.
+00032d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032d80: 6d69 7373 696e 675f 7374 6174 6573 2c0a  missing_states,.
+00032d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032da0: 6d69 7373 696e 675f 776f 726b 6572 732c  missing_workers,
+00032db0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00032dc0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00032dd0: 7420 3d20 7b22 7374 6174 7573 223a 2022  t = {"status": "
+00032de0: 6572 726f 7222 2c20 226b 6579 7322 3a20  error", "keys": 
+00032df0: 6d69 7373 696e 675f 6b65 7973 7d0a 2020  missing_keys}.  
+00032e00: 2020 2020 2020 2020 2020 7769 7468 206c            with l
+00032e10: 6f67 5f65 7272 6f72 7328 293a 0a20 2020  og_errors():.   
+00032e20: 2020 2020 2020 2020 2020 2020 2023 2052               # R
+00032e30: 656d 6f76 6520 7375 7370 6963 696f 7573  emove suspicious
+00032e40: 2077 6f72 6b65 7273 2066 726f 6d20 7468   workers from th
+00032e50: 6520 7363 6865 6475 6c65 7220 616e 6420  e scheduler and 
+00032e60: 7368 7574 2074 6865 6d20 646f 776e 2e0a  shut them down..
+00032e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032e80: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00032e90: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00032ea0: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
+00032eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ec0: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
+00032ed0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+00032ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ef0: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
+00032f00: 6b65 722c 2063 6c6f 7365 3d54 7275 652c  ker, close=True,
+00032f10: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+00032f20: 6d75 6c75 735f 6964 0a20 2020 2020 2020  mulus_id.       
+00032f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032f40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00032f50: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+00032f60: 6f72 6b65 7220 696e 206d 6973 7369 6e67  orker in missing
+00032f70: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+00032f80: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00032f90: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00032fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032fb0: 2066 6f72 206b 6579 2c20 776f 726b 6572   for key, worker
+00032fc0: 7320 696e 206d 6973 7369 6e67 5f6b 6579  s in missing_key
+00032fd0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00032fe0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00032ff0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+00033000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033010: 2020 2020 2020 2020 2022 5368 7574 2064           "Shut d
+00033020: 6f77 6e20 776f 726b 6572 7320 7468 6174  own workers that
+00033030: 2064 6f6e 2774 2068 6176 6520 7072 6f6d   don't have prom
+00033040: 6973 6564 206b 6579 3a20 2573 2c20 2573  ised key: %s, %s
+00033050: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00033060: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
+00033070: 6f72 6b65 7273 292c 0a20 2020 2020 2020  orkers),.       
+00033080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033090: 2073 7472 286b 6579 292c 0a20 2020 2020   str(key),.     
+000330a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000330b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
+000330c0: 6f67 5f65 7665 6e74 2822 616c 6c22 2c20  og_event("all", 
+000330d0: 7b22 6163 7469 6f6e 223a 2022 6761 7468  {"action": "gath
+000330e0: 6572 222c 2022 636f 756e 7422 3a20 6c65  er", "count": le
+000330f0: 6e28 6b65 7973 297d 290a 2020 2020 2020  n(keys)}).      
+00033100: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
+00033110: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+00033120: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
+00033130: 6573 7461 7274 2873 656c 662c 2063 6c69  estart(self, cli
+00033140: 656e 743d 4e6f 6e65 2c20 7469 6d65 6f75  ent=None, timeou
+00033150: 743d 3330 2c20 7761 6974 5f66 6f72 5f77  t=30, wait_for_w
+00033160: 6f72 6b65 7273 3d54 7275 6529 3a0a 2020  orkers=True):.  
+00033170: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00033180: 2020 5265 7374 6172 7420 616c 6c20 776f    Restart all wo
+00033190: 726b 6572 732e 2052 6573 6574 206c 6f63  rkers. Reset loc
+000331a0: 616c 2073 7461 7465 2e20 4f70 7469 6f6e  al state. Option
+000331b0: 616c 6c79 2077 6169 7420 666f 7220 776f  ally wait for wo
+000331c0: 726b 6572 7320 746f 2072 6574 7572 6e2e  rkers to return.
+000331d0: 0a0a 2020 2020 2020 2020 576f 726b 6572  ..        Worker
+000331e0: 7320 7769 7468 6f75 7420 6e61 6e6e 6965  s without nannie
+000331f0: 7320 6172 6520 7368 7574 2064 6f77 6e2c  s are shut down,
+00033200: 2068 6f70 696e 6720 616e 2065 7874 6572   hoping an exter
+00033210: 6e61 6c20 6465 706c 6f79 6d65 6e74 2073  nal deployment s
+00033220: 7973 7465 6d0a 2020 2020 2020 2020 7769  ystem.        wi
+00033230: 6c6c 2072 6573 7461 7274 2074 6865 6d2e  ll restart them.
+00033240: 2054 6865 7265 666f 7265 2c20 6966 206e   Therefore, if n
+00033250: 6f74 2075 7369 6e67 206e 616e 6e69 6573  ot using nannies
+00033260: 2061 6e64 2079 6f75 7220 6465 706c 6f79   and your deploy
+00033270: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
+00033280: 2020 2020 646f 6573 206e 6f74 2061 7574      does not aut
+00033290: 6f6d 6174 6963 616c 6c79 2072 6573 7461  omatically resta
+000332a0: 7274 2077 6f72 6b65 7273 2c20 6060 7265  rt workers, ``re
+000332b0: 7374 6172 7460 6020 7769 6c6c 206a 7573  start`` will jus
+000332c0: 7420 7368 7574 2064 6f77 6e20 616c 6c0a  t shut down all.
+000332d0: 2020 2020 2020 2020 776f 726b 6572 732c          workers,
+000332e0: 2074 6865 6e20 7469 6d65 206f 7574 210a   then time out!.
+000332f0: 0a20 2020 2020 2020 2041 6674 6572 2060  .        After `
+00033300: 6072 6573 7461 7274 6060 2c20 616c 6c20  `restart``, all 
+00033310: 636f 6e6e 6563 7465 6420 776f 726b 6572  connected worker
+00033320: 7320 6172 6520 6e65 772c 2072 6567 6172  s are new, regar
+00033330: 646c 6573 7320 6f66 2077 6865 7468 6572  dless of whether
+00033340: 2060 6054 696d 656f 7574 4572 726f 7260   ``TimeoutError`
+00033350: 600a 2020 2020 2020 2020 7761 7320 7261  `.        was ra
+00033360: 6973 6564 2e20 416e 7920 776f 726b 6572  ised. Any worker
+00033370: 7320 7468 6174 2066 6169 6c65 6420 746f  s that failed to
+00033380: 2073 6875 7420 646f 776e 2069 6e20 7469   shut down in ti
+00033390: 6d65 2061 7265 2072 656d 6f76 6564 2c20  me are removed, 
+000333a0: 616e 640a 2020 2020 2020 2020 6d61 7920  and.        may 
+000333b0: 6f72 206d 6179 206e 6f74 2073 6875 7420  or may not shut 
+000333c0: 646f 776e 206f 6e20 7468 6569 7220 6f77  down on their ow
+000333d0: 6e20 696e 2074 6865 2066 7574 7572 652e  n in the future.
+000333e0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+000333f0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+00033400: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00033410: 7469 6d65 6f75 743a 0a20 2020 2020 2020  timeout:.       
+00033420: 2020 2020 2048 6f77 206c 6f6e 6720 746f       How long to
+00033430: 2077 6169 7420 666f 7220 776f 726b 6572   wait for worker
+00033440: 7320 746f 2073 6875 7420 646f 776e 2061  s to shut down a
+00033450: 6e64 2063 6f6d 6520 6261 636b 2c20 6966  nd come back, if
+00033460: 2060 6077 6169 745f 666f 725f 776f 726b   ``wait_for_work
+00033470: 6572 7360 600a 2020 2020 2020 2020 2020  ers``.          
+00033480: 2020 6973 2054 7275 652c 206f 7468 6572    is True, other
+00033490: 7769 7365 206a 7573 7420 686f 7720 6c6f  wise just how lo
+000334a0: 6e67 2074 6f20 7761 6974 2066 6f72 2077  ng to wait for w
+000334b0: 6f72 6b65 7273 2074 6f20 7368 7574 2064  orkers to shut d
+000334c0: 6f77 6e2e 0a20 2020 2020 2020 2020 2020  own..           
+000334d0: 2052 6169 7365 7320 6060 6173 796e 6369   Raises ``asynci
+000334e0: 6f2e 5469 6d65 6f75 7445 7272 6f72 6060  o.TimeoutError``
+000334f0: 2069 6620 7468 6973 2069 7320 6578 6365   if this is exce
+00033500: 6564 6564 2e0a 2020 2020 2020 2020 7761  eded..        wa
+00033510: 6974 5f66 6f72 5f77 6f72 6b65 7273 3a0a  it_for_workers:.
+00033520: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00033530: 6865 7220 746f 2077 6169 7420 666f 7220  her to wait for 
+00033540: 616c 6c20 776f 726b 6572 7320 746f 2072  all workers to r
+00033550: 6563 6f6e 6e65 6374 2c20 6f72 206a 7573  econnect, or jus
+00033560: 7420 666f 7220 7468 656d 2074 6f20 7368  t for them to sh
+00033570: 7574 2064 6f77 6e0a 2020 2020 2020 2020  ut down.        
+00033580: 2020 2020 2864 6566 6175 6c74 2054 7275      (default Tru
+00033590: 6529 2e20 5573 6520 6060 7265 7374 6172  e). Use ``restar
+000335a0: 7428 7761 6974 5f66 6f72 5f77 6f72 6b65  t(wait_for_worke
+000335b0: 7273 3d46 616c 7365 2960 6020 636f 6d62  rs=False)`` comb
+000335c0: 696e 6564 2077 6974 680a 2020 2020 2020  ined with.      
+000335d0: 2020 2020 2020 3a6d 6574 683a 6043 6c69        :meth:`Cli
+000335e0: 656e 742e 7761 6974 5f66 6f72 5f77 6f72  ent.wait_for_wor
+000335f0: 6b65 7273 6020 666f 7220 6772 616e 756c  kers` for granul
+00033600: 6172 2063 6f6e 7472 6f6c 206f 7665 7220  ar control over 
+00033610: 686f 7720 6d61 6e79 2077 6f72 6b65 7273  how many workers
+00033620: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
+00033630: 7761 6974 2066 6f72 2e0a 0a20 2020 2020  wait for...     
+00033640: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+00033650: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00033660: 2020 2020 2043 6c69 656e 742e 7265 7374       Client.rest
+00033670: 6172 740a 2020 2020 2020 2020 436c 6965  art.        Clie
+00033680: 6e74 2e72 6573 7461 7274 5f77 6f72 6b65  nt.restart_worke
+00033690: 7273 0a20 2020 2020 2020 2022 2222 0a20  rs.        """. 
+000336a0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+000336b0: 6964 203d 2066 2272 6573 7461 7274 2d7b  id = f"restart-{
+000336c0: 7469 6d65 2829 7d22 0a0a 2020 2020 2020  time()}"..      
+000336d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
+000336e0: 6573 7461 7274 696e 6720 776f 726b 6572  estarting worker
+000336f0: 7320 616e 6420 7265 6c65 6173 696e 6720  s and releasing 
+00033700: 616c 6c20 6b65 7973 2e22 290a 2020 2020  all keys.").    
+00033710: 2020 2020 666f 7220 6373 2069 6e20 7365      for cs in se
+00033720: 6c66 2e63 6c69 656e 7473 2e76 616c 7565  lf.clients.value
+00033730: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00033740: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
+00033750: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
+00033760: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+00033770: 3d5b 7473 2e6b 6579 2066 6f72 2074 7320  =[ts.key for ts 
+00033780: 696e 2063 732e 7761 6e74 735f 7768 6174  in cs.wants_what
+00033790: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000337a0: 2020 2063 6c69 656e 743d 6373 2e63 6c69     client=cs.cli
+000337b0: 656e 745f 6b65 792c 0a20 2020 2020 2020  ent_key,.       
+000337c0: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
+000337d0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+000337e0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000337f0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
+00033800: 6c65 6172 5f74 6173 6b5f 7374 6174 6528  lear_task_state(
+00033810: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00033820: 206e 6f74 2073 656c 662e 7461 736b 730a   not self.tasks.
+00033830: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+00033840: 6f72 7428 7b22 6f70 223a 2022 7265 7374  ort({"op": "rest
+00033850: 6172 7422 7d29 0a0a 2020 2020 2020 2020  art"})..        
+00033860: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
+00033870: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
+00033880: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
+00033890: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000338a0: 2020 2020 2020 2020 2020 2020 706c 7567              plug
+000338b0: 696e 2e72 6573 7461 7274 2873 656c 6629  in.restart(self)
+000338c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+000338d0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+000338e0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+000338f0: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+00033900: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
+00033910: 206e 5f77 6f72 6b65 7273 203d 206c 656e   n_workers = len
+00033920: 2873 656c 662e 776f 726b 6572 7329 0a20  (self.workers). 
+00033930: 2020 2020 2020 206e 616e 6e79 5f77 6f72         nanny_wor
+00033940: 6b65 7273 203d 207b 0a20 2020 2020 2020  kers = {.       
+00033950: 2020 2020 2061 6464 723a 2077 732e 6e61       addr: ws.na
+00033960: 6e6e 7920 666f 7220 6164 6472 2c20 7773  nny for addr, ws
+00033970: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00033980: 2e69 7465 6d73 2829 2069 6620 7773 2e6e  .items() if ws.n
+00033990: 616e 6e79 0a20 2020 2020 2020 207d 0a20  anny.        }. 
+000339a0: 2020 2020 2020 2023 2043 6c6f 7365 206e         # Close n
+000339b0: 6f6e 2d4e 616e 6e79 2077 6f72 6b65 7273  on-Nanny workers
+000339c0: 2e20 5765 2068 6176 6520 6e6f 2077 6179  . We have no way
+000339d0: 2074 6f20 7265 7374 6172 7420 7468 656d   to restart them
+000339e0: 2c20 736f 2077 6520 6a75 7374 206c 6574  , so we just let
+000339f0: 2074 6865 6d20 676f 2c0a 2020 2020 2020   them go,.      
+00033a00: 2020 2320 616e 6420 6173 7375 6d65 2061    # and assume a
+00033a10: 2064 6570 6c6f 796d 656e 7420 7379 7374   deployment syst
+00033a20: 656d 2069 7320 676f 696e 6720 746f 2072  em is going to r
+00033a30: 6573 7461 7274 2074 6865 6d20 666f 7220  estart them for 
+00033a40: 7573 2e0a 2020 2020 2020 2020 6177 6169  us..        awai
+00033a50: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+00033a60: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
+00033a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033a80: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
+00033a90: 6b65 7228 6164 6472 6573 733d 6164 6472  ker(address=addr
+00033aa0: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
+00033ab0: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
+00033ac0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+00033ad0: 6464 7220 696e 2073 656c 662e 776f 726b  ddr in self.work
+00033ae0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+00033af0: 2020 2020 6966 2061 6464 7220 6e6f 7420      if addr not 
+00033b00: 696e 206e 616e 6e79 5f77 6f72 6b65 7273  in nanny_workers
+00033b10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00033b20: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00033b30: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+00033b40: 5365 6e64 206b 696c 6c20 7369 676e 616c  Send kill signal
+00033b50: 2074 6f20 6e61 6e6e 6965 733a 2025 7322   to nannies: %s"
+00033b60: 2c20 6e61 6e6e 795f 776f 726b 6572 7329  , nanny_workers)
+00033b70: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
+00033b80: 6974 6820 636f 6e74 6578 746c 6962 2e41  ith contextlib.A
+00033b90: 7379 6e63 4578 6974 5374 6163 6b28 2920  syncExitStack() 
+00033ba0: 6173 2073 7461 636b 3a0a 2020 2020 2020  as stack:.      
+00033bb0: 2020 2020 2020 6e61 6e6e 6965 7320 3d20        nannies = 
+00033bc0: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00033bd0: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00033be0: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+00033bf0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00033c00: 636b 2e65 6e74 6572 5f61 7379 6e63 5f63  ck.enter_async_c
+00033c10: 6f6e 7465 7874 280a 2020 2020 2020 2020  ontext(.        
+00033c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033c30: 7270 6328 6e61 6e6e 795f 6164 6472 6573  rpc(nanny_addres
+00033c40: 732c 2063 6f6e 6e65 6374 696f 6e5f 6172  s, connection_ar
+00033c50: 6773 3d73 656c 662e 636f 6e6e 6563 7469  gs=self.connecti
+00033c60: 6f6e 5f61 7267 7329 0a20 2020 2020 2020  on_args).       
+00033c70: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00033c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033c90: 2020 2066 6f72 206e 616e 6e79 5f61 6464     for nanny_add
+00033ca0: 7265 7373 2069 6e20 6e61 6e6e 795f 776f  ress in nanny_wo
+00033cb0: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
+00033cc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00033cd0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00033ce0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00033cf0: 7420 3d20 6d6f 6e6f 746f 6e69 6328 290a  t = monotonic().
+00033d00: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00033d10: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
+00033d20: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00033d30: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
+00033d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033d50: 2077 6169 745f 666f 7228 0a20 2020 2020   wait_for(.     
+00033d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033d70: 2020 2023 2046 4958 4d45 2064 6f65 7320     # FIXME does 
+00033d80: 6e6f 7420 7261 6973 6520 6966 2074 6865  not raise if the
+00033d90: 2070 726f 6365 7373 2066 6169 6c73 2074   process fails t
+00033da0: 6f20 7368 7574 2064 6f77 6e2c 0a20 2020  o shut down,.   
+00033db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033dc0: 2020 2020 2023 2073 6565 2068 7474 7073       # see https
+00033dd0: 3a2f 2f67 6974 6875 622e 636f 6d2f 6461  ://github.com/da
+00033de0: 736b 2f64 6973 7472 6962 7574 6564 2f70  sk/distributed/p
+00033df0: 756c 6c2f 3634 3237 2f66 696c 6573 2372  ull/6427/files#r
+00033e00: 3839 3439 3137 3432 340a 2020 2020 2020  894917424.      
+00033e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e20: 2020 2320 4e4f 5445 3a20 4e61 6e6e 7920    # NOTE: Nanny 
+00033e30: 7769 6c6c 2061 7574 6f6d 6174 6963 616c  will automatical
+00033e40: 6c79 2072 6573 7461 7274 2077 6f72 6b65  ly restart worke
+00033e50: 7220 7072 6f63 6573 7320 7768 656e 2069  r process when i
+00033e60: 7427 7320 6b69 6c6c 6564 0a20 2020 2020  t's killed.     
+00033e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e80: 2020 206e 616e 6e79 2e6b 696c 6c28 0a20     nanny.kill(. 
+00033e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ea0: 2020 2020 2020 2020 2020 2072 6561 736f             reaso
+00033eb0: 6e3d 2273 6368 6564 756c 6572 2d72 6573  n="scheduler-res
+00033ec0: 7461 7274 222c 0a20 2020 2020 2020 2020  tart",.         
 00033ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ee0: 6164 6472 2066 6f72 2061 6464 722c 2072  addr for addr, r
-00033ef0: 6573 7020 696e 207a 6970 286e 616e 6e79  esp in zip(nanny
-00033f00: 5f77 6f72 6b65 7273 2c20 7265 7370 7329  _workers, resps)
-00033f10: 2069 6620 7265 7370 2069 7320 6e6f 7420   if resp is not 
-00033f20: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00033f30: 205d 0a20 2020 2020 2020 2020 2020 2069   ].            i
-00033f40: 6620 6261 645f 6e61 6e6e 6965 733a 0a20  f bad_nannies:. 
-00033f50: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00033f60: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00033f70: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00033f80: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
-00033f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033fa0: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-00033fb0: 776f 726b 6572 2861 6464 722c 2073 7469  worker(addr, sti
-00033fc0: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-00033fd0: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
-00033fe0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00033ff0: 7220 6164 6472 2069 6e20 6261 645f 6e61  r addr in bad_na
-00034000: 6e6e 6965 730a 2020 2020 2020 2020 2020  nnies.          
-00034010: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00034020: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00034030: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00034040: 6169 7365 2054 696d 656f 7574 4572 726f  aise TimeoutErro
-00034050: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00034060: 2020 2020 2020 2066 227b 6c65 6e28 6261         f"{len(ba
-00034070: 645f 6e61 6e6e 6965 7329 7d2f 7b6c 656e  d_nannies)}/{len
-00034080: 286e 616e 6e69 6573 297d 206e 616e 6e79  (nannies)} nanny
-00034090: 2077 6f72 6b65 7228 7329 2064 6964 206e   worker(s) did n
-000340a0: 6f74 2073 6875 7420 646f 776e 2077 6974  ot shut down wit
-000340b0: 6869 6e20 7b74 696d 656f 7574 7d73 220a  hin {timeout}s".
-000340c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000340d0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000340e0: 6c6f 675f 6576 656e 7428 5b63 6c69 656e  log_event([clien
-000340f0: 742c 2022 616c 6c22 5d2c 207b 2261 6374  t, "all"], {"act
-00034100: 696f 6e22 3a20 2272 6573 7461 7274 222c  ion": "restart",
-00034110: 2022 636c 6965 6e74 223a 2063 6c69 656e   "client": clien
-00034120: 747d 290a 0a20 2020 2020 2020 2069 6620  t})..        if 
-00034130: 7761 6974 5f66 6f72 5f77 6f72 6b65 7273  wait_for_workers
-00034140: 3a0a 2020 2020 2020 2020 2020 2020 7768  :.            wh
-00034150: 696c 6520 6c65 6e28 7365 6c66 2e77 6f72  ile len(self.wor
-00034160: 6b65 7273 2920 3c20 6e5f 776f 726b 6572  kers) < n_worker
-00034170: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00034180: 2020 2023 204e 4f54 453a 2069 6620 6e65     # NOTE: if ne
-00034190: 7720 2875 6e72 656c 6174 6564 2920 776f  w (unrelated) wo
-000341a0: 726b 6572 7320 6a6f 696e 2077 6869 6c65  rkers join while
-000341b0: 2077 6527 7265 2077 6169 7469 6e67 2c20   we're waiting, 
-000341c0: 7765 206d 6179 2072 6574 7572 6e20 6265  we may return be
-000341d0: 666f 7265 0a20 2020 2020 2020 2020 2020  fore.           
-000341e0: 2020 2020 2023 206f 7572 2073 6875 742d       # our shut-
-000341f0: 646f 776e 2077 6f72 6b65 7273 2068 6176  down workers hav
-00034200: 6520 636f 6d65 2062 6163 6b20 7570 2e20  e come back up. 
-00034210: 5468 6174 2773 2066 696e 653b 2077 6f72  That's fine; wor
-00034220: 6b65 7273 2061 7265 2069 6e74 6572 6368  kers are interch
-00034230: 616e 6765 6162 6c65 2e0a 2020 2020 2020  angeable..      
-00034240: 2020 2020 2020 2020 2020 6966 206d 6f6e            if mon
-00034250: 6f74 6f6e 6963 2829 203c 2073 7461 7274  otonic() < start
-00034260: 202b 2074 696d 656f 7574 3a0a 2020 2020   + timeout:.    
-00034270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034280: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
-00034290: 6565 7028 302e 3229 0a20 2020 2020 2020  eep(0.2).       
-000342a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000342b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000342c0: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
-000342d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000342e0: 2020 2066 2257 6169 7465 6420 666f 7220     f"Waited for 
-000342f0: 7b6e 5f77 6f72 6b65 7273 7d20 776f 726b  {n_workers} work
-00034300: 6572 2873 2920 746f 2072 6563 6f6e 6e65  er(s) to reconne
-00034310: 6374 2061 6674 6572 2072 6573 7461 7274  ct after restart
-00034320: 696e 672c 2022 0a20 2020 2020 2020 2020  ing, ".         
-00034330: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00034340: 2262 7574 2061 6674 6572 207b 7469 6d65  "but after {time
-00034350: 6f75 747d 732c 206f 6e6c 7920 7b6c 656e  out}s, only {len
-00034360: 2873 656c 662e 776f 726b 6572 7329 7d20  (self.workers)} 
-00034370: 6861 7665 2072 6574 7572 6e65 642e 2022  have returned. "
-00034380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034390: 2020 2020 2020 2020 2022 436f 6e73 6964           "Consid
-000343a0: 6572 2061 206c 6f6e 6765 7220 7469 6d65  er a longer time
-000343b0: 6f75 742c 206f 7220 6077 6169 745f 666f  out, or `wait_fo
-000343c0: 725f 776f 726b 6572 733d 4661 6c73 6560  r_workers=False`
-000343d0: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-000343e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000343f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00034400: 2028 6e5f 6e61 6e6e 7920 3a3d 206c 656e   (n_nanny := len
-00034410: 286e 616e 6e79 5f77 6f72 6b65 7273 2929  (nanny_workers))
-00034420: 203c 206e 5f77 6f72 6b65 7273 3a0a 2020   < n_workers:.  
-00034430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034440: 2020 2020 2020 6d73 6720 2b3d 2028 0a20        msg += (. 
-00034450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034460: 2020 2020 2020 2020 2020 2066 2220 5468             f" Th
-00034470: 6520 7b6e 5f77 6f72 6b65 7273 202d 206e  e {n_workers - n
-00034480: 5f6e 616e 6e79 7d20 776f 726b 6572 2873  _nanny} worker(s
-00034490: 2920 6e6f 7420 7573 696e 6720 4e61 6e6e  ) not using Nann
-000344a0: 6965 7320 7765 7265 206a 7573 7420 7368  ies were just sh
-000344b0: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
-000344c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000344d0: 2022 646f 776e 2069 6e73 7465 6164 206f   "down instead o
-000344e0: 6620 7265 7374 6172 7465 6420 2872 6573  f restarted (res
-000344f0: 7461 7274 2069 7320 6f6e 6c79 2070 6f73  tart is only pos
-00034500: 7369 626c 6520 7769 7468 204e 616e 6e69  sible with Nanni
-00034510: 6573 292e 2049 6620 220a 2020 2020 2020  es). If ".      
-00034520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034530: 2020 2020 2020 2279 6f75 7220 6465 706c        "your depl
-00034540: 6f79 6d65 6e74 2073 7973 7465 6d20 646f  oyment system do
-00034550: 6573 206e 6f74 2061 7574 6f6d 6174 6963  es not automatic
-00034560: 616c 6c79 2072 652d 6c61 756e 6368 2074  ally re-launch t
-00034570: 6572 6d69 6e61 7465 6420 220a 2020 2020  erminated ".    
-00034580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034590: 2020 2020 2020 2020 2270 726f 6365 7373          "process
-000345a0: 6573 2c20 7468 656e 2074 686f 7365 2077  es, then those w
-000345b0: 6f72 6b65 7273 2077 696c 6c20 6e65 7665  orkers will neve
-000345c0: 7220 636f 6d65 2062 6163 6b2c 2061 6e64  r come back, and
-000345d0: 2060 436c 6965 6e74 2e72 6573 7461 7274   `Client.restart
-000345e0: 6020 220a 2020 2020 2020 2020 2020 2020  ` ".            
-000345f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034600: 2277 696c 6c20 616c 7761 7973 2074 696d  "will always tim
-00034610: 6520 6f75 742e 2044 6f20 6e6f 7420 7573  e out. Do not us
-00034620: 6520 6043 6c69 656e 742e 7265 7374 6172  e `Client.restar
-00034630: 7460 2069 6e20 7468 6174 2063 6173 652e  t` in that case.
-00034640: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00034650: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00033ee0: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
+00033ef0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00033f00: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00033f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033f20: 2020 2020 2020 2074 696d 656f 7574 2c0a         timeout,.
+00033f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033f40: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00033f50: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
+00033f60: 6e6e 7920 696e 206e 616e 6e69 6573 0a20  nny in nannies. 
+00033f70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00033f80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00033f90: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+00033fa0: 6f6e 733d 5472 7565 2c0a 2020 2020 2020  ons=True,.      
+00033fb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00033fc0: 2020 2020 2320 4e4f 5445 3a20 7468 6520      # NOTE: the 
+00033fd0: 6057 6f72 6b65 7253 7461 7465 6020 656e  `WorkerState` en
+00033fe0: 7472 6965 7320 666f 7220 7468 6573 6520  tries for these 
+00033ff0: 776f 726b 6572 7320 7769 6c6c 2062 6520  workers will be 
+00034000: 7265 6d6f 7665 640a 2020 2020 2020 2020  removed.        
+00034010: 2020 2020 2320 6e61 7475 7261 6c6c 7920      # naturally 
+00034020: 7768 656e 2074 6865 7920 6469 7363 6f6e  when they discon
+00034030: 6e65 6374 2066 726f 6d20 7468 6520 7363  nect from the sc
+00034040: 6865 6475 6c65 722e 0a0a 2020 2020 2020  heduler...      
+00034050: 2020 2020 2020 2320 5265 6d6f 7665 2061        # Remove a
+00034060: 6e79 2077 6f72 6b65 7273 2074 6861 7420  ny workers that 
+00034070: 6661 696c 6564 2074 6f20 7368 7574 2064  failed to shut d
+00034080: 6f77 6e2c 2073 6f20 7765 2063 616e 2067  own, so we can g
+00034090: 7561 7261 6e74 6565 0a20 2020 2020 2020  uarantee.       
+000340a0: 2020 2020 2023 2074 6861 7420 6166 7465       # that afte
+000340b0: 7220 6072 6573 7461 7274 602c 2074 6865  r `restart`, the
+000340c0: 7265 2061 7265 206e 6f20 6f6c 6420 776f  re are no old wo
+000340d0: 726b 6572 7320 6172 6f75 6e64 2e0a 2020  rkers around..  
+000340e0: 2020 2020 2020 2020 2020 6261 645f 6e61            bad_na
+000340f0: 6e6e 6965 7320 3d20 5b0a 2020 2020 2020  nnies = [.      
+00034100: 2020 2020 2020 2020 2020 6164 6472 2066            addr f
+00034110: 6f72 2061 6464 722c 2072 6573 7020 696e  or addr, resp in
+00034120: 207a 6970 286e 616e 6e79 5f77 6f72 6b65   zip(nanny_worke
+00034130: 7273 2c20 7265 7370 7329 2069 6620 7265  rs, resps) if re
+00034140: 7370 2069 7320 6e6f 7420 4e6f 6e65 0a20  sp is not None. 
+00034150: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+00034160: 2020 2020 2020 2020 2069 6620 6261 645f           if bad_
+00034170: 6e61 6e6e 6965 733a 0a20 2020 2020 2020  nannies:.       
+00034180: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00034190: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
+000341a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000341b0: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
+000341c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000341d0: 6c66 2e72 656d 6f76 655f 776f 726b 6572  lf.remove_worker
+000341e0: 2861 6464 722c 2073 7469 6d75 6c75 735f  (addr, stimulus_
+000341f0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
+00034200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034210: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
+00034220: 2069 6e20 6261 645f 6e61 6e6e 6965 730a   in bad_nannies.
+00034230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034240: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00034250: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00034260: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+00034270: 696d 656f 7574 4572 726f 7228 0a20 2020  imeoutError(.   
+00034280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034290: 2066 227b 6c65 6e28 6261 645f 6e61 6e6e   f"{len(bad_nann
+000342a0: 6965 7329 7d2f 7b6c 656e 286e 616e 6e69  ies)}/{len(nanni
+000342b0: 6573 297d 206e 616e 6e79 2077 6f72 6b65  es)} nanny worke
+000342c0: 7228 7329 2064 6964 206e 6f74 2073 6875  r(s) did not shu
+000342d0: 7420 646f 776e 2077 6974 6869 6e20 7b74  t down within {t
+000342e0: 696d 656f 7574 7d73 220a 2020 2020 2020  imeout}s".      
+000342f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00034300: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
+00034310: 656e 7428 5b63 6c69 656e 742c 2022 616c  ent([client, "al
+00034320: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
+00034330: 2272 6573 7461 7274 222c 2022 636c 6965  "restart", "clie
+00034340: 6e74 223a 2063 6c69 656e 747d 290a 0a20  nt": client}).. 
+00034350: 2020 2020 2020 2069 6620 7761 6974 5f66         if wait_f
+00034360: 6f72 5f77 6f72 6b65 7273 3a0a 2020 2020  or_workers:.    
+00034370: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
+00034380: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
+00034390: 3c20 6e5f 776f 726b 6572 733a 0a20 2020  < n_workers:.   
+000343a0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+000343b0: 4f54 453a 2069 6620 6e65 7720 2875 6e72  OTE: if new (unr
+000343c0: 656c 6174 6564 2920 776f 726b 6572 7320  elated) workers 
+000343d0: 6a6f 696e 2077 6869 6c65 2077 6527 7265  join while we're
+000343e0: 2077 6169 7469 6e67 2c20 7765 206d 6179   waiting, we may
+000343f0: 2072 6574 7572 6e20 6265 666f 7265 0a20   return before. 
+00034400: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00034410: 206f 7572 2073 6875 742d 646f 776e 2077   our shut-down w
+00034420: 6f72 6b65 7273 2068 6176 6520 636f 6d65  orkers have come
+00034430: 2062 6163 6b20 7570 2e20 5468 6174 2773   back up. That's
+00034440: 2066 696e 653b 2077 6f72 6b65 7273 2061   fine; workers a
+00034450: 7265 2069 6e74 6572 6368 616e 6765 6162  re interchangeab
+00034460: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
+00034470: 2020 2020 6966 206d 6f6e 6f74 6f6e 6963      if monotonic
+00034480: 2829 203c 2073 7461 7274 202b 2074 696d  () < start + tim
+00034490: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
+000344a0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+000344b0: 6173 796e 6369 6f2e 736c 6565 7028 302e  asyncio.sleep(0.
+000344c0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
+000344d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000344e0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000344f0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00034500: 2020 2020 2020 2020 2020 2020 2066 2257               f"W
+00034510: 6169 7465 6420 666f 7220 7b6e 5f77 6f72  aited for {n_wor
+00034520: 6b65 7273 7d20 776f 726b 6572 2873 2920  kers} worker(s) 
+00034530: 746f 2072 6563 6f6e 6e65 6374 2061 6674  to reconnect aft
+00034540: 6572 2072 6573 7461 7274 696e 672c 2022  er restarting, "
+00034550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034560: 2020 2020 2020 2020 2066 2262 7574 2061           f"but a
+00034570: 6674 6572 207b 7469 6d65 6f75 747d 732c  fter {timeout}s,
+00034580: 206f 6e6c 7920 7b6c 656e 2873 656c 662e   only {len(self.
+00034590: 776f 726b 6572 7329 7d20 6861 7665 2072  workers)} have r
+000345a0: 6574 7572 6e65 642e 2022 0a20 2020 2020  eturned. ".     
+000345b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000345c0: 2020 2022 436f 6e73 6964 6572 2061 206c     "Consider a l
+000345d0: 6f6e 6765 7220 7469 6d65 6f75 742c 206f  onger timeout, o
+000345e0: 7220 6077 6169 745f 666f 725f 776f 726b  r `wait_for_work
+000345f0: 6572 733d 4661 6c73 6560 2e22 0a20 2020  ers=False`.".   
+00034600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034610: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+00034620: 2020 2020 2020 2020 6966 2028 6e5f 6e61          if (n_na
+00034630: 6e6e 7920 3a3d 206c 656e 286e 616e 6e79  nny := len(nanny
+00034640: 5f77 6f72 6b65 7273 2929 203c 206e 5f77  _workers)) < n_w
+00034650: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
 00034660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034670: 7261 6973 6520 5469 6d65 6f75 7445 7272  raise TimeoutErr
-00034680: 6f72 286d 7367 2920 6672 6f6d 204e 6f6e  or(msg) from Non
-00034690: 650a 2020 2020 2020 2020 6c6f 6767 6572  e.        logger
-000346a0: 2e69 6e66 6f28 2252 6573 7461 7274 696e  .info("Restartin
-000346b0: 6720 6669 6e69 7368 6564 2e22 290a 0a20  g finished.").. 
-000346c0: 2020 2061 7379 6e63 2064 6566 2062 726f     async def bro
-000346d0: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
-000346e0: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-000346f0: 0a20 2020 2020 2020 206d 7367 3a20 6469  .        msg: di
-00034700: 6374 2c0a 2020 2020 2020 2020 776f 726b  ct,.        work
-00034710: 6572 733a 206c 6973 745b 7374 725d 207c  ers: list[str] |
-00034720: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00034730: 2020 2020 2020 686f 7374 733a 206c 6973        hosts: lis
-00034740: 745b 7374 725d 207c 204e 6f6e 6520 3d20  t[str] | None = 
-00034750: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
-00034760: 6e6e 793a 2062 6f6f 6c20 3d20 4661 6c73  nny: bool = Fals
-00034770: 652c 0a20 2020 2020 2020 2073 6572 6961  e,.        seria
-00034780: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
-00034790: 6e65 2c0a 2020 2020 2020 2020 6f6e 5f65  ne,.        on_e
-000347a0: 7272 6f72 3a20 224c 6974 6572 616c 5b27  rror: "Literal['
-000347b0: 7261 6973 6527 2c20 2772 6574 7572 6e27  raise', 'return'
-000347c0: 2c20 2772 6574 7572 6e5f 7069 636b 6c65  , 'return_pickle
-000347d0: 272c 2027 6967 6e6f 7265 275d 2220 3d20  ', 'ignore']" = 
-000347e0: 2272 6169 7365 222c 0a20 2020 2029 202d  "raise",.    ) -
-000347f0: 3e20 6469 6374 3a20 2023 2064 6963 745b  > dict:  # dict[
-00034800: 7374 722c 2041 6e79 5d0a 2020 2020 2020  str, Any].      
-00034810: 2020 2222 2242 726f 6164 6361 7374 206d    """Broadcast m
-00034820: 6573 7361 6765 2074 6f20 776f 726b 6572  essage to worker
-00034830: 732c 2072 6574 7572 6e20 616c 6c20 7265  s, return all re
-00034840: 7375 6c74 7322 2222 0a20 2020 2020 2020  sults""".       
-00034850: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
-00034860: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00034870: 2069 6620 686f 7374 7320 6973 204e 6f6e   if hosts is Non
-00034880: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00034890: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
-000348a0: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
-000348b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000348c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000348d0: 2020 776f 726b 6572 7320 3d20 5b5d 0a20    workers = []. 
-000348e0: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
-000348f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00034900: 2020 2020 2020 2020 2066 6f72 2068 6f73           for hos
-00034910: 7420 696e 2068 6f73 7473 3a0a 2020 2020  t in hosts:.    
-00034920: 2020 2020 2020 2020 2020 2020 6468 3a20              dh: 
-00034930: 6469 6374 203d 2073 656c 662e 686f 7374  dict = self.host
-00034940: 5f69 6e66 6f2e 6765 7428 686f 7374 2920  _info.get(host) 
-00034950: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-00034960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034970: 6966 2064 6820 6973 206e 6f74 204e 6f6e  if dh is not Non
-00034980: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00034990: 2020 2020 2020 2077 6f72 6b65 7273 2e65         workers.e
-000349a0: 7874 656e 6428 6468 5b22 6164 6472 6573  xtend(dh["addres
-000349b0: 7365 7322 5d29 0a20 2020 2020 2020 2023  ses"]).        #
-000349c0: 2054 4f44 4f20 7265 706c 6163 6520 7769   TODO replace wi
-000349d0: 7468 2077 6f72 6b65 725f 6c69 7374 0a0a  th worker_list..
-000349e0: 2020 2020 2020 2020 6966 206e 616e 6e79          if nanny
-000349f0: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-00034a00: 6472 6573 7365 7320 3d20 5b73 656c 662e  dresses = [self.
-00034a10: 776f 726b 6572 735b 775d 2e6e 616e 6e79  workers[w].nanny
-00034a20: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
-00034a30: 735d 0a20 2020 2020 2020 2065 6c73 653a  s].        else:
-00034a40: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
-00034a50: 7265 7373 6573 203d 2077 6f72 6b65 7273  resses = workers
-00034a60: 0a0a 2020 2020 2020 2020 4552 524f 5220  ..        ERROR 
-00034a70: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
-00034a80: 2020 2020 6173 796e 6320 6465 6620 7365      async def se
-00034a90: 6e64 5f6d 6573 7361 6765 2861 6464 7229  nd_message(addr)
-00034aa0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00034ab0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00034ac0: 2020 2063 6f6d 6d20 3d20 6177 6169 7420     comm = await 
-00034ad0: 7365 6c66 2e72 7063 2e63 6f6e 6e65 6374  self.rpc.connect
-00034ae0: 2861 6464 7229 0a20 2020 2020 2020 2020  (addr).         
-00034af0: 2020 2020 2020 2063 6f6d 6d2e 6e61 6d65         comm.name
-00034b00: 203d 2022 5363 6865 6475 6c65 7220 4272   = "Scheduler Br
-00034b10: 6f61 6463 6173 7422 0a20 2020 2020 2020  oadcast".       
-00034b20: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00034b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b40: 2020 7265 7370 203d 2061 7761 6974 2073    resp = await s
-00034b50: 656e 645f 7265 6376 280a 2020 2020 2020  end_recv(.      
-00034b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b70: 2020 636f 6d6d 2c20 636c 6f73 653d 5472    comm, close=Tr
-00034b80: 7565 2c20 7365 7269 616c 697a 6572 733d  ue, serializers=
-00034b90: 7365 7269 616c 697a 6572 732c 202a 2a6d  serializers, **m
-00034ba0: 7367 0a20 2020 2020 2020 2020 2020 2020  sg.             
-00034bb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00034bc0: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
-00034bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00034be0: 2020 2020 2020 7365 6c66 2e72 7063 2e72        self.rpc.r
-00034bf0: 6575 7365 2861 6464 722c 2063 6f6d 6d29  euse(addr, comm)
-00034c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034c10: 2072 6574 7572 6e20 7265 7370 0a20 2020   return resp.   
-00034c20: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00034c30: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-00034c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034c50: 6c6f 6767 6572 2e65 7272 6f72 2866 2262  logger.error(f"b
-00034c60: 726f 6164 6361 7374 2074 6f20 7b61 6464  roadcast to {add
-00034c70: 727d 2066 6169 6c65 643a 207b 652e 5f5f  r} failed: {e.__
-00034c80: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-00034c90: 7d3a 207b 657d 2229 0a20 2020 2020 2020  }: {e}").       
-00034ca0: 2020 2020 2020 2020 2069 6620 6f6e 5f65           if on_e
-00034cb0: 7272 6f72 203d 3d20 2272 6169 7365 223a  rror == "raise":
-00034cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034cd0: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
-00034ce0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00034cf0: 6f6e 5f65 7272 6f72 203d 3d20 2272 6574  on_error == "ret
-00034d00: 7572 6e22 3a0a 2020 2020 2020 2020 2020  urn":.          
-00034d10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00034d20: 2065 0a20 2020 2020 2020 2020 2020 2020   e.             
-00034d30: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
-00034d40: 203d 3d20 2272 6574 7572 6e5f 7069 636b   == "return_pick
-00034d50: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
-00034d60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00034d70: 6475 6d70 7328 6529 0a20 2020 2020 2020  dumps(e).       
-00034d80: 2020 2020 2020 2020 2065 6c69 6620 6f6e           elif on
-00034d90: 5f65 7272 6f72 203d 3d20 2269 676e 6f72  _error == "ignor
-00034da0: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-00034db0: 2020 2020 2020 2020 7265 7475 726e 2045          return E
-00034dc0: 5252 4f52 0a20 2020 2020 2020 2020 2020  RROR.           
-00034dd0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00034de0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00034df0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00034e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034e10: 2020 2020 2020 2020 2022 6f6e 5f65 7272           "on_err
-00034e20: 6f72 206d 7573 7420 6265 2027 7261 6973  or must be 'rais
-00034e30: 6527 2c20 2772 6574 7572 6e27 2c20 2772  e', 'return', 'r
-00034e40: 6574 7572 6e5f 7069 636b 6c65 272c 2022  eturn_pickle', "
-00034e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034e60: 2020 2020 2020 2020 2066 226f 7220 2769           f"or 'i
-00034e70: 676e 6f72 6527 3b20 676f 7420 7b6f 6e5f  gnore'; got {on_
-00034e80: 6572 726f 7221 727d 220a 2020 2020 2020  error!r}".      
-00034e90: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00034ea0: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-00034eb0: 203d 2061 7761 6974 2041 6c6c 280a 2020   = await All(.  
-00034ec0: 2020 2020 2020 2020 2020 5b73 656e 645f            [send_
-00034ed0: 6d65 7373 6167 6528 6164 6472 6573 7329  message(address)
-00034ee0: 2066 6f72 2061 6464 7265 7373 2069 6e20   for address in 
-00034ef0: 6164 6472 6573 7365 7320 6966 2061 6464  addresses if add
-00034f00: 7265 7373 2069 7320 6e6f 7420 4e6f 6e65  ress is not None
-00034f10: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
-00034f20: 2020 2020 2072 6574 7572 6e20 7b6b 3a20       return {k: 
-00034f30: 7620 666f 7220 6b2c 2076 2069 6e20 7a69  v for k, v in zi
-00034f40: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
-00034f50: 7473 2920 6966 2076 2069 7320 6e6f 7420  ts) if v is not 
-00034f60: 4552 524f 527d 0a0a 2020 2020 6173 796e  ERROR}..    asyn
-00034f70: 6320 6465 6620 7072 6f78 7928 0a20 2020  c def proxy(.   
-00034f80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00034f90: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
-00034fa0: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
-00034fb0: 722c 0a20 2020 2020 2020 2073 6572 6961  r,.        seria
-00034fc0: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
-00034fd0: 6e65 2c0a 2020 2020 2920 2d3e 2041 6e79  ne,.    ) -> Any
-00034fe0: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
-00034ff0: 7879 2061 2063 6f6d 6d75 6e69 6361 7469  xy a communicati
-00035000: 6f6e 2074 6872 6f75 6768 2074 6865 2073  on through the s
-00035010: 6368 6564 756c 6572 2074 6f20 736f 6d65  cheduler to some
-00035020: 206f 7468 6572 2077 6f72 6b65 7222 2222   other worker"""
-00035030: 0a20 2020 2020 2020 2064 203d 2061 7761  .        d = awa
-00035040: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
-00035050: 7428 6d73 673d 6d73 672c 2077 6f72 6b65  t(msg=msg, worke
-00035060: 7273 3d5b 776f 726b 6572 5d2c 2073 6572  rs=[worker], ser
-00035070: 6961 6c69 7a65 7273 3d73 6572 6961 6c69  ializers=seriali
-00035080: 7a65 7273 290a 2020 2020 2020 2020 7265  zers).        re
-00035090: 7475 726e 2064 5b77 6f72 6b65 725d 0a0a  turn d[worker]..
-000350a0: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
-000350b0: 7468 6572 5f6f 6e5f 776f 726b 6572 280a  ther_on_worker(.
-000350c0: 2020 2020 2020 2020 7365 6c66 2c20 776f          self, wo
-000350d0: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
-000350e0: 722c 2077 686f 5f68 6173 3a20 2264 6963  r, who_has: "dic
-000350f0: 745b 7374 722c 206c 6973 745b 7374 725d  t[str, list[str]
-00035100: 5d22 0a20 2020 2029 202d 3e20 7365 743a  ]".    ) -> set:
-00035110: 0a20 2020 2020 2020 2022 2222 5065 6572  .        """Peer
-00035120: 2d74 6f2d 7065 6572 2063 6f70 7920 6f66  -to-peer copy of
-00035130: 206b 6579 7320 6672 6f6d 206d 756c 7469   keys from multi
-00035140: 706c 6520 776f 726b 6572 7320 746f 2061  ple workers to a
-00035150: 2073 696e 676c 6520 776f 726b 6572 0a0a   single worker..
-00035160: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00035170: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-00035180: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
-00035190: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
-000351a0: 720a 2020 2020 2020 2020 2020 2020 5265  r.            Re
-000351b0: 6369 7069 656e 7420 776f 726b 6572 2061  cipient worker a
-000351c0: 6464 7265 7373 2074 6f20 636f 7079 206b  ddress to copy k
-000351d0: 6579 7320 746f 0a20 2020 2020 2020 2077  eys to.        w
-000351e0: 686f 5f68 6173 3a20 6469 6374 5b48 6173  ho_has: dict[Has
-000351f0: 6861 626c 652c 206c 6973 745b 7374 725d  hable, list[str]
-00035200: 5d0a 2020 2020 2020 2020 2020 2020 7b6b  ].            {k
-00035210: 6579 3a20 5b73 656e 6465 7220 6164 6472  ey: [sender addr
-00035220: 6573 732c 2073 656e 6465 7220 6164 6472  ess, sender addr
-00035230: 6573 732c 202e 2e2e 5d2c 206b 6579 3a20  ess, ...], key: 
-00035240: 2e2e 2e7d 0a0a 2020 2020 2020 2020 5265  ...}..        Re
-00035250: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
-00035260: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7265  -----.        re
-00035270: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-00035280: 2020 2073 6574 206f 6620 6b65 7973 2074     set of keys t
-00035290: 6861 7420 6661 696c 6564 2074 6f20 6265  hat failed to be
-000352a0: 2063 6f70 6965 640a 2020 2020 2020 2020   copied.        
-000352b0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-000352c0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-000352d0: 756c 7420 3d20 6177 6169 7420 7265 7472  ult = await retr
-000352e0: 795f 6f70 6572 6174 696f 6e28 0a20 2020  y_operation(.   
-000352f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00035300: 662e 7270 6328 6164 6472 3d77 6f72 6b65  f.rpc(addr=worke
-00035310: 725f 6164 6472 6573 7329 2e67 6174 6865  r_address).gathe
-00035320: 722c 2077 686f 5f68 6173 3d77 686f 5f68  r, who_has=who_h
-00035330: 6173 0a20 2020 2020 2020 2020 2020 2029  as.            )
-00035340: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00035350: 4f53 4572 726f 7220 6173 2065 3a0a 2020  OSError as e:.  
-00035360: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-00035370: 2063 616e 2068 6170 7065 6e20 652e 672e   can happen e.g.
-00035380: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
-00035390: 7320 676f 696e 6720 7468 726f 7567 6820  s going through 
-000353a0: 636f 6e74 726f 6c6c 6564 2073 6875 7464  controlled shutd
-000353b0: 6f77 6e3b 0a20 2020 2020 2020 2020 2020  own;.           
-000353c0: 2023 2069 7420 646f 6573 6e27 7420 6e65   # it doesn't ne
-000353d0: 6365 7373 6172 696c 7920 6d65 616e 2074  cessarily mean t
-000353e0: 6861 7420 6974 2077 656e 7420 756e 6578  hat it went unex
-000353f0: 7065 6374 6564 6c79 206d 6973 7369 6e67  pectedly missing
-00035400: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00035410: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-00035420: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
-00035430: 6f6d 6d75 6e69 6361 7469 6f6e 2077 6974  ommunication wit
-00035440: 6820 776f 726b 6572 207b 776f 726b 6572  h worker {worker
-00035450: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
-00035460: 2064 7572 696e 6720 220a 2020 2020 2020   during ".      
-00035470: 2020 2020 2020 2020 2020 6622 7265 706c            f"repl
-00035480: 6963 6174 696f 6e3a 207b 652e 5f5f 636c  ication: {e.__cl
-00035490: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d3a  ass__.__name__}:
-000354a0: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
-000354b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000354c0: 7265 7475 726e 2073 6574 2877 686f 5f68  return set(who_h
-000354d0: 6173 290a 0a20 2020 2020 2020 2077 7320  as)..        ws 
-000354e0: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
-000354f0: 6574 2877 6f72 6b65 725f 6164 6472 6573  et(worker_addres
-00035500: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
-00035510: 6f74 2077 733a 0a20 2020 2020 2020 2020  ot ws:.         
-00035520: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00035530: 6728 6622 576f 726b 6572 207b 776f 726b  g(f"Worker {work
-00035540: 6572 5f61 6464 7265 7373 7d20 6c6f 7374  er_address} lost
-00035550: 2064 7572 696e 6720 7265 706c 6963 6174   during replicat
-00035560: 696f 6e22 290a 2020 2020 2020 2020 2020  ion").          
-00035570: 2020 7265 7475 726e 2073 6574 2877 686f    return set(who
-00035580: 5f68 6173 290a 2020 2020 2020 2020 656c  _has).        el
-00035590: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
-000355a0: 7322 5d20 3d3d 2022 4f4b 223a 0a20 2020  s"] == "OK":.   
-000355b0: 2020 2020 2020 2020 206b 6579 735f 6661           keys_fa
-000355c0: 696c 6564 203d 2073 6574 2829 0a20 2020  iled = set().   
-000355d0: 2020 2020 2020 2020 206b 6579 735f 6f6b           keys_ok
-000355e0: 3a20 5365 7420 3d20 7768 6f5f 6861 732e  : Set = who_has.
-000355f0: 6b65 7973 2829 0a20 2020 2020 2020 2065  keys().        e
-00035600: 6c69 6620 7265 7375 6c74 5b22 7374 6174  lif result["stat
-00035610: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
-00035620: 2d66 6169 6c22 3a0a 2020 2020 2020 2020  -fail":.        
-00035630: 2020 2020 6b65 7973 5f66 6169 6c65 6420      keys_failed 
-00035640: 3d20 7365 7428 7265 7375 6c74 5b22 6b65  = set(result["ke
-00035650: 7973 225d 290a 2020 2020 2020 2020 2020  ys"]).          
-00035660: 2020 6b65 7973 5f6f 6b20 3d20 7768 6f5f    keys_ok = who_
-00035670: 6861 732e 6b65 7973 2829 202d 206b 6579  has.keys() - key
-00035680: 735f 6661 696c 6564 0a20 2020 2020 2020  s_failed.       
-00035690: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
-000356a0: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-000356b0: 2020 2020 2066 2257 6f72 6b65 7220 7b77       f"Worker {w
-000356c0: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
-000356d0: 6169 6c65 6420 746f 2061 6371 7569 7265  ailed to acquire
-000356e0: 206b 6579 733a 207b 7265 7375 6c74 5b27   keys: {result['
-000356f0: 6b65 7973 275d 7d22 0a20 2020 2020 2020  keys']}".       
-00035700: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-00035710: 6c73 653a 2020 2320 7072 6167 6d61 3a20  lse:  # pragma: 
-00035720: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
-00035730: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00035740: 7272 6f72 2866 2255 6e65 7870 6563 7465  rror(f"Unexpecte
-00035750: 6420 6d65 7373 6167 6520 6672 6f6d 207b  d message from {
-00035760: 776f 726b 6572 5f61 6464 7265 7373 7d3a  worker_address}:
-00035770: 207b 7265 7375 6c74 7d22 290a 0a20 2020   {result}")..   
-00035780: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-00035790: 6b65 7973 5f6f 6b3a 0a20 2020 2020 2020  keys_ok:.       
-000357a0: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-000357b0: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
-000357c0: 6765 7428 6b65 7929 2020 2320 7479 7065  get(key)  # type
-000357d0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-000357e0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-000357f0: 6e65 206f 7220 7473 2e73 7461 7465 2021  ne or ts.state !
-00035800: 3d20 226d 656d 6f72 7922 3a0a 2020 2020  = "memory":.    
-00035810: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00035820: 6572 2e77 6172 6e69 6e67 2866 224b 6579  er.warning(f"Key
-00035830: 206c 6f73 7420 6475 7269 6e67 2072 6570   lost during rep
-00035840: 6c69 6361 7469 6f6e 3a20 7b6b 6579 7d22  lication: {key}"
-00035850: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00035860: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00035870: 2020 2020 2020 2069 6620 7773 206e 6f74         if ws not
-00035880: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
-00035890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000358a0: 7365 6c66 2e61 6464 5f72 6570 6c69 6361  self.add_replica
-000358b0: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
-000358c0: 2020 7265 7475 726e 206b 6579 735f 6661    return keys_fa
-000358d0: 696c 6564 0a0a 2020 2020 6173 796e 6320  iled..    async 
-000358e0: 6465 6620 6465 6c65 7465 5f77 6f72 6b65  def delete_worke
-000358f0: 725f 6461 7461 280a 2020 2020 2020 2020  r_data(.        
-00035900: 7365 6c66 2c20 776f 726b 6572 5f61 6464  self, worker_add
-00035910: 7265 7373 3a20 7374 722c 206b 6579 733a  ress: str, keys:
-00035920: 2022 436f 6c6c 6563 7469 6f6e 5b73 7472   "Collection[str
-00035930: 5d22 2c20 7374 696d 756c 7573 5f69 643a  ]", stimulus_id:
-00035940: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
-00035950: 6e65 3a0a 2020 2020 2020 2020 2222 2244  ne:.        """D
-00035960: 656c 6574 6520 6461 7461 2066 726f 6d20  elete data from 
-00035970: 6120 776f 726b 6572 2061 6e64 2075 7064  a worker and upd
-00035980: 6174 6520 7468 6520 636f 7272 6573 706f  ate the correspo
-00035990: 6e64 696e 6720 776f 726b 6572 2f74 6173  nding worker/tas
-000359a0: 6b20 7374 6174 6573 0a0a 2020 2020 2020  k states..      
-000359b0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-000359c0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
-000359d0: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
-000359e0: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
-000359f0: 2020 2020 2020 2020 576f 726b 6572 2061          Worker a
-00035a00: 6464 7265 7373 2074 6f20 6465 6c65 7465  ddress to delete
-00035a10: 206b 6579 7320 6672 6f6d 0a20 2020 2020   keys from.     
-00035a20: 2020 206b 6579 733a 206c 6973 745b 7374     keys: list[st
-00035a30: 725d 0a20 2020 2020 2020 2020 2020 204c  r].            L
-00035a40: 6973 7420 6f66 206b 6579 7320 746f 2064  ist of keys to d
-00035a50: 656c 6574 6520 6f6e 2074 6865 2073 7065  elete on the spe
-00035a60: 6369 6669 6564 2077 6f72 6b65 720a 2020  cified worker.  
-00035a70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00035a80: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00035a90: 2020 2061 7761 6974 2072 6574 7279 5f6f     await retry_o
-00035aa0: 7065 7261 7469 6f6e 280a 2020 2020 2020  peration(.      
-00035ab0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00035ac0: 7063 2861 6464 723d 776f 726b 6572 5f61  pc(addr=worker_a
-00035ad0: 6464 7265 7373 292e 6672 6565 5f6b 6579  ddress).free_key
-00035ae0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00035af0: 2020 206b 6579 733d 6c69 7374 286b 6579     keys=list(key
-00035b00: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00035b10: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
-00035b20: 6622 6465 6c65 7465 2d64 6174 612d 7b74  f"delete-data-{t
-00035b30: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
-00035b40: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-00035b50: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-00035b60: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00035b70: 2320 5468 6973 2063 616e 2068 6170 7065  # This can happe
-00035b80: 6e20 652e 672e 2069 6620 7468 6520 776f  n e.g. if the wo
-00035b90: 726b 6572 2069 7320 676f 696e 6720 7468  rker is going th
-00035ba0: 726f 7567 6820 636f 6e74 726f 6c6c 6564  rough controlled
-00035bb0: 2073 6875 7464 6f77 6e3b 0a20 2020 2020   shutdown;.     
-00035bc0: 2020 2020 2020 2023 2069 7420 646f 6573         # it does
-00035bd0: 6e27 7420 6e65 6365 7373 6172 696c 7920  n't necessarily 
-00035be0: 6d65 616e 2074 6861 7420 6974 2077 656e  mean that it wen
-00035bf0: 7420 756e 6578 7065 6374 6564 6c79 206d  t unexpectedly m
-00035c00: 6973 7369 6e67 0a20 2020 2020 2020 2020  issing.         
-00035c10: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00035c20: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00035c30: 2020 2066 2243 6f6d 6d75 6e69 6361 7469     f"Communicati
-00035c40: 6f6e 2077 6974 6820 776f 726b 6572 207b  on with worker {
-00035c50: 776f 726b 6572 5f61 6464 7265 7373 7d20  worker_address} 
-00035c60: 6661 696c 6564 2064 7572 696e 6720 220a  failed during ".
-00035c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035c80: 6622 7265 706c 6963 6174 696f 6e3a 207b  f"replication: {
-00035c90: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
-00035ca0: 6d65 5f5f 7d3a 207b 657d 220a 2020 2020  me__}: {e}".    
-00035cb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00035cc0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00035cd0: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00035ce0: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
-00035cf0: 6572 5f61 6464 7265 7373 290a 2020 2020  er_address).    
-00035d00: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
-00035d10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00035d20: 6e0a 0a20 2020 2020 2020 2066 6f72 206b  n..        for k
-00035d30: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-00035d40: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
-00035d50: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
-00035d60: 6b73 2e67 6574 286b 6579 2920 2023 2074  ks.get(key)  # t
-00035d70: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00035d80: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-00035d90: 206e 6f74 204e 6f6e 6520 616e 6420 7773   not None and ws
-00035da0: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
-00035db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035dc0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-00035dd0: 3d3d 2022 6d65 6d6f 7279 220a 2020 2020  == "memory".    
-00035de0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00035df0: 2e72 656d 6f76 655f 7265 706c 6963 6128  .remove_replica(
-00035e00: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
-00035e10: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-00035e20: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
-00035e30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00035e40: 204c 6173 7420 636f 7079 2064 656c 6574   Last copy delet
-00035e50: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-00035e60: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-00035e70: 7369 7469 6f6e 7328 7b6b 6579 3a20 2272  sitions({key: "r
-00035e80: 656c 6561 7365 6422 7d2c 2073 7469 6d75  eleased"}, stimu
-00035e90: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
-00035ea0: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-00035eb0: 7773 2e61 6464 7265 7373 2c20 7b22 6163  ws.address, {"ac
-00035ec0: 7469 6f6e 223a 2022 7265 6d6f 7665 2d77  tion": "remove-w
-00035ed0: 6f72 6b65 722d 6461 7461 222c 2022 6b65  orker-data", "ke
-00035ee0: 7973 223a 206b 6579 737d 290a 0a20 2020  ys": keys})..   
-00035ef0: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-00035f00: 2061 7379 6e63 2064 6566 2072 6562 616c   async def rebal
-00035f10: 616e 6365 280a 2020 2020 2020 2020 7365  ance(.        se
-00035f20: 6c66 2c0a 2020 2020 2020 2020 6b65 7973  lf,.        keys
-00035f30: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
-00035f40: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00035f50: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
-00035f60: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-00035f70: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00035f80: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00035f90: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-00035fa0: 6f6e 652c 0a20 2020 2029 202d 3e20 6469  one,.    ) -> di
-00035fb0: 6374 3a0a 2020 2020 2020 2020 2222 2252  ct:.        """R
-00035fc0: 6562 616c 616e 6365 206b 6579 7320 736f  ebalance keys so
-00035fd0: 2074 6861 7420 6561 6368 2077 6f72 6b65   that each worke
-00035fe0: 7220 656e 6473 2075 7020 7769 7468 2072  r ends up with r
-00035ff0: 6f75 6768 6c79 2074 6865 2073 616d 6520  oughly the same 
-00036000: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-00036010: 6d65 6d6f 7279 2028 6d61 6e61 6765 642b  memory (managed+
-00036020: 756e 6d61 6e61 6765 6429 2e0a 0a20 2020  unmanaged)...   
-00036030: 2020 2020 202e 2e20 7761 726e 696e 673a       .. warning:
-00036040: 3a0a 2020 2020 2020 2020 2020 2054 6869  :.           Thi
-00036050: 7320 6f70 6572 6174 696f 6e20 6973 2067  s operation is g
-00036060: 656e 6572 616c 6c79 206e 6f74 2077 656c  enerally not wel
-00036070: 6c20 7465 7374 6564 2061 6761 696e 7374  l tested against
-00036080: 206e 6f72 6d61 6c20 6f70 6572 6174 696f   normal operatio
-00036090: 6e20 6f66 2074 6865 0a20 2020 2020 2020  n of the.       
-000360a0: 2020 2020 7363 6865 6475 6c65 722e 2049      scheduler. I
-000360b0: 7420 6973 206e 6f74 2072 6563 6f6d 6d65  t is not recomme
-000360c0: 6e64 6564 2074 6f20 7573 6520 6974 2077  nded to use it w
-000360d0: 6869 6c65 2077 6169 7469 6e67 206f 6e20  hile waiting on 
-000360e0: 636f 6d70 7574 6174 696f 6e73 2e0a 0a20  computations... 
-000360f0: 2020 2020 2020 202a 2a41 6c67 6f72 6974         **Algorit
-00036100: 686d 2a2a 0a0a 2020 2020 2020 2020 232e  hm**..        #.
-00036110: 2046 696e 6420 7468 6520 6d65 616e 206f   Find the mean o
-00036120: 6363 7570 616e 6379 206f 6620 7468 6520  ccupancy of the 
-00036130: 636c 7573 7465 722c 2064 6566 696e 6564  cluster, defined
-00036140: 2061 7320 6461 7461 206d 616e 6167 6564   as data managed
-00036150: 2062 7920 6461 736b 202b 0a20 2020 2020   by dask +.     
-00036160: 2020 2020 2020 756e 6d61 6e61 6765 6420        unmanaged 
-00036170: 7072 6f63 6573 7320 6d65 6d6f 7279 2074  process memory t
-00036180: 6861 7420 6861 7320 6265 656e 2074 6865  hat has been the
-00036190: 7265 2066 6f72 2061 7420 6c65 6173 7420  re for at least 
-000361a0: 3330 2073 6563 6f6e 6473 0a20 2020 2020  30 seconds.     
-000361b0: 2020 2020 2020 2860 6064 6973 7472 6962        (``distrib
-000361c0: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-000361d0: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-000361e0: 2d74 696d 6560 6029 2e0a 2020 2020 2020  -time``)..      
-000361f0: 2020 2020 2054 6869 7320 6c65 7473 2075       This lets u
-00036200: 7320 6967 6e6f 7265 2074 656d 706f 7261  s ignore tempora
-00036210: 7279 2073 7069 6b65 7320 6361 7573 6564  ry spikes caused
-00036220: 2062 7920 7461 736b 2068 6561 7020 7573   by task heap us
-00036230: 6167 652e 0a0a 2020 2020 2020 2020 2020  age...          
-00036240: 2041 6c74 6572 6e61 7469 7665 6c79 2c20   Alternatively, 
-00036250: 796f 7520 6d61 7920 6368 616e 6765 2068  you may change h
-00036260: 6f77 206d 656d 6f72 7920 6973 206d 6561  ow memory is mea
-00036270: 7375 7265 6420 626f 7468 2066 6f72 2074  sured both for t
-00036280: 6865 2069 6e64 6976 6964 7561 6c0a 2020  he individual.  
-00036290: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-000362a0: 2061 7320 7765 6c6c 2061 7320 746f 2063   as well as to c
-000362b0: 616c 6375 6c61 7465 2074 6865 206d 6561  alculate the mea
-000362c0: 6e20 7468 726f 7567 680a 2020 2020 2020  n through.      
-000362d0: 2020 2020 2060 6064 6973 7472 6962 7574       ``distribut
-000362e0: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-000362f0: 2e72 6562 616c 616e 6365 2e6d 6561 7375  .rebalance.measu
-00036300: 7265 6060 2e20 4e61 6d65 6c79 2c20 7468  re``. Namely, th
-00036310: 6973 2063 616e 2062 6520 7573 6566 756c  is can be useful
-00036320: 0a20 2020 2020 2020 2020 2020 746f 2064  .           to d
-00036330: 6973 7265 6761 7264 2069 6e61 6363 7572  isregard inaccur
-00036340: 6174 6520 4f53 206d 656d 6f72 7920 6d65  ate OS memory me
-00036350: 6173 7572 656d 656e 7473 2e0a 0a20 2020  asurements...   
-00036360: 2020 2020 2023 2e20 4469 7363 6172 6420       #. Discard 
-00036370: 776f 726b 6572 7320 7768 6f73 6520 6f63  workers whose oc
-00036380: 6375 7061 6e63 7920 6973 2077 6974 6869  cupancy is withi
-00036390: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
-000363a0: 2063 6c75 7374 6572 206f 6363 7570 616e   cluster occupan
-000363b0: 6379 0a20 2020 2020 2020 2020 2020 2860  cy.           (`
-000363c0: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
-000363d0: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
-000363e0: 616e 6365 2e73 656e 6465 722d 7265 6369  ance.sender-reci
-000363f0: 7069 656e 742d 6761 7060 6020 2f20 3229  pient-gap`` / 2)
-00036400: 2e0a 2020 2020 2020 2020 2020 2054 6869  ..           Thi
-00036410: 7320 6865 6c70 7320 6176 6f69 6420 6461  s helps avoid da
-00036420: 7461 2066 726f 6d20 626f 756e 6369 6e67  ta from bouncing
-00036430: 2061 726f 756e 6420 7468 6520 636c 7573   around the clus
-00036440: 7465 7220 7265 7065 6174 6564 6c79 2e0a  ter repeatedly..
-00036450: 2020 2020 2020 2020 232e 2057 6f72 6b65          #. Worke
-00036460: 7273 2061 626f 7665 2074 6865 206d 6561  rs above the mea
-00036470: 6e20 6172 6520 7365 6e64 6572 733b 2074  n are senders; t
-00036480: 686f 7365 2062 656c 6f77 2061 7265 2072  hose below are r
-00036490: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
-000364a0: 2020 2023 2e20 4469 7363 6172 6420 7365     #. Discard se
-000364b0: 6e64 6572 7320 7768 6f73 6520 6162 736f  nders whose abso
-000364c0: 6c75 7465 206f 6363 7570 616e 6379 2069  lute occupancy i
-000364d0: 7320 6265 6c6f 7720 3330 250a 2020 2020  s below 30%.    
-000364e0: 2020 2020 2020 2028 6060 6469 7374 7269         (``distri
-000364f0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-00036500: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
-00036510: 6e64 6572 2d6d 696e 6060 292e 2049 6e20  nder-min``). In 
-00036520: 6f74 6865 7220 776f 7264 732c 206e 6f20  other words, no 
-00036530: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-00036540: 6973 206d 6f76 6564 2072 6567 6172 646c  is moved regardl
-00036550: 6573 7320 6f66 2069 6d62 616c 616e 6369  ess of imbalanci
-00036560: 6e67 2061 7320 6c6f 6e67 2061 7320 616c  ng as long as al
-00036570: 6c20 776f 726b 6572 7320 6172 6520 6265  l workers are be
-00036580: 6c6f 7720 3330 252e 0a20 2020 2020 2020  low 30%..       
-00036590: 2023 2e20 4469 7363 6172 6420 7265 6369   #. Discard reci
-000365a0: 7069 656e 7473 2077 686f 7365 2061 6273  pients whose abs
-000365b0: 6f6c 7574 6520 6f63 6375 7061 6e63 7920  olute occupancy 
-000365c0: 6973 2061 626f 7665 2036 3025 0a20 2020  is above 60%.   
-000365d0: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
-000365e0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-000365f0: 6d6f 7279 2e72 6562 616c 616e 6365 2e72  mory.rebalance.r
-00036600: 6563 6970 6965 6e74 2d6d 6178 6060 292e  ecipient-max``).
-00036610: 0a20 2020 2020 2020 2020 2020 4e6f 7465  .           Note
-00036620: 2074 6861 7420 7468 6973 2074 6872 6573   that this thres
-00036630: 686f 6c64 2062 7920 6465 6661 756c 7420  hold by default 
-00036640: 6973 2074 6865 2073 616d 6520 6173 0a20  is the same as. 
-00036650: 2020 2020 2020 2020 2020 6060 6469 7374            ``dist
-00036660: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-00036670: 656d 6f72 792e 7461 7267 6574 6060 2074  emory.target`` t
-00036680: 6f20 7072 6576 656e 7420 776f 726b 6572  o prevent worker
-00036690: 7320 6672 6f6d 2061 6363 6570 7469 6e67  s from accepting
-000366a0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-000366b0: 2061 6e64 2069 6d6d 6564 6961 7465 6c79   and immediately
-000366c0: 2073 7069 6c6c 696e 6720 6974 206f 7574   spilling it out
-000366d0: 2074 6f20 6469 736b 2e0a 2020 2020 2020   to disk..      
-000366e0: 2020 232e 2049 7465 7261 7469 7665 6c79    #. Iteratively
-000366f0: 2070 6963 6b20 7468 6520 7365 6e64 6572   pick the sender
-00036700: 2061 6e64 2072 6563 6970 6965 6e74 2074   and recipient t
-00036710: 6861 7420 6172 6520 6661 7274 6865 7374  hat are farthest
-00036720: 2066 726f 6d20 7468 6520 6d65 616e 2061   from the mean a
-00036730: 6e64 0a20 2020 2020 2020 2020 2020 6d6f  nd.           mo
-00036740: 7665 2074 6865 202a 6c65 6173 7420 7265  ve the *least re
-00036750: 6365 6e74 6c79 2069 6e73 6572 7465 642a  cently inserted*
-00036760: 206b 6579 2062 6574 7765 656e 2074 6865   key between the
-00036770: 2074 776f 2c20 756e 7469 6c20 6569 7468   two, until eith
-00036780: 6572 2061 6c6c 0a20 2020 2020 2020 2020  er all.         
-00036790: 2020 7365 6e64 6572 7320 6f72 2061 6c6c    senders or all
-000367a0: 2072 6563 6970 6965 6e74 7320 6661 6c6c   recipients fall
-000367b0: 2077 6974 6869 6e20 3525 206f 6620 7468   within 5% of th
-000367c0: 6520 6d65 616e 2e0a 0a20 2020 2020 2020  e mean...       
-000367d0: 2020 2020 4120 7265 6369 7069 656e 7420      A recipient 
-000367e0: 7769 6c6c 2062 6520 736b 6970 7065 6420  will be skipped 
-000367f0: 6966 2069 7420 616c 7265 6164 7920 6861  if it already ha
-00036800: 7320 6120 636f 7079 206f 6620 7468 6520  s a copy of the 
-00036810: 6461 7461 2e20 496e 206f 7468 6572 0a20  data. In other. 
-00036820: 2020 2020 2020 2020 2020 776f 7264 732c            words,
-00036830: 2074 6869 7320 6d65 7468 6f64 2064 6f65   this method doe
-00036840: 7320 6e6f 7420 6465 6772 6164 6520 7265  s not degrade re
-00036850: 706c 6963 6174 696f 6e2e 0a20 2020 2020  plication..     
-00036860: 2020 2020 2020 4120 6b65 7920 7769 6c6c        A key will
-00036870: 2062 6520 736b 6970 7065 6420 6966 2074   be skipped if t
-00036880: 6865 7265 2061 7265 206e 6f20 7265 6369  here are no reci
-00036890: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
-000368a0: 2077 6974 6820 656e 6f75 6768 206d 656d   with enough mem
-000368b0: 6f72 790a 2020 2020 2020 2020 2020 2074  ory.           t
-000368c0: 6f20 6163 6365 7074 2074 6865 206b 6579  o accept the key
-000368d0: 2061 6e64 2074 6861 7420 646f 6e27 7420   and that don't 
-000368e0: 616c 7265 6164 7920 686f 6c64 2061 2063  already hold a c
-000368f0: 6f70 792e 0a0a 2020 2020 2020 2020 5468  opy...        Th
-00036900: 6520 6c65 6173 7420 7265 6365 6e74 6c79  e least recently
-00036910: 2069 6e73 6572 7464 2028 4c52 4929 2070   insertd (LRI) p
-00036920: 6f6c 6963 7920 6973 2061 2067 7265 6564  olicy is a greed
-00036930: 7920 6368 6f69 6365 2077 6974 6820 7468  y choice with th
-00036940: 6520 6164 7661 6e74 6167 6520 6f66 0a20  e advantage of. 
-00036950: 2020 2020 2020 2062 6569 6e67 204f 2831         being O(1
-00036960: 292c 2074 7269 7669 616c 2074 6f20 696d  ), trivial to im
-00036970: 706c 656d 656e 7420 2869 7420 7265 6c69  plement (it reli
-00036980: 6573 206f 6e20 7079 7468 6f6e 2064 6963  es on python dic
-00036990: 7420 696e 7365 7274 696f 6e2d 736f 7274  t insertion-sort
-000369a0: 696e 6729 0a20 2020 2020 2020 2061 6e64  ing).        and
-000369b0: 2068 6f70 6566 756c 6c79 2067 6f6f 6420   hopefully good 
-000369c0: 656e 6f75 6768 2069 6e20 6d6f 7374 2063  enough in most c
-000369d0: 6173 6573 2e20 4469 7363 6172 6465 6420  ases. Discarded 
-000369e0: 616c 7465 726e 6174 6976 6520 706f 6c69  alternative poli
-000369f0: 6369 6573 2077 6572 653a 0a0a 2020 2020  cies were:..    
-00036a00: 2020 2020 2d20 4c61 7267 6573 7420 6669      - Largest fi
-00036a10: 7273 742e 204f 286e 2a6c 6f67 286e 2929  rst. O(n*log(n))
-00036a20: 2073 6176 6520 666f 7220 6e6f 6e2d 7472   save for non-tr
-00036a30: 6976 6961 6c20 6164 6469 7469 6f6e 616c  ivial additional
-00036a40: 2064 6174 6120 7374 7275 6374 7572 6573   data structures
-00036a50: 2061 6e64 0a20 2020 2020 2020 2020 2072   and.          r
-00036a60: 6973 6b73 2063 6175 7369 6e67 2074 6865  isks causing the
-00036a70: 206c 6172 6765 7374 2063 6875 6e6b 7320   largest chunks 
-00036a80: 6f66 2064 6174 6120 746f 2072 6570 6561  of data to repea
-00036a90: 7465 646c 7920 6d6f 7665 2061 726f 756e  tedly move aroun
-00036aa0: 6420 7468 650a 2020 2020 2020 2020 2020  d the.          
-00036ab0: 636c 7573 7465 7220 6c69 6b65 2070 696e  cluster like pin
-00036ac0: 6261 6c6c 732e 0a20 2020 2020 2020 202d  balls..        -
-00036ad0: 204c 6561 7374 2072 6563 656e 746c 7920   Least recently 
-00036ae0: 7573 6564 2028 4c52 5529 2e20 5468 6973  used (LRU). This
-00036af0: 2069 6e66 6f72 6d61 7469 6f6e 2069 7320   information is 
-00036b00: 6375 7272 656e 746c 7920 6176 6169 6c61  currently availa
-00036b10: 626c 6520 6f6e 2074 6865 0a20 2020 2020  ble on the.     
-00036b20: 2020 2020 2077 6f72 6b65 7273 206f 6e6c       workers onl
-00036b30: 7920 616e 6420 6e6f 7420 7472 6976 6961  y and not trivia
-00036b40: 6c20 746f 2072 6570 6c69 6361 7465 206f  l to replicate o
-00036b50: 6e20 7468 6520 7363 6865 6475 6c65 723b  n the scheduler;
-00036b60: 2074 7261 6e73 6d69 7474 696e 6720 6974   transmitting it
-00036b70: 0a20 2020 2020 2020 2020 206f 7665 7220  .          over 
-00036b80: 7468 6520 6e65 7477 6f72 6b20 776f 756c  the network woul
-00036b90: 6420 6265 2076 6572 7920 6578 7065 6e73  d be very expens
-00036ba0: 6976 652e 2041 6c73 6f2c 206e 6f74 6520  ive. Also, note 
-00036bb0: 7468 6174 2064 6173 6b20 7769 6c6c 2067  that dask will g
-00036bc0: 6f20 6f75 7420 6f66 0a20 2020 2020 2020  o out of.       
-00036bd0: 2020 2069 7473 2077 6179 2074 6f20 6d69     its way to mi
-00036be0: 6e69 6d69 7365 2074 6865 2061 6d6f 756e  nimise the amoun
-00036bf0: 7420 6f66 2074 696d 6520 696e 7465 726d  t of time interm
-00036c00: 6564 6961 7465 206b 6579 7320 6172 6520  ediate keys are 
-00036c10: 6865 6c64 2069 6e20 6d65 6d6f 7279 2c0a  held in memory,.
-00036c20: 2020 2020 2020 2020 2020 736f 2069 6e20            so in 
-00036c30: 7375 6368 2061 2063 6173 6520 4c52 4920  such a case LRI 
-00036c40: 6973 2061 2063 6c6f 7365 2061 7070 726f  is a close appro
-00036c50: 7869 6d61 7469 6f6e 206f 6620 4c52 552e  ximation of LRU.
-00036c60: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-00036c70: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-00036c80: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00036c90: 6b65 7973 3a20 6f70 7469 6f6e 616c 0a20  keys: optional. 
-00036ca0: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-00036cb0: 6c69 7374 206f 6620 6461 736b 206b 6579  list of dask key
-00036cc0: 7320 7468 6174 2073 686f 756c 6420 6265  s that should be
-00036cd0: 2063 6f6e 7369 6465 7265 6420 666f 7220   considered for 
-00036ce0: 6d6f 7669 6e67 2e20 416c 6c20 6f74 6865  moving. All othe
-00036cf0: 7220 6b65 7973 0a20 2020 2020 2020 2020  r keys.         
-00036d00: 2020 2077 696c 6c20 6265 2069 676e 6f72     will be ignor
-00036d10: 6564 2e20 4e6f 7465 2074 6861 7420 7468  ed. Note that th
-00036d20: 6973 206f 6666 6572 7320 6e6f 2067 7561  is offers no gua
-00036d30: 7261 6e74 6565 2074 6861 7420 6120 6b65  rantee that a ke
-00036d40: 7920 7769 6c6c 2061 6374 7561 6c6c 790a  y will actually.
-00036d50: 2020 2020 2020 2020 2020 2020 6265 206d              be m
-00036d60: 6f76 6564 2028 652e 672e 2062 6563 6175  oved (e.g. becau
-00036d70: 7365 2069 7420 6973 2075 6e6e 6563 6573  se it is unneces
-00036d80: 7361 7279 206f 7220 6265 6361 7573 6520  sary or because 
-00036d90: 7468 6572 6520 6172 6520 6e6f 2076 6961  there are no via
-00036da0: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-00036db0: 7265 6369 7069 656e 7420 776f 726b 6572  recipient worker
-00036dc0: 7320 666f 7220 6974 292e 0a20 2020 2020  s for it)..     
-00036dd0: 2020 2077 6f72 6b65 7273 3a20 6f70 7469     workers: opti
-00036de0: 6f6e 616c 0a20 2020 2020 2020 2020 2020  onal.           
-00036df0: 2061 6c6c 6f77 6c69 7374 206f 6620 776f   allowlist of wo
-00036e00: 726b 6572 7320 6164 6472 6573 7365 7320  rkers addresses 
-00036e10: 746f 2062 6520 636f 6e73 6964 6572 6564  to be considered
-00036e20: 2061 7320 7365 6e64 6572 7320 6f72 2072   as senders or r
-00036e30: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
-00036e40: 2020 2020 2020 2041 6c6c 206f 7468 6572         All other
-00036e50: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
-00036e60: 2069 676e 6f72 6564 2e20 5468 6520 6d65   ignored. The me
-00036e70: 616e 2063 6c75 7374 6572 206f 6363 7570  an cluster occup
-00036e80: 616e 6379 2077 696c 6c20 6265 0a20 2020  ancy will be.   
-00036e90: 2020 2020 2020 2020 2063 616c 6375 6c61           calcula
-00036ea0: 7465 6420 6f6e 6c79 2075 7369 6e67 2074  ted only using t
-00036eb0: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
-00036ec0: 7273 2e0a 2020 2020 2020 2020 2222 220a  rs..        """.
-00036ed0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00036ee0: 5f69 6420 3d20 7374 696d 756c 7573 5f69  _id = stimulus_i
-00036ef0: 6420 6f72 2066 2272 6562 616c 616e 6365  d or f"rebalance
-00036f00: 2d7b 7469 6d65 2829 7d22 0a0a 2020 2020  -{time()}"..    
-00036f10: 2020 2020 7773 733a 2043 6f6c 6c65 6374      wss: Collect
-00036f20: 696f 6e5b 576f 726b 6572 5374 6174 655d  ion[WorkerState]
-00036f30: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
-00036f40: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
-00036f50: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
-00036f60: 203d 205b 7365 6c66 2e77 6f72 6b65 7273   = [self.workers
-00036f70: 5b77 5d20 666f 7220 7720 696e 2077 6f72  [w] for w in wor
-00036f80: 6b65 7273 5d0a 2020 2020 2020 2020 656c  kers].        el
-00036f90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00036fa0: 7773 7320 3d20 7365 6c66 2e77 6f72 6b65  wss = self.worke
-00036fb0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
-00036fc0: 2020 2020 6966 206e 6f74 2077 7373 3a0a      if not wss:.
-00036fd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00036fe0: 726e 207b 2273 7461 7475 7322 3a20 224f  rn {"status": "O
-00036ff0: 4b22 7d0a 0a20 2020 2020 2020 2069 6620  K"}..        if 
-00037000: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-00037010: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00037020: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00037030: 6b65 7973 2c20 5365 7429 3a0a 2020 2020  keys, Set):.    
-00037040: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00037050: 203d 2073 6574 286b 6579 7329 2020 2320   = set(keys)  # 
-00037060: 756e 6c65 7373 2061 6c72 6561 6479 2061  unless already a
-00037070: 2073 6574 2d6c 696b 650a 2020 2020 2020   set-like.      
-00037080: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
-00037090: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000370a0: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
-000370b0: 7573 223a 2022 4f4b 227d 0a20 2020 2020  us": "OK"}.     
-000370c0: 2020 2020 2020 206d 6973 7369 6e67 5f64         missing_d
-000370d0: 6174 6120 3d20 5b0a 2020 2020 2020 2020  ata = [.        
-000370e0: 2020 2020 2020 2020 6b20 666f 7220 6b20          k for k 
-000370f0: 696e 206b 6579 7320 6966 206b 206e 6f74  in keys if k not
-00037100: 2069 6e20 7365 6c66 2e74 6173 6b73 206f   in self.tasks o
-00037110: 7220 6e6f 7420 7365 6c66 2e74 6173 6b73  r not self.tasks
-00037120: 5b6b 5d2e 7768 6f5f 6861 730a 2020 2020  [k].who_has.    
-00037130: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00037140: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
-00037150: 5f64 6174 613a 0a20 2020 2020 2020 2020  _data:.         
-00037160: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
-00037170: 7374 6174 7573 223a 2022 7061 7274 6961  status": "partia
-00037180: 6c2d 6661 696c 222c 2022 6b65 7973 223a  l-fail", "keys":
-00037190: 206d 6973 7369 6e67 5f64 6174 617d 0a0a   missing_data}..
-000371a0: 2020 2020 2020 2020 6d73 6773 203d 2073          msgs = s
-000371b0: 656c 662e 5f72 6562 616c 616e 6365 5f66  elf._rebalance_f
-000371c0: 696e 645f 6d73 6773 286b 6579 732c 2077  ind_msgs(keys, w
-000371d0: 7373 290a 2020 2020 2020 2020 6966 206e  ss).        if n
-000371e0: 6f74 206d 7367 733a 0a20 2020 2020 2020  ot msgs:.       
-000371f0: 2020 2020 2072 6574 7572 6e20 7b22 7374       return {"st
-00037200: 6174 7573 223a 2022 4f4b 227d 0a0a 2020  atus": "OK"}..  
-00037210: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-00037220: 2073 656c 662e 5f6c 6f63 6b3a 0a20 2020   self._lock:.   
-00037230: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00037240: 3d20 6177 6169 7420 7365 6c66 2e5f 7265  = await self._re
-00037250: 6261 6c61 6e63 655f 6d6f 7665 5f64 6174  balance_move_dat
-00037260: 6128 6d73 6773 2c20 7374 696d 756c 7573  a(msgs, stimulus
-00037270: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
-00037280: 2069 6620 7265 7375 6c74 5b22 7374 6174   if result["stat
-00037290: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
-000372a0: 2d66 6169 6c22 2061 6e64 206b 6579 7320  -fail" and keys 
-000372b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000372c0: 2020 2020 2020 2020 2023 204f 6e6c 7920           # Only 
-000372d0: 7265 7475 726e 2066 6169 6c65 6420 6b65  return failed ke
-000372e0: 7973 2069 6620 7468 6520 636c 6965 6e74  ys if the client
-000372f0: 2065 7870 6c69 6369 746c 7920 6173 6b65   explicitly aske
-00037300: 6420 666f 7220 7468 656d 0a20 2020 2020  d for them.     
-00037310: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00037320: 7420 3d20 7b22 7374 6174 7573 223a 2022  t = {"status": "
-00037330: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
-00037340: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-00037350: 2020 2020 6465 6620 5f72 6562 616c 616e      def _rebalan
-00037360: 6365 5f66 696e 645f 6d73 6773 280a 2020  ce_find_msgs(.  
-00037370: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00037380: 2020 2020 6b65 7973 3a20 5365 745b 4861      keys: Set[Ha
-00037390: 7368 6162 6c65 5d20 7c20 4e6f 6e65 2c0a  shable] | None,.
-000373a0: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-000373b0: 2049 7465 7261 626c 655b 576f 726b 6572   Iterable[Worker
-000373c0: 5374 6174 655d 2c0a 2020 2020 2920 2d3e  State],.    ) ->
-000373d0: 206c 6973 745b 7475 706c 655b 576f 726b   list[tuple[Work
-000373e0: 6572 5374 6174 652c 2057 6f72 6b65 7253  erState, WorkerS
-000373f0: 7461 7465 2c20 5461 736b 5374 6174 655d  tate, TaskState]
-00037400: 5d3a 0a20 2020 2020 2020 2022 2222 4964  ]:.        """Id
-00037410: 656e 7469 6679 2077 6f72 6b65 7273 2074  entify workers t
-00037420: 6861 7420 6e65 6564 2074 6f20 6c6f 7365  hat need to lose
-00037430: 206b 6579 7320 616e 6420 7468 6f73 6520   keys and those 
-00037440: 7468 6174 2063 616e 2072 6563 6569 7665  that can receive
-00037450: 2074 6865 6d2c 0a20 2020 2020 2020 2074   them,.        t
-00037460: 6f67 6574 6865 7220 7769 7468 2068 6f77  ogether with how
-00037470: 206d 616e 7920 6279 7465 7320 6561 6368   many bytes each
-00037480: 206e 6565 6473 2074 6f20 6c6f 7365 2f72   needs to lose/r
-00037490: 6563 6569 7665 2e20 5468 656e 2c20 7061  eceive. Then, pa
-000374a0: 6972 2061 2073 656e 6465 720a 2020 2020  ir a sender.    
-000374b0: 2020 2020 776f 726b 6572 2077 6974 6820      worker with 
-000374c0: 6120 7265 6369 7069 656e 7420 776f 726b  a recipient work
-000374d0: 6572 2066 6f72 2065 6163 6820 6b65 792c  er for each key,
-000374e0: 2075 6e74 696c 2074 6865 2063 6c75 7374   until the clust
-000374f0: 6572 2069 7320 7265 6261 6c61 6e63 6564  er is rebalanced
-00037500: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-00037510: 6d65 7468 6f64 206f 6e6c 7920 6465 6669  method only defi
-00037520: 6e65 7320 7468 6520 776f 726b 2074 6f20  nes the work to 
-00037530: 6265 2070 6572 666f 726d 6564 3b20 6974  be performed; it
-00037540: 2064 6f65 7320 6e6f 7420 7374 6172 7420   does not start 
-00037550: 616e 7920 6e65 7477 6f72 6b0a 2020 2020  any network.    
-00037560: 2020 2020 7472 616e 7366 6572 7320 6974      transfers it
-00037570: 7365 6c66 2e0a 0a20 2020 2020 2020 2054  self...        T
-00037580: 6865 2062 6967 2d4f 2063 6f6d 706c 6578  he big-O complex
-00037590: 6974 7920 6973 204f 2877 7420 2b20 6b65  ity is O(wt + ke
-000375a0: 2a6c 6f67 2877 6529 292c 2077 6865 7265  *log(we)), where
-000375b0: 0a0a 2020 2020 2020 2020 2d20 7774 2069  ..        - wt i
-000375c0: 7320 7468 6520 746f 7461 6c20 6e75 6d62  s the total numb
-000375d0: 6572 206f 6620 776f 726b 6572 7320 6f6e  er of workers on
-000375e0: 2074 6865 2063 6c75 7374 6572 2028 6f72   the cluster (or
-000375f0: 2074 6865 206e 756d 6265 7220 6f66 2061   the number of a
-00037600: 6c6c 6f77 6564 0a20 2020 2020 2020 2020  llowed.         
-00037610: 2077 6f72 6b65 7273 2c20 6966 2065 7870   workers, if exp
-00037620: 6c69 6369 746c 7920 7374 6174 6564 2062  licitly stated b
-00037630: 7920 7468 6520 7573 6572 290a 2020 2020  y the user).    
-00037640: 2020 2020 2d20 7765 2069 7320 7468 6520      - we is the 
-00037650: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
-00037660: 7320 7468 6174 2061 7265 2065 6c69 6769  s that are eligi
-00037670: 626c 6520 746f 2062 6520 7365 6e64 6572  ble to be sender
-00037680: 7320 6f72 2072 6563 6970 6965 6e74 730a  s or recipients.
-00037690: 2020 2020 2020 2020 2d20 6b74 2069 7320          - kt is 
-000376a0: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
-000376b0: 206f 6620 6b65 7973 206f 6e20 7468 6520   of keys on the 
-000376c0: 636c 7573 7465 7220 286f 7220 6f6e 2074  cluster (or on t
-000376d0: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
-000376e0: 7273 290a 2020 2020 2020 2020 2d20 6b65  rs).        - ke
-000376f0: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
-00037700: 6620 6b65 7973 2074 6861 7420 6e65 6564  f keys that need
-00037710: 2074 6f20 6265 206d 6f76 6564 2069 6e20   to be moved in 
-00037720: 6f72 6465 7220 746f 2061 6368 6965 7665  order to achieve
-00037730: 2061 2062 616c 616e 6365 640a 2020 2020   a balanced.    
-00037740: 2020 2020 2020 636c 7573 7465 720a 0a20        cluster.. 
-00037750: 2020 2020 2020 2054 6865 7265 2069 7320         There is 
-00037760: 6120 6465 6765 6e65 7261 7465 2065 6467  a degenerate edg
-00037770: 6520 6361 7365 204f 2877 7420 2b20 6b74  e case O(wt + kt
-00037780: 2a6c 6f67 2877 6529 2920 7768 656e 206b  *log(we)) when k
-00037790: 7420 6973 206d 7563 6820 6772 6561 7465  t is much greate
-000377a0: 7220 7468 616e 0a20 2020 2020 2020 2074  r than.        t
-000377b0: 6865 206e 756d 6265 7220 6f66 2061 6c6c  he number of all
-000377c0: 6f77 6564 206b 6579 732c 206f 7220 7768  owed keys, or wh
-000377d0: 656e 206d 6f73 7420 6b65 7973 2061 7265  en most keys are
-000377e0: 2072 6570 6c69 6361 7465 6420 6f72 2063   replicated or c
-000377f0: 616e 6e6f 7420 6265 0a20 2020 2020 2020  annot be.       
-00037800: 206d 6f76 6564 2066 6f72 2073 6f6d 6520   moved for some 
-00037810: 6f74 6865 7220 7265 6173 6f6e 2e0a 0a20  other reason... 
-00037820: 2020 2020 2020 2052 6574 7572 6e73 206c         Returns l
-00037830: 6973 7420 6f66 2074 7570 6c65 7320 746f  ist of tuples to
-00037840: 2066 6565 6420 696e 746f 205f 7265 6261   feed into _reba
-00037850: 6c61 6e63 655f 6d6f 7665 5f64 6174 613a  lance_move_data:
-00037860: 0a0a 2020 2020 2020 2020 2d20 7365 6e64  ..        - send
-00037870: 6572 2077 6f72 6b65 720a 2020 2020 2020  er worker.      
-00037880: 2020 2d20 7265 6369 7069 656e 7420 776f    - recipient wo
-00037890: 726b 6572 0a20 2020 2020 2020 202d 2074  rker.        - t
-000378a0: 6173 6b20 746f 2062 6520 7472 616e 7366  ask to be transf
-000378b0: 6572 7265 640a 2020 2020 2020 2020 2222  erred.        ""
-000378c0: 220a 2020 2020 2020 2020 2320 4865 6170  ".        # Heap
-000378d0: 7320 6f66 2077 6f72 6b65 7273 2c20 6d61  s of workers, ma
-000378e0: 6e61 6765 6420 6279 2074 6865 2068 6561  naged by the hea
-000378f0: 7071 206d 6f64 756c 652c 2074 6861 7420  pq module, that 
-00037900: 6e65 6564 2074 6f20 7365 6e64 2f72 6563  need to send/rec
-00037910: 6569 7665 2064 6174 612c 0a20 2020 2020  eive data,.     
-00037920: 2020 2023 2077 6974 6820 686f 7720 6d61     # with how ma
-00037930: 6e79 2062 7974 6573 2065 6163 6820 6e65  ny bytes each ne
-00037940: 6564 7320 746f 2073 656e 642f 7265 6365  eds to send/rece
-00037950: 6976 652e 0a20 2020 2020 2020 2023 0a20  ive..        #. 
-00037960: 2020 2020 2020 2023 2045 6163 6820 656c         # Each el
-00037970: 656d 656e 7420 6f66 2074 6865 2068 6561  ement of the hea
-00037980: 7020 6973 2061 2074 7570 6c65 2063 6f6e  p is a tuple con
-00037990: 7374 7275 6374 6564 2061 7320 666f 6c6c  structed as foll
-000379a0: 6f77 733a 0a20 2020 2020 2020 2023 202d  ows:.        # -
-000379b0: 2073 6e64 5f62 7974 6573 5f6d 6178 2f72   snd_bytes_max/r
-000379c0: 6563 5f62 7974 6573 5f6d 6178 3a20 6d61  ec_bytes_max: ma
-000379d0: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
-000379e0: 6279 7465 7320 746f 2073 656e 6420 6f72  bytes to send or
-000379f0: 2072 6563 6569 7665 2e0a 2020 2020 2020   receive..      
-00037a00: 2020 2320 2020 5468 6973 206e 756d 6265    #   This numbe
-00037a10: 7220 6973 206e 6567 6174 6976 652c 2073  r is negative, s
-00037a20: 6f20 7468 6174 2074 6865 2077 6f72 6b65  o that the worke
-00037a30: 7273 2066 6172 7468 6573 7420 6672 6f6d  rs farthest from
-00037a40: 2074 6865 2063 6c75 7374 6572 206d 6561   the cluster mea
-00037a50: 6e0a 2020 2020 2020 2020 2320 2020 6172  n.        #   ar
-00037a60: 6520 6174 2074 6865 2074 6f70 206f 6620  e at the top of 
-00037a70: 7468 6520 736d 616c 6c65 7374 2d66 6972  the smallest-fir
-00037a80: 7374 2068 6561 7073 2e0a 2020 2020 2020  st heaps..      
-00037a90: 2020 2320 2d20 736e 645f 6279 7465 735f    # - snd_bytes_
-00037aa0: 6d69 6e2f 7265 635f 6279 7465 735f 6d69  min/rec_bytes_mi
-00037ab0: 6e3a 206d 696e 696d 756d 206e 756d 6265  n: minimum numbe
-00037ac0: 7220 6f66 2062 7974 6573 2061 6674 6572  r of bytes after
-00037ad0: 2073 656e 6469 6e67 2f72 6563 6569 7669   sending/receivi
-00037ae0: 6e67 0a20 2020 2020 2020 2023 2020 2077  ng.        #   w
-00037af0: 6869 6368 2074 6865 2077 6f72 6b65 7220  hich the worker 
-00037b00: 7368 6f75 6c64 206e 6f74 2062 6520 636f  should not be co
-00037b10: 6e73 6964 6572 6564 2061 6e79 6d6f 7265  nsidered anymore
-00037b20: 2e20 5468 6973 2069 7320 616c 736f 206e  . This is also n
-00037b30: 6567 6174 6976 652e 0a20 2020 2020 2020  egative..       
-00037b40: 2023 202d 2061 7262 6974 7261 7279 2075   # - arbitrary u
-00037b50: 6e69 7175 6520 6e75 6d62 6572 2c20 7468  nique number, th
-00037b60: 6572 6520 6a75 7374 2074 6f20 746f 206d  ere just to to m
-00037b70: 616b 6520 7375 7265 2074 6861 7420 576f  ake sure that Wo
-00037b80: 726b 6572 5374 6174 6520 6f62 6a65 6374  rkerState object
-00037b90: 730a 2020 2020 2020 2020 2320 2020 6172  s.        #   ar
-00037ba0: 6520 6e65 7665 7220 7573 6564 2066 6f72  e never used for
-00037bb0: 2073 6f72 7469 6e67 2069 6e20 7468 6520   sorting in the 
-00037bc0: 756e 6c69 6b65 6c79 2065 7665 6e74 2074  unlikely event t
-00037bd0: 6861 7420 7477 6f20 7072 6f63 6573 7365  hat two processe
-00037be0: 7320 6861 7665 0a20 2020 2020 2020 2023  s have.        #
-00037bf0: 2020 2065 7861 6374 6c79 2074 6865 2073     exactly the s
-00037c00: 616d 6520 6e75 6d62 6572 206f 6620 6279  ame number of by
-00037c10: 7465 7320 616c 6c6f 6361 7465 642e 0a20  tes allocated.. 
-00037c20: 2020 2020 2020 2023 202d 2057 6f72 6b65         # - Worke
-00037c30: 7253 7461 7465 0a20 2020 2020 2020 2023  rState.        #
-00037c40: 202d 2069 7465 7261 746f 7220 6f66 2061   - iterator of a
-00037c50: 6c6c 2074 6173 6b73 2069 6e20 6d65 6d6f  ll tasks in memo
-00037c60: 7279 206f 6e20 7468 6520 776f 726b 6572  ry on the worker
-00037c70: 2028 7365 6e64 6572 7320 6f6e 6c79 292c   (senders only),
-00037c80: 2069 6e73 6572 7469 6f6e 0a20 2020 2020   insertion.     
-00037c90: 2020 2023 2020 2073 6f72 7465 6420 286c     #   sorted (l
-00037ca0: 6561 7374 2072 6563 656e 746c 7920 696e  east recently in
-00037cb0: 7365 7274 6564 2066 6972 7374 292e 0a20  serted first).. 
-00037cc0: 2020 2020 2020 2023 2020 204e 6f74 6520         #   Note 
-00037cd0: 7468 6174 2074 6869 7320 6974 6572 6174  that this iterat
-00037ce0: 6f72 2077 696c 6c20 7479 7069 6361 6c6c  or will typicall
-00037cf0: 7920 2a6e 6f74 2a20 6265 2065 7868 6175  y *not* be exhau
-00037d00: 7374 6564 2e20 4974 2077 696c 6c20 6f6e  sted. It will on
-00037d10: 6c79 2062 650a 2020 2020 2020 2020 2320  ly be.        # 
-00037d20: 2020 6578 6861 7573 7465 6420 6966 2c20    exhausted if, 
-00037d30: 6166 7465 7220 6d6f 7669 6e67 2061 7761  after moving awa
-00037d40: 7920 6672 6f6d 2074 6865 2077 6f72 6b65  y from the worke
-00037d50: 7220 616c 6c20 6b65 7973 2074 6861 7420  r all keys that 
-00037d60: 6361 6e20 6265 206d 6f76 6564 2c0a 2020  can be moved,.  
-00037d70: 2020 2020 2020 2320 2020 6973 2069 6e73        #   is ins
-00037d80: 7566 6669 6369 656e 7420 746f 2064 726f  ufficient to dro
-00037d90: 7020 736e 645f 6279 7465 735f 6d69 6e20  p snd_bytes_min 
-00037da0: 6162 6f76 6520 302e 0a20 2020 2020 2020  above 0..       
-00037db0: 2073 656e 6465 7273 3a20 6c69 7374 5b74   senders: list[t
-00037dc0: 7570 6c65 5b69 6e74 2c20 696e 742c 2069  uple[int, int, i
-00037dd0: 6e74 2c20 576f 726b 6572 5374 6174 652c  nt, WorkerState,
-00037de0: 2049 7465 7261 746f 725b 5461 736b 5374   Iterator[TaskSt
-00037df0: 6174 655d 5d5d 203d 205b 5d0a 2020 2020  ate]]] = [].    
-00037e00: 2020 2020 7265 6369 7069 656e 7473 3a20      recipients: 
-00037e10: 6c69 7374 5b74 7570 6c65 5b69 6e74 2c20  list[tuple[int, 
-00037e20: 696e 742c 2069 6e74 2c20 576f 726b 6572  int, int, Worker
-00037e30: 5374 6174 655d 5d20 3d20 5b5d 0a0a 2020  State]] = []..  
-00037e40: 2020 2020 2020 2320 4f75 7470 7574 3a20        # Output: 
-00037e50: 5b28 7365 6e64 6572 2c20 7265 6369 7069  [(sender, recipi
-00037e60: 656e 742c 2074 6173 6b29 2c20 2e2e 2e5d  ent, task), ...]
-00037e70: 0a20 2020 2020 2020 206d 7367 733a 206c  .        msgs: l
-00037e80: 6973 745b 7475 706c 655b 576f 726b 6572  ist[tuple[Worker
-00037e90: 5374 6174 652c 2057 6f72 6b65 7253 7461  State, WorkerSta
-00037ea0: 7465 2c20 5461 736b 5374 6174 655d 5d20  te, TaskState]] 
-00037eb0: 3d20 5b5d 0a0a 2020 2020 2020 2020 2320  = []..        # 
-00037ec0: 4279 2064 6566 6175 6c74 2c20 7468 6973  By default, this
-00037ed0: 2069 7320 7468 6520 6f70 7469 6d69 7374   is the optimist
-00037ee0: 6963 206d 656d 6f72 792c 206d 6561 6e69  ic memory, meani
-00037ef0: 6e67 2074 6f74 616c 2070 726f 6365 7373  ng total process
-00037f00: 206d 656d 6f72 7920 6d69 6e75 730a 2020   memory minus.  
-00037f10: 2020 2020 2020 2320 756e 6d61 6e61 6765        # unmanage
-00037f20: 6420 6d65 6d6f 7279 2074 6861 7420 6170  d memory that ap
-00037f30: 7065 6172 6564 206f 7665 7220 7468 6520  peared over the 
-00037f40: 6c61 7374 2033 3020 7365 636f 6e64 730a  last 30 seconds.
-00037f50: 2020 2020 2020 2020 2320 2864 6973 7472          # (distr
-00037f60: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-00037f70: 6d6f 7279 2e72 6563 656e 742d 746f 2d6f  mory.recent-to-o
-00037f80: 6c64 2d74 696d 6529 2e0a 2020 2020 2020  ld-time)..      
-00037f90: 2020 2320 5468 6973 206c 6574 7320 7573    # This lets us
-00037fa0: 2069 676e 6f72 6520 7465 6d70 6f72 6172   ignore temporar
-00037fb0: 7920 7370 696b 6573 2063 6175 7365 6420  y spikes caused 
-00037fc0: 6279 2074 6173 6b20 6865 6170 2075 7361  by task heap usa
-00037fd0: 6765 2e0a 2020 2020 2020 2020 6d65 6d6f  ge..        memo
-00037fe0: 7279 5f62 795f 776f 726b 6572 203d 205b  ry_by_worker = [
-00037ff0: 0a20 2020 2020 2020 2020 2020 2028 7773  .            (ws
-00038000: 2c20 6765 7461 7474 7228 7773 2e6d 656d  , getattr(ws.mem
-00038010: 6f72 792c 2073 656c 662e 4d45 4d4f 5259  ory, self.MEMORY
-00038020: 5f52 4542 414c 414e 4345 5f4d 4541 5355  _REBALANCE_MEASU
-00038030: 5245 2929 2066 6f72 2077 7320 696e 2077  RE)) for ws in w
-00038040: 6f72 6b65 7273 0a20 2020 2020 2020 205d  orkers.        ]
-00038050: 0a20 2020 2020 2020 206d 6561 6e5f 6d65  .        mean_me
-00038060: 6d6f 7279 203d 2073 756d 286d 2066 6f72  mory = sum(m for
-00038070: 205f 2c20 6d20 696e 206d 656d 6f72 795f   _, m in memory_
-00038080: 6279 5f77 6f72 6b65 7229 202f 2f20 6c65  by_worker) // le
-00038090: 6e28 6d65 6d6f 7279 5f62 795f 776f 726b  n(memory_by_work
-000380a0: 6572 290a 0a20 2020 2020 2020 2066 6f72  er)..        for
-000380b0: 2077 732c 2077 735f 6d65 6d6f 7279 2069   ws, ws_memory i
-000380c0: 6e20 6d65 6d6f 7279 5f62 795f 776f 726b  n memory_by_work
-000380d0: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-000380e0: 6966 2077 732e 6d65 6d6f 7279 5f6c 696d  if ws.memory_lim
-000380f0: 6974 3a0a 2020 2020 2020 2020 2020 2020  it:.            
-00038100: 2020 2020 6861 6c66 5f67 6170 203d 2069      half_gap = i
-00038110: 6e74 2873 656c 662e 4d45 4d4f 5259 5f52  nt(self.MEMORY_R
-00038120: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
-00038130: 5020 2a20 7773 2e6d 656d 6f72 795f 6c69  P * ws.memory_li
-00038140: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
-00038150: 2020 2020 2073 656e 6465 725f 6d69 6e20       sender_min 
-00038160: 3d20 7365 6c66 2e4d 454d 4f52 595f 5245  = self.MEMORY_RE
-00038170: 4241 4c41 4e43 455f 5345 4e44 4552 5f4d  BALANCE_SENDER_M
-00038180: 494e 202a 2077 732e 6d65 6d6f 7279 5f6c  IN * ws.memory_l
-00038190: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
-000381a0: 2020 2020 2072 6563 6970 6965 6e74 5f6d       recipient_m
-000381b0: 6178 203d 2073 656c 662e 4d45 4d4f 5259  ax = self.MEMORY
-000381c0: 5f52 4542 414c 414e 4345 5f52 4543 4950  _REBALANCE_RECIP
-000381d0: 4945 4e54 5f4d 4158 202a 2077 732e 6d65  IENT_MAX * ws.me
-000381e0: 6d6f 7279 5f6c 696d 6974 0a20 2020 2020  mory_limit.     
-000381f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00038200: 2020 2020 2020 2020 2020 2020 2068 616c               hal
-00038210: 665f 6761 7020 3d20 300a 2020 2020 2020  f_gap = 0.      
-00038220: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
-00038230: 5f6d 696e 203d 2030 2e30 0a20 2020 2020  _min = 0.0.     
-00038240: 2020 2020 2020 2020 2020 2072 6563 6970             recip
-00038250: 6965 6e74 5f6d 6178 203d 206d 6174 682e  ient_max = math.
-00038260: 696e 660a 0a20 2020 2020 2020 2020 2020  inf..           
-00038270: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-00038280: 2020 2020 2020 7773 2e5f 6861 735f 7768        ws._has_wh
-00038290: 6174 0a20 2020 2020 2020 2020 2020 2020  at.             
-000382a0: 2020 2061 6e64 2077 735f 6d65 6d6f 7279     and ws_memory
-000382b0: 203e 3d20 6d65 616e 5f6d 656d 6f72 7920   >= mean_memory 
-000382c0: 2b20 6861 6c66 5f67 6170 0a20 2020 2020  + half_gap.     
-000382d0: 2020 2020 2020 2020 2020 2061 6e64 2077             and w
-000382e0: 735f 6d65 6d6f 7279 203e 3d20 7365 6e64  s_memory >= send
-000382f0: 6572 5f6d 696e 0a20 2020 2020 2020 2020  er_min.         
-00038300: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-00038310: 2020 2020 2020 2320 5468 6973 206d 6179        # This may
-00038320: 2073 656e 6420 7468 6520 776f 726b 6572   send the worker
-00038330: 2062 656c 6f77 2073 656e 6465 725f 6d69   below sender_mi
-00038340: 6e20 2862 7920 6465 7369 676e 290a 2020  n (by design).  
-00038350: 2020 2020 2020 2020 2020 2020 2020 736e                sn
-00038360: 645f 6279 7465 735f 6d61 7820 3d20 6d65  d_bytes_max = me
-00038370: 616e 5f6d 656d 6f72 7920 2d20 7773 5f6d  an_memory - ws_m
-00038380: 656d 6f72 7920 2023 206e 6567 6174 6976  emory  # negativ
-00038390: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000383a0: 2020 736e 645f 6279 7465 735f 6d69 6e20    snd_bytes_min 
-000383b0: 3d20 736e 645f 6279 7465 735f 6d61 7820  = snd_bytes_max 
-000383c0: 2b20 6861 6c66 5f67 6170 2020 2320 6e65  + half_gap  # ne
-000383d0: 6761 7469 7665 0a20 2020 2020 2020 2020  gative.         
-000383e0: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
-000383f0: 696e 6974 696f 6e20 6f66 2073 656e 6465  inition of sende
-00038400: 7273 2061 626f 7665 0a20 2020 2020 2020  rs above.       
-00038410: 2020 2020 2020 2020 2073 656e 6465 7273           senders
-00038420: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-00038430: 2020 2020 2020 2020 2020 2020 2028 736e               (sn
-00038440: 645f 6279 7465 735f 6d61 782c 2073 6e64  d_bytes_max, snd
-00038450: 5f62 7974 6573 5f6d 696e 2c20 6964 2877  _bytes_min, id(w
-00038460: 7329 2c20 7773 2c20 6974 6572 2877 732e  s), ws, iter(ws.
-00038470: 5f68 6173 5f77 6861 7429 290a 2020 2020  _has_what)).    
-00038480: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00038490: 2020 2020 2020 2020 2020 656c 6966 2077            elif w
-000384a0: 735f 6d65 6d6f 7279 203c 206d 6561 6e5f  s_memory < mean_
-000384b0: 6d65 6d6f 7279 202d 2068 616c 665f 6761  memory - half_ga
-000384c0: 7020 616e 6420 7773 5f6d 656d 6f72 7920  p and ws_memory 
-000384d0: 3c20 7265 6369 7069 656e 745f 6d61 783a  < recipient_max:
-000384e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000384f0: 2023 2054 6869 7320 6d61 7920 7365 6e64   # This may send
-00038500: 2074 6865 2077 6f72 6b65 7220 6162 6f76   the worker abov
-00038510: 6520 7265 6369 7069 656e 745f 6d61 7820  e recipient_max 
-00038520: 2862 7920 6465 7369 676e 290a 2020 2020  (by design).    
-00038530: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
-00038540: 6279 7465 735f 6d61 7820 3d20 7773 5f6d  bytes_max = ws_m
-00038550: 656d 6f72 7920 2d20 6d65 616e 5f6d 656d  emory - mean_mem
-00038560: 6f72 7920 2023 206e 6567 6174 6976 650a  ory  # negative.
-00038570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038580: 7265 635f 6279 7465 735f 6d69 6e20 3d20  rec_bytes_min = 
-00038590: 7265 635f 6279 7465 735f 6d61 7820 2b20  rec_bytes_max + 
-000385a0: 6861 6c66 5f67 6170 2020 2320 6e65 6761  half_gap  # nega
-000385b0: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
-000385c0: 2020 2020 2023 2053 6565 2064 6566 696e       # See defin
-000385d0: 6974 696f 6e20 6f66 2072 6563 6970 6965  ition of recipie
-000385e0: 6e74 7320 6162 6f76 650a 2020 2020 2020  nts above.      
-000385f0: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-00038600: 656e 7473 2e61 7070 656e 6428 2872 6563  ents.append((rec
-00038610: 5f62 7974 6573 5f6d 6178 2c20 7265 635f  _bytes_max, rec_
-00038620: 6279 7465 735f 6d69 6e2c 2069 6428 7773  bytes_min, id(ws
-00038630: 292c 2077 7329 290a 0a20 2020 2020 2020  ), ws))..       
-00038640: 2023 2046 6173 7420 6578 6974 2069 6e20   # Fast exit in 
-00038650: 6361 7365 206e 6f20 7472 616e 7366 6572  case no transfer
-00038660: 7320 6172 6520 6e65 6365 7373 6172 7920  s are necessary 
-00038670: 6f72 2070 6f73 7369 626c 650a 2020 2020  or possible.    
-00038680: 2020 2020 6966 206e 6f74 2073 656e 6465      if not sende
-00038690: 7273 206f 7220 6e6f 7420 7265 6369 7069  rs or not recipi
-000386a0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-000386b0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-000386c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000386d0: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
-000386e0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000386f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00038700: 6163 7469 6f6e 223a 2022 7265 6261 6c61  action": "rebala
-00038710: 6e63 6522 2c0a 2020 2020 2020 2020 2020  nce",.          
-00038720: 2020 2020 2020 2020 2020 2273 656e 6465            "sende
-00038730: 7273 223a 206c 656e 2873 656e 6465 7273  rs": len(senders
-00038740: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00038750: 2020 2020 2020 2022 7265 6369 7069 656e         "recipien
-00038760: 7473 223a 206c 656e 2872 6563 6970 6965  ts": len(recipie
-00038770: 6e74 7329 2c0a 2020 2020 2020 2020 2020  nts),.          
-00038780: 2020 2020 2020 2020 2020 226d 6f76 6564            "moved
-00038790: 5f6b 6579 7322 3a20 302c 0a20 2020 2020  _keys": 0,.     
-000387a0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-000387b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000387c0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-000387d0: 5d0a 0a20 2020 2020 2020 2068 6561 7071  ]..        heapq
-000387e0: 2e68 6561 7069 6679 2873 656e 6465 7273  .heapify(senders
-000387f0: 290a 2020 2020 2020 2020 6865 6170 712e  ).        heapq.
-00038800: 6865 6170 6966 7928 7265 6369 7069 656e  heapify(recipien
-00038810: 7473 290a 0a20 2020 2020 2020 2077 6869  ts)..        whi
-00038820: 6c65 2073 656e 6465 7273 2061 6e64 2072  le senders and r
-00038830: 6563 6970 6965 6e74 733a 0a20 2020 2020  ecipients:.     
-00038840: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
-00038850: 5f6d 6178 2c20 736e 645f 6279 7465 735f  _max, snd_bytes_
-00038860: 6d69 6e2c 205f 2c20 736e 645f 7773 2c20  min, _, snd_ws, 
-00038870: 7473 5f69 7465 7220 3d20 7365 6e64 6572  ts_iter = sender
-00038880: 735b 305d 0a0a 2020 2020 2020 2020 2020  s[0]..          
-00038890: 2020 2320 4974 6572 6174 6520 7468 726f    # Iterate thro
-000388a0: 7567 6820 7461 736b 7320 696e 206d 656d  ugh tasks in mem
-000388b0: 6f72 792c 206c 6561 7374 2072 6563 656e  ory, least recen
-000388c0: 746c 7920 696e 7365 7274 6564 2066 6972  tly inserted fir
-000388d0: 7374 0a20 2020 2020 2020 2020 2020 2066  st.            f
-000388e0: 6f72 2074 7320 696e 2074 735f 6974 6572  or ts in ts_iter
-000388f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00038900: 2020 6966 206b 6579 7320 6973 206e 6f74    if keys is not
-00038910: 204e 6f6e 6520 616e 6420 7473 2e6b 6579   None and ts.key
-00038920: 206e 6f74 2069 6e20 6b65 7973 3a0a 2020   not in keys:.  
-00038930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038940: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00038950: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
-00038960: 7320 3d20 7473 2e6e 6279 7465 730a 2020  s = ts.nbytes.  
-00038970: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00038980: 206e 6279 7465 7320 2b20 736e 645f 6279   nbytes + snd_by
-00038990: 7465 735f 6d61 7820 3e20 303a 0a20 2020  tes_max > 0:.   
+00034670: 6d73 6720 2b3d 2028 0a20 2020 2020 2020  msg += (.       
+00034680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034690: 2020 2020 2066 2220 5468 6520 7b6e 5f77       f" The {n_w
+000346a0: 6f72 6b65 7273 202d 206e 5f6e 616e 6e79  orkers - n_nanny
+000346b0: 7d20 776f 726b 6572 2873 2920 6e6f 7420  } worker(s) not 
+000346c0: 7573 696e 6720 4e61 6e6e 6965 7320 7765  using Nannies we
+000346d0: 7265 206a 7573 7420 7368 7574 2022 0a20  re just shut ". 
+000346e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000346f0: 2020 2020 2020 2020 2020 2022 646f 776e             "down
+00034700: 2069 6e73 7465 6164 206f 6620 7265 7374   instead of rest
+00034710: 6172 7465 6420 2872 6573 7461 7274 2069  arted (restart i
+00034720: 7320 6f6e 6c79 2070 6f73 7369 626c 6520  s only possible 
+00034730: 7769 7468 204e 616e 6e69 6573 292e 2049  with Nannies). I
+00034740: 6620 220a 2020 2020 2020 2020 2020 2020  f ".            
+00034750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034760: 2279 6f75 7220 6465 706c 6f79 6d65 6e74  "your deployment
+00034770: 2073 7973 7465 6d20 646f 6573 206e 6f74   system does not
+00034780: 2061 7574 6f6d 6174 6963 616c 6c79 2072   automatically r
+00034790: 652d 6c61 756e 6368 2074 6572 6d69 6e61  e-launch termina
+000347a0: 7465 6420 220a 2020 2020 2020 2020 2020  ted ".          
+000347b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000347c0: 2020 2270 726f 6365 7373 6573 2c20 7468    "processes, th
+000347d0: 656e 2074 686f 7365 2077 6f72 6b65 7273  en those workers
+000347e0: 2077 696c 6c20 6e65 7665 7220 636f 6d65   will never come
+000347f0: 2062 6163 6b2c 2061 6e64 2060 436c 6965   back, and `Clie
+00034800: 6e74 2e72 6573 7461 7274 6020 220a 2020  nt.restart` ".  
+00034810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034820: 2020 2020 2020 2020 2020 2277 696c 6c20            "will 
+00034830: 616c 7761 7973 2074 696d 6520 6f75 742e  always time out.
+00034840: 2044 6f20 6e6f 7420 7573 6520 6043 6c69   Do not use `Cli
+00034850: 656e 742e 7265 7374 6172 7460 2069 6e20  ent.restart` in 
+00034860: 7468 6174 2063 6173 652e 220a 2020 2020  that case.".    
+00034870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034880: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00034890: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000348a0: 5469 6d65 6f75 7445 7272 6f72 286d 7367  TimeoutError(msg
+000348b0: 2920 6672 6f6d 204e 6f6e 650a 2020 2020  ) from None.    
+000348c0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+000348d0: 2252 6573 7461 7274 696e 6720 6669 6e69  "Restarting fini
+000348e0: 7368 6564 2e22 290a 0a20 2020 2061 7379  shed.")..    asy
+000348f0: 6e63 2064 6566 2062 726f 6164 6361 7374  nc def broadcast
+00034900: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00034910: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00034920: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
+00034930: 2020 2020 2020 776f 726b 6572 733a 206c        workers: l
+00034940: 6973 745b 7374 725d 207c 204e 6f6e 6520  ist[str] | None 
+00034950: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00034960: 686f 7374 733a 206c 6973 745b 7374 725d  hosts: list[str]
+00034970: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00034980: 2020 2020 2020 2020 6e61 6e6e 793a 2062          nanny: b
+00034990: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+000349a0: 2020 2020 2073 6572 6961 6c69 7a65 7273       serializers
+000349b0: 3a20 416e 7920 3d20 4e6f 6e65 2c0a 2020  : Any = None,.  
+000349c0: 2020 2020 2020 6f6e 5f65 7272 6f72 3a20        on_error: 
+000349d0: 224c 6974 6572 616c 5b27 7261 6973 6527  "Literal['raise'
+000349e0: 2c20 2772 6574 7572 6e27 2c20 2772 6574  , 'return', 'ret
+000349f0: 7572 6e5f 7069 636b 6c65 272c 2027 6967  urn_pickle', 'ig
+00034a00: 6e6f 7265 275d 2220 3d20 2272 6169 7365  nore']" = "raise
+00034a10: 222c 0a20 2020 2029 202d 3e20 6469 6374  ",.    ) -> dict
+00034a20: 3a20 2023 2064 6963 745b 7374 722c 2041  :  # dict[str, A
+00034a30: 6e79 5d0a 2020 2020 2020 2020 2222 2242  ny].        """B
+00034a40: 726f 6164 6361 7374 206d 6573 7361 6765  roadcast message
+00034a50: 2074 6f20 776f 726b 6572 732c 2072 6574   to workers, ret
+00034a60: 7572 6e20 616c 6c20 7265 7375 6c74 7322  urn all results"
+00034a70: 2222 0a20 2020 2020 2020 2069 6620 776f  "".        if wo
+00034a80: 726b 6572 7320 6973 204e 6f6e 653a 0a20  rkers is None:. 
+00034a90: 2020 2020 2020 2020 2020 2069 6620 686f             if ho
+00034aa0: 7374 7320 6973 204e 6f6e 653a 0a20 2020  sts is None:.   
+00034ab0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+00034ac0: 6b65 7273 203d 206c 6973 7428 7365 6c66  kers = list(self
+00034ad0: 2e77 6f72 6b65 7273 290a 2020 2020 2020  .workers).      
+00034ae0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00034af0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00034b00: 6572 7320 3d20 5b5d 0a20 2020 2020 2020  ers = [].       
+00034b10: 2069 6620 686f 7374 7320 6973 206e 6f74   if hosts is not
+00034b20: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00034b30: 2020 2066 6f72 2068 6f73 7420 696e 2068     for host in h
+00034b40: 6f73 7473 3a0a 2020 2020 2020 2020 2020  osts:.          
+00034b50: 2020 2020 2020 6468 3a20 6469 6374 203d        dh: dict =
+00034b60: 2073 656c 662e 686f 7374 5f69 6e66 6f2e   self.host_info.
+00034b70: 6765 7428 686f 7374 2920 2023 2074 7970  get(host)  # typ
+00034b80: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+00034b90: 2020 2020 2020 2020 2020 6966 2064 6820            if dh 
+00034ba0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00034bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034bc0: 2077 6f72 6b65 7273 2e65 7874 656e 6428   workers.extend(
+00034bd0: 6468 5b22 6164 6472 6573 7365 7322 5d29  dh["addresses"])
+00034be0: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
+00034bf0: 7265 706c 6163 6520 7769 7468 2077 6f72  replace with wor
+00034c00: 6b65 725f 6c69 7374 0a0a 2020 2020 2020  ker_list..      
+00034c10: 2020 6966 206e 616e 6e79 3a0a 2020 2020    if nanny:.    
+00034c20: 2020 2020 2020 2020 6164 6472 6573 7365          addresse
+00034c30: 7320 3d20 5b73 656c 662e 776f 726b 6572  s = [self.worker
+00034c40: 735b 775d 2e6e 616e 6e79 2066 6f72 2077  s[w].nanny for w
+00034c50: 2069 6e20 776f 726b 6572 735d 0a20 2020   in workers].   
+00034c60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00034c70: 2020 2020 2020 2061 6464 7265 7373 6573         addresses
+00034c80: 203d 2077 6f72 6b65 7273 0a0a 2020 2020   = workers..    
+00034c90: 2020 2020 4552 524f 5220 3d20 6f62 6a65      ERROR = obje
+00034ca0: 6374 2829 0a0a 2020 2020 2020 2020 6173  ct()..        as
+00034cb0: 796e 6320 6465 6620 7365 6e64 5f6d 6573  ync def send_mes
+00034cc0: 7361 6765 2861 6464 7229 3a0a 2020 2020  sage(addr):.    
+00034cd0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00034ce0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00034cf0: 6d20 3d20 6177 6169 7420 7365 6c66 2e72  m = await self.r
+00034d00: 7063 2e63 6f6e 6e65 6374 2861 6464 7229  pc.connect(addr)
+00034d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034d20: 2063 6f6d 6d2e 6e61 6d65 203d 2022 5363   comm.name = "Sc
+00034d30: 6865 6475 6c65 7220 4272 6f61 6463 6173  heduler Broadcas
+00034d40: 7422 0a20 2020 2020 2020 2020 2020 2020  t".             
+00034d50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00034d60: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00034d70: 203d 2061 7761 6974 2073 656e 645f 7265   = await send_re
+00034d80: 6376 280a 2020 2020 2020 2020 2020 2020  cv(.            
+00034d90: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00034da0: 2c20 636c 6f73 653d 5472 7565 2c20 7365  , close=True, se
+00034db0: 7269 616c 697a 6572 733d 7365 7269 616c  rializers=serial
+00034dc0: 697a 6572 732c 202a 2a6d 7367 0a20 2020  izers, **msg.   
+00034dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034de0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00034df0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+00034e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034e10: 7365 6c66 2e72 7063 2e72 6575 7365 2861  self.rpc.reuse(a
+00034e20: 6464 722c 2063 6f6d 6d29 0a20 2020 2020  ddr, comm).     
+00034e30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00034e40: 6e20 7265 7370 0a20 2020 2020 2020 2020  n resp.         
+00034e50: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00034e60: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+00034e70: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00034e80: 2e65 7272 6f72 2866 2262 726f 6164 6361  .error(f"broadca
+00034e90: 7374 2074 6f20 7b61 6464 727d 2066 6169  st to {addr} fai
+00034ea0: 6c65 643a 207b 652e 5f5f 636c 6173 735f  led: {e.__class_
+00034eb0: 5f2e 5f5f 6e61 6d65 5f5f 7d3a 207b 657d  _.__name__}: {e}
+00034ec0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00034ed0: 2020 2069 6620 6f6e 5f65 7272 6f72 203d     if on_error =
+00034ee0: 3d20 2272 6169 7365 223a 0a20 2020 2020  = "raise":.     
+00034ef0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00034f00: 6169 7365 0a20 2020 2020 2020 2020 2020  aise.           
+00034f10: 2020 2020 2065 6c69 6620 6f6e 5f65 7272       elif on_err
+00034f20: 6f72 203d 3d20 2272 6574 7572 6e22 3a0a  or == "return":.
+00034f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034f40: 2020 2020 7265 7475 726e 2065 0a20 2020      return e.   
+00034f50: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00034f60: 6620 6f6e 5f65 7272 6f72 203d 3d20 2272  f on_error == "r
+00034f70: 6574 7572 6e5f 7069 636b 6c65 223a 0a20  eturn_pickle":. 
+00034f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034f90: 2020 2072 6574 7572 6e20 6475 6d70 7328     return dumps(
+00034fa0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00034fb0: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
+00034fc0: 203d 3d20 2269 676e 6f72 6522 3a0a 2020   == "ignore":.  
+00034fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034fe0: 2020 7265 7475 726e 2045 5252 4f52 0a20    return ERROR. 
+00034ff0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00035000: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00035010: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00035020: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00035030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035040: 2020 2022 6f6e 5f65 7272 6f72 206d 7573     "on_error mus
+00035050: 7420 6265 2027 7261 6973 6527 2c20 2772  t be 'raise', 'r
+00035060: 6574 7572 6e27 2c20 2772 6574 7572 6e5f  eturn', 'return_
+00035070: 7069 636b 6c65 272c 2022 0a20 2020 2020  pickle', ".     
+00035080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035090: 2020 2066 226f 7220 2769 676e 6f72 6527     f"or 'ignore'
+000350a0: 3b20 676f 7420 7b6f 6e5f 6572 726f 7221  ; got {on_error!
+000350b0: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
+000350c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000350d0: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+000350e0: 6974 2041 6c6c 280a 2020 2020 2020 2020  it All(.        
+000350f0: 2020 2020 5b73 656e 645f 6d65 7373 6167      [send_messag
+00035100: 6528 6164 6472 6573 7329 2066 6f72 2061  e(address) for a
+00035110: 6464 7265 7373 2069 6e20 6164 6472 6573  ddress in addres
+00035120: 7365 7320 6966 2061 6464 7265 7373 2069  ses if address i
+00035130: 7320 6e6f 7420 4e6f 6e65 5d0a 2020 2020  s not None].    
+00035140: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
+00035150: 6574 7572 6e20 7b6b 3a20 7620 666f 7220  eturn {k: v for 
+00035160: 6b2c 2076 2069 6e20 7a69 7028 776f 726b  k, v in zip(work
+00035170: 6572 732c 2072 6573 756c 7473 2920 6966  ers, results) if
+00035180: 2076 2069 7320 6e6f 7420 4552 524f 527d   v is not ERROR}
+00035190: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000351a0: 7072 6f78 7928 0a20 2020 2020 2020 2073  proxy(.        s
+000351b0: 656c 662c 0a20 2020 2020 2020 206d 7367  elf,.        msg
+000351c0: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
+000351d0: 776f 726b 6572 3a20 7374 722c 0a20 2020  worker: str,.   
+000351e0: 2020 2020 2073 6572 6961 6c69 7a65 7273       serializers
+000351f0: 3a20 416e 7920 3d20 4e6f 6e65 2c0a 2020  : Any = None,.  
+00035200: 2020 2920 2d3e 2041 6e79 3a0a 2020 2020    ) -> Any:.    
+00035210: 2020 2020 2222 2250 726f 7879 2061 2063      """Proxy a c
+00035220: 6f6d 6d75 6e69 6361 7469 6f6e 2074 6872  ommunication thr
+00035230: 6f75 6768 2074 6865 2073 6368 6564 756c  ough the schedul
+00035240: 6572 2074 6f20 736f 6d65 206f 7468 6572  er to some other
+00035250: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
+00035260: 2020 2064 203d 2061 7761 6974 2073 656c     d = await sel
+00035270: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
+00035280: 6d73 672c 2077 6f72 6b65 7273 3d5b 776f  msg, workers=[wo
+00035290: 726b 6572 5d2c 2073 6572 6961 6c69 7a65  rker], serialize
+000352a0: 7273 3d73 6572 6961 6c69 7a65 7273 290a  rs=serializers).
+000352b0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+000352c0: 5b77 6f72 6b65 725d 0a0a 2020 2020 6173  [worker]..    as
+000352d0: 796e 6320 6465 6620 6761 7468 6572 5f6f  ync def gather_o
+000352e0: 6e5f 776f 726b 6572 280a 2020 2020 2020  n_worker(.      
+000352f0: 2020 7365 6c66 2c20 776f 726b 6572 5f61    self, worker_a
+00035300: 6464 7265 7373 3a20 7374 722c 2077 686f  ddress: str, who
+00035310: 5f68 6173 3a20 2264 6963 745b 7374 722c  _has: "dict[str,
+00035320: 206c 6973 745b 7374 725d 5d22 0a20 2020   list[str]]".   
+00035330: 2029 202d 3e20 7365 743a 0a20 2020 2020   ) -> set:.     
+00035340: 2020 2022 2222 5065 6572 2d74 6f2d 7065     """Peer-to-pe
+00035350: 6572 2063 6f70 7920 6f66 206b 6579 7320  er copy of keys 
+00035360: 6672 6f6d 206d 756c 7469 706c 6520 776f  from multiple wo
+00035370: 726b 6572 7320 746f 2061 2073 696e 676c  rkers to a singl
+00035380: 6520 776f 726b 6572 0a0a 2020 2020 2020  e worker..      
+00035390: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+000353a0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+000353b0: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
+000353c0: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
+000353d0: 2020 2020 2020 2020 5265 6369 7069 656e          Recipien
+000353e0: 7420 776f 726b 6572 2061 6464 7265 7373  t worker address
+000353f0: 2074 6f20 636f 7079 206b 6579 7320 746f   to copy keys to
+00035400: 0a20 2020 2020 2020 2077 686f 5f68 6173  .        who_has
+00035410: 3a20 6469 6374 5b48 6173 6861 626c 652c  : dict[Hashable,
+00035420: 206c 6973 745b 7374 725d 5d0a 2020 2020   list[str]].    
+00035430: 2020 2020 2020 2020 7b6b 6579 3a20 5b73          {key: [s
+00035440: 656e 6465 7220 6164 6472 6573 732c 2073  ender address, s
+00035450: 656e 6465 7220 6164 6472 6573 732c 202e  ender address, .
+00035460: 2e2e 5d2c 206b 6579 3a20 2e2e 2e7d 0a0a  ..], key: ...}..
+00035470: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
+00035480: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+00035490: 2020 2020 2020 2020 7265 7475 726e 733a          returns:
+000354a0: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
+000354b0: 206f 6620 6b65 7973 2074 6861 7420 6661   of keys that fa
+000354c0: 696c 6564 2074 6f20 6265 2063 6f70 6965  iled to be copie
+000354d0: 640a 2020 2020 2020 2020 2222 220a 2020  d.        """.  
+000354e0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000354f0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00035500: 6177 6169 7420 7265 7472 795f 6f70 6572  await retry_oper
+00035510: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
+00035520: 2020 2020 2020 2073 656c 662e 7270 6328         self.rpc(
+00035530: 6164 6472 3d77 6f72 6b65 725f 6164 6472  addr=worker_addr
+00035540: 6573 7329 2e67 6174 6865 722c 2077 686f  ess).gather, who
+00035550: 5f68 6173 3d77 686f 5f68 6173 0a20 2020  _has=who_has.   
+00035560: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00035570: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
+00035580: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00035590: 2020 2020 2320 5468 6973 2063 616e 2068      # This can h
+000355a0: 6170 7065 6e20 652e 672e 2069 6620 7468  appen e.g. if th
+000355b0: 6520 776f 726b 6572 2069 7320 676f 696e  e worker is goin
+000355c0: 6720 7468 726f 7567 6820 636f 6e74 726f  g through contro
+000355d0: 6c6c 6564 2073 6875 7464 6f77 6e3b 0a20  lled shutdown;. 
+000355e0: 2020 2020 2020 2020 2020 2023 2069 7420             # it 
+000355f0: 646f 6573 6e27 7420 6e65 6365 7373 6172  doesn't necessar
+00035600: 696c 7920 6d65 616e 2074 6861 7420 6974  ily mean that it
+00035610: 2077 656e 7420 756e 6578 7065 6374 6564   went unexpected
+00035620: 6c79 206d 6973 7369 6e67 0a20 2020 2020  ly missing.     
+00035630: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+00035640: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+00035650: 2020 2020 2020 2066 2243 6f6d 6d75 6e69         f"Communi
+00035660: 6361 7469 6f6e 2077 6974 6820 776f 726b  cation with work
+00035670: 6572 207b 776f 726b 6572 5f61 6464 7265  er {worker_addre
+00035680: 7373 7d20 6661 696c 6564 2064 7572 696e  ss} failed durin
+00035690: 6720 220a 2020 2020 2020 2020 2020 2020  g ".            
+000356a0: 2020 2020 6622 7265 706c 6963 6174 696f      f"replicatio
+000356b0: 6e3a 207b 652e 5f5f 636c 6173 735f 5f2e  n: {e.__class__.
+000356c0: 5f5f 6e61 6d65 5f5f 7d3a 207b 657d 220a  __name__}: {e}".
+000356d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000356e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000356f0: 2073 6574 2877 686f 5f68 6173 290a 0a20   set(who_has).. 
+00035700: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
+00035710: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
+00035720: 6b65 725f 6164 6472 6573 7329 0a0a 2020  ker_address)..  
+00035730: 2020 2020 2020 6966 206e 6f74 2077 733a        if not ws:
+00035740: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00035750: 6765 722e 7761 726e 696e 6728 6622 576f  ger.warning(f"Wo
+00035760: 726b 6572 207b 776f 726b 6572 5f61 6464  rker {worker_add
+00035770: 7265 7373 7d20 6c6f 7374 2064 7572 696e  ress} lost durin
+00035780: 6720 7265 706c 6963 6174 696f 6e22 290a  g replication").
+00035790: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000357a0: 726e 2073 6574 2877 686f 5f68 6173 290a  rn set(who_has).
+000357b0: 2020 2020 2020 2020 656c 6966 2072 6573          elif res
+000357c0: 756c 745b 2273 7461 7475 7322 5d20 3d3d  ult["status"] ==
+000357d0: 2022 4f4b 223a 0a20 2020 2020 2020 2020   "OK":.         
+000357e0: 2020 206b 6579 735f 6661 696c 6564 203d     keys_failed =
+000357f0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
+00035800: 2020 206b 6579 735f 6f6b 3a20 5365 7420     keys_ok: Set 
+00035810: 3d20 7768 6f5f 6861 732e 6b65 7973 2829  = who_has.keys()
+00035820: 0a20 2020 2020 2020 2065 6c69 6620 7265  .        elif re
+00035830: 7375 6c74 5b22 7374 6174 7573 225d 203d  sult["status"] =
+00035840: 3d20 2270 6172 7469 616c 2d66 6169 6c22  = "partial-fail"
+00035850: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+00035860: 7973 5f66 6169 6c65 6420 3d20 7365 7428  ys_failed = set(
+00035870: 7265 7375 6c74 5b22 6b65 7973 225d 290a  result["keys"]).
+00035880: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+00035890: 5f6f 6b20 3d20 7768 6f5f 6861 732e 6b65  _ok = who_has.ke
+000358a0: 7973 2829 202d 206b 6579 735f 6661 696c  ys() - keys_fail
+000358b0: 6564 0a20 2020 2020 2020 2020 2020 206c  ed.            l
+000358c0: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
+000358d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000358e0: 2257 6f72 6b65 7220 7b77 6f72 6b65 725f  "Worker {worker_
+000358f0: 6164 6472 6573 737d 2066 6169 6c65 6420  address} failed 
+00035900: 746f 2061 6371 7569 7265 206b 6579 733a  to acquire keys:
+00035910: 207b 7265 7375 6c74 5b27 6b65 7973 275d   {result['keys']
+00035920: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00035930: 0a20 2020 2020 2020 2065 6c73 653a 2020  .        else:  
+00035940: 2320 7072 6167 6d61 3a20 6e6f 636f 7665  # pragma: nocove
+00035950: 720a 2020 2020 2020 2020 2020 2020 7261  r.            ra
+00035960: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00035970: 2255 6e65 7870 6563 7465 6420 6d65 7373  "Unexpected mess
+00035980: 6167 6520 6672 6f6d 207b 776f 726b 6572  age from {worker
+00035990: 5f61 6464 7265 7373 7d3a 207b 7265 7375  _address}: {resu
+000359a0: 6c74 7d22 290a 0a20 2020 2020 2020 2066  lt}")..        f
+000359b0: 6f72 206b 6579 2069 6e20 6b65 7973 5f6f  or key in keys_o
+000359c0: 6b3a 0a20 2020 2020 2020 2020 2020 2074  k:.            t
+000359d0: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
+000359e0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+000359f0: 7929 2020 2320 7479 7065 3a20 6967 6e6f  y)  # type: igno
+00035a00: 7265 0a20 2020 2020 2020 2020 2020 2069  re.            i
+00035a10: 6620 7473 2069 7320 4e6f 6e65 206f 7220  f ts is None or 
+00035a20: 7473 2e73 7461 7465 2021 3d20 226d 656d  ts.state != "mem
+00035a30: 6f72 7922 3a0a 2020 2020 2020 2020 2020  ory":.          
+00035a40: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00035a50: 6e69 6e67 2866 224b 6579 206c 6f73 7420  ning(f"Key lost 
+00035a60: 6475 7269 6e67 2072 6570 6c69 6361 7469  during replicati
+00035a70: 6f6e 3a20 7b6b 6579 7d22 290a 2020 2020  on: {key}").    
+00035a80: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00035a90: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00035aa0: 2069 6620 7773 206e 6f74 2069 6e20 7473   if ws not in ts
+00035ab0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+00035ac0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00035ad0: 6464 5f72 6570 6c69 6361 2874 732c 2077  dd_replica(ts, w
+00035ae0: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
+00035af0: 726e 206b 6579 735f 6661 696c 6564 0a0a  rn keys_failed..
+00035b00: 2020 2020 6173 796e 6320 6465 6620 6465      async def de
+00035b10: 6c65 7465 5f77 6f72 6b65 725f 6461 7461  lete_worker_data
+00035b20: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00035b30: 776f 726b 6572 5f61 6464 7265 7373 3a20  worker_address: 
+00035b40: 7374 722c 206b 6579 733a 2022 436f 6c6c  str, keys: "Coll
+00035b50: 6563 7469 6f6e 5b73 7472 5d22 2c20 7374  ection[str]", st
+00035b60: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+00035b70: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00035b80: 2020 2020 2020 2222 2244 656c 6574 6520        """Delete 
+00035b90: 6461 7461 2066 726f 6d20 6120 776f 726b  data from a work
+00035ba0: 6572 2061 6e64 2075 7064 6174 6520 7468  er and update th
+00035bb0: 6520 636f 7272 6573 706f 6e64 696e 6720  e corresponding 
+00035bc0: 776f 726b 6572 2f74 6173 6b20 7374 6174  worker/task stat
+00035bd0: 6573 0a0a 2020 2020 2020 2020 5061 7261  es..        Para
+00035be0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
+00035bf0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+00035c00: 2020 776f 726b 6572 5f61 6464 7265 7373    worker_address
+00035c10: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
+00035c20: 2020 576f 726b 6572 2061 6464 7265 7373    Worker address
+00035c30: 2074 6f20 6465 6c65 7465 206b 6579 7320   to delete keys 
+00035c40: 6672 6f6d 0a20 2020 2020 2020 206b 6579  from.        key
+00035c50: 733a 206c 6973 745b 7374 725d 0a20 2020  s: list[str].   
+00035c60: 2020 2020 2020 2020 204c 6973 7420 6f66           List of
+00035c70: 206b 6579 7320 746f 2064 656c 6574 6520   keys to delete 
+00035c80: 6f6e 2074 6865 2073 7065 6369 6669 6564  on the specified
+00035c90: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
+00035ca0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+00035cb0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00035cc0: 6974 2072 6574 7279 5f6f 7065 7261 7469  it retry_operati
+00035cd0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00035ce0: 2020 2020 7365 6c66 2e72 7063 2861 6464      self.rpc(add
+00035cf0: 723d 776f 726b 6572 5f61 6464 7265 7373  r=worker_address
+00035d00: 292e 6672 6565 5f6b 6579 732c 0a20 2020  ).free_keys,.   
+00035d10: 2020 2020 2020 2020 2020 2020 206b 6579               key
+00035d20: 733d 6c69 7374 286b 6579 7329 2c0a 2020  s=list(keys),.  
+00035d30: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00035d40: 696d 756c 7573 5f69 643d 6622 6465 6c65  imulus_id=f"dele
+00035d50: 7465 2d64 6174 612d 7b74 696d 6528 297d  te-data-{time()}
+00035d60: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+00035d70: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00035d80: 4f53 4572 726f 7220 6173 2065 3a0a 2020  OSError as e:.  
+00035d90: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+00035da0: 2063 616e 2068 6170 7065 6e20 652e 672e   can happen e.g.
+00035db0: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
+00035dc0: 7320 676f 696e 6720 7468 726f 7567 6820  s going through 
+00035dd0: 636f 6e74 726f 6c6c 6564 2073 6875 7464  controlled shutd
+00035de0: 6f77 6e3b 0a20 2020 2020 2020 2020 2020  own;.           
+00035df0: 2023 2069 7420 646f 6573 6e27 7420 6e65   # it doesn't ne
+00035e00: 6365 7373 6172 696c 7920 6d65 616e 2074  cessarily mean t
+00035e10: 6861 7420 6974 2077 656e 7420 756e 6578  hat it went unex
+00035e20: 7065 6374 6564 6c79 206d 6973 7369 6e67  pectedly missing
+00035e30: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00035e40: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00035e50: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+00035e60: 6f6d 6d75 6e69 6361 7469 6f6e 2077 6974  ommunication wit
+00035e70: 6820 776f 726b 6572 207b 776f 726b 6572  h worker {worker
+00035e80: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
+00035e90: 2064 7572 696e 6720 220a 2020 2020 2020   during ".      
+00035ea0: 2020 2020 2020 2020 2020 6622 7265 706c            f"repl
+00035eb0: 6963 6174 696f 6e3a 207b 652e 5f5f 636c  ication: {e.__cl
+00035ec0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d3a  ass__.__name__}:
+00035ed0: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
+00035ee0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00035ef0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00035f00: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+00035f10: 732e 6765 7428 776f 726b 6572 5f61 6464  s.get(worker_add
+00035f20: 7265 7373 290a 2020 2020 2020 2020 6966  ress).        if
+00035f30: 206e 6f74 2077 733a 0a20 2020 2020 2020   not ws:.       
+00035f40: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00035f50: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00035f60: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+00035f70: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
+00035f80: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+00035f90: 286b 6579 2920 2023 2074 7970 653a 2069  (key)  # type: i
+00035fa0: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+00035fb0: 2020 6966 2074 7320 6973 206e 6f74 204e    if ts is not N
+00035fc0: 6f6e 6520 616e 6420 7773 2069 6e20 7473  one and ws in ts
+00035fd0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+00035fe0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00035ff0: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
+00036000: 6d6f 7279 220a 2020 2020 2020 2020 2020  mory".          
+00036010: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+00036020: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
+00036030: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00036040: 2020 6966 206e 6f74 2074 732e 7768 6f5f    if not ts.who_
+00036050: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+00036060: 2020 2020 2020 2020 2023 204c 6173 7420           # Last 
+00036070: 636f 7079 2064 656c 6574 6564 0a20 2020  copy deleted.   
+00036080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036090: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+000360a0: 7328 7b6b 6579 3a20 2272 656c 6561 7365  s({key: "release
+000360b0: 6422 7d2c 2073 7469 6d75 6c75 735f 6964  d"}, stimulus_id
+000360c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000360d0: 6c6f 675f 6576 656e 7428 7773 2e61 6464  log_event(ws.add
+000360e0: 7265 7373 2c20 7b22 6163 7469 6f6e 223a  ress, {"action":
+000360f0: 2022 7265 6d6f 7665 2d77 6f72 6b65 722d   "remove-worker-
+00036100: 6461 7461 222c 2022 6b65 7973 223a 206b  data", "keys": k
+00036110: 6579 737d 290a 0a20 2020 2040 6c6f 675f  eys})..    @log_
+00036120: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+00036130: 2064 6566 2072 6562 616c 616e 6365 280a   def rebalance(.
+00036140: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00036150: 2020 2020 2020 6b65 7973 3a20 4974 6572        keys: Iter
+00036160: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
+00036170: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00036180: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
+00036190: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
+000361a0: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
+000361b0: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
+000361c0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000361d0: 2020 2029 202d 3e20 6469 6374 3a0a 2020     ) -> dict:.  
+000361e0: 2020 2020 2020 2222 2252 6562 616c 616e        """Rebalan
+000361f0: 6365 206b 6579 7320 736f 2074 6861 7420  ce keys so that 
+00036200: 6561 6368 2077 6f72 6b65 7220 656e 6473  each worker ends
+00036210: 2075 7020 7769 7468 2072 6f75 6768 6c79   up with roughly
+00036220: 2074 6865 2073 616d 6520 7072 6f63 6573   the same proces
+00036230: 730a 2020 2020 2020 2020 6d65 6d6f 7279  s.        memory
+00036240: 2028 6d61 6e61 6765 642b 756e 6d61 6e61   (managed+unmana
+00036250: 6765 6429 2e0a 0a20 2020 2020 2020 202e  ged)...        .
+00036260: 2e20 7761 726e 696e 673a 3a0a 2020 2020  . warning::.    
+00036270: 2020 2020 2020 2054 6869 7320 6f70 6572         This oper
+00036280: 6174 696f 6e20 6973 2067 656e 6572 616c  ation is general
+00036290: 6c79 206e 6f74 2077 656c 6c20 7465 7374  ly not well test
+000362a0: 6564 2061 6761 696e 7374 206e 6f72 6d61  ed against norma
+000362b0: 6c20 6f70 6572 6174 696f 6e20 6f66 2074  l operation of t
+000362c0: 6865 0a20 2020 2020 2020 2020 2020 7363  he.           sc
+000362d0: 6865 6475 6c65 722e 2049 7420 6973 206e  heduler. It is n
+000362e0: 6f74 2072 6563 6f6d 6d65 6e64 6564 2074  ot recommended t
+000362f0: 6f20 7573 6520 6974 2077 6869 6c65 2077  o use it while w
+00036300: 6169 7469 6e67 206f 6e20 636f 6d70 7574  aiting on comput
+00036310: 6174 696f 6e73 2e0a 0a20 2020 2020 2020  ations...       
+00036320: 202a 2a41 6c67 6f72 6974 686d 2a2a 0a0a   **Algorithm**..
+00036330: 2020 2020 2020 2020 232e 2046 696e 6420          #. Find 
+00036340: 7468 6520 6d65 616e 206f 6363 7570 616e  the mean occupan
+00036350: 6379 206f 6620 7468 6520 636c 7573 7465  cy of the cluste
+00036360: 722c 2064 6566 696e 6564 2061 7320 6461  r, defined as da
+00036370: 7461 206d 616e 6167 6564 2062 7920 6461  ta managed by da
+00036380: 736b 202b 0a20 2020 2020 2020 2020 2020  sk +.           
+00036390: 756e 6d61 6e61 6765 6420 7072 6f63 6573  unmanaged proces
+000363a0: 7320 6d65 6d6f 7279 2074 6861 7420 6861  s memory that ha
+000363b0: 7320 6265 656e 2074 6865 7265 2066 6f72  s been there for
+000363c0: 2061 7420 6c65 6173 7420 3330 2073 6563   at least 30 sec
+000363d0: 6f6e 6473 0a20 2020 2020 2020 2020 2020  onds.           
+000363e0: 2860 6064 6973 7472 6962 7574 6564 2e77  (``distributed.w
+000363f0: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
+00036400: 656e 742d 746f 2d6f 6c64 2d74 696d 6560  ent-to-old-time`
+00036410: 6029 2e0a 2020 2020 2020 2020 2020 2054  `)..           T
+00036420: 6869 7320 6c65 7473 2075 7320 6967 6e6f  his lets us igno
+00036430: 7265 2074 656d 706f 7261 7279 2073 7069  re temporary spi
+00036440: 6b65 7320 6361 7573 6564 2062 7920 7461  kes caused by ta
+00036450: 736b 2068 6561 7020 7573 6167 652e 0a0a  sk heap usage...
+00036460: 2020 2020 2020 2020 2020 2041 6c74 6572             Alter
+00036470: 6e61 7469 7665 6c79 2c20 796f 7520 6d61  natively, you ma
+00036480: 7920 6368 616e 6765 2068 6f77 206d 656d  y change how mem
+00036490: 6f72 7920 6973 206d 6561 7375 7265 6420  ory is measured 
+000364a0: 626f 7468 2066 6f72 2074 6865 2069 6e64  both for the ind
+000364b0: 6976 6964 7561 6c0a 2020 2020 2020 2020  ividual.        
+000364c0: 2020 2077 6f72 6b65 7273 2061 7320 7765     workers as we
+000364d0: 6c6c 2061 7320 746f 2063 616c 6375 6c61  ll as to calcula
+000364e0: 7465 2074 6865 206d 6561 6e20 7468 726f  te the mean thro
+000364f0: 7567 680a 2020 2020 2020 2020 2020 2060  ugh.           `
+00036500: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
+00036510: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
+00036520: 616e 6365 2e6d 6561 7375 7265 6060 2e20  ance.measure``. 
+00036530: 4e61 6d65 6c79 2c20 7468 6973 2063 616e  Namely, this can
+00036540: 2062 6520 7573 6566 756c 0a20 2020 2020   be useful.     
+00036550: 2020 2020 2020 746f 2064 6973 7265 6761        to disrega
+00036560: 7264 2069 6e61 6363 7572 6174 6520 4f53  rd inaccurate OS
+00036570: 206d 656d 6f72 7920 6d65 6173 7572 656d   memory measurem
+00036580: 656e 7473 2e0a 0a20 2020 2020 2020 2023  ents...        #
+00036590: 2e20 4469 7363 6172 6420 776f 726b 6572  . Discard worker
+000365a0: 7320 7768 6f73 6520 6f63 6375 7061 6e63  s whose occupanc
+000365b0: 7920 6973 2077 6974 6869 6e20 3525 206f  y is within 5% o
+000365c0: 6620 7468 6520 6d65 616e 2063 6c75 7374  f the mean clust
+000365d0: 6572 206f 6363 7570 616e 6379 0a20 2020  er occupancy.   
+000365e0: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
+000365f0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+00036600: 6d6f 7279 2e72 6562 616c 616e 6365 2e73  mory.rebalance.s
+00036610: 656e 6465 722d 7265 6369 7069 656e 742d  ender-recipient-
+00036620: 6761 7060 6020 2f20 3229 2e0a 2020 2020  gap`` / 2)..    
+00036630: 2020 2020 2020 2054 6869 7320 6865 6c70         This help
+00036640: 7320 6176 6f69 6420 6461 7461 2066 726f  s avoid data fro
+00036650: 6d20 626f 756e 6369 6e67 2061 726f 756e  m bouncing aroun
+00036660: 6420 7468 6520 636c 7573 7465 7220 7265  d the cluster re
+00036670: 7065 6174 6564 6c79 2e0a 2020 2020 2020  peatedly..      
+00036680: 2020 232e 2057 6f72 6b65 7273 2061 626f    #. Workers abo
+00036690: 7665 2074 6865 206d 6561 6e20 6172 6520  ve the mean are 
+000366a0: 7365 6e64 6572 733b 2074 686f 7365 2062  senders; those b
+000366b0: 656c 6f77 2061 7265 2072 6563 6970 6965  elow are recipie
+000366c0: 6e74 732e 0a20 2020 2020 2020 2023 2e20  nts..        #. 
+000366d0: 4469 7363 6172 6420 7365 6e64 6572 7320  Discard senders 
+000366e0: 7768 6f73 6520 6162 736f 6c75 7465 206f  whose absolute o
+000366f0: 6363 7570 616e 6379 2069 7320 6265 6c6f  ccupancy is belo
+00036700: 7720 3330 250a 2020 2020 2020 2020 2020  w 30%.          
+00036710: 2028 6060 6469 7374 7269 6275 7465 642e   (``distributed.
+00036720: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
+00036730: 6261 6c61 6e63 652e 7365 6e64 6572 2d6d  balance.sender-m
+00036740: 696e 6060 292e 2049 6e20 6f74 6865 7220  in``). In other 
+00036750: 776f 7264 732c 206e 6f20 6461 7461 0a20  words, no data. 
+00036760: 2020 2020 2020 2020 2020 6973 206d 6f76            is mov
+00036770: 6564 2072 6567 6172 646c 6573 7320 6f66  ed regardless of
+00036780: 2069 6d62 616c 616e 6369 6e67 2061 7320   imbalancing as 
+00036790: 6c6f 6e67 2061 7320 616c 6c20 776f 726b  long as all work
+000367a0: 6572 7320 6172 6520 6265 6c6f 7720 3330  ers are below 30
+000367b0: 252e 0a20 2020 2020 2020 2023 2e20 4469  %..        #. Di
+000367c0: 7363 6172 6420 7265 6369 7069 656e 7473  scard recipients
+000367d0: 2077 686f 7365 2061 6273 6f6c 7574 6520   whose absolute 
+000367e0: 6f63 6375 7061 6e63 7920 6973 2061 626f  occupancy is abo
+000367f0: 7665 2036 3025 0a20 2020 2020 2020 2020  ve 60%.         
+00036800: 2020 2860 6064 6973 7472 6962 7574 6564    (``distributed
+00036810: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+00036820: 6562 616c 616e 6365 2e72 6563 6970 6965  ebalance.recipie
+00036830: 6e74 2d6d 6178 6060 292e 0a20 2020 2020  nt-max``)..     
+00036840: 2020 2020 2020 4e6f 7465 2074 6861 7420        Note that 
+00036850: 7468 6973 2074 6872 6573 686f 6c64 2062  this threshold b
+00036860: 7920 6465 6661 756c 7420 6973 2074 6865  y default is the
+00036870: 2073 616d 6520 6173 0a20 2020 2020 2020   same as.       
+00036880: 2020 2020 6060 6469 7374 7269 6275 7465      ``distribute
+00036890: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+000368a0: 7461 7267 6574 6060 2074 6f20 7072 6576  target`` to prev
+000368b0: 656e 7420 776f 726b 6572 7320 6672 6f6d  ent workers from
+000368c0: 2061 6363 6570 7469 6e67 2064 6174 610a   accepting data.
+000368d0: 2020 2020 2020 2020 2020 2061 6e64 2069             and i
+000368e0: 6d6d 6564 6961 7465 6c79 2073 7069 6c6c  mmediately spill
+000368f0: 696e 6720 6974 206f 7574 2074 6f20 6469  ing it out to di
+00036900: 736b 2e0a 2020 2020 2020 2020 232e 2049  sk..        #. I
+00036910: 7465 7261 7469 7665 6c79 2070 6963 6b20  teratively pick 
+00036920: 7468 6520 7365 6e64 6572 2061 6e64 2072  the sender and r
+00036930: 6563 6970 6965 6e74 2074 6861 7420 6172  ecipient that ar
+00036940: 6520 6661 7274 6865 7374 2066 726f 6d20  e farthest from 
+00036950: 7468 6520 6d65 616e 2061 6e64 0a20 2020  the mean and.   
+00036960: 2020 2020 2020 2020 6d6f 7665 2074 6865          move the
+00036970: 202a 6c65 6173 7420 7265 6365 6e74 6c79   *least recently
+00036980: 2069 6e73 6572 7465 642a 206b 6579 2062   inserted* key b
+00036990: 6574 7765 656e 2074 6865 2074 776f 2c20  etween the two, 
+000369a0: 756e 7469 6c20 6569 7468 6572 2061 6c6c  until either all
+000369b0: 0a20 2020 2020 2020 2020 2020 7365 6e64  .           send
+000369c0: 6572 7320 6f72 2061 6c6c 2072 6563 6970  ers or all recip
+000369d0: 6965 6e74 7320 6661 6c6c 2077 6974 6869  ients fall withi
+000369e0: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
+000369f0: 2e0a 0a20 2020 2020 2020 2020 2020 4120  ...           A 
+00036a00: 7265 6369 7069 656e 7420 7769 6c6c 2062  recipient will b
+00036a10: 6520 736b 6970 7065 6420 6966 2069 7420  e skipped if it 
+00036a20: 616c 7265 6164 7920 6861 7320 6120 636f  already has a co
+00036a30: 7079 206f 6620 7468 6520 6461 7461 2e20  py of the data. 
+00036a40: 496e 206f 7468 6572 0a20 2020 2020 2020  In other.       
+00036a50: 2020 2020 776f 7264 732c 2074 6869 7320      words, this 
+00036a60: 6d65 7468 6f64 2064 6f65 7320 6e6f 7420  method does not 
+00036a70: 6465 6772 6164 6520 7265 706c 6963 6174  degrade replicat
+00036a80: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+00036a90: 4120 6b65 7920 7769 6c6c 2062 6520 736b  A key will be sk
+00036aa0: 6970 7065 6420 6966 2074 6865 7265 2061  ipped if there a
+00036ab0: 7265 206e 6f20 7265 6369 7069 656e 7473  re no recipients
+00036ac0: 2061 7661 696c 6162 6c65 2077 6974 6820   available with 
+00036ad0: 656e 6f75 6768 206d 656d 6f72 790a 2020  enough memory.  
+00036ae0: 2020 2020 2020 2020 2074 6f20 6163 6365           to acce
+00036af0: 7074 2074 6865 206b 6579 2061 6e64 2074  pt the key and t
+00036b00: 6861 7420 646f 6e27 7420 616c 7265 6164  hat don't alread
+00036b10: 7920 686f 6c64 2061 2063 6f70 792e 0a0a  y hold a copy...
+00036b20: 2020 2020 2020 2020 5468 6520 6c65 6173          The leas
+00036b30: 7420 7265 6365 6e74 6c79 2069 6e73 6572  t recently inser
+00036b40: 7464 2028 4c52 4929 2070 6f6c 6963 7920  td (LRI) policy 
+00036b50: 6973 2061 2067 7265 6564 7920 6368 6f69  is a greedy choi
+00036b60: 6365 2077 6974 6820 7468 6520 6164 7661  ce with the adva
+00036b70: 6e74 6167 6520 6f66 0a20 2020 2020 2020  ntage of.       
+00036b80: 2062 6569 6e67 204f 2831 292c 2074 7269   being O(1), tri
+00036b90: 7669 616c 2074 6f20 696d 706c 656d 656e  vial to implemen
+00036ba0: 7420 2869 7420 7265 6c69 6573 206f 6e20  t (it relies on 
+00036bb0: 7079 7468 6f6e 2064 6963 7420 696e 7365  python dict inse
+00036bc0: 7274 696f 6e2d 736f 7274 696e 6729 0a20  rtion-sorting). 
+00036bd0: 2020 2020 2020 2061 6e64 2068 6f70 6566         and hopef
+00036be0: 756c 6c79 2067 6f6f 6420 656e 6f75 6768  ully good enough
+00036bf0: 2069 6e20 6d6f 7374 2063 6173 6573 2e20   in most cases. 
+00036c00: 4469 7363 6172 6465 6420 616c 7465 726e  Discarded altern
+00036c10: 6174 6976 6520 706f 6c69 6369 6573 2077  ative policies w
+00036c20: 6572 653a 0a0a 2020 2020 2020 2020 2d20  ere:..        - 
+00036c30: 4c61 7267 6573 7420 6669 7273 742e 204f  Largest first. O
+00036c40: 286e 2a6c 6f67 286e 2929 2073 6176 6520  (n*log(n)) save 
+00036c50: 666f 7220 6e6f 6e2d 7472 6976 6961 6c20  for non-trivial 
+00036c60: 6164 6469 7469 6f6e 616c 2064 6174 6120  additional data 
+00036c70: 7374 7275 6374 7572 6573 2061 6e64 0a20  structures and. 
+00036c80: 2020 2020 2020 2020 2072 6973 6b73 2063           risks c
+00036c90: 6175 7369 6e67 2074 6865 206c 6172 6765  ausing the large
+00036ca0: 7374 2063 6875 6e6b 7320 6f66 2064 6174  st chunks of dat
+00036cb0: 6120 746f 2072 6570 6561 7465 646c 7920  a to repeatedly 
+00036cc0: 6d6f 7665 2061 726f 756e 6420 7468 650a  move around the.
+00036cd0: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00036ce0: 7220 6c69 6b65 2070 696e 6261 6c6c 732e  r like pinballs.
+00036cf0: 0a20 2020 2020 2020 202d 204c 6561 7374  .        - Least
+00036d00: 2072 6563 656e 746c 7920 7573 6564 2028   recently used (
+00036d10: 4c52 5529 2e20 5468 6973 2069 6e66 6f72  LRU). This infor
+00036d20: 6d61 7469 6f6e 2069 7320 6375 7272 656e  mation is curren
+00036d30: 746c 7920 6176 6169 6c61 626c 6520 6f6e  tly available on
+00036d40: 2074 6865 0a20 2020 2020 2020 2020 2077   the.          w
+00036d50: 6f72 6b65 7273 206f 6e6c 7920 616e 6420  orkers only and 
+00036d60: 6e6f 7420 7472 6976 6961 6c20 746f 2072  not trivial to r
+00036d70: 6570 6c69 6361 7465 206f 6e20 7468 6520  eplicate on the 
+00036d80: 7363 6865 6475 6c65 723b 2074 7261 6e73  scheduler; trans
+00036d90: 6d69 7474 696e 6720 6974 0a20 2020 2020  mitting it.     
+00036da0: 2020 2020 206f 7665 7220 7468 6520 6e65       over the ne
+00036db0: 7477 6f72 6b20 776f 756c 6420 6265 2076  twork would be v
+00036dc0: 6572 7920 6578 7065 6e73 6976 652e 2041  ery expensive. A
+00036dd0: 6c73 6f2c 206e 6f74 6520 7468 6174 2064  lso, note that d
+00036de0: 6173 6b20 7769 6c6c 2067 6f20 6f75 7420  ask will go out 
+00036df0: 6f66 0a20 2020 2020 2020 2020 2069 7473  of.          its
+00036e00: 2077 6179 2074 6f20 6d69 6e69 6d69 7365   way to minimise
+00036e10: 2074 6865 2061 6d6f 756e 7420 6f66 2074   the amount of t
+00036e20: 696d 6520 696e 7465 726d 6564 6961 7465  ime intermediate
+00036e30: 206b 6579 7320 6172 6520 6865 6c64 2069   keys are held i
+00036e40: 6e20 6d65 6d6f 7279 2c0a 2020 2020 2020  n memory,.      
+00036e50: 2020 2020 736f 2069 6e20 7375 6368 2061      so in such a
+00036e60: 2063 6173 6520 4c52 4920 6973 2061 2063   case LRI is a c
+00036e70: 6c6f 7365 2061 7070 726f 7869 6d61 7469  lose approximati
+00036e80: 6f6e 206f 6620 4c52 552e 0a0a 2020 2020  on of LRU...    
+00036e90: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00036ea0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00036eb0: 2d0a 2020 2020 2020 2020 6b65 7973 3a20  -.        keys: 
+00036ec0: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
+00036ed0: 2020 2020 2061 6c6c 6f77 6c69 7374 206f       allowlist o
+00036ee0: 6620 6461 736b 206b 6579 7320 7468 6174  f dask keys that
+00036ef0: 2073 686f 756c 6420 6265 2063 6f6e 7369   should be consi
+00036f00: 6465 7265 6420 666f 7220 6d6f 7669 6e67  dered for moving
+00036f10: 2e20 416c 6c20 6f74 6865 7220 6b65 7973  . All other keys
+00036f20: 0a20 2020 2020 2020 2020 2020 2077 696c  .            wil
+00036f30: 6c20 6265 2069 676e 6f72 6564 2e20 4e6f  l be ignored. No
+00036f40: 7465 2074 6861 7420 7468 6973 206f 6666  te that this off
+00036f50: 6572 7320 6e6f 2067 7561 7261 6e74 6565  ers no guarantee
+00036f60: 2074 6861 7420 6120 6b65 7920 7769 6c6c   that a key will
+00036f70: 2061 6374 7561 6c6c 790a 2020 2020 2020   actually.      
+00036f80: 2020 2020 2020 6265 206d 6f76 6564 2028        be moved (
+00036f90: 652e 672e 2062 6563 6175 7365 2069 7420  e.g. because it 
+00036fa0: 6973 2075 6e6e 6563 6573 7361 7279 206f  is unnecessary o
+00036fb0: 7220 6265 6361 7573 6520 7468 6572 6520  r because there 
+00036fc0: 6172 6520 6e6f 2076 6961 626c 650a 2020  are no viable.  
+00036fd0: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
+00036fe0: 656e 7420 776f 726b 6572 7320 666f 7220  ent workers for 
+00036ff0: 6974 292e 0a20 2020 2020 2020 2077 6f72  it)..        wor
+00037000: 6b65 7273 3a20 6f70 7469 6f6e 616c 0a20  kers: optional. 
+00037010: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
+00037020: 6c69 7374 206f 6620 776f 726b 6572 7320  list of workers 
+00037030: 6164 6472 6573 7365 7320 746f 2062 6520  addresses to be 
+00037040: 636f 6e73 6964 6572 6564 2061 7320 7365  considered as se
+00037050: 6e64 6572 7320 6f72 2072 6563 6970 6965  nders or recipie
+00037060: 6e74 732e 0a20 2020 2020 2020 2020 2020  nts..           
+00037070: 2041 6c6c 206f 7468 6572 2077 6f72 6b65   All other worke
+00037080: 7273 2077 696c 6c20 6265 2069 676e 6f72  rs will be ignor
+00037090: 6564 2e20 5468 6520 6d65 616e 2063 6c75  ed. The mean clu
+000370a0: 7374 6572 206f 6363 7570 616e 6379 2077  ster occupancy w
+000370b0: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
+000370c0: 2020 2063 616c 6375 6c61 7465 6420 6f6e     calculated on
+000370d0: 6c79 2075 7369 6e67 2074 6865 2061 6c6c  ly using the all
+000370e0: 6f77 6564 2077 6f72 6b65 7273 2e0a 2020  owed workers..  
+000370f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00037100: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
+00037110: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
+00037120: 2272 6562 616c 616e 6365 2d7b 7469 6d65  "rebalance-{time
+00037130: 2829 7d22 0a0a 2020 2020 2020 2020 7773  ()}"..        ws
+00037140: 733a 2043 6f6c 6c65 6374 696f 6e5b 576f  s: Collection[Wo
+00037150: 726b 6572 5374 6174 655d 0a20 2020 2020  rkerState].     
+00037160: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
+00037170: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00037180: 2020 2020 2020 2077 7373 203d 205b 7365         wss = [se
+00037190: 6c66 2e77 6f72 6b65 7273 5b77 5d20 666f  lf.workers[w] fo
+000371a0: 7220 7720 696e 2077 6f72 6b65 7273 5d0a  r w in workers].
+000371b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000371c0: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
+000371d0: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+000371e0: 7565 7328 290a 2020 2020 2020 2020 6966  ues().        if
+000371f0: 206e 6f74 2077 7373 3a0a 2020 2020 2020   not wss:.      
+00037200: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
+00037210: 7461 7475 7322 3a20 224f 4b22 7d0a 0a20  tatus": "OK"}.. 
+00037220: 2020 2020 2020 2069 6620 6b65 7973 2069         if keys i
+00037230: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00037240: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00037250: 7369 6e73 7461 6e63 6528 6b65 7973 2c20  sinstance(keys, 
+00037260: 5365 7429 3a0a 2020 2020 2020 2020 2020  Set):.          
+00037270: 2020 2020 2020 6b65 7973 203d 2073 6574        keys = set
+00037280: 286b 6579 7329 2020 2320 756e 6c65 7373  (keys)  # unless
+00037290: 2061 6c72 6561 6479 2061 2073 6574 2d6c   already a set-l
+000372a0: 696b 650a 2020 2020 2020 2020 2020 2020  ike.            
+000372b0: 6966 206e 6f74 206b 6579 733a 0a20 2020  if not keys:.   
+000372c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000372d0: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
+000372e0: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
+000372f0: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
+00037300: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00037310: 2020 6b20 666f 7220 6b20 696e 206b 6579    k for k in key
+00037320: 7320 6966 206b 206e 6f74 2069 6e20 7365  s if k not in se
+00037330: 6c66 2e74 6173 6b73 206f 7220 6e6f 7420  lf.tasks or not 
+00037340: 7365 6c66 2e74 6173 6b73 5b6b 5d2e 7768  self.tasks[k].wh
+00037350: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
+00037360: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00037370: 6966 206d 6973 7369 6e67 5f64 6174 613a  if missing_data:
+00037380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037390: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
+000373a0: 223a 2022 7061 7274 6961 6c2d 6661 696c  ": "partial-fail
+000373b0: 222c 2022 6b65 7973 223a 206d 6973 7369  ", "keys": missi
+000373c0: 6e67 5f64 6174 617d 0a0a 2020 2020 2020  ng_data}..      
+000373d0: 2020 6d73 6773 203d 2073 656c 662e 5f72    msgs = self._r
+000373e0: 6562 616c 616e 6365 5f66 696e 645f 6d73  ebalance_find_ms
+000373f0: 6773 286b 6579 732c 2077 7373 290a 2020  gs(keys, wss).  
+00037400: 2020 2020 2020 6966 206e 6f74 206d 7367        if not msg
+00037410: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00037420: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
+00037430: 2022 4f4b 227d 0a0a 2020 2020 2020 2020   "OK"}..        
+00037440: 6173 796e 6320 7769 7468 2073 656c 662e  async with self.
+00037450: 5f6c 6f63 6b3a 0a20 2020 2020 2020 2020  _lock:.         
+00037460: 2020 2072 6573 756c 7420 3d20 6177 6169     result = awai
+00037470: 7420 7365 6c66 2e5f 7265 6261 6c61 6e63  t self._rebalanc
+00037480: 655f 6d6f 7665 5f64 6174 6128 6d73 6773  e_move_data(msgs
+00037490: 2c20 7374 696d 756c 7573 5f69 6429 0a20  , stimulus_id). 
+000374a0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+000374b0: 7375 6c74 5b22 7374 6174 7573 225d 203d  sult["status"] =
+000374c0: 3d20 2270 6172 7469 616c 2d66 6169 6c22  = "partial-fail"
+000374d0: 2061 6e64 206b 6579 7320 6973 204e 6f6e   and keys is Non
+000374e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000374f0: 2020 2023 204f 6e6c 7920 7265 7475 726e     # Only return
+00037500: 2066 6169 6c65 6420 6b65 7973 2069 6620   failed keys if 
+00037510: 7468 6520 636c 6965 6e74 2065 7870 6c69  the client expli
+00037520: 6369 746c 7920 6173 6b65 6420 666f 7220  citly asked for 
+00037530: 7468 656d 0a20 2020 2020 2020 2020 2020  them.           
+00037540: 2020 2020 2072 6573 756c 7420 3d20 7b22       result = {"
+00037550: 7374 6174 7573 223a 2022 4f4b 227d 0a20  status": "OK"}. 
+00037560: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00037570: 6e20 7265 7375 6c74 0a0a 2020 2020 6465  n result..    de
+00037580: 6620 5f72 6562 616c 616e 6365 5f66 696e  f _rebalance_fin
+00037590: 645f 6d73 6773 280a 2020 2020 2020 2020  d_msgs(.        
+000375a0: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
+000375b0: 7973 3a20 5365 745b 4861 7368 6162 6c65  ys: Set[Hashable
+000375c0: 5d20 7c20 4e6f 6e65 2c0a 2020 2020 2020  ] | None,.      
+000375d0: 2020 776f 726b 6572 733a 2049 7465 7261    workers: Itera
+000375e0: 626c 655b 576f 726b 6572 5374 6174 655d  ble[WorkerState]
+000375f0: 2c0a 2020 2020 2920 2d3e 206c 6973 745b  ,.    ) -> list[
+00037600: 7475 706c 655b 576f 726b 6572 5374 6174  tuple[WorkerStat
+00037610: 652c 2057 6f72 6b65 7253 7461 7465 2c20  e, WorkerState, 
+00037620: 5461 736b 5374 6174 655d 5d3a 0a20 2020  TaskState]]:.   
+00037630: 2020 2020 2022 2222 4964 656e 7469 6679       """Identify
+00037640: 2077 6f72 6b65 7273 2074 6861 7420 6e65   workers that ne
+00037650: 6564 2074 6f20 6c6f 7365 206b 6579 7320  ed to lose keys 
+00037660: 616e 6420 7468 6f73 6520 7468 6174 2063  and those that c
+00037670: 616e 2072 6563 6569 7665 2074 6865 6d2c  an receive them,
+00037680: 0a20 2020 2020 2020 2074 6f67 6574 6865  .        togethe
+00037690: 7220 7769 7468 2068 6f77 206d 616e 7920  r with how many 
+000376a0: 6279 7465 7320 6561 6368 206e 6565 6473  bytes each needs
+000376b0: 2074 6f20 6c6f 7365 2f72 6563 6569 7665   to lose/receive
+000376c0: 2e20 5468 656e 2c20 7061 6972 2061 2073  . Then, pair a s
+000376d0: 656e 6465 720a 2020 2020 2020 2020 776f  ender.        wo
+000376e0: 726b 6572 2077 6974 6820 6120 7265 6369  rker with a reci
+000376f0: 7069 656e 7420 776f 726b 6572 2066 6f72  pient worker for
+00037700: 2065 6163 6820 6b65 792c 2075 6e74 696c   each key, until
+00037710: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00037720: 7265 6261 6c61 6e63 6564 2e0a 0a20 2020  rebalanced...   
+00037730: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
+00037740: 206f 6e6c 7920 6465 6669 6e65 7320 7468   only defines th
+00037750: 6520 776f 726b 2074 6f20 6265 2070 6572  e work to be per
+00037760: 666f 726d 6564 3b20 6974 2064 6f65 7320  formed; it does 
+00037770: 6e6f 7420 7374 6172 7420 616e 7920 6e65  not start any ne
+00037780: 7477 6f72 6b0a 2020 2020 2020 2020 7472  twork.        tr
+00037790: 616e 7366 6572 7320 6974 7365 6c66 2e0a  ansfers itself..
+000377a0: 0a20 2020 2020 2020 2054 6865 2062 6967  .        The big
+000377b0: 2d4f 2063 6f6d 706c 6578 6974 7920 6973  -O complexity is
+000377c0: 204f 2877 7420 2b20 6b65 2a6c 6f67 2877   O(wt + ke*log(w
+000377d0: 6529 292c 2077 6865 7265 0a0a 2020 2020  e)), where..    
+000377e0: 2020 2020 2d20 7774 2069 7320 7468 6520      - wt is the 
+000377f0: 746f 7461 6c20 6e75 6d62 6572 206f 6620  total number of 
+00037800: 776f 726b 6572 7320 6f6e 2074 6865 2063  workers on the c
+00037810: 6c75 7374 6572 2028 6f72 2074 6865 206e  luster (or the n
+00037820: 756d 6265 7220 6f66 2061 6c6c 6f77 6564  umber of allowed
+00037830: 0a20 2020 2020 2020 2020 2077 6f72 6b65  .          worke
+00037840: 7273 2c20 6966 2065 7870 6c69 6369 746c  rs, if explicitl
+00037850: 7920 7374 6174 6564 2062 7920 7468 6520  y stated by the 
+00037860: 7573 6572 290a 2020 2020 2020 2020 2d20  user).        - 
+00037870: 7765 2069 7320 7468 6520 6e75 6d62 6572  we is the number
+00037880: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
+00037890: 2061 7265 2065 6c69 6769 626c 6520 746f   are eligible to
+000378a0: 2062 6520 7365 6e64 6572 7320 6f72 2072   be senders or r
+000378b0: 6563 6970 6965 6e74 730a 2020 2020 2020  ecipients.      
+000378c0: 2020 2d20 6b74 2069 7320 7468 6520 746f    - kt is the to
+000378d0: 7461 6c20 6e75 6d62 6572 206f 6620 6b65  tal number of ke
+000378e0: 7973 206f 6e20 7468 6520 636c 7573 7465  ys on the cluste
+000378f0: 7220 286f 7220 6f6e 2074 6865 2061 6c6c  r (or on the all
+00037900: 6f77 6564 2077 6f72 6b65 7273 290a 2020  owed workers).  
+00037910: 2020 2020 2020 2d20 6b65 2069 7320 7468        - ke is th
+00037920: 6520 6e75 6d62 6572 206f 6620 6b65 7973  e number of keys
+00037930: 2074 6861 7420 6e65 6564 2074 6f20 6265   that need to be
+00037940: 206d 6f76 6564 2069 6e20 6f72 6465 7220   moved in order 
+00037950: 746f 2061 6368 6965 7665 2061 2062 616c  to achieve a bal
+00037960: 616e 6365 640a 2020 2020 2020 2020 2020  anced.          
+00037970: 636c 7573 7465 720a 0a20 2020 2020 2020  cluster..       
+00037980: 2054 6865 7265 2069 7320 6120 6465 6765   There is a dege
+00037990: 6e65 7261 7465 2065 6467 6520 6361 7365  nerate edge case
+000379a0: 204f 2877 7420 2b20 6b74 2a6c 6f67 2877   O(wt + kt*log(w
+000379b0: 6529 2920 7768 656e 206b 7420 6973 206d  e)) when kt is m
+000379c0: 7563 6820 6772 6561 7465 7220 7468 616e  uch greater than
+000379d0: 0a20 2020 2020 2020 2074 6865 206e 756d  .        the num
+000379e0: 6265 7220 6f66 2061 6c6c 6f77 6564 206b  ber of allowed k
+000379f0: 6579 732c 206f 7220 7768 656e 206d 6f73  eys, or when mos
+00037a00: 7420 6b65 7973 2061 7265 2072 6570 6c69  t keys are repli
+00037a10: 6361 7465 6420 6f72 2063 616e 6e6f 7420  cated or cannot 
+00037a20: 6265 0a20 2020 2020 2020 206d 6f76 6564  be.        moved
+00037a30: 2066 6f72 2073 6f6d 6520 6f74 6865 7220   for some other 
+00037a40: 7265 6173 6f6e 2e0a 0a20 2020 2020 2020  reason...       
+00037a50: 2052 6574 7572 6e73 206c 6973 7420 6f66   Returns list of
+00037a60: 2074 7570 6c65 7320 746f 2066 6565 6420   tuples to feed 
+00037a70: 696e 746f 205f 7265 6261 6c61 6e63 655f  into _rebalance_
+00037a80: 6d6f 7665 5f64 6174 613a 0a0a 2020 2020  move_data:..    
+00037a90: 2020 2020 2d20 7365 6e64 6572 2077 6f72      - sender wor
+00037aa0: 6b65 720a 2020 2020 2020 2020 2d20 7265  ker.        - re
+00037ab0: 6369 7069 656e 7420 776f 726b 6572 0a20  cipient worker. 
+00037ac0: 2020 2020 2020 202d 2074 6173 6b20 746f         - task to
+00037ad0: 2062 6520 7472 616e 7366 6572 7265 640a   be transferred.
+00037ae0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00037af0: 2020 2020 2320 4865 6170 7320 6f66 2077      # Heaps of w
+00037b00: 6f72 6b65 7273 2c20 6d61 6e61 6765 6420  orkers, managed 
+00037b10: 6279 2074 6865 2068 6561 7071 206d 6f64  by the heapq mod
+00037b20: 756c 652c 2074 6861 7420 6e65 6564 2074  ule, that need t
+00037b30: 6f20 7365 6e64 2f72 6563 6569 7665 2064  o send/receive d
+00037b40: 6174 612c 0a20 2020 2020 2020 2023 2077  ata,.        # w
+00037b50: 6974 6820 686f 7720 6d61 6e79 2062 7974  ith how many byt
+00037b60: 6573 2065 6163 6820 6e65 6564 7320 746f  es each needs to
+00037b70: 2073 656e 642f 7265 6365 6976 652e 0a20   send/receive.. 
+00037b80: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+00037b90: 2023 2045 6163 6820 656c 656d 656e 7420   # Each element 
+00037ba0: 6f66 2074 6865 2068 6561 7020 6973 2061  of the heap is a
+00037bb0: 2074 7570 6c65 2063 6f6e 7374 7275 6374   tuple construct
+00037bc0: 6564 2061 7320 666f 6c6c 6f77 733a 0a20  ed as follows:. 
+00037bd0: 2020 2020 2020 2023 202d 2073 6e64 5f62         # - snd_b
+00037be0: 7974 6573 5f6d 6178 2f72 6563 5f62 7974  ytes_max/rec_byt
+00037bf0: 6573 5f6d 6178 3a20 6d61 7869 6d75 6d20  es_max: maximum 
+00037c00: 6e75 6d62 6572 206f 6620 6279 7465 7320  number of bytes 
+00037c10: 746f 2073 656e 6420 6f72 2072 6563 6569  to send or recei
+00037c20: 7665 2e0a 2020 2020 2020 2020 2320 2020  ve..        #   
+00037c30: 5468 6973 206e 756d 6265 7220 6973 206e  This number is n
+00037c40: 6567 6174 6976 652c 2073 6f20 7468 6174  egative, so that
+00037c50: 2074 6865 2077 6f72 6b65 7273 2066 6172   the workers far
+00037c60: 7468 6573 7420 6672 6f6d 2074 6865 2063  thest from the c
+00037c70: 6c75 7374 6572 206d 6561 6e0a 2020 2020  luster mean.    
+00037c80: 2020 2020 2320 2020 6172 6520 6174 2074      #   are at t
+00037c90: 6865 2074 6f70 206f 6620 7468 6520 736d  he top of the sm
+00037ca0: 616c 6c65 7374 2d66 6972 7374 2068 6561  allest-first hea
+00037cb0: 7073 2e0a 2020 2020 2020 2020 2320 2d20  ps..        # - 
+00037cc0: 736e 645f 6279 7465 735f 6d69 6e2f 7265  snd_bytes_min/re
+00037cd0: 635f 6279 7465 735f 6d69 6e3a 206d 696e  c_bytes_min: min
+00037ce0: 696d 756d 206e 756d 6265 7220 6f66 2062  imum number of b
+00037cf0: 7974 6573 2061 6674 6572 2073 656e 6469  ytes after sendi
+00037d00: 6e67 2f72 6563 6569 7669 6e67 0a20 2020  ng/receiving.   
+00037d10: 2020 2020 2023 2020 2077 6869 6368 2074       #   which t
+00037d20: 6865 2077 6f72 6b65 7220 7368 6f75 6c64  he worker should
+00037d30: 206e 6f74 2062 6520 636f 6e73 6964 6572   not be consider
+00037d40: 6564 2061 6e79 6d6f 7265 2e20 5468 6973  ed anymore. This
+00037d50: 2069 7320 616c 736f 206e 6567 6174 6976   is also negativ
+00037d60: 652e 0a20 2020 2020 2020 2023 202d 2061  e..        # - a
+00037d70: 7262 6974 7261 7279 2075 6e69 7175 6520  rbitrary unique 
+00037d80: 6e75 6d62 6572 2c20 7468 6572 6520 6a75  number, there ju
+00037d90: 7374 2074 6f20 746f 206d 616b 6520 7375  st to to make su
+00037da0: 7265 2074 6861 7420 576f 726b 6572 5374  re that WorkerSt
+00037db0: 6174 6520 6f62 6a65 6374 730a 2020 2020  ate objects.    
+00037dc0: 2020 2020 2320 2020 6172 6520 6e65 7665      #   are neve
+00037dd0: 7220 7573 6564 2066 6f72 2073 6f72 7469  r used for sorti
+00037de0: 6e67 2069 6e20 7468 6520 756e 6c69 6b65  ng in the unlike
+00037df0: 6c79 2065 7665 6e74 2074 6861 7420 7477  ly event that tw
+00037e00: 6f20 7072 6f63 6573 7365 7320 6861 7665  o processes have
+00037e10: 0a20 2020 2020 2020 2023 2020 2065 7861  .        #   exa
+00037e20: 6374 6c79 2074 6865 2073 616d 6520 6e75  ctly the same nu
+00037e30: 6d62 6572 206f 6620 6279 7465 7320 616c  mber of bytes al
+00037e40: 6c6f 6361 7465 642e 0a20 2020 2020 2020  located..       
+00037e50: 2023 202d 2057 6f72 6b65 7253 7461 7465   # - WorkerState
+00037e60: 0a20 2020 2020 2020 2023 202d 2069 7465  .        # - ite
+00037e70: 7261 746f 7220 6f66 2061 6c6c 2074 6173  rator of all tas
+00037e80: 6b73 2069 6e20 6d65 6d6f 7279 206f 6e20  ks in memory on 
+00037e90: 7468 6520 776f 726b 6572 2028 7365 6e64  the worker (send
+00037ea0: 6572 7320 6f6e 6c79 292c 2069 6e73 6572  ers only), inser
+00037eb0: 7469 6f6e 0a20 2020 2020 2020 2023 2020  tion.        #  
+00037ec0: 2073 6f72 7465 6420 286c 6561 7374 2072   sorted (least r
+00037ed0: 6563 656e 746c 7920 696e 7365 7274 6564  ecently inserted
+00037ee0: 2066 6972 7374 292e 0a20 2020 2020 2020   first)..       
+00037ef0: 2023 2020 204e 6f74 6520 7468 6174 2074   #   Note that t
+00037f00: 6869 7320 6974 6572 6174 6f72 2077 696c  his iterator wil
+00037f10: 6c20 7479 7069 6361 6c6c 7920 2a6e 6f74  l typically *not
+00037f20: 2a20 6265 2065 7868 6175 7374 6564 2e20  * be exhausted. 
+00037f30: 4974 2077 696c 6c20 6f6e 6c79 2062 650a  It will only be.
+00037f40: 2020 2020 2020 2020 2320 2020 6578 6861          #   exha
+00037f50: 7573 7465 6420 6966 2c20 6166 7465 7220  usted if, after 
+00037f60: 6d6f 7669 6e67 2061 7761 7920 6672 6f6d  moving away from
+00037f70: 2074 6865 2077 6f72 6b65 7220 616c 6c20   the worker all 
+00037f80: 6b65 7973 2074 6861 7420 6361 6e20 6265  keys that can be
+00037f90: 206d 6f76 6564 2c0a 2020 2020 2020 2020   moved,.        
+00037fa0: 2320 2020 6973 2069 6e73 7566 6669 6369  #   is insuffici
+00037fb0: 656e 7420 746f 2064 726f 7020 736e 645f  ent to drop snd_
+00037fc0: 6279 7465 735f 6d69 6e20 6162 6f76 6520  bytes_min above 
+00037fd0: 302e 0a20 2020 2020 2020 2073 656e 6465  0..        sende
+00037fe0: 7273 3a20 6c69 7374 5b74 7570 6c65 5b69  rs: list[tuple[i
+00037ff0: 6e74 2c20 696e 742c 2069 6e74 2c20 576f  nt, int, int, Wo
+00038000: 726b 6572 5374 6174 652c 2049 7465 7261  rkerState, Itera
+00038010: 746f 725b 5461 736b 5374 6174 655d 5d5d  tor[TaskState]]]
+00038020: 203d 205b 5d0a 2020 2020 2020 2020 7265   = [].        re
+00038030: 6369 7069 656e 7473 3a20 6c69 7374 5b74  cipients: list[t
+00038040: 7570 6c65 5b69 6e74 2c20 696e 742c 2069  uple[int, int, i
+00038050: 6e74 2c20 576f 726b 6572 5374 6174 655d  nt, WorkerState]
+00038060: 5d20 3d20 5b5d 0a0a 2020 2020 2020 2020  ] = []..        
+00038070: 2320 4f75 7470 7574 3a20 5b28 7365 6e64  # Output: [(send
+00038080: 6572 2c20 7265 6369 7069 656e 742c 2074  er, recipient, t
+00038090: 6173 6b29 2c20 2e2e 2e5d 0a20 2020 2020  ask), ...].     
+000380a0: 2020 206d 7367 733a 206c 6973 745b 7475     msgs: list[tu
+000380b0: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
+000380c0: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
+000380d0: 736b 5374 6174 655d 5d20 3d20 5b5d 0a0a  skState]] = []..
+000380e0: 2020 2020 2020 2020 2320 4279 2064 6566          # By def
+000380f0: 6175 6c74 2c20 7468 6973 2069 7320 7468  ault, this is th
+00038100: 6520 6f70 7469 6d69 7374 6963 206d 656d  e optimistic mem
+00038110: 6f72 792c 206d 6561 6e69 6e67 2074 6f74  ory, meaning tot
+00038120: 616c 2070 726f 6365 7373 206d 656d 6f72  al process memor
+00038130: 7920 6d69 6e75 730a 2020 2020 2020 2020  y minus.        
+00038140: 2320 756e 6d61 6e61 6765 6420 6d65 6d6f  # unmanaged memo
+00038150: 7279 2074 6861 7420 6170 7065 6172 6564  ry that appeared
+00038160: 206f 7665 7220 7468 6520 6c61 7374 2033   over the last 3
+00038170: 3020 7365 636f 6e64 730a 2020 2020 2020  0 seconds.      
+00038180: 2020 2320 2864 6973 7472 6962 7574 6564    # (distributed
+00038190: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+000381a0: 6563 656e 742d 746f 2d6f 6c64 2d74 696d  ecent-to-old-tim
+000381b0: 6529 2e0a 2020 2020 2020 2020 2320 5468  e)..        # Th
+000381c0: 6973 206c 6574 7320 7573 2069 676e 6f72  is lets us ignor
+000381d0: 6520 7465 6d70 6f72 6172 7920 7370 696b  e temporary spik
+000381e0: 6573 2063 6175 7365 6420 6279 2074 6173  es caused by tas
+000381f0: 6b20 6865 6170 2075 7361 6765 2e0a 2020  k heap usage..  
+00038200: 2020 2020 2020 6d65 6d6f 7279 5f62 795f        memory_by_
+00038210: 776f 726b 6572 203d 205b 0a20 2020 2020  worker = [.     
+00038220: 2020 2020 2020 2028 7773 2c20 6765 7461         (ws, geta
+00038230: 7474 7228 7773 2e6d 656d 6f72 792c 2073  ttr(ws.memory, s
+00038240: 656c 662e 4d45 4d4f 5259 5f52 4542 414c  elf.MEMORY_REBAL
+00038250: 414e 4345 5f4d 4541 5355 5245 2929 2066  ANCE_MEASURE)) f
+00038260: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
+00038270: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+00038280: 2020 206d 6561 6e5f 6d65 6d6f 7279 203d     mean_memory =
+00038290: 2073 756d 286d 2066 6f72 205f 2c20 6d20   sum(m for _, m 
+000382a0: 696e 206d 656d 6f72 795f 6279 5f77 6f72  in memory_by_wor
+000382b0: 6b65 7229 202f 2f20 6c65 6e28 6d65 6d6f  ker) // len(memo
+000382c0: 7279 5f62 795f 776f 726b 6572 290a 0a20  ry_by_worker).. 
+000382d0: 2020 2020 2020 2066 6f72 2077 732c 2077         for ws, w
+000382e0: 735f 6d65 6d6f 7279 2069 6e20 6d65 6d6f  s_memory in memo
+000382f0: 7279 5f62 795f 776f 726b 6572 3a0a 2020  ry_by_worker:.  
+00038300: 2020 2020 2020 2020 2020 6966 2077 732e            if ws.
+00038310: 6d65 6d6f 7279 5f6c 696d 6974 3a0a 2020  memory_limit:.  
+00038320: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+00038330: 6c66 5f67 6170 203d 2069 6e74 2873 656c  lf_gap = int(sel
+00038340: 662e 4d45 4d4f 5259 5f52 4542 414c 414e  f.MEMORY_REBALAN
+00038350: 4345 5f48 414c 465f 4741 5020 2a20 7773  CE_HALF_GAP * ws
+00038360: 2e6d 656d 6f72 795f 6c69 6d69 7429 0a20  .memory_limit). 
+00038370: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00038380: 656e 6465 725f 6d69 6e20 3d20 7365 6c66  ender_min = self
+00038390: 2e4d 454d 4f52 595f 5245 4241 4c41 4e43  .MEMORY_REBALANC
+000383a0: 455f 5345 4e44 4552 5f4d 494e 202a 2077  E_SENDER_MIN * w
+000383b0: 732e 6d65 6d6f 7279 5f6c 696d 6974 0a20  s.memory_limit. 
+000383c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000383d0: 6563 6970 6965 6e74 5f6d 6178 203d 2073  ecipient_max = s
+000383e0: 656c 662e 4d45 4d4f 5259 5f52 4542 414c  elf.MEMORY_REBAL
+000383f0: 414e 4345 5f52 4543 4950 4945 4e54 5f4d  ANCE_RECIPIENT_M
+00038400: 4158 202a 2077 732e 6d65 6d6f 7279 5f6c  AX * ws.memory_l
+00038410: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
+00038420: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00038430: 2020 2020 2020 2068 616c 665f 6761 7020         half_gap 
+00038440: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+00038450: 2020 2020 7365 6e64 6572 5f6d 696e 203d      sender_min =
+00038460: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
+00038470: 2020 2020 2072 6563 6970 6965 6e74 5f6d       recipient_m
+00038480: 6178 203d 206d 6174 682e 696e 660a 0a20  ax = math.inf.. 
+00038490: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+000384a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000384b0: 7773 2e5f 6861 735f 7768 6174 0a20 2020  ws._has_what.   
+000384c0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+000384d0: 2077 735f 6d65 6d6f 7279 203e 3d20 6d65   ws_memory >= me
+000384e0: 616e 5f6d 656d 6f72 7920 2b20 6861 6c66  an_memory + half
+000384f0: 5f67 6170 0a20 2020 2020 2020 2020 2020  _gap.           
+00038500: 2020 2020 2061 6e64 2077 735f 6d65 6d6f       and ws_memo
+00038510: 7279 203e 3d20 7365 6e64 6572 5f6d 696e  ry >= sender_min
+00038520: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
+00038530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038540: 2320 5468 6973 206d 6179 2073 656e 6420  # This may send 
+00038550: 7468 6520 776f 726b 6572 2062 656c 6f77  the worker below
+00038560: 2073 656e 6465 725f 6d69 6e20 2862 7920   sender_min (by 
+00038570: 6465 7369 676e 290a 2020 2020 2020 2020  design).        
+00038580: 2020 2020 2020 2020 736e 645f 6279 7465          snd_byte
+00038590: 735f 6d61 7820 3d20 6d65 616e 5f6d 656d  s_max = mean_mem
+000385a0: 6f72 7920 2d20 7773 5f6d 656d 6f72 7920  ory - ws_memory 
+000385b0: 2023 206e 6567 6174 6976 650a 2020 2020   # negative.    
+000385c0: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
+000385d0: 6279 7465 735f 6d69 6e20 3d20 736e 645f  bytes_min = snd_
+000385e0: 6279 7465 735f 6d61 7820 2b20 6861 6c66  bytes_max + half
+000385f0: 5f67 6170 2020 2320 6e65 6761 7469 7665  _gap  # negative
+00038600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038610: 2023 2053 6565 2064 6566 696e 6974 696f   # See definitio
+00038620: 6e20 6f66 2073 656e 6465 7273 2061 626f  n of senders abo
+00038630: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
+00038640: 2020 2073 656e 6465 7273 2e61 7070 656e     senders.appen
+00038650: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00038660: 2020 2020 2020 2028 736e 645f 6279 7465         (snd_byte
+00038670: 735f 6d61 782c 2073 6e64 5f62 7974 6573  s_max, snd_bytes
+00038680: 5f6d 696e 2c20 6964 2877 7329 2c20 7773  _min, id(ws), ws
+00038690: 2c20 6974 6572 2877 732e 5f68 6173 5f77  , iter(ws._has_w
+000386a0: 6861 7429 290a 2020 2020 2020 2020 2020  hat)).          
+000386b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000386c0: 2020 2020 656c 6966 2077 735f 6d65 6d6f      elif ws_memo
+000386d0: 7279 203c 206d 6561 6e5f 6d65 6d6f 7279  ry < mean_memory
+000386e0: 202d 2068 616c 665f 6761 7020 616e 6420   - half_gap and 
+000386f0: 7773 5f6d 656d 6f72 7920 3c20 7265 6369  ws_memory < reci
+00038700: 7069 656e 745f 6d61 783a 0a20 2020 2020  pient_max:.     
+00038710: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+00038720: 7320 6d61 7920 7365 6e64 2074 6865 2077  s may send the w
+00038730: 6f72 6b65 7220 6162 6f76 6520 7265 6369  orker above reci
+00038740: 7069 656e 745f 6d61 7820 2862 7920 6465  pient_max (by de
+00038750: 7369 676e 290a 2020 2020 2020 2020 2020  sign).          
+00038760: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
+00038770: 6d61 7820 3d20 7773 5f6d 656d 6f72 7920  max = ws_memory 
+00038780: 2d20 6d65 616e 5f6d 656d 6f72 7920 2023  - mean_memory  #
+00038790: 206e 6567 6174 6976 650a 2020 2020 2020   negative.      
+000387a0: 2020 2020 2020 2020 2020 7265 635f 6279            rec_by
+000387b0: 7465 735f 6d69 6e20 3d20 7265 635f 6279  tes_min = rec_by
+000387c0: 7465 735f 6d61 7820 2b20 6861 6c66 5f67  tes_max + half_g
+000387d0: 6170 2020 2320 6e65 6761 7469 7665 0a20  ap  # negative. 
+000387e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000387f0: 2053 6565 2064 6566 696e 6974 696f 6e20   See definition 
+00038800: 6f66 2072 6563 6970 6965 6e74 7320 6162  of recipients ab
+00038810: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
+00038820: 2020 2020 7265 6369 7069 656e 7473 2e61      recipients.a
+00038830: 7070 656e 6428 2872 6563 5f62 7974 6573  ppend((rec_bytes
+00038840: 5f6d 6178 2c20 7265 635f 6279 7465 735f  _max, rec_bytes_
+00038850: 6d69 6e2c 2069 6428 7773 292c 2077 7329  min, id(ws), ws)
+00038860: 290a 0a20 2020 2020 2020 2023 2046 6173  )..        # Fas
+00038870: 7420 6578 6974 2069 6e20 6361 7365 206e  t exit in case n
+00038880: 6f20 7472 616e 7366 6572 7320 6172 6520  o transfers are 
+00038890: 6e65 6365 7373 6172 7920 6f72 2070 6f73  necessary or pos
+000388a0: 7369 626c 650a 2020 2020 2020 2020 6966  sible.        if
+000388b0: 206e 6f74 2073 656e 6465 7273 206f 7220   not senders or 
+000388c0: 6e6f 7420 7265 6369 7069 656e 7473 3a0a  not recipients:.
+000388d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000388e0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+000388f0: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
+00038900: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00038910: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00038920: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
+00038930: 223a 2022 7265 6261 6c61 6e63 6522 2c0a  ": "rebalance",.
+00038940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038950: 2020 2020 2273 656e 6465 7273 223a 206c      "senders": l
+00038960: 656e 2873 656e 6465 7273 292c 0a20 2020  en(senders),.   
+00038970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038980: 2022 7265 6369 7069 656e 7473 223a 206c   "recipients": l
+00038990: 656e 2872 6563 6970 6965 6e74 7329 2c0a  en(recipients),.
 000389a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000389b0: 2023 204d 6f76 696e 6720 7468 6973 2074   # Moving this t
-000389c0: 6173 6b20 776f 756c 6420 6361 7573 6520  ask would cause 
-000389d0: 7468 6520 7365 6e64 6572 2074 6f20 676f  the sender to go
-000389e0: 2062 656c 6f77 206d 6561 6e20 616e 640a   below mean and.
-000389f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a00: 2020 2020 2320 706f 7465 6e74 6961 6c6c      # potentiall
-00038a10: 7920 7269 736b 2062 6563 6f6d 696e 6720  y risk becoming 
-00038a20: 6120 7265 6369 7069 656e 742c 2077 6869  a recipient, whi
-00038a30: 6368 2077 6f75 6c64 2063 6175 7365 2074  ch would cause t
-00038a40: 6173 6b73 2074 6f0a 2020 2020 2020 2020  asks to.        
-00038a50: 2020 2020 2020 2020 2020 2020 2320 626f              # bo
-00038a60: 756e 6365 2061 726f 756e 642e 204d 6f76  unce around. Mov
-00038a70: 6520 6f6e 2074 6f20 7468 6520 6e65 7874  e on to the next
-00038a80: 2074 6173 6b20 6f66 2074 6865 2073 616d   task of the sam
-00038a90: 6520 7365 6e64 6572 2e0a 2020 2020 2020  e sender..      
-00038aa0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00038ab0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00038ac0: 2020 2020 2020 2020 2320 4669 6e64 2074          # Find t
-00038ad0: 6865 2072 6563 6970 6965 6e74 2c20 6661  he recipient, fa
-00038ae0: 7274 6865 7374 2066 726f 6d20 7468 6520  rthest from the 
-00038af0: 6d65 616e 2c20 7768 6963 680a 2020 2020  mean, which.    
-00038b00: 2020 2020 2020 2020 2020 2020 2320 312e              # 1.
-00038b10: 2068 6173 2065 6e6f 7567 6820 6176 6169   has enough avai
-00038b20: 6c61 626c 6520 5241 4d20 666f 7220 7468  lable RAM for th
-00038b30: 6973 2074 6173 6b2c 2061 6e64 0a20 2020  is task, and.   
-00038b40: 2020 2020 2020 2020 2020 2020 2023 2032               # 2
-00038b50: 2e20 646f 6573 6e27 7420 686f 6c64 2061  . doesn't hold a
-00038b60: 2063 6f70 7920 6f66 2074 6869 7320 7461   copy of this ta
-00038b70: 736b 2061 6c72 6561 6479 0a20 2020 2020  sk already.     
-00038b80: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00038b90: 7265 206d 6179 206e 6f74 2062 6520 616e  re may not be an
-00038ba0: 7920 7468 6174 2073 6174 6973 6669 6573  y that satisfies
-00038bb0: 2074 6865 7365 2063 6f6e 6469 7469 6f6e   these condition
-00038bc0: 733b 2069 6e20 7468 6973 2063 6173 650a  s; in this case.
-00038bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038be0: 2320 7468 6973 2074 6173 6b20 776f 6e27  # this task won'
-00038bf0: 7420 6265 206d 6f76 6564 2e0a 2020 2020  t be moved..    
-00038c00: 2020 2020 2020 2020 2020 2020 736b 6970              skip
-00038c10: 7065 645f 7265 6369 7069 656e 7473 203d  ped_recipients =
-00038c20: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00038c30: 2020 2020 7573 655f 7265 6369 7069 656e      use_recipien
-00038c40: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
-00038c50: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00038c60: 7265 6369 7069 656e 7473 2061 6e64 206e  recipients and n
-00038c70: 6f74 2075 7365 5f72 6563 6970 6965 6e74  ot use_recipient
-00038c80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00038c90: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
-00038ca0: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
-00038cb0: 696e 2c20 5f2c 2072 6563 5f77 7320 3d20  in, _, rec_ws = 
-00038cc0: 7265 6369 7069 656e 7473 5b30 5d0a 2020  recipients[0].  
-00038cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ce0: 2020 6966 206e 6279 7465 7320 2b20 7265    if nbytes + re
-00038cf0: 635f 6279 7465 735f 6d61 7820 3e20 303a  c_bytes_max > 0:
-00038d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038d10: 2020 2020 2020 2020 2023 2072 6563 6970           # recip
-00038d20: 6965 6e74 7320 6172 6520 736f 7274 6564  ients are sorted
-00038d30: 2062 7920 7265 635f 6279 7465 735f 6d61   by rec_bytes_ma
-00038d40: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
-00038d50: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00038d60: 206e 6578 7420 6f6e 6573 2077 696c 6c20   next ones will 
-00038d70: 6265 2077 6f72 7365 3b20 6e6f 2072 6561  be worse; no rea
-00038d80: 736f 6e20 746f 2063 6f6e 7469 6e75 6520  son to continue 
-00038d90: 6974 6572 6174 696e 670a 2020 2020 2020  iterating.      
-00038da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038db0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00038dc0: 2020 2020 2020 2020 2020 2020 7573 655f              use_
-00038dd0: 7265 6369 7069 656e 7420 3d20 7473 206e  recipient = ts n
-00038de0: 6f74 2069 6e20 7265 635f 7773 2e5f 6861  ot in rec_ws._ha
-00038df0: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
-00038e00: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00038e10: 7420 7573 655f 7265 6369 7069 656e 743a  t use_recipient:
-00038e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038e30: 2020 2020 2020 2020 2073 6b69 7070 6564           skipped
-00038e40: 5f72 6563 6970 6965 6e74 732e 6170 7065  _recipients.appe
-00038e50: 6e64 2868 6561 7071 2e68 6561 7070 6f70  nd(heapq.heappop
-00038e60: 2872 6563 6970 6965 6e74 7329 290a 0a20  (recipients)).. 
-00038e70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00038e80: 6f72 2072 6563 6970 6965 6e74 2069 6e20  or recipient in 
-00038e90: 736b 6970 7065 645f 7265 6369 7069 656e  skipped_recipien
-00038ea0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00038eb0: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
-00038ec0: 6170 7075 7368 2872 6563 6970 6965 6e74  appush(recipient
-00038ed0: 732c 2072 6563 6970 6965 6e74 290a 0a20  s, recipient).. 
-00038ee0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00038ef0: 6620 6e6f 7420 7573 655f 7265 6369 7069  f not use_recipi
-00038f00: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
-00038f10: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
-00038f20: 7461 736b 2068 6173 206e 6f20 7265 6369  task has no reci
-00038f30: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
-00038f40: 2e20 4c65 6176 6520 6974 206f 6e20 7468  . Leave it on th
-00038f50: 6520 7365 6e64 6572 2061 6e64 0a20 2020  e sender and.   
-00038f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038f70: 2023 206d 6f76 6520 6f6e 2074 6f20 7468   # move on to th
-00038f80: 6520 6e65 7874 2074 6173 6b20 6f66 2074  e next task of t
-00038f90: 6865 2073 616d 6520 7365 6e64 6572 2e0a  he same sender..
-00038fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038fb0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-00038fc0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00038fd0: 5363 6865 6475 6c65 2074 6173 6b20 666f  Schedule task fo
-00038fe0: 7220 7472 616e 7366 6572 2066 726f 6d20  r transfer from 
-00038ff0: 7365 6e64 6572 2074 6f20 7265 6369 7069  sender to recipi
-00039000: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-00039010: 2020 2020 6d73 6773 2e61 7070 656e 6428      msgs.append(
-00039020: 2873 6e64 5f77 732c 2072 6563 5f77 732c  (snd_ws, rec_ws,
-00039030: 2074 7329 290a 0a20 2020 2020 2020 2020   ts))..         
-00039040: 2020 2020 2020 2023 202a 5f62 7974 6573         # *_bytes
-00039050: 5f6d 6178 2f6d 696e 2061 7265 2061 6c6c  _max/min are all
-00039060: 206e 6567 6174 6976 6520 666f 7220 6865   negative for he
-00039070: 6170 2073 6f72 7469 6e67 0a20 2020 2020  ap sorting.     
-00039080: 2020 2020 2020 2020 2020 2073 6e64 5f62             snd_b
-00039090: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
-000390a0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-000390b0: 2020 2073 6e64 5f62 7974 6573 5f6d 696e     snd_bytes_min
-000390c0: 202b 3d20 6e62 7974 6573 0a20 2020 2020   += nbytes.     
-000390d0: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
-000390e0: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
-000390f0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00039100: 2020 2072 6563 5f62 7974 6573 5f6d 696e     rec_bytes_min
-00039110: 202b 3d20 6e62 7974 6573 0a0a 2020 2020   += nbytes..    
-00039120: 2020 2020 2020 2020 2020 2020 2320 5374              # St
-00039130: 6f70 2069 7465 7261 7469 6e67 206f 6e20  op iterating on 
-00039140: 7468 6520 7461 736b 7320 6f66 2074 6869  the tasks of thi
-00039150: 7320 7365 6e64 6572 2066 6f72 206e 6f77  s sender for now
-00039160: 2061 6e64 2c20 6966 2069 7420 7374 696c   and, if it stil
-00039170: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-00039180: 2020 2320 6861 7320 6279 7465 7320 746f    # has bytes to
-00039190: 206c 6f73 652c 2070 7573 6820 6974 2062   lose, push it b
-000391a0: 6163 6b20 696e 746f 2074 6865 2073 656e  ack into the sen
-000391b0: 6465 7273 2068 6561 703b 2069 7420 6d61  ders heap; it ma
-000391c0: 7920 6f72 206d 6179 0a20 2020 2020 2020  y or may.       
-000391d0: 2020 2020 2020 2020 2023 206e 6f74 2063           # not c
-000391e0: 6f6d 6520 6261 636b 206f 6e20 746f 7020  ome back on top 
-000391f0: 6167 6169 6e2e 0a20 2020 2020 2020 2020  again..         
-00039200: 2020 2020 2020 2069 6620 736e 645f 6279         if snd_by
-00039210: 7465 735f 6d69 6e20 3c20 303a 0a20 2020  tes_min < 0:.   
-00039220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039230: 2023 2053 6565 2064 6566 696e 6974 696f   # See definitio
-00039240: 6e20 6f66 2073 656e 6465 7273 2061 626f  n of senders abo
-00039250: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
-00039260: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
-00039270: 7072 6570 6c61 6365 280a 2020 2020 2020  preplace(.      
-00039280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039290: 2020 7365 6e64 6572 732c 0a20 2020 2020    senders,.     
-000392a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000392b0: 2020 2028 736e 645f 6279 7465 735f 6d61     (snd_bytes_ma
-000392c0: 782c 2073 6e64 5f62 7974 6573 5f6d 696e  x, snd_bytes_min
-000392d0: 2c20 6964 2873 6e64 5f77 7329 2c20 736e  , id(snd_ws), sn
-000392e0: 645f 7773 2c20 7473 5f69 7465 7229 2c0a  d_ws, ts_iter),.
-000392f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039300: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00039310: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00039320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039330: 6865 6170 712e 6865 6170 706f 7028 7365  heapq.heappop(se
-00039340: 6e64 6572 7329 0a0a 2020 2020 2020 2020  nders)..        
-00039350: 2020 2020 2020 2020 2320 4966 2072 6563          # If rec
-00039360: 6970 6965 6e74 2073 7469 6c6c 2068 6173  ipient still has
-00039370: 2062 7974 6573 2074 6f20 6761 696e 2c20   bytes to gain, 
-00039380: 7075 7368 2069 7420 6261 636b 2069 6e74  push it back int
-00039390: 6f20 7468 6520 7265 6369 7069 656e 7473  o the recipients
-000393a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000393b0: 2023 2068 6561 703b 2069 7420 6d61 7920   # heap; it may 
-000393c0: 6f72 206d 6179 206e 6f74 2063 6f6d 6520  or may not come 
-000393d0: 6261 636b 206f 6e20 746f 7020 6167 6169  back on top agai
-000393e0: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-000393f0: 2020 2069 6620 7265 635f 6279 7465 735f     if rec_bytes_
-00039400: 6d69 6e20 3c20 303a 0a20 2020 2020 2020  min < 0:.       
-00039410: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-00039420: 6565 2064 6566 696e 6974 696f 6e20 6f66  ee definition of
-00039430: 2072 6563 6970 6965 6e74 7320 6162 6f76   recipients abov
-00039440: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00039450: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
-00039460: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
-00039470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039480: 2072 6563 6970 6965 6e74 732c 0a20 2020   recipients,.   
-00039490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394a0: 2020 2020 2028 7265 635f 6279 7465 735f       (rec_bytes_
-000394b0: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
-000394c0: 696e 2c20 6964 2872 6563 5f77 7329 2c20  in, id(rec_ws), 
-000394d0: 7265 635f 7773 292c 0a20 2020 2020 2020  rec_ws),.       
-000394e0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-000394f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00039500: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00039510: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
-00039520: 6561 7070 6f70 2872 6563 6970 6965 6e74  eappop(recipient
-00039530: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-00039540: 2020 2020 2320 4d6f 7665 2074 6f20 6e65      # Move to ne
-00039550: 7874 2073 656e 6465 7220 7769 7468 2074  xt sender with t
-00039560: 6865 206d 6f73 7420 6461 7461 2074 6f20  he most data to 
-00039570: 6c6f 7365 2e0a 2020 2020 2020 2020 2020  lose..          
-00039580: 2020 2020 2020 2320 4974 206d 6179 206f        # It may o
-00039590: 7220 6d61 7920 6e6f 7420 6265 2074 6865  r may not be the
-000395a0: 2073 616d 6520 7365 6e64 6572 2061 6761   same sender aga
-000395b0: 696e 2e0a 2020 2020 2020 2020 2020 2020  in..            
-000395c0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-000395d0: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
-000395e0: 666f 7220 7473 2069 6e20 7473 5f69 7465  for ts in ts_ite
-000395f0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00039600: 2020 2320 4578 6861 7573 7465 6420 7461    # Exhausted ta
-00039610: 736b 7320 6f6e 2074 6869 7320 7365 6e64  sks on this send
-00039620: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-00039630: 2020 2068 6561 7071 2e68 6561 7070 6f70     heapq.heappop
-00039640: 2873 656e 6465 7273 290a 0a20 2020 2020  (senders)..     
-00039650: 2020 2072 6574 7572 6e20 6d73 6773 0a0a     return msgs..
-00039660: 2020 2020 6173 796e 6320 6465 6620 5f72      async def _r
-00039670: 6562 616c 616e 6365 5f6d 6f76 655f 6461  ebalance_move_da
-00039680: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
-00039690: 2c20 6d73 6773 3a20 226c 6973 745b 7475  , msgs: "list[tu
-000396a0: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
-000396b0: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
-000396c0: 736b 5374 6174 655d 5d22 2c20 7374 696d  skState]]", stim
-000396d0: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
-000396e0: 2029 202d 3e20 6469 6374 3a0a 2020 2020   ) -> dict:.    
-000396f0: 2020 2020 2222 2250 6572 666f 726d 2074      """Perform t
-00039700: 6865 2061 6374 7561 6c20 7472 616e 7366  he actual transf
-00039710: 6572 206f 6620 6461 7461 2061 6372 6f73  er of data acros
-00039720: 7320 7468 6520 6e65 7477 6f72 6b20 696e  s the network in
-00039730: 2072 6562 616c 616e 6365 2829 2e0a 2020   rebalance()..  
-00039740: 2020 2020 2020 5461 6b65 7320 696e 2069        Takes in i
-00039750: 6e70 7574 2074 6865 206f 7574 7075 7420  nput the output 
-00039760: 6f66 205f 7265 6261 6c61 6e63 655f 6669  of _rebalance_fi
-00039770: 6e64 5f6d 7367 7328 292c 2074 6861 7420  nd_msgs(), that 
-00039780: 6973 2061 206c 6973 7420 6f66 2074 7570  is a list of tup
-00039790: 6c65 733a 0a0a 2020 2020 2020 2020 2d20  les:..        - 
-000397a0: 7365 6e64 6572 2077 6f72 6b65 720a 2020  sender worker.  
-000397b0: 2020 2020 2020 2d20 7265 6369 7069 656e        - recipien
-000397c0: 7420 776f 726b 6572 0a20 2020 2020 2020  t worker.       
-000397d0: 202d 2074 6173 6b20 746f 2062 6520 7472   - task to be tr
-000397e0: 616e 7366 6572 7265 640a 0a20 2020 2020  ansferred..     
-000397f0: 2020 2046 4958 4d45 2074 6869 7320 6d65     FIXME this me
-00039800: 7468 6f64 2069 7320 6e6f 7420 726f 6275  thod is not robu
-00039810: 7374 2077 6865 6e20 7468 6520 636c 7573  st when the clus
-00039820: 7465 7220 6973 206e 6f74 2069 646c 652e  ter is not idle.
-00039830: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00039840: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
-00039850: 7473 3a20 6465 6661 756c 7464 6963 745b  ts: defaultdict[
-00039860: 7374 722c 2064 6566 6175 6c74 6469 6374  str, defaultdict
-00039870: 5b73 7472 2c20 6c69 7374 5b73 7472 5d5d  [str, list[str]]
-00039880: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
-00039890: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-000398a0: 6264 613a 2064 6566 6175 6c74 6469 6374  bda: defaultdict
-000398b0: 286c 6973 7429 0a20 2020 2020 2020 2029  (list).        )
-000398c0: 0a20 2020 2020 2020 2066 6f72 2073 6e64  .        for snd
-000398d0: 5f77 732c 2072 6563 5f77 732c 2074 7320  _ws, rec_ws, ts 
-000398e0: 696e 206d 7367 733a 0a20 2020 2020 2020  in msgs:.       
-000398f0: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
-00039900: 7473 5b72 6563 5f77 732e 6164 6472 6573  ts[rec_ws.addres
-00039910: 735d 5b74 732e 6b65 795d 2e61 7070 656e  s][ts.key].appen
-00039920: 6428 736e 645f 7773 2e61 6464 7265 7373  d(snd_ws.address
-00039930: 290a 2020 2020 2020 2020 6661 696c 6564  ).        failed
-00039940: 5f6b 6579 735f 6279 5f72 6563 6970 6965  _keys_by_recipie
-00039950: 6e74 203d 2064 6963 7428 0a20 2020 2020  nt = dict(.     
-00039960: 2020 2020 2020 207a 6970 280a 2020 2020         zip(.    
-00039970: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
-00039980: 6563 6970 6965 6e74 732c 0a20 2020 2020  ecipients,.     
-00039990: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000399a0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-000399b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000399c0: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
-000399d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000399e0: 2320 4e6f 7465 3a20 7468 6973 206e 6576  # Note: this nev
-000399f0: 6572 2072 6169 7365 7320 6578 6365 7074  er raises except
-00039a00: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-00039a10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00039a20: 662e 6761 7468 6572 5f6f 6e5f 776f 726b  f.gather_on_work
-00039a30: 6572 2877 2c20 7768 6f5f 6861 7329 0a20  er(w, who_has). 
-00039a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a50: 2020 2020 2020 2066 6f72 2077 2c20 7768         for w, wh
-00039a60: 6f5f 6861 7320 696e 2074 6f5f 7265 6369  o_has in to_reci
-00039a70: 7069 656e 7473 2e69 7465 6d73 2829 0a20  pients.items(). 
-00039a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a90: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00039aa0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00039ab0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-00039ac0: 0a20 2020 2020 2020 2074 6f5f 7365 6e64  .        to_send
-00039ad0: 6572 7320 3d20 6465 6661 756c 7464 6963  ers = defaultdic
-00039ae0: 7428 6c69 7374 290a 2020 2020 2020 2020  t(list).        
-00039af0: 666f 7220 736e 645f 7773 2c20 7265 635f  for snd_ws, rec_
-00039b00: 7773 2c20 7473 2069 6e20 6d73 6773 3a0a  ws, ts in msgs:.
-00039b10: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00039b20: 732e 6b65 7920 6e6f 7420 696e 2066 6169  s.key not in fai
-00039b30: 6c65 645f 6b65 7973 5f62 795f 7265 6369  led_keys_by_reci
-00039b40: 7069 656e 745b 7265 635f 7773 2e61 6464  pient[rec_ws.add
-00039b50: 7265 7373 5d3a 0a20 2020 2020 2020 2020  ress]:.         
-00039b60: 2020 2020 2020 2074 6f5f 7365 6e64 6572         to_sender
-00039b70: 735b 736e 645f 7773 2e61 6464 7265 7373  s[snd_ws.address
-00039b80: 5d2e 6170 7065 6e64 2874 732e 6b65 7929  ].append(ts.key)
-00039b90: 0a0a 2020 2020 2020 2020 2320 4e6f 7465  ..        # Note
-00039ba0: 3a20 7468 6973 206e 6576 6572 2072 6169  : this never rai
-00039bb0: 7365 7320 6578 6365 7074 696f 6e73 0a20  ses exceptions. 
-00039bc0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00039bd0: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-00039be0: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
-00039bf0: 6465 6c65 7465 5f77 6f72 6b65 725f 6461  delete_worker_da
-00039c00: 7461 2872 2c20 762c 2073 7469 6d75 6c75  ta(r, v, stimulu
-00039c10: 735f 6964 2920 666f 7220 722c 2076 2069  s_id) for r, v i
-00039c20: 6e20 746f 5f73 656e 6465 7273 2e69 7465  n to_senders.ite
-00039c30: 6d73 2829 290a 2020 2020 2020 2020 290a  ms()).        ).
-00039c40: 0a20 2020 2020 2020 2066 6f72 2072 2c20  .        for r, 
-00039c50: 7620 696e 2074 6f5f 7265 6369 7069 656e  v in to_recipien
-00039c60: 7473 2e69 7465 6d73 2829 3a0a 2020 2020  ts.items():.    
-00039c70: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00039c80: 5f65 7665 6e74 2872 2c20 7b22 6163 7469  _event(r, {"acti
-00039c90: 6f6e 223a 2022 7265 6261 6c61 6e63 6522  on": "rebalance"
-00039ca0: 2c20 2277 686f 5f68 6173 223a 2076 7d29  , "who_has": v})
-00039cb0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00039cc0: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
-00039cd0: 2020 2020 2022 616c 6c22 2c0a 2020 2020       "all",.    
-00039ce0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00039cf0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-00039d00: 6e22 3a20 2272 6562 616c 616e 6365 222c  n": "rebalance",
-00039d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039d20: 2022 7365 6e64 6572 7322 3a20 7661 6c6d   "senders": valm
-00039d30: 6170 286c 656e 2c20 746f 5f73 656e 6465  ap(len, to_sende
-00039d40: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
-00039d50: 2020 2020 2022 7265 6369 7069 656e 7473       "recipients
-00039d60: 223a 2076 616c 6d61 7028 6c65 6e2c 2074  ": valmap(len, t
-00039d70: 6f5f 7265 6369 7069 656e 7473 292c 0a20  o_recipients),. 
-00039d80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00039d90: 6d6f 7665 645f 6b65 7973 223a 206c 656e  moved_keys": len
-00039da0: 286d 7367 7329 2c0a 2020 2020 2020 2020  (msgs),.        
-00039db0: 2020 2020 7d2c 0a20 2020 2020 2020 2029      },.        )
-00039dc0: 0a0a 2020 2020 2020 2020 6d69 7373 696e  ..        missin
-00039dd0: 675f 6b65 7973 203d 207b 6b20 666f 7220  g_keys = {k for 
-00039de0: 7220 696e 2066 6169 6c65 645f 6b65 7973  r in failed_keys
-00039df0: 5f62 795f 7265 6369 7069 656e 742e 7661  _by_recipient.va
-00039e00: 6c75 6573 2829 2066 6f72 206b 2069 6e20  lues() for k in 
-00039e10: 727d 0a20 2020 2020 2020 2069 6620 6d69  r}.        if mi
-00039e20: 7373 696e 675f 6b65 7973 3a0a 2020 2020  ssing_keys:.    
-00039e30: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00039e40: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
-00039e50: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
-00039e60: 3a20 6c69 7374 286d 6973 7369 6e67 5f6b  : list(missing_k
-00039e70: 6579 7329 7d0a 2020 2020 2020 2020 656c  eys)}.        el
-00039e80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00039e90: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
-00039ea0: 3a20 224f 4b22 7d0a 0a20 2020 2061 7379  : "OK"}..    asy
-00039eb0: 6e63 2064 6566 2072 6570 6c69 6361 7465  nc def replicate
-00039ec0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00039ed0: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
-00039ee0: 652c 0a20 2020 2020 2020 206b 6579 733d  e,.        keys=
-00039ef0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e3d  None,.        n=
-00039f00: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
-00039f10: 726b 6572 733d 4e6f 6e65 2c0a 2020 2020  rkers=None,.    
-00039f20: 2020 2020 6272 616e 6368 696e 675f 6661      branching_fa
-00039f30: 6374 6f72 3d32 2c0a 2020 2020 2020 2020  ctor=2,.        
-00039f40: 6465 6c65 7465 3d54 7275 652c 0a20 2020  delete=True,.   
-00039f50: 2020 2020 206c 6f63 6b3d 5472 7565 2c0a       lock=True,.
-00039f60: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00039f70: 5f69 643d 4e6f 6e65 2c0a 2020 2020 293a  _id=None,.    ):
-00039f80: 0a20 2020 2020 2020 2022 2222 5265 706c  .        """Repl
-00039f90: 6963 6174 6520 6461 7461 2074 6872 6f75  icate data throu
-00039fa0: 6768 6f75 7420 636c 7573 7465 720a 0a20  ghout cluster.. 
-00039fb0: 2020 2020 2020 2054 6869 7320 7065 7266         This perf
-00039fc0: 6f72 6d73 2061 2074 7265 6520 636f 7079  orms a tree copy
-00039fd0: 206f 6620 7468 6520 6461 7461 2074 6872   of the data thr
-00039fe0: 6f75 6768 6f75 7420 7468 6520 6e65 7477  oughout the netw
-00039ff0: 6f72 6b0a 2020 2020 2020 2020 696e 6469  ork.        indi
-0003a000: 7669 6475 616c 6c79 206f 6e20 6561 6368  vidually on each
-0003a010: 2070 6965 6365 206f 6620 6461 7461 2e0a   piece of data..
-0003a020: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-0003a030: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-0003a040: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
-0003a050: 6579 733a 2049 7465 7261 626c 650a 2020  eys: Iterable.  
-0003a060: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
-0003a070: 6620 6b65 7973 2074 6f20 7265 706c 6963  f keys to replic
-0003a080: 6174 650a 2020 2020 2020 2020 6e3a 2069  ate.        n: i
-0003a090: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
-0003a0a0: 756d 6265 7220 6f66 2072 6570 6c69 6361  umber of replica
-0003a0b0: 7469 6f6e 7320 7765 2065 7870 6563 7420  tions we expect 
-0003a0c0: 746f 2073 6565 2077 6974 6869 6e20 7468  to see within th
-0003a0d0: 6520 636c 7573 7465 720a 2020 2020 2020  e cluster.      
-0003a0e0: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
-0003a0f0: 6f72 3a20 696e 742c 206f 7074 696f 6e61  or: int, optiona
-0003a100: 6c0a 2020 2020 2020 2020 2020 2020 5468  l.            Th
-0003a110: 6520 6e75 6d62 6572 206f 6620 776f 726b  e number of work
-0003a120: 6572 7320 7468 6174 2063 616e 2063 6f70  ers that can cop
-0003a130: 7920 6461 7461 2069 6e20 6561 6368 2067  y data in each g
-0003a140: 656e 6572 6174 696f 6e2e 0a20 2020 2020  eneration..     
-0003a150: 2020 2020 2020 2054 6865 206c 6172 6765         The large
-0003a160: 7220 7468 6520 6272 616e 6368 696e 6720  r the branching 
-0003a170: 6661 6374 6f72 2c20 7468 6520 6d6f 7265  factor, the more
-0003a180: 2064 6174 6120 7765 2063 6f70 7920 696e   data we copy in
-0003a190: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
-0003a1a0: 696e 676c 6520 7374 6570 2c20 6275 7420  ingle step, but 
-0003a1b0: 7468 6520 6d6f 7265 2061 2067 6976 656e  the more a given
-0003a1c0: 2077 6f72 6b65 7220 7269 736b 7320 6265   worker risks be
-0003a1d0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0003a1e0: 7377 616d 7065 6420 6279 2064 6174 6120  swamped by data 
-0003a1f0: 7265 7175 6573 7473 2e0a 0a20 2020 2020  requests...     
-0003a200: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-0003a210: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-0003a220: 2020 2020 2053 6368 6564 756c 6572 2e72       Scheduler.r
-0003a230: 6562 616c 616e 6365 0a20 2020 2020 2020  ebalance.       
-0003a240: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
-0003a250: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
-0003a260: 6c75 735f 6964 206f 7220 6622 7265 706c  lus_id or f"repl
-0003a270: 6963 6174 652d 7b74 696d 6528 297d 220a  icate-{time()}".
-0003a280: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
-0003a290: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
-0003a2a0: 3e20 300a 2020 2020 2020 2020 6173 796e  > 0.        asyn
-0003a2b0: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
-0003a2c0: 6b20 6966 206c 6f63 6b20 656c 7365 2065  k if lock else e
-0003a2d0: 6d70 7479 5f63 6f6e 7465 7874 3a0a 2020  mpty_context:.  
-0003a2e0: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
-0003a2f0: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
-0003a300: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a310: 2020 776f 726b 6572 7320 3d20 7b73 656c    workers = {sel
-0003a320: 662e 776f 726b 6572 735b 775d 2066 6f72  f.workers[w] for
-0003a330: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
-0003a340: 7273 5f6c 6973 7428 776f 726b 6572 7329  rs_list(workers)
-0003a350: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003a360: 2020 776f 726b 6572 7320 3d20 7b77 7320    workers = {ws 
-0003a370: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
-0003a380: 7320 6966 2077 732e 7374 6174 7573 203d  s if ws.status =
-0003a390: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-0003a3a0: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
-0003a3b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003a3c0: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
-0003a3d0: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
-0003a3e0: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
-0003a3f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003a400: 2020 2020 2020 6e20 3d20 6c65 6e28 776f        n = len(wo
-0003a410: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
-0003a420: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003a430: 2020 2020 2020 2020 206e 203d 206d 696e           n = min
-0003a440: 286e 2c20 6c65 6e28 776f 726b 6572 7329  (n, len(workers)
-0003a450: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0003a460: 206e 203d 3d20 303a 0a20 2020 2020 2020   n == 0:.       
-0003a470: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0003a480: 616c 7565 4572 726f 7228 2243 616e 206e  alueError("Can n
-0003a490: 6f74 2075 7365 2072 6570 6c69 6361 7465  ot use replicate
-0003a4a0: 2074 6f20 6465 6c65 7465 2064 6174 6122   to delete data"
-0003a4b0: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
-0003a4c0: 6173 6b73 203d 207b 7365 6c66 2e74 6173  asks = {self.tas
-0003a4d0: 6b73 5b6b 5d20 666f 7220 6b20 696e 206b  ks[k] for k in k
-0003a4e0: 6579 737d 0a20 2020 2020 2020 2020 2020  eys}.           
-0003a4f0: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
-0003a500: 5b74 732e 6b65 7920 666f 7220 7473 2069  [ts.key for ts i
-0003a510: 6e20 7461 736b 7320 6966 206e 6f74 2074  n tasks if not t
-0003a520: 732e 7768 6f5f 6861 735d 0a20 2020 2020  s.who_has].     
-0003a530: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
-0003a540: 675f 6461 7461 3a0a 2020 2020 2020 2020  g_data:.        
-0003a550: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0003a560: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
-0003a570: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
-0003a580: 3a20 6d69 7373 696e 675f 6461 7461 7d0a  : missing_data}.
-0003a590: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-0003a5a0: 656c 6574 6520 6578 7472 616e 656f 7573  elete extraneous
-0003a5b0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-0003a5c0: 2020 6966 2064 656c 6574 653a 0a20 2020    if delete:.   
-0003a5d0: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0003a5e0: 5f77 6f72 6b65 725f 7461 736b 7320 3d20  _worker_tasks = 
-0003a5f0: 6465 6661 756c 7464 6963 7428 7365 7429  defaultdict(set)
-0003a600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a610: 2066 6f72 2074 7320 696e 2074 6173 6b73   for ts in tasks
-0003a620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a630: 2020 2020 2020 6465 6c5f 6361 6e64 6964        del_candid
-0003a640: 6174 6573 203d 2074 7570 6c65 2874 732e  ates = tuple(ts.
-0003a650: 7768 6f5f 6861 7320 2620 776f 726b 6572  who_has & worker
-0003a660: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003a670: 2020 2020 2020 2069 6620 6c65 6e28 6465         if len(de
-0003a680: 6c5f 6361 6e64 6964 6174 6573 2920 3e20  l_candidates) > 
-0003a690: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-0003a6a0: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0003a6b0: 7320 696e 2072 616e 646f 6d2e 7361 6d70  s in random.samp
-0003a6c0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0003a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a6e0: 6465 6c5f 6361 6e64 6964 6174 6573 2c20  del_candidates, 
-0003a6f0: 6c65 6e28 6465 6c5f 6361 6e64 6964 6174  len(del_candidat
-0003a700: 6573 2920 2d20 6e0a 2020 2020 2020 2020  es) - n.        
-0003a710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a720: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003a730: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0003a740: 656c 5f77 6f72 6b65 725f 7461 736b 735b  el_worker_tasks[
-0003a750: 7773 5d2e 6164 6428 7473 290a 0a20 2020  ws].add(ts)..   
-0003a760: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-0003a770: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
-0003a780: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
-0003a790: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003a7a0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-0003a7b0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-0003a7c0: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
-0003a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a7e0: 2020 2020 2020 2073 656c 662e 6465 6c65         self.dele
-0003a7f0: 7465 5f77 6f72 6b65 725f 6461 7461 280a  te_worker_data(.
-0003a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a810: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
-0003a820: 6464 7265 7373 2c20 5b74 2e6b 6579 2066  ddress, [t.key f
-0003a830: 6f72 2074 2069 6e20 7461 736b 735d 2c20  or t in tasks], 
-0003a840: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
+000389b0: 2020 2020 226d 6f76 6564 5f6b 6579 7322      "moved_keys"
+000389c0: 3a20 302c 0a20 2020 2020 2020 2020 2020  : 0,.           
+000389d0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000389e0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000389f0: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
+00038a00: 2020 2020 2068 6561 7071 2e68 6561 7069       heapq.heapi
+00038a10: 6679 2873 656e 6465 7273 290a 2020 2020  fy(senders).    
+00038a20: 2020 2020 6865 6170 712e 6865 6170 6966      heapq.heapif
+00038a30: 7928 7265 6369 7069 656e 7473 290a 0a20  y(recipients).. 
+00038a40: 2020 2020 2020 2077 6869 6c65 2073 656e         while sen
+00038a50: 6465 7273 2061 6e64 2072 6563 6970 6965  ders and recipie
+00038a60: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00038a70: 2073 6e64 5f62 7974 6573 5f6d 6178 2c20   snd_bytes_max, 
+00038a80: 736e 645f 6279 7465 735f 6d69 6e2c 205f  snd_bytes_min, _
+00038a90: 2c20 736e 645f 7773 2c20 7473 5f69 7465  , snd_ws, ts_ite
+00038aa0: 7220 3d20 7365 6e64 6572 735b 305d 0a0a  r = senders[0]..
+00038ab0: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+00038ac0: 6572 6174 6520 7468 726f 7567 6820 7461  erate through ta
+00038ad0: 736b 7320 696e 206d 656d 6f72 792c 206c  sks in memory, l
+00038ae0: 6561 7374 2072 6563 656e 746c 7920 696e  east recently in
+00038af0: 7365 7274 6564 2066 6972 7374 0a20 2020  serted first.   
+00038b00: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
+00038b10: 696e 2074 735f 6974 6572 3a0a 2020 2020  in ts_iter:.    
+00038b20: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00038b30: 6579 7320 6973 206e 6f74 204e 6f6e 6520  eys is not None 
+00038b40: 616e 6420 7473 2e6b 6579 206e 6f74 2069  and ts.key not i
+00038b50: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00038b60: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00038b70: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00038b80: 2020 2020 206e 6279 7465 7320 3d20 7473       nbytes = ts
+00038b90: 2e6e 6279 7465 730a 2020 2020 2020 2020  .nbytes.        
+00038ba0: 2020 2020 2020 2020 6966 206e 6279 7465          if nbyte
+00038bb0: 7320 2b20 736e 645f 6279 7465 735f 6d61  s + snd_bytes_ma
+00038bc0: 7820 3e20 303a 0a20 2020 2020 2020 2020  x > 0:.         
+00038bd0: 2020 2020 2020 2020 2020 2023 204d 6f76             # Mov
+00038be0: 696e 6720 7468 6973 2074 6173 6b20 776f  ing this task wo
+00038bf0: 756c 6420 6361 7573 6520 7468 6520 7365  uld cause the se
+00038c00: 6e64 6572 2074 6f20 676f 2062 656c 6f77  nder to go below
+00038c10: 206d 6561 6e20 616e 640a 2020 2020 2020   mean and.      
+00038c20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00038c30: 706f 7465 6e74 6961 6c6c 7920 7269 736b  potentially risk
+00038c40: 2062 6563 6f6d 696e 6720 6120 7265 6369   becoming a reci
+00038c50: 7069 656e 742c 2077 6869 6368 2077 6f75  pient, which wou
+00038c60: 6c64 2063 6175 7365 2074 6173 6b73 2074  ld cause tasks t
+00038c70: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
+00038c80: 2020 2020 2020 2320 626f 756e 6365 2061        # bounce a
+00038c90: 726f 756e 642e 204d 6f76 6520 6f6e 2074  round. Move on t
+00038ca0: 6f20 7468 6520 6e65 7874 2074 6173 6b20  o the next task 
+00038cb0: 6f66 2074 6865 2073 616d 6520 7365 6e64  of the same send
+00038cc0: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
+00038cd0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00038ce0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00038cf0: 2020 2320 4669 6e64 2074 6865 2072 6563    # Find the rec
+00038d00: 6970 6965 6e74 2c20 6661 7274 6865 7374  ipient, farthest
+00038d10: 2066 726f 6d20 7468 6520 6d65 616e 2c20   from the mean, 
+00038d20: 7768 6963 680a 2020 2020 2020 2020 2020  which.          
+00038d30: 2020 2020 2020 2320 312e 2068 6173 2065        # 1. has e
+00038d40: 6e6f 7567 6820 6176 6169 6c61 626c 6520  nough available 
+00038d50: 5241 4d20 666f 7220 7468 6973 2074 6173  RAM for this tas
+00038d60: 6b2c 2061 6e64 0a20 2020 2020 2020 2020  k, and.         
+00038d70: 2020 2020 2020 2023 2032 2e20 646f 6573         # 2. does
+00038d80: 6e27 7420 686f 6c64 2061 2063 6f70 7920  n't hold a copy 
+00038d90: 6f66 2074 6869 7320 7461 736b 2061 6c72  of this task alr
+00038da0: 6561 6479 0a20 2020 2020 2020 2020 2020  eady.           
+00038db0: 2020 2020 2023 2054 6865 7265 206d 6179       # There may
+00038dc0: 206e 6f74 2062 6520 616e 7920 7468 6174   not be any that
+00038dd0: 2073 6174 6973 6669 6573 2074 6865 7365   satisfies these
+00038de0: 2063 6f6e 6469 7469 6f6e 733b 2069 6e20   conditions; in 
+00038df0: 7468 6973 2063 6173 650a 2020 2020 2020  this case.      
+00038e00: 2020 2020 2020 2020 2020 2320 7468 6973            # this
+00038e10: 2074 6173 6b20 776f 6e27 7420 6265 206d   task won't be m
+00038e20: 6f76 6564 2e0a 2020 2020 2020 2020 2020  oved..          
+00038e30: 2020 2020 2020 736b 6970 7065 645f 7265        skipped_re
+00038e40: 6369 7069 656e 7473 203d 205b 5d0a 2020  cipients = [].  
+00038e50: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00038e60: 655f 7265 6369 7069 656e 7420 3d20 4661  e_recipient = Fa
+00038e70: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00038e80: 2020 2020 7768 696c 6520 7265 6369 7069      while recipi
+00038e90: 656e 7473 2061 6e64 206e 6f74 2075 7365  ents and not use
+00038ea0: 5f72 6563 6970 6965 6e74 3a0a 2020 2020  _recipient:.    
+00038eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ec0: 7265 635f 6279 7465 735f 6d61 782c 2072  rec_bytes_max, r
+00038ed0: 6563 5f62 7974 6573 5f6d 696e 2c20 5f2c  ec_bytes_min, _,
+00038ee0: 2072 6563 5f77 7320 3d20 7265 6369 7069   rec_ws = recipi
+00038ef0: 656e 7473 5b30 5d0a 2020 2020 2020 2020  ents[0].        
+00038f00: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00038f10: 6279 7465 7320 2b20 7265 635f 6279 7465  bytes + rec_byte
+00038f20: 735f 6d61 7820 3e20 303a 0a20 2020 2020  s_max > 0:.     
+00038f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038f40: 2020 2023 2072 6563 6970 6965 6e74 7320     # recipients 
+00038f50: 6172 6520 736f 7274 6564 2062 7920 7265  are sorted by re
+00038f60: 635f 6279 7465 735f 6d61 782e 0a20 2020  c_bytes_max..   
+00038f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038f80: 2020 2020 2023 2054 6865 206e 6578 7420       # The next 
+00038f90: 6f6e 6573 2077 696c 6c20 6265 2077 6f72  ones will be wor
+00038fa0: 7365 3b20 6e6f 2072 6561 736f 6e20 746f  se; no reason to
+00038fb0: 2063 6f6e 7469 6e75 6520 6974 6572 6174   continue iterat
+00038fc0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00038fd0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00038fe0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+00038ff0: 2020 2020 2020 7573 655f 7265 6369 7069        use_recipi
+00039000: 656e 7420 3d20 7473 206e 6f74 2069 6e20  ent = ts not in 
+00039010: 7265 635f 7773 2e5f 6861 735f 7768 6174  rec_ws._has_what
+00039020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039030: 2020 2020 2069 6620 6e6f 7420 7573 655f       if not use_
+00039040: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
+00039050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039060: 2020 2073 6b69 7070 6564 5f72 6563 6970     skipped_recip
+00039070: 6965 6e74 732e 6170 7065 6e64 2868 6561  ients.append(hea
+00039080: 7071 2e68 6561 7070 6f70 2872 6563 6970  pq.heappop(recip
+00039090: 6965 6e74 7329 290a 0a20 2020 2020 2020  ients))..       
+000390a0: 2020 2020 2020 2020 2066 6f72 2072 6563           for rec
+000390b0: 6970 6965 6e74 2069 6e20 736b 6970 7065  ipient in skippe
+000390c0: 645f 7265 6369 7069 656e 7473 3a0a 2020  d_recipients:.  
+000390d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000390e0: 2020 6865 6170 712e 6865 6170 7075 7368    heapq.heappush
+000390f0: 2872 6563 6970 6965 6e74 732c 2072 6563  (recipients, rec
+00039100: 6970 6965 6e74 290a 0a20 2020 2020 2020  ipient)..       
+00039110: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00039120: 7573 655f 7265 6369 7069 656e 743a 0a20  use_recipient:. 
+00039130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039140: 2020 2023 2054 6869 7320 7461 736b 2068     # This task h
+00039150: 6173 206e 6f20 7265 6369 7069 656e 7473  as no recipients
+00039160: 2061 7661 696c 6162 6c65 2e20 4c65 6176   available. Leav
+00039170: 6520 6974 206f 6e20 7468 6520 7365 6e64  e it on the send
+00039180: 6572 2061 6e64 0a20 2020 2020 2020 2020  er and.         
+00039190: 2020 2020 2020 2020 2020 2023 206d 6f76             # mov
+000391a0: 6520 6f6e 2074 6f20 7468 6520 6e65 7874  e on to the next
+000391b0: 2074 6173 6b20 6f66 2074 6865 2073 616d   task of the sam
+000391c0: 6520 7365 6e64 6572 2e0a 2020 2020 2020  e sender..      
+000391d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000391e0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+000391f0: 2020 2020 2020 2020 2320 5363 6865 6475          # Schedu
+00039200: 6c65 2074 6173 6b20 666f 7220 7472 616e  le task for tran
+00039210: 7366 6572 2066 726f 6d20 7365 6e64 6572  sfer from sender
+00039220: 2074 6f20 7265 6369 7069 656e 740a 2020   to recipient.  
+00039230: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00039240: 6773 2e61 7070 656e 6428 2873 6e64 5f77  gs.append((snd_w
+00039250: 732c 2072 6563 5f77 732c 2074 7329 290a  s, rec_ws, ts)).
+00039260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039270: 2023 202a 5f62 7974 6573 5f6d 6178 2f6d   # *_bytes_max/m
+00039280: 696e 2061 7265 2061 6c6c 206e 6567 6174  in are all negat
+00039290: 6976 6520 666f 7220 6865 6170 2073 6f72  ive for heap sor
+000392a0: 7469 6e67 0a20 2020 2020 2020 2020 2020  ting.           
+000392b0: 2020 2020 2073 6e64 5f62 7974 6573 5f6d       snd_bytes_m
+000392c0: 6178 202b 3d20 6e62 7974 6573 0a20 2020  ax += nbytes.   
+000392d0: 2020 2020 2020 2020 2020 2020 2073 6e64               snd
+000392e0: 5f62 7974 6573 5f6d 696e 202b 3d20 6e62  _bytes_min += nb
+000392f0: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
+00039300: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
+00039310: 6178 202b 3d20 6e62 7974 6573 0a20 2020  ax += nbytes.   
+00039320: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+00039330: 5f62 7974 6573 5f6d 696e 202b 3d20 6e62  _bytes_min += nb
+00039340: 7974 6573 0a0a 2020 2020 2020 2020 2020  ytes..          
+00039350: 2020 2020 2020 2320 5374 6f70 2069 7465        # Stop ite
+00039360: 7261 7469 6e67 206f 6e20 7468 6520 7461  rating on the ta
+00039370: 736b 7320 6f66 2074 6869 7320 7365 6e64  sks of this send
+00039380: 6572 2066 6f72 206e 6f77 2061 6e64 2c20  er for now and, 
+00039390: 6966 2069 7420 7374 696c 6c0a 2020 2020  if it still.    
+000393a0: 2020 2020 2020 2020 2020 2020 2320 6861              # ha
+000393b0: 7320 6279 7465 7320 746f 206c 6f73 652c  s bytes to lose,
+000393c0: 2070 7573 6820 6974 2062 6163 6b20 696e   push it back in
+000393d0: 746f 2074 6865 2073 656e 6465 7273 2068  to the senders h
+000393e0: 6561 703b 2069 7420 6d61 7920 6f72 206d  eap; it may or m
+000393f0: 6179 0a20 2020 2020 2020 2020 2020 2020  ay.             
+00039400: 2020 2023 206e 6f74 2063 6f6d 6520 6261     # not come ba
+00039410: 636b 206f 6e20 746f 7020 6167 6169 6e2e  ck on top again.
+00039420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039430: 2069 6620 736e 645f 6279 7465 735f 6d69   if snd_bytes_mi
+00039440: 6e20 3c20 303a 0a20 2020 2020 2020 2020  n < 0:.         
+00039450: 2020 2020 2020 2020 2020 2023 2053 6565             # See
+00039460: 2064 6566 696e 6974 696f 6e20 6f66 2073   definition of s
+00039470: 656e 6465 7273 2061 626f 7665 0a20 2020  enders above.   
+00039480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039490: 2068 6561 7071 2e68 6561 7072 6570 6c61   heapq.heaprepla
+000394a0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+000394b0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
+000394c0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+000394d0: 2020 2020 2020 2020 2020 2020 2028 736e               (sn
+000394e0: 645f 6279 7465 735f 6d61 782c 2073 6e64  d_bytes_max, snd
+000394f0: 5f62 7974 6573 5f6d 696e 2c20 6964 2873  _bytes_min, id(s
+00039500: 6e64 5f77 7329 2c20 736e 645f 7773 2c20  nd_ws), snd_ws, 
+00039510: 7473 5f69 7465 7229 2c0a 2020 2020 2020  ts_iter),.      
+00039520: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00039530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039540: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00039550: 2020 2020 2020 2020 2020 6865 6170 712e            heapq.
+00039560: 6865 6170 706f 7028 7365 6e64 6572 7329  heappop(senders)
+00039570: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039580: 2020 2320 4966 2072 6563 6970 6965 6e74    # If recipient
+00039590: 2073 7469 6c6c 2068 6173 2062 7974 6573   still has bytes
+000395a0: 2074 6f20 6761 696e 2c20 7075 7368 2069   to gain, push i
+000395b0: 7420 6261 636b 2069 6e74 6f20 7468 6520  t back into the 
+000395c0: 7265 6369 7069 656e 7473 0a20 2020 2020  recipients.     
+000395d0: 2020 2020 2020 2020 2020 2023 2068 6561             # hea
+000395e0: 703b 2069 7420 6d61 7920 6f72 206d 6179  p; it may or may
+000395f0: 206e 6f74 2063 6f6d 6520 6261 636b 206f   not come back o
+00039600: 6e20 746f 7020 6167 6169 6e2e 0a20 2020  n top again..   
+00039610: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00039620: 7265 635f 6279 7465 735f 6d69 6e20 3c20  rec_bytes_min < 
+00039630: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00039640: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
+00039650: 696e 6974 696f 6e20 6f66 2072 6563 6970  inition of recip
+00039660: 6965 6e74 7320 6162 6f76 650a 2020 2020  ients above.    
+00039670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039680: 6865 6170 712e 6865 6170 7265 706c 6163  heapq.heapreplac
+00039690: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000396a0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+000396b0: 6965 6e74 732c 0a20 2020 2020 2020 2020  ients,.         
+000396c0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000396d0: 7265 635f 6279 7465 735f 6d61 782c 2072  rec_bytes_max, r
+000396e0: 6563 5f62 7974 6573 5f6d 696e 2c20 6964  ec_bytes_min, id
+000396f0: 2872 6563 5f77 7329 2c20 7265 635f 7773  (rec_ws), rec_ws
+00039700: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00039710: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00039720: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00039730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039740: 2020 2068 6561 7071 2e68 6561 7070 6f70     heapq.heappop
+00039750: 2872 6563 6970 6965 6e74 7329 0a0a 2020  (recipients)..  
+00039760: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00039770: 4d6f 7665 2074 6f20 6e65 7874 2073 656e  Move to next sen
+00039780: 6465 7220 7769 7468 2074 6865 206d 6f73  der with the mos
+00039790: 7420 6461 7461 2074 6f20 6c6f 7365 2e0a  t data to lose..
+000397a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000397b0: 2320 4974 206d 6179 206f 7220 6d61 7920  # It may or may 
+000397c0: 6e6f 7420 6265 2074 6865 2073 616d 6520  not be the same 
+000397d0: 7365 6e64 6572 2061 6761 696e 2e0a 2020  sender again..  
+000397e0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+000397f0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+00039800: 2065 6c73 653a 2020 2320 666f 7220 7473   else:  # for ts
+00039810: 2069 6e20 7473 5f69 7465 720a 2020 2020   in ts_iter.    
+00039820: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
+00039830: 6861 7573 7465 6420 7461 736b 7320 6f6e  hausted tasks on
+00039840: 2074 6869 7320 7365 6e64 6572 0a20 2020   this sender.   
+00039850: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+00039860: 7071 2e68 6561 7070 6f70 2873 656e 6465  pq.heappop(sende
+00039870: 7273 290a 0a20 2020 2020 2020 2072 6574  rs)..        ret
+00039880: 7572 6e20 6d73 6773 0a0a 2020 2020 6173  urn msgs..    as
+00039890: 796e 6320 6465 6620 5f72 6562 616c 616e  ync def _rebalan
+000398a0: 6365 5f6d 6f76 655f 6461 7461 280a 2020  ce_move_data(.  
+000398b0: 2020 2020 2020 7365 6c66 2c20 6d73 6773        self, msgs
+000398c0: 3a20 226c 6973 745b 7475 706c 655b 576f  : "list[tuple[Wo
+000398d0: 726b 6572 5374 6174 652c 2057 6f72 6b65  rkerState, Worke
+000398e0: 7253 7461 7465 2c20 5461 736b 5374 6174  rState, TaskStat
+000398f0: 655d 5d22 2c20 7374 696d 756c 7573 5f69  e]]", stimulus_i
+00039900: 643a 2073 7472 0a20 2020 2029 202d 3e20  d: str.    ) -> 
+00039910: 6469 6374 3a0a 2020 2020 2020 2020 2222  dict:.        ""
+00039920: 2250 6572 666f 726d 2074 6865 2061 6374  "Perform the act
+00039930: 7561 6c20 7472 616e 7366 6572 206f 6620  ual transfer of 
+00039940: 6461 7461 2061 6372 6f73 7320 7468 6520  data across the 
+00039950: 6e65 7477 6f72 6b20 696e 2072 6562 616c  network in rebal
+00039960: 616e 6365 2829 2e0a 2020 2020 2020 2020  ance()..        
+00039970: 5461 6b65 7320 696e 2069 6e70 7574 2074  Takes in input t
+00039980: 6865 206f 7574 7075 7420 6f66 205f 7265  he output of _re
+00039990: 6261 6c61 6e63 655f 6669 6e64 5f6d 7367  balance_find_msg
+000399a0: 7328 292c 2074 6861 7420 6973 2061 206c  s(), that is a l
+000399b0: 6973 7420 6f66 2074 7570 6c65 733a 0a0a  ist of tuples:..
+000399c0: 2020 2020 2020 2020 2d20 7365 6e64 6572          - sender
+000399d0: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
+000399e0: 2d20 7265 6369 7069 656e 7420 776f 726b  - recipient work
+000399f0: 6572 0a20 2020 2020 2020 202d 2074 6173  er.        - tas
+00039a00: 6b20 746f 2062 6520 7472 616e 7366 6572  k to be transfer
+00039a10: 7265 640a 0a20 2020 2020 2020 2046 4958  red..        FIX
+00039a20: 4d45 2074 6869 7320 6d65 7468 6f64 2069  ME this method i
+00039a30: 7320 6e6f 7420 726f 6275 7374 2077 6865  s not robust whe
+00039a40: 6e20 7468 6520 636c 7573 7465 7220 6973  n the cluster is
+00039a50: 206e 6f74 2069 646c 652e 0a20 2020 2020   not idle..     
+00039a60: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
+00039a70: 6f5f 7265 6369 7069 656e 7473 3a20 6465  o_recipients: de
+00039a80: 6661 756c 7464 6963 745b 7374 722c 2064  faultdict[str, d
+00039a90: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+00039aa0: 6c69 7374 5b73 7472 5d5d 5d20 3d20 6465  list[str]]] = de
+00039ab0: 6661 756c 7464 6963 7428 0a20 2020 2020  faultdict(.     
+00039ac0: 2020 2020 2020 206c 616d 6264 613a 2064         lambda: d
+00039ad0: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
+00039ae0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00039af0: 2020 2066 6f72 2073 6e64 5f77 732c 2072     for snd_ws, r
+00039b00: 6563 5f77 732c 2074 7320 696e 206d 7367  ec_ws, ts in msg
+00039b10: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+00039b20: 6f5f 7265 6369 7069 656e 7473 5b72 6563  o_recipients[rec
+00039b30: 5f77 732e 6164 6472 6573 735d 5b74 732e  _ws.address][ts.
+00039b40: 6b65 795d 2e61 7070 656e 6428 736e 645f  key].append(snd_
+00039b50: 7773 2e61 6464 7265 7373 290a 2020 2020  ws.address).    
+00039b60: 2020 2020 6661 696c 6564 5f6b 6579 735f      failed_keys_
+00039b70: 6279 5f72 6563 6970 6965 6e74 203d 2064  by_recipient = d
+00039b80: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
+00039b90: 207a 6970 280a 2020 2020 2020 2020 2020   zip(.          
+00039ba0: 2020 2020 2020 746f 5f72 6563 6970 6965        to_recipie
+00039bb0: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
+00039bc0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00039bd0: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00039be0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00039bf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00039c00: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
+00039c10: 3a20 7468 6973 206e 6576 6572 2072 6169  : this never rai
+00039c20: 7365 7320 6578 6365 7074 696f 6e73 0a20  ses exceptions. 
+00039c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c40: 2020 2020 2020 2073 656c 662e 6761 7468         self.gath
+00039c50: 6572 5f6f 6e5f 776f 726b 6572 2877 2c20  er_on_worker(w, 
+00039c60: 7768 6f5f 6861 7329 0a20 2020 2020 2020  who_has).       
+00039c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c80: 2066 6f72 2077 2c20 7768 6f5f 6861 7320   for w, who_has 
+00039c90: 696e 2074 6f5f 7265 6369 7069 656e 7473  in to_recipients
+00039ca0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+00039cb0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00039cc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00039cd0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00039ce0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00039cf0: 2020 2074 6f5f 7365 6e64 6572 7320 3d20     to_senders = 
+00039d00: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
+00039d10: 290a 2020 2020 2020 2020 666f 7220 736e  ).        for sn
+00039d20: 645f 7773 2c20 7265 635f 7773 2c20 7473  d_ws, rec_ws, ts
+00039d30: 2069 6e20 6d73 6773 3a0a 2020 2020 2020   in msgs:.      
+00039d40: 2020 2020 2020 6966 2074 732e 6b65 7920        if ts.key 
+00039d50: 6e6f 7420 696e 2066 6169 6c65 645f 6b65  not in failed_ke
+00039d60: 7973 5f62 795f 7265 6369 7069 656e 745b  ys_by_recipient[
+00039d70: 7265 635f 7773 2e61 6464 7265 7373 5d3a  rec_ws.address]:
+00039d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039d90: 2074 6f5f 7365 6e64 6572 735b 736e 645f   to_senders[snd_
+00039da0: 7773 2e61 6464 7265 7373 5d2e 6170 7065  ws.address].appe
+00039db0: 6e64 2874 732e 6b65 7929 0a0a 2020 2020  nd(ts.key)..    
+00039dc0: 2020 2020 2320 4e6f 7465 3a20 7468 6973      # Note: this
+00039dd0: 206e 6576 6572 2072 6169 7365 7320 6578   never raises ex
+00039de0: 6365 7074 696f 6e73 0a20 2020 2020 2020  ceptions.       
+00039df0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00039e00: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+00039e10: 2020 202a 2873 656c 662e 6465 6c65 7465     *(self.delete
+00039e20: 5f77 6f72 6b65 725f 6461 7461 2872 2c20  _worker_data(r, 
+00039e30: 762c 2073 7469 6d75 6c75 735f 6964 2920  v, stimulus_id) 
+00039e40: 666f 7220 722c 2076 2069 6e20 746f 5f73  for r, v in to_s
+00039e50: 656e 6465 7273 2e69 7465 6d73 2829 290a  enders.items()).
+00039e60: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00039e70: 2020 2066 6f72 2072 2c20 7620 696e 2074     for r, v in t
+00039e80: 6f5f 7265 6369 7069 656e 7473 2e69 7465  o_recipients.ite
+00039e90: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00039ea0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00039eb0: 2872 2c20 7b22 6163 7469 6f6e 223a 2022  (r, {"action": "
+00039ec0: 7265 6261 6c61 6e63 6522 2c20 2277 686f  rebalance", "who
+00039ed0: 5f68 6173 223a 2076 7d29 0a20 2020 2020  _has": v}).     
+00039ee0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+00039ef0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
+00039f00: 616c 6c22 2c0a 2020 2020 2020 2020 2020  all",.          
+00039f10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00039f20: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
+00039f30: 6562 616c 616e 6365 222c 0a20 2020 2020  ebalance",.     
+00039f40: 2020 2020 2020 2020 2020 2022 7365 6e64             "send
+00039f50: 6572 7322 3a20 7661 6c6d 6170 286c 656e  ers": valmap(len
+00039f60: 2c20 746f 5f73 656e 6465 7273 292c 0a20  , to_senders),. 
+00039f70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00039f80: 7265 6369 7069 656e 7473 223a 2076 616c  recipients": val
+00039f90: 6d61 7028 6c65 6e2c 2074 6f5f 7265 6369  map(len, to_reci
+00039fa0: 7069 656e 7473 292c 0a20 2020 2020 2020  pients),.       
+00039fb0: 2020 2020 2020 2020 2022 6d6f 7665 645f           "moved_
+00039fc0: 6b65 7973 223a 206c 656e 286d 7367 7329  keys": len(msgs)
+00039fd0: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
+00039fe0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00039ff0: 2020 2020 6d69 7373 696e 675f 6b65 7973      missing_keys
+0003a000: 203d 207b 6b20 666f 7220 7220 696e 2066   = {k for r in f
+0003a010: 6169 6c65 645f 6b65 7973 5f62 795f 7265  ailed_keys_by_re
+0003a020: 6369 7069 656e 742e 7661 6c75 6573 2829  cipient.values()
+0003a030: 2066 6f72 206b 2069 6e20 727d 0a20 2020   for k in r}.   
+0003a040: 2020 2020 2069 6620 6d69 7373 696e 675f       if missing_
+0003a050: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+0003a060: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
+0003a070: 7322 3a20 2270 6172 7469 616c 2d66 6169  s": "partial-fai
+0003a080: 6c22 2c20 226b 6579 7322 3a20 6c69 7374  l", "keys": list
+0003a090: 286d 6973 7369 6e67 5f6b 6579 7329 7d0a  (missing_keys)}.
+0003a0a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003a0b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003a0c0: 207b 2273 7461 7475 7322 3a20 224f 4b22   {"status": "OK"
+0003a0d0: 7d0a 0a20 2020 2061 7379 6e63 2064 6566  }..    async def
+0003a0e0: 2072 6570 6c69 6361 7465 280a 2020 2020   replicate(.    
+0003a0f0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0003a100: 2020 636f 6d6d 3d4e 6f6e 652c 0a20 2020    comm=None,.   
+0003a110: 2020 2020 206b 6579 733d 4e6f 6e65 2c0a       keys=None,.
+0003a120: 2020 2020 2020 2020 6e3d 4e6f 6e65 2c0a          n=None,.
+0003a130: 2020 2020 2020 2020 776f 726b 6572 733d          workers=
+0003a140: 4e6f 6e65 2c0a 2020 2020 2020 2020 6272  None,.        br
+0003a150: 616e 6368 696e 675f 6661 6374 6f72 3d32  anching_factor=2
+0003a160: 2c0a 2020 2020 2020 2020 6465 6c65 7465  ,.        delete
+0003a170: 3d54 7275 652c 0a20 2020 2020 2020 206c  =True,.        l
+0003a180: 6f63 6b3d 5472 7565 2c0a 2020 2020 2020  ock=True,.      
+0003a190: 2020 7374 696d 756c 7573 5f69 643d 4e6f    stimulus_id=No
+0003a1a0: 6e65 2c0a 2020 2020 293a 0a20 2020 2020  ne,.    ):.     
+0003a1b0: 2020 2022 2222 5265 706c 6963 6174 6520     """Replicate 
+0003a1c0: 6461 7461 2074 6872 6f75 6768 6f75 7420  data throughout 
+0003a1d0: 636c 7573 7465 720a 0a20 2020 2020 2020  cluster..       
+0003a1e0: 2054 6869 7320 7065 7266 6f72 6d73 2061   This performs a
+0003a1f0: 2074 7265 6520 636f 7079 206f 6620 7468   tree copy of th
+0003a200: 6520 6461 7461 2074 6872 6f75 6768 6f75  e data throughou
+0003a210: 7420 7468 6520 6e65 7477 6f72 6b0a 2020  t the network.  
+0003a220: 2020 2020 2020 696e 6469 7669 6475 616c        individual
+0003a230: 6c79 206f 6e20 6561 6368 2070 6965 6365  ly on each piece
+0003a240: 206f 6620 6461 7461 2e0a 0a20 2020 2020   of data...     
+0003a250: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+0003a260: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
+0003a270: 0a20 2020 2020 2020 206b 6579 733a 2049  .        keys: I
+0003a280: 7465 7261 626c 650a 2020 2020 2020 2020  terable.        
+0003a290: 2020 2020 6c69 7374 206f 6620 6b65 7973      list of keys
+0003a2a0: 2074 6f20 7265 706c 6963 6174 650a 2020   to replicate.  
+0003a2b0: 2020 2020 2020 6e3a 2069 6e74 0a20 2020        n: int.   
+0003a2c0: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
+0003a2d0: 6f66 2072 6570 6c69 6361 7469 6f6e 7320  of replications 
+0003a2e0: 7765 2065 7870 6563 7420 746f 2073 6565  we expect to see
+0003a2f0: 2077 6974 6869 6e20 7468 6520 636c 7573   within the clus
+0003a300: 7465 720a 2020 2020 2020 2020 6272 616e  ter.        bran
+0003a310: 6368 696e 675f 6661 6374 6f72 3a20 696e  ching_factor: in
+0003a320: 742c 206f 7074 696f 6e61 6c0a 2020 2020  t, optional.    
+0003a330: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
+0003a340: 6572 206f 6620 776f 726b 6572 7320 7468  er of workers th
+0003a350: 6174 2063 616e 2063 6f70 7920 6461 7461  at can copy data
+0003a360: 2069 6e20 6561 6368 2067 656e 6572 6174   in each generat
+0003a370: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+0003a380: 2054 6865 206c 6172 6765 7220 7468 6520   The larger the 
+0003a390: 6272 616e 6368 696e 6720 6661 6374 6f72  branching factor
+0003a3a0: 2c20 7468 6520 6d6f 7265 2064 6174 6120  , the more data 
+0003a3b0: 7765 2063 6f70 7920 696e 0a20 2020 2020  we copy in.     
+0003a3c0: 2020 2020 2020 2061 2073 696e 676c 6520         a single 
+0003a3d0: 7374 6570 2c20 6275 7420 7468 6520 6d6f  step, but the mo
+0003a3e0: 7265 2061 2067 6976 656e 2077 6f72 6b65  re a given worke
+0003a3f0: 7220 7269 736b 7320 6265 696e 670a 2020  r risks being.  
+0003a400: 2020 2020 2020 2020 2020 7377 616d 7065            swampe
+0003a410: 6420 6279 2064 6174 6120 7265 7175 6573  d by data reques
+0003a420: 7473 2e0a 0a20 2020 2020 2020 2053 6565  ts...        See
+0003a430: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
+0003a440: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
+0003a450: 6368 6564 756c 6572 2e72 6562 616c 616e  cheduler.rebalan
+0003a460: 6365 0a20 2020 2020 2020 2022 2222 0a20  ce.        """. 
+0003a470: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+0003a480: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
+0003a490: 206f 7220 6622 7265 706c 6963 6174 652d   or f"replicate-
+0003a4a0: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
+0003a4b0: 2020 6173 7365 7274 2062 7261 6e63 6869    assert branchi
+0003a4c0: 6e67 5f66 6163 746f 7220 3e20 300a 2020  ng_factor > 0.  
+0003a4d0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+0003a4e0: 2073 656c 662e 5f6c 6f63 6b20 6966 206c   self._lock if l
+0003a4f0: 6f63 6b20 656c 7365 2065 6d70 7479 5f63  ock else empty_c
+0003a500: 6f6e 7465 7874 3a0a 2020 2020 2020 2020  ontext:.        
+0003a510: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
+0003a520: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0003a530: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0003a540: 6572 7320 3d20 7b73 656c 662e 776f 726b  ers = {self.work
+0003a550: 6572 735b 775d 2066 6f72 2077 2069 6e20  ers[w] for w in 
+0003a560: 7365 6c66 2e77 6f72 6b65 7273 5f6c 6973  self.workers_lis
+0003a570: 7428 776f 726b 6572 7329 7d0a 2020 2020  t(workers)}.    
+0003a580: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0003a590: 6572 7320 3d20 7b77 7320 666f 7220 7773  ers = {ws for ws
+0003a5a0: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
+0003a5b0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
+0003a5c0: 7573 2e72 756e 6e69 6e67 7d0a 2020 2020  us.running}.    
+0003a5d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003a5e0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+0003a5f0: 726b 6572 7320 3d20 7365 6c66 2e72 756e  rkers = self.run
+0003a600: 6e69 6e67 0a0a 2020 2020 2020 2020 2020  ning..          
+0003a610: 2020 6966 206e 2069 7320 4e6f 6e65 3a0a    if n is None:.
+0003a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a630: 6e20 3d20 6c65 6e28 776f 726b 6572 7329  n = len(workers)
+0003a640: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003a650: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003a660: 2020 206e 203d 206d 696e 286e 2c20 6c65     n = min(n, le
+0003a670: 6e28 776f 726b 6572 7329 290a 2020 2020  n(workers)).    
+0003a680: 2020 2020 2020 2020 6966 206e 203d 3d20          if n == 
+0003a690: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003a6a0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0003a6b0: 726f 7228 2243 616e 206e 6f74 2075 7365  ror("Can not use
+0003a6c0: 2072 6570 6c69 6361 7465 2074 6f20 6465   replicate to de
+0003a6d0: 6c65 7465 2064 6174 6122 290a 0a20 2020  lete data")..   
+0003a6e0: 2020 2020 2020 2020 2074 6173 6b73 203d           tasks =
+0003a6f0: 207b 7365 6c66 2e74 6173 6b73 5b6b 5d20   {self.tasks[k] 
+0003a700: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
+0003a710: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0003a720: 6e67 5f64 6174 6120 3d20 5b74 732e 6b65  ng_data = [ts.ke
+0003a730: 7920 666f 7220 7473 2069 6e20 7461 736b  y for ts in task
+0003a740: 7320 6966 206e 6f74 2074 732e 7768 6f5f  s if not ts.who_
+0003a750: 6861 735d 0a20 2020 2020 2020 2020 2020  has].           
+0003a760: 2069 6620 6d69 7373 696e 675f 6461 7461   if missing_data
+0003a770: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003a780: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
+0003a790: 7322 3a20 2270 6172 7469 616c 2d66 6169  s": "partial-fai
+0003a7a0: 6c22 2c20 226b 6579 7322 3a20 6d69 7373  l", "keys": miss
+0003a7b0: 696e 675f 6461 7461 7d0a 0a20 2020 2020  ing_data}..     
+0003a7c0: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
+0003a7d0: 6578 7472 616e 656f 7573 2064 6174 610a  extraneous data.
+0003a7e0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0003a7f0: 656c 6574 653a 0a20 2020 2020 2020 2020  elete:.         
+0003a800: 2020 2020 2020 2064 656c 5f77 6f72 6b65         del_worke
+0003a810: 725f 7461 736b 7320 3d20 6465 6661 756c  r_tasks = defaul
+0003a820: 7464 6963 7428 7365 7429 0a20 2020 2020  tdict(set).     
+0003a830: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0003a840: 7320 696e 2074 6173 6b73 3a0a 2020 2020  s in tasks:.    
 0003a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a860: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0003a870: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003a880: 7220 7773 2c20 7461 736b 7320 696e 2064  r ws, tasks in d
-0003a890: 656c 5f77 6f72 6b65 725f 7461 736b 732e  el_worker_tasks.
-0003a8a0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-0003a8b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0003a8c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003a8d0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0003a8e0: 6f70 7920 6e6f 742d 7965 742d 6669 6c6c  opy not-yet-fill
-0003a8f0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
-0003a900: 2020 2020 7768 696c 6520 7461 736b 733a      while tasks:
-0003a910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a920: 2067 6174 6865 7273 203d 2064 6566 6175   gathers = defau
-0003a930: 6c74 6469 6374 2864 6963 7429 0a20 2020  ltdict(dict).   
-0003a940: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003a950: 2074 7320 696e 206c 6973 7428 7461 736b   ts in list(task
-0003a960: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0003a970: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
-0003a980: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
-0003a990: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
-0003a9a0: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
-0003a9b0: 736b 2069 7320 6e6f 206c 6f6e 6765 7220  sk is no longer 
-0003a9c0: 6e65 6564 6564 2062 7920 616e 7920 636c  needed by any cl
-0003a9d0: 6965 6e74 206f 7220 6465 7065 6e64 656e  ient or dependen
-0003a9e0: 7420 7461 736b 0a20 2020 2020 2020 2020  t task.         
-0003a9f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003aa00: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
-0003aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa20: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0003aa30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003aa40: 2020 2020 206e 5f6d 6973 7369 6e67 203d       n_missing =
-0003aa50: 206e 202d 206c 656e 2874 732e 7768 6f5f   n - len(ts.who_
-0003aa60: 6861 7320 2620 776f 726b 6572 7329 0a20  has & workers). 
-0003aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa80: 2020 2069 6620 6e5f 6d69 7373 696e 6720     if n_missing 
-0003aa90: 3c3d 2030 3a0a 2020 2020 2020 2020 2020  <= 0:.          
-0003aaa0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003aab0: 416c 7265 6164 7920 7265 706c 6963 6174  Already replicat
-0003aac0: 6564 2065 6e6f 7567 680a 2020 2020 2020  ed enough.      
-0003aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aae0: 2020 7461 736b 732e 7265 6d6f 7665 2874    tasks.remove(t
-0003aaf0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003ab00: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0003ab10: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0003ab20: 2020 2020 2020 2020 2063 6f75 6e74 203d           count =
-0003ab30: 206d 696e 286e 5f6d 6973 7369 6e67 2c20   min(n_missing, 
-0003ab40: 6272 616e 6368 696e 675f 6661 6374 6f72  branching_factor
-0003ab50: 202a 206c 656e 2874 732e 7768 6f5f 6861   * len(ts.who_ha
-0003ab60: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0003ab70: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0003ab80: 6f75 6e74 203e 2030 0a0a 2020 2020 2020  ount > 0..      
-0003ab90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003aba0: 7220 7773 2069 6e20 7261 6e64 6f6d 2e73  r ws in random.s
-0003abb0: 616d 706c 6528 7475 706c 6528 776f 726b  ample(tuple(work
-0003abc0: 6572 7320 2d20 7473 2e77 686f 5f68 6173  ers - ts.who_has
-0003abd0: 292c 2063 6f75 6e74 293a 0a20 2020 2020  ), count):.     
-0003abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003abf0: 2020 2067 6174 6865 7273 5b77 732e 6164     gathers[ws.ad
-0003ac00: 6472 6573 735d 5b74 732e 6b65 795d 203d  dress][ts.key] =
-0003ac10: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0003ac20: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0003ac30: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
-0003ac40: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-0003ac50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ac60: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
-0003ac70: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0003ac80: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0003ac90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003aca0: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
-0003acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003acc0: 2023 204e 6f74 653a 2074 6869 7320 6e65   # Note: this ne
-0003acd0: 7665 7220 7261 6973 6573 2065 7863 6570  ver raises excep
-0003ace0: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
-0003acf0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003ad00: 6c66 2e67 6174 6865 725f 6f6e 5f77 6f72  lf.gather_on_wor
-0003ad10: 6b65 7228 772c 2077 686f 5f68 6173 290a  ker(w, who_has).
+0003a860: 6465 6c5f 6361 6e64 6964 6174 6573 203d  del_candidates =
+0003a870: 2074 7570 6c65 2874 732e 7768 6f5f 6861   tuple(ts.who_ha
+0003a880: 7320 2620 776f 726b 6572 7329 0a20 2020  s & workers).   
+0003a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a8a0: 2069 6620 6c65 6e28 6465 6c5f 6361 6e64   if len(del_cand
+0003a8b0: 6964 6174 6573 2920 3e20 6e3a 0a20 2020  idates) > n:.   
+0003a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a8d0: 2020 2020 2066 6f72 2077 7320 696e 2072       for ws in r
+0003a8e0: 616e 646f 6d2e 7361 6d70 6c65 280a 2020  andom.sample(.  
+0003a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a900: 2020 2020 2020 2020 2020 6465 6c5f 6361            del_ca
+0003a910: 6e64 6964 6174 6573 2c20 6c65 6e28 6465  ndidates, len(de
+0003a920: 6c5f 6361 6e64 6964 6174 6573 2920 2d20  l_candidates) - 
+0003a930: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0003a940: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+0003a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a960: 2020 2020 2020 2020 2064 656c 5f77 6f72           del_wor
+0003a970: 6b65 725f 7461 736b 735b 7773 5d2e 6164  ker_tasks[ws].ad
+0003a980: 6428 7473 290a 0a20 2020 2020 2020 2020  d(ts)..         
+0003a990: 2020 2020 2020 2023 204e 6f74 653a 2074         # Note: t
+0003a9a0: 6869 7320 6e65 7665 7220 7261 6973 6573  his never raises
+0003a9b0: 2065 7863 6570 7469 6f6e 730a 2020 2020   exceptions.    
+0003a9c0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0003a9d0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0003a9e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003a9f0: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
+0003aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa10: 2073 656c 662e 6465 6c65 7465 5f77 6f72   self.delete_wor
+0003aa20: 6b65 725f 6461 7461 280a 2020 2020 2020  ker_data(.      
+0003aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa40: 2020 2020 2020 7773 2e61 6464 7265 7373        ws.address
+0003aa50: 2c20 5b74 2e6b 6579 2066 6f72 2074 2069  , [t.key for t i
+0003aa60: 6e20 7461 736b 735d 2c20 7374 696d 756c  n tasks], stimul
+0003aa70: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+0003aa80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aaa0: 2020 2020 2020 2020 666f 7220 7773 2c20          for ws, 
+0003aab0: 7461 736b 7320 696e 2064 656c 5f77 6f72  tasks in del_wor
+0003aac0: 6b65 725f 7461 736b 732e 6974 656d 7328  ker_tasks.items(
+0003aad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003aae0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0003aaf0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003ab00: 2020 2020 2020 2023 2043 6f70 7920 6e6f         # Copy no
+0003ab10: 742d 7965 742d 6669 6c6c 6564 2064 6174  t-yet-filled dat
+0003ab20: 610a 2020 2020 2020 2020 2020 2020 7768  a.            wh
+0003ab30: 696c 6520 7461 736b 733a 0a20 2020 2020  ile tasks:.     
+0003ab40: 2020 2020 2020 2020 2020 2067 6174 6865             gathe
+0003ab50: 7273 203d 2064 6566 6175 6c74 6469 6374  rs = defaultdict
+0003ab60: 2864 6963 7429 0a20 2020 2020 2020 2020  (dict).         
+0003ab70: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0003ab80: 206c 6973 7428 7461 736b 7329 3a0a 2020   list(tasks):.  
+0003ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aba0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+0003abb0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
+0003abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003abd0: 2020 2020 2020 2320 7461 736b 2069 7320        # task is 
+0003abe0: 6e6f 206c 6f6e 6765 7220 6e65 6564 6564  no longer needed
+0003abf0: 2062 7920 616e 7920 636c 6965 6e74 206f   by any client o
+0003ac00: 7220 6465 7065 6e64 656e 7420 7461 736b  r dependent task
+0003ac10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ac20: 2020 2020 2020 2020 2074 6173 6b73 2e72           tasks.r
+0003ac30: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
+0003ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac50: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0003ac60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003ac70: 5f6d 6973 7369 6e67 203d 206e 202d 206c  _missing = n - l
+0003ac80: 656e 2874 732e 7768 6f5f 6861 7320 2620  en(ts.who_has & 
+0003ac90: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+0003aca0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003acb0: 6e5f 6d69 7373 696e 6720 3c3d 2030 3a0a  n_missing <= 0:.
+0003acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003acd0: 2020 2020 2020 2020 2320 416c 7265 6164          # Alread
+0003ace0: 7920 7265 706c 6963 6174 6564 2065 6e6f  y replicated eno
+0003acf0: 7567 680a 2020 2020 2020 2020 2020 2020  ugh.            
+0003ad00: 2020 2020 2020 2020 2020 2020 7461 736b              task
+0003ad10: 732e 7265 6d6f 7665 2874 7329 0a20 2020  s.remove(ts).   
 0003ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad30: 2020 2020 2020 2020 666f 7220 772c 2077          for w, w
-0003ad40: 686f 5f68 6173 2069 6e20 6761 7468 6572  ho_has in gather
-0003ad50: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
-0003ad60: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003ad90: 2020 666f 7220 722c 2076 2069 6e20 6761    for r, v in ga
-0003ada0: 7468 6572 732e 6974 656d 7328 293a 0a20  thers.items():. 
-0003adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003adc0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-0003add0: 7428 722c 207b 2261 6374 696f 6e22 3a20  t(r, {"action": 
-0003ade0: 2272 6570 6c69 6361 7465 2d61 6464 222c  "replicate-add",
-0003adf0: 2022 7768 6f5f 6861 7322 3a20 767d 290a   "who_has": v}).
-0003ae00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0003ae10: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-0003ae20: 2020 2020 2020 2020 2020 2020 2022 616c               "al
-0003ae30: 6c22 2c0a 2020 2020 2020 2020 2020 2020  l",.            
-0003ae40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0003ae50: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-0003ae60: 6e22 3a20 2272 6570 6c69 6361 7465 222c  n": "replicate",
-0003ae70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ae80: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
-0003ae90: 6c69 7374 2877 6f72 6b65 7273 292c 0a20  list(workers),. 
-0003aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aeb0: 2020 2022 6b65 792d 636f 756e 7422 3a20     "key-count": 
-0003aec0: 6c65 6e28 6b65 7973 292c 0a20 2020 2020  len(keys),.     
-0003aed0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003aee0: 6272 616e 6368 696e 672d 6661 6374 6f72  branching-factor
-0003aef0: 223a 2062 7261 6e63 6869 6e67 5f66 6163  ": branching_fac
-0003af00: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
-0003af10: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0003af20: 2020 2020 290a 0a20 2020 2064 6566 2077      )..    def w
-0003af30: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
-0003af40: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0003af50: 2020 2020 2020 206d 656d 6f72 795f 7261         memory_ra
-0003af60: 7469 6f3a 2069 6e74 207c 2066 6c6f 6174  tio: int | float
-0003af70: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003af80: 2020 2020 2020 2020 6e3a 2069 6e74 207c          n: int |
-0003af90: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-0003afa0: 2020 2020 2020 6b65 793a 2043 616c 6c61        key: Calla
-0003afb0: 626c 655b 5b57 6f72 6b65 7253 7461 7465  ble[[WorkerState
-0003afc0: 5d2c 2048 6173 6861 626c 655d 207c 2062  ], Hashable] | b
-0003afd0: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
-0003afe0: 6e65 2c0a 2020 2020 2020 2020 6d69 6e69  ne,.        mini
-0003aff0: 6d75 6d3a 2069 6e74 207c 204e 6f6e 6520  mum: int | None 
-0003b000: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0003b010: 7461 7267 6574 3a20 696e 7420 7c20 4e6f  target: int | No
-0003b020: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-0003b030: 2020 2061 7474 7269 6275 7465 3a20 7374     attribute: st
-0003b040: 7220 3d20 2261 6464 7265 7373 222c 0a20  r = "address",. 
-0003b050: 2020 2029 202d 3e20 6c69 7374 5b73 7472     ) -> list[str
-0003b060: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-0003b070: 2020 2020 2020 2046 696e 6420 776f 726b         Find work
-0003b080: 6572 7320 7468 6174 2077 6520 6361 6e20  ers that we can 
-0003b090: 636c 6f73 6520 7769 7468 206c 6f77 2063  close with low c
-0003b0a0: 6f73 740a 0a20 2020 2020 2020 2054 6869  ost..        Thi
-0003b0b0: 7320 7265 7475 726e 7320 6120 6c69 7374  s returns a list
-0003b0c0: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
-0003b0d0: 2061 7265 2067 6f6f 6420 6361 6e64 6964   are good candid
-0003b0e0: 6174 6573 2074 6f20 7265 7469 7265 2e0a  ates to retire..
-0003b0f0: 2020 2020 2020 2020 5468 6573 6520 776f          These wo
-0003b100: 726b 6572 7320 6172 6520 6e6f 7420 7275  rkers are not ru
-0003b110: 6e6e 696e 6720 616e 7974 6869 6e67 2061  nning anything a
-0003b120: 6e64 2061 7265 2073 746f 7269 6e67 0a20  nd are storing. 
-0003b130: 2020 2020 2020 2072 656c 6174 6976 656c         relativel
-0003b140: 7920 6c69 7474 6c65 2064 6174 6120 7265  y little data re
-0003b150: 6c61 7469 7665 2074 6f20 7468 6569 7220  lative to their 
-0003b160: 7065 6572 732e 2020 4966 2061 6c6c 2077  peers.  If all w
-0003b170: 6f72 6b65 7273 2061 7265 0a20 2020 2020  orkers are.     
-0003b180: 2020 2069 646c 6520 7468 656e 2077 6520     idle then we 
-0003b190: 7374 696c 6c20 6d61 696e 7461 696e 2065  still maintain e
-0003b1a0: 6e6f 7567 6820 776f 726b 6572 7320 746f  nough workers to
-0003b1b0: 2068 6176 6520 656e 6f75 6768 2052 414d   have enough RAM
-0003b1c0: 2074 6f20 7374 6f72 650a 2020 2020 2020   to store.      
-0003b1d0: 2020 6f75 7220 6461 7461 2c20 7769 7468    our data, with
-0003b1e0: 2061 2063 6f6d 666f 7274 6162 6c65 2062   a comfortable b
-0003b1f0: 7566 6665 722e 0a0a 2020 2020 2020 2020  uffer...        
-0003b200: 5468 6973 2069 7320 666f 7220 7573 6520  This is for use 
-0003b210: 7769 7468 2073 7973 7465 6d73 206c 696b  with systems lik
-0003b220: 6520 6060 6469 7374 7269 6275 7465 642e  e ``distributed.
-0003b230: 6465 706c 6f79 2e61 6461 7074 6976 6560  deploy.adaptive`
-0003b240: 602e 0a0a 2020 2020 2020 2020 5061 7261  `...        Para
-0003b250: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
-0003b260: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
-0003b270: 2020 6d65 6d6f 7279 5f72 6174 696f 203a    memory_ratio :
-0003b280: 204e 756d 6265 720a 2020 2020 2020 2020   Number.        
-0003b290: 2020 2020 416d 6f75 6e74 206f 6620 6578      Amount of ex
-0003b2a0: 7472 6120 7370 6163 6520 7765 2077 616e  tra space we wan
-0003b2b0: 7420 746f 2068 6176 6520 666f 7220 6f75  t to have for ou
-0003b2c0: 7220 7374 6f72 6564 2064 6174 612e 0a20  r stored data.. 
-0003b2d0: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
-0003b2e0: 6c74 7320 746f 2032 2c20 6f72 2074 6861  lts to 2, or tha
-0003b2f0: 7420 7765 2077 616e 7420 746f 2068 6176  t we want to hav
-0003b300: 6520 7477 6963 6520 6173 206d 7563 6820  e twice as much 
-0003b310: 6d65 6d6f 7279 2061 7320 7765 0a20 2020  memory as we.   
-0003b320: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-0003b330: 6c79 2068 6176 6520 6461 7461 2e0a 2020  ly have data..  
-0003b340: 2020 2020 2020 6e20 3a20 696e 740a 2020        n : int.  
-0003b350: 2020 2020 2020 2020 2020 4e75 6d62 6572            Number
-0003b360: 206f 6620 776f 726b 6572 7320 746f 2063   of workers to c
-0003b370: 6c6f 7365 0a20 2020 2020 2020 206d 696e  lose.        min
-0003b380: 696d 756d 203a 2069 6e74 0a20 2020 2020  imum : int.     
-0003b390: 2020 2020 2020 204d 696e 696d 756d 206e         Minimum n
-0003b3a0: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-0003b3b0: 2074 6f20 6b65 6570 2061 726f 756e 640a   to keep around.
-0003b3c0: 2020 2020 2020 2020 6b65 7920 3a20 4361          key : Ca
-0003b3d0: 6c6c 6162 6c65 2857 6f72 6b65 7253 7461  llable(WorkerSta
-0003b3e0: 7465 290a 2020 2020 2020 2020 2020 2020  te).            
-0003b3f0: 416e 206f 7074 696f 6e61 6c20 6361 6c6c  An optional call
-0003b400: 6162 6c65 206d 6170 7069 6e67 2061 2057  able mapping a W
-0003b410: 6f72 6b65 7253 7461 7465 206f 626a 6563  orkerState objec
-0003b420: 7420 746f 2061 2067 726f 7570 0a20 2020  t to a group.   
-0003b430: 2020 2020 2020 2020 2061 6666 696c 6961           affilia
-0003b440: 7469 6f6e 2e20 4772 6f75 7073 2077 696c  tion. Groups wil
-0003b450: 6c20 6265 2063 6c6f 7365 6420 746f 6765  l be closed toge
-0003b460: 7468 6572 2e20 5468 6973 2069 7320 7573  ther. This is us
-0003b470: 6566 756c 2077 6865 6e0a 2020 2020 2020  eful when.      
-0003b480: 2020 2020 2020 636c 6f73 696e 6720 776f        closing wo
-0003b490: 726b 6572 7320 6d75 7374 2062 6520 646f  rkers must be do
-0003b4a0: 6e65 2063 6f6c 6c65 6374 6976 656c 792c  ne collectively,
-0003b4b0: 2073 7563 6820 6173 2062 7920 686f 7374   such as by host
-0003b4c0: 6e61 6d65 2e0a 2020 2020 2020 2020 7461  name..        ta
-0003b4d0: 7267 6574 203a 2069 6e74 0a20 2020 2020  rget : int.     
-0003b4e0: 2020 2020 2020 2054 6172 6765 7420 6e75         Target nu
-0003b4f0: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
-0003b500: 746f 2068 6176 6520 6166 7465 7220 7765  to have after we
-0003b510: 2063 6c6f 7365 0a20 2020 2020 2020 2061   close.        a
-0003b520: 7474 7269 6275 7465 203a 2073 7472 0a20  ttribute : str. 
-0003b530: 2020 2020 2020 2020 2020 2054 6865 2061             The a
-0003b540: 7474 7269 6275 7465 206f 6620 7468 6520  ttribute of the 
-0003b550: 576f 726b 6572 5374 6174 6520 6f62 6a65  WorkerState obje
-0003b560: 6374 2074 6f20 7265 7475 726e 2c20 6c69  ct to return, li
-0003b570: 6b65 2022 6164 6472 6573 7322 0a20 2020  ke "address".   
-0003b580: 2020 2020 2020 2020 206f 7220 226e 616d           or "nam
-0003b590: 6522 2e20 2044 6566 6175 6c74 7320 746f  e".  Defaults to
-0003b5a0: 2022 6164 6472 6573 7322 2e0a 0a20 2020   "address"...   
-0003b5b0: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
-0003b5c0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0003b5d0: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
-0003b5e0: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
-0003b5f0: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-0003b600: 5b27 7463 703a 2f2f 3139 322e 3136 382e  ['tcp://192.168.
-0003b610: 302e 313a 3132 3334 272c 2027 7463 703a  0.1:1234', 'tcp:
-0003b620: 2f2f 3139 322e 3136 382e 302e 323a 3132  //192.168.0.2:12
-0003b630: 3334 275d 0a0a 2020 2020 2020 2020 4772  34']..        Gr
-0003b640: 6f75 7020 776f 726b 6572 7320 6279 2068  oup workers by h
-0003b650: 6f73 746e 616d 6520 7072 696f 7220 746f  ostname prior to
-0003b660: 2063 6c6f 7369 6e67 0a0a 2020 2020 2020   closing..      
-0003b670: 2020 3e3e 3e20 7363 6865 6475 6c65 722e    >>> scheduler.
-0003b680: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
-0003b690: 286b 6579 3d6c 616d 6264 6120 7773 3a20  (key=lambda ws: 
-0003b6a0: 7773 2e68 6f73 7429 0a20 2020 2020 2020  ws.host).       
-0003b6b0: 205b 2774 6370 3a2f 2f31 3932 2e31 3638   ['tcp://192.168
-0003b6c0: 2e30 2e31 3a31 3233 3427 2c20 2774 6370  .0.1:1234', 'tcp
-0003b6d0: 3a2f 2f31 3932 2e31 3638 2e30 2e31 3a34  ://192.168.0.1:4
-0003b6e0: 3536 3727 5d0a 0a20 2020 2020 2020 2052  567']..        R
-0003b6f0: 656d 6f76 6520 7477 6f20 776f 726b 6572  emove two worker
-0003b700: 730a 0a20 2020 2020 2020 203e 3e3e 2073  s..        >>> s
-0003b710: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0003b720: 5f74 6f5f 636c 6f73 6528 6e3d 3229 0a0a  _to_close(n=2)..
-0003b730: 2020 2020 2020 2020 4b65 6570 2065 6e6f          Keep eno
-0003b740: 7567 6820 776f 726b 6572 7320 746f 2068  ugh workers to h
-0003b750: 6176 6520 7477 6963 6520 6173 206d 7563  ave twice as muc
-0003b760: 6820 6d65 6d6f 7279 2061 7320 7765 2077  h memory as we w
-0003b770: 6520 6e65 6564 2e0a 0a20 2020 2020 2020  e need...       
-0003b780: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
-0003b790: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
-0003b7a0: 6d65 6d6f 7279 5f72 6174 696f 3d32 290a  memory_ratio=2).
-0003b7b0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0003b7c0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003b7d0: 0a20 2020 2020 2020 2074 6f5f 636c 6f73  .        to_clos
-0003b7e0: 653a 206c 6973 7420 6f66 2077 6f72 6b65  e: list of worke
-0003b7f0: 7220 6164 6472 6573 7365 7320 7468 6174  r addresses that
-0003b800: 2061 7265 204f 4b20 746f 2063 6c6f 7365   are OK to close
-0003b810: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
-0003b820: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-0003b830: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
-0003b840: 6475 6c65 722e 7265 7469 7265 5f77 6f72  duler.retire_wor
-0003b850: 6b65 7273 0a20 2020 2020 2020 2022 2222  kers.        """
-0003b860: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
-0003b870: 6574 2069 7320 6e6f 7420 4e6f 6e65 2061  et is not None a
-0003b880: 6e64 206e 2069 7320 4e6f 6e65 3a0a 2020  nd n is None:.  
-0003b890: 2020 2020 2020 2020 2020 6e20 3d20 6c65            n = le
-0003b8a0: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-0003b8b0: 2d20 7461 7267 6574 0a20 2020 2020 2020  - target.       
-0003b8c0: 2069 6620 6e20 6973 206e 6f74 204e 6f6e   if n is not Non
-0003b8d0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0003b8e0: 6620 6e20 3c20 303a 0a20 2020 2020 2020  f n < 0:.       
-0003b8f0: 2020 2020 2020 2020 206e 203d 2030 0a20           n = 0. 
-0003b900: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0003b910: 7420 3d20 6c65 6e28 7365 6c66 2e77 6f72  t = len(self.wor
-0003b920: 6b65 7273 2920 2d20 6e0a 0a20 2020 2020  kers) - n..     
-0003b930: 2020 2069 6620 6e20 6973 204e 6f6e 6520     if n is None 
-0003b940: 616e 6420 6d65 6d6f 7279 5f72 6174 696f  and memory_ratio
-0003b950: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003b960: 2020 2020 2020 6d65 6d6f 7279 5f72 6174        memory_rat
-0003b970: 696f 203d 2032 0a0a 2020 2020 2020 2020  io = 2..        
-0003b980: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
-0003b990: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0003b9a0: 6620 6e6f 7420 6e20 616e 6420 616c 6c28  f not n and all(
-0003b9b0: 5b77 732e 7072 6f63 6573 7369 6e67 2066  [ws.processing f
-0003b9c0: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
-0003b9d0: 726b 6572 732e 7661 6c75 6573 2829 5d29  rkers.values()])
-0003b9e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003b9f0: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-0003ba00: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-0003ba10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003ba20: 2020 2020 2020 2020 206b 6579 203d 206f           key = o
-0003ba30: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
-0003ba40: 6572 2822 6164 6472 6573 7322 290a 2020  er("address").  
-0003ba50: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0003ba60: 6e73 7461 6e63 6528 6b65 792c 2062 7974  nstance(key, byt
-0003ba70: 6573 2920 616e 6420 6461 736b 2e63 6f6e  es) and dask.con
-0003ba80: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-0003ba90: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
-0003baa0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0003bab0: 7069 636b 6c65 220a 2020 2020 2020 2020  pickle".        
-0003bac0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0003bad0: 2020 2020 2020 206b 6579 203d 2070 6963         key = pic
-0003bae0: 6b6c 652e 6c6f 6164 7328 6b65 7929 0a0a  kle.loads(key)..
-0003baf0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-0003bb00: 7073 203d 2067 726f 7570 6279 286b 6579  ps = groupby(key
-0003bb10: 2c20 7365 6c66 2e77 6f72 6b65 7273 2e76  , self.workers.v
-0003bb20: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
-0003bb30: 2020 2020 2020 6c69 6d69 745f 6279 7465        limit_byte
-0003bb40: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-0003bb50: 2020 2020 2020 6b3a 2073 756d 2877 732e        k: sum(ws.
-0003bb60: 6d65 6d6f 7279 5f6c 696d 6974 2066 6f72  memory_limit for
-0003bb70: 2077 7320 696e 2076 2920 666f 7220 6b2c   ws in v) for k,
-0003bb80: 2076 2069 6e20 6772 6f75 7073 2e69 7465   v in groups.ite
-0003bb90: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
-0003bba0: 207d 0a20 2020 2020 2020 2020 2020 2067   }.            g
-0003bbb0: 726f 7570 5f62 7974 6573 203d 207b 6b3a  roup_bytes = {k:
-0003bbc0: 2073 756d 2877 732e 6e62 7974 6573 2066   sum(ws.nbytes f
-0003bbd0: 6f72 2077 7320 696e 2076 2920 666f 7220  or ws in v) for 
-0003bbe0: 6b2c 2076 2069 6e20 6772 6f75 7073 2e69  k, v in groups.i
-0003bbf0: 7465 6d73 2829 7d0a 0a20 2020 2020 2020  tems()}..       
-0003bc00: 2020 2020 206c 696d 6974 203d 2073 756d       limit = sum
-0003bc10: 286c 696d 6974 5f62 7974 6573 2e76 616c  (limit_bytes.val
-0003bc20: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
-0003bc30: 2020 2074 6f74 616c 203d 2073 756d 2867     total = sum(g
-0003bc40: 726f 7570 5f62 7974 6573 2e76 616c 7565  roup_bytes.value
-0003bc50: 7328 2929 0a0a 2020 2020 2020 2020 2020  s())..          
-0003bc60: 2020 6465 6620 5f6b 6579 2867 726f 7570    def _key(group
-0003bc70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003bc80: 2020 2069 735f 6964 6c65 203d 206e 6f74     is_idle = not
-0003bc90: 2061 6e79 285b 7777 732e 7072 6f63 6573   any([wws.proces
-0003bca0: 7369 6e67 2066 6f72 2077 7773 2069 6e20  sing for wws in 
-0003bcb0: 6772 6f75 7073 5b67 726f 7570 5d5d 290a  groups[group]]).
-0003bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bcd0: 6279 7465 7320 3d20 2d67 726f 7570 5f62  bytes = -group_b
-0003bce0: 7974 6573 5b67 726f 7570 5d0a 2020 2020  ytes[group].    
-0003bcf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003bd00: 726e 2069 735f 6964 6c65 2c20 6279 7465  rn is_idle, byte
-0003bd10: 730a 0a20 2020 2020 2020 2020 2020 2069  s..            i
-0003bd20: 646c 6520 3d20 736f 7274 6564 2867 726f  dle = sorted(gro
-0003bd30: 7570 732c 206b 6579 3d5f 6b65 7929 0a0a  ups, key=_key)..
-0003bd40: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
-0003bd50: 6c6f 7365 203d 205b 5d0a 2020 2020 2020  lose = [].      
-0003bd60: 2020 2020 2020 6e5f 7265 6d61 696e 203d        n_remain =
-0003bd70: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
-0003bd80: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0003bd90: 7768 696c 6520 6964 6c65 3a0a 2020 2020  while idle:.    
-0003bda0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-0003bdb0: 7020 3d20 6964 6c65 2e70 6f70 2829 0a20  p = idle.pop(). 
-0003bdc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003bdd0: 6620 6e20 6973 204e 6f6e 6520 616e 6420  f n is None and 
-0003bde0: 616e 7928 5b77 732e 7072 6f63 6573 7369  any([ws.processi
-0003bdf0: 6e67 2066 6f72 2077 7320 696e 2067 726f  ng for ws in gro
-0003be00: 7570 735b 6772 6f75 705d 5d29 3a0a 2020  ups[group]]):.  
-0003be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003be20: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-0003be30: 2020 2020 2020 2020 2069 6620 6d69 6e69           if mini
-0003be40: 6d75 6d20 616e 6420 6e5f 7265 6d61 696e  mum and n_remain
-0003be50: 202d 206c 656e 2867 726f 7570 735b 6772   - len(groups[gr
-0003be60: 6f75 705d 2920 3c20 6d69 6e69 6d75 6d3a  oup]) < minimum:
-0003be70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003be80: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-0003be90: 2020 2020 2020 2020 2020 2020 6c69 6d69              limi
-0003bea0: 7420 2d3d 206c 696d 6974 5f62 7974 6573  t -= limit_bytes
-0003beb0: 5b67 726f 7570 5d0a 0a20 2020 2020 2020  [group]..       
-0003bec0: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
-0003bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bee0: 2020 6e20 6973 206e 6f74 204e 6f6e 6520    n is not None 
-0003bef0: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
-0003bf00: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
-0003bf10: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
-0003bf20: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-0003bf30: 2020 2029 206f 7220 286d 656d 6f72 795f     ) or (memory_
-0003bf40: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
-0003bf50: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
-0003bf60: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
-0003bf70: 7461 6c29 3a0a 2020 2020 2020 2020 2020  tal):.          
-0003bf80: 2020 2020 2020 2020 2020 746f 5f63 6c6f            to_clo
-0003bf90: 7365 2e61 7070 656e 6428 6772 6f75 7029  se.append(group)
-0003bfa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003bfb0: 2020 2020 206e 5f72 656d 6169 6e20 2d3d       n_remain -=
-0003bfc0: 206c 656e 2867 726f 7570 735b 6772 6f75   len(groups[grou
-0003bfd0: 705d 290a 0a20 2020 2020 2020 2020 2020  p])..           
-0003bfe0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003bff0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0003c000: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
-0003c010: 2020 7265 7375 6c74 203d 205b 6765 7461    result = [geta
-0003c020: 7474 7228 7773 2c20 6174 7472 6962 7574  ttr(ws, attribut
-0003c030: 6529 2066 6f72 2067 2069 6e20 746f 5f63  e) for g in to_c
-0003c040: 6c6f 7365 2066 6f72 2077 7320 696e 2067  lose for ws in g
-0003c050: 726f 7570 735b 675d 5d0a 2020 2020 2020  roups[g]].      
-0003c060: 2020 2020 2020 6966 2072 6573 756c 743a        if result:
-0003c070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c080: 206c 6f67 6765 722e 6465 6275 6728 2253   logger.debug("S
-0003c090: 7567 6765 7374 2063 6c6f 7369 6e67 2077  uggest closing w
-0003c0a0: 6f72 6b65 7273 3a20 2573 222c 2072 6573  orkers: %s", res
-0003c0b0: 756c 7429 0a0a 2020 2020 2020 2020 2020  ult)..          
-0003c0c0: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-0003c0d0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0003c0e0: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-0003c0f0: 6574 6972 655f 776f 726b 6572 7328 0a20  etire_workers(. 
-0003c100: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0003c110: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
-0003c120: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
-0003c130: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-0003c140: 2c0a 2020 2020 2020 2020 6e61 6d65 733a  ,.        names:
-0003c150: 206c 6973 7420 7c20 4e6f 6e65 203d 204e   list | None = N
-0003c160: 6f6e 652c 0a20 2020 2020 2020 2063 6c6f  one,.        clo
-0003c170: 7365 5f77 6f72 6b65 7273 3a20 626f 6f6c  se_workers: bool
-0003c180: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
-0003c190: 2020 7265 6d6f 7665 3a20 626f 6f6c 203d    remove: bool =
-0003c1a0: 2054 7275 652c 0a20 2020 2020 2020 2073   True,.        s
-0003c1b0: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
-0003c1c0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0003c1d0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-0003c1e0: 2041 6e79 2c0a 2020 2020 2920 2d3e 2064   Any,.    ) -> d
-0003c1f0: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0003c200: 2020 2020 2020 2022 2222 4772 6163 6566         """Gracef
-0003c210: 756c 6c79 2072 6574 6972 6520 776f 726b  ully retire work
-0003c220: 6572 7320 6672 6f6d 2063 6c75 7374 6572  ers from cluster
-0003c230: 2e20 416e 7920 6b65 7920 7468 6174 2069  . Any key that i
-0003c240: 7320 696e 206d 656d 6f72 7920 6578 636c  s in memory excl
-0003c250: 7573 6976 656c 790a 2020 2020 2020 2020  usively.        
-0003c260: 6f6e 2074 6865 2072 6574 6972 6564 2077  on the retired w
-0003c270: 6f72 6b65 7273 2069 7320 7265 706c 6963  orkers is replic
-0003c280: 6174 6564 2073 6f6d 6577 6865 7265 2065  ated somewhere e
-0003c290: 6c73 652e 0a0a 2020 2020 2020 2020 5061  lse...        Pa
-0003c2a0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-0003c2b0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0003c2c0: 2020 2020 776f 726b 6572 733a 206c 6973      workers: lis
-0003c2d0: 745b 7374 725d 2028 6f70 7469 6f6e 616c  t[str] (optional
-0003c2e0: 290a 2020 2020 2020 2020 2020 2020 4c69  ).            Li
-0003c2f0: 7374 206f 6620 776f 726b 6572 2061 6464  st of worker add
-0003c300: 7265 7373 6573 2074 6f20 7265 7469 7265  resses to retire
-0003c310: 2e0a 2020 2020 2020 2020 6e61 6d65 733a  ..        names:
-0003c320: 206c 6973 7420 286f 7074 696f 6e61 6c29   list (optional)
-0003c330: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
-0003c340: 7420 6f66 2077 6f72 6b65 7220 6e61 6d65  t of worker name
-0003c350: 7320 746f 2072 6574 6972 652e 0a20 2020  s to retire..   
-0003c360: 2020 2020 2020 2020 204d 7574 7561 6c6c           Mutuall
-0003c370: 7920 6578 636c 7573 6976 6520 7769 7468  y exclusive with
-0003c380: 2060 6077 6f72 6b65 7273 6060 2e0a 2020   ``workers``..  
-0003c390: 2020 2020 2020 2020 2020 4966 206e 6569            If nei
-0003c3a0: 7468 6572 2060 6077 6f72 6b65 7273 6060  ther ``workers``
-0003c3b0: 206e 6f72 2060 606e 616d 6573 6060 2061   nor ``names`` a
-0003c3c0: 7265 2070 726f 7669 6465 642c 2077 6520  re provided, we 
-0003c3d0: 6361 6c6c 0a20 2020 2020 2020 2020 2020  call.           
-0003c3e0: 2060 6077 6f72 6b65 7273 5f74 6f5f 636c   ``workers_to_cl
-0003c3f0: 6f73 6560 6020 7768 6963 6820 6669 6e64  ose`` which find
-0003c400: 7320 6120 676f 6f64 2073 6574 2e0a 2020  s a good set..  
-0003c410: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
-0003c420: 6572 733a 2062 6f6f 6c20 2864 6566 6175  ers: bool (defau
-0003c430: 6c74 7320 746f 2046 616c 7365 290a 2020  lts to False).  
-0003c440: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
-0003c450: 7220 6f72 206e 6f74 2074 6f20 6163 7475  r or not to actu
-0003c460: 616c 6c79 2063 6c6f 7365 2074 6865 2077  ally close the w
-0003c470: 6f72 6b65 7220 6578 706c 6963 6974 6c79  orker explicitly
-0003c480: 2066 726f 6d20 6865 7265 2e0a 2020 2020   from here..    
-0003c490: 2020 2020 2020 2020 4f74 6865 7277 6973          Otherwis
-0003c4a0: 6520 7765 2065 7870 6563 7420 736f 6d65  e we expect some
-0003c4b0: 2065 7874 6572 6e61 6c20 6a6f 6220 7363   external job sc
-0003c4c0: 6865 6475 6c65 7220 746f 2066 696e 6973  heduler to finis
-0003c4d0: 6820 6f66 6620 7468 650a 2020 2020 2020  h off the.      
-0003c4e0: 2020 2020 2020 776f 726b 6572 2e0a 2020        worker..  
-0003c4f0: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
-0003c500: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
-0003c510: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0003c520: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
-0003c530: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
-0003c540: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
-0003c550: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
-0003c560: 7365 0a20 2020 2020 2020 2020 2020 2077  se.            w
-0003c570: 6169 7420 666f 7220 7468 6520 776f 726b  ait for the work
-0003c580: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
-0003c590: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
-0003c5a0: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
-0003c5b0: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
-0003c5c0: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
-0003c5d0: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
-0003c5e0: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
-0003c5f0: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
-0003c600: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
-0003c610: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
-0003c620: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
-0003c630: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
-0003c640: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
-0003c650: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
-0003c660: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
-0003c670: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
-0003c680: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-0003c690: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
-0003c6a0: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
-0003c6b0: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
-0003c6c0: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
-0003c6d0: 2020 2020 2020 2020 2020 2020 4966 2063              If c
-0003c6e0: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
-0003c6f0: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
-0003c700: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
-0003c710: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
-0003c720: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
-0003c730: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
-0003c740: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
-0003c750: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
-0003c760: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
-0003c770: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
-0003c780: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
-0003c790: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
-0003c7a0: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
-0003c7b0: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
-0003c7c0: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
-0003c7d0: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
-0003c7e0: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
-0003c7f0: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
-0003c800: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
-0003c810: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
-0003c820: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
-0003c830: 686f 756c 6420 6472 6f70 0a0a 2020 2020  hould drop..    
-0003c840: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0003c850: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0003c860: 2020 2020 4469 6374 696f 6e61 7279 206d      Dictionary m
-0003c870: 6170 7069 6e67 2077 6f72 6b65 7220 4944  apping worker ID
-0003c880: 2f61 6464 7265 7373 2074 6f20 6469 6374  /address to dict
-0003c890: 696f 6e61 7279 206f 6620 696e 666f 726d  ionary of inform
-0003c8a0: 6174 696f 6e20 6162 6f75 740a 2020 2020  ation about.    
-0003c8b0: 2020 2020 7468 6174 2077 6f72 6b65 7220      that worker 
-0003c8c0: 666f 7220 6561 6368 2072 6574 6972 6564  for each retired
-0003c8d0: 2077 6f72 6b65 722e 0a0a 2020 2020 2020   worker...      
-0003c8e0: 2020 4966 2074 6865 7265 2061 7265 206b    If there are k
-0003c8f0: 6579 7320 7468 6174 2065 7869 7374 2069  eys that exist i
-0003c900: 6e20 6d65 6d6f 7279 206f 6e6c 7920 6f6e  n memory only on
-0003c910: 2074 6865 2077 6f72 6b65 7273 2062 6569   the workers bei
-0003c920: 6e67 2072 6574 6972 6564 2061 6e64 2069  ng retired and i
-0003c930: 740a 2020 2020 2020 2020 7761 7320 696d  t.        was im
-0003c940: 706f 7373 6962 6c65 2074 6f20 7265 706c  possible to repl
-0003c950: 6963 6174 6520 7468 656d 2073 6f6d 6577  icate them somew
-0003c960: 6865 7265 2065 6c73 6520 2865 2e67 2e20  here else (e.g. 
-0003c970: 6265 6361 7573 6520 7468 6572 6520 6172  because there ar
-0003c980: 656e 2774 0a20 2020 2020 2020 2061 6e79  en't.        any
-0003c990: 206f 7468 6572 2072 756e 6e69 6e67 2077   other running w
-0003c9a0: 6f72 6b65 7273 292c 2074 6865 2077 6f72  orkers), the wor
-0003c9b0: 6b65 7273 2068 6f6c 6469 6e67 2073 7563  kers holding suc
-0003c9c0: 6820 6b65 7973 2077 6f6e 2774 2062 6520  h keys won't be 
-0003c9d0: 7265 7469 7265 6420 616e 640a 2020 2020  retired and.    
-0003c9e0: 2020 2020 776f 6e27 7420 6170 7065 6172      won't appear
-0003c9f0: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
-0003ca00: 2064 6963 742e 0a0a 2020 2020 2020 2020   dict...        
-0003ca10: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
-0003ca20: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-0003ca30: 2020 5363 6865 6475 6c65 722e 776f 726b    Scheduler.work
-0003ca40: 6572 735f 746f 5f63 6c6f 7365 0a20 2020  ers_to_close.   
-0003ca50: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0003ca60: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
-0003ca70: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
-0003ca80: 7265 7469 7265 2d77 6f72 6b65 7273 2d7b  retire-workers-{
-0003ca90: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
-0003caa0: 2023 2054 6869 7320 6c6f 636b 206d 616b   # This lock mak
-0003cab0: 6573 2072 6574 6972 655f 776f 726b 6572  es retire_worker
-0003cac0: 732c 2072 6562 616c 616e 6365 2c20 616e  s, rebalance, an
-0003cad0: 6420 7265 706c 6963 6174 6520 6d75 7475  d replicate mutu
-0003cae0: 616c 6c79 0a20 2020 2020 2020 2023 2065  ally.        # e
-0003caf0: 7863 6c75 7369 7665 2061 6e64 2077 696c  xclusive and wil
-0003cb00: 6c20 6e6f 206c 6f6e 6765 7220 6265 206e  l no longer be n
-0003cb10: 6563 6573 7361 7279 206f 6e63 6520 7265  ecessary once re
-0003cb20: 6261 6c61 6e63 6520 616e 6420 7265 706c  balance and repl
-0003cb30: 6963 6174 6520 6172 650a 2020 2020 2020  icate are.      
-0003cb40: 2020 2320 6d69 6772 6174 6564 2074 6f20    # migrated to 
-0003cb50: 7468 6520 4163 7469 7665 204d 656d 6f72  the Active Memor
-0003cb60: 7920 4d61 6e61 6765 722e 0a20 2020 2020  y Manager..     
-0003cb70: 2020 2023 204e 6f74 6520 7468 6174 2c20     # Note that, 
-0003cb80: 696e 6369 6465 6e74 616c 6c79 2c20 6974  incidentally, it
-0003cb90: 2061 6c73 6f20 7072 6576 656e 7473 206d   also prevents m
-0003cba0: 756c 7469 706c 6520 6361 6c6c 7320 746f  ultiple calls to
-0003cbb0: 2072 6574 6972 655f 776f 726b 6572 730a   retire_workers.
-0003cbc0: 2020 2020 2020 2020 2320 6672 6f6d 2072          # from r
-0003cbd0: 756e 6e69 6e67 2069 6e20 7061 7261 6c6c  unning in parall
-0003cbe0: 656c 202d 2074 6869 7320 6973 2075 6e6e  el - this is unn
-0003cbf0: 6563 6573 7361 7279 2e0a 2020 2020 2020  ecessary..      
-0003cc00: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
-0003cc10: 662e 5f6c 6f63 6b3a 0a20 2020 2020 2020  f._lock:.       
-0003cc20: 2020 2020 2069 6620 6e61 6d65 7320 6973       if names is
-0003cc30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0003cc40: 2020 2020 2020 2020 2020 2069 6620 776f             if wo
-0003cc50: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
-0003cc60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003cc70: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
-0003cc80: 6545 7272 6f72 2822 6e61 6d65 7320 616e  eError("names an
-0003cc90: 6420 776f 726b 6572 7320 6172 6520 6d75  d workers are mu
-0003cca0: 7475 616c 6c79 2065 7863 6c75 7369 7665  tually exclusive
-0003ccb0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0003ccc0: 2020 2069 6620 6e61 6d65 733a 0a20 2020     if names:.   
-0003ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cce0: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
-0003ccf0: 7469 7265 2077 6f72 6b65 7220 6e61 6d65  tire worker name
-0003cd00: 7320 2573 222c 206e 616d 6573 290a 2020  s %s", names).  
-0003cd10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003cd20: 5375 7070 6f72 7420 6361 7365 7320 7768  Support cases wh
-0003cd30: 6572 6520 6e61 6d65 7320 6172 6520 7061  ere names are pa
-0003cd40: 7373 6564 2074 6872 6f75 6768 2061 2043  ssed through a C
-0003cd50: 4c49 2061 6e64 2062 6563 6f6d 650a 2020  LI and become.  
-0003cd60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003cd70: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
-0003cd80: 2020 2020 2020 2020 6e61 6d65 735f 7365          names_se
-0003cd90: 7420 3d20 7b73 7472 286e 616d 6529 2066  t = {str(name) f
-0003cda0: 6f72 206e 616d 6520 696e 206e 616d 6573  or name in names
-0003cdb0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003cdc0: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
-0003cdd0: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
-0003cde0: 7273 2e76 616c 7565 7328 2920 6966 2073  rs.values() if s
-0003cdf0: 7472 2877 732e 6e61 6d65 2920 696e 206e  tr(ws.name) in n
-0003ce00: 616d 6573 5f73 6574 7d0a 2020 2020 2020  ames_set}.      
-0003ce10: 2020 2020 2020 656c 6966 2077 6f72 6b65        elif worke
-0003ce20: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
-0003ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce40: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
-0003ce50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003ce60: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
-0003ce70: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003ce80: 2020 2020 2020 666f 7220 6164 6472 6573        for addres
-0003ce90: 7320 696e 2077 6f72 6b65 7273 0a20 2020  s in workers.   
-0003cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ceb0: 2069 6620 6164 6472 6573 7320 696e 2073   if address in s
-0003cec0: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
-0003ced0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0003cee0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0003cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cf00: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
-0003cf10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003cf20: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
-0003cf30: 5d20 666f 7220 6164 6472 6573 7320 696e  ] for address in
-0003cf40: 2073 656c 662e 776f 726b 6572 735f 746f   self.workers_to
-0003cf50: 5f63 6c6f 7365 282a 2a6b 7761 7267 7329  _close(**kwargs)
-0003cf60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003cf70: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
-0003cf80: 6620 6e6f 7420 7773 733a 0a20 2020 2020  f not wss:.     
-0003cf90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003cfa0: 6e20 7b7d 0a0a 2020 2020 2020 2020 2020  n {}..          
-0003cfb0: 2020 7374 6f70 5f61 6d6d 203d 2046 616c    stop_amm = Fal
-0003cfc0: 7365 0a20 2020 2020 2020 2020 2020 2061  se.            a
-0003cfd0: 6d6d 3a20 4163 7469 7665 4d65 6d6f 7279  mm: ActiveMemory
-0003cfe0: 4d61 6e61 6765 7245 7874 656e 7369 6f6e  ManagerExtension
-0003cff0: 203d 2073 656c 662e 6578 7465 6e73 696f   = self.extensio
-0003d000: 6e73 5b22 616d 6d22 5d0a 2020 2020 2020  ns["amm"].      
-0003d010: 2020 2020 2020 6966 206e 6f74 2061 6d6d        if not amm
-0003d020: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-0003d030: 2020 2020 2020 2020 2020 616d 6d20 3d20            amm = 
-0003d040: 4163 7469 7665 4d65 6d6f 7279 4d61 6e61  ActiveMemoryMana
-0003d050: 6765 7245 7874 656e 7369 6f6e 280a 2020  gerExtension(.  
-0003d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d070: 2020 7365 6c66 2c20 706f 6c69 6369 6573    self, policies
-0003d080: 3d73 6574 2829 2c20 7265 6769 7374 6572  =set(), register
-0003d090: 3d46 616c 7365 2c20 7374 6172 743d 5472  =False, start=Tr
-0003d0a0: 7565 2c20 696e 7465 7276 616c 3d32 2e30  ue, interval=2.0
-0003d0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d0c0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0003d0d0: 2020 2073 746f 705f 616d 6d20 3d20 5472     stop_amm = Tr
-0003d0e0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-0003d0f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0003d100: 2020 2020 2063 6f72 6f73 203d 205b 5d0a       coros = [].
-0003d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d120: 666f 7220 7773 2069 6e20 7773 733a 0a20  for ws in wss:. 
-0003d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d140: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-0003d150: 5265 7469 7269 6e67 2077 6f72 6b65 7220  Retiring worker 
-0003d160: 2573 222c 2077 732e 6164 6472 6573 7329  %s", ws.address)
-0003d170: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003d180: 2020 2020 2020 706f 6c69 6379 203d 2052        policy = R
-0003d190: 6574 6972 6557 6f72 6b65 7228 7773 2e61  etireWorker(ws.a
-0003d1a0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
-0003d1b0: 2020 2020 2020 2020 2020 2020 616d 6d2e              amm.
-0003d1c0: 6164 645f 706f 6c69 6379 2870 6f6c 6963  add_policy(polic
-0003d1d0: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
-0003d1e0: 2020 2020 2020 2020 2320 4368 616e 6765          # Change
-0003d1f0: 2057 6f72 6b65 722e 7374 6174 7573 2074   Worker.status t
-0003d200: 6f20 636c 6f73 696e 675f 6772 6163 6566  o closing_gracef
-0003d210: 756c 6c79 2e20 496d 6d65 6469 6174 656c  ully. Immediatel
-0003d220: 7920 7365 740a 2020 2020 2020 2020 2020  y set.          
-0003d230: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
-0003d240: 7361 6d65 206f 6e20 7468 6520 7363 6865  same on the sche
-0003d250: 6475 6c65 7220 746f 2070 7265 7665 6e74  duler to prevent
-0003d260: 2072 6163 6520 636f 6e64 6974 696f 6e73   race conditions
-0003d270: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003d280: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
-0003d290: 7320 3d20 7773 2e73 7461 7475 730a 2020  s = ws.status.  
-0003d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d2b0: 2020 7365 6c66 2e68 616e 646c 655f 776f    self.handle_wo
-0003d2c0: 726b 6572 5f73 7461 7475 735f 6368 616e  rker_status_chan
-0003d2d0: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-0003d2e0: 2020 2020 2020 2020 2020 2020 5374 6174              Stat
-0003d2f0: 7573 2e63 6c6f 7369 6e67 5f67 7261 6365  us.closing_grace
-0003d300: 6675 6c6c 792c 2077 732c 2073 7469 6d75  fully, ws, stimu
-0003d310: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
-0003d320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0003d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d340: 2023 2046 4958 4d45 3a20 5765 2073 686f   # FIXME: We sho
-0003d350: 756c 6420 7365 6e64 2061 206d 6573 7361  uld send a messa
-0003d360: 6765 2074 6f20 7468 6520 6e61 6e6e 7920  ge to the nanny 
-0003d370: 6669 7273 743b 0a20 2020 2020 2020 2020  first;.         
-0003d380: 2020 2020 2020 2020 2020 2023 2065 7665             # eve
-0003d390: 6e74 7561 6c6c 7920 776f 726b 6572 7320  ntually workers 
-0003d3a0: 776f 6e27 7420 6265 2061 626c 6520 746f  won't be able to
-0003d3b0: 2063 6c6f 7365 2074 6865 6972 206f 776e   close their own
-0003d3c0: 206e 616e 6e69 6573 2e0a 2020 2020 2020   nannies..      
-0003d3d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003d3e0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-0003d3f0: 7773 2e61 6464 7265 7373 5d2e 7365 6e64  ws.address].send
-0003d400: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003d410: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0003d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d430: 2020 2020 2020 2020 226f 7022 3a20 2277          "op": "w
-0003d440: 6f72 6b65 722d 7374 6174 7573 2d63 6861  orker-status-cha
-0003d450: 6e67 6522 2c0a 2020 2020 2020 2020 2020  nge",.          
-0003d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d470: 2020 2273 7461 7475 7322 3a20 7773 2e73    "status": ws.s
-0003d480: 7461 7475 732e 6e61 6d65 2c0a 2020 2020  tatus.name,.    
-0003d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4a0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-0003d4b0: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-0003d4c0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0003d4d0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0003d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4f0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0003d500: 2020 2020 2020 2020 2063 6f72 6f73 2e61           coros.a
-0003d510: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-0003d520: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0003d530: 656c 662e 5f74 7261 636b 5f72 6574 6972  elf._track_retir
-0003d540: 655f 776f 726b 6572 280a 2020 2020 2020  e_worker(.      
-0003d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d560: 2020 2020 2020 7773 2c0a 2020 2020 2020        ws,.      
-0003d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d580: 2020 2020 2020 706f 6c69 6379 2c0a 2020        policy,.  
-0003d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d5a0: 2020 2020 2020 2020 2020 7072 6576 5f73            prev_s
-0003d5b0: 7461 7475 733d 7072 6576 5f73 7461 7475  tatus=prev_statu
-0003d5c0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0003d5d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0003d5e0: 6c6f 7365 3d63 6c6f 7365 5f77 6f72 6b65  lose=close_worke
-0003d5f0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-0003d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d610: 7265 6d6f 7665 3d72 656d 6f76 652c 0a20  remove=remove,. 
-0003d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d630: 2020 2020 2020 2020 2020 2073 7469 6d75             stimu
-0003d640: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-0003d650: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0003d660: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d680: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0003d690: 2020 2020 2023 2047 6976 6520 7468 6520       # Give the 
-0003d6a0: 414d 4d20 6120 6b69 636b 2c20 696e 2061  AMM a kick, in a
-0003d6b0: 6464 6974 696f 6e20 746f 2069 7473 2070  ddition to its p
-0003d6c0: 6572 696f 6469 6320 7275 6e6e 696e 672e  eriodic running.
-0003d6d0: 2054 6869 7320 6973 0a20 2020 2020 2020   This is.       
-0003d6e0: 2020 2020 2020 2020 2023 2074 6f20 6176           # to av
-0003d6f0: 6f69 6420 756e 6e65 6365 7373 6172 696c  oid unnecessaril
-0003d700: 7920 7761 6974 696e 6720 666f 7220 6120  y waiting for a 
-0003d710: 706f 7465 6e74 6961 6c6c 7920 6172 6269  potentially arbi
-0003d720: 7472 6172 696c 7920 6c6f 6e67 0a20 2020  trarily long.   
-0003d730: 2020 2020 2020 2020 2020 2020 2023 2074               # t
-0003d740: 696d 6520 2864 6570 656e 6469 6e67 206f  ime (depending o
-0003d750: 6e20 696e 7465 7276 616c 2073 6574 7469  n interval setti
-0003d760: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
-0003d770: 2020 2020 2061 6d6d 2e72 756e 5f6f 6e63       amm.run_onc
-0003d780: 6528 290a 0a20 2020 2020 2020 2020 2020  e()..           
-0003d790: 2020 2020 2077 6f72 6b65 7273 5f69 6e66       workers_inf
-0003d7a0: 6f20 3d20 6469 6374 2861 7761 6974 2061  o = dict(await a
-0003d7b0: 7379 6e63 696f 2e67 6174 6865 7228 2a63  syncio.gather(*c
-0003d7c0: 6f72 6f73 2929 0a20 2020 2020 2020 2020  oros)).         
-0003d7d0: 2020 2020 2020 2077 6f72 6b65 7273 5f69         workers_i
-0003d7e0: 6e66 6f2e 706f 7028 4e6f 6e65 2c20 4e6f  nfo.pop(None, No
-0003d7f0: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-0003d800: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
-0003d810: 2020 2020 2020 2020 2069 6620 7374 6f70           if stop
-0003d820: 5f61 6d6d 3a0a 2020 2020 2020 2020 2020  _amm:.          
-0003d830: 2020 2020 2020 2020 2020 616d 6d2e 7374            amm.st
-0003d840: 6f70 2829 0a0a 2020 2020 2020 2020 7365  op()..        se
-0003d850: 6c66 2e6c 6f67 5f65 7665 6e74 2822 616c  lf.log_event("al
-0003d860: 6c22 2c20 7b22 6163 7469 6f6e 223a 2022  l", {"action": "
-0003d870: 7265 7469 7265 2d77 6f72 6b65 7273 222c  retire-workers",
-0003d880: 2022 776f 726b 6572 7322 3a20 776f 726b   "workers": work
-0003d890: 6572 735f 696e 666f 7d29 0a20 2020 2020  ers_info}).     
-0003d8a0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-0003d8b0: 7428 6c69 7374 2877 6f72 6b65 7273 5f69  t(list(workers_i
-0003d8c0: 6e66 6f29 2c20 7b22 6163 7469 6f6e 223a  nfo), {"action":
-0003d8d0: 2022 7265 7469 7265 6422 7d29 0a0a 2020   "retired"})..  
-0003d8e0: 2020 2020 2020 7265 7475 726e 2077 6f72        return wor
-0003d8f0: 6b65 7273 5f69 6e66 6f0a 0a20 2020 2061  kers_info..    a
-0003d900: 7379 6e63 2064 6566 205f 7472 6163 6b5f  sync def _track_
-0003d910: 7265 7469 7265 5f77 6f72 6b65 7228 0a20  retire_worker(. 
-0003d920: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0003d930: 2020 2020 2077 733a 2057 6f72 6b65 7253       ws: WorkerS
-0003d940: 7461 7465 2c0a 2020 2020 2020 2020 706f  tate,.        po
-0003d950: 6c69 6379 3a20 5265 7469 7265 576f 726b  licy: RetireWork
-0003d960: 6572 2c0a 2020 2020 2020 2020 7072 6576  er,.        prev
-0003d970: 5f73 7461 7475 733a 2053 7461 7475 732c  _status: Status,
-0003d980: 0a20 2020 2020 2020 2063 6c6f 7365 3a20  .        close: 
-0003d990: 626f 6f6c 2c0a 2020 2020 2020 2020 7265  bool,.        re
-0003d9a0: 6d6f 7665 3a20 626f 6f6c 2c0a 2020 2020  move: bool,.    
-0003d9b0: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
-0003d9c0: 2073 7472 2c0a 2020 2020 2920 2d3e 2074   str,.    ) -> t
-0003d9d0: 7570 6c65 3a20 2023 2074 7570 6c65 5b73  uple:  # tuple[s
-0003d9e0: 7472 207c 204e 6f6e 652c 2064 6963 745d  tr | None, dict]
-0003d9f0: 0a20 2020 2020 2020 2077 6869 6c65 206e  .        while n
-0003da00: 6f74 2070 6f6c 6963 792e 646f 6e65 2829  ot policy.done()
-0003da10: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0003da20: 536c 6565 7020 302e 3031 7320 7768 656e  Sleep 0.01s when
-0003da30: 2074 6865 7265 2061 7265 2034 2074 6173   there are 4 tas
-0003da40: 6b73 206f 7220 6c65 7373 0a20 2020 2020  ks or less.     
-0003da50: 2020 2020 2020 2023 2053 6c65 6570 2030         # Sleep 0
-0003da60: 2e35 7320 7768 656e 2074 6865 7265 2061  .5s when there a
-0003da70: 7265 2032 3030 206f 7220 6d6f 7265 0a20  re 200 or more. 
-0003da80: 2020 2020 2020 2020 2020 2070 6f6c 6c5f             poll_
-0003da90: 696e 7465 7276 616c 203d 206d 6178 2830  interval = max(0
-0003daa0: 2e30 312c 206d 696e 2830 2e35 2c20 6c65  .01, min(0.5, le
-0003dab0: 6e28 7773 2e68 6173 5f77 6861 7429 202f  n(ws.has_what) /
-0003dac0: 2034 3030 2929 0a20 2020 2020 2020 2020   400)).         
-0003dad0: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-0003dae0: 2e73 6c65 6570 2870 6f6c 6c5f 696e 7465  .sleep(poll_inte
-0003daf0: 7276 616c 290a 0a20 2020 2020 2020 2069  rval)..        i
-0003db00: 6620 706f 6c69 6379 2e6e 6f5f 7265 6369  f policy.no_reci
-0003db10: 7069 656e 7473 3a0a 2020 2020 2020 2020  pients:.        
-0003db20: 2020 2020 2320 4162 6f72 7420 7265 7469      # Abort reti
-0003db30: 7265 6d65 6e74 2e20 5468 6973 2074 696d  rement. This tim
-0003db40: 6520 7765 2064 6f6e 2774 206e 6565 6420  e we don't need 
-0003db50: 746f 2077 6f72 7279 2061 626f 7574 2072  to worry about r
-0003db60: 6163 650a 2020 2020 2020 2020 2020 2020  ace.            
-0003db70: 2320 636f 6e64 6974 696f 6e73 2061 6e64  # conditions and
-0003db80: 2077 6520 6361 6e20 7761 6974 2066 6f72   we can wait for
-0003db90: 2061 2073 6368 6564 756c 6572 2d3e 776f   a scheduler->wo
-0003dba0: 726b 6572 2d3e 7363 6865 6475 6c65 720a  rker->scheduler.
-0003dbb0: 2020 2020 2020 2020 2020 2020 2320 726f              # ro
-0003dbc0: 756e 642d 7472 6970 2e0a 2020 2020 2020  und-trip..      
-0003dbd0: 2020 2020 2020 7365 6c66 2e73 7472 6561        self.strea
-0003dbe0: 6d5f 636f 6d6d 735b 7773 2e61 6464 7265  m_comms[ws.addre
-0003dbf0: 7373 5d2e 7365 6e64 280a 2020 2020 2020  ss].send(.      
-0003dc00: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0003dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dc20: 226f 7022 3a20 2277 6f72 6b65 722d 7374  "op": "worker-st
-0003dc30: 6174 7573 2d63 6861 6e67 6522 2c0a 2020  atus-change",.  
-0003dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dc50: 2020 2273 7461 7475 7322 3a20 7072 6576    "status": prev
-0003dc60: 5f73 7461 7475 732e 6e61 6d65 2c0a 2020  _status.name,.  
-0003dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dc80: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-0003dc90: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-0003dca0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0003dcb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003dcc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0003dcd0: 204e 6f6e 652c 207b 7d0a 0a20 2020 2020   None, {}..     
-0003dce0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0003dcf0: 0a20 2020 2020 2020 2020 2020 2022 416c  .            "Al
-0003dd00: 6c20 756e 6971 7565 206b 6579 7320 6f6e  l unique keys on
-0003dd10: 2077 6f72 6b65 7220 2573 2068 6176 6520   worker %s have 
-0003dd20: 6265 656e 2072 6570 6c69 6361 7465 6420  been replicated 
-0003dd30: 656c 7365 7768 6572 6522 2c20 7773 2e61  elsewhere", ws.a
-0003dd40: 6464 7265 7373 0a20 2020 2020 2020 2029  ddress.        )
-0003dd50: 0a0a 2020 2020 2020 2020 6966 2072 656d  ..        if rem
-0003dd60: 6f76 653a 0a20 2020 2020 2020 2020 2020  ove:.           
-0003dd70: 2061 7761 6974 2073 656c 662e 7265 6d6f   await self.remo
-0003dd80: 7665 5f77 6f72 6b65 7228 0a20 2020 2020  ve_worker(.     
-0003dd90: 2020 2020 2020 2020 2020 2077 732e 6164             ws.ad
-0003dda0: 6472 6573 732c 2073 6166 653d 5472 7565  dress, safe=True
-0003ddb0: 2c20 636c 6f73 653d 636c 6f73 652c 2073  , close=close, s
-0003ddc0: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-0003ddd0: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
-0003dde0: 2020 2029 0a20 2020 2020 2020 2065 6c69     ).        eli
-0003ddf0: 6620 636c 6f73 653a 0a20 2020 2020 2020  f close:.       
-0003de00: 2020 2020 2073 656c 662e 636c 6f73 655f       self.close_
-0003de10: 776f 726b 6572 2877 732e 6164 6472 6573  worker(ws.addres
-0003de20: 7329 0a0a 2020 2020 2020 2020 6c6f 6767  s)..        logg
-0003de30: 6572 2e69 6e66 6f28 2252 6574 6972 6564  er.info("Retired
-0003de40: 2077 6f72 6b65 7220 2573 222c 2077 732e   worker %s", ws.
-0003de50: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-0003de60: 2072 6574 7572 6e20 7773 2e61 6464 7265   return ws.addre
-0003de70: 7373 2c20 7773 2e69 6465 6e74 6974 7928  ss, ws.identity(
-0003de80: 290a 0a20 2020 2064 6566 2061 6464 5f6b  )..    def add_k
-0003de90: 6579 7328 0a20 2020 2020 2020 2073 656c  eys(.        sel
-0003dea0: 662c 2077 6f72 6b65 723a 2073 7472 2c20  f, worker: str, 
-0003deb0: 6b65 7973 3a20 436f 6c6c 6563 7469 6f6e  keys: Collection
-0003dec0: 5b73 7472 5d20 3d20 2829 2c20 7374 696d  [str] = (), stim
-0003ded0: 756c 7573 5f69 643a 2073 7472 207c 204e  ulus_id: str | N
-0003dee0: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-0003def0: 202d 3e20 4c69 7465 7261 6c5b 224f 4b22   -> Literal["OK"
-0003df00: 2c20 226e 6f74 2066 6f75 6e64 225d 3a0a  , "not found"]:.
-0003df10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0003df20: 2020 2020 4c65 6172 6e20 7468 6174 2061      Learn that a
-0003df30: 2077 6f72 6b65 7220 6861 7320 6365 7274   worker has cert
-0003df40: 6169 6e20 6b65 7973 0a0a 2020 2020 2020  ain keys..      
-0003df50: 2020 5468 6973 2073 686f 756c 6420 6e6f    This should no
-0003df60: 7420 6265 2075 7365 6420 696e 2070 7261  t be used in pra
-0003df70: 6374 6963 6520 616e 6420 6973 206d 6f73  ctice and is mos
-0003df80: 746c 7920 6865 7265 2066 6f72 206c 6567  tly here for leg
-0003df90: 6163 790a 2020 2020 2020 2020 7265 6173  acy.        reas
-0003dfa0: 6f6e 732e 2020 486f 7765 7665 722c 2069  ons.  However, i
-0003dfb0: 7420 6973 2073 656e 7420 6279 2077 6f72  t is sent by wor
-0003dfc0: 6b65 7273 2066 726f 6d20 7469 6d65 2074  kers from time t
-0003dfd0: 6f20 7469 6d65 2e0a 2020 2020 2020 2020  o time..        
-0003dfe0: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
-0003dff0: 6f72 6b65 7220 6e6f 7420 696e 2073 656c  orker not in sel
-0003e000: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
-0003e010: 2020 2020 2020 2072 6574 7572 6e20 226e         return "n
-0003e020: 6f74 2066 6f75 6e64 220a 2020 2020 2020  ot found".      
-0003e030: 2020 7773 3a20 576f 726b 6572 5374 6174    ws: WorkerStat
-0003e040: 6520 3d20 7365 6c66 2e77 6f72 6b65 7273  e = self.workers
-0003e050: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
-0003e060: 2072 6564 756e 6461 6e74 5f72 6570 6c69   redundant_repli
-0003e070: 6361 7320 3d20 5b5d 0a20 2020 2020 2020  cas = [].       
-0003e080: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
-0003e090: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-0003e0a0: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-0003e0b0: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
-0003e0c0: 2020 2069 6620 7473 2069 7320 6e6f 7420     if ts is not 
-0003e0d0: 4e6f 6e65 2061 6e64 2074 732e 7374 6174  None and ts.stat
-0003e0e0: 6520 3d3d 2022 6d65 6d6f 7279 223a 0a20  e == "memory":. 
-0003e0f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003e100: 6620 7773 206e 6f74 2069 6e20 7473 2e77  f ws not in ts.w
-0003e110: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-0003e120: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003e130: 2e61 6464 5f72 6570 6c69 6361 2874 732c  .add_replica(ts,
-0003e140: 2077 7329 0a20 2020 2020 2020 2020 2020   ws).           
-0003e150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003e160: 2020 2020 2020 2072 6564 756e 6461 6e74         redundant
-0003e170: 5f72 6570 6c69 6361 732e 6170 7065 6e64  _replicas.append
-0003e180: 286b 6579 290a 0a20 2020 2020 2020 2069  (key)..        i
-0003e190: 6620 7265 6475 6e64 616e 745f 7265 706c  f redundant_repl
-0003e1a0: 6963 6173 3a0a 2020 2020 2020 2020 2020  icas:.          
-0003e1b0: 2020 6966 206e 6f74 2073 7469 6d75 6c75    if not stimulu
-0003e1c0: 735f 6964 3a0a 2020 2020 2020 2020 2020  s_id:.          
-0003e1d0: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-0003e1e0: 6420 3d20 6622 7265 6475 6e64 616e 742d  d = f"redundant-
-0003e1f0: 7265 706c 6963 6173 2d7b 7469 6d65 2829  replicas-{time()
-0003e200: 7d22 0a20 2020 2020 2020 2020 2020 2073  }".            s
-0003e210: 656c 662e 776f 726b 6572 5f73 656e 6428  elf.worker_send(
-0003e220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e230: 2077 6f72 6b65 722c 0a20 2020 2020 2020   worker,.       
-0003e240: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0003e250: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003e260: 6f70 223a 2022 7265 6d6f 7665 2d72 6570  op": "remove-rep
-0003e270: 6c69 6361 7322 2c0a 2020 2020 2020 2020  licas",.        
-0003e280: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-0003e290: 7322 3a20 7265 6475 6e64 616e 745f 7265  s": redundant_re
-0003e2a0: 706c 6963 6173 2c0a 2020 2020 2020 2020  plicas,.        
-0003e2b0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0003e2c0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-0003e2d0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-0003e2e0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0003e2f0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0003e300: 2020 7265 7475 726e 2022 4f4b 220a 0a20    return "OK".. 
-0003e310: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-0003e320: 2020 2064 6566 2075 7064 6174 655f 6461     def update_da
-0003e330: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
-0003e340: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-0003e350: 2020 2020 2077 686f 5f68 6173 3a20 6469       who_has: di
-0003e360: 6374 5b73 7472 2c20 6c69 7374 5b73 7472  ct[str, list[str
-0003e370: 5d5d 2c0a 2020 2020 2020 2020 6e62 7974  ]],.        nbyt
-0003e380: 6573 3a20 6469 6374 5b73 7472 2c20 696e  es: dict[str, in
-0003e390: 745d 2c0a 2020 2020 2020 2020 636c 6965  t],.        clie
-0003e3a0: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
-0003e3b0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-0003e3c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0003e3d0: 224c 6561 726e 2074 6861 7420 6e65 7720  "Learn that new 
-0003e3e0: 6461 7461 2068 6173 2065 6e74 6572 6564  data has entered
-0003e3f0: 2074 6865 206e 6574 776f 726b 2066 726f   the network fro
-0003e400: 6d20 616e 2065 7874 6572 6e61 6c20 736f  m an external so
-0003e410: 7572 6365 2222 220a 2020 2020 2020 2020  urce""".        
-0003e420: 7768 6f5f 6861 7320 3d20 7b6b 3a20 5b73  who_has = {k: [s
-0003e430: 656c 662e 636f 6572 6365 5f61 6464 7265  elf.coerce_addre
-0003e440: 7373 2876 7629 2066 6f72 2076 7620 696e  ss(vv) for vv in
-0003e450: 2076 5d20 666f 7220 6b2c 2076 2069 6e20   v] for k, v in 
-0003e460: 7768 6f5f 6861 732e 6974 656d 7328 297d  who_has.items()}
-0003e470: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0003e480: 6465 6275 6728 2255 7064 6174 6520 6461  debug("Update da
-0003e490: 7461 2025 7322 2c20 7768 6f5f 6861 7329  ta %s", who_has)
-0003e4a0: 0a0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
-0003e4b0: 792c 2077 6f72 6b65 7273 2069 6e20 7768  y, workers in wh
-0003e4c0: 6f5f 6861 732e 6974 656d 7328 293a 0a20  o_has.items():. 
-0003e4d0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-0003e4e0: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
-0003e4f0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0003e500: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
-0003e510: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003e520: 7320 3d20 7365 6c66 2e6e 6577 5f74 6173  s = self.new_tas
-0003e530: 6b28 6b65 792c 204e 6f6e 652c 2022 6d65  k(key, None, "me
-0003e540: 6d6f 7279 2229 0a20 2020 2020 2020 2020  mory").         
-0003e550: 2020 2074 732e 7374 6174 6520 3d20 226d     ts.state = "m
-0003e560: 656d 6f72 7922 0a20 2020 2020 2020 2020  emory".         
-0003e570: 2020 2074 735f 6e62 7974 6573 203d 206e     ts_nbytes = n
-0003e580: 6279 7465 732e 6765 7428 6b65 792c 202d  bytes.get(key, -
-0003e590: 3129 0a20 2020 2020 2020 2020 2020 2069  1).            i
-0003e5a0: 6620 7473 5f6e 6279 7465 7320 3e3d 2030  f ts_nbytes >= 0
-0003e5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e5c0: 2020 7473 2e73 6574 5f6e 6279 7465 7328    ts.set_nbytes(
-0003e5d0: 7473 5f6e 6279 7465 7329 0a0a 2020 2020  ts_nbytes)..    
-0003e5e0: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
-0003e5f0: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
-0003e600: 2020 2020 2020 2020 2020 7773 203d 2073            ws = s
-0003e610: 656c 662e 776f 726b 6572 735b 775d 0a20  elf.workers[w]. 
-0003e620: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003e630: 6620 7773 206e 6f74 2069 6e20 7473 2e77  f ws not in ts.w
-0003e640: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-0003e650: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003e660: 2e61 6464 5f72 6570 6c69 6361 2874 732c  .add_replica(ts,
-0003e670: 2077 7329 0a20 2020 2020 2020 2020 2020   ws).           
-0003e680: 2073 656c 662e 7265 706f 7274 287b 226f   self.report({"o
-0003e690: 7022 3a20 226b 6579 2d69 6e2d 6d65 6d6f  p": "key-in-memo
-0003e6a0: 7279 222c 2022 6b65 7922 3a20 6b65 792c  ry", "key": key,
-0003e6b0: 2022 776f 726b 6572 7322 3a20 6c69 7374   "workers": list
-0003e6c0: 2877 6f72 6b65 7273 297d 290a 0a20 2020  (workers)})..   
-0003e6d0: 2020 2020 2069 6620 636c 6965 6e74 3a0a       if client:.
-0003e6e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003e6f0: 2e63 6c69 656e 745f 6465 7369 7265 735f  .client_desires_
-0003e700: 6b65 7973 286b 6579 733d 6c69 7374 2877  keys(keys=list(w
-0003e710: 686f 5f68 6173 292c 2063 6c69 656e 743d  ho_has), client=
-0003e720: 636c 6965 6e74 290a 0a20 2020 2040 6f76  client)..    @ov
-0003e730: 6572 6c6f 6164 0a20 2020 2064 6566 2072  erload.    def r
-0003e740: 6570 6f72 745f 6f6e 5f6b 6579 2873 656c  eport_on_key(sel
-0003e750: 662c 206b 6579 3a20 7374 722c 202a 2c20  f, key: str, *, 
-0003e760: 636c 6965 6e74 3a20 7374 7220 7c20 4e6f  client: str | No
-0003e770: 6e65 203d 204e 6f6e 6529 202d 3e20 4e6f  ne = None) -> No
-0003e780: 6e65 3a0a 2020 2020 2020 2020 2e2e 2e0a  ne:.        ....
-0003e790: 0a20 2020 2040 6f76 6572 6c6f 6164 0a20  .    @overload. 
-0003e7a0: 2020 2064 6566 2072 6570 6f72 745f 6f6e     def report_on
-0003e7b0: 5f6b 6579 2873 656c 662c 202a 2c20 7473  _key(self, *, ts
-0003e7c0: 3a20 5461 736b 5374 6174 652c 2063 6c69  : TaskState, cli
-0003e7d0: 656e 743a 2073 7472 207c 204e 6f6e 6520  ent: str | None 
-0003e7e0: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
-0003e7f0: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
-0003e800: 2020 6465 6620 7265 706f 7274 5f6f 6e5f    def report_on_
-0003e810: 6b65 7928 7365 6c66 2c20 6b65 793d 4e6f  key(self, key=No
-0003e820: 6e65 2c20 2a2c 2074 733d 4e6f 6e65 2c20  ne, *, ts=None, 
-0003e830: 636c 6965 6e74 3d4e 6f6e 6529 3a0a 2020  client=None):.  
-0003e840: 2020 2020 2020 6966 2028 7473 2069 7320        if (ts is 
-0003e850: 4e6f 6e65 2920 3d3d 2028 6b65 7920 6973  None) == (key is
-0003e860: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
-0003e870: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0003e880: 7272 6f72 2820 2023 2070 7261 676d 613a  rror(  # pragma:
-0003e890: 206e 6f63 6f76 6572 0a20 2020 2020 2020   nocover.       
-0003e8a0: 2020 2020 2020 2020 2066 2274 7320 616e           f"ts an
-0003e8b0: 6420 6b65 7920 6172 6520 6d75 7475 616c  d key are mutual
-0003e8c0: 6c79 2065 7863 6c75 7369 7665 3b20 7265  ly exclusive; re
-0003e8d0: 6365 6976 6564 207b 6b65 793d 2172 7d2c  ceived {key=!r},
-0003e8e0: 207b 7473 3d21 727d 220a 2020 2020 2020   {ts=!r}".      
-0003e8f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003e900: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
-0003e910: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0003e920: 7420 6b65 7920 6973 206e 6f74 204e 6f6e  t key is not Non
-0003e930: 650a 2020 2020 2020 2020 2020 2020 7473  e.            ts
-0003e940: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-0003e950: 7428 6b65 7929 0a20 2020 2020 2020 2065  t(key).        e
-0003e960: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003e970: 206b 6579 203d 2074 732e 6b65 790a 0a20   key = ts.key.. 
-0003e980: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
-0003e990: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003e9a0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
-0003e9b0: 203d 205f 7461 736b 5f74 6f5f 7265 706f   = _task_to_repo
-0003e9c0: 7274 5f6d 7367 2874 7329 0a20 2020 2020  rt_msg(ts).     
-0003e9d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003e9e0: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
-0003e9f0: 3d20 7b22 6f70 223a 2022 6361 6e63 656c  = {"op": "cancel
-0003ea00: 6c65 642d 6b65 7973 222c 2022 6b65 7973  led-keys", "keys
-0003ea10: 223a 205b 6b65 795d 7d0a 2020 2020 2020  ": [key]}.      
-0003ea20: 2020 6966 2072 6570 6f72 745f 6d73 6720    if report_msg 
-0003ea30: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0003ea40: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0003ea50: 706f 7274 2872 6570 6f72 745f 6d73 672c  port(report_msg,
-0003ea60: 2074 733d 7473 2c20 636c 6965 6e74 3d63   ts=ts, client=c
-0003ea70: 6c69 656e 7429 0a0a 2020 2020 406c 6f67  lient)..    @log
-0003ea80: 5f65 7272 6f72 730a 2020 2020 6173 796e  _errors.    asyn
-0003ea90: 6320 6465 6620 6665 6564 280a 2020 2020  c def feed(.    
-0003eaa0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0003eab0: 2020 636f 6d6d 3a20 436f 6d6d 2c0a 2020    comm: Comm,.  
-0003eac0: 2020 2020 2020 6675 6e63 7469 6f6e 3a20        function: 
-0003ead0: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
-0003eae0: 6f6e 652c 0a20 2020 2020 2020 2073 6574  one,.        set
-0003eaf0: 7570 3a20 6279 7465 7320 7c20 4e6f 6e65  up: bytes | None
-0003eb00: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0003eb10: 2074 6561 7264 6f77 6e3a 2062 7974 6573   teardown: bytes
-0003eb20: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003eb30: 2020 2020 2020 2020 696e 7465 7276 616c          interval
-0003eb40: 3a20 7374 7220 7c20 666c 6f61 7420 3d20  : str | float = 
-0003eb50: 2231 7322 2c0a 2020 2020 2020 2020 2a2a  "1s",.        **
-0003eb60: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-0003eb70: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-0003eb80: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0003eb90: 5072 6f76 6964 6573 2061 2064 6174 6120  Provides a data 
-0003eba0: 436f 6d6d 2074 6f20 6578 7465 726e 616c  Comm to external
-0003ebb0: 2072 6571 7565 7374 6572 0a0a 2020 2020   requester..    
-0003ebc0: 2020 2020 4361 7574 696f 6e3a 2074 6869      Caution: thi
-0003ebd0: 7320 7275 6e73 2061 7262 6974 7261 7279  s runs arbitrary
-0003ebe0: 2050 7974 686f 6e20 636f 6465 206f 6e20   Python code on 
-0003ebf0: 7468 6520 7363 6865 6475 6c65 722e 2020  the scheduler.  
-0003ec00: 5468 6973 2073 686f 756c 640a 2020 2020  This should.    
-0003ec10: 2020 2020 6576 656e 7475 616c 6c79 2062      eventually b
-0003ec20: 6520 7068 6173 6564 206f 7574 2e20 2049  e phased out.  I
-0003ec30: 7420 6973 206d 6f73 746c 7920 7573 6564  t is mostly used
-0003ec40: 2062 7920 6469 6167 6e6f 7374 6963 732e   by diagnostics.
-0003ec50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0003ec60: 2020 2020 2069 6620 6e6f 7420 6461 736b       if not dask
-0003ec70: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0003ec80: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0003ec90: 6572 2e70 6963 6b6c 6522 293a 0a20 2020  er.pickle"):.   
-0003eca0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0003ecb0: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-0003ecc0: 2020 2020 2020 2020 2022 5472 6965 6420           "Tried 
-0003ecd0: 746f 2063 616c 6c20 2766 6565 6427 2072  to call 'feed' r
-0003ece0: 6f75 7465 2077 6974 6820 6375 7374 6f6d  oute with custom
-0003ecf0: 2066 756e 6374 696f 6e73 2c20 6275 7420   functions, but 
-0003ed00: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0003ed10: 2020 2270 6963 6b6c 6520 6973 2064 6973    "pickle is dis
-0003ed20: 616c 6c6f 7765 642e 2020 5365 7420 7468  allowed.  Set th
-0003ed30: 6520 2764 6973 7472 6962 7574 6564 2e73  e 'distributed.s
-0003ed40: 6368 6564 756c 6572 2e70 6963 6b6c 6527  cheduler.pickle'
-0003ed50: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0003ed60: 2020 2263 6f6e 6669 6720 7661 6c75 6520    "config value 
-0003ed70: 746f 2054 7275 6520 746f 2075 7365 2074  to True to use t
-0003ed80: 6865 2027 6665 6564 2720 726f 7574 6520  he 'feed' route 
-0003ed90: 2874 6869 7320 6973 206d 6f73 746c 7920  (this is mostly 
-0003eda0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0003edb0: 2020 2263 6f6d 6d6f 6e6c 7920 7573 6564    "commonly used
-0003edc0: 2077 6974 6820 7072 6f67 7265 7373 2062   with progress b
-0003edd0: 6172 7329 220a 2020 2020 2020 2020 2020  ars)".          
-0003ede0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0003edf0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-0003ee00: 696e 7465 7276 616c 203d 2070 6172 7365  interval = parse
-0003ee10: 5f74 696d 6564 656c 7461 2869 6e74 6572  _timedelta(inter
-0003ee20: 7661 6c29 0a20 2020 2020 2020 2069 6620  val).        if 
-0003ee30: 6675 6e63 7469 6f6e 3a0a 2020 2020 2020  function:.      
-0003ee40: 2020 2020 2020 6675 6e63 7469 6f6e 203d        function =
-0003ee50: 2070 6963 6b6c 652e 6c6f 6164 7328 6675   pickle.loads(fu
-0003ee60: 6e63 7469 6f6e 290a 2020 2020 2020 2020  nction).        
-0003ee70: 6966 2073 6574 7570 3a0a 2020 2020 2020  if setup:.      
-0003ee80: 2020 2020 2020 7365 7475 7020 3d20 7069        setup = pi
-0003ee90: 636b 6c65 2e6c 6f61 6473 2873 6574 7570  ckle.loads(setup
-0003eea0: 290a 0a20 2020 2020 2020 2069 6620 7465  )..        if te
-0003eeb0: 6172 646f 776e 3a0a 2020 2020 2020 2020  ardown:.        
-0003eec0: 2020 2020 7465 6172 646f 776e 203d 2070      teardown = p
-0003eed0: 6963 6b6c 652e 6c6f 6164 7328 7465 6172  ickle.loads(tear
-0003eee0: 646f 776e 290a 2020 2020 2020 2020 7374  down).        st
-0003eef0: 6174 6520 3d20 7365 7475 7028 7365 6c66  ate = setup(self
-0003ef00: 2920 6966 2073 6574 7570 2065 6c73 6520  ) if setup else 
-0003ef10: 4e6f 6e65 2020 2320 7479 7065 3a20 6967  None  # type: ig
-0003ef20: 6e6f 7265 0a20 2020 2020 2020 2069 6620  nore.        if 
-0003ef30: 696e 7370 6563 742e 6973 6177 6169 7461  inspect.isawaita
-0003ef40: 626c 6528 7374 6174 6529 3a0a 2020 2020  ble(state):.    
-0003ef50: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-0003ef60: 6177 6169 7420 7374 6174 650a 2020 2020  await state.    
-0003ef70: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0003ef80: 2020 2020 2077 6869 6c65 2073 656c 662e       while self.
-0003ef90: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-0003efa0: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-0003efb0: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
-0003efc0: 7465 2069 7320 4e6f 6e65 3a0a 2020 2020  te is None:.    
-0003efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003efe0: 7265 7370 6f6e 7365 203d 2066 756e 6374  response = funct
-0003eff0: 696f 6e28 7365 6c66 2920 2023 2074 7970  ion(self)  # typ
-0003f000: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-0003f010: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0003f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f030: 2020 2020 7265 7370 6f6e 7365 203d 2066      response = f
-0003f040: 756e 6374 696f 6e28 7365 6c66 2c20 7374  unction(self, st
-0003f050: 6174 6529 2020 2320 7479 7065 3a20 6967  ate)  # type: ig
-0003f060: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-0003f070: 2020 2020 2061 7761 6974 2063 6f6d 6d2e       await comm.
-0003f080: 7772 6974 6528 7265 7370 6f6e 7365 290a  write(response).
-0003f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0a0: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
-0003f0b0: 6565 7028 696e 7465 7276 616c 290a 2020  eep(interval).  
-0003f0c0: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
-0003f0d0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0003f0e0: 2020 7061 7373 0a20 2020 2020 2020 2066    pass.        f
-0003f0f0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-0003f100: 2020 2020 6966 2074 6561 7264 6f77 6e3a      if teardown:
-0003f110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f120: 2074 6561 7264 6f77 6e28 7365 6c66 2c20   teardown(self, 
-0003f130: 7374 6174 6529 2020 2320 7479 7065 3a20  state)  # type: 
-0003f140: 6967 6e6f 7265 0a0a 2020 2020 6465 6620  ignore..    def 
-0003f150: 6c6f 675f 776f 726b 6572 5f65 7665 6e74  log_worker_event
-0003f160: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0003f170: 776f 726b 6572 3a20 7374 722c 2074 6f70  worker: str, top
-0003f180: 6963 3a20 7374 7220 7c20 436f 6c6c 6563  ic: str | Collec
-0003f190: 7469 6f6e 5b73 7472 5d2c 206d 7367 3a20  tion[str], msg: 
-0003f1a0: 416e 790a 2020 2020 2920 2d3e 204e 6f6e  Any.    ) -> Non
-0003f1b0: 653a 0a20 2020 2020 2020 2069 6620 6973  e:.        if is
-0003f1c0: 696e 7374 616e 6365 286d 7367 2c20 6469  instance(msg, di
-0003f1d0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-0003f1e0: 206d 7367 5b22 776f 726b 6572 225d 203d   msg["worker"] =
-0003f1f0: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
-0003f200: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2874  self.log_event(t
-0003f210: 6f70 6963 2c20 6d73 6729 0a0a 2020 2020  opic, msg)..    
-0003f220: 6465 6620 7375 6273 6372 6962 655f 776f  def subscribe_wo
-0003f230: 726b 6572 5f73 7461 7475 7328 7365 6c66  rker_status(self
-0003f240: 2c20 636f 6d6d 3a20 436f 6d6d 2920 2d3e  , comm: Comm) ->
-0003f250: 2073 7472 3a0a 2020 2020 2020 2020 576f   str:.        Wo
-0003f260: 726b 6572 5374 6174 7573 506c 7567 696e  rkerStatusPlugin
-0003f270: 2873 656c 662c 2063 6f6d 6d29 0a20 2020  (self, comm).   
-0003f280: 2020 2020 2069 6465 6e74 203d 2073 656c       ident = sel
-0003f290: 662e 6964 656e 7469 7479 2829 0a20 2020  f.identity().   
-0003f2a0: 2020 2020 2066 6f72 2076 2069 6e20 6964       for v in id
-0003f2b0: 656e 745b 2277 6f72 6b65 7273 225d 2e76  ent["workers"].v
-0003f2c0: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-0003f2d0: 2020 2020 2064 656c 2076 5b22 6d65 7472       del v["metr
-0003f2e0: 6963 7322 5d0a 2020 2020 2020 2020 2020  ics"].          
-0003f2f0: 2020 6465 6c20 765b 226c 6173 745f 7365    del v["last_se
-0003f300: 656e 225d 0a20 2020 2020 2020 2072 6574  en"].        ret
-0003f310: 7572 6e20 6964 656e 740a 0a20 2020 2064  urn ident..    d
-0003f320: 6566 2067 6574 5f70 726f 6365 7373 696e  ef get_processin
-0003f330: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
-0003f340: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
-0003f350: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
-0003f360: 204e 6f6e 650a 2020 2020 2920 2d3e 2064   None.    ) -> d
-0003f370: 6963 745b 7374 722c 206c 6973 745b 7374  ict[str, list[st
-0003f380: 725d 5d3a 0a20 2020 2020 2020 2069 6620  r]]:.        if 
-0003f390: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-0003f3a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003f3b0: 2077 6f72 6b65 7273 203d 2073 6574 286d   workers = set(m
-0003f3c0: 6170 2873 656c 662e 636f 6572 6365 5f61  ap(self.coerce_a
-0003f3d0: 6464 7265 7373 2c20 776f 726b 6572 7329  ddress, workers)
-0003f3e0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0003f3f0: 7475 726e 207b 773a 205b 7473 2e6b 6579  turn {w: [ts.key
-0003f400: 2066 6f72 2074 7320 696e 2073 656c 662e   for ts in self.
-0003f410: 776f 726b 6572 735b 775d 2e70 726f 6365  workers[w].proce
-0003f420: 7373 696e 675d 2066 6f72 2077 2069 6e20  ssing] for w in 
-0003f430: 776f 726b 6572 737d 0a20 2020 2020 2020  workers}.       
-0003f440: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003f450: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-0003f460: 2020 2020 2020 2020 2020 2020 773a 205b              w: [
-0003f470: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
-0003f480: 2077 732e 7072 6f63 6573 7369 6e67 5d20   ws.processing] 
-0003f490: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
-0003f4a0: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
-0003f4b0: 290a 2020 2020 2020 2020 2020 2020 7d0a  ).            }.
-0003f4c0: 0a20 2020 2064 6566 2067 6574 5f77 686f  .    def get_who
-0003f4d0: 5f68 6173 2873 656c 662c 206b 6579 733a  _has(self, keys:
-0003f4e0: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
-0003f4f0: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
-0003f500: 2064 6963 745b 7374 722c 206c 6973 745b   dict[str, list[
-0003f510: 7374 725d 5d3a 0a20 2020 2020 2020 2069  str]]:.        i
-0003f520: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
-0003f530: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003f540: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
-0003f550: 2020 2020 2020 2020 206b 6579 3a20 5b77           key: [w
-0003f560: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
-0003f570: 2069 6e20 7365 6c66 2e74 6173 6b73 5b6b   in self.tasks[k
-0003f580: 6579 5d2e 7768 6f5f 6861 735d 0a20 2020  ey].who_has].   
-0003f590: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003f5a0: 6b65 7920 696e 2073 656c 662e 7461 736b  key in self.task
-0003f5b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003f5c0: 2020 656c 7365 205b 5d0a 2020 2020 2020    else [].      
-0003f5d0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-0003f5e0: 7920 696e 206b 6579 730a 2020 2020 2020  y in keys.      
-0003f5f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003f600: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0003f610: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-0003f620: 2020 2020 2020 2020 2020 206b 6579 3a20             key: 
-0003f630: 5b77 732e 6164 6472 6573 7320 666f 7220  [ws.address for 
-0003f640: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-0003f650: 5d20 666f 7220 6b65 792c 2074 7320 696e  ] for key, ts in
-0003f660: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
-0003f670: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0003f680: 7d0a 0a20 2020 2064 6566 2067 6574 5f68  }..    def get_h
-0003f690: 6173 5f77 6861 7428 0a20 2020 2020 2020  as_what(.       
-0003f6a0: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
-0003f6b0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-0003f6c0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
-0003f6d0: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
-0003f6e0: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
-0003f6f0: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
-0003f700: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0003f710: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-0003f720: 206d 6170 2873 656c 662e 636f 6572 6365   map(self.coerce
-0003f730: 5f61 6464 7265 7373 2c20 776f 726b 6572  _address, worker
-0003f740: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
-0003f750: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-0003f760: 2020 2020 2020 2020 773a 205b 7473 2e6b          w: [ts.k
-0003f770: 6579 2066 6f72 2074 7320 696e 2073 656c  ey for ts in sel
-0003f780: 662e 776f 726b 6572 735b 775d 2e68 6173  f.workers[w].has
-0003f790: 5f77 6861 745d 0a20 2020 2020 2020 2020  _what].         
-0003f7a0: 2020 2020 2020 2069 6620 7720 696e 2073         if w in s
-0003f7b0: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
-0003f7c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003f7d0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0003f7e0: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-0003f7f0: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-0003f800: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
-0003f810: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003f820: 7572 6e20 7b77 3a20 5b74 732e 6b65 7920  urn {w: [ts.key 
-0003f830: 666f 7220 7473 2069 6e20 7773 2e68 6173  for ts in ws.has
-0003f840: 5f77 6861 745d 2066 6f72 2077 2c20 7773  _what] for w, ws
-0003f850: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0003f860: 2e69 7465 6d73 2829 7d0a 0a20 2020 2064  .items()}..    d
-0003f870: 6566 2067 6574 5f6e 636f 7265 7328 7365  ef get_ncores(se
-0003f880: 6c66 2c20 776f 726b 6572 733a 2049 7465  lf, workers: Ite
-0003f890: 7261 626c 655b 7374 725d 207c 204e 6f6e  rable[str] | Non
-0003f8a0: 6520 3d20 4e6f 6e65 2920 2d3e 2064 6963  e = None) -> dic
-0003f8b0: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
-0003f8c0: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
-0003f8d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0003f8e0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0003f8f0: 203d 206d 6170 2873 656c 662e 636f 6572   = map(self.coer
-0003f900: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
-0003f910: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-0003f920: 2072 6574 7572 6e20 7b77 3a20 7365 6c66   return {w: self
-0003f930: 2e77 6f72 6b65 7273 5b77 5d2e 6e74 6872  .workers[w].nthr
-0003f940: 6561 6473 2066 6f72 2077 2069 6e20 776f  eads for w in wo
-0003f950: 726b 6572 7320 6966 2077 2069 6e20 7365  rkers if w in se
-0003f960: 6c66 2e77 6f72 6b65 7273 7d0a 2020 2020  lf.workers}.    
-0003f970: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0003f980: 2020 2020 2020 7265 7475 726e 207b 773a        return {w:
-0003f990: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
-0003f9a0: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-0003f9b0: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
-0003f9c0: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
-0003f9d0: 7265 735f 7275 6e6e 696e 6728 0a20 2020  res_running(.   
-0003f9e0: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-0003f9f0: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
-0003fa00: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
-0003fa10: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
-0003fa20: 722c 2069 6e74 5d3a 0a20 2020 2020 2020  r, int]:.       
-0003fa30: 206e 636f 7265 7320 3d20 7365 6c66 2e67   ncores = self.g
-0003fa40: 6574 5f6e 636f 7265 7328 776f 726b 6572  et_ncores(worker
-0003fa50: 733d 776f 726b 6572 7329 0a20 2020 2020  s=workers).     
-0003fa60: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-0003fa70: 2020 2020 2020 2020 773a 206e 2066 6f72          w: n for
-0003fa80: 2077 2c20 6e20 696e 206e 636f 7265 732e   w, n in ncores.
-0003fa90: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
-0003faa0: 776f 726b 6572 735b 775d 2e73 7461 7475  workers[w].statu
-0003fab0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-0003fac0: 696e 670a 2020 2020 2020 2020 7d0a 0a20  ing.        }.. 
-0003fad0: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-0003fae0: 5f63 616c 6c5f 7374 6163 6b28 7365 6c66  _call_stack(self
-0003faf0: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
-0003fb00: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
-0003fb10: 6f6e 6529 202d 3e20 6469 6374 3a0a 2020  one) -> dict:.  
-0003fb20: 2020 2020 2020 776f 726b 6572 733a 2064        workers: d
-0003fb30: 6963 745b 7374 722c 206c 6973 745b 7374  ict[str, list[st
-0003fb40: 725d 207c 204e 6f6e 655d 0a20 2020 2020  r] | None].     
-0003fb50: 2020 2069 6620 6b65 7973 2069 7320 6e6f     if keys is no
-0003fb60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0003fb70: 2020 2020 7374 6163 6b20 3d20 6c69 7374      stack = list
-0003fb80: 286b 6579 7329 0a20 2020 2020 2020 2020  (keys).         
-0003fb90: 2020 2070 726f 6365 7373 696e 6720 3d20     processing = 
-0003fba0: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
-0003fbb0: 2020 7768 696c 6520 7374 6163 6b3a 0a20    while stack:. 
-0003fbc0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0003fbd0: 6579 203d 2073 7461 636b 2e70 6f70 2829  ey = stack.pop()
-0003fbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003fbf0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-0003fc00: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
-0003fc10: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-0003fc20: 6520 3d3d 2022 7761 6974 696e 6722 3a0a  e == "waiting":.
-0003fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fc40: 2020 2020 7374 6163 6b2e 6578 7465 6e64      stack.extend
-0003fc50: 285b 6474 732e 6b65 7920 666f 7220 6474  ([dts.key for dt
-0003fc60: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0003fc70: 6369 6573 5d29 0a20 2020 2020 2020 2020  cies]).         
-0003fc80: 2020 2020 2020 2065 6c69 6620 7473 2e73         elif ts.s
-0003fc90: 7461 7465 203d 3d20 2270 726f 6365 7373  tate == "process
-0003fca0: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
-0003fcb0: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
-0003fcc0: 7369 6e67 2e61 6464 2874 7329 0a0a 2020  sing.add(ts)..  
-0003fcd0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0003fce0: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-0003fcf0: 6c69 7374 290a 2020 2020 2020 2020 2020  list).          
-0003fd00: 2020 666f 7220 7473 2069 6e20 7072 6f63    for ts in proc
-0003fd10: 6573 7369 6e67 3a0a 2020 2020 2020 2020  essing:.        
-0003fd20: 2020 2020 2020 2020 6966 2074 732e 7072          if ts.pr
-0003fd30: 6f63 6573 7369 6e67 5f6f 6e3a 0a20 2020  ocessing_on:.   
-0003fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fd50: 2077 6b65 7973 203d 2077 6f72 6b65 7273   wkeys = workers
-0003fd60: 5b74 732e 7072 6f63 6573 7369 6e67 5f6f  [ts.processing_o
-0003fd70: 6e2e 6164 6472 6573 735d 0a20 2020 2020  n.address].     
-0003fd80: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0003fd90: 7373 6572 7420 776b 6579 7320 6973 206e  ssert wkeys is n
-0003fda0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-0003fdb0: 2020 2020 2020 2020 2020 2020 776b 6579              wkey
-0003fdc0: 732e 6170 7065 6e64 2874 732e 6b65 7929  s.append(ts.key)
-0003fdd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0003fde0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0003fdf0: 7273 203d 207b 773a 204e 6f6e 6520 666f  rs = {w: None fo
-0003fe00: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
-0003fe10: 6572 737d 0a0a 2020 2020 2020 2020 6966  ers}..        if
-0003fe20: 206e 6f74 2077 6f72 6b65 7273 3a0a 2020   not workers:.  
-0003fe30: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0003fe40: 207b 7d0a 0a20 2020 2020 2020 2072 6573   {}..        res
-0003fe50: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
-0003fe60: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-0003fe70: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
-0003fe80: 7270 6328 7729 2e63 616c 6c5f 7374 6163  rpc(w).call_stac
-0003fe90: 6b28 6b65 7973 3d76 2920 666f 7220 772c  k(keys=v) for w,
-0003fea0: 2076 2069 6e20 776f 726b 6572 732e 6974   v in workers.it
-0003feb0: 656d 7328 2929 0a20 2020 2020 2020 2029  ems()).        )
-0003fec0: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-0003fed0: 6520 3d20 7b77 3a20 7220 666f 7220 772c  e = {w: r for w,
-0003fee0: 2072 2069 6e20 7a69 7028 776f 726b 6572   r in zip(worker
-0003fef0: 732c 2072 6573 756c 7473 2920 6966 2072  s, results) if r
-0003ff00: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
-0003ff10: 2072 6573 706f 6e73 650a 0a20 2020 2061   response..    a
-0003ff20: 7379 6e63 2064 6566 2062 656e 6368 6d61  sync def benchma
-0003ff30: 726b 5f68 6172 6477 6172 6528 7365 6c66  rk_hardware(self
-0003ff40: 2920 2d3e 2022 6469 6374 5b73 7472 2c20  ) -> "dict[str, 
-0003ff50: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
-0003ff60: 5d22 3a0a 2020 2020 2020 2020 2222 220a  ]":.        """.
-0003ff70: 2020 2020 2020 2020 5275 6e20 6120 6265          Run a be
-0003ff80: 6e63 686d 6172 6b20 6f6e 2074 6865 2077  nchmark on the w
-0003ff90: 6f72 6b65 7273 2066 6f72 206d 656d 6f72  orkers for memor
-0003ffa0: 792c 2064 6973 6b2c 2061 6e64 206e 6574  y, disk, and net
-0003ffb0: 776f 726b 2062 616e 6477 6964 7468 730a  work bandwidths.
-0003ffc0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0003ffd0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003ffe0: 0a20 2020 2020 2020 2072 6573 756c 743a  .        result:
-0003fff0: 2064 6963 740a 2020 2020 2020 2020 2020   dict.          
-00040000: 2020 4120 6469 6374 696f 6e61 7279 206d    A dictionary m
-00040010: 6170 7069 6e67 2074 6865 206e 616d 6573  apping the names
-00040020: 2022 6469 736b 222c 2022 6d65 6d6f 7279   "disk", "memory
-00040030: 222c 2061 6e64 2022 6e65 7477 6f72 6b22  ", and "network"
-00040040: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-00040050: 6469 6374 696f 6e61 7269 6573 206d 6170  dictionaries map
-00040060: 7069 6e67 2073 697a 6573 2074 6f20 6261  ping sizes to ba
-00040070: 6e64 7769 6474 6873 2e20 2054 6865 7365  ndwidths.  These
-00040080: 2062 616e 6477 6964 7468 7320 6172 650a   bandwidths are.
-00040090: 2020 2020 2020 2020 2020 2020 6176 6572              aver
-000400a0: 6167 6564 206f 7665 7220 6d61 6e79 2077  aged over many w
-000400b0: 6f72 6b65 7273 2072 756e 6e69 6e67 2063  orkers running c
-000400c0: 6f6d 7075 7461 7469 6f6e 7320 6163 726f  omputations acro
-000400d0: 7373 2074 6865 2063 6c75 7374 6572 2e0a  ss the cluster..
-000400e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000400f0: 2020 2020 6f75 743a 2064 6963 745b 7374      out: dict[st
-00040100: 722c 2064 6566 6175 6c74 6469 6374 5b73  r, defaultdict[s
-00040110: 7472 2c20 6c69 7374 5b66 6c6f 6174 5d5d  tr, list[float]]
-00040120: 5d20 3d20 7b0a 2020 2020 2020 2020 2020  ] = {.          
-00040130: 2020 6e61 6d65 3a20 6465 6661 756c 7464    name: defaultd
-00040140: 6963 7428 6c69 7374 2920 666f 7220 6e61  ict(list) for na
-00040150: 6d65 2069 6e20 5b22 6469 736b 222c 2022  me in ["disk", "
-00040160: 6d65 6d6f 7279 222c 2022 6e65 7477 6f72  memory", "networ
-00040170: 6b22 5d0a 2020 2020 2020 2020 7d0a 0a20  k"].        }.. 
-00040180: 2020 2020 2020 2023 2064 6973 6b0a 2020         # disk.  
-00040190: 2020 2020 2020 7265 7375 6c74 203d 2061        result = a
-000401a0: 7761 6974 2073 656c 662e 6272 6f61 6463  wait self.broadc
-000401b0: 6173 7428 6d73 673d 7b22 6f70 223a 2022  ast(msg={"op": "
-000401c0: 6265 6e63 686d 6172 6b5f 6469 736b 227d  benchmark_disk"}
-000401d0: 290a 2020 2020 2020 2020 666f 7220 6420  ).        for d 
-000401e0: 696e 2072 6573 756c 742e 7661 6c75 6573  in result.values
-000401f0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00040200: 666f 7220 7369 7a65 2c20 6475 7261 7469  for size, durati
-00040210: 6f6e 2069 6e20 642e 6974 656d 7328 293a  on in d.items():
-00040220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040230: 206f 7574 5b22 6469 736b 225d 5b73 697a   out["disk"][siz
-00040240: 655d 2e61 7070 656e 6428 6475 7261 7469  e].append(durati
-00040250: 6f6e 290a 0a20 2020 2020 2020 2023 206d  on)..        # m
-00040260: 656d 6f72 790a 2020 2020 2020 2020 7265  emory.        re
-00040270: 7375 6c74 203d 2061 7761 6974 2073 656c  sult = await sel
-00040280: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
-00040290: 7b22 6f70 223a 2022 6265 6e63 686d 6172  {"op": "benchmar
-000402a0: 6b5f 6d65 6d6f 7279 227d 290a 2020 2020  k_memory"}).    
-000402b0: 2020 2020 666f 7220 6420 696e 2072 6573      for d in res
-000402c0: 756c 742e 7661 6c75 6573 2829 3a0a 2020  ult.values():.  
-000402d0: 2020 2020 2020 2020 2020 666f 7220 7369            for si
-000402e0: 7a65 2c20 6475 7261 7469 6f6e 2069 6e20  ze, duration in 
-000402f0: 642e 6974 656d 7328 293a 0a20 2020 2020  d.items():.     
-00040300: 2020 2020 2020 2020 2020 206f 7574 5b22             out["
-00040310: 6d65 6d6f 7279 225d 5b73 697a 655d 2e61  memory"][size].a
-00040320: 7070 656e 6428 6475 7261 7469 6f6e 290a  ppend(duration).
-00040330: 0a20 2020 2020 2020 2023 206e 6574 776f  .        # netwo
-00040340: 726b 0a20 2020 2020 2020 2077 6f72 6b65  rk.        worke
-00040350: 7273 203d 206c 6973 7428 7365 6c66 2e77  rs = list(self.w
-00040360: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
-00040370: 2320 4f6e 2061 6e20 6164 6170 7469 7665  # On an adaptive
-00040380: 2063 6c75 7374 6572 2c20 6966 206d 756c   cluster, if mul
-00040390: 7469 706c 6520 776f 726b 6572 7320 6172  tiple workers ar
-000403a0: 6520 7374 6172 7465 6420 6f6e 2074 6865  e started on the
-000403b0: 2073 616d 6520 7068 7973 6963 616c 2068   same physical h
-000403c0: 6f73 742c 0a20 2020 2020 2020 2023 2074  ost,.        # t
-000403d0: 6865 7920 6172 6520 6d6f 7265 206c 696b  hey are more lik
-000403e0: 656c 7920 746f 2063 6f6e 6e65 6374 2074  ely to connect t
-000403f0: 6f20 7468 6520 5363 6865 6475 6c65 7220  o the Scheduler 
-00040400: 696e 2073 6571 7565 6e63 652c 2065 6e64  in sequence, end
-00040410: 696e 6720 7570 206e 6578 7420 746f 0a20  ing up next to. 
-00040420: 2020 2020 2020 2023 2065 6163 6820 6f74         # each ot
-00040430: 6865 7220 696e 2074 6869 7320 6c69 7374  her in this list
-00040440: 2e0a 2020 2020 2020 2020 2320 5468 6520  ..        # The 
-00040450: 7472 616e 7366 6572 2073 7065 6564 2077  transfer speed w
-00040460: 6974 6869 6e20 7375 6368 2063 6c75 7374  ithin such clust
-00040470: 6572 7320 6f66 2077 6f72 6b65 7273 2077  ers of workers w
-00040480: 696c 6c20 6265 2065 6666 6563 7469 7665  ill be effective
-00040490: 6c79 2074 6861 7420 6f66 0a20 2020 2020  ly that of.     
-000404a0: 2020 2023 206c 6f63 616c 686f 7374 2e20     # localhost. 
-000404b0: 5468 6973 2063 6f75 6c64 2068 6170 7065  This could happe
-000404c0: 6e20 6163 726f 7373 2064 6966 6665 7265  n across differe
-000404d0: 6e74 2056 4d73 2061 6e64 2f6f 7220 646f  nt VMs and/or do
-000404e0: 636b 6572 2069 6d61 6765 732c 2073 6f0a  cker images, so.
-000404f0: 2020 2020 2020 2020 2320 696d 706c 656d          # implem
-00040500: 656e 7469 6e67 206c 6f67 6963 2062 6173  enting logic bas
-00040510: 6564 206f 6e20 4950 2061 6464 7265 7373  ed on IP address
-00040520: 6573 2077 6f75 6c64 206e 6f74 206e 6563  es would not nec
-00040530: 6573 7361 7269 6c79 2068 656c 702e 0a20  essarily help.. 
-00040540: 2020 2020 2020 2023 2052 616e 646f 6d69         # Randomi
-00040550: 7a65 2074 6865 2063 6f6e 6e65 6374 696f  ze the connectio
-00040560: 6e73 2074 6f20 6576 656e 206f 7574 2074  ns to even out t
-00040570: 6865 206d 6561 6e20 6d65 6173 7572 6573  he mean measures
-00040580: 2e0a 2020 2020 2020 2020 7261 6e64 6f6d  ..        random
-00040590: 2e73 6875 6666 6c65 2877 6f72 6b65 7273  .shuffle(workers
-000405a0: 290a 2020 2020 2020 2020 6675 7475 7265  ).        future
-000405b0: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-000405c0: 2020 7365 6c66 2e72 7063 2861 292e 6265    self.rpc(a).be
-000405d0: 6e63 686d 6172 6b5f 6e65 7477 6f72 6b28  nchmark_network(
-000405e0: 6164 6472 6573 733d 6229 2066 6f72 2061  address=b) for a
-000405f0: 2c20 6220 696e 2070 6172 7469 7469 6f6e  , b in partition
-00040600: 2832 2c20 776f 726b 6572 7329 0a20 2020  (2, workers).   
-00040610: 2020 2020 205d 0a20 2020 2020 2020 2072       ].        r
-00040620: 6573 706f 6e73 6573 203d 2061 7761 6974  esponses = await
-00040630: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00040640: 2a66 7574 7572 6573 290a 0a20 2020 2020  *futures)..     
-00040650: 2020 2066 6f72 2064 2069 6e20 7265 7370     for d in resp
-00040660: 6f6e 7365 733a 0a20 2020 2020 2020 2020  onses:.         
-00040670: 2020 2066 6f72 2073 697a 652c 2064 7572     for size, dur
-00040680: 6174 696f 6e20 696e 2064 2e69 7465 6d73  ation in d.items
-00040690: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000406a0: 2020 2020 6f75 745b 226e 6574 776f 726b      out["network
-000406b0: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
-000406c0: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
-000406d0: 2020 2072 6573 756c 7420 3d20 7b7d 0a20     result = {}. 
-000406e0: 2020 2020 2020 2066 6f72 206d 6f64 6520         for mode 
-000406f0: 696e 206f 7574 3a0a 2020 2020 2020 2020  in out:.        
-00040700: 2020 2020 7265 7375 6c74 5b6d 6f64 655d      result[mode]
-00040710: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00040720: 2020 2020 2073 697a 653a 2073 756d 2864       size: sum(d
-00040730: 7572 6174 696f 6e73 2920 2f20 6c65 6e28  urations) / len(
-00040740: 6475 7261 7469 6f6e 7329 0a20 2020 2020  durations).     
-00040750: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
-00040760: 697a 652c 2064 7572 6174 696f 6e73 2069  ize, durations i
-00040770: 6e20 6f75 745b 6d6f 6465 5d2e 6974 656d  n out[mode].item
-00040780: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00040790: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
-000407a0: 6e20 7265 7375 6c74 0a0a 2020 2020 406c  n result..    @l
-000407b0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-000407c0: 6620 6765 745f 6e62 7974 6573 280a 2020  f get_nbytes(.  
-000407d0: 2020 2020 2020 7365 6c66 2c20 6b65 7973        self, keys
-000407e0: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
-000407f0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 2073  | None = None, s
-00040800: 756d 6d61 7279 3a20 626f 6f6c 203d 2054  ummary: bool = T
-00040810: 7275 650a 2020 2020 2920 2d3e 2064 6963  rue.    ) -> dic
-00040820: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
-00040830: 2020 2020 2069 6620 6b65 7973 2069 7320       if keys is 
-00040840: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00040850: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
-00040860: 6b3a 2073 656c 662e 7461 736b 735b 6b5d  k: self.tasks[k]
-00040870: 2e6e 6279 7465 7320 666f 7220 6b20 696e  .nbytes for k in
-00040880: 206b 6579 737d 0a20 2020 2020 2020 2065   keys}.        e
-00040890: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000408a0: 2072 6573 756c 7420 3d20 7b6b 3a20 7473   result = {k: ts
-000408b0: 2e6e 6279 7465 7320 666f 7220 6b2c 2074  .nbytes for k, t
-000408c0: 7320 696e 2073 656c 662e 7461 736b 732e  s in self.tasks.
-000408d0: 6974 656d 7328 2920 6966 2074 732e 6e62  items() if ts.nb
-000408e0: 7974 6573 203e 3d20 307d 0a0a 2020 2020  ytes >= 0}..    
-000408f0: 2020 2020 6966 2073 756d 6d61 7279 3a0a      if summary:.
-00040900: 2020 2020 2020 2020 2020 2020 6f75 743a              out:
-00040910: 2064 6566 6175 6c74 6469 6374 5b73 7472   defaultdict[str
-00040920: 2c20 696e 745d 203d 2064 6566 6175 6c74  , int] = default
-00040930: 6469 6374 286c 616d 6264 613a 2030 290a  dict(lambda: 0).
-00040940: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00040950: 6b2c 2076 2069 6e20 7265 7375 6c74 2e69  k, v in result.i
-00040960: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00040970: 2020 2020 2020 2020 6f75 745b 6b65 795f          out[key_
-00040980: 7370 6c69 7428 6b29 5d20 2b3d 2076 0a20  split(k)] += v. 
-00040990: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-000409a0: 7420 3d20 6469 6374 286f 7574 290a 0a20  t = dict(out).. 
-000409b0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-000409c0: 7375 6c74 0a0a 2020 2020 6465 6620 7275  sult..    def ru
-000409d0: 6e5f 6675 6e63 7469 6f6e 280a 2020 2020  n_function(.    
-000409e0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-000409f0: 2020 636f 6d6d 3a20 436f 6d6d 2c0a 2020    comm: Comm,.  
-00040a00: 2020 2020 2020 6675 6e63 7469 6f6e 3a20        function: 
-00040a10: 4361 6c6c 6162 6c65 2c0a 2020 2020 2020  Callable,.      
-00040a20: 2020 6172 6773 3a20 7475 706c 6520 3d20    args: tuple = 
-00040a30: 2829 2c0a 2020 2020 2020 2020 6b77 6172  (),.        kwar
-00040a40: 6773 3a20 6469 6374 207c 204e 6f6e 6520  gs: dict | None 
-00040a50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00040a60: 7761 6974 3a20 626f 6f6c 203d 2054 7275  wait: bool = Tru
-00040a70: 652c 0a20 2020 2029 202d 3e20 416e 793a  e,.    ) -> Any:
-00040a80: 0a20 2020 2020 2020 2022 2222 5275 6e20  .        """Run 
-00040a90: 6120 6675 6e63 7469 6f6e 2077 6974 6869  a function withi
-00040aa0: 6e20 7468 6973 2070 726f 6365 7373 0a0a  n this process..
-00040ab0: 2020 2020 2020 2020 5365 6520 416c 736f          See Also
-00040ac0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00040ad0: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
-00040ae0: 2e72 756e 5f6f 6e5f 7363 6865 6475 6c65  .run_on_schedule
-00040af0: 720a 2020 2020 2020 2020 2222 220a 2020  r.        """.  
-00040b00: 2020 2020 2020 6672 6f6d 2064 6973 7472        from distr
-00040b10: 6962 7574 6564 2e77 6f72 6b65 7220 696d  ibuted.worker im
-00040b20: 706f 7274 2072 756e 0a0a 2020 2020 2020  port run..      
-00040b30: 2020 6966 206e 6f74 2064 6173 6b2e 636f    if not dask.co
-00040b40: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-00040b50: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-00040b60: 7069 636b 6c65 2229 3a0a 2020 2020 2020  pickle"):.      
-00040b70: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00040b80: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-00040b90: 2020 2020 2020 2020 2243 616e 6e6f 7420          "Cannot 
-00040ba0: 7275 6e20 6675 6e63 7469 6f6e 2061 7320  run function as 
-00040bb0: 7468 6520 7363 6865 6475 6c65 7220 6861  the scheduler ha
-00040bc0: 7320 6265 656e 2065 7870 6c69 6369 746c  s been explicitl
-00040bd0: 7920 6469 7361 6c6c 6f77 6564 2066 726f  y disallowed fro
-00040be0: 6d20 220a 2020 2020 2020 2020 2020 2020  m ".            
-00040bf0: 2020 2020 2264 6573 6572 6961 6c69 7a69      "deserializi
-00040c00: 6e67 2061 7262 6974 7261 7279 2062 7974  ng arbitrary byt
-00040c10: 6573 7472 696e 6773 2075 7369 6e67 2070  estrings using p
-00040c20: 6963 6b6c 6520 7669 6120 7468 6520 220a  ickle via the ".
-00040c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040c40: 2227 6469 7374 7269 6275 7465 642e 7363  "'distributed.sc
-00040c50: 6865 6475 6c65 722e 7069 636b 6c65 2720  heduler.pickle' 
-00040c60: 636f 6e66 6967 7572 6174 696f 6e20 7365  configuration se
-00040c70: 7474 696e 672e 220a 2020 2020 2020 2020  tting.".        
-00040c80: 2020 2020 290a 2020 2020 2020 2020 6b77      ).        kw
-00040c90: 6172 6773 203d 206b 7761 7267 7320 6f72  args = kwargs or
-00040ca0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-00040cb0: 2e6c 6f67 5f65 7665 6e74 2822 616c 6c22  .log_event("all"
-00040cc0: 2c20 7b22 6163 7469 6f6e 223a 2022 7275  , {"action": "ru
-00040cd0: 6e2d 6675 6e63 7469 6f6e 222c 2022 6675  n-function", "fu
-00040ce0: 6e63 7469 6f6e 223a 2066 756e 6374 696f  nction": functio
-00040cf0: 6e7d 290a 2020 2020 2020 2020 7265 7475  n}).        retu
-00040d00: 726e 2072 756e 2873 656c 662c 2063 6f6d  rn run(self, com
-00040d10: 6d2c 2066 756e 6374 696f 6e3d 6675 6e63  m, function=func
-00040d20: 7469 6f6e 2c20 6172 6773 3d61 7267 732c  tion, args=args,
-00040d30: 206b 7761 7267 733d 6b77 6172 6773 2c20   kwargs=kwargs, 
-00040d40: 7761 6974 3d77 6169 7429 0a0a 2020 2020  wait=wait)..    
-00040d50: 6465 6620 7365 745f 6d65 7461 6461 7461  def set_metadata
-00040d60: 2873 656c 662c 206b 6579 733a 206c 6973  (self, keys: lis
-00040d70: 745b 7374 725d 2c20 7661 6c75 653a 206f  t[str], value: o
-00040d80: 626a 6563 7420 3d20 4e6f 6e65 2920 2d3e  bject = None) ->
-00040d90: 204e 6f6e 653a 0a20 2020 2020 2020 206d   None:.        m
-00040da0: 6574 6164 6174 6120 3d20 7365 6c66 2e74  etadata = self.t
-00040db0: 6173 6b5f 6d65 7461 6461 7461 0a20 2020  ask_metadata.   
-00040dc0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-00040dd0: 6b65 7973 5b3a 2d31 5d3a 0a20 2020 2020  keys[:-1]:.     
-00040de0: 2020 2020 2020 2069 6620 6b65 7920 6e6f         if key no
-00040df0: 7420 696e 206d 6574 6164 6174 6120 6f72  t in metadata or
-00040e00: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00040e10: 6d65 7461 6461 7461 5b6b 6579 5d2c 2028  metadata[key], (
-00040e20: 6469 6374 2c20 6c69 7374 2929 3a0a 2020  dict, list)):.  
-00040e30: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00040e40: 7461 6461 7461 5b6b 6579 5d20 3d20 7b7d  tadata[key] = {}
-00040e50: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-00040e60: 6164 6174 6120 3d20 6d65 7461 6461 7461  adata = metadata
-00040e70: 5b6b 6579 5d0a 2020 2020 2020 2020 6d65  [key].        me
-00040e80: 7461 6461 7461 5b6b 6579 735b 2d31 5d5d  tadata[keys[-1]]
-00040e90: 203d 2076 616c 7565 0a0a 2020 2020 6465   = value..    de
-00040ea0: 6620 6765 745f 6d65 7461 6461 7461 2873  f get_metadata(s
-00040eb0: 656c 662c 206b 6579 733a 206c 6973 745b  elf, keys: list[
-00040ec0: 7374 725d 2c20 6465 6661 756c 743a 2041  str], default: A
-00040ed0: 6e79 203d 206e 6f5f 6465 6661 756c 7429  ny = no_default)
-00040ee0: 202d 3e20 416e 793a 0a20 2020 2020 2020   -> Any:.       
-00040ef0: 206d 6574 6164 6174 6120 3d20 7365 6c66   metadata = self
-00040f00: 2e74 6173 6b5f 6d65 7461 6461 7461 0a20  .task_metadata. 
-00040f10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00040f20: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00040f30: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-00040f40: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
-00040f50: 6120 3d20 6d65 7461 6461 7461 5b6b 6579  a = metadata[key
-00040f60: 5d0a 2020 2020 2020 2020 2020 2020 7265  ].            re
-00040f70: 7475 726e 206d 6574 6164 6174 610a 2020  turn metadata.  
-00040f80: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-00040f90: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00040fa0: 2020 2069 6620 6465 6661 756c 7420 213d     if default !=
-00040fb0: 206e 6f5f 6465 6661 756c 743a 0a20 2020   no_default:.   
-00040fc0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00040fd0: 7572 6e20 6465 6661 756c 740a 2020 2020  urn default.    
-00040fe0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00040ff0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00041000: 6973 650a 0a20 2020 2064 6566 2073 6574  ise..    def set
-00041010: 5f72 6573 7472 6963 7469 6f6e 7328 7365  _restrictions(se
-00041020: 6c66 2c20 776f 726b 6572 3a20 6469 6374  lf, worker: dict
-00041030: 5b73 7472 2c20 436f 6c6c 6563 7469 6f6e  [str, Collection
-00041040: 5b73 7472 5d20 7c20 7374 725d 2920 2d3e  [str] | str]) ->
-00041050: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
-00041060: 6f72 206b 6579 2c20 7265 7374 7269 6374  or key, restrict
-00041070: 696f 6e73 2069 6e20 776f 726b 6572 2e69  ions in worker.i
-00041080: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00041090: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-000410a0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-000410b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-000410c0: 6365 2872 6573 7472 6963 7469 6f6e 732c  ce(restrictions,
-000410d0: 2073 7472 293a 0a20 2020 2020 2020 2020   str):.         
-000410e0: 2020 2020 2020 2072 6573 7472 6963 7469         restricti
-000410f0: 6f6e 7320 3d20 7b72 6573 7472 6963 7469  ons = {restricti
-00041100: 6f6e 737d 0a20 2020 2020 2020 2020 2020  ons}.           
-00041110: 2074 732e 776f 726b 6572 5f72 6573 7472   ts.worker_restr
-00041120: 6963 7469 6f6e 7320 3d20 7365 7428 7265  ictions = set(re
-00041130: 7374 7269 6374 696f 6e73 290a 0a20 2020  strictions)..   
-00041140: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-00041150: 2064 6566 2067 6574 5f74 6173 6b5f 7072   def get_task_pr
-00041160: 6566 6978 5f73 7461 7465 7328 7365 6c66  efix_states(self
-00041170: 2920 2d3e 2064 6963 745b 7374 722c 2064  ) -> dict[str, d
-00041180: 6963 745b 7374 722c 2069 6e74 5d5d 3a0a  ict[str, int]]:.
-00041190: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-000411a0: 7b7d 0a0a 2020 2020 2020 2020 666f 7220  {}..        for 
-000411b0: 7470 2069 6e20 7365 6c66 2e74 6173 6b5f  tp in self.task_
-000411c0: 7072 6566 6978 6573 2e76 616c 7565 7328  prefixes.values(
-000411d0: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-000411e0: 6374 6976 655f 7374 6174 6573 203d 2074  ctive_states = t
-000411f0: 702e 6163 7469 7665 5f73 7461 7465 730a  p.active_states.
-00041200: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00041210: 6e79 280a 2020 2020 2020 2020 2020 2020  ny(.            
-00041220: 2020 2020 6163 7469 7665 5f73 7461 7465      active_state
-00041230: 732e 6765 7428 7329 0a20 2020 2020 2020  s.get(s).       
-00041240: 2020 2020 2020 2020 2066 6f72 2073 2069           for s i
-00041250: 6e20 7b22 6d65 6d6f 7279 222c 2022 6572  n {"memory", "er
-00041260: 7265 6422 2c20 2272 656c 6561 7365 6422  red", "released"
-00041270: 2c20 2270 726f 6365 7373 696e 6722 2c20  , "processing", 
-00041280: 2277 6169 7469 6e67 227d 0a20 2020 2020  "waiting"}.     
-00041290: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-000412a0: 2020 2020 2020 2020 2020 7374 6174 655b            state[
-000412b0: 7470 2e6e 616d 655d 203d 207b 0a20 2020  tp.name] = {.   
-000412c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000412d0: 2022 6d65 6d6f 7279 223a 2061 6374 6976   "memory": activ
-000412e0: 655f 7374 6174 6573 5b22 6d65 6d6f 7279  e_states["memory
-000412f0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00041300: 2020 2020 2020 2020 2265 7272 6564 223a          "erred":
-00041310: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
-00041320: 6572 7265 6422 5d2c 0a20 2020 2020 2020  erred"],.       
-00041330: 2020 2020 2020 2020 2020 2020 2022 7265               "re
-00041340: 6c65 6173 6564 223a 2061 6374 6976 655f  leased": active_
-00041350: 7374 6174 6573 5b22 7265 6c65 6173 6564  states["released
-00041360: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00041370: 2020 2020 2020 2020 2270 726f 6365 7373          "process
-00041380: 696e 6722 3a20 6163 7469 7665 5f73 7461  ing": active_sta
-00041390: 7465 735b 2270 726f 6365 7373 696e 6722  tes["processing"
-000413a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000413b0: 2020 2020 2020 2022 7761 6974 696e 6722         "waiting"
-000413c0: 3a20 6163 7469 7665 5f73 7461 7465 735b  : active_states[
-000413d0: 2277 6169 7469 6e67 225d 2c0a 2020 2020  "waiting"],.    
-000413e0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-000413f0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
-00041400: 6174 650a 0a20 2020 2064 6566 2067 6574  ate..    def get
-00041410: 5f74 6173 6b5f 7374 6174 7573 2873 656c  _task_status(sel
-00041420: 662c 206b 6579 733a 2049 7465 7261 626c  f, keys: Iterabl
-00041430: 655b 7374 725d 2920 2d3e 2064 6963 745b  e[str]) -> dict[
-00041440: 7374 722c 2054 6173 6b53 7461 7465 5374  str, TaskStateSt
-00041450: 6174 6520 7c20 4e6f 6e65 5d3a 0a20 2020  ate | None]:.   
-00041460: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
-00041470: 2020 2020 2020 2020 2020 6b65 793a 2028            key: (
-00041480: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d2e  self.tasks[key].
-00041490: 7374 6174 6520 6966 206b 6579 2069 6e20  state if key in 
-000414a0: 7365 6c66 2e74 6173 6b73 2065 6c73 6520  self.tasks else 
-000414b0: 4e6f 6e65 2920 666f 7220 6b65 7920 696e  None) for key in
-000414c0: 206b 6579 730a 2020 2020 2020 2020 7d0a   keys.        }.
-000414d0: 0a20 2020 2064 6566 2067 6574 5f74 6173  .    def get_tas
-000414e0: 6b5f 7374 7265 616d 280a 2020 2020 2020  k_stream(.      
-000414f0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00041500: 7374 6172 743a 2073 7472 207c 2066 6c6f  start: str | flo
-00041510: 6174 207c 204e 6f6e 6520 3d20 4e6f 6e65  at | None = None
-00041520: 2c0a 2020 2020 2020 2020 7374 6f70 3a20  ,.        stop: 
-00041530: 7374 7220 7c20 666c 6f61 7420 7c20 4e6f  str | float | No
-00041540: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00041550: 2020 2063 6f75 6e74 3a20 696e 7420 7c20     count: int | 
-00041560: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00041570: 2029 202d 3e20 6c69 7374 3a0a 2020 2020   ) -> list:.    
-00041580: 2020 2020 6672 6f6d 2064 6973 7472 6962      from distrib
-00041590: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
-000415a0: 2e74 6173 6b5f 7374 7265 616d 2069 6d70  .task_stream imp
-000415b0: 6f72 7420 5461 736b 5374 7265 616d 506c  ort TaskStreamPl
-000415c0: 7567 696e 0a0a 2020 2020 2020 2020 6966  ugin..        if
-000415d0: 2054 6173 6b53 7472 6561 6d50 6c75 6769   TaskStreamPlugi
-000415e0: 6e2e 6e61 6d65 206e 6f74 2069 6e20 7365  n.name not in se
-000415f0: 6c66 2e70 6c75 6769 6e73 3a0a 2020 2020  lf.plugins:.    
-00041600: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00041610: 5f70 6c75 6769 6e28 5461 736b 5374 7265  _plugin(TaskStre
-00041620: 616d 506c 7567 696e 2873 656c 6629 290a  amPlugin(self)).
-00041630: 0a20 2020 2020 2020 2070 6c75 6769 6e20  .        plugin 
-00041640: 3d20 6361 7374 2854 6173 6b53 7472 6561  = cast(TaskStrea
-00041650: 6d50 6c75 6769 6e2c 2073 656c 662e 706c  mPlugin, self.pl
-00041660: 7567 696e 735b 5461 736b 5374 7265 616d  ugins[TaskStream
-00041670: 506c 7567 696e 2e6e 616d 655d 290a 0a20  Plugin.name]).. 
-00041680: 2020 2020 2020 2072 6574 7572 6e20 706c         return pl
-00041690: 7567 696e 2e63 6f6c 6c65 6374 2873 7461  ugin.collect(sta
-000416a0: 7274 3d73 7461 7274 2c20 7374 6f70 3d73  rt=start, stop=s
-000416b0: 746f 702c 2063 6f75 6e74 3d63 6f75 6e74  top, count=count
-000416c0: 290a 0a20 2020 2064 6566 2073 7461 7274  )..    def start
-000416d0: 5f74 6173 6b5f 6d65 7461 6461 7461 2873  _task_metadata(s
-000416e0: 656c 662c 206e 616d 653a 2073 7472 2920  elf, name: str) 
-000416f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00041700: 2070 6c75 6769 6e20 3d20 436f 6c6c 6563   plugin = Collec
-00041710: 7454 6173 6b4d 6574 6144 6174 6150 6c75  tTaskMetaDataPlu
-00041720: 6769 6e28 7363 6865 6475 6c65 723d 7365  gin(scheduler=se
-00041730: 6c66 2c20 6e61 6d65 3d6e 616d 6529 0a20  lf, name=name). 
-00041740: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-00041750: 706c 7567 696e 2870 6c75 6769 6e29 0a0a  plugin(plugin)..
-00041760: 2020 2020 6465 6620 7374 6f70 5f74 6173      def stop_tas
-00041770: 6b5f 6d65 7461 6461 7461 2873 656c 662c  k_metadata(self,
-00041780: 206e 616d 653a 2073 7472 207c 204e 6f6e   name: str | Non
-00041790: 6520 3d20 4e6f 6e65 2920 2d3e 2064 6963  e = None) -> dic
-000417a0: 743a 0a20 2020 2020 2020 2070 6c75 6769  t:.        plugi
-000417b0: 6e73 203d 205b 0a20 2020 2020 2020 2020  ns = [.         
-000417c0: 2020 2070 0a20 2020 2020 2020 2020 2020     p.           
-000417d0: 2066 6f72 2070 2069 6e20 6c69 7374 2873   for p in list(s
-000417e0: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-000417f0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-00041800: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00041810: 702c 2043 6f6c 6c65 6374 5461 736b 4d65  p, CollectTaskMe
-00041820: 7461 4461 7461 506c 7567 696e 2920 616e  taDataPlugin) an
-00041830: 6420 702e 6e61 6d65 203d 3d20 6e61 6d65  d p.name == name
-00041840: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-00041850: 2020 2069 6620 6c65 6e28 706c 7567 696e     if len(plugin
-00041860: 7329 2021 3d20 313a 0a20 2020 2020 2020  s) != 1:.       
-00041870: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00041880: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00041890: 2020 2020 2020 2022 4578 7065 6374 6564         "Expected
-000418a0: 2074 6f20 6669 6e64 2065 7861 6374 6c79   to find exactly
-000418b0: 206f 6e65 2043 6f6c 6c65 6374 5461 736b   one CollectTask
-000418c0: 4d65 7461 4461 7461 506c 7567 696e 2022  MetaDataPlugin "
-000418d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000418e0: 2066 2277 6974 6820 6e61 6d65 207b 6e61   f"with name {na
-000418f0: 6d65 7d20 6275 7420 666f 756e 6420 7b6c  me} but found {l
-00041900: 656e 2870 6c75 6769 6e73 297d 2e22 0a20  en(plugins)}.". 
-00041910: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00041920: 2020 2020 2020 706c 7567 696e 203d 2070        plugin = p
-00041930: 6c75 6769 6e73 5b30 5d0a 2020 2020 2020  lugins[0].      
-00041940: 2020 7365 6c66 2e72 656d 6f76 655f 706c    self.remove_pl
-00041950: 7567 696e 286e 616d 653d 706c 7567 696e  ugin(name=plugin
-00041960: 2e6e 616d 6529 0a20 2020 2020 2020 2072  .name).        r
-00041970: 6574 7572 6e20 7b22 6d65 7461 6461 7461  eturn {"metadata
-00041980: 223a 2070 6c75 6769 6e2e 6d65 7461 6461  ": plugin.metada
-00041990: 7461 2c20 2273 7461 7465 223a 2070 6c75  ta, "state": plu
-000419a0: 6769 6e2e 7374 6174 657d 0a0a 2020 2020  gin.state}..    
-000419b0: 6173 796e 6320 6465 6620 7265 6769 7374  async def regist
-000419c0: 6572 5f77 6f72 6b65 725f 706c 7567 696e  er_worker_plugin
-000419d0: 2873 656c 662c 2063 6f6d 6d2c 2070 6c75  (self, comm, plu
-000419e0: 6769 6e2c 206e 616d 653d 4e6f 6e65 293a  gin, name=None):
-000419f0: 0a20 2020 2020 2020 2022 2222 5265 6769  .        """Regi
-00041a00: 7374 6572 7320 6120 776f 726b 6572 2070  sters a worker p
-00041a10: 6c75 6769 6e20 6f6e 2061 6c6c 2072 756e  lugin on all run
-00041a20: 6e69 6e67 2061 6e64 2066 7574 7572 6520  ning and future 
-00041a30: 776f 726b 6572 7322 2222 0a20 2020 2020  workers""".     
-00041a40: 2020 2073 656c 662e 776f 726b 6572 5f70     self.worker_p
-00041a50: 6c75 6769 6e73 5b6e 616d 655d 203d 2070  lugins[name] = p
-00041a60: 6c75 6769 6e0a 0a20 2020 2020 2020 2072  lugin..        r
-00041a70: 6573 706f 6e73 6573 203d 2061 7761 6974  esponses = await
-00041a80: 2073 656c 662e 6272 6f61 6463 6173 7428   self.broadcast(
-00041a90: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-00041aa0: 3d64 6963 7428 6f70 3d22 706c 7567 696e  =dict(op="plugin
-00041ab0: 2d61 6464 222c 2070 6c75 6769 6e3d 706c  -add", plugin=pl
-00041ac0: 7567 696e 2c20 6e61 6d65 3d6e 616d 6529  ugin, name=name)
-00041ad0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00041ae0: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
-00041af0: 7365 730a 0a20 2020 2061 7379 6e63 2064  ses..    async d
-00041b00: 6566 2075 6e72 6567 6973 7465 725f 776f  ef unregister_wo
-00041b10: 726b 6572 5f70 6c75 6769 6e28 7365 6c66  rker_plugin(self
-00041b20: 2c20 636f 6d6d 2c20 6e61 6d65 293a 0a20  , comm, name):. 
-00041b30: 2020 2020 2020 2022 2222 556e 7265 6769         """Unregi
-00041b40: 7374 6572 7320 6120 776f 726b 6572 2070  sters a worker p
-00041b50: 6c75 6769 6e22 2222 0a20 2020 2020 2020  lugin""".       
-00041b60: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00041b70: 2020 7365 6c66 2e77 6f72 6b65 725f 706c    self.worker_pl
-00041b80: 7567 696e 732e 706f 7028 6e61 6d65 290a  ugins.pop(name).
-00041b90: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00041ba0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00041bb0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00041bc0: 4572 726f 7228 6622 5468 6520 776f 726b  Error(f"The work
-00041bd0: 6572 2070 6c75 6769 6e20 7b6e 616d 657d  er plugin {name}
-00041be0: 2064 6f65 7320 6e6f 7420 6578 6973 7422   does not exist"
-00041bf0: 290a 0a20 2020 2020 2020 2072 6573 706f  )..        respo
-00041c00: 6e73 6573 203d 2061 7761 6974 2073 656c  nses = await sel
-00041c10: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
-00041c20: 6469 6374 286f 703d 2270 6c75 6769 6e2d  dict(op="plugin-
-00041c30: 7265 6d6f 7665 222c 206e 616d 653d 6e61  remove", name=na
-00041c40: 6d65 2929 0a20 2020 2020 2020 2072 6574  me)).        ret
-00041c50: 7572 6e20 7265 7370 6f6e 7365 730a 0a20  urn responses.. 
-00041c60: 2020 2061 7379 6e63 2064 6566 2072 6567     async def reg
-00041c70: 6973 7465 725f 6e61 6e6e 795f 706c 7567  ister_nanny_plug
-00041c80: 696e 2873 656c 662c 2063 6f6d 6d2c 2070  in(self, comm, p
-00041c90: 6c75 6769 6e2c 206e 616d 653d 4e6f 6e65  lugin, name=None
-00041ca0: 293a 0a20 2020 2020 2020 2022 2222 5265  ):.        """Re
-00041cb0: 6769 7374 6572 7320 6120 7365 7475 7020  gisters a setup 
-00041cc0: 6675 6e63 7469 6f6e 2c20 616e 6420 6361  function, and ca
-00041cd0: 6c6c 2069 7420 6f6e 2065 7665 7279 2077  ll it on every w
-00041ce0: 6f72 6b65 7222 2222 0a20 2020 2020 2020  orker""".       
-00041cf0: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
-00041d00: 696e 735b 6e61 6d65 5d20 3d20 706c 7567  ins[name] = plug
-00041d10: 696e 0a0a 2020 2020 2020 2020 7265 7370  in..        resp
-00041d20: 6f6e 7365 7320 3d20 6177 6169 7420 7365  onses = await se
-00041d30: 6c66 2e62 726f 6164 6361 7374 280a 2020  lf.broadcast(.  
-00041d40: 2020 2020 2020 2020 2020 6d73 673d 6469            msg=di
-00041d50: 6374 286f 703d 2270 6c75 6769 6e5f 6164  ct(op="plugin_ad
-00041d60: 6422 2c20 706c 7567 696e 3d70 6c75 6769  d", plugin=plugi
-00041d70: 6e2c 206e 616d 653d 6e61 6d65 292c 0a20  n, name=name),. 
-00041d80: 2020 2020 2020 2020 2020 206e 616e 6e79             nanny
-00041d90: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
-00041da0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00041db0: 7265 7370 6f6e 7365 730a 0a20 2020 2061  responses..    a
-00041dc0: 7379 6e63 2064 6566 2075 6e72 6567 6973  sync def unregis
-00041dd0: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
-00041de0: 2873 656c 662c 2063 6f6d 6d2c 206e 616d  (self, comm, nam
-00041df0: 6529 3a0a 2020 2020 2020 2020 2222 2255  e):.        """U
-00041e00: 6e72 6567 6973 7465 7273 2061 2077 6f72  nregisters a wor
-00041e10: 6b65 7220 706c 7567 696e 2222 220a 2020  ker plugin""".  
-00041e20: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00041e30: 2020 2020 2020 2073 656c 662e 6e61 6e6e         self.nann
-00041e40: 795f 706c 7567 696e 732e 706f 7028 6e61  y_plugins.pop(na
-00041e50: 6d65 290a 2020 2020 2020 2020 6578 6365  me).        exce
-00041e60: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00041e70: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00041e80: 616c 7565 4572 726f 7228 6622 5468 6520  alueError(f"The 
-00041e90: 6e61 6e6e 7920 706c 7567 696e 207b 6e61  nanny plugin {na
-00041ea0: 6d65 7d20 646f 6573 206e 6f74 2065 7869  me} does not exi
-00041eb0: 7374 2229 0a0a 2020 2020 2020 2020 7265  st")..        re
-00041ec0: 7370 6f6e 7365 7320 3d20 6177 6169 7420  sponses = await 
-00041ed0: 7365 6c66 2e62 726f 6164 6361 7374 280a  self.broadcast(.
-00041ee0: 2020 2020 2020 2020 2020 2020 6d73 673d              msg=
-00041ef0: 6469 6374 286f 703d 2270 6c75 6769 6e5f  dict(op="plugin_
-00041f00: 7265 6d6f 7665 222c 206e 616d 653d 6e61  remove", name=na
-00041f10: 6d65 292c 206e 616e 6e79 3d54 7275 650a  me), nanny=True.
-00041f20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00041f30: 2020 7265 7475 726e 2072 6573 706f 6e73    return respons
-00041f40: 6573 0a0a 2020 2020 6465 6620 7472 616e  es..    def tran
-00041f50: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
-00041f60: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-00041f70: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
-00041f80: 6669 6e69 7368 3a20 5461 736b 5374 6174  finish: TaskStat
-00041f90: 6553 7461 7465 2c0a 2020 2020 2020 2020  eState,.        
-00041fa0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00041fb0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00041fc0: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
-00041fd0: 3e20 5265 6373 3a0a 2020 2020 2020 2020  > Recs:.        
-00041fe0: 2222 2254 7261 6e73 6974 696f 6e20 6120  """Transition a 
-00041ff0: 6b65 7920 6672 6f6d 2069 7473 2063 7572  key from its cur
-00042000: 7265 6e74 2073 7461 7465 2074 6f20 7468  rent state to th
-00042010: 6520 6669 6e69 7368 2073 7461 7465 0a0a  e finish state..
-00042020: 2020 2020 2020 2020 4578 616d 706c 6573          Examples
-00042030: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00042040: 2d0a 2020 2020 2020 2020 3e3e 3e20 7365  -.        >>> se
-00042050: 6c66 2e74 7261 6e73 6974 696f 6e28 2778  lf.transition('x
-00042060: 272c 2027 7761 6974 696e 6727 290a 2020  ', 'waiting').  
-00042070: 2020 2020 2020 7b27 7827 3a20 2770 726f        {'x': 'pro
-00042080: 6365 7373 696e 6727 7d0a 0a20 2020 2020  cessing'}..     
-00042090: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-000420a0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-000420b0: 2020 2044 6963 7469 6f6e 6172 7920 6f66     Dictionary of
-000420c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000420d0: 2066 6f72 2066 7574 7572 6520 7472 616e   for future tran
-000420e0: 7369 7469 6f6e 730a 0a20 2020 2020 2020  sitions..       
-000420f0: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
-00042100: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-00042110: 2020 2053 6368 6564 756c 6572 2e74 7261     Scheduler.tra
-00042120: 6e73 6974 696f 6e73 3a20 7472 616e 7369  nsitions: transi
-00042130: 7469 7665 2076 6572 7369 6f6e 206f 6620  tive version of 
-00042140: 7468 6973 2066 756e 6374 696f 6e0a 2020  this function.  
-00042150: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00042160: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00042170: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-00042180: 776f 726b 6572 5f6d 7367 7320 3d20 7365  worker_msgs = se
-00042190: 6c66 2e5f 7472 616e 7369 7469 6f6e 280a  lf._transition(.
-000421a0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
-000421b0: 2066 696e 6973 682c 2073 7469 6d75 6c75   finish, stimulu
-000421c0: 735f 6964 2c20 2a2a 6b77 6172 6773 0a20  s_id, **kwargs. 
-000421d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000421e0: 2073 656c 662e 7365 6e64 5f61 6c6c 2863   self.send_all(c
-000421f0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
-00042200: 6572 5f6d 7367 7329 0a20 2020 2020 2020  er_msgs).       
-00042210: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00042220: 6461 7469 6f6e 730a 0a20 2020 2064 6566  dations..    def
-00042230: 2074 7261 6e73 6974 696f 6e73 2873 656c   transitions(sel
-00042240: 662c 2072 6563 6f6d 6d65 6e64 6174 696f  f, recommendatio
-00042250: 6e73 3a20 5265 6373 2c20 7374 696d 756c  ns: Recs, stimul
-00042260: 7573 5f69 643a 2073 7472 2920 2d3e 204e  us_id: str) -> N
-00042270: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00042280: 5072 6f63 6573 7320 7472 616e 7369 7469  Process transiti
-00042290: 6f6e 7320 756e 7469 6c20 6e6f 6e65 2061  ons until none a
-000422a0: 7265 206c 6566 740a 0a20 2020 2020 2020  re left..       
-000422b0: 2054 6869 7320 696e 636c 7564 6573 2066   This includes f
-000422c0: 6565 6462 6163 6b20 6672 6f6d 2070 7265  eedback from pre
-000422d0: 7669 6f75 7320 7472 616e 7369 7469 6f6e  vious transition
-000422e0: 7320 616e 6420 636f 6e74 696e 7565 7320  s and continues 
-000422f0: 756e 7469 6c20 7765 0a20 2020 2020 2020  until we.       
-00042300: 2072 6561 6368 2061 2073 7465 6164 7920   reach a steady 
-00042310: 7374 6174 650a 2020 2020 2020 2020 2222  state.        ""
-00042320: 220a 2020 2020 2020 2020 636c 6965 6e74  ".        client
-00042330: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-00042340: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00042350: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-00042360: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
-00042370: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
-00042380: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00042390: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-000423a0: 7367 732c 2073 7469 6d75 6c75 735f 6964  sgs, stimulus_id
-000423b0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-000423c0: 656e 645f 616c 6c28 636c 6965 6e74 5f6d  end_all(client_m
-000423d0: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-000423e0: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-000423f0: 2067 6574 5f73 746f 7279 2873 656c 662c   get_story(self,
-00042400: 206b 6579 735f 6f72 5f73 7469 6d75 6c69   keys_or_stimuli
-00042410: 3a20 4974 6572 6162 6c65 5b73 7472 5d29  : Iterable[str])
-00042420: 202d 3e20 6c69 7374 5b54 7261 6e73 6974   -> list[Transit
-00042430: 696f 6e5d 3a0a 2020 2020 2020 2020 2222  ion]:.        ""
-00042440: 2252 5043 2068 6f6f 6b20 666f 7220 3a6d  "RPC hook for :m
-00042450: 6574 683a 6053 6368 6564 756c 6572 5374  eth:`SchedulerSt
-00042460: 6174 652e 7374 6f72 7960 2e0a 0a20 2020  ate.story`...   
-00042470: 2020 2020 204e 6f74 6520 7468 6174 2074       Note that t
-00042480: 6865 206d 7367 7061 636b 2073 6572 6961  he msgpack seria
-00042490: 6c69 7a61 7469 6f6e 2f64 6573 6572 6961  lization/deseria
-000424a0: 6c69 7a61 7469 6f6e 2072 6f75 6e64 2d74  lization round-t
-000424b0: 7269 7020 7769 6c6c 2074 7261 6e73 666f  rip will transfo
-000424c0: 726d 0a20 2020 2020 2020 2074 6865 203a  rm.        the :
-000424d0: 636c 6173 733a 6054 7261 6e73 6974 696f  class:`Transitio
-000424e0: 6e60 206e 616d 6564 7475 706c 6573 2069  n` namedtuples i
-000424f0: 6e74 6f20 7265 6775 6c61 7220 7475 706c  nto regular tupl
-00042500: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
-00042510: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00042520: 656c 662e 7374 6f72 7928 2a6b 6579 735f  elf.story(*keys_
-00042530: 6f72 5f73 7469 6d75 6c69 290a 0a20 2020  or_stimuli)..   
-00042540: 2064 6566 205f 7265 7363 6865 6475 6c65   def _reschedule
-00042550: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-00042560: 6b65 793a 2073 7472 2c20 776f 726b 6572  key: str, worker
-00042570: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-00042580: 6f6e 652c 202a 2c20 7374 696d 756c 7573  one, *, stimulus
-00042590: 5f69 643a 2073 7472 0a20 2020 2029 202d  _id: str.    ) -
-000425a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000425b0: 2222 2252 6573 6368 6564 756c 6520 6120  """Reschedule a 
-000425c0: 7461 736b 2e0a 0a20 2020 2020 2020 2054  task...        T
-000425d0: 6869 7320 6675 6e63 7469 6f6e 2073 686f  his function sho
-000425e0: 756c 6420 6f6e 6c79 2062 6520 7573 6564  uld only be used
-000425f0: 2077 6865 6e20 7468 6520 7461 736b 2068   when the task h
-00042600: 6173 2061 6c72 6561 6479 2062 6565 6e20  as already been 
-00042610: 7265 6c65 6173 6564 2069 6e0a 2020 2020  released in.    
-00042620: 2020 2020 736f 6d65 2077 6179 206f 6e20      some way on 
-00042630: 7468 6520 776f 726b 6572 2069 7427 7320  the worker it's 
-00042640: 6173 7369 676e 6564 2074 6f20 e280 9420  assigned to ... 
-00042650: 6569 7468 6572 2076 6961 2063 616e 6365  either via cance
-00042660: 6c6c 6174 696f 6e20 6f72 2061 0a20 2020  llation or a.   
-00042670: 2020 2020 2052 6573 6368 6564 756c 6520       Reschedule 
-00042680: 6578 6365 7074 696f 6e20 e280 9420 616e  exception ... an
-00042690: 6420 796f 7520 6172 6520 6365 7274 6169  d you are certai
-000426a0: 6e20 7468 6520 776f 726b 6572 2077 696c  n the worker wil
-000426b0: 6c20 6e6f 7420 7365 6e64 2061 6e79 2066  l not send any f
-000426c0: 7572 7468 6572 0a20 2020 2020 2020 2075  urther.        u
-000426d0: 7064 6174 6573 2061 626f 7574 2074 6865  pdates about the
-000426e0: 2074 6173 6b20 746f 2074 6865 2073 6368   task to the sch
-000426f0: 6564 756c 6572 2e0a 2020 2020 2020 2020  eduler..        
-00042700: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00042710: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
-00042720: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00042730: 5d0a 2020 2020 2020 2020 6578 6365 7074  ].        except
-00042740: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
-00042750: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00042760: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
-00042770: 2020 2020 2020 2066 2241 7474 656d 7074         f"Attempt
-00042780: 696e 6720 746f 2072 6573 6368 6564 756c  ing to reschedul
-00042790: 6520 7461 736b 207b 6b65 797d 2c20 7768  e task {key}, wh
-000427a0: 6963 6820 7761 7320 6e6f 7420 220a 2020  ich was not ".  
-000427b0: 2020 2020 2020 2020 2020 2020 2020 2266                "f
-000427c0: 6f75 6e64 206f 6e20 7468 6520 7363 6865  ound on the sche
-000427d0: 6475 6c65 722e 2041 626f 7274 696e 6720  duler. Aborting 
-000427e0: 7265 7363 6865 6475 6c65 2e22 0a20 2020  reschedule.".   
-000427f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00042800: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00042810: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-00042820: 6520 213d 2022 7072 6f63 6573 7369 6e67  e != "processing
-00042830: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-00042840: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
-00042850: 2077 6f72 6b65 7220 616e 6420 7473 2e70   worker and ts.p
-00042860: 726f 6365 7373 696e 675f 6f6e 2061 6e64  rocessing_on and
-00042870: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00042880: 6e2e 6164 6472 6573 7320 213d 2077 6f72  n.address != wor
-00042890: 6b65 723a 0a20 2020 2020 2020 2020 2020  ker:.           
-000428a0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-000428b0: 2320 7472 616e 7369 7469 6f6e 5f70 726f  # transition_pro
-000428c0: 6365 7373 696e 675f 7265 6c65 6173 6564  cessing_released
-000428d0: 2077 696c 6c20 696d 6d65 6469 6174 656c   will immediatel
-000428e0: 7920 7375 6767 6573 7420 616e 2061 6464  y suggest an add
-000428f0: 6974 696f 6e61 6c0a 2020 2020 2020 2020  itional.        
-00042900: 2320 7472 616e 7369 7469 6f6e 2074 6f20  # transition to 
-00042910: 7761 6974 696e 6720 6966 2074 6865 2074  waiting if the t
-00042920: 6173 6b20 6861 7320 616e 7920 7761 6974  ask has any wait
-00042930: 6572 7320 6f72 2063 6c69 656e 7473 2068  ers or clients h
-00042940: 6f6c 6469 6e67 2061 2066 7574 7572 652e  olding a future.
-00042950: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
-00042960: 616e 7369 7469 6f6e 7328 7b6b 6579 3a20  ansitions({key: 
-00042970: 2272 656c 6561 7365 6422 7d2c 2073 7469  "released"}, sti
-00042980: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-00042990: 735f 6964 290a 0a20 2020 2023 2323 2323  s_id)..    #####
-000429a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000429b0: 0a20 2020 2023 2055 7469 6c69 7479 2066  .    # Utility f
-000429c0: 756e 6374 696f 6e73 2023 0a20 2020 2023  unctions #.    #
-000429d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000429e0: 2323 2323 0a0a 2020 2020 6465 6620 6164  ####..    def ad
-000429f0: 645f 7265 736f 7572 6365 7328 0a20 2020  d_resources(.   
-00042a00: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-00042a10: 723a 2073 7472 2c20 7265 736f 7572 6365  r: str, resource
-00042a20: 733a 2064 6963 7420 7c20 4e6f 6e65 203d  s: dict | None =
-00042a30: 204e 6f6e 650a 2020 2020 2920 2d3e 204c   None.    ) -> L
-00042a40: 6974 6572 616c 5b22 4f4b 225d 3a0a 2020  iteral["OK"]:.  
-00042a50: 2020 2020 2020 7773 3a20 576f 726b 6572        ws: Worker
-00042a60: 5374 6174 6520 3d20 7365 6c66 2e77 6f72  State = self.wor
-00042a70: 6b65 7273 5b77 6f72 6b65 725d 0a20 2020  kers[worker].   
-00042a80: 2020 2020 2069 6620 7265 736f 7572 6365       if resource
-00042a90: 733a 0a20 2020 2020 2020 2020 2020 2077  s:.            w
-00042aa0: 732e 7265 736f 7572 6365 732e 7570 6461  s.resources.upda
-00042ab0: 7465 2872 6573 6f75 7263 6573 290a 2020  te(resources).  
-00042ac0: 2020 2020 2020 7773 2e75 7365 645f 7265        ws.used_re
-00042ad0: 736f 7572 6365 7320 3d20 7b7d 0a20 2020  sources = {}.   
-00042ae0: 2020 2020 2066 6f72 2072 6573 6f75 7263       for resourc
-00042af0: 652c 2071 7561 6e74 6974 7920 696e 2077  e, quantity in w
-00042b00: 732e 7265 736f 7572 6365 732e 6974 656d  s.resources.item
-00042b10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00042b20: 2077 732e 7573 6564 5f72 6573 6f75 7263   ws.used_resourc
-00042b30: 6573 5b72 6573 6f75 7263 655d 203d 2030  es[resource] = 0
-00042b40: 0a20 2020 2020 2020 2020 2020 2064 7220  .            dr 
-00042b50: 3d20 7365 6c66 2e72 6573 6f75 7263 6573  = self.resources
-00042b60: 2e67 6574 2872 6573 6f75 7263 652c 204e  .get(resource, N
-00042b70: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-00042b80: 2069 6620 6472 2069 7320 4e6f 6e65 3a0a   if dr is None:.
-00042b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042ba0: 7365 6c66 2e72 6573 6f75 7263 6573 5b72  self.resources[r
-00042bb0: 6573 6f75 7263 655d 203d 2064 7220 3d20  esource] = dr = 
-00042bc0: 7b7d 0a20 2020 2020 2020 2020 2020 2064  {}.            d
-00042bd0: 725b 776f 726b 6572 5d20 3d20 7175 616e  r[worker] = quan
-00042be0: 7469 7479 0a20 2020 2020 2020 2072 6574  tity.        ret
-00042bf0: 7572 6e20 224f 4b22 0a0a 2020 2020 6465  urn "OK"..    de
-00042c00: 6620 7265 6d6f 7665 5f72 6573 6f75 7263  f remove_resourc
-00042c10: 6573 2873 656c 662c 2077 6f72 6b65 723a  es(self, worker:
-00042c20: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00042c30: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
-00042c40: 7253 7461 7465 203d 2073 656c 662e 776f  rState = self.wo
-00042c50: 726b 6572 735b 776f 726b 6572 5d0a 2020  rkers[worker].  
-00042c60: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
-00042c70: 6365 2069 6e20 7773 2e72 6573 6f75 7263  ce in ws.resourc
-00042c80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00042c90: 6472 203d 2073 656c 662e 7265 736f 7572  dr = self.resour
-00042ca0: 6365 732e 7365 7464 6566 6175 6c74 2872  ces.setdefault(r
-00042cb0: 6573 6f75 7263 652c 207b 7d29 0a20 2020  esource, {}).   
-00042cc0: 2020 2020 2020 2020 2064 656c 2064 725b           del dr[
-00042cd0: 776f 726b 6572 5d0a 0a20 2020 2064 6566  worker]..    def
-00042ce0: 2063 6f65 7263 655f 6164 6472 6573 7328   coerce_address(
-00042cf0: 7365 6c66 2c20 6164 6472 3a20 7374 7220  self, addr: str 
-00042d00: 7c20 7475 706c 652c 2072 6573 6f6c 7665  | tuple, resolve
-00042d10: 3a20 626f 6f6c 203d 2054 7275 6529 202d  : bool = True) -
-00042d20: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
-00042d30: 2222 0a20 2020 2020 2020 2043 6f65 7263  "".        Coerc
-00042d40: 6520 706f 7373 6962 6c65 2069 6e70 7574  e possible input
-00042d50: 2061 6464 7265 7373 6573 2074 6f20 6361   addresses to ca
-00042d60: 6e6f 6e69 6361 6c20 666f 726d 2e0a 2020  nonical form..  
-00042d70: 2020 2020 2020 2a72 6573 6f6c 7665 2a20        *resolve* 
-00042d80: 6361 6e20 6265 2064 6973 6162 6c65 6420  can be disabled 
-00042d90: 666f 7220 7465 7374 696e 6720 7769 7468  for testing with
-00042da0: 2066 616b 6520 686f 7374 6e61 6d65 732e   fake hostnames.
-00042db0: 0a0a 2020 2020 2020 2020 4861 6e64 6c65  ..        Handle
-00042dc0: 7320 7374 7269 6e67 732c 2074 7570 6c65  s strings, tuple
-00042dd0: 732c 206f 7220 616c 6961 7365 732e 0a20  s, or aliases.. 
-00042de0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00042df0: 2020 2023 2058 5858 2068 6f77 206d 616e     # XXX how man
-00042e00: 7920 6164 6472 6573 732d 7061 7273 696e  y address-parsin
-00042e10: 6720 726f 7574 696e 6573 2064 6f20 7765  g routines do we
-00042e20: 2068 6176 653f 0a20 2020 2020 2020 2069   have?.        i
-00042e30: 6620 6164 6472 2069 6e20 7365 6c66 2e61  f addr in self.a
-00042e40: 6c69 6173 6573 3a0a 2020 2020 2020 2020  liases:.        
-00042e50: 2020 2020 6164 6472 203d 2073 656c 662e      addr = self.
-00042e60: 616c 6961 7365 735b 6164 6472 5d0a 2020  aliases[addr].  
-00042e70: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00042e80: 6e63 6528 6164 6472 2c20 7475 706c 6529  nce(addr, tuple)
-00042e90: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-00042ea0: 6472 203d 2075 6e70 6172 7365 5f68 6f73  dr = unparse_hos
-00042eb0: 745f 706f 7274 282a 6164 6472 290a 2020  t_port(*addr).  
-00042ec0: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00042ed0: 6e73 7461 6e63 6528 6164 6472 2c20 7374  nstance(addr, st
-00042ee0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00042ef0: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00042f00: 6622 6164 6472 6573 7365 7320 7368 6f75  f"addresses shou
-00042f10: 6c64 2062 6520 7374 7269 6e67 7320 6f72  ld be strings or
-00042f20: 2074 7570 6c65 732c 2067 6f74 207b 6164   tuples, got {ad
-00042f30: 6472 2172 7d22 290a 0a20 2020 2020 2020  dr!r}")..       
-00042f40: 2069 6620 7265 736f 6c76 653a 0a20 2020   if resolve:.   
-00042f50: 2020 2020 2020 2020 2061 6464 7220 3d20           addr = 
-00042f60: 7265 736f 6c76 655f 6164 6472 6573 7328  resolve_address(
-00042f70: 6164 6472 290a 2020 2020 2020 2020 656c  addr).        el
-00042f80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00042f90: 6164 6472 203d 206e 6f72 6d61 6c69 7a65  addr = normalize
-00042fa0: 5f61 6464 7265 7373 2861 6464 7229 0a0a  _address(addr)..
-00042fb0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-00042fc0: 6464 720a 0a20 2020 2064 6566 2077 6f72  ddr..    def wor
-00042fd0: 6b65 7273 5f6c 6973 7428 7365 6c66 2c20  kers_list(self, 
-00042fe0: 776f 726b 6572 733a 2049 7465 7261 626c  workers: Iterabl
-00042ff0: 655b 7374 725d 207c 204e 6f6e 6529 202d  e[str] | None) -
-00043000: 3e20 6c69 7374 5b73 7472 5d3a 0a20 2020  > list[str]:.   
-00043010: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00043020: 204c 6973 7420 6f66 2071 7561 6c69 6679   List of qualify
-00043030: 696e 6720 776f 726b 6572 730a 0a20 2020  ing workers..   
-00043040: 2020 2020 2054 616b 6573 2061 206c 6973       Takes a lis
-00043050: 7420 6f66 2077 6f72 6b65 7220 6164 6472  t of worker addr
-00043060: 6573 7365 7320 6f72 2068 6f73 746e 616d  esses or hostnam
-00043070: 6573 2e0a 2020 2020 2020 2020 5265 7475  es..        Retu
-00043080: 726e 7320 6120 6c69 7374 206f 6620 616c  rns a list of al
-00043090: 6c20 776f 726b 6572 2061 6464 7265 7373  l worker address
-000430a0: 6573 2074 6861 7420 6d61 7463 680a 2020  es that match.  
-000430b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000430c0: 2020 6966 2077 6f72 6b65 7273 2069 7320    if workers is 
-000430d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000430e0: 2020 7265 7475 726e 206c 6973 7428 7365    return list(se
-000430f0: 6c66 2e77 6f72 6b65 7273 290a 0a20 2020  lf.workers)..   
-00043100: 2020 2020 206f 7574 203d 2073 6574 2829       out = set()
-00043110: 0a20 2020 2020 2020 2066 6f72 2077 2069  .        for w i
-00043120: 6e20 776f 726b 6572 733a 0a20 2020 2020  n workers:.     
-00043130: 2020 2020 2020 2069 6620 223a 2220 696e         if ":" in
-00043140: 2077 3a0a 2020 2020 2020 2020 2020 2020   w:.            
-00043150: 2020 2020 6f75 742e 6164 6428 7729 0a20      out.add(w). 
-00043160: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00043170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043180: 206f 7574 2e75 7064 6174 6528 7b77 7720   out.update({ww 
-00043190: 666f 7220 7777 2069 6e20 7365 6c66 2e77  for ww in self.w
-000431a0: 6f72 6b65 7273 2069 6620 7720 696e 2077  orkers if w in w
-000431b0: 777d 2920 2023 2054 4f44 4f3a 2071 7561  w})  # TODO: qua
-000431c0: 6472 6174 6963 0a20 2020 2020 2020 2072  dratic.        r
-000431d0: 6574 7572 6e20 6c69 7374 286f 7574 290a  eturn list(out).
-000431e0: 0a20 2020 2061 7379 6e63 2064 6566 2067  .    async def g
-000431f0: 6574 5f70 726f 6669 6c65 280a 2020 2020  et_profile(.    
-00043200: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00043210: 2020 636f 6d6d 3d4e 6f6e 652c 0a20 2020    comm=None,.   
-00043220: 2020 2020 2077 6f72 6b65 7273 3d4e 6f6e       workers=Non
-00043230: 652c 0a20 2020 2020 2020 2073 6368 6564  e,.        sched
-00043240: 756c 6572 3d46 616c 7365 2c0a 2020 2020  uler=False,.    
-00043250: 2020 2020 7365 7276 6572 3d46 616c 7365      server=False
-00043260: 2c0a 2020 2020 2020 2020 6d65 7267 655f  ,.        merge_
-00043270: 776f 726b 6572 733d 5472 7565 2c0a 2020  workers=True,.  
-00043280: 2020 2020 2020 7374 6172 743d 4e6f 6e65        start=None
-00043290: 2c0a 2020 2020 2020 2020 7374 6f70 3d4e  ,.        stop=N
-000432a0: 6f6e 652c 0a20 2020 2020 2020 206b 6579  one,.        key
-000432b0: 3d4e 6f6e 652c 0a20 2020 2029 3a0a 2020  =None,.    ):.  
-000432c0: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
-000432d0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000432e0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-000432f0: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
-00043300: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00043310: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00043320: 2073 6574 2873 656c 662e 776f 726b 6572   set(self.worker
-00043330: 7329 2026 2073 6574 2877 6f72 6b65 7273  s) & set(workers
-00043340: 290a 0a20 2020 2020 2020 2069 6620 7363  )..        if sc
-00043350: 6865 6475 6c65 723a 0a20 2020 2020 2020  heduler:.       
-00043360: 2020 2020 2072 6574 7572 6e20 7072 6f66       return prof
-00043370: 696c 652e 6765 745f 7072 6f66 696c 6528  ile.get_profile(
-00043380: 7365 6c66 2e69 6f5f 6c6f 6f70 2e70 726f  self.io_loop.pro
-00043390: 6669 6c65 2c20 7374 6172 743d 7374 6172  file, start=star
-000433a0: 742c 2073 746f 703d 7374 6f70 290a 0a20  t, stop=stop).. 
-000433b0: 2020 2020 2020 2072 6573 756c 7473 203d         results =
-000433c0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-000433d0: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-000433e0: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
-000433f0: 2020 2020 2020 7365 6c66 2e72 7063 2877        self.rpc(w
-00043400: 292e 7072 6f66 696c 6528 7374 6172 743d  ).profile(start=
-00043410: 7374 6172 742c 2073 746f 703d 7374 6f70  start, stop=stop
-00043420: 2c20 6b65 793d 6b65 792c 2073 6572 7665  , key=key, serve
-00043430: 723d 7365 7276 6572 290a 2020 2020 2020  r=server).      
-00043440: 2020 2020 2020 2020 2020 666f 7220 7720            for w 
-00043450: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
-00043460: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00043470: 2020 2020 2020 7265 7475 726e 5f65 7863        return_exc
-00043480: 6570 7469 6f6e 733d 5472 7565 2c0a 2020  eptions=True,.  
-00043490: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000434a0: 2072 6573 756c 7473 203d 205b 7220 666f   results = [r fo
-000434b0: 7220 7220 696e 2072 6573 756c 7473 2069  r r in results i
-000434c0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-000434d0: 2872 2c20 4578 6365 7074 696f 6e29 5d0a  (r, Exception)].
-000434e0: 0a20 2020 2020 2020 2069 6620 6d65 7267  .        if merg
-000434f0: 655f 776f 726b 6572 733a 0a20 2020 2020  e_workers:.     
-00043500: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-00043510: 3d20 7072 6f66 696c 652e 6d65 7267 6528  = profile.merge(
-00043520: 2a72 6573 756c 7473 290a 2020 2020 2020  *results).      
-00043530: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00043540: 2020 2020 7265 7370 6f6e 7365 203d 2064      response = d
-00043550: 6963 7428 7a69 7028 776f 726b 6572 732c  ict(zip(workers,
-00043560: 2072 6573 756c 7473 2929 0a20 2020 2020   results)).     
-00043570: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
-00043580: 7365 0a0a 2020 2020 6173 796e 6320 6465  se..    async de
-00043590: 6620 6765 745f 7072 6f66 696c 655f 6d65  f get_profile_me
-000435a0: 7461 6461 7461 280a 2020 2020 2020 2020  tadata(.        
-000435b0: 7365 6c66 2c0a 2020 2020 2020 2020 776f  self,.        wo
-000435c0: 726b 6572 733a 2022 4974 6572 6162 6c65  rkers: "Iterable
-000435d0: 5b73 7472 5d20 7c20 4e6f 6e65 2220 3d20  [str] | None" = 
-000435e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7374  None,.        st
-000435f0: 6172 743a 2066 6c6f 6174 203d 2030 2c0a  art: float = 0,.
-00043600: 2020 2020 2020 2020 7374 6f70 3a20 2266          stop: "f
-00043610: 6c6f 6174 207c 204e 6f6e 6522 203d 204e  loat | None" = N
-00043620: 6f6e 652c 0a20 2020 2020 2020 2070 726f  one,.        pro
-00043630: 6669 6c65 5f63 7963 6c65 5f69 6e74 6572  file_cycle_inter
-00043640: 7661 6c3a 2022 7374 7220 7c20 666c 6f61  val: "str | floa
-00043650: 7420 7c20 4e6f 6e65 2220 3d20 4e6f 6e65  t | None" = None
-00043660: 2c0a 2020 2020 2920 2d3e 2064 6963 743a  ,.    ) -> dict:
-00043670: 0a20 2020 2020 2020 2064 7420 3d20 7072  .        dt = pr
-00043680: 6f66 696c 655f 6379 636c 655f 696e 7465  ofile_cycle_inte
-00043690: 7276 616c 206f 7220 6461 736b 2e63 6f6e  rval or dask.con
-000436a0: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-000436b0: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
-000436c0: 642e 776f 726b 6572 2e70 726f 6669 6c65  d.worker.profile
-000436d0: 2e63 7963 6c65 220a 2020 2020 2020 2020  .cycle".        
-000436e0: 290a 2020 2020 2020 2020 6474 203d 2070  ).        dt = p
-000436f0: 6172 7365 5f74 696d 6564 656c 7461 2864  arse_timedelta(d
-00043700: 742c 2064 6566 6175 6c74 3d22 6d73 2229  t, default="ms")
-00043710: 0a0a 2020 2020 2020 2020 6966 2077 6f72  ..        if wor
-00043720: 6b65 7273 2069 7320 4e6f 6e65 3a0a 2020  kers is None:.  
-00043730: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00043740: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-00043750: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00043760: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00043770: 7273 203d 2073 6574 2873 656c 662e 776f  rs = set(self.wo
-00043780: 726b 6572 7329 2026 2073 6574 2877 6f72  rkers) & set(wor
-00043790: 6b65 7273 290a 2020 2020 2020 2020 7265  kers).        re
-000437a0: 7375 6c74 7320 3d20 6177 6169 7420 6173  sults = await as
-000437b0: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
-000437c0: 2020 2020 2020 2020 2020 2a28 7365 6c66            *(self
-000437d0: 2e72 7063 2877 292e 7072 6f66 696c 655f  .rpc(w).profile_
-000437e0: 6d65 7461 6461 7461 2873 7461 7274 3d73  metadata(start=s
-000437f0: 7461 7274 2c20 7374 6f70 3d73 746f 7029  tart, stop=stop)
-00043800: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
-00043810: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00043820: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00043830: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00043840: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00043850: 7473 203d 205b 7220 666f 7220 7220 696e  ts = [r for r in
-00043860: 2072 6573 756c 7473 2069 6620 6e6f 7420   results if not 
-00043870: 6973 696e 7374 616e 6365 2872 2c20 4578  isinstance(r, Ex
-00043880: 6365 7074 696f 6e29 5d0a 2020 2020 2020  ception)].      
-00043890: 2020 636f 756e 7473 203d 205b 0a20 2020    counts = [.   
-000438a0: 2020 2020 2020 2020 2028 7469 6d65 2c20           (time, 
-000438b0: 7375 6d28 706c 7563 6b28 312c 2067 726f  sum(pluck(1, gro
-000438c0: 7570 2929 290a 2020 2020 2020 2020 2020  up))).          
-000438d0: 2020 666f 7220 7469 6d65 2c20 6772 6f75    for time, grou
-000438e0: 7020 696e 2069 7465 7274 6f6f 6c73 2e67  p in itertools.g
-000438f0: 726f 7570 6279 280a 2020 2020 2020 2020  roupby(.        
-00043900: 2020 2020 2020 2020 6d65 7267 655f 736f          merge_so
-00043910: 7274 6564 280a 2020 2020 2020 2020 2020  rted(.          
-00043920: 2020 2020 2020 2020 2020 2a28 765b 2263            *(v["c
-00043930: 6f75 6e74 7322 5d20 666f 7220 7620 696e  ounts"] for v in
-00043940: 2072 6573 756c 7473 292c 0a20 2020 2020   results),.     
-00043950: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00043960: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00043970: 6d62 6461 2074 3a20 745b 305d 202f 2f20  mbda t: t[0] // 
-00043980: 6474 202a 2064 742c 0a20 2020 2020 2020  dt * dt,.       
-00043990: 2020 2020 2029 0a20 2020 2020 2020 205d       ).        ]
-000439a0: 0a0a 2020 2020 2020 2020 6b65 7973 3a20  ..        keys: 
-000439b0: 6469 6374 5b73 7472 2c20 6c69 7374 5b6c  dict[str, list[l
-000439c0: 6973 745d 5d20 3d20 7b0a 2020 2020 2020  ist]] = {.      
-000439d0: 2020 2020 2020 6b3a 205b 5d20 666f 7220        k: [] for 
-000439e0: 7620 696e 2072 6573 756c 7473 2066 6f72  v in results for
-000439f0: 2074 2c20 6420 696e 2076 5b22 6b65 7973   t, d in v["keys
-00043a00: 225d 2066 6f72 206b 2069 6e20 640a 2020  "] for k in d.  
-00043a10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00043a20: 2067 726f 7570 7331 203d 205b 765b 226b   groups1 = [v["k
-00043a30: 6579 7322 5d20 666f 7220 7620 696e 2072  eys"] for v in r
-00043a40: 6573 756c 7473 5d0a 2020 2020 2020 2020  esults].        
-00043a50: 6772 6f75 7073 3220 3d20 6c69 7374 286d  groups2 = list(m
-00043a60: 6572 6765 5f73 6f72 7465 6428 2a67 726f  erge_sorted(*gro
-00043a70: 7570 7331 2c20 6b65 793d 6669 7273 7429  ups1, key=first)
-00043a80: 290a 0a20 2020 2020 2020 206c 6173 7420  )..        last 
-00043a90: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
-00043aa0: 742c 2064 2069 6e20 6772 6f75 7073 323a  t, d in groups2:
-00043ab0: 0a20 2020 2020 2020 2020 2020 2074 7420  .            tt 
-00043ac0: 3d20 7420 2f2f 2064 7420 2a20 6474 0a20  = t // dt * dt. 
-00043ad0: 2020 2020 2020 2020 2020 2069 6620 7474             if tt
-00043ae0: 203e 206c 6173 743a 0a20 2020 2020 2020   > last:.       
-00043af0: 2020 2020 2020 2020 206c 6173 7420 3d20           last = 
-00043b00: 7474 0a20 2020 2020 2020 2020 2020 2020  tt.             
-00043b10: 2020 2066 6f72 2076 2069 6e20 6b65 7973     for v in keys
-00043b20: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-00043b30: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00043b40: 2e61 7070 656e 6428 5b74 742c 2030 5d29  .append([tt, 0])
-00043b50: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00043b60: 206b 2c20 7620 696e 2064 2e69 7465 6d73   k, v in d.items
-00043b70: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00043b80: 2020 2020 6b65 7973 5b6b 5d5b 2d31 5d5b      keys[k][-1][
-00043b90: 315d 202b 3d20 760a 0a20 2020 2020 2020  1] += v..       
-00043ba0: 2072 6574 7572 6e20 7b22 636f 756e 7473   return {"counts
-00043bb0: 223a 2063 6f75 6e74 732c 2022 6b65 7973  ": counts, "keys
-00043bc0: 223a 206b 6579 737d 0a0a 2020 2020 6173  ": keys}..    as
-00043bd0: 796e 6320 6465 6620 7065 7266 6f72 6d61  ync def performa
-00043be0: 6e63 655f 7265 706f 7274 280a 2020 2020  nce_report(.    
-00043bf0: 2020 2020 7365 6c66 2c20 7374 6172 743a      self, start:
-00043c00: 2066 6c6f 6174 2c20 6c61 7374 5f63 6f75   float, last_cou
-00043c10: 6e74 3a20 696e 742c 2063 6f64 653a 2073  nt: int, code: s
-00043c20: 7472 203d 2022 222c 206d 6f64 653a 2073  tr = "", mode: s
-00043c30: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00043c40: 0a20 2020 2029 202d 3e20 7374 723a 0a20  .    ) -> str:. 
-00043c50: 2020 2020 2020 2073 746f 7020 3d20 7469         stop = ti
-00043c60: 6d65 2829 0a20 2020 2020 2020 2023 2050  me().        # P
-00043c70: 726f 6669 6c65 730a 2020 2020 2020 2020  rofiles.        
-00043c80: 636f 6d70 7574 652c 2073 6368 6564 756c  compute, schedul
-00043c90: 6572 2c20 776f 726b 6572 7320 3d20 6177  er, workers = aw
-00043ca0: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
-00043cb0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-00043cc0: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
-00043cd0: 2020 2073 656c 662e 6765 745f 7072 6f66     self.get_prof
-00043ce0: 696c 6528 7374 6172 743d 7374 6172 7429  ile(start=start)
-00043cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00043d00: 2020 7365 6c66 2e67 6574 5f70 726f 6669    self.get_profi
-00043d10: 6c65 2873 6368 6564 756c 6572 3d54 7275  le(scheduler=Tru
-00043d20: 652c 2073 7461 7274 3d73 7461 7274 292c  e, start=start),
-00043d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043d40: 2073 656c 662e 6765 745f 7072 6f66 696c   self.get_profil
-00043d50: 6528 7365 7276 6572 3d54 7275 652c 2073  e(server=True, s
-00043d60: 7461 7274 3d73 7461 7274 292c 0a20 2020  tart=start),.   
-00043d70: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00043d80: 2020 2029 0a20 2020 2020 2020 2066 726f     ).        fro
-00043d90: 6d20 6469 7374 7269 6275 7465 6420 696d  m distributed im
-00043da0: 706f 7274 2070 726f 6669 6c65 0a0a 2020  port profile..  
-00043db0: 2020 2020 2020 6465 6620 7072 6f66 696c        def profil
-00043dc0: 655f 746f 5f66 6967 7572 6528 7374 6174  e_to_figure(stat
-00043dd0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00043de0: 6461 7461 203d 2070 726f 6669 6c65 2e70  data = profile.p
-00043df0: 6c6f 745f 6461 7461 2873 7461 7465 290a  lot_data(state).
-00043e00: 2020 2020 2020 2020 2020 2020 6669 6775              figu
-00043e10: 7265 2c20 736f 7572 6365 203d 2070 726f  re, source = pro
-00043e20: 6669 6c65 2e70 6c6f 745f 6669 6775 7265  file.plot_figure
-00043e30: 2864 6174 612c 2073 697a 696e 675f 6d6f  (data, sizing_mo
-00043e40: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
-00043e50: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00043e60: 6574 7572 6e20 6669 6775 7265 0a0a 2020  eturn figure..  
-00043e70: 2020 2020 2020 636f 6d70 7574 652c 2073        compute, s
-00043e80: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
-00043e90: 7320 3d20 6d61 7028 0a20 2020 2020 2020  s = map(.       
-00043ea0: 2020 2020 2070 726f 6669 6c65 5f74 6f5f       profile_to_
-00043eb0: 6669 6775 7265 2c20 2863 6f6d 7075 7465  figure, (compute
-00043ec0: 2c20 7363 6865 6475 6c65 722c 2077 6f72  , scheduler, wor
-00043ed0: 6b65 7273 290a 2020 2020 2020 2020 290a  kers).        ).
-00043ee0: 0a20 2020 2020 2020 2023 2054 6173 6b20  .        # Task 
-00043ef0: 7374 7265 616d 0a20 2020 2020 2020 2074  stream.        t
-00043f00: 6173 6b5f 7374 7265 616d 203d 2073 656c  ask_stream = sel
-00043f10: 662e 6765 745f 7461 736b 5f73 7472 6561  f.get_task_strea
-00043f20: 6d28 7374 6172 743d 7374 6172 7429 0a20  m(start=start). 
-00043f30: 2020 2020 2020 2074 6f74 616c 5f74 6173         total_tas
-00043f40: 6b73 203d 206c 656e 2874 6173 6b5f 7374  ks = len(task_st
-00043f50: 7265 616d 290a 2020 2020 2020 2020 7469  ream).        ti
-00043f60: 6d65 7370 656e 743a 2064 6566 6175 6c74  mespent: default
-00043f70: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
-00043f80: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-00043f90: 6c6f 6174 290a 2020 2020 2020 2020 666f  loat).        fo
-00043fa0: 7220 6420 696e 2074 6173 6b5f 7374 7265  r d in task_stre
-00043fb0: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
-00043fc0: 666f 7220 7820 696e 2064 5b22 7374 6172  for x in d["star
-00043fd0: 7473 746f 7073 225d 3a0a 2020 2020 2020  tstops"]:.      
-00043fe0: 2020 2020 2020 2020 2020 7469 6d65 7370            timesp
-00043ff0: 656e 745b 785b 2261 6374 696f 6e22 5d5d  ent[x["action"]]
-00044000: 202b 3d20 785b 2273 746f 7022 5d20 2d20   += x["stop"] - 
-00044010: 785b 2273 7461 7274 225d 0a20 2020 2020  x["start"].     
-00044020: 2020 2074 6173 6b73 5f74 696d 696e 6773     tasks_timings
-00044030: 203d 2022 220a 2020 2020 2020 2020 666f   = "".        fo
-00044040: 7220 6b20 696e 2073 6f72 7465 6428 7469  r k in sorted(ti
-00044050: 6d65 7370 656e 742e 6b65 7973 2829 293a  mespent.keys()):
-00044060: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00044070: 6b73 5f74 696d 696e 6773 202b 3d20 6622  ks_timings += f"
-00044080: 5c6e 3c6c 693e 207b 6b7d 2074 696d 653a  \n<li> {k} time:
-00044090: 207b 666f 726d 6174 5f74 696d 6528 7469   {format_time(ti
-000440a0: 6d65 7370 656e 745b 6b5d 297d 203c 2f6c  mespent[k])} </l
-000440b0: 693e 220a 0a20 2020 2020 2020 2066 726f  i>"..        fro
-000440c0: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
-000440d0: 7368 626f 6172 642e 636f 6d70 6f6e 656e  shboard.componen
-000440e0: 7473 2e73 6368 6564 756c 6572 2069 6d70  ts.scheduler imp
-000440f0: 6f72 7420 7461 736b 5f73 7472 6561 6d5f  ort task_stream_
-00044100: 6669 6775 7265 0a20 2020 2020 2020 2066  figure.        f
-00044110: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00044120: 6469 6167 6e6f 7374 6963 732e 7461 736b  diagnostics.task
-00044130: 5f73 7472 6561 6d20 696d 706f 7274 2072  _stream import r
-00044140: 6563 7461 6e67 6c65 730a 0a20 2020 2020  ectangles..     
-00044150: 2020 2072 6563 7473 203d 2072 6563 7461     rects = recta
-00044160: 6e67 6c65 7328 7461 736b 5f73 7472 6561  ngles(task_strea
-00044170: 6d29 0a20 2020 2020 2020 2073 6f75 7263  m).        sourc
-00044180: 652c 2074 6173 6b5f 7374 7265 616d 203d  e, task_stream =
-00044190: 2074 6173 6b5f 7374 7265 616d 5f66 6967   task_stream_fig
-000441a0: 7572 6528 7369 7a69 6e67 5f6d 6f64 653d  ure(sizing_mode=
-000441b0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-000441c0: 2020 2020 2020 2020 736f 7572 6365 2e64          source.d
-000441d0: 6174 612e 7570 6461 7465 2872 6563 7473  ata.update(rects
-000441e0: 290a 0a20 2020 2020 2020 2023 2042 616e  )..        # Ban
-000441f0: 6477 6964 7468 0a20 2020 2020 2020 2066  dwidth.        f
-00044200: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00044210: 6461 7368 626f 6172 642e 636f 6d70 6f6e  dashboard.compon
-00044220: 656e 7473 2e73 6368 6564 756c 6572 2069  ents.scheduler i
-00044230: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
-00044240: 2020 2020 4261 6e64 7769 6474 6854 7970      BandwidthTyp
-00044250: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00044260: 4261 6e64 7769 6474 6857 6f72 6b65 7273  BandwidthWorkers
-00044270: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00044280: 2020 2020 2062 616e 6477 6964 7468 5f77       bandwidth_w
-00044290: 6f72 6b65 7273 203d 2042 616e 6477 6964  orkers = Bandwid
-000442a0: 7468 576f 726b 6572 7328 7365 6c66 2c20  thWorkers(self, 
-000442b0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-000442c0: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
-000442d0: 2020 2020 6261 6e64 7769 6474 685f 776f      bandwidth_wo
-000442e0: 726b 6572 732e 7570 6461 7465 2829 0a20  rkers.update(). 
-000442f0: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
-00044300: 5f74 7970 6573 203d 2042 616e 6477 6964  _types = Bandwid
-00044310: 7468 5479 7065 7328 7365 6c66 2c20 7369  thTypes(self, si
-00044320: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
-00044330: 6368 5f62 6f74 6822 290a 2020 2020 2020  ch_both").      
-00044340: 2020 6261 6e64 7769 6474 685f 7479 7065    bandwidth_type
-00044350: 732e 7570 6461 7465 2829 0a0a 2020 2020  s.update()..    
-00044360: 2020 2020 2320 5379 7374 656d 206d 6f6e      # System mon
-00044370: 6974 6f72 0a20 2020 2020 2020 2066 726f  itor.        fro
-00044380: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
-00044390: 7368 626f 6172 642e 636f 6d70 6f6e 656e  shboard.componen
-000443a0: 7473 2e73 6861 7265 6420 696d 706f 7274  ts.shared import
-000443b0: 2053 7973 7465 6d4d 6f6e 6974 6f72 0a0a   SystemMonitor..
-000443c0: 2020 2020 2020 2020 7379 736d 6f6e 203d          sysmon =
-000443d0: 2053 7973 7465 6d4d 6f6e 6974 6f72 2873   SystemMonitor(s
-000443e0: 656c 662c 206c 6173 745f 636f 756e 743d  elf, last_count=
-000443f0: 6c61 7374 5f63 6f75 6e74 2c20 7369 7a69  last_count, sizi
-00044400: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00044410: 5f62 6f74 6822 290a 2020 2020 2020 2020  _both").        
-00044420: 7379 736d 6f6e 2e75 7064 6174 6528 290a  sysmon.update().
-00044430: 0a20 2020 2020 2020 2023 2053 6368 6564  .        # Sched
-00044440: 756c 6572 206c 6f67 730a 2020 2020 2020  uler logs.      
-00044450: 2020 6672 6f6d 2064 6973 7472 6962 7574    from distribut
-00044460: 6564 2e64 6173 6862 6f61 7264 2e63 6f6d  ed.dashboard.com
-00044470: 706f 6e65 6e74 732e 7363 6865 6475 6c65  ponents.schedule
-00044480: 7220 696d 706f 7274 2028 0a20 2020 2020  r import (.     
-00044490: 2020 2020 2020 205f 424f 4b45 485f 5354         _BOKEH_ST
-000444a0: 594c 4553 5f4b 5741 5247 532c 0a20 2020  YLES_KWARGS,.   
-000444b0: 2020 2020 2020 2020 2053 6368 6564 756c           Schedul
-000444c0: 6572 4c6f 6773 2c0a 2020 2020 2020 2020  erLogs,.        
-000444d0: 290a 0a20 2020 2020 2020 206c 6f67 7320  )..        logs 
-000444e0: 3d20 5363 6865 6475 6c65 724c 6f67 7328  = SchedulerLogs(
-000444f0: 7365 6c66 2c20 7374 6172 743d 7374 6172  self, start=star
-00044500: 7429 0a0a 2020 2020 2020 2020 6672 6f6d  t)..        from
-00044510: 2062 6f6b 6568 2e6d 6f64 656c 7320 696d   bokeh.models im
-00044520: 706f 7274 2044 6976 2c20 5461 6273 0a0a  port Div, Tabs..
-00044530: 2020 2020 2020 2020 696d 706f 7274 2064          import d
-00044540: 6973 7472 6962 7574 6564 0a20 2020 2020  istributed.     
-00044550: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
-00044560: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
-00044570: 7265 2069 6d70 6f72 7420 5461 6250 616e  re import TabPan
-00044580: 656c 0a0a 2020 2020 2020 2020 2320 4854  el..        # HT
-00044590: 4d4c 0a20 2020 2020 2020 2068 746d 6c20  ML.        html 
-000445a0: 3d20 2222 220a 2020 2020 2020 2020 3c68  = """.        <h
-000445b0: 313e 2044 6173 6b20 5065 7266 6f72 6d61  1> Dask Performa
-000445c0: 6e63 6520 5265 706f 7274 203c 2f68 313e  nce Report </h1>
-000445d0: 0a0a 2020 2020 2020 2020 3c69 3e20 5365  ..        <i> Se
-000445e0: 6c65 6374 2064 6966 6665 7265 6e74 2074  lect different t
-000445f0: 6162 7320 6f6e 2074 6865 2074 6f70 2066  abs on the top f
-00044600: 6f72 2061 6464 6974 696f 6e61 6c20 696e  or additional in
-00044610: 666f 726d 6174 696f 6e20 3c2f 693e 0a0a  formation </i>..
-00044620: 2020 2020 2020 2020 3c68 323e 2044 7572          <h2> Dur
-00044630: 6174 696f 6e3a 207b 7469 6d65 7d20 3c2f  ation: {time} </
-00044640: 6832 3e0a 2020 2020 2020 2020 3c68 323e  h2>.        <h2>
-00044650: 2054 6173 6b73 2049 6e66 6f72 6d61 7469   Tasks Informati
-00044660: 6f6e 203c 2f68 323e 0a20 2020 2020 2020  on </h2>.       
-00044670: 203c 756c 3e0a 2020 2020 2020 2020 203c   <ul>.         <
-00044680: 6c69 3e20 6e75 6d62 6572 206f 6620 7461  li> number of ta
-00044690: 736b 733a 207b 6e74 6173 6b73 7d20 3c2f  sks: {ntasks} </
-000446a0: 6c69 3e0a 2020 2020 2020 2020 207b 7461  li>.         {ta
-000446b0: 736b 735f 7469 6d69 6e67 737d 0a20 2020  sks_timings}.   
-000446c0: 2020 2020 203c 2f75 6c3e 0a0a 2020 2020       </ul>..    
-000446d0: 2020 2020 3c68 323e 2053 6368 6564 756c      <h2> Schedul
-000446e0: 6572 2049 6e66 6f72 6d61 7469 6f6e 203c  er Information <
-000446f0: 2f68 323e 0a20 2020 2020 2020 203c 756c  /h2>.        <ul
-00044700: 3e0a 2020 2020 2020 2020 2020 3c6c 693e  >.          <li>
-00044710: 2041 6464 7265 7373 3a20 7b61 6464 7265   Address: {addre
-00044720: 7373 7d20 3c2f 6c69 3e0a 2020 2020 2020  ss} </li>.      
-00044730: 2020 2020 3c6c 693e 2057 6f72 6b65 7273      <li> Workers
-00044740: 3a20 7b6e 776f 726b 6572 737d 203c 2f6c  : {nworkers} </l
-00044750: 693e 0a20 2020 2020 2020 2020 203c 6c69  i>.          <li
-00044760: 3e20 5468 7265 6164 733a 207b 7468 7265  > Threads: {thre
-00044770: 6164 737d 203c 2f6c 693e 0a20 2020 2020  ads} </li>.     
-00044780: 2020 2020 203c 6c69 3e20 4d65 6d6f 7279       <li> Memory
-00044790: 3a20 7b6d 656d 6f72 797d 203c 2f6c 693e  : {memory} </li>
-000447a0: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
-000447b0: 4461 736b 2056 6572 7369 6f6e 3a20 7b64  Dask Version: {d
-000447c0: 6173 6b5f 7665 7273 696f 6e7d 203c 2f6c  ask_version} </l
-000447d0: 693e 0a20 2020 2020 2020 2020 203c 6c69  i>.          <li
-000447e0: 3e20 4461 736b 2e44 6973 7472 6962 7574  > Dask.Distribut
-000447f0: 6564 2056 6572 7369 6f6e 3a20 7b64 6973  ed Version: {dis
-00044800: 7472 6962 7574 6564 5f76 6572 7369 6f6e  tributed_version
-00044810: 7d20 3c2f 6c69 3e0a 2020 2020 2020 2020  } </li>.        
-00044820: 3c2f 756c 3e0a 0a20 2020 2020 2020 203c  </ul>..        <
-00044830: 6832 3e20 4361 6c6c 696e 6720 436f 6465  h2> Calling Code
-00044840: 203c 2f68 323e 0a20 2020 2020 2020 203c   </h2>.        <
-00044850: 7072 653e 0a7b 636f 6465 7d0a 2020 2020  pre>.{code}.    
-00044860: 2020 2020 3c2f 7072 653e 0a20 2020 2020      </pre>.     
-00044870: 2020 2022 2222 2e66 6f72 6d61 7428 0a20     """.format(. 
-00044880: 2020 2020 2020 2020 2020 2074 696d 653d             time=
-00044890: 666f 726d 6174 5f74 696d 6528 7374 6f70  format_time(stop
-000448a0: 202d 2073 7461 7274 292c 0a20 2020 2020   - start),.     
-000448b0: 2020 2020 2020 206e 7461 736b 733d 746f         ntasks=to
-000448c0: 7461 6c5f 7461 736b 732c 0a20 2020 2020  tal_tasks,.     
-000448d0: 2020 2020 2020 2074 6173 6b73 5f74 696d         tasks_tim
-000448e0: 696e 6773 3d74 6173 6b73 5f74 696d 696e  ings=tasks_timin
-000448f0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-00044900: 6164 6472 6573 733d 7365 6c66 2e61 6464  address=self.add
-00044910: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-00044920: 2020 6e77 6f72 6b65 7273 3d6c 656e 2873    nworkers=len(s
-00044930: 656c 662e 776f 726b 6572 7329 2c0a 2020  elf.workers),.  
-00044940: 2020 2020 2020 2020 2020 7468 7265 6164            thread
-00044950: 733d 7375 6d28 7773 2e6e 7468 7265 6164  s=sum(ws.nthread
-00044960: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
-00044970: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00044980: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00044990: 6d65 6d6f 7279 3d66 6f72 6d61 745f 6279  memory=format_by
-000449a0: 7465 7328 7375 6d28 7773 2e6d 656d 6f72  tes(sum(ws.memor
-000449b0: 795f 6c69 6d69 7420 666f 7220 7773 2069  y_limit for ws i
-000449c0: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-000449d0: 616c 7565 7328 2929 292c 0a20 2020 2020  alues())),.     
-000449e0: 2020 2020 2020 2063 6f64 653d 636f 6465         code=code
-000449f0: 2c0a 2020 2020 2020 2020 2020 2020 6461  ,.            da
-00044a00: 736b 5f76 6572 7369 6f6e 3d64 6173 6b2e  sk_version=dask.
-00044a10: 5f5f 7665 7273 696f 6e5f 5f2c 0a20 2020  __version__,.   
-00044a20: 2020 2020 2020 2020 2064 6973 7472 6962           distrib
-00044a30: 7574 6564 5f76 6572 7369 6f6e 3d64 6973  uted_version=dis
-00044a40: 7472 6962 7574 6564 2e5f 5f76 6572 7369  tributed.__versi
-00044a50: 6f6e 5f5f 2c0a 2020 2020 2020 2020 290a  on__,.        ).
-00044a60: 2020 2020 2020 2020 6874 6d6c 203d 2044          html = D
-00044a70: 6976 2874 6578 743d 6874 6d6c 2c20 2a2a  iv(text=html, **
-00044a80: 5f42 4f4b 4548 5f53 5459 4c45 535f 4b57  _BOKEH_STYLES_KW
-00044a90: 4152 4753 290a 0a20 2020 2020 2020 2068  ARGS)..        h
-00044aa0: 746d 6c20 3d20 5461 6250 616e 656c 2863  tml = TabPanel(c
-00044ab0: 6869 6c64 3d68 746d 6c2c 2074 6974 6c65  hild=html, title
-00044ac0: 3d22 5375 6d6d 6172 7922 290a 2020 2020  ="Summary").    
-00044ad0: 2020 2020 636f 6d70 7574 6520 3d20 5461      compute = Ta
-00044ae0: 6250 616e 656c 2863 6869 6c64 3d63 6f6d  bPanel(child=com
-00044af0: 7075 7465 2c20 7469 746c 653d 2257 6f72  pute, title="Wor
-00044b00: 6b65 7220 5072 6f66 696c 6520 2863 6f6d  ker Profile (com
-00044b10: 7075 7465 2922 290a 2020 2020 2020 2020  pute)").        
-00044b20: 776f 726b 6572 7320 3d20 5461 6250 616e  workers = TabPan
-00044b30: 656c 2863 6869 6c64 3d77 6f72 6b65 7273  el(child=workers
-00044b40: 2c20 7469 746c 653d 2257 6f72 6b65 7220  , title="Worker 
-00044b50: 5072 6f66 696c 6520 2861 646d 696e 6973  Profile (adminis
-00044b60: 7472 6174 6976 6529 2229 0a20 2020 2020  trative)").     
-00044b70: 2020 2073 6368 6564 756c 6572 203d 2054     scheduler = T
-00044b80: 6162 5061 6e65 6c28 0a20 2020 2020 2020  abPanel(.       
-00044b90: 2020 2020 2063 6869 6c64 3d73 6368 6564       child=sched
-00044ba0: 756c 6572 2c20 7469 746c 653d 2253 6368  uler, title="Sch
-00044bb0: 6564 756c 6572 2050 726f 6669 6c65 2028  eduler Profile (
-00044bc0: 6164 6d69 6e69 7374 7261 7469 7665 2922  administrative)"
-00044bd0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00044be0: 2020 2074 6173 6b5f 7374 7265 616d 203d     task_stream =
-00044bf0: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
-00044c00: 7461 736b 5f73 7472 6561 6d2c 2074 6974  task_stream, tit
-00044c10: 6c65 3d22 5461 736b 2053 7472 6561 6d22  le="Task Stream"
-00044c20: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
-00044c30: 6474 685f 776f 726b 6572 7320 3d20 5461  dth_workers = Ta
-00044c40: 6250 616e 656c 280a 2020 2020 2020 2020  bPanel(.        
-00044c50: 2020 2020 6368 696c 643d 6261 6e64 7769      child=bandwi
-00044c60: 6474 685f 776f 726b 6572 732e 726f 6f74  dth_workers.root
-00044c70: 2c20 7469 746c 653d 2242 616e 6477 6964  , title="Bandwid
-00044c80: 7468 2028 576f 726b 6572 7329 220a 2020  th (Workers)".  
-00044c90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00044ca0: 6261 6e64 7769 6474 685f 7479 7065 7320  bandwidth_types 
-00044cb0: 3d20 5461 6250 616e 656c 280a 2020 2020  = TabPanel(.    
-00044cc0: 2020 2020 2020 2020 6368 696c 643d 6261          child=ba
-00044cd0: 6e64 7769 6474 685f 7479 7065 732e 726f  ndwidth_types.ro
-00044ce0: 6f74 2c20 7469 746c 653d 2242 616e 6477  ot, title="Bandw
-00044cf0: 6964 7468 2028 5479 7065 7329 220a 2020  idth (Types)".  
-00044d00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00044d10: 7379 7374 656d 203d 2054 6162 5061 6e65  system = TabPane
-00044d20: 6c28 6368 696c 643d 7379 736d 6f6e 2e72  l(child=sysmon.r
-00044d30: 6f6f 742c 2074 6974 6c65 3d22 5379 7374  oot, title="Syst
-00044d40: 656d 2229 0a20 2020 2020 2020 206c 6f67  em").        log
+0003ad30: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+0003ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ad50: 2020 2063 6f75 6e74 203d 206d 696e 286e     count = min(n
+0003ad60: 5f6d 6973 7369 6e67 2c20 6272 616e 6368  _missing, branch
+0003ad70: 696e 675f 6661 6374 6f72 202a 206c 656e  ing_factor * len
+0003ad80: 2874 732e 7768 6f5f 6861 7329 290a 2020  (ts.who_has)).  
+0003ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ada0: 2020 6173 7365 7274 2063 6f75 6e74 203e    assert count >
+0003adb0: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
+0003adc0: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+0003add0: 6e20 7261 6e64 6f6d 2e73 616d 706c 6528  n random.sample(
+0003ade0: 7475 706c 6528 776f 726b 6572 7320 2d20  tuple(workers - 
+0003adf0: 7473 2e77 686f 5f68 6173 292c 2063 6f75  ts.who_has), cou
+0003ae00: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
+0003ae10: 2020 2020 2020 2020 2020 2020 2067 6174               gat
+0003ae20: 6865 7273 5b77 732e 6164 6472 6573 735d  hers[ws.address]
+0003ae30: 5b74 732e 6b65 795d 203d 205b 0a20 2020  [ts.key] = [.   
+0003ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ae50: 2020 2020 2020 2020 2077 7773 2e61 6464           wws.add
+0003ae60: 7265 7373 2066 6f72 2077 7773 2069 6e20  ress for wws in 
+0003ae70: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0003ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ae90: 2020 205d 0a0a 2020 2020 2020 2020 2020     ]..          
+0003aea0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+0003aeb0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+0003aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aed0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+0003aee0: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
+0003aef0: 653a 2074 6869 7320 6e65 7665 7220 7261  e: this never ra
+0003af00: 6973 6573 2065 7863 6570 7469 6f6e 730a  ises exceptions.
+0003af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003af20: 2020 2020 2020 2020 7365 6c66 2e67 6174          self.gat
+0003af30: 6865 725f 6f6e 5f77 6f72 6b65 7228 772c  her_on_worker(w,
+0003af40: 2077 686f 5f68 6173 290a 2020 2020 2020   who_has).      
+0003af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003af60: 2020 666f 7220 772c 2077 686f 5f68 6173    for w, who_has
+0003af70: 2069 6e20 6761 7468 6572 732e 6974 656d   in gathers.item
+0003af80: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+0003af90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0003afa0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0003afb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003afc0: 722c 2076 2069 6e20 6761 7468 6572 732e  r, v in gathers.
+0003afd0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0003afe0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003aff0: 662e 6c6f 675f 6576 656e 7428 722c 207b  f.log_event(r, {
+0003b000: 2261 6374 696f 6e22 3a20 2272 6570 6c69  "action": "repli
+0003b010: 6361 7465 2d61 6464 222c 2022 7768 6f5f  cate-add", "who_
+0003b020: 6861 7322 3a20 767d 290a 0a20 2020 2020  has": v})..     
+0003b030: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+0003b040: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
+0003b050: 2020 2020 2020 2022 616c 6c22 2c0a 2020         "all",.  
+0003b060: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0003b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b080: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
+0003b090: 6570 6c69 6361 7465 222c 0a20 2020 2020  eplicate",.     
+0003b0a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003b0b0: 776f 726b 6572 7322 3a20 6c69 7374 2877  workers": list(w
+0003b0c0: 6f72 6b65 7273 292c 0a20 2020 2020 2020  orkers),.       
+0003b0d0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
+0003b0e0: 792d 636f 756e 7422 3a20 6c65 6e28 6b65  y-count": len(ke
+0003b0f0: 7973 292c 0a20 2020 2020 2020 2020 2020  ys),.           
+0003b100: 2020 2020 2020 2020 2022 6272 616e 6368           "branch
+0003b110: 696e 672d 6661 6374 6f72 223a 2062 7261  ing-factor": bra
+0003b120: 6e63 6869 6e67 5f66 6163 746f 722c 0a20  nching_factor,. 
+0003b130: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0003b140: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0003b150: 0a20 2020 2064 6566 2077 6f72 6b65 7273  .    def workers
+0003b160: 5f74 6f5f 636c 6f73 6528 0a20 2020 2020  _to_close(.     
+0003b170: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0003b180: 206d 656d 6f72 795f 7261 7469 6f3a 2069   memory_ratio: i
+0003b190: 6e74 207c 2066 6c6f 6174 207c 204e 6f6e  nt | float | Non
+0003b1a0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0003b1b0: 2020 6e3a 2069 6e74 207c 204e 6f6e 6520    n: int | None 
+0003b1c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0003b1d0: 6b65 793a 2043 616c 6c61 626c 655b 5b57  key: Callable[[W
+0003b1e0: 6f72 6b65 7253 7461 7465 5d2c 2048 6173  orkerState], Has
+0003b1f0: 6861 626c 655d 207c 2062 7974 6573 207c  hable] | bytes |
+0003b200: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0003b210: 2020 2020 2020 6d69 6e69 6d75 6d3a 2069        minimum: i
+0003b220: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
+0003b230: 2c0a 2020 2020 2020 2020 7461 7267 6574  ,.        target
+0003b240: 3a20 696e 7420 7c20 4e6f 6e65 203d 204e  : int | None = N
+0003b250: 6f6e 652c 0a20 2020 2020 2020 2061 7474  one,.        att
+0003b260: 7269 6275 7465 3a20 7374 7220 3d20 2261  ribute: str = "a
+0003b270: 6464 7265 7373 222c 0a20 2020 2029 202d  ddress",.    ) -
+0003b280: 3e20 6c69 7374 5b73 7472 5d3a 0a20 2020  > list[str]:.   
+0003b290: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003b2a0: 2046 696e 6420 776f 726b 6572 7320 7468   Find workers th
+0003b2b0: 6174 2077 6520 6361 6e20 636c 6f73 6520  at we can close 
+0003b2c0: 7769 7468 206c 6f77 2063 6f73 740a 0a20  with low cost.. 
+0003b2d0: 2020 2020 2020 2054 6869 7320 7265 7475         This retu
+0003b2e0: 726e 7320 6120 6c69 7374 206f 6620 776f  rns a list of wo
+0003b2f0: 726b 6572 7320 7468 6174 2061 7265 2067  rkers that are g
+0003b300: 6f6f 6420 6361 6e64 6964 6174 6573 2074  ood candidates t
+0003b310: 6f20 7265 7469 7265 2e0a 2020 2020 2020  o retire..      
+0003b320: 2020 5468 6573 6520 776f 726b 6572 7320    These workers 
+0003b330: 6172 6520 6e6f 7420 7275 6e6e 696e 6720  are not running 
+0003b340: 616e 7974 6869 6e67 2061 6e64 2061 7265  anything and are
+0003b350: 2073 746f 7269 6e67 0a20 2020 2020 2020   storing.       
+0003b360: 2072 656c 6174 6976 656c 7920 6c69 7474   relatively litt
+0003b370: 6c65 2064 6174 6120 7265 6c61 7469 7665  le data relative
+0003b380: 2074 6f20 7468 6569 7220 7065 6572 732e   to their peers.
+0003b390: 2020 4966 2061 6c6c 2077 6f72 6b65 7273    If all workers
+0003b3a0: 2061 7265 0a20 2020 2020 2020 2069 646c   are.        idl
+0003b3b0: 6520 7468 656e 2077 6520 7374 696c 6c20  e then we still 
+0003b3c0: 6d61 696e 7461 696e 2065 6e6f 7567 6820  maintain enough 
+0003b3d0: 776f 726b 6572 7320 746f 2068 6176 6520  workers to have 
+0003b3e0: 656e 6f75 6768 2052 414d 2074 6f20 7374  enough RAM to st
+0003b3f0: 6f72 650a 2020 2020 2020 2020 6f75 7220  ore.        our 
+0003b400: 6461 7461 2c20 7769 7468 2061 2063 6f6d  data, with a com
+0003b410: 666f 7274 6162 6c65 2062 7566 6665 722e  fortable buffer.
+0003b420: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
+0003b430: 7320 666f 7220 7573 6520 7769 7468 2073  s for use with s
+0003b440: 7973 7465 6d73 206c 696b 6520 6060 6469  ystems like ``di
+0003b450: 7374 7269 6275 7465 642e 6465 706c 6f79  stributed.deploy
+0003b460: 2e61 6461 7074 6976 6560 602e 0a0a 2020  .adaptive``...  
+0003b470: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
+0003b480: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0003b490: 2d2d 2d0a 2020 2020 2020 2020 6d65 6d6f  ---.        memo
+0003b4a0: 7279 5f72 6174 696f 203a 204e 756d 6265  ry_ratio : Numbe
+0003b4b0: 720a 2020 2020 2020 2020 2020 2020 416d  r.            Am
+0003b4c0: 6f75 6e74 206f 6620 6578 7472 6120 7370  ount of extra sp
+0003b4d0: 6163 6520 7765 2077 616e 7420 746f 2068  ace we want to h
+0003b4e0: 6176 6520 666f 7220 6f75 7220 7374 6f72  ave for our stor
+0003b4f0: 6564 2064 6174 612e 0a20 2020 2020 2020  ed data..       
+0003b500: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
+0003b510: 2032 2c20 6f72 2074 6861 7420 7765 2077   2, or that we w
+0003b520: 616e 7420 746f 2068 6176 6520 7477 6963  ant to have twic
+0003b530: 6520 6173 206d 7563 6820 6d65 6d6f 7279  e as much memory
+0003b540: 2061 7320 7765 0a20 2020 2020 2020 2020   as we.         
+0003b550: 2020 2063 7572 7265 6e74 6c79 2068 6176     currently hav
+0003b560: 6520 6461 7461 2e0a 2020 2020 2020 2020  e data..        
+0003b570: 6e20 3a20 696e 740a 2020 2020 2020 2020  n : int.        
+0003b580: 2020 2020 4e75 6d62 6572 206f 6620 776f      Number of wo
+0003b590: 726b 6572 7320 746f 2063 6c6f 7365 0a20  rkers to close. 
+0003b5a0: 2020 2020 2020 206d 696e 696d 756d 203a         minimum :
+0003b5b0: 2069 6e74 0a20 2020 2020 2020 2020 2020   int.           
+0003b5c0: 204d 696e 696d 756d 206e 756d 6265 7220   Minimum number 
+0003b5d0: 6f66 2077 6f72 6b65 7273 2074 6f20 6b65  of workers to ke
+0003b5e0: 6570 2061 726f 756e 640a 2020 2020 2020  ep around.      
+0003b5f0: 2020 6b65 7920 3a20 4361 6c6c 6162 6c65    key : Callable
+0003b600: 2857 6f72 6b65 7253 7461 7465 290a 2020  (WorkerState).  
+0003b610: 2020 2020 2020 2020 2020 416e 206f 7074            An opt
+0003b620: 696f 6e61 6c20 6361 6c6c 6162 6c65 206d  ional callable m
+0003b630: 6170 7069 6e67 2061 2057 6f72 6b65 7253  apping a WorkerS
+0003b640: 7461 7465 206f 626a 6563 7420 746f 2061  tate object to a
+0003b650: 2067 726f 7570 0a20 2020 2020 2020 2020   group.         
+0003b660: 2020 2061 6666 696c 6961 7469 6f6e 2e20     affiliation. 
+0003b670: 4772 6f75 7073 2077 696c 6c20 6265 2063  Groups will be c
+0003b680: 6c6f 7365 6420 746f 6765 7468 6572 2e20  losed together. 
+0003b690: 5468 6973 2069 7320 7573 6566 756c 2077  This is useful w
+0003b6a0: 6865 6e0a 2020 2020 2020 2020 2020 2020  hen.            
+0003b6b0: 636c 6f73 696e 6720 776f 726b 6572 7320  closing workers 
+0003b6c0: 6d75 7374 2062 6520 646f 6e65 2063 6f6c  must be done col
+0003b6d0: 6c65 6374 6976 656c 792c 2073 7563 6820  lectively, such 
+0003b6e0: 6173 2062 7920 686f 7374 6e61 6d65 2e0a  as by hostname..
+0003b6f0: 2020 2020 2020 2020 7461 7267 6574 203a          target :
+0003b700: 2069 6e74 0a20 2020 2020 2020 2020 2020   int.           
+0003b710: 2054 6172 6765 7420 6e75 6d62 6572 206f   Target number o
+0003b720: 6620 776f 726b 6572 7320 746f 2068 6176  f workers to hav
+0003b730: 6520 6166 7465 7220 7765 2063 6c6f 7365  e after we close
+0003b740: 0a20 2020 2020 2020 2061 7474 7269 6275  .        attribu
+0003b750: 7465 203a 2073 7472 0a20 2020 2020 2020  te : str.       
+0003b760: 2020 2020 2054 6865 2061 7474 7269 6275       The attribu
+0003b770: 7465 206f 6620 7468 6520 576f 726b 6572  te of the Worker
+0003b780: 5374 6174 6520 6f62 6a65 6374 2074 6f20  State object to 
+0003b790: 7265 7475 726e 2c20 6c69 6b65 2022 6164  return, like "ad
+0003b7a0: 6472 6573 7322 0a20 2020 2020 2020 2020  dress".         
+0003b7b0: 2020 206f 7220 226e 616d 6522 2e20 2044     or "name".  D
+0003b7c0: 6566 6175 6c74 7320 746f 2022 6164 6472  efaults to "addr
+0003b7d0: 6573 7322 2e0a 0a20 2020 2020 2020 2045  ess"...        E
+0003b7e0: 7861 6d70 6c65 730a 2020 2020 2020 2020  xamples.        
+0003b7f0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0003b800: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
+0003b810: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003b820: 290a 2020 2020 2020 2020 5b27 7463 703a  ).        ['tcp:
+0003b830: 2f2f 3139 322e 3136 382e 302e 313a 3132  //192.168.0.1:12
+0003b840: 3334 272c 2027 7463 703a 2f2f 3139 322e  34', 'tcp://192.
+0003b850: 3136 382e 302e 323a 3132 3334 275d 0a0a  168.0.2:1234']..
+0003b860: 2020 2020 2020 2020 4772 6f75 7020 776f          Group wo
+0003b870: 726b 6572 7320 6279 2068 6f73 746e 616d  rkers by hostnam
+0003b880: 6520 7072 696f 7220 746f 2063 6c6f 7369  e prior to closi
+0003b890: 6e67 0a0a 2020 2020 2020 2020 3e3e 3e20  ng..        >>> 
+0003b8a0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+0003b8b0: 735f 746f 5f63 6c6f 7365 286b 6579 3d6c  s_to_close(key=l
+0003b8c0: 616d 6264 6120 7773 3a20 7773 2e68 6f73  ambda ws: ws.hos
+0003b8d0: 7429 0a20 2020 2020 2020 205b 2774 6370  t).        ['tcp
+0003b8e0: 3a2f 2f31 3932 2e31 3638 2e30 2e31 3a31  ://192.168.0.1:1
+0003b8f0: 3233 3427 2c20 2774 6370 3a2f 2f31 3932  234', 'tcp://192
+0003b900: 2e31 3638 2e30 2e31 3a34 3536 3727 5d0a  .168.0.1:4567'].
+0003b910: 0a20 2020 2020 2020 2052 656d 6f76 6520  .        Remove 
+0003b920: 7477 6f20 776f 726b 6572 730a 0a20 2020  two workers..   
+0003b930: 2020 2020 203e 3e3e 2073 6368 6564 756c       >>> schedul
+0003b940: 6572 2e77 6f72 6b65 7273 5f74 6f5f 636c  er.workers_to_cl
+0003b950: 6f73 6528 6e3d 3229 0a0a 2020 2020 2020  ose(n=2)..      
+0003b960: 2020 4b65 6570 2065 6e6f 7567 6820 776f    Keep enough wo
+0003b970: 726b 6572 7320 746f 2068 6176 6520 7477  rkers to have tw
+0003b980: 6963 6520 6173 206d 7563 6820 6d65 6d6f  ice as much memo
+0003b990: 7279 2061 7320 7765 2077 6520 6e65 6564  ry as we we need
+0003b9a0: 2e0a 0a20 2020 2020 2020 203e 3e3e 2073  ...        >>> s
+0003b9b0: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0003b9c0: 5f74 6f5f 636c 6f73 6528 6d65 6d6f 7279  _to_close(memory
+0003b9d0: 5f72 6174 696f 3d32 290a 0a20 2020 2020  _ratio=2)..     
+0003b9e0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+0003b9f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+0003ba00: 2020 2074 6f5f 636c 6f73 653a 206c 6973     to_close: lis
+0003ba10: 7420 6f66 2077 6f72 6b65 7220 6164 6472  t of worker addr
+0003ba20: 6573 7365 7320 7468 6174 2061 7265 204f  esses that are O
+0003ba30: 4b20 746f 2063 6c6f 7365 0a0a 2020 2020  K to close..    
+0003ba40: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
+0003ba50: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+0003ba60: 2020 2020 2020 5363 6865 6475 6c65 722e        Scheduler.
+0003ba70: 7265 7469 7265 5f77 6f72 6b65 7273 0a20  retire_workers. 
+0003ba80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003ba90: 2020 2069 6620 7461 7267 6574 2069 7320     if target is 
+0003baa0: 6e6f 7420 4e6f 6e65 2061 6e64 206e 2069  not None and n i
+0003bab0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0003bac0: 2020 2020 6e20 3d20 6c65 6e28 7365 6c66      n = len(self
+0003bad0: 2e77 6f72 6b65 7273 2920 2d20 7461 7267  .workers) - targ
+0003bae0: 6574 0a20 2020 2020 2020 2069 6620 6e20  et.        if n 
+0003baf0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0003bb00: 2020 2020 2020 2020 2069 6620 6e20 3c20           if n < 
+0003bb10: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003bb20: 2020 206e 203d 2030 0a20 2020 2020 2020     n = 0.       
+0003bb30: 2020 2020 2074 6172 6765 7420 3d20 6c65       target = le
+0003bb40: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
+0003bb50: 2d20 6e0a 0a20 2020 2020 2020 2069 6620  - n..        if 
+0003bb60: 6e20 6973 204e 6f6e 6520 616e 6420 6d65  n is None and me
+0003bb70: 6d6f 7279 5f72 6174 696f 2069 7320 4e6f  mory_ratio is No
+0003bb80: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003bb90: 6d65 6d6f 7279 5f72 6174 696f 203d 2032  memory_ratio = 2
+0003bba0: 0a0a 2020 2020 2020 2020 7769 7468 206c  ..        with l
+0003bbb0: 6f67 5f65 7272 6f72 7328 293a 0a20 2020  og_errors():.   
+0003bbc0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0003bbd0: 6e20 616e 6420 616c 6c28 5b77 732e 7072  n and all([ws.pr
+0003bbe0: 6f63 6573 7369 6e67 2066 6f72 2077 7320  ocessing for ws 
+0003bbf0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0003bc00: 7661 6c75 6573 2829 5d29 3a0a 2020 2020  values()]):.    
+0003bc10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003bc20: 726e 205b 5d0a 0a20 2020 2020 2020 2020  rn []..         
+0003bc30: 2020 2069 6620 6b65 7920 6973 204e 6f6e     if key is Non
+0003bc40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003bc50: 2020 206b 6579 203d 206f 7065 7261 746f     key = operato
+0003bc60: 722e 6174 7472 6765 7474 6572 2822 6164  r.attrgetter("ad
+0003bc70: 6472 6573 7322 290a 2020 2020 2020 2020  dress").        
+0003bc80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0003bc90: 6528 6b65 792c 2062 7974 6573 2920 616e  e(key, bytes) an
+0003bca0: 6420 6461 736b 2e63 6f6e 6669 672e 6765  d dask.config.ge
+0003bcb0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0003bcc0: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
+0003bcd0: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
+0003bce0: 220a 2020 2020 2020 2020 2020 2020 293a  ".            ):
+0003bcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bd00: 206b 6579 203d 2070 6963 6b6c 652e 6c6f   key = pickle.lo
+0003bd10: 6164 7328 6b65 7929 0a0a 2020 2020 2020  ads(key)..      
+0003bd20: 2020 2020 2020 6772 6f75 7073 203d 2067        groups = g
+0003bd30: 726f 7570 6279 286b 6579 2c20 7365 6c66  roupby(key, self
+0003bd40: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+0003bd50: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+0003bd60: 6c69 6d69 745f 6279 7465 7320 3d20 7b0a  limit_bytes = {.
+0003bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bd80: 6b3a 2073 756d 2877 732e 6d65 6d6f 7279  k: sum(ws.memory
+0003bd90: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
+0003bda0: 2076 2920 666f 7220 6b2c 2076 2069 6e20   v) for k, v in 
+0003bdb0: 6772 6f75 7073 2e69 7465 6d73 2829 0a20  groups.items(). 
+0003bdc0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0003bdd0: 2020 2020 2020 2020 2067 726f 7570 5f62           group_b
+0003bde0: 7974 6573 203d 207b 6b3a 2073 756d 2877  ytes = {k: sum(w
+0003bdf0: 732e 6e62 7974 6573 2066 6f72 2077 7320  s.nbytes for ws 
+0003be00: 696e 2076 2920 666f 7220 6b2c 2076 2069  in v) for k, v i
+0003be10: 6e20 6772 6f75 7073 2e69 7465 6d73 2829  n groups.items()
+0003be20: 7d0a 0a20 2020 2020 2020 2020 2020 206c  }..            l
+0003be30: 696d 6974 203d 2073 756d 286c 696d 6974  imit = sum(limit
+0003be40: 5f62 7974 6573 2e76 616c 7565 7328 2929  _bytes.values())
+0003be50: 0a20 2020 2020 2020 2020 2020 2074 6f74  .            tot
+0003be60: 616c 203d 2073 756d 2867 726f 7570 5f62  al = sum(group_b
+0003be70: 7974 6573 2e76 616c 7565 7328 2929 0a0a  ytes.values())..
+0003be80: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+0003be90: 5f6b 6579 2867 726f 7570 293a 0a20 2020  _key(group):.   
+0003bea0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
+0003beb0: 6964 6c65 203d 206e 6f74 2061 6e79 285b  idle = not any([
+0003bec0: 7777 732e 7072 6f63 6573 7369 6e67 2066  wws.processing f
+0003bed0: 6f72 2077 7773 2069 6e20 6772 6f75 7073  or wws in groups
+0003bee0: 5b67 726f 7570 5d5d 290a 2020 2020 2020  [group]]).      
+0003bef0: 2020 2020 2020 2020 2020 6279 7465 7320            bytes 
+0003bf00: 3d20 2d67 726f 7570 5f62 7974 6573 5b67  = -group_bytes[g
+0003bf10: 726f 7570 5d0a 2020 2020 2020 2020 2020  roup].          
+0003bf20: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
+0003bf30: 6964 6c65 2c20 6279 7465 730a 0a20 2020  idle, bytes..   
+0003bf40: 2020 2020 2020 2020 2069 646c 6520 3d20           idle = 
+0003bf50: 736f 7274 6564 2867 726f 7570 732c 206b  sorted(groups, k
+0003bf60: 6579 3d5f 6b65 7929 0a0a 2020 2020 2020  ey=_key)..      
+0003bf70: 2020 2020 2020 746f 5f63 6c6f 7365 203d        to_close =
+0003bf80: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0003bf90: 6e5f 7265 6d61 696e 203d 206c 656e 2873  n_remain = len(s
+0003bfa0: 656c 662e 776f 726b 6572 7329 0a0a 2020  elf.workers)..  
+0003bfb0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+0003bfc0: 6964 6c65 3a0a 2020 2020 2020 2020 2020  idle:.          
+0003bfd0: 2020 2020 2020 6772 6f75 7020 3d20 6964        group = id
+0003bfe0: 6c65 2e70 6f70 2829 0a20 2020 2020 2020  le.pop().       
+0003bff0: 2020 2020 2020 2020 2069 6620 6e20 6973           if n is
+0003c000: 204e 6f6e 6520 616e 6420 616e 7928 5b77   None and any([w
+0003c010: 732e 7072 6f63 6573 7369 6e67 2066 6f72  s.processing for
+0003c020: 2077 7320 696e 2067 726f 7570 735b 6772   ws in groups[gr
+0003c030: 6f75 705d 5d29 3a0a 2020 2020 2020 2020  oup]]):.        
+0003c040: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0003c050: 6b0a 0a20 2020 2020 2020 2020 2020 2020  k..             
+0003c060: 2020 2069 6620 6d69 6e69 6d75 6d20 616e     if minimum an
+0003c070: 6420 6e5f 7265 6d61 696e 202d 206c 656e  d n_remain - len
+0003c080: 2867 726f 7570 735b 6772 6f75 705d 2920  (groups[group]) 
+0003c090: 3c20 6d69 6e69 6d75 6d3a 0a20 2020 2020  < minimum:.     
+0003c0a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0003c0b0: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
+0003c0c0: 2020 2020 2020 6c69 6d69 7420 2d3d 206c        limit -= l
+0003c0d0: 696d 6974 5f62 7974 6573 5b67 726f 7570  imit_bytes[group
+0003c0e0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+0003c0f0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+0003c100: 2020 2020 2020 2020 2020 2020 6e20 6973              n is
+0003c110: 206e 6f74 204e 6f6e 6520 616e 6420 6e5f   not None and n_
+0003c120: 7265 6d61 696e 202d 206c 656e 2867 726f  remain - len(gro
+0003c130: 7570 735b 6772 6f75 705d 2920 3e3d 2028  ups[group]) >= (
+0003c140: 7461 7267 6574 206f 7220 3029 0a20 2020  target or 0).   
+0003c150: 2020 2020 2020 2020 2020 2020 2029 206f               ) o
+0003c160: 7220 286d 656d 6f72 795f 7261 7469 6f20  r (memory_ratio 
+0003c170: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0003c180: 6c69 6d69 7420 3e3d 206d 656d 6f72 795f  limit >= memory_
+0003c190: 7261 7469 6f20 2a20 746f 7461 6c29 3a0a  ratio * total):.
+0003c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c1b0: 2020 2020 746f 5f63 6c6f 7365 2e61 7070      to_close.app
+0003c1c0: 656e 6428 6772 6f75 7029 0a20 2020 2020  end(group).     
+0003c1d0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003c1e0: 5f72 656d 6169 6e20 2d3d 206c 656e 2867  _remain -= len(g
+0003c1f0: 726f 7570 735b 6772 6f75 705d 290a 0a20  roups[group]).. 
+0003c200: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0003c210: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003c220: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+0003c230: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+0003c240: 6c74 203d 205b 6765 7461 7474 7228 7773  lt = [getattr(ws
+0003c250: 2c20 6174 7472 6962 7574 6529 2066 6f72  , attribute) for
+0003c260: 2067 2069 6e20 746f 5f63 6c6f 7365 2066   g in to_close f
+0003c270: 6f72 2077 7320 696e 2067 726f 7570 735b  or ws in groups[
+0003c280: 675d 5d0a 2020 2020 2020 2020 2020 2020  g]].            
+0003c290: 6966 2072 6573 756c 743a 0a20 2020 2020  if result:.     
+0003c2a0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0003c2b0: 722e 6465 6275 6728 2253 7567 6765 7374  r.debug("Suggest
+0003c2c0: 2063 6c6f 7369 6e67 2077 6f72 6b65 7273   closing workers
+0003c2d0: 3a20 2573 222c 2072 6573 756c 7429 0a0a  : %s", result)..
+0003c2e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003c2f0: 726e 2072 6573 756c 740a 0a20 2020 2040  rn result..    @
+0003c300: 6c6f 675f 6572 726f 7273 0a20 2020 2061  log_errors.    a
+0003c310: 7379 6e63 2064 6566 2072 6574 6972 655f  sync def retire_
+0003c320: 776f 726b 6572 7328 0a20 2020 2020 2020  workers(.       
+0003c330: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
+0003c340: 6f72 6b65 7273 3a20 6c69 7374 5b73 7472  orkers: list[str
+0003c350: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+0003c360: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+0003c370: 2020 2020 6e61 6d65 733a 206c 6973 7420      names: list 
+0003c380: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003c390: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
+0003c3a0: 6b65 7273 3a20 626f 6f6c 203d 2046 616c  kers: bool = Fal
+0003c3b0: 7365 2c0a 2020 2020 2020 2020 7265 6d6f  se,.        remo
+0003c3c0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
+0003c3d0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+0003c3e0: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
+0003c3f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0003c400: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+0003c410: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
+0003c420: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+0003c430: 2022 2222 4772 6163 6566 756c 6c79 2072   """Gracefully r
+0003c440: 6574 6972 6520 776f 726b 6572 7320 6672  etire workers fr
+0003c450: 6f6d 2063 6c75 7374 6572 2e20 416e 7920  om cluster. Any 
+0003c460: 6b65 7920 7468 6174 2069 7320 696e 206d  key that is in m
+0003c470: 656d 6f72 7920 6578 636c 7573 6976 656c  emory exclusivel
+0003c480: 790a 2020 2020 2020 2020 6f6e 2074 6865  y.        on the
+0003c490: 2072 6574 6972 6564 2077 6f72 6b65 7273   retired workers
+0003c4a0: 2069 7320 7265 706c 6963 6174 6564 2073   is replicated s
+0003c4b0: 6f6d 6577 6865 7265 2065 6c73 652e 0a0a  omewhere else...
+0003c4c0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+0003c4d0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+0003c4e0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
+0003c4f0: 726b 6572 733a 206c 6973 745b 7374 725d  rkers: list[str]
+0003c500: 2028 6f70 7469 6f6e 616c 290a 2020 2020   (optional).    
+0003c510: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+0003c520: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
+0003c530: 2074 6f20 7265 7469 7265 2e0a 2020 2020   to retire..    
+0003c540: 2020 2020 6e61 6d65 733a 206c 6973 7420      names: list 
+0003c550: 286f 7074 696f 6e61 6c29 0a20 2020 2020  (optional).     
+0003c560: 2020 2020 2020 204c 6973 7420 6f66 2077         List of w
+0003c570: 6f72 6b65 7220 6e61 6d65 7320 746f 2072  orker names to r
+0003c580: 6574 6972 652e 0a20 2020 2020 2020 2020  etire..         
+0003c590: 2020 204d 7574 7561 6c6c 7920 6578 636c     Mutually excl
+0003c5a0: 7573 6976 6520 7769 7468 2060 6077 6f72  usive with ``wor
+0003c5b0: 6b65 7273 6060 2e0a 2020 2020 2020 2020  kers``..        
+0003c5c0: 2020 2020 4966 206e 6569 7468 6572 2060      If neither `
+0003c5d0: 6077 6f72 6b65 7273 6060 206e 6f72 2060  `workers`` nor `
+0003c5e0: 606e 616d 6573 6060 2061 7265 2070 726f  `names`` are pro
+0003c5f0: 7669 6465 642c 2077 6520 6361 6c6c 0a20  vided, we call. 
+0003c600: 2020 2020 2020 2020 2020 2060 6077 6f72             ``wor
+0003c610: 6b65 7273 5f74 6f5f 636c 6f73 6560 6020  kers_to_close`` 
+0003c620: 7768 6963 6820 6669 6e64 7320 6120 676f  which finds a go
+0003c630: 6f64 2073 6574 2e0a 2020 2020 2020 2020  od set..        
+0003c640: 636c 6f73 655f 776f 726b 6572 733a 2062  close_workers: b
+0003c650: 6f6f 6c20 2864 6566 6175 6c74 7320 746f  ool (defaults to
+0003c660: 2046 616c 7365 290a 2020 2020 2020 2020   False).        
+0003c670: 2020 2020 5768 6574 6865 7220 6f72 206e      Whether or n
+0003c680: 6f74 2074 6f20 6163 7475 616c 6c79 2063  ot to actually c
+0003c690: 6c6f 7365 2074 6865 2077 6f72 6b65 7220  lose the worker 
+0003c6a0: 6578 706c 6963 6974 6c79 2066 726f 6d20  explicitly from 
+0003c6b0: 6865 7265 2e0a 2020 2020 2020 2020 2020  here..          
+0003c6c0: 2020 4f74 6865 7277 6973 6520 7765 2065    Otherwise we e
+0003c6d0: 7870 6563 7420 736f 6d65 2065 7874 6572  xpect some exter
+0003c6e0: 6e61 6c20 6a6f 6220 7363 6865 6475 6c65  nal job schedule
+0003c6f0: 7220 746f 2066 696e 6973 6820 6f66 6620  r to finish off 
+0003c700: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+0003c710: 776f 726b 6572 2e0a 2020 2020 2020 2020  worker..        
+0003c720: 7265 6d6f 7665 3a20 626f 6f6c 2028 6465  remove: bool (de
+0003c730: 6661 756c 7473 2074 6f20 5472 7565 290a  faults to True).
+0003c740: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+0003c750: 6865 7220 6f72 206e 6f74 2074 6f20 7265  her or not to re
+0003c760: 6d6f 7665 2074 6865 2077 6f72 6b65 7220  move the worker 
+0003c770: 6d65 7461 6461 7461 2069 6d6d 6564 6961  metadata immedia
+0003c780: 7465 6c79 206f 7220 656c 7365 0a20 2020  tely or else.   
+0003c790: 2020 2020 2020 2020 2077 6169 7420 666f           wait fo
+0003c7a0: 7220 7468 6520 776f 726b 6572 2074 6f20  r the worker to 
+0003c7b0: 636f 6e74 6163 7420 7573 2e0a 0a20 2020  contact us...   
+0003c7c0: 2020 2020 2020 2020 2049 6620 636c 6f73           If clos
+0003c7d0: 655f 776f 726b 6572 733d 4661 6c73 6520  e_workers=False 
+0003c7e0: 616e 6420 7265 6d6f 7665 3d46 616c 7365  and remove=False
+0003c7f0: 2c20 7468 6973 206d 6574 686f 6420 6a75  , this method ju
+0003c800: 7374 2066 6c75 7368 6573 2074 6865 2074  st flushes the t
+0003c810: 6173 6b73 0a20 2020 2020 2020 2020 2020  asks.           
+0003c820: 2069 6e20 6d65 6d6f 7279 206f 7574 206f   in memory out o
+0003c830: 6620 7468 6520 776f 726b 6572 7320 616e  f the workers an
+0003c840: 6420 7468 656e 2072 6574 7572 6e73 2e0a  d then returns..
+0003c850: 2020 2020 2020 2020 2020 2020 4966 2063              If c
+0003c860: 6c6f 7365 5f77 6f72 6b65 7273 3d54 7275  lose_workers=Tru
+0003c870: 6520 616e 6420 7265 6d6f 7665 3d46 616c  e and remove=Fal
+0003c880: 7365 2c20 7468 6973 206d 6574 686f 6420  se, this method 
+0003c890: 7769 6c6c 2072 6574 7572 6e20 7768 696c  will return whil
+0003c8a0: 6520 7468 650a 2020 2020 2020 2020 2020  e the.          
+0003c8b0: 2020 776f 726b 6572 7320 6172 6520 7374    workers are st
+0003c8c0: 696c 6c20 696e 2074 6865 2063 6c75 7374  ill in the clust
+0003c8d0: 6572 2c20 616c 7468 6f75 6768 2074 6865  er, although the
+0003c8e0: 7920 776f 6e27 7420 6163 6365 7074 206e  y won't accept n
+0003c8f0: 6577 2074 6173 6b73 2e0a 2020 2020 2020  ew tasks..      
+0003c900: 2020 2020 2020 4966 2063 6c6f 7365 5f77        If close_w
+0003c910: 6f72 6b65 7273 3d46 616c 7365 206f 7220  orkers=False or 
+0003c920: 666f 7220 7768 6174 6576 6572 2072 6561  for whatever rea
+0003c930: 736f 6e20 6120 776f 726b 6572 2064 6f65  son a worker doe
+0003c940: 736e 2774 2061 6363 6570 7420 7468 650a  sn't accept the.
+0003c950: 2020 2020 2020 2020 2020 2020 636c 6f73              clos
+0003c960: 6520 636f 6d6d 616e 642c 2069 7420 7769  e command, it wi
+0003c970: 6c6c 2062 6520 6c65 6674 2070 6572 6d61  ll be left perma
+0003c980: 6e65 6e74 6c79 2075 6e61 626c 6520 746f  nently unable to
+0003c990: 2061 6363 6570 7420 6e65 7720 7461 736b   accept new task
+0003c9a0: 7320 616e 640a 2020 2020 2020 2020 2020  s and.          
+0003c9b0: 2020 6974 2069 7320 6578 7065 6374 6564    it is expected
+0003c9c0: 2074 6f20 6265 2063 6c6f 7365 6420 696e   to be closed in
+0003c9d0: 2073 6f6d 6520 6f74 6865 7220 7761 792e   some other way.
+0003c9e0: 0a0a 2020 2020 2020 2020 2a2a 6b77 6172  ..        **kwar
+0003c9f0: 6773 3a20 6469 6374 0a20 2020 2020 2020  gs: dict.       
+0003ca00: 2020 2020 2045 7874 7261 206f 7074 696f       Extra optio
+0003ca10: 6e73 2074 6f20 7061 7373 2074 6f20 776f  ns to pass to wo
+0003ca20: 726b 6572 735f 746f 5f63 6c6f 7365 2074  rkers_to_close t
+0003ca30: 6f20 6465 7465 726d 696e 6520 7768 6963  o determine whic
+0003ca40: 680a 2020 2020 2020 2020 2020 2020 776f  h.            wo
+0003ca50: 726b 6572 7320 7765 2073 686f 756c 6420  rkers we should 
+0003ca60: 6472 6f70 0a0a 2020 2020 2020 2020 5265  drop..        Re
+0003ca70: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
+0003ca80: 2d2d 2d2d 2d0a 2020 2020 2020 2020 4469  -----.        Di
+0003ca90: 6374 696f 6e61 7279 206d 6170 7069 6e67  ctionary mapping
+0003caa0: 2077 6f72 6b65 7220 4944 2f61 6464 7265   worker ID/addre
+0003cab0: 7373 2074 6f20 6469 6374 696f 6e61 7279  ss to dictionary
+0003cac0: 206f 6620 696e 666f 726d 6174 696f 6e20   of information 
+0003cad0: 6162 6f75 740a 2020 2020 2020 2020 7468  about.        th
+0003cae0: 6174 2077 6f72 6b65 7220 666f 7220 6561  at worker for ea
+0003caf0: 6368 2072 6574 6972 6564 2077 6f72 6b65  ch retired worke
+0003cb00: 722e 0a0a 2020 2020 2020 2020 4966 2074  r...        If t
+0003cb10: 6865 7265 2061 7265 206b 6579 7320 7468  here are keys th
+0003cb20: 6174 2065 7869 7374 2069 6e20 6d65 6d6f  at exist in memo
+0003cb30: 7279 206f 6e6c 7920 6f6e 2074 6865 2077  ry only on the w
+0003cb40: 6f72 6b65 7273 2062 6569 6e67 2072 6574  orkers being ret
+0003cb50: 6972 6564 2061 6e64 2069 740a 2020 2020  ired and it.    
+0003cb60: 2020 2020 7761 7320 696d 706f 7373 6962      was impossib
+0003cb70: 6c65 2074 6f20 7265 706c 6963 6174 6520  le to replicate 
+0003cb80: 7468 656d 2073 6f6d 6577 6865 7265 2065  them somewhere e
+0003cb90: 6c73 6520 2865 2e67 2e20 6265 6361 7573  lse (e.g. becaus
+0003cba0: 6520 7468 6572 6520 6172 656e 2774 0a20  e there aren't. 
+0003cbb0: 2020 2020 2020 2061 6e79 206f 7468 6572         any other
+0003cbc0: 2072 756e 6e69 6e67 2077 6f72 6b65 7273   running workers
+0003cbd0: 292c 2074 6865 2077 6f72 6b65 7273 2068  ), the workers h
+0003cbe0: 6f6c 6469 6e67 2073 7563 6820 6b65 7973  olding such keys
+0003cbf0: 2077 6f6e 2774 2062 6520 7265 7469 7265   won't be retire
+0003cc00: 6420 616e 640a 2020 2020 2020 2020 776f  d and.        wo
+0003cc10: 6e27 7420 6170 7065 6172 2069 6e20 7468  n't appear in th
+0003cc20: 6520 7265 7475 726e 6564 2064 6963 742e  e returned dict.
+0003cc30: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
+0003cc40: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+0003cc50: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
+0003cc60: 6475 6c65 722e 776f 726b 6572 735f 746f  duler.workers_to
+0003cc70: 5f63 6c6f 7365 0a20 2020 2020 2020 2022  _close.        "
+0003cc80: 2222 0a20 2020 2020 2020 2073 7469 6d75  "".        stimu
+0003cc90: 6c75 735f 6964 203d 2073 7469 6d75 6c75  lus_id = stimulu
+0003cca0: 735f 6964 206f 7220 6622 7265 7469 7265  s_id or f"retire
+0003ccb0: 2d77 6f72 6b65 7273 2d7b 7469 6d65 2829  -workers-{time()
+0003ccc0: 7d22 0a20 2020 2020 2020 2023 2054 6869  }".        # Thi
+0003ccd0: 7320 6c6f 636b 206d 616b 6573 2072 6574  s lock makes ret
+0003cce0: 6972 655f 776f 726b 6572 732c 2072 6562  ire_workers, reb
+0003ccf0: 616c 616e 6365 2c20 616e 6420 7265 706c  alance, and repl
+0003cd00: 6963 6174 6520 6d75 7475 616c 6c79 0a20  icate mutually. 
+0003cd10: 2020 2020 2020 2023 2065 7863 6c75 7369         # exclusi
+0003cd20: 7665 2061 6e64 2077 696c 6c20 6e6f 206c  ve and will no l
+0003cd30: 6f6e 6765 7220 6265 206e 6563 6573 7361  onger be necessa
+0003cd40: 7279 206f 6e63 6520 7265 6261 6c61 6e63  ry once rebalanc
+0003cd50: 6520 616e 6420 7265 706c 6963 6174 6520  e and replicate 
+0003cd60: 6172 650a 2020 2020 2020 2020 2320 6d69  are.        # mi
+0003cd70: 6772 6174 6564 2074 6f20 7468 6520 4163  grated to the Ac
+0003cd80: 7469 7665 204d 656d 6f72 7920 4d61 6e61  tive Memory Mana
+0003cd90: 6765 722e 0a20 2020 2020 2020 2023 204e  ger..        # N
+0003cda0: 6f74 6520 7468 6174 2c20 696e 6369 6465  ote that, incide
+0003cdb0: 6e74 616c 6c79 2c20 6974 2061 6c73 6f20  ntally, it also 
+0003cdc0: 7072 6576 656e 7473 206d 756c 7469 706c  prevents multipl
+0003cdd0: 6520 6361 6c6c 7320 746f 2072 6574 6972  e calls to retir
+0003cde0: 655f 776f 726b 6572 730a 2020 2020 2020  e_workers.      
+0003cdf0: 2020 2320 6672 6f6d 2072 756e 6e69 6e67    # from running
+0003ce00: 2069 6e20 7061 7261 6c6c 656c 202d 2074   in parallel - t
+0003ce10: 6869 7320 6973 2075 6e6e 6563 6573 7361  his is unnecessa
+0003ce20: 7279 2e0a 2020 2020 2020 2020 6173 796e  ry..        asyn
+0003ce30: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
+0003ce40: 6b3a 0a20 2020 2020 2020 2020 2020 2069  k:.            i
+0003ce50: 6620 6e61 6d65 7320 6973 206e 6f74 204e  f names is not N
+0003ce60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003ce70: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
+0003ce80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0003ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cea0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+0003ceb0: 2822 6e61 6d65 7320 616e 6420 776f 726b  ("names and work
+0003cec0: 6572 7320 6172 6520 6d75 7475 616c 6c79  ers are mutually
+0003ced0: 2065 7863 6c75 7369 7665 2229 0a20 2020   exclusive").   
+0003cee0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003cef0: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
+0003cf00: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0003cf10: 722e 696e 666f 2822 5265 7469 7265 2077  r.info("Retire w
+0003cf20: 6f72 6b65 7220 6e61 6d65 7320 2573 222c  orker names %s",
+0003cf30: 206e 616d 6573 290a 2020 2020 2020 2020   names).        
+0003cf40: 2020 2020 2020 2020 2320 5375 7070 6f72          # Suppor
+0003cf50: 7420 6361 7365 7320 7768 6572 6520 6e61  t cases where na
+0003cf60: 6d65 7320 6172 6520 7061 7373 6564 2074  mes are passed t
+0003cf70: 6872 6f75 6768 2061 2043 4c49 2061 6e64  hrough a CLI and
+0003cf80: 2062 6563 6f6d 650a 2020 2020 2020 2020   become.        
+0003cf90: 2020 2020 2020 2020 2320 7374 7269 6e67          # string
+0003cfa0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0003cfb0: 2020 6e61 6d65 735f 7365 7420 3d20 7b73    names_set = {s
+0003cfc0: 7472 286e 616d 6529 2066 6f72 206e 616d  tr(name) for nam
+0003cfd0: 6520 696e 206e 616d 6573 7d0a 2020 2020  e in names}.    
+0003cfe0: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
+0003cff0: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
+0003d000: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+0003d010: 7565 7328 2920 6966 2073 7472 2877 732e  ues() if str(ws.
+0003d020: 6e61 6d65 2920 696e 206e 616d 6573 5f73  name) in names_s
+0003d030: 6574 7d0a 2020 2020 2020 2020 2020 2020  et}.            
+0003d040: 656c 6966 2077 6f72 6b65 7273 2069 7320  elif workers is 
+0003d050: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0003d060: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
+0003d070: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003d080: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
+0003d090: 7273 5b61 6464 7265 7373 5d0a 2020 2020  rs[address].    
+0003d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d0b0: 666f 7220 6164 6472 6573 7320 696e 2077  for address in w
+0003d0c0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+0003d0d0: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
+0003d0e0: 6472 6573 7320 696e 2073 656c 662e 776f  dress in self.wo
+0003d0f0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
+0003d100: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003d110: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003d120: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
+0003d130: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003d140: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
+0003d150: 7273 5b61 6464 7265 7373 5d20 666f 7220  rs[address] for 
+0003d160: 6164 6472 6573 7320 696e 2073 656c 662e  address in self.
+0003d170: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
+0003d180: 282a 2a6b 7761 7267 7329 0a20 2020 2020  (**kwargs).     
+0003d190: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0003d1a0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0003d1b0: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
+0003d1c0: 2020 2020 2072 6574 7572 6e20 7b7d 0a0a       return {}..
+0003d1d0: 2020 2020 2020 2020 2020 2020 7374 6f70              stop
+0003d1e0: 5f61 6d6d 203d 2046 616c 7365 0a20 2020  _amm = False.   
+0003d1f0: 2020 2020 2020 2020 2061 6d6d 3a20 4163           amm: Ac
+0003d200: 7469 7665 4d65 6d6f 7279 4d61 6e61 6765  tiveMemoryManage
+0003d210: 7245 7874 656e 7369 6f6e 203d 2073 656c  rExtension = sel
+0003d220: 662e 6578 7465 6e73 696f 6e73 5b22 616d  f.extensions["am
+0003d230: 6d22 5d0a 2020 2020 2020 2020 2020 2020  m"].            
+0003d240: 6966 206e 6f74 2061 6d6d 2e72 756e 6e69  if not amm.runni
+0003d250: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0003d260: 2020 2020 616d 6d20 3d20 4163 7469 7665      amm = Active
+0003d270: 4d65 6d6f 7279 4d61 6e61 6765 7245 7874  MemoryManagerExt
+0003d280: 656e 7369 6f6e 280a 2020 2020 2020 2020  ension(.        
+0003d290: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003d2a0: 2c20 706f 6c69 6369 6573 3d73 6574 2829  , policies=set()
+0003d2b0: 2c20 7265 6769 7374 6572 3d46 616c 7365  , register=False
+0003d2c0: 2c20 7374 6172 743d 5472 7565 2c20 696e  , start=True, in
+0003d2d0: 7465 7276 616c 3d32 2e30 0a20 2020 2020  terval=2.0.     
+0003d2e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003d2f0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+0003d300: 705f 616d 6d20 3d20 5472 7565 0a0a 2020  p_amm = True..  
+0003d310: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0003d320: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003d330: 6f72 6f73 203d 205b 5d0a 2020 2020 2020  oros = [].      
+0003d340: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
+0003d350: 2069 6e20 7773 733a 0a20 2020 2020 2020   in wss:.       
+0003d360: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0003d370: 6765 722e 696e 666f 2822 5265 7469 7269  ger.info("Retiri
+0003d380: 6e67 2077 6f72 6b65 7220 2573 222c 2077  ng worker %s", w
+0003d390: 732e 6164 6472 6573 7329 0a0a 2020 2020  s.address)..    
+0003d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d3b0: 706f 6c69 6379 203d 2052 6574 6972 6557  policy = RetireW
+0003d3c0: 6f72 6b65 7228 7773 2e61 6464 7265 7373  orker(ws.address
+0003d3d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003d3e0: 2020 2020 2020 616d 6d2e 6164 645f 706f        amm.add_po
+0003d3f0: 6c69 6379 2870 6f6c 6963 7929 0a0a 2020  licy(policy)..  
+0003d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d410: 2020 2320 4368 616e 6765 2057 6f72 6b65    # Change Worke
+0003d420: 722e 7374 6174 7573 2074 6f20 636c 6f73  r.status to clos
+0003d430: 696e 675f 6772 6163 6566 756c 6c79 2e20  ing_gracefully. 
+0003d440: 496d 6d65 6469 6174 656c 7920 7365 740a  Immediately set.
+0003d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d460: 2020 2020 2320 7468 6520 7361 6d65 206f      # the same o
+0003d470: 6e20 7468 6520 7363 6865 6475 6c65 7220  n the scheduler 
+0003d480: 746f 2070 7265 7665 6e74 2072 6163 6520  to prevent race 
+0003d490: 636f 6e64 6974 696f 6e73 2e0a 2020 2020  conditions..    
+0003d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d4b0: 7072 6576 5f73 7461 7475 7320 3d20 7773  prev_status = ws
+0003d4c0: 2e73 7461 7475 730a 2020 2020 2020 2020  .status.        
+0003d4d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003d4e0: 2e68 616e 646c 655f 776f 726b 6572 5f73  .handle_worker_s
+0003d4f0: 7461 7475 735f 6368 616e 6765 280a 2020  tatus_change(.  
+0003d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d510: 2020 2020 2020 5374 6174 7573 2e63 6c6f        Status.clo
+0003d520: 7369 6e67 5f67 7261 6365 6675 6c6c 792c  sing_gracefully,
+0003d530: 2077 732c 2073 7469 6d75 6c75 735f 6964   ws, stimulus_id
+0003d540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d550: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0003d560: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
+0003d570: 4d45 3a20 5765 2073 686f 756c 6420 7365  ME: We should se
+0003d580: 6e64 2061 206d 6573 7361 6765 2074 6f20  nd a message to 
+0003d590: 7468 6520 6e61 6e6e 7920 6669 7273 743b  the nanny first;
+0003d5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d5b0: 2020 2020 2023 2065 7665 6e74 7561 6c6c       # eventuall
+0003d5c0: 7920 776f 726b 6572 7320 776f 6e27 7420  y workers won't 
+0003d5d0: 6265 2061 626c 6520 746f 2063 6c6f 7365  be able to close
+0003d5e0: 2074 6865 6972 206f 776e 206e 616e 6e69   their own nanni
+0003d5f0: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+0003d600: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
+0003d610: 6561 6d5f 636f 6d6d 735b 7773 2e61 6464  eam_comms[ws.add
+0003d620: 7265 7373 5d2e 7365 6e64 280a 2020 2020  ress].send(.    
+0003d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d640: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d660: 2020 226f 7022 3a20 2277 6f72 6b65 722d    "op": "worker-
+0003d670: 7374 6174 7573 2d63 6861 6e67 6522 2c0a  status-change",.
+0003d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d690: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0003d6a0: 7475 7322 3a20 7773 2e73 7461 7475 732e  tus": ws.status.
+0003d6b0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0003d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d6d0: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+0003d6e0: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d700: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003d710: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0003d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d730: 2020 2063 6f72 6f73 2e61 7070 656e 6428     coros.append(
+0003d740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d750: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
+0003d760: 7261 636b 5f72 6574 6972 655f 776f 726b  rack_retire_work
+0003d770: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0003d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d790: 7773 2c0a 2020 2020 2020 2020 2020 2020  ws,.            
+0003d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d7b0: 706f 6c69 6379 2c0a 2020 2020 2020 2020  policy,.        
+0003d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d7d0: 2020 2020 7072 6576 5f73 7461 7475 733d      prev_status=
+0003d7e0: 7072 6576 5f73 7461 7475 732c 0a20 2020  prev_status,.   
+0003d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d800: 2020 2020 2020 2020 2063 6c6f 7365 3d63           close=c
+0003d810: 6c6f 7365 5f77 6f72 6b65 7273 2c0a 2020  lose_workers,.  
+0003d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d830: 2020 2020 2020 2020 2020 7265 6d6f 7665            remove
+0003d840: 3d72 656d 6f76 652c 0a20 2020 2020 2020  =remove,.       
+0003d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d860: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0003d870: 3d73 7469 6d75 6c75 735f 6964 2c0a 2020  =stimulus_id,.  
+0003d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d890: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003d8a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0003d8b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003d8c0: 2047 6976 6520 7468 6520 414d 4d20 6120   Give the AMM a 
+0003d8d0: 6b69 636b 2c20 696e 2061 6464 6974 696f  kick, in additio
+0003d8e0: 6e20 746f 2069 7473 2070 6572 696f 6469  n to its periodi
+0003d8f0: 6320 7275 6e6e 696e 672e 2054 6869 7320  c running. This 
+0003d900: 6973 0a20 2020 2020 2020 2020 2020 2020  is.             
+0003d910: 2020 2023 2074 6f20 6176 6f69 6420 756e     # to avoid un
+0003d920: 6e65 6365 7373 6172 696c 7920 7761 6974  necessarily wait
+0003d930: 696e 6720 666f 7220 6120 706f 7465 6e74  ing for a potent
+0003d940: 6961 6c6c 7920 6172 6269 7472 6172 696c  ially arbitraril
+0003d950: 7920 6c6f 6e67 0a20 2020 2020 2020 2020  y long.         
+0003d960: 2020 2020 2020 2023 2074 696d 6520 2864         # time (d
+0003d970: 6570 656e 6469 6e67 206f 6e20 696e 7465  epending on inte
+0003d980: 7276 616c 2073 6574 7469 6e67 7329 0a20  rval settings). 
+0003d990: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0003d9a0: 6d6d 2e72 756e 5f6f 6e63 6528 290a 0a20  mm.run_once().. 
+0003d9b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003d9c0: 6f72 6b65 7273 5f69 6e66 6f20 3d20 6469  orkers_info = di
+0003d9d0: 6374 2861 7761 6974 2061 7379 6e63 696f  ct(await asyncio
+0003d9e0: 2e67 6174 6865 7228 2a63 6f72 6f73 2929  .gather(*coros))
+0003d9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003da00: 2077 6f72 6b65 7273 5f69 6e66 6f2e 706f   workers_info.po
+0003da10: 7028 4e6f 6e65 2c20 4e6f 6e65 290a 2020  p(None, None).  
+0003da20: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
+0003da30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0003da40: 2020 2069 6620 7374 6f70 5f61 6d6d 3a0a     if stop_amm:.
+0003da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003da60: 2020 2020 616d 6d2e 7374 6f70 2829 0a0a      amm.stop()..
+0003da70: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0003da80: 5f65 7665 6e74 2822 616c 6c22 2c20 7b22  _event("all", {"
+0003da90: 6163 7469 6f6e 223a 2022 7265 7469 7265  action": "retire
+0003daa0: 2d77 6f72 6b65 7273 222c 2022 776f 726b  -workers", "work
+0003dab0: 6572 7322 3a20 776f 726b 6572 735f 696e  ers": workers_in
+0003dac0: 666f 7d29 0a20 2020 2020 2020 2073 656c  fo}).        sel
+0003dad0: 662e 6c6f 675f 6576 656e 7428 6c69 7374  f.log_event(list
+0003dae0: 2877 6f72 6b65 7273 5f69 6e66 6f29 2c20  (workers_info), 
+0003daf0: 7b22 6163 7469 6f6e 223a 2022 7265 7469  {"action": "reti
+0003db00: 7265 6422 7d29 0a0a 2020 2020 2020 2020  red"})..        
+0003db10: 7265 7475 726e 2077 6f72 6b65 7273 5f69  return workers_i
+0003db20: 6e66 6f0a 0a20 2020 2061 7379 6e63 2064  nfo..    async d
+0003db30: 6566 205f 7472 6163 6b5f 7265 7469 7265  ef _track_retire
+0003db40: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+0003db50: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
+0003db60: 733a 2057 6f72 6b65 7253 7461 7465 2c0a  s: WorkerState,.
+0003db70: 2020 2020 2020 2020 706f 6c69 6379 3a20          policy: 
+0003db80: 5265 7469 7265 576f 726b 6572 2c0a 2020  RetireWorker,.  
+0003db90: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
+0003dba0: 733a 2053 7461 7475 732c 0a20 2020 2020  s: Status,.     
+0003dbb0: 2020 2063 6c6f 7365 3a20 626f 6f6c 2c0a     close: bool,.
+0003dbc0: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
+0003dbd0: 626f 6f6c 2c0a 2020 2020 2020 2020 7374  bool,.        st
+0003dbe0: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
+0003dbf0: 2020 2020 2920 2d3e 2074 7570 6c65 3a20      ) -> tuple: 
+0003dc00: 2023 2074 7570 6c65 5b73 7472 207c 204e   # tuple[str | N
+0003dc10: 6f6e 652c 2064 6963 745d 0a20 2020 2020  one, dict].     
+0003dc20: 2020 2077 6869 6c65 206e 6f74 2070 6f6c     while not pol
+0003dc30: 6963 792e 646f 6e65 2829 3a0a 2020 2020  icy.done():.    
+0003dc40: 2020 2020 2020 2020 2320 536c 6565 7020          # Sleep 
+0003dc50: 302e 3031 7320 7768 656e 2074 6865 7265  0.01s when there
+0003dc60: 2061 7265 2034 2074 6173 6b73 206f 7220   are 4 tasks or 
+0003dc70: 6c65 7373 0a20 2020 2020 2020 2020 2020  less.           
+0003dc80: 2023 2053 6c65 6570 2030 2e35 7320 7768   # Sleep 0.5s wh
+0003dc90: 656e 2074 6865 7265 2061 7265 2032 3030  en there are 200
+0003dca0: 206f 7220 6d6f 7265 0a20 2020 2020 2020   or more.       
+0003dcb0: 2020 2020 2070 6f6c 6c5f 696e 7465 7276       poll_interv
+0003dcc0: 616c 203d 206d 6178 2830 2e30 312c 206d  al = max(0.01, m
+0003dcd0: 696e 2830 2e35 2c20 6c65 6e28 7773 2e68  in(0.5, len(ws.h
+0003dce0: 6173 5f77 6861 7429 202f 2034 3030 2929  as_what) / 400))
+0003dcf0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0003dd00: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+0003dd10: 2870 6f6c 6c5f 696e 7465 7276 616c 290a  (poll_interval).
+0003dd20: 0a20 2020 2020 2020 2069 6620 706f 6c69  .        if poli
+0003dd30: 6379 2e6e 6f5f 7265 6369 7069 656e 7473  cy.no_recipients
+0003dd40: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0003dd50: 4162 6f72 7420 7265 7469 7265 6d65 6e74  Abort retirement
+0003dd60: 2e20 5468 6973 2074 696d 6520 7765 2064  . This time we d
+0003dd70: 6f6e 2774 206e 6565 6420 746f 2077 6f72  on't need to wor
+0003dd80: 7279 2061 626f 7574 2072 6163 650a 2020  ry about race.  
+0003dd90: 2020 2020 2020 2020 2020 2320 636f 6e64            # cond
+0003dda0: 6974 696f 6e73 2061 6e64 2077 6520 6361  itions and we ca
+0003ddb0: 6e20 7761 6974 2066 6f72 2061 2073 6368  n wait for a sch
+0003ddc0: 6564 756c 6572 2d3e 776f 726b 6572 2d3e  eduler->worker->
+0003ddd0: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+0003dde0: 2020 2020 2020 2320 726f 756e 642d 7472        # round-tr
+0003ddf0: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
+0003de00: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+0003de10: 735b 7773 2e61 6464 7265 7373 5d2e 7365  s[ws.address].se
+0003de20: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+0003de30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003de40: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+0003de50: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
+0003de60: 6861 6e67 6522 2c0a 2020 2020 2020 2020  hange",.        
+0003de70: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0003de80: 7475 7322 3a20 7072 6576 5f73 7461 7475  tus": prev_statu
+0003de90: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
+0003dea0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+0003deb0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+0003dec0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+0003ded0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0003dee0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003def0: 2020 2020 7265 7475 726e 204e 6f6e 652c      return None,
+0003df00: 207b 7d0a 0a20 2020 2020 2020 206c 6f67   {}..        log
+0003df10: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
+0003df20: 2020 2020 2020 2022 416c 6c20 756e 6971         "All uniq
+0003df30: 7565 206b 6579 7320 6f6e 2077 6f72 6b65  ue keys on worke
+0003df40: 7220 2573 2068 6176 6520 6265 656e 2072  r %s have been r
+0003df50: 6570 6c69 6361 7465 6420 656c 7365 7768  eplicated elsewh
+0003df60: 6572 6522 2c20 7773 2e61 6464 7265 7373  ere", ws.address
+0003df70: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0003df80: 2020 2020 6966 2072 656d 6f76 653a 0a20      if remove:. 
+0003df90: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0003dfa0: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
+0003dfb0: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
+0003dfc0: 2020 2020 2077 732e 6164 6472 6573 732c       ws.address,
+0003dfd0: 2073 6166 653d 5472 7565 2c20 636c 6f73   safe=True, clos
+0003dfe0: 653d 636c 6f73 652c 2073 7469 6d75 6c75  e=close, stimulu
+0003dff0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+0003e000: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0003e010: 2020 2020 2020 2065 6c69 6620 636c 6f73         elif clos
+0003e020: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0003e030: 656c 662e 636c 6f73 655f 776f 726b 6572  elf.close_worker
+0003e040: 2877 732e 6164 6472 6573 7329 0a0a 2020  (ws.address)..  
+0003e050: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+0003e060: 6f28 2252 6574 6972 6564 2077 6f72 6b65  o("Retired worke
+0003e070: 7220 2573 222c 2077 732e 6164 6472 6573  r %s", ws.addres
+0003e080: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+0003e090: 6e20 7773 2e61 6464 7265 7373 2c20 7773  n ws.address, ws
+0003e0a0: 2e69 6465 6e74 6974 7928 290a 0a20 2020  .identity()..   
+0003e0b0: 2064 6566 2061 6464 5f6b 6579 7328 0a20   def add_keys(. 
+0003e0c0: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
+0003e0d0: 6b65 723a 2073 7472 2c20 6b65 7973 3a20  ker: str, keys: 
+0003e0e0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
+0003e0f0: 3d20 2829 2c20 7374 696d 756c 7573 5f69  = (), stimulus_i
+0003e100: 643a 2073 7472 207c 204e 6f6e 6520 3d20  d: str | None = 
+0003e110: 4e6f 6e65 0a20 2020 2029 202d 3e20 4c69  None.    ) -> Li
+0003e120: 7465 7261 6c5b 224f 4b22 2c20 226e 6f74  teral["OK", "not
+0003e130: 2066 6f75 6e64 225d 3a0a 2020 2020 2020   found"]:.      
+0003e140: 2020 2222 220a 2020 2020 2020 2020 4c65    """.        Le
+0003e150: 6172 6e20 7468 6174 2061 2077 6f72 6b65  arn that a worke
+0003e160: 7220 6861 7320 6365 7274 6169 6e20 6b65  r has certain ke
+0003e170: 7973 0a0a 2020 2020 2020 2020 5468 6973  ys..        This
+0003e180: 2073 686f 756c 6420 6e6f 7420 6265 2075   should not be u
+0003e190: 7365 6420 696e 2070 7261 6374 6963 6520  sed in practice 
+0003e1a0: 616e 6420 6973 206d 6f73 746c 7920 6865  and is mostly he
+0003e1b0: 7265 2066 6f72 206c 6567 6163 790a 2020  re for legacy.  
+0003e1c0: 2020 2020 2020 7265 6173 6f6e 732e 2020        reasons.  
+0003e1d0: 486f 7765 7665 722c 2069 7420 6973 2073  However, it is s
+0003e1e0: 656e 7420 6279 2077 6f72 6b65 7273 2066  ent by workers f
+0003e1f0: 726f 6d20 7469 6d65 2074 6f20 7469 6d65  rom time to time
+0003e200: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0003e210: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
+0003e220: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
+0003e230: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0003e240: 2072 6574 7572 6e20 226e 6f74 2066 6f75   return "not fou
+0003e250: 6e64 220a 2020 2020 2020 2020 7773 3a20  nd".        ws: 
+0003e260: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
+0003e270: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
+0003e280: 725d 0a20 2020 2020 2020 2072 6564 756e  r].        redun
+0003e290: 6461 6e74 5f72 6570 6c69 6361 7320 3d20  dant_replicas = 
+0003e2a0: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
+0003e2b0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
+0003e2c0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+0003e2d0: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
+0003e2e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003e2f0: 7473 2069 7320 6e6f 7420 4e6f 6e65 2061  ts is not None a
+0003e300: 6e64 2074 732e 7374 6174 6520 3d3d 2022  nd ts.state == "
+0003e310: 6d65 6d6f 7279 223a 0a20 2020 2020 2020  memory":.       
+0003e320: 2020 2020 2020 2020 2069 6620 7773 206e           if ws n
+0003e330: 6f74 2069 6e20 7473 2e77 686f 5f68 6173  ot in ts.who_has
+0003e340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e350: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
+0003e360: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
+0003e370: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003e380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e390: 2072 6564 756e 6461 6e74 5f72 6570 6c69   redundant_repli
+0003e3a0: 6361 732e 6170 7065 6e64 286b 6579 290a  cas.append(key).
+0003e3b0: 0a20 2020 2020 2020 2069 6620 7265 6475  .        if redu
+0003e3c0: 6e64 616e 745f 7265 706c 6963 6173 3a0a  ndant_replicas:.
+0003e3d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0003e3e0: 6f74 2073 7469 6d75 6c75 735f 6964 3a0a  ot stimulus_id:.
+0003e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e400: 7374 696d 756c 7573 5f69 6420 3d20 6622  stimulus_id = f"
+0003e410: 7265 6475 6e64 616e 742d 7265 706c 6963  redundant-replic
+0003e420: 6173 2d7b 7469 6d65 2829 7d22 0a20 2020  as-{time()}".   
+0003e430: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
+0003e440: 726b 6572 5f73 656e 6428 0a20 2020 2020  rker_send(.     
+0003e450: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0003e460: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0003e470: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0003e480: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+0003e490: 7265 6d6f 7665 2d72 6570 6c69 6361 7322  remove-replicas"
+0003e4a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e4b0: 2020 2020 2020 226b 6579 7322 3a20 7265        "keys": re
+0003e4c0: 6475 6e64 616e 745f 7265 706c 6963 6173  dundant_replicas
+0003e4d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e4e0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
+0003e4f0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
+0003e500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e510: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0003e520: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
+0003e530: 726e 2022 4f4b 220a 0a20 2020 2040 6c6f  rn "OK"..    @lo
+0003e540: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+0003e550: 2075 7064 6174 655f 6461 7461 280a 2020   update_data(.  
+0003e560: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0003e570: 2020 2020 2a2c 0a20 2020 2020 2020 2077      *,.        w
+0003e580: 686f 5f68 6173 3a20 6469 6374 5b73 7472  ho_has: dict[str
+0003e590: 2c20 6c69 7374 5b73 7472 5d5d 2c0a 2020  , list[str]],.  
+0003e5a0: 2020 2020 2020 6e62 7974 6573 3a20 6469        nbytes: di
+0003e5b0: 6374 5b73 7472 2c20 696e 745d 2c0a 2020  ct[str, int],.  
+0003e5c0: 2020 2020 2020 636c 6965 6e74 3a20 7374        client: st
+0003e5d0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+0003e5e0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+0003e5f0: 2020 2020 2020 2020 2222 224c 6561 726e          """Learn
+0003e600: 2074 6861 7420 6e65 7720 6461 7461 2068   that new data h
+0003e610: 6173 2065 6e74 6572 6564 2074 6865 206e  as entered the n
+0003e620: 6574 776f 726b 2066 726f 6d20 616e 2065  etwork from an e
+0003e630: 7874 6572 6e61 6c20 736f 7572 6365 2222  xternal source""
+0003e640: 220a 2020 2020 2020 2020 7768 6f5f 6861  ".        who_ha
+0003e650: 7320 3d20 7b6b 3a20 5b73 656c 662e 636f  s = {k: [self.co
+0003e660: 6572 6365 5f61 6464 7265 7373 2876 7629  erce_address(vv)
+0003e670: 2066 6f72 2076 7620 696e 2076 5d20 666f   for vv in v] fo
+0003e680: 7220 6b2c 2076 2069 6e20 7768 6f5f 6861  r k, v in who_ha
+0003e690: 732e 6974 656d 7328 297d 0a20 2020 2020  s.items()}.     
+0003e6a0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0003e6b0: 2255 7064 6174 6520 6461 7461 2025 7322  "Update data %s"
+0003e6c0: 2c20 7768 6f5f 6861 7329 0a0a 2020 2020  , who_has)..    
+0003e6d0: 2020 2020 666f 7220 6b65 792c 2077 6f72      for key, wor
+0003e6e0: 6b65 7273 2069 6e20 7768 6f5f 6861 732e  kers in who_has.
+0003e6f0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0003e700: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0003e710: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+0003e720: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+0003e730: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003e740: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+0003e750: 6c66 2e6e 6577 5f74 6173 6b28 6b65 792c  lf.new_task(key,
+0003e760: 204e 6f6e 652c 2022 6d65 6d6f 7279 2229   None, "memory")
+0003e770: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+0003e780: 7374 6174 6520 3d20 226d 656d 6f72 7922  state = "memory"
+0003e790: 0a20 2020 2020 2020 2020 2020 2074 735f  .            ts_
+0003e7a0: 6e62 7974 6573 203d 206e 6279 7465 732e  nbytes = nbytes.
+0003e7b0: 6765 7428 6b65 792c 202d 3129 0a20 2020  get(key, -1).   
+0003e7c0: 2020 2020 2020 2020 2069 6620 7473 5f6e           if ts_n
+0003e7d0: 6279 7465 7320 3e3d 2030 3a0a 2020 2020  bytes >= 0:.    
+0003e7e0: 2020 2020 2020 2020 2020 2020 7473 2e73              ts.s
+0003e7f0: 6574 5f6e 6279 7465 7328 7473 5f6e 6279  et_nbytes(ts_nby
+0003e800: 7465 7329 0a0a 2020 2020 2020 2020 2020  tes)..          
+0003e810: 2020 666f 7220 7720 696e 2077 6f72 6b65    for w in worke
+0003e820: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0003e830: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
+0003e840: 726b 6572 735b 775d 0a20 2020 2020 2020  rkers[w].       
+0003e850: 2020 2020 2020 2020 2069 6620 7773 206e           if ws n
+0003e860: 6f74 2069 6e20 7473 2e77 686f 5f68 6173  ot in ts.who_has
+0003e870: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e880: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
+0003e890: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
+0003e8a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003e8b0: 7265 706f 7274 287b 226f 7022 3a20 226b  report({"op": "k
+0003e8c0: 6579 2d69 6e2d 6d65 6d6f 7279 222c 2022  ey-in-memory", "
+0003e8d0: 6b65 7922 3a20 6b65 792c 2022 776f 726b  key": key, "work
+0003e8e0: 6572 7322 3a20 6c69 7374 2877 6f72 6b65  ers": list(worke
+0003e8f0: 7273 297d 290a 0a20 2020 2020 2020 2069  rs)})..        i
+0003e900: 6620 636c 6965 6e74 3a0a 2020 2020 2020  f client:.      
+0003e910: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0003e920: 745f 6465 7369 7265 735f 6b65 7973 286b  t_desires_keys(k
+0003e930: 6579 733d 6c69 7374 2877 686f 5f68 6173  eys=list(who_has
+0003e940: 292c 2063 6c69 656e 743d 636c 6965 6e74  ), client=client
+0003e950: 290a 0a20 2020 2040 6f76 6572 6c6f 6164  )..    @overload
+0003e960: 0a20 2020 2064 6566 2072 6570 6f72 745f  .    def report_
+0003e970: 6f6e 5f6b 6579 2873 656c 662c 206b 6579  on_key(self, key
+0003e980: 3a20 7374 722c 202a 2c20 636c 6965 6e74  : str, *, client
+0003e990: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+0003e9a0: 6f6e 6529 202d 3e20 4e6f 6e65 3a0a 2020  one) -> None:.  
+0003e9b0: 2020 2020 2020 2e2e 2e0a 0a20 2020 2040        .....    @
+0003e9c0: 6f76 6572 6c6f 6164 0a20 2020 2064 6566  overload.    def
+0003e9d0: 2072 6570 6f72 745f 6f6e 5f6b 6579 2873   report_on_key(s
+0003e9e0: 656c 662c 202a 2c20 7473 3a20 5461 736b  elf, *, ts: Task
+0003e9f0: 5374 6174 652c 2063 6c69 656e 743a 2073  State, client: s
+0003ea00: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+0003ea10: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0003ea20: 2020 202e 2e2e 0a0a 2020 2020 6465 6620     .....    def 
+0003ea30: 7265 706f 7274 5f6f 6e5f 6b65 7928 7365  report_on_key(se
+0003ea40: 6c66 2c20 6b65 793d 4e6f 6e65 2c20 2a2c  lf, key=None, *,
+0003ea50: 2074 733d 4e6f 6e65 2c20 636c 6965 6e74   ts=None, client
+0003ea60: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
+0003ea70: 6966 2028 7473 2069 7320 4e6f 6e65 2920  if (ts is None) 
+0003ea80: 3d3d 2028 6b65 7920 6973 204e 6f6e 6529  == (key is None)
+0003ea90: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0003eaa0: 6973 6520 5661 6c75 6545 7272 6f72 2820  ise ValueError( 
+0003eab0: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
+0003eac0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0003ead0: 2020 2066 2274 7320 616e 6420 6b65 7920     f"ts and key 
+0003eae0: 6172 6520 6d75 7475 616c 6c79 2065 7863  are mutually exc
+0003eaf0: 6c75 7369 7665 3b20 7265 6365 6976 6564  lusive; received
+0003eb00: 207b 6b65 793d 2172 7d2c 207b 7473 3d21   {key=!r}, {ts=!
+0003eb10: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
+0003eb20: 290a 2020 2020 2020 2020 6966 2074 7320  ).        if ts 
+0003eb30: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003eb40: 2020 2020 2061 7373 6572 7420 6b65 7920       assert key 
+0003eb50: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+0003eb60: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+0003eb70: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
+0003eb80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0003eb90: 2020 2020 2020 2020 2020 206b 6579 203d             key =
+0003eba0: 2074 732e 6b65 790a 0a20 2020 2020 2020   ts.key..       
+0003ebb0: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
+0003ebc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003ebd0: 7265 706f 7274 5f6d 7367 203d 205f 7461  report_msg = _ta
+0003ebe0: 736b 5f74 6f5f 7265 706f 7274 5f6d 7367  sk_to_report_msg
+0003ebf0: 2874 7329 0a20 2020 2020 2020 2065 6c73  (ts).        els
+0003ec00: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0003ec10: 6570 6f72 745f 6d73 6720 3d20 7b22 6f70  eport_msg = {"op
+0003ec20: 223a 2022 6361 6e63 656c 6c65 642d 6b65  ": "cancelled-ke
+0003ec30: 7973 222c 2022 6b65 7973 223a 205b 6b65  ys", "keys": [ke
+0003ec40: 795d 7d0a 2020 2020 2020 2020 6966 2072  y]}.        if r
+0003ec50: 6570 6f72 745f 6d73 6720 6973 206e 6f74  eport_msg is not
+0003ec60: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0003ec70: 2020 2073 656c 662e 7265 706f 7274 2872     self.report(r
+0003ec80: 6570 6f72 745f 6d73 672c 2074 733d 7473  eport_msg, ts=ts
+0003ec90: 2c20 636c 6965 6e74 3d63 6c69 656e 7429  , client=client)
+0003eca0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+0003ecb0: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
+0003ecc0: 6665 6564 280a 2020 2020 2020 2020 7365  feed(.        se
+0003ecd0: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
+0003ece0: 3a20 436f 6d6d 2c0a 2020 2020 2020 2020  : Comm,.        
+0003ecf0: 6675 6e63 7469 6f6e 3a20 6279 7465 7320  function: bytes 
+0003ed00: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003ed10: 2020 2020 2020 2073 6574 7570 3a20 6279         setup: by
+0003ed20: 7465 7320 7c20 4e6f 6e65 203d 204e 6f6e  tes | None = Non
+0003ed30: 652c 0a20 2020 2020 2020 2074 6561 7264  e,.        teard
+0003ed40: 6f77 6e3a 2062 7974 6573 207c 204e 6f6e  own: bytes | Non
+0003ed50: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0003ed60: 2020 696e 7465 7276 616c 3a20 7374 7220    interval: str 
+0003ed70: 7c20 666c 6f61 7420 3d20 2231 7322 2c0a  | float = "1s",.
+0003ed80: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0003ed90: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+0003eda0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0003edb0: 220a 2020 2020 2020 2020 5072 6f76 6964  ".        Provid
+0003edc0: 6573 2061 2064 6174 6120 436f 6d6d 2074  es a data Comm t
+0003edd0: 6f20 6578 7465 726e 616c 2072 6571 7565  o external reque
+0003ede0: 7374 6572 0a0a 2020 2020 2020 2020 4361  ster..        Ca
+0003edf0: 7574 696f 6e3a 2074 6869 7320 7275 6e73  ution: this runs
+0003ee00: 2061 7262 6974 7261 7279 2050 7974 686f   arbitrary Pytho
+0003ee10: 6e20 636f 6465 206f 6e20 7468 6520 7363  n code on the sc
+0003ee20: 6865 6475 6c65 722e 2020 5468 6973 2073  heduler.  This s
+0003ee30: 686f 756c 640a 2020 2020 2020 2020 6576  hould.        ev
+0003ee40: 656e 7475 616c 6c79 2062 6520 7068 6173  entually be phas
+0003ee50: 6564 206f 7574 2e20 2049 7420 6973 206d  ed out.  It is m
+0003ee60: 6f73 746c 7920 7573 6564 2062 7920 6469  ostly used by di
+0003ee70: 6167 6e6f 7374 6963 732e 0a20 2020 2020  agnostics..     
+0003ee80: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0003ee90: 6620 6e6f 7420 6461 736b 2e63 6f6e 6669  f not dask.confi
+0003eea0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+0003eeb0: 6564 2e73 6368 6564 756c 6572 2e70 6963  ed.scheduler.pic
+0003eec0: 6b6c 6522 293a 0a20 2020 2020 2020 2020  kle"):.         
+0003eed0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+0003eee0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0003eef0: 2020 2022 5472 6965 6420 746f 2063 616c     "Tried to cal
+0003ef00: 6c20 2766 6565 6427 2072 6f75 7465 2077  l 'feed' route w
+0003ef10: 6974 6820 6375 7374 6f6d 2066 756e 6374  ith custom funct
+0003ef20: 696f 6e73 2c20 6275 7420 220a 2020 2020  ions, but ".    
+0003ef30: 2020 2020 2020 2020 2020 2020 2270 6963              "pic
+0003ef40: 6b6c 6520 6973 2064 6973 616c 6c6f 7765  kle is disallowe
+0003ef50: 642e 2020 5365 7420 7468 6520 2764 6973  d.  Set the 'dis
+0003ef60: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+0003ef70: 6572 2e70 6963 6b6c 6527 220a 2020 2020  er.pickle'".    
+0003ef80: 2020 2020 2020 2020 2020 2020 2263 6f6e              "con
+0003ef90: 6669 6720 7661 6c75 6520 746f 2054 7275  fig value to Tru
+0003efa0: 6520 746f 2075 7365 2074 6865 2027 6665  e to use the 'fe
+0003efb0: 6564 2720 726f 7574 6520 2874 6869 7320  ed' route (this 
+0003efc0: 6973 206d 6f73 746c 7920 220a 2020 2020  is mostly ".    
+0003efd0: 2020 2020 2020 2020 2020 2020 2263 6f6d              "com
+0003efe0: 6d6f 6e6c 7920 7573 6564 2077 6974 6820  monly used with 
+0003eff0: 7072 6f67 7265 7373 2062 6172 7329 220a  progress bars)".
+0003f000: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0003f010: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003f020: 0a0a 2020 2020 2020 2020 696e 7465 7276  ..        interv
+0003f030: 616c 203d 2070 6172 7365 5f74 696d 6564  al = parse_timed
+0003f040: 656c 7461 2869 6e74 6572 7661 6c29 0a20  elta(interval). 
+0003f050: 2020 2020 2020 2069 6620 6675 6e63 7469         if functi
+0003f060: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+0003f070: 6675 6e63 7469 6f6e 203d 2070 6963 6b6c  function = pickl
+0003f080: 652e 6c6f 6164 7328 6675 6e63 7469 6f6e  e.loads(function
+0003f090: 290a 2020 2020 2020 2020 6966 2073 6574  ).        if set
+0003f0a0: 7570 3a0a 2020 2020 2020 2020 2020 2020  up:.            
+0003f0b0: 7365 7475 7020 3d20 7069 636b 6c65 2e6c  setup = pickle.l
+0003f0c0: 6f61 6473 2873 6574 7570 290a 0a20 2020  oads(setup)..   
+0003f0d0: 2020 2020 2069 6620 7465 6172 646f 776e       if teardown
+0003f0e0: 3a0a 2020 2020 2020 2020 2020 2020 7465  :.            te
+0003f0f0: 6172 646f 776e 203d 2070 6963 6b6c 652e  ardown = pickle.
+0003f100: 6c6f 6164 7328 7465 6172 646f 776e 290a  loads(teardown).
+0003f110: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+0003f120: 7365 7475 7028 7365 6c66 2920 6966 2073  setup(self) if s
+0003f130: 6574 7570 2065 6c73 6520 4e6f 6e65 2020  etup else None  
+0003f140: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+0003f150: 2020 2020 2020 2069 6620 696e 7370 6563         if inspec
+0003f160: 742e 6973 6177 6169 7461 626c 6528 7374  t.isawaitable(st
+0003f170: 6174 6529 3a0a 2020 2020 2020 2020 2020  ate):.          
+0003f180: 2020 7374 6174 6520 3d20 6177 6169 7420    state = await 
+0003f190: 7374 6174 650a 2020 2020 2020 2020 7472  state.        tr
+0003f1a0: 793a 0a20 2020 2020 2020 2020 2020 2077  y:.            w
+0003f1b0: 6869 6c65 2073 656c 662e 7374 6174 7573  hile self.status
+0003f1c0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+0003f1d0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0003f1e0: 2020 2020 6966 2073 7461 7465 2069 7320      if state is 
+0003f1f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003f200: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0003f210: 7365 203d 2066 756e 6374 696f 6e28 7365  se = function(se
+0003f220: 6c66 2920 2023 2074 7970 653a 2069 676e  lf)  # type: ign
+0003f230: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+0003f240: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003f250: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0003f260: 7370 6f6e 7365 203d 2066 756e 6374 696f  sponse = functio
+0003f270: 6e28 7365 6c66 2c20 7374 6174 6529 2020  n(self, state)  
+0003f280: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+0003f290: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0003f2a0: 7761 6974 2063 6f6d 6d2e 7772 6974 6528  wait comm.write(
+0003f2b0: 7265 7370 6f6e 7365 290a 2020 2020 2020  response).      
+0003f2c0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0003f2d0: 6173 796e 6369 6f2e 736c 6565 7028 696e  asyncio.sleep(in
+0003f2e0: 7465 7276 616c 290a 2020 2020 2020 2020  terval).        
+0003f2f0: 6578 6365 7074 204f 5345 7272 6f72 3a0a  except OSError:.
+0003f300: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0003f310: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+0003f320: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0003f330: 2074 6561 7264 6f77 6e3a 0a20 2020 2020   teardown:.     
+0003f340: 2020 2020 2020 2020 2020 2074 6561 7264             teard
+0003f350: 6f77 6e28 7365 6c66 2c20 7374 6174 6529  own(self, state)
+0003f360: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0003f370: 0a0a 2020 2020 6465 6620 6c6f 675f 776f  ..    def log_wo
+0003f380: 726b 6572 5f65 7665 6e74 280a 2020 2020  rker_event(.    
+0003f390: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+0003f3a0: 3a20 7374 722c 2074 6f70 6963 3a20 7374  : str, topic: st
+0003f3b0: 7220 7c20 436f 6c6c 6563 7469 6f6e 5b73  r | Collection[s
+0003f3c0: 7472 5d2c 206d 7367 3a20 416e 790a 2020  tr], msg: Any.  
+0003f3d0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+0003f3e0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0003f3f0: 6365 286d 7367 2c20 6469 6374 293a 0a20  ce(msg, dict):. 
+0003f400: 2020 2020 2020 2020 2020 206d 7367 5b22             msg["
+0003f410: 776f 726b 6572 225d 203d 2077 6f72 6b65  worker"] = worke
+0003f420: 720a 2020 2020 2020 2020 7365 6c66 2e6c  r.        self.l
+0003f430: 6f67 5f65 7665 6e74 2874 6f70 6963 2c20  og_event(topic, 
+0003f440: 6d73 6729 0a0a 2020 2020 6465 6620 7375  msg)..    def su
+0003f450: 6273 6372 6962 655f 776f 726b 6572 5f73  bscribe_worker_s
+0003f460: 7461 7475 7328 7365 6c66 2c20 636f 6d6d  tatus(self, comm
+0003f470: 3a20 436f 6d6d 2920 2d3e 2073 7472 3a0a  : Comm) -> str:.
+0003f480: 2020 2020 2020 2020 576f 726b 6572 5374          WorkerSt
+0003f490: 6174 7573 506c 7567 696e 2873 656c 662c  atusPlugin(self,
+0003f4a0: 2063 6f6d 6d29 0a20 2020 2020 2020 2069   comm).        i
+0003f4b0: 6465 6e74 203d 2073 656c 662e 6964 656e  dent = self.iden
+0003f4c0: 7469 7479 2829 0a20 2020 2020 2020 2066  tity().        f
+0003f4d0: 6f72 2076 2069 6e20 6964 656e 745b 2277  or v in ident["w
+0003f4e0: 6f72 6b65 7273 225d 2e76 616c 7565 7328  orkers"].values(
+0003f4f0: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
+0003f500: 656c 2076 5b22 6d65 7472 6963 7322 5d0a  el v["metrics"].
+0003f510: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+0003f520: 765b 226c 6173 745f 7365 656e 225d 0a20  v["last_seen"]. 
+0003f530: 2020 2020 2020 2072 6574 7572 6e20 6964         return id
+0003f540: 656e 740a 0a20 2020 2064 6566 2067 6574  ent..    def get
+0003f550: 5f70 726f 6365 7373 696e 6728 0a20 2020  _processing(.   
+0003f560: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
+0003f570: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
+0003f580: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
+0003f590: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
+0003f5a0: 722c 206c 6973 745b 7374 725d 5d3a 0a20  r, list[str]]:. 
+0003f5b0: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+0003f5c0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0003f5d0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0003f5e0: 7273 203d 2073 6574 286d 6170 2873 656c  rs = set(map(sel
+0003f5f0: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
+0003f600: 2c20 776f 726b 6572 7329 290a 2020 2020  , workers)).    
+0003f610: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0003f620: 773a 205b 7473 2e6b 6579 2066 6f72 2074  w: [ts.key for t
+0003f630: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+0003f640: 735b 775d 2e70 726f 6365 7373 696e 675d  s[w].processing]
+0003f650: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
+0003f660: 737d 0a20 2020 2020 2020 2065 6c73 653a  s}.        else:
+0003f670: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003f680: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
+0003f690: 2020 2020 2020 773a 205b 7473 2e6b 6579        w: [ts.key
+0003f6a0: 2066 6f72 2074 7320 696e 2077 732e 7072   for ts in ws.pr
+0003f6b0: 6f63 6573 7369 6e67 5d20 666f 7220 772c  ocessing] for w,
+0003f6c0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
+0003f6d0: 6572 732e 6974 656d 7328 290a 2020 2020  ers.items().    
+0003f6e0: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
+0003f6f0: 6566 2067 6574 5f77 686f 5f68 6173 2873  ef get_who_has(s
+0003f700: 656c 662c 206b 6579 733a 2049 7465 7261  elf, keys: Itera
+0003f710: 626c 655b 7374 725d 207c 204e 6f6e 6520  ble[str] | None 
+0003f720: 3d20 4e6f 6e65 2920 2d3e 2064 6963 745b  = None) -> dict[
+0003f730: 7374 722c 206c 6973 745b 7374 725d 5d3a  str, list[str]]:
+0003f740: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
+0003f750: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0003f760: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003f770: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003f780: 2020 206b 6579 3a20 5b77 732e 6164 6472     key: [ws.addr
+0003f790: 6573 7320 666f 7220 7773 2069 6e20 7365  ess for ws in se
+0003f7a0: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 7768  lf.tasks[key].wh
+0003f7b0: 6f5f 6861 735d 0a20 2020 2020 2020 2020  o_has].         
+0003f7c0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
+0003f7d0: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
+0003f7e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0003f7f0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0003f800: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+0003f810: 6579 730a 2020 2020 2020 2020 2020 2020  eys.            
+0003f820: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+0003f830: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003f840: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
+0003f850: 2020 2020 206b 6579 3a20 5b77 732e 6164       key: [ws.ad
+0003f860: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
+0003f870: 7473 2e77 686f 5f68 6173 5d20 666f 7220  ts.who_has] for 
+0003f880: 6b65 792c 2074 7320 696e 2073 656c 662e  key, ts in self.
+0003f890: 7461 736b 732e 6974 656d 7328 290a 2020  tasks.items().  
+0003f8a0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0003f8b0: 2064 6566 2067 6574 5f68 6173 5f77 6861   def get_has_wha
+0003f8c0: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+0003f8d0: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
+0003f8e0: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
+0003f8f0: 204e 6f6e 650a 2020 2020 2920 2d3e 2064   None.    ) -> d
+0003f900: 6963 745b 7374 722c 206c 6973 745b 7374  ict[str, list[st
+0003f910: 725d 5d3a 0a20 2020 2020 2020 2069 6620  r]]:.        if 
+0003f920: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
+0003f930: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003f940: 2077 6f72 6b65 7273 203d 206d 6170 2873   workers = map(s
+0003f950: 656c 662e 636f 6572 6365 5f61 6464 7265  elf.coerce_addre
+0003f960: 7373 2c20 776f 726b 6572 7329 0a20 2020  ss, workers).   
+0003f970: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003f980: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003f990: 2020 773a 205b 7473 2e6b 6579 2066 6f72    w: [ts.key for
+0003f9a0: 2074 7320 696e 2073 656c 662e 776f 726b   ts in self.work
+0003f9b0: 6572 735b 775d 2e68 6173 5f77 6861 745d  ers[w].has_what]
+0003f9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f9d0: 2069 6620 7720 696e 2073 656c 662e 776f   if w in self.wo
+0003f9e0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
+0003f9f0: 2020 2020 2020 656c 7365 205b 5d0a 2020        else [].  
+0003fa00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003fa10: 7220 7720 696e 2077 6f72 6b65 7273 0a20  r w in workers. 
+0003fa20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0003fa30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003fa40: 2020 2020 2020 2072 6574 7572 6e20 7b77         return {w
+0003fa50: 3a20 5b74 732e 6b65 7920 666f 7220 7473  : [ts.key for ts
+0003fa60: 2069 6e20 7773 2e68 6173 5f77 6861 745d   in ws.has_what]
+0003fa70: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
+0003fa80: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
+0003fa90: 2829 7d0a 0a20 2020 2064 6566 2067 6574  ()}..    def get
+0003faa0: 5f6e 636f 7265 7328 7365 6c66 2c20 776f  _ncores(self, wo
+0003fab0: 726b 6572 733a 2049 7465 7261 626c 655b  rkers: Iterable[
+0003fac0: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
+0003fad0: 6e65 2920 2d3e 2064 6963 745b 7374 722c  ne) -> dict[str,
+0003fae0: 2069 6e74 5d3a 0a20 2020 2020 2020 2069   int]:.        i
+0003faf0: 6620 776f 726b 6572 7320 6973 206e 6f74  f workers is not
+0003fb00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0003fb10: 2020 2077 6f72 6b65 7273 203d 206d 6170     workers = map
+0003fb20: 2873 656c 662e 636f 6572 6365 5f61 6464  (self.coerce_add
+0003fb30: 7265 7373 2c20 776f 726b 6572 7329 0a20  ress, workers). 
+0003fb40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003fb50: 6e20 7b77 3a20 7365 6c66 2e77 6f72 6b65  n {w: self.worke
+0003fb60: 7273 5b77 5d2e 6e74 6872 6561 6473 2066  rs[w].nthreads f
+0003fb70: 6f72 2077 2069 6e20 776f 726b 6572 7320  or w in workers 
+0003fb80: 6966 2077 2069 6e20 7365 6c66 2e77 6f72  if w in self.wor
+0003fb90: 6b65 7273 7d0a 2020 2020 2020 2020 656c  kers}.        el
+0003fba0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003fbb0: 7265 7475 726e 207b 773a 2077 732e 6e74  return {w: ws.nt
+0003fbc0: 6872 6561 6473 2066 6f72 2077 2c20 7773  hreads for w, ws
+0003fbd0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0003fbe0: 2e69 7465 6d73 2829 7d0a 0a20 2020 2064  .items()}..    d
+0003fbf0: 6566 2067 6574 5f6e 636f 7265 735f 7275  ef get_ncores_ru
+0003fc00: 6e6e 696e 6728 0a20 2020 2020 2020 2073  nning(.        s
+0003fc10: 656c 662c 2077 6f72 6b65 7273 3a20 4974  elf, workers: It
+0003fc20: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+0003fc30: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
+0003fc40: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
+0003fc50: 5d3a 0a20 2020 2020 2020 206e 636f 7265  ]:.        ncore
+0003fc60: 7320 3d20 7365 6c66 2e67 6574 5f6e 636f  s = self.get_nco
+0003fc70: 7265 7328 776f 726b 6572 733d 776f 726b  res(workers=work
+0003fc80: 6572 7329 0a20 2020 2020 2020 2072 6574  ers).        ret
+0003fc90: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
+0003fca0: 2020 773a 206e 2066 6f72 2077 2c20 6e20    w: n for w, n 
+0003fcb0: 696e 206e 636f 7265 732e 6974 656d 7328  in ncores.items(
+0003fcc0: 2920 6966 2073 656c 662e 776f 726b 6572  ) if self.worker
+0003fcd0: 735b 775d 2e73 7461 7475 7320 3d3d 2053  s[w].status == S
+0003fce0: 7461 7475 732e 7275 6e6e 696e 670a 2020  tatus.running.  
+0003fcf0: 2020 2020 2020 7d0a 0a20 2020 2061 7379        }..    asy
+0003fd00: 6e63 2064 6566 2067 6574 5f63 616c 6c5f  nc def get_call_
+0003fd10: 7374 6163 6b28 7365 6c66 2c20 6b65 7973  stack(self, keys
+0003fd20: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
+0003fd30: 7c20 4e6f 6e65 203d 204e 6f6e 6529 202d  | None = None) -
+0003fd40: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
+0003fd50: 776f 726b 6572 733a 2064 6963 745b 7374  workers: dict[st
+0003fd60: 722c 206c 6973 745b 7374 725d 207c 204e  r, list[str] | N
+0003fd70: 6f6e 655d 0a20 2020 2020 2020 2069 6620  one].        if 
+0003fd80: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
+0003fd90: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0003fda0: 6163 6b20 3d20 6c69 7374 286b 6579 7329  ack = list(keys)
+0003fdb0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+0003fdc0: 6365 7373 696e 6720 3d20 7365 7428 290a  cessing = set().
+0003fdd0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+0003fde0: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
+0003fdf0: 2020 2020 2020 2020 206b 6579 203d 2073           key = s
+0003fe00: 7461 636b 2e70 6f70 2829 0a20 2020 2020  tack.pop().     
+0003fe10: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0003fe20: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+0003fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe40: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
+0003fe50: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
+0003fe60: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0003fe70: 6163 6b2e 6578 7465 6e64 285b 6474 732e  ack.extend([dts.
+0003fe80: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
+0003fe90: 732e 6465 7065 6e64 656e 6369 6573 5d29  s.dependencies])
+0003fea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003feb0: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
+0003fec0: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
+0003fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fee0: 2020 2020 7072 6f63 6573 7369 6e67 2e61      processing.a
+0003fef0: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
+0003ff00: 2020 2020 776f 726b 6572 7320 3d20 6465      workers = de
+0003ff10: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
+0003ff20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003ff30: 7473 2069 6e20 7072 6f63 6573 7369 6e67  ts in processing
+0003ff40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ff50: 2020 6966 2074 732e 7072 6f63 6573 7369    if ts.processi
+0003ff60: 6e67 5f6f 6e3a 0a20 2020 2020 2020 2020  ng_on:.         
+0003ff70: 2020 2020 2020 2020 2020 2077 6b65 7973             wkeys
+0003ff80: 203d 2077 6f72 6b65 7273 5b74 732e 7072   = workers[ts.pr
+0003ff90: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
+0003ffa0: 6573 735d 0a20 2020 2020 2020 2020 2020  ess].           
+0003ffb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0003ffc0: 776b 6579 7320 6973 206e 6f74 204e 6f6e  wkeys is not Non
+0003ffd0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0003ffe0: 2020 2020 2020 776b 6579 732e 6170 7065        wkeys.appe
+0003fff0: 6e64 2874 732e 6b65 7929 0a20 2020 2020  nd(ts.key).     
+00040000: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00040010: 2020 2020 2077 6f72 6b65 7273 203d 207b       workers = {
+00040020: 773a 204e 6f6e 6520 666f 7220 7720 696e  w: None for w in
+00040030: 2073 656c 662e 776f 726b 6572 737d 0a0a   self.workers}..
+00040040: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
+00040050: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+00040060: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
+00040070: 2020 2020 2020 2072 6573 756c 7473 203d         results =
+00040080: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00040090: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+000400a0: 2020 202a 2873 656c 662e 7270 6328 7729     *(self.rpc(w)
+000400b0: 2e63 616c 6c5f 7374 6163 6b28 6b65 7973  .call_stack(keys
+000400c0: 3d76 2920 666f 7220 772c 2076 2069 6e20  =v) for w, v in 
+000400d0: 776f 726b 6572 732e 6974 656d 7328 2929  workers.items())
+000400e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000400f0: 2020 2072 6573 706f 6e73 6520 3d20 7b77     response = {w
+00040100: 3a20 7220 666f 7220 772c 2072 2069 6e20  : r for w, r in 
+00040110: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
+00040120: 756c 7473 2920 6966 2072 7d0a 2020 2020  ults) if r}.    
+00040130: 2020 2020 7265 7475 726e 2072 6573 706f      return respo
+00040140: 6e73 650a 0a20 2020 2061 7379 6e63 2064  nse..    async d
+00040150: 6566 2062 656e 6368 6d61 726b 5f68 6172  ef benchmark_har
+00040160: 6477 6172 6528 7365 6c66 2920 2d3e 2022  dware(self) -> "
+00040170: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
+00040180: 7472 2c20 666c 6f61 745d 5d22 3a0a 2020  tr, float]]":.  
+00040190: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000401a0: 2020 5275 6e20 6120 6265 6e63 686d 6172    Run a benchmar
+000401b0: 6b20 6f6e 2074 6865 2077 6f72 6b65 7273  k on the workers
+000401c0: 2066 6f72 206d 656d 6f72 792c 2064 6973   for memory, dis
+000401d0: 6b2c 2061 6e64 206e 6574 776f 726b 2062  k, and network b
+000401e0: 616e 6477 6964 7468 730a 0a20 2020 2020  andwidths..     
+000401f0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00040200: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00040210: 2020 2072 6573 756c 743a 2064 6963 740a     result: dict.
+00040220: 2020 2020 2020 2020 2020 2020 4120 6469              A di
+00040230: 6374 696f 6e61 7279 206d 6170 7069 6e67  ctionary mapping
+00040240: 2074 6865 206e 616d 6573 2022 6469 736b   the names "disk
+00040250: 222c 2022 6d65 6d6f 7279 222c 2061 6e64  ", "memory", and
+00040260: 2022 6e65 7477 6f72 6b22 2074 6f0a 2020   "network" to.  
+00040270: 2020 2020 2020 2020 2020 6469 6374 696f            dictio
+00040280: 6e61 7269 6573 206d 6170 7069 6e67 2073  naries mapping s
+00040290: 697a 6573 2074 6f20 6261 6e64 7769 6474  izes to bandwidt
+000402a0: 6873 2e20 2054 6865 7365 2062 616e 6477  hs.  These bandw
+000402b0: 6964 7468 7320 6172 650a 2020 2020 2020  idths are.      
+000402c0: 2020 2020 2020 6176 6572 6167 6564 206f        averaged o
+000402d0: 7665 7220 6d61 6e79 2077 6f72 6b65 7273  ver many workers
+000402e0: 2072 756e 6e69 6e67 2063 6f6d 7075 7461   running computa
+000402f0: 7469 6f6e 7320 6163 726f 7373 2074 6865  tions across the
+00040300: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00040310: 2020 2222 220a 2020 2020 2020 2020 6f75    """.        ou
+00040320: 743a 2064 6963 745b 7374 722c 2064 6566  t: dict[str, def
+00040330: 6175 6c74 6469 6374 5b73 7472 2c20 6c69  aultdict[str, li
+00040340: 7374 5b66 6c6f 6174 5d5d 5d20 3d20 7b0a  st[float]]] = {.
+00040350: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00040360: 3a20 6465 6661 756c 7464 6963 7428 6c69  : defaultdict(li
+00040370: 7374 2920 666f 7220 6e61 6d65 2069 6e20  st) for name in 
+00040380: 5b22 6469 736b 222c 2022 6d65 6d6f 7279  ["disk", "memory
+00040390: 222c 2022 6e65 7477 6f72 6b22 5d0a 2020  ", "network"].  
+000403a0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000403b0: 2023 2064 6973 6b0a 2020 2020 2020 2020   # disk.        
+000403c0: 7265 7375 6c74 203d 2061 7761 6974 2073  result = await s
+000403d0: 656c 662e 6272 6f61 6463 6173 7428 6d73  elf.broadcast(ms
+000403e0: 673d 7b22 6f70 223a 2022 6265 6e63 686d  g={"op": "benchm
+000403f0: 6172 6b5f 6469 736b 227d 290a 2020 2020  ark_disk"}).    
+00040400: 2020 2020 666f 7220 6420 696e 2072 6573      for d in res
+00040410: 756c 742e 7661 6c75 6573 2829 3a0a 2020  ult.values():.  
+00040420: 2020 2020 2020 2020 2020 666f 7220 7369            for si
+00040430: 7a65 2c20 6475 7261 7469 6f6e 2069 6e20  ze, duration in 
+00040440: 642e 6974 656d 7328 293a 0a20 2020 2020  d.items():.     
+00040450: 2020 2020 2020 2020 2020 206f 7574 5b22             out["
+00040460: 6469 736b 225d 5b73 697a 655d 2e61 7070  disk"][size].app
+00040470: 656e 6428 6475 7261 7469 6f6e 290a 0a20  end(duration).. 
+00040480: 2020 2020 2020 2023 206d 656d 6f72 790a         # memory.
+00040490: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+000404a0: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
+000404b0: 6463 6173 7428 6d73 673d 7b22 6f70 223a  dcast(msg={"op":
+000404c0: 2022 6265 6e63 686d 6172 6b5f 6d65 6d6f   "benchmark_memo
+000404d0: 7279 227d 290a 2020 2020 2020 2020 666f  ry"}).        fo
+000404e0: 7220 6420 696e 2072 6573 756c 742e 7661  r d in result.va
+000404f0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00040500: 2020 2020 666f 7220 7369 7a65 2c20 6475      for size, du
+00040510: 7261 7469 6f6e 2069 6e20 642e 6974 656d  ration in d.item
+00040520: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00040530: 2020 2020 206f 7574 5b22 6d65 6d6f 7279       out["memory
+00040540: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
+00040550: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
+00040560: 2020 2023 206e 6574 776f 726b 0a20 2020     # network.   
+00040570: 2020 2020 2077 6f72 6b65 7273 203d 206c       workers = l
+00040580: 6973 7428 7365 6c66 2e77 6f72 6b65 7273  ist(self.workers
+00040590: 290a 2020 2020 2020 2020 2320 4f6e 2061  ).        # On a
+000405a0: 6e20 6164 6170 7469 7665 2063 6c75 7374  n adaptive clust
+000405b0: 6572 2c20 6966 206d 756c 7469 706c 6520  er, if multiple 
+000405c0: 776f 726b 6572 7320 6172 6520 7374 6172  workers are star
+000405d0: 7465 6420 6f6e 2074 6865 2073 616d 6520  ted on the same 
+000405e0: 7068 7973 6963 616c 2068 6f73 742c 0a20  physical host,. 
+000405f0: 2020 2020 2020 2023 2074 6865 7920 6172         # they ar
+00040600: 6520 6d6f 7265 206c 696b 656c 7920 746f  e more likely to
+00040610: 2063 6f6e 6e65 6374 2074 6f20 7468 6520   connect to the 
+00040620: 5363 6865 6475 6c65 7220 696e 2073 6571  Scheduler in seq
+00040630: 7565 6e63 652c 2065 6e64 696e 6720 7570  uence, ending up
+00040640: 206e 6578 7420 746f 0a20 2020 2020 2020   next to.       
+00040650: 2023 2065 6163 6820 6f74 6865 7220 696e   # each other in
+00040660: 2074 6869 7320 6c69 7374 2e0a 2020 2020   this list..    
+00040670: 2020 2020 2320 5468 6520 7472 616e 7366      # The transf
+00040680: 6572 2073 7065 6564 2077 6974 6869 6e20  er speed within 
+00040690: 7375 6368 2063 6c75 7374 6572 7320 6f66  such clusters of
+000406a0: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
+000406b0: 2065 6666 6563 7469 7665 6c79 2074 6861   effectively tha
+000406c0: 7420 6f66 0a20 2020 2020 2020 2023 206c  t of.        # l
+000406d0: 6f63 616c 686f 7374 2e20 5468 6973 2063  ocalhost. This c
+000406e0: 6f75 6c64 2068 6170 7065 6e20 6163 726f  ould happen acro
+000406f0: 7373 2064 6966 6665 7265 6e74 2056 4d73  ss different VMs
+00040700: 2061 6e64 2f6f 7220 646f 636b 6572 2069   and/or docker i
+00040710: 6d61 6765 732c 2073 6f0a 2020 2020 2020  mages, so.      
+00040720: 2020 2320 696d 706c 656d 656e 7469 6e67    # implementing
+00040730: 206c 6f67 6963 2062 6173 6564 206f 6e20   logic based on 
+00040740: 4950 2061 6464 7265 7373 6573 2077 6f75  IP addresses wou
+00040750: 6c64 206e 6f74 206e 6563 6573 7361 7269  ld not necessari
+00040760: 6c79 2068 656c 702e 0a20 2020 2020 2020  ly help..       
+00040770: 2023 2052 616e 646f 6d69 7a65 2074 6865   # Randomize the
+00040780: 2063 6f6e 6e65 6374 696f 6e73 2074 6f20   connections to 
+00040790: 6576 656e 206f 7574 2074 6865 206d 6561  even out the mea
+000407a0: 6e20 6d65 6173 7572 6573 2e0a 2020 2020  n measures..    
+000407b0: 2020 2020 7261 6e64 6f6d 2e73 6875 6666      random.shuff
+000407c0: 6c65 2877 6f72 6b65 7273 290a 2020 2020  le(workers).    
+000407d0: 2020 2020 6675 7475 7265 7320 3d20 5b0a      futures = [.
+000407e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000407f0: 2e72 7063 2861 292e 6265 6e63 686d 6172  .rpc(a).benchmar
+00040800: 6b5f 6e65 7477 6f72 6b28 6164 6472 6573  k_network(addres
+00040810: 733d 6229 2066 6f72 2061 2c20 6220 696e  s=b) for a, b in
+00040820: 2070 6172 7469 7469 6f6e 2832 2c20 776f   partition(2, wo
+00040830: 726b 6572 7329 0a20 2020 2020 2020 205d  rkers).        ]
+00040840: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
+00040850: 6573 203d 2061 7761 6974 2061 7379 6e63  es = await async
+00040860: 696f 2e67 6174 6865 7228 2a66 7574 7572  io.gather(*futur
+00040870: 6573 290a 0a20 2020 2020 2020 2066 6f72  es)..        for
+00040880: 2064 2069 6e20 7265 7370 6f6e 7365 733a   d in responses:
+00040890: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000408a0: 2073 697a 652c 2064 7572 6174 696f 6e20   size, duration 
+000408b0: 696e 2064 2e69 7465 6d73 2829 3a0a 2020  in d.items():.  
+000408c0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+000408d0: 745b 226e 6574 776f 726b 225d 5b73 697a  t["network"][siz
+000408e0: 655d 2e61 7070 656e 6428 6475 7261 7469  e].append(durati
+000408f0: 6f6e 290a 0a20 2020 2020 2020 2072 6573  on)..        res
+00040900: 756c 7420 3d20 7b7d 0a20 2020 2020 2020  ult = {}.       
+00040910: 2066 6f72 206d 6f64 6520 696e 206f 7574   for mode in out
+00040920: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00040930: 7375 6c74 5b6d 6f64 655d 203d 207b 0a20  sult[mode] = {. 
+00040940: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00040950: 697a 653a 2073 756d 2864 7572 6174 696f  ize: sum(duratio
+00040960: 6e73 2920 2f20 6c65 6e28 6475 7261 7469  ns) / len(durati
+00040970: 6f6e 7329 0a20 2020 2020 2020 2020 2020  ons).           
+00040980: 2020 2020 2066 6f72 2073 697a 652c 2064       for size, d
+00040990: 7572 6174 696f 6e73 2069 6e20 6f75 745b  urations in out[
+000409a0: 6d6f 6465 5d2e 6974 656d 7328 290a 2020  mode].items().  
+000409b0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+000409c0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+000409d0: 6c74 0a0a 2020 2020 406c 6f67 5f65 7272  lt..    @log_err
+000409e0: 6f72 730a 2020 2020 6465 6620 6765 745f  ors.    def get_
+000409f0: 6e62 7974 6573 280a 2020 2020 2020 2020  nbytes(.        
+00040a00: 7365 6c66 2c20 6b65 7973 3a20 4974 6572  self, keys: Iter
+00040a10: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
+00040a20: 203d 204e 6f6e 652c 2073 756d 6d61 7279   = None, summary
+00040a30: 3a20 626f 6f6c 203d 2054 7275 650a 2020  : bool = True.  
+00040a40: 2020 2920 2d3e 2064 6963 745b 7374 722c    ) -> dict[str,
+00040a50: 2069 6e74 5d3a 0a20 2020 2020 2020 2069   int]:.        i
+00040a60: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
+00040a70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00040a80: 7265 7375 6c74 203d 207b 6b3a 2073 656c  result = {k: sel
+00040a90: 662e 7461 736b 735b 6b5d 2e6e 6279 7465  f.tasks[k].nbyte
+00040aa0: 7320 666f 7220 6b20 696e 206b 6579 737d  s for k in keys}
+00040ab0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00040ac0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00040ad0: 7420 3d20 7b6b 3a20 7473 2e6e 6279 7465  t = {k: ts.nbyte
+00040ae0: 7320 666f 7220 6b2c 2074 7320 696e 2073  s for k, ts in s
+00040af0: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
+00040b00: 2920 6966 2074 732e 6e62 7974 6573 203e  ) if ts.nbytes >
+00040b10: 3d20 307d 0a0a 2020 2020 2020 2020 6966  = 0}..        if
+00040b20: 2073 756d 6d61 7279 3a0a 2020 2020 2020   summary:.      
+00040b30: 2020 2020 2020 6f75 743a 2064 6566 6175        out: defau
+00040b40: 6c74 6469 6374 5b73 7472 2c20 696e 745d  ltdict[str, int]
+00040b50: 203d 2064 6566 6175 6c74 6469 6374 286c   = defaultdict(l
+00040b60: 616d 6264 613a 2030 290a 2020 2020 2020  ambda: 0).      
+00040b70: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
+00040b80: 6e20 7265 7375 6c74 2e69 7465 6d73 2829  n result.items()
+00040b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040ba0: 2020 6f75 745b 6b65 795f 7370 6c69 7428    out[key_split(
+00040bb0: 6b29 5d20 2b3d 2076 0a20 2020 2020 2020  k)] += v.       
+00040bc0: 2020 2020 2072 6573 756c 7420 3d20 6469       result = di
+00040bd0: 6374 286f 7574 290a 0a20 2020 2020 2020  ct(out)..       
+00040be0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00040bf0: 2020 2020 6465 6620 7275 6e5f 6675 6e63      def run_func
+00040c00: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
+00040c10: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
+00040c20: 3a20 436f 6d6d 2c0a 2020 2020 2020 2020  : Comm,.        
+00040c30: 6675 6e63 7469 6f6e 3a20 4361 6c6c 6162  function: Callab
+00040c40: 6c65 2c0a 2020 2020 2020 2020 6172 6773  le,.        args
+00040c50: 3a20 7475 706c 6520 3d20 2829 2c0a 2020  : tuple = (),.  
+00040c60: 2020 2020 2020 6b77 6172 6773 3a20 6469        kwargs: di
+00040c70: 6374 207c 204e 6f6e 6520 3d20 4e6f 6e65  ct | None = None
+00040c80: 2c0a 2020 2020 2020 2020 7761 6974 3a20  ,.        wait: 
+00040c90: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+00040ca0: 2029 202d 3e20 416e 793a 0a20 2020 2020   ) -> Any:.     
+00040cb0: 2020 2022 2222 5275 6e20 6120 6675 6e63     """Run a func
+00040cc0: 7469 6f6e 2077 6974 6869 6e20 7468 6973  tion within this
+00040cd0: 2070 726f 6365 7373 0a0a 2020 2020 2020   process..      
+00040ce0: 2020 5365 6520 416c 736f 0a20 2020 2020    See Also.     
+00040cf0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00040d00: 2020 2020 436c 6965 6e74 2e72 756e 5f6f      Client.run_o
+00040d10: 6e5f 7363 6865 6475 6c65 720a 2020 2020  n_scheduler.    
+00040d20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00040d30: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00040d40: 2e77 6f72 6b65 7220 696d 706f 7274 2072  .worker import r
+00040d50: 756e 0a0a 2020 2020 2020 2020 6966 206e  un..        if n
+00040d60: 6f74 2064 6173 6b2e 636f 6e66 6967 2e67  ot dask.config.g
+00040d70: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+00040d80: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
+00040d90: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00040da0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00040db0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00040dc0: 2020 2243 616e 6e6f 7420 7275 6e20 6675    "Cannot run fu
+00040dd0: 6e63 7469 6f6e 2061 7320 7468 6520 7363  nction as the sc
+00040de0: 6865 6475 6c65 7220 6861 7320 6265 656e  heduler has been
+00040df0: 2065 7870 6c69 6369 746c 7920 6469 7361   explicitly disa
+00040e00: 6c6c 6f77 6564 2066 726f 6d20 220a 2020  llowed from ".  
+00040e10: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+00040e20: 6573 6572 6961 6c69 7a69 6e67 2061 7262  eserializing arb
+00040e30: 6974 7261 7279 2062 7974 6573 7472 696e  itrary bytestrin
+00040e40: 6773 2075 7369 6e67 2070 6963 6b6c 6520  gs using pickle 
+00040e50: 7669 6120 7468 6520 220a 2020 2020 2020  via the ".      
+00040e60: 2020 2020 2020 2020 2020 2227 6469 7374            "'dist
+00040e70: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+00040e80: 722e 7069 636b 6c65 2720 636f 6e66 6967  r.pickle' config
+00040e90: 7572 6174 696f 6e20 7365 7474 696e 672e  uration setting.
+00040ea0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00040eb0: 2020 2020 2020 2020 6b77 6172 6773 203d          kwargs =
+00040ec0: 206b 7761 7267 7320 6f72 207b 7d0a 2020   kwargs or {}.  
+00040ed0: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00040ee0: 7665 6e74 2822 616c 6c22 2c20 7b22 6163  vent("all", {"ac
+00040ef0: 7469 6f6e 223a 2022 7275 6e2d 6675 6e63  tion": "run-func
+00040f00: 7469 6f6e 222c 2022 6675 6e63 7469 6f6e  tion", "function
+00040f10: 223a 2066 756e 6374 696f 6e7d 290a 2020  ": function}).  
+00040f20: 2020 2020 2020 7265 7475 726e 2072 756e        return run
+00040f30: 2873 656c 662c 2063 6f6d 6d2c 2066 756e  (self, comm, fun
+00040f40: 6374 696f 6e3d 6675 6e63 7469 6f6e 2c20  ction=function, 
+00040f50: 6172 6773 3d61 7267 732c 206b 7761 7267  args=args, kwarg
+00040f60: 733d 6b77 6172 6773 2c20 7761 6974 3d77  s=kwargs, wait=w
+00040f70: 6169 7429 0a0a 2020 2020 6465 6620 7365  ait)..    def se
+00040f80: 745f 6d65 7461 6461 7461 2873 656c 662c  t_metadata(self,
+00040f90: 206b 6579 733a 206c 6973 745b 7374 725d   keys: list[str]
+00040fa0: 2c20 7661 6c75 653a 206f 626a 6563 7420  , value: object 
+00040fb0: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
+00040fc0: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
+00040fd0: 6120 3d20 7365 6c66 2e74 6173 6b5f 6d65  a = self.task_me
+00040fe0: 7461 6461 7461 0a20 2020 2020 2020 2066  tadata.        f
+00040ff0: 6f72 206b 6579 2069 6e20 6b65 7973 5b3a  or key in keys[:
+00041000: 2d31 5d3a 0a20 2020 2020 2020 2020 2020  -1]:.           
+00041010: 2069 6620 6b65 7920 6e6f 7420 696e 206d   if key not in m
+00041020: 6574 6164 6174 6120 6f72 206e 6f74 2069  etadata or not i
+00041030: 7369 6e73 7461 6e63 6528 6d65 7461 6461  sinstance(metada
+00041040: 7461 5b6b 6579 5d2c 2028 6469 6374 2c20  ta[key], (dict, 
+00041050: 6c69 7374 2929 3a0a 2020 2020 2020 2020  list)):.        
+00041060: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+00041070: 5b6b 6579 5d20 3d20 7b7d 0a20 2020 2020  [key] = {}.     
+00041080: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+00041090: 3d20 6d65 7461 6461 7461 5b6b 6579 5d0a  = metadata[key].
+000410a0: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+000410b0: 5b6b 6579 735b 2d31 5d5d 203d 2076 616c  [keys[-1]] = val
+000410c0: 7565 0a0a 2020 2020 6465 6620 6765 745f  ue..    def get_
+000410d0: 6d65 7461 6461 7461 2873 656c 662c 206b  metadata(self, k
+000410e0: 6579 733a 206c 6973 745b 7374 725d 2c20  eys: list[str], 
+000410f0: 6465 6661 756c 743a 2041 6e79 203d 206e  default: Any = n
+00041100: 6f5f 6465 6661 756c 7429 202d 3e20 416e  o_default) -> An
+00041110: 793a 0a20 2020 2020 2020 206d 6574 6164  y:.        metad
+00041120: 6174 6120 3d20 7365 6c66 2e74 6173 6b5f  ata = self.task_
+00041130: 6d65 7461 6461 7461 0a20 2020 2020 2020  metadata.       
+00041140: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00041150: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+00041160: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00041170: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
+00041180: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
+00041190: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+000411a0: 6574 6164 6174 610a 2020 2020 2020 2020  etadata.        
+000411b0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+000411c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000411d0: 6465 6661 756c 7420 213d 206e 6f5f 6465  default != no_de
+000411e0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+000411f0: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
+00041200: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
+00041210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00041220: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
+00041230: 2020 2064 6566 2073 6574 5f72 6573 7472     def set_restr
+00041240: 6963 7469 6f6e 7328 7365 6c66 2c20 776f  ictions(self, wo
+00041250: 726b 6572 3a20 6469 6374 5b73 7472 2c20  rker: dict[str, 
+00041260: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
+00041270: 7c20 7374 725d 2920 2d3e 204e 6f6e 653a  | str]) -> None:
+00041280: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00041290: 2c20 7265 7374 7269 6374 696f 6e73 2069  , restrictions i
+000412a0: 6e20 776f 726b 6572 2e69 7465 6d73 2829  n worker.items()
+000412b0: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+000412c0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+000412d0: 795d 0a20 2020 2020 2020 2020 2020 2069  y].            i
+000412e0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+000412f0: 7472 6963 7469 6f6e 732c 2073 7472 293a  trictions, str):
+00041300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041310: 2072 6573 7472 6963 7469 6f6e 7320 3d20   restrictions = 
+00041320: 7b72 6573 7472 6963 7469 6f6e 737d 0a20  {restrictions}. 
+00041330: 2020 2020 2020 2020 2020 2074 732e 776f             ts.wo
+00041340: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
+00041350: 7320 3d20 7365 7428 7265 7374 7269 6374  s = set(restrict
+00041360: 696f 6e73 290a 0a20 2020 2040 6c6f 675f  ions)..    @log_
+00041370: 6572 726f 7273 0a20 2020 2064 6566 2067  errors.    def g
+00041380: 6574 5f74 6173 6b5f 7072 6566 6978 5f73  et_task_prefix_s
+00041390: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
+000413a0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
+000413b0: 722c 2069 6e74 5d5d 3a0a 2020 2020 2020  r, int]]:.      
+000413c0: 2020 7374 6174 6520 3d20 7b7d 0a0a 2020    state = {}..  
+000413d0: 2020 2020 2020 666f 7220 7470 2069 6e20        for tp in 
+000413e0: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+000413f0: 6573 2e76 616c 7565 7328 293a 0a20 2020  es.values():.   
+00041400: 2020 2020 2020 2020 2061 6374 6976 655f           active_
+00041410: 7374 6174 6573 203d 2074 702e 6163 7469  states = tp.acti
+00041420: 7665 5f73 7461 7465 730a 2020 2020 2020  ve_states.      
+00041430: 2020 2020 2020 6966 2061 6e79 280a 2020        if any(.  
+00041440: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+00041450: 7469 7665 5f73 7461 7465 732e 6765 7428  tive_states.get(
+00041460: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00041470: 2020 2066 6f72 2073 2069 6e20 7b22 6d65     for s in {"me
+00041480: 6d6f 7279 222c 2022 6572 7265 6422 2c20  mory", "erred", 
+00041490: 2272 656c 6561 7365 6422 2c20 2270 726f  "released", "pro
+000414a0: 6365 7373 696e 6722 2c20 2277 6169 7469  cessing", "waiti
+000414b0: 6e67 227d 0a20 2020 2020 2020 2020 2020  ng"}.           
+000414c0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000414d0: 2020 2020 7374 6174 655b 7470 2e6e 616d      state[tp.nam
+000414e0: 655d 203d 207b 0a20 2020 2020 2020 2020  e] = {.         
+000414f0: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00041500: 7279 223a 2061 6374 6976 655f 7374 6174  ry": active_stat
+00041510: 6573 5b22 6d65 6d6f 7279 225d 2c0a 2020  es["memory"],.  
+00041520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041530: 2020 2265 7272 6564 223a 2061 6374 6976    "erred": activ
+00041540: 655f 7374 6174 6573 5b22 6572 7265 6422  e_states["erred"
+00041550: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00041560: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
+00041570: 223a 2061 6374 6976 655f 7374 6174 6573  ": active_states
+00041580: 5b22 7265 6c65 6173 6564 225d 2c0a 2020  ["released"],.  
+00041590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000415a0: 2020 2270 726f 6365 7373 696e 6722 3a20    "processing": 
+000415b0: 6163 7469 7665 5f73 7461 7465 735b 2270  active_states["p
+000415c0: 726f 6365 7373 696e 6722 5d2c 0a20 2020  rocessing"],.   
+000415d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000415e0: 2022 7761 6974 696e 6722 3a20 6163 7469   "waiting": acti
+000415f0: 7665 5f73 7461 7465 735b 2277 6169 7469  ve_states["waiti
+00041600: 6e67 225d 2c0a 2020 2020 2020 2020 2020  ng"],.          
+00041610: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00041620: 2072 6574 7572 6e20 7374 6174 650a 0a20   return state.. 
+00041630: 2020 2064 6566 2067 6574 5f74 6173 6b5f     def get_task_
+00041640: 7374 6174 7573 2873 656c 662c 206b 6579  status(self, key
+00041650: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+00041660: 2920 2d3e 2064 6963 745b 7374 722c 2054  ) -> dict[str, T
+00041670: 6173 6b53 7461 7465 5374 6174 6520 7c20  askStateState | 
+00041680: 4e6f 6e65 5d3a 0a20 2020 2020 2020 2072  None]:.        r
+00041690: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+000416a0: 2020 2020 6b65 793a 2028 7365 6c66 2e74      key: (self.t
+000416b0: 6173 6b73 5b6b 6579 5d2e 7374 6174 6520  asks[key].state 
+000416c0: 6966 206b 6579 2069 6e20 7365 6c66 2e74  if key in self.t
+000416d0: 6173 6b73 2065 6c73 6520 4e6f 6e65 2920  asks else None) 
+000416e0: 666f 7220 6b65 7920 696e 206b 6579 730a  for key in keys.
+000416f0: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
+00041700: 6566 2067 6574 5f74 6173 6b5f 7374 7265  ef get_task_stre
+00041710: 616d 280a 2020 2020 2020 2020 7365 6c66  am(.        self
+00041720: 2c0a 2020 2020 2020 2020 7374 6172 743a  ,.        start:
+00041730: 2073 7472 207c 2066 6c6f 6174 207c 204e   str | float | N
+00041740: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00041750: 2020 2020 7374 6f70 3a20 7374 7220 7c20      stop: str | 
+00041760: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
+00041770: 6f6e 652c 0a20 2020 2020 2020 2063 6f75  one,.        cou
+00041780: 6e74 3a20 696e 7420 7c20 4e6f 6e65 203d  nt: int | None =
+00041790: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+000417a0: 6c69 7374 3a0a 2020 2020 2020 2020 6672  list:.        fr
+000417b0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+000417c0: 6961 676e 6f73 7469 6373 2e74 6173 6b5f  iagnostics.task_
+000417d0: 7374 7265 616d 2069 6d70 6f72 7420 5461  stream import Ta
+000417e0: 736b 5374 7265 616d 506c 7567 696e 0a0a  skStreamPlugin..
+000417f0: 2020 2020 2020 2020 6966 2054 6173 6b53          if TaskS
+00041800: 7472 6561 6d50 6c75 6769 6e2e 6e61 6d65  treamPlugin.name
+00041810: 206e 6f74 2069 6e20 7365 6c66 2e70 6c75   not in self.plu
+00041820: 6769 6e73 3a0a 2020 2020 2020 2020 2020  gins:.          
+00041830: 2020 7365 6c66 2e61 6464 5f70 6c75 6769    self.add_plugi
+00041840: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
+00041850: 696e 2873 656c 6629 290a 0a20 2020 2020  in(self))..     
+00041860: 2020 2070 6c75 6769 6e20 3d20 6361 7374     plugin = cast
+00041870: 2854 6173 6b53 7472 6561 6d50 6c75 6769  (TaskStreamPlugi
+00041880: 6e2c 2073 656c 662e 706c 7567 696e 735b  n, self.plugins[
+00041890: 5461 736b 5374 7265 616d 506c 7567 696e  TaskStreamPlugin
+000418a0: 2e6e 616d 655d 290a 0a20 2020 2020 2020  .name])..       
+000418b0: 2072 6574 7572 6e20 706c 7567 696e 2e63   return plugin.c
+000418c0: 6f6c 6c65 6374 2873 7461 7274 3d73 7461  ollect(start=sta
+000418d0: 7274 2c20 7374 6f70 3d73 746f 702c 2063  rt, stop=stop, c
+000418e0: 6f75 6e74 3d63 6f75 6e74 290a 0a20 2020  ount=count)..   
+000418f0: 2064 6566 2073 7461 7274 5f74 6173 6b5f   def start_task_
+00041900: 6d65 7461 6461 7461 2873 656c 662c 206e  metadata(self, n
+00041910: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
+00041920: 653a 0a20 2020 2020 2020 2070 6c75 6769  e:.        plugi
+00041930: 6e20 3d20 436f 6c6c 6563 7454 6173 6b4d  n = CollectTaskM
+00041940: 6574 6144 6174 6150 6c75 6769 6e28 7363  etaDataPlugin(sc
+00041950: 6865 6475 6c65 723d 7365 6c66 2c20 6e61  heduler=self, na
+00041960: 6d65 3d6e 616d 6529 0a20 2020 2020 2020  me=name).       
+00041970: 2073 656c 662e 6164 645f 706c 7567 696e   self.add_plugin
+00041980: 2870 6c75 6769 6e29 0a0a 2020 2020 6465  (plugin)..    de
+00041990: 6620 7374 6f70 5f74 6173 6b5f 6d65 7461  f stop_task_meta
+000419a0: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
+000419b0: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+000419c0: 6e65 2920 2d3e 2064 6963 743a 0a20 2020  ne) -> dict:.   
+000419d0: 2020 2020 2070 6c75 6769 6e73 203d 205b       plugins = [
+000419e0: 0a20 2020 2020 2020 2020 2020 2070 0a20  .            p. 
+000419f0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
+00041a00: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
+00041a10: 7567 696e 732e 7661 6c75 6573 2829 290a  ugins.values()).
+00041a20: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00041a30: 7369 6e73 7461 6e63 6528 702c 2043 6f6c  sinstance(p, Col
+00041a40: 6c65 6374 5461 736b 4d65 7461 4461 7461  lectTaskMetaData
+00041a50: 506c 7567 696e 2920 616e 6420 702e 6e61  Plugin) and p.na
+00041a60: 6d65 203d 3d20 6e61 6d65 0a20 2020 2020  me == name.     
+00041a70: 2020 205d 0a20 2020 2020 2020 2069 6620     ].        if 
+00041a80: 6c65 6e28 706c 7567 696e 7329 2021 3d20  len(plugins) != 
+00041a90: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
+00041aa0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00041ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041ac0: 2022 4578 7065 6374 6564 2074 6f20 6669   "Expected to fi
+00041ad0: 6e64 2065 7861 6374 6c79 206f 6e65 2043  nd exactly one C
+00041ae0: 6f6c 6c65 6374 5461 736b 4d65 7461 4461  ollectTaskMetaDa
+00041af0: 7461 506c 7567 696e 2022 0a20 2020 2020  taPlugin ".     
+00041b00: 2020 2020 2020 2020 2020 2066 2277 6974             f"wit
+00041b10: 6820 6e61 6d65 207b 6e61 6d65 7d20 6275  h name {name} bu
+00041b20: 7420 666f 756e 6420 7b6c 656e 2870 6c75  t found {len(plu
+00041b30: 6769 6e73 297d 2e22 0a20 2020 2020 2020  gins)}.".       
+00041b40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00041b50: 706c 7567 696e 203d 2070 6c75 6769 6e73  plugin = plugins
+00041b60: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
+00041b70: 2e72 656d 6f76 655f 706c 7567 696e 286e  .remove_plugin(n
+00041b80: 616d 653d 706c 7567 696e 2e6e 616d 6529  ame=plugin.name)
+00041b90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00041ba0: 7b22 6d65 7461 6461 7461 223a 2070 6c75  {"metadata": plu
+00041bb0: 6769 6e2e 6d65 7461 6461 7461 2c20 2273  gin.metadata, "s
+00041bc0: 7461 7465 223a 2070 6c75 6769 6e2e 7374  tate": plugin.st
+00041bd0: 6174 657d 0a0a 2020 2020 6173 796e 6320  ate}..    async 
+00041be0: 6465 6620 7265 6769 7374 6572 5f77 6f72  def register_wor
+00041bf0: 6b65 725f 706c 7567 696e 2873 656c 662c  ker_plugin(self,
+00041c00: 2063 6f6d 6d2c 2070 6c75 6769 6e2c 206e   comm, plugin, n
+00041c10: 616d 653d 4e6f 6e65 293a 0a20 2020 2020  ame=None):.     
+00041c20: 2020 2022 2222 5265 6769 7374 6572 7320     """Registers 
+00041c30: 6120 776f 726b 6572 2070 6c75 6769 6e20  a worker plugin 
+00041c40: 6f6e 2061 6c6c 2072 756e 6e69 6e67 2061  on all running a
+00041c50: 6e64 2066 7574 7572 6520 776f 726b 6572  nd future worker
+00041c60: 7322 2222 0a20 2020 2020 2020 2073 656c  s""".        sel
+00041c70: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
+00041c80: 5b6e 616d 655d 203d 2070 6c75 6769 6e0a  [name] = plugin.
+00041c90: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
+00041ca0: 6573 203d 2061 7761 6974 2073 656c 662e  es = await self.
+00041cb0: 6272 6f61 6463 6173 7428 0a20 2020 2020  broadcast(.     
+00041cc0: 2020 2020 2020 206d 7367 3d64 6963 7428         msg=dict(
+00041cd0: 6f70 3d22 706c 7567 696e 2d61 6464 222c  op="plugin-add",
+00041ce0: 2070 6c75 6769 6e3d 706c 7567 696e 2c20   plugin=plugin, 
+00041cf0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+00041d00: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+00041d10: 7572 6e20 7265 7370 6f6e 7365 730a 0a20  urn responses.. 
+00041d20: 2020 2061 7379 6e63 2064 6566 2075 6e72     async def unr
+00041d30: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
+00041d40: 6c75 6769 6e28 7365 6c66 2c20 636f 6d6d  lugin(self, comm
+00041d50: 2c20 6e61 6d65 293a 0a20 2020 2020 2020  , name):.       
+00041d60: 2022 2222 556e 7265 6769 7374 6572 7320   """Unregisters 
+00041d70: 6120 776f 726b 6572 2070 6c75 6769 6e22  a worker plugin"
+00041d80: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+00041d90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00041da0: 2e77 6f72 6b65 725f 706c 7567 696e 732e  .worker_plugins.
+00041db0: 706f 7028 6e61 6d65 290a 2020 2020 2020  pop(name).      
+00041dc0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00041dd0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00041de0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00041df0: 6622 5468 6520 776f 726b 6572 2070 6c75  f"The worker plu
+00041e00: 6769 6e20 7b6e 616d 657d 2064 6f65 7320  gin {name} does 
+00041e10: 6e6f 7420 6578 6973 7422 290a 0a20 2020  not exist")..   
+00041e20: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
+00041e30: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
+00041e40: 6463 6173 7428 6d73 673d 6469 6374 286f  dcast(msg=dict(o
+00041e50: 703d 2270 6c75 6769 6e2d 7265 6d6f 7665  p="plugin-remove
+00041e60: 222c 206e 616d 653d 6e61 6d65 2929 0a20  ", name=name)). 
+00041e70: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00041e80: 7370 6f6e 7365 730a 0a20 2020 2061 7379  sponses..    asy
+00041e90: 6e63 2064 6566 2072 6567 6973 7465 725f  nc def register_
+00041ea0: 6e61 6e6e 795f 706c 7567 696e 2873 656c  nanny_plugin(sel
+00041eb0: 662c 2063 6f6d 6d2c 2070 6c75 6769 6e2c  f, comm, plugin,
+00041ec0: 206e 616d 653d 4e6f 6e65 293a 0a20 2020   name=None):.   
+00041ed0: 2020 2020 2022 2222 5265 6769 7374 6572       """Register
+00041ee0: 7320 6120 7365 7475 7020 6675 6e63 7469  s a setup functi
+00041ef0: 6f6e 2c20 616e 6420 6361 6c6c 2069 7420  on, and call it 
+00041f00: 6f6e 2065 7665 7279 2077 6f72 6b65 7222  on every worker"
+00041f10: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
+00041f20: 6e61 6e6e 795f 706c 7567 696e 735b 6e61  nanny_plugins[na
+00041f30: 6d65 5d20 3d20 706c 7567 696e 0a0a 2020  me] = plugin..  
+00041f40: 2020 2020 2020 7265 7370 6f6e 7365 7320        responses 
+00041f50: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
+00041f60: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
+00041f70: 2020 2020 6d73 673d 6469 6374 286f 703d      msg=dict(op=
+00041f80: 2270 6c75 6769 6e5f 6164 6422 2c20 706c  "plugin_add", pl
+00041f90: 7567 696e 3d70 6c75 6769 6e2c 206e 616d  ugin=plugin, nam
+00041fa0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00041fb0: 2020 2020 206e 616e 6e79 3d54 7275 652c       nanny=True,
+00041fc0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00041fd0: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
+00041fe0: 7365 730a 0a20 2020 2061 7379 6e63 2064  ses..    async d
+00041ff0: 6566 2075 6e72 6567 6973 7465 725f 6e61  ef unregister_na
+00042000: 6e6e 795f 706c 7567 696e 2873 656c 662c  nny_plugin(self,
+00042010: 2063 6f6d 6d2c 206e 616d 6529 3a0a 2020   comm, name):.  
+00042020: 2020 2020 2020 2222 2255 6e72 6567 6973        """Unregis
+00042030: 7465 7273 2061 2077 6f72 6b65 7220 706c  ters a worker pl
+00042040: 7567 696e 2222 220a 2020 2020 2020 2020  ugin""".        
+00042050: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00042060: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
+00042070: 696e 732e 706f 7028 6e61 6d65 290a 2020  ins.pop(name).  
+00042080: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+00042090: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000420a0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000420b0: 726f 7228 6622 5468 6520 6e61 6e6e 7920  ror(f"The nanny 
+000420c0: 706c 7567 696e 207b 6e61 6d65 7d20 646f  plugin {name} do
+000420d0: 6573 206e 6f74 2065 7869 7374 2229 0a0a  es not exist")..
+000420e0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+000420f0: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
+00042100: 726f 6164 6361 7374 280a 2020 2020 2020  roadcast(.      
+00042110: 2020 2020 2020 6d73 673d 6469 6374 286f        msg=dict(o
+00042120: 703d 2270 6c75 6769 6e5f 7265 6d6f 7665  p="plugin_remove
+00042130: 222c 206e 616d 653d 6e61 6d65 292c 206e  ", name=name), n
+00042140: 616e 6e79 3d54 7275 650a 2020 2020 2020  anny=True.      
+00042150: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
+00042160: 726e 2072 6573 706f 6e73 6573 0a0a 2020  rn responses..  
+00042170: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00042180: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00042190: 2020 2020 2020 2020 6b65 793a 2073 7472          key: str
+000421a0: 2c0a 2020 2020 2020 2020 6669 6e69 7368  ,.        finish
+000421b0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+000421c0: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+000421d0: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
+000421e0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+000421f0: 792c 0a20 2020 2029 202d 3e20 5265 6373  y,.    ) -> Recs
+00042200: 3a0a 2020 2020 2020 2020 2222 2254 7261  :.        """Tra
+00042210: 6e73 6974 696f 6e20 6120 6b65 7920 6672  nsition a key fr
+00042220: 6f6d 2069 7473 2063 7572 7265 6e74 2073  om its current s
+00042230: 7461 7465 2074 6f20 7468 6520 6669 6e69  tate to the fini
+00042240: 7368 2073 7461 7465 0a0a 2020 2020 2020  sh state..      
+00042250: 2020 4578 616d 706c 6573 0a20 2020 2020    Examples.     
+00042260: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00042270: 2020 2020 3e3e 3e20 7365 6c66 2e74 7261      >>> self.tra
+00042280: 6e73 6974 696f 6e28 2778 272c 2027 7761  nsition('x', 'wa
+00042290: 6974 696e 6727 290a 2020 2020 2020 2020  iting').        
+000422a0: 7b27 7827 3a20 2770 726f 6365 7373 696e  {'x': 'processin
+000422b0: 6727 7d0a 0a20 2020 2020 2020 2052 6574  g'}..        Ret
+000422c0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+000422d0: 2d2d 2d2d 0a20 2020 2020 2020 2044 6963  ----.        Dic
+000422e0: 7469 6f6e 6172 7920 6f66 2072 6563 6f6d  tionary of recom
+000422f0: 6d65 6e64 6174 696f 6e73 2066 6f72 2066  mendations for f
+00042300: 7574 7572 6520 7472 616e 7369 7469 6f6e  uture transition
+00042310: 730a 0a20 2020 2020 2020 2053 6565 2041  s..        See A
+00042320: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+00042330: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
+00042340: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+00042350: 6e73 3a20 7472 616e 7369 7469 7665 2076  ns: transitive v
+00042360: 6572 7369 6f6e 206f 6620 7468 6973 2066  ersion of this f
+00042370: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
+00042380: 2222 220a 2020 2020 2020 2020 7265 636f  """.        reco
+00042390: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+000423a0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+000423b0: 5f6d 7367 7320 3d20 7365 6c66 2e5f 7472  _msgs = self._tr
+000423c0: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+000423d0: 2020 2020 2020 6b65 792c 2066 696e 6973        key, finis
+000423e0: 682c 2073 7469 6d75 6c75 735f 6964 2c20  h, stimulus_id, 
+000423f0: 2a2a 6b77 6172 6773 0a20 2020 2020 2020  **kwargs.       
+00042400: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00042410: 7365 6e64 5f61 6c6c 2863 6c69 656e 745f  send_all(client_
+00042420: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00042430: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+00042440: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00042450: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
+00042460: 6974 696f 6e73 2873 656c 662c 2072 6563  itions(self, rec
+00042470: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+00042480: 6373 2c20 7374 696d 756c 7573 5f69 643a  cs, stimulus_id:
+00042490: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+000424a0: 2020 2020 2020 2022 2222 5072 6f63 6573         """Proces
+000424b0: 7320 7472 616e 7369 7469 6f6e 7320 756e  s transitions un
+000424c0: 7469 6c20 6e6f 6e65 2061 7265 206c 6566  til none are lef
+000424d0: 740a 0a20 2020 2020 2020 2054 6869 7320  t..        This 
+000424e0: 696e 636c 7564 6573 2066 6565 6462 6163  includes feedbac
+000424f0: 6b20 6672 6f6d 2070 7265 7669 6f75 7320  k from previous 
+00042500: 7472 616e 7369 7469 6f6e 7320 616e 6420  transitions and 
+00042510: 636f 6e74 696e 7565 7320 756e 7469 6c20  continues until 
+00042520: 7765 0a20 2020 2020 2020 2072 6561 6368  we.        reach
+00042530: 2061 2073 7465 6164 7920 7374 6174 650a   a steady state.
+00042540: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00042550: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
+00042560: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
+00042570: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
+00042580: 4d73 6773 203d 207b 7d0a 2020 2020 2020  Msgs = {}.      
+00042590: 2020 7365 6c66 2e5f 7472 616e 7369 7469    self._transiti
+000425a0: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
+000425b0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+000425c0: 2c20 776f 726b 6572 5f6d 7367 732c 2073  , worker_msgs, s
+000425d0: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
+000425e0: 2020 2020 7365 6c66 2e73 656e 645f 616c      self.send_al
+000425f0: 6c28 636c 6965 6e74 5f6d 7367 732c 2077  l(client_msgs, w
+00042600: 6f72 6b65 725f 6d73 6773 290a 0a20 2020  orker_msgs)..   
+00042610: 2061 7379 6e63 2064 6566 2067 6574 5f73   async def get_s
+00042620: 746f 7279 2873 656c 662c 206b 6579 735f  tory(self, keys_
+00042630: 6f72 5f73 7469 6d75 6c69 3a20 4974 6572  or_stimuli: Iter
+00042640: 6162 6c65 5b73 7472 5d29 202d 3e20 6c69  able[str]) -> li
+00042650: 7374 5b54 7261 6e73 6974 696f 6e5d 3a0a  st[Transition]:.
+00042660: 2020 2020 2020 2020 2222 2252 5043 2068          """RPC h
+00042670: 6f6f 6b20 666f 7220 3a6d 6574 683a 6053  ook for :meth:`S
+00042680: 6368 6564 756c 6572 5374 6174 652e 7374  chedulerState.st
+00042690: 6f72 7960 2e0a 0a20 2020 2020 2020 204e  ory`...        N
+000426a0: 6f74 6520 7468 6174 2074 6865 206d 7367  ote that the msg
+000426b0: 7061 636b 2073 6572 6961 6c69 7a61 7469  pack serializati
+000426c0: 6f6e 2f64 6573 6572 6961 6c69 7a61 7469  on/deserializati
+000426d0: 6f6e 2072 6f75 6e64 2d74 7269 7020 7769  on round-trip wi
+000426e0: 6c6c 2074 7261 6e73 666f 726d 0a20 2020  ll transform.   
+000426f0: 2020 2020 2074 6865 203a 636c 6173 733a       the :class:
+00042700: 6054 7261 6e73 6974 696f 6e60 206e 616d  `Transition` nam
+00042710: 6564 7475 706c 6573 2069 6e74 6f20 7265  edtuples into re
+00042720: 6775 6c61 7220 7475 706c 6573 2e0a 2020  gular tuples..  
+00042730: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00042740: 2020 7265 7475 726e 2073 656c 662e 7374    return self.st
+00042750: 6f72 7928 2a6b 6579 735f 6f72 5f73 7469  ory(*keys_or_sti
+00042760: 6d75 6c69 290a 0a20 2020 2064 6566 205f  muli)..    def _
+00042770: 7265 7363 6865 6475 6c65 280a 2020 2020  reschedule(.    
+00042780: 2020 2020 7365 6c66 2c20 6b65 793a 2073      self, key: s
+00042790: 7472 2c20 776f 726b 6572 3a20 7374 7220  tr, worker: str 
+000427a0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 202a  | None = None, *
+000427b0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+000427c0: 7472 0a20 2020 2029 202d 3e20 4e6f 6e65  tr.    ) -> None
+000427d0: 3a0a 2020 2020 2020 2020 2222 2252 6573  :.        """Res
+000427e0: 6368 6564 756c 6520 6120 7461 736b 2e0a  chedule a task..
+000427f0: 0a20 2020 2020 2020 2054 6869 7320 6675  .        This fu
+00042800: 6e63 7469 6f6e 2073 686f 756c 6420 6f6e  nction should on
+00042810: 6c79 2062 6520 7573 6564 2077 6865 6e20  ly be used when 
+00042820: 7468 6520 7461 736b 2068 6173 2061 6c72  the task has alr
+00042830: 6561 6479 2062 6565 6e20 7265 6c65 6173  eady been releas
+00042840: 6564 2069 6e0a 2020 2020 2020 2020 736f  ed in.        so
+00042850: 6d65 2077 6179 206f 6e20 7468 6520 776f  me way on the wo
+00042860: 726b 6572 2069 7427 7320 6173 7369 676e  rker it's assign
+00042870: 6564 2074 6f20 e280 9420 6569 7468 6572  ed to ... either
+00042880: 2076 6961 2063 616e 6365 6c6c 6174 696f   via cancellatio
+00042890: 6e20 6f72 2061 0a20 2020 2020 2020 2052  n or a.        R
+000428a0: 6573 6368 6564 756c 6520 6578 6365 7074  eschedule except
+000428b0: 696f 6e20 e280 9420 616e 6420 796f 7520  ion ... and you 
+000428c0: 6172 6520 6365 7274 6169 6e20 7468 6520  are certain the 
+000428d0: 776f 726b 6572 2077 696c 6c20 6e6f 7420  worker will not 
+000428e0: 7365 6e64 2061 6e79 2066 7572 7468 6572  send any further
+000428f0: 0a20 2020 2020 2020 2075 7064 6174 6573  .        updates
+00042900: 2061 626f 7574 2074 6865 2074 6173 6b20   about the task 
+00042910: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
+00042920: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00042930: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00042940: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00042950: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00042960: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
+00042970: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00042980: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00042990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000429a0: 2066 2241 7474 656d 7074 696e 6720 746f   f"Attempting to
+000429b0: 2072 6573 6368 6564 756c 6520 7461 736b   reschedule task
+000429c0: 207b 6b65 797d 2c20 7768 6963 6820 7761   {key}, which wa
+000429d0: 7320 6e6f 7420 220a 2020 2020 2020 2020  s not ".        
+000429e0: 2020 2020 2020 2020 2266 6f75 6e64 206f          "found o
+000429f0: 6e20 7468 6520 7363 6865 6475 6c65 722e  n the scheduler.
+00042a00: 2041 626f 7274 696e 6720 7265 7363 6865   Aborting resche
+00042a10: 6475 6c65 2e22 0a20 2020 2020 2020 2020  dule.".         
+00042a20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00042a30: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00042a40: 6966 2074 732e 7374 6174 6520 213d 2022  if ts.state != "
+00042a50: 7072 6f63 6573 7369 6e67 223a 0a20 2020  processing":.   
+00042a60: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00042a70: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+00042a80: 7220 616e 6420 7473 2e70 726f 6365 7373  r and ts.process
+00042a90: 696e 675f 6f6e 2061 6e64 2074 732e 7072  ing_on and ts.pr
+00042aa0: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
+00042ab0: 6573 7320 213d 2077 6f72 6b65 723a 0a20  ess != worker:. 
+00042ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00042ad0: 6e0a 2020 2020 2020 2020 2320 7472 616e  n.        # tran
+00042ae0: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
+00042af0: 675f 7265 6c65 6173 6564 2077 696c 6c20  g_released will 
+00042b00: 696d 6d65 6469 6174 656c 7920 7375 6767  immediately sugg
+00042b10: 6573 7420 616e 2061 6464 6974 696f 6e61  est an additiona
+00042b20: 6c0a 2020 2020 2020 2020 2320 7472 616e  l.        # tran
+00042b30: 7369 7469 6f6e 2074 6f20 7761 6974 696e  sition to waitin
+00042b40: 6720 6966 2074 6865 2074 6173 6b20 6861  g if the task ha
+00042b50: 7320 616e 7920 7761 6974 6572 7320 6f72  s any waiters or
+00042b60: 2063 6c69 656e 7473 2068 6f6c 6469 6e67   clients holding
+00042b70: 2061 2066 7574 7572 652e 0a20 2020 2020   a future..     
+00042b80: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+00042b90: 6f6e 7328 7b6b 6579 3a20 2272 656c 6561  ons({key: "relea
+00042ba0: 7365 6422 7d2c 2073 7469 6d75 6c75 735f  sed"}, stimulus_
+00042bb0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
+00042bc0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00042bd0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+00042be0: 2055 7469 6c69 7479 2066 756e 6374 696f   Utility functio
+00042bf0: 6e73 2023 0a20 2020 2023 2323 2323 2323  ns #.    #######
+00042c00: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
+00042c10: 2020 2020 6465 6620 6164 645f 7265 736f      def add_reso
+00042c20: 7572 6365 7328 0a20 2020 2020 2020 2073  urces(.        s
+00042c30: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
+00042c40: 2c20 7265 736f 7572 6365 733a 2064 6963  , resources: dic
+00042c50: 7420 7c20 4e6f 6e65 203d 204e 6f6e 650a  t | None = None.
+00042c60: 2020 2020 2920 2d3e 204c 6974 6572 616c      ) -> Literal
+00042c70: 5b22 4f4b 225d 3a0a 2020 2020 2020 2020  ["OK"]:.        
+00042c80: 7773 3a20 576f 726b 6572 5374 6174 6520  ws: WorkerState 
+00042c90: 3d20 7365 6c66 2e77 6f72 6b65 7273 5b77  = self.workers[w
+00042ca0: 6f72 6b65 725d 0a20 2020 2020 2020 2069  orker].        i
+00042cb0: 6620 7265 736f 7572 6365 733a 0a20 2020  f resources:.   
+00042cc0: 2020 2020 2020 2020 2077 732e 7265 736f           ws.reso
+00042cd0: 7572 6365 732e 7570 6461 7465 2872 6573  urces.update(res
+00042ce0: 6f75 7263 6573 290a 2020 2020 2020 2020  ources).        
+00042cf0: 7773 2e75 7365 645f 7265 736f 7572 6365  ws.used_resource
+00042d00: 7320 3d20 7b7d 0a20 2020 2020 2020 2066  s = {}.        f
+00042d10: 6f72 2072 6573 6f75 7263 652c 2071 7561  or resource, qua
+00042d20: 6e74 6974 7920 696e 2077 732e 7265 736f  ntity in ws.reso
+00042d30: 7572 6365 732e 6974 656d 7328 293a 0a20  urces.items():. 
+00042d40: 2020 2020 2020 2020 2020 2077 732e 7573             ws.us
+00042d50: 6564 5f72 6573 6f75 7263 6573 5b72 6573  ed_resources[res
+00042d60: 6f75 7263 655d 203d 2030 0a20 2020 2020  ource] = 0.     
+00042d70: 2020 2020 2020 2064 7220 3d20 7365 6c66         dr = self
+00042d80: 2e72 6573 6f75 7263 6573 2e67 6574 2872  .resources.get(r
+00042d90: 6573 6f75 7263 652c 204e 6f6e 6529 0a20  esource, None). 
+00042da0: 2020 2020 2020 2020 2020 2069 6620 6472             if dr
+00042db0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00042dc0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00042dd0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
+00042de0: 655d 203d 2064 7220 3d20 7b7d 0a20 2020  e] = dr = {}.   
+00042df0: 2020 2020 2020 2020 2064 725b 776f 726b           dr[work
+00042e00: 6572 5d20 3d20 7175 616e 7469 7479 0a20  er] = quantity. 
+00042e10: 2020 2020 2020 2072 6574 7572 6e20 224f         return "O
+00042e20: 4b22 0a0a 2020 2020 6465 6620 7265 6d6f  K"..    def remo
+00042e30: 7665 5f72 6573 6f75 7263 6573 2873 656c  ve_resources(sel
+00042e40: 662c 2077 6f72 6b65 723a 2073 7472 2920  f, worker: str) 
+00042e50: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00042e60: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+00042e70: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
+00042e80: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
+00042e90: 666f 7220 7265 736f 7572 6365 2069 6e20  for resource in 
+00042ea0: 7773 2e72 6573 6f75 7263 6573 3a0a 2020  ws.resources:.  
+00042eb0: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
+00042ec0: 656c 662e 7265 736f 7572 6365 732e 7365  elf.resources.se
+00042ed0: 7464 6566 6175 6c74 2872 6573 6f75 7263  tdefault(resourc
+00042ee0: 652c 207b 7d29 0a20 2020 2020 2020 2020  e, {}).         
+00042ef0: 2020 2064 656c 2064 725b 776f 726b 6572     del dr[worker
+00042f00: 5d0a 0a20 2020 2064 6566 2063 6f65 7263  ]..    def coerc
+00042f10: 655f 6164 6472 6573 7328 7365 6c66 2c20  e_address(self, 
+00042f20: 6164 6472 3a20 7374 7220 7c20 7475 706c  addr: str | tupl
+00042f30: 652c 2072 6573 6f6c 7665 3a20 626f 6f6c  e, resolve: bool
+00042f40: 203d 2054 7275 6529 202d 3e20 7374 723a   = True) -> str:
+00042f50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00042f60: 2020 2020 2043 6f65 7263 6520 706f 7373       Coerce poss
+00042f70: 6962 6c65 2069 6e70 7574 2061 6464 7265  ible input addre
+00042f80: 7373 6573 2074 6f20 6361 6e6f 6e69 6361  sses to canonica
+00042f90: 6c20 666f 726d 2e0a 2020 2020 2020 2020  l form..        
+00042fa0: 2a72 6573 6f6c 7665 2a20 6361 6e20 6265  *resolve* can be
+00042fb0: 2064 6973 6162 6c65 6420 666f 7220 7465   disabled for te
+00042fc0: 7374 696e 6720 7769 7468 2066 616b 6520  sting with fake 
+00042fd0: 686f 7374 6e61 6d65 732e 0a0a 2020 2020  hostnames...    
+00042fe0: 2020 2020 4861 6e64 6c65 7320 7374 7269      Handles stri
+00042ff0: 6e67 732c 2074 7570 6c65 732c 206f 7220  ngs, tuples, or 
+00043000: 616c 6961 7365 732e 0a20 2020 2020 2020  aliases..       
+00043010: 2022 2222 0a20 2020 2020 2020 2023 2058   """.        # X
+00043020: 5858 2068 6f77 206d 616e 7920 6164 6472  XX how many addr
+00043030: 6573 732d 7061 7273 696e 6720 726f 7574  ess-parsing rout
+00043040: 696e 6573 2064 6f20 7765 2068 6176 653f  ines do we have?
+00043050: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
+00043060: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
+00043070: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
+00043080: 6472 203d 2073 656c 662e 616c 6961 7365  dr = self.aliase
+00043090: 735b 6164 6472 5d0a 2020 2020 2020 2020  s[addr].        
+000430a0: 6966 2069 7369 6e73 7461 6e63 6528 6164  if isinstance(ad
+000430b0: 6472 2c20 7475 706c 6529 3a0a 2020 2020  dr, tuple):.    
+000430c0: 2020 2020 2020 2020 6164 6472 203d 2075          addr = u
+000430d0: 6e70 6172 7365 5f68 6f73 745f 706f 7274  nparse_host_port
+000430e0: 282a 6164 6472 290a 2020 2020 2020 2020  (*addr).        
+000430f0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+00043100: 6528 6164 6472 2c20 7374 7229 3a0a 2020  e(addr, str):.  
+00043110: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00043120: 5479 7065 4572 726f 7228 6622 6164 6472  TypeError(f"addr
+00043130: 6573 7365 7320 7368 6f75 6c64 2062 6520  esses should be 
+00043140: 7374 7269 6e67 7320 6f72 2074 7570 6c65  strings or tuple
+00043150: 732c 2067 6f74 207b 6164 6472 2172 7d22  s, got {addr!r}"
+00043160: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
+00043170: 736f 6c76 653a 0a20 2020 2020 2020 2020  solve:.         
+00043180: 2020 2061 6464 7220 3d20 7265 736f 6c76     addr = resolv
+00043190: 655f 6164 6472 6573 7328 6164 6472 290a  e_address(addr).
+000431a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000431b0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
+000431c0: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
+000431d0: 7373 2861 6464 7229 0a0a 2020 2020 2020  ss(addr)..      
+000431e0: 2020 7265 7475 726e 2061 6464 720a 0a20    return addr.. 
+000431f0: 2020 2064 6566 2077 6f72 6b65 7273 5f6c     def workers_l
+00043200: 6973 7428 7365 6c66 2c20 776f 726b 6572  ist(self, worker
+00043210: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+00043220: 207c 204e 6f6e 6529 202d 3e20 6c69 7374   | None) -> list
+00043230: 5b73 7472 5d3a 0a20 2020 2020 2020 2022  [str]:.        "
+00043240: 2222 0a20 2020 2020 2020 204c 6973 7420  "".        List 
+00043250: 6f66 2071 7561 6c69 6679 696e 6720 776f  of qualifying wo
+00043260: 726b 6572 730a 0a20 2020 2020 2020 2054  rkers..        T
+00043270: 616b 6573 2061 206c 6973 7420 6f66 2077  akes a list of w
+00043280: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
+00043290: 6f72 2068 6f73 746e 616d 6573 2e0a 2020  or hostnames..  
+000432a0: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
+000432b0: 6c69 7374 206f 6620 616c 6c20 776f 726b  list of all work
+000432c0: 6572 2061 6464 7265 7373 6573 2074 6861  er addresses tha
+000432d0: 7420 6d61 7463 680a 2020 2020 2020 2020  t match.        
+000432e0: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
+000432f0: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+00043300: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00043310: 726e 206c 6973 7428 7365 6c66 2e77 6f72  rn list(self.wor
+00043320: 6b65 7273 290a 0a20 2020 2020 2020 206f  kers)..        o
+00043330: 7574 203d 2073 6574 2829 0a20 2020 2020  ut = set().     
+00043340: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
+00043350: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00043360: 2069 6620 223a 2220 696e 2077 3a0a 2020   if ":" in w:.  
+00043370: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00043380: 742e 6164 6428 7729 0a20 2020 2020 2020  t.add(w).       
+00043390: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000433a0: 2020 2020 2020 2020 2020 206f 7574 2e75             out.u
+000433b0: 7064 6174 6528 7b77 7720 666f 7220 7777  pdate({ww for ww
+000433c0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+000433d0: 2069 6620 7720 696e 2077 777d 2920 2023   if w in ww})  #
+000433e0: 2054 4f44 4f3a 2071 7561 6472 6174 6963   TODO: quadratic
+000433f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00043400: 6c69 7374 286f 7574 290a 0a20 2020 2061  list(out)..    a
+00043410: 7379 6e63 2064 6566 2067 6574 5f70 726f  sync def get_pro
+00043420: 6669 6c65 280a 2020 2020 2020 2020 7365  file(.        se
+00043430: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
+00043440: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
+00043450: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
+00043460: 2020 2020 2073 6368 6564 756c 6572 3d46       scheduler=F
+00043470: 616c 7365 2c0a 2020 2020 2020 2020 7365  alse,.        se
+00043480: 7276 6572 3d46 616c 7365 2c0a 2020 2020  rver=False,.    
+00043490: 2020 2020 6d65 7267 655f 776f 726b 6572      merge_worker
+000434a0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+000434b0: 7374 6172 743d 4e6f 6e65 2c0a 2020 2020  start=None,.    
+000434c0: 2020 2020 7374 6f70 3d4e 6f6e 652c 0a20      stop=None,. 
+000434d0: 2020 2020 2020 206b 6579 3d4e 6f6e 652c         key=None,
+000434e0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+000434f0: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
+00043500: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00043510: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
+00043520: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
+00043530: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00043540: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
+00043550: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
+00043560: 6574 2877 6f72 6b65 7273 290a 0a20 2020  et(workers)..   
+00043570: 2020 2020 2069 6620 7363 6865 6475 6c65       if schedule
+00043580: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00043590: 6574 7572 6e20 7072 6f66 696c 652e 6765  eturn profile.ge
+000435a0: 745f 7072 6f66 696c 6528 7365 6c66 2e69  t_profile(self.i
+000435b0: 6f5f 6c6f 6f70 2e70 726f 6669 6c65 2c20  o_loop.profile, 
+000435c0: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
+000435d0: 703d 7374 6f70 290a 0a20 2020 2020 2020  p=stop)..       
+000435e0: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
+000435f0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+00043600: 0a20 2020 2020 2020 2020 2020 202a 280a  .            *(.
+00043610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043620: 7365 6c66 2e72 7063 2877 292e 7072 6f66  self.rpc(w).prof
+00043630: 696c 6528 7374 6172 743d 7374 6172 742c  ile(start=start,
+00043640: 2073 746f 703d 7374 6f70 2c20 6b65 793d   stop=stop, key=
+00043650: 6b65 792c 2073 6572 7665 723d 7365 7276  key, server=serv
+00043660: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00043670: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
+00043680: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
+00043690: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+000436a0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+000436b0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+000436c0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
+000436d0: 7473 203d 205b 7220 666f 7220 7220 696e  ts = [r for r in
+000436e0: 2072 6573 756c 7473 2069 6620 6e6f 7420   results if not 
+000436f0: 6973 696e 7374 616e 6365 2872 2c20 4578  isinstance(r, Ex
+00043700: 6365 7074 696f 6e29 5d0a 0a20 2020 2020  ception)]..     
+00043710: 2020 2069 6620 6d65 7267 655f 776f 726b     if merge_work
+00043720: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00043730: 2072 6573 706f 6e73 6520 3d20 7072 6f66   response = prof
+00043740: 696c 652e 6d65 7267 6528 2a72 6573 756c  ile.merge(*resul
+00043750: 7473 290a 2020 2020 2020 2020 656c 7365  ts).        else
+00043760: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00043770: 7370 6f6e 7365 203d 2064 6963 7428 7a69  sponse = dict(zi
+00043780: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
+00043790: 7473 2929 0a20 2020 2020 2020 2072 6574  ts)).        ret
+000437a0: 7572 6e20 7265 7370 6f6e 7365 0a0a 2020  urn response..  
+000437b0: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
+000437c0: 7072 6f66 696c 655f 6d65 7461 6461 7461  profile_metadata
+000437d0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+000437e0: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+000437f0: 2022 4974 6572 6162 6c65 5b73 7472 5d20   "Iterable[str] 
+00043800: 7c20 4e6f 6e65 2220 3d20 4e6f 6e65 2c0a  | None" = None,.
+00043810: 2020 2020 2020 2020 7374 6172 743a 2066          start: f
+00043820: 6c6f 6174 203d 2030 2c0a 2020 2020 2020  loat = 0,.      
+00043830: 2020 7374 6f70 3a20 2266 6c6f 6174 207c    stop: "float |
+00043840: 204e 6f6e 6522 203d 204e 6f6e 652c 0a20   None" = None,. 
+00043850: 2020 2020 2020 2070 726f 6669 6c65 5f63         profile_c
+00043860: 7963 6c65 5f69 6e74 6572 7661 6c3a 2022  ycle_interval: "
+00043870: 7374 7220 7c20 666c 6f61 7420 7c20 4e6f  str | float | No
+00043880: 6e65 2220 3d20 4e6f 6e65 2c0a 2020 2020  ne" = None,.    
+00043890: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
+000438a0: 2020 2064 7420 3d20 7072 6f66 696c 655f     dt = profile_
+000438b0: 6379 636c 655f 696e 7465 7276 616c 206f  cycle_interval o
+000438c0: 7220 6461 736b 2e63 6f6e 6669 672e 6765  r dask.config.ge
+000438d0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
+000438e0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+000438f0: 6572 2e70 726f 6669 6c65 2e63 7963 6c65  er.profile.cycle
+00043900: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00043910: 2020 2020 6474 203d 2070 6172 7365 5f74      dt = parse_t
+00043920: 696d 6564 656c 7461 2864 742c 2064 6566  imedelta(dt, def
+00043930: 6175 6c74 3d22 6d73 2229 0a0a 2020 2020  ault="ms")..    
+00043940: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
+00043950: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00043960: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
+00043970: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+00043980: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00043990: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
+000439a0: 6574 2873 656c 662e 776f 726b 6572 7329  et(self.workers)
+000439b0: 2026 2073 6574 2877 6f72 6b65 7273 290a   & set(workers).
+000439c0: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
+000439d0: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
+000439e0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+000439f0: 2020 2020 2a28 7365 6c66 2e72 7063 2877      *(self.rpc(w
+00043a00: 292e 7072 6f66 696c 655f 6d65 7461 6461  ).profile_metada
+00043a10: 7461 2873 7461 7274 3d73 7461 7274 2c20  ta(start=start, 
+00043a20: 7374 6f70 3d73 746f 7029 2066 6f72 2077  stop=stop) for w
+00043a30: 2069 6e20 776f 726b 6572 7329 2c0a 2020   in workers),.  
+00043a40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00043a50: 5f65 7863 6570 7469 6f6e 733d 5472 7565  _exceptions=True
+00043a60: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00043a70: 2020 2020 2072 6573 756c 7473 203d 205b       results = [
+00043a80: 7220 666f 7220 7220 696e 2072 6573 756c  r for r in resul
+00043a90: 7473 2069 6620 6e6f 7420 6973 696e 7374  ts if not isinst
+00043aa0: 616e 6365 2872 2c20 4578 6365 7074 696f  ance(r, Exceptio
+00043ab0: 6e29 5d0a 2020 2020 2020 2020 636f 756e  n)].        coun
+00043ac0: 7473 203d 205b 0a20 2020 2020 2020 2020  ts = [.         
+00043ad0: 2020 2028 7469 6d65 2c20 7375 6d28 706c     (time, sum(pl
+00043ae0: 7563 6b28 312c 2067 726f 7570 2929 290a  uck(1, group))).
+00043af0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00043b00: 7469 6d65 2c20 6772 6f75 7020 696e 2069  time, group in i
+00043b10: 7465 7274 6f6f 6c73 2e67 726f 7570 6279  tertools.groupby
+00043b20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00043b30: 2020 6d65 7267 655f 736f 7274 6564 280a    merge_sorted(.
+00043b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043b50: 2020 2020 2a28 765b 2263 6f75 6e74 7322      *(v["counts"
+00043b60: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
+00043b70: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00043b80: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00043b90: 2020 2020 2020 2020 6c61 6d62 6461 2074          lambda t
+00043ba0: 3a20 745b 305d 202f 2f20 6474 202a 2064  : t[0] // dt * d
+00043bb0: 742c 0a20 2020 2020 2020 2020 2020 2029  t,.            )
+00043bc0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
+00043bd0: 2020 2020 6b65 7973 3a20 6469 6374 5b73      keys: dict[s
+00043be0: 7472 2c20 6c69 7374 5b6c 6973 745d 5d20  tr, list[list]] 
+00043bf0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00043c00: 6b3a 205b 5d20 666f 7220 7620 696e 2072  k: [] for v in r
+00043c10: 6573 756c 7473 2066 6f72 2074 2c20 6420  esults for t, d 
+00043c20: 696e 2076 5b22 6b65 7973 225d 2066 6f72  in v["keys"] for
+00043c30: 206b 2069 6e20 640a 2020 2020 2020 2020   k in d.        
+00043c40: 7d0a 0a20 2020 2020 2020 2067 726f 7570  }..        group
+00043c50: 7331 203d 205b 765b 226b 6579 7322 5d20  s1 = [v["keys"] 
+00043c60: 666f 7220 7620 696e 2072 6573 756c 7473  for v in results
+00043c70: 5d0a 2020 2020 2020 2020 6772 6f75 7073  ].        groups
+00043c80: 3220 3d20 6c69 7374 286d 6572 6765 5f73  2 = list(merge_s
+00043c90: 6f72 7465 6428 2a67 726f 7570 7331 2c20  orted(*groups1, 
+00043ca0: 6b65 793d 6669 7273 7429 290a 0a20 2020  key=first))..   
+00043cb0: 2020 2020 206c 6173 7420 3d20 300a 2020       last = 0.  
+00043cc0: 2020 2020 2020 666f 7220 742c 2064 2069        for t, d i
+00043cd0: 6e20 6772 6f75 7073 323a 0a20 2020 2020  n groups2:.     
+00043ce0: 2020 2020 2020 2074 7420 3d20 7420 2f2f         tt = t //
+00043cf0: 2064 7420 2a20 6474 0a20 2020 2020 2020   dt * dt.       
+00043d00: 2020 2020 2069 6620 7474 203e 206c 6173       if tt > las
+00043d10: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00043d20: 2020 206c 6173 7420 3d20 7474 0a20 2020     last = tt.   
+00043d30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00043d40: 2076 2069 6e20 6b65 7973 2e76 616c 7565   v in keys.value
+00043d50: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00043d60: 2020 2020 2020 2020 2076 2e61 7070 656e           v.appen
+00043d70: 6428 5b74 742c 2030 5d29 0a20 2020 2020  d([tt, 0]).     
+00043d80: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+00043d90: 696e 2064 2e69 7465 6d73 2829 3a0a 2020  in d.items():.  
+00043da0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00043db0: 7973 5b6b 5d5b 2d31 5d5b 315d 202b 3d20  ys[k][-1][1] += 
+00043dc0: 760a 0a20 2020 2020 2020 2072 6574 7572  v..        retur
+00043dd0: 6e20 7b22 636f 756e 7473 223a 2063 6f75  n {"counts": cou
+00043de0: 6e74 732c 2022 6b65 7973 223a 206b 6579  nts, "keys": key
+00043df0: 737d 0a0a 2020 2020 6173 796e 6320 6465  s}..    async de
+00043e00: 6620 7065 7266 6f72 6d61 6e63 655f 7265  f performance_re
+00043e10: 706f 7274 280a 2020 2020 2020 2020 7365  port(.        se
+00043e20: 6c66 2c20 7374 6172 743a 2066 6c6f 6174  lf, start: float
+00043e30: 2c20 6c61 7374 5f63 6f75 6e74 3a20 696e  , last_count: in
+00043e40: 742c 2063 6f64 653a 2073 7472 203d 2022  t, code: str = "
+00043e50: 222c 206d 6f64 653a 2073 7472 207c 204e  ", mode: str | N
+00043e60: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
+00043e70: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00043e80: 2073 746f 7020 3d20 7469 6d65 2829 0a20   stop = time(). 
+00043e90: 2020 2020 2020 2023 2050 726f 6669 6c65         # Profile
+00043ea0: 730a 2020 2020 2020 2020 636f 6d70 7574  s.        comput
+00043eb0: 652c 2073 6368 6564 756c 6572 2c20 776f  e, scheduler, wo
+00043ec0: 726b 6572 7320 3d20 6177 6169 7420 6173  rkers = await as
+00043ed0: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
+00043ee0: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
+00043ef0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00043f00: 662e 6765 745f 7072 6f66 696c 6528 7374  f.get_profile(st
+00043f10: 6172 743d 7374 6172 7429 2c0a 2020 2020  art=start),.    
+00043f20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00043f30: 2e67 6574 5f70 726f 6669 6c65 2873 6368  .get_profile(sch
+00043f40: 6564 756c 6572 3d54 7275 652c 2073 7461  eduler=True, sta
+00043f50: 7274 3d73 7461 7274 292c 0a20 2020 2020  rt=start),.     
+00043f60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00043f70: 6765 745f 7072 6f66 696c 6528 7365 7276  get_profile(serv
+00043f80: 6572 3d54 7275 652c 2073 7461 7274 3d73  er=True, start=s
+00043f90: 7461 7274 292c 0a20 2020 2020 2020 2020  tart),.         
+00043fa0: 2020 205d 0a20 2020 2020 2020 2029 0a20     ].        ). 
+00043fb0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
+00043fc0: 7269 6275 7465 6420 696d 706f 7274 2070  ributed import p
+00043fd0: 726f 6669 6c65 0a0a 2020 2020 2020 2020  rofile..        
+00043fe0: 6465 6620 7072 6f66 696c 655f 746f 5f66  def profile_to_f
+00043ff0: 6967 7572 6528 7374 6174 6529 3a0a 2020  igure(state):.  
+00044000: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+00044010: 2070 726f 6669 6c65 2e70 6c6f 745f 6461   profile.plot_da
+00044020: 7461 2873 7461 7465 290a 2020 2020 2020  ta(state).      
+00044030: 2020 2020 2020 6669 6775 7265 2c20 736f        figure, so
+00044040: 7572 6365 203d 2070 726f 6669 6c65 2e70  urce = profile.p
+00044050: 6c6f 745f 6669 6775 7265 2864 6174 612c  lot_figure(data,
+00044060: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00044070: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+00044080: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00044090: 6669 6775 7265 0a0a 2020 2020 2020 2020  figure..        
+000440a0: 636f 6d70 7574 652c 2073 6368 6564 756c  compute, schedul
+000440b0: 6572 2c20 776f 726b 6572 7320 3d20 6d61  er, workers = ma
+000440c0: 7028 0a20 2020 2020 2020 2020 2020 2070  p(.            p
+000440d0: 726f 6669 6c65 5f74 6f5f 6669 6775 7265  rofile_to_figure
+000440e0: 2c20 2863 6f6d 7075 7465 2c20 7363 6865  , (compute, sche
+000440f0: 6475 6c65 722c 2077 6f72 6b65 7273 290a  duler, workers).
+00044100: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00044110: 2020 2023 2054 6173 6b20 7374 7265 616d     # Task stream
+00044120: 0a20 2020 2020 2020 2074 6173 6b5f 7374  .        task_st
+00044130: 7265 616d 203d 2073 656c 662e 6765 745f  ream = self.get_
+00044140: 7461 736b 5f73 7472 6561 6d28 7374 6172  task_stream(star
+00044150: 743d 7374 6172 7429 0a20 2020 2020 2020  t=start).       
+00044160: 2074 6f74 616c 5f74 6173 6b73 203d 206c   total_tasks = l
+00044170: 656e 2874 6173 6b5f 7374 7265 616d 290a  en(task_stream).
+00044180: 2020 2020 2020 2020 7469 6d65 7370 656e          timespen
+00044190: 743a 2064 6566 6175 6c74 6469 6374 5b73  t: defaultdict[s
+000441a0: 7472 2c20 666c 6f61 745d 203d 2064 6566  tr, float] = def
+000441b0: 6175 6c74 6469 6374 2866 6c6f 6174 290a  aultdict(float).
+000441c0: 2020 2020 2020 2020 666f 7220 6420 696e          for d in
+000441d0: 2074 6173 6b5f 7374 7265 616d 3a0a 2020   task_stream:.  
+000441e0: 2020 2020 2020 2020 2020 666f 7220 7820            for x 
+000441f0: 696e 2064 5b22 7374 6172 7473 746f 7073  in d["startstops
+00044200: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
+00044210: 2020 2020 7469 6d65 7370 656e 745b 785b      timespent[x[
+00044220: 2261 6374 696f 6e22 5d5d 202b 3d20 785b  "action"]] += x[
+00044230: 2273 746f 7022 5d20 2d20 785b 2273 7461  "stop"] - x["sta
+00044240: 7274 225d 0a20 2020 2020 2020 2074 6173  rt"].        tas
+00044250: 6b73 5f74 696d 696e 6773 203d 2022 220a  ks_timings = "".
+00044260: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+00044270: 2073 6f72 7465 6428 7469 6d65 7370 656e   sorted(timespen
+00044280: 742e 6b65 7973 2829 293a 0a20 2020 2020  t.keys()):.     
+00044290: 2020 2020 2020 2074 6173 6b73 5f74 696d         tasks_tim
+000442a0: 696e 6773 202b 3d20 6622 5c6e 3c6c 693e  ings += f"\n<li>
+000442b0: 207b 6b7d 2074 696d 653a 207b 666f 726d   {k} time: {form
+000442c0: 6174 5f74 696d 6528 7469 6d65 7370 656e  at_time(timespen
+000442d0: 745b 6b5d 297d 203c 2f6c 693e 220a 0a20  t[k])} </li>".. 
+000442e0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
+000442f0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
+00044300: 642e 636f 6d70 6f6e 656e 7473 2e73 6368  d.components.sch
+00044310: 6564 756c 6572 2069 6d70 6f72 7420 7461  eduler import ta
+00044320: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
+00044330: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00044340: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
+00044350: 7374 6963 732e 7461 736b 5f73 7472 6561  stics.task_strea
+00044360: 6d20 696d 706f 7274 2072 6563 7461 6e67  m import rectang
+00044370: 6c65 730a 0a20 2020 2020 2020 2072 6563  les..        rec
+00044380: 7473 203d 2072 6563 7461 6e67 6c65 7328  ts = rectangles(
+00044390: 7461 736b 5f73 7472 6561 6d29 0a20 2020  task_stream).   
+000443a0: 2020 2020 2073 6f75 7263 652c 2074 6173       source, tas
+000443b0: 6b5f 7374 7265 616d 203d 2074 6173 6b5f  k_stream = task_
+000443c0: 7374 7265 616d 5f66 6967 7572 6528 7369  stream_figure(si
+000443d0: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+000443e0: 6368 5f62 6f74 6822 290a 2020 2020 2020  ch_both").      
+000443f0: 2020 736f 7572 6365 2e64 6174 612e 7570    source.data.up
+00044400: 6461 7465 2872 6563 7473 290a 0a20 2020  date(rects)..   
+00044410: 2020 2020 2023 2042 616e 6477 6964 7468       # Bandwidth
+00044420: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00044430: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
+00044440: 6172 642e 636f 6d70 6f6e 656e 7473 2e73  ard.components.s
+00044450: 6368 6564 756c 6572 2069 6d70 6f72 7420  cheduler import 
+00044460: 280a 2020 2020 2020 2020 2020 2020 4261  (.            Ba
+00044470: 6e64 7769 6474 6854 7970 6573 2c0a 2020  ndwidthTypes,.  
+00044480: 2020 2020 2020 2020 2020 4261 6e64 7769            Bandwi
+00044490: 6474 6857 6f72 6b65 7273 2c0a 2020 2020  dthWorkers,.    
+000444a0: 2020 2020 290a 0a20 2020 2020 2020 2062      )..        b
+000444b0: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
+000444c0: 203d 2042 616e 6477 6964 7468 576f 726b   = BandwidthWork
+000444d0: 6572 7328 7365 6c66 2c20 7369 7a69 6e67  ers(self, sizing
+000444e0: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
+000444f0: 6f74 6822 290a 2020 2020 2020 2020 6261  oth").        ba
+00044500: 6e64 7769 6474 685f 776f 726b 6572 732e  ndwidth_workers.
+00044510: 7570 6461 7465 2829 0a20 2020 2020 2020  update().       
+00044520: 2062 616e 6477 6964 7468 5f74 7970 6573   bandwidth_types
+00044530: 203d 2042 616e 6477 6964 7468 5479 7065   = BandwidthType
+00044540: 7328 7365 6c66 2c20 7369 7a69 6e67 5f6d  s(self, sizing_m
+00044550: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00044560: 6822 290a 2020 2020 2020 2020 6261 6e64  h").        band
+00044570: 7769 6474 685f 7479 7065 732e 7570 6461  width_types.upda
+00044580: 7465 2829 0a0a 2020 2020 2020 2020 2320  te()..        # 
+00044590: 5379 7374 656d 206d 6f6e 6974 6f72 0a20  System monitor. 
+000445a0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
+000445b0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
+000445c0: 642e 636f 6d70 6f6e 656e 7473 2e73 6861  d.components.sha
+000445d0: 7265 6420 696d 706f 7274 2053 7973 7465  red import Syste
+000445e0: 6d4d 6f6e 6974 6f72 0a0a 2020 2020 2020  mMonitor..      
+000445f0: 2020 7379 736d 6f6e 203d 2053 7973 7465    sysmon = Syste
+00044600: 6d4d 6f6e 6974 6f72 2873 656c 662c 206c  mMonitor(self, l
+00044610: 6173 745f 636f 756e 743d 6c61 7374 5f63  ast_count=last_c
+00044620: 6f75 6e74 2c20 7369 7a69 6e67 5f6d 6f64  ount, sizing_mod
+00044630: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00044640: 290a 2020 2020 2020 2020 7379 736d 6f6e  ).        sysmon
+00044650: 2e75 7064 6174 6528 290a 0a20 2020 2020  .update()..     
+00044660: 2020 2023 2053 6368 6564 756c 6572 206c     # Scheduler l
+00044670: 6f67 730a 2020 2020 2020 2020 6672 6f6d  ogs.        from
+00044680: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00044690: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+000446a0: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
+000446b0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+000446c0: 205f 424f 4b45 485f 5354 594c 4553 5f4b   _BOKEH_STYLES_K
+000446d0: 5741 5247 532c 0a20 2020 2020 2020 2020  WARGS,.         
+000446e0: 2020 2053 6368 6564 756c 6572 4c6f 6773     SchedulerLogs
+000446f0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00044700: 2020 2020 206c 6f67 7320 3d20 5363 6865       logs = Sche
+00044710: 6475 6c65 724c 6f67 7328 7365 6c66 2c20  dulerLogs(self, 
+00044720: 7374 6172 743d 7374 6172 7429 0a0a 2020  start=start)..  
+00044730: 2020 2020 2020 6672 6f6d 2062 6f6b 6568        from bokeh
+00044740: 2e6d 6f64 656c 7320 696d 706f 7274 2044  .models import D
+00044750: 6976 2c20 5461 6273 0a0a 2020 2020 2020  iv, Tabs..      
+00044760: 2020 696d 706f 7274 2064 6973 7472 6962    import distrib
+00044770: 7574 6564 0a20 2020 2020 2020 2066 726f  uted.        fro
+00044780: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
+00044790: 7368 626f 6172 642e 636f 7265 2069 6d70  shboard.core imp
+000447a0: 6f72 7420 5461 6250 616e 656c 0a0a 2020  ort TabPanel..  
+000447b0: 2020 2020 2020 2320 4854 4d4c 0a20 2020        # HTML.   
+000447c0: 2020 2020 2068 746d 6c20 3d20 2222 220a       html = """.
+000447d0: 2020 2020 2020 2020 3c68 313e 2044 6173          <h1> Das
+000447e0: 6b20 5065 7266 6f72 6d61 6e63 6520 5265  k Performance Re
+000447f0: 706f 7274 203c 2f68 313e 0a0a 2020 2020  port </h1>..    
+00044800: 2020 2020 3c69 3e20 5365 6c65 6374 2064      <i> Select d
+00044810: 6966 6665 7265 6e74 2074 6162 7320 6f6e  ifferent tabs on
+00044820: 2074 6865 2074 6f70 2066 6f72 2061 6464   the top for add
+00044830: 6974 696f 6e61 6c20 696e 666f 726d 6174  itional informat
+00044840: 696f 6e20 3c2f 693e 0a0a 2020 2020 2020  ion </i>..      
+00044850: 2020 3c68 323e 2044 7572 6174 696f 6e3a    <h2> Duration:
+00044860: 207b 7469 6d65 7d20 3c2f 6832 3e0a 2020   {time} </h2>.  
+00044870: 2020 2020 2020 3c68 323e 2054 6173 6b73        <h2> Tasks
+00044880: 2049 6e66 6f72 6d61 7469 6f6e 203c 2f68   Information </h
+00044890: 323e 0a20 2020 2020 2020 203c 756c 3e0a  2>.        <ul>.
+000448a0: 2020 2020 2020 2020 203c 6c69 3e20 6e75           <li> nu
+000448b0: 6d62 6572 206f 6620 7461 736b 733a 207b  mber of tasks: {
+000448c0: 6e74 6173 6b73 7d20 3c2f 6c69 3e0a 2020  ntasks} </li>.  
+000448d0: 2020 2020 2020 207b 7461 736b 735f 7469         {tasks_ti
+000448e0: 6d69 6e67 737d 0a20 2020 2020 2020 203c  mings}.        <
+000448f0: 2f75 6c3e 0a0a 2020 2020 2020 2020 3c68  /ul>..        <h
+00044900: 323e 2053 6368 6564 756c 6572 2049 6e66  2> Scheduler Inf
+00044910: 6f72 6d61 7469 6f6e 203c 2f68 323e 0a20  ormation </h2>. 
+00044920: 2020 2020 2020 203c 756c 3e0a 2020 2020         <ul>.    
+00044930: 2020 2020 2020 3c6c 693e 2041 6464 7265        <li> Addre
+00044940: 7373 3a20 7b61 6464 7265 7373 7d20 3c2f  ss: {address} </
+00044950: 6c69 3e0a 2020 2020 2020 2020 2020 3c6c  li>.          <l
+00044960: 693e 2057 6f72 6b65 7273 3a20 7b6e 776f  i> Workers: {nwo
+00044970: 726b 6572 737d 203c 2f6c 693e 0a20 2020  rkers} </li>.   
+00044980: 2020 2020 2020 203c 6c69 3e20 5468 7265         <li> Thre
+00044990: 6164 733a 207b 7468 7265 6164 737d 203c  ads: {threads} <
+000449a0: 2f6c 693e 0a20 2020 2020 2020 2020 203c  /li>.          <
+000449b0: 6c69 3e20 4d65 6d6f 7279 3a20 7b6d 656d  li> Memory: {mem
+000449c0: 6f72 797d 203c 2f6c 693e 0a20 2020 2020  ory} </li>.     
+000449d0: 2020 2020 203c 6c69 3e20 4461 736b 2056       <li> Dask V
+000449e0: 6572 7369 6f6e 3a20 7b64 6173 6b5f 7665  ersion: {dask_ve
+000449f0: 7273 696f 6e7d 203c 2f6c 693e 0a20 2020  rsion} </li>.   
+00044a00: 2020 2020 2020 203c 6c69 3e20 4461 736b         <li> Dask
+00044a10: 2e44 6973 7472 6962 7574 6564 2056 6572  .Distributed Ver
+00044a20: 7369 6f6e 3a20 7b64 6973 7472 6962 7574  sion: {distribut
+00044a30: 6564 5f76 6572 7369 6f6e 7d20 3c2f 6c69  ed_version} </li
+00044a40: 3e0a 2020 2020 2020 2020 3c2f 756c 3e0a  >.        </ul>.
+00044a50: 0a20 2020 2020 2020 203c 6832 3e20 4361  .        <h2> Ca
+00044a60: 6c6c 696e 6720 436f 6465 203c 2f68 323e  lling Code </h2>
+00044a70: 0a20 2020 2020 2020 203c 7072 653e 0a7b  .        <pre>.{
+00044a80: 636f 6465 7d0a 2020 2020 2020 2020 3c2f  code}.        </
+00044a90: 7072 653e 0a20 2020 2020 2020 2022 2222  pre>.        """
+00044aa0: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
+00044ab0: 2020 2020 2074 696d 653d 666f 726d 6174       time=format
+00044ac0: 5f74 696d 6528 7374 6f70 202d 2073 7461  _time(stop - sta
+00044ad0: 7274 292c 0a20 2020 2020 2020 2020 2020  rt),.           
+00044ae0: 206e 7461 736b 733d 746f 7461 6c5f 7461   ntasks=total_ta
+00044af0: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
+00044b00: 2074 6173 6b73 5f74 696d 696e 6773 3d74   tasks_timings=t
+00044b10: 6173 6b73 5f74 696d 696e 6773 2c0a 2020  asks_timings,.  
+00044b20: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+00044b30: 733d 7365 6c66 2e61 6464 7265 7373 2c0a  s=self.address,.
+00044b40: 2020 2020 2020 2020 2020 2020 6e77 6f72              nwor
+00044b50: 6b65 7273 3d6c 656e 2873 656c 662e 776f  kers=len(self.wo
+00044b60: 726b 6572 7329 2c0a 2020 2020 2020 2020  rkers),.        
+00044b70: 2020 2020 7468 7265 6164 733d 7375 6d28      threads=sum(
+00044b80: 7773 2e6e 7468 7265 6164 7320 666f 7220  ws.nthreads for 
+00044b90: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+00044ba0: 7273 2e76 616c 7565 7328 2929 2c0a 2020  rs.values()),.  
+00044bb0: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
+00044bc0: 3d66 6f72 6d61 745f 6279 7465 7328 7375  =format_bytes(su
+00044bd0: 6d28 7773 2e6d 656d 6f72 795f 6c69 6d69  m(ws.memory_limi
+00044be0: 7420 666f 7220 7773 2069 6e20 7365 6c66  t for ws in self
+00044bf0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00044c00: 2929 292c 0a20 2020 2020 2020 2020 2020  ))),.           
+00044c10: 2063 6f64 653d 636f 6465 2c0a 2020 2020   code=code,.    
+00044c20: 2020 2020 2020 2020 6461 736b 5f76 6572          dask_ver
+00044c30: 7369 6f6e 3d64 6173 6b2e 5f5f 7665 7273  sion=dask.__vers
+00044c40: 696f 6e5f 5f2c 0a20 2020 2020 2020 2020  ion__,.         
+00044c50: 2020 2064 6973 7472 6962 7574 6564 5f76     distributed_v
+00044c60: 6572 7369 6f6e 3d64 6973 7472 6962 7574  ersion=distribut
+00044c70: 6564 2e5f 5f76 6572 7369 6f6e 5f5f 2c0a  ed.__version__,.
+00044c80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00044c90: 2020 6874 6d6c 203d 2044 6976 2874 6578    html = Div(tex
+00044ca0: 743d 6874 6d6c 2c20 2a2a 5f42 4f4b 4548  t=html, **_BOKEH
+00044cb0: 5f53 5459 4c45 535f 4b57 4152 4753 290a  _STYLES_KWARGS).
+00044cc0: 0a20 2020 2020 2020 2068 746d 6c20 3d20  .        html = 
+00044cd0: 5461 6250 616e 656c 2863 6869 6c64 3d68  TabPanel(child=h
+00044ce0: 746d 6c2c 2074 6974 6c65 3d22 5375 6d6d  tml, title="Summ
+00044cf0: 6172 7922 290a 2020 2020 2020 2020 636f  ary").        co
+00044d00: 6d70 7574 6520 3d20 5461 6250 616e 656c  mpute = TabPanel
+00044d10: 2863 6869 6c64 3d63 6f6d 7075 7465 2c20  (child=compute, 
+00044d20: 7469 746c 653d 2257 6f72 6b65 7220 5072  title="Worker Pr
+00044d30: 6f66 696c 6520 2863 6f6d 7075 7465 2922  ofile (compute)"
+00044d40: 290a 2020 2020 2020 2020 776f 726b 6572  ).        worker
 00044d50: 7320 3d20 5461 6250 616e 656c 2863 6869  s = TabPanel(chi
-00044d60: 6c64 3d6c 6f67 732e 726f 6f74 2c20 7469  ld=logs.root, ti
-00044d70: 746c 653d 2253 6368 6564 756c 6572 204c  tle="Scheduler L
-00044d80: 6f67 7322 290a 0a20 2020 2020 2020 2074  ogs")..        t
-00044d90: 6162 7320 3d20 5461 6273 280a 2020 2020  abs = Tabs(.    
-00044da0: 2020 2020 2020 2020 7461 6273 3d5b 0a20          tabs=[. 
-00044db0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00044dc0: 746d 6c2c 0a20 2020 2020 2020 2020 2020  tml,.           
-00044dd0: 2020 2020 2074 6173 6b5f 7374 7265 616d       task_stream
-00044de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00044df0: 2020 7379 7374 656d 2c0a 2020 2020 2020    system,.      
-00044e00: 2020 2020 2020 2020 2020 6c6f 6773 2c0a            logs,.
-00044e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044e20: 636f 6d70 7574 652c 0a20 2020 2020 2020  compute,.       
-00044e30: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00044e40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00044e50: 2020 7363 6865 6475 6c65 722c 0a20 2020    scheduler,.   
-00044e60: 2020 2020 2020 2020 2020 2020 2062 616e               ban
-00044e70: 6477 6964 7468 5f77 6f72 6b65 7273 2c0a  dwidth_workers,.
-00044e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044e90: 6261 6e64 7769 6474 685f 7479 7065 732c  bandwidth_types,
-00044ea0: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-00044eb0: 2020 2020 2020 2020 2020 2020 7369 7a69              sizi
-00044ec0: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00044ed0: 5f62 6f74 6822 2c0a 2020 2020 2020 2020  _both",.        
-00044ee0: 290a 0a20 2020 2020 2020 2066 726f 6d20  )..        from 
-00044ef0: 626f 6b65 682e 636f 7265 2e74 656d 706c  bokeh.core.templ
-00044f00: 6174 6573 2069 6d70 6f72 7420 6765 745f  ates import get_
-00044f10: 656e 760a 2020 2020 2020 2020 6672 6f6d  env.        from
-00044f20: 2062 6f6b 6568 2e70 6c6f 7474 696e 6720   bokeh.plotting 
-00044f30: 696d 706f 7274 206f 7574 7075 745f 6669  import output_fi
-00044f40: 6c65 2c20 7361 7665 0a0a 2020 2020 2020  le, save..      
-00044f50: 2020 7769 7468 2074 6d70 6669 6c65 2865    with tmpfile(e
-00044f60: 7874 656e 7369 6f6e 3d22 2e68 746d 6c22  xtension=".html"
-00044f70: 2920 6173 2066 6e3a 0a20 2020 2020 2020  ) as fn:.       
-00044f80: 2020 2020 206f 7574 7075 745f 6669 6c65       output_file
-00044f90: 2866 696c 656e 616d 653d 666e 2c20 7469  (filename=fn, ti
-00044fa0: 746c 653d 2244 6173 6b20 5065 7266 6f72  tle="Dask Perfor
-00044fb0: 6d61 6e63 6520 5265 706f 7274 222c 206d  mance Report", m
-00044fc0: 6f64 653d 6d6f 6465 290a 2020 2020 2020  ode=mode).      
-00044fd0: 2020 2020 2020 7465 6d70 6c61 7465 5f64        template_d
-00044fe0: 6972 6563 746f 7279 203d 206f 732e 7061  irectory = os.pa
-00044ff0: 7468 2e6a 6f69 6e28 0a20 2020 2020 2020  th.join(.       
-00045000: 2020 2020 2020 2020 206f 732e 7061 7468           os.path
-00045010: 2e64 6972 6e61 6d65 286f 732e 7061 7468  .dirname(os.path
-00045020: 2e61 6273 7061 7468 285f 5f66 696c 655f  .abspath(__file_
-00045030: 5f29 292c 2022 6461 7368 626f 6172 6422  _)), "dashboard"
-00045040: 2c20 2274 656d 706c 6174 6573 220a 2020  , "templates".  
-00045050: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00045060: 2020 2020 2020 2020 7465 6d70 6c61 7465          template
-00045070: 5f65 6e76 6972 6f6e 6d65 6e74 203d 2067  _environment = g
-00045080: 6574 5f65 6e76 2829 0a20 2020 2020 2020  et_env().       
-00045090: 2020 2020 2074 656d 706c 6174 655f 656e       template_en
-000450a0: 7669 726f 6e6d 656e 742e 6c6f 6164 6572  vironment.loader
-000450b0: 2e73 6561 7263 6870 6174 682e 6170 7065  .searchpath.appe
-000450c0: 6e64 2874 656d 706c 6174 655f 6469 7265  nd(template_dire
-000450d0: 6374 6f72 7929 0a20 2020 2020 2020 2020  ctory).         
-000450e0: 2020 2074 656d 706c 6174 6520 3d20 7465     template = te
-000450f0: 6d70 6c61 7465 5f65 6e76 6972 6f6e 6d65  mplate_environme
-00045100: 6e74 2e67 6574 5f74 656d 706c 6174 6528  nt.get_template(
-00045110: 2270 6572 666f 726d 616e 6365 5f72 6570  "performance_rep
-00045120: 6f72 742e 6874 6d6c 2229 0a20 2020 2020  ort.html").     
-00045130: 2020 2020 2020 2073 6176 6528 7461 6273         save(tabs
-00045140: 2c20 6669 6c65 6e61 6d65 3d66 6e2c 2074  , filename=fn, t
-00045150: 656d 706c 6174 653d 7465 6d70 6c61 7465  emplate=template
-00045160: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
-00045170: 6974 6820 6f70 656e 2866 6e29 2061 7320  ith open(fn) as 
-00045180: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-00045190: 2020 2064 6174 6120 3d20 662e 7265 6164     data = f.read
-000451a0: 2829 0a0a 2020 2020 2020 2020 7265 7475  ()..        retu
-000451b0: 726e 2064 6174 610a 0a20 2020 2061 7379  rn data..    asy
-000451c0: 6e63 2064 6566 2067 6574 5f77 6f72 6b65  nc def get_worke
-000451d0: 725f 6c6f 6773 2873 656c 662c 206e 3d4e  r_logs(self, n=N
-000451e0: 6f6e 652c 2077 6f72 6b65 7273 3d4e 6f6e  one, workers=Non
-000451f0: 652c 206e 616e 6e79 3d46 616c 7365 293a  e, nanny=False):
-00045200: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-00045210: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
-00045220: 6f61 6463 6173 7428 0a20 2020 2020 2020  oadcast(.       
-00045230: 2020 2020 206d 7367 3d7b 226f 7022 3a20       msg={"op": 
-00045240: 2267 6574 5f6c 6f67 7322 2c20 226e 223a  "get_logs", "n":
-00045250: 206e 7d2c 2077 6f72 6b65 7273 3d77 6f72   n}, workers=wor
-00045260: 6b65 7273 2c20 6e61 6e6e 793d 6e61 6e6e  kers, nanny=nann
-00045270: 790a 2020 2020 2020 2020 290a 2020 2020  y.        ).    
-00045280: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00045290: 7473 0a0a 2020 2020 6465 6620 6c6f 675f  ts..    def log_
-000452a0: 6576 656e 7428 7365 6c66 2c20 746f 7069  event(self, topi
-000452b0: 633a 2073 7472 207c 2043 6f6c 6c65 6374  c: str | Collect
-000452c0: 696f 6e5b 7374 725d 2c20 6d73 673a 2041  ion[str], msg: A
-000452d0: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-000452e0: 2020 2020 2022 2222 4c6f 6720 616e 2065       """Log an e
-000452f0: 7665 6e74 2075 6e64 6572 2061 2067 6976  vent under a giv
-00045300: 656e 2074 6f70 6963 0a0a 2020 2020 2020  en topic..      
-00045310: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00045320: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
-00045330: 2020 2020 2020 2020 746f 7069 6320 3a20          topic : 
-00045340: 7374 722c 206c 6973 745b 7374 725d 0a20  str, list[str]. 
-00045350: 2020 2020 2020 2020 2020 204e 616d 6520             Name 
-00045360: 6f66 2074 6865 2074 6f70 6963 2075 6e64  of the topic und
-00045370: 6572 2077 6869 6368 2074 6f20 6c6f 6720  er which to log 
-00045380: 616e 2065 7665 6e74 2e20 546f 206c 6f67  an event. To log
-00045390: 2074 6865 2073 616d 650a 2020 2020 2020   the same.      
-000453a0: 2020 2020 2020 6576 656e 7420 756e 6465        event unde
-000453b0: 7220 6d75 6c74 6970 6c65 2074 6f70 6963  r multiple topic
-000453c0: 732c 2070 6173 7320 6120 6c69 7374 206f  s, pass a list o
-000453d0: 6620 746f 7069 6320 6e61 6d65 732e 0a20  f topic names.. 
-000453e0: 2020 2020 2020 206d 7367 0a20 2020 2020         msg.     
-000453f0: 2020 2020 2020 2045 7665 6e74 206d 6573         Event mes
-00045400: 7361 6765 2074 6f20 6c6f 672e 204e 6f74  sage to log. Not
-00045410: 6520 7468 6973 206d 7573 7420 6265 206d  e this must be m
-00045420: 7367 7061 636b 2073 6572 6961 6c69 7a61  sgpack serializa
-00045430: 626c 652e 0a0a 2020 2020 2020 2020 5365  ble...        Se
-00045440: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-00045450: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00045460: 436c 6965 6e74 2e6c 6f67 5f65 7665 6e74  Client.log_event
-00045470: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00045480: 2020 2020 2065 7665 6e74 203d 2028 7469       event = (ti
-00045490: 6d65 2829 2c20 6d73 6729 0a20 2020 2020  me(), msg).     
-000454a0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-000454b0: 616e 6365 2874 6f70 6963 2c20 7374 7229  ance(topic, str)
-000454c0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-000454d0: 7220 7420 696e 2074 6f70 6963 3a0a 2020  r t in topic:.  
-000454e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000454f0: 6c66 2e65 7665 6e74 735b 745d 2e61 7070  lf.events[t].app
-00045500: 656e 6428 6576 656e 7429 0a20 2020 2020  end(event).     
-00045510: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00045520: 6576 656e 745f 636f 756e 7473 5b74 5d20  event_counts[t] 
-00045530: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-00045540: 2020 2020 2073 656c 662e 5f72 6570 6f72       self._repor
-00045550: 745f 6576 656e 7428 742c 2065 7665 6e74  t_event(t, event
-00045560: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00045570: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00045580: 2e65 7665 6e74 735b 746f 7069 635d 2e61  .events[topic].a
-00045590: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
-000455a0: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
-000455b0: 656e 745f 636f 756e 7473 5b74 6f70 6963  ent_counts[topic
-000455c0: 5d20 2b3d 2031 0a20 2020 2020 2020 2020  ] += 1.         
-000455d0: 2020 2073 656c 662e 5f72 6570 6f72 745f     self._report_
-000455e0: 6576 656e 7428 746f 7069 632c 2065 7665  event(topic, eve
-000455f0: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
-00045600: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
-00045610: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
-00045620: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
-00045630: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00045640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045650: 2020 2020 2070 6c75 6769 6e2e 6c6f 675f       plugin.log_
-00045660: 6576 656e 7428 746f 7069 632c 206d 7367  event(topic, msg
-00045670: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00045680: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00045690: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-000456a0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-000456b0: 6e66 6f28 2250 6c75 6769 6e20 6661 696c  nfo("Plugin fail
-000456c0: 6564 2077 6974 6820 6578 6365 7074 696f  ed with exceptio
-000456d0: 6e22 2c20 6578 635f 696e 666f 3d54 7275  n", exc_info=Tru
-000456e0: 6529 0a0a 2020 2020 6465 6620 5f72 6570  e)..    def _rep
-000456f0: 6f72 745f 6576 656e 7428 7365 6c66 2c20  ort_event(self, 
-00045700: 6e61 6d65 2c20 6576 656e 7429 3a0a 2020  name, event):.  
-00045710: 2020 2020 2020 6d73 6720 3d20 7b0a 2020        msg = {.  
-00045720: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-00045730: 2265 7665 6e74 222c 0a20 2020 2020 2020  "event",.       
-00045740: 2020 2020 2022 746f 7069 6322 3a20 6e61       "topic": na
-00045750: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00045760: 2265 7665 6e74 223a 2065 7665 6e74 2c0a  "event": event,.
-00045770: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00045780: 2020 636c 6965 6e74 5f6d 7367 7320 3d20    client_msgs = 
-00045790: 7b63 6c69 656e 743a 205b 6d73 675d 2066  {client: [msg] f
-000457a0: 6f72 2063 6c69 656e 7420 696e 2073 656c  or client in sel
-000457b0: 662e 6576 656e 745f 7375 6273 6372 6962  f.event_subscrib
-000457c0: 6572 5b6e 616d 655d 7d0a 2020 2020 2020  er[name]}.      
-000457d0: 2020 7365 6c66 2e73 656e 645f 616c 6c28    self.send_all(
-000457e0: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-000457f0: 6b65 725f 6d73 6773 3d7b 7d29 0a0a 2020  ker_msgs={})..  
-00045800: 2020 6465 6620 7375 6273 6372 6962 655f    def subscribe_
-00045810: 746f 7069 6328 7365 6c66 2c20 746f 7069  topic(self, topi
-00045820: 632c 2063 6c69 656e 7429 3a0a 2020 2020  c, client):.    
-00045830: 2020 2020 7365 6c66 2e65 7665 6e74 5f73      self.event_s
-00045840: 7562 7363 7269 6265 725b 746f 7069 635d  ubscriber[topic]
-00045850: 2e61 6464 2863 6c69 656e 7429 0a0a 2020  .add(client)..  
-00045860: 2020 6465 6620 756e 7375 6273 6372 6962    def unsubscrib
-00045870: 655f 746f 7069 6328 7365 6c66 2c20 746f  e_topic(self, to
-00045880: 7069 632c 2063 6c69 656e 7429 3a0a 2020  pic, client):.  
-00045890: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-000458a0: 5f73 7562 7363 7269 6265 725b 746f 7069  _subscriber[topi
-000458b0: 635d 2e64 6973 6361 7264 2863 6c69 656e  c].discard(clien
-000458c0: 7429 0a0a 2020 2020 6465 6620 6765 745f  t)..    def get_
-000458d0: 6576 656e 7473 2873 656c 662c 2074 6f70  events(self, top
-000458e0: 6963 3d4e 6f6e 6529 3a0a 2020 2020 2020  ic=None):.      
-000458f0: 2020 6966 2074 6f70 6963 2069 7320 6e6f    if topic is no
-00045900: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00045910: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
-00045920: 2873 656c 662e 6576 656e 7473 5b74 6f70  (self.events[top
-00045930: 6963 5d29 0a20 2020 2020 2020 2065 6c73  ic]).        els
-00045940: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00045950: 6574 7572 6e20 7661 6c6d 6170 2874 7570  eturn valmap(tup
-00045960: 6c65 2c20 7365 6c66 2e65 7665 6e74 7329  le, self.events)
-00045970: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00045980: 6765 745f 776f 726b 6572 5f6d 6f6e 6974  get_worker_monit
-00045990: 6f72 5f69 6e66 6f28 7365 6c66 2c20 7265  or_info(self, re
-000459a0: 6365 6e74 3d46 616c 7365 2c20 7374 6172  cent=False, star
-000459b0: 7473 3d4e 6f6e 6529 3a0a 2020 2020 2020  ts=None):.      
-000459c0: 2020 6966 2073 7461 7274 7320 6973 204e    if starts is N
-000459d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000459e0: 2073 7461 7274 7320 3d20 7b7d 0a20 2020   starts = {}.   
-000459f0: 2020 2020 2072 6573 756c 7473 203d 2061       results = a
-00045a00: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00045a10: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00045a20: 202a 280a 2020 2020 2020 2020 2020 2020   *(.            
-00045a30: 2020 2020 7365 6c66 2e72 7063 2877 292e      self.rpc(w).
-00045a40: 6765 745f 6d6f 6e69 746f 725f 696e 666f  get_monitor_info
-00045a50: 2872 6563 656e 743d 7265 6365 6e74 2c20  (recent=recent, 
-00045a60: 7374 6172 743d 7374 6172 7473 2e67 6574  start=starts.get
-00045a70: 2877 2c20 3029 290a 2020 2020 2020 2020  (w, 0)).        
-00045a80: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
-00045a90: 2073 656c 662e 776f 726b 6572 730a 2020   self.workers.  
-00045aa0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00045ab0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00045ac0: 7475 726e 2064 6963 7428 7a69 7028 7365  turn dict(zip(se
-00045ad0: 6c66 2e77 6f72 6b65 7273 2c20 7265 7375  lf.workers, resu
-00045ae0: 6c74 7329 290a 0a20 2020 2023 2323 2323  lts))..    #####
-00045af0: 2323 2323 2323 0a20 2020 2023 2043 6c65  ######.    # Cle
-00045b00: 616e 7570 2023 0a20 2020 2023 2323 2323  anup #.    #####
-00045b10: 2323 2323 2323 0a0a 2020 2020 6173 796e  ######..    asyn
-00045b20: 6320 6465 6620 6368 6563 6b5f 776f 726b  c def check_work
-00045b30: 6572 5f74 746c 2873 656c 6629 3a0a 2020  er_ttl(self):.  
-00045b40: 2020 2020 2020 6e6f 7720 3d20 7469 6d65        now = time
-00045b50: 2829 0a20 2020 2020 2020 2073 7469 6d75  ().        stimu
-00045b60: 6c75 735f 6964 203d 2066 2263 6865 636b  lus_id = f"check
-00045b70: 2d77 6f72 6b65 722d 7474 6c2d 7b6e 6f77  -worker-ttl-{now
-00045b80: 7d22 0a20 2020 2020 2020 2066 6f72 2077  }".        for w
-00045b90: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-00045ba0: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
-00045bb0: 2020 2020 2020 2020 6966 2028 7773 2e6c          if (ws.l
-00045bc0: 6173 745f 7365 656e 203c 206e 6f77 202d  ast_seen < now -
-00045bd0: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
-00045be0: 2920 616e 6420 280a 2020 2020 2020 2020  ) and (.        
-00045bf0: 2020 2020 2020 2020 7773 2e6c 6173 745f          ws.last_
-00045c00: 7365 656e 203c 206e 6f77 202d 2031 3020  seen < now - 10 
-00045c10: 2a20 6865 6172 7462 6561 745f 696e 7465  * heartbeat_inte
-00045c20: 7276 616c 286c 656e 2873 656c 662e 776f  rval(len(self.wo
-00045c30: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
-00045c40: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00045c50: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00045c60: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
-00045c70: 2020 2020 2020 2020 2020 2022 576f 726b             "Work
-00045c80: 6572 2066 6169 6c65 6420 746f 2068 6561  er failed to hea
-00045c90: 7274 6265 6174 2077 6974 6869 6e20 2573  rtbeat within %s
-00045ca0: 2073 6563 6f6e 6473 2e20 436c 6f73 696e   seconds. Closin
-00045cb0: 673a 2025 7322 2c0a 2020 2020 2020 2020  g: %s",.        
-00045cc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00045cd0: 2e77 6f72 6b65 725f 7474 6c2c 0a20 2020  .worker_ttl,.   
-00045ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045cf0: 2077 732c 0a20 2020 2020 2020 2020 2020   ws,.           
-00045d00: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00045d10: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-00045d20: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
-00045d30: 6164 6472 6573 733d 7773 2e61 6464 7265  address=ws.addre
-00045d40: 7373 2c20 7374 696d 756c 7573 5f69 643d  ss, stimulus_id=
-00045d50: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-00045d60: 2020 6465 6620 6368 6563 6b5f 6964 6c65    def check_idle
-00045d70: 2873 656c 6629 202d 3e20 666c 6f61 7420  (self) -> float 
-00045d80: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
-00045d90: 6966 2073 656c 662e 7374 6174 7573 2069  if self.status i
-00045da0: 6e20 2853 7461 7475 732e 636c 6f73 696e  n (Status.closin
-00045db0: 672c 2053 7461 7475 732e 636c 6f73 6564  g, Status.closed
-00045dc0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00045dd0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-00045de0: 2020 2020 6966 2073 656c 662e 7472 616e      if self.tran
-00045df0: 7369 7469 6f6e 5f63 6f75 6e74 6572 2021  sition_counter !
-00045e00: 3d20 7365 6c66 2e5f 6964 6c65 5f74 7261  = self._idle_tra
-00045e10: 6e73 6974 696f 6e5f 636f 756e 7465 723a  nsition_counter:
-00045e20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00045e30: 662e 5f69 646c 655f 7472 616e 7369 7469  f._idle_transiti
-00045e40: 6f6e 5f63 6f75 6e74 6572 203d 2073 656c  on_counter = sel
-00045e50: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-00045e60: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
-00045e70: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-00045e80: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00045e90: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00045ea0: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
-00045eb0: 2020 2020 2020 2020 2020 7365 6c66 2e71            self.q
-00045ec0: 7565 7565 640a 2020 2020 2020 2020 2020  ueued.          
-00045ed0: 2020 6f72 2073 656c 662e 756e 7275 6e6e    or self.unrunn
-00045ee0: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
-00045ef0: 206f 7220 616e 7928 7773 2e70 726f 6365   or any(ws.proce
-00045f00: 7373 696e 6720 666f 7220 7773 2069 6e20  ssing for ws in 
-00045f10: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-00045f20: 7565 7328 2929 0a20 2020 2020 2020 2029  ues()).        )
-00045f30: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00045f40: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
-00045f50: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00045f60: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-00045f70: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00045f80: 662e 6964 6c65 5f73 696e 6365 3a0a 2020  f.idle_since:.  
-00045f90: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-00045fa0: 646c 655f 7369 6e63 6520 3d20 7469 6d65  dle_since = time
-00045fb0: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-00045fc0: 6574 7572 6e20 7365 6c66 2e69 646c 655f  eturn self.idle_
-00045fd0: 7369 6e63 650a 0a20 2020 2020 2020 2069  since..        i
-00045fe0: 6620 7365 6c66 2e6a 7570 7974 6572 3a0a  f self.jupyter:.
-00045ff0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-00046000: 5f61 6374 6976 6974 7920 3d20 280a 2020  _activity = (.  
-00046010: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00046020: 6c66 2e5f 6a75 7079 7465 725f 7365 7276  lf._jupyter_serv
-00046030: 6572 5f61 7070 6c69 6361 7469 6f6e 2e77  er_application.w
-00046040: 6562 5f61 7070 2e6c 6173 745f 6163 7469  eb_app.last_acti
-00046050: 7669 7479 2829 2e74 696d 6573 7461 6d70  vity().timestamp
-00046060: 2829 0a20 2020 2020 2020 2020 2020 2029  ().            )
-00046070: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00046080: 6c61 7374 5f61 6374 6976 6974 7920 3e20  last_activity > 
-00046090: 7365 6c66 2e69 646c 655f 7369 6e63 653a  self.idle_since:
-000460a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000460b0: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-000460c0: 203d 206c 6173 745f 6163 7469 7669 7479   = last_activity
-000460d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000460e0: 2072 6574 7572 6e20 7365 6c66 2e69 646c   return self.idl
-000460f0: 655f 7369 6e63 650a 0a20 2020 2020 2020  e_since..       
-00046100: 2069 6620 7365 6c66 2e69 646c 655f 7469   if self.idle_ti
-00046110: 6d65 6f75 743a 0a20 2020 2020 2020 2020  meout:.         
-00046120: 2020 2069 6620 7469 6d65 2829 203e 2073     if time() > s
-00046130: 656c 662e 6964 6c65 5f73 696e 6365 202b  elf.idle_since +
-00046140: 2073 656c 662e 6964 6c65 5f74 696d 656f   self.idle_timeo
-00046150: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-00046160: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-00046170: 6964 6c65 5f73 696e 6365 0a20 2020 2020  idle_since.     
-00046180: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00046190: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
-000461a0: 2020 2020 2020 2020 2020 2020 2253 6368              "Sch
-000461b0: 6564 756c 6572 2063 6c6f 7369 6e67 2061  eduler closing a
-000461c0: 6674 6572 2062 6569 6e67 2069 646c 6520  fter being idle 
-000461d0: 666f 7220 2573 222c 0a20 2020 2020 2020  for %s",.       
-000461e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000461f0: 6d61 745f 7469 6d65 2873 656c 662e 6964  mat_time(self.id
-00046200: 6c65 5f74 696d 656f 7574 292c 0a20 2020  le_timeout),.   
-00046210: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00046220: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00046230: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
-00046240: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
-00046250: 6c6c 5f73 6f6f 6e28 7365 6c66 2e63 6c6f  ll_soon(self.clo
-00046260: 7365 290a 2020 2020 2020 2020 7265 7475  se).        retu
-00046270: 726e 2073 656c 662e 6964 6c65 5f73 696e  rn self.idle_sin
-00046280: 6365 0a0a 2020 2020 6465 6620 6164 6170  ce..    def adap
-00046290: 7469 7665 5f74 6172 6765 7428 7365 6c66  tive_target(self
-000462a0: 2c20 7461 7267 6574 5f64 7572 6174 696f  , target_duratio
-000462b0: 6e3d 4e6f 6e65 293a 0a20 2020 2020 2020  n=None):.       
-000462c0: 2022 2222 4465 7369 7265 6420 6e75 6d62   """Desired numb
-000462d0: 6572 206f 6620 776f 726b 6572 7320 6261  er of workers ba
-000462e0: 7365 6420 6f6e 2074 6865 2063 7572 7265  sed on the curre
-000462f0: 6e74 2077 6f72 6b6c 6f61 640a 0a20 2020  nt workload..   
-00046300: 2020 2020 2054 6869 7320 6c6f 6f6b 7320       This looks 
-00046310: 6174 2074 6865 2063 7572 7265 6e74 2072  at the current r
-00046320: 756e 6e69 6e67 2074 6173 6b73 2061 6e64  unning tasks and
-00046330: 206d 656d 6f72 7920 7573 652c 2061 6e64   memory use, and
-00046340: 2072 6574 7572 6e73 2061 0a20 2020 2020   returns a.     
-00046350: 2020 206e 756d 6265 7220 6f66 2064 6573     number of des
-00046360: 6972 6564 2077 6f72 6b65 7273 2e20 2054  ired workers.  T
-00046370: 6869 7320 6973 206f 6674 656e 2075 7365  his is often use
-00046380: 6420 6279 2061 6461 7074 6976 6520 7363  d by adaptive sc
-00046390: 6865 6475 6c69 6e67 2e0a 0a20 2020 2020  heduling...     
-000463a0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-000463b0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-000463c0: 0a20 2020 2020 2020 2074 6172 6765 745f  .        target_
-000463d0: 6475 7261 7469 6f6e 203a 2073 7472 0a20  duration : str. 
-000463e0: 2020 2020 2020 2020 2020 2041 2064 6573             A des
-000463f0: 6972 6564 2064 7572 6174 696f 6e20 6f66  ired duration of
-00046400: 2074 696d 6520 666f 7220 636f 6d70 7574   time for comput
-00046410: 6174 696f 6e73 2074 6f20 7461 6b65 2e20  ations to take. 
-00046420: 2054 6869 7320 6166 6665 6374 730a 2020   This affects.  
-00046430: 2020 2020 2020 2020 2020 686f 7720 7261            how ra
-00046440: 7069 646c 7920 7468 6520 7363 6865 6475  pidly the schedu
-00046450: 6c65 7220 7769 6c6c 2061 736b 2074 6f20  ler will ask to 
-00046460: 7363 616c 652e 0a0a 2020 2020 2020 2020  scale...        
-00046470: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
-00046480: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-00046490: 2020 6469 7374 7269 6275 7465 642e 6465    distributed.de
-000464a0: 706c 6f79 2e41 6461 7074 6976 650a 2020  ploy.Adaptive.  
-000464b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000464c0: 2020 6966 2074 6172 6765 745f 6475 7261    if target_dura
-000464d0: 7469 6f6e 2069 7320 4e6f 6e65 3a0a 2020  tion is None:.  
-000464e0: 2020 2020 2020 2020 2020 7461 7267 6574            target
-000464f0: 5f64 7572 6174 696f 6e20 3d20 6461 736b  _duration = dask
-00046500: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-00046510: 7472 6962 7574 6564 2e61 6461 7074 6976  tributed.adaptiv
-00046520: 652e 7461 7267 6574 2d64 7572 6174 696f  e.target-duratio
-00046530: 6e22 290a 2020 2020 2020 2020 7461 7267  n").        targ
-00046540: 6574 5f64 7572 6174 696f 6e20 3d20 7061  et_duration = pa
-00046550: 7273 655f 7469 6d65 6465 6c74 6128 7461  rse_timedelta(ta
-00046560: 7267 6574 5f64 7572 6174 696f 6e29 0a0a  rget_duration)..
-00046570: 2020 2020 2020 2020 2320 4350 550a 0a20          # CPU.. 
-00046580: 2020 2020 2020 2023 2054 4f44 4f20 636f         # TODO co
-00046590: 6e73 6964 6572 2061 6e79 2075 7365 722d  nsider any user-
-000465a0: 7370 6563 6966 6965 6420 6465 6661 756c  specified defaul
-000465b0: 7420 7461 736b 2064 7572 6174 696f 6e73  t task durations
-000465c0: 2066 6f72 2071 7565 7565 6420 7461 736b   for queued task
-000465d0: 730a 2020 2020 2020 2020 7175 6575 6564  s.        queued
-000465e0: 5f6f 6363 7570 616e 6379 203d 206c 656e  _occupancy = len
-000465f0: 2873 656c 662e 7175 6575 6564 2920 2a20  (self.queued) * 
-00046600: 7365 6c66 2e55 4e4b 4e4f 574e 5f54 4153  self.UNKNOWN_TAS
-00046610: 4b5f 4455 5241 5449 4f4e 0a20 2020 2020  K_DURATION.     
-00046620: 2020 2063 7075 203d 206d 6174 682e 6365     cpu = math.ce
-00046630: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
-00046640: 2873 656c 662e 746f 7461 6c5f 6f63 6375  (self.total_occu
-00046650: 7061 6e63 7920 2b20 7175 6575 6564 5f6f  pancy + queued_o
-00046660: 6363 7570 616e 6379 2920 2f20 7461 7267  ccupancy) / targ
-00046670: 6574 5f64 7572 6174 696f 6e0a 2020 2020  et_duration.    
-00046680: 2020 2020 2920 2023 2054 4f44 4f3a 2074      )  # TODO: t
-00046690: 6872 6561 6473 2070 6572 2077 6f72 6b65  hreads per worke
-000466a0: 720a 0a20 2020 2020 2020 2023 2041 766f  r..        # Avo
-000466b0: 6964 2061 2066 6577 206c 6f6e 6720 7461  id a few long ta
-000466c0: 736b 7320 6672 6f6d 2061 736b 696e 6720  sks from asking 
-000466d0: 666f 7220 6d61 6e79 2063 6f72 6573 0a20  for many cores. 
-000466e0: 2020 2020 2020 2074 6173 6b73 5f72 6561         tasks_rea
-000466f0: 6479 203d 206c 656e 2873 656c 662e 7175  dy = len(self.qu
-00046700: 6575 6564 290a 2020 2020 2020 2020 666f  eued).        fo
-00046710: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
-00046720: 6b65 7273 2e76 616c 7565 7328 293a 0a20  kers.values():. 
-00046730: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-00046740: 5f72 6561 6479 202b 3d20 6c65 6e28 7773  _ready += len(ws
-00046750: 2e70 726f 6365 7373 696e 6729 0a0a 2020  .processing)..  
-00046760: 2020 2020 2020 2020 2020 6966 2074 6173            if tas
-00046770: 6b73 5f72 6561 6479 203e 2063 7075 3a0a  ks_ready > cpu:.
-00046780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046790: 6272 6561 6b0a 2020 2020 2020 2020 656c  break.        el
-000467a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000467b0: 6370 7520 3d20 6d69 6e28 7461 736b 735f  cpu = min(tasks_
-000467c0: 7265 6164 792c 2063 7075 290a 0a20 2020  ready, cpu)..   
-000467d0: 2020 2020 2069 6620 2873 656c 662e 756e       if (self.un
-000467e0: 7275 6e6e 6162 6c65 206f 7220 7365 6c66  runnable or self
-000467f0: 2e71 7565 7565 6429 2061 6e64 206e 6f74  .queued) and not
-00046800: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
-00046810: 2020 2020 2020 2020 2020 2063 7075 203d             cpu =
-00046820: 206d 6178 2831 2c20 6370 7529 0a0a 2020   max(1, cpu)..  
-00046830: 2020 2020 2020 2320 6164 6420 6d6f 7265        # add more
-00046840: 2077 6f72 6b65 7273 2069 6620 6d6f 7265   workers if more
-00046850: 2074 6861 6e20 3630 2520 6f66 206d 656d   than 60% of mem
-00046860: 6f72 7920 6973 2075 7365 640a 2020 2020  ory is used.    
-00046870: 2020 2020 6c69 6d69 7420 3d20 7375 6d28      limit = sum(
-00046880: 7773 2e6d 656d 6f72 795f 6c69 6d69 7420  ws.memory_limit 
-00046890: 666f 7220 7773 2069 6e20 7365 6c66 2e77  for ws in self.w
-000468a0: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
-000468b0: 0a20 2020 2020 2020 2075 7365 6420 3d20  .        used = 
-000468c0: 7375 6d28 7773 2e6e 6279 7465 7320 666f  sum(ws.nbytes fo
-000468d0: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
-000468e0: 6b65 7273 2e76 616c 7565 7328 2929 0a20  kers.values()). 
-000468f0: 2020 2020 2020 206d 656d 6f72 7920 3d20         memory = 
-00046900: 300a 2020 2020 2020 2020 6966 2075 7365  0.        if use
-00046910: 6420 3e20 302e 3620 2a20 6c69 6d69 7420  d > 0.6 * limit 
-00046920: 616e 6420 6c69 6d69 7420 3e20 303a 0a20  and limit > 0:. 
-00046930: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-00046940: 7920 3d20 3220 2a20 6c65 6e28 7365 6c66  y = 2 * len(self
-00046950: 2e77 6f72 6b65 7273 290a 0a20 2020 2020  .workers)..     
-00046960: 2020 2074 6172 6765 7420 3d20 6d61 7828     target = max(
-00046970: 6d65 6d6f 7279 2c20 6370 7529 0a20 2020  memory, cpu).   
-00046980: 2020 2020 2069 6620 7461 7267 6574 203e       if target >
-00046990: 3d20 6c65 6e28 7365 6c66 2e77 6f72 6b65  = len(self.worke
-000469a0: 7273 293a 0a20 2020 2020 2020 2020 2020  rs):.           
-000469b0: 2072 6574 7572 6e20 7461 7267 6574 0a20   return target. 
-000469c0: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
-000469d0: 5363 616c 6520 646f 776e 3f0a 2020 2020  Scale down?.    
-000469e0: 2020 2020 2020 2020 746f 5f63 6c6f 7365          to_close
-000469f0: 203d 2073 656c 662e 776f 726b 6572 735f   = self.workers_
-00046a00: 746f 5f63 6c6f 7365 2829 0a20 2020 2020  to_close().     
-00046a10: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
-00046a20: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-00046a30: 2d20 6c65 6e28 746f 5f63 6c6f 7365 290a  - len(to_close).
-00046a40: 0a20 2020 2064 6566 2072 6571 7565 7374  .    def request
-00046a50: 5f61 6371 7569 7265 5f72 6570 6c69 6361  _acquire_replica
-00046a60: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-00046a70: 2061 6464 723a 2073 7472 2c20 6b65 7973   addr: str, keys
-00046a80: 3a20 4974 6572 6162 6c65 5b73 7472 5d2c  : Iterable[str],
-00046a90: 202a 2c20 7374 696d 756c 7573 5f69 643a   *, stimulus_id:
-00046aa0: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
-00046ab0: 6e65 3a0a 2020 2020 2020 2020 2222 2241  ne:.        """A
-00046ac0: 7379 6e63 6872 6f6e 6f75 736c 7920 6173  synchronously as
-00046ad0: 6b20 6120 776f 726b 6572 2074 6f20 6163  k a worker to ac
-00046ae0: 7175 6972 6520 6120 7265 706c 6963 6120  quire a replica 
-00046af0: 6f66 2074 6865 206c 6973 7465 6420 6b65  of the listed ke
-00046b00: 7973 2066 726f 6d0a 2020 2020 2020 2020  ys from.        
-00046b10: 6f74 6865 7220 776f 726b 6572 732e 2054  other workers. T
-00046b20: 6869 7320 6973 2061 2066 6972 652d 616e  his is a fire-an
-00046b30: 642d 666f 7267 6574 206f 7065 7261 7469  d-forget operati
-00046b40: 6f6e 2077 6869 6368 206f 6666 6572 7320  on which offers 
-00046b50: 6e6f 2066 6565 6462 6163 6b20 666f 720a  no feedback for.
-00046b60: 2020 2020 2020 2020 7375 6363 6573 7320          success 
-00046b70: 6f72 2066 6169 6c75 7265 2c20 616e 6420  or failure, and 
-00046b80: 6973 2069 6e74 656e 6465 6420 666f 7220  is intended for 
-00046b90: 686f 7573 656b 6565 7069 6e67 2061 6e64  housekeeping and
-00046ba0: 206e 6f74 2066 6f72 2063 6f6d 7075 7461   not for computa
-00046bb0: 7469 6f6e 2e0a 2020 2020 2020 2020 2222  tion..        ""
-00046bc0: 220a 2020 2020 2020 2020 7768 6f5f 6861  ".        who_ha
-00046bd0: 7320 3d20 7b7d 0a20 2020 2020 2020 206e  s = {}.        n
-00046be0: 6279 7465 7320 3d20 7b7d 0a20 2020 2020  bytes = {}.     
-00046bf0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
-00046c00: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00046c10: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00046c20: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-00046c30: 2061 7373 6572 7420 7473 2e77 686f 5f68   assert ts.who_h
-00046c40: 6173 0a20 2020 2020 2020 2020 2020 2077  as.            w
-00046c50: 686f 5f68 6173 5b6b 6579 5d20 3d20 5b77  ho_has[key] = [w
-00046c60: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
-00046c70: 2069 6e20 7473 2e77 686f 5f68 6173 5d0a   in ts.who_has].
-00046c80: 2020 2020 2020 2020 2020 2020 6e62 7974              nbyt
-00046c90: 6573 5b6b 6579 5d20 3d20 7473 2e6e 6279  es[key] = ts.nby
-00046ca0: 7465 730a 0a20 2020 2020 2020 2073 656c  tes..        sel
-00046cb0: 662e 7374 7265 616d 5f63 6f6d 6d73 5b61  f.stream_comms[a
-00046cc0: 6464 725d 2e73 656e 6428 0a20 2020 2020  ddr].send(.     
-00046cd0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00046ce0: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-00046cf0: 6163 7175 6972 652d 7265 706c 6963 6173  acquire-replicas
-00046d00: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00046d10: 2020 2022 7768 6f5f 6861 7322 3a20 7768     "who_has": wh
-00046d20: 6f5f 6861 732c 0a20 2020 2020 2020 2020  o_has,.         
-00046d30: 2020 2020 2020 2022 6e62 7974 6573 223a         "nbytes":
-00046d40: 206e 6279 7465 732c 0a20 2020 2020 2020   nbytes,.       
-00046d50: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-00046d60: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
-00046d70: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00046d80: 207d 2c0a 2020 2020 2020 2020 290a 0a20   },.        ).. 
-00046d90: 2020 2064 6566 2072 6571 7565 7374 5f72     def request_r
-00046da0: 656d 6f76 655f 7265 706c 6963 6173 280a  emove_replicas(.
-00046db0: 2020 2020 2020 2020 7365 6c66 2c20 6164          self, ad
-00046dc0: 6472 3a20 7374 722c 206b 6579 733a 206c  dr: str, keys: l
-00046dd0: 6973 745b 7374 725d 2c20 2a2c 2073 7469  ist[str], *, sti
-00046de0: 6d75 6c75 735f 6964 3a20 7374 720a 2020  mulus_id: str.  
-00046df0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00046e00: 2020 2020 2022 2222 4173 796e 6368 726f       """Asynchro
-00046e10: 6e6f 7573 6c79 2061 736b 2061 2077 6f72  nously ask a wor
-00046e20: 6b65 7220 746f 2064 6973 6361 7264 2069  ker to discard i
-00046e30: 7473 2072 6570 6c69 6361 206f 6620 7468  ts replica of th
-00046e40: 6520 6c69 7374 6564 206b 6579 732e 0a20  e listed keys.. 
-00046e50: 2020 2020 2020 2054 6869 7320 6d75 7374         This must
-00046e60: 206e 6576 6572 2062 6520 7573 6564 2074   never be used t
-00046e70: 6f20 6465 7374 726f 7920 7468 6520 6c61  o destroy the la
-00046e80: 7374 2072 6570 6c69 6361 206f 6620 6120  st replica of a 
-00046e90: 6b65 792e 2054 6869 7320 6973 2061 0a20  key. This is a. 
-00046ea0: 2020 2020 2020 2066 6972 652d 616e 642d         fire-and-
-00046eb0: 666f 7267 6574 206f 7065 7261 7469 6f6e  forget operation
-00046ec0: 2c20 696e 7465 6e64 6564 2066 6f72 2068  , intended for h
-00046ed0: 6f75 7365 6b65 6570 696e 6720 616e 6420  ousekeeping and 
-00046ee0: 6e6f 7420 666f 7220 636f 6d70 7574 6174  not for computat
-00046ef0: 696f 6e2e 0a0a 2020 2020 2020 2020 5468  ion...        Th
-00046f00: 6520 7265 706c 6963 6120 6469 7361 7070  e replica disapp
-00046f10: 6561 7273 2069 6d6d 6564 6961 7465 6c79  ears immediately
-00046f20: 2066 726f 6d20 5461 736b 5374 6174 652e   from TaskState.
-00046f30: 7768 6f5f 6861 7320 6f6e 2074 6865 2053  who_has on the S
-00046f40: 6368 6564 756c 6572 2073 6964 653b 0a20  cheduler side;. 
-00046f50: 2020 2020 2020 2069 6620 7468 6520 776f         if the wo
-00046f60: 726b 6572 2072 6566 7573 6573 2074 6f20  rker refuses to 
-00046f70: 6465 6c65 7465 2c20 652e 672e 2062 6563  delete, e.g. bec
-00046f80: 6175 7365 2074 6865 2074 6173 6b20 6973  ause the task is
-00046f90: 2061 2064 6570 656e 6465 6e63 7920 6f66   a dependency of
-00046fa0: 0a20 2020 2020 2020 2061 6e6f 7468 6572  .        another
-00046fb0: 2074 6173 6b20 7275 6e6e 696e 6720 6f6e   task running on
-00046fc0: 2069 742c 2069 7420 7769 6c6c 2028 616c   it, it will (al
-00046fd0: 736f 2061 7379 6e63 6872 6f6e 6f75 736c  so asynchronousl
-00046fe0: 7929 2069 6e66 6f72 6d20 7468 6520 7363  y) inform the sc
-00046ff0: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-00047000: 746f 2072 652d 6164 6420 6974 7365 6c66  to re-add itself
-00047010: 2074 6f20 7768 6f5f 6861 732e 2049 6620   to who_has. If 
-00047020: 7468 6520 776f 726b 6572 2061 6772 6565  the worker agree
-00047030: 7320 746f 2064 6973 6361 7264 2074 6865  s to discard the
-00047040: 2074 6173 6b2c 2074 6865 7265 2069 730a   task, there is.
-00047050: 2020 2020 2020 2020 6e6f 2066 6565 6462          no feedb
-00047060: 6163 6b2e 0a20 2020 2020 2020 2022 2222  ack..        """
-00047070: 0a20 2020 2020 2020 2077 7320 3d20 7365  .        ws = se
-00047080: 6c66 2e77 6f72 6b65 7273 5b61 6464 725d  lf.workers[addr]
-00047090: 0a0a 2020 2020 2020 2020 2320 5468 6520  ..        # The 
-000470a0: 7363 6865 6475 6c65 7220 696d 6d65 6469  scheduler immedi
-000470b0: 6174 656c 7920 666f 7267 6574 7320 6162  ately forgets ab
-000470c0: 6f75 7420 7468 6520 7265 706c 6963 6120  out the replica 
-000470d0: 616e 6420 7375 6767 6573 7473 2074 6865  and suggests the
-000470e0: 2077 6f72 6b65 7220 746f 0a20 2020 2020   worker to.     
-000470f0: 2020 2023 2064 726f 7020 6974 2e20 5468     # drop it. Th
-00047100: 6520 776f 726b 6572 206d 6179 2072 6566  e worker may ref
-00047110: 7573 652c 2061 7420 7768 6963 6820 706f  use, at which po
-00047120: 696e 7420 6974 2077 696c 6c20 7365 6e64  int it will send
-00047130: 2062 6163 6b20 616e 2061 6464 2d6b 6579   back an add-key
-00047140: 730a 2020 2020 2020 2020 2320 6d65 7373  s.        # mess
-00047150: 6167 6520 746f 2072 6569 6e73 7461 7465  age to reinstate
-00047160: 2069 742e 0a20 2020 2020 2020 2066 6f72   it..        for
-00047170: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
-00047180: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00047190: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-000471a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000471b0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-000471c0: 2020 2020 2020 2020 2020 2020 2023 2044               # D
-000471d0: 6f20 6e6f 7420 6465 7374 726f 7920 7468  o not destroy th
-000471e0: 6520 6c61 7374 2063 6f70 790a 2020 2020  e last copy.    
-000471f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00047200: 7274 206c 656e 2874 732e 7768 6f5f 6861  rt len(ts.who_ha
-00047210: 7329 203e 2031 0a20 2020 2020 2020 2020  s) > 1.         
-00047220: 2020 2073 656c 662e 7265 6d6f 7665 5f72     self.remove_r
-00047230: 6570 6c69 6361 2874 732c 2077 7329 0a0a  eplica(ts, ws)..
-00047240: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-00047250: 6561 6d5f 636f 6d6d 735b 6164 6472 5d2e  eam_comms[addr].
-00047260: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
-00047270: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00047280: 2020 2020 226f 7022 3a20 2272 656d 6f76      "op": "remov
-00047290: 652d 7265 706c 6963 6173 222c 0a20 2020  e-replicas",.   
-000472a0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-000472b0: 7973 223a 206b 6579 732c 0a20 2020 2020  ys": keys,.     
-000472c0: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
-000472d0: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
-000472e0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-000472f0: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
-00047300: 0a64 6566 205f 7461 736b 5f74 6f5f 7265  .def _task_to_re
-00047310: 706f 7274 5f6d 7367 2874 733a 2054 6173  port_msg(ts: Tas
-00047320: 6b53 7461 7465 2920 2d3e 2064 6963 745b  kState) -> dict[
-00047330: 7374 722c 2041 6e79 5d20 7c20 4e6f 6e65  str, Any] | None
-00047340: 3a0a 2020 2020 6966 2074 732e 7374 6174  :.    if ts.stat
-00047350: 6520 3d3d 2022 666f 7267 6f74 7465 6e22  e == "forgotten"
-00047360: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00047370: 207b 226f 7022 3a20 2263 616e 6365 6c6c   {"op": "cancell
-00047380: 6564 2d6b 6579 7322 2c20 226b 6579 7322  ed-keys", "keys"
-00047390: 3a20 5b74 732e 6b65 795d 7d0a 2020 2020  : [ts.key]}.    
-000473a0: 656c 6966 2074 732e 7374 6174 6520 3d3d  elif ts.state ==
-000473b0: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
-000473c0: 2020 2072 6574 7572 6e20 7b22 6f70 223a     return {"op":
-000473d0: 2022 6b65 792d 696e 2d6d 656d 6f72 7922   "key-in-memory"
-000473e0: 2c20 226b 6579 223a 2074 732e 6b65 797d  , "key": ts.key}
-000473f0: 0a20 2020 2065 6c69 6620 7473 2e73 7461  .    elif ts.sta
-00047400: 7465 203d 3d20 2265 7272 6564 223a 0a20  te == "erred":. 
-00047410: 2020 2020 2020 2066 6169 6c69 6e67 5f74         failing_t
-00047420: 7320 3d20 7473 2e65 7863 6570 7469 6f6e  s = ts.exception
-00047430: 5f62 6c61 6d65 0a20 2020 2020 2020 2061  _blame.        a
-00047440: 7373 6572 7420 6661 696c 696e 675f 7473  ssert failing_ts
-00047450: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00047460: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
-00047470: 7022 3a20 2274 6173 6b2d 6572 7265 6422  p": "task-erred"
-00047480: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-00047490: 6579 223a 2074 732e 6b65 792c 0a20 2020  ey": ts.key,.   
-000474a0: 2020 2020 2020 2020 2022 6578 6365 7074           "except
-000474b0: 696f 6e22 3a20 6661 696c 696e 675f 7473  ion": failing_ts
-000474c0: 2e65 7863 6570 7469 6f6e 2c0a 2020 2020  .exception,.    
-000474d0: 2020 2020 2020 2020 2274 7261 6365 6261          "traceba
-000474e0: 636b 223a 2066 6169 6c69 6e67 5f74 732e  ck": failing_ts.
-000474f0: 7472 6163 6562 6163 6b2c 0a20 2020 2020  traceback,.     
-00047500: 2020 207d 0a20 2020 2065 6c73 653a 0a20     }.    else:. 
-00047510: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-00047520: 6e65 0a0a 0a64 6566 205f 7461 736b 5f74  ne...def _task_t
-00047530: 6f5f 636c 6965 6e74 5f6d 7367 7328 7473  o_client_msgs(ts
-00047540: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-00047550: 6469 6374 5b73 7472 2c20 6c69 7374 5b64  dict[str, list[d
-00047560: 6963 745b 7374 722c 2041 6e79 5d5d 5d3a  ict[str, Any]]]:
-00047570: 0a20 2020 2069 6620 7473 2e77 686f 5f77  .    if ts.who_w
-00047580: 616e 7473 3a0a 2020 2020 2020 2020 7265  ants:.        re
-00047590: 706f 7274 5f6d 7367 203d 205f 7461 736b  port_msg = _task
-000475a0: 5f74 6f5f 7265 706f 7274 5f6d 7367 2874  _to_report_msg(t
-000475b0: 7329 0a20 2020 2020 2020 2069 6620 7265  s).        if re
-000475c0: 706f 7274 5f6d 7367 2069 7320 6e6f 7420  port_msg is not 
-000475d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000475e0: 2020 7265 7475 726e 207b 6373 2e63 6c69    return {cs.cli
-000475f0: 656e 745f 6b65 793a 205b 7265 706f 7274  ent_key: [report
-00047600: 5f6d 7367 5d20 666f 7220 6373 2069 6e20  _msg] for cs in 
-00047610: 7473 2e77 686f 5f77 616e 7473 7d0a 2020  ts.who_wants}.  
-00047620: 2020 7265 7475 726e 207b 7d0a 0a0a 6465    return {}...de
-00047630: 6620 6465 6369 6465 5f77 6f72 6b65 7228  f decide_worker(
-00047640: 0a20 2020 2074 733a 2054 6173 6b53 7461  .    ts: TaskSta
-00047650: 7465 2c0a 2020 2020 616c 6c5f 776f 726b  te,.    all_work
-00047660: 6572 733a 2049 7465 7261 626c 655b 576f  ers: Iterable[Wo
-00047670: 726b 6572 5374 6174 655d 2c0a 2020 2020  rkerState],.    
-00047680: 7661 6c69 645f 776f 726b 6572 733a 2073  valid_workers: s
-00047690: 6574 5b57 6f72 6b65 7253 7461 7465 5d20  et[WorkerState] 
-000476a0: 7c20 4e6f 6e65 2c0a 2020 2020 6f62 6a65  | None,.    obje
-000476b0: 6374 6976 653a 2043 616c 6c61 626c 655b  ctive: Callable[
-000476c0: 5b57 6f72 6b65 7253 7461 7465 5d2c 2041  [WorkerState], A
-000476d0: 6e79 5d2c 0a29 202d 3e20 576f 726b 6572  ny],.) -> Worker
-000476e0: 5374 6174 6520 7c20 4e6f 6e65 3a0a 2020  State | None:.  
-000476f0: 2020 2222 220a 2020 2020 4465 6369 6465    """.    Decide
-00047700: 2077 6869 6368 2077 6f72 6b65 7220 7368   which worker sh
-00047710: 6f75 6c64 2074 616b 6520 7461 736b 202a  ould take task *
-00047720: 7473 2a2e 0a0a 2020 2020 5765 2063 686f  ts*...    We cho
-00047730: 6f73 6520 7468 6520 776f 726b 6572 2074  ose the worker t
-00047740: 6861 7420 6861 7320 7468 6520 6461 7461  hat has the data
-00047750: 206f 6e20 7768 6963 6820 2a74 732a 2064   on which *ts* d
-00047760: 6570 656e 6473 2e0a 0a20 2020 2049 6620  epends...    If 
-00047770: 7365 7665 7261 6c20 776f 726b 6572 7320  several workers 
-00047780: 6861 7665 2064 6570 656e 6465 6e63 6965  have dependencie
-00047790: 7320 7468 656e 2077 6520 6368 6f6f 7365  s then we choose
-000477a0: 2074 6865 206c 6573 732d 6275 7379 2077   the less-busy w
-000477b0: 6f72 6b65 722e 0a0a 2020 2020 4f70 7469  orker...    Opti
-000477c0: 6f6e 616c 6c79 2070 726f 7669 6465 202a  onally provide *
-000477d0: 7661 6c69 645f 776f 726b 6572 732a 206f  valid_workers* o
-000477e0: 6620 7768 6572 6520 6a6f 6273 2061 7265  f where jobs are
-000477f0: 2061 6c6c 6f77 6564 2074 6f20 6f63 6375   allowed to occu
-00047800: 720a 2020 2020 2869 6620 616c 6c20 776f  r.    (if all wo
-00047810: 726b 6572 7320 6172 6520 616c 6c6f 7765  rkers are allowe
-00047820: 6420 746f 2074 616b 6520 7468 6520 7461  d to take the ta
-00047830: 736b 2c20 7061 7373 204e 6f6e 6520 696e  sk, pass None in
-00047840: 7374 6561 6429 2e0a 0a20 2020 2049 6620  stead)...    If 
-00047850: 7468 6520 7461 736b 2072 6571 7569 7265  the task require
-00047860: 7320 6461 7461 2063 6f6d 6d75 6e69 6361  s data communica
-00047870: 7469 6f6e 2062 6563 6175 7365 206e 6f20  tion because no 
-00047880: 656c 6967 6962 6c65 2077 6f72 6b65 7220  eligible worker 
-00047890: 6861 730a 2020 2020 616c 6c20 7468 6520  has.    all the 
-000478a0: 6465 7065 6e64 656e 6369 6573 2061 6c72  dependencies alr
-000478b0: 6561 6479 2c20 7468 656e 2077 6520 6368  eady, then we ch
-000478c0: 6f6f 7365 2074 6f20 6d69 6e69 6d69 7a65  oose to minimize
-000478d0: 2074 6865 206e 756d 6265 720a 2020 2020   the number.    
-000478e0: 6f66 2062 7974 6573 2073 656e 7420 6265  of bytes sent be
-000478f0: 7477 6565 6e20 776f 726b 6572 732e 2020  tween workers.  
-00047900: 5468 6973 2069 7320 6465 7465 726d 696e  This is determin
-00047910: 6564 2062 7920 6361 6c6c 696e 6720 7468  ed by calling th
-00047920: 650a 2020 2020 2a6f 626a 6563 7469 7665  e.    *objective
-00047930: 2a20 6675 6e63 7469 6f6e 2e0a 2020 2020  * function..    
-00047940: 2222 220a 2020 2020 6173 7365 7274 2061  """.    assert a
-00047950: 6c6c 2864 7473 2e77 686f 5f68 6173 2066  ll(dts.who_has f
-00047960: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00047970: 656e 6465 6e63 6965 7329 0a20 2020 2069  endencies).    i
-00047980: 6620 7473 2e61 6374 6f72 3a0a 2020 2020  f ts.actor:.    
-00047990: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
-000479a0: 2073 6574 2861 6c6c 5f77 6f72 6b65 7273   set(all_workers
-000479b0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-000479c0: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
-000479d0: 207b 7777 7320 666f 7220 6474 7320 696e   {wws for dts in
-000479e0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-000479f0: 2066 6f72 2077 7773 2069 6e20 6474 732e   for wws in dts.
-00047a00: 7768 6f5f 6861 737d 0a20 2020 2069 6620  who_has}.    if 
-00047a10: 7661 6c69 645f 776f 726b 6572 7320 6973  valid_workers is
-00047a20: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00047a30: 6620 6e6f 7420 6361 6e64 6964 6174 6573  f not candidates
-00047a40: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
-00047a50: 6e64 6964 6174 6573 203d 2073 6574 2861  ndidates = set(a
-00047a60: 6c6c 5f77 6f72 6b65 7273 290a 2020 2020  ll_workers).    
-00047a70: 656c 7365 3a0a 2020 2020 2020 2020 6361  else:.        ca
-00047a80: 6e64 6964 6174 6573 2026 3d20 7661 6c69  ndidates &= vali
-00047a90: 645f 776f 726b 6572 730a 2020 2020 2020  d_workers.      
-00047aa0: 2020 6966 206e 6f74 2063 616e 6469 6461    if not candida
-00047ab0: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
-00047ac0: 2063 616e 6469 6461 7465 7320 3d20 7661   candidates = va
-00047ad0: 6c69 645f 776f 726b 6572 730a 2020 2020  lid_workers.    
-00047ae0: 2020 2020 2020 2020 6966 206e 6f74 2063          if not c
-00047af0: 616e 6469 6461 7465 733a 0a20 2020 2020  andidates:.     
-00047b00: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00047b10: 2e6c 6f6f 7365 5f72 6573 7472 6963 7469  .loose_restricti
-00047b20: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00047b30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00047b40: 6465 6369 6465 5f77 6f72 6b65 7228 7473  decide_worker(ts
-00047b50: 2c20 616c 6c5f 776f 726b 6572 732c 204e  , all_workers, N
-00047b60: 6f6e 652c 206f 626a 6563 7469 7665 290a  one, objective).
-00047b70: 0a20 2020 2069 6620 6e6f 7420 6361 6e64  .    if not cand
-00047b80: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
-00047b90: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-00047ba0: 656c 6966 206c 656e 2863 616e 6469 6461  elif len(candida
-00047bb0: 7465 7329 203d 3d20 313a 0a20 2020 2020  tes) == 1:.     
-00047bc0: 2020 2072 6574 7572 6e20 6e65 7874 2869     return next(i
-00047bd0: 7465 7228 6361 6e64 6964 6174 6573 2929  ter(candidates))
-00047be0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00047bf0: 2020 2072 6574 7572 6e20 6d69 6e28 6361     return min(ca
-00047c00: 6e64 6964 6174 6573 2c20 6b65 793d 6f62  ndidates, key=ob
-00047c10: 6a65 6374 6976 6529 0a0a 0a64 6566 2076  jective)...def v
-00047c20: 616c 6964 6174 655f 7461 736b 5f73 7461  alidate_task_sta
-00047c30: 7465 2874 733a 2054 6173 6b53 7461 7465  te(ts: TaskState
-00047c40: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-00047c50: 2222 5661 6c69 6461 7465 2074 6865 2067  ""Validate the g
-00047c60: 6976 656e 2054 6173 6b53 7461 7465 2222  iven TaskState""
-00047c70: 220a 2020 2020 6173 7365 7274 2074 732e  ".    assert ts.
-00047c80: 7374 6174 6520 696e 2041 4c4c 5f54 4153  state in ALL_TAS
-00047c90: 4b5f 5354 4154 4553 2c20 7473 0a0a 2020  K_STATES, ts..  
-00047ca0: 2020 6966 2074 732e 7761 6974 696e 675f    if ts.waiting_
-00047cb0: 6f6e 3a0a 2020 2020 2020 2020 6173 7365  on:.        asse
-00047cc0: 7274 2074 732e 7761 6974 696e 675f 6f6e  rt ts.waiting_on
-00047cd0: 2e69 7373 7562 7365 7428 7473 2e64 6570  .issubset(ts.dep
-00047ce0: 656e 6465 6e63 6965 7329 2c20 280a 2020  endencies), (.  
-00047cf0: 2020 2020 2020 2020 2020 2277 6169 7469            "waiti
-00047d00: 6e67 206e 6f74 2073 7562 7365 7420 6f66  ng not subset of
-00047d10: 2064 6570 656e 6465 6e63 6965 7322 2c0a   dependencies",.
-00047d20: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00047d30: 7473 2e77 6169 7469 6e67 5f6f 6e29 2c0a  ts.waiting_on),.
-00047d40: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00047d50: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
-00047d60: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00047d70: 6966 2074 732e 7761 6974 6572 733a 0a20  if ts.waiters:. 
-00047d80: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00047d90: 2e77 6169 7465 7273 2e69 7373 7562 7365  .waiters.issubse
-00047da0: 7428 7473 2e64 6570 656e 6465 6e74 7329  t(ts.dependents)
-00047db0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00047dc0: 2277 6169 7465 7273 206e 6f74 2073 7562  "waiters not sub
-00047dd0: 7365 7420 6f66 2064 6570 656e 6465 6e74  set of dependent
-00047de0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00047df0: 7374 7228 7473 2e77 6169 7465 7273 292c  str(ts.waiters),
-00047e00: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00047e10: 2874 732e 6465 7065 6e64 656e 7473 292c  (ts.dependents),
-00047e20: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00047e30: 666f 7220 6474 7320 696e 2074 732e 7761  for dts in ts.wa
-00047e40: 6974 696e 675f 6f6e 3a0a 2020 2020 2020  iting_on:.      
-00047e50: 2020 6173 7365 7274 206e 6f74 2064 7473    assert not dts
-00047e60: 2e77 686f 5f68 6173 2c20 2822 7761 6974  .who_has, ("wait
-00047e70: 696e 6720 6f6e 2069 6e2d 6d65 6d6f 7279  ing on in-memory
-00047e80: 2064 6570 222c 2073 7472 2874 7329 2c20   dep", str(ts), 
-00047e90: 7374 7228 6474 7329 290a 2020 2020 2020  str(dts)).      
-00047ea0: 2020 6173 7365 7274 2064 7473 2e73 7461    assert dts.sta
-00047eb0: 7465 2021 3d20 2272 656c 6561 7365 6422  te != "released"
-00047ec0: 2c20 2822 7761 6974 696e 6720 6f6e 2072  , ("waiting on r
-00047ed0: 656c 6561 7365 6420 6465 7022 2c20 7374  eleased dep", st
-00047ee0: 7228 7473 292c 2073 7472 2864 7473 2929  r(ts), str(dts))
-00047ef0: 0a20 2020 2066 6f72 2064 7473 2069 6e20  .    for dts in 
-00047f00: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-00047f10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00047f20: 7473 2069 6e20 6474 732e 6465 7065 6e64  ts in dts.depend
-00047f30: 656e 7473 2c20 280a 2020 2020 2020 2020  ents, (.        
-00047f40: 2020 2020 226e 6f74 2069 6e20 6465 7065      "not in depe
-00047f50: 6e64 656e 6379 2773 2064 6570 656e 6465  ndency's depende
-00047f60: 6e74 7322 2c0a 2020 2020 2020 2020 2020  nts",.          
-00047f70: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-00047f80: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
-00047f90: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00047fa0: 2864 7473 2e64 6570 656e 6465 6e74 7329  (dts.dependents)
-00047fb0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00047fc0: 2020 2020 6966 2074 732e 7374 6174 6520      if ts.state 
-00047fd0: 696e 2028 2277 6169 7469 6e67 222c 2022  in ("waiting", "
-00047fe0: 7175 6575 6564 222c 2022 7072 6f63 6573  queued", "proces
-00047ff0: 7369 6e67 222c 2022 6e6f 2d77 6f72 6b65  sing", "no-worke
-00048000: 7222 293a 0a20 2020 2020 2020 2020 2020  r"):.           
-00048010: 2061 7373 6572 7420 6474 7320 696e 2074   assert dts in t
-00048020: 732e 7761 6974 696e 675f 6f6e 206f 7220  s.waiting_on or 
-00048030: 6474 732e 7768 6f5f 6861 732c 2028 0a20  dts.who_has, (. 
-00048040: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00048050: 6465 7020 6d69 7373 696e 6722 2c0a 2020  dep missing",.  
-00048060: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00048070: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
-00048080: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
-00048090: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000480a0: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-000480b0: 732e 7374 6174 6520 213d 2022 666f 7267  s.state != "forg
-000480c0: 6f74 7465 6e22 0a0a 2020 2020 666f 7220  otten"..    for 
-000480d0: 6474 7320 696e 2074 732e 7761 6974 6572  dts in ts.waiter
-000480e0: 733a 0a20 2020 2020 2020 2061 7373 6572  s:.        asser
-000480f0: 7420 6474 732e 7374 6174 6520 696e 2028  t dts.state in (
-00048100: 2277 6169 7469 6e67 222c 2022 7175 6575  "waiting", "queu
-00048110: 6564 222c 2022 7072 6f63 6573 7369 6e67  ed", "processing
-00048120: 222c 2022 6e6f 2d77 6f72 6b65 7222 292c  ", "no-worker"),
-00048130: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-00048140: 7761 6974 6572 206e 6f74 2069 6e20 706c  waiter not in pl
-00048150: 6179 222c 0a20 2020 2020 2020 2020 2020  ay",.           
-00048160: 2073 7472 2874 7329 2c0a 2020 2020 2020   str(ts),.      
-00048170: 2020 2020 2020 7374 7228 6474 7329 2c0a        str(dts),.
-00048180: 2020 2020 2020 2020 290a 2020 2020 666f          ).    fo
-00048190: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-000481a0: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
-000481b0: 6173 7365 7274 2074 7320 696e 2064 7473  assert ts in dts
-000481c0: 2e64 6570 656e 6465 6e63 6965 732c 2028  .dependencies, (
-000481d0: 0a20 2020 2020 2020 2020 2020 2022 6e6f  .            "no
-000481e0: 7420 696e 2064 6570 656e 6465 6e74 2773  t in dependent's
-000481f0: 2064 6570 656e 6465 6e63 6965 7322 2c0a   dependencies",.
-00048200: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048210: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00048220: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
-00048230: 2020 2020 2020 2073 7472 2864 7473 2e64         str(dts.d
-00048240: 6570 656e 6465 6e63 6965 7329 2c0a 2020  ependencies),.  
-00048250: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00048260: 6173 7365 7274 2064 7473 2e73 7461 7465  assert dts.state
-00048270: 2021 3d20 2266 6f72 676f 7474 656e 220a   != "forgotten".
-00048280: 0a20 2020 2061 7373 6572 7420 2874 732e  .    assert (ts.
-00048290: 7072 6f63 6573 7369 6e67 5f6f 6e20 6973  processing_on is
-000482a0: 206e 6f74 204e 6f6e 6529 203d 3d20 2874   not None) == (t
-000482b0: 732e 7374 6174 6520 3d3d 2022 7072 6f63  s.state == "proc
-000482c0: 6573 7369 6e67 2229 0a20 2020 2061 7373  essing").    ass
-000482d0: 6572 7420 626f 6f6c 2874 732e 7768 6f5f  ert bool(ts.who_
-000482e0: 6861 7329 203d 3d20 2874 732e 7374 6174  has) == (ts.stat
-000482f0: 6520 3d3d 2022 6d65 6d6f 7279 2229 2c20  e == "memory"), 
-00048300: 2874 732c 2074 732e 7768 6f5f 6861 732c  (ts, ts.who_has,
-00048310: 2074 732e 7374 6174 6529 0a0a 2020 2020   ts.state)..    
-00048320: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
-00048330: 7175 6575 6564 223a 0a20 2020 2020 2020  queued":.       
-00048340: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00048350: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-00048360: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00048370: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-00048380: 2020 2061 7373 6572 7420 616c 6c28 6474     assert all(dt
-00048390: 732e 7768 6f5f 6861 7320 666f 7220 6474  s.who_has for dt
-000483a0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-000483b0: 6369 6573 292c 2028 0a20 2020 2020 2020  cies), (.       
-000483c0: 2020 2020 2022 7461 736b 2071 7565 7565       "task queue
-000483d0: 6420 7769 7468 6f75 7420 616c 6c20 6465  d without all de
-000483e0: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
-000483f0: 2073 7472 2874 7329 2c0a 2020 2020 2020   str(ts),.      
-00048400: 2020 2020 2020 7374 7228 7473 2e64 6570        str(ts.dep
-00048410: 656e 6465 6e63 6965 7329 2c0a 2020 2020  endencies),.    
-00048420: 2020 2020 290a 0a20 2020 2069 6620 7473      )..    if ts
-00048430: 2e73 7461 7465 203d 3d20 2270 726f 6365  .state == "proce
-00048440: 7373 696e 6722 3a0a 2020 2020 2020 2020  ssing":.        
-00048450: 6173 7365 7274 2061 6c6c 2864 7473 2e77  assert all(dts.w
-00048460: 686f 5f68 6173 2066 6f72 2064 7473 2069  ho_has for dts i
-00048470: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-00048480: 7329 2c20 280a 2020 2020 2020 2020 2020  s), (.          
-00048490: 2020 2274 6173 6b20 7072 6f63 6573 7369    "task processi
-000484a0: 6e67 2077 6974 686f 7574 2061 6c6c 2064  ng without all d
-000484b0: 6570 7322 2c0a 2020 2020 2020 2020 2020  eps",.          
-000484c0: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-000484d0: 2020 2020 2020 2073 7472 2874 732e 6465         str(ts.de
-000484e0: 7065 6e64 656e 6369 6573 292c 0a20 2020  pendencies),.   
-000484f0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-00048500: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00048510: 7469 6e67 5f6f 6e0a 0a20 2020 2069 6620  ting_on..    if 
-00048520: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
-00048530: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
-00048540: 6974 6572 7320 6f72 2074 732e 7768 6f5f  iters or ts.who_
-00048550: 7761 6e74 732c 2028 0a20 2020 2020 2020  wants, (.       
-00048560: 2020 2020 2022 756e 6e65 6564 6564 2074       "unneeded t
-00048570: 6173 6b20 696e 206d 656d 6f72 7922 2c0a  ask in memory",.
-00048580: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048590: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-000485a0: 2073 7472 2874 732e 7768 6f5f 6861 7329   str(ts.who_has)
-000485b0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-000485c0: 2020 2020 6966 2074 732e 7275 6e5f 7370      if ts.run_sp
-000485d0: 6563 3a20 2023 2077 6173 2063 6f6d 7075  ec:  # was compu
-000485e0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-000485f0: 6173 7365 7274 2074 732e 7479 7065 0a20  assert ts.type. 
-00048600: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00048610: 7420 6973 696e 7374 616e 6365 2874 732e  t isinstance(ts.
-00048620: 7479 7065 2c20 7374 7229 0a20 2020 2020  type, str).     
-00048630: 2020 2061 7373 6572 7420 6e6f 7420 616e     assert not an
-00048640: 7928 5b74 7320 696e 2064 7473 2e77 6169  y([ts in dts.wai
-00048650: 7469 6e67 5f6f 6e20 666f 7220 6474 7320  ting_on for dts 
-00048660: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
-00048670: 5d29 0a20 2020 2020 2020 2066 6f72 2077  ]).        for w
-00048680: 7320 696e 2074 732e 7768 6f5f 6861 733a  s in ts.who_has:
-00048690: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000486a0: 6572 7420 7473 2069 6e20 7773 2e68 6173  ert ts in ws.has
-000486b0: 5f77 6861 742c 2028 0a20 2020 2020 2020  _what, (.       
-000486c0: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
-000486d0: 2077 686f 5f68 6173 2720 6861 735f 7768   who_has' has_wh
-000486e0: 6174 222c 0a20 2020 2020 2020 2020 2020  at",.           
-000486f0: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-00048700: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00048710: 7228 7773 292c 0a20 2020 2020 2020 2020  r(ws),.         
-00048720: 2020 2020 2020 2073 7472 2877 732e 6861         str(ws.ha
-00048730: 735f 7768 6174 292c 0a20 2020 2020 2020  s_what),.       
-00048740: 2020 2020 2029 0a0a 2020 2020 666f 7220       )..    for 
-00048750: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
-00048760: 7473 3a0a 2020 2020 2020 2020 6173 7365  ts:.        asse
-00048770: 7274 2074 7320 696e 2063 732e 7761 6e74  rt ts in cs.want
-00048780: 735f 7768 6174 2c20 280a 2020 2020 2020  s_what, (.      
-00048790: 2020 2020 2020 226e 6f74 2069 6e20 7768        "not in wh
-000487a0: 6f5f 7761 6e74 7327 2077 616e 7473 5f77  o_wants' wants_w
-000487b0: 6861 7422 2c0a 2020 2020 2020 2020 2020  hat",.          
-000487c0: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-000487d0: 2020 2020 2020 2073 7472 2863 7329 2c0a         str(cs),.
-000487e0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-000487f0: 6373 2e77 616e 7473 5f77 6861 7429 2c0a  cs.wants_what),.
-00048800: 2020 2020 2020 2020 290a 0a20 2020 2069          )..    i
-00048810: 6620 7473 2e61 6374 6f72 3a0a 2020 2020  f ts.actor:.    
-00048820: 2020 2020 6966 2074 732e 7374 6174 6520      if ts.state 
-00048830: 3d3d 2022 6d65 6d6f 7279 223a 0a20 2020  == "memory":.   
-00048840: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00048850: 7375 6d28 7473 2069 6e20 7773 2e61 6374  sum(ts in ws.act
-00048860: 6f72 7320 666f 7220 7773 2069 6e20 7473  ors for ws in ts
-00048870: 2e77 686f 5f68 6173 2920 3d3d 2031 0a20  .who_has) == 1. 
-00048880: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-00048890: 7465 203d 3d20 2270 726f 6365 7373 696e  te == "processin
-000488a0: 6722 3a0a 2020 2020 2020 2020 2020 2020  g":.            
-000488b0: 6173 7365 7274 2074 732e 7072 6f63 6573  assert ts.proces
-000488c0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-000488d0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
-000488e0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-000488f0: 6e2e 6163 746f 7273 0a20 2020 2020 2020  n.actors.       
-00048900: 2061 7373 6572 7420 7473 2e73 7461 7465   assert ts.state
-00048910: 2021 3d20 2271 7565 7565 6422 0a0a 0a64   != "queued"...d
-00048920: 6566 2076 616c 6964 6174 655f 776f 726b  ef validate_work
-00048930: 6572 5f73 7461 7465 2877 733a 2057 6f72  er_state(ws: Wor
-00048940: 6b65 7253 7461 7465 2920 2d3e 204e 6f6e  kerState) -> Non
-00048950: 653a 0a20 2020 2066 6f72 2074 7320 696e  e:.    for ts in
-00048960: 2077 732e 6861 735f 7768 6174 3a0a 2020   ws.has_what:.  
-00048970: 2020 2020 2020 6173 7365 7274 2077 7320        assert ws 
-00048980: 696e 2074 732e 7768 6f5f 6861 732c 2028  in ts.who_has, (
-00048990: 0a20 2020 2020 2020 2020 2020 2022 6e6f  .            "no
-000489a0: 7420 696e 2068 6173 5f77 6861 7427 2077  t in has_what' w
-000489b0: 686f 5f68 6173 222c 0a20 2020 2020 2020  ho_has",.       
-000489c0: 2020 2020 2073 7472 2877 7329 2c0a 2020       str(ws),.  
-000489d0: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-000489e0: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-000489f0: 7472 2874 732e 7768 6f5f 6861 7329 2c0a  tr(ts.who_has),.
-00048a00: 2020 2020 2020 2020 290a 0a20 2020 2066          )..    f
-00048a10: 6f72 2074 7320 696e 2077 732e 6163 746f  or ts in ws.acto
-00048a20: 7273 3a0a 2020 2020 2020 2020 6173 7365  rs:.        asse
-00048a30: 7274 2074 732e 7374 6174 6520 696e 2028  rt ts.state in (
-00048a40: 226d 656d 6f72 7922 2c20 2270 726f 6365  "memory", "proce
-00048a50: 7373 696e 6722 290a 0a0a 6465 6620 7661  ssing")...def va
-00048a60: 6c69 6461 7465 5f73 7461 7465 280a 2020  lidate_state(.  
-00048a70: 2020 7461 736b 733a 2064 6963 745b 7374    tasks: dict[st
-00048a80: 722c 2054 6173 6b53 7461 7465 5d2c 0a20  r, TaskState],. 
-00048a90: 2020 2077 6f72 6b65 7273 3a20 6469 6374     workers: dict
-00048aa0: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
-00048ab0: 655d 2c0a 2020 2020 636c 6965 6e74 733a  e],.    clients:
-00048ac0: 2064 6963 745b 7374 722c 2043 6c69 656e   dict[str, Clien
-00048ad0: 7453 7461 7465 5d2c 0a29 202d 3e20 4e6f  tState],.) -> No
-00048ae0: 6e65 3a0a 2020 2020 2222 2256 616c 6964  ne:.    """Valid
-00048af0: 6174 6520 6120 6375 7272 656e 7420 7275  ate a current ru
-00048b00: 6e74 696d 6520 7374 6174 652e 0a0a 2020  ntime state...  
-00048b10: 2020 5468 6973 2070 6572 666f 726d 7320    This performs 
-00048b20: 6120 7365 7175 656e 6365 206f 6620 6368  a sequence of ch
-00048b30: 6563 6b73 206f 6e20 7468 6520 656e 7469  ecks on the enti
-00048b40: 7265 2067 7261 7068 2c20 7275 6e6e 696e  re graph, runnin
-00048b50: 6720 696e 2061 626f 7574 206c 696e 6561  g in about linea
-00048b60: 720a 2020 2020 7469 6d65 2e20 5468 6973  r.    time. This
-00048b70: 2072 6169 7365 7320 6173 7365 7274 2065   raises assert e
-00048b80: 7272 6f72 7320 6966 2061 6e79 7468 696e  rrors if anythin
-00048b90: 6720 646f 6573 6e27 7420 6368 6563 6b20  g doesn't check 
-00048ba0: 6f75 742e 0a20 2020 2022 2222 0a20 2020  out..    """.   
-00048bb0: 2066 6f72 2074 7320 696e 2074 6173 6b73   for ts in tasks
-00048bc0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-00048bd0: 2020 2076 616c 6964 6174 655f 7461 736b     validate_task
-00048be0: 5f73 7461 7465 2874 7329 0a0a 2020 2020  _state(ts)..    
-00048bf0: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
-00048c00: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
-00048c10: 2020 2020 7661 6c69 6461 7465 5f77 6f72      validate_wor
-00048c20: 6b65 725f 7374 6174 6528 7773 290a 0a20  ker_state(ws).. 
-00048c30: 2020 2066 6f72 2063 7320 696e 2063 6c69     for cs in cli
-00048c40: 656e 7473 2e76 616c 7565 7328 293a 0a20  ents.values():. 
-00048c50: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-00048c60: 2063 732e 7761 6e74 735f 7768 6174 3a0a   cs.wants_what:.
-00048c70: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00048c80: 7274 2063 7320 696e 2074 732e 7768 6f5f  rt cs in ts.who_
-00048c90: 7761 6e74 732c 2028 0a20 2020 2020 2020  wants, (.       
-00048ca0: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
-00048cb0: 2077 616e 7473 5f77 6861 7427 2077 686f   wants_what' who
-00048cc0: 5f77 616e 7473 222c 0a20 2020 2020 2020  _wants",.       
-00048cd0: 2020 2020 2020 2020 2073 7472 2863 7329           str(cs)
-00048ce0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00048cf0: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-00048d00: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-00048d10: 732e 7768 6f5f 7761 6e74 7329 2c0a 2020  s.who_wants),.  
-00048d20: 2020 2020 2020 2020 2020 290a 0a0a 6465            )...de
-00048d30: 6620 6865 6172 7462 6561 745f 696e 7465  f heartbeat_inte
-00048d40: 7276 616c 286e 3a20 696e 7429 202d 3e20  rval(n: int) -> 
-00048d50: 666c 6f61 743a 0a20 2020 2022 2222 496e  float:.    """In
-00048d60: 7465 7276 616c 2069 6e20 7365 636f 6e64  terval in second
-00048d70: 7320 7468 6174 2077 6520 6465 7369 7265  s that we desire
-00048d80: 2068 6561 7274 6265 6174 7320 6261 7365   heartbeats base
-00048d90: 6420 6f6e 206e 756d 6265 7220 6f66 2077  d on number of w
-00048da0: 6f72 6b65 7273 2222 220a 2020 2020 6966  orkers""".    if
-00048db0: 206e 203c 3d20 3130 3a0a 2020 2020 2020   n <= 10:.      
-00048dc0: 2020 7265 7475 726e 2030 2e35 0a20 2020    return 0.5.   
-00048dd0: 2065 6c69 6620 6e20 3c20 3530 3a0a 2020   elif n < 50:.  
-00048de0: 2020 2020 2020 7265 7475 726e 2031 0a20        return 1. 
-00048df0: 2020 2065 6c69 6620 6e20 3c20 3230 303a     elif n < 200:
-00048e00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00048e10: 320a 2020 2020 656c 7365 3a0a 2020 2020  2.    else:.    
-00048e20: 2020 2020 2320 4e6f 206d 6f72 6520 7468      # No more th
-00048e30: 616e 2032 3030 2068 6561 7274 6265 6174  an 200 heartbeat
-00048e40: 7320 6120 7365 636f 6e64 2073 6361 6c65  s a second scale
-00048e50: 6420 6279 2077 6f72 6b65 7273 0a20 2020  d by workers.   
-00048e60: 2020 2020 2072 6574 7572 6e20 6e20 2f20       return n / 
-00048e70: 3230 3020 2b20 310a 0a0a 6465 6620 5f74  200 + 1...def _t
-00048e80: 6173 6b5f 736c 6f74 735f 6176 6169 6c61  ask_slots_availa
-00048e90: 626c 6528 7773 3a20 576f 726b 6572 5374  ble(ws: WorkerSt
-00048ea0: 6174 652c 2073 6174 7572 6174 696f 6e5f  ate, saturation_
-00048eb0: 6661 6374 6f72 3a20 666c 6f61 7429 202d  factor: float) -
-00048ec0: 3e20 696e 743a 0a20 2020 2022 2222 4e75  > int:.    """Nu
-00048ed0: 6d62 6572 206f 6620 7461 736b 7320 7468  mber of tasks th
-00048ee0: 6174 2063 616e 2062 6520 7365 6e74 2074  at can be sent t
-00048ef0: 6f20 7468 6973 2077 6f72 6b65 7220 7769  o this worker wi
-00048f00: 7468 6f75 7420 6f76 6572 7361 7475 7261  thout oversatura
-00048f10: 7469 6e67 2069 7422 2222 0a20 2020 2061  ting it""".    a
-00048f20: 7373 6572 7420 6e6f 7420 6d61 7468 2e69  ssert not math.i
-00048f30: 7369 6e66 2873 6174 7572 6174 696f 6e5f  sinf(saturation_
-00048f40: 6661 6374 6f72 290a 2020 2020 7265 7475  factor).    retu
-00048f50: 726e 206d 6178 286d 6174 682e 6365 696c  rn max(math.ceil
-00048f60: 2873 6174 7572 6174 696f 6e5f 6661 6374  (saturation_fact
-00048f70: 6f72 202a 2077 732e 6e74 6872 6561 6473  or * ws.nthreads
-00048f80: 292c 2031 2920 2d20 280a 2020 2020 2020  ), 1) - (.      
-00048f90: 2020 6c65 6e28 7773 2e70 726f 6365 7373    len(ws.process
-00048fa0: 696e 6729 202d 206c 656e 2877 732e 6c6f  ing) - len(ws.lo
-00048fb0: 6e67 5f72 756e 6e69 6e67 290a 2020 2020  ng_running).    
-00048fc0: 290a 0a0a 6465 6620 5f77 6f72 6b65 725f  )...def _worker_
-00048fd0: 6675 6c6c 2877 733a 2057 6f72 6b65 7253  full(ws: WorkerS
-00048fe0: 7461 7465 2c20 7361 7475 7261 7469 6f6e  tate, saturation
-00048ff0: 5f66 6163 746f 723a 2066 6c6f 6174 2920  _factor: float) 
-00049000: 2d3e 2062 6f6f 6c3a 0a20 2020 2069 6620  -> bool:.    if 
-00049010: 6d61 7468 2e69 7369 6e66 2873 6174 7572  math.isinf(satur
-00049020: 6174 696f 6e5f 6661 6374 6f72 293a 0a20  ation_factor):. 
-00049030: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-00049040: 6c73 650a 2020 2020 7265 7475 726e 205f  lse.    return _
-00049050: 7461 736b 5f73 6c6f 7473 5f61 7661 696c  task_slots_avail
-00049060: 6162 6c65 2877 732c 2073 6174 7572 6174  able(ws, saturat
-00049070: 696f 6e5f 6661 6374 6f72 2920 3c3d 2030  ion_factor) <= 0
-00049080: 0a0a 0a63 6c61 7373 204b 696c 6c65 6457  ...class KilledW
-00049090: 6f72 6b65 7228 4578 6365 7074 696f 6e29  orker(Exception)
-000490a0: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
-000490b0: 5f5f 2873 656c 662c 2074 6173 6b3a 2073  __(self, task: s
-000490c0: 7472 2c20 6c61 7374 5f77 6f72 6b65 723a  tr, last_worker:
-000490d0: 2057 6f72 6b65 7253 7461 7465 2c20 616c   WorkerState, al
-000490e0: 6c6f 7765 645f 6661 696c 7572 6573 3a20  lowed_failures: 
-000490f0: 696e 7429 3a0a 2020 2020 2020 2020 7375  int):.        su
-00049100: 7065 7228 292e 5f5f 696e 6974 5f5f 2874  per().__init__(t
-00049110: 6173 6b2c 206c 6173 745f 776f 726b 6572  ask, last_worker
-00049120: 2c20 616c 6c6f 7765 645f 6661 696c 7572  , allowed_failur
-00049130: 6573 290a 0a20 2020 2040 7072 6f70 6572  es)..    @proper
-00049140: 7479 0a20 2020 2064 6566 2074 6173 6b28  ty.    def task(
-00049150: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-00049160: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00049170: 662e 6172 6773 5b30 5d0a 0a20 2020 2040  f.args[0]..    @
-00049180: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00049190: 206c 6173 745f 776f 726b 6572 2873 656c   last_worker(sel
-000491a0: 6629 202d 3e20 576f 726b 6572 5374 6174  f) -> WorkerStat
-000491b0: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-000491c0: 6e20 7365 6c66 2e61 7267 735b 315d 0a0a  n self.args[1]..
-000491d0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-000491e0: 2020 6465 6620 616c 6c6f 7765 645f 6661    def allowed_fa
-000491f0: 696c 7572 6573 2873 656c 6629 202d 3e20  ilures(self) -> 
-00049200: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
-00049210: 7572 6e20 7365 6c66 2e61 7267 735b 325d  urn self.args[2]
-00049220: 0a0a 2020 2020 6465 6620 5f5f 7374 725f  ..    def __str_
-00049230: 5f28 7365 6c66 2920 2d3e 2073 7472 3a0a  _(self) -> str:.
-00049240: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00049250: 0a20 2020 2020 2020 2020 2020 2066 2241  .            f"A
-00049260: 7474 656d 7074 6564 2074 6f20 7275 6e20  ttempted to run 
-00049270: 7461 736b 207b 7365 6c66 2e74 6173 6b7d  task {self.task}
-00049280: 206f 6e20 7b73 656c 662e 616c 6c6f 7765   on {self.allowe
-00049290: 645f 6661 696c 7572 6573 7d20 6469 6666  d_failures} diff
-000492a0: 6572 656e 7420 220a 2020 2020 2020 2020  erent ".        
-000492b0: 2020 2020 2277 6f72 6b65 7273 2c20 6275      "workers, bu
-000492c0: 7420 616c 6c20 7468 6f73 6520 776f 726b  t all those work
-000492d0: 6572 7320 6469 6564 2077 6869 6c65 2072  ers died while r
-000492e0: 756e 6e69 6e67 2069 742e 2022 0a20 2020  unning it. ".   
-000492f0: 2020 2020 2020 2020 2066 2254 6865 206c           f"The l
-00049300: 6173 7420 776f 726b 6572 2074 6861 7420  ast worker that 
-00049310: 6174 7465 6d70 7420 746f 2072 756e 2074  attempt to run t
-00049320: 6865 2074 6173 6b20 7761 7320 7b73 656c  he task was {sel
-00049330: 662e 6c61 7374 5f77 6f72 6b65 722e 6164  f.last_worker.ad
-00049340: 6472 6573 737d 2e20 220a 2020 2020 2020  dress}. ".      
-00049350: 2020 2020 2020 2249 6e73 7065 6374 696e        "Inspectin
-00049360: 6720 776f 726b 6572 206c 6f67 7320 6973  g worker logs is
-00049370: 206f 6674 656e 2061 2067 6f6f 6420 6e65   often a good ne
-00049380: 7874 2073 7465 7020 746f 2064 6961 676e  xt step to diagn
-00049390: 6f73 6520 7768 6174 2077 656e 7420 7772  ose what went wr
-000493a0: 6f6e 672e 2022 0a20 2020 2020 2020 2020  ong. ".         
-000493b0: 2020 2022 466f 7220 6d6f 7265 2069 6e66     "For more inf
-000493c0: 6f72 6d61 7469 6f6e 2073 6565 2068 7474  ormation see htt
-000493d0: 7073 3a2f 2f64 6973 7472 6962 7574 6564  ps://distributed
-000493e0: 2e64 6173 6b2e 6f72 672f 656e 2f73 7461  .dask.org/en/sta
-000493f0: 626c 652f 6b69 6c6c 6564 2e68 746d 6c2e  ble/killed.html.
-00049400: 220a 2020 2020 2020 2020 290a 0a0a 636c  ".        )...cl
-00049410: 6173 7320 576f 726b 6572 5374 6174 7573  ass WorkerStatus
-00049420: 506c 7567 696e 2853 6368 6564 756c 6572  Plugin(Scheduler
-00049430: 506c 7567 696e 293a 0a20 2020 2022 2222  Plugin):.    """
-00049440: 4120 706c 7567 696e 2074 6f20 7368 6172  A plugin to shar
-00049450: 6520 776f 726b 6572 2073 7461 7475 7320  e worker status 
-00049460: 7769 7468 2061 2072 656d 6f74 6520 6f62  with a remote ob
-00049470: 7365 7276 6572 0a0a 2020 2020 5468 6973  server..    This
-00049480: 2069 7320 7573 6564 2069 6e20 636c 7573   is used in clus
-00049490: 7465 7220 6d61 6e61 6765 7273 2074 6f20  ter managers to 
-000494a0: 6b65 6570 2075 7064 6174 6564 2061 626f  keep updated abo
-000494b0: 7574 2074 6865 2073 7461 7475 7320 6f66  ut the status of
-000494c0: 2074 6865 2073 6368 6564 756c 6572 2e0a   the scheduler..
-000494d0: 2020 2020 2222 220a 0a20 2020 206e 616d      """..    nam
-000494e0: 653a 2043 6c61 7373 5661 725b 7374 725d  e: ClassVar[str]
-000494f0: 203d 2022 776f 726b 6572 2d73 7461 7475   = "worker-statu
-00049500: 7322 0a20 2020 2062 636f 6d6d 3a20 4261  s".    bcomm: Ba
-00049510: 7463 6865 6453 656e 640a 0a20 2020 2064  tchedSend..    d
-00049520: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00049530: 2c20 7363 6865 6475 6c65 723a 2053 6368  , scheduler: Sch
-00049540: 6564 756c 6572 2c20 636f 6d6d 3a20 436f  eduler, comm: Co
-00049550: 6d6d 293a 0a20 2020 2020 2020 2073 656c  mm):.        sel
-00049560: 662e 6263 6f6d 6d20 3d20 4261 7463 6865  f.bcomm = Batche
-00049570: 6453 656e 6428 696e 7465 7276 616c 3d22  dSend(interval="
-00049580: 356d 7322 290a 2020 2020 2020 2020 7365  5ms").        se
-00049590: 6c66 2e62 636f 6d6d 2e73 7461 7274 2863  lf.bcomm.start(c
-000495a0: 6f6d 6d29 0a20 2020 2020 2020 2073 6368  omm).        sch
-000495b0: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
-000495c0: 6e28 7365 6c66 290a 0a20 2020 2064 6566  n(self)..    def
-000495d0: 2061 6464 5f77 6f72 6b65 7228 7365 6c66   add_worker(self
-000495e0: 2c20 7363 6865 6475 6c65 723a 2053 6368  , scheduler: Sch
-000495f0: 6564 756c 6572 2c20 776f 726b 6572 3a20  eduler, worker: 
-00049600: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-00049610: 2020 2020 2020 6964 656e 7420 3d20 7363        ident = sc
-00049620: 6865 6475 6c65 722e 776f 726b 6572 735b  heduler.workers[
-00049630: 776f 726b 6572 5d2e 6964 656e 7469 7479  worker].identity
-00049640: 2829 0a20 2020 2020 2020 2064 656c 2069  ().        del i
-00049650: 6465 6e74 5b22 6d65 7472 6963 7322 5d0a  dent["metrics"].
-00049660: 2020 2020 2020 2020 6465 6c20 6964 656e          del iden
-00049670: 745b 226c 6173 745f 7365 656e 225d 0a20  t["last_seen"]. 
-00049680: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00049690: 2020 2020 2020 2020 7365 6c66 2e62 636f          self.bco
-000496a0: 6d6d 2e73 656e 6428 5b22 6164 6422 2c20  mm.send(["add", 
-000496b0: 7b22 776f 726b 6572 7322 3a20 7b77 6f72  {"workers": {wor
-000496c0: 6b65 723a 2069 6465 6e74 7d7d 5d29 0a20  ker: ident}}]). 
-000496d0: 2020 2020 2020 2065 7863 6570 7420 436f         except Co
-000496e0: 6d6d 436c 6f73 6564 4572 726f 723a 0a20  mmClosedError:. 
-000496f0: 2020 2020 2020 2020 2020 2073 6368 6564             sched
-00049700: 756c 6572 2e72 656d 6f76 655f 706c 7567  uler.remove_plug
-00049710: 696e 286e 616d 653d 7365 6c66 2e6e 616d  in(name=self.nam
-00049720: 6529 0a0a 2020 2020 6465 6620 7265 6d6f  e)..    def remo
-00049730: 7665 5f77 6f72 6b65 7228 7365 6c66 2c20  ve_worker(self, 
-00049740: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
-00049750: 756c 6572 2c20 776f 726b 6572 3a20 7374  uler, worker: st
-00049760: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-00049770: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00049780: 2020 2020 2073 656c 662e 6263 6f6d 6d2e       self.bcomm.
-00049790: 7365 6e64 285b 2272 656d 6f76 6522 2c20  send(["remove", 
-000497a0: 776f 726b 6572 5d29 0a20 2020 2020 2020  worker]).       
-000497b0: 2065 7863 6570 7420 436f 6d6d 436c 6f73   except CommClos
-000497c0: 6564 4572 726f 723a 0a20 2020 2020 2020  edError:.       
-000497d0: 2020 2020 2073 6368 6564 756c 6572 2e72       scheduler.r
-000497e0: 656d 6f76 655f 706c 7567 696e 286e 616d  emove_plugin(nam
-000497f0: 653d 7365 6c66 2e6e 616d 6529 0a0a 2020  e=self.name)..  
-00049800: 2020 6465 6620 7465 6172 646f 776e 2873    def teardown(s
-00049810: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-00049820: 2020 2020 2020 7365 6c66 2e62 636f 6d6d        self.bcomm
-00049830: 2e63 6c6f 7365 2829 0a0a 0a63 6c61 7373  .close()...class
-00049840: 2043 6f6c 6c65 6374 5461 736b 4d65 7461   CollectTaskMeta
-00049850: 4461 7461 506c 7567 696e 2853 6368 6564  DataPlugin(Sched
-00049860: 756c 6572 506c 7567 696e 293a 0a20 2020  ulerPlugin):.   
-00049870: 2073 6368 6564 756c 6572 3a20 5363 6865   scheduler: Sche
-00049880: 6475 6c65 720a 2020 2020 6e61 6d65 3a20  duler.    name: 
-00049890: 7374 720a 2020 2020 6b65 7973 3a20 7365  str.    keys: se
-000498a0: 745b 7374 725d 0a20 2020 206d 6574 6164  t[str].    metad
-000498b0: 6174 613a 2064 6963 745b 7374 722c 2041  ata: dict[str, A
-000498c0: 6e79 5d0a 2020 2020 7374 6174 653a 2064  ny].    state: d
-000498d0: 6963 745b 7374 722c 2073 7472 5d0a 0a20  ict[str, str].. 
-000498e0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-000498f0: 7365 6c66 2c20 7363 6865 6475 6c65 723a  self, scheduler:
-00049900: 2053 6368 6564 756c 6572 2c20 6e61 6d65   Scheduler, name
-00049910: 3a20 7374 7229 3a0a 2020 2020 2020 2020  : str):.        
-00049920: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-00049930: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
-00049940: 2020 2073 656c 662e 6e61 6d65 203d 206e     self.name = n
-00049950: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
-00049960: 2e6b 6579 7320 3d20 7365 7428 290a 2020  .keys = set().  
-00049970: 2020 2020 2020 7365 6c66 2e6d 6574 6164        self.metad
-00049980: 6174 6120 3d20 7b7d 0a20 2020 2020 2020  ata = {}.       
-00049990: 2073 656c 662e 7374 6174 6520 3d20 7b7d   self.state = {}
-000499a0: 0a0a 2020 2020 6465 6620 7570 6461 7465  ..    def update
-000499b0: 5f67 7261 7068 280a 2020 2020 2020 2020  _graph(.        
-000499c0: 7365 6c66 2c0a 2020 2020 2020 2020 7363  self,.        sc
-000499d0: 6865 6475 6c65 723a 2053 6368 6564 756c  heduler: Schedul
-000499e0: 6572 2c0a 2020 2020 2020 2020 2a2c 0a20  er,.        *,. 
-000499f0: 2020 2020 2020 206b 6579 733a 2073 6574         keys: set
-00049a00: 5b73 7472 5d2c 0a20 2020 2020 2020 202a  [str],.        *
-00049a10: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
-00049a20: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00049a30: 2020 2020 2073 656c 662e 6b65 7973 2e75       self.keys.u
-00049a40: 7064 6174 6528 6b65 7973 290a 0a20 2020  pdate(keys)..   
-00049a50: 2064 6566 2074 7261 6e73 6974 696f 6e28   def transition(
-00049a60: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00049a70: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
-00049a80: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
-00049a90: 5461 736b 5374 6174 6553 7461 7465 2c0a  TaskStateState,.
-00049aa0: 2020 2020 2020 2020 6669 6e69 7368 3a20          finish: 
-00049ab0: 5461 736b 5374 6174 6553 7461 7465 2c0a  TaskStateState,.
-00049ac0: 2020 2020 2020 2020 2a61 7267 733a 2041          *args: A
-00049ad0: 6e79 2c0a 2020 2020 2020 2020 2a2a 6b77  ny,.        **kw
-00049ae0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
-00049af0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00049b00: 2020 6966 2066 696e 6973 6820 696e 2028    if finish in (
-00049b10: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
-00049b20: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00049b30: 7473 203d 2073 656c 662e 7363 6865 6475  ts = self.schedu
-00049b40: 6c65 722e 7461 736b 732e 6765 7428 6b65  ler.tasks.get(ke
-00049b50: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-00049b60: 6620 7473 2069 7320 6e6f 7420 4e6f 6e65  f ts is not None
-00049b70: 2061 6e64 2074 732e 6b65 7920 696e 2073   and ts.key in s
-00049b80: 656c 662e 6b65 7973 3a0a 2020 2020 2020  elf.keys:.      
-00049b90: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00049ba0: 6574 6164 6174 615b 6b65 795d 203d 2074  etadata[key] = t
-00049bb0: 732e 6d65 7461 6461 7461 0a20 2020 2020  s.metadata.     
-00049bc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00049bd0: 7374 6174 655b 6b65 795d 203d 2066 696e  state[key] = fin
-00049be0: 6973 680a 2020 2020 2020 2020 2020 2020  ish.            
-00049bf0: 2020 2020 7365 6c66 2e6b 6579 732e 6469      self.keys.di
-00049c00: 7363 6172 6428 6b65 7929 0a              scard(key).
+00044d60: 6c64 3d77 6f72 6b65 7273 2c20 7469 746c  ld=workers, titl
+00044d70: 653d 2257 6f72 6b65 7220 5072 6f66 696c  e="Worker Profil
+00044d80: 6520 2861 646d 696e 6973 7472 6174 6976  e (administrativ
+00044d90: 6529 2229 0a20 2020 2020 2020 2073 6368  e)").        sch
+00044da0: 6564 756c 6572 203d 2054 6162 5061 6e65  eduler = TabPane
+00044db0: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
+00044dc0: 6869 6c64 3d73 6368 6564 756c 6572 2c20  hild=scheduler, 
+00044dd0: 7469 746c 653d 2253 6368 6564 756c 6572  title="Scheduler
+00044de0: 2050 726f 6669 6c65 2028 6164 6d69 6e69   Profile (admini
+00044df0: 7374 7261 7469 7665 2922 0a20 2020 2020  strative)".     
+00044e00: 2020 2029 0a20 2020 2020 2020 2074 6173     ).        tas
+00044e10: 6b5f 7374 7265 616d 203d 2054 6162 5061  k_stream = TabPa
+00044e20: 6e65 6c28 6368 696c 643d 7461 736b 5f73  nel(child=task_s
+00044e30: 7472 6561 6d2c 2074 6974 6c65 3d22 5461  tream, title="Ta
+00044e40: 736b 2053 7472 6561 6d22 290a 2020 2020  sk Stream").    
+00044e50: 2020 2020 6261 6e64 7769 6474 685f 776f      bandwidth_wo
+00044e60: 726b 6572 7320 3d20 5461 6250 616e 656c  rkers = TabPanel
+00044e70: 280a 2020 2020 2020 2020 2020 2020 6368  (.            ch
+00044e80: 696c 643d 6261 6e64 7769 6474 685f 776f  ild=bandwidth_wo
+00044e90: 726b 6572 732e 726f 6f74 2c20 7469 746c  rkers.root, titl
+00044ea0: 653d 2242 616e 6477 6964 7468 2028 576f  e="Bandwidth (Wo
+00044eb0: 726b 6572 7329 220a 2020 2020 2020 2020  rkers)".        
+00044ec0: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
+00044ed0: 6474 685f 7479 7065 7320 3d20 5461 6250  dth_types = TabP
+00044ee0: 616e 656c 280a 2020 2020 2020 2020 2020  anel(.          
+00044ef0: 2020 6368 696c 643d 6261 6e64 7769 6474    child=bandwidt
+00044f00: 685f 7479 7065 732e 726f 6f74 2c20 7469  h_types.root, ti
+00044f10: 746c 653d 2242 616e 6477 6964 7468 2028  tle="Bandwidth (
+00044f20: 5479 7065 7329 220a 2020 2020 2020 2020  Types)".        
+00044f30: 290a 2020 2020 2020 2020 7379 7374 656d  ).        system
+00044f40: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
+00044f50: 643d 7379 736d 6f6e 2e72 6f6f 742c 2074  d=sysmon.root, t
+00044f60: 6974 6c65 3d22 5379 7374 656d 2229 0a20  itle="System"). 
+00044f70: 2020 2020 2020 206c 6f67 7320 3d20 5461         logs = Ta
+00044f80: 6250 616e 656c 2863 6869 6c64 3d6c 6f67  bPanel(child=log
+00044f90: 732e 726f 6f74 2c20 7469 746c 653d 2253  s.root, title="S
+00044fa0: 6368 6564 756c 6572 204c 6f67 7322 290a  cheduler Logs").
+00044fb0: 0a20 2020 2020 2020 2074 6162 7320 3d20  .        tabs = 
+00044fc0: 5461 6273 280a 2020 2020 2020 2020 2020  Tabs(.          
+00044fd0: 2020 7461 6273 3d5b 0a20 2020 2020 2020    tabs=[.       
+00044fe0: 2020 2020 2020 2020 2068 746d 6c2c 0a20           html,. 
+00044ff0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00045000: 6173 6b5f 7374 7265 616d 2c0a 2020 2020  ask_stream,.    
+00045010: 2020 2020 2020 2020 2020 2020 7379 7374              syst
+00045020: 656d 2c0a 2020 2020 2020 2020 2020 2020  em,.            
+00045030: 2020 2020 6c6f 6773 2c0a 2020 2020 2020      logs,.      
+00045040: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
+00045050: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00045060: 2020 2077 6f72 6b65 7273 2c0a 2020 2020     workers,.    
+00045070: 2020 2020 2020 2020 2020 2020 7363 6865              sche
+00045080: 6475 6c65 722c 0a20 2020 2020 2020 2020  duler,.         
+00045090: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
+000450a0: 5f77 6f72 6b65 7273 2c0a 2020 2020 2020  _workers,.      
+000450b0: 2020 2020 2020 2020 2020 6261 6e64 7769            bandwi
+000450c0: 6474 685f 7479 7065 732c 0a20 2020 2020  dth_types,.     
+000450d0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000450e0: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
+000450f0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00045100: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00045110: 2020 2020 2066 726f 6d20 626f 6b65 682e       from bokeh.
+00045120: 636f 7265 2e74 656d 706c 6174 6573 2069  core.templates i
+00045130: 6d70 6f72 7420 6765 745f 656e 760a 2020  mport get_env.  
+00045140: 2020 2020 2020 6672 6f6d 2062 6f6b 6568        from bokeh
+00045150: 2e70 6c6f 7474 696e 6720 696d 706f 7274  .plotting import
+00045160: 206f 7574 7075 745f 6669 6c65 2c20 7361   output_file, sa
+00045170: 7665 0a0a 2020 2020 2020 2020 7769 7468  ve..        with
+00045180: 2074 6d70 6669 6c65 2865 7874 656e 7369   tmpfile(extensi
+00045190: 6f6e 3d22 2e68 746d 6c22 2920 6173 2066  on=".html") as f
+000451a0: 6e3a 0a20 2020 2020 2020 2020 2020 206f  n:.            o
+000451b0: 7574 7075 745f 6669 6c65 2866 696c 656e  utput_file(filen
+000451c0: 616d 653d 666e 2c20 7469 746c 653d 2244  ame=fn, title="D
+000451d0: 6173 6b20 5065 7266 6f72 6d61 6e63 6520  ask Performance 
+000451e0: 5265 706f 7274 222c 206d 6f64 653d 6d6f  Report", mode=mo
+000451f0: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
+00045200: 7465 6d70 6c61 7465 5f64 6972 6563 746f  template_directo
+00045210: 7279 203d 206f 732e 7061 7468 2e6a 6f69  ry = os.path.joi
+00045220: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00045230: 2020 206f 732e 7061 7468 2e64 6972 6e61     os.path.dirna
+00045240: 6d65 286f 732e 7061 7468 2e61 6273 7061  me(os.path.abspa
+00045250: 7468 285f 5f66 696c 655f 5f29 292c 2022  th(__file__)), "
+00045260: 6461 7368 626f 6172 6422 2c20 2274 656d  dashboard", "tem
+00045270: 706c 6174 6573 220a 2020 2020 2020 2020  plates".        
+00045280: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00045290: 2020 7465 6d70 6c61 7465 5f65 6e76 6972    template_envir
+000452a0: 6f6e 6d65 6e74 203d 2067 6574 5f65 6e76  onment = get_env
+000452b0: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
+000452c0: 656d 706c 6174 655f 656e 7669 726f 6e6d  emplate_environm
+000452d0: 656e 742e 6c6f 6164 6572 2e73 6561 7263  ent.loader.searc
+000452e0: 6870 6174 682e 6170 7065 6e64 2874 656d  hpath.append(tem
+000452f0: 706c 6174 655f 6469 7265 6374 6f72 7929  plate_directory)
+00045300: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+00045310: 706c 6174 6520 3d20 7465 6d70 6c61 7465  plate = template
+00045320: 5f65 6e76 6972 6f6e 6d65 6e74 2e67 6574  _environment.get
+00045330: 5f74 656d 706c 6174 6528 2270 6572 666f  _template("perfo
+00045340: 726d 616e 6365 5f72 6570 6f72 742e 6874  rmance_report.ht
+00045350: 6d6c 2229 0a20 2020 2020 2020 2020 2020  ml").           
+00045360: 2073 6176 6528 7461 6273 2c20 6669 6c65   save(tabs, file
+00045370: 6e61 6d65 3d66 6e2c 2074 656d 706c 6174  name=fn, templat
+00045380: 653d 7465 6d70 6c61 7465 290a 0a20 2020  e=template)..   
+00045390: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
+000453a0: 656e 2866 6e29 2061 7320 663a 0a20 2020  en(fn) as f:.   
+000453b0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000453c0: 6120 3d20 662e 7265 6164 2829 0a0a 2020  a = f.read()..  
+000453d0: 2020 2020 2020 7265 7475 726e 2064 6174        return dat
+000453e0: 610a 0a20 2020 2061 7379 6e63 2064 6566  a..    async def
+000453f0: 2067 6574 5f77 6f72 6b65 725f 6c6f 6773   get_worker_logs
+00045400: 2873 656c 662c 206e 3d4e 6f6e 652c 2077  (self, n=None, w
+00045410: 6f72 6b65 7273 3d4e 6f6e 652c 206e 616e  orkers=None, nan
+00045420: 6e79 3d46 616c 7365 293a 0a20 2020 2020  ny=False):.     
+00045430: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+00045440: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+00045450: 7428 0a20 2020 2020 2020 2020 2020 206d  t(.            m
+00045460: 7367 3d7b 226f 7022 3a20 2267 6574 5f6c  sg={"op": "get_l
+00045470: 6f67 7322 2c20 226e 223a 206e 7d2c 2077  ogs", "n": n}, w
+00045480: 6f72 6b65 7273 3d77 6f72 6b65 7273 2c20  orkers=workers, 
+00045490: 6e61 6e6e 793d 6e61 6e6e 790a 2020 2020  nanny=nanny.    
+000454a0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+000454b0: 7475 726e 2072 6573 756c 7473 0a0a 2020  turn results..  
+000454c0: 2020 6465 6620 6c6f 675f 6576 656e 7428    def log_event(
+000454d0: 7365 6c66 2c20 746f 7069 633a 2073 7472  self, topic: str
+000454e0: 207c 2043 6f6c 6c65 6374 696f 6e5b 7374   | Collection[st
+000454f0: 725d 2c20 6d73 673a 2041 6e79 2920 2d3e  r], msg: Any) ->
+00045500: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00045510: 2222 4c6f 6720 616e 2065 7665 6e74 2075  ""Log an event u
+00045520: 6e64 6572 2061 2067 6976 656e 2074 6f70  nder a given top
+00045530: 6963 0a0a 2020 2020 2020 2020 5061 7261  ic..        Para
+00045540: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
+00045550: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+00045560: 2020 746f 7069 6320 3a20 7374 722c 206c    topic : str, l
+00045570: 6973 745b 7374 725d 0a20 2020 2020 2020  ist[str].       
+00045580: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
+00045590: 2074 6f70 6963 2075 6e64 6572 2077 6869   topic under whi
+000455a0: 6368 2074 6f20 6c6f 6720 616e 2065 7665  ch to log an eve
+000455b0: 6e74 2e20 546f 206c 6f67 2074 6865 2073  nt. To log the s
+000455c0: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+000455d0: 6576 656e 7420 756e 6465 7220 6d75 6c74  event under mult
+000455e0: 6970 6c65 2074 6f70 6963 732c 2070 6173  iple topics, pas
+000455f0: 7320 6120 6c69 7374 206f 6620 746f 7069  s a list of topi
+00045600: 6320 6e61 6d65 732e 0a20 2020 2020 2020  c names..       
+00045610: 206d 7367 0a20 2020 2020 2020 2020 2020   msg.           
+00045620: 2045 7665 6e74 206d 6573 7361 6765 2074   Event message t
+00045630: 6f20 6c6f 672e 204e 6f74 6520 7468 6973  o log. Note this
+00045640: 206d 7573 7420 6265 206d 7367 7061 636b   must be msgpack
+00045650: 2073 6572 6961 6c69 7a61 626c 652e 0a0a   serializable...
+00045660: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+00045670: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00045680: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
+00045690: 2e6c 6f67 5f65 7665 6e74 0a20 2020 2020  .log_event.     
+000456a0: 2020 2022 2222 0a20 2020 2020 2020 2065     """.        e
+000456b0: 7665 6e74 203d 2028 7469 6d65 2829 2c20  vent = (time(), 
+000456c0: 6d73 6729 0a20 2020 2020 2020 2069 6620  msg).        if 
+000456d0: 6e6f 7420 6973 696e 7374 616e 6365 2874  not isinstance(t
+000456e0: 6f70 6963 2c20 7374 7229 3a0a 2020 2020  opic, str):.    
+000456f0: 2020 2020 2020 2020 666f 7220 7420 696e          for t in
+00045700: 2074 6f70 6963 3a0a 2020 2020 2020 2020   topic:.        
+00045710: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+00045720: 6e74 735b 745d 2e61 7070 656e 6428 6576  nts[t].append(ev
+00045730: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+00045740: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
+00045750: 636f 756e 7473 5b74 5d20 2b3d 2031 0a20  counts[t] += 1. 
+00045760: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00045770: 656c 662e 5f72 6570 6f72 745f 6576 656e  elf._report_even
+00045780: 7428 742c 2065 7665 6e74 290a 2020 2020  t(t, event).    
+00045790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000457a0: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
+000457b0: 735b 746f 7069 635d 2e61 7070 656e 6428  s[topic].append(
+000457c0: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
+000457d0: 2020 2073 656c 662e 6576 656e 745f 636f     self.event_co
+000457e0: 756e 7473 5b74 6f70 6963 5d20 2b3d 2031  unts[topic] += 1
+000457f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00045800: 662e 5f72 6570 6f72 745f 6576 656e 7428  f._report_event(
+00045810: 746f 7069 632c 2065 7665 6e74 290a 0a20  topic, event).. 
+00045820: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
+00045830: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
+00045840: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+00045850: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+00045860: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00045870: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00045880: 6c75 6769 6e2e 6c6f 675f 6576 656e 7428  lugin.log_event(
+00045890: 746f 7069 632c 206d 7367 290a 2020 2020  topic, msg).    
+000458a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+000458b0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+000458c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000458d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2250    logger.info("P
+000458e0: 6c75 6769 6e20 6661 696c 6564 2077 6974  lugin failed wit
+000458f0: 6820 6578 6365 7074 696f 6e22 2c20 6578  h exception", ex
+00045900: 635f 696e 666f 3d54 7275 6529 0a0a 2020  c_info=True)..  
+00045910: 2020 6465 6620 5f72 6570 6f72 745f 6576    def _report_ev
+00045920: 656e 7428 7365 6c66 2c20 6e61 6d65 2c20  ent(self, name, 
+00045930: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00045940: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+00045950: 2020 2020 226f 7022 3a20 2265 7665 6e74      "op": "event
+00045960: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00045970: 746f 7069 6322 3a20 6e61 6d65 2c0a 2020  topic": name,.  
+00045980: 2020 2020 2020 2020 2020 2265 7665 6e74            "event
+00045990: 223a 2065 7665 6e74 2c0a 2020 2020 2020  ": event,.      
+000459a0: 2020 7d0a 2020 2020 2020 2020 636c 6965    }.        clie
+000459b0: 6e74 5f6d 7367 7320 3d20 7b63 6c69 656e  nt_msgs = {clien
+000459c0: 743a 205b 6d73 675d 2066 6f72 2063 6c69  t: [msg] for cli
+000459d0: 656e 7420 696e 2073 656c 662e 6576 656e  ent in self.even
+000459e0: 745f 7375 6273 6372 6962 6572 5b6e 616d  t_subscriber[nam
+000459f0: 655d 7d0a 2020 2020 2020 2020 7365 6c66  e]}.        self
+00045a00: 2e73 656e 645f 616c 6c28 636c 6965 6e74  .send_all(client
+00045a10: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+00045a20: 6773 3d7b 7d29 0a0a 2020 2020 6465 6620  gs={})..    def 
+00045a30: 7375 6273 6372 6962 655f 746f 7069 6328  subscribe_topic(
+00045a40: 7365 6c66 2c20 746f 7069 632c 2063 6c69  self, topic, cli
+00045a50: 656e 7429 3a0a 2020 2020 2020 2020 7365  ent):.        se
+00045a60: 6c66 2e65 7665 6e74 5f73 7562 7363 7269  lf.event_subscri
+00045a70: 6265 725b 746f 7069 635d 2e61 6464 2863  ber[topic].add(c
+00045a80: 6c69 656e 7429 0a0a 2020 2020 6465 6620  lient)..    def 
+00045a90: 756e 7375 6273 6372 6962 655f 746f 7069  unsubscribe_topi
+00045aa0: 6328 7365 6c66 2c20 746f 7069 632c 2063  c(self, topic, c
+00045ab0: 6c69 656e 7429 3a0a 2020 2020 2020 2020  lient):.        
+00045ac0: 7365 6c66 2e65 7665 6e74 5f73 7562 7363  self.event_subsc
+00045ad0: 7269 6265 725b 746f 7069 635d 2e64 6973  riber[topic].dis
+00045ae0: 6361 7264 2863 6c69 656e 7429 0a0a 2020  card(client)..  
+00045af0: 2020 6465 6620 6765 745f 6576 656e 7473    def get_events
+00045b00: 2873 656c 662c 2074 6f70 6963 3d4e 6f6e  (self, topic=Non
+00045b10: 6529 3a0a 2020 2020 2020 2020 6966 2074  e):.        if t
+00045b20: 6f70 6963 2069 7320 6e6f 7420 4e6f 6e65  opic is not None
+00045b30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00045b40: 7475 726e 2074 7570 6c65 2873 656c 662e  turn tuple(self.
+00045b50: 6576 656e 7473 5b74 6f70 6963 5d29 0a20  events[topic]). 
+00045b60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00045b70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00045b80: 7661 6c6d 6170 2874 7570 6c65 2c20 7365  valmap(tuple, se
+00045b90: 6c66 2e65 7665 6e74 7329 0a0a 2020 2020  lf.events)..    
+00045ba0: 6173 796e 6320 6465 6620 6765 745f 776f  async def get_wo
+00045bb0: 726b 6572 5f6d 6f6e 6974 6f72 5f69 6e66  rker_monitor_inf
+00045bc0: 6f28 7365 6c66 2c20 7265 6365 6e74 3d46  o(self, recent=F
+00045bd0: 616c 7365 2c20 7374 6172 7473 3d4e 6f6e  alse, starts=Non
+00045be0: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
+00045bf0: 7461 7274 7320 6973 204e 6f6e 653a 0a20  tarts is None:. 
+00045c00: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00045c10: 7320 3d20 7b7d 0a20 2020 2020 2020 2072  s = {}.        r
+00045c20: 6573 756c 7473 203d 2061 7761 6974 2061  esults = await a
+00045c30: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
+00045c40: 2020 2020 2020 2020 2020 202a 280a 2020             *(.  
+00045c50: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00045c60: 6c66 2e72 7063 2877 292e 6765 745f 6d6f  lf.rpc(w).get_mo
+00045c70: 6e69 746f 725f 696e 666f 2872 6563 656e  nitor_info(recen
+00045c80: 743d 7265 6365 6e74 2c20 7374 6172 743d  t=recent, start=
+00045c90: 7374 6172 7473 2e67 6574 2877 2c20 3029  starts.get(w, 0)
+00045ca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00045cb0: 2020 666f 7220 7720 696e 2073 656c 662e    for w in self.
+00045cc0: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00045cd0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+00045ce0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00045cf0: 6963 7428 7a69 7028 7365 6c66 2e77 6f72  ict(zip(self.wor
+00045d00: 6b65 7273 2c20 7265 7375 6c74 7329 290a  kers, results)).
+00045d10: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00045d20: 0a20 2020 2023 2043 6c65 616e 7570 2023  .    # Cleanup #
+00045d30: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00045d40: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00045d50: 6368 6563 6b5f 776f 726b 6572 5f74 746c  check_worker_ttl
+00045d60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00045d70: 6e6f 7720 3d20 7469 6d65 2829 0a20 2020  now = time().   
+00045d80: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00045d90: 203d 2066 2263 6865 636b 2d77 6f72 6b65   = f"check-worke
+00045da0: 722d 7474 6c2d 7b6e 6f77 7d22 0a20 2020  r-ttl-{now}".   
+00045db0: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
+00045dc0: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
+00045dd0: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+00045de0: 2020 6966 2028 7773 2e6c 6173 745f 7365    if (ws.last_se
+00045df0: 656e 203c 206e 6f77 202d 2073 656c 662e  en < now - self.
+00045e00: 776f 726b 6572 5f74 746c 2920 616e 6420  worker_ttl) and 
+00045e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00045e20: 2020 7773 2e6c 6173 745f 7365 656e 203c    ws.last_seen <
+00045e30: 206e 6f77 202d 2031 3020 2a20 6865 6172   now - 10 * hear
+00045e40: 7462 6561 745f 696e 7465 7276 616c 286c  tbeat_interval(l
+00045e50: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
+00045e60: 290a 2020 2020 2020 2020 2020 2020 293a  ).            ):
+00045e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045e80: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00045e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045ea0: 2020 2020 2022 576f 726b 6572 2066 6169       "Worker fai
+00045eb0: 6c65 6420 746f 2068 6561 7274 6265 6174  led to heartbeat
+00045ec0: 2077 6974 6869 6e20 2573 2073 6563 6f6e   within %s secon
+00045ed0: 6473 2e20 436c 6f73 696e 673a 2025 7322  ds. Closing: %s"
+00045ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00045ef0: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
+00045f00: 725f 7474 6c2c 0a20 2020 2020 2020 2020  r_ttl,.         
+00045f10: 2020 2020 2020 2020 2020 2077 732c 0a20             ws,. 
+00045f20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00045f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045f40: 2061 7761 6974 2073 656c 662e 7265 6d6f   await self.remo
+00045f50: 7665 5f77 6f72 6b65 7228 6164 6472 6573  ve_worker(addres
+00045f60: 733d 7773 2e61 6464 7265 7373 2c20 7374  s=ws.address, st
+00045f70: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+00045f80: 7573 5f69 6429 0a0a 2020 2020 6465 6620  us_id)..    def 
+00045f90: 6368 6563 6b5f 6964 6c65 2873 656c 6629  check_idle(self)
+00045fa0: 202d 3e20 666c 6f61 7420 7c20 4e6f 6e65   -> float | None
+00045fb0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+00045fc0: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
+00045fd0: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
+00045fe0: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
+00045ff0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00046000: 4e6f 6e65 0a0a 2020 2020 2020 2020 6966  None..        if
+00046010: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+00046020: 5f63 6f75 6e74 6572 2021 3d20 7365 6c66  _counter != self
+00046030: 2e5f 6964 6c65 5f74 7261 6e73 6974 696f  ._idle_transitio
+00046040: 6e5f 636f 756e 7465 723a 0a20 2020 2020  n_counter:.     
+00046050: 2020 2020 2020 2073 656c 662e 5f69 646c         self._idl
+00046060: 655f 7472 616e 7369 7469 6f6e 5f63 6f75  e_transition_cou
+00046070: 6e74 6572 203d 2073 656c 662e 7472 616e  nter = self.tran
+00046080: 7369 7469 6f6e 5f63 6f75 6e74 6572 0a20  sition_counter. 
+00046090: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000460a0: 6964 6c65 5f73 696e 6365 203d 204e 6f6e  idle_since = Non
+000460b0: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+000460c0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+000460d0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+000460e0: 2020 2020 7365 6c66 2e71 7565 7565 640a      self.queued.
+000460f0: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
+00046100: 656c 662e 756e 7275 6e6e 6162 6c65 0a20  elf.unrunnable. 
+00046110: 2020 2020 2020 2020 2020 206f 7220 616e             or an
+00046120: 7928 7773 2e70 726f 6365 7373 696e 6720  y(ws.processing 
+00046130: 666f 7220 7773 2069 6e20 7365 6c66 2e77  for ws in self.w
+00046140: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
+00046150: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+00046160: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+00046170: 655f 7369 6e63 6520 3d20 4e6f 6e65 0a20  e_since = None. 
+00046180: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046190: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+000461a0: 6966 206e 6f74 2073 656c 662e 6964 6c65  if not self.idle
+000461b0: 5f73 696e 6365 3a0a 2020 2020 2020 2020  _since:.        
+000461c0: 2020 2020 7365 6c66 2e69 646c 655f 7369      self.idle_si
+000461d0: 6e63 6520 3d20 7469 6d65 2829 0a20 2020  nce = time().   
+000461e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000461f0: 7365 6c66 2e69 646c 655f 7369 6e63 650a  self.idle_since.
+00046200: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00046210: 2e6a 7570 7974 6572 3a0a 2020 2020 2020  .jupyter:.      
+00046220: 2020 2020 2020 6c61 7374 5f61 6374 6976        last_activ
+00046230: 6974 7920 3d20 280a 2020 2020 2020 2020  ity = (.        
+00046240: 2020 2020 2020 2020 7365 6c66 2e5f 6a75          self._ju
+00046250: 7079 7465 725f 7365 7276 6572 5f61 7070  pyter_server_app
+00046260: 6c69 6361 7469 6f6e 2e77 6562 5f61 7070  lication.web_app
+00046270: 2e6c 6173 745f 6163 7469 7669 7479 2829  .last_activity()
+00046280: 2e74 696d 6573 7461 6d70 2829 0a20 2020  .timestamp().   
+00046290: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000462a0: 2020 2020 2020 2069 6620 6c61 7374 5f61         if last_a
+000462b0: 6374 6976 6974 7920 3e20 7365 6c66 2e69  ctivity > self.i
+000462c0: 646c 655f 7369 6e63 653a 0a20 2020 2020  dle_since:.     
+000462d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000462e0: 6964 6c65 5f73 696e 6365 203d 206c 6173  idle_since = las
+000462f0: 745f 6163 7469 7669 7479 0a20 2020 2020  t_activity.     
+00046300: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046310: 6e20 7365 6c66 2e69 646c 655f 7369 6e63  n self.idle_sinc
+00046320: 650a 0a20 2020 2020 2020 2069 6620 7365  e..        if se
+00046330: 6c66 2e69 646c 655f 7469 6d65 6f75 743a  lf.idle_timeout:
+00046340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00046350: 7469 6d65 2829 203e 2073 656c 662e 6964  time() > self.id
+00046360: 6c65 5f73 696e 6365 202b 2073 656c 662e  le_since + self.
+00046370: 6964 6c65 5f74 696d 656f 7574 3a0a 2020  idle_timeout:.  
+00046380: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00046390: 7365 7274 2073 656c 662e 6964 6c65 5f73  sert self.idle_s
+000463a0: 696e 6365 0a20 2020 2020 2020 2020 2020  ince.           
+000463b0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+000463c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000463d0: 2020 2020 2020 2253 6368 6564 756c 6572        "Scheduler
+000463e0: 2063 6c6f 7369 6e67 2061 6674 6572 2062   closing after b
+000463f0: 6569 6e67 2069 646c 6520 666f 7220 2573  eing idle for %s
+00046400: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00046410: 2020 2020 2020 2066 6f72 6d61 745f 7469         format_ti
+00046420: 6d65 2873 656c 662e 6964 6c65 5f74 696d  me(self.idle_tim
+00046430: 656f 7574 292c 0a20 2020 2020 2020 2020  eout),.         
+00046440: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00046450: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
+00046460: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
+00046470: 645f 7461 736b 732e 6361 6c6c 5f73 6f6f  d_tasks.call_soo
+00046480: 6e28 7365 6c66 2e63 6c6f 7365 290a 2020  n(self.close).  
+00046490: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000464a0: 662e 6964 6c65 5f73 696e 6365 0a0a 2020  f.idle_since..  
+000464b0: 2020 6465 6620 6164 6170 7469 7665 5f74    def adaptive_t
+000464c0: 6172 6765 7428 7365 6c66 2c20 7461 7267  arget(self, targ
+000464d0: 6574 5f64 7572 6174 696f 6e3d 4e6f 6e65  et_duration=None
+000464e0: 293a 0a20 2020 2020 2020 2022 2222 4465  ):.        """De
+000464f0: 7369 7265 6420 6e75 6d62 6572 206f 6620  sired number of 
+00046500: 776f 726b 6572 7320 6261 7365 6420 6f6e  workers based on
+00046510: 2074 6865 2063 7572 7265 6e74 2077 6f72   the current wor
+00046520: 6b6c 6f61 640a 0a20 2020 2020 2020 2054  kload..        T
+00046530: 6869 7320 6c6f 6f6b 7320 6174 2074 6865  his looks at the
+00046540: 2063 7572 7265 6e74 2072 756e 6e69 6e67   current running
+00046550: 2074 6173 6b73 2061 6e64 206d 656d 6f72   tasks and memor
+00046560: 7920 7573 652c 2061 6e64 2072 6574 7572  y use, and retur
+00046570: 6e73 2061 0a20 2020 2020 2020 206e 756d  ns a.        num
+00046580: 6265 7220 6f66 2064 6573 6972 6564 2077  ber of desired w
+00046590: 6f72 6b65 7273 2e20 2054 6869 7320 6973  orkers.  This is
+000465a0: 206f 6674 656e 2075 7365 6420 6279 2061   often used by a
+000465b0: 6461 7074 6976 6520 7363 6865 6475 6c69  daptive scheduli
+000465c0: 6e67 2e0a 0a20 2020 2020 2020 2050 6172  ng...        Par
+000465d0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+000465e0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+000465f0: 2020 2074 6172 6765 745f 6475 7261 7469     target_durati
+00046600: 6f6e 203a 2073 7472 0a20 2020 2020 2020  on : str.       
+00046610: 2020 2020 2041 2064 6573 6972 6564 2064       A desired d
+00046620: 7572 6174 696f 6e20 6f66 2074 696d 6520  uration of time 
+00046630: 666f 7220 636f 6d70 7574 6174 696f 6e73  for computations
+00046640: 2074 6f20 7461 6b65 2e20 2054 6869 7320   to take.  This 
+00046650: 6166 6665 6374 730a 2020 2020 2020 2020  affects.        
+00046660: 2020 2020 686f 7720 7261 7069 646c 7920      how rapidly 
+00046670: 7468 6520 7363 6865 6475 6c65 7220 7769  the scheduler wi
+00046680: 6c6c 2061 736b 2074 6f20 7363 616c 652e  ll ask to scale.
+00046690: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
+000466a0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+000466b0: 2d2d 2d0a 2020 2020 2020 2020 6469 7374  ---.        dist
+000466c0: 7269 6275 7465 642e 6465 706c 6f79 2e41  ributed.deploy.A
+000466d0: 6461 7074 6976 650a 2020 2020 2020 2020  daptive.        
+000466e0: 2222 220a 2020 2020 2020 2020 6966 2074  """.        if t
+000466f0: 6172 6765 745f 6475 7261 7469 6f6e 2069  arget_duration i
+00046700: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00046710: 2020 2020 7461 7267 6574 5f64 7572 6174      target_durat
+00046720: 696f 6e20 3d20 6461 736b 2e63 6f6e 6669  ion = dask.confi
+00046730: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+00046740: 6564 2e61 6461 7074 6976 652e 7461 7267  ed.adaptive.targ
+00046750: 6574 2d64 7572 6174 696f 6e22 290a 2020  et-duration").  
+00046760: 2020 2020 2020 7461 7267 6574 5f64 7572        target_dur
+00046770: 6174 696f 6e20 3d20 7061 7273 655f 7469  ation = parse_ti
+00046780: 6d65 6465 6c74 6128 7461 7267 6574 5f64  medelta(target_d
+00046790: 7572 6174 696f 6e29 0a0a 2020 2020 2020  uration)..      
+000467a0: 2020 2320 4350 550a 0a20 2020 2020 2020    # CPU..       
+000467b0: 2023 2054 4f44 4f20 636f 6e73 6964 6572   # TODO consider
+000467c0: 2061 6e79 2075 7365 722d 7370 6563 6966   any user-specif
+000467d0: 6965 6420 6465 6661 756c 7420 7461 736b  ied default task
+000467e0: 2064 7572 6174 696f 6e73 2066 6f72 2071   durations for q
+000467f0: 7565 7565 6420 7461 736b 730a 2020 2020  ueued tasks.    
+00046800: 2020 2020 7175 6575 6564 5f6f 6363 7570      queued_occup
+00046810: 616e 6379 203d 206c 656e 2873 656c 662e  ancy = len(self.
+00046820: 7175 6575 6564 2920 2a20 7365 6c66 2e55  queued) * self.U
+00046830: 4e4b 4e4f 574e 5f54 4153 4b5f 4455 5241  NKNOWN_TASK_DURA
+00046840: 5449 4f4e 0a20 2020 2020 2020 2063 7075  TION.        cpu
+00046850: 203d 206d 6174 682e 6365 696c 280a 2020   = math.ceil(.  
+00046860: 2020 2020 2020 2020 2020 2873 656c 662e            (self.
+00046870: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
+00046880: 2b20 7175 6575 6564 5f6f 6363 7570 616e  + queued_occupan
+00046890: 6379 2920 2f20 7461 7267 6574 5f64 7572  cy) / target_dur
+000468a0: 6174 696f 6e0a 2020 2020 2020 2020 2920  ation.        ) 
+000468b0: 2023 2054 4f44 4f3a 2074 6872 6561 6473   # TODO: threads
+000468c0: 2070 6572 2077 6f72 6b65 720a 0a20 2020   per worker..   
+000468d0: 2020 2020 2023 2041 766f 6964 2061 2066       # Avoid a f
+000468e0: 6577 206c 6f6e 6720 7461 736b 7320 6672  ew long tasks fr
+000468f0: 6f6d 2061 736b 696e 6720 666f 7220 6d61  om asking for ma
+00046900: 6e79 2063 6f72 6573 0a20 2020 2020 2020  ny cores.       
+00046910: 2074 6173 6b73 5f72 6561 6479 203d 206c   tasks_ready = l
+00046920: 656e 2873 656c 662e 7175 6575 6564 290a  en(self.queued).
+00046930: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+00046940: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+00046950: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+00046960: 2020 2020 2074 6173 6b73 5f72 6561 6479       tasks_ready
+00046970: 202b 3d20 6c65 6e28 7773 2e70 726f 6365   += len(ws.proce
+00046980: 7373 696e 6729 0a0a 2020 2020 2020 2020  ssing)..        
+00046990: 2020 2020 6966 2074 6173 6b73 5f72 6561      if tasks_rea
+000469a0: 6479 203e 2063 7075 3a0a 2020 2020 2020  dy > cpu:.      
+000469b0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+000469c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000469d0: 2020 2020 2020 2020 2020 6370 7520 3d20            cpu = 
+000469e0: 6d69 6e28 7461 736b 735f 7265 6164 792c  min(tasks_ready,
+000469f0: 2063 7075 290a 0a20 2020 2020 2020 2069   cpu)..        i
+00046a00: 6620 2873 656c 662e 756e 7275 6e6e 6162  f (self.unrunnab
+00046a10: 6c65 206f 7220 7365 6c66 2e71 7565 7565  le or self.queue
+00046a20: 6429 2061 6e64 206e 6f74 2073 656c 662e  d) and not self.
+00046a30: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+00046a40: 2020 2020 2063 7075 203d 206d 6178 2831       cpu = max(1
+00046a50: 2c20 6370 7529 0a0a 2020 2020 2020 2020  , cpu)..        
+00046a60: 2320 6164 6420 6d6f 7265 2077 6f72 6b65  # add more worke
+00046a70: 7273 2069 6620 6d6f 7265 2074 6861 6e20  rs if more than 
+00046a80: 3630 2520 6f66 206d 656d 6f72 7920 6973  60% of memory is
+00046a90: 2075 7365 640a 2020 2020 2020 2020 6c69   used.        li
+00046aa0: 6d69 7420 3d20 7375 6d28 7773 2e6d 656d  mit = sum(ws.mem
+00046ab0: 6f72 795f 6c69 6d69 7420 666f 7220 7773  ory_limit for ws
+00046ac0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00046ad0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+00046ae0: 2020 2075 7365 6420 3d20 7375 6d28 7773     used = sum(ws
+00046af0: 2e6e 6279 7465 7320 666f 7220 7773 2069  .nbytes for ws i
+00046b00: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+00046b10: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
+00046b20: 206d 656d 6f72 7920 3d20 300a 2020 2020   memory = 0.    
+00046b30: 2020 2020 6966 2075 7365 6420 3e20 302e      if used > 0.
+00046b40: 3620 2a20 6c69 6d69 7420 616e 6420 6c69  6 * limit and li
+00046b50: 6d69 7420 3e20 303a 0a20 2020 2020 2020  mit > 0:.       
+00046b60: 2020 2020 206d 656d 6f72 7920 3d20 3220       memory = 2 
+00046b70: 2a20 6c65 6e28 7365 6c66 2e77 6f72 6b65  * len(self.worke
+00046b80: 7273 290a 0a20 2020 2020 2020 2074 6172  rs)..        tar
+00046b90: 6765 7420 3d20 6d61 7828 6d65 6d6f 7279  get = max(memory
+00046ba0: 2c20 6370 7529 0a20 2020 2020 2020 2069  , cpu).        i
+00046bb0: 6620 7461 7267 6574 203e 3d20 6c65 6e28  f target >= len(
+00046bc0: 7365 6c66 2e77 6f72 6b65 7273 293a 0a20  self.workers):. 
+00046bd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046be0: 6e20 7461 7267 6574 0a20 2020 2020 2020  n target.       
+00046bf0: 2065 6c73 653a 2020 2320 5363 616c 6520   else:  # Scale 
+00046c00: 646f 776e 3f0a 2020 2020 2020 2020 2020  down?.          
+00046c10: 2020 746f 5f63 6c6f 7365 203d 2073 656c    to_close = sel
+00046c20: 662e 776f 726b 6572 735f 746f 5f63 6c6f  f.workers_to_clo
+00046c30: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+00046c40: 2072 6574 7572 6e20 6c65 6e28 7365 6c66   return len(self
+00046c50: 2e77 6f72 6b65 7273 2920 2d20 6c65 6e28  .workers) - len(
+00046c60: 746f 5f63 6c6f 7365 290a 0a20 2020 2064  to_close)..    d
+00046c70: 6566 2072 6571 7565 7374 5f61 6371 7569  ef request_acqui
+00046c80: 7265 5f72 6570 6c69 6361 7328 0a20 2020  re_replicas(.   
+00046c90: 2020 2020 2073 656c 662c 2061 6464 723a       self, addr:
+00046ca0: 2073 7472 2c20 6b65 7973 3a20 4974 6572   str, keys: Iter
+00046cb0: 6162 6c65 5b73 7472 5d2c 202a 2c20 7374  able[str], *, st
+00046cc0: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+00046cd0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00046ce0: 2020 2020 2020 2222 2241 7379 6e63 6872        """Asynchr
+00046cf0: 6f6e 6f75 736c 7920 6173 6b20 6120 776f  onously ask a wo
+00046d00: 726b 6572 2074 6f20 6163 7175 6972 6520  rker to acquire 
+00046d10: 6120 7265 706c 6963 6120 6f66 2074 6865  a replica of the
+00046d20: 206c 6973 7465 6420 6b65 7973 2066 726f   listed keys fro
+00046d30: 6d0a 2020 2020 2020 2020 6f74 6865 7220  m.        other 
+00046d40: 776f 726b 6572 732e 2054 6869 7320 6973  workers. This is
+00046d50: 2061 2066 6972 652d 616e 642d 666f 7267   a fire-and-forg
+00046d60: 6574 206f 7065 7261 7469 6f6e 2077 6869  et operation whi
+00046d70: 6368 206f 6666 6572 7320 6e6f 2066 6565  ch offers no fee
+00046d80: 6462 6163 6b20 666f 720a 2020 2020 2020  dback for.      
+00046d90: 2020 7375 6363 6573 7320 6f72 2066 6169    success or fai
+00046da0: 6c75 7265 2c20 616e 6420 6973 2069 6e74  lure, and is int
+00046db0: 656e 6465 6420 666f 7220 686f 7573 656b  ended for housek
+00046dc0: 6565 7069 6e67 2061 6e64 206e 6f74 2066  eeping and not f
+00046dd0: 6f72 2063 6f6d 7075 7461 7469 6f6e 2e0a  or computation..
+00046de0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00046df0: 2020 2020 7768 6f5f 6861 7320 3d20 7b7d      who_has = {}
+00046e00: 0a20 2020 2020 2020 206e 6279 7465 7320  .        nbytes 
+00046e10: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+00046e20: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
+00046e30: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00046e40: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00046e50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00046e60: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+00046e70: 2020 2020 2020 2020 2077 686f 5f68 6173           who_has
+00046e80: 5b6b 6579 5d20 3d20 5b77 732e 6164 6472  [key] = [ws.addr
+00046e90: 6573 7320 666f 7220 7773 2069 6e20 7473  ess for ws in ts
+00046ea0: 2e77 686f 5f68 6173 5d0a 2020 2020 2020  .who_has].      
+00046eb0: 2020 2020 2020 6e62 7974 6573 5b6b 6579        nbytes[key
+00046ec0: 5d20 3d20 7473 2e6e 6279 7465 730a 0a20  ] = ts.nbytes.. 
+00046ed0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+00046ee0: 616d 5f63 6f6d 6d73 5b61 6464 725d 2e73  am_comms[addr].s
+00046ef0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+00046f00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00046f10: 2020 2022 6f70 223a 2022 6163 7175 6972     "op": "acquir
+00046f20: 652d 7265 706c 6963 6173 222c 0a20 2020  e-replicas",.   
+00046f30: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
+00046f40: 6f5f 6861 7322 3a20 7768 6f5f 6861 732c  o_has": who_has,
+00046f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046f60: 2022 6e62 7974 6573 223a 206e 6279 7465   "nbytes": nbyte
+00046f70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00046f80: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
+00046f90: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
+00046fa0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00046fb0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00046fc0: 2072 6571 7565 7374 5f72 656d 6f76 655f   request_remove_
+00046fd0: 7265 706c 6963 6173 280a 2020 2020 2020  replicas(.      
+00046fe0: 2020 7365 6c66 2c20 6164 6472 3a20 7374    self, addr: st
+00046ff0: 722c 206b 6579 733a 206c 6973 745b 7374  r, keys: list[st
+00047000: 725d 2c20 2a2c 2073 7469 6d75 6c75 735f  r], *, stimulus_
+00047010: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
+00047020: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00047030: 2222 4173 796e 6368 726f 6e6f 7573 6c79  ""Asynchronously
+00047040: 2061 736b 2061 2077 6f72 6b65 7220 746f   ask a worker to
+00047050: 2064 6973 6361 7264 2069 7473 2072 6570   discard its rep
+00047060: 6c69 6361 206f 6620 7468 6520 6c69 7374  lica of the list
+00047070: 6564 206b 6579 732e 0a20 2020 2020 2020  ed keys..       
+00047080: 2054 6869 7320 6d75 7374 206e 6576 6572   This must never
+00047090: 2062 6520 7573 6564 2074 6f20 6465 7374   be used to dest
+000470a0: 726f 7920 7468 6520 6c61 7374 2072 6570  roy the last rep
+000470b0: 6c69 6361 206f 6620 6120 6b65 792e 2054  lica of a key. T
+000470c0: 6869 7320 6973 2061 0a20 2020 2020 2020  his is a.       
+000470d0: 2066 6972 652d 616e 642d 666f 7267 6574   fire-and-forget
+000470e0: 206f 7065 7261 7469 6f6e 2c20 696e 7465   operation, inte
+000470f0: 6e64 6564 2066 6f72 2068 6f75 7365 6b65  nded for houseke
+00047100: 6570 696e 6720 616e 6420 6e6f 7420 666f  eping and not fo
+00047110: 7220 636f 6d70 7574 6174 696f 6e2e 0a0a  r computation...
+00047120: 2020 2020 2020 2020 5468 6520 7265 706c          The repl
+00047130: 6963 6120 6469 7361 7070 6561 7273 2069  ica disappears i
+00047140: 6d6d 6564 6961 7465 6c79 2066 726f 6d20  mmediately from 
+00047150: 5461 736b 5374 6174 652e 7768 6f5f 6861  TaskState.who_ha
+00047160: 7320 6f6e 2074 6865 2053 6368 6564 756c  s on the Schedul
+00047170: 6572 2073 6964 653b 0a20 2020 2020 2020  er side;.       
+00047180: 2069 6620 7468 6520 776f 726b 6572 2072   if the worker r
+00047190: 6566 7573 6573 2074 6f20 6465 6c65 7465  efuses to delete
+000471a0: 2c20 652e 672e 2062 6563 6175 7365 2074  , e.g. because t
+000471b0: 6865 2074 6173 6b20 6973 2061 2064 6570  he task is a dep
+000471c0: 656e 6465 6e63 7920 6f66 0a20 2020 2020  endency of.     
+000471d0: 2020 2061 6e6f 7468 6572 2074 6173 6b20     another task 
+000471e0: 7275 6e6e 696e 6720 6f6e 2069 742c 2069  running on it, i
+000471f0: 7420 7769 6c6c 2028 616c 736f 2061 7379  t will (also asy
+00047200: 6e63 6872 6f6e 6f75 736c 7929 2069 6e66  nchronously) inf
+00047210: 6f72 6d20 7468 6520 7363 6865 6475 6c65  orm the schedule
+00047220: 720a 2020 2020 2020 2020 746f 2072 652d  r.        to re-
+00047230: 6164 6420 6974 7365 6c66 2074 6f20 7768  add itself to wh
+00047240: 6f5f 6861 732e 2049 6620 7468 6520 776f  o_has. If the wo
+00047250: 726b 6572 2061 6772 6565 7320 746f 2064  rker agrees to d
+00047260: 6973 6361 7264 2074 6865 2074 6173 6b2c  iscard the task,
+00047270: 2074 6865 7265 2069 730a 2020 2020 2020   there is.      
+00047280: 2020 6e6f 2066 6565 6462 6163 6b2e 0a20    no feedback.. 
+00047290: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000472a0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
+000472b0: 6b65 7273 5b61 6464 725d 0a0a 2020 2020  kers[addr]..    
+000472c0: 2020 2020 2320 5468 6520 7363 6865 6475      # The schedu
+000472d0: 6c65 7220 696d 6d65 6469 6174 656c 7920  ler immediately 
+000472e0: 666f 7267 6574 7320 6162 6f75 7420 7468  forgets about th
+000472f0: 6520 7265 706c 6963 6120 616e 6420 7375  e replica and su
+00047300: 6767 6573 7473 2074 6865 2077 6f72 6b65  ggests the worke
+00047310: 7220 746f 0a20 2020 2020 2020 2023 2064  r to.        # d
+00047320: 726f 7020 6974 2e20 5468 6520 776f 726b  rop it. The work
+00047330: 6572 206d 6179 2072 6566 7573 652c 2061  er may refuse, a
+00047340: 7420 7768 6963 6820 706f 696e 7420 6974  t which point it
+00047350: 2077 696c 6c20 7365 6e64 2062 6163 6b20   will send back 
+00047360: 616e 2061 6464 2d6b 6579 730a 2020 2020  an add-keys.    
+00047370: 2020 2020 2320 6d65 7373 6167 6520 746f      # message to
+00047380: 2072 6569 6e73 7461 7465 2069 742e 0a20   reinstate it.. 
+00047390: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+000473a0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+000473b0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+000473c0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+000473d0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+000473e0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+000473f0: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
+00047400: 6465 7374 726f 7920 7468 6520 6c61 7374  destroy the last
+00047410: 2063 6f70 790a 2020 2020 2020 2020 2020   copy.          
+00047420: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+00047430: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
+00047440: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00047450: 662e 7265 6d6f 7665 5f72 6570 6c69 6361  f.remove_replica
+00047460: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
+00047470: 2020 7365 6c66 2e73 7472 6561 6d5f 636f    self.stream_co
+00047480: 6d6d 735b 6164 6472 5d2e 7365 6e64 280a  mms[addr].send(.
+00047490: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000474a0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+000474b0: 7022 3a20 2272 656d 6f76 652d 7265 706c  p": "remove-repl
+000474c0: 6963 6173 222c 0a20 2020 2020 2020 2020  icas",.         
+000474d0: 2020 2020 2020 2022 6b65 7973 223a 206b         "keys": k
+000474e0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
+000474f0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+00047500: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
+00047510: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00047520: 2020 2020 2020 2029 0a0a 0a64 6566 205f         )...def _
+00047530: 7461 736b 5f74 6f5f 7265 706f 7274 5f6d  task_to_report_m
+00047540: 7367 2874 733a 2054 6173 6b53 7461 7465  sg(ts: TaskState
+00047550: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
+00047560: 6e79 5d20 7c20 4e6f 6e65 3a0a 2020 2020  ny] | None:.    
+00047570: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
+00047580: 666f 7267 6f74 7465 6e22 3a0a 2020 2020  forgotten":.    
+00047590: 2020 2020 7265 7475 726e 207b 226f 7022      return {"op"
+000475a0: 3a20 2263 616e 6365 6c6c 6564 2d6b 6579  : "cancelled-key
+000475b0: 7322 2c20 226b 6579 7322 3a20 5b74 732e  s", "keys": [ts.
+000475c0: 6b65 795d 7d0a 2020 2020 656c 6966 2074  key]}.    elif t
+000475d0: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+000475e0: 7279 223a 0a20 2020 2020 2020 2072 6574  ry":.        ret
+000475f0: 7572 6e20 7b22 6f70 223a 2022 6b65 792d  urn {"op": "key-
+00047600: 696e 2d6d 656d 6f72 7922 2c20 226b 6579  in-memory", "key
+00047610: 223a 2074 732e 6b65 797d 0a20 2020 2065  ": ts.key}.    e
+00047620: 6c69 6620 7473 2e73 7461 7465 203d 3d20  lif ts.state == 
+00047630: 2265 7272 6564 223a 0a20 2020 2020 2020  "erred":.       
+00047640: 2066 6169 6c69 6e67 5f74 7320 3d20 7473   failing_ts = ts
+00047650: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+00047660: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00047670: 6661 696c 696e 675f 7473 0a20 2020 2020  failing_ts.     
+00047680: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
+00047690: 2020 2020 2020 2020 226f 7022 3a20 2274          "op": "t
+000476a0: 6173 6b2d 6572 7265 6422 2c0a 2020 2020  ask-erred",.    
+000476b0: 2020 2020 2020 2020 226b 6579 223a 2074          "key": t
+000476c0: 732e 6b65 792c 0a20 2020 2020 2020 2020  s.key,.         
+000476d0: 2020 2022 6578 6365 7074 696f 6e22 3a20     "exception": 
+000476e0: 6661 696c 696e 675f 7473 2e65 7863 6570  failing_ts.excep
+000476f0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00047700: 2020 2274 7261 6365 6261 636b 223a 2066    "traceback": f
+00047710: 6169 6c69 6e67 5f74 732e 7472 6163 6562  ailing_ts.traceb
+00047720: 6163 6b2c 0a20 2020 2020 2020 207d 0a20  ack,.        }. 
+00047730: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00047740: 2072 6574 7572 6e20 4e6f 6e65 0a0a 0a64   return None...d
+00047750: 6566 205f 7461 736b 5f74 6f5f 636c 6965  ef _task_to_clie
+00047760: 6e74 5f6d 7367 7328 7473 3a20 5461 736b  nt_msgs(ts: Task
+00047770: 5374 6174 6529 202d 3e20 6469 6374 5b73  State) -> dict[s
+00047780: 7472 2c20 6c69 7374 5b64 6963 745b 7374  tr, list[dict[st
+00047790: 722c 2041 6e79 5d5d 5d3a 0a20 2020 2069  r, Any]]]:.    i
+000477a0: 6620 7473 2e77 686f 5f77 616e 7473 3a0a  f ts.who_wants:.
+000477b0: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
+000477c0: 7367 203d 205f 7461 736b 5f74 6f5f 7265  sg = _task_to_re
+000477d0: 706f 7274 5f6d 7367 2874 7329 0a20 2020  port_msg(ts).   
+000477e0: 2020 2020 2069 6620 7265 706f 7274 5f6d       if report_m
+000477f0: 7367 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sg is not None:.
+00047800: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00047810: 726e 207b 6373 2e63 6c69 656e 745f 6b65  rn {cs.client_ke
+00047820: 793a 205b 7265 706f 7274 5f6d 7367 5d20  y: [report_msg] 
+00047830: 666f 7220 6373 2069 6e20 7473 2e77 686f  for cs in ts.who
+00047840: 5f77 616e 7473 7d0a 2020 2020 7265 7475  _wants}.    retu
+00047850: 726e 207b 7d0a 0a0a 6465 6620 6465 6369  rn {}...def deci
+00047860: 6465 5f77 6f72 6b65 7228 0a20 2020 2074  de_worker(.    t
+00047870: 733a 2054 6173 6b53 7461 7465 2c0a 2020  s: TaskState,.  
+00047880: 2020 616c 6c5f 776f 726b 6572 733a 2049    all_workers: I
+00047890: 7465 7261 626c 655b 576f 726b 6572 5374  terable[WorkerSt
+000478a0: 6174 655d 2c0a 2020 2020 7661 6c69 645f  ate],.    valid_
+000478b0: 776f 726b 6572 733a 2073 6574 5b57 6f72  workers: set[Wor
+000478c0: 6b65 7253 7461 7465 5d20 7c20 4e6f 6e65  kerState] | None
+000478d0: 2c0a 2020 2020 6f62 6a65 6374 6976 653a  ,.    objective:
+000478e0: 2043 616c 6c61 626c 655b 5b57 6f72 6b65   Callable[[Worke
+000478f0: 7253 7461 7465 5d2c 2041 6e79 5d2c 0a29  rState], Any],.)
+00047900: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
+00047910: 7c20 4e6f 6e65 3a0a 2020 2020 2222 220a  | None:.    """.
+00047920: 2020 2020 4465 6369 6465 2077 6869 6368      Decide which
+00047930: 2077 6f72 6b65 7220 7368 6f75 6c64 2074   worker should t
+00047940: 616b 6520 7461 736b 202a 7473 2a2e 0a0a  ake task *ts*...
+00047950: 2020 2020 5765 2063 686f 6f73 6520 7468      We choose th
+00047960: 6520 776f 726b 6572 2074 6861 7420 6861  e worker that ha
+00047970: 7320 7468 6520 6461 7461 206f 6e20 7768  s the data on wh
+00047980: 6963 6820 2a74 732a 2064 6570 656e 6473  ich *ts* depends
+00047990: 2e0a 0a20 2020 2049 6620 7365 7665 7261  ...    If severa
+000479a0: 6c20 776f 726b 6572 7320 6861 7665 2064  l workers have d
+000479b0: 6570 656e 6465 6e63 6965 7320 7468 656e  ependencies then
+000479c0: 2077 6520 6368 6f6f 7365 2074 6865 206c   we choose the l
+000479d0: 6573 732d 6275 7379 2077 6f72 6b65 722e  ess-busy worker.
+000479e0: 0a0a 2020 2020 4f70 7469 6f6e 616c 6c79  ..    Optionally
+000479f0: 2070 726f 7669 6465 202a 7661 6c69 645f   provide *valid_
+00047a00: 776f 726b 6572 732a 206f 6620 7768 6572  workers* of wher
+00047a10: 6520 6a6f 6273 2061 7265 2061 6c6c 6f77  e jobs are allow
+00047a20: 6564 2074 6f20 6f63 6375 720a 2020 2020  ed to occur.    
+00047a30: 2869 6620 616c 6c20 776f 726b 6572 7320  (if all workers 
+00047a40: 6172 6520 616c 6c6f 7765 6420 746f 2074  are allowed to t
+00047a50: 616b 6520 7468 6520 7461 736b 2c20 7061  ake the task, pa
+00047a60: 7373 204e 6f6e 6520 696e 7374 6561 6429  ss None instead)
+00047a70: 2e0a 0a20 2020 2049 6620 7468 6520 7461  ...    If the ta
+00047a80: 736b 2072 6571 7569 7265 7320 6461 7461  sk requires data
+00047a90: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2062   communication b
+00047aa0: 6563 6175 7365 206e 6f20 656c 6967 6962  ecause no eligib
+00047ab0: 6c65 2077 6f72 6b65 7220 6861 730a 2020  le worker has.  
+00047ac0: 2020 616c 6c20 7468 6520 6465 7065 6e64    all the depend
+00047ad0: 656e 6369 6573 2061 6c72 6561 6479 2c20  encies already, 
+00047ae0: 7468 656e 2077 6520 6368 6f6f 7365 2074  then we choose t
+00047af0: 6f20 6d69 6e69 6d69 7a65 2074 6865 206e  o minimize the n
+00047b00: 756d 6265 720a 2020 2020 6f66 2062 7974  umber.    of byt
+00047b10: 6573 2073 656e 7420 6265 7477 6565 6e20  es sent between 
+00047b20: 776f 726b 6572 732e 2020 5468 6973 2069  workers.  This i
+00047b30: 7320 6465 7465 726d 696e 6564 2062 7920  s determined by 
+00047b40: 6361 6c6c 696e 6720 7468 650a 2020 2020  calling the.    
+00047b50: 2a6f 626a 6563 7469 7665 2a20 6675 6e63  *objective* func
+00047b60: 7469 6f6e 2e0a 2020 2020 2222 220a 2020  tion..    """.  
+00047b70: 2020 6173 7365 7274 2061 6c6c 2864 7473    assert all(dts
+00047b80: 2e77 686f 5f68 6173 2066 6f72 2064 7473  .who_has for dts
+00047b90: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00047ba0: 6965 7329 0a20 2020 2069 6620 7473 2e61  ies).    if ts.a
+00047bb0: 6374 6f72 3a0a 2020 2020 2020 2020 6361  ctor:.        ca
+00047bc0: 6e64 6964 6174 6573 203d 2073 6574 2861  ndidates = set(a
+00047bd0: 6c6c 5f77 6f72 6b65 7273 290a 2020 2020  ll_workers).    
+00047be0: 656c 7365 3a0a 2020 2020 2020 2020 6361  else:.        ca
+00047bf0: 6e64 6964 6174 6573 203d 207b 7777 7320  ndidates = {wws 
+00047c00: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+00047c10: 7065 6e64 656e 6369 6573 2066 6f72 2077  pendencies for w
+00047c20: 7773 2069 6e20 6474 732e 7768 6f5f 6861  ws in dts.who_ha
+00047c30: 737d 0a20 2020 2069 6620 7661 6c69 645f  s}.    if valid_
+00047c40: 776f 726b 6572 7320 6973 204e 6f6e 653a  workers is None:
+00047c50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00047c60: 6361 6e64 6964 6174 6573 3a0a 2020 2020  candidates:.    
+00047c70: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
+00047c80: 6573 203d 2073 6574 2861 6c6c 5f77 6f72  es = set(all_wor
+00047c90: 6b65 7273 290a 2020 2020 656c 7365 3a0a  kers).    else:.
+00047ca0: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
+00047cb0: 6573 2026 3d20 7661 6c69 645f 776f 726b  es &= valid_work
+00047cc0: 6572 730a 2020 2020 2020 2020 6966 206e  ers.        if n
+00047cd0: 6f74 2063 616e 6469 6461 7465 733a 0a20  ot candidates:. 
+00047ce0: 2020 2020 2020 2020 2020 2063 616e 6469             candi
+00047cf0: 6461 7465 7320 3d20 7661 6c69 645f 776f  dates = valid_wo
+00047d00: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
+00047d10: 2020 6966 206e 6f74 2063 616e 6469 6461    if not candida
+00047d20: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
+00047d30: 2020 2020 2069 6620 7473 2e6c 6f6f 7365       if ts.loose
+00047d40: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
+00047d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047d60: 2020 2072 6574 7572 6e20 6465 6369 6465     return decide
+00047d70: 5f77 6f72 6b65 7228 7473 2c20 616c 6c5f  _worker(ts, all_
+00047d80: 776f 726b 6572 732c 204e 6f6e 652c 206f  workers, None, o
+00047d90: 626a 6563 7469 7665 290a 0a20 2020 2069  bjective)..    i
+00047da0: 6620 6e6f 7420 6361 6e64 6964 6174 6573  f not candidates
+00047db0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00047dc0: 204e 6f6e 650a 2020 2020 656c 6966 206c   None.    elif l
+00047dd0: 656e 2863 616e 6469 6461 7465 7329 203d  en(candidates) =
+00047de0: 3d20 313a 0a20 2020 2020 2020 2072 6574  = 1:.        ret
+00047df0: 7572 6e20 6e65 7874 2869 7465 7228 6361  urn next(iter(ca
+00047e00: 6e64 6964 6174 6573 2929 0a20 2020 2065  ndidates)).    e
+00047e10: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
+00047e20: 7572 6e20 6d69 6e28 6361 6e64 6964 6174  urn min(candidat
+00047e30: 6573 2c20 6b65 793d 6f62 6a65 6374 6976  es, key=objectiv
+00047e40: 6529 0a0a 0a64 6566 2076 616c 6964 6174  e)...def validat
+00047e50: 655f 7461 736b 5f73 7461 7465 2874 733a  e_task_state(ts:
+00047e60: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
+00047e70: 6f6e 653a 0a20 2020 2022 2222 5661 6c69  one:.    """Vali
+00047e80: 6461 7465 2074 6865 2067 6976 656e 2054  date the given T
+00047e90: 6173 6b53 7461 7465 2222 220a 2020 2020  askState""".    
+00047ea0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
+00047eb0: 696e 2041 4c4c 5f54 4153 4b5f 5354 4154  in ALL_TASK_STAT
+00047ec0: 4553 2c20 7473 0a0a 2020 2020 6966 2074  ES, ts..    if t
+00047ed0: 732e 7761 6974 696e 675f 6f6e 3a0a 2020  s.waiting_on:.  
+00047ee0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00047ef0: 7761 6974 696e 675f 6f6e 2e69 7373 7562  waiting_on.issub
+00047f00: 7365 7428 7473 2e64 6570 656e 6465 6e63  set(ts.dependenc
+00047f10: 6965 7329 2c20 280a 2020 2020 2020 2020  ies), (.        
+00047f20: 2020 2020 2277 6169 7469 6e67 206e 6f74      "waiting not
+00047f30: 2073 7562 7365 7420 6f66 2064 6570 656e   subset of depen
+00047f40: 6465 6e63 6965 7322 2c0a 2020 2020 2020  dencies",.      
+00047f50: 2020 2020 2020 7374 7228 7473 2e77 6169        str(ts.wai
+00047f60: 7469 6e67 5f6f 6e29 2c0a 2020 2020 2020  ting_on),.      
+00047f70: 2020 2020 2020 7374 7228 7473 2e64 6570        str(ts.dep
+00047f80: 656e 6465 6e63 6965 7329 2c0a 2020 2020  endencies),.    
+00047f90: 2020 2020 290a 2020 2020 6966 2074 732e      ).    if ts.
+00047fa0: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
+00047fb0: 2061 7373 6572 7420 7473 2e77 6169 7465   assert ts.waite
+00047fc0: 7273 2e69 7373 7562 7365 7428 7473 2e64  rs.issubset(ts.d
+00047fd0: 6570 656e 6465 6e74 7329 2c20 280a 2020  ependents), (.  
+00047fe0: 2020 2020 2020 2020 2020 2277 6169 7465            "waite
+00047ff0: 7273 206e 6f74 2073 7562 7365 7420 6f66  rs not subset of
+00048000: 2064 6570 656e 6465 6e74 7322 2c0a 2020   dependents",.  
+00048010: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
+00048020: 2e77 6169 7465 7273 292c 0a20 2020 2020  .waiters),.     
+00048030: 2020 2020 2020 2073 7472 2874 732e 6465         str(ts.de
+00048040: 7065 6e64 656e 7473 292c 0a20 2020 2020  pendents),.     
+00048050: 2020 2029 0a0a 2020 2020 666f 7220 6474     )..    for dt
+00048060: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
+00048070: 6f6e 3a0a 2020 2020 2020 2020 6173 7365  on:.        asse
+00048080: 7274 206e 6f74 2064 7473 2e77 686f 5f68  rt not dts.who_h
+00048090: 6173 2c20 2822 7761 6974 696e 6720 6f6e  as, ("waiting on
+000480a0: 2069 6e2d 6d65 6d6f 7279 2064 6570 222c   in-memory dep",
+000480b0: 2073 7472 2874 7329 2c20 7374 7228 6474   str(ts), str(dt
+000480c0: 7329 290a 2020 2020 2020 2020 6173 7365  s)).        asse
+000480d0: 7274 2064 7473 2e73 7461 7465 2021 3d20  rt dts.state != 
+000480e0: 2272 656c 6561 7365 6422 2c20 2822 7761  "released", ("wa
+000480f0: 6974 696e 6720 6f6e 2072 656c 6561 7365  iting on release
+00048100: 6420 6465 7022 2c20 7374 7228 7473 292c  d dep", str(ts),
+00048110: 2073 7472 2864 7473 2929 0a20 2020 2066   str(dts)).    f
+00048120: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+00048130: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00048140: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00048150: 6474 732e 6465 7065 6e64 656e 7473 2c20  dts.dependents, 
+00048160: 280a 2020 2020 2020 2020 2020 2020 226e  (.            "n
+00048170: 6f74 2069 6e20 6465 7065 6e64 656e 6379  ot in dependency
+00048180: 2773 2064 6570 656e 6465 6e74 7322 2c0a  's dependents",.
+00048190: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+000481a0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+000481b0: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
+000481c0: 2020 2020 2020 2073 7472 2864 7473 2e64         str(dts.d
+000481d0: 6570 656e 6465 6e74 7329 2c0a 2020 2020  ependents),.    
+000481e0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+000481f0: 2074 732e 7374 6174 6520 696e 2028 2277   ts.state in ("w
+00048200: 6169 7469 6e67 222c 2022 7175 6575 6564  aiting", "queued
+00048210: 222c 2022 7072 6f63 6573 7369 6e67 222c  ", "processing",
+00048220: 2022 6e6f 2d77 6f72 6b65 7222 293a 0a20   "no-worker"):. 
+00048230: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00048240: 7420 6474 7320 696e 2074 732e 7761 6974  t dts in ts.wait
+00048250: 696e 675f 6f6e 206f 7220 6474 732e 7768  ing_on or dts.wh
+00048260: 6f5f 6861 732c 2028 0a20 2020 2020 2020  o_has, (.       
+00048270: 2020 2020 2020 2020 2022 6465 7020 6d69           "dep mi
+00048280: 7373 696e 6722 2c0a 2020 2020 2020 2020  ssing",.        
+00048290: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+000482a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000482b0: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
+000482c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000482d0: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
+000482e0: 6520 213d 2022 666f 7267 6f74 7465 6e22  e != "forgotten"
+000482f0: 0a0a 2020 2020 666f 7220 6474 7320 696e  ..    for dts in
+00048300: 2074 732e 7761 6974 6572 733a 0a20 2020   ts.waiters:.   
+00048310: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
+00048320: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
+00048330: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
+00048340: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
+00048350: 2d77 6f72 6b65 7222 292c 2028 0a20 2020  -worker"), (.   
+00048360: 2020 2020 2020 2020 2022 7761 6974 6572           "waiter
+00048370: 206e 6f74 2069 6e20 706c 6179 222c 0a20   not in play",. 
+00048380: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+00048390: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000483a0: 7374 7228 6474 7329 2c0a 2020 2020 2020  str(dts),.      
+000483b0: 2020 290a 2020 2020 666f 7220 6474 7320    ).    for dts 
+000483c0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
+000483d0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+000483e0: 2074 7320 696e 2064 7473 2e64 6570 656e   ts in dts.depen
+000483f0: 6465 6e63 6965 732c 2028 0a20 2020 2020  dencies, (.     
+00048400: 2020 2020 2020 2022 6e6f 7420 696e 2064         "not in d
+00048410: 6570 656e 6465 6e74 2773 2064 6570 656e  ependent's depen
+00048420: 6465 6e63 6965 7322 2c0a 2020 2020 2020  dencies",.      
+00048430: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+00048440: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
+00048450: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00048460: 2073 7472 2864 7473 2e64 6570 656e 6465   str(dts.depende
+00048470: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
+00048480: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00048490: 2064 7473 2e73 7461 7465 2021 3d20 2266   dts.state != "f
+000484a0: 6f72 676f 7474 656e 220a 0a20 2020 2061  orgotten"..    a
+000484b0: 7373 6572 7420 2874 732e 7072 6f63 6573  ssert (ts.proces
+000484c0: 7369 6e67 5f6f 6e20 6973 206e 6f74 204e  sing_on is not N
+000484d0: 6f6e 6529 203d 3d20 2874 732e 7374 6174  one) == (ts.stat
+000484e0: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
+000484f0: 2229 0a20 2020 2061 7373 6572 7420 626f  ").    assert bo
+00048500: 6f6c 2874 732e 7768 6f5f 6861 7329 203d  ol(ts.who_has) =
+00048510: 3d20 2874 732e 7374 6174 6520 3d3d 2022  = (ts.state == "
+00048520: 6d65 6d6f 7279 2229 2c20 2874 732c 2074  memory"), (ts, t
+00048530: 732e 7768 6f5f 6861 732c 2074 732e 7374  s.who_has, ts.st
+00048540: 6174 6529 0a0a 2020 2020 6966 2074 732e  ate)..    if ts.
+00048550: 7374 6174 6520 3d3d 2022 7175 6575 6564  state == "queued
+00048560: 223a 0a20 2020 2020 2020 2061 7373 6572  ":.        asser
+00048570: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+00048580: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+00048590: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+000485a0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
+000485b0: 6572 7420 616c 6c28 6474 732e 7768 6f5f  ert all(dts.who_
+000485c0: 6861 7320 666f 7220 6474 7320 696e 2074  has for dts in t
+000485d0: 732e 6465 7065 6e64 656e 6369 6573 292c  s.dependencies),
+000485e0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+000485f0: 7461 736b 2071 7565 7565 6420 7769 7468  task queued with
+00048600: 6f75 7420 616c 6c20 6465 7073 222c 0a20  out all deps",. 
+00048610: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+00048620: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00048630: 7374 7228 7473 2e64 6570 656e 6465 6e63  str(ts.dependenc
+00048640: 6965 7329 2c0a 2020 2020 2020 2020 290a  ies),.        ).
+00048650: 0a20 2020 2069 6620 7473 2e73 7461 7465  .    if ts.state
+00048660: 203d 3d20 2270 726f 6365 7373 696e 6722   == "processing"
+00048670: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00048680: 2061 6c6c 2864 7473 2e77 686f 5f68 6173   all(dts.who_has
+00048690: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+000486a0: 6570 656e 6465 6e63 6965 7329 2c20 280a  ependencies), (.
+000486b0: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
+000486c0: 6b20 7072 6f63 6573 7369 6e67 2077 6974  k processing wit
+000486d0: 686f 7574 2061 6c6c 2064 6570 7322 2c0a  hout all deps",.
+000486e0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+000486f0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00048700: 2073 7472 2874 732e 6465 7065 6e64 656e   str(ts.dependen
+00048710: 6369 6573 292c 0a20 2020 2020 2020 2029  cies),.        )
+00048720: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00048730: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
+00048740: 6e0a 0a20 2020 2069 6620 7473 2e77 686f  n..    if ts.who
+00048750: 5f68 6173 3a0a 2020 2020 2020 2020 6173  _has:.        as
+00048760: 7365 7274 2074 732e 7761 6974 6572 7320  sert ts.waiters 
+00048770: 6f72 2074 732e 7768 6f5f 7761 6e74 732c  or ts.who_wants,
+00048780: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+00048790: 756e 6e65 6564 6564 2074 6173 6b20 696e  unneeded task in
+000487a0: 206d 656d 6f72 7922 2c0a 2020 2020 2020   memory",.      
+000487b0: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+000487c0: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+000487d0: 732e 7768 6f5f 6861 7329 2c0a 2020 2020  s.who_has),.    
+000487e0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+000487f0: 2074 732e 7275 6e5f 7370 6563 3a20 2023   ts.run_spec:  #
+00048800: 2077 6173 2063 6f6d 7075 7465 640a 2020   was computed.  
+00048810: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00048820: 2074 732e 7479 7065 0a20 2020 2020 2020   ts.type.       
+00048830: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00048840: 7374 616e 6365 2874 732e 7479 7065 2c20  stance(ts.type, 
+00048850: 7374 7229 0a20 2020 2020 2020 2061 7373  str).        ass
+00048860: 6572 7420 6e6f 7420 616e 7928 5b74 7320  ert not any([ts 
+00048870: 696e 2064 7473 2e77 6169 7469 6e67 5f6f  in dts.waiting_o
+00048880: 6e20 666f 7220 6474 7320 696e 2074 732e  n for dts in ts.
+00048890: 6465 7065 6e64 656e 7473 5d29 0a20 2020  dependents]).   
+000488a0: 2020 2020 2066 6f72 2077 7320 696e 2074       for ws in t
+000488b0: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
+000488c0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000488d0: 2069 6e20 7773 2e68 6173 5f77 6861 742c   in ws.has_what,
+000488e0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+000488f0: 2020 2022 6e6f 7420 696e 2077 686f 5f68     "not in who_h
+00048900: 6173 2720 6861 735f 7768 6174 222c 0a20  as' has_what",. 
+00048910: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00048920: 7472 2874 7329 2c0a 2020 2020 2020 2020  tr(ts),.        
+00048930: 2020 2020 2020 2020 7374 7228 7773 292c          str(ws),
+00048940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048950: 2073 7472 2877 732e 6861 735f 7768 6174   str(ws.has_what
+00048960: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00048970: 0a0a 2020 2020 666f 7220 6373 2069 6e20  ..    for cs in 
+00048980: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
+00048990: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+000489a0: 696e 2063 732e 7761 6e74 735f 7768 6174  in cs.wants_what
+000489b0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+000489c0: 226e 6f74 2069 6e20 7768 6f5f 7761 6e74  "not in who_want
+000489d0: 7327 2077 616e 7473 5f77 6861 7422 2c0a  s' wants_what",.
+000489e0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+000489f0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00048a00: 2073 7472 2863 7329 2c0a 2020 2020 2020   str(cs),.      
+00048a10: 2020 2020 2020 7374 7228 6373 2e77 616e        str(cs.wan
+00048a20: 7473 5f77 6861 7429 2c0a 2020 2020 2020  ts_what),.      
+00048a30: 2020 290a 0a20 2020 2069 6620 7473 2e61    )..    if ts.a
+00048a40: 6374 6f72 3a0a 2020 2020 2020 2020 6966  ctor:.        if
+00048a50: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
+00048a60: 6d6f 7279 223a 0a20 2020 2020 2020 2020  mory":.         
+00048a70: 2020 2061 7373 6572 7420 7375 6d28 7473     assert sum(ts
+00048a80: 2069 6e20 7773 2e61 6374 6f72 7320 666f   in ws.actors fo
+00048a90: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
+00048aa0: 6173 2920 3d3d 2031 0a20 2020 2020 2020  as) == 1.       
+00048ab0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
+00048ac0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
+00048ad0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00048ae0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00048af0: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00048b00: 7365 7274 2074 7320 696e 2074 732e 7072  sert ts in ts.pr
+00048b10: 6f63 6573 7369 6e67 5f6f 6e2e 6163 746f  ocessing_on.acto
+00048b20: 7273 0a20 2020 2020 2020 2061 7373 6572  rs.        asser
+00048b30: 7420 7473 2e73 7461 7465 2021 3d20 2271  t ts.state != "q
+00048b40: 7565 7565 6422 0a0a 0a64 6566 2076 616c  ueued"...def val
+00048b50: 6964 6174 655f 776f 726b 6572 5f73 7461  idate_worker_sta
+00048b60: 7465 2877 733a 2057 6f72 6b65 7253 7461  te(ws: WorkerSta
+00048b70: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+00048b80: 2066 6f72 2074 7320 696e 2077 732e 6861   for ts in ws.ha
+00048b90: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
+00048ba0: 6173 7365 7274 2077 7320 696e 2074 732e  assert ws in ts.
+00048bb0: 7768 6f5f 6861 732c 2028 0a20 2020 2020  who_has, (.     
+00048bc0: 2020 2020 2020 2022 6e6f 7420 696e 2068         "not in h
+00048bd0: 6173 5f77 6861 7427 2077 686f 5f68 6173  as_what' who_has
+00048be0: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+00048bf0: 7472 2877 7329 2c0a 2020 2020 2020 2020  tr(ws),.        
+00048c00: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
+00048c10: 2020 2020 2020 2020 2073 7472 2874 732e           str(ts.
+00048c20: 7768 6f5f 6861 7329 2c0a 2020 2020 2020  who_has),.      
+00048c30: 2020 290a 0a20 2020 2066 6f72 2074 7320    )..    for ts 
+00048c40: 696e 2077 732e 6163 746f 7273 3a0a 2020  in ws.actors:.  
+00048c50: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00048c60: 7374 6174 6520 696e 2028 226d 656d 6f72  state in ("memor
+00048c70: 7922 2c20 2270 726f 6365 7373 696e 6722  y", "processing"
+00048c80: 290a 0a0a 6465 6620 7661 6c69 6461 7465  )...def validate
+00048c90: 5f73 7461 7465 280a 2020 2020 7461 736b  _state(.    task
+00048ca0: 733a 2064 6963 745b 7374 722c 2054 6173  s: dict[str, Tas
+00048cb0: 6b53 7461 7465 5d2c 0a20 2020 2077 6f72  kState],.    wor
+00048cc0: 6b65 7273 3a20 6469 6374 5b73 7472 2c20  kers: dict[str, 
+00048cd0: 576f 726b 6572 5374 6174 655d 2c0a 2020  WorkerState],.  
+00048ce0: 2020 636c 6965 6e74 733a 2064 6963 745b    clients: dict[
+00048cf0: 7374 722c 2043 6c69 656e 7453 7461 7465  str, ClientState
+00048d00: 5d2c 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ],.) -> None:.  
+00048d10: 2020 2222 2256 616c 6964 6174 6520 6120    """Validate a 
+00048d20: 6375 7272 656e 7420 7275 6e74 696d 6520  current runtime 
+00048d30: 7374 6174 652e 0a0a 2020 2020 5468 6973  state...    This
+00048d40: 2070 6572 666f 726d 7320 6120 7365 7175   performs a sequ
+00048d50: 656e 6365 206f 6620 6368 6563 6b73 206f  ence of checks o
+00048d60: 6e20 7468 6520 656e 7469 7265 2067 7261  n the entire gra
+00048d70: 7068 2c20 7275 6e6e 696e 6720 696e 2061  ph, running in a
+00048d80: 626f 7574 206c 696e 6561 720a 2020 2020  bout linear.    
+00048d90: 7469 6d65 2e20 5468 6973 2072 6169 7365  time. This raise
+00048da0: 7320 6173 7365 7274 2065 7272 6f72 7320  s assert errors 
+00048db0: 6966 2061 6e79 7468 696e 6720 646f 6573  if anything does
+00048dc0: 6e27 7420 6368 6563 6b20 6f75 742e 0a20  n't check out.. 
+00048dd0: 2020 2022 2222 0a20 2020 2066 6f72 2074     """.    for t
+00048de0: 7320 696e 2074 6173 6b73 2e76 616c 7565  s in tasks.value
+00048df0: 7328 293a 0a20 2020 2020 2020 2076 616c  s():.        val
+00048e00: 6964 6174 655f 7461 736b 5f73 7461 7465  idate_task_state
+00048e10: 2874 7329 0a0a 2020 2020 666f 7220 7773  (ts)..    for ws
+00048e20: 2069 6e20 776f 726b 6572 732e 7661 6c75   in workers.valu
+00048e30: 6573 2829 3a0a 2020 2020 2020 2020 7661  es():.        va
+00048e40: 6c69 6461 7465 5f77 6f72 6b65 725f 7374  lidate_worker_st
+00048e50: 6174 6528 7773 290a 0a20 2020 2066 6f72  ate(ws)..    for
+00048e60: 2063 7320 696e 2063 6c69 656e 7473 2e76   cs in clients.v
+00048e70: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+00048e80: 2066 6f72 2074 7320 696e 2063 732e 7761   for ts in cs.wa
+00048e90: 6e74 735f 7768 6174 3a0a 2020 2020 2020  nts_what:.      
+00048ea0: 2020 2020 2020 6173 7365 7274 2063 7320        assert cs 
+00048eb0: 696e 2074 732e 7768 6f5f 7761 6e74 732c  in ts.who_wants,
+00048ec0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00048ed0: 2020 2022 6e6f 7420 696e 2077 616e 7473     "not in wants
+00048ee0: 5f77 6861 7427 2077 686f 5f77 616e 7473  _what' who_wants
+00048ef0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00048f00: 2020 2073 7472 2863 7329 2c0a 2020 2020     str(cs),.    
+00048f10: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+00048f20: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00048f30: 2020 2020 2073 7472 2874 732e 7768 6f5f       str(ts.who_
+00048f40: 7761 6e74 7329 2c0a 2020 2020 2020 2020  wants),.        
+00048f50: 2020 2020 290a 0a0a 6465 6620 6865 6172      )...def hear
+00048f60: 7462 6561 745f 696e 7465 7276 616c 286e  tbeat_interval(n
+00048f70: 3a20 696e 7429 202d 3e20 666c 6f61 743a  : int) -> float:
+00048f80: 0a20 2020 2022 2222 496e 7465 7276 616c  .    """Interval
+00048f90: 2069 6e20 7365 636f 6e64 7320 7468 6174   in seconds that
+00048fa0: 2077 6520 6465 7369 7265 2068 6561 7274   we desire heart
+00048fb0: 6265 6174 7320 6261 7365 6420 6f6e 206e  beats based on n
+00048fc0: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
+00048fd0: 2222 220a 2020 2020 6966 206e 203c 3d20  """.    if n <= 
+00048fe0: 3130 3a0a 2020 2020 2020 2020 7265 7475  10:.        retu
+00048ff0: 726e 2030 2e35 0a20 2020 2065 6c69 6620  rn 0.5.    elif 
+00049000: 6e20 3c20 3530 3a0a 2020 2020 2020 2020  n < 50:.        
+00049010: 7265 7475 726e 2031 0a20 2020 2065 6c69  return 1.    eli
+00049020: 6620 6e20 3c20 3230 303a 0a20 2020 2020  f n < 200:.     
+00049030: 2020 2072 6574 7572 6e20 320a 2020 2020     return 2.    
+00049040: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
+00049050: 4e6f 206d 6f72 6520 7468 616e 2032 3030  No more than 200
+00049060: 2068 6561 7274 6265 6174 7320 6120 7365   heartbeats a se
+00049070: 636f 6e64 2073 6361 6c65 6420 6279 2077  cond scaled by w
+00049080: 6f72 6b65 7273 0a20 2020 2020 2020 2072  orkers.        r
+00049090: 6574 7572 6e20 6e20 2f20 3230 3020 2b20  eturn n / 200 + 
+000490a0: 310a 0a0a 6465 6620 5f74 6173 6b5f 736c  1...def _task_sl
+000490b0: 6f74 735f 6176 6169 6c61 626c 6528 7773  ots_available(ws
+000490c0: 3a20 576f 726b 6572 5374 6174 652c 2073  : WorkerState, s
+000490d0: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
+000490e0: 3a20 666c 6f61 7429 202d 3e20 696e 743a  : float) -> int:
+000490f0: 0a20 2020 2022 2222 4e75 6d62 6572 206f  .    """Number o
+00049100: 6620 7461 736b 7320 7468 6174 2063 616e  f tasks that can
+00049110: 2062 6520 7365 6e74 2074 6f20 7468 6973   be sent to this
+00049120: 2077 6f72 6b65 7220 7769 7468 6f75 7420   worker without 
+00049130: 6f76 6572 7361 7475 7261 7469 6e67 2069  oversaturating i
+00049140: 7422 2222 0a20 2020 2061 7373 6572 7420  t""".    assert 
+00049150: 6e6f 7420 6d61 7468 2e69 7369 6e66 2873  not math.isinf(s
+00049160: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
+00049170: 290a 2020 2020 7265 7475 726e 206d 6178  ).    return max
+00049180: 286d 6174 682e 6365 696c 2873 6174 7572  (math.ceil(satur
+00049190: 6174 696f 6e5f 6661 6374 6f72 202a 2077  ation_factor * w
+000491a0: 732e 6e74 6872 6561 6473 292c 2031 2920  s.nthreads), 1) 
+000491b0: 2d20 280a 2020 2020 2020 2020 6c65 6e28  - (.        len(
+000491c0: 7773 2e70 726f 6365 7373 696e 6729 202d  ws.processing) -
+000491d0: 206c 656e 2877 732e 6c6f 6e67 5f72 756e   len(ws.long_run
+000491e0: 6e69 6e67 290a 2020 2020 290a 0a0a 6465  ning).    )...de
+000491f0: 6620 5f77 6f72 6b65 725f 6675 6c6c 2877  f _worker_full(w
+00049200: 733a 2057 6f72 6b65 7253 7461 7465 2c20  s: WorkerState, 
+00049210: 7361 7475 7261 7469 6f6e 5f66 6163 746f  saturation_facto
+00049220: 723a 2066 6c6f 6174 2920 2d3e 2062 6f6f  r: float) -> boo
+00049230: 6c3a 0a20 2020 2069 6620 6d61 7468 2e69  l:.    if math.i
+00049240: 7369 6e66 2873 6174 7572 6174 696f 6e5f  sinf(saturation_
+00049250: 6661 6374 6f72 293a 0a20 2020 2020 2020  factor):.       
+00049260: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+00049270: 2020 7265 7475 726e 205f 7461 736b 5f73    return _task_s
+00049280: 6c6f 7473 5f61 7661 696c 6162 6c65 2877  lots_available(w
+00049290: 732c 2073 6174 7572 6174 696f 6e5f 6661  s, saturation_fa
+000492a0: 6374 6f72 2920 3c3d 2030 0a0a 0a63 6c61  ctor) <= 0...cla
+000492b0: 7373 204b 696c 6c65 6457 6f72 6b65 7228  ss KilledWorker(
+000492c0: 4578 6365 7074 696f 6e29 3a0a 2020 2020  Exception):.    
+000492d0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000492e0: 662c 2074 6173 6b3a 2073 7472 2c20 6c61  f, task: str, la
+000492f0: 7374 5f77 6f72 6b65 723a 2057 6f72 6b65  st_worker: Worke
+00049300: 7253 7461 7465 2c20 616c 6c6f 7765 645f  rState, allowed_
+00049310: 6661 696c 7572 6573 3a20 696e 7429 3a0a  failures: int):.
+00049320: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00049330: 5f5f 696e 6974 5f5f 2874 6173 6b2c 206c  __init__(task, l
+00049340: 6173 745f 776f 726b 6572 2c20 616c 6c6f  ast_worker, allo
+00049350: 7765 645f 6661 696c 7572 6573 290a 0a20  wed_failures).. 
+00049360: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00049370: 2064 6566 2074 6173 6b28 7365 6c66 2920   def task(self) 
+00049380: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+00049390: 7265 7475 726e 2073 656c 662e 6172 6773  return self.args
+000493a0: 5b30 5d0a 0a20 2020 2040 7072 6f70 6572  [0]..    @proper
+000493b0: 7479 0a20 2020 2064 6566 206c 6173 745f  ty.    def last_
+000493c0: 776f 726b 6572 2873 656c 6629 202d 3e20  worker(self) -> 
+000493d0: 576f 726b 6572 5374 6174 653a 0a20 2020  WorkerState:.   
+000493e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000493f0: 2e61 7267 735b 315d 0a0a 2020 2020 4070  .args[1]..    @p
+00049400: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00049410: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
+00049420: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+00049430: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00049440: 6c66 2e61 7267 735b 325d 0a0a 2020 2020  lf.args[2]..    
+00049450: 6465 6620 5f5f 7374 725f 5f28 7365 6c66  def __str__(self
+00049460: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00049470: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
+00049480: 2020 2020 2020 2066 2241 7474 656d 7074         f"Attempt
+00049490: 6564 2074 6f20 7275 6e20 7461 736b 207b  ed to run task {
+000494a0: 7365 6c66 2e74 6173 6b7d 206f 6e20 7b73  self.task} on {s
+000494b0: 656c 662e 616c 6c6f 7765 645f 6661 696c  elf.allowed_fail
+000494c0: 7572 6573 7d20 6469 6666 6572 656e 7420  ures} different 
+000494d0: 220a 2020 2020 2020 2020 2020 2020 2277  ".            "w
+000494e0: 6f72 6b65 7273 2c20 6275 7420 616c 6c20  orkers, but all 
+000494f0: 7468 6f73 6520 776f 726b 6572 7320 6469  those workers di
+00049500: 6564 2077 6869 6c65 2072 756e 6e69 6e67  ed while running
+00049510: 2069 742e 2022 0a20 2020 2020 2020 2020   it. ".         
+00049520: 2020 2066 2254 6865 206c 6173 7420 776f     f"The last wo
+00049530: 726b 6572 2074 6861 7420 6174 7465 6d70  rker that attemp
+00049540: 7420 746f 2072 756e 2074 6865 2074 6173  t to run the tas
+00049550: 6b20 7761 7320 7b73 656c 662e 6c61 7374  k was {self.last
+00049560: 5f77 6f72 6b65 722e 6164 6472 6573 737d  _worker.address}
+00049570: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+00049580: 2249 6e73 7065 6374 696e 6720 776f 726b  "Inspecting work
+00049590: 6572 206c 6f67 7320 6973 206f 6674 656e  er logs is often
+000495a0: 2061 2067 6f6f 6420 6e65 7874 2073 7465   a good next ste
+000495b0: 7020 746f 2064 6961 676e 6f73 6520 7768  p to diagnose wh
+000495c0: 6174 2077 656e 7420 7772 6f6e 672e 2022  at went wrong. "
+000495d0: 0a20 2020 2020 2020 2020 2020 2022 466f  .            "Fo
+000495e0: 7220 6d6f 7265 2069 6e66 6f72 6d61 7469  r more informati
+000495f0: 6f6e 2073 6565 2068 7474 7073 3a2f 2f64  on see https://d
+00049600: 6973 7472 6962 7574 6564 2e64 6173 6b2e  istributed.dask.
+00049610: 6f72 672f 656e 2f73 7461 626c 652f 6b69  org/en/stable/ki
+00049620: 6c6c 6564 2e68 746d 6c2e 220a 2020 2020  lled.html.".    
+00049630: 2020 2020 290a 0a0a 636c 6173 7320 576f      )...class Wo
+00049640: 726b 6572 5374 6174 7573 506c 7567 696e  rkerStatusPlugin
+00049650: 2853 6368 6564 756c 6572 506c 7567 696e  (SchedulerPlugin
+00049660: 293a 0a20 2020 2022 2222 4120 706c 7567  ):.    """A plug
+00049670: 696e 2074 6f20 7368 6172 6520 776f 726b  in to share work
+00049680: 6572 2073 7461 7475 7320 7769 7468 2061  er status with a
+00049690: 2072 656d 6f74 6520 6f62 7365 7276 6572   remote observer
+000496a0: 0a0a 2020 2020 5468 6973 2069 7320 7573  ..    This is us
+000496b0: 6564 2069 6e20 636c 7573 7465 7220 6d61  ed in cluster ma
+000496c0: 6e61 6765 7273 2074 6f20 6b65 6570 2075  nagers to keep u
+000496d0: 7064 6174 6564 2061 626f 7574 2074 6865  pdated about the
+000496e0: 2073 7461 7475 7320 6f66 2074 6865 2073   status of the s
+000496f0: 6368 6564 756c 6572 2e0a 2020 2020 2222  cheduler..    ""
+00049700: 220a 0a20 2020 206e 616d 653a 2043 6c61  "..    name: Cla
+00049710: 7373 5661 725b 7374 725d 203d 2022 776f  ssVar[str] = "wo
+00049720: 726b 6572 2d73 7461 7475 7322 0a20 2020  rker-status".   
+00049730: 2062 636f 6d6d 3a20 4261 7463 6865 6453   bcomm: BatchedS
+00049740: 656e 640a 0a20 2020 2064 6566 205f 5f69  end..    def __i
+00049750: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+00049760: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
+00049770: 2c20 636f 6d6d 3a20 436f 6d6d 293a 0a20  , comm: Comm):. 
+00049780: 2020 2020 2020 2073 656c 662e 6263 6f6d         self.bcom
+00049790: 6d20 3d20 4261 7463 6865 6453 656e 6428  m = BatchedSend(
+000497a0: 696e 7465 7276 616c 3d22 356d 7322 290a  interval="5ms").
+000497b0: 2020 2020 2020 2020 7365 6c66 2e62 636f          self.bco
+000497c0: 6d6d 2e73 7461 7274 2863 6f6d 6d29 0a20  mm.start(comm). 
+000497d0: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+000497e0: 2e61 6464 5f70 6c75 6769 6e28 7365 6c66  .add_plugin(self
+000497f0: 290a 0a20 2020 2064 6566 2061 6464 5f77  )..    def add_w
+00049800: 6f72 6b65 7228 7365 6c66 2c20 7363 6865  orker(self, sche
+00049810: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
+00049820: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
+00049830: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00049840: 6964 656e 7420 3d20 7363 6865 6475 6c65  ident = schedule
+00049850: 722e 776f 726b 6572 735b 776f 726b 6572  r.workers[worker
+00049860: 5d2e 6964 656e 7469 7479 2829 0a20 2020  ].identity().   
+00049870: 2020 2020 2064 656c 2069 6465 6e74 5b22       del ident["
+00049880: 6d65 7472 6963 7322 5d0a 2020 2020 2020  metrics"].      
+00049890: 2020 6465 6c20 6964 656e 745b 226c 6173    del ident["las
+000498a0: 745f 7365 656e 225d 0a20 2020 2020 2020  t_seen"].       
+000498b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000498c0: 2020 7365 6c66 2e62 636f 6d6d 2e73 656e    self.bcomm.sen
+000498d0: 6428 5b22 6164 6422 2c20 7b22 776f 726b  d(["add", {"work
+000498e0: 6572 7322 3a20 7b77 6f72 6b65 723a 2069  ers": {worker: i
+000498f0: 6465 6e74 7d7d 5d29 0a20 2020 2020 2020  dent}}]).       
+00049900: 2065 7863 6570 7420 436f 6d6d 436c 6f73   except CommClos
+00049910: 6564 4572 726f 723a 0a20 2020 2020 2020  edError:.       
+00049920: 2020 2020 2073 6368 6564 756c 6572 2e72       scheduler.r
+00049930: 656d 6f76 655f 706c 7567 696e 286e 616d  emove_plugin(nam
+00049940: 653d 7365 6c66 2e6e 616d 6529 0a0a 2020  e=self.name)..  
+00049950: 2020 6465 6620 7265 6d6f 7665 5f77 6f72    def remove_wor
+00049960: 6b65 7228 7365 6c66 2c20 7363 6865 6475  ker(self, schedu
+00049970: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
+00049980: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
+00049990: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
+000499a0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000499b0: 656c 662e 6263 6f6d 6d2e 7365 6e64 285b  elf.bcomm.send([
+000499c0: 2272 656d 6f76 6522 2c20 776f 726b 6572  "remove", worker
+000499d0: 5d29 0a20 2020 2020 2020 2065 7863 6570  ]).        excep
+000499e0: 7420 436f 6d6d 436c 6f73 6564 4572 726f  t CommClosedErro
+000499f0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+00049a00: 6368 6564 756c 6572 2e72 656d 6f76 655f  cheduler.remove_
+00049a10: 706c 7567 696e 286e 616d 653d 7365 6c66  plugin(name=self
+00049a20: 2e6e 616d 6529 0a0a 2020 2020 6465 6620  .name)..    def 
+00049a30: 7465 6172 646f 776e 2873 656c 6629 202d  teardown(self) -
+00049a40: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00049a50: 7365 6c66 2e62 636f 6d6d 2e63 6c6f 7365  self.bcomm.close
+00049a60: 2829 0a0a 0a63 6c61 7373 2043 6f6c 6c65  ()...class Colle
+00049a70: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
+00049a80: 7567 696e 2853 6368 6564 756c 6572 506c  ugin(SchedulerPl
+00049a90: 7567 696e 293a 0a20 2020 2073 6368 6564  ugin):.    sched
+00049aa0: 756c 6572 3a20 5363 6865 6475 6c65 720a  uler: Scheduler.
+00049ab0: 2020 2020 6e61 6d65 3a20 7374 720a 2020      name: str.  
+00049ac0: 2020 6b65 7973 3a20 7365 745b 7374 725d    keys: set[str]
+00049ad0: 0a20 2020 206d 6574 6164 6174 613a 2064  .    metadata: d
+00049ae0: 6963 745b 7374 722c 2041 6e79 5d0a 2020  ict[str, Any].  
+00049af0: 2020 7374 6174 653a 2064 6963 745b 7374    state: dict[st
+00049b00: 722c 2073 7472 5d0a 0a20 2020 2064 6566  r, str]..    def
+00049b10: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00049b20: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
+00049b30: 756c 6572 2c20 6e61 6d65 3a20 7374 7229  uler, name: str)
+00049b40: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+00049b50: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+00049b60: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
+00049b70: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
+00049b80: 2020 2020 2020 7365 6c66 2e6b 6579 7320        self.keys 
+00049b90: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00049ba0: 7365 6c66 2e6d 6574 6164 6174 6120 3d20  self.metadata = 
+00049bb0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00049bc0: 7374 6174 6520 3d20 7b7d 0a0a 2020 2020  state = {}..    
+00049bd0: 6465 6620 7570 6461 7465 5f67 7261 7068  def update_graph
+00049be0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00049bf0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00049c00: 723a 2053 6368 6564 756c 6572 2c0a 2020  r: Scheduler,.  
+00049c10: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00049c20: 206b 6579 733a 2073 6574 5b73 7472 5d2c   keys: set[str],
+00049c30: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00049c40: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+00049c50: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
+00049c60: 656c 662e 6b65 7973 2e75 7064 6174 6528  elf.keys.update(
+00049c70: 6b65 7973 290a 0a20 2020 2064 6566 2074  keys)..    def t
+00049c80: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
+00049c90: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00049ca0: 206b 6579 3a20 7374 722c 0a20 2020 2020   key: str,.     
+00049cb0: 2020 2073 7461 7274 3a20 5461 736b 5374     start: TaskSt
+00049cc0: 6174 6553 7461 7465 2c0a 2020 2020 2020  ateState,.      
+00049cd0: 2020 6669 6e69 7368 3a20 5461 736b 5374    finish: TaskSt
+00049ce0: 6174 6553 7461 7465 2c0a 2020 2020 2020  ateState,.      
+00049cf0: 2020 2a61 7267 733a 2041 6e79 2c0a 2020    *args: Any,.  
+00049d00: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+00049d10: 416e 792c 0a20 2020 2029 202d 3e20 4e6f  Any,.    ) -> No
+00049d20: 6e65 3a0a 2020 2020 2020 2020 6966 2066  ne:.        if f
+00049d30: 696e 6973 6820 696e 2028 226d 656d 6f72  inish in ("memor
+00049d40: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
+00049d50: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00049d60: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+00049d70: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+00049d80: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+00049d90: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
+00049da0: 732e 6b65 7920 696e 2073 656c 662e 6b65  s.key in self.ke
+00049db0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00049dc0: 2020 2020 7365 6c66 2e6d 6574 6164 6174      self.metadat
+00049dd0: 615b 6b65 795d 203d 2074 732e 6d65 7461  a[key] = ts.meta
+00049de0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+00049df0: 2020 2020 2073 656c 662e 7374 6174 655b       self.state[
+00049e00: 6b65 795d 203d 2066 696e 6973 680a 2020  key] = finish.  
+00049e10: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00049e20: 6c66 2e6b 6579 732e 6469 7363 6172 6428  lf.keys.discard(
+00049e30: 6b65 7929 0a                             key).
```

### Comparing `distributed-2023.5.0/distributed/security.py` & `distributed-2023.5.1/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/semaphore.py` & `distributed-2023.5.1/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/shuffle/__init__.py` & `distributed-2023.5.1/distributed/shuffle/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/shuffle/_arrow.py` & `distributed-2023.5.1/distributed/shuffle/_arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/shuffle/_buffer.py` & `distributed-2023.5.1/distributed/shuffle/_buffer.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,27 +1,27 @@
 from __future__ import annotations
 
 import asyncio
 import contextlib
 import logging
 from collections import defaultdict
-from collections.abc import Iterator
-from typing import Any, Generic, List, Sized, TypeVar
+from collections.abc import Iterator, Sized
+from typing import Any, Generic, TypeVar
 
 from distributed.metrics import time
 from distributed.shuffle._limiter import ResourceLimiter
 from distributed.sizeof import sizeof
 
 logger = logging.getLogger("distributed.shuffle")
 
 ShardType = TypeVar("ShardType", bound=Sized)
 T = TypeVar("T")
 
 
-class _List(List[T]):
+class _List(list[T]):
     # This ensures that the distributed.protocol will not iterate over this collection
     pass
 
 
 class ShardsBuffer(Generic[ShardType]):
     """A buffer for P2P shuffle
```

### Comparing `distributed-2023.5.0/distributed/shuffle/_comms.py` & `distributed-2023.5.1/distributed/shuffle/_comms.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 from __future__ import annotations
 
-from typing import Any, Awaitable, Callable
+from collections.abc import Awaitable, Callable
+from typing import Any
 
 from dask.utils import parse_bytes
 
 from distributed.shuffle._disk import ShardsBuffer
 from distributed.shuffle._limiter import ResourceLimiter
 from distributed.utils import log_errors
```

### Comparing `distributed-2023.5.0/distributed/shuffle/_disk.py` & `distributed-2023.5.1/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/shuffle/_limiter.py` & `distributed-2023.5.1/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/shuffle/_merge.py` & `distributed-2023.5.1/distributed/shuffle/_merge.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 # mypy: ignore-errors
 from __future__ import annotations
 
 from collections import defaultdict
-from typing import TYPE_CHECKING, Any, Iterable, Sequence
+from collections.abc import Iterable, Sequence
+from typing import TYPE_CHECKING, Any
 
 from dask.base import is_dask_collection, tokenize
 from dask.highlevelgraph import HighLevelGraph
 from dask.layers import Layer
 
 from distributed.shuffle._shuffle import (
     ShuffleId,
```

### Comparing `distributed-2023.5.0/distributed/shuffle/_rechunk.py` & `distributed-2023.5.1/distributed/shuffle/_rechunk.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,11 +1,12 @@
 from __future__ import annotations
 
+import math
 from collections import defaultdict
-from itertools import product
+from itertools import compress, product
 from typing import TYPE_CHECKING, NamedTuple
 
 import dask
 from dask.base import tokenize
 from dask.highlevelgraph import HighLevelGraph, MaterializedLayer
 
 from distributed.exceptions import Reschedule
@@ -20,19 +21,18 @@
 if TYPE_CHECKING:
     import numpy as np
     from typing_extensions import TypeAlias
 
     import dask.array as da
 
 
-# TODO remove quotes (requires Python >=3.9)
-ChunkedAxis: TypeAlias = "tuple[float, ...]"  # chunks must either be an int or NaN
-ChunkedAxes: TypeAlias = "tuple[ChunkedAxis, ...]"
-NIndex: TypeAlias = "tuple[int, ...]"
-NSlice: TypeAlias = "tuple[slice, ...]"
+ChunkedAxis: TypeAlias = tuple[float, ...]  # chunks must either be an int or NaN
+ChunkedAxes: TypeAlias = tuple[ChunkedAxis, ...]
+NIndex: TypeAlias = tuple[int, ...]
+NSlice: TypeAlias = tuple[slice, ...]
 
 
 def rechunk_transfer(
     input: np.ndarray,
     id: ShuffleId,
     input_chunk: NIndex,
     new: ChunkedAxes,
@@ -69,14 +69,42 @@
 
     import dask.array as da
 
     if x.size == 0:
         # Special case for empty array, as the algorithm below does not behave correctly
         return da.empty(x.shape, chunks=chunks, dtype=x.dtype)
 
+    old_chunks = x.chunks
+    new_chunks = chunks
+
+    def is_unknown(dim: ChunkedAxis) -> bool:
+        return any(math.isnan(chunk) for chunk in dim)
+
+    old_is_unknown = [is_unknown(dim) for dim in old_chunks]
+    new_is_unknown = [is_unknown(dim) for dim in new_chunks]
+
+    if old_is_unknown != new_is_unknown or any(
+        new != old for new, old in compress(zip(old_chunks, new_chunks), old_is_unknown)
+    ):
+        raise ValueError(
+            "Chunks must be unchanging along dimensions with missing values.\n\n"
+            "A possible solution:\n  x.compute_chunk_sizes()"
+        )
+
+    old_known = [dim for dim, unknown in zip(old_chunks, old_is_unknown) if not unknown]
+    new_known = [dim for dim, unknown in zip(new_chunks, new_is_unknown) if not unknown]
+
+    old_sizes = [sum(o) for o in old_known]
+    new_sizes = [sum(n) for n in new_known]
+
+    if old_sizes != new_sizes:
+        raise ValueError(
+            f"Cannot change dimensions from {old_sizes!r} to {new_sizes!r}"
+        )
+
     dsk: dict = {}
     token = tokenize(x, chunks)
     _barrier_key = barrier_key(ShuffleId(token))
     name = f"rechunk-transfer-{token}"
     transfer_keys = []
     for index in np.ndindex(tuple(len(dim) for dim in x.chunks)):
         transfer_keys.append((name,) + index)
```

### Comparing `distributed-2023.5.0/distributed/shuffle/_scheduler_extension.py` & `distributed-2023.5.1/distributed/shuffle/_scheduler_extension.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,18 +1,19 @@
 from __future__ import annotations
 
 import abc
 import contextlib
 import itertools
 import logging
 from collections import defaultdict
+from collections.abc import Callable, Iterable, Sequence
 from dataclasses import dataclass
 from functools import partial
 from itertools import product
-from typing import TYPE_CHECKING, Any, Callable, ClassVar, Iterable, Sequence
+from typing import TYPE_CHECKING, Any, ClassVar
 
 from distributed.diagnostics.plugin import SchedulerPlugin
 from distributed.shuffle._rechunk import ChunkedAxes, NIndex
 from distributed.shuffle._shuffle import (
     ShuffleId,
     ShuffleType,
     barrier_key,
```

### Comparing `distributed-2023.5.0/distributed/shuffle/_shuffle.py` & `distributed-2023.5.1/distributed/shuffle/_shuffle.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 
 import logging
+from collections.abc import Iterable, Iterator
 from enum import Enum
-from typing import TYPE_CHECKING, Any, Iterable, Iterator, NewType
+from typing import TYPE_CHECKING, Any, NewType, Union
 
 from dask.base import tokenize
 from dask.highlevelgraph import HighLevelGraph
 from dask.layers import Layer
 
 from distributed.exceptions import Reschedule
 from distributed.shuffle._arrow import check_dtype_support, check_minimal_arrow_version
@@ -122,17 +123,16 @@
         HighLevelGraph.from_collections(name, layer, [df]),
         name,
         empty,
         [None] * (npartitions + 1),
     )
 
 
-# TODO remove quotes (requires Python >=3.9)
-_T_Key: TypeAlias = "tuple[str, int] | str"
-_T_LowLevelGraph: TypeAlias = "dict[_T_Key, tuple]"
+_T_Key: TypeAlias = Union[tuple[str, int], str]
+_T_LowLevelGraph: TypeAlias = dict[_T_Key, tuple]
 
 
 class P2PShuffleLayer(Layer):
     def __init__(
         self,
         name: str,
         column: str,
```

### Comparing `distributed-2023.5.0/distributed/shuffle/_worker_extension.py` & `distributed-2023.5.1/distributed/shuffle/_worker_extension.py`

 * *Files 0% similar despite different names*

```diff
@@ -236,15 +236,14 @@
     @abc.abstractmethod
     async def get_output_partition(
         self, i: T_partition_id, key: str
     ) -> T_partition_type:
         """Get an output partition to the shuffle run"""
 
 
-# TODO remove quotes on tuple (requires Python >=3.9)
 class ArrayRechunkRun(ShuffleRun[ArrayRechunkShardID, NIndex, "np.ndarray"]):
     """State for a single active rechunk execution
 
     This object is responsible for splitting, sending, receiving and combining
     data shards.
 
     It is entirely agnostic to the distributed system and can perform a shuffle
@@ -298,37 +297,45 @@
         directory: str,
         executor: ThreadPoolExecutor,
         rpc: Callable[[str], PooledRPCCall],
         scheduler: PooledRPCCall,
         memory_limiter_disk: ResourceLimiter,
         memory_limiter_comms: ResourceLimiter,
     ):
-        from dask.array.rechunk import _old_to_new
+        from dask.array.rechunk import old_to_new
 
         super().__init__(
             id=id,
             run_id=run_id,
             output_workers=output_workers,
             local_address=local_address,
             directory=directory,
             executor=executor,
             rpc=rpc,
             scheduler=scheduler,
             memory_limiter_comms=memory_limiter_comms,
             memory_limiter_disk=memory_limiter_disk,
         )
+        from dask.array.core import normalize_chunks
+
+        # We rely on a canonical `np.nan` in `dask.array.rechunk.old_to_new`
+        # that passes an implicit identity check when testing for list equality.
+        # This does not work with (de)serialization, so we have to normalize the chunks
+        # here again to canonicalize `nan`s.
+        old = normalize_chunks(old)
+        new = normalize_chunks(new)
         self.old = old
         self.new = new
         partitions_of = defaultdict(list)
         for part, addr in worker_for.items():
             partitions_of[addr].append(part)
         self.partitions_of = dict(partitions_of)
         self.worker_for = worker_for
         self._slicing = rechunk_slicing(old, new)
-        self._old_to_new = _old_to_new(old, new)
+        self._old_to_new = old_to_new(old, new)
 
     async def _receive(self, data: list[tuple[ArrayRechunkShardID, bytes]]) -> None:
         self.raise_if_closed()
 
         buffers = defaultdict(list)
         for d in data:
             id, payload = d
```

### Comparing `distributed-2023.5.0/distributed/sizeof.py` & `distributed-2023.5.1/distributed/sizeof.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/spill.py` & `distributed-2023.5.1/distributed/spill.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,14 @@
 from __future__ import annotations
 
 import logging
 from collections import defaultdict
-from collections.abc import Hashable, Iterator, Mapping, Sized
+from collections.abc import Callable, Hashable, Iterator, Mapping, Sized
 from contextlib import contextmanager
 from functools import partial
-from typing import Callable  # TODO import from collections.abc (requires Python >=3.9)
 from typing import Literal, NamedTuple, Protocol, cast
 
 import zict
 
 from distributed.metrics import context_meter
 from distributed.protocol import deserialize_bytes, serialize_bytelist
 from distributed.protocol.compression import get_compression_settings
```

### Comparing `distributed-2023.5.0/distributed/stealing.py` & `distributed-2023.5.1/distributed/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/system.py` & `distributed-2023.5.1/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/system_monitor.py` & `distributed-2023.5.1/distributed/system_monitor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/threadpoolexecutor.py` & `distributed-2023.5.1/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/utils.py` & `distributed-2023.5.1/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/utils_comm.py` & `distributed-2023.5.1/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/utils_perf.py` & `distributed-2023.5.1/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/utils_test.py` & `distributed-2023.5.1/distributed/utils_test.py`

 * *Files 0% similar despite different names*

```diff
@@ -20,19 +20,19 @@
 import subprocess
 import sys
 import tempfile
 import threading
 import warnings
 import weakref
 from collections import defaultdict
-from collections.abc import Callable, Collection, Mapping
+from collections.abc import Callable, Collection, Generator, Iterator, Mapping
 from contextlib import contextmanager, nullcontext, suppress
 from itertools import count
 from time import sleep
-from typing import IO, Any, Generator, Iterator, Literal
+from typing import IO, Any, Literal
 
 import pytest
 import yaml
 from tlz import assoc, memoize, merge
 from tornado.httpclient import AsyncHTTPClient
 from tornado.ioloop import IOLoop
```

### Comparing `distributed-2023.5.0/distributed/variable.py` & `distributed-2023.5.1/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/versions.py` & `distributed-2023.5.1/distributed/versions.py`

 * *Files 4% similar despite different names*

```diff
@@ -29,21 +29,22 @@
     ("numpy", lambda p: p.__version__),
     ("pandas", lambda p: p.__version__),
     ("lz4", lambda p: p.__version__),
 ]
 
 
 # only these scheduler packages will be checked for version mismatch
-scheduler_relevant_packages = {pkg for pkg, _ in required_packages} | {"lz4", "python"}
+scheduler_relevant_packages = {pkg for pkg, _ in required_packages} | {
+    "lz4",
+    "python",
+} - {"msgpack"}
 
 
 # notes to be displayed for mismatch packages
-notes_mismatch_package = {
-    "msgpack": "Variation is ok, as long as everything is above 0.6"
-}
+notes_mismatch_package: dict[str, str] = {}
 
 
 def get_versions(
     packages: Iterable[str | tuple[str, Callable[[ModuleType], str | None]]]
     | None = None
 ) -> dict[str, dict[str, Any]]:
     """Return basic information on our software installation, and our installed versions
```

### Comparing `distributed-2023.5.0/distributed/widgets/templates/client.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/cluster.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/computation.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/computation.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/future.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/has_what.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/log.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/process_interface.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2023.5.1/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/worker.py` & `distributed-2023.5.1/distributed/worker.py`

 * *Files 0% similar despite different names*

```diff
@@ -61,15 +61,15 @@
 from distributed import preloading, profile, utils
 from distributed.batched import BatchedSend
 from distributed.collections import LRU
 from distributed.comm import Comm, connect, get_address_host, parse_address
 from distributed.comm import resolve_address as comm_resolve_address
 from distributed.comm.addressing import address_from_user_args
 from distributed.comm.utils import OFFLOAD_THRESHOLD
-from distributed.compatibility import PeriodicCallback, randbytes, to_thread
+from distributed.compatibility import PeriodicCallback
 from distributed.core import (
     ConnectionPool,
     PooledRPCCall,
     Status,
     coerce_to_address,
     context_meter_to_server_digest,
     error_message,
@@ -1602,15 +1602,17 @@
             # worker clients, semaphores, etc.
             if is_python_shutting_down():
                 # If we're shutting down there is no need to wait for daemon
                 # threads to finish
                 _close(executor=executor, wait=False)
             else:
                 try:
-                    await to_thread(_close, executor=executor, wait=executor_wait)
+                    await asyncio.to_thread(
+                        _close, executor=executor, wait=executor_wait
+                    )
                 except RuntimeError:  # Are we shutting down the process?
                     logger.error(
                         "Could not close executor %r by dispatching to thread. Trying synchronously.",
                         executor,
                         exc_info=True,
                     )
                     _close(
@@ -2906,15 +2908,15 @@
         return func(*map(execute_task, args))
     elif isinstance(task, list):
         return list(map(execute_task, task))
     else:
         return task
 
 
-cache_dumps = LRU(maxsize=100)
+cache_dumps: LRU[Callable[..., Any], bytes] = LRU(maxsize=100)
 
 _cache_lock = threading.Lock()
 
 
 def dumps_function(func) -> bytes:
     """Dump a function to bytes, cache functions"""
     try:
@@ -3439,15 +3441,15 @@
     out = {}
     for size_str in sizes:
         with tmpdir(dir=rootdir) as dir:
             dir = pathlib.Path(dir)
             names = list(map(str, range(100)))
             size = parse_bytes(size_str)
 
-            data = randbytes(size)
+            data = random.randbytes(size)
 
             start = time()
             total = 0
             while time() < start + duration:
                 with open(dir / random.choice(names), mode="ab") as f:
                     f.write(data)
                     f.flush()
@@ -3470,15 +3472,15 @@
     out: dict
         Maps sizes of outputs to measured bandwidths
     """
     duration = parse_timedelta(duration)
     out = {}
     for size_str in sizes:
         size = parse_bytes(size_str)
-        data = randbytes(size)
+        data = random.randbytes(size)
 
         start = time()
         total = 0
         while time() < start + duration:
             _ = data[:-1]
             del _
             total += size
@@ -3503,15 +3505,15 @@
     """
 
     duration = parse_timedelta(duration)
     out = {}
     async with rpc(address) as r:
         for size_str in sizes:
             size = parse_bytes(size_str)
-            data = to_serialize(randbytes(size))
+            data = to_serialize(random.randbytes(size))
 
             start = time()
             total = 0
             while time() < start + duration:
                 await r.echo(data=data)
                 total += size * 2
```

### Comparing `distributed-2023.5.0/distributed/worker_client.py` & `distributed-2023.5.1/distributed/worker_client.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/distributed/worker_memory.py` & `distributed-2023.5.1/distributed/worker_memory.py`

 * *Files 2% similar despite different names*

```diff
@@ -21,18 +21,18 @@
 from __future__ import annotations
 
 import asyncio
 import logging
 import os
 import sys
 import warnings
-from collections.abc import Callable, Hashable, MutableMapping
+from collections.abc import Callable, Container, Hashable, MutableMapping
 from contextlib import suppress
 from functools import partial
-from typing import TYPE_CHECKING, Any, Container, Literal, Union, cast
+from typing import TYPE_CHECKING, Any, Literal, Union, cast
 
 import psutil
 
 import dask.config
 from dask.system import CPU_COUNT
 from dask.utils import format_bytes, parse_bytes, parse_timedelta
 
@@ -48,29 +48,26 @@
     # TODO import from typing (requires Python >=3.10)
     from typing_extensions import TypeAlias
 
     # Circular imports
     from distributed.nanny import Nanny
     from distributed.worker import Worker
 
-    # TODO move outside of TYPE_CHECKING (requires Python >=3.9)
-    WorkerDataParameter: TypeAlias = Union[
-        # pre-initialized
-        MutableMapping[str, object],
-        # constructor
-        Callable[[], MutableMapping[str, object]],
-        # constructor, passed worker.local_directory
-        Callable[[str], MutableMapping[str, object]],
-        # (constructor, kwargs to constructor)
-        tuple[Callable[..., MutableMapping[str, object]], dict[str, Any]],
-        # initialize internally
-        None,
-    ]
-else:
-    WorkerDataParameter = object
+WorkerDataParameter: TypeAlias = Union[
+    # pre-initialized
+    MutableMapping[str, object],
+    # constructor
+    Callable[[], MutableMapping[str, object]],
+    # constructor, passed worker.local_directory
+    Callable[[str], MutableMapping[str, object]],
+    # (constructor, kwargs to constructor)
+    tuple[Callable[..., MutableMapping[str, object]], dict[str, Any]],
+    # initialize internally
+    None,
+]
 
 worker_logger = logging.getLogger("distributed.worker.memory")
 worker_logger.addFilter(RateLimiterFilter(r"Unmanaged memory use is high"))
 nanny_logger = logging.getLogger("distributed.nanny.memory")
 
 
 class WorkerMemoryManager:
```

### Comparing `distributed-2023.5.0/distributed/worker_state_machine.py` & `distributed-2023.5.1/distributed/worker_state_machine.py`

 * *Files 0% similar despite different names*

```diff
@@ -16,28 +16,29 @@
     Callable,
     Collection,
     Container,
     Hashable,
     Iterator,
     Mapping,
     MutableMapping,
+    Sequence,
     Set,
 )
 from copy import copy
 from dataclasses import dataclass, field
 from functools import lru_cache, partial, singledispatchmethod, wraps
 from itertools import chain
 from typing import (
     TYPE_CHECKING,
     Any,
     ClassVar,
     Literal,
     NamedTuple,
-    Sequence,
     TypedDict,
+    Union,
     cast,
 )
 
 from tlz import peekn
 
 import dask
 from dask.utils import key_split, parse_bytes, typename
@@ -1042,20 +1043,19 @@
 @dataclass
 class SecedeEvent(StateMachineEvent):
     __slots__ = ("key", "compute_duration")
     key: str
     compute_duration: float
 
 
-# TODO remove quotes (requires Python >=3.9)
 # {TaskState -> finish: TaskStateState | (finish: TaskStateState, transition *args)}
 # Not to be confused with distributed.scheduler.Recs
-Recs: TypeAlias = "dict[TaskState, TaskStateState | tuple]"
-Instructions: TypeAlias = "list[Instruction]"
-RecsInstrs: TypeAlias = "tuple[Recs, Instructions]"
+Recs: TypeAlias = dict[TaskState, Union[TaskStateState, tuple]]
+Instructions: TypeAlias = list[Instruction]
+RecsInstrs: TypeAlias = tuple[Recs, Instructions]
 
 
 def merge_recs_instructions(*args: RecsInstrs) -> RecsInstrs:
     """Merge multiple (recommendations, instructions) tuples.
     Collisions in recommendations are only allowed if identical.
     """
     recs: Recs = {}
```

### Comparing `distributed-2023.5.0/distributed.egg-info/PKG-INFO` & `distributed-2023.5.1/distributed.egg-info/PKG-INFO`

 * *Files 5% similar despite different names*

```diff
@@ -1,30 +1,29 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.5.0
+Version: 2023.5.1
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
 Classifier: Intended Audience :: Science/Research
 Classifier: License :: OSI Approved :: BSD License
 Classifier: Operating System :: OS Independent
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3 :: Only
-Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
 Classifier: Topic :: Scientific/Engineering
 Classifier: Topic :: System :: Distributed Computing
-Requires-Python: >=3.8
+Requires-Python: >=3.9
 Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 
 Distributed
 ===========
```

### Comparing `distributed-2023.5.0/distributed.egg-info/SOURCES.txt` & `distributed-2023.5.1/distributed.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/active_memory_manager.rst` & `distributed-2023.5.1/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/actors.rst` & `distributed-2023.5.1/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/api.rst` & `distributed-2023.5.1/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/asynchronous.rst` & `distributed-2023.5.1/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/changelog.rst` & `distributed-2023.5.1/docs/source/changelog.rst`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,47 @@
 Changelog
 =========
 
+.. _v2023.5.1:
+
+2023.5.1
+--------
+
+Released on May 26, 2023
+
+.. note::
+
+  This release drops support for Python 3.8. As of this release
+  Dask supports Python 3.9, 3.10, and 3.11.
+  See `this community issue <https://github.com/dask/community/issues/315>`_
+  for more details.
+
+Enhancements
+^^^^^^^^^^^^
+- Exclude IPython code from computations (:pr:`7788`) `Miles`_
+- Drop Python 3.8 support (:pr:`7840`) `Thomas Grainger`_
+- Add ``storage_options`` to ``performance_report`` (:pr:`7636`) `ypogorelova`_
+- Don't warn about mismatched ``msgpack`` (:pr:`7839`) `Irina Truong`_
+- Clean up ``sys.path`` on ``Server`` shutdown (:pr:`7838`) `James Bourbeau`_
+- Dashboard: Fine Performance Metrics (:pr:`7725`) `Miles`_
+
+Bug Fixes
+^^^^^^^^^
+- Properly handle unknown chunk sizes in P2P rechunking (:pr:`7856`) `Hendrik Makait`_
+- Minimal change to work around (:issue:`7726`) / support for UCX (:pr:`7851`) `Benjamin Zaitlen`_
+- Don't end computations until cluster is truly idle (:pr:`7790`) `crusaderky`_
+
+Maintenance
+^^^^^^^^^^^
+- Explicitly install ``anaconda-client`` from conda-forge when uploading conda nightlies (:pr:`7861`) `Charles Blackmon-Luca`_
+- Fix ``is_idle`` docs build (:pr:`7854`) `James Bourbeau`_
+- Add tests for P2P barrier fusion (:pr:`7845`) `Hendrik Makait`_
+- Avoid ``DeprecationWarning`` in ``cupy`` dispatch registration (:pr:`7836`) `Lawrence Mitchell`_
+
+
 .. _v2023.5.0:
 
 2023.5.0
 --------
 
 Released on May 12, 2023
 
@@ -4946,7 +4983,8 @@
 .. _`Dylan Wragge`: https://github.com/dwragge
 .. _`Nicholas R. Knezek`: https://github.com/nknezek
 .. _`antonymayi`: https://github.com/antonymayi
 .. _`Miles`: https://github.com/milesgranger
 .. _`Eugene Druzhynin`: https://github.com/eugene-graft
 .. _`ypogorelova`: https://github.com/ypogorelova
 .. _`Patrick Hoefler`: https://github.com/phofl
+.. _`Irina Truong`: https://github.com/j-bennet
```

### Comparing `distributed-2023.5.0/docs/source/client.rst` & `distributed-2023.5.1/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/communications.rst` & `distributed-2023.5.1/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/develop.rst` & `distributed-2023.5.1/docs/source/develop.rst`

 * *Files 1% similar despite different names*

```diff
@@ -16,15 +16,15 @@
 
      git clone git@github.com:dask/distributed.git
      cd distributed
 
 2. Install anaconda or miniconda (OS-dependent)
 3. ::
 
-     conda env create --file continuous_integration/environment-3.8.yaml
+     conda env create --file continuous_integration/environment-3.11.yaml
      conda activate dask-distributed
      python -m pip install -e .
 
 
 To keep a fork in sync with the upstream source::
 
    cd distributed
```

### Comparing `distributed-2023.5.0/docs/source/diagnosing-performance.rst` & `distributed-2023.5.1/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/efficiency.rst` & `distributed-2023.5.1/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/examples/word-count.rst` & `distributed-2023.5.1/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/faq.rst` & `distributed-2023.5.1/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/foundations.rst` & `distributed-2023.5.1/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/http_services.rst` & `distributed-2023.5.1/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/index.rst` & `distributed-2023.5.1/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/install.rst` & `distributed-2023.5.1/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/journey.rst` & `distributed-2023.5.1/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/killed.rst` & `distributed-2023.5.1/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/limitations.rst` & `distributed-2023.5.1/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/locality.rst` & `distributed-2023.5.1/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/logging.rst` & `distributed-2023.5.1/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/manage-computation.rst` & `distributed-2023.5.1/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/memory.rst` & `distributed-2023.5.1/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/plugins.rst` & `distributed-2023.5.1/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/priority.rst` & `distributed-2023.5.1/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/prometheus.rst` & `distributed-2023.5.1/docs/source/prometheus.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/protocol.rst` & `distributed-2023.5.1/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/publish.rst` & `distributed-2023.5.1/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/quickstart.rst` & `distributed-2023.5.1/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/related-work.rst` & `distributed-2023.5.1/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/resilience.rst` & `distributed-2023.5.1/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/resources.rst` & `distributed-2023.5.1/docs/source/resources.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/scheduling-policies.rst` & `distributed-2023.5.1/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/scheduling-state.rst` & `distributed-2023.5.1/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/serialization.rst` & `distributed-2023.5.1/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/task-launch.rst` & `distributed-2023.5.1/docs/source/task-launch.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/tls.rst` & `distributed-2023.5.1/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/work-stealing.rst` & `distributed-2023.5.1/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/worker-memory.rst` & `distributed-2023.5.1/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/worker-state.rst` & `distributed-2023.5.1/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/docs/source/worker.rst` & `distributed-2023.5.1/docs/source/worker.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.0/pyproject.toml` & `distributed-2023.5.1/pyproject.toml`

 * *Files 2% similar despite different names*

```diff
@@ -12,37 +12,36 @@
     "Intended Audience :: Developers",
     "Intended Audience :: Science/Research",
     "License :: OSI Approved :: BSD License",
     "Operating System :: OS Independent",
     "Programming Language :: Python",
     "Programming Language :: Python :: 3",
     "Programming Language :: Python :: 3 :: Only",
-    "Programming Language :: Python :: 3.8",
     "Programming Language :: Python :: 3.9",
     "Programming Language :: Python :: 3.10",
     "Programming Language :: Python :: 3.11",
     "Topic :: Scientific/Engineering",
     "Topic :: System :: Distributed Computing",
 ]
 readme = "README.rst"
-requires-python = ">=3.8"
+requires-python = ">=3.9"
 dependencies = [
     "click >= 8.0",
     "cloudpickle >= 1.5.0",
-    "dask == 2023.5.0",
+    "dask == 2023.5.1",
     "jinja2 >= 2.10.3",
     "locket >= 1.0.0",
     "msgpack >= 1.0.0",
     "packaging >= 20.0",
-    "psutil >= 5.7.0",
+    "psutil >= 5.7.2",
     "pyyaml >= 5.3.1",
     "sortedcontainers >= 2.0.5",
     "tblib >= 1.6.0",
     "toolz >= 0.10.0",
-    "tornado >= 6.0.3",
+    "tornado >= 6.0.4",
     "urllib3 >= 1.24.3",
     "zict >= 2.2.0",
 ]
 dynamic = ["version"]
 
 [project.urls]
 Homepage = "https://distributed.dask.org"
@@ -159,15 +158,14 @@
 # The CI script modifies this config file on the fly on Linux and MacOS.
 timeout_method = "thread"
 # This should not be reduced; Windows CI has been observed to be occasionally
 # exceptionally slow.
 timeout = 300
 
 [tool.mypy]
-# Silence errors about Python 3.9-style delayed type annotations on Python 3.8
 python_version = "3.9"
 # See https://github.com/python/mypy/issues/12286 for automatic multi-platform support
 platform = "linux"
 # platform = win32
 # platform = darwin
 allow_incomplete_defs = false
 allow_untyped_decorators = false
```

