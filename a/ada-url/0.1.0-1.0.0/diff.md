# Comparing `tmp/ada-url-0.1.0.tar.gz` & `tmp/ada-url-1.0.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ada-url-0.1.0.tar", last modified: Mon May 22 14:46:27 2023, max compression
+gzip compressed data, was "ada-url-1.0.0.tar", last modified: Fri May 26 14:08:04 2023, max compression
```

## Comparing `ada-url-0.1.0.tar` & `ada-url-1.0.0.tar`

### file list

```diff
@@ -1,24 +1,23 @@
-drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-22 14:46:27.374367 ada-url-0.1.0/
--rw-r--r--   0 bo.bayles   (501) staff       (20)     1060 2023-05-16 21:01:11.000000 ada-url-0.1.0/LICENSE
--rw-r--r--   0 bo.bayles   (501) staff       (20)     2614 2023-05-22 14:46:27.374539 ada-url-0.1.0/PKG-INFO
--rw-r--r--   0 bo.bayles   (501) staff       (20)     2113 2023-05-19 14:47:14.000000 ada-url-0.1.0/README.rst
-drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-22 14:46:27.352304 ada-url-0.1.0/ada_url/
--rw-r--r--   0 bo.bayles   (501) staff       (20)      241 2023-05-18 14:10:46.000000 ada-url-0.1.0/ada_url/__init__.py
--rwxr-xr-x   0 bo.bayles   (501) staff       (20)   605329 2023-05-19 21:11:47.000000 ada-url-0.1.0/ada_url/_ada_wrapper.abi3.so
--rw-r--r--   0 bo.bayles   (501) staff       (20)   852512 2023-05-19 21:11:24.000000 ada-url-0.1.0/ada_url/ada.cpp
--rw-r--r--   0 bo.bayles   (501) staff       (20)   232672 2023-05-19 21:11:24.000000 ada-url-0.1.0/ada_url/ada.h
--rw-r--r--   0 bo.bayles   (501) staff       (20)   480352 2023-05-22 14:46:25.000000 ada-url-0.1.0/ada_url/ada.o
--rw-r--r--   0 bo.bayles   (501) staff       (20)     8692 2023-05-19 21:11:24.000000 ada-url-0.1.0/ada_url/ada_adapter.py
--rw-r--r--   0 bo.bayles   (501) staff       (20)      616 2023-05-18 19:33:47.000000 ada-url-0.1.0/ada_url/ada_build.py
--rw-r--r--   0 bo.bayles   (501) staff       (20)     3515 2023-05-19 14:47:24.000000 ada-url-0.1.0/ada_url/ada_c.h
-drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-22 14:46:27.373004 ada-url-0.1.0/ada_url.egg-info/
--rw-r--r--   0 bo.bayles   (501) staff       (20)     2614 2023-05-22 14:46:27.000000 ada-url-0.1.0/ada_url.egg-info/PKG-INFO
--rw-r--r--   0 bo.bayles   (501) staff       (20)      381 2023-05-22 14:46:27.000000 ada-url-0.1.0/ada_url.egg-info/SOURCES.txt
--rw-r--r--   0 bo.bayles   (501) staff       (20)        1 2023-05-22 14:46:27.000000 ada-url-0.1.0/ada_url.egg-info/dependency_links.txt
--rw-r--r--   0 bo.bayles   (501) staff       (20)        5 2023-05-22 14:46:27.000000 ada-url-0.1.0/ada_url.egg-info/requires.txt
--rw-r--r--   0 bo.bayles   (501) staff       (20)        8 2023-05-22 14:46:27.000000 ada-url-0.1.0/ada_url.egg-info/top_level.txt
--rw-r--r--   0 bo.bayles   (501) staff       (20)      559 2023-05-19 21:11:24.000000 ada-url-0.1.0/pyproject.toml
--rw-r--r--   0 bo.bayles   (501) staff       (20)      863 2023-05-22 14:46:27.375620 ada-url-0.1.0/setup.cfg
--rw-r--r--   0 bo.bayles   (501) staff       (20)      111 2023-05-18 14:10:46.000000 ada-url-0.1.0/setup.py
-drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-22 14:46:27.373805 ada-url-0.1.0/tests/
--rw-r--r--   0 bo.bayles   (501) staff       (20)    10746 2023-05-19 21:11:24.000000 ada-url-0.1.0/tests/test_ada_url.py
+drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-26 14:08:03.990870 ada-url-1.0.0/
+-rw-r--r--   0 bo.bayles   (501) staff       (20)     1060 2023-05-16 21:01:11.000000 ada-url-1.0.0/LICENSE
+-rw-r--r--   0 bo.bayles   (501) staff       (20)     2702 2023-05-26 14:08:03.991093 ada-url-1.0.0/PKG-INFO
+-rw-r--r--   0 bo.bayles   (501) staff       (20)     2201 2023-05-25 21:23:19.000000 ada-url-1.0.0/README.rst
+drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-26 14:08:03.985338 ada-url-1.0.0/ada_url/
+-rw-r--r--   0 bo.bayles   (501) staff       (20)      241 2023-05-18 14:10:46.000000 ada-url-1.0.0/ada_url/__init__.py
+-rw-r--r--   0 bo.bayles   (501) staff       (20)   852821 2023-05-26 14:07:56.000000 ada-url-1.0.0/ada_url/ada.cpp
+-rw-r--r--   0 bo.bayles   (501) staff       (20)   232670 2023-05-26 14:07:56.000000 ada-url-1.0.0/ada_url/ada.h
+-rw-r--r--   0 bo.bayles   (501) staff       (20)   480352 2023-05-26 14:08:02.000000 ada-url-1.0.0/ada_url/ada.o
+-rw-r--r--   0 bo.bayles   (501) staff       (20)     8692 2023-05-25 14:16:18.000000 ada-url-1.0.0/ada_url/ada_adapter.py
+-rw-r--r--   0 bo.bayles   (501) staff       (20)      616 2023-05-25 14:02:56.000000 ada-url-1.0.0/ada_url/ada_build.py
+-rw-r--r--   0 bo.bayles   (501) staff       (20)     3515 2023-05-25 21:23:58.000000 ada-url-1.0.0/ada_url/ada_c.h
+drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-26 14:08:03.989095 ada-url-1.0.0/ada_url.egg-info/
+-rw-r--r--   0 bo.bayles   (501) staff       (20)     2702 2023-05-26 14:08:03.000000 ada-url-1.0.0/ada_url.egg-info/PKG-INFO
+-rw-r--r--   0 bo.bayles   (501) staff       (20)      352 2023-05-26 14:08:03.000000 ada-url-1.0.0/ada_url.egg-info/SOURCES.txt
+-rw-r--r--   0 bo.bayles   (501) staff       (20)        1 2023-05-26 14:08:03.000000 ada-url-1.0.0/ada_url.egg-info/dependency_links.txt
+-rw-r--r--   0 bo.bayles   (501) staff       (20)        5 2023-05-26 14:08:03.000000 ada-url-1.0.0/ada_url.egg-info/requires.txt
+-rw-r--r--   0 bo.bayles   (501) staff       (20)        8 2023-05-26 14:08:03.000000 ada-url-1.0.0/ada_url.egg-info/top_level.txt
+-rw-r--r--   0 bo.bayles   (501) staff       (20)      559 2023-05-19 21:11:24.000000 ada-url-1.0.0/pyproject.toml
+-rw-r--r--   0 bo.bayles   (501) staff       (20)      863 2023-05-26 14:08:03.998543 ada-url-1.0.0/setup.cfg
+-rw-r--r--   0 bo.bayles   (501) staff       (20)      111 2023-05-22 20:32:27.000000 ada-url-1.0.0/setup.py
+drwxr-xr-x   0 bo.bayles   (501) staff       (20)        0 2023-05-26 14:08:03.989904 ada-url-1.0.0/tests/
+-rw-r--r--   0 bo.bayles   (501) staff       (20)    10746 2023-05-19 21:11:24.000000 ada-url-1.0.0/tests/test_ada_url.py
```

### Comparing `ada-url-0.1.0/LICENSE` & `ada-url-1.0.0/LICENSE`

 * *Files identical despite different names*

### Comparing `ada-url-0.1.0/PKG-INFO` & `ada-url-1.0.0/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ada-url
-Version: 0.1.0
+Version: 1.0.0
 Summary: 'URL parser and manipulator based on the WHAT WG URL standard'
 Author: Bo Bayles
 Author-email: bo@bbayles.com
 License: Apache 2.0
 Project-URL: homepage, https://github.com/ada-url/ada-python
 Classifier: License :: OSI Approved :: Apache Software License
 Classifier: Programming Language :: Python :: 3
@@ -85,7 +85,9 @@
         'hostname': 'example.org',
         'pathname': '/api',
         'search': '?q=1',
         'hash': '#2'
     }
     >>> ada_url.replace_url('http://example.org:80', protocol='https:')
     'https://example.org/'
+
+You can find more documentation at `Read the Docs <https://ada-url.readthedocs.io>`__.
```

### Comparing `ada-url-0.1.0/README.rst` & `ada-url-1.0.0/README.rst`

 * *Files 4% similar despite different names*

```diff
@@ -70,7 +70,9 @@
         'hostname': 'example.org',
         'pathname': '/api',
         'search': '?q=1',
         'hash': '#2'
     }
     >>> ada_url.replace_url('http://example.org:80', protocol='https:')
     'https://example.org/'
+
+You can find more documentation at `Read the Docs <https://ada-url.readthedocs.io>`__.
```

### Comparing `ada-url-0.1.0/ada_url/ada.cpp` & `ada-url-1.0.0/ada_url/ada.cpp`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 00000000: 2f2a 2061 7574 6f2d 6765 6e65 7261 7465  /* auto-generate
-00000010: 6420 6f6e 2032 3032 332d 3035 2d31 3920  d on 2023-05-19 
-00000020: 3030 3a30 323a 3333 202d 3034 3030 2e20  00:02:33 -0400. 
+00000010: 6420 6f6e 2032 3032 332d 3035 2d32 3520  d on 2023-05-25 
+00000020: 3136 3a30 393a 3235 202d 3034 3030 2e20  16:09:25 -0400. 
 00000030: 446f 206e 6f74 2065 6469 7421 202a 2f0a  Do not edit! */.
 00000040: 2f2a 2062 6567 696e 2066 696c 6520 7372  /* begin file sr
 00000050: 632f 6164 612e 6370 7020 2a2f 0a23 696e  c/ada.cpp */.#in
 00000060: 636c 7564 6520 2261 6461 2e68 220a 2f2a  clude "ada.h"./*
 00000070: 2062 6567 696e 2066 696c 6520 7372 632f   begin file src/
 00000080: 6368 6563 6b65 7273 2e63 7070 202a 2f0a  checkers.cpp */.
 00000090: 2369 6e63 6c75 6465 203c 616c 676f 7269  #include <algori
@@ -40328,3001 +40328,3001 @@
 0009d870: 6f72 204e 6f6e 7472 616e 7369 7469 6f6e  or Nontransition
 0009d880: 616c 2050 726f 6365 7373 696e 672c 2065  al Processing, e
 0009d890: 6163 6820 7661 6c75 6520 6d75 7374 2062  ach value must b
 0009d8a0: 6520 6569 7468 6572 2076 616c 6964 206f  e either valid o
 0009d8b0: 720a 2020 2f2f 2064 6576 6961 7469 6f6e  r.  // deviation
 0009d8c0: 2e0a 0a20 202f 2f20 4966 2043 6865 636b  ...  // If Check
 0009d8d0: 4a6f 696e 6572 732c 2074 6865 206c 6162  Joiners, the lab
-0009d8e0: 656c 206d 7573 7420 7361 7469 7369 6679  el must satisify
-0009d8f0: 2074 6865 2043 6f6e 7465 7874 4a20 7275   the ContextJ ru
-0009d900: 6c65 7320 6672 6f6d 2041 7070 656e 6469  les from Appendi
-0009d910: 780a 2020 2f2f 2041 2c20 696e 2054 6865  x.  // A, in The
-0009d920: 2055 6e69 636f 6465 2043 6f64 6520 506f   Unicode Code Po
-0009d930: 696e 7473 2061 6e64 2049 6e74 6572 6e61  ints and Interna
-0009d940: 7469 6f6e 616c 697a 6564 2044 6f6d 6169  tionalized Domai
-0009d950: 6e20 4e61 6d65 7320 666f 720a 2020 2f2f  n Names for.  //
-0009d960: 2041 7070 6c69 6361 7469 6f6e 7320 2849   Applications (I
-0009d970: 444e 4129 205b 4944 4e41 3230 3038 5d2e  DNA) [IDNA2008].
-0009d980: 0a20 2063 6f6e 7374 6578 7072 2073 7461  .  constexpr sta
-0009d990: 7469 6320 7569 6e74 3332 5f74 2076 6972  tic uint32_t vir
-0009d9a0: 616d 615b 5d20 3d20 7b0a 2020 2020 2020  ama[] = {.      
-0009d9b0: 3078 3039 3444 2c20 2030 7830 3943 442c  0x094D,  0x09CD,
-0009d9c0: 2020 3078 3041 3444 2c20 2030 7830 4143    0x0A4D,  0x0AC
-0009d9d0: 442c 2020 3078 3042 3444 2c20 2030 7830  D,  0x0B4D,  0x0
-0009d9e0: 4243 442c 2020 3078 3043 3444 2c20 2030  BCD,  0x0C4D,  0
-0009d9f0: 7830 4343 442c 0a20 2020 2020 2030 7830  x0CCD,.      0x0
-0009da00: 4433 422c 2020 3078 3044 3343 2c20 2030  D3B,  0x0D3C,  0
-0009da10: 7830 4434 442c 2020 3078 3044 4341 2c20  x0D4D,  0x0DCA, 
-0009da20: 2030 7830 4533 412c 2020 3078 3045 4241   0x0E3A,  0x0EBA
-0009da30: 2c20 2030 7830 4638 342c 2020 3078 3130  ,  0x0F84,  0x10
-0009da40: 3339 2c0a 2020 2020 2020 3078 3130 3341  39,.      0x103A
-0009da50: 2c20 2030 7831 3731 342c 2020 3078 3137  ,  0x1714,  0x17
-0009da60: 3334 2c20 2030 7831 3744 322c 2020 3078  34,  0x17D2,  0x
-0009da70: 3141 3630 2c20 2030 7831 4234 342c 2020  1A60,  0x1B44,  
-0009da80: 3078 3142 4141 2c20 2030 7831 4241 422c  0x1BAA,  0x1BAB,
-0009da90: 0a20 2020 2020 2030 7831 4246 322c 2020  .      0x1BF2,  
-0009daa0: 3078 3142 4633 2c20 2030 7832 4437 462c  0x1BF3,  0x2D7F,
-0009dab0: 2020 3078 4138 3036 2c20 2030 7841 3832    0xA806,  0xA82
-0009dac0: 432c 2020 3078 4138 4334 2c20 2030 7841  C,  0xA8C4,  0xA
-0009dad0: 3935 332c 2020 3078 4139 4330 2c0a 2020  953,  0xA9C0,.  
-0009dae0: 2020 2020 3078 4141 4636 2c20 2030 7841      0xAAF6,  0xA
-0009daf0: 4245 442c 2020 3078 3130 4133 462c 2030  BED,  0x10A3F, 0
-0009db00: 7831 3130 3436 2c20 3078 3131 3037 462c  x11046, 0x1107F,
-0009db10: 2030 7831 3130 4239 2c20 3078 3131 3133   0x110B9, 0x1113
-0009db20: 332c 2030 7831 3131 3334 2c0a 2020 2020  3, 0x11134,.    
-0009db30: 2020 3078 3131 3143 302c 2030 7831 3132    0x111C0, 0x112
-0009db40: 3335 2c20 3078 3131 3245 412c 2030 7831  35, 0x112EA, 0x1
-0009db50: 3133 3444 2c20 3078 3131 3434 322c 2030  134D, 0x11442, 0
-0009db60: 7831 3134 4332 2c20 3078 3131 3542 462c  x114C2, 0x115BF,
-0009db70: 2030 7831 3136 3346 2c0a 2020 2020 2020   0x1163F,.      
-0009db80: 3078 3131 3642 362c 2030 7831 3137 3242  0x116B6, 0x1172B
-0009db90: 2c20 3078 3131 3833 392c 2030 7831 3139  , 0x11839, 0x119
-0009dba0: 3344 2c20 3078 3131 3933 452c 2030 7831  3D, 0x1193E, 0x1
-0009dbb0: 3139 4530 2c20 3078 3131 4133 342c 2030  19E0, 0x11A34, 0
-0009dbc0: 7831 3141 3437 2c0a 2020 2020 2020 3078  x11A47,.      0x
-0009dbd0: 3131 4139 392c 2030 7831 3143 3346 2c20  11A99, 0x11C3F, 
-0009dbe0: 3078 3131 4434 342c 2030 7831 3144 3435  0x11D44, 0x11D45
-0009dbf0: 2c20 3078 3131 4439 377d 3b0a 2020 636f  , 0x11D97};.  co
-0009dc00: 6e73 7465 7870 7220 7374 6174 6963 2075  nstexpr static u
-0009dc10: 696e 7433 325f 7420 525b 5d20 3d20 7b0a  int32_t R[] = {.
-0009dc20: 2020 2020 2020 3078 3632 322c 2030 7836        0x622, 0x6
-0009dc30: 3233 2c20 3078 3632 342c 2030 7836 3235  23, 0x624, 0x625
-0009dc40: 2c20 3078 3632 372c 2030 7836 3239 2c20  , 0x627, 0x629, 
-0009dc50: 3078 3632 662c 2030 7836 3330 2c20 3078  0x62f, 0x630, 0x
-0009dc60: 3633 312c 0a20 2020 2020 2030 7836 3332  631,.      0x632
-0009dc70: 2c20 3078 3634 382c 2030 7836 3731 2c20  , 0x648, 0x671, 
-0009dc80: 3078 3637 322c 2030 7836 3733 2c20 3078  0x672, 0x673, 0x
-0009dc90: 3637 352c 2030 7836 3736 2c20 3078 3637  675, 0x676, 0x67
-0009dca0: 372c 2030 7836 3838 2c0a 2020 2020 2020  7, 0x688,.      
-0009dcb0: 3078 3638 392c 2030 7836 3861 2c20 3078  0x689, 0x68a, 0x
-0009dcc0: 3638 622c 2030 7836 3863 2c20 3078 3638  68b, 0x68c, 0x68
-0009dcd0: 642c 2030 7836 3865 2c20 3078 3638 662c  d, 0x68e, 0x68f,
-0009dce0: 2030 7836 3930 2c20 3078 3639 312c 0a20   0x690, 0x691,. 
-0009dcf0: 2020 2020 2030 7836 3932 2c20 3078 3639       0x692, 0x69
-0009dd00: 332c 2030 7836 3934 2c20 3078 3639 352c  3, 0x694, 0x695,
-0009dd10: 2030 7836 3936 2c20 3078 3639 372c 2030   0x696, 0x697, 0
-0009dd20: 7836 3938 2c20 3078 3639 392c 2030 7836  x698, 0x699, 0x6
-0009dd30: 6330 2c0a 2020 2020 2020 3078 3663 332c  c0,.      0x6c3,
-0009dd40: 2030 7836 6334 2c20 3078 3663 352c 2030   0x6c4, 0x6c5, 0
-0009dd50: 7836 6336 2c20 3078 3663 372c 2030 7836  x6c6, 0x6c7, 0x6
-0009dd60: 6338 2c20 3078 3663 392c 2030 7836 6361  c8, 0x6c9, 0x6ca
-0009dd70: 2c20 3078 3663 622c 0a20 2020 2020 2030  , 0x6cb,.      0
-0009dd80: 7836 6364 2c20 3078 3663 662c 2030 7836  x6cd, 0x6cf, 0x6
-0009dd90: 6432 2c20 3078 3664 332c 2030 7836 6435  d2, 0x6d3, 0x6d5
-0009dda0: 2c20 3078 3665 652c 2030 7836 6566 2c20  , 0x6ee, 0x6ef, 
-0009ddb0: 3078 3731 302c 2030 7837 3135 2c0a 2020  0x710, 0x715,.  
-0009ddc0: 2020 2020 3078 3731 362c 2030 7837 3137      0x716, 0x717
-0009ddd0: 2c20 3078 3731 382c 2030 7837 3139 2c20  , 0x718, 0x719, 
-0009dde0: 3078 3731 652c 2030 7837 3238 2c20 3078  0x71e, 0x728, 0x
-0009ddf0: 3732 612c 2030 7837 3263 2c20 3078 3732  72a, 0x72c, 0x72
-0009de00: 662c 0a20 2020 2020 2030 7837 3464 2c20  f,.      0x74d, 
-0009de10: 3078 3735 392c 2030 7837 3561 2c20 3078  0x759, 0x75a, 0x
-0009de20: 3735 622c 2030 7838 3534 2c20 3078 3861  75b, 0x854, 0x8a
-0009de30: 612c 2030 7838 6162 2c20 3078 3861 637d  a, 0x8ab, 0x8ac}
-0009de40: 3b0a 2020 636f 6e73 7465 7870 7220 7374  ;.  constexpr st
-0009de50: 6174 6963 2075 696e 7433 325f 7420 4c5b  atic uint32_t L[
-0009de60: 5d20 3d20 7b30 7861 3837 327d 3b0a 2020  ] = {0xa872};.  
-0009de70: 636f 6e73 7465 7870 7220 7374 6174 6963  constexpr static
-0009de80: 2075 696e 7433 325f 7420 445b 5d20 3d20   uint32_t D[] = 
-0009de90: 7b0a 2020 2020 2020 3078 3632 302c 2020  {.      0x620,  
-0009dea0: 3078 3632 362c 2020 3078 3632 382c 2020  0x626,  0x628,  
-0009deb0: 3078 3632 612c 2020 3078 3632 622c 2020  0x62a,  0x62b,  
-0009dec0: 3078 3632 632c 2020 3078 3632 642c 2020  0x62c,  0x62d,  
-0009ded0: 3078 3632 652c 2020 3078 3633 332c 0a20  0x62e,  0x633,. 
-0009dee0: 2020 2020 2030 7836 3334 2c20 2030 7836       0x634,  0x6
-0009def0: 3335 2c20 2030 7836 3336 2c20 2030 7836  35,  0x636,  0x6
-0009df00: 3337 2c20 2030 7836 3338 2c20 2030 7836  37,  0x638,  0x6
-0009df10: 3339 2c20 2030 7836 3361 2c20 2030 7836  39,  0x63a,  0x6
-0009df20: 3362 2c20 2030 7836 3363 2c0a 2020 2020  3b,  0x63c,.    
-0009df30: 2020 3078 3633 642c 2020 3078 3633 652c    0x63d,  0x63e,
-0009df40: 2020 3078 3633 662c 2020 3078 3634 312c    0x63f,  0x641,
-0009df50: 2020 3078 3634 322c 2020 3078 3634 332c    0x642,  0x643,
-0009df60: 2020 3078 3634 342c 2020 3078 3634 352c    0x644,  0x645,
-0009df70: 2020 3078 3634 362c 0a20 2020 2020 2030    0x646,.      0
-0009df80: 7836 3437 2c20 2030 7836 3439 2c20 2030  x647,  0x649,  0
-0009df90: 7836 3461 2c20 2030 7836 3665 2c20 2030  x64a,  0x66e,  0
-0009dfa0: 7836 3666 2c20 2030 7836 3738 2c20 2030  x66f,  0x678,  0
-0009dfb0: 7836 3739 2c20 2030 7836 3761 2c20 2030  x679,  0x67a,  0
-0009dfc0: 7836 3762 2c0a 2020 2020 2020 3078 3637  x67b,.      0x67
-0009dfd0: 632c 2020 3078 3637 642c 2020 3078 3637  c,  0x67d,  0x67
-0009dfe0: 652c 2020 3078 3637 662c 2020 3078 3638  e,  0x67f,  0x68
-0009dff0: 302c 2020 3078 3638 312c 2020 3078 3638  0,  0x681,  0x68
-0009e000: 322c 2020 3078 3638 332c 2020 3078 3638  2,  0x683,  0x68
-0009e010: 342c 0a20 2020 2020 2030 7836 3835 2c20  4,.      0x685, 
-0009e020: 2030 7836 3836 2c20 2030 7836 3837 2c20   0x686,  0x687, 
-0009e030: 2030 7836 3961 2c20 2030 7836 3962 2c20   0x69a,  0x69b, 
-0009e040: 2030 7836 3963 2c20 2030 7836 3964 2c20   0x69c,  0x69d, 
-0009e050: 2030 7836 3965 2c20 2030 7836 3966 2c0a   0x69e,  0x69f,.
-0009e060: 2020 2020 2020 3078 3661 302c 2020 3078        0x6a0,  0x
-0009e070: 3661 312c 2020 3078 3661 322c 2020 3078  6a1,  0x6a2,  0x
-0009e080: 3661 332c 2020 3078 3661 342c 2020 3078  6a3,  0x6a4,  0x
-0009e090: 3661 352c 2020 3078 3661 362c 2020 3078  6a5,  0x6a6,  0x
-0009e0a0: 3661 372c 2020 3078 3661 382c 0a20 2020  6a7,  0x6a8,.   
-0009e0b0: 2020 2030 7836 6139 2c20 2030 7836 6161     0x6a9,  0x6aa
-0009e0c0: 2c20 2030 7836 6162 2c20 2030 7836 6163  ,  0x6ab,  0x6ac
-0009e0d0: 2c20 2030 7836 6164 2c20 2030 7836 6165  ,  0x6ad,  0x6ae
-0009e0e0: 2c20 2030 7836 6166 2c20 2030 7836 6230  ,  0x6af,  0x6b0
-0009e0f0: 2c20 2030 7836 6231 2c0a 2020 2020 2020  ,  0x6b1,.      
-0009e100: 3078 3662 322c 2020 3078 3662 332c 2020  0x6b2,  0x6b3,  
-0009e110: 3078 3662 342c 2020 3078 3662 352c 2020  0x6b4,  0x6b5,  
-0009e120: 3078 3662 362c 2020 3078 3662 372c 2020  0x6b6,  0x6b7,  
-0009e130: 3078 3662 382c 2020 3078 3662 392c 2020  0x6b8,  0x6b9,  
-0009e140: 3078 3662 612c 0a20 2020 2020 2030 7836  0x6ba,.      0x6
-0009e150: 6262 2c20 2030 7836 6263 2c20 2030 7836  bb,  0x6bc,  0x6
-0009e160: 6264 2c20 2030 7836 6265 2c20 2030 7836  bd,  0x6be,  0x6
-0009e170: 6266 2c20 2030 7836 6331 2c20 2030 7836  bf,  0x6c1,  0x6
-0009e180: 6332 2c20 2030 7836 6363 2c20 2030 7836  c2,  0x6cc,  0x6
-0009e190: 6365 2c0a 2020 2020 2020 3078 3664 302c  ce,.      0x6d0,
-0009e1a0: 2020 3078 3664 312c 2020 3078 3666 612c    0x6d1,  0x6fa,
-0009e1b0: 2020 3078 3666 622c 2020 3078 3666 632c    0x6fb,  0x6fc,
-0009e1c0: 2020 3078 3666 662c 2020 3078 3731 322c    0x6ff,  0x712,
-0009e1d0: 2020 3078 3731 332c 2020 3078 3731 342c    0x713,  0x714,
-0009e1e0: 0a20 2020 2020 2030 7837 3161 2c20 2030  .      0x71a,  0
-0009e1f0: 7837 3162 2c20 2030 7837 3163 2c20 2030  x71b,  0x71c,  0
-0009e200: 7837 3164 2c20 2030 7837 3166 2c20 2030  x71d,  0x71f,  0
-0009e210: 7837 3230 2c20 2030 7837 3231 2c20 2030  x720,  0x721,  0
-0009e220: 7837 3232 2c20 2030 7837 3233 2c0a 2020  x722,  0x723,.  
-0009e230: 2020 2020 3078 3732 342c 2020 3078 3732      0x724,  0x72
-0009e240: 352c 2020 3078 3732 362c 2020 3078 3732  5,  0x726,  0x72
-0009e250: 372c 2020 3078 3732 392c 2020 3078 3732  7,  0x729,  0x72
-0009e260: 622c 2020 3078 3732 642c 2020 3078 3732  b,  0x72d,  0x72
-0009e270: 652c 2020 3078 3734 652c 0a20 2020 2020  e,  0x74e,.     
-0009e280: 2030 7837 3466 2c20 2030 7837 3530 2c20   0x74f,  0x750, 
-0009e290: 2030 7837 3531 2c20 2030 7837 3532 2c20   0x751,  0x752, 
-0009e2a0: 2030 7837 3533 2c20 2030 7837 3534 2c20   0x753,  0x754, 
-0009e2b0: 2030 7837 3535 2c20 2030 7837 3536 2c20   0x755,  0x756, 
-0009e2c0: 2030 7837 3537 2c0a 2020 2020 2020 3078   0x757,.      0x
-0009e2d0: 3735 382c 2020 3078 3735 632c 2020 3078  758,  0x75c,  0x
-0009e2e0: 3735 642c 2020 3078 3735 652c 2020 3078  75d,  0x75e,  0x
-0009e2f0: 3735 662c 2020 3078 3736 302c 2020 3078  75f,  0x760,  0x
-0009e300: 3736 312c 2020 3078 3736 322c 2020 3078  761,  0x762,  0x
-0009e310: 3736 332c 0a20 2020 2020 2030 7837 3634  763,.      0x764
-0009e320: 2c20 2030 7837 3635 2c20 2030 7837 3636  ,  0x765,  0x766
-0009e330: 2c20 2030 7838 3530 2c20 2030 7838 3531  ,  0x850,  0x851
-0009e340: 2c20 2030 7838 3532 2c20 2030 7838 3533  ,  0x852,  0x853
-0009e350: 2c20 2030 7838 3535 2c20 2030 7838 6130  ,  0x855,  0x8a0
-0009e360: 2c0a 2020 2020 2020 3078 3861 322c 2020  ,.      0x8a2,  
-0009e370: 3078 3861 332c 2020 3078 3861 342c 2020  0x8a3,  0x8a4,  
-0009e380: 3078 3861 352c 2020 3078 3861 362c 2020  0x8a5,  0x8a6,  
-0009e390: 3078 3861 372c 2020 3078 3861 382c 2020  0x8a7,  0x8a8,  
-0009e3a0: 3078 3861 392c 2020 3078 3138 3037 2c0a  0x8a9,  0x1807,.
-0009e3b0: 2020 2020 2020 3078 3138 3230 2c20 3078        0x1820, 0x
-0009e3c0: 3138 3231 2c20 3078 3138 3232 2c20 3078  1821, 0x1822, 0x
-0009e3d0: 3138 3233 2c20 3078 3138 3234 2c20 3078  1823, 0x1824, 0x
-0009e3e0: 3138 3235 2c20 3078 3138 3236 2c20 3078  1825, 0x1826, 0x
-0009e3f0: 3138 3237 2c20 3078 3138 3238 2c0a 2020  1827, 0x1828,.  
-0009e400: 2020 2020 3078 3138 3239 2c20 3078 3138      0x1829, 0x18
-0009e410: 3261 2c20 3078 3138 3262 2c20 3078 3138  2a, 0x182b, 0x18
-0009e420: 3263 2c20 3078 3138 3264 2c20 3078 3138  2c, 0x182d, 0x18
-0009e430: 3265 2c20 3078 3138 3266 2c20 3078 3138  2e, 0x182f, 0x18
-0009e440: 3330 2c20 3078 3138 3331 2c0a 2020 2020  30, 0x1831,.    
-0009e450: 2020 3078 3138 3332 2c20 3078 3138 3333    0x1832, 0x1833
-0009e460: 2c20 3078 3138 3334 2c20 3078 3138 3335  , 0x1834, 0x1835
-0009e470: 2c20 3078 3138 3336 2c20 3078 3138 3337  , 0x1836, 0x1837
-0009e480: 2c20 3078 3138 3338 2c20 3078 3138 3339  , 0x1838, 0x1839
-0009e490: 2c20 3078 3138 3361 2c0a 2020 2020 2020  , 0x183a,.      
-0009e4a0: 3078 3138 3362 2c20 3078 3138 3363 2c20  0x183b, 0x183c, 
-0009e4b0: 3078 3138 3364 2c20 3078 3138 3365 2c20  0x183d, 0x183e, 
-0009e4c0: 3078 3138 3366 2c20 3078 3138 3430 2c20  0x183f, 0x1840, 
-0009e4d0: 3078 3138 3431 2c20 3078 3138 3432 2c20  0x1841, 0x1842, 
-0009e4e0: 3078 3138 3433 2c0a 2020 2020 2020 3078  0x1843,.      0x
-0009e4f0: 3138 3434 2c20 3078 3138 3435 2c20 3078  1844, 0x1845, 0x
-0009e500: 3138 3436 2c20 3078 3138 3437 2c20 3078  1846, 0x1847, 0x
-0009e510: 3138 3438 2c20 3078 3138 3439 2c20 3078  1848, 0x1849, 0x
-0009e520: 3138 3461 2c20 3078 3138 3462 2c20 3078  184a, 0x184b, 0x
-0009e530: 3138 3463 2c0a 2020 2020 2020 3078 3138  184c,.      0x18
-0009e540: 3464 2c20 3078 3138 3465 2c20 3078 3138  4d, 0x184e, 0x18
-0009e550: 3466 2c20 3078 3138 3530 2c20 3078 3138  4f, 0x1850, 0x18
-0009e560: 3531 2c20 3078 3138 3532 2c20 3078 3138  51, 0x1852, 0x18
-0009e570: 3533 2c20 3078 3138 3534 2c20 3078 3138  53, 0x1854, 0x18
-0009e580: 3535 2c0a 2020 2020 2020 3078 3138 3536  55,.      0x1856
-0009e590: 2c20 3078 3138 3537 2c20 3078 3138 3538  , 0x1857, 0x1858
-0009e5a0: 2c20 3078 3138 3539 2c20 3078 3138 3561  , 0x1859, 0x185a
-0009e5b0: 2c20 3078 3138 3562 2c20 3078 3138 3563  , 0x185b, 0x185c
-0009e5c0: 2c20 3078 3138 3564 2c20 3078 3138 3565  , 0x185d, 0x185e
-0009e5d0: 2c0a 2020 2020 2020 3078 3138 3566 2c20  ,.      0x185f, 
-0009e5e0: 3078 3138 3630 2c20 3078 3138 3631 2c20  0x1860, 0x1861, 
-0009e5f0: 3078 3138 3632 2c20 3078 3138 3633 2c20  0x1862, 0x1863, 
-0009e600: 3078 3138 3634 2c20 3078 3138 3635 2c20  0x1864, 0x1865, 
-0009e610: 3078 3138 3636 2c20 3078 3138 3637 2c0a  0x1866, 0x1867,.
-0009e620: 2020 2020 2020 3078 3138 3638 2c20 3078        0x1868, 0x
-0009e630: 3138 3639 2c20 3078 3138 3661 2c20 3078  1869, 0x186a, 0x
-0009e640: 3138 3662 2c20 3078 3138 3663 2c20 3078  186b, 0x186c, 0x
-0009e650: 3138 3664 2c20 3078 3138 3665 2c20 3078  186d, 0x186e, 0x
-0009e660: 3138 3666 2c20 3078 3138 3730 2c0a 2020  186f, 0x1870,.  
-0009e670: 2020 2020 3078 3138 3731 2c20 3078 3138      0x1871, 0x18
-0009e680: 3732 2c20 3078 3138 3733 2c20 3078 3138  72, 0x1873, 0x18
-0009e690: 3734 2c20 3078 3138 3735 2c20 3078 3138  74, 0x1875, 0x18
-0009e6a0: 3736 2c20 3078 3138 3737 2c20 3078 3138  76, 0x1877, 0x18
-0009e6b0: 3837 2c20 3078 3138 3838 2c0a 2020 2020  87, 0x1888,.    
-0009e6c0: 2020 3078 3138 3839 2c20 3078 3138 3861    0x1889, 0x188a
-0009e6d0: 2c20 3078 3138 3862 2c20 3078 3138 3863  , 0x188b, 0x188c
-0009e6e0: 2c20 3078 3138 3864 2c20 3078 3138 3865  , 0x188d, 0x188e
-0009e6f0: 2c20 3078 3138 3866 2c20 3078 3138 3930  , 0x188f, 0x1890
-0009e700: 2c20 3078 3138 3931 2c0a 2020 2020 2020  , 0x1891,.      
-0009e710: 3078 3138 3932 2c20 3078 3138 3933 2c20  0x1892, 0x1893, 
-0009e720: 3078 3138 3934 2c20 3078 3138 3935 2c20  0x1894, 0x1895, 
-0009e730: 3078 3138 3936 2c20 3078 3138 3937 2c20  0x1896, 0x1897, 
-0009e740: 3078 3138 3938 2c20 3078 3138 3939 2c20  0x1898, 0x1899, 
-0009e750: 3078 3138 3961 2c0a 2020 2020 2020 3078  0x189a,.      0x
-0009e760: 3138 3962 2c20 3078 3138 3963 2c20 3078  189b, 0x189c, 0x
-0009e770: 3138 3964 2c20 3078 3138 3965 2c20 3078  189d, 0x189e, 0x
-0009e780: 3138 3966 2c20 3078 3138 6130 2c20 3078  189f, 0x18a0, 0x
-0009e790: 3138 6131 2c20 3078 3138 6132 2c20 3078  18a1, 0x18a2, 0x
-0009e7a0: 3138 6133 2c0a 2020 2020 2020 3078 3138  18a3,.      0x18
-0009e7b0: 6134 2c20 3078 3138 6135 2c20 3078 3138  a4, 0x18a5, 0x18
-0009e7c0: 6136 2c20 3078 3138 6137 2c20 3078 3138  a6, 0x18a7, 0x18
-0009e7d0: 6138 2c20 3078 3138 6161 2c20 3078 6138  a8, 0x18aa, 0xa8
-0009e7e0: 3430 2c20 3078 6138 3431 2c20 3078 6138  40, 0xa841, 0xa8
-0009e7f0: 3432 2c0a 2020 2020 2020 3078 6138 3433  42,.      0xa843
-0009e800: 2c20 3078 6138 3434 2c20 3078 6138 3435  , 0xa844, 0xa845
-0009e810: 2c20 3078 6138 3436 2c20 3078 6138 3437  , 0xa846, 0xa847
-0009e820: 2c20 3078 6138 3438 2c20 3078 6138 3439  , 0xa848, 0xa849
-0009e830: 2c20 3078 6138 3461 2c20 3078 6138 3462  , 0xa84a, 0xa84b
-0009e840: 2c0a 2020 2020 2020 3078 6138 3463 2c20  ,.      0xa84c, 
-0009e850: 3078 6138 3464 2c20 3078 6138 3465 2c20  0xa84d, 0xa84e, 
-0009e860: 3078 6138 3466 2c20 3078 6138 3530 2c20  0xa84f, 0xa850, 
-0009e870: 3078 6138 3531 2c20 3078 6138 3532 2c20  0xa851, 0xa852, 
-0009e880: 3078 6138 3533 2c20 3078 6138 3534 2c0a  0xa853, 0xa854,.
-0009e890: 2020 2020 2020 3078 6138 3535 2c20 3078        0xa855, 0x
-0009e8a0: 6138 3536 2c20 3078 6138 3537 2c20 3078  a856, 0xa857, 0x
-0009e8b0: 6138 3538 2c20 3078 6138 3539 2c20 3078  a858, 0xa859, 0x
-0009e8c0: 6138 3561 2c20 3078 6138 3562 2c20 3078  a85a, 0xa85b, 0x
-0009e8d0: 6138 3563 2c20 3078 6138 3564 2c0a 2020  a85c, 0xa85d,.  
-0009e8e0: 2020 2020 3078 6138 3565 2c20 3078 6138      0xa85e, 0xa8
-0009e8f0: 3566 2c20 3078 6138 3630 2c20 3078 6138  5f, 0xa860, 0xa8
-0009e900: 3631 2c20 3078 6138 3632 2c20 3078 6138  61, 0xa862, 0xa8
-0009e910: 3633 2c20 3078 6138 3634 2c20 3078 6138  63, 0xa864, 0xa8
-0009e920: 3635 2c20 3078 6138 3636 2c0a 2020 2020  65, 0xa866,.    
-0009e930: 2020 3078 6138 3637 2c20 3078 6138 3638    0xa867, 0xa868
-0009e940: 2c20 3078 6138 3639 2c20 3078 6138 3661  , 0xa869, 0xa86a
-0009e950: 2c20 3078 6138 3662 2c20 3078 6138 3663  , 0xa86b, 0xa86c
-0009e960: 2c20 3078 6138 3664 2c20 3078 6138 3665  , 0xa86d, 0xa86e
-0009e970: 2c20 3078 6138 3666 2c0a 2020 2020 2020  , 0xa86f,.      
-0009e980: 3078 6138 3730 2c20 3078 6138 3731 7d3b  0xa870, 0xa871};
-0009e990: 0a0a 2020 666f 7220 2873 697a 655f 7420  ..  for (size_t 
-0009e9a0: 6920 3d20 303b 2069 203c 206c 6162 656c  i = 0; i < label
-0009e9b0: 2e73 697a 6528 293b 2069 2b2b 2920 7b0a  .size(); i++) {.
-0009e9c0: 2020 2020 7569 6e74 3332 5f74 2063 203d      uint32_t c =
-0009e9d0: 206c 6162 656c 5b69 5d3b 0a20 2020 2069   label[i];.    i
-0009e9e0: 6620 2863 203d 3d20 3078 3230 3063 2920  f (c == 0x200c) 
-0009e9f0: 7b0a 2020 2020 2020 6966 2028 6920 3e20  {.      if (i > 
-0009ea00: 3029 207b 0a20 2020 2020 2020 2069 6620  0) {.        if 
-0009ea10: 2873 7464 3a3a 6269 6e61 7279 5f73 6561  (std::binary_sea
-0009ea20: 7263 6828 7374 643a 3a62 6567 696e 2876  rch(std::begin(v
-0009ea30: 6972 616d 6129 2c20 7374 643a 3a65 6e64  irama), std::end
-0009ea40: 2876 6972 616d 6129 2c0a 2020 2020 2020  (virama),.      
+0009d8e0: 656c 206d 7573 7420 7361 7469 7366 7920  el must satisfy 
+0009d8f0: 7468 6520 436f 6e74 6578 744a 2072 756c  the ContextJ rul
+0009d900: 6573 2066 726f 6d20 4170 7065 6e64 6978  es from Appendix
+0009d910: 0a20 202f 2f20 412c 2069 6e20 5468 6520  .  // A, in The 
+0009d920: 556e 6963 6f64 6520 436f 6465 2050 6f69  Unicode Code Poi
+0009d930: 6e74 7320 616e 6420 496e 7465 726e 6174  nts and Internat
+0009d940: 696f 6e61 6c69 7a65 6420 446f 6d61 696e  ionalized Domain
+0009d950: 204e 616d 6573 2066 6f72 0a20 202f 2f20   Names for.  // 
+0009d960: 4170 706c 6963 6174 696f 6e73 2028 4944  Applications (ID
+0009d970: 4e41 2920 5b49 444e 4132 3030 385d 2e0a  NA) [IDNA2008]..
+0009d980: 2020 636f 6e73 7465 7870 7220 7374 6174    constexpr stat
+0009d990: 6963 2075 696e 7433 325f 7420 7669 7261  ic uint32_t vira
+0009d9a0: 6d61 5b5d 203d 207b 0a20 2020 2020 2030  ma[] = {.      0
+0009d9b0: 7830 3934 442c 2020 3078 3039 4344 2c20  x094D,  0x09CD, 
+0009d9c0: 2030 7830 4134 442c 2020 3078 3041 4344   0x0A4D,  0x0ACD
+0009d9d0: 2c20 2030 7830 4234 442c 2020 3078 3042  ,  0x0B4D,  0x0B
+0009d9e0: 4344 2c20 2030 7830 4334 442c 2020 3078  CD,  0x0C4D,  0x
+0009d9f0: 3043 4344 2c0a 2020 2020 2020 3078 3044  0CCD,.      0x0D
+0009da00: 3342 2c20 2030 7830 4433 432c 2020 3078  3B,  0x0D3C,  0x
+0009da10: 3044 3444 2c20 2030 7830 4443 412c 2020  0D4D,  0x0DCA,  
+0009da20: 3078 3045 3341 2c20 2030 7830 4542 412c  0x0E3A,  0x0EBA,
+0009da30: 2020 3078 3046 3834 2c20 2030 7831 3033    0x0F84,  0x103
+0009da40: 392c 0a20 2020 2020 2030 7831 3033 412c  9,.      0x103A,
+0009da50: 2020 3078 3137 3134 2c20 2030 7831 3733    0x1714,  0x173
+0009da60: 342c 2020 3078 3137 4432 2c20 2030 7831  4,  0x17D2,  0x1
+0009da70: 4136 302c 2020 3078 3142 3434 2c20 2030  A60,  0x1B44,  0
+0009da80: 7831 4241 412c 2020 3078 3142 4142 2c0a  x1BAA,  0x1BAB,.
+0009da90: 2020 2020 2020 3078 3142 4632 2c20 2030        0x1BF2,  0
+0009daa0: 7831 4246 332c 2020 3078 3244 3746 2c20  x1BF3,  0x2D7F, 
+0009dab0: 2030 7841 3830 362c 2020 3078 4138 3243   0xA806,  0xA82C
+0009dac0: 2c20 2030 7841 3843 342c 2020 3078 4139  ,  0xA8C4,  0xA9
+0009dad0: 3533 2c20 2030 7841 3943 302c 0a20 2020  53,  0xA9C0,.   
+0009dae0: 2020 2030 7841 4146 362c 2020 3078 4142     0xAAF6,  0xAB
+0009daf0: 4544 2c20 2030 7831 3041 3346 2c20 3078  ED,  0x10A3F, 0x
+0009db00: 3131 3034 362c 2030 7831 3130 3746 2c20  11046, 0x1107F, 
+0009db10: 3078 3131 3042 392c 2030 7831 3131 3333  0x110B9, 0x11133
+0009db20: 2c20 3078 3131 3133 342c 0a20 2020 2020  , 0x11134,.     
+0009db30: 2030 7831 3131 4330 2c20 3078 3131 3233   0x111C0, 0x1123
+0009db40: 352c 2030 7831 3132 4541 2c20 3078 3131  5, 0x112EA, 0x11
+0009db50: 3334 442c 2030 7831 3134 3432 2c20 3078  34D, 0x11442, 0x
+0009db60: 3131 3443 322c 2030 7831 3135 4246 2c20  114C2, 0x115BF, 
+0009db70: 3078 3131 3633 462c 0a20 2020 2020 2030  0x1163F,.      0
+0009db80: 7831 3136 4236 2c20 3078 3131 3732 422c  x116B6, 0x1172B,
+0009db90: 2030 7831 3138 3339 2c20 3078 3131 3933   0x11839, 0x1193
+0009dba0: 442c 2030 7831 3139 3345 2c20 3078 3131  D, 0x1193E, 0x11
+0009dbb0: 3945 302c 2030 7831 3141 3334 2c20 3078  9E0, 0x11A34, 0x
+0009dbc0: 3131 4134 372c 0a20 2020 2020 2030 7831  11A47,.      0x1
+0009dbd0: 3141 3939 2c20 3078 3131 4333 462c 2030  1A99, 0x11C3F, 0
+0009dbe0: 7831 3144 3434 2c20 3078 3131 4434 352c  x11D44, 0x11D45,
+0009dbf0: 2030 7831 3144 3937 7d3b 0a20 2063 6f6e   0x11D97};.  con
+0009dc00: 7374 6578 7072 2073 7461 7469 6320 7569  stexpr static ui
+0009dc10: 6e74 3332 5f74 2052 5b5d 203d 207b 0a20  nt32_t R[] = {. 
+0009dc20: 2020 2020 2030 7836 3232 2c20 3078 3632       0x622, 0x62
+0009dc30: 332c 2030 7836 3234 2c20 3078 3632 352c  3, 0x624, 0x625,
+0009dc40: 2030 7836 3237 2c20 3078 3632 392c 2030   0x627, 0x629, 0
+0009dc50: 7836 3266 2c20 3078 3633 302c 2030 7836  x62f, 0x630, 0x6
+0009dc60: 3331 2c0a 2020 2020 2020 3078 3633 322c  31,.      0x632,
+0009dc70: 2030 7836 3438 2c20 3078 3637 312c 2030   0x648, 0x671, 0
+0009dc80: 7836 3732 2c20 3078 3637 332c 2030 7836  x672, 0x673, 0x6
+0009dc90: 3735 2c20 3078 3637 362c 2030 7836 3737  75, 0x676, 0x677
+0009dca0: 2c20 3078 3638 382c 0a20 2020 2020 2030  , 0x688,.      0
+0009dcb0: 7836 3839 2c20 3078 3638 612c 2030 7836  x689, 0x68a, 0x6
+0009dcc0: 3862 2c20 3078 3638 632c 2030 7836 3864  8b, 0x68c, 0x68d
+0009dcd0: 2c20 3078 3638 652c 2030 7836 3866 2c20  , 0x68e, 0x68f, 
+0009dce0: 3078 3639 302c 2030 7836 3931 2c0a 2020  0x690, 0x691,.  
+0009dcf0: 2020 2020 3078 3639 322c 2030 7836 3933      0x692, 0x693
+0009dd00: 2c20 3078 3639 342c 2030 7836 3935 2c20  , 0x694, 0x695, 
+0009dd10: 3078 3639 362c 2030 7836 3937 2c20 3078  0x696, 0x697, 0x
+0009dd20: 3639 382c 2030 7836 3939 2c20 3078 3663  698, 0x699, 0x6c
+0009dd30: 302c 0a20 2020 2020 2030 7836 6333 2c20  0,.      0x6c3, 
+0009dd40: 3078 3663 342c 2030 7836 6335 2c20 3078  0x6c4, 0x6c5, 0x
+0009dd50: 3663 362c 2030 7836 6337 2c20 3078 3663  6c6, 0x6c7, 0x6c
+0009dd60: 382c 2030 7836 6339 2c20 3078 3663 612c  8, 0x6c9, 0x6ca,
+0009dd70: 2030 7836 6362 2c0a 2020 2020 2020 3078   0x6cb,.      0x
+0009dd80: 3663 642c 2030 7836 6366 2c20 3078 3664  6cd, 0x6cf, 0x6d
+0009dd90: 322c 2030 7836 6433 2c20 3078 3664 352c  2, 0x6d3, 0x6d5,
+0009dda0: 2030 7836 6565 2c20 3078 3665 662c 2030   0x6ee, 0x6ef, 0
+0009ddb0: 7837 3130 2c20 3078 3731 352c 0a20 2020  x710, 0x715,.   
+0009ddc0: 2020 2030 7837 3136 2c20 3078 3731 372c     0x716, 0x717,
+0009ddd0: 2030 7837 3138 2c20 3078 3731 392c 2030   0x718, 0x719, 0
+0009dde0: 7837 3165 2c20 3078 3732 382c 2030 7837  x71e, 0x728, 0x7
+0009ddf0: 3261 2c20 3078 3732 632c 2030 7837 3266  2a, 0x72c, 0x72f
+0009de00: 2c0a 2020 2020 2020 3078 3734 642c 2030  ,.      0x74d, 0
+0009de10: 7837 3539 2c20 3078 3735 612c 2030 7837  x759, 0x75a, 0x7
+0009de20: 3562 2c20 3078 3835 342c 2030 7838 6161  5b, 0x854, 0x8aa
+0009de30: 2c20 3078 3861 622c 2030 7838 6163 7d3b  , 0x8ab, 0x8ac};
+0009de40: 0a20 2063 6f6e 7374 6578 7072 2073 7461  .  constexpr sta
+0009de50: 7469 6320 7569 6e74 3332 5f74 204c 5b5d  tic uint32_t L[]
+0009de60: 203d 207b 3078 6138 3732 7d3b 0a20 2063   = {0xa872};.  c
+0009de70: 6f6e 7374 6578 7072 2073 7461 7469 6320  onstexpr static 
+0009de80: 7569 6e74 3332 5f74 2044 5b5d 203d 207b  uint32_t D[] = {
+0009de90: 0a20 2020 2020 2030 7836 3230 2c20 2030  .      0x620,  0
+0009dea0: 7836 3236 2c20 2030 7836 3238 2c20 2030  x626,  0x628,  0
+0009deb0: 7836 3261 2c20 2030 7836 3262 2c20 2030  x62a,  0x62b,  0
+0009dec0: 7836 3263 2c20 2030 7836 3264 2c20 2030  x62c,  0x62d,  0
+0009ded0: 7836 3265 2c20 2030 7836 3333 2c0a 2020  x62e,  0x633,.  
+0009dee0: 2020 2020 3078 3633 342c 2020 3078 3633      0x634,  0x63
+0009def0: 352c 2020 3078 3633 362c 2020 3078 3633  5,  0x636,  0x63
+0009df00: 372c 2020 3078 3633 382c 2020 3078 3633  7,  0x638,  0x63
+0009df10: 392c 2020 3078 3633 612c 2020 3078 3633  9,  0x63a,  0x63
+0009df20: 622c 2020 3078 3633 632c 0a20 2020 2020  b,  0x63c,.     
+0009df30: 2030 7836 3364 2c20 2030 7836 3365 2c20   0x63d,  0x63e, 
+0009df40: 2030 7836 3366 2c20 2030 7836 3431 2c20   0x63f,  0x641, 
+0009df50: 2030 7836 3432 2c20 2030 7836 3433 2c20   0x642,  0x643, 
+0009df60: 2030 7836 3434 2c20 2030 7836 3435 2c20   0x644,  0x645, 
+0009df70: 2030 7836 3436 2c0a 2020 2020 2020 3078   0x646,.      0x
+0009df80: 3634 372c 2020 3078 3634 392c 2020 3078  647,  0x649,  0x
+0009df90: 3634 612c 2020 3078 3636 652c 2020 3078  64a,  0x66e,  0x
+0009dfa0: 3636 662c 2020 3078 3637 382c 2020 3078  66f,  0x678,  0x
+0009dfb0: 3637 392c 2020 3078 3637 612c 2020 3078  679,  0x67a,  0x
+0009dfc0: 3637 622c 0a20 2020 2020 2030 7836 3763  67b,.      0x67c
+0009dfd0: 2c20 2030 7836 3764 2c20 2030 7836 3765  ,  0x67d,  0x67e
+0009dfe0: 2c20 2030 7836 3766 2c20 2030 7836 3830  ,  0x67f,  0x680
+0009dff0: 2c20 2030 7836 3831 2c20 2030 7836 3832  ,  0x681,  0x682
+0009e000: 2c20 2030 7836 3833 2c20 2030 7836 3834  ,  0x683,  0x684
+0009e010: 2c0a 2020 2020 2020 3078 3638 352c 2020  ,.      0x685,  
+0009e020: 3078 3638 362c 2020 3078 3638 372c 2020  0x686,  0x687,  
+0009e030: 3078 3639 612c 2020 3078 3639 622c 2020  0x69a,  0x69b,  
+0009e040: 3078 3639 632c 2020 3078 3639 642c 2020  0x69c,  0x69d,  
+0009e050: 3078 3639 652c 2020 3078 3639 662c 0a20  0x69e,  0x69f,. 
+0009e060: 2020 2020 2030 7836 6130 2c20 2030 7836       0x6a0,  0x6
+0009e070: 6131 2c20 2030 7836 6132 2c20 2030 7836  a1,  0x6a2,  0x6
+0009e080: 6133 2c20 2030 7836 6134 2c20 2030 7836  a3,  0x6a4,  0x6
+0009e090: 6135 2c20 2030 7836 6136 2c20 2030 7836  a5,  0x6a6,  0x6
+0009e0a0: 6137 2c20 2030 7836 6138 2c0a 2020 2020  a7,  0x6a8,.    
+0009e0b0: 2020 3078 3661 392c 2020 3078 3661 612c    0x6a9,  0x6aa,
+0009e0c0: 2020 3078 3661 622c 2020 3078 3661 632c    0x6ab,  0x6ac,
+0009e0d0: 2020 3078 3661 642c 2020 3078 3661 652c    0x6ad,  0x6ae,
+0009e0e0: 2020 3078 3661 662c 2020 3078 3662 302c    0x6af,  0x6b0,
+0009e0f0: 2020 3078 3662 312c 0a20 2020 2020 2030    0x6b1,.      0
+0009e100: 7836 6232 2c20 2030 7836 6233 2c20 2030  x6b2,  0x6b3,  0
+0009e110: 7836 6234 2c20 2030 7836 6235 2c20 2030  x6b4,  0x6b5,  0
+0009e120: 7836 6236 2c20 2030 7836 6237 2c20 2030  x6b6,  0x6b7,  0
+0009e130: 7836 6238 2c20 2030 7836 6239 2c20 2030  x6b8,  0x6b9,  0
+0009e140: 7836 6261 2c0a 2020 2020 2020 3078 3662  x6ba,.      0x6b
+0009e150: 622c 2020 3078 3662 632c 2020 3078 3662  b,  0x6bc,  0x6b
+0009e160: 642c 2020 3078 3662 652c 2020 3078 3662  d,  0x6be,  0x6b
+0009e170: 662c 2020 3078 3663 312c 2020 3078 3663  f,  0x6c1,  0x6c
+0009e180: 322c 2020 3078 3663 632c 2020 3078 3663  2,  0x6cc,  0x6c
+0009e190: 652c 0a20 2020 2020 2030 7836 6430 2c20  e,.      0x6d0, 
+0009e1a0: 2030 7836 6431 2c20 2030 7836 6661 2c20   0x6d1,  0x6fa, 
+0009e1b0: 2030 7836 6662 2c20 2030 7836 6663 2c20   0x6fb,  0x6fc, 
+0009e1c0: 2030 7836 6666 2c20 2030 7837 3132 2c20   0x6ff,  0x712, 
+0009e1d0: 2030 7837 3133 2c20 2030 7837 3134 2c0a   0x713,  0x714,.
+0009e1e0: 2020 2020 2020 3078 3731 612c 2020 3078        0x71a,  0x
+0009e1f0: 3731 622c 2020 3078 3731 632c 2020 3078  71b,  0x71c,  0x
+0009e200: 3731 642c 2020 3078 3731 662c 2020 3078  71d,  0x71f,  0x
+0009e210: 3732 302c 2020 3078 3732 312c 2020 3078  720,  0x721,  0x
+0009e220: 3732 322c 2020 3078 3732 332c 0a20 2020  722,  0x723,.   
+0009e230: 2020 2030 7837 3234 2c20 2030 7837 3235     0x724,  0x725
+0009e240: 2c20 2030 7837 3236 2c20 2030 7837 3237  ,  0x726,  0x727
+0009e250: 2c20 2030 7837 3239 2c20 2030 7837 3262  ,  0x729,  0x72b
+0009e260: 2c20 2030 7837 3264 2c20 2030 7837 3265  ,  0x72d,  0x72e
+0009e270: 2c20 2030 7837 3465 2c0a 2020 2020 2020  ,  0x74e,.      
+0009e280: 3078 3734 662c 2020 3078 3735 302c 2020  0x74f,  0x750,  
+0009e290: 3078 3735 312c 2020 3078 3735 322c 2020  0x751,  0x752,  
+0009e2a0: 3078 3735 332c 2020 3078 3735 342c 2020  0x753,  0x754,  
+0009e2b0: 3078 3735 352c 2020 3078 3735 362c 2020  0x755,  0x756,  
+0009e2c0: 3078 3735 372c 0a20 2020 2020 2030 7837  0x757,.      0x7
+0009e2d0: 3538 2c20 2030 7837 3563 2c20 2030 7837  58,  0x75c,  0x7
+0009e2e0: 3564 2c20 2030 7837 3565 2c20 2030 7837  5d,  0x75e,  0x7
+0009e2f0: 3566 2c20 2030 7837 3630 2c20 2030 7837  5f,  0x760,  0x7
+0009e300: 3631 2c20 2030 7837 3632 2c20 2030 7837  61,  0x762,  0x7
+0009e310: 3633 2c0a 2020 2020 2020 3078 3736 342c  63,.      0x764,
+0009e320: 2020 3078 3736 352c 2020 3078 3736 362c    0x765,  0x766,
+0009e330: 2020 3078 3835 302c 2020 3078 3835 312c    0x850,  0x851,
+0009e340: 2020 3078 3835 322c 2020 3078 3835 332c    0x852,  0x853,
+0009e350: 2020 3078 3835 352c 2020 3078 3861 302c    0x855,  0x8a0,
+0009e360: 0a20 2020 2020 2030 7838 6132 2c20 2030  .      0x8a2,  0
+0009e370: 7838 6133 2c20 2030 7838 6134 2c20 2030  x8a3,  0x8a4,  0
+0009e380: 7838 6135 2c20 2030 7838 6136 2c20 2030  x8a5,  0x8a6,  0
+0009e390: 7838 6137 2c20 2030 7838 6138 2c20 2030  x8a7,  0x8a8,  0
+0009e3a0: 7838 6139 2c20 2030 7831 3830 372c 0a20  x8a9,  0x1807,. 
+0009e3b0: 2020 2020 2030 7831 3832 302c 2030 7831       0x1820, 0x1
+0009e3c0: 3832 312c 2030 7831 3832 322c 2030 7831  821, 0x1822, 0x1
+0009e3d0: 3832 332c 2030 7831 3832 342c 2030 7831  823, 0x1824, 0x1
+0009e3e0: 3832 352c 2030 7831 3832 362c 2030 7831  825, 0x1826, 0x1
+0009e3f0: 3832 372c 2030 7831 3832 382c 0a20 2020  827, 0x1828,.   
+0009e400: 2020 2030 7831 3832 392c 2030 7831 3832     0x1829, 0x182
+0009e410: 612c 2030 7831 3832 622c 2030 7831 3832  a, 0x182b, 0x182
+0009e420: 632c 2030 7831 3832 642c 2030 7831 3832  c, 0x182d, 0x182
+0009e430: 652c 2030 7831 3832 662c 2030 7831 3833  e, 0x182f, 0x183
+0009e440: 302c 2030 7831 3833 312c 0a20 2020 2020  0, 0x1831,.     
+0009e450: 2030 7831 3833 322c 2030 7831 3833 332c   0x1832, 0x1833,
+0009e460: 2030 7831 3833 342c 2030 7831 3833 352c   0x1834, 0x1835,
+0009e470: 2030 7831 3833 362c 2030 7831 3833 372c   0x1836, 0x1837,
+0009e480: 2030 7831 3833 382c 2030 7831 3833 392c   0x1838, 0x1839,
+0009e490: 2030 7831 3833 612c 0a20 2020 2020 2030   0x183a,.      0
+0009e4a0: 7831 3833 622c 2030 7831 3833 632c 2030  x183b, 0x183c, 0
+0009e4b0: 7831 3833 642c 2030 7831 3833 652c 2030  x183d, 0x183e, 0
+0009e4c0: 7831 3833 662c 2030 7831 3834 302c 2030  x183f, 0x1840, 0
+0009e4d0: 7831 3834 312c 2030 7831 3834 322c 2030  x1841, 0x1842, 0
+0009e4e0: 7831 3834 332c 0a20 2020 2020 2030 7831  x1843,.      0x1
+0009e4f0: 3834 342c 2030 7831 3834 352c 2030 7831  844, 0x1845, 0x1
+0009e500: 3834 362c 2030 7831 3834 372c 2030 7831  846, 0x1847, 0x1
+0009e510: 3834 382c 2030 7831 3834 392c 2030 7831  848, 0x1849, 0x1
+0009e520: 3834 612c 2030 7831 3834 622c 2030 7831  84a, 0x184b, 0x1
+0009e530: 3834 632c 0a20 2020 2020 2030 7831 3834  84c,.      0x184
+0009e540: 642c 2030 7831 3834 652c 2030 7831 3834  d, 0x184e, 0x184
+0009e550: 662c 2030 7831 3835 302c 2030 7831 3835  f, 0x1850, 0x185
+0009e560: 312c 2030 7831 3835 322c 2030 7831 3835  1, 0x1852, 0x185
+0009e570: 332c 2030 7831 3835 342c 2030 7831 3835  3, 0x1854, 0x185
+0009e580: 352c 0a20 2020 2020 2030 7831 3835 362c  5,.      0x1856,
+0009e590: 2030 7831 3835 372c 2030 7831 3835 382c   0x1857, 0x1858,
+0009e5a0: 2030 7831 3835 392c 2030 7831 3835 612c   0x1859, 0x185a,
+0009e5b0: 2030 7831 3835 622c 2030 7831 3835 632c   0x185b, 0x185c,
+0009e5c0: 2030 7831 3835 642c 2030 7831 3835 652c   0x185d, 0x185e,
+0009e5d0: 0a20 2020 2020 2030 7831 3835 662c 2030  .      0x185f, 0
+0009e5e0: 7831 3836 302c 2030 7831 3836 312c 2030  x1860, 0x1861, 0
+0009e5f0: 7831 3836 322c 2030 7831 3836 332c 2030  x1862, 0x1863, 0
+0009e600: 7831 3836 342c 2030 7831 3836 352c 2030  x1864, 0x1865, 0
+0009e610: 7831 3836 362c 2030 7831 3836 372c 0a20  x1866, 0x1867,. 
+0009e620: 2020 2020 2030 7831 3836 382c 2030 7831       0x1868, 0x1
+0009e630: 3836 392c 2030 7831 3836 612c 2030 7831  869, 0x186a, 0x1
+0009e640: 3836 622c 2030 7831 3836 632c 2030 7831  86b, 0x186c, 0x1
+0009e650: 3836 642c 2030 7831 3836 652c 2030 7831  86d, 0x186e, 0x1
+0009e660: 3836 662c 2030 7831 3837 302c 0a20 2020  86f, 0x1870,.   
+0009e670: 2020 2030 7831 3837 312c 2030 7831 3837     0x1871, 0x187
+0009e680: 322c 2030 7831 3837 332c 2030 7831 3837  2, 0x1873, 0x187
+0009e690: 342c 2030 7831 3837 352c 2030 7831 3837  4, 0x1875, 0x187
+0009e6a0: 362c 2030 7831 3837 372c 2030 7831 3838  6, 0x1877, 0x188
+0009e6b0: 372c 2030 7831 3838 382c 0a20 2020 2020  7, 0x1888,.     
+0009e6c0: 2030 7831 3838 392c 2030 7831 3838 612c   0x1889, 0x188a,
+0009e6d0: 2030 7831 3838 622c 2030 7831 3838 632c   0x188b, 0x188c,
+0009e6e0: 2030 7831 3838 642c 2030 7831 3838 652c   0x188d, 0x188e,
+0009e6f0: 2030 7831 3838 662c 2030 7831 3839 302c   0x188f, 0x1890,
+0009e700: 2030 7831 3839 312c 0a20 2020 2020 2030   0x1891,.      0
+0009e710: 7831 3839 322c 2030 7831 3839 332c 2030  x1892, 0x1893, 0
+0009e720: 7831 3839 342c 2030 7831 3839 352c 2030  x1894, 0x1895, 0
+0009e730: 7831 3839 362c 2030 7831 3839 372c 2030  x1896, 0x1897, 0
+0009e740: 7831 3839 382c 2030 7831 3839 392c 2030  x1898, 0x1899, 0
+0009e750: 7831 3839 612c 0a20 2020 2020 2030 7831  x189a,.      0x1
+0009e760: 3839 622c 2030 7831 3839 632c 2030 7831  89b, 0x189c, 0x1
+0009e770: 3839 642c 2030 7831 3839 652c 2030 7831  89d, 0x189e, 0x1
+0009e780: 3839 662c 2030 7831 3861 302c 2030 7831  89f, 0x18a0, 0x1
+0009e790: 3861 312c 2030 7831 3861 322c 2030 7831  8a1, 0x18a2, 0x1
+0009e7a0: 3861 332c 0a20 2020 2020 2030 7831 3861  8a3,.      0x18a
+0009e7b0: 342c 2030 7831 3861 352c 2030 7831 3861  4, 0x18a5, 0x18a
+0009e7c0: 362c 2030 7831 3861 372c 2030 7831 3861  6, 0x18a7, 0x18a
+0009e7d0: 382c 2030 7831 3861 612c 2030 7861 3834  8, 0x18aa, 0xa84
+0009e7e0: 302c 2030 7861 3834 312c 2030 7861 3834  0, 0xa841, 0xa84
+0009e7f0: 322c 0a20 2020 2020 2030 7861 3834 332c  2,.      0xa843,
+0009e800: 2030 7861 3834 342c 2030 7861 3834 352c   0xa844, 0xa845,
+0009e810: 2030 7861 3834 362c 2030 7861 3834 372c   0xa846, 0xa847,
+0009e820: 2030 7861 3834 382c 2030 7861 3834 392c   0xa848, 0xa849,
+0009e830: 2030 7861 3834 612c 2030 7861 3834 622c   0xa84a, 0xa84b,
+0009e840: 0a20 2020 2020 2030 7861 3834 632c 2030  .      0xa84c, 0
+0009e850: 7861 3834 642c 2030 7861 3834 652c 2030  xa84d, 0xa84e, 0
+0009e860: 7861 3834 662c 2030 7861 3835 302c 2030  xa84f, 0xa850, 0
+0009e870: 7861 3835 312c 2030 7861 3835 322c 2030  xa851, 0xa852, 0
+0009e880: 7861 3835 332c 2030 7861 3835 342c 0a20  xa853, 0xa854,. 
+0009e890: 2020 2020 2030 7861 3835 352c 2030 7861       0xa855, 0xa
+0009e8a0: 3835 362c 2030 7861 3835 372c 2030 7861  856, 0xa857, 0xa
+0009e8b0: 3835 382c 2030 7861 3835 392c 2030 7861  858, 0xa859, 0xa
+0009e8c0: 3835 612c 2030 7861 3835 622c 2030 7861  85a, 0xa85b, 0xa
+0009e8d0: 3835 632c 2030 7861 3835 642c 0a20 2020  85c, 0xa85d,.   
+0009e8e0: 2020 2030 7861 3835 652c 2030 7861 3835     0xa85e, 0xa85
+0009e8f0: 662c 2030 7861 3836 302c 2030 7861 3836  f, 0xa860, 0xa86
+0009e900: 312c 2030 7861 3836 322c 2030 7861 3836  1, 0xa862, 0xa86
+0009e910: 332c 2030 7861 3836 342c 2030 7861 3836  3, 0xa864, 0xa86
+0009e920: 352c 2030 7861 3836 362c 0a20 2020 2020  5, 0xa866,.     
+0009e930: 2030 7861 3836 372c 2030 7861 3836 382c   0xa867, 0xa868,
+0009e940: 2030 7861 3836 392c 2030 7861 3836 612c   0xa869, 0xa86a,
+0009e950: 2030 7861 3836 622c 2030 7861 3836 632c   0xa86b, 0xa86c,
+0009e960: 2030 7861 3836 642c 2030 7861 3836 652c   0xa86d, 0xa86e,
+0009e970: 2030 7861 3836 662c 0a20 2020 2020 2030   0xa86f,.      0
+0009e980: 7861 3837 302c 2030 7861 3837 317d 3b0a  xa870, 0xa871};.
+0009e990: 0a20 2066 6f72 2028 7369 7a65 5f74 2069  .  for (size_t i
+0009e9a0: 203d 2030 3b20 6920 3c20 6c61 6265 6c2e   = 0; i < label.
+0009e9b0: 7369 7a65 2829 3b20 692b 2b29 207b 0a20  size(); i++) {. 
+0009e9c0: 2020 2075 696e 7433 325f 7420 6320 3d20     uint32_t c = 
+0009e9d0: 6c61 6265 6c5b 695d 3b0a 2020 2020 6966  label[i];.    if
+0009e9e0: 2028 6320 3d3d 2030 7832 3030 6329 207b   (c == 0x200c) {
+0009e9f0: 0a20 2020 2020 2069 6620 2869 203e 2030  .      if (i > 0
+0009ea00: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+0009ea10: 7374 643a 3a62 696e 6172 795f 7365 6172  std::binary_sear
+0009ea20: 6368 2873 7464 3a3a 6265 6769 6e28 7669  ch(std::begin(vi
+0009ea30: 7261 6d61 292c 2073 7464 3a3a 656e 6428  rama), std::end(
+0009ea40: 7669 7261 6d61 292c 0a20 2020 2020 2020  virama),.       
 0009ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0009ea60: 2020 2020 2020 2020 206c 6162 656c 5b69           label[i
-0009ea70: 202d 2031 5d29 2920 7b0a 2020 2020 2020   - 1])) {.      
-0009ea80: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
-0009ea90: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-0009eaa0: 207d 0a20 2020 2020 2069 6620 2828 6920   }.      if ((i 
-0009eab0: 3d3d 2030 2920 7c7c 2028 6920 2b20 3120  == 0) || (i + 1 
-0009eac0: 3e3d 206c 6162 656c 2e73 697a 6528 2929  >= label.size())
-0009ead0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-0009eae0: 726e 2066 616c 7365 3b0a 2020 2020 2020  rn false;.      
-0009eaf0: 7d0a 2020 2020 2020 2f2f 2077 6520 676f  }.      // we go
-0009eb00: 2062 6163 6b77 6172 6420 6c6f 6f6b 696e   backward lookin
-0009eb10: 6720 666f 7220 4c20 6f72 2044 0a20 2020  g for L or D.   
-0009eb20: 2020 2061 7574 6f20 6973 5f6c 5f6f 725f     auto is_l_or_
-0009eb30: 6420 3d20 5b5d 2875 696e 7433 325f 7420  d = [](uint32_t 
-0009eb40: 636f 6465 2920 7b0a 2020 2020 2020 2020  code) {.        
-0009eb50: 7265 7475 726e 2073 7464 3a3a 6269 6e61  return std::bina
-0009eb60: 7279 5f73 6561 7263 6828 7374 643a 3a62  ry_search(std::b
-0009eb70: 6567 696e 284c 292c 2073 7464 3a3a 656e  egin(L), std::en
-0009eb80: 6428 4c29 2c20 636f 6465 2920 7c7c 0a20  d(L), code) ||. 
-0009eb90: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0009eba0: 643a 3a62 696e 6172 795f 7365 6172 6368  d::binary_search
-0009ebb0: 2873 7464 3a3a 6265 6769 6e28 4429 2c20  (std::begin(D), 
-0009ebc0: 7374 643a 3a65 6e64 2844 292c 2063 6f64  std::end(D), cod
-0009ebd0: 6529 3b0a 2020 2020 2020 7d3b 0a20 2020  e);.      };.   
-0009ebe0: 2020 2061 7574 6f20 6973 5f72 5f6f 725f     auto is_r_or_
-0009ebf0: 6420 3d20 5b5d 2875 696e 7433 325f 7420  d = [](uint32_t 
-0009ec00: 636f 6465 2920 7b0a 2020 2020 2020 2020  code) {.        
-0009ec10: 7265 7475 726e 2073 7464 3a3a 6269 6e61  return std::bina
-0009ec20: 7279 5f73 6561 7263 6828 7374 643a 3a62  ry_search(std::b
-0009ec30: 6567 696e 2852 292c 2073 7464 3a3a 656e  egin(R), std::en
-0009ec40: 6428 5229 2c20 636f 6465 2920 7c7c 0a20  d(R), code) ||. 
-0009ec50: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0009ec60: 643a 3a62 696e 6172 795f 7365 6172 6368  d::binary_search
-0009ec70: 2873 7464 3a3a 6265 6769 6e28 4429 2c20  (std::begin(D), 
-0009ec80: 7374 643a 3a65 6e64 2844 292c 2063 6f64  std::end(D), cod
-0009ec90: 6529 3b0a 2020 2020 2020 7d3b 0a20 2020  e);.      };.   
-0009eca0: 2020 2073 7464 3a3a 7533 3273 7472 696e     std::u32strin
-0009ecb0: 675f 7669 6577 2062 6566 6f72 6520 3d20  g_view before = 
-0009ecc0: 6c61 6265 6c2e 7375 6273 7472 2830 2c20  label.substr(0, 
-0009ecd0: 6929 3b0a 2020 2020 2020 7374 643a 3a75  i);.      std::u
-0009ece0: 3332 7374 7269 6e67 5f76 6965 7720 6166  32string_view af
-0009ecf0: 7465 7220 3d20 6c61 6265 6c2e 7375 6273  ter = label.subs
-0009ed00: 7472 2869 202b 2031 293b 0a20 2020 2020  tr(i + 1);.     
-0009ed10: 2072 6574 7572 6e20 2873 7464 3a3a 6669   return (std::fi
-0009ed20: 6e64 5f69 6628 6265 666f 7265 2e62 6567  nd_if(before.beg
-0009ed30: 696e 2829 2c20 6265 666f 7265 2e65 6e64  in(), before.end
-0009ed40: 2829 2c20 6973 5f6c 5f6f 725f 6429 2021  (), is_l_or_d) !
-0009ed50: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-0009ed60: 6265 666f 7265 2e65 6e64 2829 2920 2626  before.end()) &&
-0009ed70: 0a20 2020 2020 2020 2020 2020 2020 2873  .             (s
-0009ed80: 7464 3a3a 6669 6e64 5f69 6628 6166 7465  td::find_if(afte
-0009ed90: 722e 6265 6769 6e28 292c 2061 6674 6572  r.begin(), after
-0009eda0: 2e65 6e64 2829 2c20 6973 5f72 5f6f 725f  .end(), is_r_or_
-0009edb0: 6429 2021 3d0a 2020 2020 2020 2020 2020  d) !=.          
-0009edc0: 2020 2020 6166 7465 722e 656e 6428 2929      after.end())
-0009edd0: 3b0a 2020 2020 7d20 656c 7365 2069 6620  ;.    } else if 
-0009ede0: 2863 203d 3d20 3078 3230 3064 2920 7b0a  (c == 0x200d) {.
-0009edf0: 2020 2020 2020 6966 2028 6920 3e20 3029        if (i > 0)
-0009ee00: 207b 0a20 2020 2020 2020 2069 6620 2873   {.        if (s
-0009ee10: 7464 3a3a 6269 6e61 7279 5f73 6561 7263  td::binary_searc
-0009ee20: 6828 7374 643a 3a62 6567 696e 2876 6972  h(std::begin(vir
-0009ee30: 616d 6129 2c20 7374 643a 3a65 6e64 2876  ama), std::end(v
-0009ee40: 6972 616d 6129 2c0a 2020 2020 2020 2020  irama),.        
+0009ea60: 2020 2020 2020 2020 6c61 6265 6c5b 6920          label[i 
+0009ea70: 2d20 315d 2929 207b 0a20 2020 2020 2020  - 1])) {.       
+0009ea80: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
+0009ea90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0009eaa0: 7d0a 2020 2020 2020 6966 2028 2869 203d  }.      if ((i =
+0009eab0: 3d20 3029 207c 7c20 2869 202b 2031 203e  = 0) || (i + 1 >
+0009eac0: 3d20 6c61 6265 6c2e 7369 7a65 2829 2929  = label.size()))
+0009ead0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+0009eae0: 6e20 6661 6c73 653b 0a20 2020 2020 207d  n false;.      }
+0009eaf0: 0a20 2020 2020 202f 2f20 7765 2067 6f20  .      // we go 
+0009eb00: 6261 636b 7761 7264 206c 6f6f 6b69 6e67  backward looking
+0009eb10: 2066 6f72 204c 206f 7220 440a 2020 2020   for L or D.    
+0009eb20: 2020 6175 746f 2069 735f 6c5f 6f72 5f64    auto is_l_or_d
+0009eb30: 203d 205b 5d28 7569 6e74 3332 5f74 2063   = [](uint32_t c
+0009eb40: 6f64 6529 207b 0a20 2020 2020 2020 2072  ode) {.        r
+0009eb50: 6574 7572 6e20 7374 643a 3a62 696e 6172  eturn std::binar
+0009eb60: 795f 7365 6172 6368 2873 7464 3a3a 6265  y_search(std::be
+0009eb70: 6769 6e28 4c29 2c20 7374 643a 3a65 6e64  gin(L), std::end
+0009eb80: 284c 292c 2063 6f64 6529 207c 7c0a 2020  (L), code) ||.  
+0009eb90: 2020 2020 2020 2020 2020 2020 2073 7464               std
+0009eba0: 3a3a 6269 6e61 7279 5f73 6561 7263 6828  ::binary_search(
+0009ebb0: 7374 643a 3a62 6567 696e 2844 292c 2073  std::begin(D), s
+0009ebc0: 7464 3a3a 656e 6428 4429 2c20 636f 6465  td::end(D), code
+0009ebd0: 293b 0a20 2020 2020 207d 3b0a 2020 2020  );.      };.    
+0009ebe0: 2020 6175 746f 2069 735f 725f 6f72 5f64    auto is_r_or_d
+0009ebf0: 203d 205b 5d28 7569 6e74 3332 5f74 2063   = [](uint32_t c
+0009ec00: 6f64 6529 207b 0a20 2020 2020 2020 2072  ode) {.        r
+0009ec10: 6574 7572 6e20 7374 643a 3a62 696e 6172  eturn std::binar
+0009ec20: 795f 7365 6172 6368 2873 7464 3a3a 6265  y_search(std::be
+0009ec30: 6769 6e28 5229 2c20 7374 643a 3a65 6e64  gin(R), std::end
+0009ec40: 2852 292c 2063 6f64 6529 207c 7c0a 2020  (R), code) ||.  
+0009ec50: 2020 2020 2020 2020 2020 2020 2073 7464               std
+0009ec60: 3a3a 6269 6e61 7279 5f73 6561 7263 6828  ::binary_search(
+0009ec70: 7374 643a 3a62 6567 696e 2844 292c 2073  std::begin(D), s
+0009ec80: 7464 3a3a 656e 6428 4429 2c20 636f 6465  td::end(D), code
+0009ec90: 293b 0a20 2020 2020 207d 3b0a 2020 2020  );.      };.    
+0009eca0: 2020 7374 643a 3a75 3332 7374 7269 6e67    std::u32string
+0009ecb0: 5f76 6965 7720 6265 666f 7265 203d 206c  _view before = l
+0009ecc0: 6162 656c 2e73 7562 7374 7228 302c 2069  abel.substr(0, i
+0009ecd0: 293b 0a20 2020 2020 2073 7464 3a3a 7533  );.      std::u3
+0009ece0: 3273 7472 696e 675f 7669 6577 2061 6674  2string_view aft
+0009ecf0: 6572 203d 206c 6162 656c 2e73 7562 7374  er = label.subst
+0009ed00: 7228 6920 2b20 3129 3b0a 2020 2020 2020  r(i + 1);.      
+0009ed10: 7265 7475 726e 2028 7374 643a 3a66 696e  return (std::fin
+0009ed20: 645f 6966 2862 6566 6f72 652e 6265 6769  d_if(before.begi
+0009ed30: 6e28 292c 2062 6566 6f72 652e 656e 6428  n(), before.end(
+0009ed40: 292c 2069 735f 6c5f 6f72 5f64 2920 213d  ), is_l_or_d) !=
+0009ed50: 0a20 2020 2020 2020 2020 2020 2020 2062  .              b
+0009ed60: 6566 6f72 652e 656e 6428 2929 2026 260a  efore.end()) &&.
+0009ed70: 2020 2020 2020 2020 2020 2020 2028 7374               (st
+0009ed80: 643a 3a66 696e 645f 6966 2861 6674 6572  d::find_if(after
+0009ed90: 2e62 6567 696e 2829 2c20 6166 7465 722e  .begin(), after.
+0009eda0: 656e 6428 292c 2069 735f 725f 6f72 5f64  end(), is_r_or_d
+0009edb0: 2920 213d 0a20 2020 2020 2020 2020 2020  ) !=.           
+0009edc0: 2020 2061 6674 6572 2e65 6e64 2829 293b     after.end());
+0009edd0: 0a20 2020 207d 2065 6c73 6520 6966 2028  .    } else if (
+0009ede0: 6320 3d3d 2030 7832 3030 6429 207b 0a20  c == 0x200d) {. 
+0009edf0: 2020 2020 2069 6620 2869 203e 2030 2920       if (i > 0) 
+0009ee00: 7b0a 2020 2020 2020 2020 6966 2028 7374  {.        if (st
+0009ee10: 643a 3a62 696e 6172 795f 7365 6172 6368  d::binary_search
+0009ee20: 2873 7464 3a3a 6265 6769 6e28 7669 7261  (std::begin(vira
+0009ee30: 6d61 292c 2073 7464 3a3a 656e 6428 7669  ma), std::end(vi
+0009ee40: 7261 6d61 292c 0a20 2020 2020 2020 2020  rama),.         
 0009ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0009ee60: 2020 2020 2020 206c 6162 656c 5b69 202d         label[i -
-0009ee70: 2031 5d29 2920 7b0a 2020 2020 2020 2020   1])) {.        
-0009ee80: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
-0009ee90: 2020 2020 2020 207d 0a20 2020 2020 207d         }.      }
-0009eea0: 0a20 2020 2020 2072 6574 7572 6e20 6661  .      return fa
-0009eeb0: 6c73 653b 0a20 2020 207d 0a20 207d 0a0a  lse;.    }.  }..
-0009eec0: 2020 2f2f 2049 6620 4368 6563 6b42 6964    // If CheckBid
-0009eed0: 692c 2061 6e64 2069 6620 7468 6520 646f  i, and if the do
-0009eee0: 6d61 696e 206e 616d 6520 6973 2061 2020  main name is a  
-0009eef0: 4269 6469 2064 6f6d 6169 6e20 6e61 6d65  Bidi domain name
-0009ef00: 2c20 7468 656e 2074 6865 206c 6162 656c  , then the label
-0009ef10: 0a20 202f 2f20 6d75 7374 2073 6174 6973  .  // must satis
-0009ef20: 6679 2061 6c6c 2073 6978 206f 6620 7468  fy all six of th
-0009ef30: 6520 6e75 6d62 6572 6564 2063 6f6e 6469  e numbered condi
-0009ef40: 7469 6f6e 7320 696e 205b 4944 4e41 3230  tions in [IDNA20
-0009ef50: 3038 5d20 5246 4320 3538 3933 2c0a 2020  08] RFC 5893,.  
-0009ef60: 2f2f 2053 6563 7469 6f6e 2032 2e0a 0a20  // Section 2... 
-0009ef70: 202f 2f20 5468 6520 666f 6c6c 6f77 696e   // The followin
-0009ef80: 6720 7275 6c65 2c20 636f 6e73 6973 7469  g rule, consisti
-0009ef90: 6e67 206f 6620 7369 7820 636f 6e64 6974  ng of six condit
-0009efa0: 696f 6e73 2c20 6170 706c 6965 7320 746f  ions, applies to
-0009efb0: 206c 6162 656c 730a 2020 2f2f 2069 6e20   labels.  // in 
-0009efc0: 4269 6469 2064 6f6d 6169 6e20 6e61 6d65  Bidi domain name
-0009efd0: 732e 2020 5468 6520 7265 7175 6972 656d  s.  The requirem
-0009efe0: 656e 7473 2074 6861 7420 7468 6973 2072  ents that this r
-0009eff0: 756c 6520 7361 7469 7366 6965 7320 6172  ule satisfies ar
-0009f000: 650a 2020 2f2f 2064 6573 6372 6962 6564  e.  // described
-0009f010: 2069 6e20 5365 6374 696f 6e20 332e 2020   in Section 3.  
-0009f020: 416c 6c20 6f66 2074 6865 2063 6f6e 6469  All of the condi
-0009f030: 7469 6f6e 7320 6d75 7374 2062 6520 7361  tions must be sa
-0009f040: 7469 7366 6965 6420 666f 720a 2020 2f2f  tisfied for.  //
-0009f050: 2074 6865 2072 756c 6520 746f 2062 6520   the rule to be 
-0009f060: 7361 7469 7366 6965 642e 0a20 202f 2f0a  satisfied..  //.
-0009f070: 2020 2f2f 2020 312e 2020 5468 6520 6669    //  1.  The fi
-0009f080: 7273 7420 6368 6172 6163 7465 7220 6d75  rst character mu
-0009f090: 7374 2062 6520 6120 6368 6172 6163 7465  st be a characte
-0009f0a0: 7220 7769 7468 2042 6964 6920 7072 6f70  r with Bidi prop
-0009f0b0: 6572 7479 204c 2c20 522c 0a20 202f 2f20  erty L, R,.  // 
-0009f0c0: 2020 2020 6f72 2041 4c2e 2020 4966 2069      or AL.  If i
-0009f0d0: 7420 6861 7320 7468 6520 5220 6f72 2041  t has the R or A
-0009f0e0: 4c20 7072 6f70 6572 7479 2c20 6974 2069  L property, it i
-0009f0f0: 7320 616e 2052 544c 206c 6162 656c 3b20  s an RTL label; 
-0009f100: 6966 2069 740a 2020 2f2f 2020 2020 2068  if it.  //     h
-0009f110: 6173 2074 6865 204c 2070 726f 7065 7274  as the L propert
-0009f120: 792c 2069 7420 6973 2061 6e20 4c54 5220  y, it is an LTR 
-0009f130: 6c61 6265 6c2e 0a20 202f 2f0a 2020 2f2f  label..  //.  //
-0009f140: 2020 322e 2020 496e 2061 6e20 5254 4c20    2.  In an RTL 
-0009f150: 6c61 6265 6c2c 206f 6e6c 7920 6368 6172  label, only char
-0009f160: 6163 7465 7273 2077 6974 6820 7468 6520  acters with the 
-0009f170: 4269 6469 2070 726f 7065 7274 6965 7320  Bidi properties 
-0009f180: 522c 2041 4c2c 0a20 202f 2f20 2020 2020  R, AL,.  //     
-0009f190: 2041 4e2c 2045 4e2c 2045 532c 2043 532c   AN, EN, ES, CS,
-0009f1a0: 2045 542c 204f 4e2c 2042 4e2c 206f 7220   ET, ON, BN, or 
-0009f1b0: 4e53 4d20 6172 6520 616c 6c6f 7765 642e  NSM are allowed.
-0009f1c0: 0a20 202f 2f0a 2020 2f2f 2020 2033 2e20  .  //.  //   3. 
-0009f1d0: 2049 6e20 616e 2052 544c 206c 6162 656c   In an RTL label
-0009f1e0: 2c20 7468 6520 656e 6420 6f66 2074 6865  , the end of the
-0009f1f0: 206c 6162 656c 206d 7573 7420 6265 2061   label must be a
-0009f200: 2063 6861 7261 6374 6572 2077 6974 680a   character with.
-0009f210: 2020 2f2f 2020 2020 2020 2042 6964 6920    //       Bidi 
-0009f220: 7072 6f70 6572 7479 2052 2c20 414c 2c20  property R, AL, 
-0009f230: 454e 2c20 6f72 2041 4e2c 2066 6f6c 6c6f  EN, or AN, follo
-0009f240: 7765 6420 6279 207a 6572 6f20 6f72 206d  wed by zero or m
-0009f250: 6f72 650a 2020 2f2f 2020 2020 2020 2063  ore.  //       c
-0009f260: 6861 7261 6374 6572 7320 7769 7468 2042  haracters with B
-0009f270: 6964 6920 7072 6f70 6572 7479 204e 534d  idi property NSM
-0009f280: 2e0a 2020 2f2f 0a20 202f 2f20 2020 342e  ..  //.  //   4.
-0009f290: 2020 496e 2061 6e20 5254 4c20 6c61 6265    In an RTL labe
-0009f2a0: 6c2c 2069 6620 616e 2045 4e20 6973 2070  l, if an EN is p
-0009f2b0: 7265 7365 6e74 2c20 6e6f 2041 4e20 6d61  resent, no AN ma
-0009f2c0: 7920 6265 2070 7265 7365 6e74 2c20 616e  y be present, an
-0009f2d0: 640a 2020 2f2f 2020 2020 2020 2076 6963  d.  //       vic
-0009f2e0: 6520 7665 7273 612e 0a20 202f 2f0a 2020  e versa..  //.  
-0009f2f0: 2f2f 2020 352e 2020 496e 2061 6e20 4c54  //  5.  In an LT
-0009f300: 5220 6c61 6265 6c2c 206f 6e6c 7920 6368  R label, only ch
-0009f310: 6172 6163 7465 7273 2077 6974 6820 7468  aracters with th
-0009f320: 6520 4269 6469 2070 726f 7065 7274 6965  e Bidi propertie
-0009f330: 7320 4c2c 2045 4e2c 0a20 202f 2f20 2020  s L, EN,.  //   
-0009f340: 2020 2020 4553 2c20 4353 2c20 4554 2c20      ES, CS, ET, 
-0009f350: 4f4e 2c20 424e 2c20 6f72 204e 534d 2061  ON, BN, or NSM a
-0009f360: 7265 2061 6c6c 6f77 6564 2e0a 2020 2f2f  re allowed..  //
-0009f370: 0a20 202f 2f20 2020 362e 2020 496e 2061  .  //   6.  In a
-0009f380: 6e20 4c54 5220 6c61 6265 6c2c 2074 6865  n LTR label, the
-0009f390: 2065 6e64 206f 6620 7468 6520 6c61 6265   end of the labe
-0009f3a0: 6c20 6d75 7374 2062 6520 6120 6368 6172  l must be a char
-0009f3b0: 6163 7465 7220 7769 7468 0a20 202f 2f20  acter with.  // 
-0009f3c0: 2020 2020 2020 4269 6469 2070 726f 7065        Bidi prope
-0009f3d0: 7274 7920 4c20 6f72 2045 4e2c 2066 6f6c  rty L or EN, fol
-0009f3e0: 6c6f 7765 6420 6279 207a 6572 6f20 6f72  lowed by zero or
-0009f3f0: 206d 6f72 6520 6368 6172 6163 7465 7273   more characters
-0009f400: 2077 6974 680a 2020 2f2f 2020 2020 2020   with.  //      
-0009f410: 2042 6964 6920 7072 6f70 6572 7479 204e   Bidi property N
-0009f420: 534d 2e0a 0a20 2073 697a 655f 7420 6c61  SM...  size_t la
-0009f430: 7374 5f6e 6f6e 5f6e 736d 5f63 6861 7220  st_non_nsm_char 
-0009f440: 3d20 6669 6e64 5f6c 6173 745f 6e6f 745f  = find_last_not_
-0009f450: 6f66 5f6e 736d 286c 6162 656c 293b 0a20  of_nsm(label);. 
-0009f460: 2069 6620 286c 6173 745f 6e6f 6e5f 6e73   if (last_non_ns
-0009f470: 6d5f 6368 6172 203d 3d20 7374 643a 3a75  m_char == std::u
-0009f480: 3332 7374 7269 6e67 5f76 6965 773a 3a6e  32string_view::n
-0009f490: 706f 7329 207b 0a20 2020 2072 6574 7572  pos) {.    retur
-0009f4a0: 6e20 6661 6c73 653b 0a20 207d 0a0a 2020  n false;.  }..  
-0009f4b0: 2f2f 2041 2022 4269 6469 2064 6f6d 6169  // A "Bidi domai
-0009f4c0: 6e20 6e61 6d65 2220 6973 2061 2064 6f6d  n name" is a dom
-0009f4d0: 6169 6e20 6e61 6d65 2074 6861 7420 636f  ain name that co
-0009f4e0: 6e74 6169 6e73 2061 7420 6c65 6173 7420  ntains at least 
-0009f4f0: 6f6e 6520 5254 4c20 6c61 6265 6c2e 0a20  one RTL label.. 
-0009f500: 202f 2f20 5468 6520 666f 6c6c 6f77 696e   // The followin
-0009f510: 6720 7275 6c65 2c20 636f 6e73 6973 7469  g rule, consisti
-0009f520: 6e67 206f 6620 7369 7820 636f 6e64 6974  ng of six condit
-0009f530: 696f 6e73 2c20 6170 706c 6965 7320 746f  ions, applies to
-0009f540: 206c 6162 656c 7320 696e 2042 6964 690a   labels in Bidi.
-0009f550: 2020 2f2f 2064 6f6d 6169 6e20 6e61 6d65    // domain name
-0009f560: 732e 0a20 2069 6620 2869 735f 7274 6c5f  s..  if (is_rtl_
-0009f570: 6c61 6265 6c28 6c61 6265 6c29 2920 7b0a  label(label)) {.
-0009f580: 2020 2020 2f2f 2054 6865 2066 6972 7374      // The first
-0009f590: 2063 6861 7261 6374 6572 206d 7573 7420   character must 
-0009f5a0: 6265 2061 2063 6861 7261 6374 6572 2077  be a character w
-0009f5b0: 6974 6820 4269 6469 2070 726f 7065 7274  ith Bidi propert
-0009f5c0: 7920 4c2c 2052 2c0a 2020 2020 2f2f 206f  y L, R,.    // o
-0009f5d0: 7220 414c 2e20 4966 2069 7420 6861 7320  r AL. If it has 
-0009f5e0: 7468 6520 5220 6f72 2041 4c20 7072 6f70  the R or AL prop
-0009f5f0: 6572 7479 2c20 6974 2069 7320 616e 2052  erty, it is an R
-0009f600: 544c 206c 6162 656c 3b20 6966 2069 740a  TL label; if it.
-0009f610: 2020 2020 2f2f 2068 6173 2074 6865 204c      // has the L
-0009f620: 2070 726f 7065 7274 792c 2069 7420 6973   property, it is
-0009f630: 2061 6e20 4c54 5220 6c61 6265 6c2e 0a0a   an LTR label...
-0009f640: 2020 2020 6966 2028 6669 6e64 5f64 6972      if (find_dir
-0009f650: 6563 7469 6f6e 286c 6162 656c 5b30 5d29  ection(label[0])
-0009f660: 203d 3d20 6469 7265 6374 696f 6e3a 3a4c   == direction::L
-0009f670: 2920 7b0a 2020 2020 2020 2f2f 2045 7661  ) {.      // Eva
-0009f680: 6c20 6173 204c 5452 0a0a 2020 2020 2020  l as LTR..      
-0009f690: 2f2f 2049 6e20 616e 204c 5452 206c 6162  // In an LTR lab
-0009f6a0: 656c 2c20 6f6e 6c79 2063 6861 7261 6374  el, only charact
-0009f6b0: 6572 7320 7769 7468 2074 6865 2042 6964  ers with the Bid
-0009f6c0: 6920 7072 6f70 6572 7469 6573 204c 2c20  i properties L, 
-0009f6d0: 454e 2c0a 2020 2020 2020 2f2f 2045 532c  EN,.      // ES,
-0009f6e0: 2043 532c 2045 542c 204f 4e2c 2042 4e2c   CS, ET, ON, BN,
-0009f6f0: 206f 7220 4e53 4d20 6172 6520 616c 6c6f   or NSM are allo
-0009f700: 7765 642e 0a20 2020 2020 2066 6f72 2028  wed..      for (
-0009f710: 7369 7a65 5f74 2069 203d 2030 3b20 6920  size_t i = 0; i 
-0009f720: 3c20 6c61 7374 5f6e 6f6e 5f6e 736d 5f63  < last_non_nsm_c
-0009f730: 6861 723b 2069 2b2b 2920 7b0a 2020 2020  har; i++) {.    
-0009f740: 2020 2020 636f 6e73 7420 6469 7265 6374      const direct
-0009f750: 696f 6e20 6420 3d20 6669 6e64 5f64 6972  ion d = find_dir
-0009f760: 6563 7469 6f6e 286c 6162 656c 5b69 5d29  ection(label[i])
-0009f770: 3b0a 2020 2020 2020 2020 6966 2028 2128  ;.        if (!(
-0009f780: 6420 3d3d 2064 6972 6563 7469 6f6e 3a3a  d == direction::
-0009f790: 4c20 7c7c 2064 203d 3d20 6469 7265 6374  L || d == direct
-0009f7a0: 696f 6e3a 3a45 4e20 7c7c 2064 203d 3d20  ion::EN || d == 
-0009f7b0: 6469 7265 6374 696f 6e3a 3a45 5320 7c7c  direction::ES ||
-0009f7c0: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-0009f7d0: 203d 3d20 6469 7265 6374 696f 6e3a 3a43   == direction::C
-0009f7e0: 5320 7c7c 2064 203d 3d20 6469 7265 6374  S || d == direct
-0009f7f0: 696f 6e3a 3a45 5420 7c7c 2064 203d 3d20  ion::ET || d == 
-0009f800: 6469 7265 6374 696f 6e3a 3a4f 4e20 7c7c  direction::ON ||
-0009f810: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-0009f820: 203d 3d20 6469 7265 6374 696f 6e3a 3a42   == direction::B
-0009f830: 4e20 7c7c 2064 203d 3d20 6469 7265 6374  N || d == direct
-0009f840: 696f 6e3a 3a4e 534d 2929 207b 0a20 2020  ion::NSM)) {.   
-0009f850: 2020 2020 2020 2072 6574 7572 6e20 6661         return fa
-0009f860: 6c73 653b 0a20 2020 2020 2020 207d 0a0a  lse;.        }..
-0009f870: 2020 2020 2020 2020 6966 2028 2869 203d          if ((i =
-0009f880: 3d20 6c61 7374 5f6e 6f6e 5f6e 736d 5f63  = last_non_nsm_c
-0009f890: 6861 7229 2026 260a 2020 2020 2020 2020  har) &&.        
-0009f8a0: 2020 2020 2128 6420 3d3d 2064 6972 6563      !(d == direc
-0009f8b0: 7469 6f6e 3a3a 4c20 7c7c 2064 203d 3d20  tion::L || d == 
-0009f8c0: 6469 7265 6374 696f 6e3a 3a45 4e29 2920  direction::EN)) 
-0009f8d0: 7b0a 2020 2020 2020 2020 2020 7265 7475  {.          retu
-0009f8e0: 726e 2066 616c 7365 3b0a 2020 2020 2020  rn false;.      
-0009f8f0: 2020 7d0a 2020 2020 2020 7d0a 0a20 2020    }.      }..   
-0009f900: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
-0009f910: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
-0009f920: 2020 2020 2f2f 2045 7661 6c20 6173 2052      // Eval as R
-0009f930: 544c 0a0a 2020 2020 2020 626f 6f6c 2068  TL..      bool h
-0009f940: 6173 5f61 6e20 3d20 6661 6c73 653b 0a20  as_an = false;. 
-0009f950: 2020 2020 2062 6f6f 6c20 6861 735f 656e       bool has_en
-0009f960: 203d 2066 616c 7365 3b0a 2020 2020 2020   = false;.      
-0009f970: 666f 7220 2873 697a 655f 7420 6920 3d20  for (size_t i = 
-0009f980: 303b 2069 203c 3d20 6c61 7374 5f6e 6f6e  0; i <= last_non
-0009f990: 5f6e 736d 5f63 6861 723b 2069 2b2b 2920  _nsm_char; i++) 
-0009f9a0: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
-0009f9b0: 6469 7265 6374 696f 6e20 6420 3d20 6669  direction d = fi
-0009f9c0: 6e64 5f64 6972 6563 7469 6f6e 286c 6162  nd_direction(lab
-0009f9d0: 656c 5b69 5d29 3b0a 0a20 2020 2020 2020  el[i]);..       
-0009f9e0: 202f 2f20 496e 2061 6e20 5254 4c20 6c61   // In an RTL la
-0009f9f0: 6265 6c2c 2069 6620 616e 2045 4e20 6973  bel, if an EN is
-0009fa00: 2070 7265 7365 6e74 2c20 6e6f 2041 4e20   present, no AN 
-0009fa10: 6d61 7920 6265 2070 7265 7365 6e74 2c20  may be present, 
-0009fa20: 616e 6420 7669 6365 0a20 2020 2020 2020  and vice.       
-0009fa30: 202f 2f20 7665 7273 612e 0a20 2020 2020   // versa..     
-0009fa40: 2020 2069 6620 2828 6420 3d3d 2064 6972     if ((d == dir
-0009fa50: 6563 7469 6f6e 3a3a 454e 2026 2620 2828  ection::EN && ((
-0009fa60: 6861 735f 656e 203d 2074 7275 6529 2026  has_en = true) &
-0009fa70: 2620 6861 735f 616e 2929 207c 7c0a 2020  & has_an)) ||.  
-0009fa80: 2020 2020 2020 2020 2020 2864 203d 3d20            (d == 
-0009fa90: 6469 7265 6374 696f 6e3a 3a41 4e20 2626  direction::AN &&
-0009faa0: 2028 2868 6173 5f61 6e20 3d20 7472 7565   ((has_an = true
-0009fab0: 2920 2626 2068 6173 5f65 6e29 2929 207b  ) && has_en))) {
-0009fac0: 0a20 2020 2020 2020 2020 2072 6574 7572  .          retur
-0009fad0: 6e20 6661 6c73 653b 0a20 2020 2020 2020  n false;.       
-0009fae0: 207d 0a0a 2020 2020 2020 2020 6966 2028   }..        if (
-0009faf0: 2128 6420 3d3d 2064 6972 6563 7469 6f6e  !(d == direction
-0009fb00: 3a3a 5220 7c7c 2064 203d 3d20 6469 7265  ::R || d == dire
-0009fb10: 6374 696f 6e3a 3a41 4c20 7c7c 2064 203d  ction::AL || d =
-0009fb20: 3d20 6469 7265 6374 696f 6e3a 3a41 4e20  = direction::AN 
-0009fb30: 7c7c 0a20 2020 2020 2020 2020 2020 2020  ||.             
-0009fb40: 2064 203d 3d20 6469 7265 6374 696f 6e3a   d == direction:
-0009fb50: 3a45 4e20 7c7c 2064 203d 3d20 6469 7265  :EN || d == dire
-0009fb60: 6374 696f 6e3a 3a45 5320 7c7c 2064 203d  ction::ES || d =
-0009fb70: 3d20 6469 7265 6374 696f 6e3a 3a43 5320  = direction::CS 
-0009fb80: 7c7c 0a20 2020 2020 2020 2020 2020 2020  ||.             
-0009fb90: 2064 203d 3d20 6469 7265 6374 696f 6e3a   d == direction:
-0009fba0: 3a45 5420 7c7c 2064 203d 3d20 6469 7265  :ET || d == dire
-0009fbb0: 6374 696f 6e3a 3a4f 4e20 7c7c 2064 203d  ction::ON || d =
-0009fbc0: 3d20 6469 7265 6374 696f 6e3a 3a42 4e20  = direction::BN 
-0009fbd0: 7c7c 0a20 2020 2020 2020 2020 2020 2020  ||.             
-0009fbe0: 2064 203d 3d20 6469 7265 6374 696f 6e3a   d == direction:
-0009fbf0: 3a4e 534d 2929 207b 0a20 2020 2020 2020  :NSM)) {.       
-0009fc00: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-0009fc10: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0009fc20: 2020 2020 6966 2028 6920 3d3d 206c 6173      if (i == las
-0009fc30: 745f 6e6f 6e5f 6e73 6d5f 6368 6172 2026  t_non_nsm_char &
-0009fc40: 260a 2020 2020 2020 2020 2020 2020 2128  &.            !(
-0009fc50: 6420 3d3d 2064 6972 6563 7469 6f6e 3a3a  d == direction::
-0009fc60: 5220 7c7c 2064 203d 3d20 6469 7265 6374  R || d == direct
-0009fc70: 696f 6e3a 3a41 4c20 7c7c 2064 203d 3d20  ion::AL || d == 
-0009fc80: 6469 7265 6374 696f 6e3a 3a41 4e20 7c7c  direction::AN ||
-0009fc90: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-0009fca0: 203d 3d20 6469 7265 6374 696f 6e3a 3a45   == direction::E
-0009fcb0: 4e29 2920 7b0a 2020 2020 2020 2020 2020  N)) {.          
-0009fcc0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
-0009fcd0: 2020 2020 2020 7d0a 2020 2020 2020 7d0a        }.      }.
-0009fce0: 0a20 2020 2020 2072 6574 7572 6e20 7472  .      return tr
-0009fcf0: 7565 3b0a 2020 2020 7d0a 2020 7d0a 0a20  ue;.    }.  }.. 
-0009fd00: 2072 6574 7572 6e20 7472 7565 3b0a 7d0a   return true;.}.
-0009fd10: 0a7d 2020 2f2f 206e 616d 6573 7061 6365  .}  // namespace
-0009fd20: 2061 6461 3a3a 6964 6e61 0a2f 2a20 656e   ada::idna./* en
-0009fd30: 6420 6669 6c65 2073 7263 2f76 616c 6964  d file src/valid
-0009fd40: 6974 792e 6370 7020 2a2f 0a2f 2a20 6265  ity.cpp */./* be
-0009fd50: 6769 6e20 6669 6c65 2073 7263 2f74 6f5f  gin file src/to_
-0009fd60: 6173 6369 692e 6370 7020 2a2f 0a0a 2369  ascii.cpp */..#i
-0009fd70: 6e63 6c75 6465 203c 616c 676f 7269 7468  nclude <algorith
-0009fd80: 6d3e 0a23 696e 636c 7564 6520 3c63 7374  m>.#include <cst
-0009fd90: 6469 6e74 3e0a 0a0a 6e61 6d65 7370 6163  dint>...namespac
-0009fda0: 6520 6164 613a 3a69 646e 6120 7b0a 0a62  e ada::idna {..b
-0009fdb0: 6f6f 6c20 636f 6e73 7465 7870 7220 6265  ool constexpr be
-0009fdc0: 6769 6e73 5f77 6974 6828 7374 643a 3a75  gins_with(std::u
-0009fdd0: 3332 7374 7269 6e67 5f76 6965 7720 7669  32string_view vi
-0009fde0: 6577 2c0a 2020 2020 2020 2020 2020 2020  ew,.            
-0009fdf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0009fe00: 7464 3a3a 7533 3273 7472 696e 675f 7669  td::u32string_vi
-0009fe10: 6577 2070 7265 6669 7829 207b 0a20 2069  ew prefix) {.  i
-0009fe20: 6620 2876 6965 772e 7369 7a65 2829 203c  f (view.size() <
-0009fe30: 2070 7265 6669 782e 7369 7a65 2829 2920   prefix.size()) 
-0009fe40: 7b0a 2020 2020 7265 7475 726e 2066 616c  {.    return fal
-0009fe50: 7365 3b0a 2020 7d0a 2020 7265 7475 726e  se;.  }.  return
-0009fe60: 2076 6965 772e 7375 6273 7472 2830 2c20   view.substr(0, 
-0009fe70: 7072 6566 6978 2e73 697a 6528 2929 203d  prefix.size()) =
-0009fe80: 3d20 7072 6566 6978 3b0a 7d0a 0a62 6f6f  = prefix;.}..boo
-0009fe90: 6c20 636f 6e73 7465 7870 7220 6265 6769  l constexpr begi
-0009fea0: 6e73 5f77 6974 6828 7374 643a 3a73 7472  ns_with(std::str
-0009feb0: 696e 675f 7669 6577 2076 6965 772c 2073  ing_view view, s
-0009fec0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
-0009fed0: 7072 6566 6978 2920 7b0a 2020 6966 2028  prefix) {.  if (
-0009fee0: 7669 6577 2e73 697a 6528 2920 3c20 7072  view.size() < pr
-0009fef0: 6566 6978 2e73 697a 6528 2929 207b 0a20  efix.size()) {. 
-0009ff00: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-0009ff10: 0a20 207d 0a20 2072 6574 7572 6e20 7669  .  }.  return vi
-0009ff20: 6577 2e73 7562 7374 7228 302c 2070 7265  ew.substr(0, pre
-0009ff30: 6669 782e 7369 7a65 2829 2920 3d3d 2070  fix.size()) == p
-0009ff40: 7265 6669 783b 0a7d 0a0a 626f 6f6c 2063  refix;.}..bool c
-0009ff50: 6f6e 7374 6578 7072 2069 735f 6173 6369  onstexpr is_asci
-0009ff60: 6928 7374 643a 3a75 3332 7374 7269 6e67  i(std::u32string
-0009ff70: 5f76 6965 7720 7669 6577 2920 7b0a 2020  _view view) {.  
-0009ff80: 666f 7220 2875 696e 7433 325f 7420 6320  for (uint32_t c 
-0009ff90: 3a20 7669 6577 2920 7b0a 2020 2020 6966  : view) {.    if
-0009ffa0: 2028 6320 3e3d 2030 7838 3029 207b 0a20   (c >= 0x80) {. 
-0009ffb0: 2020 2020 2072 6574 7572 6e20 6661 6c73       return fals
-0009ffc0: 653b 0a20 2020 207d 0a20 207d 0a20 2072  e;.    }.  }.  r
-0009ffd0: 6574 7572 6e20 7472 7565 3b0a 7d0a 0a62  eturn true;.}..b
-0009ffe0: 6f6f 6c20 636f 6e73 7465 7870 7220 6973  ool constexpr is
-0009fff0: 5f61 7363 6969 2873 7464 3a3a 7374 7269  _ascii(std::stri
-000a0000: 6e67 5f76 6965 7720 7669 6577 2920 7b0a  ng_view view) {.
-000a0010: 2020 666f 7220 2875 696e 7438 5f74 2063    for (uint8_t c
-000a0020: 203a 2076 6965 7729 207b 0a20 2020 2069   : view) {.    i
-000a0030: 6620 2863 203e 3d20 3078 3830 2920 7b0a  f (c >= 0x80) {.
-000a0040: 2020 2020 2020 7265 7475 726e 2066 616c        return fal
-000a0050: 7365 3b0a 2020 2020 7d0a 2020 7d0a 2020  se;.    }.  }.  
-000a0060: 7265 7475 726e 2074 7275 653b 0a7d 0a0a  return true;.}..
-000a0070: 636f 6e73 7465 7870 7220 7374 6174 6963  constexpr static
-000a0080: 2075 696e 7438 5f74 2069 735f 666f 7262   uint8_t is_forb
-000a0090: 6964 6465 6e5f 646f 6d61 696e 5f63 6f64  idden_domain_cod
-000a00a0: 655f 706f 696e 745f 7461 626c 655b 5d20  e_point_table[] 
-000a00b0: 3d20 7b0a 2020 2020 312c 2031 2c20 312c  = {.    1, 1, 1,
-000a00c0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a00d0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a00e0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a00f0: 2031 2c20 312c 2031 2c20 312c 2031 2c0a   1, 1, 1, 1, 1,.
-000a0100: 2020 2020 312c 2031 2c20 312c 2031 2c20      1, 1, 1, 1, 
-000a0110: 312c 2031 2c20 312c 2031 2c20 312c 2030  1, 1, 1, 1, 1, 0
-000a0120: 2c20 302c 2031 2c20 302c 2031 2c20 302c  , 0, 1, 0, 1, 0,
-000a0130: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a0140: 302c 2030 2c20 302c 2031 2c0a 2020 2020  0, 0, 0, 1,.    
-000a0150: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a0160: 2c20 302c 2030 2c20 302c 2030 2c20 312c  , 0, 0, 0, 0, 1,
-000a0170: 2030 2c20 312c 2030 2c20 312c 2031 2c20   0, 1, 0, 1, 1, 
-000a0180: 312c 2030 2c20 302c 2030 2c20 302c 2030  1, 0, 0, 0, 0, 0
-000a0190: 2c20 302c 2030 2c0a 2020 2020 302c 2030  , 0, 0,.    0, 0
-000a01a0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a01b0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a01c0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a01d0: 2c20 302c 2031 2c20 312c 2031 2c20 312c  , 0, 1, 1, 1, 1,
-000a01e0: 2030 2c0a 2020 2020 302c 2030 2c20 302c   0,.    0, 0, 0,
-000a01f0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a0200: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a0210: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a0220: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
-000a0230: 2020 2020 302c 2030 2c20 302c 2030 2c20      0, 0, 0, 0, 
-000a0240: 312c 2030 2c20 302c 2031 2c20 312c 2031  1, 0, 0, 1, 1, 1
-000a0250: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a0260: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a0270: 312c 2031 2c20 312c 2031 2c0a 2020 2020  1, 1, 1, 1,.    
-000a0280: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a0290: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a02a0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a02b0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a02c0: 2c20 312c 2031 2c0a 2020 2020 312c 2031  , 1, 1,.    1, 1
-000a02d0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a02e0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a02f0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a0300: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a0310: 2031 2c0a 2020 2020 312c 2031 2c20 312c   1,.    1, 1, 1,
-000a0320: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a0330: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a0340: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a0350: 2031 2c20 312c 2031 2c20 312c 2031 2c0a   1, 1, 1, 1, 1,.
-000a0360: 2020 2020 312c 2031 2c20 312c 2031 2c20      1, 1, 1, 1, 
-000a0370: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a0380: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a0390: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a03a0: 312c 2031 2c20 312c 2031 2c0a 2020 2020  1, 1, 1, 1,.    
-000a03b0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a03c0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a03d0: 2031 2c20 312c 2031 2c20 312c 2031 7d3b   1, 1, 1, 1, 1};
-000a03e0: 0a0a 7374 6174 6963 5f61 7373 6572 7428  ..static_assert(
-000a03f0: 7369 7a65 6f66 2869 735f 666f 7262 6964  sizeof(is_forbid
-000a0400: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
-000a0410: 706f 696e 745f 7461 626c 6529 203d 3d20  point_table) == 
-000a0420: 3235 3629 3b0a 0a69 6e6c 696e 6520 626f  256);..inline bo
-000a0430: 6f6c 2069 735f 666f 7262 6964 6465 6e5f  ol is_forbidden_
-000a0440: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
-000a0450: 7428 636f 6e73 7420 6368 6172 2063 2920  t(const char c) 
-000a0460: 6e6f 6578 6365 7074 207b 0a20 2072 6574  noexcept {.  ret
-000a0470: 7572 6e20 6973 5f66 6f72 6269 6464 656e  urn is_forbidden
-000a0480: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
-000a0490: 6e74 5f74 6162 6c65 5b75 696e 7438 5f74  nt_table[uint8_t
-000a04a0: 2863 295d 3b0a 7d0a 0a62 6f6f 6c20 636f  (c)];.}..bool co
-000a04b0: 6e74 6169 6e73 5f66 6f72 6269 6464 656e  ntains_forbidden
-000a04c0: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
-000a04d0: 6e74 2873 7464 3a3a 7374 7269 6e67 5f76  nt(std::string_v
-000a04e0: 6965 7720 7669 6577 2920 7b0a 2020 7265  iew view) {.  re
-000a04f0: 7475 726e 2028 0a20 2020 2020 2073 7464  turn (.      std
-000a0500: 3a3a 616e 795f 6f66 2876 6965 772e 6265  ::any_of(view.be
-000a0510: 6769 6e28 292c 2076 6965 772e 656e 6428  gin(), view.end(
-000a0520: 292c 2069 735f 666f 7262 6964 6465 6e5f  ), is_forbidden_
-000a0530: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
-000a0540: 7429 293b 0a7d 0a0a 2f2f 2057 6520 7265  t));.}..// We re
-000a0550: 7475 726e 2022 2220 6f6e 2065 7272 6f72  turn "" on error
-000a0560: 2e0a 7374 6174 6963 2073 7464 3a3a 7374  ..static std::st
-000a0570: 7269 6e67 2066 726f 6d5f 6173 6369 695f  ring from_ascii_
-000a0580: 746f 5f61 7363 6969 2873 7464 3a3a 7374  to_ascii(std::st
-000a0590: 7269 6e67 5f76 6965 7720 7574 385f 7374  ring_view ut8_st
-000a05a0: 7269 6e67 2920 7b0a 2020 7374 6174 6963  ring) {.  static
-000a05b0: 2063 6f6e 7374 2073 7464 3a3a 7374 7269   const std::stri
-000a05c0: 6e67 2065 7272 6f72 203d 2022 223b 0a20  ng error = "";. 
-000a05d0: 202f 2f20 636f 7079 2061 6e64 206d 6170   // copy and map
-000a05e0: 0a20 202f 2f20 7765 2063 6f75 6c64 2062  .  // we could b
-000a05f0: 6520 6d6f 7265 2065 6666 6963 6965 6e74  e more efficient
-000a0600: 2062 7920 6176 6f69 6469 6e67 2074 6865   by avoiding the
-000a0610: 2063 6f70 7920 7768 656e 2075 6e6e 6563   copy when unnec
-000a0620: 6573 7361 7279 2e0a 2020 7374 643a 3a73  essary..  std::s
-000a0630: 7472 696e 6720 6d61 7070 6564 5f73 7472  tring mapped_str
-000a0640: 696e 6720 3d20 7374 643a 3a73 7472 696e  ing = std::strin
-000a0650: 6728 7574 385f 7374 7269 6e67 293b 0a20  g(ut8_string);. 
-000a0660: 2061 7363 6969 5f6d 6170 286d 6170 7065   ascii_map(mappe
-000a0670: 645f 7374 7269 6e67 2e64 6174 6128 292c  d_string.data(),
-000a0680: 206d 6170 7065 645f 7374 7269 6e67 2e73   mapped_string.s
-000a0690: 697a 6528 2929 3b0a 2020 7374 643a 3a73  ize());.  std::s
-000a06a0: 7472 696e 6720 6f75 743b 0a20 2073 697a  tring out;.  siz
-000a06b0: 655f 7420 6c61 6265 6c5f 7374 6172 7420  e_t label_start 
-000a06c0: 3d20 303b 0a0a 2020 7768 696c 6520 286c  = 0;..  while (l
-000a06d0: 6162 656c 5f73 7461 7274 2021 3d20 6d61  abel_start != ma
-000a06e0: 7070 6564 5f73 7472 696e 672e 7369 7a65  pped_string.size
-000a06f0: 2829 2920 7b0a 2020 2020 7369 7a65 5f74  ()) {.    size_t
-000a0700: 206c 6f63 5f64 6f74 203d 206d 6170 7065   loc_dot = mappe
-000a0710: 645f 7374 7269 6e67 2e66 696e 6428 272e  d_string.find('.
-000a0720: 272c 206c 6162 656c 5f73 7461 7274 293b  ', label_start);
-000a0730: 0a20 2020 2062 6f6f 6c20 6973 5f6c 6173  .    bool is_las
-000a0740: 745f 6c61 6265 6c20 3d20 286c 6f63 5f64  t_label = (loc_d
-000a0750: 6f74 203d 3d20 7374 643a 3a73 7472 696e  ot == std::strin
-000a0760: 675f 7669 6577 3a3a 6e70 6f73 293b 0a20  g_view::npos);. 
-000a0770: 2020 2073 697a 655f 7420 6c61 6265 6c5f     size_t label_
-000a0780: 7369 7a65 203d 2069 735f 6c61 7374 5f6c  size = is_last_l
-000a0790: 6162 656c 203f 206d 6170 7065 645f 7374  abel ? mapped_st
-000a07a0: 7269 6e67 2e73 697a 6528 2920 2d20 6c61  ring.size() - la
-000a07b0: 6265 6c5f 7374 6172 740a 2020 2020 2020  bel_start.      
+0009ee60: 2020 2020 2020 6c61 6265 6c5b 6920 2d20        label[i - 
+0009ee70: 315d 2929 207b 0a20 2020 2020 2020 2020  1])) {.         
+0009ee80: 2072 6574 7572 6e20 7472 7565 3b0a 2020   return true;.  
+0009ee90: 2020 2020 2020 7d0a 2020 2020 2020 7d0a        }.      }.
+0009eea0: 2020 2020 2020 7265 7475 726e 2066 616c        return fal
+0009eeb0: 7365 3b0a 2020 2020 7d0a 2020 7d0a 0a20  se;.    }.  }.. 
+0009eec0: 202f 2f20 4966 2043 6865 636b 4269 6469   // If CheckBidi
+0009eed0: 2c20 616e 6420 6966 2074 6865 2064 6f6d  , and if the dom
+0009eee0: 6169 6e20 6e61 6d65 2069 7320 6120 2042  ain name is a  B
+0009eef0: 6964 6920 646f 6d61 696e 206e 616d 652c  idi domain name,
+0009ef00: 2074 6865 6e20 7468 6520 6c61 6265 6c0a   then the label.
+0009ef10: 2020 2f2f 206d 7573 7420 7361 7469 7366    // must satisf
+0009ef20: 7920 616c 6c20 7369 7820 6f66 2074 6865  y all six of the
+0009ef30: 206e 756d 6265 7265 6420 636f 6e64 6974   numbered condit
+0009ef40: 696f 6e73 2069 6e20 5b49 444e 4132 3030  ions in [IDNA200
+0009ef50: 385d 2052 4643 2035 3839 332c 0a20 202f  8] RFC 5893,.  /
+0009ef60: 2f20 5365 6374 696f 6e20 322e 0a0a 2020  / Section 2...  
+0009ef70: 2f2f 2054 6865 2066 6f6c 6c6f 7769 6e67  // The following
+0009ef80: 2072 756c 652c 2063 6f6e 7369 7374 696e   rule, consistin
+0009ef90: 6720 6f66 2073 6978 2063 6f6e 6469 7469  g of six conditi
+0009efa0: 6f6e 732c 2061 7070 6c69 6573 2074 6f20  ons, applies to 
+0009efb0: 6c61 6265 6c73 0a20 202f 2f20 696e 2042  labels.  // in B
+0009efc0: 6964 6920 646f 6d61 696e 206e 616d 6573  idi domain names
+0009efd0: 2e20 2054 6865 2072 6571 7569 7265 6d65  .  The requireme
+0009efe0: 6e74 7320 7468 6174 2074 6869 7320 7275  nts that this ru
+0009eff0: 6c65 2073 6174 6973 6669 6573 2061 7265  le satisfies are
+0009f000: 0a20 202f 2f20 6465 7363 7269 6265 6420  .  // described 
+0009f010: 696e 2053 6563 7469 6f6e 2033 2e20 2041  in Section 3.  A
+0009f020: 6c6c 206f 6620 7468 6520 636f 6e64 6974  ll of the condit
+0009f030: 696f 6e73 206d 7573 7420 6265 2073 6174  ions must be sat
+0009f040: 6973 6669 6564 2066 6f72 0a20 202f 2f20  isfied for.  // 
+0009f050: 7468 6520 7275 6c65 2074 6f20 6265 2073  the rule to be s
+0009f060: 6174 6973 6669 6564 2e0a 2020 2f2f 0a20  atisfied..  //. 
+0009f070: 202f 2f20 2031 2e20 2054 6865 2066 6972   //  1.  The fir
+0009f080: 7374 2063 6861 7261 6374 6572 206d 7573  st character mus
+0009f090: 7420 6265 2061 2063 6861 7261 6374 6572  t be a character
+0009f0a0: 2077 6974 6820 4269 6469 2070 726f 7065   with Bidi prope
+0009f0b0: 7274 7920 4c2c 2052 2c0a 2020 2f2f 2020  rty L, R,.  //  
+0009f0c0: 2020 206f 7220 414c 2e20 2049 6620 6974     or AL.  If it
+0009f0d0: 2068 6173 2074 6865 2052 206f 7220 414c   has the R or AL
+0009f0e0: 2070 726f 7065 7274 792c 2069 7420 6973   property, it is
+0009f0f0: 2061 6e20 5254 4c20 6c61 6265 6c3b 2069   an RTL label; i
+0009f100: 6620 6974 0a20 202f 2f20 2020 2020 6861  f it.  //     ha
+0009f110: 7320 7468 6520 4c20 7072 6f70 6572 7479  s the L property
+0009f120: 2c20 6974 2069 7320 616e 204c 5452 206c  , it is an LTR l
+0009f130: 6162 656c 2e0a 2020 2f2f 0a20 202f 2f20  abel..  //.  // 
+0009f140: 2032 2e20 2049 6e20 616e 2052 544c 206c   2.  In an RTL l
+0009f150: 6162 656c 2c20 6f6e 6c79 2063 6861 7261  abel, only chara
+0009f160: 6374 6572 7320 7769 7468 2074 6865 2042  cters with the B
+0009f170: 6964 6920 7072 6f70 6572 7469 6573 2052  idi properties R
+0009f180: 2c20 414c 2c0a 2020 2f2f 2020 2020 2020  , AL,.  //      
+0009f190: 414e 2c20 454e 2c20 4553 2c20 4353 2c20  AN, EN, ES, CS, 
+0009f1a0: 4554 2c20 4f4e 2c20 424e 2c20 6f72 204e  ET, ON, BN, or N
+0009f1b0: 534d 2061 7265 2061 6c6c 6f77 6564 2e0a  SM are allowed..
+0009f1c0: 2020 2f2f 0a20 202f 2f20 2020 332e 2020    //.  //   3.  
+0009f1d0: 496e 2061 6e20 5254 4c20 6c61 6265 6c2c  In an RTL label,
+0009f1e0: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
+0009f1f0: 6c61 6265 6c20 6d75 7374 2062 6520 6120  label must be a 
+0009f200: 6368 6172 6163 7465 7220 7769 7468 0a20  character with. 
+0009f210: 202f 2f20 2020 2020 2020 4269 6469 2070   //       Bidi p
+0009f220: 726f 7065 7274 7920 522c 2041 4c2c 2045  roperty R, AL, E
+0009f230: 4e2c 206f 7220 414e 2c20 666f 6c6c 6f77  N, or AN, follow
+0009f240: 6564 2062 7920 7a65 726f 206f 7220 6d6f  ed by zero or mo
+0009f250: 7265 0a20 202f 2f20 2020 2020 2020 6368  re.  //       ch
+0009f260: 6172 6163 7465 7273 2077 6974 6820 4269  aracters with Bi
+0009f270: 6469 2070 726f 7065 7274 7920 4e53 4d2e  di property NSM.
+0009f280: 0a20 202f 2f0a 2020 2f2f 2020 2034 2e20  .  //.  //   4. 
+0009f290: 2049 6e20 616e 2052 544c 206c 6162 656c   In an RTL label
+0009f2a0: 2c20 6966 2061 6e20 454e 2069 7320 7072  , if an EN is pr
+0009f2b0: 6573 656e 742c 206e 6f20 414e 206d 6179  esent, no AN may
+0009f2c0: 2062 6520 7072 6573 656e 742c 2061 6e64   be present, and
+0009f2d0: 0a20 202f 2f20 2020 2020 2020 7669 6365  .  //       vice
+0009f2e0: 2076 6572 7361 2e0a 2020 2f2f 0a20 202f   versa..  //.  /
+0009f2f0: 2f20 2035 2e20 2049 6e20 616e 204c 5452  /  5.  In an LTR
+0009f300: 206c 6162 656c 2c20 6f6e 6c79 2063 6861   label, only cha
+0009f310: 7261 6374 6572 7320 7769 7468 2074 6865  racters with the
+0009f320: 2042 6964 6920 7072 6f70 6572 7469 6573   Bidi properties
+0009f330: 204c 2c20 454e 2c0a 2020 2f2f 2020 2020   L, EN,.  //    
+0009f340: 2020 2045 532c 2043 532c 2045 542c 204f     ES, CS, ET, O
+0009f350: 4e2c 2042 4e2c 206f 7220 4e53 4d20 6172  N, BN, or NSM ar
+0009f360: 6520 616c 6c6f 7765 642e 0a20 202f 2f0a  e allowed..  //.
+0009f370: 2020 2f2f 2020 2036 2e20 2049 6e20 616e    //   6.  In an
+0009f380: 204c 5452 206c 6162 656c 2c20 7468 6520   LTR label, the 
+0009f390: 656e 6420 6f66 2074 6865 206c 6162 656c  end of the label
+0009f3a0: 206d 7573 7420 6265 2061 2063 6861 7261   must be a chara
+0009f3b0: 6374 6572 2077 6974 680a 2020 2f2f 2020  cter with.  //  
+0009f3c0: 2020 2020 2042 6964 6920 7072 6f70 6572       Bidi proper
+0009f3d0: 7479 204c 206f 7220 454e 2c20 666f 6c6c  ty L or EN, foll
+0009f3e0: 6f77 6564 2062 7920 7a65 726f 206f 7220  owed by zero or 
+0009f3f0: 6d6f 7265 2063 6861 7261 6374 6572 7320  more characters 
+0009f400: 7769 7468 0a20 202f 2f20 2020 2020 2020  with.  //       
+0009f410: 4269 6469 2070 726f 7065 7274 7920 4e53  Bidi property NS
+0009f420: 4d2e 0a0a 2020 7369 7a65 5f74 206c 6173  M...  size_t las
+0009f430: 745f 6e6f 6e5f 6e73 6d5f 6368 6172 203d  t_non_nsm_char =
+0009f440: 2066 696e 645f 6c61 7374 5f6e 6f74 5f6f   find_last_not_o
+0009f450: 665f 6e73 6d28 6c61 6265 6c29 3b0a 2020  f_nsm(label);.  
+0009f460: 6966 2028 6c61 7374 5f6e 6f6e 5f6e 736d  if (last_non_nsm
+0009f470: 5f63 6861 7220 3d3d 2073 7464 3a3a 7533  _char == std::u3
+0009f480: 3273 7472 696e 675f 7669 6577 3a3a 6e70  2string_view::np
+0009f490: 6f73 2920 7b0a 2020 2020 7265 7475 726e  os) {.    return
+0009f4a0: 2066 616c 7365 3b0a 2020 7d0a 0a20 202f   false;.  }..  /
+0009f4b0: 2f20 4120 2242 6964 6920 646f 6d61 696e  / A "Bidi domain
+0009f4c0: 206e 616d 6522 2069 7320 6120 646f 6d61   name" is a doma
+0009f4d0: 696e 206e 616d 6520 7468 6174 2063 6f6e  in name that con
+0009f4e0: 7461 696e 7320 6174 206c 6561 7374 206f  tains at least o
+0009f4f0: 6e65 2052 544c 206c 6162 656c 2e0a 2020  ne RTL label..  
+0009f500: 2f2f 2054 6865 2066 6f6c 6c6f 7769 6e67  // The following
+0009f510: 2072 756c 652c 2063 6f6e 7369 7374 696e   rule, consistin
+0009f520: 6720 6f66 2073 6978 2063 6f6e 6469 7469  g of six conditi
+0009f530: 6f6e 732c 2061 7070 6c69 6573 2074 6f20  ons, applies to 
+0009f540: 6c61 6265 6c73 2069 6e20 4269 6469 0a20  labels in Bidi. 
+0009f550: 202f 2f20 646f 6d61 696e 206e 616d 6573   // domain names
+0009f560: 2e0a 2020 6966 2028 6973 5f72 746c 5f6c  ..  if (is_rtl_l
+0009f570: 6162 656c 286c 6162 656c 2929 207b 0a20  abel(label)) {. 
+0009f580: 2020 202f 2f20 5468 6520 6669 7273 7420     // The first 
+0009f590: 6368 6172 6163 7465 7220 6d75 7374 2062  character must b
+0009f5a0: 6520 6120 6368 6172 6163 7465 7220 7769  e a character wi
+0009f5b0: 7468 2042 6964 6920 7072 6f70 6572 7479  th Bidi property
+0009f5c0: 204c 2c20 522c 0a20 2020 202f 2f20 6f72   L, R,.    // or
+0009f5d0: 2041 4c2e 2049 6620 6974 2068 6173 2074   AL. If it has t
+0009f5e0: 6865 2052 206f 7220 414c 2070 726f 7065  he R or AL prope
+0009f5f0: 7274 792c 2069 7420 6973 2061 6e20 5254  rty, it is an RT
+0009f600: 4c20 6c61 6265 6c3b 2069 6620 6974 0a20  L label; if it. 
+0009f610: 2020 202f 2f20 6861 7320 7468 6520 4c20     // has the L 
+0009f620: 7072 6f70 6572 7479 2c20 6974 2069 7320  property, it is 
+0009f630: 616e 204c 5452 206c 6162 656c 2e0a 0a20  an LTR label... 
+0009f640: 2020 2069 6620 2866 696e 645f 6469 7265     if (find_dire
+0009f650: 6374 696f 6e28 6c61 6265 6c5b 305d 2920  ction(label[0]) 
+0009f660: 3d3d 2064 6972 6563 7469 6f6e 3a3a 4c29  == direction::L)
+0009f670: 207b 0a20 2020 2020 202f 2f20 4576 616c   {.      // Eval
+0009f680: 2061 7320 4c54 520a 0a20 2020 2020 202f   as LTR..      /
+0009f690: 2f20 496e 2061 6e20 4c54 5220 6c61 6265  / In an LTR labe
+0009f6a0: 6c2c 206f 6e6c 7920 6368 6172 6163 7465  l, only characte
+0009f6b0: 7273 2077 6974 6820 7468 6520 4269 6469  rs with the Bidi
+0009f6c0: 2070 726f 7065 7274 6965 7320 4c2c 2045   properties L, E
+0009f6d0: 4e2c 0a20 2020 2020 202f 2f20 4553 2c20  N,.      // ES, 
+0009f6e0: 4353 2c20 4554 2c20 4f4e 2c20 424e 2c20  CS, ET, ON, BN, 
+0009f6f0: 6f72 204e 534d 2061 7265 2061 6c6c 6f77  or NSM are allow
+0009f700: 6564 2e0a 2020 2020 2020 666f 7220 2873  ed..      for (s
+0009f710: 697a 655f 7420 6920 3d20 303b 2069 203c  ize_t i = 0; i <
+0009f720: 206c 6173 745f 6e6f 6e5f 6e73 6d5f 6368   last_non_nsm_ch
+0009f730: 6172 3b20 692b 2b29 207b 0a20 2020 2020  ar; i++) {.     
+0009f740: 2020 2063 6f6e 7374 2064 6972 6563 7469     const directi
+0009f750: 6f6e 2064 203d 2066 696e 645f 6469 7265  on d = find_dire
+0009f760: 6374 696f 6e28 6c61 6265 6c5b 695d 293b  ction(label[i]);
+0009f770: 0a20 2020 2020 2020 2069 6620 2821 2864  .        if (!(d
+0009f780: 203d 3d20 6469 7265 6374 696f 6e3a 3a4c   == direction::L
+0009f790: 207c 7c20 6420 3d3d 2064 6972 6563 7469   || d == directi
+0009f7a0: 6f6e 3a3a 454e 207c 7c20 6420 3d3d 2064  on::EN || d == d
+0009f7b0: 6972 6563 7469 6f6e 3a3a 4553 207c 7c0a  irection::ES ||.
+0009f7c0: 2020 2020 2020 2020 2020 2020 2020 6420                d 
+0009f7d0: 3d3d 2064 6972 6563 7469 6f6e 3a3a 4353  == direction::CS
+0009f7e0: 207c 7c20 6420 3d3d 2064 6972 6563 7469   || d == directi
+0009f7f0: 6f6e 3a3a 4554 207c 7c20 6420 3d3d 2064  on::ET || d == d
+0009f800: 6972 6563 7469 6f6e 3a3a 4f4e 207c 7c0a  irection::ON ||.
+0009f810: 2020 2020 2020 2020 2020 2020 2020 6420                d 
+0009f820: 3d3d 2064 6972 6563 7469 6f6e 3a3a 424e  == direction::BN
+0009f830: 207c 7c20 6420 3d3d 2064 6972 6563 7469   || d == directi
+0009f840: 6f6e 3a3a 4e53 4d29 2920 7b0a 2020 2020  on::NSM)) {.    
+0009f850: 2020 2020 2020 7265 7475 726e 2066 616c        return fal
+0009f860: 7365 3b0a 2020 2020 2020 2020 7d0a 0a20  se;.        }.. 
+0009f870: 2020 2020 2020 2069 6620 2828 6920 3d3d         if ((i ==
+0009f880: 206c 6173 745f 6e6f 6e5f 6e73 6d5f 6368   last_non_nsm_ch
+0009f890: 6172 2920 2626 0a20 2020 2020 2020 2020  ar) &&.         
+0009f8a0: 2020 2021 2864 203d 3d20 6469 7265 6374     !(d == direct
+0009f8b0: 696f 6e3a 3a4c 207c 7c20 6420 3d3d 2064  ion::L || d == d
+0009f8c0: 6972 6563 7469 6f6e 3a3a 454e 2929 207b  irection::EN)) {
+0009f8d0: 0a20 2020 2020 2020 2020 2072 6574 7572  .          retur
+0009f8e0: 6e20 6661 6c73 653b 0a20 2020 2020 2020  n false;.       
+0009f8f0: 207d 0a20 2020 2020 207d 0a0a 2020 2020   }.      }..    
+0009f900: 2020 7265 7475 726e 2074 7275 653b 0a0a    return true;..
+0009f910: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+0009f920: 2020 202f 2f20 4576 616c 2061 7320 5254     // Eval as RT
+0009f930: 4c0a 0a20 2020 2020 2062 6f6f 6c20 6861  L..      bool ha
+0009f940: 735f 616e 203d 2066 616c 7365 3b0a 2020  s_an = false;.  
+0009f950: 2020 2020 626f 6f6c 2068 6173 5f65 6e20      bool has_en 
+0009f960: 3d20 6661 6c73 653b 0a20 2020 2020 2066  = false;.      f
+0009f970: 6f72 2028 7369 7a65 5f74 2069 203d 2030  or (size_t i = 0
+0009f980: 3b20 6920 3c3d 206c 6173 745f 6e6f 6e5f  ; i <= last_non_
+0009f990: 6e73 6d5f 6368 6172 3b20 692b 2b29 207b  nsm_char; i++) {
+0009f9a0: 0a20 2020 2020 2020 2063 6f6e 7374 2064  .        const d
+0009f9b0: 6972 6563 7469 6f6e 2064 203d 2066 696e  irection d = fin
+0009f9c0: 645f 6469 7265 6374 696f 6e28 6c61 6265  d_direction(labe
+0009f9d0: 6c5b 695d 293b 0a0a 2020 2020 2020 2020  l[i]);..        
+0009f9e0: 2f2f 2049 6e20 616e 2052 544c 206c 6162  // In an RTL lab
+0009f9f0: 656c 2c20 6966 2061 6e20 454e 2069 7320  el, if an EN is 
+0009fa00: 7072 6573 656e 742c 206e 6f20 414e 206d  present, no AN m
+0009fa10: 6179 2062 6520 7072 6573 656e 742c 2061  ay be present, a
+0009fa20: 6e64 2076 6963 650a 2020 2020 2020 2020  nd vice.        
+0009fa30: 2f2f 2076 6572 7361 2e0a 2020 2020 2020  // versa..      
+0009fa40: 2020 6966 2028 2864 203d 3d20 6469 7265    if ((d == dire
+0009fa50: 6374 696f 6e3a 3a45 4e20 2626 2028 2868  ction::EN && ((h
+0009fa60: 6173 5f65 6e20 3d20 7472 7565 2920 2626  as_en = true) &&
+0009fa70: 2068 6173 5f61 6e29 2920 7c7c 0a20 2020   has_an)) ||.   
+0009fa80: 2020 2020 2020 2020 2028 6420 3d3d 2064           (d == d
+0009fa90: 6972 6563 7469 6f6e 3a3a 414e 2026 2620  irection::AN && 
+0009faa0: 2828 6861 735f 616e 203d 2074 7275 6529  ((has_an = true)
+0009fab0: 2026 2620 6861 735f 656e 2929 2920 7b0a   && has_en))) {.
+0009fac0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0009fad0: 2066 616c 7365 3b0a 2020 2020 2020 2020   false;.        
+0009fae0: 7d0a 0a20 2020 2020 2020 2069 6620 2821  }..        if (!
+0009faf0: 2864 203d 3d20 6469 7265 6374 696f 6e3a  (d == direction:
+0009fb00: 3a52 207c 7c20 6420 3d3d 2064 6972 6563  :R || d == direc
+0009fb10: 7469 6f6e 3a3a 414c 207c 7c20 6420 3d3d  tion::AL || d ==
+0009fb20: 2064 6972 6563 7469 6f6e 3a3a 414e 207c   direction::AN |
+0009fb30: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
+0009fb40: 6420 3d3d 2064 6972 6563 7469 6f6e 3a3a  d == direction::
+0009fb50: 454e 207c 7c20 6420 3d3d 2064 6972 6563  EN || d == direc
+0009fb60: 7469 6f6e 3a3a 4553 207c 7c20 6420 3d3d  tion::ES || d ==
+0009fb70: 2064 6972 6563 7469 6f6e 3a3a 4353 207c   direction::CS |
+0009fb80: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
+0009fb90: 6420 3d3d 2064 6972 6563 7469 6f6e 3a3a  d == direction::
+0009fba0: 4554 207c 7c20 6420 3d3d 2064 6972 6563  ET || d == direc
+0009fbb0: 7469 6f6e 3a3a 4f4e 207c 7c20 6420 3d3d  tion::ON || d ==
+0009fbc0: 2064 6972 6563 7469 6f6e 3a3a 424e 207c   direction::BN |
+0009fbd0: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
+0009fbe0: 6420 3d3d 2064 6972 6563 7469 6f6e 3a3a  d == direction::
+0009fbf0: 4e53 4d29 2920 7b0a 2020 2020 2020 2020  NSM)) {.        
+0009fc00: 2020 7265 7475 726e 2066 616c 7365 3b0a    return false;.
+0009fc10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0009fc20: 2020 2069 6620 2869 203d 3d20 6c61 7374     if (i == last
+0009fc30: 5f6e 6f6e 5f6e 736d 5f63 6861 7220 2626  _non_nsm_char &&
+0009fc40: 0a20 2020 2020 2020 2020 2020 2021 2864  .            !(d
+0009fc50: 203d 3d20 6469 7265 6374 696f 6e3a 3a52   == direction::R
+0009fc60: 207c 7c20 6420 3d3d 2064 6972 6563 7469   || d == directi
+0009fc70: 6f6e 3a3a 414c 207c 7c20 6420 3d3d 2064  on::AL || d == d
+0009fc80: 6972 6563 7469 6f6e 3a3a 414e 207c 7c0a  irection::AN ||.
+0009fc90: 2020 2020 2020 2020 2020 2020 2020 6420                d 
+0009fca0: 3d3d 2064 6972 6563 7469 6f6e 3a3a 454e  == direction::EN
+0009fcb0: 2929 207b 0a20 2020 2020 2020 2020 2072  )) {.          r
+0009fcc0: 6574 7572 6e20 6661 6c73 653b 0a20 2020  eturn false;.   
+0009fcd0: 2020 2020 207d 0a20 2020 2020 207d 0a0a       }.      }..
+0009fce0: 2020 2020 2020 7265 7475 726e 2074 7275        return tru
+0009fcf0: 653b 0a20 2020 207d 0a20 207d 0a0a 2020  e;.    }.  }..  
+0009fd00: 7265 7475 726e 2074 7275 653b 0a7d 0a0a  return true;.}..
+0009fd10: 7d20 202f 2f20 6e61 6d65 7370 6163 6520  }  // namespace 
+0009fd20: 6164 613a 3a69 646e 610a 2f2a 2065 6e64  ada::idna./* end
+0009fd30: 2066 696c 6520 7372 632f 7661 6c69 6469   file src/validi
+0009fd40: 7479 2e63 7070 202a 2f0a 2f2a 2062 6567  ty.cpp */./* beg
+0009fd50: 696e 2066 696c 6520 7372 632f 746f 5f61  in file src/to_a
+0009fd60: 7363 6969 2e63 7070 202a 2f0a 0a23 696e  scii.cpp */..#in
+0009fd70: 636c 7564 6520 3c61 6c67 6f72 6974 686d  clude <algorithm
+0009fd80: 3e0a 2369 6e63 6c75 6465 203c 6373 7464  >.#include <cstd
+0009fd90: 696e 743e 0a0a 0a6e 616d 6573 7061 6365  int>...namespace
+0009fda0: 2061 6461 3a3a 6964 6e61 207b 0a0a 626f   ada::idna {..bo
+0009fdb0: 6f6c 2063 6f6e 7374 6578 7072 2062 6567  ol constexpr beg
+0009fdc0: 696e 735f 7769 7468 2873 7464 3a3a 7533  ins_with(std::u3
+0009fdd0: 3273 7472 696e 675f 7669 6577 2076 6965  2string_view vie
+0009fde0: 772c 0a20 2020 2020 2020 2020 2020 2020  w,.             
+0009fdf0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0009fe00: 643a 3a75 3332 7374 7269 6e67 5f76 6965  d::u32string_vie
+0009fe10: 7720 7072 6566 6978 2920 7b0a 2020 6966  w prefix) {.  if
+0009fe20: 2028 7669 6577 2e73 697a 6528 2920 3c20   (view.size() < 
+0009fe30: 7072 6566 6978 2e73 697a 6528 2929 207b  prefix.size()) {
+0009fe40: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
+0009fe50: 653b 0a20 207d 0a20 2072 6574 7572 6e20  e;.  }.  return 
+0009fe60: 7669 6577 2e73 7562 7374 7228 302c 2070  view.substr(0, p
+0009fe70: 7265 6669 782e 7369 7a65 2829 2920 3d3d  refix.size()) ==
+0009fe80: 2070 7265 6669 783b 0a7d 0a0a 626f 6f6c   prefix;.}..bool
+0009fe90: 2063 6f6e 7374 6578 7072 2062 6567 696e   constexpr begin
+0009fea0: 735f 7769 7468 2873 7464 3a3a 7374 7269  s_with(std::stri
+0009feb0: 6e67 5f76 6965 7720 7669 6577 2c20 7374  ng_view view, st
+0009fec0: 643a 3a73 7472 696e 675f 7669 6577 2070  d::string_view p
+0009fed0: 7265 6669 7829 207b 0a20 2069 6620 2876  refix) {.  if (v
+0009fee0: 6965 772e 7369 7a65 2829 203c 2070 7265  iew.size() < pre
+0009fef0: 6669 782e 7369 7a65 2829 2920 7b0a 2020  fix.size()) {.  
+0009ff00: 2020 7265 7475 726e 2066 616c 7365 3b0a    return false;.
+0009ff10: 2020 7d0a 2020 7265 7475 726e 2076 6965    }.  return vie
+0009ff20: 772e 7375 6273 7472 2830 2c20 7072 6566  w.substr(0, pref
+0009ff30: 6978 2e73 697a 6528 2929 203d 3d20 7072  ix.size()) == pr
+0009ff40: 6566 6978 3b0a 7d0a 0a62 6f6f 6c20 636f  efix;.}..bool co
+0009ff50: 6e73 7465 7870 7220 6973 5f61 7363 6969  nstexpr is_ascii
+0009ff60: 2873 7464 3a3a 7533 3273 7472 696e 675f  (std::u32string_
+0009ff70: 7669 6577 2076 6965 7729 207b 0a20 2066  view view) {.  f
+0009ff80: 6f72 2028 7569 6e74 3332 5f74 2063 203a  or (uint32_t c :
+0009ff90: 2076 6965 7729 207b 0a20 2020 2069 6620   view) {.    if 
+0009ffa0: 2863 203e 3d20 3078 3830 2920 7b0a 2020  (c >= 0x80) {.  
+0009ffb0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+0009ffc0: 3b0a 2020 2020 7d0a 2020 7d0a 2020 7265  ;.    }.  }.  re
+0009ffd0: 7475 726e 2074 7275 653b 0a7d 0a0a 626f  turn true;.}..bo
+0009ffe0: 6f6c 2063 6f6e 7374 6578 7072 2069 735f  ol constexpr is_
+0009fff0: 6173 6369 6928 7374 643a 3a73 7472 696e  ascii(std::strin
+000a0000: 675f 7669 6577 2076 6965 7729 207b 0a20  g_view view) {. 
+000a0010: 2066 6f72 2028 7569 6e74 385f 7420 6320   for (uint8_t c 
+000a0020: 3a20 7669 6577 2920 7b0a 2020 2020 6966  : view) {.    if
+000a0030: 2028 6320 3e3d 2030 7838 3029 207b 0a20   (c >= 0x80) {. 
+000a0040: 2020 2020 2072 6574 7572 6e20 6661 6c73       return fals
+000a0050: 653b 0a20 2020 207d 0a20 207d 0a20 2072  e;.    }.  }.  r
+000a0060: 6574 7572 6e20 7472 7565 3b0a 7d0a 0a63  eturn true;.}..c
+000a0070: 6f6e 7374 6578 7072 2073 7461 7469 6320  onstexpr static 
+000a0080: 7569 6e74 385f 7420 6973 5f66 6f72 6269  uint8_t is_forbi
+000a0090: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
+000a00a0: 5f70 6f69 6e74 5f74 6162 6c65 5b5d 203d  _point_table[] =
+000a00b0: 207b 0a20 2020 2031 2c20 312c 2031 2c20   {.    1, 1, 1, 
+000a00c0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a00d0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a00e0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a00f0: 312c 2031 2c20 312c 2031 2c20 312c 0a20  1, 1, 1, 1, 1,. 
+000a0100: 2020 2031 2c20 312c 2031 2c20 312c 2031     1, 1, 1, 1, 1
+000a0110: 2c20 312c 2031 2c20 312c 2031 2c20 302c  , 1, 1, 1, 1, 0,
+000a0120: 2030 2c20 312c 2030 2c20 312c 2030 2c20   0, 1, 0, 1, 0, 
+000a0130: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a0140: 2c20 302c 2030 2c20 312c 0a20 2020 2030  , 0, 0, 1,.    0
+000a0150: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a0160: 2030 2c20 302c 2030 2c20 302c 2031 2c20   0, 0, 0, 0, 1, 
+000a0170: 302c 2031 2c20 302c 2031 2c20 312c 2031  0, 1, 0, 1, 1, 1
+000a0180: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a0190: 2030 2c20 302c 0a20 2020 2030 2c20 302c   0, 0,.    0, 0,
+000a01a0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a01b0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a01c0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a01d0: 2030 2c20 312c 2031 2c20 312c 2031 2c20   0, 1, 1, 1, 1, 
+000a01e0: 302c 0a20 2020 2030 2c20 302c 2030 2c20  0,.    0, 0, 0, 
+000a01f0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a0200: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a0210: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a0220: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
+000a0230: 2020 2030 2c20 302c 2030 2c20 302c 2031     0, 0, 0, 0, 1
+000a0240: 2c20 302c 2030 2c20 312c 2031 2c20 312c  , 0, 0, 1, 1, 1,
+000a0250: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a0260: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a0270: 2c20 312c 2031 2c20 312c 0a20 2020 2031  , 1, 1, 1,.    1
+000a0280: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a0290: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a02a0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a02b0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a02c0: 2031 2c20 312c 0a20 2020 2031 2c20 312c   1, 1,.    1, 1,
+000a02d0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a02e0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a02f0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a0300: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a0310: 312c 0a20 2020 2031 2c20 312c 2031 2c20  1,.    1, 1, 1, 
+000a0320: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a0330: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a0340: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a0350: 312c 2031 2c20 312c 2031 2c20 312c 0a20  1, 1, 1, 1, 1,. 
+000a0360: 2020 2031 2c20 312c 2031 2c20 312c 2031     1, 1, 1, 1, 1
+000a0370: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a0380: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a0390: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a03a0: 2c20 312c 2031 2c20 312c 0a20 2020 2031  , 1, 1, 1,.    1
+000a03b0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a03c0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a03d0: 312c 2031 2c20 312c 2031 2c20 317d 3b0a  1, 1, 1, 1, 1};.
+000a03e0: 0a73 7461 7469 635f 6173 7365 7274 2873  .static_assert(s
+000a03f0: 697a 656f 6628 6973 5f66 6f72 6269 6464  izeof(is_forbidd
+000a0400: 656e 5f64 6f6d 6169 6e5f 636f 6465 5f70  en_domain_code_p
+000a0410: 6f69 6e74 5f74 6162 6c65 2920 3d3d 2032  oint_table) == 2
+000a0420: 3536 293b 0a0a 696e 6c69 6e65 2062 6f6f  56);..inline boo
+000a0430: 6c20 6973 5f66 6f72 6269 6464 656e 5f64  l is_forbidden_d
+000a0440: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
+000a0450: 2863 6f6e 7374 2063 6861 7220 6329 206e  (const char c) n
+000a0460: 6f65 7863 6570 7420 7b0a 2020 7265 7475  oexcept {.  retu
+000a0470: 726e 2069 735f 666f 7262 6964 6465 6e5f  rn is_forbidden_
+000a0480: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
+000a0490: 745f 7461 626c 655b 7569 6e74 385f 7428  t_table[uint8_t(
+000a04a0: 6329 5d3b 0a7d 0a0a 626f 6f6c 2063 6f6e  c)];.}..bool con
+000a04b0: 7461 696e 735f 666f 7262 6964 6465 6e5f  tains_forbidden_
+000a04c0: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
+000a04d0: 7428 7374 643a 3a73 7472 696e 675f 7669  t(std::string_vi
+000a04e0: 6577 2076 6965 7729 207b 0a20 2072 6574  ew view) {.  ret
+000a04f0: 7572 6e20 280a 2020 2020 2020 7374 643a  urn (.      std:
+000a0500: 3a61 6e79 5f6f 6628 7669 6577 2e62 6567  :any_of(view.beg
+000a0510: 696e 2829 2c20 7669 6577 2e65 6e64 2829  in(), view.end()
+000a0520: 2c20 6973 5f66 6f72 6269 6464 656e 5f64  , is_forbidden_d
+000a0530: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
+000a0540: 2929 3b0a 7d0a 0a2f 2f20 5765 2072 6574  ));.}..// We ret
+000a0550: 7572 6e20 2222 206f 6e20 6572 726f 722e  urn "" on error.
+000a0560: 0a73 7461 7469 6320 7374 643a 3a73 7472  .static std::str
+000a0570: 696e 6720 6672 6f6d 5f61 7363 6969 5f74  ing from_ascii_t
+000a0580: 6f5f 6173 6369 6928 7374 643a 3a73 7472  o_ascii(std::str
+000a0590: 696e 675f 7669 6577 2075 7438 5f73 7472  ing_view ut8_str
+000a05a0: 696e 6729 207b 0a20 2073 7461 7469 6320  ing) {.  static 
+000a05b0: 636f 6e73 7420 7374 643a 3a73 7472 696e  const std::strin
+000a05c0: 6720 6572 726f 7220 3d20 2222 3b0a 2020  g error = "";.  
+000a05d0: 2f2f 2063 6f70 7920 616e 6420 6d61 700a  // copy and map.
+000a05e0: 2020 2f2f 2077 6520 636f 756c 6420 6265    // we could be
+000a05f0: 206d 6f72 6520 6566 6669 6369 656e 7420   more efficient 
+000a0600: 6279 2061 766f 6964 696e 6720 7468 6520  by avoiding the 
+000a0610: 636f 7079 2077 6865 6e20 756e 6e65 6365  copy when unnece
+000a0620: 7373 6172 792e 0a20 2073 7464 3a3a 7374  ssary..  std::st
+000a0630: 7269 6e67 206d 6170 7065 645f 7374 7269  ring mapped_stri
+000a0640: 6e67 203d 2073 7464 3a3a 7374 7269 6e67  ng = std::string
+000a0650: 2875 7438 5f73 7472 696e 6729 3b0a 2020  (ut8_string);.  
+000a0660: 6173 6369 695f 6d61 7028 6d61 7070 6564  ascii_map(mapped
+000a0670: 5f73 7472 696e 672e 6461 7461 2829 2c20  _string.data(), 
+000a0680: 6d61 7070 6564 5f73 7472 696e 672e 7369  mapped_string.si
+000a0690: 7a65 2829 293b 0a20 2073 7464 3a3a 7374  ze());.  std::st
+000a06a0: 7269 6e67 206f 7574 3b0a 2020 7369 7a65  ring out;.  size
+000a06b0: 5f74 206c 6162 656c 5f73 7461 7274 203d  _t label_start =
+000a06c0: 2030 3b0a 0a20 2077 6869 6c65 2028 6c61   0;..  while (la
+000a06d0: 6265 6c5f 7374 6172 7420 213d 206d 6170  bel_start != map
+000a06e0: 7065 645f 7374 7269 6e67 2e73 697a 6528  ped_string.size(
+000a06f0: 2929 207b 0a20 2020 2073 697a 655f 7420  )) {.    size_t 
+000a0700: 6c6f 635f 646f 7420 3d20 6d61 7070 6564  loc_dot = mapped
+000a0710: 5f73 7472 696e 672e 6669 6e64 2827 2e27  _string.find('.'
+000a0720: 2c20 6c61 6265 6c5f 7374 6172 7429 3b0a  , label_start);.
+000a0730: 2020 2020 626f 6f6c 2069 735f 6c61 7374      bool is_last
+000a0740: 5f6c 6162 656c 203d 2028 6c6f 635f 646f  _label = (loc_do
+000a0750: 7420 3d3d 2073 7464 3a3a 7374 7269 6e67  t == std::string
+000a0760: 5f76 6965 773a 3a6e 706f 7329 3b0a 2020  _view::npos);.  
+000a0770: 2020 7369 7a65 5f74 206c 6162 656c 5f73    size_t label_s
+000a0780: 697a 6520 3d20 6973 5f6c 6173 745f 6c61  ize = is_last_la
+000a0790: 6265 6c20 3f20 6d61 7070 6564 5f73 7472  bel ? mapped_str
+000a07a0: 696e 672e 7369 7a65 2829 202d 206c 6162  ing.size() - lab
+000a07b0: 656c 5f73 7461 7274 0a20 2020 2020 2020  el_start.       
 000a07c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a07d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a07e0: 3a20 6c6f 635f 646f 7420 2d20 6c61 6265  : loc_dot - labe
-000a07f0: 6c5f 7374 6172 743b 0a20 2020 2073 697a  l_start;.    siz
-000a0800: 655f 7420 6c61 6265 6c5f 7369 7a65 5f77  e_t label_size_w
-000a0810: 6974 685f 646f 7420 3d20 6973 5f6c 6173  ith_dot = is_las
-000a0820: 745f 6c61 6265 6c20 3f20 6c61 6265 6c5f  t_label ? label_
-000a0830: 7369 7a65 203a 206c 6162 656c 5f73 697a  size : label_siz
-000a0840: 6520 2b20 313b 0a20 2020 2073 7464 3a3a  e + 1;.    std::
-000a0850: 7374 7269 6e67 5f76 6965 7720 6c61 6265  string_view labe
-000a0860: 6c5f 7669 6577 286d 6170 7065 645f 7374  l_view(mapped_st
-000a0870: 7269 6e67 2e64 6174 6128 2920 2b20 6c61  ring.data() + la
-000a0880: 6265 6c5f 7374 6172 742c 206c 6162 656c  bel_start, label
-000a0890: 5f73 697a 6529 3b0a 2020 2020 6c61 6265  _size);.    labe
-000a08a0: 6c5f 7374 6172 7420 2b3d 206c 6162 656c  l_start += label
-000a08b0: 5f73 697a 655f 7769 7468 5f64 6f74 3b0a  _size_with_dot;.
-000a08c0: 2020 2020 6966 2028 6c61 6265 6c5f 7369      if (label_si
-000a08d0: 7a65 203d 3d20 3029 207b 0a20 2020 2020  ze == 0) {.     
-000a08e0: 202f 2f20 656d 7074 7920 6c61 6265 6c3f   // empty label?
-000a08f0: 204e 6f74 6869 6e67 2074 6f20 646f 2e0a   Nothing to do..
-000a0900: 2020 2020 7d20 656c 7365 2069 6620 2862      } else if (b
-000a0910: 6567 696e 735f 7769 7468 286c 6162 656c  egins_with(label
-000a0920: 5f76 6965 772c 2022 786e 2d2d 2229 2920  _view, "xn--")) 
-000a0930: 7b0a 2020 2020 2020 2f2f 2054 6865 2078  {.      // The x
-000a0940: 6e2d 2d20 7061 7274 2069 7320 7468 6520  n-- part is the 
-000a0950: 6578 7065 6e73 6976 6520 6761 6d65 2e0a  expensive game..
-000a0960: 2020 2020 2020 6f75 742e 6170 7065 6e64        out.append
-000a0970: 286c 6162 656c 5f76 6965 7729 3b0a 2020  (label_view);.  
-000a0980: 2020 2020 7374 643a 3a73 7472 696e 675f      std::string_
-000a0990: 7669 6577 2070 756e 795f 7365 676d 656e  view puny_segmen
-000a09a0: 745f 6173 6369 6928 0a20 2020 2020 2020  t_ascii(.       
-000a09b0: 2020 206f 7574 2e64 6174 6128 2920 2b20     out.data() + 
-000a09c0: 6f75 742e 7369 7a65 2829 202d 206c 6162  out.size() - lab
-000a09d0: 656c 5f76 6965 772e 7369 7a65 2829 202b  el_view.size() +
-000a09e0: 2034 2c0a 2020 2020 2020 2020 2020 6c61   4,.          la
-000a09f0: 6265 6c5f 7669 6577 2e73 697a 6528 2920  bel_view.size() 
-000a0a00: 2d20 3429 3b0a 2020 2020 2020 7374 643a  - 4);.      std:
-000a0a10: 3a75 3332 7374 7269 6e67 2074 6d70 5f62  :u32string tmp_b
-000a0a20: 7566 6665 723b 0a20 2020 2020 2062 6f6f  uffer;.      boo
-000a0a30: 6c20 6973 5f6f 6b20 3d20 6164 613a 3a69  l is_ok = ada::i
-000a0a40: 646e 613a 3a70 756e 7963 6f64 655f 746f  dna::punycode_to
-000a0a50: 5f75 7466 3332 2870 756e 795f 7365 676d  _utf32(puny_segm
-000a0a60: 656e 745f 6173 6369 692c 2074 6d70 5f62  ent_ascii, tmp_b
-000a0a70: 7566 6665 7229 3b0a 2020 2020 2020 6966  uffer);.      if
-000a0a80: 2028 2169 735f 6f6b 2920 7b0a 2020 2020   (!is_ok) {.    
-000a0a90: 2020 2020 7265 7475 726e 2065 7272 6f72      return error
-000a0aa0: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
-000a0ab0: 7374 643a 3a75 3332 7374 7269 6e67 2070  std::u32string p
-000a0ac0: 6f73 745f 6d61 7020 3d20 6164 613a 3a69  ost_map = ada::i
-000a0ad0: 646e 613a 3a6d 6170 2874 6d70 5f62 7566  dna::map(tmp_buf
-000a0ae0: 6665 7229 3b0a 2020 2020 2020 6966 2028  fer);.      if (
-000a0af0: 746d 705f 6275 6666 6572 2021 3d20 706f  tmp_buffer != po
-000a0b00: 7374 5f6d 6170 2920 7b0a 2020 2020 2020  st_map) {.      
-000a0b10: 2020 7265 7475 726e 2065 7272 6f72 3b0a    return error;.
-000a0b20: 2020 2020 2020 7d0a 2020 2020 2020 7374        }.      st
-000a0b30: 643a 3a75 3332 7374 7269 6e67 2070 7265  d::u32string pre
-000a0b40: 5f6e 6f72 6d61 6c20 3d20 706f 7374 5f6d  _normal = post_m
-000a0b50: 6170 3b0a 2020 2020 2020 6e6f 726d 616c  ap;.      normal
-000a0b60: 697a 6528 706f 7374 5f6d 6170 293b 0a20  ize(post_map);. 
-000a0b70: 2020 2020 2069 6620 2870 6f73 745f 6d61       if (post_ma
-000a0b80: 7020 213d 2070 7265 5f6e 6f72 6d61 6c29  p != pre_normal)
-000a0b90: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-000a0ba0: 6e20 6572 726f 723b 0a20 2020 2020 207d  n error;.      }
-000a0bb0: 0a20 2020 2020 2069 6620 2870 6f73 745f  .      if (post_
-000a0bc0: 6d61 702e 656d 7074 7928 2929 207b 0a20  map.empty()) {. 
-000a0bd0: 2020 2020 2020 2072 6574 7572 6e20 6572         return er
-000a0be0: 726f 723b 0a20 2020 2020 207d 0a20 2020  ror;.      }.   
-000a0bf0: 2020 2069 6620 2821 6973 5f6c 6162 656c     if (!is_label
-000a0c00: 5f76 616c 6964 2870 6f73 745f 6d61 7029  _valid(post_map)
-000a0c10: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-000a0c20: 726e 2065 7272 6f72 3b0a 2020 2020 2020  rn error;.      
-000a0c30: 7d0a 2020 2020 7d20 656c 7365 207b 0a20  }.    } else {. 
-000a0c40: 2020 2020 206f 7574 2e61 7070 656e 6428       out.append(
-000a0c50: 6c61 6265 6c5f 7669 6577 293b 0a20 2020  label_view);.   
-000a0c60: 207d 0a20 2020 2069 6620 2821 6973 5f6c   }.    if (!is_l
-000a0c70: 6173 745f 6c61 6265 6c29 207b 0a20 2020  ast_label) {.   
-000a0c80: 2020 206f 7574 2e70 7573 685f 6261 636b     out.push_back
-000a0c90: 2827 2e27 293b 0a20 2020 207d 0a20 207d  ('.');.    }.  }
-000a0ca0: 0a20 2072 6574 7572 6e20 6f75 743b 0a7d  .  return out;.}
-000a0cb0: 0a0a 2f2f 2057 6520 7265 7475 726e 2022  ..// We return "
-000a0cc0: 2220 6f6e 2065 7272 6f72 2e0a 7374 643a  " on error..std:
-000a0cd0: 3a73 7472 696e 6720 746f 5f61 7363 6969  :string to_ascii
-000a0ce0: 2873 7464 3a3a 7374 7269 6e67 5f76 6965  (std::string_vie
-000a0cf0: 7720 7574 385f 7374 7269 6e67 2920 7b0a  w ut8_string) {.
-000a0d00: 2020 6966 2028 6973 5f61 7363 6969 2875    if (is_ascii(u
-000a0d10: 7438 5f73 7472 696e 6729 2920 7b0a 2020  t8_string)) {.  
-000a0d20: 2020 7265 7475 726e 2066 726f 6d5f 6173    return from_as
-000a0d30: 6369 695f 746f 5f61 7363 6969 2875 7438  cii_to_ascii(ut8
-000a0d40: 5f73 7472 696e 6729 3b0a 2020 7d0a 2020  _string);.  }.  
-000a0d50: 7374 6174 6963 2063 6f6e 7374 2073 7464  static const std
-000a0d60: 3a3a 7374 7269 6e67 2065 7272 6f72 203d  ::string error =
-000a0d70: 2022 223b 0a20 202f 2f20 5765 2063 6f6e   "";.  // We con
-000a0d80: 7665 7274 2074 6f20 5554 462d 3332 0a20  vert to UTF-32. 
-000a0d90: 2073 697a 655f 7420 7574 6633 325f 6c65   size_t utf32_le
-000a0da0: 6e67 7468 203d 0a20 2020 2020 2061 6461  ngth =.      ada
-000a0db0: 3a3a 6964 6e61 3a3a 7574 6633 325f 6c65  ::idna::utf32_le
-000a0dc0: 6e67 7468 5f66 726f 6d5f 7574 6638 2875  ngth_from_utf8(u
-000a0dd0: 7438 5f73 7472 696e 672e 6461 7461 2829  t8_string.data()
-000a0de0: 2c20 7574 385f 7374 7269 6e67 2e73 697a  , ut8_string.siz
-000a0df0: 6528 2929 3b0a 2020 7374 643a 3a75 3332  e());.  std::u32
-000a0e00: 7374 7269 6e67 2075 7466 3332 2875 7466  string utf32(utf
-000a0e10: 3332 5f6c 656e 6774 682c 2027 5c30 2729  32_length, '\0')
-000a0e20: 3b0a 2020 7369 7a65 5f74 2061 6374 7561  ;.  size_t actua
-000a0e30: 6c5f 7574 6633 325f 6c65 6e67 7468 203d  l_utf32_length =
-000a0e40: 2061 6461 3a3a 6964 6e61 3a3a 7574 6638   ada::idna::utf8
-000a0e50: 5f74 6f5f 7574 6633 3228 0a20 2020 2020  _to_utf32(.     
-000a0e60: 2075 7438 5f73 7472 696e 672e 6461 7461   ut8_string.data
-000a0e70: 2829 2c20 7574 385f 7374 7269 6e67 2e73  (), ut8_string.s
-000a0e80: 697a 6528 292c 2075 7466 3332 2e64 6174  ize(), utf32.dat
-000a0e90: 6128 2929 3b0a 2020 6966 2028 6163 7475  a());.  if (actu
-000a0ea0: 616c 5f75 7466 3332 5f6c 656e 6774 6820  al_utf32_length 
-000a0eb0: 3d3d 2030 2920 7b0a 2020 2020 7265 7475  == 0) {.    retu
-000a0ec0: 726e 2065 7272 6f72 3b0a 2020 7d0a 2020  rn error;.  }.  
-000a0ed0: 2f2f 206d 6170 7069 6e67 0a20 2075 7466  // mapping.  utf
-000a0ee0: 3332 203d 2061 6461 3a3a 6964 6e61 3a3a  32 = ada::idna::
-000a0ef0: 6d61 7028 7574 6633 3229 3b0a 2020 6e6f  map(utf32);.  no
-000a0f00: 726d 616c 697a 6528 7574 6633 3229 3b0a  rmalize(utf32);.
-000a0f10: 2020 7374 643a 3a73 7472 696e 6720 6f75    std::string ou
-000a0f20: 743b 0a20 2073 697a 655f 7420 6c61 6265  t;.  size_t labe
-000a0f30: 6c5f 7374 6172 7420 3d20 303b 0a0a 2020  l_start = 0;..  
-000a0f40: 7768 696c 6520 286c 6162 656c 5f73 7461  while (label_sta
-000a0f50: 7274 2021 3d20 7574 6633 322e 7369 7a65  rt != utf32.size
-000a0f60: 2829 2920 7b0a 2020 2020 7369 7a65 5f74  ()) {.    size_t
-000a0f70: 206c 6f63 5f64 6f74 203d 2075 7466 3332   loc_dot = utf32
-000a0f80: 2e66 696e 6428 272e 272c 206c 6162 656c  .find('.', label
-000a0f90: 5f73 7461 7274 293b 0a20 2020 2062 6f6f  _start);.    boo
-000a0fa0: 6c20 6973 5f6c 6173 745f 6c61 6265 6c20  l is_last_label 
-000a0fb0: 3d20 286c 6f63 5f64 6f74 203d 3d20 7374  = (loc_dot == st
-000a0fc0: 643a 3a73 7472 696e 675f 7669 6577 3a3a  d::string_view::
-000a0fd0: 6e70 6f73 293b 0a20 2020 2073 697a 655f  npos);.    size_
-000a0fe0: 7420 6c61 6265 6c5f 7369 7a65 203d 0a20  t label_size =. 
-000a0ff0: 2020 2020 2020 2069 735f 6c61 7374 5f6c         is_last_l
-000a1000: 6162 656c 203f 2075 7466 3332 2e73 697a  abel ? utf32.siz
-000a1010: 6528 2920 2d20 6c61 6265 6c5f 7374 6172  e() - label_star
-000a1020: 7420 3a20 6c6f 635f 646f 7420 2d20 6c61  t : loc_dot - la
-000a1030: 6265 6c5f 7374 6172 743b 0a20 2020 2073  bel_start;.    s
-000a1040: 697a 655f 7420 6c61 6265 6c5f 7369 7a65  ize_t label_size
-000a1050: 5f77 6974 685f 646f 7420 3d20 6973 5f6c  _with_dot = is_l
-000a1060: 6173 745f 6c61 6265 6c20 3f20 6c61 6265  ast_label ? labe
-000a1070: 6c5f 7369 7a65 203a 206c 6162 656c 5f73  l_size : label_s
-000a1080: 697a 6520 2b20 313b 0a20 2020 2073 7464  ize + 1;.    std
-000a1090: 3a3a 7533 3273 7472 696e 675f 7669 6577  ::u32string_view
-000a10a0: 206c 6162 656c 5f76 6965 7728 7574 6633   label_view(utf3
-000a10b0: 322e 6461 7461 2829 202b 206c 6162 656c  2.data() + label
-000a10c0: 5f73 7461 7274 2c20 6c61 6265 6c5f 7369  _start, label_si
-000a10d0: 7a65 293b 0a20 2020 206c 6162 656c 5f73  ze);.    label_s
-000a10e0: 7461 7274 202b 3d20 6c61 6265 6c5f 7369  tart += label_si
-000a10f0: 7a65 5f77 6974 685f 646f 743b 0a20 2020  ze_with_dot;.   
-000a1100: 2069 6620 286c 6162 656c 5f73 697a 6520   if (label_size 
-000a1110: 3d3d 2030 2920 7b0a 2020 2020 2020 2f2f  == 0) {.      //
-000a1120: 2065 6d70 7479 206c 6162 656c 3f20 4e6f   empty label? No
-000a1130: 7468 696e 6720 746f 2064 6f2e 0a20 2020  thing to do..   
-000a1140: 207d 2065 6c73 6520 6966 2028 6265 6769   } else if (begi
-000a1150: 6e73 5f77 6974 6828 6c61 6265 6c5f 7669  ns_with(label_vi
-000a1160: 6577 2c20 5522 786e 2d2d 2229 2920 7b0a  ew, U"xn--")) {.
-000a1170: 2020 2020 2020 2f2f 2077 6520 646f 206e        // we do n
-000a1180: 6f74 206e 6565 6420 746f 2063 6865 636b  ot need to check
-000a1190: 2c20 652e 672e 2c20 586e 2d2d 2062 6563  , e.g., Xn-- bec
-000a11a0: 6175 7365 206d 6170 7069 6e67 2067 6f65  ause mapping goe
-000a11b0: 7320 746f 206c 6f77 6572 2063 6173 650a  s to lower case.
-000a11c0: 2020 2020 2020 666f 7220 2863 6861 7233        for (char3
-000a11d0: 325f 7420 6320 3a20 6c61 6265 6c5f 7669  2_t c : label_vi
-000a11e0: 6577 2920 7b0a 2020 2020 2020 2020 6966  ew) {.        if
-000a11f0: 2028 6320 3e3d 2030 7838 3029 207b 0a20   (c >= 0x80) {. 
-000a1200: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000a1210: 6572 726f 723b 0a20 2020 2020 2020 207d  error;.        }
-000a1220: 0a20 2020 2020 2020 206f 7574 202b 3d20  .        out += 
-000a1230: 2875 6e73 6967 6e65 6420 6368 6172 2928  (unsigned char)(
-000a1240: 6329 3b0a 2020 2020 2020 7d0a 2020 2020  c);.      }.    
-000a1250: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
-000a1260: 6577 2070 756e 795f 7365 676d 656e 745f  ew puny_segment_
-000a1270: 6173 6369 6928 0a20 2020 2020 2020 2020  ascii(.         
-000a1280: 206f 7574 2e64 6174 6128 2920 2b20 6f75   out.data() + ou
-000a1290: 742e 7369 7a65 2829 202d 206c 6162 656c  t.size() - label
-000a12a0: 5f76 6965 772e 7369 7a65 2829 202b 2034  _view.size() + 4
-000a12b0: 2c0a 2020 2020 2020 2020 2020 6c61 6265  ,.          labe
-000a12c0: 6c5f 7669 6577 2e73 697a 6528 2920 2d20  l_view.size() - 
-000a12d0: 3429 3b0a 2020 2020 2020 7374 643a 3a75  4);.      std::u
-000a12e0: 3332 7374 7269 6e67 2074 6d70 5f62 7566  32string tmp_buf
-000a12f0: 6665 723b 0a20 2020 2020 2062 6f6f 6c20  fer;.      bool 
-000a1300: 6973 5f6f 6b20 3d20 6164 613a 3a69 646e  is_ok = ada::idn
-000a1310: 613a 3a70 756e 7963 6f64 655f 746f 5f75  a::punycode_to_u
-000a1320: 7466 3332 2870 756e 795f 7365 676d 656e  tf32(puny_segmen
-000a1330: 745f 6173 6369 692c 2074 6d70 5f62 7566  t_ascii, tmp_buf
-000a1340: 6665 7229 3b0a 2020 2020 2020 6966 2028  fer);.      if (
-000a1350: 2169 735f 6f6b 2920 7b0a 2020 2020 2020  !is_ok) {.      
-000a1360: 2020 7265 7475 726e 2065 7272 6f72 3b0a    return error;.
-000a1370: 2020 2020 2020 7d0a 2020 2020 2020 7374        }.      st
-000a1380: 643a 3a75 3332 7374 7269 6e67 2070 6f73  d::u32string pos
-000a1390: 745f 6d61 7020 3d20 6164 613a 3a69 646e  t_map = ada::idn
-000a13a0: 613a 3a6d 6170 2874 6d70 5f62 7566 6665  a::map(tmp_buffe
-000a13b0: 7229 3b0a 2020 2020 2020 6966 2028 746d  r);.      if (tm
-000a13c0: 705f 6275 6666 6572 2021 3d20 706f 7374  p_buffer != post
-000a13d0: 5f6d 6170 2920 7b0a 2020 2020 2020 2020  _map) {.        
-000a13e0: 7265 7475 726e 2065 7272 6f72 3b0a 2020  return error;.  
-000a13f0: 2020 2020 7d0a 2020 2020 2020 7374 643a      }.      std:
-000a1400: 3a75 3332 7374 7269 6e67 2070 7265 5f6e  :u32string pre_n
-000a1410: 6f72 6d61 6c20 3d20 706f 7374 5f6d 6170  ormal = post_map
-000a1420: 3b0a 2020 2020 2020 6e6f 726d 616c 697a  ;.      normaliz
-000a1430: 6528 706f 7374 5f6d 6170 293b 0a20 2020  e(post_map);.   
-000a1440: 2020 2069 6620 2870 6f73 745f 6d61 7020     if (post_map 
-000a1450: 213d 2070 7265 5f6e 6f72 6d61 6c29 207b  != pre_normal) {
-000a1460: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000a1470: 6572 726f 723b 0a20 2020 2020 207d 0a20  error;.      }. 
-000a1480: 2020 2020 2069 6620 2870 6f73 745f 6d61       if (post_ma
-000a1490: 702e 656d 7074 7928 2929 207b 0a20 2020  p.empty()) {.   
-000a14a0: 2020 2020 2072 6574 7572 6e20 6572 726f       return erro
-000a14b0: 723b 0a20 2020 2020 207d 0a20 2020 2020  r;.      }.     
-000a14c0: 2069 6620 2821 6973 5f6c 6162 656c 5f76   if (!is_label_v
-000a14d0: 616c 6964 2870 6f73 745f 6d61 7029 2920  alid(post_map)) 
-000a14e0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-000a14f0: 2065 7272 6f72 3b0a 2020 2020 2020 7d0a   error;.      }.
-000a1500: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-000a1510: 2020 202f 2f20 5468 6520 6661 7374 2070     // The fast p
-000a1520: 6174 6820 6865 7265 2069 7320 616e 2061  ath here is an a
-000a1530: 7363 6969 206c 6162 656c 2e0a 2020 2020  scii label..    
-000a1540: 2020 6966 2028 6973 5f61 7363 6969 286c    if (is_ascii(l
-000a1550: 6162 656c 5f76 6965 7729 2920 7b0a 2020  abel_view)) {.  
-000a1560: 2020 2020 2020 2f2f 206e 6f20 7661 6c69        // no vali
-000a1570: 6461 7469 6f6e 206e 6565 6465 642e 0a20  dation needed.. 
-000a1580: 2020 2020 2020 2066 6f72 2028 6368 6172         for (char
-000a1590: 3332 5f74 2063 203a 206c 6162 656c 5f76  32_t c : label_v
-000a15a0: 6965 7729 207b 0a20 2020 2020 2020 2020  iew) {.         
-000a15b0: 206f 7574 202b 3d20 2875 6e73 6967 6e65   out += (unsigne
-000a15c0: 6420 6368 6172 2928 6329 3b0a 2020 2020  d char)(c);.    
-000a15d0: 2020 2020 7d0a 2020 2020 2020 7d20 656c      }.      } el
-000a15e0: 7365 207b 0a20 2020 2020 2020 202f 2f20  se {.        // 
-000a15f0: 736c 6f77 2070 6174 682e 0a20 2020 2020  slow path..     
-000a1600: 2020 202f 2f20 6669 7273 7420 6368 6563     // first chec
-000a1610: 6b20 7661 6c69 6469 7479 2e0a 2020 2020  k validity..    
-000a1620: 2020 2020 6966 2028 2169 735f 6c61 6265      if (!is_labe
-000a1630: 6c5f 7661 6c69 6428 6c61 6265 6c5f 7669  l_valid(label_vi
-000a1640: 6577 2929 207b 0a20 2020 2020 2020 2020  ew)) {.         
-000a1650: 2072 6574 7572 6e20 6572 726f 723b 0a20   return error;. 
-000a1660: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000a1670: 202f 2f20 4974 2069 7320 7661 6c69 6421   // It is valid!
-000a1680: 2053 6f20 6e6f 7720 7765 206d 7573 7420   So now we must 
-000a1690: 656e 636f 6465 2069 7420 6173 2070 756e  encode it as pun
-000a16a0: 7963 6f64 652e 2e2e 0a20 2020 2020 2020  ycode....       
-000a16b0: 206f 7574 2e61 7070 656e 6428 2278 6e2d   out.append("xn-
-000a16c0: 2d22 293b 0a20 2020 2020 2020 2062 6f6f  -");.        boo
-000a16d0: 6c20 6973 5f6f 6b20 3d20 6164 613a 3a69  l is_ok = ada::i
-000a16e0: 646e 613a 3a75 7466 3332 5f74 6f5f 7075  dna::utf32_to_pu
-000a16f0: 6e79 636f 6465 286c 6162 656c 5f76 6965  nycode(label_vie
-000a1700: 772c 206f 7574 293b 0a20 2020 2020 2020  w, out);.       
-000a1710: 2069 6620 2821 6973 5f6f 6b29 207b 0a20   if (!is_ok) {. 
-000a1720: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000a1730: 6572 726f 723b 0a20 2020 2020 2020 207d  error;.        }
-000a1740: 0a20 2020 2020 207d 0a20 2020 207d 0a20  .      }.    }. 
-000a1750: 2020 2069 6620 2821 6973 5f6c 6173 745f     if (!is_last_
-000a1760: 6c61 6265 6c29 207b 0a20 2020 2020 206f  label) {.      o
-000a1770: 7574 2e70 7573 685f 6261 636b 2827 2e27  ut.push_back('.'
-000a1780: 293b 0a20 2020 207d 0a20 207d 0a20 2072  );.    }.  }.  r
-000a1790: 6574 7572 6e20 6f75 743b 0a7d 0a7d 2020  eturn out;.}.}  
-000a17a0: 2f2f 206e 616d 6573 7061 6365 2061 6461  // namespace ada
-000a17b0: 3a3a 6964 6e61 0a2f 2a20 656e 6420 6669  ::idna./* end fi
-000a17c0: 6c65 2073 7263 2f74 6f5f 6173 6369 692e  le src/to_ascii.
-000a17d0: 6370 7020 2a2f 0a2f 2a20 6265 6769 6e20  cpp */./* begin 
-000a17e0: 6669 6c65 2073 7263 2f74 6f5f 756e 6963  file src/to_unic
-000a17f0: 6f64 652e 6370 7020 2a2f 0a0a 2369 6e63  ode.cpp */..#inc
-000a1800: 6c75 6465 203c 616c 676f 7269 7468 6d3e  lude <algorithm>
-000a1810: 0a23 696e 636c 7564 6520 3c73 7472 696e  .#include <strin
-000a1820: 673e 0a0a 0a6e 616d 6573 7061 6365 2061  g>...namespace a
-000a1830: 6461 3a3a 6964 6e61 207b 0a73 7464 3a3a  da::idna {.std::
-000a1840: 7374 7269 6e67 2074 6f5f 756e 6963 6f64  string to_unicod
-000a1850: 6528 7374 643a 3a73 7472 696e 675f 7669  e(std::string_vi
-000a1860: 6577 2069 6e70 7574 2920 7b0a 2020 7374  ew input) {.  st
-000a1870: 643a 3a73 7472 696e 6720 6f75 7470 7574  d::string output
-000a1880: 3b0a 2020 6f75 7470 7574 2e72 6573 6572  ;.  output.reser
-000a1890: 7665 2869 6e70 7574 2e73 697a 6528 2929  ve(input.size())
-000a18a0: 3b0a 0a20 2073 697a 655f 7420 6c61 6265  ;..  size_t labe
-000a18b0: 6c5f 7374 6172 7420 3d20 303b 0a20 2077  l_start = 0;.  w
-000a18c0: 6869 6c65 2028 6c61 6265 6c5f 7374 6172  hile (label_star
-000a18d0: 7420 3c20 696e 7075 742e 7369 7a65 2829  t < input.size()
-000a18e0: 2920 7b0a 2020 2020 7369 7a65 5f74 206c  ) {.    size_t l
-000a18f0: 6f63 5f64 6f74 203d 2069 6e70 7574 2e66  oc_dot = input.f
-000a1900: 696e 6428 272e 272c 206c 6162 656c 5f73  ind('.', label_s
-000a1910: 7461 7274 293b 0a20 2020 2062 6f6f 6c20  tart);.    bool 
-000a1920: 6973 5f6c 6173 745f 6c61 6265 6c20 3d20  is_last_label = 
-000a1930: 286c 6f63 5f64 6f74 203d 3d20 7374 643a  (loc_dot == std:
-000a1940: 3a73 7472 696e 675f 7669 6577 3a3a 6e70  :string_view::np
-000a1950: 6f73 293b 0a20 2020 2073 697a 655f 7420  os);.    size_t 
-000a1960: 6c61 6265 6c5f 7369 7a65 203d 0a20 2020  label_size =.   
-000a1970: 2020 2020 2069 735f 6c61 7374 5f6c 6162       is_last_lab
-000a1980: 656c 203f 2069 6e70 7574 2e73 697a 6528  el ? input.size(
-000a1990: 2920 2d20 6c61 6265 6c5f 7374 6172 7420  ) - label_start 
-000a19a0: 3a20 6c6f 635f 646f 7420 2d20 6c61 6265  : loc_dot - labe
-000a19b0: 6c5f 7374 6172 743b 0a20 2020 2061 7574  l_start;.    aut
-000a19c0: 6f20 6c61 6265 6c5f 7669 6577 203d 2073  o label_view = s
-000a19d0: 7464 3a3a 7374 7269 6e67 5f76 6965 7728  td::string_view(
-000a19e0: 696e 7075 742e 6461 7461 2829 202b 206c  input.data() + l
-000a19f0: 6162 656c 5f73 7461 7274 2c20 6c61 6265  abel_start, labe
-000a1a00: 6c5f 7369 7a65 293b 0a0a 2020 2020 6966  l_size);..    if
-000a1a10: 2028 6164 613a 3a69 646e 613a 3a62 6567   (ada::idna::beg
-000a1a20: 696e 735f 7769 7468 286c 6162 656c 5f76  ins_with(label_v
-000a1a30: 6965 772c 2022 786e 2d2d 2229 2026 260a  iew, "xn--") &&.
-000a1a40: 2020 2020 2020 2020 6164 613a 3a69 646e          ada::idn
-000a1a50: 613a 3a69 735f 6173 6369 6928 6c61 6265  a::is_ascii(labe
-000a1a60: 6c5f 7669 6577 2929 207b 0a20 2020 2020  l_view)) {.     
-000a1a70: 206c 6162 656c 5f76 6965 772e 7265 6d6f   label_view.remo
-000a1a80: 7665 5f70 7265 6669 7828 3429 3b0a 2020  ve_prefix(4);.  
-000a1a90: 2020 2020 6966 2028 6164 613a 3a69 646e      if (ada::idn
-000a1aa0: 613a 3a76 6572 6966 795f 7075 6e79 636f  a::verify_punyco
-000a1ab0: 6465 286c 6162 656c 5f76 6965 7729 2920  de(label_view)) 
-000a1ac0: 7b0a 2020 2020 2020 2020 7374 643a 3a75  {.        std::u
-000a1ad0: 3332 7374 7269 6e67 2074 6d70 5f62 7566  32string tmp_buf
-000a1ae0: 6665 723b 0a20 2020 2020 2020 2069 6620  fer;.        if 
-000a1af0: 2861 6461 3a3a 6964 6e61 3a3a 7075 6e79  (ada::idna::puny
-000a1b00: 636f 6465 5f74 6f5f 7574 6633 3228 6c61  code_to_utf32(la
-000a1b10: 6265 6c5f 7669 6577 2c20 746d 705f 6275  bel_view, tmp_bu
-000a1b20: 6666 6572 2929 207b 0a20 2020 2020 2020  ffer)) {.       
-000a1b30: 2020 2061 7574 6f20 7574 6638 5f73 697a     auto utf8_siz
-000a1b40: 6520 3d20 6164 613a 3a69 646e 613a 3a75  e = ada::idna::u
-000a1b50: 7466 385f 6c65 6e67 7468 5f66 726f 6d5f  tf8_length_from_
-000a1b60: 7574 6633 3228 746d 705f 6275 6666 6572  utf32(tmp_buffer
-000a1b70: 2e64 6174 6128 292c 0a20 2020 2020 2020  .data(),.       
+000a07d0: 2020 2020 2020 2020 2020 2020 2020 203a                 :
+000a07e0: 206c 6f63 5f64 6f74 202d 206c 6162 656c   loc_dot - label
+000a07f0: 5f73 7461 7274 3b0a 2020 2020 7369 7a65  _start;.    size
+000a0800: 5f74 206c 6162 656c 5f73 697a 655f 7769  _t label_size_wi
+000a0810: 7468 5f64 6f74 203d 2069 735f 6c61 7374  th_dot = is_last
+000a0820: 5f6c 6162 656c 203f 206c 6162 656c 5f73  _label ? label_s
+000a0830: 697a 6520 3a20 6c61 6265 6c5f 7369 7a65  ize : label_size
+000a0840: 202b 2031 3b0a 2020 2020 7374 643a 3a73   + 1;.    std::s
+000a0850: 7472 696e 675f 7669 6577 206c 6162 656c  tring_view label
+000a0860: 5f76 6965 7728 6d61 7070 6564 5f73 7472  _view(mapped_str
+000a0870: 696e 672e 6461 7461 2829 202b 206c 6162  ing.data() + lab
+000a0880: 656c 5f73 7461 7274 2c20 6c61 6265 6c5f  el_start, label_
+000a0890: 7369 7a65 293b 0a20 2020 206c 6162 656c  size);.    label
+000a08a0: 5f73 7461 7274 202b 3d20 6c61 6265 6c5f  _start += label_
+000a08b0: 7369 7a65 5f77 6974 685f 646f 743b 0a20  size_with_dot;. 
+000a08c0: 2020 2069 6620 286c 6162 656c 5f73 697a     if (label_siz
+000a08d0: 6520 3d3d 2030 2920 7b0a 2020 2020 2020  e == 0) {.      
+000a08e0: 2f2f 2065 6d70 7479 206c 6162 656c 3f20  // empty label? 
+000a08f0: 4e6f 7468 696e 6720 746f 2064 6f2e 0a20  Nothing to do.. 
+000a0900: 2020 207d 2065 6c73 6520 6966 2028 6265     } else if (be
+000a0910: 6769 6e73 5f77 6974 6828 6c61 6265 6c5f  gins_with(label_
+000a0920: 7669 6577 2c20 2278 6e2d 2d22 2929 207b  view, "xn--")) {
+000a0930: 0a20 2020 2020 202f 2f20 5468 6520 786e  .      // The xn
+000a0940: 2d2d 2070 6172 7420 6973 2074 6865 2065  -- part is the e
+000a0950: 7870 656e 7369 7665 2067 616d 652e 0a20  xpensive game.. 
+000a0960: 2020 2020 206f 7574 2e61 7070 656e 6428       out.append(
+000a0970: 6c61 6265 6c5f 7669 6577 293b 0a20 2020  label_view);.   
+000a0980: 2020 2073 7464 3a3a 7374 7269 6e67 5f76     std::string_v
+000a0990: 6965 7720 7075 6e79 5f73 6567 6d65 6e74  iew puny_segment
+000a09a0: 5f61 7363 6969 280a 2020 2020 2020 2020  _ascii(.        
+000a09b0: 2020 6f75 742e 6461 7461 2829 202b 206f    out.data() + o
+000a09c0: 7574 2e73 697a 6528 2920 2d20 6c61 6265  ut.size() - labe
+000a09d0: 6c5f 7669 6577 2e73 697a 6528 2920 2b20  l_view.size() + 
+000a09e0: 342c 0a20 2020 2020 2020 2020 206c 6162  4,.          lab
+000a09f0: 656c 5f76 6965 772e 7369 7a65 2829 202d  el_view.size() -
+000a0a00: 2034 293b 0a20 2020 2020 2073 7464 3a3a   4);.      std::
+000a0a10: 7533 3273 7472 696e 6720 746d 705f 6275  u32string tmp_bu
+000a0a20: 6666 6572 3b0a 2020 2020 2020 626f 6f6c  ffer;.      bool
+000a0a30: 2069 735f 6f6b 203d 2061 6461 3a3a 6964   is_ok = ada::id
+000a0a40: 6e61 3a3a 7075 6e79 636f 6465 5f74 6f5f  na::punycode_to_
+000a0a50: 7574 6633 3228 7075 6e79 5f73 6567 6d65  utf32(puny_segme
+000a0a60: 6e74 5f61 7363 6969 2c20 746d 705f 6275  nt_ascii, tmp_bu
+000a0a70: 6666 6572 293b 0a20 2020 2020 2069 6620  ffer);.      if 
+000a0a80: 2821 6973 5f6f 6b29 207b 0a20 2020 2020  (!is_ok) {.     
+000a0a90: 2020 2072 6574 7572 6e20 6572 726f 723b     return error;
+000a0aa0: 0a20 2020 2020 207d 0a20 2020 2020 2073  .      }.      s
+000a0ab0: 7464 3a3a 7533 3273 7472 696e 6720 706f  td::u32string po
+000a0ac0: 7374 5f6d 6170 203d 2061 6461 3a3a 6964  st_map = ada::id
+000a0ad0: 6e61 3a3a 6d61 7028 746d 705f 6275 6666  na::map(tmp_buff
+000a0ae0: 6572 293b 0a20 2020 2020 2069 6620 2874  er);.      if (t
+000a0af0: 6d70 5f62 7566 6665 7220 213d 2070 6f73  mp_buffer != pos
+000a0b00: 745f 6d61 7029 207b 0a20 2020 2020 2020  t_map) {.       
+000a0b10: 2072 6574 7572 6e20 6572 726f 723b 0a20   return error;. 
+000a0b20: 2020 2020 207d 0a20 2020 2020 2073 7464       }.      std
+000a0b30: 3a3a 7533 3273 7472 696e 6720 7072 655f  ::u32string pre_
+000a0b40: 6e6f 726d 616c 203d 2070 6f73 745f 6d61  normal = post_ma
+000a0b50: 703b 0a20 2020 2020 206e 6f72 6d61 6c69  p;.      normali
+000a0b60: 7a65 2870 6f73 745f 6d61 7029 3b0a 2020  ze(post_map);.  
+000a0b70: 2020 2020 6966 2028 706f 7374 5f6d 6170      if (post_map
+000a0b80: 2021 3d20 7072 655f 6e6f 726d 616c 2920   != pre_normal) 
+000a0b90: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+000a0ba0: 2065 7272 6f72 3b0a 2020 2020 2020 7d0a   error;.      }.
+000a0bb0: 2020 2020 2020 6966 2028 706f 7374 5f6d        if (post_m
+000a0bc0: 6170 2e65 6d70 7479 2829 2920 7b0a 2020  ap.empty()) {.  
+000a0bd0: 2020 2020 2020 7265 7475 726e 2065 7272        return err
+000a0be0: 6f72 3b0a 2020 2020 2020 7d0a 2020 2020  or;.      }.    
+000a0bf0: 2020 6966 2028 2169 735f 6c61 6265 6c5f    if (!is_label_
+000a0c00: 7661 6c69 6428 706f 7374 5f6d 6170 2929  valid(post_map))
+000a0c10: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+000a0c20: 6e20 6572 726f 723b 0a20 2020 2020 207d  n error;.      }
+000a0c30: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
+000a0c40: 2020 2020 6f75 742e 6170 7065 6e64 286c      out.append(l
+000a0c50: 6162 656c 5f76 6965 7729 3b0a 2020 2020  abel_view);.    
+000a0c60: 7d0a 2020 2020 6966 2028 2169 735f 6c61  }.    if (!is_la
+000a0c70: 7374 5f6c 6162 656c 2920 7b0a 2020 2020  st_label) {.    
+000a0c80: 2020 6f75 742e 7075 7368 5f62 6163 6b28    out.push_back(
+000a0c90: 272e 2729 3b0a 2020 2020 7d0a 2020 7d0a  '.');.    }.  }.
+000a0ca0: 2020 7265 7475 726e 206f 7574 3b0a 7d0a    return out;.}.
+000a0cb0: 0a2f 2f20 5765 2072 6574 7572 6e20 2222  .// We return ""
+000a0cc0: 206f 6e20 6572 726f 722e 0a73 7464 3a3a   on error..std::
+000a0cd0: 7374 7269 6e67 2074 6f5f 6173 6369 6928  string to_ascii(
+000a0ce0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000a0cf0: 2075 7438 5f73 7472 696e 6729 207b 0a20   ut8_string) {. 
+000a0d00: 2069 6620 2869 735f 6173 6369 6928 7574   if (is_ascii(ut
+000a0d10: 385f 7374 7269 6e67 2929 207b 0a20 2020  8_string)) {.   
+000a0d20: 2072 6574 7572 6e20 6672 6f6d 5f61 7363   return from_asc
+000a0d30: 6969 5f74 6f5f 6173 6369 6928 7574 385f  ii_to_ascii(ut8_
+000a0d40: 7374 7269 6e67 293b 0a20 207d 0a20 2073  string);.  }.  s
+000a0d50: 7461 7469 6320 636f 6e73 7420 7374 643a  tatic const std:
+000a0d60: 3a73 7472 696e 6720 6572 726f 7220 3d20  :string error = 
+000a0d70: 2222 3b0a 2020 2f2f 2057 6520 636f 6e76  "";.  // We conv
+000a0d80: 6572 7420 746f 2055 5446 2d33 320a 2020  ert to UTF-32.  
+000a0d90: 7369 7a65 5f74 2075 7466 3332 5f6c 656e  size_t utf32_len
+000a0da0: 6774 6820 3d0a 2020 2020 2020 6164 613a  gth =.      ada:
+000a0db0: 3a69 646e 613a 3a75 7466 3332 5f6c 656e  :idna::utf32_len
+000a0dc0: 6774 685f 6672 6f6d 5f75 7466 3828 7574  gth_from_utf8(ut
+000a0dd0: 385f 7374 7269 6e67 2e64 6174 6128 292c  8_string.data(),
+000a0de0: 2075 7438 5f73 7472 696e 672e 7369 7a65   ut8_string.size
+000a0df0: 2829 293b 0a20 2073 7464 3a3a 7533 3273  ());.  std::u32s
+000a0e00: 7472 696e 6720 7574 6633 3228 7574 6633  tring utf32(utf3
+000a0e10: 325f 6c65 6e67 7468 2c20 275c 3027 293b  2_length, '\0');
+000a0e20: 0a20 2073 697a 655f 7420 6163 7475 616c  .  size_t actual
+000a0e30: 5f75 7466 3332 5f6c 656e 6774 6820 3d20  _utf32_length = 
+000a0e40: 6164 613a 3a69 646e 613a 3a75 7466 385f  ada::idna::utf8_
+000a0e50: 746f 5f75 7466 3332 280a 2020 2020 2020  to_utf32(.      
+000a0e60: 7574 385f 7374 7269 6e67 2e64 6174 6128  ut8_string.data(
+000a0e70: 292c 2075 7438 5f73 7472 696e 672e 7369  ), ut8_string.si
+000a0e80: 7a65 2829 2c20 7574 6633 322e 6461 7461  ze(), utf32.data
+000a0e90: 2829 293b 0a20 2069 6620 2861 6374 7561  ());.  if (actua
+000a0ea0: 6c5f 7574 6633 325f 6c65 6e67 7468 203d  l_utf32_length =
+000a0eb0: 3d20 3029 207b 0a20 2020 2072 6574 7572  = 0) {.    retur
+000a0ec0: 6e20 6572 726f 723b 0a20 207d 0a20 202f  n error;.  }.  /
+000a0ed0: 2f20 6d61 7070 696e 670a 2020 7574 6633  / mapping.  utf3
+000a0ee0: 3220 3d20 6164 613a 3a69 646e 613a 3a6d  2 = ada::idna::m
+000a0ef0: 6170 2875 7466 3332 293b 0a20 206e 6f72  ap(utf32);.  nor
+000a0f00: 6d61 6c69 7a65 2875 7466 3332 293b 0a20  malize(utf32);. 
+000a0f10: 2073 7464 3a3a 7374 7269 6e67 206f 7574   std::string out
+000a0f20: 3b0a 2020 7369 7a65 5f74 206c 6162 656c  ;.  size_t label
+000a0f30: 5f73 7461 7274 203d 2030 3b0a 0a20 2077  _start = 0;..  w
+000a0f40: 6869 6c65 2028 6c61 6265 6c5f 7374 6172  hile (label_star
+000a0f50: 7420 213d 2075 7466 3332 2e73 697a 6528  t != utf32.size(
+000a0f60: 2929 207b 0a20 2020 2073 697a 655f 7420  )) {.    size_t 
+000a0f70: 6c6f 635f 646f 7420 3d20 7574 6633 322e  loc_dot = utf32.
+000a0f80: 6669 6e64 2827 2e27 2c20 6c61 6265 6c5f  find('.', label_
+000a0f90: 7374 6172 7429 3b0a 2020 2020 626f 6f6c  start);.    bool
+000a0fa0: 2069 735f 6c61 7374 5f6c 6162 656c 203d   is_last_label =
+000a0fb0: 2028 6c6f 635f 646f 7420 3d3d 2073 7464   (loc_dot == std
+000a0fc0: 3a3a 7374 7269 6e67 5f76 6965 773a 3a6e  ::string_view::n
+000a0fd0: 706f 7329 3b0a 2020 2020 7369 7a65 5f74  pos);.    size_t
+000a0fe0: 206c 6162 656c 5f73 697a 6520 3d0a 2020   label_size =.  
+000a0ff0: 2020 2020 2020 6973 5f6c 6173 745f 6c61        is_last_la
+000a1000: 6265 6c20 3f20 7574 6633 322e 7369 7a65  bel ? utf32.size
+000a1010: 2829 202d 206c 6162 656c 5f73 7461 7274  () - label_start
+000a1020: 203a 206c 6f63 5f64 6f74 202d 206c 6162   : loc_dot - lab
+000a1030: 656c 5f73 7461 7274 3b0a 2020 2020 7369  el_start;.    si
+000a1040: 7a65 5f74 206c 6162 656c 5f73 697a 655f  ze_t label_size_
+000a1050: 7769 7468 5f64 6f74 203d 2069 735f 6c61  with_dot = is_la
+000a1060: 7374 5f6c 6162 656c 203f 206c 6162 656c  st_label ? label
+000a1070: 5f73 697a 6520 3a20 6c61 6265 6c5f 7369  _size : label_si
+000a1080: 7a65 202b 2031 3b0a 2020 2020 7374 643a  ze + 1;.    std:
+000a1090: 3a75 3332 7374 7269 6e67 5f76 6965 7720  :u32string_view 
+000a10a0: 6c61 6265 6c5f 7669 6577 2875 7466 3332  label_view(utf32
+000a10b0: 2e64 6174 6128 2920 2b20 6c61 6265 6c5f  .data() + label_
+000a10c0: 7374 6172 742c 206c 6162 656c 5f73 697a  start, label_siz
+000a10d0: 6529 3b0a 2020 2020 6c61 6265 6c5f 7374  e);.    label_st
+000a10e0: 6172 7420 2b3d 206c 6162 656c 5f73 697a  art += label_siz
+000a10f0: 655f 7769 7468 5f64 6f74 3b0a 2020 2020  e_with_dot;.    
+000a1100: 6966 2028 6c61 6265 6c5f 7369 7a65 203d  if (label_size =
+000a1110: 3d20 3029 207b 0a20 2020 2020 202f 2f20  = 0) {.      // 
+000a1120: 656d 7074 7920 6c61 6265 6c3f 204e 6f74  empty label? Not
+000a1130: 6869 6e67 2074 6f20 646f 2e0a 2020 2020  hing to do..    
+000a1140: 7d20 656c 7365 2069 6620 2862 6567 696e  } else if (begin
+000a1150: 735f 7769 7468 286c 6162 656c 5f76 6965  s_with(label_vie
+000a1160: 772c 2055 2278 6e2d 2d22 2929 207b 0a20  w, U"xn--")) {. 
+000a1170: 2020 2020 202f 2f20 7765 2064 6f20 6e6f       // we do no
+000a1180: 7420 6e65 6564 2074 6f20 6368 6563 6b2c  t need to check,
+000a1190: 2065 2e67 2e2c 2058 6e2d 2d20 6265 6361   e.g., Xn-- beca
+000a11a0: 7573 6520 6d61 7070 696e 6720 676f 6573  use mapping goes
+000a11b0: 2074 6f20 6c6f 7765 7220 6361 7365 0a20   to lower case. 
+000a11c0: 2020 2020 2066 6f72 2028 6368 6172 3332       for (char32
+000a11d0: 5f74 2063 203a 206c 6162 656c 5f76 6965  _t c : label_vie
+000a11e0: 7729 207b 0a20 2020 2020 2020 2069 6620  w) {.        if 
+000a11f0: 2863 203e 3d20 3078 3830 2920 7b0a 2020  (c >= 0x80) {.  
+000a1200: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+000a1210: 7272 6f72 3b0a 2020 2020 2020 2020 7d0a  rror;.        }.
+000a1220: 2020 2020 2020 2020 6f75 7420 2b3d 2028          out += (
+000a1230: 756e 7369 676e 6564 2063 6861 7229 2863  unsigned char)(c
+000a1240: 293b 0a20 2020 2020 207d 0a20 2020 2020  );.      }.     
+000a1250: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000a1260: 7720 7075 6e79 5f73 6567 6d65 6e74 5f61  w puny_segment_a
+000a1270: 7363 6969 280a 2020 2020 2020 2020 2020  scii(.          
+000a1280: 6f75 742e 6461 7461 2829 202b 206f 7574  out.data() + out
+000a1290: 2e73 697a 6528 2920 2d20 6c61 6265 6c5f  .size() - label_
+000a12a0: 7669 6577 2e73 697a 6528 2920 2b20 342c  view.size() + 4,
+000a12b0: 0a20 2020 2020 2020 2020 206c 6162 656c  .          label
+000a12c0: 5f76 6965 772e 7369 7a65 2829 202d 2034  _view.size() - 4
+000a12d0: 293b 0a20 2020 2020 2073 7464 3a3a 7533  );.      std::u3
+000a12e0: 3273 7472 696e 6720 746d 705f 6275 6666  2string tmp_buff
+000a12f0: 6572 3b0a 2020 2020 2020 626f 6f6c 2069  er;.      bool i
+000a1300: 735f 6f6b 203d 2061 6461 3a3a 6964 6e61  s_ok = ada::idna
+000a1310: 3a3a 7075 6e79 636f 6465 5f74 6f5f 7574  ::punycode_to_ut
+000a1320: 6633 3228 7075 6e79 5f73 6567 6d65 6e74  f32(puny_segment
+000a1330: 5f61 7363 6969 2c20 746d 705f 6275 6666  _ascii, tmp_buff
+000a1340: 6572 293b 0a20 2020 2020 2069 6620 2821  er);.      if (!
+000a1350: 6973 5f6f 6b29 207b 0a20 2020 2020 2020  is_ok) {.       
+000a1360: 2072 6574 7572 6e20 6572 726f 723b 0a20   return error;. 
+000a1370: 2020 2020 207d 0a20 2020 2020 2073 7464       }.      std
+000a1380: 3a3a 7533 3273 7472 696e 6720 706f 7374  ::u32string post
+000a1390: 5f6d 6170 203d 2061 6461 3a3a 6964 6e61  _map = ada::idna
+000a13a0: 3a3a 6d61 7028 746d 705f 6275 6666 6572  ::map(tmp_buffer
+000a13b0: 293b 0a20 2020 2020 2069 6620 2874 6d70  );.      if (tmp
+000a13c0: 5f62 7566 6665 7220 213d 2070 6f73 745f  _buffer != post_
+000a13d0: 6d61 7029 207b 0a20 2020 2020 2020 2072  map) {.        r
+000a13e0: 6574 7572 6e20 6572 726f 723b 0a20 2020  eturn error;.   
+000a13f0: 2020 207d 0a20 2020 2020 2073 7464 3a3a     }.      std::
+000a1400: 7533 3273 7472 696e 6720 7072 655f 6e6f  u32string pre_no
+000a1410: 726d 616c 203d 2070 6f73 745f 6d61 703b  rmal = post_map;
+000a1420: 0a20 2020 2020 206e 6f72 6d61 6c69 7a65  .      normalize
+000a1430: 2870 6f73 745f 6d61 7029 3b0a 2020 2020  (post_map);.    
+000a1440: 2020 6966 2028 706f 7374 5f6d 6170 2021    if (post_map !
+000a1450: 3d20 7072 655f 6e6f 726d 616c 2920 7b0a  = pre_normal) {.
+000a1460: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+000a1470: 7272 6f72 3b0a 2020 2020 2020 7d0a 2020  rror;.      }.  
+000a1480: 2020 2020 6966 2028 706f 7374 5f6d 6170      if (post_map
+000a1490: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000a14a0: 2020 2020 7265 7475 726e 2065 7272 6f72      return error
+000a14b0: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
+000a14c0: 6966 2028 2169 735f 6c61 6265 6c5f 7661  if (!is_label_va
+000a14d0: 6c69 6428 706f 7374 5f6d 6170 2929 207b  lid(post_map)) {
+000a14e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000a14f0: 6572 726f 723b 0a20 2020 2020 207d 0a20  error;.      }. 
+000a1500: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+000a1510: 2020 2f2f 2054 6865 2066 6173 7420 7061    // The fast pa
+000a1520: 7468 2068 6572 6520 6973 2061 6e20 6173  th here is an as
+000a1530: 6369 6920 6c61 6265 6c2e 0a20 2020 2020  cii label..     
+000a1540: 2069 6620 2869 735f 6173 6369 6928 6c61   if (is_ascii(la
+000a1550: 6265 6c5f 7669 6577 2929 207b 0a20 2020  bel_view)) {.   
+000a1560: 2020 2020 202f 2f20 6e6f 2076 616c 6964       // no valid
+000a1570: 6174 696f 6e20 6e65 6564 6564 2e0a 2020  ation needed..  
+000a1580: 2020 2020 2020 666f 7220 2863 6861 7233        for (char3
+000a1590: 325f 7420 6320 3a20 6c61 6265 6c5f 7669  2_t c : label_vi
+000a15a0: 6577 2920 7b0a 2020 2020 2020 2020 2020  ew) {.          
+000a15b0: 6f75 7420 2b3d 2028 756e 7369 676e 6564  out += (unsigned
+000a15c0: 2063 6861 7229 2863 293b 0a20 2020 2020   char)(c);.     
+000a15d0: 2020 207d 0a20 2020 2020 207d 2065 6c73     }.      } els
+000a15e0: 6520 7b0a 2020 2020 2020 2020 2f2f 2073  e {.        // s
+000a15f0: 6c6f 7720 7061 7468 2e0a 2020 2020 2020  low path..      
+000a1600: 2020 2f2f 2066 6972 7374 2063 6865 636b    // first check
+000a1610: 2076 616c 6964 6974 792e 0a20 2020 2020   validity..     
+000a1620: 2020 2069 6620 2821 6973 5f6c 6162 656c     if (!is_label
+000a1630: 5f76 616c 6964 286c 6162 656c 5f76 6965  _valid(label_vie
+000a1640: 7729 2920 7b0a 2020 2020 2020 2020 2020  w)) {.          
+000a1650: 7265 7475 726e 2065 7272 6f72 3b0a 2020  return error;.  
+000a1660: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000a1670: 2f2f 2049 7420 6973 2076 616c 6964 2120  // It is valid! 
+000a1680: 536f 206e 6f77 2077 6520 6d75 7374 2065  So now we must e
+000a1690: 6e63 6f64 6520 6974 2061 7320 7075 6e79  ncode it as puny
+000a16a0: 636f 6465 2e2e 2e0a 2020 2020 2020 2020  code....        
+000a16b0: 6f75 742e 6170 7065 6e64 2822 786e 2d2d  out.append("xn--
+000a16c0: 2229 3b0a 2020 2020 2020 2020 626f 6f6c  ");.        bool
+000a16d0: 2069 735f 6f6b 203d 2061 6461 3a3a 6964   is_ok = ada::id
+000a16e0: 6e61 3a3a 7574 6633 325f 746f 5f70 756e  na::utf32_to_pun
+000a16f0: 7963 6f64 6528 6c61 6265 6c5f 7669 6577  ycode(label_view
+000a1700: 2c20 6f75 7429 3b0a 2020 2020 2020 2020  , out);.        
+000a1710: 6966 2028 2169 735f 6f6b 2920 7b0a 2020  if (!is_ok) {.  
+000a1720: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+000a1730: 7272 6f72 3b0a 2020 2020 2020 2020 7d0a  rror;.        }.
+000a1740: 2020 2020 2020 7d0a 2020 2020 7d0a 2020        }.    }.  
+000a1750: 2020 6966 2028 2169 735f 6c61 7374 5f6c    if (!is_last_l
+000a1760: 6162 656c 2920 7b0a 2020 2020 2020 6f75  abel) {.      ou
+000a1770: 742e 7075 7368 5f62 6163 6b28 272e 2729  t.push_back('.')
+000a1780: 3b0a 2020 2020 7d0a 2020 7d0a 2020 7265  ;.    }.  }.  re
+000a1790: 7475 726e 206f 7574 3b0a 7d0a 7d20 202f  turn out;.}.}  /
+000a17a0: 2f20 6e61 6d65 7370 6163 6520 6164 613a  / namespace ada:
+000a17b0: 3a69 646e 610a 2f2a 2065 6e64 2066 696c  :idna./* end fil
+000a17c0: 6520 7372 632f 746f 5f61 7363 6969 2e63  e src/to_ascii.c
+000a17d0: 7070 202a 2f0a 2f2a 2062 6567 696e 2066  pp */./* begin f
+000a17e0: 696c 6520 7372 632f 746f 5f75 6e69 636f  ile src/to_unico
+000a17f0: 6465 2e63 7070 202a 2f0a 0a23 696e 636c  de.cpp */..#incl
+000a1800: 7564 6520 3c61 6c67 6f72 6974 686d 3e0a  ude <algorithm>.
+000a1810: 2369 6e63 6c75 6465 203c 7374 7269 6e67  #include <string
+000a1820: 3e0a 0a0a 6e61 6d65 7370 6163 6520 6164  >...namespace ad
+000a1830: 613a 3a69 646e 6120 7b0a 7374 643a 3a73  a::idna {.std::s
+000a1840: 7472 696e 6720 746f 5f75 6e69 636f 6465  tring to_unicode
+000a1850: 2873 7464 3a3a 7374 7269 6e67 5f76 6965  (std::string_vie
+000a1860: 7720 696e 7075 7429 207b 0a20 2073 7464  w input) {.  std
+000a1870: 3a3a 7374 7269 6e67 206f 7574 7075 743b  ::string output;
+000a1880: 0a20 206f 7574 7075 742e 7265 7365 7276  .  output.reserv
+000a1890: 6528 696e 7075 742e 7369 7a65 2829 293b  e(input.size());
+000a18a0: 0a0a 2020 7369 7a65 5f74 206c 6162 656c  ..  size_t label
+000a18b0: 5f73 7461 7274 203d 2030 3b0a 2020 7768  _start = 0;.  wh
+000a18c0: 696c 6520 286c 6162 656c 5f73 7461 7274  ile (label_start
+000a18d0: 203c 2069 6e70 7574 2e73 697a 6528 2929   < input.size())
+000a18e0: 207b 0a20 2020 2073 697a 655f 7420 6c6f   {.    size_t lo
+000a18f0: 635f 646f 7420 3d20 696e 7075 742e 6669  c_dot = input.fi
+000a1900: 6e64 2827 2e27 2c20 6c61 6265 6c5f 7374  nd('.', label_st
+000a1910: 6172 7429 3b0a 2020 2020 626f 6f6c 2069  art);.    bool i
+000a1920: 735f 6c61 7374 5f6c 6162 656c 203d 2028  s_last_label = (
+000a1930: 6c6f 635f 646f 7420 3d3d 2073 7464 3a3a  loc_dot == std::
+000a1940: 7374 7269 6e67 5f76 6965 773a 3a6e 706f  string_view::npo
+000a1950: 7329 3b0a 2020 2020 7369 7a65 5f74 206c  s);.    size_t l
+000a1960: 6162 656c 5f73 697a 6520 3d0a 2020 2020  abel_size =.    
+000a1970: 2020 2020 6973 5f6c 6173 745f 6c61 6265      is_last_labe
+000a1980: 6c20 3f20 696e 7075 742e 7369 7a65 2829  l ? input.size()
+000a1990: 202d 206c 6162 656c 5f73 7461 7274 203a   - label_start :
+000a19a0: 206c 6f63 5f64 6f74 202d 206c 6162 656c   loc_dot - label
+000a19b0: 5f73 7461 7274 3b0a 2020 2020 6175 746f  _start;.    auto
+000a19c0: 206c 6162 656c 5f76 6965 7720 3d20 7374   label_view = st
+000a19d0: 643a 3a73 7472 696e 675f 7669 6577 2869  d::string_view(i
+000a19e0: 6e70 7574 2e64 6174 6128 2920 2b20 6c61  nput.data() + la
+000a19f0: 6265 6c5f 7374 6172 742c 206c 6162 656c  bel_start, label
+000a1a00: 5f73 697a 6529 3b0a 0a20 2020 2069 6620  _size);..    if 
+000a1a10: 2861 6461 3a3a 6964 6e61 3a3a 6265 6769  (ada::idna::begi
+000a1a20: 6e73 5f77 6974 6828 6c61 6265 6c5f 7669  ns_with(label_vi
+000a1a30: 6577 2c20 2278 6e2d 2d22 2920 2626 0a20  ew, "xn--") &&. 
+000a1a40: 2020 2020 2020 2061 6461 3a3a 6964 6e61         ada::idna
+000a1a50: 3a3a 6973 5f61 7363 6969 286c 6162 656c  ::is_ascii(label
+000a1a60: 5f76 6965 7729 2920 7b0a 2020 2020 2020  _view)) {.      
+000a1a70: 6c61 6265 6c5f 7669 6577 2e72 656d 6f76  label_view.remov
+000a1a80: 655f 7072 6566 6978 2834 293b 0a20 2020  e_prefix(4);.   
+000a1a90: 2020 2069 6620 2861 6461 3a3a 6964 6e61     if (ada::idna
+000a1aa0: 3a3a 7665 7269 6679 5f70 756e 7963 6f64  ::verify_punycod
+000a1ab0: 6528 6c61 6265 6c5f 7669 6577 2929 207b  e(label_view)) {
+000a1ac0: 0a20 2020 2020 2020 2073 7464 3a3a 7533  .        std::u3
+000a1ad0: 3273 7472 696e 6720 746d 705f 6275 6666  2string tmp_buff
+000a1ae0: 6572 3b0a 2020 2020 2020 2020 6966 2028  er;.        if (
+000a1af0: 6164 613a 3a69 646e 613a 3a70 756e 7963  ada::idna::punyc
+000a1b00: 6f64 655f 746f 5f75 7466 3332 286c 6162  ode_to_utf32(lab
+000a1b10: 656c 5f76 6965 772c 2074 6d70 5f62 7566  el_view, tmp_buf
+000a1b20: 6665 7229 2920 7b0a 2020 2020 2020 2020  fer)) {.        
+000a1b30: 2020 6175 746f 2075 7466 385f 7369 7a65    auto utf8_size
+000a1b40: 203d 2061 6461 3a3a 6964 6e61 3a3a 7574   = ada::idna::ut
+000a1b50: 6638 5f6c 656e 6774 685f 6672 6f6d 5f75  f8_length_from_u
+000a1b60: 7466 3332 2874 6d70 5f62 7566 6665 722e  tf32(tmp_buffer.
+000a1b70: 6461 7461 2829 2c0a 2020 2020 2020 2020  data(),.        
 000a1b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a1b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a1ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a1bb0: 2020 2020 2020 746d 705f 6275 6666 6572        tmp_buffer
-000a1bc0: 2e73 697a 6528 2929 3b0a 2020 2020 2020  .size());.      
-000a1bd0: 2020 2020 7374 643a 3a73 7472 696e 6720      std::string 
-000a1be0: 6669 6e61 6c5f 7574 6638 2875 7466 385f  final_utf8(utf8_
-000a1bf0: 7369 7a65 2c20 275c 3027 293b 0a20 2020  size, '\0');.   
-000a1c00: 2020 2020 2020 2061 6461 3a3a 6964 6e61         ada::idna
-000a1c10: 3a3a 7574 6633 325f 746f 5f75 7466 3828  ::utf32_to_utf8(
-000a1c20: 746d 705f 6275 6666 6572 2e64 6174 6128  tmp_buffer.data(
-000a1c30: 292c 2074 6d70 5f62 7566 6665 722e 7369  ), tmp_buffer.si
-000a1c40: 7a65 2829 2c0a 2020 2020 2020 2020 2020  ze(),.          
+000a1bb0: 2020 2020 2074 6d70 5f62 7566 6665 722e       tmp_buffer.
+000a1bc0: 7369 7a65 2829 293b 0a20 2020 2020 2020  size());.       
+000a1bd0: 2020 2073 7464 3a3a 7374 7269 6e67 2066     std::string f
+000a1be0: 696e 616c 5f75 7466 3828 7574 6638 5f73  inal_utf8(utf8_s
+000a1bf0: 697a 652c 2027 5c30 2729 3b0a 2020 2020  ize, '\0');.    
+000a1c00: 2020 2020 2020 6164 613a 3a69 646e 613a        ada::idna:
+000a1c10: 3a75 7466 3332 5f74 6f5f 7574 6638 2874  :utf32_to_utf8(t
+000a1c20: 6d70 5f62 7566 6665 722e 6461 7461 2829  mp_buffer.data()
+000a1c30: 2c20 746d 705f 6275 6666 6572 2e73 697a  , tmp_buffer.siz
+000a1c40: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
 000a1c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a1c60: 2020 2020 2020 2020 2066 696e 616c 5f75           final_u
-000a1c70: 7466 382e 6461 7461 2829 293b 0a20 2020  tf8.data());.   
-000a1c80: 2020 2020 2020 206f 7574 7075 742e 6170         output.ap
-000a1c90: 7065 6e64 2866 696e 616c 5f75 7466 3829  pend(final_utf8)
-000a1ca0: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
-000a1cb0: 207b 0a20 2020 2020 2020 2020 202f 2f20   {.          // 
-000a1cc0: 546f 556e 6963 6f64 6520 6e65 7665 7220  ToUnicode never 
-000a1cd0: 6661 696c 732e 2020 4966 2061 6e79 2073  fails.  If any s
-000a1ce0: 7465 7020 6661 696c 732c 2074 6865 6e20  tep fails, then 
-000a1cf0: 7468 6520 6f72 6967 696e 616c 2069 6e70  the original inp
-000a1d00: 7574 0a20 2020 2020 2020 2020 202f 2f20  ut.          // 
-000a1d10: 7365 7175 656e 6365 2069 7320 7265 7475  sequence is retu
-000a1d20: 726e 6564 2069 6d6d 6564 6961 7465 6c79  rned immediately
-000a1d30: 2069 6e20 7468 6174 2073 7465 702e 0a20   in that step.. 
-000a1d40: 2020 2020 2020 2020 206f 7574 7075 742e           output.
-000a1d50: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-000a1d60: 2020 2020 2020 7374 643a 3a73 7472 696e        std::strin
-000a1d70: 675f 7669 6577 2869 6e70 7574 2e64 6174  g_view(input.dat
-000a1d80: 6128 2920 2b20 6c61 6265 6c5f 7374 6172  a() + label_star
-000a1d90: 742c 206c 6162 656c 5f73 697a 6529 293b  t, label_size));
-000a1da0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-000a1db0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-000a1dc0: 2020 6f75 7470 7574 2e61 7070 656e 6428    output.append(
-000a1dd0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000a1de0: 2869 6e70 7574 2e64 6174 6128 2920 2b20  (input.data() + 
-000a1df0: 6c61 6265 6c5f 7374 6172 742c 206c 6162  label_start, lab
-000a1e00: 656c 5f73 697a 6529 293b 0a20 2020 2020  el_size));.     
-000a1e10: 207d 0a20 2020 207d 2065 6c73 6520 7b0a   }.    } else {.
-000a1e20: 2020 2020 2020 6f75 7470 7574 2e61 7070        output.app
-000a1e30: 656e 6428 6c61 6265 6c5f 7669 6577 293b  end(label_view);
-000a1e40: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-000a1e50: 2169 735f 6c61 7374 5f6c 6162 656c 2920  !is_last_label) 
-000a1e60: 7b0a 2020 2020 2020 6f75 7470 7574 2e70  {.      output.p
-000a1e70: 7573 685f 6261 636b 2827 2e27 293b 0a20  ush_back('.');. 
-000a1e80: 2020 207d 0a0a 2020 2020 6c61 6265 6c5f     }..    label_
-000a1e90: 7374 6172 7420 2b3d 206c 6162 656c 5f73  start += label_s
-000a1ea0: 697a 6520 2b20 313b 0a20 207d 0a0a 2020  ize + 1;.  }..  
-000a1eb0: 7265 7475 726e 206f 7574 7075 743b 0a7d  return output;.}
-000a1ec0: 0a7d 2020 2f2f 206e 616d 6573 7061 6365  .}  // namespace
-000a1ed0: 2061 6461 3a3a 6964 6e61 0a2f 2a20 656e   ada::idna./* en
-000a1ee0: 6420 6669 6c65 2073 7263 2f74 6f5f 756e  d file src/to_un
-000a1ef0: 6963 6f64 652e 6370 7020 2a2f 0a2f 2a20  icode.cpp */./* 
-000a1f00: 656e 6420 6669 6c65 2073 7263 2f69 646e  end file src/idn
-000a1f10: 612e 6370 7020 2a2f 0a2f 2a20 656e 6420  a.cpp */./* end 
-000a1f20: 6669 6c65 2073 7263 2f61 6461 5f69 646e  file src/ada_idn
-000a1f30: 612e 6370 7020 2a2f 0a41 4441 5f50 4f50  a.cpp */.ADA_POP
-000a1f40: 5f44 4953 4142 4c45 5f57 4152 4e49 4e47  _DISABLE_WARNING
-000a1f50: 530a 0a23 696e 636c 7564 6520 3c61 6c67  S..#include <alg
-000a1f60: 6f72 6974 686d 3e0a 2369 6620 4144 415f  orithm>.#if ADA_
-000a1f70: 4e45 4f4e 0a23 696e 636c 7564 6520 3c61  NEON.#include <a
-000a1f80: 726d 5f6e 656f 6e2e 683e 0a23 656c 6966  rm_neon.h>.#elif
-000a1f90: 2041 4441 5f53 5345 320a 2369 6e63 6c75   ADA_SSE2.#inclu
-000a1fa0: 6465 203c 656d 6d69 6e74 7269 6e2e 683e  de <emmintrin.h>
-000a1fb0: 0a23 656e 6469 660a 0a6e 616d 6573 7061  .#endif..namespa
-000a1fc0: 6365 2061 6461 3a3a 756e 6963 6f64 6520  ce ada::unicode 
-000a1fd0: 7b0a 0a63 6f6e 7374 6578 7072 2062 6f6f  {..constexpr boo
-000a1fe0: 6c20 746f 5f6c 6f77 6572 5f61 7363 6969  l to_lower_ascii
-000a1ff0: 2863 6861 722a 2069 6e70 7574 2c20 7369  (char* input, si
-000a2000: 7a65 5f74 206c 656e 6774 6829 206e 6f65  ze_t length) noe
-000a2010: 7863 6570 7420 7b0a 2020 6175 746f 2062  xcept {.  auto b
-000a2020: 726f 6164 6361 7374 203d 205b 5d28 7569  roadcast = [](ui
-000a2030: 6e74 385f 7420 7629 202d 3e20 7569 6e74  nt8_t v) -> uint
-000a2040: 3634 5f74 207b 0a20 2020 2072 6574 7572  64_t {.    retur
-000a2050: 6e20 3078 3130 3130 3130 3130 3130 3130  n 0x101010101010
-000a2060: 3130 3175 6c6c 202a 2076 3b0a 2020 7d3b  101ull * v;.  };
-000a2070: 0a20 2075 696e 7436 345f 7420 6272 6f61  .  uint64_t broa
-000a2080: 6463 6173 745f 3830 203d 2062 726f 6164  dcast_80 = broad
-000a2090: 6361 7374 2830 7838 3029 3b0a 2020 7569  cast(0x80);.  ui
-000a20a0: 6e74 3634 5f74 2062 726f 6164 6361 7374  nt64_t broadcast
-000a20b0: 5f41 7020 3d20 6272 6f61 6463 6173 7428  _Ap = broadcast(
-000a20c0: 3132 3820 2d20 2741 2729 3b0a 2020 7569  128 - 'A');.  ui
-000a20d0: 6e74 3634 5f74 2062 726f 6164 6361 7374  nt64_t broadcast
-000a20e0: 5f5a 7020 3d20 6272 6f61 6463 6173 7428  _Zp = broadcast(
-000a20f0: 3132 3820 2d20 275a 2720 2d20 3129 3b0a  128 - 'Z' - 1);.
-000a2100: 2020 7569 6e74 3634 5f74 206e 6f6e 5f61    uint64_t non_a
-000a2110: 7363 6969 203d 2030 3b0a 2020 7369 7a65  scii = 0;.  size
-000a2120: 5f74 2069 203d 2030 3b0a 0a20 2066 6f72  _t i = 0;..  for
-000a2130: 2028 3b20 6920 2b20 3720 3c20 6c65 6e67   (; i + 7 < leng
-000a2140: 7468 3b20 6920 2b3d 2038 2920 7b0a 2020  th; i += 8) {.  
-000a2150: 2020 7569 6e74 3634 5f74 2077 6f72 647b    uint64_t word{
-000a2160: 7d3b 0a20 2020 206d 656d 6370 7928 2677  };.    memcpy(&w
-000a2170: 6f72 642c 2069 6e70 7574 202b 2069 2c20  ord, input + i, 
-000a2180: 7369 7a65 6f66 2877 6f72 6429 293b 0a20  sizeof(word));. 
-000a2190: 2020 206e 6f6e 5f61 7363 6969 207c 3d20     non_ascii |= 
-000a21a0: 2877 6f72 6420 2620 6272 6f61 6463 6173  (word & broadcas
-000a21b0: 745f 3830 293b 0a20 2020 2077 6f72 6420  t_80);.    word 
-000a21c0: 5e3d 0a20 2020 2020 2020 2028 2828 776f  ^=.        (((wo
-000a21d0: 7264 202b 2062 726f 6164 6361 7374 5f41  rd + broadcast_A
-000a21e0: 7029 205e 2028 776f 7264 202b 2062 726f  p) ^ (word + bro
-000a21f0: 6164 6361 7374 5f5a 7029 2920 2620 6272  adcast_Zp)) & br
-000a2200: 6f61 6463 6173 745f 3830 2920 3e3e 2032  oadcast_80) >> 2
-000a2210: 3b0a 2020 2020 6d65 6d63 7079 2869 6e70  ;.    memcpy(inp
-000a2220: 7574 202b 2069 2c20 2677 6f72 642c 2073  ut + i, &word, s
-000a2230: 697a 656f 6628 776f 7264 2929 3b0a 2020  izeof(word));.  
-000a2240: 7d0a 2020 6966 2028 6920 3c20 6c65 6e67  }.  if (i < leng
-000a2250: 7468 2920 7b0a 2020 2020 7569 6e74 3634  th) {.    uint64
-000a2260: 5f74 2077 6f72 647b 7d3b 0a20 2020 206d  _t word{};.    m
-000a2270: 656d 6370 7928 2677 6f72 642c 2069 6e70  emcpy(&word, inp
-000a2280: 7574 202b 2069 2c20 6c65 6e67 7468 202d  ut + i, length -
-000a2290: 2069 293b 0a20 2020 206e 6f6e 5f61 7363   i);.    non_asc
-000a22a0: 6969 207c 3d20 2877 6f72 6420 2620 6272  ii |= (word & br
-000a22b0: 6f61 6463 6173 745f 3830 293b 0a20 2020  oadcast_80);.   
-000a22c0: 2077 6f72 6420 5e3d 0a20 2020 2020 2020   word ^=.       
-000a22d0: 2028 2828 776f 7264 202b 2062 726f 6164   (((word + broad
-000a22e0: 6361 7374 5f41 7029 205e 2028 776f 7264  cast_Ap) ^ (word
-000a22f0: 202b 2062 726f 6164 6361 7374 5f5a 7029   + broadcast_Zp)
-000a2300: 2920 2620 6272 6f61 6463 6173 745f 3830  ) & broadcast_80
-000a2310: 2920 3e3e 2032 3b0a 2020 2020 6d65 6d63  ) >> 2;.    memc
-000a2320: 7079 2869 6e70 7574 202b 2069 2c20 2677  py(input + i, &w
-000a2330: 6f72 642c 206c 656e 6774 6820 2d20 6929  ord, length - i)
-000a2340: 3b0a 2020 7d0a 2020 7265 7475 726e 206e  ;.  }.  return n
-000a2350: 6f6e 5f61 7363 6969 203d 3d20 303b 0a7d  on_ascii == 0;.}
-000a2360: 0a23 6966 2041 4441 5f4e 454f 4e0a 6164  .#if ADA_NEON.ad
-000a2370: 615f 7265 616c 6c79 5f69 6e6c 696e 6520  a_really_inline 
-000a2380: 626f 6f6c 2068 6173 5f74 6162 735f 6f72  bool has_tabs_or
-000a2390: 5f6e 6577 6c69 6e65 280a 2020 2020 7374  _newline(.    st
-000a23a0: 643a 3a73 7472 696e 675f 7669 6577 2075  d::string_view u
-000a23b0: 7365 725f 696e 7075 7429 206e 6f65 7863  ser_input) noexc
-000a23c0: 6570 7420 7b0a 2020 7369 7a65 5f74 2069  ept {.  size_t i
-000a23d0: 203d 2030 3b0a 2020 636f 6e73 7420 7569   = 0;.  const ui
-000a23e0: 6e74 3878 3136 5f74 206d 6173 6b31 203d  nt8x16_t mask1 =
-000a23f0: 2076 6d6f 7671 5f6e 5f75 3828 275c 7227   vmovq_n_u8('\r'
-000a2400: 293b 0a20 2063 6f6e 7374 2075 696e 7438  );.  const uint8
-000a2410: 7831 365f 7420 6d61 736b 3220 3d20 766d  x16_t mask2 = vm
-000a2420: 6f76 715f 6e5f 7538 2827 5c6e 2729 3b0a  ovq_n_u8('\n');.
-000a2430: 2020 636f 6e73 7420 7569 6e74 3878 3136    const uint8x16
-000a2440: 5f74 206d 6173 6b33 203d 2076 6d6f 7671  _t mask3 = vmovq
-000a2450: 5f6e 5f75 3828 275c 7427 293b 0a20 2075  _n_u8('\t');.  u
-000a2460: 696e 7438 7831 365f 7420 7275 6e6e 696e  int8x16_t runnin
-000a2470: 677b 307d 3b0a 2020 666f 7220 283b 2069  g{0};.  for (; i
-000a2480: 202b 2031 3520 3c20 7573 6572 5f69 6e70   + 15 < user_inp
-000a2490: 7574 2e73 697a 6528 293b 2069 202b 3d20  ut.size(); i += 
-000a24a0: 3136 2920 7b0a 2020 2020 7569 6e74 3878  16) {.    uint8x
-000a24b0: 3136 5f74 2077 6f72 6420 3d20 766c 6431  16_t word = vld1
-000a24c0: 715f 7538 2828 636f 6e73 7420 7569 6e74  q_u8((const uint
-000a24d0: 385f 742a 2975 7365 725f 696e 7075 742e  8_t*)user_input.
-000a24e0: 6461 7461 2829 202b 2069 293b 0a20 2020  data() + i);.   
-000a24f0: 2072 756e 6e69 6e67 203d 2076 6f72 7271   running = vorrq
-000a2500: 5f75 3828 766f 7272 715f 7538 2872 756e  _u8(vorrq_u8(run
-000a2510: 6e69 6e67 2c20 766f 7272 715f 7538 2876  ning, vorrq_u8(v
-000a2520: 6365 7171 5f75 3828 776f 7264 2c20 6d61  ceqq_u8(word, ma
-000a2530: 736b 3129 2c0a 2020 2020 2020 2020 2020  sk1),.          
+000a1c60: 2020 2020 2020 2020 6669 6e61 6c5f 7574          final_ut
+000a1c70: 6638 2e64 6174 6128 2929 3b0a 2020 2020  f8.data());.    
+000a1c80: 2020 2020 2020 6f75 7470 7574 2e61 7070        output.app
+000a1c90: 656e 6428 6669 6e61 6c5f 7574 6638 293b  end(final_utf8);
+000a1ca0: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
+000a1cb0: 7b0a 2020 2020 2020 2020 2020 2f2f 2054  {.          // T
+000a1cc0: 6f55 6e69 636f 6465 206e 6576 6572 2066  oUnicode never f
+000a1cd0: 6169 6c73 2e20 2049 6620 616e 7920 7374  ails.  If any st
+000a1ce0: 6570 2066 6169 6c73 2c20 7468 656e 2074  ep fails, then t
+000a1cf0: 6865 206f 7269 6769 6e61 6c20 696e 7075  he original inpu
+000a1d00: 740a 2020 2020 2020 2020 2020 2f2f 2073  t.          // s
+000a1d10: 6571 7565 6e63 6520 6973 2072 6574 7572  equence is retur
+000a1d20: 6e65 6420 696d 6d65 6469 6174 656c 7920  ned immediately 
+000a1d30: 696e 2074 6861 7420 7374 6570 2e0a 2020  in that step..  
+000a1d40: 2020 2020 2020 2020 6f75 7470 7574 2e61          output.a
+000a1d50: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+000a1d60: 2020 2020 2073 7464 3a3a 7374 7269 6e67       std::string
+000a1d70: 5f76 6965 7728 696e 7075 742e 6461 7461  _view(input.data
+000a1d80: 2829 202b 206c 6162 656c 5f73 7461 7274  () + label_start
+000a1d90: 2c20 6c61 6265 6c5f 7369 7a65 2929 3b0a  , label_size));.
+000a1da0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000a1db0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+000a1dc0: 206f 7574 7075 742e 6170 7065 6e64 2873   output.append(s
+000a1dd0: 7464 3a3a 7374 7269 6e67 5f76 6965 7728  td::string_view(
+000a1de0: 696e 7075 742e 6461 7461 2829 202b 206c  input.data() + l
+000a1df0: 6162 656c 5f73 7461 7274 2c20 6c61 6265  abel_start, labe
+000a1e00: 6c5f 7369 7a65 2929 3b0a 2020 2020 2020  l_size));.      
+000a1e10: 7d0a 2020 2020 7d20 656c 7365 207b 0a20  }.    } else {. 
+000a1e20: 2020 2020 206f 7574 7075 742e 6170 7065       output.appe
+000a1e30: 6e64 286c 6162 656c 5f76 6965 7729 3b0a  nd(label_view);.
+000a1e40: 2020 2020 7d0a 0a20 2020 2069 6620 2821      }..    if (!
+000a1e50: 6973 5f6c 6173 745f 6c61 6265 6c29 207b  is_last_label) {
+000a1e60: 0a20 2020 2020 206f 7574 7075 742e 7075  .      output.pu
+000a1e70: 7368 5f62 6163 6b28 272e 2729 3b0a 2020  sh_back('.');.  
+000a1e80: 2020 7d0a 0a20 2020 206c 6162 656c 5f73    }..    label_s
+000a1e90: 7461 7274 202b 3d20 6c61 6265 6c5f 7369  tart += label_si
+000a1ea0: 7a65 202b 2031 3b0a 2020 7d0a 0a20 2072  ze + 1;.  }..  r
+000a1eb0: 6574 7572 6e20 6f75 7470 7574 3b0a 7d0a  eturn output;.}.
+000a1ec0: 7d20 202f 2f20 6e61 6d65 7370 6163 6520  }  // namespace 
+000a1ed0: 6164 613a 3a69 646e 610a 2f2a 2065 6e64  ada::idna./* end
+000a1ee0: 2066 696c 6520 7372 632f 746f 5f75 6e69   file src/to_uni
+000a1ef0: 636f 6465 2e63 7070 202a 2f0a 2f2a 2065  code.cpp */./* e
+000a1f00: 6e64 2066 696c 6520 7372 632f 6964 6e61  nd file src/idna
+000a1f10: 2e63 7070 202a 2f0a 2f2a 2065 6e64 2066  .cpp */./* end f
+000a1f20: 696c 6520 7372 632f 6164 615f 6964 6e61  ile src/ada_idna
+000a1f30: 2e63 7070 202a 2f0a 4144 415f 504f 505f  .cpp */.ADA_POP_
+000a1f40: 4449 5341 424c 455f 5741 524e 494e 4753  DISABLE_WARNINGS
+000a1f50: 0a0a 2369 6e63 6c75 6465 203c 616c 676f  ..#include <algo
+000a1f60: 7269 7468 6d3e 0a23 6966 2041 4441 5f4e  rithm>.#if ADA_N
+000a1f70: 454f 4e0a 2369 6e63 6c75 6465 203c 6172  EON.#include <ar
+000a1f80: 6d5f 6e65 6f6e 2e68 3e0a 2365 6c69 6620  m_neon.h>.#elif 
+000a1f90: 4144 415f 5353 4532 0a23 696e 636c 7564  ADA_SSE2.#includ
+000a1fa0: 6520 3c65 6d6d 696e 7472 696e 2e68 3e0a  e <emmintrin.h>.
+000a1fb0: 2365 6e64 6966 0a0a 6e61 6d65 7370 6163  #endif..namespac
+000a1fc0: 6520 6164 613a 3a75 6e69 636f 6465 207b  e ada::unicode {
+000a1fd0: 0a0a 636f 6e73 7465 7870 7220 626f 6f6c  ..constexpr bool
+000a1fe0: 2074 6f5f 6c6f 7765 725f 6173 6369 6928   to_lower_ascii(
+000a1ff0: 6368 6172 2a20 696e 7075 742c 2073 697a  char* input, siz
+000a2000: 655f 7420 6c65 6e67 7468 2920 6e6f 6578  e_t length) noex
+000a2010: 6365 7074 207b 0a20 2061 7574 6f20 6272  cept {.  auto br
+000a2020: 6f61 6463 6173 7420 3d20 5b5d 2875 696e  oadcast = [](uin
+000a2030: 7438 5f74 2076 2920 2d3e 2075 696e 7436  t8_t v) -> uint6
+000a2040: 345f 7420 7b0a 2020 2020 7265 7475 726e  4_t {.    return
+000a2050: 2030 7831 3031 3031 3031 3031 3031 3031   0x1010101010101
+000a2060: 3031 756c 6c20 2a20 763b 0a20 207d 3b0a  01ull * v;.  };.
+000a2070: 2020 7569 6e74 3634 5f74 2062 726f 6164    uint64_t broad
+000a2080: 6361 7374 5f38 3020 3d20 6272 6f61 6463  cast_80 = broadc
+000a2090: 6173 7428 3078 3830 293b 0a20 2075 696e  ast(0x80);.  uin
+000a20a0: 7436 345f 7420 6272 6f61 6463 6173 745f  t64_t broadcast_
+000a20b0: 4170 203d 2062 726f 6164 6361 7374 2831  Ap = broadcast(1
+000a20c0: 3238 202d 2027 4127 293b 0a20 2075 696e  28 - 'A');.  uin
+000a20d0: 7436 345f 7420 6272 6f61 6463 6173 745f  t64_t broadcast_
+000a20e0: 5a70 203d 2062 726f 6164 6361 7374 2831  Zp = broadcast(1
+000a20f0: 3238 202d 2027 5a27 202d 2031 293b 0a20  28 - 'Z' - 1);. 
+000a2100: 2075 696e 7436 345f 7420 6e6f 6e5f 6173   uint64_t non_as
+000a2110: 6369 6920 3d20 303b 0a20 2073 697a 655f  cii = 0;.  size_
+000a2120: 7420 6920 3d20 303b 0a0a 2020 666f 7220  t i = 0;..  for 
+000a2130: 283b 2069 202b 2037 203c 206c 656e 6774  (; i + 7 < lengt
+000a2140: 683b 2069 202b 3d20 3829 207b 0a20 2020  h; i += 8) {.   
+000a2150: 2075 696e 7436 345f 7420 776f 7264 7b7d   uint64_t word{}
+000a2160: 3b0a 2020 2020 6d65 6d63 7079 2826 776f  ;.    memcpy(&wo
+000a2170: 7264 2c20 696e 7075 7420 2b20 692c 2073  rd, input + i, s
+000a2180: 697a 656f 6628 776f 7264 2929 3b0a 2020  izeof(word));.  
+000a2190: 2020 6e6f 6e5f 6173 6369 6920 7c3d 2028    non_ascii |= (
+000a21a0: 776f 7264 2026 2062 726f 6164 6361 7374  word & broadcast
+000a21b0: 5f38 3029 3b0a 2020 2020 776f 7264 205e  _80);.    word ^
+000a21c0: 3d0a 2020 2020 2020 2020 2828 2877 6f72  =.        (((wor
+000a21d0: 6420 2b20 6272 6f61 6463 6173 745f 4170  d + broadcast_Ap
+000a21e0: 2920 5e20 2877 6f72 6420 2b20 6272 6f61  ) ^ (word + broa
+000a21f0: 6463 6173 745f 5a70 2929 2026 2062 726f  dcast_Zp)) & bro
+000a2200: 6164 6361 7374 5f38 3029 203e 3e20 323b  adcast_80) >> 2;
+000a2210: 0a20 2020 206d 656d 6370 7928 696e 7075  .    memcpy(inpu
+000a2220: 7420 2b20 692c 2026 776f 7264 2c20 7369  t + i, &word, si
+000a2230: 7a65 6f66 2877 6f72 6429 293b 0a20 207d  zeof(word));.  }
+000a2240: 0a20 2069 6620 2869 203c 206c 656e 6774  .  if (i < lengt
+000a2250: 6829 207b 0a20 2020 2075 696e 7436 345f  h) {.    uint64_
+000a2260: 7420 776f 7264 7b7d 3b0a 2020 2020 6d65  t word{};.    me
+000a2270: 6d63 7079 2826 776f 7264 2c20 696e 7075  mcpy(&word, inpu
+000a2280: 7420 2b20 692c 206c 656e 6774 6820 2d20  t + i, length - 
+000a2290: 6929 3b0a 2020 2020 6e6f 6e5f 6173 6369  i);.    non_asci
+000a22a0: 6920 7c3d 2028 776f 7264 2026 2062 726f  i |= (word & bro
+000a22b0: 6164 6361 7374 5f38 3029 3b0a 2020 2020  adcast_80);.    
+000a22c0: 776f 7264 205e 3d0a 2020 2020 2020 2020  word ^=.        
+000a22d0: 2828 2877 6f72 6420 2b20 6272 6f61 6463  (((word + broadc
+000a22e0: 6173 745f 4170 2920 5e20 2877 6f72 6420  ast_Ap) ^ (word 
+000a22f0: 2b20 6272 6f61 6463 6173 745f 5a70 2929  + broadcast_Zp))
+000a2300: 2026 2062 726f 6164 6361 7374 5f38 3029   & broadcast_80)
+000a2310: 203e 3e20 323b 0a20 2020 206d 656d 6370   >> 2;.    memcp
+000a2320: 7928 696e 7075 7420 2b20 692c 2026 776f  y(input + i, &wo
+000a2330: 7264 2c20 6c65 6e67 7468 202d 2069 293b  rd, length - i);
+000a2340: 0a20 207d 0a20 2072 6574 7572 6e20 6e6f  .  }.  return no
+000a2350: 6e5f 6173 6369 6920 3d3d 2030 3b0a 7d0a  n_ascii == 0;.}.
+000a2360: 2369 6620 4144 415f 4e45 4f4e 0a61 6461  #if ADA_NEON.ada
+000a2370: 5f72 6561 6c6c 795f 696e 6c69 6e65 2062  _really_inline b
+000a2380: 6f6f 6c20 6861 735f 7461 6273 5f6f 725f  ool has_tabs_or_
+000a2390: 6e65 776c 696e 6528 0a20 2020 2073 7464  newline(.    std
+000a23a0: 3a3a 7374 7269 6e67 5f76 6965 7720 7573  ::string_view us
+000a23b0: 6572 5f69 6e70 7574 2920 6e6f 6578 6365  er_input) noexce
+000a23c0: 7074 207b 0a20 2073 697a 655f 7420 6920  pt {.  size_t i 
+000a23d0: 3d20 303b 0a20 2063 6f6e 7374 2075 696e  = 0;.  const uin
+000a23e0: 7438 7831 365f 7420 6d61 736b 3120 3d20  t8x16_t mask1 = 
+000a23f0: 766d 6f76 715f 6e5f 7538 2827 5c72 2729  vmovq_n_u8('\r')
+000a2400: 3b0a 2020 636f 6e73 7420 7569 6e74 3878  ;.  const uint8x
+000a2410: 3136 5f74 206d 6173 6b32 203d 2076 6d6f  16_t mask2 = vmo
+000a2420: 7671 5f6e 5f75 3828 275c 6e27 293b 0a20  vq_n_u8('\n');. 
+000a2430: 2063 6f6e 7374 2075 696e 7438 7831 365f   const uint8x16_
+000a2440: 7420 6d61 736b 3320 3d20 766d 6f76 715f  t mask3 = vmovq_
+000a2450: 6e5f 7538 2827 5c74 2729 3b0a 2020 7569  n_u8('\t');.  ui
+000a2460: 6e74 3878 3136 5f74 2072 756e 6e69 6e67  nt8x16_t running
+000a2470: 7b30 7d3b 0a20 2066 6f72 2028 3b20 6920  {0};.  for (; i 
+000a2480: 2b20 3135 203c 2075 7365 725f 696e 7075  + 15 < user_inpu
+000a2490: 742e 7369 7a65 2829 3b20 6920 2b3d 2031  t.size(); i += 1
+000a24a0: 3629 207b 0a20 2020 2075 696e 7438 7831  6) {.    uint8x1
+000a24b0: 365f 7420 776f 7264 203d 2076 6c64 3171  6_t word = vld1q
+000a24c0: 5f75 3828 2863 6f6e 7374 2075 696e 7438  _u8((const uint8
+000a24d0: 5f74 2a29 7573 6572 5f69 6e70 7574 2e64  _t*)user_input.d
+000a24e0: 6174 6128 2920 2b20 6929 3b0a 2020 2020  ata() + i);.    
+000a24f0: 7275 6e6e 696e 6720 3d20 766f 7272 715f  running = vorrq_
+000a2500: 7538 2876 6f72 7271 5f75 3828 7275 6e6e  u8(vorrq_u8(runn
+000a2510: 696e 672c 2076 6f72 7271 5f75 3828 7663  ing, vorrq_u8(vc
+000a2520: 6571 715f 7538 2877 6f72 642c 206d 6173  eqq_u8(word, mas
+000a2530: 6b31 292c 0a20 2020 2020 2020 2020 2020  k1),.           
 000a2540: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a2550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a2560: 2020 2020 2020 2020 7663 6571 715f 7538          vceqq_u8
-000a2570: 2877 6f72 642c 206d 6173 6b32 2929 292c  (word, mask2))),
-000a2580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000a2590: 2020 2020 2020 2020 7663 6571 715f 7538          vceqq_u8
-000a25a0: 2877 6f72 642c 206d 6173 6b33 2929 3b0a  (word, mask3));.
-000a25b0: 2020 7d0a 2020 6966 2028 6920 3c20 7573    }.  if (i < us
-000a25c0: 6572 5f69 6e70 7574 2e73 697a 6528 2929  er_input.size())
-000a25d0: 207b 0a20 2020 2075 696e 7438 5f74 2062   {.    uint8_t b
-000a25e0: 7566 6665 725b 3136 5d7b 7d3b 0a20 2020  uffer[16]{};.   
-000a25f0: 206d 656d 6370 7928 6275 6666 6572 2c20   memcpy(buffer, 
-000a2600: 7573 6572 5f69 6e70 7574 2e64 6174 6128  user_input.data(
-000a2610: 2920 2b20 692c 2075 7365 725f 696e 7075  ) + i, user_inpu
-000a2620: 742e 7369 7a65 2829 202d 2069 293b 0a20  t.size() - i);. 
-000a2630: 2020 2075 696e 7438 7831 365f 7420 776f     uint8x16_t wo
-000a2640: 7264 203d 2076 6c64 3171 5f75 3828 2863  rd = vld1q_u8((c
-000a2650: 6f6e 7374 2075 696e 7438 5f74 2a29 7573  onst uint8_t*)us
-000a2660: 6572 5f69 6e70 7574 2e64 6174 6128 2920  er_input.data() 
-000a2670: 2b20 6929 3b0a 2020 2020 7275 6e6e 696e  + i);.    runnin
-000a2680: 6720 3d20 766f 7272 715f 7538 2876 6f72  g = vorrq_u8(vor
-000a2690: 7271 5f75 3828 7275 6e6e 696e 672c 2076  rq_u8(running, v
-000a26a0: 6f72 7271 5f75 3828 7663 6571 715f 7538  orrq_u8(vceqq_u8
-000a26b0: 2877 6f72 642c 206d 6173 6b31 292c 0a20  (word, mask1),. 
+000a2560: 2020 2020 2020 2076 6365 7171 5f75 3828         vceqq_u8(
+000a2570: 776f 7264 2c20 6d61 736b 3229 2929 2c0a  word, mask2))),.
+000a2580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000a2590: 2020 2020 2020 2076 6365 7171 5f75 3828         vceqq_u8(
+000a25a0: 776f 7264 2c20 6d61 736b 3329 293b 0a20  word, mask3));. 
+000a25b0: 207d 0a20 2069 6620 2869 203c 2075 7365   }.  if (i < use
+000a25c0: 725f 696e 7075 742e 7369 7a65 2829 2920  r_input.size()) 
+000a25d0: 7b0a 2020 2020 7569 6e74 385f 7420 6275  {.    uint8_t bu
+000a25e0: 6666 6572 5b31 365d 7b7d 3b0a 2020 2020  ffer[16]{};.    
+000a25f0: 6d65 6d63 7079 2862 7566 6665 722c 2075  memcpy(buffer, u
+000a2600: 7365 725f 696e 7075 742e 6461 7461 2829  ser_input.data()
+000a2610: 202b 2069 2c20 7573 6572 5f69 6e70 7574   + i, user_input
+000a2620: 2e73 697a 6528 2920 2d20 6929 3b0a 2020  .size() - i);.  
+000a2630: 2020 7569 6e74 3878 3136 5f74 2077 6f72    uint8x16_t wor
+000a2640: 6420 3d20 766c 6431 715f 7538 2828 636f  d = vld1q_u8((co
+000a2650: 6e73 7420 7569 6e74 385f 742a 2975 7365  nst uint8_t*)use
+000a2660: 725f 696e 7075 742e 6461 7461 2829 202b  r_input.data() +
+000a2670: 2069 293b 0a20 2020 2072 756e 6e69 6e67   i);.    running
+000a2680: 203d 2076 6f72 7271 5f75 3828 766f 7272   = vorrq_u8(vorr
+000a2690: 715f 7538 2872 756e 6e69 6e67 2c20 766f  q_u8(running, vo
+000a26a0: 7272 715f 7538 2876 6365 7171 5f75 3828  rrq_u8(vceqq_u8(
+000a26b0: 776f 7264 2c20 6d61 736b 3129 2c0a 2020  word, mask1),.  
 000a26c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a26d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a26e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a26f0: 2076 6365 7171 5f75 3828 776f 7264 2c20   vceqq_u8(word, 
-000a2700: 6d61 736b 3229 2929 2c0a 2020 2020 2020  mask2))),.      
+000a26f0: 7663 6571 715f 7538 2877 6f72 642c 206d  vceqq_u8(word, m
+000a2700: 6173 6b32 2929 292c 0a20 2020 2020 2020  ask2))),.       
 000a2710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a2720: 2076 6365 7171 5f75 3828 776f 7264 2c20   vceqq_u8(word, 
-000a2730: 6d61 736b 3329 293b 0a20 207d 0a20 2072  mask3));.  }.  r
-000a2740: 6574 7572 6e20 766d 6178 7671 5f75 3828  eturn vmaxvq_u8(
-000a2750: 7275 6e6e 696e 6729 2021 3d20 303b 0a7d  running) != 0;.}
-000a2760: 0a23 656c 6966 2041 4441 5f53 5345 320a  .#elif ADA_SSE2.
-000a2770: 6164 615f 7265 616c 6c79 5f69 6e6c 696e  ada_really_inlin
-000a2780: 6520 626f 6f6c 2068 6173 5f74 6162 735f  e bool has_tabs_
-000a2790: 6f72 5f6e 6577 6c69 6e65 280a 2020 2020  or_newline(.    
-000a27a0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000a27b0: 2075 7365 725f 696e 7075 7429 206e 6f65   user_input) noe
-000a27c0: 7863 6570 7420 7b0a 2020 7369 7a65 5f74  xcept {.  size_t
-000a27d0: 2069 203d 2030 3b0a 2020 636f 6e73 7420   i = 0;.  const 
-000a27e0: 5f5f 6d31 3238 6920 6d61 736b 3120 3d20  __m128i mask1 = 
-000a27f0: 5f6d 6d5f 7365 7431 5f65 7069 3828 275c  _mm_set1_epi8('\
-000a2800: 7227 293b 0a20 2063 6f6e 7374 205f 5f6d  r');.  const __m
-000a2810: 3132 3869 206d 6173 6b32 203d 205f 6d6d  128i mask2 = _mm
-000a2820: 5f73 6574 315f 6570 6938 2827 5c6e 2729  _set1_epi8('\n')
-000a2830: 3b0a 2020 636f 6e73 7420 5f5f 6d31 3238  ;.  const __m128
-000a2840: 6920 6d61 736b 3320 3d20 5f6d 6d5f 7365  i mask3 = _mm_se
-000a2850: 7431 5f65 7069 3828 275c 7427 293b 0a20  t1_epi8('\t');. 
-000a2860: 205f 5f6d 3132 3869 2072 756e 6e69 6e67   __m128i running
-000a2870: 7b30 7d3b 0a20 2066 6f72 2028 3b20 6920  {0};.  for (; i 
-000a2880: 2b20 3135 203c 2075 7365 725f 696e 7075  + 15 < user_inpu
-000a2890: 742e 7369 7a65 2829 3b20 6920 2b3d 2031  t.size(); i += 1
-000a28a0: 3629 207b 0a20 2020 205f 5f6d 3132 3869  6) {.    __m128i
-000a28b0: 2077 6f72 6420 3d20 5f6d 6d5f 6c6f 6164   word = _mm_load
-000a28c0: 755f 7369 3132 3828 2863 6f6e 7374 205f  u_si128((const _
-000a28d0: 5f6d 3132 3869 2a29 2875 7365 725f 696e  _m128i*)(user_in
-000a28e0: 7075 742e 6461 7461 2829 202b 2069 2929  put.data() + i))
-000a28f0: 3b0a 2020 2020 7275 6e6e 696e 6720 3d20  ;.    running = 
-000a2900: 5f6d 6d5f 6f72 5f73 6931 3238 280a 2020  _mm_or_si128(.  
-000a2910: 2020 2020 2020 5f6d 6d5f 6f72 5f73 6931        _mm_or_si1
-000a2920: 3238 2872 756e 6e69 6e67 2c20 5f6d 6d5f  28(running, _mm_
-000a2930: 6f72 5f73 6931 3238 285f 6d6d 5f63 6d70  or_si128(_mm_cmp
-000a2940: 6571 5f65 7069 3828 776f 7264 2c20 6d61  eq_epi8(word, ma
-000a2950: 736b 3129 2c0a 2020 2020 2020 2020 2020  sk1),.          
+000a2720: 7663 6571 715f 7538 2877 6f72 642c 206d  vceqq_u8(word, m
+000a2730: 6173 6b33 2929 3b0a 2020 7d0a 2020 7265  ask3));.  }.  re
+000a2740: 7475 726e 2076 6d61 7876 715f 7538 2872  turn vmaxvq_u8(r
+000a2750: 756e 6e69 6e67 2920 213d 2030 3b0a 7d0a  unning) != 0;.}.
+000a2760: 2365 6c69 6620 4144 415f 5353 4532 0a61  #elif ADA_SSE2.a
+000a2770: 6461 5f72 6561 6c6c 795f 696e 6c69 6e65  da_really_inline
+000a2780: 2062 6f6f 6c20 6861 735f 7461 6273 5f6f   bool has_tabs_o
+000a2790: 725f 6e65 776c 696e 6528 0a20 2020 2073  r_newline(.    s
+000a27a0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000a27b0: 7573 6572 5f69 6e70 7574 2920 6e6f 6578  user_input) noex
+000a27c0: 6365 7074 207b 0a20 2073 697a 655f 7420  cept {.  size_t 
+000a27d0: 6920 3d20 303b 0a20 2063 6f6e 7374 205f  i = 0;.  const _
+000a27e0: 5f6d 3132 3869 206d 6173 6b31 203d 205f  _m128i mask1 = _
+000a27f0: 6d6d 5f73 6574 315f 6570 6938 2827 5c72  mm_set1_epi8('\r
+000a2800: 2729 3b0a 2020 636f 6e73 7420 5f5f 6d31  ');.  const __m1
+000a2810: 3238 6920 6d61 736b 3220 3d20 5f6d 6d5f  28i mask2 = _mm_
+000a2820: 7365 7431 5f65 7069 3828 275c 6e27 293b  set1_epi8('\n');
+000a2830: 0a20 2063 6f6e 7374 205f 5f6d 3132 3869  .  const __m128i
+000a2840: 206d 6173 6b33 203d 205f 6d6d 5f73 6574   mask3 = _mm_set
+000a2850: 315f 6570 6938 2827 5c74 2729 3b0a 2020  1_epi8('\t');.  
+000a2860: 5f5f 6d31 3238 6920 7275 6e6e 696e 677b  __m128i running{
+000a2870: 307d 3b0a 2020 666f 7220 283b 2069 202b  0};.  for (; i +
+000a2880: 2031 3520 3c20 7573 6572 5f69 6e70 7574   15 < user_input
+000a2890: 2e73 697a 6528 293b 2069 202b 3d20 3136  .size(); i += 16
+000a28a0: 2920 7b0a 2020 2020 5f5f 6d31 3238 6920  ) {.    __m128i 
+000a28b0: 776f 7264 203d 205f 6d6d 5f6c 6f61 6475  word = _mm_loadu
+000a28c0: 5f73 6931 3238 2828 636f 6e73 7420 5f5f  _si128((const __
+000a28d0: 6d31 3238 692a 2928 7573 6572 5f69 6e70  m128i*)(user_inp
+000a28e0: 7574 2e64 6174 6128 2920 2b20 6929 293b  ut.data() + i));
+000a28f0: 0a20 2020 2072 756e 6e69 6e67 203d 205f  .    running = _
+000a2900: 6d6d 5f6f 725f 7369 3132 3828 0a20 2020  mm_or_si128(.   
+000a2910: 2020 2020 205f 6d6d 5f6f 725f 7369 3132       _mm_or_si12
+000a2920: 3828 7275 6e6e 696e 672c 205f 6d6d 5f6f  8(running, _mm_o
+000a2930: 725f 7369 3132 3828 5f6d 6d5f 636d 7065  r_si128(_mm_cmpe
+000a2940: 715f 6570 6938 2877 6f72 642c 206d 6173  q_epi8(word, mas
+000a2950: 6b31 292c 0a20 2020 2020 2020 2020 2020  k1),.           
 000a2960: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a2970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a2980: 205f 6d6d 5f63 6d70 6571 5f65 7069 3828   _mm_cmpeq_epi8(
-000a2990: 776f 7264 2c20 6d61 736b 3229 2929 2c0a  word, mask2))),.
-000a29a0: 2020 2020 2020 2020 5f6d 6d5f 636d 7065          _mm_cmpe
-000a29b0: 715f 6570 6938 2877 6f72 642c 206d 6173  q_epi8(word, mas
-000a29c0: 6b33 2929 3b0a 2020 7d0a 2020 6966 2028  k3));.  }.  if (
-000a29d0: 6920 3c20 7573 6572 5f69 6e70 7574 2e73  i < user_input.s
-000a29e0: 697a 6528 2929 207b 0a20 2020 2075 696e  ize()) {.    uin
-000a29f0: 7438 5f74 2062 7566 6665 725b 3136 5d7b  t8_t buffer[16]{
-000a2a00: 7d3b 0a20 2020 206d 656d 6370 7928 6275  };.    memcpy(bu
-000a2a10: 6666 6572 2c20 7573 6572 5f69 6e70 7574  ffer, user_input
-000a2a20: 2e64 6174 6128 2920 2b20 692c 2075 7365  .data() + i, use
-000a2a30: 725f 696e 7075 742e 7369 7a65 2829 202d  r_input.size() -
-000a2a40: 2069 293b 0a20 2020 205f 5f6d 3132 3869   i);.    __m128i
-000a2a50: 2077 6f72 6420 3d20 5f6d 6d5f 6c6f 6164   word = _mm_load
-000a2a60: 755f 7369 3132 3828 2863 6f6e 7374 205f  u_si128((const _
-000a2a70: 5f6d 3132 3869 2a29 6275 6666 6572 293b  _m128i*)buffer);
-000a2a80: 0a20 2020 2072 756e 6e69 6e67 203d 205f  .    running = _
-000a2a90: 6d6d 5f6f 725f 7369 3132 3828 0a20 2020  mm_or_si128(.   
-000a2aa0: 2020 2020 205f 6d6d 5f6f 725f 7369 3132       _mm_or_si12
-000a2ab0: 3828 7275 6e6e 696e 672c 205f 6d6d 5f6f  8(running, _mm_o
-000a2ac0: 725f 7369 3132 3828 5f6d 6d5f 636d 7065  r_si128(_mm_cmpe
-000a2ad0: 715f 6570 6938 2877 6f72 642c 206d 6173  q_epi8(word, mas
-000a2ae0: 6b31 292c 0a20 2020 2020 2020 2020 2020  k1),.           
+000a2980: 5f6d 6d5f 636d 7065 715f 6570 6938 2877  _mm_cmpeq_epi8(w
+000a2990: 6f72 642c 206d 6173 6b32 2929 292c 0a20  ord, mask2))),. 
+000a29a0: 2020 2020 2020 205f 6d6d 5f63 6d70 6571         _mm_cmpeq
+000a29b0: 5f65 7069 3828 776f 7264 2c20 6d61 736b  _epi8(word, mask
+000a29c0: 3329 293b 0a20 207d 0a20 2069 6620 2869  3));.  }.  if (i
+000a29d0: 203c 2075 7365 725f 696e 7075 742e 7369   < user_input.si
+000a29e0: 7a65 2829 2920 7b0a 2020 2020 7569 6e74  ze()) {.    uint
+000a29f0: 385f 7420 6275 6666 6572 5b31 365d 7b7d  8_t buffer[16]{}
+000a2a00: 3b0a 2020 2020 6d65 6d63 7079 2862 7566  ;.    memcpy(buf
+000a2a10: 6665 722c 2075 7365 725f 696e 7075 742e  fer, user_input.
+000a2a20: 6461 7461 2829 202b 2069 2c20 7573 6572  data() + i, user
+000a2a30: 5f69 6e70 7574 2e73 697a 6528 2920 2d20  _input.size() - 
+000a2a40: 6929 3b0a 2020 2020 5f5f 6d31 3238 6920  i);.    __m128i 
+000a2a50: 776f 7264 203d 205f 6d6d 5f6c 6f61 6475  word = _mm_loadu
+000a2a60: 5f73 6931 3238 2828 636f 6e73 7420 5f5f  _si128((const __
+000a2a70: 6d31 3238 692a 2962 7566 6665 7229 3b0a  m128i*)buffer);.
+000a2a80: 2020 2020 7275 6e6e 696e 6720 3d20 5f6d      running = _m
+000a2a90: 6d5f 6f72 5f73 6931 3238 280a 2020 2020  m_or_si128(.    
+000a2aa0: 2020 2020 5f6d 6d5f 6f72 5f73 6931 3238      _mm_or_si128
+000a2ab0: 2872 756e 6e69 6e67 2c20 5f6d 6d5f 6f72  (running, _mm_or
+000a2ac0: 5f73 6931 3238 285f 6d6d 5f63 6d70 6571  _si128(_mm_cmpeq
+000a2ad0: 5f65 7069 3828 776f 7264 2c20 6d61 736b  _epi8(word, mask
+000a2ae0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
 000a2af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a2b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a2b10: 5f6d 6d5f 636d 7065 715f 6570 6938 2877  _mm_cmpeq_epi8(w
-000a2b20: 6f72 642c 206d 6173 6b32 2929 292c 0a20  ord, mask2))),. 
-000a2b30: 2020 2020 2020 205f 6d6d 5f63 6d70 6571         _mm_cmpeq
-000a2b40: 5f65 7069 3828 776f 7264 2c20 6d61 736b  _epi8(word, mask
-000a2b50: 3329 293b 0a20 207d 0a20 2072 6574 7572  3));.  }.  retur
-000a2b60: 6e20 5f6d 6d5f 6d6f 7665 6d61 736b 5f65  n _mm_movemask_e
-000a2b70: 7069 3828 7275 6e6e 696e 6729 2021 3d20  pi8(running) != 
-000a2b80: 303b 0a7d 0a23 656c 7365 0a61 6461 5f72  0;.}.#else.ada_r
-000a2b90: 6561 6c6c 795f 696e 6c69 6e65 2062 6f6f  eally_inline boo
-000a2ba0: 6c20 6861 735f 7461 6273 5f6f 725f 6e65  l has_tabs_or_ne
-000a2bb0: 776c 696e 6528 0a20 2020 2073 7464 3a3a  wline(.    std::
-000a2bc0: 7374 7269 6e67 5f76 6965 7720 7573 6572  string_view user
-000a2bd0: 5f69 6e70 7574 2920 6e6f 6578 6365 7074  _input) noexcept
-000a2be0: 207b 0a20 2061 7574 6f20 6861 735f 7a65   {.  auto has_ze
-000a2bf0: 726f 5f62 7974 6520 3d20 5b5d 2875 696e  ro_byte = [](uin
-000a2c00: 7436 345f 7420 7629 207b 0a20 2020 2072  t64_t v) {.    r
-000a2c10: 6574 7572 6e20 2828 7620 2d20 3078 3031  eturn ((v - 0x01
-000a2c20: 3031 3031 3031 3031 3031 3031 3031 2920  01010101010101) 
-000a2c30: 2620 7e28 7629 2630 7838 3038 3038 3038  & ~(v)&0x8080808
-000a2c40: 3038 3038 3038 3038 3029 3b0a 2020 7d3b  080808080);.  };
-000a2c50: 0a20 2061 7574 6f20 6272 6f61 6463 6173  .  auto broadcas
-000a2c60: 7420 3d20 5b5d 2875 696e 7438 5f74 2076  t = [](uint8_t v
-000a2c70: 2920 2d3e 2075 696e 7436 345f 7420 7b0a  ) -> uint64_t {.
-000a2c80: 2020 2020 7265 7475 726e 2030 7831 3031      return 0x101
-000a2c90: 3031 3031 3031 3031 3031 3031 756c 6c20  010101010101ull 
-000a2ca0: 2a20 763b 0a20 207d 3b0a 2020 7369 7a65  * v;.  };.  size
-000a2cb0: 5f74 2069 203d 2030 3b0a 2020 7569 6e74  _t i = 0;.  uint
-000a2cc0: 3634 5f74 206d 6173 6b31 203d 2062 726f  64_t mask1 = bro
-000a2cd0: 6164 6361 7374 2827 5c72 2729 3b0a 2020  adcast('\r');.  
-000a2ce0: 7569 6e74 3634 5f74 206d 6173 6b32 203d  uint64_t mask2 =
-000a2cf0: 2062 726f 6164 6361 7374 2827 5c6e 2729   broadcast('\n')
-000a2d00: 3b0a 2020 7569 6e74 3634 5f74 206d 6173  ;.  uint64_t mas
-000a2d10: 6b33 203d 2062 726f 6164 6361 7374 2827  k3 = broadcast('
-000a2d20: 5c74 2729 3b0a 2020 7569 6e74 3634 5f74  \t');.  uint64_t
-000a2d30: 2072 756e 6e69 6e67 7b30 7d3b 0a20 2066   running{0};.  f
-000a2d40: 6f72 2028 3b20 6920 2b20 3720 3c20 7573  or (; i + 7 < us
-000a2d50: 6572 5f69 6e70 7574 2e73 697a 6528 293b  er_input.size();
-000a2d60: 2069 202b 3d20 3829 207b 0a20 2020 2075   i += 8) {.    u
-000a2d70: 696e 7436 345f 7420 776f 7264 7b7d 3b0a  int64_t word{};.
-000a2d80: 2020 2020 6d65 6d63 7079 2826 776f 7264      memcpy(&word
-000a2d90: 2c20 7573 6572 5f69 6e70 7574 2e64 6174  , user_input.dat
-000a2da0: 6128 2920 2b20 692c 2073 697a 656f 6628  a() + i, sizeof(
-000a2db0: 776f 7264 2929 3b0a 2020 2020 7569 6e74  word));.    uint
-000a2dc0: 3634 5f74 2078 6f72 3120 3d20 776f 7264  64_t xor1 = word
-000a2dd0: 205e 206d 6173 6b31 3b0a 2020 2020 7569   ^ mask1;.    ui
-000a2de0: 6e74 3634 5f74 2078 6f72 3220 3d20 776f  nt64_t xor2 = wo
-000a2df0: 7264 205e 206d 6173 6b32 3b0a 2020 2020  rd ^ mask2;.    
-000a2e00: 7569 6e74 3634 5f74 2078 6f72 3320 3d20  uint64_t xor3 = 
-000a2e10: 776f 7264 205e 206d 6173 6b33 3b0a 2020  word ^ mask3;.  
-000a2e20: 2020 7275 6e6e 696e 6720 7c3d 2068 6173    running |= has
-000a2e30: 5f7a 6572 6f5f 6279 7465 2878 6f72 3129  _zero_byte(xor1)
-000a2e40: 207c 2068 6173 5f7a 6572 6f5f 6279 7465   | has_zero_byte
-000a2e50: 2878 6f72 3229 207c 2068 6173 5f7a 6572  (xor2) | has_zer
-000a2e60: 6f5f 6279 7465 2878 6f72 3329 3b0a 2020  o_byte(xor3);.  
-000a2e70: 7d0a 2020 6966 2028 6920 3c20 7573 6572  }.  if (i < user
-000a2e80: 5f69 6e70 7574 2e73 697a 6528 2929 207b  _input.size()) {
-000a2e90: 0a20 2020 2075 696e 7436 345f 7420 776f  .    uint64_t wo
-000a2ea0: 7264 7b7d 3b0a 2020 2020 6d65 6d63 7079  rd{};.    memcpy
-000a2eb0: 2826 776f 7264 2c20 7573 6572 5f69 6e70  (&word, user_inp
-000a2ec0: 7574 2e64 6174 6128 2920 2b20 692c 2075  ut.data() + i, u
-000a2ed0: 7365 725f 696e 7075 742e 7369 7a65 2829  ser_input.size()
-000a2ee0: 202d 2069 293b 0a20 2020 2075 696e 7436   - i);.    uint6
-000a2ef0: 345f 7420 786f 7231 203d 2077 6f72 6420  4_t xor1 = word 
-000a2f00: 5e20 6d61 736b 313b 0a20 2020 2075 696e  ^ mask1;.    uin
-000a2f10: 7436 345f 7420 786f 7232 203d 2077 6f72  t64_t xor2 = wor
-000a2f20: 6420 5e20 6d61 736b 323b 0a20 2020 2075  d ^ mask2;.    u
-000a2f30: 696e 7436 345f 7420 786f 7233 203d 2077  int64_t xor3 = w
-000a2f40: 6f72 6420 5e20 6d61 736b 333b 0a20 2020  ord ^ mask3;.   
-000a2f50: 2072 756e 6e69 6e67 207c 3d20 6861 735f   running |= has_
-000a2f60: 7a65 726f 5f62 7974 6528 786f 7231 2920  zero_byte(xor1) 
-000a2f70: 7c20 6861 735f 7a65 726f 5f62 7974 6528  | has_zero_byte(
-000a2f80: 786f 7232 2920 7c20 6861 735f 7a65 726f  xor2) | has_zero
-000a2f90: 5f62 7974 6528 786f 7233 293b 0a20 207d  _byte(xor3);.  }
-000a2fa0: 0a20 2072 6574 7572 6e20 7275 6e6e 696e  .  return runnin
-000a2fb0: 673b 0a7d 0a23 656e 6469 660a 0a2f 2f20  g;.}.#endif..// 
-000a2fc0: 4120 666f 7262 6964 6465 6e20 686f 7374  A forbidden host
-000a2fd0: 2063 6f64 6520 706f 696e 7420 6973 2055   code point is U
-000a2fe0: 2b30 3030 3020 4e55 4c4c 2c20 552b 3030  +0000 NULL, U+00
-000a2ff0: 3039 2054 4142 2c20 552b 3030 3041 204c  09 TAB, U+000A L
-000a3000: 462c 2055 2b30 3030 4420 4352 2c0a 2f2f  F, U+000D CR,.//
-000a3010: 2055 2b30 3032 3020 5350 4143 452c 2055   U+0020 SPACE, U
-000a3020: 2b30 3032 3320 2823 292c 2055 2b30 3032  +0023 (#), U+002
-000a3030: 4620 282f 292c 2055 2b30 3033 4120 283a  F (/), U+003A (:
-000a3040: 292c 2055 2b30 3033 4320 283c 292c 2055  ), U+003C (<), U
-000a3050: 2b30 3033 4520 283e 292c 0a2f 2f20 552b  +003E (>),.// U+
-000a3060: 3030 3346 2028 3f29 2c20 552b 3030 3430  003F (?), U+0040
-000a3070: 2028 4029 2c20 552b 3030 3542 2028 5b29   (@), U+005B ([)
-000a3080: 2c20 552b 3030 3543 2028 5c29 2c20 552b  , U+005C (\), U+
-000a3090: 3030 3544 2028 5d29 2c20 552b 3030 3545  005D (]), U+005E
-000a30a0: 2028 5e29 2c20 6f72 0a2f 2f20 552b 3030   (^), or.// U+00
-000a30b0: 3743 2028 7c29 2e0a 636f 6e73 7465 7870  7C (|)..constexp
-000a30c0: 7220 7374 6174 6963 2062 6f6f 6c20 6973  r static bool is
-000a30d0: 5f66 6f72 6269 6464 656e 5f68 6f73 745f  _forbidden_host_
-000a30e0: 636f 6465 5f70 6f69 6e74 5f74 6162 6c65  code_point_table
-000a30f0: 5b5d 203d 207b 0a20 2020 2031 2c20 302c  [] = {.    1, 0,
-000a3100: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3110: 302c 2030 2c20 312c 2031 2c20 302c 2030  0, 0, 1, 1, 0, 0
-000a3120: 2c20 312c 2030 2c20 302c 2030 2c20 302c  , 1, 0, 0, 0, 0,
-000a3130: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3140: 302c 0a20 2020 2030 2c20 302c 2030 2c20  0,.    0, 0, 0, 
-000a3150: 302c 2030 2c20 302c 2030 2c20 302c 2031  0, 0, 0, 0, 0, 1
-000a3160: 2c20 302c 2030 2c20 312c 2030 2c20 302c  , 0, 0, 1, 0, 0,
-000a3170: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3180: 302c 2030 2c20 302c 2030 2c20 312c 0a20  0, 0, 0, 0, 1,. 
-000a3190: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
-000a31a0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a31b0: 2031 2c20 302c 2031 2c20 302c 2031 2c20   1, 0, 1, 0, 1, 
-000a31c0: 312c 2031 2c20 302c 2030 2c20 302c 2030  1, 1, 0, 0, 0, 0
-000a31d0: 2c20 302c 2030 2c20 302c 0a20 2020 2030  , 0, 0, 0,.    0
-000a31e0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a31f0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3200: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3210: 2c20 302c 2030 2c20 312c 2031 2c20 312c  , 0, 0, 1, 1, 1,
-000a3220: 2031 2c20 302c 0a20 2020 2030 2c20 302c   1, 0,.    0, 0,
-000a3230: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3240: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3250: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3260: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3270: 302c 0a20 2020 2030 2c20 302c 2030 2c20  0,.    0, 0, 0, 
-000a3280: 302c 2031 2c20 302c 2030 2c20 302c 2030  0, 1, 0, 0, 0, 0
-000a3290: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a32a0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a32b0: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
-000a32c0: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
-000a32d0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a32e0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a32f0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3300: 2c20 302c 2030 2c20 302c 0a20 2020 2030  , 0, 0, 0,.    0
-000a3310: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3320: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3330: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3340: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3350: 2030 2c20 302c 0a20 2020 2030 2c20 302c   0, 0,.    0, 0,
-000a3360: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3370: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3380: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3390: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a33a0: 302c 0a20 2020 2030 2c20 302c 2030 2c20  0,.    0, 0, 0, 
-000a33b0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a33c0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a33d0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a33e0: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
-000a33f0: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
-000a3400: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3410: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3420: 307d 3b0a 7374 6174 6963 5f61 7373 6572  0};.static_asser
-000a3430: 7428 7369 7a65 6f66 2869 735f 666f 7262  t(sizeof(is_forb
-000a3440: 6964 6465 6e5f 686f 7374 5f63 6f64 655f  idden_host_code_
-000a3450: 706f 696e 745f 7461 626c 6529 203d 3d20  point_table) == 
-000a3460: 3235 3629 3b0a 0a61 6461 5f72 6561 6c6c  256);..ada_reall
-000a3470: 795f 696e 6c69 6e65 2063 6f6e 7374 6578  y_inline constex
-000a3480: 7072 2062 6f6f 6c20 6973 5f66 6f72 6269  pr bool is_forbi
-000a3490: 6464 656e 5f68 6f73 745f 636f 6465 5f70  dden_host_code_p
-000a34a0: 6f69 6e74 280a 2020 2020 636f 6e73 7420  oint(.    const 
-000a34b0: 6368 6172 2063 2920 6e6f 6578 6365 7074  char c) noexcept
-000a34c0: 207b 0a20 2072 6574 7572 6e20 6973 5f66   {.  return is_f
-000a34d0: 6f72 6269 6464 656e 5f68 6f73 745f 636f  orbidden_host_co
-000a34e0: 6465 5f70 6f69 6e74 5f74 6162 6c65 5b75  de_point_table[u
-000a34f0: 696e 7438 5f74 2863 295d 3b0a 7d0a 0a73  int8_t(c)];.}..s
-000a3500: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
-000a3510: 636f 6465 3a3a 6973 5f66 6f72 6269 6464  code::is_forbidd
-000a3520: 656e 5f68 6f73 745f 636f 6465 5f70 6f69  en_host_code_poi
-000a3530: 6e74 2827 5c30 2729 293b 0a73 7461 7469  nt('\0'));.stati
-000a3540: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
-000a3550: 3a3a 6973 5f66 6f72 6269 6464 656e 5f68  ::is_forbidden_h
-000a3560: 6f73 745f 636f 6465 5f70 6f69 6e74 2827  ost_code_point('
-000a3570: 5c74 2729 293b 0a73 7461 7469 635f 6173  \t'));.static_as
-000a3580: 7365 7274 2875 6e69 636f 6465 3a3a 6973  sert(unicode::is
-000a3590: 5f66 6f72 6269 6464 656e 5f68 6f73 745f  _forbidden_host_
-000a35a0: 636f 6465 5f70 6f69 6e74 2827 5c6e 2729  code_point('\n')
-000a35b0: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
-000a35c0: 2875 6e69 636f 6465 3a3a 6973 5f66 6f72  (unicode::is_for
-000a35d0: 6269 6464 656e 5f68 6f73 745f 636f 6465  bidden_host_code
-000a35e0: 5f70 6f69 6e74 2827 5c72 2729 293b 0a73  _point('\r'));.s
-000a35f0: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
-000a3600: 636f 6465 3a3a 6973 5f66 6f72 6269 6464  code::is_forbidd
-000a3610: 656e 5f68 6f73 745f 636f 6465 5f70 6f69  en_host_code_poi
-000a3620: 6e74 2827 2027 2929 3b0a 7374 6174 6963  nt(' '));.static
-000a3630: 5f61 7373 6572 7428 756e 6963 6f64 653a  _assert(unicode:
-000a3640: 3a69 735f 666f 7262 6964 6465 6e5f 686f  :is_forbidden_ho
-000a3650: 7374 5f63 6f64 655f 706f 696e 7428 2723  st_code_point('#
-000a3660: 2729 293b 0a73 7461 7469 635f 6173 7365  '));.static_asse
-000a3670: 7274 2875 6e69 636f 6465 3a3a 6973 5f66  rt(unicode::is_f
-000a3680: 6f72 6269 6464 656e 5f68 6f73 745f 636f  orbidden_host_co
-000a3690: 6465 5f70 6f69 6e74 2827 2f27 2929 3b0a  de_point('/'));.
-000a36a0: 7374 6174 6963 5f61 7373 6572 7428 756e  static_assert(un
-000a36b0: 6963 6f64 653a 3a69 735f 666f 7262 6964  icode::is_forbid
-000a36c0: 6465 6e5f 686f 7374 5f63 6f64 655f 706f  den_host_code_po
-000a36d0: 696e 7428 273a 2729 293b 0a73 7461 7469  int(':'));.stati
-000a36e0: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
-000a36f0: 3a3a 6973 5f66 6f72 6269 6464 656e 5f68  ::is_forbidden_h
-000a3700: 6f73 745f 636f 6465 5f70 6f69 6e74 2827  ost_code_point('
-000a3710: 3f27 2929 3b0a 7374 6174 6963 5f61 7373  ?'));.static_ass
-000a3720: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
-000a3730: 666f 7262 6964 6465 6e5f 686f 7374 5f63  forbidden_host_c
-000a3740: 6f64 655f 706f 696e 7428 2740 2729 293b  ode_point('@'));
-000a3750: 0a73 7461 7469 635f 6173 7365 7274 2875  .static_assert(u
-000a3760: 6e69 636f 6465 3a3a 6973 5f66 6f72 6269  nicode::is_forbi
-000a3770: 6464 656e 5f68 6f73 745f 636f 6465 5f70  dden_host_code_p
-000a3780: 6f69 6e74 2827 5b27 2929 3b0a 7374 6174  oint('['));.stat
-000a3790: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
-000a37a0: 653a 3a69 735f 666f 7262 6964 6465 6e5f  e::is_forbidden_
-000a37b0: 686f 7374 5f63 6f64 655f 706f 696e 7428  host_code_point(
-000a37c0: 273f 2729 293b 0a73 7461 7469 635f 6173  '?'));.static_as
-000a37d0: 7365 7274 2875 6e69 636f 6465 3a3a 6973  sert(unicode::is
-000a37e0: 5f66 6f72 6269 6464 656e 5f68 6f73 745f  _forbidden_host_
-000a37f0: 636f 6465 5f70 6f69 6e74 2827 3c27 2929  code_point('<'))
-000a3800: 3b0a 7374 6174 6963 5f61 7373 6572 7428  ;.static_assert(
-000a3810: 756e 6963 6f64 653a 3a69 735f 666f 7262  unicode::is_forb
-000a3820: 6964 6465 6e5f 686f 7374 5f63 6f64 655f  idden_host_code_
-000a3830: 706f 696e 7428 273e 2729 293b 0a73 7461  point('>'));.sta
-000a3840: 7469 635f 6173 7365 7274 2875 6e69 636f  tic_assert(unico
-000a3850: 6465 3a3a 6973 5f66 6f72 6269 6464 656e  de::is_forbidden
-000a3860: 5f68 6f73 745f 636f 6465 5f70 6f69 6e74  _host_code_point
-000a3870: 2827 5c5c 2729 293b 0a73 7461 7469 635f  ('\\'));.static_
-000a3880: 6173 7365 7274 2875 6e69 636f 6465 3a3a  assert(unicode::
-000a3890: 6973 5f66 6f72 6269 6464 656e 5f68 6f73  is_forbidden_hos
-000a38a0: 745f 636f 6465 5f70 6f69 6e74 2827 5d27  t_code_point(']'
-000a38b0: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
-000a38c0: 7428 756e 6963 6f64 653a 3a69 735f 666f  t(unicode::is_fo
-000a38d0: 7262 6964 6465 6e5f 686f 7374 5f63 6f64  rbidden_host_cod
-000a38e0: 655f 706f 696e 7428 275e 2729 293b 0a73  e_point('^'));.s
-000a38f0: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
-000a3900: 636f 6465 3a3a 6973 5f66 6f72 6269 6464  code::is_forbidd
-000a3910: 656e 5f68 6f73 745f 636f 6465 5f70 6f69  en_host_code_poi
-000a3920: 6e74 2827 7c27 2929 3b0a 0a63 6f6e 7374  nt('|'));..const
-000a3930: 6578 7072 2073 7461 7469 6320 7569 6e74  expr static uint
-000a3940: 385f 7420 6973 5f66 6f72 6269 6464 656e  8_t is_forbidden
-000a3950: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
-000a3960: 6e74 5f74 6162 6c65 5b5d 203d 207b 0a20  nt_table[] = {. 
-000a3970: 2020 2031 2c20 312c 2031 2c20 312c 2031     1, 1, 1, 1, 1
-000a3980: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3990: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a39a0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a39b0: 2c20 312c 2031 2c20 312c 0a20 2020 2031  , 1, 1, 1,.    1
-000a39c0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a39d0: 2031 2c20 312c 2031 2c20 302c 2030 2c20   1, 1, 1, 0, 0, 
-000a39e0: 312c 2030 2c20 312c 2030 2c20 302c 2030  1, 0, 1, 0, 0, 0
-000a39f0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3a00: 2030 2c20 312c 0a20 2020 2030 2c20 302c   0, 1,.    0, 0,
-000a3a10: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3a20: 302c 2030 2c20 302c 2031 2c20 302c 2031  0, 0, 0, 1, 0, 1
-000a3a30: 2c20 302c 2031 2c20 312c 2031 2c20 302c  , 0, 1, 1, 1, 0,
-000a3a40: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3a50: 302c 0a20 2020 2030 2c20 302c 2030 2c20  0,.    0, 0, 0, 
-000a3a60: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3a70: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3a80: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3a90: 312c 2031 2c20 312c 2031 2c20 302c 0a20  1, 1, 1, 1, 0,. 
-000a3aa0: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
-000a3ab0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a3ac0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a3ad0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a3ae0: 2c20 302c 2030 2c20 302c 0a20 2020 2030  , 0, 0, 0,.    0
-000a3af0: 2c20 302c 2030 2c20 302c 2031 2c20 302c  , 0, 0, 0, 1, 0,
-000a3b00: 2030 2c20 312c 2031 2c20 312c 2031 2c20   0, 1, 1, 1, 1, 
-000a3b10: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a3b20: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3b30: 2031 2c20 312c 0a20 2020 2031 2c20 312c   1, 1,.    1, 1,
-000a3b40: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a3b50: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a3b60: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3b70: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a3b80: 312c 0a20 2020 2031 2c20 312c 2031 2c20  1,.    1, 1, 1, 
-000a3b90: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a3ba0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3bb0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a3bc0: 312c 2031 2c20 312c 2031 2c20 312c 0a20  1, 1, 1, 1, 1,. 
-000a3bd0: 2020 2031 2c20 312c 2031 2c20 312c 2031     1, 1, 1, 1, 1
-000a3be0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3bf0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a3c00: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a3c10: 2c20 312c 2031 2c20 312c 0a20 2020 2031  , 1, 1, 1,.    1
-000a3c20: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3c30: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a3c40: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a3c50: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a3c60: 2031 2c20 312c 0a20 2020 2031 2c20 312c   1, 1,.    1, 1,
-000a3c70: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a3c80: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a3c90: 2c20 312c 2031 2c20 317d 3b0a 0a73 7461  , 1, 1, 1};..sta
-000a3ca0: 7469 635f 6173 7365 7274 2873 697a 656f  tic_assert(sizeo
-000a3cb0: 6628 6973 5f66 6f72 6269 6464 656e 5f64  f(is_forbidden_d
-000a3cc0: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
-000a3cd0: 5f74 6162 6c65 2920 3d3d 2032 3536 293b  _table) == 256);
-000a3ce0: 0a0a 6164 615f 7265 616c 6c79 5f69 6e6c  ..ada_really_inl
-000a3cf0: 696e 6520 636f 6e73 7465 7870 7220 626f  ine constexpr bo
-000a3d00: 6f6c 2069 735f 666f 7262 6964 6465 6e5f  ol is_forbidden_
-000a3d10: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
-000a3d20: 7428 0a20 2020 2063 6f6e 7374 2063 6861  t(.    const cha
-000a3d30: 7220 6329 206e 6f65 7863 6570 7420 7b0a  r c) noexcept {.
-000a3d40: 2020 7265 7475 726e 2069 735f 666f 7262    return is_forb
-000a3d50: 6964 6465 6e5f 646f 6d61 696e 5f63 6f64  idden_domain_cod
-000a3d60: 655f 706f 696e 745f 7461 626c 655b 7569  e_point_table[ui
-000a3d70: 6e74 385f 7428 6329 5d3b 0a7d 0a0a 6164  nt8_t(c)];.}..ad
-000a3d80: 615f 7265 616c 6c79 5f69 6e6c 696e 6520  a_really_inline 
-000a3d90: 636f 6e73 7465 7870 7220 626f 6f6c 2063  constexpr bool c
-000a3da0: 6f6e 7461 696e 735f 666f 7262 6964 6465  ontains_forbidde
-000a3db0: 6e5f 646f 6d61 696e 5f63 6f64 655f 706f  n_domain_code_po
-000a3dc0: 696e 7428 0a20 2020 2063 6f6e 7374 2063  int(.    const c
-000a3dd0: 6861 722a 2069 6e70 7574 2c20 7369 7a65  har* input, size
-000a3de0: 5f74 206c 656e 6774 6829 206e 6f65 7863  _t length) noexc
-000a3df0: 6570 7420 7b0a 2020 7369 7a65 5f74 2069  ept {.  size_t i
-000a3e00: 203d 2030 3b0a 2020 7569 6e74 385f 7420   = 0;.  uint8_t 
-000a3e10: 6163 6375 6d75 6c61 746f 727b 7d3b 0a20  accumulator{};. 
-000a3e20: 2066 6f72 2028 3b20 6920 2b20 3420 3c3d   for (; i + 4 <=
-000a3e30: 206c 656e 6774 683b 2069 202b 3d20 3429   length; i += 4)
-000a3e40: 207b 0a20 2020 2061 6363 756d 756c 6174   {.    accumulat
-000a3e50: 6f72 207c 3d20 6973 5f66 6f72 6269 6464  or |= is_forbidd
-000a3e60: 656e 5f64 6f6d 6169 6e5f 636f 6465 5f70  en_domain_code_p
-000a3e70: 6f69 6e74 5f74 6162 6c65 5b75 696e 7438  oint_table[uint8
-000a3e80: 5f74 2869 6e70 7574 5b69 5d29 5d3b 0a20  _t(input[i])];. 
-000a3e90: 2020 2061 6363 756d 756c 6174 6f72 207c     accumulator |
-000a3ea0: 3d20 6973 5f66 6f72 6269 6464 656e 5f64  = is_forbidden_d
-000a3eb0: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
-000a3ec0: 5f74 6162 6c65 5b75 696e 7438 5f74 2869  _table[uint8_t(i
-000a3ed0: 6e70 7574 5b69 202b 2031 5d29 5d3b 0a20  nput[i + 1])];. 
-000a3ee0: 2020 2061 6363 756d 756c 6174 6f72 207c     accumulator |
-000a3ef0: 3d20 6973 5f66 6f72 6269 6464 656e 5f64  = is_forbidden_d
-000a3f00: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
-000a3f10: 5f74 6162 6c65 5b75 696e 7438 5f74 2869  _table[uint8_t(i
-000a3f20: 6e70 7574 5b69 202b 2032 5d29 5d3b 0a20  nput[i + 2])];. 
-000a3f30: 2020 2061 6363 756d 756c 6174 6f72 207c     accumulator |
-000a3f40: 3d20 6973 5f66 6f72 6269 6464 656e 5f64  = is_forbidden_d
-000a3f50: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
-000a3f60: 5f74 6162 6c65 5b75 696e 7438 5f74 2869  _table[uint8_t(i
-000a3f70: 6e70 7574 5b69 202b 2033 5d29 5d3b 0a20  nput[i + 3])];. 
-000a3f80: 207d 0a20 2066 6f72 2028 3b20 6920 3c20   }.  for (; i < 
-000a3f90: 6c65 6e67 7468 3b20 692b 2b29 207b 0a20  length; i++) {. 
-000a3fa0: 2020 2061 6363 756d 756c 6174 6f72 207c     accumulator |
-000a3fb0: 3d20 6973 5f66 6f72 6269 6464 656e 5f64  = is_forbidden_d
-000a3fc0: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
-000a3fd0: 5f74 6162 6c65 5b75 696e 7438 5f74 2869  _table[uint8_t(i
-000a3fe0: 6e70 7574 5b69 5d29 5d3b 0a20 207d 0a20  nput[i])];.  }. 
-000a3ff0: 2072 6574 7572 6e20 6163 6375 6d75 6c61   return accumula
-000a4000: 746f 723b 0a7d 0a0a 636f 6e73 7465 7870  tor;.}..constexp
-000a4010: 7220 7374 6174 6963 2075 696e 7438 5f74  r static uint8_t
-000a4020: 2069 735f 666f 7262 6964 6465 6e5f 646f   is_forbidden_do
-000a4030: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
-000a4040: 7461 626c 655f 6f72 5f75 7070 6572 5b5d  table_or_upper[]
-000a4050: 203d 207b 0a20 2020 2031 2c20 312c 2031   = {.    1, 1, 1
-000a4060: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4070: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4080: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4090: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a40a0: 0a20 2020 2031 2c20 312c 2031 2c20 312c  .    1, 1, 1, 1,
-000a40b0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a40c0: 302c 2030 2c20 312c 2030 2c20 312c 2030  0, 0, 1, 0, 1, 0
-000a40d0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a40e0: 2030 2c20 302c 2030 2c20 312c 0a20 2020   0, 0, 0, 1,.   
-000a40f0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4100: 302c 2030 2c20 302c 2030 2c20 302c 2031  0, 0, 0, 0, 0, 1
-000a4110: 2c20 302c 2031 2c20 302c 2031 2c20 312c  , 0, 1, 0, 1, 1,
-000a4120: 2031 2c20 322c 2032 2c20 322c 2032 2c20   1, 2, 2, 2, 2, 
-000a4130: 322c 2032 2c20 322c 0a20 2020 2032 2c20  2, 2, 2,.    2, 
-000a4140: 322c 2032 2c20 322c 2032 2c20 322c 2032  2, 2, 2, 2, 2, 2
-000a4150: 2c20 322c 2032 2c20 322c 2032 2c20 322c  , 2, 2, 2, 2, 2,
-000a4160: 2032 2c20 322c 2032 2c20 322c 2032 2c20   2, 2, 2, 2, 2, 
-000a4170: 322c 2032 2c20 312c 2031 2c20 312c 2031  2, 2, 1, 1, 1, 1
-000a4180: 2c20 302c 0a20 2020 2030 2c20 302c 2030  , 0,.    0, 0, 0
-000a4190: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a41a0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a41b0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a41c0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a41d0: 0a20 2020 2030 2c20 302c 2030 2c20 302c  .    0, 0, 0, 0,
-000a41e0: 2031 2c20 302c 2030 2c20 312c 2031 2c20   1, 0, 0, 1, 1, 
-000a41f0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4200: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4210: 2031 2c20 312c 2031 2c20 312c 0a20 2020   1, 1, 1, 1,.   
-000a4220: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4230: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4240: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4250: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4260: 312c 2031 2c20 312c 0a20 2020 2031 2c20  1, 1, 1,.    1, 
-000a4270: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4280: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4290: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a42a0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a42b0: 2c20 312c 0a20 2020 2031 2c20 312c 2031  , 1,.    1, 1, 1
-000a42c0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a42d0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a42e0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a42f0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4300: 0a20 2020 2031 2c20 312c 2031 2c20 312c  .    1, 1, 1, 1,
-000a4310: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4320: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4330: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4340: 2031 2c20 312c 2031 2c20 312c 0a20 2020   1, 1, 1, 1,.   
-000a4350: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4360: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4370: 2c20 312c 2031 2c20 312c 2031 2c20 317d  , 1, 1, 1, 1, 1}
-000a4380: 3b0a 0a73 7461 7469 635f 6173 7365 7274  ;..static_assert
-000a4390: 2873 697a 656f 6628 6973 5f66 6f72 6269  (sizeof(is_forbi
-000a43a0: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
-000a43b0: 5f70 6f69 6e74 5f74 6162 6c65 5f6f 725f  _point_table_or_
-000a43c0: 7570 7065 7229 203d 3d20 3235 3629 3b0a  upper) == 256);.
-000a43d0: 7374 6174 6963 5f61 7373 6572 7428 6973  static_assert(is
-000a43e0: 5f66 6f72 6269 6464 656e 5f64 6f6d 6169  _forbidden_domai
-000a43f0: 6e5f 636f 6465 5f70 6f69 6e74 5f74 6162  n_code_point_tab
-000a4400: 6c65 5f6f 725f 7570 7065 725b 7569 6e74  le_or_upper[uint
-000a4410: 385f 7428 2741 2729 5d20 3d3d 2032 293b  8_t('A')] == 2);
-000a4420: 0a73 7461 7469 635f 6173 7365 7274 2869  .static_assert(i
-000a4430: 735f 666f 7262 6964 6465 6e5f 646f 6d61  s_forbidden_doma
-000a4440: 696e 5f63 6f64 655f 706f 696e 745f 7461  in_code_point_ta
-000a4450: 626c 655f 6f72 5f75 7070 6572 5b75 696e  ble_or_upper[uin
-000a4460: 7438 5f74 2827 5a27 295d 203d 3d20 3229  t8_t('Z')] == 2)
-000a4470: 3b0a 0a61 6461 5f72 6561 6c6c 795f 696e  ;..ada_really_in
-000a4480: 6c69 6e65 2063 6f6e 7374 6578 7072 2075  line constexpr u
-000a4490: 696e 7438 5f74 0a63 6f6e 7461 696e 735f  int8_t.contains_
-000a44a0: 666f 7262 6964 6465 6e5f 646f 6d61 696e  forbidden_domain
-000a44b0: 5f63 6f64 655f 706f 696e 745f 6f72 5f75  _code_point_or_u
-000a44c0: 7070 6572 2863 6f6e 7374 2063 6861 722a  pper(const char*
-000a44d0: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
+000a2b00: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+000a2b10: 6d6d 5f63 6d70 6571 5f65 7069 3828 776f  mm_cmpeq_epi8(wo
+000a2b20: 7264 2c20 6d61 736b 3229 2929 2c0a 2020  rd, mask2))),.  
+000a2b30: 2020 2020 2020 5f6d 6d5f 636d 7065 715f        _mm_cmpeq_
+000a2b40: 6570 6938 2877 6f72 642c 206d 6173 6b33  epi8(word, mask3
+000a2b50: 2929 3b0a 2020 7d0a 2020 7265 7475 726e  ));.  }.  return
+000a2b60: 205f 6d6d 5f6d 6f76 656d 6173 6b5f 6570   _mm_movemask_ep
+000a2b70: 6938 2872 756e 6e69 6e67 2920 213d 2030  i8(running) != 0
+000a2b80: 3b0a 7d0a 2365 6c73 650a 6164 615f 7265  ;.}.#else.ada_re
+000a2b90: 616c 6c79 5f69 6e6c 696e 6520 626f 6f6c  ally_inline bool
+000a2ba0: 2068 6173 5f74 6162 735f 6f72 5f6e 6577   has_tabs_or_new
+000a2bb0: 6c69 6e65 280a 2020 2020 7374 643a 3a73  line(.    std::s
+000a2bc0: 7472 696e 675f 7669 6577 2075 7365 725f  tring_view user_
+000a2bd0: 696e 7075 7429 206e 6f65 7863 6570 7420  input) noexcept 
+000a2be0: 7b0a 2020 6175 746f 2068 6173 5f7a 6572  {.  auto has_zer
+000a2bf0: 6f5f 6279 7465 203d 205b 5d28 7569 6e74  o_byte = [](uint
+000a2c00: 3634 5f74 2076 2920 7b0a 2020 2020 7265  64_t v) {.    re
+000a2c10: 7475 726e 2028 2876 202d 2030 7830 3130  turn ((v - 0x010
+000a2c20: 3130 3130 3130 3130 3130 3130 3129 2026  1010101010101) &
+000a2c30: 207e 2876 2926 3078 3830 3830 3830 3830   ~(v)&0x80808080
+000a2c40: 3830 3830 3830 3830 293b 0a20 207d 3b0a  80808080);.  };.
+000a2c50: 2020 6175 746f 2062 726f 6164 6361 7374    auto broadcast
+000a2c60: 203d 205b 5d28 7569 6e74 385f 7420 7629   = [](uint8_t v)
+000a2c70: 202d 3e20 7569 6e74 3634 5f74 207b 0a20   -> uint64_t {. 
+000a2c80: 2020 2072 6574 7572 6e20 3078 3130 3130     return 0x1010
+000a2c90: 3130 3130 3130 3130 3130 3175 6c6c 202a  10101010101ull *
+000a2ca0: 2076 3b0a 2020 7d3b 0a20 2073 697a 655f   v;.  };.  size_
+000a2cb0: 7420 6920 3d20 303b 0a20 2075 696e 7436  t i = 0;.  uint6
+000a2cc0: 345f 7420 6d61 736b 3120 3d20 6272 6f61  4_t mask1 = broa
+000a2cd0: 6463 6173 7428 275c 7227 293b 0a20 2075  dcast('\r');.  u
+000a2ce0: 696e 7436 345f 7420 6d61 736b 3220 3d20  int64_t mask2 = 
+000a2cf0: 6272 6f61 6463 6173 7428 275c 6e27 293b  broadcast('\n');
+000a2d00: 0a20 2075 696e 7436 345f 7420 6d61 736b  .  uint64_t mask
+000a2d10: 3320 3d20 6272 6f61 6463 6173 7428 275c  3 = broadcast('\
+000a2d20: 7427 293b 0a20 2075 696e 7436 345f 7420  t');.  uint64_t 
+000a2d30: 7275 6e6e 696e 677b 307d 3b0a 2020 666f  running{0};.  fo
+000a2d40: 7220 283b 2069 202b 2037 203c 2075 7365  r (; i + 7 < use
+000a2d50: 725f 696e 7075 742e 7369 7a65 2829 3b20  r_input.size(); 
+000a2d60: 6920 2b3d 2038 2920 7b0a 2020 2020 7569  i += 8) {.    ui
+000a2d70: 6e74 3634 5f74 2077 6f72 647b 7d3b 0a20  nt64_t word{};. 
+000a2d80: 2020 206d 656d 6370 7928 2677 6f72 642c     memcpy(&word,
+000a2d90: 2075 7365 725f 696e 7075 742e 6461 7461   user_input.data
+000a2da0: 2829 202b 2069 2c20 7369 7a65 6f66 2877  () + i, sizeof(w
+000a2db0: 6f72 6429 293b 0a20 2020 2075 696e 7436  ord));.    uint6
+000a2dc0: 345f 7420 786f 7231 203d 2077 6f72 6420  4_t xor1 = word 
+000a2dd0: 5e20 6d61 736b 313b 0a20 2020 2075 696e  ^ mask1;.    uin
+000a2de0: 7436 345f 7420 786f 7232 203d 2077 6f72  t64_t xor2 = wor
+000a2df0: 6420 5e20 6d61 736b 323b 0a20 2020 2075  d ^ mask2;.    u
+000a2e00: 696e 7436 345f 7420 786f 7233 203d 2077  int64_t xor3 = w
+000a2e10: 6f72 6420 5e20 6d61 736b 333b 0a20 2020  ord ^ mask3;.   
+000a2e20: 2072 756e 6e69 6e67 207c 3d20 6861 735f   running |= has_
+000a2e30: 7a65 726f 5f62 7974 6528 786f 7231 2920  zero_byte(xor1) 
+000a2e40: 7c20 6861 735f 7a65 726f 5f62 7974 6528  | has_zero_byte(
+000a2e50: 786f 7232 2920 7c20 6861 735f 7a65 726f  xor2) | has_zero
+000a2e60: 5f62 7974 6528 786f 7233 293b 0a20 207d  _byte(xor3);.  }
+000a2e70: 0a20 2069 6620 2869 203c 2075 7365 725f  .  if (i < user_
+000a2e80: 696e 7075 742e 7369 7a65 2829 2920 7b0a  input.size()) {.
+000a2e90: 2020 2020 7569 6e74 3634 5f74 2077 6f72      uint64_t wor
+000a2ea0: 647b 7d3b 0a20 2020 206d 656d 6370 7928  d{};.    memcpy(
+000a2eb0: 2677 6f72 642c 2075 7365 725f 696e 7075  &word, user_inpu
+000a2ec0: 742e 6461 7461 2829 202b 2069 2c20 7573  t.data() + i, us
+000a2ed0: 6572 5f69 6e70 7574 2e73 697a 6528 2920  er_input.size() 
+000a2ee0: 2d20 6929 3b0a 2020 2020 7569 6e74 3634  - i);.    uint64
+000a2ef0: 5f74 2078 6f72 3120 3d20 776f 7264 205e  _t xor1 = word ^
+000a2f00: 206d 6173 6b31 3b0a 2020 2020 7569 6e74   mask1;.    uint
+000a2f10: 3634 5f74 2078 6f72 3220 3d20 776f 7264  64_t xor2 = word
+000a2f20: 205e 206d 6173 6b32 3b0a 2020 2020 7569   ^ mask2;.    ui
+000a2f30: 6e74 3634 5f74 2078 6f72 3320 3d20 776f  nt64_t xor3 = wo
+000a2f40: 7264 205e 206d 6173 6b33 3b0a 2020 2020  rd ^ mask3;.    
+000a2f50: 7275 6e6e 696e 6720 7c3d 2068 6173 5f7a  running |= has_z
+000a2f60: 6572 6f5f 6279 7465 2878 6f72 3129 207c  ero_byte(xor1) |
+000a2f70: 2068 6173 5f7a 6572 6f5f 6279 7465 2878   has_zero_byte(x
+000a2f80: 6f72 3229 207c 2068 6173 5f7a 6572 6f5f  or2) | has_zero_
+000a2f90: 6279 7465 2878 6f72 3329 3b0a 2020 7d0a  byte(xor3);.  }.
+000a2fa0: 2020 7265 7475 726e 2072 756e 6e69 6e67    return running
+000a2fb0: 3b0a 7d0a 2365 6e64 6966 0a0a 2f2f 2041  ;.}.#endif..// A
+000a2fc0: 2066 6f72 6269 6464 656e 2068 6f73 7420   forbidden host 
+000a2fd0: 636f 6465 2070 6f69 6e74 2069 7320 552b  code point is U+
+000a2fe0: 3030 3030 204e 554c 4c2c 2055 2b30 3030  0000 NULL, U+000
+000a2ff0: 3920 5441 422c 2055 2b30 3030 4120 4c46  9 TAB, U+000A LF
+000a3000: 2c20 552b 3030 3044 2043 522c 0a2f 2f20  , U+000D CR,.// 
+000a3010: 552b 3030 3230 2053 5041 4345 2c20 552b  U+0020 SPACE, U+
+000a3020: 3030 3233 2028 2329 2c20 552b 3030 3246  0023 (#), U+002F
+000a3030: 2028 2f29 2c20 552b 3030 3341 2028 3a29   (/), U+003A (:)
+000a3040: 2c20 552b 3030 3343 2028 3c29 2c20 552b  , U+003C (<), U+
+000a3050: 3030 3345 2028 3e29 2c0a 2f2f 2055 2b30  003E (>),.// U+0
+000a3060: 3033 4620 283f 292c 2055 2b30 3034 3020  03F (?), U+0040 
+000a3070: 2840 292c 2055 2b30 3035 4220 285b 292c  (@), U+005B ([),
+000a3080: 2055 2b30 3035 4320 285c 292c 2055 2b30   U+005C (\), U+0
+000a3090: 3035 4420 285d 292c 2055 2b30 3035 4520  05D (]), U+005E 
+000a30a0: 285e 292c 206f 720a 2f2f 2055 2b30 3037  (^), or.// U+007
+000a30b0: 4320 287c 292e 0a63 6f6e 7374 6578 7072  C (|)..constexpr
+000a30c0: 2073 7461 7469 6320 626f 6f6c 2069 735f   static bool is_
+000a30d0: 666f 7262 6964 6465 6e5f 686f 7374 5f63  forbidden_host_c
+000a30e0: 6f64 655f 706f 696e 745f 7461 626c 655b  ode_point_table[
+000a30f0: 5d20 3d20 7b0a 2020 2020 312c 2030 2c20  ] = {.    1, 0, 
+000a3100: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3110: 2c20 302c 2031 2c20 312c 2030 2c20 302c  , 0, 1, 1, 0, 0,
+000a3120: 2031 2c20 302c 2030 2c20 302c 2030 2c20   1, 0, 0, 0, 0, 
+000a3130: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3140: 2c0a 2020 2020 302c 2030 2c20 302c 2030  ,.    0, 0, 0, 0
+000a3150: 2c20 302c 2030 2c20 302c 2030 2c20 312c  , 0, 0, 0, 0, 1,
+000a3160: 2030 2c20 302c 2031 2c20 302c 2030 2c20   0, 0, 1, 0, 0, 
+000a3170: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3180: 2c20 302c 2030 2c20 302c 2031 2c0a 2020  , 0, 0, 0, 1,.  
+000a3190: 2020 302c 2030 2c20 302c 2030 2c20 302c    0, 0, 0, 0, 0,
+000a31a0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a31b0: 312c 2030 2c20 312c 2030 2c20 312c 2031  1, 0, 1, 0, 1, 1
+000a31c0: 2c20 312c 2030 2c20 302c 2030 2c20 302c  , 1, 0, 0, 0, 0,
+000a31d0: 2030 2c20 302c 2030 2c0a 2020 2020 302c   0, 0, 0,.    0,
+000a31e0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a31f0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3200: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3210: 2030 2c20 302c 2031 2c20 312c 2031 2c20   0, 0, 1, 1, 1, 
+000a3220: 312c 2030 2c0a 2020 2020 302c 2030 2c20  1, 0,.    0, 0, 
+000a3230: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3240: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3250: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3260: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3270: 2c0a 2020 2020 302c 2030 2c20 302c 2030  ,.    0, 0, 0, 0
+000a3280: 2c20 312c 2030 2c20 302c 2030 2c20 302c  , 1, 0, 0, 0, 0,
+000a3290: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a32a0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a32b0: 2c20 302c 2030 2c20 302c 2030 2c0a 2020  , 0, 0, 0, 0,.  
+000a32c0: 2020 302c 2030 2c20 302c 2030 2c20 302c    0, 0, 0, 0, 0,
+000a32d0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a32e0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a32f0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3300: 2030 2c20 302c 2030 2c0a 2020 2020 302c   0, 0, 0,.    0,
+000a3310: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3320: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3330: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3340: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3350: 302c 2030 2c0a 2020 2020 302c 2030 2c20  0, 0,.    0, 0, 
+000a3360: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3370: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3380: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3390: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a33a0: 2c0a 2020 2020 302c 2030 2c20 302c 2030  ,.    0, 0, 0, 0
+000a33b0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a33c0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a33d0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a33e0: 2c20 302c 2030 2c20 302c 2030 2c0a 2020  , 0, 0, 0, 0,.  
+000a33f0: 2020 302c 2030 2c20 302c 2030 2c20 302c    0, 0, 0, 0, 0,
+000a3400: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3410: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3420: 7d3b 0a73 7461 7469 635f 6173 7365 7274  };.static_assert
+000a3430: 2873 697a 656f 6628 6973 5f66 6f72 6269  (sizeof(is_forbi
+000a3440: 6464 656e 5f68 6f73 745f 636f 6465 5f70  dden_host_code_p
+000a3450: 6f69 6e74 5f74 6162 6c65 2920 3d3d 2032  oint_table) == 2
+000a3460: 3536 293b 0a0a 6164 615f 7265 616c 6c79  56);..ada_really
+000a3470: 5f69 6e6c 696e 6520 636f 6e73 7465 7870  _inline constexp
+000a3480: 7220 626f 6f6c 2069 735f 666f 7262 6964  r bool is_forbid
+000a3490: 6465 6e5f 686f 7374 5f63 6f64 655f 706f  den_host_code_po
+000a34a0: 696e 7428 0a20 2020 2063 6f6e 7374 2063  int(.    const c
+000a34b0: 6861 7220 6329 206e 6f65 7863 6570 7420  har c) noexcept 
+000a34c0: 7b0a 2020 7265 7475 726e 2069 735f 666f  {.  return is_fo
+000a34d0: 7262 6964 6465 6e5f 686f 7374 5f63 6f64  rbidden_host_cod
+000a34e0: 655f 706f 696e 745f 7461 626c 655b 7569  e_point_table[ui
+000a34f0: 6e74 385f 7428 6329 5d3b 0a7d 0a0a 7374  nt8_t(c)];.}..st
+000a3500: 6174 6963 5f61 7373 6572 7428 756e 6963  atic_assert(unic
+000a3510: 6f64 653a 3a69 735f 666f 7262 6964 6465  ode::is_forbidde
+000a3520: 6e5f 686f 7374 5f63 6f64 655f 706f 696e  n_host_code_poin
+000a3530: 7428 275c 3027 2929 3b0a 7374 6174 6963  t('\0'));.static
+000a3540: 5f61 7373 6572 7428 756e 6963 6f64 653a  _assert(unicode:
+000a3550: 3a69 735f 666f 7262 6964 6465 6e5f 686f  :is_forbidden_ho
+000a3560: 7374 5f63 6f64 655f 706f 696e 7428 275c  st_code_point('\
+000a3570: 7427 2929 3b0a 7374 6174 6963 5f61 7373  t'));.static_ass
+000a3580: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
+000a3590: 666f 7262 6964 6465 6e5f 686f 7374 5f63  forbidden_host_c
+000a35a0: 6f64 655f 706f 696e 7428 275c 6e27 2929  ode_point('\n'))
+000a35b0: 3b0a 7374 6174 6963 5f61 7373 6572 7428  ;.static_assert(
+000a35c0: 756e 6963 6f64 653a 3a69 735f 666f 7262  unicode::is_forb
+000a35d0: 6964 6465 6e5f 686f 7374 5f63 6f64 655f  idden_host_code_
+000a35e0: 706f 696e 7428 275c 7227 2929 3b0a 7374  point('\r'));.st
+000a35f0: 6174 6963 5f61 7373 6572 7428 756e 6963  atic_assert(unic
+000a3600: 6f64 653a 3a69 735f 666f 7262 6964 6465  ode::is_forbidde
+000a3610: 6e5f 686f 7374 5f63 6f64 655f 706f 696e  n_host_code_poin
+000a3620: 7428 2720 2729 293b 0a73 7461 7469 635f  t(' '));.static_
+000a3630: 6173 7365 7274 2875 6e69 636f 6465 3a3a  assert(unicode::
+000a3640: 6973 5f66 6f72 6269 6464 656e 5f68 6f73  is_forbidden_hos
+000a3650: 745f 636f 6465 5f70 6f69 6e74 2827 2327  t_code_point('#'
+000a3660: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
+000a3670: 7428 756e 6963 6f64 653a 3a69 735f 666f  t(unicode::is_fo
+000a3680: 7262 6964 6465 6e5f 686f 7374 5f63 6f64  rbidden_host_cod
+000a3690: 655f 706f 696e 7428 272f 2729 293b 0a73  e_point('/'));.s
+000a36a0: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
+000a36b0: 636f 6465 3a3a 6973 5f66 6f72 6269 6464  code::is_forbidd
+000a36c0: 656e 5f68 6f73 745f 636f 6465 5f70 6f69  en_host_code_poi
+000a36d0: 6e74 2827 3a27 2929 3b0a 7374 6174 6963  nt(':'));.static
+000a36e0: 5f61 7373 6572 7428 756e 6963 6f64 653a  _assert(unicode:
+000a36f0: 3a69 735f 666f 7262 6964 6465 6e5f 686f  :is_forbidden_ho
+000a3700: 7374 5f63 6f64 655f 706f 696e 7428 273f  st_code_point('?
+000a3710: 2729 293b 0a73 7461 7469 635f 6173 7365  '));.static_asse
+000a3720: 7274 2875 6e69 636f 6465 3a3a 6973 5f66  rt(unicode::is_f
+000a3730: 6f72 6269 6464 656e 5f68 6f73 745f 636f  orbidden_host_co
+000a3740: 6465 5f70 6f69 6e74 2827 4027 2929 3b0a  de_point('@'));.
+000a3750: 7374 6174 6963 5f61 7373 6572 7428 756e  static_assert(un
+000a3760: 6963 6f64 653a 3a69 735f 666f 7262 6964  icode::is_forbid
+000a3770: 6465 6e5f 686f 7374 5f63 6f64 655f 706f  den_host_code_po
+000a3780: 696e 7428 275b 2729 293b 0a73 7461 7469  int('['));.stati
+000a3790: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
+000a37a0: 3a3a 6973 5f66 6f72 6269 6464 656e 5f68  ::is_forbidden_h
+000a37b0: 6f73 745f 636f 6465 5f70 6f69 6e74 2827  ost_code_point('
+000a37c0: 3f27 2929 3b0a 7374 6174 6963 5f61 7373  ?'));.static_ass
+000a37d0: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
+000a37e0: 666f 7262 6964 6465 6e5f 686f 7374 5f63  forbidden_host_c
+000a37f0: 6f64 655f 706f 696e 7428 273c 2729 293b  ode_point('<'));
+000a3800: 0a73 7461 7469 635f 6173 7365 7274 2875  .static_assert(u
+000a3810: 6e69 636f 6465 3a3a 6973 5f66 6f72 6269  nicode::is_forbi
+000a3820: 6464 656e 5f68 6f73 745f 636f 6465 5f70  dden_host_code_p
+000a3830: 6f69 6e74 2827 3e27 2929 3b0a 7374 6174  oint('>'));.stat
+000a3840: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
+000a3850: 653a 3a69 735f 666f 7262 6964 6465 6e5f  e::is_forbidden_
+000a3860: 686f 7374 5f63 6f64 655f 706f 696e 7428  host_code_point(
+000a3870: 275c 5c27 2929 3b0a 7374 6174 6963 5f61  '\\'));.static_a
+000a3880: 7373 6572 7428 756e 6963 6f64 653a 3a69  ssert(unicode::i
+000a3890: 735f 666f 7262 6964 6465 6e5f 686f 7374  s_forbidden_host
+000a38a0: 5f63 6f64 655f 706f 696e 7428 275d 2729  _code_point(']')
+000a38b0: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
+000a38c0: 2875 6e69 636f 6465 3a3a 6973 5f66 6f72  (unicode::is_for
+000a38d0: 6269 6464 656e 5f68 6f73 745f 636f 6465  bidden_host_code
+000a38e0: 5f70 6f69 6e74 2827 5e27 2929 3b0a 7374  _point('^'));.st
+000a38f0: 6174 6963 5f61 7373 6572 7428 756e 6963  atic_assert(unic
+000a3900: 6f64 653a 3a69 735f 666f 7262 6964 6465  ode::is_forbidde
+000a3910: 6e5f 686f 7374 5f63 6f64 655f 706f 696e  n_host_code_poin
+000a3920: 7428 277c 2729 293b 0a0a 636f 6e73 7465  t('|'));..conste
+000a3930: 7870 7220 7374 6174 6963 2075 696e 7438  xpr static uint8
+000a3940: 5f74 2069 735f 666f 7262 6964 6465 6e5f  _t is_forbidden_
+000a3950: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
+000a3960: 745f 7461 626c 655b 5d20 3d20 7b0a 2020  t_table[] = {.  
+000a3970: 2020 312c 2031 2c20 312c 2031 2c20 312c    1, 1, 1, 1, 1,
+000a3980: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3990: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a39a0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a39b0: 2031 2c20 312c 2031 2c0a 2020 2020 312c   1, 1, 1,.    1,
+000a39c0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a39d0: 312c 2031 2c20 312c 2030 2c20 302c 2031  1, 1, 1, 0, 0, 1
+000a39e0: 2c20 302c 2031 2c20 302c 2030 2c20 302c  , 0, 1, 0, 0, 0,
+000a39f0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3a00: 302c 2031 2c0a 2020 2020 302c 2030 2c20  0, 1,.    0, 0, 
+000a3a10: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3a20: 2c20 302c 2030 2c20 312c 2030 2c20 312c  , 0, 0, 1, 0, 1,
+000a3a30: 2030 2c20 312c 2031 2c20 312c 2030 2c20   0, 1, 1, 1, 0, 
+000a3a40: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3a50: 2c0a 2020 2020 302c 2030 2c20 302c 2030  ,.    0, 0, 0, 0
+000a3a60: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3a70: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3a80: 302c 2030 2c20 302c 2030 2c20 302c 2031  0, 0, 0, 0, 0, 1
+000a3a90: 2c20 312c 2031 2c20 312c 2030 2c0a 2020  , 1, 1, 1, 0,.  
+000a3aa0: 2020 302c 2030 2c20 302c 2030 2c20 302c    0, 0, 0, 0, 0,
+000a3ab0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a3ac0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a3ad0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a3ae0: 2030 2c20 302c 2030 2c0a 2020 2020 302c   0, 0, 0,.    0,
+000a3af0: 2030 2c20 302c 2030 2c20 312c 2030 2c20   0, 0, 0, 1, 0, 
+000a3b00: 302c 2031 2c20 312c 2031 2c20 312c 2031  0, 1, 1, 1, 1, 1
+000a3b10: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a3b20: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3b30: 312c 2031 2c0a 2020 2020 312c 2031 2c20  1, 1,.    1, 1, 
+000a3b40: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a3b50: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a3b60: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3b70: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a3b80: 2c0a 2020 2020 312c 2031 2c20 312c 2031  ,.    1, 1, 1, 1
+000a3b90: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a3ba0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3bb0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a3bc0: 2c20 312c 2031 2c20 312c 2031 2c0a 2020  , 1, 1, 1, 1,.  
+000a3bd0: 2020 312c 2031 2c20 312c 2031 2c20 312c    1, 1, 1, 1, 1,
+000a3be0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3bf0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a3c00: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a3c10: 2031 2c20 312c 2031 2c0a 2020 2020 312c   1, 1, 1,.    1,
+000a3c20: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3c30: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a3c40: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a3c50: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a3c60: 312c 2031 2c0a 2020 2020 312c 2031 2c20  1, 1,.    1, 1, 
+000a3c70: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a3c80: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a3c90: 2031 2c20 312c 2031 7d3b 0a0a 7374 6174   1, 1, 1};..stat
+000a3ca0: 6963 5f61 7373 6572 7428 7369 7a65 6f66  ic_assert(sizeof
+000a3cb0: 2869 735f 666f 7262 6964 6465 6e5f 646f  (is_forbidden_do
+000a3cc0: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
+000a3cd0: 7461 626c 6529 203d 3d20 3235 3629 3b0a  table) == 256);.
+000a3ce0: 0a61 6461 5f72 6561 6c6c 795f 696e 6c69  .ada_really_inli
+000a3cf0: 6e65 2063 6f6e 7374 6578 7072 2062 6f6f  ne constexpr boo
+000a3d00: 6c20 6973 5f66 6f72 6269 6464 656e 5f64  l is_forbidden_d
+000a3d10: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
+000a3d20: 280a 2020 2020 636f 6e73 7420 6368 6172  (.    const char
+000a3d30: 2063 2920 6e6f 6578 6365 7074 207b 0a20   c) noexcept {. 
+000a3d40: 2072 6574 7572 6e20 6973 5f66 6f72 6269   return is_forbi
+000a3d50: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
+000a3d60: 5f70 6f69 6e74 5f74 6162 6c65 5b75 696e  _point_table[uin
+000a3d70: 7438 5f74 2863 295d 3b0a 7d0a 0a61 6461  t8_t(c)];.}..ada
+000a3d80: 5f72 6561 6c6c 795f 696e 6c69 6e65 2063  _really_inline c
+000a3d90: 6f6e 7374 6578 7072 2062 6f6f 6c20 636f  onstexpr bool co
+000a3da0: 6e74 6169 6e73 5f66 6f72 6269 6464 656e  ntains_forbidden
+000a3db0: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
+000a3dc0: 6e74 280a 2020 2020 636f 6e73 7420 6368  nt(.    const ch
+000a3dd0: 6172 2a20 696e 7075 742c 2073 697a 655f  ar* input, size_
+000a3de0: 7420 6c65 6e67 7468 2920 6e6f 6578 6365  t length) noexce
+000a3df0: 7074 207b 0a20 2073 697a 655f 7420 6920  pt {.  size_t i 
+000a3e00: 3d20 303b 0a20 2075 696e 7438 5f74 2061  = 0;.  uint8_t a
+000a3e10: 6363 756d 756c 6174 6f72 7b7d 3b0a 2020  ccumulator{};.  
+000a3e20: 666f 7220 283b 2069 202b 2034 203c 3d20  for (; i + 4 <= 
+000a3e30: 6c65 6e67 7468 3b20 6920 2b3d 2034 2920  length; i += 4) 
+000a3e40: 7b0a 2020 2020 6163 6375 6d75 6c61 746f  {.    accumulato
+000a3e50: 7220 7c3d 2069 735f 666f 7262 6964 6465  r |= is_forbidde
+000a3e60: 6e5f 646f 6d61 696e 5f63 6f64 655f 706f  n_domain_code_po
+000a3e70: 696e 745f 7461 626c 655b 7569 6e74 385f  int_table[uint8_
+000a3e80: 7428 696e 7075 745b 695d 295d 3b0a 2020  t(input[i])];.  
+000a3e90: 2020 6163 6375 6d75 6c61 746f 7220 7c3d    accumulator |=
+000a3ea0: 2069 735f 666f 7262 6964 6465 6e5f 646f   is_forbidden_do
+000a3eb0: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
+000a3ec0: 7461 626c 655b 7569 6e74 385f 7428 696e  table[uint8_t(in
+000a3ed0: 7075 745b 6920 2b20 315d 295d 3b0a 2020  put[i + 1])];.  
+000a3ee0: 2020 6163 6375 6d75 6c61 746f 7220 7c3d    accumulator |=
+000a3ef0: 2069 735f 666f 7262 6964 6465 6e5f 646f   is_forbidden_do
+000a3f00: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
+000a3f10: 7461 626c 655b 7569 6e74 385f 7428 696e  table[uint8_t(in
+000a3f20: 7075 745b 6920 2b20 325d 295d 3b0a 2020  put[i + 2])];.  
+000a3f30: 2020 6163 6375 6d75 6c61 746f 7220 7c3d    accumulator |=
+000a3f40: 2069 735f 666f 7262 6964 6465 6e5f 646f   is_forbidden_do
+000a3f50: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
+000a3f60: 7461 626c 655b 7569 6e74 385f 7428 696e  table[uint8_t(in
+000a3f70: 7075 745b 6920 2b20 335d 295d 3b0a 2020  put[i + 3])];.  
+000a3f80: 7d0a 2020 666f 7220 283b 2069 203c 206c  }.  for (; i < l
+000a3f90: 656e 6774 683b 2069 2b2b 2920 7b0a 2020  ength; i++) {.  
+000a3fa0: 2020 6163 6375 6d75 6c61 746f 7220 7c3d    accumulator |=
+000a3fb0: 2069 735f 666f 7262 6964 6465 6e5f 646f   is_forbidden_do
+000a3fc0: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
+000a3fd0: 7461 626c 655b 7569 6e74 385f 7428 696e  table[uint8_t(in
+000a3fe0: 7075 745b 695d 295d 3b0a 2020 7d0a 2020  put[i])];.  }.  
+000a3ff0: 7265 7475 726e 2061 6363 756d 756c 6174  return accumulat
+000a4000: 6f72 3b0a 7d0a 0a63 6f6e 7374 6578 7072  or;.}..constexpr
+000a4010: 2073 7461 7469 6320 7569 6e74 385f 7420   static uint8_t 
+000a4020: 6973 5f66 6f72 6269 6464 656e 5f64 6f6d  is_forbidden_dom
+000a4030: 6169 6e5f 636f 6465 5f70 6f69 6e74 5f74  ain_code_point_t
+000a4040: 6162 6c65 5f6f 725f 7570 7065 725b 5d20  able_or_upper[] 
+000a4050: 3d20 7b0a 2020 2020 312c 2031 2c20 312c  = {.    1, 1, 1,
+000a4060: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4070: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4080: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4090: 2031 2c20 312c 2031 2c20 312c 2031 2c0a   1, 1, 1, 1, 1,.
+000a40a0: 2020 2020 312c 2031 2c20 312c 2031 2c20      1, 1, 1, 1, 
+000a40b0: 312c 2031 2c20 312c 2031 2c20 312c 2030  1, 1, 1, 1, 1, 0
+000a40c0: 2c20 302c 2031 2c20 302c 2031 2c20 302c  , 0, 1, 0, 1, 0,
+000a40d0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a40e0: 302c 2030 2c20 302c 2031 2c0a 2020 2020  0, 0, 0, 1,.    
+000a40f0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4100: 2c20 302c 2030 2c20 302c 2030 2c20 312c  , 0, 0, 0, 0, 1,
+000a4110: 2030 2c20 312c 2030 2c20 312c 2031 2c20   0, 1, 0, 1, 1, 
+000a4120: 312c 2032 2c20 322c 2032 2c20 322c 2032  1, 2, 2, 2, 2, 2
+000a4130: 2c20 322c 2032 2c0a 2020 2020 322c 2032  , 2, 2,.    2, 2
+000a4140: 2c20 322c 2032 2c20 322c 2032 2c20 322c  , 2, 2, 2, 2, 2,
+000a4150: 2032 2c20 322c 2032 2c20 322c 2032 2c20   2, 2, 2, 2, 2, 
+000a4160: 322c 2032 2c20 322c 2032 2c20 322c 2032  2, 2, 2, 2, 2, 2
+000a4170: 2c20 322c 2031 2c20 312c 2031 2c20 312c  , 2, 1, 1, 1, 1,
+000a4180: 2030 2c0a 2020 2020 302c 2030 2c20 302c   0,.    0, 0, 0,
+000a4190: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a41a0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a41b0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a41c0: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
+000a41d0: 2020 2020 302c 2030 2c20 302c 2030 2c20      0, 0, 0, 0, 
+000a41e0: 312c 2030 2c20 302c 2031 2c20 312c 2031  1, 0, 0, 1, 1, 1
+000a41f0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4200: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4210: 312c 2031 2c20 312c 2031 2c0a 2020 2020  1, 1, 1, 1,.    
+000a4220: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4230: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4240: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4250: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4260: 2c20 312c 2031 2c0a 2020 2020 312c 2031  , 1, 1,.    1, 1
+000a4270: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4280: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4290: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a42a0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a42b0: 2031 2c0a 2020 2020 312c 2031 2c20 312c   1,.    1, 1, 1,
+000a42c0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a42d0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a42e0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a42f0: 2031 2c20 312c 2031 2c20 312c 2031 2c0a   1, 1, 1, 1, 1,.
+000a4300: 2020 2020 312c 2031 2c20 312c 2031 2c20      1, 1, 1, 1, 
+000a4310: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4320: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4330: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4340: 312c 2031 2c20 312c 2031 2c0a 2020 2020  1, 1, 1, 1,.    
+000a4350: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4360: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4370: 2031 2c20 312c 2031 2c20 312c 2031 7d3b   1, 1, 1, 1, 1};
+000a4380: 0a0a 7374 6174 6963 5f61 7373 6572 7428  ..static_assert(
+000a4390: 7369 7a65 6f66 2869 735f 666f 7262 6964  sizeof(is_forbid
+000a43a0: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
+000a43b0: 706f 696e 745f 7461 626c 655f 6f72 5f75  point_table_or_u
+000a43c0: 7070 6572 2920 3d3d 2032 3536 293b 0a73  pper) == 256);.s
+000a43d0: 7461 7469 635f 6173 7365 7274 2869 735f  tatic_assert(is_
+000a43e0: 666f 7262 6964 6465 6e5f 646f 6d61 696e  forbidden_domain
+000a43f0: 5f63 6f64 655f 706f 696e 745f 7461 626c  _code_point_tabl
+000a4400: 655f 6f72 5f75 7070 6572 5b75 696e 7438  e_or_upper[uint8
+000a4410: 5f74 2827 4127 295d 203d 3d20 3229 3b0a  _t('A')] == 2);.
+000a4420: 7374 6174 6963 5f61 7373 6572 7428 6973  static_assert(is
+000a4430: 5f66 6f72 6269 6464 656e 5f64 6f6d 6169  _forbidden_domai
+000a4440: 6e5f 636f 6465 5f70 6f69 6e74 5f74 6162  n_code_point_tab
+000a4450: 6c65 5f6f 725f 7570 7065 725b 7569 6e74  le_or_upper[uint
+000a4460: 385f 7428 275a 2729 5d20 3d3d 2032 293b  8_t('Z')] == 2);
+000a4470: 0a0a 6164 615f 7265 616c 6c79 5f69 6e6c  ..ada_really_inl
+000a4480: 696e 6520 636f 6e73 7465 7870 7220 7569  ine constexpr ui
+000a4490: 6e74 385f 740a 636f 6e74 6169 6e73 5f66  nt8_t.contains_f
+000a44a0: 6f72 6269 6464 656e 5f64 6f6d 6169 6e5f  orbidden_domain_
+000a44b0: 636f 6465 5f70 6f69 6e74 5f6f 725f 7570  code_point_or_up
+000a44c0: 7065 7228 636f 6e73 7420 6368 6172 2a20  per(const char* 
+000a44d0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
 000a44e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a44f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a4500: 2020 2020 2020 7369 7a65 5f74 206c 656e        size_t len
-000a4510: 6774 6829 206e 6f65 7863 6570 7420 7b0a  gth) noexcept {.
-000a4520: 2020 7369 7a65 5f74 2069 203d 2030 3b0a    size_t i = 0;.
-000a4530: 2020 7569 6e74 385f 7420 6163 6375 6d75    uint8_t accumu
-000a4540: 6c61 746f 727b 7d3b 0a20 2066 6f72 2028  lator{};.  for (
-000a4550: 3b20 6920 2b20 3420 3c3d 206c 656e 6774  ; i + 4 <= lengt
-000a4560: 683b 2069 202b 3d20 3429 207b 0a20 2020  h; i += 4) {.   
-000a4570: 2061 6363 756d 756c 6174 6f72 207c 3d0a   accumulator |=.
-000a4580: 2020 2020 2020 2020 6973 5f66 6f72 6269          is_forbi
-000a4590: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
-000a45a0: 5f70 6f69 6e74 5f74 6162 6c65 5f6f 725f  _point_table_or_
-000a45b0: 7570 7065 725b 7569 6e74 385f 7428 696e  upper[uint8_t(in
-000a45c0: 7075 745b 695d 295d 3b0a 2020 2020 6163  put[i])];.    ac
-000a45d0: 6375 6d75 6c61 746f 7220 7c3d 0a20 2020  cumulator |=.   
-000a45e0: 2020 2020 2069 735f 666f 7262 6964 6465       is_forbidde
-000a45f0: 6e5f 646f 6d61 696e 5f63 6f64 655f 706f  n_domain_code_po
-000a4600: 696e 745f 7461 626c 655f 6f72 5f75 7070  int_table_or_upp
-000a4610: 6572 5b75 696e 7438 5f74 2869 6e70 7574  er[uint8_t(input
-000a4620: 5b69 202b 2031 5d29 5d3b 0a20 2020 2061  [i + 1])];.    a
-000a4630: 6363 756d 756c 6174 6f72 207c 3d0a 2020  ccumulator |=.  
-000a4640: 2020 2020 2020 6973 5f66 6f72 6269 6464        is_forbidd
-000a4650: 656e 5f64 6f6d 6169 6e5f 636f 6465 5f70  en_domain_code_p
-000a4660: 6f69 6e74 5f74 6162 6c65 5f6f 725f 7570  oint_table_or_up
-000a4670: 7065 725b 7569 6e74 385f 7428 696e 7075  per[uint8_t(inpu
-000a4680: 745b 6920 2b20 325d 295d 3b0a 2020 2020  t[i + 2])];.    
-000a4690: 6163 6375 6d75 6c61 746f 7220 7c3d 0a20  accumulator |=. 
-000a46a0: 2020 2020 2020 2069 735f 666f 7262 6964         is_forbid
-000a46b0: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
-000a46c0: 706f 696e 745f 7461 626c 655f 6f72 5f75  point_table_or_u
-000a46d0: 7070 6572 5b75 696e 7438 5f74 2869 6e70  pper[uint8_t(inp
-000a46e0: 7574 5b69 202b 2033 5d29 5d3b 0a20 207d  ut[i + 3])];.  }
-000a46f0: 0a20 2066 6f72 2028 3b20 6920 3c20 6c65  .  for (; i < le
-000a4700: 6e67 7468 3b20 692b 2b29 207b 0a20 2020  ngth; i++) {.   
-000a4710: 2061 6363 756d 756c 6174 6f72 207c 3d0a   accumulator |=.
-000a4720: 2020 2020 2020 2020 6973 5f66 6f72 6269          is_forbi
-000a4730: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
-000a4740: 5f70 6f69 6e74 5f74 6162 6c65 5f6f 725f  _point_table_or_
-000a4750: 7570 7065 725b 7569 6e74 385f 7428 696e  upper[uint8_t(in
-000a4760: 7075 745b 695d 295d 3b0a 2020 7d0a 2020  put[i])];.  }.  
-000a4770: 7265 7475 726e 2061 6363 756d 756c 6174  return accumulat
-000a4780: 6f72 3b0a 7d0a 0a73 7461 7469 635f 6173  or;.}..static_as
-000a4790: 7365 7274 2875 6e69 636f 6465 3a3a 6973  sert(unicode::is
-000a47a0: 5f66 6f72 6269 6464 656e 5f64 6f6d 6169  _forbidden_domai
-000a47b0: 6e5f 636f 6465 5f70 6f69 6e74 2827 2527  n_code_point('%'
-000a47c0: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
-000a47d0: 7428 756e 6963 6f64 653a 3a69 735f 666f  t(unicode::is_fo
-000a47e0: 7262 6964 6465 6e5f 646f 6d61 696e 5f63  rbidden_domain_c
-000a47f0: 6f64 655f 706f 696e 7428 275c 7837 6627  ode_point('\x7f'
-000a4800: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
-000a4810: 7428 756e 6963 6f64 653a 3a69 735f 666f  t(unicode::is_fo
-000a4820: 7262 6964 6465 6e5f 646f 6d61 696e 5f63  rbidden_domain_c
-000a4830: 6f64 655f 706f 696e 7428 275c 3027 2929  ode_point('\0'))
-000a4840: 3b0a 7374 6174 6963 5f61 7373 6572 7428  ;.static_assert(
-000a4850: 756e 6963 6f64 653a 3a69 735f 666f 7262  unicode::is_forb
-000a4860: 6964 6465 6e5f 646f 6d61 696e 5f63 6f64  idden_domain_cod
-000a4870: 655f 706f 696e 7428 275c 7427 2929 3b0a  e_point('\t'));.
-000a4880: 7374 6174 6963 5f61 7373 6572 7428 756e  static_assert(un
-000a4890: 6963 6f64 653a 3a69 735f 666f 7262 6964  icode::is_forbid
-000a48a0: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
-000a48b0: 706f 696e 7428 275c 6e27 2929 3b0a 7374  point('\n'));.st
-000a48c0: 6174 6963 5f61 7373 6572 7428 756e 6963  atic_assert(unic
-000a48d0: 6f64 653a 3a69 735f 666f 7262 6964 6465  ode::is_forbidde
-000a48e0: 6e5f 646f 6d61 696e 5f63 6f64 655f 706f  n_domain_code_po
-000a48f0: 696e 7428 275c 7227 2929 3b0a 7374 6174  int('\r'));.stat
-000a4900: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
-000a4910: 653a 3a69 735f 666f 7262 6964 6465 6e5f  e::is_forbidden_
-000a4920: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
-000a4930: 7428 2720 2729 293b 0a73 7461 7469 635f  t(' '));.static_
-000a4940: 6173 7365 7274 2875 6e69 636f 6465 3a3a  assert(unicode::
-000a4950: 6973 5f66 6f72 6269 6464 656e 5f64 6f6d  is_forbidden_dom
-000a4960: 6169 6e5f 636f 6465 5f70 6f69 6e74 2827  ain_code_point('
-000a4970: 2327 2929 3b0a 7374 6174 6963 5f61 7373  #'));.static_ass
-000a4980: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
-000a4990: 666f 7262 6964 6465 6e5f 646f 6d61 696e  forbidden_domain
-000a49a0: 5f63 6f64 655f 706f 696e 7428 272f 2729  _code_point('/')
-000a49b0: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
-000a49c0: 2875 6e69 636f 6465 3a3a 6973 5f66 6f72  (unicode::is_for
-000a49d0: 6269 6464 656e 5f64 6f6d 6169 6e5f 636f  bidden_domain_co
-000a49e0: 6465 5f70 6f69 6e74 2827 3a27 2929 3b0a  de_point(':'));.
-000a49f0: 7374 6174 6963 5f61 7373 6572 7428 756e  static_assert(un
-000a4a00: 6963 6f64 653a 3a69 735f 666f 7262 6964  icode::is_forbid
-000a4a10: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
-000a4a20: 706f 696e 7428 273f 2729 293b 0a73 7461  point('?'));.sta
-000a4a30: 7469 635f 6173 7365 7274 2875 6e69 636f  tic_assert(unico
-000a4a40: 6465 3a3a 6973 5f66 6f72 6269 6464 656e  de::is_forbidden
-000a4a50: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
-000a4a60: 6e74 2827 4027 2929 3b0a 7374 6174 6963  nt('@'));.static
-000a4a70: 5f61 7373 6572 7428 756e 6963 6f64 653a  _assert(unicode:
-000a4a80: 3a69 735f 666f 7262 6964 6465 6e5f 646f  :is_forbidden_do
-000a4a90: 6d61 696e 5f63 6f64 655f 706f 696e 7428  main_code_point(
-000a4aa0: 275b 2729 293b 0a73 7461 7469 635f 6173  '['));.static_as
-000a4ab0: 7365 7274 2875 6e69 636f 6465 3a3a 6973  sert(unicode::is
-000a4ac0: 5f66 6f72 6269 6464 656e 5f64 6f6d 6169  _forbidden_domai
-000a4ad0: 6e5f 636f 6465 5f70 6f69 6e74 2827 3f27  n_code_point('?'
-000a4ae0: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
-000a4af0: 7428 756e 6963 6f64 653a 3a69 735f 666f  t(unicode::is_fo
-000a4b00: 7262 6964 6465 6e5f 646f 6d61 696e 5f63  rbidden_domain_c
-000a4b10: 6f64 655f 706f 696e 7428 273c 2729 293b  ode_point('<'));
-000a4b20: 0a73 7461 7469 635f 6173 7365 7274 2875  .static_assert(u
-000a4b30: 6e69 636f 6465 3a3a 6973 5f66 6f72 6269  nicode::is_forbi
-000a4b40: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
-000a4b50: 5f70 6f69 6e74 2827 3e27 2929 3b0a 7374  _point('>'));.st
-000a4b60: 6174 6963 5f61 7373 6572 7428 756e 6963  atic_assert(unic
-000a4b70: 6f64 653a 3a69 735f 666f 7262 6964 6465  ode::is_forbidde
-000a4b80: 6e5f 646f 6d61 696e 5f63 6f64 655f 706f  n_domain_code_po
-000a4b90: 696e 7428 275c 5c27 2929 3b0a 7374 6174  int('\\'));.stat
-000a4ba0: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
-000a4bb0: 653a 3a69 735f 666f 7262 6964 6465 6e5f  e::is_forbidden_
-000a4bc0: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
-000a4bd0: 7428 275d 2729 293b 0a73 7461 7469 635f  t(']'));.static_
-000a4be0: 6173 7365 7274 2875 6e69 636f 6465 3a3a  assert(unicode::
-000a4bf0: 6973 5f66 6f72 6269 6464 656e 5f64 6f6d  is_forbidden_dom
-000a4c00: 6169 6e5f 636f 6465 5f70 6f69 6e74 2827  ain_code_point('
-000a4c10: 5e27 2929 3b0a 7374 6174 6963 5f61 7373  ^'));.static_ass
-000a4c20: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
-000a4c30: 666f 7262 6964 6465 6e5f 646f 6d61 696e  forbidden_domain
-000a4c40: 5f63 6f64 655f 706f 696e 7428 277c 2729  _code_point('|')
-000a4c50: 293b 0a0a 636f 6e73 7465 7870 7220 7374  );..constexpr st
-000a4c60: 6174 6963 2062 6f6f 6c20 6973 5f61 6c6e  atic bool is_aln
-000a4c70: 756d 5f70 6c75 735f 7461 626c 655b 5d20  um_plus_table[] 
-000a4c80: 3d20 7b0a 2020 2020 302c 2030 2c20 302c  = {.    0, 0, 0,
-000a4c90: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4ca0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4cb0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4cc0: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
-000a4cd0: 2020 2020 302c 2030 2c20 302c 2030 2c20      0, 0, 0, 0, 
-000a4ce0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4cf0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4d00: 2030 2c20 302c 2030 2c20 302c 2031 2c20   0, 0, 0, 0, 1, 
-000a4d10: 302c 2031 2c20 312c 2030 2c0a 2020 2020  0, 1, 1, 0,.    
-000a4d20: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4d30: 2c20 312c 2031 2c20 312c 2031 2c20 302c  , 1, 1, 1, 1, 0,
-000a4d40: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4d50: 302c 2031 2c20 312c 2031 2c20 312c 2031  0, 1, 1, 1, 1, 1
-000a4d60: 2c20 312c 2031 2c0a 2020 2020 312c 2031  , 1, 1,.    1, 1
-000a4d70: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4d80: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4d90: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4da0: 2c20 312c 2030 2c20 302c 2030 2c20 302c  , 1, 0, 0, 0, 0,
-000a4db0: 2030 2c0a 2020 2020 302c 2031 2c20 312c   0,.    0, 1, 1,
-000a4dc0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
-000a4dd0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000a4de0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
-000a4df0: 2031 2c20 312c 2031 2c20 312c 2031 2c0a   1, 1, 1, 1, 1,.
-000a4e00: 2020 2020 312c 2031 2c20 312c 2030 2c20      1, 1, 1, 0, 
-000a4e10: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4e20: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4e30: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4e40: 302c 2030 2c20 302c 2030 2c0a 2020 2020  0, 0, 0, 0,.    
-000a4e50: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4e60: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4e70: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4e80: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4e90: 2c20 302c 2030 2c0a 2020 2020 302c 2030  , 0, 0,.    0, 0
-000a4ea0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4eb0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4ec0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4ed0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4ee0: 2030 2c0a 2020 2020 302c 2030 2c20 302c   0,.    0, 0, 0,
-000a4ef0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4f00: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4f10: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4f20: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
-000a4f30: 2020 2020 302c 2030 2c20 302c 2030 2c20      0, 0, 0, 0, 
-000a4f40: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4f50: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4f60: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000a4f70: 302c 2030 2c20 302c 2030 2c0a 2020 2020  0, 0, 0, 0,.    
-000a4f80: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000a4f90: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000a4fa0: 2030 2c20 302c 2030 2c20 302c 2030 7d3b   0, 0, 0, 0, 0};
-000a4fb0: 0a0a 7374 6174 6963 5f61 7373 6572 7428  ..static_assert(
-000a4fc0: 7369 7a65 6f66 2869 735f 616c 6e75 6d5f  sizeof(is_alnum_
-000a4fd0: 706c 7573 5f74 6162 6c65 2920 3d3d 2032  plus_table) == 2
-000a4fe0: 3536 293b 0a0a 6164 615f 7265 616c 6c79  56);..ada_really
-000a4ff0: 5f69 6e6c 696e 6520 636f 6e73 7465 7870  _inline constexp
-000a5000: 7220 626f 6f6c 2069 735f 616c 6e75 6d5f  r bool is_alnum_
-000a5010: 706c 7573 2863 6f6e 7374 2063 6861 7220  plus(const char 
-000a5020: 6329 206e 6f65 7863 6570 7420 7b0a 2020  c) noexcept {.  
-000a5030: 7265 7475 726e 2069 735f 616c 6e75 6d5f  return is_alnum_
-000a5040: 706c 7573 5f74 6162 6c65 5b75 696e 7438  plus_table[uint8
-000a5050: 5f74 2863 295d 3b0a 2020 2f2f 2041 2074  _t(c)];.  // A t
-000a5060: 6162 6c65 2069 7320 616c 6d6f 7374 2073  able is almost s
-000a5070: 7572 656c 7920 6d75 6368 2066 6173 7465  urely much faste
-000a5080: 7220 7468 616e 2074 6865 0a20 202f 2f20  r than the.  // 
-000a5090: 666f 6c6c 6f77 696e 6720 756e 6465 7220  following under 
-000a50a0: 6d6f 7374 2063 6f6d 7069 6c65 7273 3a20  most compilers: 
-000a50b0: 7265 7475 726e 0a20 202f 2f20 7265 7475  return.  // retu
-000a50c0: 726e 2028 7374 643a 3a69 7361 6c6e 756d  rn (std::isalnum
-000a50d0: 2863 2920 7c7c 2063 203d 3d20 272b 2720  (c) || c == '+' 
-000a50e0: 7c7c 2063 203d 3d20 272d 2720 7c7c 2063  || c == '-' || c
-000a50f0: 203d 3d20 272e 2729 3b0a 7d0a 7374 6174   == '.');.}.stat
-000a5100: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
-000a5110: 653a 3a69 735f 616c 6e75 6d5f 706c 7573  e::is_alnum_plus
-000a5120: 2827 2b27 2929 3b0a 7374 6174 6963 5f61  ('+'));.static_a
-000a5130: 7373 6572 7428 756e 6963 6f64 653a 3a69  ssert(unicode::i
-000a5140: 735f 616c 6e75 6d5f 706c 7573 2827 2d27  s_alnum_plus('-'
-000a5150: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
-000a5160: 7428 756e 6963 6f64 653a 3a69 735f 616c  t(unicode::is_al
-000a5170: 6e75 6d5f 706c 7573 2827 2e27 2929 3b0a  num_plus('.'));.
-000a5180: 7374 6174 6963 5f61 7373 6572 7428 756e  static_assert(un
-000a5190: 6963 6f64 653a 3a69 735f 616c 6e75 6d5f  icode::is_alnum_
-000a51a0: 706c 7573 2827 3027 2929 3b0a 7374 6174  plus('0'));.stat
-000a51b0: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
-000a51c0: 653a 3a69 735f 616c 6e75 6d5f 706c 7573  e::is_alnum_plus
-000a51d0: 2827 3127 2929 3b0a 7374 6174 6963 5f61  ('1'));.static_a
-000a51e0: 7373 6572 7428 756e 6963 6f64 653a 3a69  ssert(unicode::i
-000a51f0: 735f 616c 6e75 6d5f 706c 7573 2827 6127  s_alnum_plus('a'
-000a5200: 2929 3b0a 7374 6174 6963 5f61 7373 6572  ));.static_asser
-000a5210: 7428 756e 6963 6f64 653a 3a69 735f 616c  t(unicode::is_al
-000a5220: 6e75 6d5f 706c 7573 2827 6227 2929 3b0a  num_plus('b'));.
-000a5230: 0a61 6461 5f72 6561 6c6c 795f 696e 6c69  .ada_really_inli
-000a5240: 6e65 2063 6f6e 7374 6578 7072 2062 6f6f  ne constexpr boo
-000a5250: 6c20 6973 5f61 7363 6969 5f68 6578 5f64  l is_ascii_hex_d
-000a5260: 6967 6974 2863 6f6e 7374 2063 6861 7220  igit(const char 
-000a5270: 6329 206e 6f65 7863 6570 7420 7b0a 2020  c) noexcept {.  
-000a5280: 7265 7475 726e 2028 6320 3e3d 2027 3027  return (c >= '0'
-000a5290: 2026 2620 6320 3c3d 2027 3927 2920 7c7c   && c <= '9') ||
-000a52a0: 2028 6320 3e3d 2027 4127 2026 2620 6320   (c >= 'A' && c 
-000a52b0: 3c3d 2027 4627 2920 7c7c 0a20 2020 2020  <= 'F') ||.     
-000a52c0: 2020 2020 2863 203e 3d20 2761 2720 2626      (c >= 'a' &&
-000a52d0: 2063 203c 3d20 2766 2729 3b0a 7d0a 0a61   c <= 'f');.}..a
-000a52e0: 6461 5f72 6561 6c6c 795f 696e 6c69 6e65  da_really_inline
-000a52f0: 2063 6f6e 7374 6578 7072 2062 6f6f 6c20   constexpr bool 
-000a5300: 6973 5f63 305f 636f 6e74 726f 6c5f 6f72  is_c0_control_or
-000a5310: 5f73 7061 6365 2863 6f6e 7374 2063 6861  _space(const cha
-000a5320: 7220 6329 206e 6f65 7863 6570 7420 7b0a  r c) noexcept {.
-000a5330: 2020 7265 7475 726e 2028 756e 7369 676e    return (unsign
-000a5340: 6564 2063 6861 7229 6320 3c3d 2027 2027  ed char)c <= ' '
-000a5350: 3b0a 7d0a 0a61 6461 5f72 6561 6c6c 795f  ;.}..ada_really_
-000a5360: 696e 6c69 6e65 2063 6f6e 7374 6578 7072  inline constexpr
-000a5370: 2062 6f6f 6c20 6973 5f61 7363 6969 5f74   bool is_ascii_t
-000a5380: 6162 5f6f 725f 6e65 776c 696e 6528 0a20  ab_or_newline(. 
-000a5390: 2020 2063 6f6e 7374 2063 6861 7220 6329     const char c)
-000a53a0: 206e 6f65 7863 6570 7420 7b0a 2020 7265   noexcept {.  re
-000a53b0: 7475 726e 2063 203d 3d20 275c 7427 207c  turn c == '\t' |
-000a53c0: 7c20 6320 3d3d 2027 5c6e 2720 7c7c 2063  | c == '\n' || c
-000a53d0: 203d 3d20 275c 7227 3b0a 7d0a 0a63 6f6e   == '\r';.}..con
-000a53e0: 7374 6578 7072 2073 7464 3a3a 7374 7269  stexpr std::stri
-000a53f0: 6e67 5f76 6965 7720 7461 626c 655f 6973  ng_view table_is
-000a5400: 5f64 6f75 626c 655f 646f 745f 7061 7468  _double_dot_path
-000a5410: 5f73 6567 6d65 6e74 5b5d 203d 207b 0a20  _segment[] = {. 
-000a5420: 2020 2022 2e2e 222c 2022 2532 652e 222c     "..", "%2e.",
-000a5430: 2022 2e25 3265 222c 2022 2532 6525 3265   ".%2e", "%2e%2e
-000a5440: 227d 3b0a 0a61 6461 5f72 6561 6c6c 795f  "};..ada_really_
-000a5450: 696e 6c69 6e65 2061 6461 5f63 6f6e 7374  inline ada_const
-000a5460: 6578 7072 2062 6f6f 6c20 6973 5f64 6f75  expr bool is_dou
-000a5470: 626c 655f 646f 745f 7061 7468 5f73 6567  ble_dot_path_seg
-000a5480: 6d65 6e74 280a 2020 2020 7374 643a 3a73  ment(.    std::s
-000a5490: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
-000a54a0: 2920 6e6f 6578 6365 7074 207b 0a20 202f  ) noexcept {.  /
-000a54b0: 2f20 5468 6973 2077 696c 6c20 6361 7463  / This will catc
-000a54c0: 6820 6d6f 7374 2063 6173 6573 3a0a 2020  h most cases:.  
-000a54d0: 2f2f 2054 6865 206c 656e 6774 6820 6d75  // The length mu
-000a54e0: 7374 2062 6520 322c 3420 6f72 2036 2e0a  st be 2,4 or 6..
-000a54f0: 2020 2f2f 2057 6520 6469 7669 6465 2062    // We divide b
-000a5500: 7920 7477 6f20 616e 6420 7265 7175 6972  y two and requir
-000a5510: 650a 2020 2f2f 2074 6861 7420 7468 6520  e.  // that the 
-000a5520: 7265 7375 6c74 2062 6520 6265 7477 6565  result be betwee
-000a5530: 6e20 3120 616e 6420 3320 696e 636c 7573  n 1 and 3 inclus
-000a5540: 6976 656c 792e 0a20 2075 696e 7436 345f  ively..  uint64_
-000a5550: 7420 6861 6c66 5f6c 656e 6774 6820 3d20  t half_length = 
-000a5560: 7569 6e74 3634 5f74 2869 6e70 7574 2e73  uint64_t(input.s
-000a5570: 697a 6528 2929 202f 2032 3b0a 2020 6966  ize()) / 2;.  if
-000a5580: 2028 6861 6c66 5f6c 656e 6774 6820 2d20   (half_length - 
-000a5590: 3120 3e20 3229 207b 0a20 2020 2072 6574  1 > 2) {.    ret
-000a55a0: 7572 6e20 6661 6c73 653b 0a20 207d 0a20  urn false;.  }. 
-000a55b0: 202f 2f20 5765 2068 6176 6520 6120 7374   // We have a st
-000a55c0: 7269 6e67 206f 6620 6c65 6e67 7468 2032  ring of length 2
-000a55d0: 2c20 3420 6f72 2036 2e0a 2020 2f2f 2057  , 4 or 6..  // W
-000a55e0: 6520 6e6f 7720 6368 6563 6b20 7468 6520  e now check the 
-000a55f0: 6669 7273 7420 6368 6172 6163 7465 723a  first character:
-000a5600: 0a20 2069 6620 2828 696e 7075 745b 305d  .  if ((input[0]
-000a5610: 2021 3d20 272e 2729 2026 2620 2869 6e70   != '.') && (inp
-000a5620: 7574 5b30 5d20 213d 2027 2527 2929 207b  ut[0] != '%')) {
-000a5630: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
-000a5640: 653b 0a20 207d 0a20 202f 2f20 5765 2061  e;.  }.  // We a
-000a5650: 7265 2075 6e6c 696b 656c 7920 7468 6520  re unlikely the 
-000a5660: 6765 7420 6265 796f 6e64 2074 6869 7320  get beyond this 
-000a5670: 706f 696e 742e 0a20 2069 6e74 2068 6173  point..  int has
-000a5680: 685f 7661 6c75 6520 3d20 2869 6e70 7574  h_value = (input
-000a5690: 2e73 697a 6528 2920 2b20 2875 6e73 6967  .size() + (unsig
-000a56a0: 6e65 6429 2869 6e70 7574 5b30 5d29 2920  ned)(input[0])) 
-000a56b0: 2620 333b 0a20 2063 6f6e 7374 2073 7464  & 3;.  const std
-000a56c0: 3a3a 7374 7269 6e67 5f76 6965 7720 7461  ::string_view ta
-000a56d0: 7267 6574 203d 2074 6162 6c65 5f69 735f  rget = table_is_
-000a56e0: 646f 7562 6c65 5f64 6f74 5f70 6174 685f  double_dot_path_
-000a56f0: 7365 676d 656e 745b 6861 7368 5f76 616c  segment[hash_val
-000a5700: 7565 5d3b 0a20 2069 6620 2874 6172 6765  ue];.  if (targe
-000a5710: 742e 7369 7a65 2829 2021 3d20 696e 7075  t.size() != inpu
-000a5720: 742e 7369 7a65 2829 2920 7b0a 2020 2020  t.size()) {.    
-000a5730: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
-000a5740: 7d0a 2020 2f2f 2057 6520 616c 6d6f 7374  }.  // We almost
-000a5750: 206e 6576 6572 2067 6574 2068 6572 652e   never get here.
-000a5760: 0a20 202f 2f20 4f70 7469 6d69 7a69 6e67  .  // Optimizing
-000a5770: 2074 6865 2072 6573 7420 6973 2072 656c   the rest is rel
-000a5780: 6174 6976 656c 7920 756e 696d 706f 7274  atively unimport
-000a5790: 616e 742e 0a20 2061 7574 6f20 7072 6566  ant..  auto pref
-000a57a0: 6978 5f65 7175 616c 5f75 6e73 6166 6520  ix_equal_unsafe 
-000a57b0: 3d20 5b5d 2873 7464 3a3a 7374 7269 6e67  = [](std::string
-000a57c0: 5f76 6965 7720 612c 2073 7464 3a3a 7374  _view a, std::st
-000a57d0: 7269 6e67 5f76 6965 7720 6229 207b 0a20  ring_view b) {. 
-000a57e0: 2020 2075 696e 7431 365f 7420 412c 2042     uint16_t A, B
-000a57f0: 3b0a 2020 2020 6d65 6d63 7079 2826 412c  ;.    memcpy(&A,
-000a5800: 2061 2e64 6174 6128 292c 2073 697a 656f   a.data(), sizeo
-000a5810: 6628 4129 293b 0a20 2020 206d 656d 6370  f(A));.    memcp
-000a5820: 7928 2642 2c20 622e 6461 7461 2829 2c20  y(&B, b.data(), 
-000a5830: 7369 7a65 6f66 2842 2929 3b0a 2020 2020  sizeof(B));.    
-000a5840: 7265 7475 726e 2041 203d 3d20 423b 0a20  return A == B;. 
-000a5850: 207d 3b0a 2020 6966 2028 2170 7265 6669   };.  if (!prefi
-000a5860: 785f 6571 7561 6c5f 756e 7361 6665 2869  x_equal_unsafe(i
-000a5870: 6e70 7574 2c20 7461 7267 6574 2929 207b  nput, target)) {
-000a5880: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
-000a5890: 653b 0a20 207d 0a20 2066 6f72 2028 7369  e;.  }.  for (si
-000a58a0: 7a65 5f74 2069 203d 2032 3b20 6920 3c20  ze_t i = 2; i < 
-000a58b0: 696e 7075 742e 7369 7a65 2829 3b20 692b  input.size(); i+
-000a58c0: 2b29 207b 0a20 2020 2063 6861 7220 6320  +) {.    char c 
-000a58d0: 3d20 696e 7075 745b 695d 3b0a 2020 2020  = input[i];.    
-000a58e0: 6966 2028 2875 696e 7438 5f74 2828 6320  if ((uint8_t((c 
-000a58f0: 7c20 3078 3230 2920 2d20 3078 3631 2920  | 0x20) - 0x61) 
-000a5900: 3c3d 2032 3520 3f20 2863 207c 2030 7832  <= 25 ? (c | 0x2
-000a5910: 3029 203a 2063 2920 213d 2074 6172 6765  0) : c) != targe
-000a5920: 745b 695d 2920 7b0a 2020 2020 2020 7265  t[i]) {.      re
-000a5930: 7475 726e 2066 616c 7365 3b0a 2020 2020  turn false;.    
-000a5940: 7d0a 2020 7d0a 2020 7265 7475 726e 2074  }.  }.  return t
-000a5950: 7275 653b 0a20 202f 2f20 5468 6520 6162  rue;.  // The ab
-000a5960: 6f76 6520 636f 6465 206d 6967 6874 2062  ove code might b
-000a5970: 6520 6120 6269 7420 6265 7474 6572 2074  e a bit better t
-000a5980: 6861 6e20 7468 6520 636f 6465 2062 656c  han the code bel
-000a5990: 6f77 2e20 436f 6d70 696c 6572 730a 2020  ow. Compilers.  
-000a59a0: 2f2f 2061 7265 206e 6f74 2073 7475 7069  // are not stupi
-000a59b0: 6420 616e 6420 6d61 7920 7573 6520 7468  d and may use th
-000a59c0: 6520 6661 6374 2074 6861 7420 7468 6573  e fact that thes
-000a59d0: 6520 7374 7269 6e67 7320 6861 7665 206c  e strings have l
-000a59e0: 656e 6774 6820 322c 3420 616e 640a 2020  ength 2,4 and.  
-000a59f0: 2f2f 2036 2061 6e64 206f 7468 6572 2074  // 6 and other t
-000a5a00: 7269 636b 732e 0a20 202f 2f20 7265 7475  ricks..  // retu
-000a5a10: 726e 2069 6e70 7574 203d 3d20 222e 2e22  rn input == ".."
-000a5a20: 207c 7c0a 2020 2f2f 2020 696e 7075 7420   ||.  //  input 
-000a5a30: 3d3d 2022 2e25 3265 2220 7c7c 2069 6e70  == ".%2e" || inp
-000a5a40: 7574 203d 3d20 222e 2532 4522 207c 7c0a  ut == ".%2E" ||.
-000a5a50: 2020 2f2f 2020 696e 7075 7420 3d3d 2022    //  input == "
-000a5a60: 2532 652e 2220 7c7c 2069 6e70 7574 203d  %2e." || input =
-000a5a70: 3d20 2225 3245 2e22 207c 7c0a 2020 2f2f  = "%2E." ||.  //
-000a5a80: 2020 696e 7075 7420 3d3d 2022 2532 6525    input == "%2e%
-000a5a90: 3265 2220 7c7c 2069 6e70 7574 203d 3d20  2e" || input == 
-000a5aa0: 2225 3245 2532 4522 207c 7c20 696e 7075  "%2E%2E" || inpu
-000a5ab0: 7420 3d3d 2022 2532 4525 3265 2220 7c7c  t == "%2E%2e" ||
-000a5ac0: 2069 6e70 7574 203d 3d0a 2020 2f2f 2020   input ==.  //  
-000a5ad0: 2225 3265 2532 4522 3b0a 7d0a 0a61 6461  "%2e%2E";.}..ada
-000a5ae0: 5f72 6561 6c6c 795f 696e 6c69 6e65 2063  _really_inline c
-000a5af0: 6f6e 7374 6578 7072 2062 6f6f 6c20 6973  onstexpr bool is
-000a5b00: 5f73 696e 676c 655f 646f 745f 7061 7468  _single_dot_path
-000a5b10: 5f73 6567 6d65 6e74 280a 2020 2020 7374  _segment(.    st
-000a5b20: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
-000a5b30: 6e70 7574 2920 6e6f 6578 6365 7074 207b  nput) noexcept {
-000a5b40: 0a20 2072 6574 7572 6e20 696e 7075 7420  .  return input 
-000a5b50: 3d3d 2022 2e22 207c 7c20 696e 7075 7420  == "." || input 
-000a5b60: 3d3d 2022 2532 6522 207c 7c20 696e 7075  == "%2e" || inpu
-000a5b70: 7420 3d3d 2022 2532 4522 3b0a 7d0a 0a61  t == "%2E";.}..a
-000a5b80: 6461 5f72 6561 6c6c 795f 696e 6c69 6e65  da_really_inline
-000a5b90: 2063 6f6e 7374 6578 7072 2062 6f6f 6c20   constexpr bool 
-000a5ba0: 6973 5f6c 6f77 6572 6361 7365 5f68 6578  is_lowercase_hex
-000a5bb0: 2863 6f6e 7374 2063 6861 7220 6329 206e  (const char c) n
-000a5bc0: 6f65 7863 6570 7420 7b0a 2020 7265 7475  oexcept {.  retu
-000a5bd0: 726e 2028 6320 3e3d 2027 3027 2026 2620  rn (c >= '0' && 
-000a5be0: 6320 3c3d 2027 3927 2920 7c7c 2028 6320  c <= '9') || (c 
-000a5bf0: 3e3d 2027 6127 2026 2620 6320 3c3d 2027  >= 'a' && c <= '
-000a5c00: 6627 293b 0a7d 0a0a 756e 7369 676e 6564  f');.}..unsigned
-000a5c10: 2063 6f6e 7374 6578 7072 2063 6f6e 7665   constexpr conve
-000a5c20: 7274 5f68 6578 5f74 6f5f 6269 6e61 7279  rt_hex_to_binary
-000a5c30: 2863 6f6e 7374 2063 6861 7220 6329 206e  (const char c) n
-000a5c40: 6f65 7863 6570 7420 7b0a 2020 2f2f 2074  oexcept {.  // t
-000a5c50: 6869 7320 636f 6465 2063 616e 2062 6520  his code can be 
-000a5c60: 6f70 7469 6d69 7a65 642e 0a20 2069 6620  optimized..  if 
-000a5c70: 2863 203c 3d20 2739 2729 207b 0a20 2020  (c <= '9') {.   
-000a5c80: 2072 6574 7572 6e20 6320 2d20 2730 273b   return c - '0';
-000a5c90: 0a20 207d 0a20 2063 6861 7220 6465 6c20  .  }.  char del 
-000a5ca0: 3d20 6320 3e3d 2027 6127 203f 2027 6127  = c >= 'a' ? 'a'
-000a5cb0: 203a 2027 4127 3b0a 2020 7265 7475 726e   : 'A';.  return
-000a5cc0: 2031 3020 2b20 2863 202d 2064 656c 293b   10 + (c - del);
-000a5cd0: 0a7d 0a0a 7374 643a 3a73 7472 696e 6720  .}..std::string 
-000a5ce0: 7065 7263 656e 745f 6465 636f 6465 2863  percent_decode(c
-000a5cf0: 6f6e 7374 2073 7464 3a3a 7374 7269 6e67  onst std::string
-000a5d00: 5f76 6965 7720 696e 7075 742c 2073 697a  _view input, siz
-000a5d10: 655f 7420 6669 7273 745f 7065 7263 656e  e_t first_percen
-000a5d20: 7429 207b 0a20 202f 2f20 6e65 7874 206c  t) {.  // next l
-000a5d30: 696e 6520 6973 2066 6f72 2073 6166 6574  ine is for safet
-000a5d40: 7920 6f6e 6c79 2c20 7765 2065 7870 6563  y only, we expec
-000a5d50: 7420 7573 6572 7320 746f 2061 766f 6964  t users to avoid
-000a5d60: 2063 616c 6c69 6e67 0a20 202f 2f20 7065   calling.  // pe
-000a5d70: 7263 656e 745f 6465 636f 6465 2077 6865  rcent_decode whe
-000a5d80: 6e20 6669 7273 745f 7065 7263 656e 7420  n first_percent 
-000a5d90: 6973 206f 7574 7369 6465 2074 6865 2072  is outside the r
-000a5da0: 616e 6765 2e0a 2020 6966 2028 6669 7273  ange..  if (firs
-000a5db0: 745f 7065 7263 656e 7420 3d3d 2073 7464  t_percent == std
-000a5dc0: 3a3a 7374 7269 6e67 5f76 6965 773a 3a6e  ::string_view::n
-000a5dd0: 706f 7329 207b 0a20 2020 2072 6574 7572  pos) {.    retur
-000a5de0: 6e20 7374 643a 3a73 7472 696e 6728 696e  n std::string(in
-000a5df0: 7075 7429 3b0a 2020 7d0a 2020 7374 643a  put);.  }.  std:
-000a5e00: 3a73 7472 696e 6720 6465 7374 2869 6e70  :string dest(inp
-000a5e10: 7574 2e73 7562 7374 7228 302c 2066 6972  ut.substr(0, fir
-000a5e20: 7374 5f70 6572 6365 6e74 2929 3b0a 2020  st_percent));.  
-000a5e30: 6465 7374 2e72 6573 6572 7665 2869 6e70  dest.reserve(inp
-000a5e40: 7574 2e6c 656e 6774 6828 2929 3b0a 2020  ut.length());.  
-000a5e50: 636f 6e73 7420 6368 6172 2a20 706f 696e  const char* poin
-000a5e60: 7465 7220 3d20 696e 7075 742e 6461 7461  ter = input.data
-000a5e70: 2829 202b 2066 6972 7374 5f70 6572 6365  () + first_perce
-000a5e80: 6e74 3b0a 2020 636f 6e73 7420 6368 6172  nt;.  const char
-000a5e90: 2a20 656e 6420 3d20 696e 7075 742e 6461  * end = input.da
-000a5ea0: 7461 2829 202b 2069 6e70 7574 2e73 697a  ta() + input.siz
-000a5eb0: 6528 293b 0a20 202f 2f20 4f70 7469 6d69  e();.  // Optimi
-000a5ec0: 7a61 7469 6f6e 206f 7070 6f72 7475 6e69  zation opportuni
-000a5ed0: 7479 3a20 6966 2074 6865 2066 6f6c 6c6f  ty: if the follo
-000a5ee0: 7769 6e67 2063 6f64 6520 6765 7473 0a20  wing code gets. 
-000a5ef0: 202f 2f20 6361 6c6c 6564 206f 6674 656e   // called often
-000a5f00: 2c20 6974 2063 616e 2062 6520 6f70 7469  , it can be opti
-000a5f10: 6d69 7a65 6420 7175 6974 6520 6120 6269  mized quite a bi
-000a5f20: 742e 0a20 2077 6869 6c65 2028 706f 696e  t..  while (poin
-000a5f30: 7465 7220 3c20 656e 6429 207b 0a20 2020  ter < end) {.   
-000a5f40: 2063 6f6e 7374 2063 6861 7220 6368 203d   const char ch =
-000a5f50: 2070 6f69 6e74 6572 5b30 5d3b 0a20 2020   pointer[0];.   
-000a5f60: 2073 697a 655f 7420 7265 6d61 696e 696e   size_t remainin
-000a5f70: 6720 3d20 656e 6420 2d20 706f 696e 7465  g = end - pointe
-000a5f80: 7220 2d20 313b 0a20 2020 2069 6620 2863  r - 1;.    if (c
-000a5f90: 6820 213d 2027 2527 207c 7c20 7265 6d61  h != '%' || rema
-000a5fa0: 696e 696e 6720 3c20 3220 7c7c 0a20 2020  ining < 2 ||.   
-000a5fb0: 2020 2020 2028 2020 2f2f 2063 6820 3d3d       (  // ch ==
-000a5fc0: 2027 2527 2026 2620 2f2f 2049 7420 6973   '%' && // It is
-000a5fd0: 2075 6e6e 6563 6573 7361 7279 2074 6f20   unnecessary to 
-000a5fe0: 6368 6563 6b20 7468 6174 2063 6820 3d3d  check that ch ==
-000a5ff0: 2027 2527 2e0a 2020 2020 2020 2020 2020   '%'..          
-000a6000: 2020 2821 6973 5f61 7363 6969 5f68 6578    (!is_ascii_hex
-000a6010: 5f64 6967 6974 2870 6f69 6e74 6572 5b31  _digit(pointer[1
-000a6020: 5d29 207c 7c0a 2020 2020 2020 2020 2020  ]) ||.          
-000a6030: 2020 2021 6973 5f61 7363 6969 5f68 6578     !is_ascii_hex
-000a6040: 5f64 6967 6974 2870 6f69 6e74 6572 5b32  _digit(pointer[2
-000a6050: 5d29 2929 2920 7b0a 2020 2020 2020 6465  ])))) {.      de
-000a6060: 7374 202b 3d20 6368 3b0a 2020 2020 2020  st += ch;.      
-000a6070: 706f 696e 7465 722b 2b3b 0a20 2020 2020  pointer++;.     
-000a6080: 2063 6f6e 7469 6e75 653b 0a20 2020 207d   continue;.    }
-000a6090: 2065 6c73 6520 7b0a 2020 2020 2020 756e   else {.      un
-000a60a0: 7369 676e 6564 2061 203d 2063 6f6e 7665  signed a = conve
-000a60b0: 7274 5f68 6578 5f74 6f5f 6269 6e61 7279  rt_hex_to_binary
-000a60c0: 2870 6f69 6e74 6572 5b31 5d29 3b0a 2020  (pointer[1]);.  
-000a60d0: 2020 2020 756e 7369 676e 6564 2062 203d      unsigned b =
-000a60e0: 2063 6f6e 7665 7274 5f68 6578 5f74 6f5f   convert_hex_to_
-000a60f0: 6269 6e61 7279 2870 6f69 6e74 6572 5b32  binary(pointer[2
-000a6100: 5d29 3b0a 2020 2020 2020 6368 6172 2063  ]);.      char c
-000a6110: 203d 2073 7461 7469 635f 6361 7374 3c63   = static_cast<c
-000a6120: 6861 723e 2861 202a 2031 3620 2b20 6229  har>(a * 16 + b)
-000a6130: 3b0a 2020 2020 2020 6465 7374 202b 3d20  ;.      dest += 
-000a6140: 633b 0a20 2020 2020 2070 6f69 6e74 6572  c;.      pointer
-000a6150: 202b 3d20 333b 0a20 2020 207d 0a20 207d   += 3;.    }.  }
-000a6160: 0a20 2072 6574 7572 6e20 6465 7374 3b0a  .  return dest;.
-000a6170: 7d0a 0a73 7464 3a3a 7374 7269 6e67 2070  }..std::string p
-000a6180: 6572 6365 6e74 5f65 6e63 6f64 6528 636f  ercent_encode(co
-000a6190: 6e73 7420 7374 643a 3a73 7472 696e 675f  nst std::string_
-000a61a0: 7669 6577 2069 6e70 7574 2c0a 2020 2020  view input,.    
+000a4500: 2020 2020 2073 697a 655f 7420 6c65 6e67       size_t leng
+000a4510: 7468 2920 6e6f 6578 6365 7074 207b 0a20  th) noexcept {. 
+000a4520: 2073 697a 655f 7420 6920 3d20 303b 0a20   size_t i = 0;. 
+000a4530: 2075 696e 7438 5f74 2061 6363 756d 756c   uint8_t accumul
+000a4540: 6174 6f72 7b7d 3b0a 2020 666f 7220 283b  ator{};.  for (;
+000a4550: 2069 202b 2034 203c 3d20 6c65 6e67 7468   i + 4 <= length
+000a4560: 3b20 6920 2b3d 2034 2920 7b0a 2020 2020  ; i += 4) {.    
+000a4570: 6163 6375 6d75 6c61 746f 7220 7c3d 0a20  accumulator |=. 
+000a4580: 2020 2020 2020 2069 735f 666f 7262 6964         is_forbid
+000a4590: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
+000a45a0: 706f 696e 745f 7461 626c 655f 6f72 5f75  point_table_or_u
+000a45b0: 7070 6572 5b75 696e 7438 5f74 2869 6e70  pper[uint8_t(inp
+000a45c0: 7574 5b69 5d29 5d3b 0a20 2020 2061 6363  ut[i])];.    acc
+000a45d0: 756d 756c 6174 6f72 207c 3d0a 2020 2020  umulator |=.    
+000a45e0: 2020 2020 6973 5f66 6f72 6269 6464 656e      is_forbidden
+000a45f0: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
+000a4600: 6e74 5f74 6162 6c65 5f6f 725f 7570 7065  nt_table_or_uppe
+000a4610: 725b 7569 6e74 385f 7428 696e 7075 745b  r[uint8_t(input[
+000a4620: 6920 2b20 315d 295d 3b0a 2020 2020 6163  i + 1])];.    ac
+000a4630: 6375 6d75 6c61 746f 7220 7c3d 0a20 2020  cumulator |=.   
+000a4640: 2020 2020 2069 735f 666f 7262 6964 6465       is_forbidde
+000a4650: 6e5f 646f 6d61 696e 5f63 6f64 655f 706f  n_domain_code_po
+000a4660: 696e 745f 7461 626c 655f 6f72 5f75 7070  int_table_or_upp
+000a4670: 6572 5b75 696e 7438 5f74 2869 6e70 7574  er[uint8_t(input
+000a4680: 5b69 202b 2032 5d29 5d3b 0a20 2020 2061  [i + 2])];.    a
+000a4690: 6363 756d 756c 6174 6f72 207c 3d0a 2020  ccumulator |=.  
+000a46a0: 2020 2020 2020 6973 5f66 6f72 6269 6464        is_forbidd
+000a46b0: 656e 5f64 6f6d 6169 6e5f 636f 6465 5f70  en_domain_code_p
+000a46c0: 6f69 6e74 5f74 6162 6c65 5f6f 725f 7570  oint_table_or_up
+000a46d0: 7065 725b 7569 6e74 385f 7428 696e 7075  per[uint8_t(inpu
+000a46e0: 745b 6920 2b20 335d 295d 3b0a 2020 7d0a  t[i + 3])];.  }.
+000a46f0: 2020 666f 7220 283b 2069 203c 206c 656e    for (; i < len
+000a4700: 6774 683b 2069 2b2b 2920 7b0a 2020 2020  gth; i++) {.    
+000a4710: 6163 6375 6d75 6c61 746f 7220 7c3d 0a20  accumulator |=. 
+000a4720: 2020 2020 2020 2069 735f 666f 7262 6964         is_forbid
+000a4730: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
+000a4740: 706f 696e 745f 7461 626c 655f 6f72 5f75  point_table_or_u
+000a4750: 7070 6572 5b75 696e 7438 5f74 2869 6e70  pper[uint8_t(inp
+000a4760: 7574 5b69 5d29 5d3b 0a20 207d 0a20 2072  ut[i])];.  }.  r
+000a4770: 6574 7572 6e20 6163 6375 6d75 6c61 746f  eturn accumulato
+000a4780: 723b 0a7d 0a0a 7374 6174 6963 5f61 7373  r;.}..static_ass
+000a4790: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
+000a47a0: 666f 7262 6964 6465 6e5f 646f 6d61 696e  forbidden_domain
+000a47b0: 5f63 6f64 655f 706f 696e 7428 2725 2729  _code_point('%')
+000a47c0: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
+000a47d0: 2875 6e69 636f 6465 3a3a 6973 5f66 6f72  (unicode::is_for
+000a47e0: 6269 6464 656e 5f64 6f6d 6169 6e5f 636f  bidden_domain_co
+000a47f0: 6465 5f70 6f69 6e74 2827 5c78 3766 2729  de_point('\x7f')
+000a4800: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
+000a4810: 2875 6e69 636f 6465 3a3a 6973 5f66 6f72  (unicode::is_for
+000a4820: 6269 6464 656e 5f64 6f6d 6169 6e5f 636f  bidden_domain_co
+000a4830: 6465 5f70 6f69 6e74 2827 5c30 2729 293b  de_point('\0'));
+000a4840: 0a73 7461 7469 635f 6173 7365 7274 2875  .static_assert(u
+000a4850: 6e69 636f 6465 3a3a 6973 5f66 6f72 6269  nicode::is_forbi
+000a4860: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
+000a4870: 5f70 6f69 6e74 2827 5c74 2729 293b 0a73  _point('\t'));.s
+000a4880: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
+000a4890: 636f 6465 3a3a 6973 5f66 6f72 6269 6464  code::is_forbidd
+000a48a0: 656e 5f64 6f6d 6169 6e5f 636f 6465 5f70  en_domain_code_p
+000a48b0: 6f69 6e74 2827 5c6e 2729 293b 0a73 7461  oint('\n'));.sta
+000a48c0: 7469 635f 6173 7365 7274 2875 6e69 636f  tic_assert(unico
+000a48d0: 6465 3a3a 6973 5f66 6f72 6269 6464 656e  de::is_forbidden
+000a48e0: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
+000a48f0: 6e74 2827 5c72 2729 293b 0a73 7461 7469  nt('\r'));.stati
+000a4900: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
+000a4910: 3a3a 6973 5f66 6f72 6269 6464 656e 5f64  ::is_forbidden_d
+000a4920: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
+000a4930: 2827 2027 2929 3b0a 7374 6174 6963 5f61  (' '));.static_a
+000a4940: 7373 6572 7428 756e 6963 6f64 653a 3a69  ssert(unicode::i
+000a4950: 735f 666f 7262 6964 6465 6e5f 646f 6d61  s_forbidden_doma
+000a4960: 696e 5f63 6f64 655f 706f 696e 7428 2723  in_code_point('#
+000a4970: 2729 293b 0a73 7461 7469 635f 6173 7365  '));.static_asse
+000a4980: 7274 2875 6e69 636f 6465 3a3a 6973 5f66  rt(unicode::is_f
+000a4990: 6f72 6269 6464 656e 5f64 6f6d 6169 6e5f  orbidden_domain_
+000a49a0: 636f 6465 5f70 6f69 6e74 2827 2f27 2929  code_point('/'))
+000a49b0: 3b0a 7374 6174 6963 5f61 7373 6572 7428  ;.static_assert(
+000a49c0: 756e 6963 6f64 653a 3a69 735f 666f 7262  unicode::is_forb
+000a49d0: 6964 6465 6e5f 646f 6d61 696e 5f63 6f64  idden_domain_cod
+000a49e0: 655f 706f 696e 7428 273a 2729 293b 0a73  e_point(':'));.s
+000a49f0: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
+000a4a00: 636f 6465 3a3a 6973 5f66 6f72 6269 6464  code::is_forbidd
+000a4a10: 656e 5f64 6f6d 6169 6e5f 636f 6465 5f70  en_domain_code_p
+000a4a20: 6f69 6e74 2827 3f27 2929 3b0a 7374 6174  oint('?'));.stat
+000a4a30: 6963 5f61 7373 6572 7428 756e 6963 6f64  ic_assert(unicod
+000a4a40: 653a 3a69 735f 666f 7262 6964 6465 6e5f  e::is_forbidden_
+000a4a50: 646f 6d61 696e 5f63 6f64 655f 706f 696e  domain_code_poin
+000a4a60: 7428 2740 2729 293b 0a73 7461 7469 635f  t('@'));.static_
+000a4a70: 6173 7365 7274 2875 6e69 636f 6465 3a3a  assert(unicode::
+000a4a80: 6973 5f66 6f72 6269 6464 656e 5f64 6f6d  is_forbidden_dom
+000a4a90: 6169 6e5f 636f 6465 5f70 6f69 6e74 2827  ain_code_point('
+000a4aa0: 5b27 2929 3b0a 7374 6174 6963 5f61 7373  ['));.static_ass
+000a4ab0: 6572 7428 756e 6963 6f64 653a 3a69 735f  ert(unicode::is_
+000a4ac0: 666f 7262 6964 6465 6e5f 646f 6d61 696e  forbidden_domain
+000a4ad0: 5f63 6f64 655f 706f 696e 7428 273f 2729  _code_point('?')
+000a4ae0: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
+000a4af0: 2875 6e69 636f 6465 3a3a 6973 5f66 6f72  (unicode::is_for
+000a4b00: 6269 6464 656e 5f64 6f6d 6169 6e5f 636f  bidden_domain_co
+000a4b10: 6465 5f70 6f69 6e74 2827 3c27 2929 3b0a  de_point('<'));.
+000a4b20: 7374 6174 6963 5f61 7373 6572 7428 756e  static_assert(un
+000a4b30: 6963 6f64 653a 3a69 735f 666f 7262 6964  icode::is_forbid
+000a4b40: 6465 6e5f 646f 6d61 696e 5f63 6f64 655f  den_domain_code_
+000a4b50: 706f 696e 7428 273e 2729 293b 0a73 7461  point('>'));.sta
+000a4b60: 7469 635f 6173 7365 7274 2875 6e69 636f  tic_assert(unico
+000a4b70: 6465 3a3a 6973 5f66 6f72 6269 6464 656e  de::is_forbidden
+000a4b80: 5f64 6f6d 6169 6e5f 636f 6465 5f70 6f69  _domain_code_poi
+000a4b90: 6e74 2827 5c5c 2729 293b 0a73 7461 7469  nt('\\'));.stati
+000a4ba0: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
+000a4bb0: 3a3a 6973 5f66 6f72 6269 6464 656e 5f64  ::is_forbidden_d
+000a4bc0: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
+000a4bd0: 2827 5d27 2929 3b0a 7374 6174 6963 5f61  (']'));.static_a
+000a4be0: 7373 6572 7428 756e 6963 6f64 653a 3a69  ssert(unicode::i
+000a4bf0: 735f 666f 7262 6964 6465 6e5f 646f 6d61  s_forbidden_doma
+000a4c00: 696e 5f63 6f64 655f 706f 696e 7428 275e  in_code_point('^
+000a4c10: 2729 293b 0a73 7461 7469 635f 6173 7365  '));.static_asse
+000a4c20: 7274 2875 6e69 636f 6465 3a3a 6973 5f66  rt(unicode::is_f
+000a4c30: 6f72 6269 6464 656e 5f64 6f6d 6169 6e5f  orbidden_domain_
+000a4c40: 636f 6465 5f70 6f69 6e74 2827 7c27 2929  code_point('|'))
+000a4c50: 3b0a 0a63 6f6e 7374 6578 7072 2073 7461  ;..constexpr sta
+000a4c60: 7469 6320 626f 6f6c 2069 735f 616c 6e75  tic bool is_alnu
+000a4c70: 6d5f 706c 7573 5f74 6162 6c65 5b5d 203d  m_plus_table[] =
+000a4c80: 207b 0a20 2020 2030 2c20 302c 2030 2c20   {.    0, 0, 0, 
+000a4c90: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4ca0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4cb0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4cc0: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
+000a4cd0: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
+000a4ce0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4cf0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4d00: 302c 2030 2c20 302c 2030 2c20 312c 2030  0, 0, 0, 0, 1, 0
+000a4d10: 2c20 312c 2031 2c20 302c 0a20 2020 2031  , 1, 1, 0,.    1
+000a4d20: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4d30: 2031 2c20 312c 2031 2c20 312c 2030 2c20   1, 1, 1, 1, 0, 
+000a4d40: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4d50: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4d60: 2031 2c20 312c 0a20 2020 2031 2c20 312c   1, 1,.    1, 1,
+000a4d70: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4d80: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4d90: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4da0: 2031 2c20 302c 2030 2c20 302c 2030 2c20   1, 0, 0, 0, 0, 
+000a4db0: 302c 0a20 2020 2030 2c20 312c 2031 2c20  0,.    0, 1, 1, 
+000a4dc0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+000a4dd0: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+000a4de0: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+000a4df0: 312c 2031 2c20 312c 2031 2c20 312c 0a20  1, 1, 1, 1, 1,. 
+000a4e00: 2020 2031 2c20 312c 2031 2c20 302c 2030     1, 1, 1, 0, 0
+000a4e10: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4e20: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4e30: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4e40: 2c20 302c 2030 2c20 302c 0a20 2020 2030  , 0, 0, 0,.    0
+000a4e50: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4e60: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4e70: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4e80: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4e90: 2030 2c20 302c 0a20 2020 2030 2c20 302c   0, 0,.    0, 0,
+000a4ea0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4eb0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4ec0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4ed0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4ee0: 302c 0a20 2020 2030 2c20 302c 2030 2c20  0,.    0, 0, 0, 
+000a4ef0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4f00: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4f10: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4f20: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
+000a4f30: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
+000a4f40: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4f50: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4f60: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000a4f70: 2c20 302c 2030 2c20 302c 0a20 2020 2030  , 0, 0, 0,.    0
+000a4f80: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000a4f90: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000a4fa0: 302c 2030 2c20 302c 2030 2c20 307d 3b0a  0, 0, 0, 0, 0};.
+000a4fb0: 0a73 7461 7469 635f 6173 7365 7274 2873  .static_assert(s
+000a4fc0: 697a 656f 6628 6973 5f61 6c6e 756d 5f70  izeof(is_alnum_p
+000a4fd0: 6c75 735f 7461 626c 6529 203d 3d20 3235  lus_table) == 25
+000a4fe0: 3629 3b0a 0a61 6461 5f72 6561 6c6c 795f  6);..ada_really_
+000a4ff0: 696e 6c69 6e65 2063 6f6e 7374 6578 7072  inline constexpr
+000a5000: 2062 6f6f 6c20 6973 5f61 6c6e 756d 5f70   bool is_alnum_p
+000a5010: 6c75 7328 636f 6e73 7420 6368 6172 2063  lus(const char c
+000a5020: 2920 6e6f 6578 6365 7074 207b 0a20 2072  ) noexcept {.  r
+000a5030: 6574 7572 6e20 6973 5f61 6c6e 756d 5f70  eturn is_alnum_p
+000a5040: 6c75 735f 7461 626c 655b 7569 6e74 385f  lus_table[uint8_
+000a5050: 7428 6329 5d3b 0a20 202f 2f20 4120 7461  t(c)];.  // A ta
+000a5060: 626c 6520 6973 2061 6c6d 6f73 7420 7375  ble is almost su
+000a5070: 7265 6c79 206d 7563 6820 6661 7374 6572  rely much faster
+000a5080: 2074 6861 6e20 7468 650a 2020 2f2f 2066   than the.  // f
+000a5090: 6f6c 6c6f 7769 6e67 2075 6e64 6572 206d  ollowing under m
+000a50a0: 6f73 7420 636f 6d70 696c 6572 733a 2072  ost compilers: r
+000a50b0: 6574 7572 6e0a 2020 2f2f 2072 6574 7572  eturn.  // retur
+000a50c0: 6e20 2873 7464 3a3a 6973 616c 6e75 6d28  n (std::isalnum(
+000a50d0: 6329 207c 7c20 6320 3d3d 2027 2b27 207c  c) || c == '+' |
+000a50e0: 7c20 6320 3d3d 2027 2d27 207c 7c20 6320  | c == '-' || c 
+000a50f0: 3d3d 2027 2e27 293b 0a7d 0a73 7461 7469  == '.');.}.stati
+000a5100: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
+000a5110: 3a3a 6973 5f61 6c6e 756d 5f70 6c75 7328  ::is_alnum_plus(
+000a5120: 272b 2729 293b 0a73 7461 7469 635f 6173  '+'));.static_as
+000a5130: 7365 7274 2875 6e69 636f 6465 3a3a 6973  sert(unicode::is
+000a5140: 5f61 6c6e 756d 5f70 6c75 7328 272d 2729  _alnum_plus('-')
+000a5150: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
+000a5160: 2875 6e69 636f 6465 3a3a 6973 5f61 6c6e  (unicode::is_aln
+000a5170: 756d 5f70 6c75 7328 272e 2729 293b 0a73  um_plus('.'));.s
+000a5180: 7461 7469 635f 6173 7365 7274 2875 6e69  tatic_assert(uni
+000a5190: 636f 6465 3a3a 6973 5f61 6c6e 756d 5f70  code::is_alnum_p
+000a51a0: 6c75 7328 2730 2729 293b 0a73 7461 7469  lus('0'));.stati
+000a51b0: 635f 6173 7365 7274 2875 6e69 636f 6465  c_assert(unicode
+000a51c0: 3a3a 6973 5f61 6c6e 756d 5f70 6c75 7328  ::is_alnum_plus(
+000a51d0: 2731 2729 293b 0a73 7461 7469 635f 6173  '1'));.static_as
+000a51e0: 7365 7274 2875 6e69 636f 6465 3a3a 6973  sert(unicode::is
+000a51f0: 5f61 6c6e 756d 5f70 6c75 7328 2761 2729  _alnum_plus('a')
+000a5200: 293b 0a73 7461 7469 635f 6173 7365 7274  );.static_assert
+000a5210: 2875 6e69 636f 6465 3a3a 6973 5f61 6c6e  (unicode::is_aln
+000a5220: 756d 5f70 6c75 7328 2762 2729 293b 0a0a  um_plus('b'));..
+000a5230: 6164 615f 7265 616c 6c79 5f69 6e6c 696e  ada_really_inlin
+000a5240: 6520 636f 6e73 7465 7870 7220 626f 6f6c  e constexpr bool
+000a5250: 2069 735f 6173 6369 695f 6865 785f 6469   is_ascii_hex_di
+000a5260: 6769 7428 636f 6e73 7420 6368 6172 2063  git(const char c
+000a5270: 2920 6e6f 6578 6365 7074 207b 0a20 2072  ) noexcept {.  r
+000a5280: 6574 7572 6e20 2863 203e 3d20 2730 2720  eturn (c >= '0' 
+000a5290: 2626 2063 203c 3d20 2739 2729 207c 7c20  && c <= '9') || 
+000a52a0: 2863 203e 3d20 2741 2720 2626 2063 203c  (c >= 'A' && c <
+000a52b0: 3d20 2746 2729 207c 7c0a 2020 2020 2020  = 'F') ||.      
+000a52c0: 2020 2028 6320 3e3d 2027 6127 2026 2620     (c >= 'a' && 
+000a52d0: 6320 3c3d 2027 6627 293b 0a7d 0a0a 6164  c <= 'f');.}..ad
+000a52e0: 615f 7265 616c 6c79 5f69 6e6c 696e 6520  a_really_inline 
+000a52f0: 636f 6e73 7465 7870 7220 626f 6f6c 2069  constexpr bool i
+000a5300: 735f 6330 5f63 6f6e 7472 6f6c 5f6f 725f  s_c0_control_or_
+000a5310: 7370 6163 6528 636f 6e73 7420 6368 6172  space(const char
+000a5320: 2063 2920 6e6f 6578 6365 7074 207b 0a20   c) noexcept {. 
+000a5330: 2072 6574 7572 6e20 2875 6e73 6967 6e65   return (unsigne
+000a5340: 6420 6368 6172 2963 203c 3d20 2720 273b  d char)c <= ' ';
+000a5350: 0a7d 0a0a 6164 615f 7265 616c 6c79 5f69  .}..ada_really_i
+000a5360: 6e6c 696e 6520 636f 6e73 7465 7870 7220  nline constexpr 
+000a5370: 626f 6f6c 2069 735f 6173 6369 695f 7461  bool is_ascii_ta
+000a5380: 625f 6f72 5f6e 6577 6c69 6e65 280a 2020  b_or_newline(.  
+000a5390: 2020 636f 6e73 7420 6368 6172 2063 2920    const char c) 
+000a53a0: 6e6f 6578 6365 7074 207b 0a20 2072 6574  noexcept {.  ret
+000a53b0: 7572 6e20 6320 3d3d 2027 5c74 2720 7c7c  urn c == '\t' ||
+000a53c0: 2063 203d 3d20 275c 6e27 207c 7c20 6320   c == '\n' || c 
+000a53d0: 3d3d 2027 5c72 273b 0a7d 0a0a 636f 6e73  == '\r';.}..cons
+000a53e0: 7465 7870 7220 7374 643a 3a73 7472 696e  texpr std::strin
+000a53f0: 675f 7669 6577 2074 6162 6c65 5f69 735f  g_view table_is_
+000a5400: 646f 7562 6c65 5f64 6f74 5f70 6174 685f  double_dot_path_
+000a5410: 7365 676d 656e 745b 5d20 3d20 7b0a 2020  segment[] = {.  
+000a5420: 2020 222e 2e22 2c20 2225 3265 2e22 2c20    "..", "%2e.", 
+000a5430: 222e 2532 6522 2c20 2225 3265 2532 6522  ".%2e", "%2e%2e"
+000a5440: 7d3b 0a0a 6164 615f 7265 616c 6c79 5f69  };..ada_really_i
+000a5450: 6e6c 696e 6520 6164 615f 636f 6e73 7465  nline ada_conste
+000a5460: 7870 7220 626f 6f6c 2069 735f 646f 7562  xpr bool is_doub
+000a5470: 6c65 5f64 6f74 5f70 6174 685f 7365 676d  le_dot_path_segm
+000a5480: 656e 7428 0a20 2020 2073 7464 3a3a 7374  ent(.    std::st
+000a5490: 7269 6e67 5f76 6965 7720 696e 7075 7429  ring_view input)
+000a54a0: 206e 6f65 7863 6570 7420 7b0a 2020 2f2f   noexcept {.  //
+000a54b0: 2054 6869 7320 7769 6c6c 2063 6174 6368   This will catch
+000a54c0: 206d 6f73 7420 6361 7365 733a 0a20 202f   most cases:.  /
+000a54d0: 2f20 5468 6520 6c65 6e67 7468 206d 7573  / The length mus
+000a54e0: 7420 6265 2032 2c34 206f 7220 362e 0a20  t be 2,4 or 6.. 
+000a54f0: 202f 2f20 5765 2064 6976 6964 6520 6279   // We divide by
+000a5500: 2074 776f 2061 6e64 2072 6571 7569 7265   two and require
+000a5510: 0a20 202f 2f20 7468 6174 2074 6865 2072  .  // that the r
+000a5520: 6573 756c 7420 6265 2062 6574 7765 656e  esult be between
+000a5530: 2031 2061 6e64 2033 2069 6e63 6c75 7369   1 and 3 inclusi
+000a5540: 7665 6c79 2e0a 2020 7569 6e74 3634 5f74  vely..  uint64_t
+000a5550: 2068 616c 665f 6c65 6e67 7468 203d 2075   half_length = u
+000a5560: 696e 7436 345f 7428 696e 7075 742e 7369  int64_t(input.si
+000a5570: 7a65 2829 2920 2f20 323b 0a20 2069 6620  ze()) / 2;.  if 
+000a5580: 2868 616c 665f 6c65 6e67 7468 202d 2031  (half_length - 1
+000a5590: 203e 2032 2920 7b0a 2020 2020 7265 7475   > 2) {.    retu
+000a55a0: 726e 2066 616c 7365 3b0a 2020 7d0a 2020  rn false;.  }.  
+000a55b0: 2f2f 2057 6520 6861 7665 2061 2073 7472  // We have a str
+000a55c0: 696e 6720 6f66 206c 656e 6774 6820 322c  ing of length 2,
+000a55d0: 2034 206f 7220 362e 0a20 202f 2f20 5765   4 or 6..  // We
+000a55e0: 206e 6f77 2063 6865 636b 2074 6865 2066   now check the f
+000a55f0: 6972 7374 2063 6861 7261 6374 6572 3a0a  irst character:.
+000a5600: 2020 6966 2028 2869 6e70 7574 5b30 5d20    if ((input[0] 
+000a5610: 213d 2027 2e27 2920 2626 2028 696e 7075  != '.') && (inpu
+000a5620: 745b 305d 2021 3d20 2725 2729 2920 7b0a  t[0] != '%')) {.
+000a5630: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000a5640: 3b0a 2020 7d0a 2020 2f2f 2057 6520 6172  ;.  }.  // We ar
+000a5650: 6520 756e 6c69 6b65 6c79 2074 6865 2067  e unlikely the g
+000a5660: 6574 2062 6579 6f6e 6420 7468 6973 2070  et beyond this p
+000a5670: 6f69 6e74 2e0a 2020 696e 7420 6861 7368  oint..  int hash
+000a5680: 5f76 616c 7565 203d 2028 696e 7075 742e  _value = (input.
+000a5690: 7369 7a65 2829 202b 2028 756e 7369 676e  size() + (unsign
+000a56a0: 6564 2928 696e 7075 745b 305d 2929 2026  ed)(input[0])) &
+000a56b0: 2033 3b0a 2020 636f 6e73 7420 7374 643a   3;.  const std:
+000a56c0: 3a73 7472 696e 675f 7669 6577 2074 6172  :string_view tar
+000a56d0: 6765 7420 3d20 7461 626c 655f 6973 5f64  get = table_is_d
+000a56e0: 6f75 626c 655f 646f 745f 7061 7468 5f73  ouble_dot_path_s
+000a56f0: 6567 6d65 6e74 5b68 6173 685f 7661 6c75  egment[hash_valu
+000a5700: 655d 3b0a 2020 6966 2028 7461 7267 6574  e];.  if (target
+000a5710: 2e73 697a 6528 2920 213d 2069 6e70 7574  .size() != input
+000a5720: 2e73 697a 6528 2929 207b 0a20 2020 2072  .size()) {.    r
+000a5730: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
+000a5740: 0a20 202f 2f20 5765 2061 6c6d 6f73 7420  .  // We almost 
+000a5750: 6e65 7665 7220 6765 7420 6865 7265 2e0a  never get here..
+000a5760: 2020 2f2f 204f 7074 696d 697a 696e 6720    // Optimizing 
+000a5770: 7468 6520 7265 7374 2069 7320 7265 6c61  the rest is rela
+000a5780: 7469 7665 6c79 2075 6e69 6d70 6f72 7461  tively unimporta
+000a5790: 6e74 2e0a 2020 6175 746f 2070 7265 6669  nt..  auto prefi
+000a57a0: 785f 6571 7561 6c5f 756e 7361 6665 203d  x_equal_unsafe =
+000a57b0: 205b 5d28 7374 643a 3a73 7472 696e 675f   [](std::string_
+000a57c0: 7669 6577 2061 2c20 7374 643a 3a73 7472  view a, std::str
+000a57d0: 696e 675f 7669 6577 2062 2920 7b0a 2020  ing_view b) {.  
+000a57e0: 2020 7569 6e74 3136 5f74 2041 2c20 423b    uint16_t A, B;
+000a57f0: 0a20 2020 206d 656d 6370 7928 2641 2c20  .    memcpy(&A, 
+000a5800: 612e 6461 7461 2829 2c20 7369 7a65 6f66  a.data(), sizeof
+000a5810: 2841 2929 3b0a 2020 2020 6d65 6d63 7079  (A));.    memcpy
+000a5820: 2826 422c 2062 2e64 6174 6128 292c 2073  (&B, b.data(), s
+000a5830: 697a 656f 6628 4229 293b 0a20 2020 2072  izeof(B));.    r
+000a5840: 6574 7572 6e20 4120 3d3d 2042 3b0a 2020  eturn A == B;.  
+000a5850: 7d3b 0a20 2069 6620 2821 7072 6566 6978  };.  if (!prefix
+000a5860: 5f65 7175 616c 5f75 6e73 6166 6528 696e  _equal_unsafe(in
+000a5870: 7075 742c 2074 6172 6765 7429 2920 7b0a  put, target)) {.
+000a5880: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000a5890: 3b0a 2020 7d0a 2020 666f 7220 2873 697a  ;.  }.  for (siz
+000a58a0: 655f 7420 6920 3d20 323b 2069 203c 2069  e_t i = 2; i < i
+000a58b0: 6e70 7574 2e73 697a 6528 293b 2069 2b2b  nput.size(); i++
+000a58c0: 2920 7b0a 2020 2020 6368 6172 2063 203d  ) {.    char c =
+000a58d0: 2069 6e70 7574 5b69 5d3b 0a20 2020 2069   input[i];.    i
+000a58e0: 6620 2828 7569 6e74 385f 7428 2863 207c  f ((uint8_t((c |
+000a58f0: 2030 7832 3029 202d 2030 7836 3129 203c   0x20) - 0x61) <
+000a5900: 3d20 3235 203f 2028 6320 7c20 3078 3230  = 25 ? (c | 0x20
+000a5910: 2920 3a20 6329 2021 3d20 7461 7267 6574  ) : c) != target
+000a5920: 5b69 5d29 207b 0a20 2020 2020 2072 6574  [i]) {.      ret
+000a5930: 7572 6e20 6661 6c73 653b 0a20 2020 207d  urn false;.    }
+000a5940: 0a20 207d 0a20 2072 6574 7572 6e20 7472  .  }.  return tr
+000a5950: 7565 3b0a 2020 2f2f 2054 6865 2061 626f  ue;.  // The abo
+000a5960: 7665 2063 6f64 6520 6d69 6768 7420 6265  ve code might be
+000a5970: 2061 2062 6974 2062 6574 7465 7220 7468   a bit better th
+000a5980: 616e 2074 6865 2063 6f64 6520 6265 6c6f  an the code belo
+000a5990: 772e 2043 6f6d 7069 6c65 7273 0a20 202f  w. Compilers.  /
+000a59a0: 2f20 6172 6520 6e6f 7420 7374 7570 6964  / are not stupid
+000a59b0: 2061 6e64 206d 6179 2075 7365 2074 6865   and may use the
+000a59c0: 2066 6163 7420 7468 6174 2074 6865 7365   fact that these
+000a59d0: 2073 7472 696e 6773 2068 6176 6520 6c65   strings have le
+000a59e0: 6e67 7468 2032 2c34 2061 6e64 0a20 202f  ngth 2,4 and.  /
+000a59f0: 2f20 3620 616e 6420 6f74 6865 7220 7472  / 6 and other tr
+000a5a00: 6963 6b73 2e0a 2020 2f2f 2072 6574 7572  icks..  // retur
+000a5a10: 6e20 696e 7075 7420 3d3d 2022 2e2e 2220  n input == ".." 
+000a5a20: 7c7c 0a20 202f 2f20 2069 6e70 7574 203d  ||.  //  input =
+000a5a30: 3d20 222e 2532 6522 207c 7c20 696e 7075  = ".%2e" || inpu
+000a5a40: 7420 3d3d 2022 2e25 3245 2220 7c7c 0a20  t == ".%2E" ||. 
+000a5a50: 202f 2f20 2069 6e70 7574 203d 3d20 2225   //  input == "%
+000a5a60: 3265 2e22 207c 7c20 696e 7075 7420 3d3d  2e." || input ==
+000a5a70: 2022 2532 452e 2220 7c7c 0a20 202f 2f20   "%2E." ||.  // 
+000a5a80: 2069 6e70 7574 203d 3d20 2225 3265 2532   input == "%2e%2
+000a5a90: 6522 207c 7c20 696e 7075 7420 3d3d 2022  e" || input == "
+000a5aa0: 2532 4525 3245 2220 7c7c 2069 6e70 7574  %2E%2E" || input
+000a5ab0: 203d 3d20 2225 3245 2532 6522 207c 7c20   == "%2E%2e" || 
+000a5ac0: 696e 7075 7420 3d3d 0a20 202f 2f20 2022  input ==.  //  "
+000a5ad0: 2532 6525 3245 223b 0a7d 0a0a 6164 615f  %2e%2E";.}..ada_
+000a5ae0: 7265 616c 6c79 5f69 6e6c 696e 6520 636f  really_inline co
+000a5af0: 6e73 7465 7870 7220 626f 6f6c 2069 735f  nstexpr bool is_
+000a5b00: 7369 6e67 6c65 5f64 6f74 5f70 6174 685f  single_dot_path_
+000a5b10: 7365 676d 656e 7428 0a20 2020 2073 7464  segment(.    std
+000a5b20: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
+000a5b30: 7075 7429 206e 6f65 7863 6570 7420 7b0a  put) noexcept {.
+000a5b40: 2020 7265 7475 726e 2069 6e70 7574 203d    return input =
+000a5b50: 3d20 222e 2220 7c7c 2069 6e70 7574 203d  = "." || input =
+000a5b60: 3d20 2225 3265 2220 7c7c 2069 6e70 7574  = "%2e" || input
+000a5b70: 203d 3d20 2225 3245 223b 0a7d 0a0a 6164   == "%2E";.}..ad
+000a5b80: 615f 7265 616c 6c79 5f69 6e6c 696e 6520  a_really_inline 
+000a5b90: 636f 6e73 7465 7870 7220 626f 6f6c 2069  constexpr bool i
+000a5ba0: 735f 6c6f 7765 7263 6173 655f 6865 7828  s_lowercase_hex(
+000a5bb0: 636f 6e73 7420 6368 6172 2063 2920 6e6f  const char c) no
+000a5bc0: 6578 6365 7074 207b 0a20 2072 6574 7572  except {.  retur
+000a5bd0: 6e20 2863 203e 3d20 2730 2720 2626 2063  n (c >= '0' && c
+000a5be0: 203c 3d20 2739 2729 207c 7c20 2863 203e   <= '9') || (c >
+000a5bf0: 3d20 2761 2720 2626 2063 203c 3d20 2766  = 'a' && c <= 'f
+000a5c00: 2729 3b0a 7d0a 0a75 6e73 6967 6e65 6420  ');.}..unsigned 
+000a5c10: 636f 6e73 7465 7870 7220 636f 6e76 6572  constexpr conver
+000a5c20: 745f 6865 785f 746f 5f62 696e 6172 7928  t_hex_to_binary(
+000a5c30: 636f 6e73 7420 6368 6172 2063 2920 6e6f  const char c) no
+000a5c40: 6578 6365 7074 207b 0a20 202f 2f20 7468  except {.  // th
+000a5c50: 6973 2063 6f64 6520 6361 6e20 6265 206f  is code can be o
+000a5c60: 7074 696d 697a 6564 2e0a 2020 6966 2028  ptimized..  if (
+000a5c70: 6320 3c3d 2027 3927 2920 7b0a 2020 2020  c <= '9') {.    
+000a5c80: 7265 7475 726e 2063 202d 2027 3027 3b0a  return c - '0';.
+000a5c90: 2020 7d0a 2020 6368 6172 2064 656c 203d    }.  char del =
+000a5ca0: 2063 203e 3d20 2761 2720 3f20 2761 2720   c >= 'a' ? 'a' 
+000a5cb0: 3a20 2741 273b 0a20 2072 6574 7572 6e20  : 'A';.  return 
+000a5cc0: 3130 202b 2028 6320 2d20 6465 6c29 3b0a  10 + (c - del);.
+000a5cd0: 7d0a 0a73 7464 3a3a 7374 7269 6e67 2070  }..std::string p
+000a5ce0: 6572 6365 6e74 5f64 6563 6f64 6528 636f  ercent_decode(co
+000a5cf0: 6e73 7420 7374 643a 3a73 7472 696e 675f  nst std::string_
+000a5d00: 7669 6577 2069 6e70 7574 2c20 7369 7a65  view input, size
+000a5d10: 5f74 2066 6972 7374 5f70 6572 6365 6e74  _t first_percent
+000a5d20: 2920 7b0a 2020 2f2f 206e 6578 7420 6c69  ) {.  // next li
+000a5d30: 6e65 2069 7320 666f 7220 7361 6665 7479  ne is for safety
+000a5d40: 206f 6e6c 792c 2077 6520 6578 7065 6374   only, we expect
+000a5d50: 2075 7365 7273 2074 6f20 6176 6f69 6420   users to avoid 
+000a5d60: 6361 6c6c 696e 670a 2020 2f2f 2070 6572  calling.  // per
+000a5d70: 6365 6e74 5f64 6563 6f64 6520 7768 656e  cent_decode when
+000a5d80: 2066 6972 7374 5f70 6572 6365 6e74 2069   first_percent i
+000a5d90: 7320 6f75 7473 6964 6520 7468 6520 7261  s outside the ra
+000a5da0: 6e67 652e 0a20 2069 6620 2866 6972 7374  nge..  if (first
+000a5db0: 5f70 6572 6365 6e74 203d 3d20 7374 643a  _percent == std:
+000a5dc0: 3a73 7472 696e 675f 7669 6577 3a3a 6e70  :string_view::np
+000a5dd0: 6f73 2920 7b0a 2020 2020 7265 7475 726e  os) {.    return
+000a5de0: 2073 7464 3a3a 7374 7269 6e67 2869 6e70   std::string(inp
+000a5df0: 7574 293b 0a20 207d 0a20 2073 7464 3a3a  ut);.  }.  std::
+000a5e00: 7374 7269 6e67 2064 6573 7428 696e 7075  string dest(inpu
+000a5e10: 742e 7375 6273 7472 2830 2c20 6669 7273  t.substr(0, firs
+000a5e20: 745f 7065 7263 656e 7429 293b 0a20 2064  t_percent));.  d
+000a5e30: 6573 742e 7265 7365 7276 6528 696e 7075  est.reserve(inpu
+000a5e40: 742e 6c65 6e67 7468 2829 293b 0a20 2063  t.length());.  c
+000a5e50: 6f6e 7374 2063 6861 722a 2070 6f69 6e74  onst char* point
+000a5e60: 6572 203d 2069 6e70 7574 2e64 6174 6128  er = input.data(
+000a5e70: 2920 2b20 6669 7273 745f 7065 7263 656e  ) + first_percen
+000a5e80: 743b 0a20 2063 6f6e 7374 2063 6861 722a  t;.  const char*
+000a5e90: 2065 6e64 203d 2069 6e70 7574 2e64 6174   end = input.dat
+000a5ea0: 6128 2920 2b20 696e 7075 742e 7369 7a65  a() + input.size
+000a5eb0: 2829 3b0a 2020 2f2f 204f 7074 696d 697a  ();.  // Optimiz
+000a5ec0: 6174 696f 6e20 6f70 706f 7274 756e 6974  ation opportunit
+000a5ed0: 793a 2069 6620 7468 6520 666f 6c6c 6f77  y: if the follow
+000a5ee0: 696e 6720 636f 6465 2067 6574 730a 2020  ing code gets.  
+000a5ef0: 2f2f 2063 616c 6c65 6420 6f66 7465 6e2c  // called often,
+000a5f00: 2069 7420 6361 6e20 6265 206f 7074 696d   it can be optim
+000a5f10: 697a 6564 2071 7569 7465 2061 2062 6974  ized quite a bit
+000a5f20: 2e0a 2020 7768 696c 6520 2870 6f69 6e74  ..  while (point
+000a5f30: 6572 203c 2065 6e64 2920 7b0a 2020 2020  er < end) {.    
+000a5f40: 636f 6e73 7420 6368 6172 2063 6820 3d20  const char ch = 
+000a5f50: 706f 696e 7465 725b 305d 3b0a 2020 2020  pointer[0];.    
+000a5f60: 7369 7a65 5f74 2072 656d 6169 6e69 6e67  size_t remaining
+000a5f70: 203d 2065 6e64 202d 2070 6f69 6e74 6572   = end - pointer
+000a5f80: 202d 2031 3b0a 2020 2020 6966 2028 6368   - 1;.    if (ch
+000a5f90: 2021 3d20 2725 2720 7c7c 2072 656d 6169   != '%' || remai
+000a5fa0: 6e69 6e67 203c 2032 207c 7c0a 2020 2020  ning < 2 ||.    
+000a5fb0: 2020 2020 2820 202f 2f20 6368 203d 3d20      (  // ch == 
+000a5fc0: 2725 2720 2626 202f 2f20 4974 2069 7320  '%' && // It is 
+000a5fd0: 756e 6e65 6365 7373 6172 7920 746f 2063  unnecessary to c
+000a5fe0: 6865 636b 2074 6861 7420 6368 203d 3d20  heck that ch == 
+000a5ff0: 2725 272e 0a20 2020 2020 2020 2020 2020  '%'..           
+000a6000: 2028 2169 735f 6173 6369 695f 6865 785f   (!is_ascii_hex_
+000a6010: 6469 6769 7428 706f 696e 7465 725b 315d  digit(pointer[1]
+000a6020: 2920 7c7c 0a20 2020 2020 2020 2020 2020  ) ||.           
+000a6030: 2020 2169 735f 6173 6369 695f 6865 785f    !is_ascii_hex_
+000a6040: 6469 6769 7428 706f 696e 7465 725b 325d  digit(pointer[2]
+000a6050: 2929 2929 207b 0a20 2020 2020 2064 6573  )))) {.      des
+000a6060: 7420 2b3d 2063 683b 0a20 2020 2020 2070  t += ch;.      p
+000a6070: 6f69 6e74 6572 2b2b 3b0a 2020 2020 2020  ointer++;.      
+000a6080: 636f 6e74 696e 7565 3b0a 2020 2020 7d20  continue;.    } 
+000a6090: 656c 7365 207b 0a20 2020 2020 2075 6e73  else {.      uns
+000a60a0: 6967 6e65 6420 6120 3d20 636f 6e76 6572  igned a = conver
+000a60b0: 745f 6865 785f 746f 5f62 696e 6172 7928  t_hex_to_binary(
+000a60c0: 706f 696e 7465 725b 315d 293b 0a20 2020  pointer[1]);.   
+000a60d0: 2020 2075 6e73 6967 6e65 6420 6220 3d20     unsigned b = 
+000a60e0: 636f 6e76 6572 745f 6865 785f 746f 5f62  convert_hex_to_b
+000a60f0: 696e 6172 7928 706f 696e 7465 725b 325d  inary(pointer[2]
+000a6100: 293b 0a20 2020 2020 2063 6861 7220 6320  );.      char c 
+000a6110: 3d20 7374 6174 6963 5f63 6173 743c 6368  = static_cast<ch
+000a6120: 6172 3e28 6120 2a20 3136 202b 2062 293b  ar>(a * 16 + b);
+000a6130: 0a20 2020 2020 2064 6573 7420 2b3d 2063  .      dest += c
+000a6140: 3b0a 2020 2020 2020 706f 696e 7465 7220  ;.      pointer 
+000a6150: 2b3d 2033 3b0a 2020 2020 7d0a 2020 7d0a  += 3;.    }.  }.
+000a6160: 2020 7265 7475 726e 2064 6573 743b 0a7d    return dest;.}
+000a6170: 0a0a 7374 643a 3a73 7472 696e 6720 7065  ..std::string pe
+000a6180: 7263 656e 745f 656e 636f 6465 2863 6f6e  rcent_encode(con
+000a6190: 7374 2073 7464 3a3a 7374 7269 6e67 5f76  st std::string_v
+000a61a0: 6965 7720 696e 7075 742c 0a20 2020 2020  iew input,.     
 000a61b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a61c0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-000a61d0: 7438 5f74 2063 6861 7261 6374 6572 5f73  t8_t character_s
-000a61e0: 6574 5b5d 2920 7b0a 2020 6175 746f 2070  et[]) {.  auto p
-000a61f0: 6f69 6e74 6572 203d 0a20 2020 2020 2073  ointer =.      s
-000a6200: 7464 3a3a 6669 6e64 5f69 6628 696e 7075  td::find_if(inpu
-000a6210: 742e 6265 6769 6e28 292c 2069 6e70 7574  t.begin(), input
-000a6220: 2e65 6e64 2829 2c20 5b63 6861 7261 6374  .end(), [charact
-000a6230: 6572 5f73 6574 5d28 636f 6e73 7420 6368  er_set](const ch
-000a6240: 6172 2063 2920 7b0a 2020 2020 2020 2020  ar c) {.        
-000a6250: 7265 7475 726e 2063 6861 7261 6374 6572  return character
-000a6260: 5f73 6574 733a 3a62 6974 5f61 7428 6368  _sets::bit_at(ch
-000a6270: 6172 6163 7465 725f 7365 742c 2063 293b  aracter_set, c);
-000a6280: 0a20 2020 2020 207d 293b 0a20 202f 2f20  .      });.  // 
-000a6290: 4f70 7469 6d69 7a61 7469 6f6e 3a20 446f  Optimization: Do
-000a62a0: 6e27 7420 6974 6572 6174 6520 6966 2070  n't iterate if p
-000a62b0: 6572 6365 6e74 2065 6e63 6f64 6520 6973  ercent encode is
-000a62c0: 206e 6f74 2072 6571 7569 7265 640a 2020   not required.  
-000a62d0: 6966 2028 706f 696e 7465 7220 3d3d 2069  if (pointer == i
-000a62e0: 6e70 7574 2e65 6e64 2829 2920 7b0a 2020  nput.end()) {.  
-000a62f0: 2020 7265 7475 726e 2073 7464 3a3a 7374    return std::st
-000a6300: 7269 6e67 2869 6e70 7574 293b 0a20 207d  ring(input);.  }
-000a6310: 0a0a 2020 7374 643a 3a73 7472 696e 6720  ..  std::string 
-000a6320: 7265 7375 6c74 2869 6e70 7574 2e73 7562  result(input.sub
-000a6330: 7374 7228 302c 2073 7464 3a3a 6469 7374  str(0, std::dist
-000a6340: 616e 6365 2869 6e70 7574 2e62 6567 696e  ance(input.begin
-000a6350: 2829 2c20 706f 696e 7465 7229 2929 3b0a  (), pointer)));.
-000a6360: 2020 7265 7375 6c74 2e72 6573 6572 7665    result.reserve
-000a6370: 2869 6e70 7574 2e6c 656e 6774 6828 2929  (input.length())
-000a6380: 3b20 202f 2f20 696e 2074 6865 2077 6f72  ;  // in the wor
-000a6390: 7374 2063 6173 652c 2070 6572 6365 6e74  st case, percent
-000a63a0: 2065 6e63 6f64 696e 6720 6d69 6768 740a   encoding might.
+000a61c0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+000a61d0: 385f 7420 6368 6172 6163 7465 725f 7365  8_t character_se
+000a61e0: 745b 5d29 207b 0a20 2061 7574 6f20 706f  t[]) {.  auto po
+000a61f0: 696e 7465 7220 3d0a 2020 2020 2020 7374  inter =.      st
+000a6200: 643a 3a66 696e 645f 6966 2869 6e70 7574  d::find_if(input
+000a6210: 2e62 6567 696e 2829 2c20 696e 7075 742e  .begin(), input.
+000a6220: 656e 6428 292c 205b 6368 6172 6163 7465  end(), [characte
+000a6230: 725f 7365 745d 2863 6f6e 7374 2063 6861  r_set](const cha
+000a6240: 7220 6329 207b 0a20 2020 2020 2020 2072  r c) {.        r
+000a6250: 6574 7572 6e20 6368 6172 6163 7465 725f  eturn character_
+000a6260: 7365 7473 3a3a 6269 745f 6174 2863 6861  sets::bit_at(cha
+000a6270: 7261 6374 6572 5f73 6574 2c20 6329 3b0a  racter_set, c);.
+000a6280: 2020 2020 2020 7d29 3b0a 2020 2f2f 204f        });.  // O
+000a6290: 7074 696d 697a 6174 696f 6e3a 2044 6f6e  ptimization: Don
+000a62a0: 2774 2069 7465 7261 7465 2069 6620 7065  't iterate if pe
+000a62b0: 7263 656e 7420 656e 636f 6465 2069 7320  rcent encode is 
+000a62c0: 6e6f 7420 7265 7175 6972 6564 0a20 2069  not required.  i
+000a62d0: 6620 2870 6f69 6e74 6572 203d 3d20 696e  f (pointer == in
+000a62e0: 7075 742e 656e 6428 2929 207b 0a20 2020  put.end()) {.   
+000a62f0: 2072 6574 7572 6e20 7374 643a 3a73 7472   return std::str
+000a6300: 696e 6728 696e 7075 7429 3b0a 2020 7d0a  ing(input);.  }.
+000a6310: 0a20 2073 7464 3a3a 7374 7269 6e67 2072  .  std::string r
+000a6320: 6573 756c 7428 696e 7075 742e 7375 6273  esult(input.subs
+000a6330: 7472 2830 2c20 7374 643a 3a64 6973 7461  tr(0, std::dista
+000a6340: 6e63 6528 696e 7075 742e 6265 6769 6e28  nce(input.begin(
+000a6350: 292c 2070 6f69 6e74 6572 2929 293b 0a20  ), pointer)));. 
+000a6360: 2072 6573 756c 742e 7265 7365 7276 6528   result.reserve(
+000a6370: 696e 7075 742e 6c65 6e67 7468 2829 293b  input.length());
+000a6380: 2020 2f2f 2069 6e20 7468 6520 776f 7273    // in the wors
+000a6390: 7420 6361 7365 2c20 7065 7263 656e 7420  t case, percent 
+000a63a0: 656e 636f 6469 6e67 206d 6967 6874 0a20  encoding might. 
 000a63b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a63c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a63d0: 2020 202f 2f20 7072 6f64 7563 6520 3320     // produce 3 
-000a63e0: 6368 6172 6163 7465 7273 2e0a 0a20 2066  characters...  f
-000a63f0: 6f72 2028 3b20 706f 696e 7465 7220 213d  or (; pointer !=
-000a6400: 2069 6e70 7574 2e65 6e64 2829 3b20 706f   input.end(); po
-000a6410: 696e 7465 722b 2b29 207b 0a20 2020 2069  inter++) {.    i
-000a6420: 6620 2863 6861 7261 6374 6572 5f73 6574  f (character_set
-000a6430: 733a 3a62 6974 5f61 7428 6368 6172 6163  s::bit_at(charac
-000a6440: 7465 725f 7365 742c 202a 706f 696e 7465  ter_set, *pointe
-000a6450: 7229 2920 7b0a 2020 2020 2020 7265 7375  r)) {.      resu
-000a6460: 6c74 2e61 7070 656e 6428 6368 6172 6163  lt.append(charac
-000a6470: 7465 725f 7365 7473 3a3a 6865 7820 2b20  ter_sets::hex + 
-000a6480: 7569 6e74 385f 7428 2a70 6f69 6e74 6572  uint8_t(*pointer
-000a6490: 2920 2a20 342c 2033 293b 0a20 2020 207d  ) * 4, 3);.    }
-000a64a0: 2065 6c73 6520 7b0a 2020 2020 2020 7265   else {.      re
-000a64b0: 7375 6c74 202b 3d20 2a70 6f69 6e74 6572  sult += *pointer
-000a64c0: 3b0a 2020 2020 7d0a 2020 7d0a 0a20 2072  ;.    }.  }..  r
-000a64d0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-000a64e0: 0a74 656d 706c 6174 6520 3c62 6f6f 6c20  .template <bool 
-000a64f0: 6170 7065 6e64 3e0a 626f 6f6c 2070 6572  append>.bool per
-000a6500: 6365 6e74 5f65 6e63 6f64 6528 636f 6e73  cent_encode(cons
-000a6510: 7420 7374 643a 3a73 7472 696e 675f 7669  t std::string_vi
-000a6520: 6577 2069 6e70 7574 2c20 636f 6e73 7420  ew input, const 
-000a6530: 7569 6e74 385f 7420 6368 6172 6163 7465  uint8_t characte
-000a6540: 725f 7365 745b 5d2c 0a20 2020 2020 2020  r_set[],.       
-000a6550: 2020 2020 2020 2020 2020 2020 2073 7464               std
-000a6560: 3a3a 7374 7269 6e67 2620 6f75 7429 207b  ::string& out) {
-000a6570: 0a20 2061 6461 5f6c 6f67 2822 7065 7263  .  ada_log("perc
-000a6580: 656e 745f 656e 636f 6465 2022 2c20 696e  ent_encode ", in
-000a6590: 7075 742c 2022 2074 6f20 6f75 7470 7574  put, " to output
-000a65a0: 2073 7472 696e 6720 7768 696c 6520 222c   string while ",
-000a65b0: 0a20 2020 2020 2020 2020 2061 7070 656e  .          appen
-000a65c0: 6420 3f20 2261 7070 656e 6469 6e67 2220  d ? "appending" 
-000a65d0: 3a20 226f 7665 7277 7269 7469 6e67 2229  : "overwriting")
-000a65e0: 3b0a 2020 6175 746f 2070 6f69 6e74 6572  ;.  auto pointer
-000a65f0: 203d 0a20 2020 2020 2073 7464 3a3a 6669   =.      std::fi
-000a6600: 6e64 5f69 6628 696e 7075 742e 6265 6769  nd_if(input.begi
-000a6610: 6e28 292c 2069 6e70 7574 2e65 6e64 2829  n(), input.end()
-000a6620: 2c20 5b63 6861 7261 6374 6572 5f73 6574  , [character_set
-000a6630: 5d28 636f 6e73 7420 6368 6172 2063 2920  ](const char c) 
-000a6640: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-000a6650: 2063 6861 7261 6374 6572 5f73 6574 733a   character_sets:
-000a6660: 3a62 6974 5f61 7428 6368 6172 6163 7465  :bit_at(characte
-000a6670: 725f 7365 742c 2063 293b 0a20 2020 2020  r_set, c);.     
-000a6680: 207d 293b 0a20 2061 6461 5f6c 6f67 2822   });.  ada_log("
-000a6690: 7065 7263 656e 745f 656e 636f 6465 2064  percent_encode d
-000a66a0: 6f6e 6520 6368 6563 6b69 6e67 2c20 6d6f  one checking, mo
-000a66b0: 7665 6420 746f 2022 2c0a 2020 2020 2020  ved to ",.      
-000a66c0: 2020 2020 7374 643a 3a64 6973 7461 6e63      std::distanc
-000a66d0: 6528 696e 7075 742e 6265 6769 6e28 292c  e(input.begin(),
-000a66e0: 2070 6f69 6e74 6572 2929 3b0a 0a20 202f   pointer));..  /
-000a66f0: 2f20 4f70 7469 6d69 7a61 7469 6f6e 3a20  / Optimization: 
-000a6700: 446f 6e27 7420 6974 6572 6174 6520 6966  Don't iterate if
-000a6710: 2070 6572 6365 6e74 2065 6e63 6f64 6520   percent encode 
-000a6720: 6973 206e 6f74 2072 6571 7569 7265 640a  is not required.
-000a6730: 2020 6966 2028 706f 696e 7465 7220 3d3d    if (pointer ==
-000a6740: 2069 6e70 7574 2e65 6e64 2829 2920 7b0a   input.end()) {.
-000a6750: 2020 2020 6164 615f 6c6f 6728 2270 6572      ada_log("per
-000a6760: 6365 6e74 5f65 6e63 6f64 6520 656e 636f  cent_encode enco
-000a6770: 6469 6e67 206e 6f74 206e 6565 6465 642e  ding not needed.
-000a6780: 2229 3b0a 2020 2020 7265 7475 726e 2066  ");.    return f
-000a6790: 616c 7365 3b0a 2020 7d0a 2020 6966 2028  alse;.  }.  if (
-000a67a0: 2161 7070 656e 6429 207b 0a20 2020 206f  !append) {.    o
-000a67b0: 7574 2e63 6c65 6172 2829 3b0a 2020 7d0a  ut.clear();.  }.
-000a67c0: 2020 6164 615f 6c6f 6728 2270 6572 6365    ada_log("perce
-000a67d0: 6e74 5f65 6e63 6f64 6520 6170 7065 6e64  nt_encode append
-000a67e0: 696e 6720 222c 2073 7464 3a3a 6469 7374  ing ", std::dist
-000a67f0: 616e 6365 2869 6e70 7574 2e62 6567 696e  ance(input.begin
-000a6800: 2829 2c20 706f 696e 7465 7229 2c0a 2020  (), pointer),.  
-000a6810: 2020 2020 2020 2020 2220 6279 7465 7322          " bytes"
-000a6820: 293b 0a20 206f 7574 2e61 7070 656e 6428  );.  out.append(
-000a6830: 696e 7075 742e 6461 7461 2829 2c20 7374  input.data(), st
-000a6840: 643a 3a64 6973 7461 6e63 6528 696e 7075  d::distance(inpu
-000a6850: 742e 6265 6769 6e28 292c 2070 6f69 6e74  t.begin(), point
-000a6860: 6572 2929 3b0a 2020 6164 615f 6c6f 6728  er));.  ada_log(
-000a6870: 2270 6572 6365 6e74 5f65 6e63 6f64 6520  "percent_encode 
-000a6880: 7072 6f63 6573 7369 6e67 2022 2c20 7374  processing ", st
-000a6890: 643a 3a64 6973 7461 6e63 6528 706f 696e  d::distance(poin
-000a68a0: 7465 722c 2069 6e70 7574 2e65 6e64 2829  ter, input.end()
-000a68b0: 292c 0a20 2020 2020 2020 2020 2022 2062  ),.          " b
-000a68c0: 7974 6573 2229 3b0a 2020 666f 7220 283b  ytes");.  for (;
-000a68d0: 2070 6f69 6e74 6572 2021 3d20 696e 7075   pointer != inpu
-000a68e0: 742e 656e 6428 293b 2070 6f69 6e74 6572  t.end(); pointer
-000a68f0: 2b2b 2920 7b0a 2020 2020 6966 2028 6368  ++) {.    if (ch
-000a6900: 6172 6163 7465 725f 7365 7473 3a3a 6269  aracter_sets::bi
-000a6910: 745f 6174 2863 6861 7261 6374 6572 5f73  t_at(character_s
-000a6920: 6574 2c20 2a70 6f69 6e74 6572 2929 207b  et, *pointer)) {
-000a6930: 0a20 2020 2020 206f 7574 2e61 7070 656e  .      out.appen
-000a6940: 6428 6368 6172 6163 7465 725f 7365 7473  d(character_sets
-000a6950: 3a3a 6865 7820 2b20 7569 6e74 385f 7428  ::hex + uint8_t(
-000a6960: 2a70 6f69 6e74 6572 2920 2a20 342c 2033  *pointer) * 4, 3
-000a6970: 293b 0a20 2020 207d 2065 6c73 6520 7b0a  );.    } else {.
-000a6980: 2020 2020 2020 6f75 7420 2b3d 202a 706f        out += *po
-000a6990: 696e 7465 723b 0a20 2020 207d 0a20 207d  inter;.    }.  }
-000a69a0: 0a20 2072 6574 7572 6e20 7472 7565 3b0a  .  return true;.
-000a69b0: 7d0a 0a62 6f6f 6c20 746f 5f61 7363 6969  }..bool to_ascii
-000a69c0: 2873 7464 3a3a 6f70 7469 6f6e 616c 3c73  (std::optional<s
-000a69d0: 7464 3a3a 7374 7269 6e67 3e26 206f 7574  td::string>& out
-000a69e0: 2c20 636f 6e73 7420 7374 643a 3a73 7472  , const std::str
-000a69f0: 696e 675f 7669 6577 2070 6c61 696e 2c0a  ing_view plain,.
-000a6a00: 2020 2020 2020 2020 2020 2020 2020 7369                si
-000a6a10: 7a65 5f74 2066 6972 7374 5f70 6572 6365  ze_t first_perce
-000a6a20: 6e74 2920 7b0a 2020 7374 643a 3a73 7472  nt) {.  std::str
-000a6a30: 696e 6720 7065 7263 656e 745f 6465 636f  ing percent_deco
-000a6a40: 6465 645f 6275 6666 6572 3b0a 2020 7374  ded_buffer;.  st
-000a6a50: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
-000a6a60: 6e70 7574 203d 2070 6c61 696e 3b0a 2020  nput = plain;.  
-000a6a70: 6966 2028 6669 7273 745f 7065 7263 656e  if (first_percen
-000a6a80: 7420 213d 2073 7464 3a3a 7374 7269 6e67  t != std::string
-000a6a90: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
-000a6aa0: 2020 2070 6572 6365 6e74 5f64 6563 6f64     percent_decod
-000a6ab0: 6564 5f62 7566 6665 7220 3d20 756e 6963  ed_buffer = unic
-000a6ac0: 6f64 653a 3a70 6572 6365 6e74 5f64 6563  ode::percent_dec
-000a6ad0: 6f64 6528 706c 6169 6e2c 2066 6972 7374  ode(plain, first
-000a6ae0: 5f70 6572 6365 6e74 293b 0a20 2020 2069  _percent);.    i
-000a6af0: 6e70 7574 203d 2070 6572 6365 6e74 5f64  nput = percent_d
-000a6b00: 6563 6f64 6564 5f62 7566 6665 723b 0a20  ecoded_buffer;. 
-000a6b10: 207d 0a20 202f 2f20 696e 7075 7420 6973   }.  // input is
-000a6b20: 2061 206e 6f6e 2d65 6d70 7479 2055 5446   a non-empty UTF
-000a6b30: 2d38 2073 7472 696e 672c 206d 7573 7420  -8 string, must 
-000a6b40: 6265 2070 6572 6365 6e74 2064 6563 6f64  be percent decod
-000a6b50: 6564 0a20 2073 7464 3a3a 7374 7269 6e67  ed.  std::string
-000a6b60: 2069 646e 615f 6173 6369 6920 3d20 6164   idna_ascii = ad
-000a6b70: 613a 3a69 646e 613a 3a74 6f5f 6173 6369  a::idna::to_asci
-000a6b80: 6928 696e 7075 7429 3b0a 2020 6966 2028  i(input);.  if (
-000a6b90: 6964 6e61 5f61 7363 6969 2e65 6d70 7479  idna_ascii.empty
-000a6ba0: 2829 207c 7c20 636f 6e74 6169 6e73 5f66  () || contains_f
-000a6bb0: 6f72 6269 6464 656e 5f64 6f6d 6169 6e5f  orbidden_domain_
-000a6bc0: 636f 6465 5f70 6f69 6e74 280a 2020 2020  code_point(.    
+000a63d0: 2020 2f2f 2070 726f 6475 6365 2033 2063    // produce 3 c
+000a63e0: 6861 7261 6374 6572 732e 0a0a 2020 666f  haracters...  fo
+000a63f0: 7220 283b 2070 6f69 6e74 6572 2021 3d20  r (; pointer != 
+000a6400: 696e 7075 742e 656e 6428 293b 2070 6f69  input.end(); poi
+000a6410: 6e74 6572 2b2b 2920 7b0a 2020 2020 6966  nter++) {.    if
+000a6420: 2028 6368 6172 6163 7465 725f 7365 7473   (character_sets
+000a6430: 3a3a 6269 745f 6174 2863 6861 7261 6374  ::bit_at(charact
+000a6440: 6572 5f73 6574 2c20 2a70 6f69 6e74 6572  er_set, *pointer
+000a6450: 2929 207b 0a20 2020 2020 2072 6573 756c  )) {.      resul
+000a6460: 742e 6170 7065 6e64 2863 6861 7261 6374  t.append(charact
+000a6470: 6572 5f73 6574 733a 3a68 6578 202b 2075  er_sets::hex + u
+000a6480: 696e 7438 5f74 282a 706f 696e 7465 7229  int8_t(*pointer)
+000a6490: 202a 2034 2c20 3329 3b0a 2020 2020 7d20   * 4, 3);.    } 
+000a64a0: 656c 7365 207b 0a20 2020 2020 2072 6573  else {.      res
+000a64b0: 756c 7420 2b3d 202a 706f 696e 7465 723b  ult += *pointer;
+000a64c0: 0a20 2020 207d 0a20 207d 0a0a 2020 7265  .    }.  }..  re
+000a64d0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+000a64e0: 7465 6d70 6c61 7465 203c 626f 6f6c 2061  template <bool a
+000a64f0: 7070 656e 643e 0a62 6f6f 6c20 7065 7263  ppend>.bool perc
+000a6500: 656e 745f 656e 636f 6465 2863 6f6e 7374  ent_encode(const
+000a6510: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000a6520: 7720 696e 7075 742c 2063 6f6e 7374 2075  w input, const u
+000a6530: 696e 7438 5f74 2063 6861 7261 6374 6572  int8_t character
+000a6540: 5f73 6574 5b5d 2c0a 2020 2020 2020 2020  _set[],.        
+000a6550: 2020 2020 2020 2020 2020 2020 7374 643a              std:
+000a6560: 3a73 7472 696e 6726 206f 7574 2920 7b0a  :string& out) {.
+000a6570: 2020 6164 615f 6c6f 6728 2270 6572 6365    ada_log("perce
+000a6580: 6e74 5f65 6e63 6f64 6520 222c 2069 6e70  nt_encode ", inp
+000a6590: 7574 2c20 2220 746f 206f 7574 7075 7420  ut, " to output 
+000a65a0: 7374 7269 6e67 2077 6869 6c65 2022 2c0a  string while ",.
+000a65b0: 2020 2020 2020 2020 2020 6170 7065 6e64            append
+000a65c0: 203f 2022 6170 7065 6e64 696e 6722 203a   ? "appending" :
+000a65d0: 2022 6f76 6572 7772 6974 696e 6722 293b   "overwriting");
+000a65e0: 0a20 2061 7574 6f20 706f 696e 7465 7220  .  auto pointer 
+000a65f0: 3d0a 2020 2020 2020 7374 643a 3a66 696e  =.      std::fin
+000a6600: 645f 6966 2869 6e70 7574 2e62 6567 696e  d_if(input.begin
+000a6610: 2829 2c20 696e 7075 742e 656e 6428 292c  (), input.end(),
+000a6620: 205b 6368 6172 6163 7465 725f 7365 745d   [character_set]
+000a6630: 2863 6f6e 7374 2063 6861 7220 6329 207b  (const char c) {
+000a6640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000a6650: 6368 6172 6163 7465 725f 7365 7473 3a3a  character_sets::
+000a6660: 6269 745f 6174 2863 6861 7261 6374 6572  bit_at(character
+000a6670: 5f73 6574 2c20 6329 3b0a 2020 2020 2020  _set, c);.      
+000a6680: 7d29 3b0a 2020 6164 615f 6c6f 6728 2270  });.  ada_log("p
+000a6690: 6572 6365 6e74 5f65 6e63 6f64 6520 646f  ercent_encode do
+000a66a0: 6e65 2063 6865 636b 696e 672c 206d 6f76  ne checking, mov
+000a66b0: 6564 2074 6f20 222c 0a20 2020 2020 2020  ed to ",.       
+000a66c0: 2020 2073 7464 3a3a 6469 7374 616e 6365     std::distance
+000a66d0: 2869 6e70 7574 2e62 6567 696e 2829 2c20  (input.begin(), 
+000a66e0: 706f 696e 7465 7229 293b 0a0a 2020 2f2f  pointer));..  //
+000a66f0: 204f 7074 696d 697a 6174 696f 6e3a 2044   Optimization: D
+000a6700: 6f6e 2774 2069 7465 7261 7465 2069 6620  on't iterate if 
+000a6710: 7065 7263 656e 7420 656e 636f 6465 2069  percent encode i
+000a6720: 7320 6e6f 7420 7265 7175 6972 6564 0a20  s not required. 
+000a6730: 2069 6620 2870 6f69 6e74 6572 203d 3d20   if (pointer == 
+000a6740: 696e 7075 742e 656e 6428 2929 207b 0a20  input.end()) {. 
+000a6750: 2020 2061 6461 5f6c 6f67 2822 7065 7263     ada_log("perc
+000a6760: 656e 745f 656e 636f 6465 2065 6e63 6f64  ent_encode encod
+000a6770: 696e 6720 6e6f 7420 6e65 6564 6564 2e22  ing not needed."
+000a6780: 293b 0a20 2020 2072 6574 7572 6e20 6661  );.    return fa
+000a6790: 6c73 653b 0a20 207d 0a20 2069 6620 2821  lse;.  }.  if (!
+000a67a0: 6170 7065 6e64 2920 7b0a 2020 2020 6f75  append) {.    ou
+000a67b0: 742e 636c 6561 7228 293b 0a20 207d 0a20  t.clear();.  }. 
+000a67c0: 2061 6461 5f6c 6f67 2822 7065 7263 656e   ada_log("percen
+000a67d0: 745f 656e 636f 6465 2061 7070 656e 6469  t_encode appendi
+000a67e0: 6e67 2022 2c20 7374 643a 3a64 6973 7461  ng ", std::dista
+000a67f0: 6e63 6528 696e 7075 742e 6265 6769 6e28  nce(input.begin(
+000a6800: 292c 2070 6f69 6e74 6572 292c 0a20 2020  ), pointer),.   
+000a6810: 2020 2020 2020 2022 2062 7974 6573 2229         " bytes")
+000a6820: 3b0a 2020 6f75 742e 6170 7065 6e64 2869  ;.  out.append(i
+000a6830: 6e70 7574 2e64 6174 6128 292c 2073 7464  nput.data(), std
+000a6840: 3a3a 6469 7374 616e 6365 2869 6e70 7574  ::distance(input
+000a6850: 2e62 6567 696e 2829 2c20 706f 696e 7465  .begin(), pointe
+000a6860: 7229 293b 0a20 2061 6461 5f6c 6f67 2822  r));.  ada_log("
+000a6870: 7065 7263 656e 745f 656e 636f 6465 2070  percent_encode p
+000a6880: 726f 6365 7373 696e 6720 222c 2073 7464  rocessing ", std
+000a6890: 3a3a 6469 7374 616e 6365 2870 6f69 6e74  ::distance(point
+000a68a0: 6572 2c20 696e 7075 742e 656e 6428 2929  er, input.end())
+000a68b0: 2c0a 2020 2020 2020 2020 2020 2220 6279  ,.          " by
+000a68c0: 7465 7322 293b 0a20 2066 6f72 2028 3b20  tes");.  for (; 
+000a68d0: 706f 696e 7465 7220 213d 2069 6e70 7574  pointer != input
+000a68e0: 2e65 6e64 2829 3b20 706f 696e 7465 722b  .end(); pointer+
+000a68f0: 2b29 207b 0a20 2020 2069 6620 2863 6861  +) {.    if (cha
+000a6900: 7261 6374 6572 5f73 6574 733a 3a62 6974  racter_sets::bit
+000a6910: 5f61 7428 6368 6172 6163 7465 725f 7365  _at(character_se
+000a6920: 742c 202a 706f 696e 7465 7229 2920 7b0a  t, *pointer)) {.
+000a6930: 2020 2020 2020 6f75 742e 6170 7065 6e64        out.append
+000a6940: 2863 6861 7261 6374 6572 5f73 6574 733a  (character_sets:
+000a6950: 3a68 6578 202b 2075 696e 7438 5f74 282a  :hex + uint8_t(*
+000a6960: 706f 696e 7465 7229 202a 2034 2c20 3329  pointer) * 4, 3)
+000a6970: 3b0a 2020 2020 7d20 656c 7365 207b 0a20  ;.    } else {. 
+000a6980: 2020 2020 206f 7574 202b 3d20 2a70 6f69       out += *poi
+000a6990: 6e74 6572 3b0a 2020 2020 7d0a 2020 7d0a  nter;.    }.  }.
+000a69a0: 2020 7265 7475 726e 2074 7275 653b 0a7d    return true;.}
+000a69b0: 0a0a 626f 6f6c 2074 6f5f 6173 6369 6928  ..bool to_ascii(
+000a69c0: 7374 643a 3a6f 7074 696f 6e61 6c3c 7374  std::optional<st
+000a69d0: 643a 3a73 7472 696e 673e 2620 6f75 742c  d::string>& out,
+000a69e0: 2063 6f6e 7374 2073 7464 3a3a 7374 7269   const std::stri
+000a69f0: 6e67 5f76 6965 7720 706c 6169 6e2c 0a20  ng_view plain,. 
+000a6a00: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+000a6a10: 655f 7420 6669 7273 745f 7065 7263 656e  e_t first_percen
+000a6a20: 7429 207b 0a20 2073 7464 3a3a 7374 7269  t) {.  std::stri
+000a6a30: 6e67 2070 6572 6365 6e74 5f64 6563 6f64  ng percent_decod
+000a6a40: 6564 5f62 7566 6665 723b 0a20 2073 7464  ed_buffer;.  std
+000a6a50: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
+000a6a60: 7075 7420 3d20 706c 6169 6e3b 0a20 2069  put = plain;.  i
+000a6a70: 6620 2866 6972 7374 5f70 6572 6365 6e74  f (first_percent
+000a6a80: 2021 3d20 7374 643a 3a73 7472 696e 675f   != std::string_
+000a6a90: 7669 6577 3a3a 6e70 6f73 2920 7b0a 2020  view::npos) {.  
+000a6aa0: 2020 7065 7263 656e 745f 6465 636f 6465    percent_decode
+000a6ab0: 645f 6275 6666 6572 203d 2075 6e69 636f  d_buffer = unico
+000a6ac0: 6465 3a3a 7065 7263 656e 745f 6465 636f  de::percent_deco
+000a6ad0: 6465 2870 6c61 696e 2c20 6669 7273 745f  de(plain, first_
+000a6ae0: 7065 7263 656e 7429 3b0a 2020 2020 696e  percent);.    in
+000a6af0: 7075 7420 3d20 7065 7263 656e 745f 6465  put = percent_de
+000a6b00: 636f 6465 645f 6275 6666 6572 3b0a 2020  coded_buffer;.  
+000a6b10: 7d0a 2020 2f2f 2069 6e70 7574 2069 7320  }.  // input is 
+000a6b20: 6120 6e6f 6e2d 656d 7074 7920 5554 462d  a non-empty UTF-
+000a6b30: 3820 7374 7269 6e67 2c20 6d75 7374 2062  8 string, must b
+000a6b40: 6520 7065 7263 656e 7420 6465 636f 6465  e percent decode
+000a6b50: 640a 2020 7374 643a 3a73 7472 696e 6720  d.  std::string 
+000a6b60: 6964 6e61 5f61 7363 6969 203d 2061 6461  idna_ascii = ada
+000a6b70: 3a3a 6964 6e61 3a3a 746f 5f61 7363 6969  ::idna::to_ascii
+000a6b80: 2869 6e70 7574 293b 0a20 2069 6620 2869  (input);.  if (i
+000a6b90: 646e 615f 6173 6369 692e 656d 7074 7928  dna_ascii.empty(
+000a6ba0: 2920 7c7c 2063 6f6e 7461 696e 735f 666f  ) || contains_fo
+000a6bb0: 7262 6964 6465 6e5f 646f 6d61 696e 5f63  rbidden_domain_c
+000a6bc0: 6f64 655f 706f 696e 7428 0a20 2020 2020  ode_point(.     
 000a6bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a6be0: 2020 2020 2020 2020 2020 2020 6964 6e61              idna
-000a6bf0: 5f61 7363 6969 2e64 6174 6128 292c 2069  _ascii.data(), i
-000a6c00: 646e 615f 6173 6369 692e 7369 7a65 2829  dna_ascii.size()
-000a6c10: 2929 207b 0a20 2020 2072 6574 7572 6e20  )) {.    return 
-000a6c20: 6661 6c73 653b 0a20 207d 0a20 206f 7574  false;.  }.  out
-000a6c30: 203d 2073 7464 3a3a 6d6f 7665 2869 646e   = std::move(idn
-000a6c40: 615f 6173 6369 6929 3b0a 2020 7265 7475  a_ascii);.  retu
-000a6c50: 726e 2074 7275 653b 0a7d 0a0a 7374 643a  rn true;.}..std:
-000a6c60: 3a73 7472 696e 6720 7065 7263 656e 745f  :string percent_
-000a6c70: 656e 636f 6465 2863 6f6e 7374 2073 7464  encode(const std
-000a6c80: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
-000a6c90: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
-000a6ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a6cb0: 636f 6e73 7420 7569 6e74 385f 7420 6368  const uint8_t ch
-000a6cc0: 6172 6163 7465 725f 7365 745b 5d2c 2073  aracter_set[], s
-000a6cd0: 697a 655f 7420 696e 6465 7829 207b 0a20  ize_t index) {. 
-000a6ce0: 2073 7464 3a3a 7374 7269 6e67 206f 7574   std::string out
-000a6cf0: 3b0a 2020 6f75 742e 6170 7065 6e64 2869  ;.  out.append(i
-000a6d00: 6e70 7574 2e64 6174 6128 292c 2069 6e64  nput.data(), ind
-000a6d10: 6578 293b 0a20 2061 7574 6f20 706f 696e  ex);.  auto poin
-000a6d20: 7465 7220 3d20 696e 7075 742e 6265 6769  ter = input.begi
-000a6d30: 6e28 2920 2b20 696e 6465 783b 0a20 2066  n() + index;.  f
-000a6d40: 6f72 2028 3b20 706f 696e 7465 7220 213d  or (; pointer !=
-000a6d50: 2069 6e70 7574 2e65 6e64 2829 3b20 706f   input.end(); po
-000a6d60: 696e 7465 722b 2b29 207b 0a20 2020 2069  inter++) {.    i
-000a6d70: 6620 2863 6861 7261 6374 6572 5f73 6574  f (character_set
-000a6d80: 733a 3a62 6974 5f61 7428 6368 6172 6163  s::bit_at(charac
-000a6d90: 7465 725f 7365 742c 202a 706f 696e 7465  ter_set, *pointe
-000a6da0: 7229 2920 7b0a 2020 2020 2020 6f75 742e  r)) {.      out.
-000a6db0: 6170 7065 6e64 2863 6861 7261 6374 6572  append(character
-000a6dc0: 5f73 6574 733a 3a68 6578 202b 2075 696e  _sets::hex + uin
-000a6dd0: 7438 5f74 282a 706f 696e 7465 7229 202a  t8_t(*pointer) *
-000a6de0: 2034 2c20 3329 3b0a 2020 2020 7d20 656c   4, 3);.    } el
-000a6df0: 7365 207b 0a20 2020 2020 206f 7574 202b  se {.      out +
-000a6e00: 3d20 2a70 6f69 6e74 6572 3b0a 2020 2020  = *pointer;.    
-000a6e10: 7d0a 2020 7d0a 2020 7265 7475 726e 206f  }.  }.  return o
-000a6e20: 7574 3b0a 7d0a 0a73 7464 3a3a 7374 7269  ut;.}..std::stri
-000a6e30: 6e67 2074 6f5f 756e 6963 6f64 6528 7374  ng to_unicode(st
-000a6e40: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
-000a6e50: 6e70 7574 2920 7b0a 2020 7265 7475 726e  nput) {.  return
-000a6e60: 2061 6461 3a3a 6964 6e61 3a3a 746f 5f75   ada::idna::to_u
-000a6e70: 6e69 636f 6465 2869 6e70 7574 293b 0a7d  nicode(input);.}
-000a6e80: 0a0a 7d20 202f 2f20 6e61 6d65 7370 6163  ..}  // namespac
-000a6e90: 6520 6164 613a 3a75 6e69 636f 6465 0a2f  e ada::unicode./
-000a6ea0: 2a20 656e 6420 6669 6c65 2073 7263 2f75  * end file src/u
-000a6eb0: 6e69 636f 6465 2e63 7070 202a 2f0a 2f2a  nicode.cpp */./*
-000a6ec0: 2062 6567 696e 2066 696c 6520 7372 632f   begin file src/
-000a6ed0: 7365 7269 616c 697a 6572 732e 6370 7020  serializers.cpp 
-000a6ee0: 2a2f 0a0a 2369 6e63 6c75 6465 203c 6172  */..#include <ar
-000a6ef0: 7261 793e 0a23 696e 636c 7564 6520 3c73  ray>.#include <s
-000a6f00: 7472 696e 673e 0a0a 6e61 6d65 7370 6163  tring>..namespac
-000a6f10: 6520 6164 613a 3a73 6572 6961 6c69 7a65  e ada::serialize
-000a6f20: 7273 207b 0a0a 766f 6964 2066 696e 645f  rs {..void find_
-000a6f30: 6c6f 6e67 6573 745f 7365 7175 656e 6365  longest_sequence
-000a6f40: 5f6f 665f 6970 7636 5f70 6965 6365 7328  _of_ipv6_pieces(
-000a6f50: 0a20 2020 2063 6f6e 7374 2073 7464 3a3a  .    const std::
-000a6f60: 6172 7261 793c 7569 6e74 3136 5f74 2c20  array<uint16_t, 
-000a6f70: 383e 2620 6164 6472 6573 732c 2073 697a  8>& address, siz
-000a6f80: 655f 7426 2063 6f6d 7072 6573 732c 0a20  e_t& compress,. 
-000a6f90: 2020 2073 697a 655f 7426 2063 6f6d 7072     size_t& compr
-000a6fa0: 6573 735f 6c65 6e67 7468 2920 6e6f 6578  ess_length) noex
-000a6fb0: 6365 7074 207b 0a20 2066 6f72 2028 7369  cept {.  for (si
-000a6fc0: 7a65 5f74 2069 203d 2030 3b20 6920 3c20  ze_t i = 0; i < 
-000a6fd0: 383b 2069 2b2b 2920 7b0a 2020 2020 6966  8; i++) {.    if
-000a6fe0: 2028 6164 6472 6573 735b 695d 203d 3d20   (address[i] == 
-000a6ff0: 3029 207b 0a20 2020 2020 2073 697a 655f  0) {.      size_
-000a7000: 7420 6e65 7874 203d 2069 202b 2031 3b0a  t next = i + 1;.
-000a7010: 2020 2020 2020 7768 696c 6520 286e 6578        while (nex
-000a7020: 7420 213d 2038 2026 2620 6164 6472 6573  t != 8 && addres
-000a7030: 735b 6e65 7874 5d20 3d3d 2030 2920 2b2b  s[next] == 0) ++
-000a7040: 6e65 7874 3b0a 2020 2020 2020 636f 6e73  next;.      cons
-000a7050: 7420 7369 7a65 5f74 2063 6f75 6e74 203d  t size_t count =
-000a7060: 206e 6578 7420 2d20 693b 0a20 2020 2020   next - i;.     
-000a7070: 2069 6620 2863 6f6d 7072 6573 735f 6c65   if (compress_le
-000a7080: 6e67 7468 203c 2063 6f75 6e74 2920 7b0a  ngth < count) {.
-000a7090: 2020 2020 2020 2020 636f 6d70 7265 7373          compress
-000a70a0: 5f6c 656e 6774 6820 3d20 636f 756e 743b  _length = count;
-000a70b0: 0a20 2020 2020 2020 2063 6f6d 7072 6573  .        compres
-000a70c0: 7320 3d20 693b 0a20 2020 2020 2020 2069  s = i;.        i
-000a70d0: 6620 286e 6578 7420 3d3d 2038 2920 6272  f (next == 8) br
-000a70e0: 6561 6b3b 0a20 2020 2020 2020 2069 203d  eak;.        i =
-000a70f0: 206e 6578 743b 0a20 2020 2020 207d 0a20   next;.      }. 
-000a7100: 2020 207d 0a20 207d 0a7d 0a0a 7374 643a     }.  }.}..std:
-000a7110: 3a73 7472 696e 6720 6970 7636 2863 6f6e  :string ipv6(con
-000a7120: 7374 2073 7464 3a3a 6172 7261 793c 7569  st std::array<ui
-000a7130: 6e74 3136 5f74 2c20 383e 2620 6164 6472  nt16_t, 8>& addr
-000a7140: 6573 7329 206e 6f65 7863 6570 7420 7b0a  ess) noexcept {.
-000a7150: 2020 7369 7a65 5f74 2063 6f6d 7072 6573    size_t compres
-000a7160: 735f 6c65 6e67 7468 203d 2030 3b20 202f  s_length = 0;  /
-000a7170: 2f20 5468 6520 6c65 6e67 7468 206f 6620  / The length of 
-000a7180: 6120 6c6f 6e67 2073 6571 7565 6e63 6520  a long sequence 
-000a7190: 6f66 207a 6572 6f73 2e0a 2020 7369 7a65  of zeros..  size
-000a71a0: 5f74 2063 6f6d 7072 6573 7320 3d20 303b  _t compress = 0;
-000a71b0: 2020 2020 2020 2020 202f 2f20 5468 6520           // The 
-000a71c0: 7374 6172 7420 6f66 2061 206c 6f6e 6720  start of a long 
-000a71d0: 7365 7175 656e 6365 206f 6620 7a65 726f  sequence of zero
-000a71e0: 732e 0a20 2066 696e 645f 6c6f 6e67 6573  s..  find_longes
-000a71f0: 745f 7365 7175 656e 6365 5f6f 665f 6970  t_sequence_of_ip
-000a7200: 7636 5f70 6965 6365 7328 6164 6472 6573  v6_pieces(addres
-000a7210: 732c 2063 6f6d 7072 6573 732c 2063 6f6d  s, compress, com
-000a7220: 7072 6573 735f 6c65 6e67 7468 293b 0a0a  press_length);..
-000a7230: 2020 6966 2028 636f 6d70 7265 7373 5f6c    if (compress_l
-000a7240: 656e 6774 6820 3c3d 2031 2920 7b0a 2020  ength <= 1) {.  
-000a7250: 2020 2f2f 204f 7074 696d 697a 6174 696f    // Optimizatio
-000a7260: 6e20 6f70 706f 7274 756e 6974 793a 2046  n opportunity: F
-000a7270: 696e 6420 6120 6661 7374 6572 2077 6179  ind a faster way
-000a7280: 2074 6865 6e20 736e 7072 696e 7466 2066   then snprintf f
-000a7290: 6f72 2069 6d70 6c6f 6469 6e67 0a20 2020  or imploding.   
-000a72a0: 202f 2f20 616e 6420 7265 7475 726e 2068   // and return h
-000a72b0: 6572 652e 0a20 2020 2063 6f6d 7072 6573  ere..    compres
-000a72c0: 7320 3d20 636f 6d70 7265 7373 5f6c 656e  s = compress_len
-000a72d0: 6774 6820 3d20 383b 0a20 207d 0a0a 2020  gth = 8;.  }..  
-000a72e0: 7374 643a 3a73 7472 696e 6720 6f75 7470  std::string outp
-000a72f0: 7574 2834 202a 2038 202b 2037 202b 2032  ut(4 * 8 + 7 + 2
-000a7300: 2c20 275c 3027 293b 0a20 2073 697a 655f  , '\0');.  size_
-000a7310: 7420 7069 6563 655f 696e 6465 7820 3d20  t piece_index = 
-000a7320: 303b 0a20 2063 6861 722a 2070 6f69 6e74  0;.  char* point
-000a7330: 203d 206f 7574 7075 742e 6461 7461 2829   = output.data()
-000a7340: 3b0a 2020 6368 6172 2a20 706f 696e 745f  ;.  char* point_
-000a7350: 656e 6420 3d20 6f75 7470 7574 2e64 6174  end = output.dat
-000a7360: 6128 2920 2b20 6f75 7470 7574 2e73 697a  a() + output.siz
-000a7370: 6528 293b 0a20 202a 706f 696e 742b 2b20  e();.  *point++ 
-000a7380: 3d20 275b 273b 0a20 2077 6869 6c65 2028  = '[';.  while (
-000a7390: 7472 7565 2920 7b0a 2020 2020 6966 2028  true) {.    if (
-000a73a0: 7069 6563 655f 696e 6465 7820 3d3d 2063  piece_index == c
-000a73b0: 6f6d 7072 6573 7329 207b 0a20 2020 2020  ompress) {.     
-000a73c0: 202a 706f 696e 742b 2b20 3d20 273a 273b   *point++ = ':';
-000a73d0: 0a20 2020 2020 202f 2f20 4966 2077 6520  .      // If we 
-000a73e0: 736b 6970 2061 2076 616c 7565 2069 6e69  skip a value ini
-000a73f0: 7469 616c 6c79 2c20 7765 206e 6565 6420  tially, we need 
-000a7400: 746f 2077 7269 7465 2027 3a3a 272c 206f  to write '::', o
-000a7410: 7468 6572 7769 7365 0a20 2020 2020 202f  therwise.      /
-000a7420: 2f20 6120 7369 6e67 6c65 2027 3a27 2077  / a single ':' w
-000a7430: 696c 6c20 646f 2073 696e 6365 2069 7420  ill do since it 
-000a7440: 666f 6c6c 6f77 7320 6120 7072 6576 696f  follows a previo
-000a7450: 7573 2027 3a27 2e0a 2020 2020 2020 6966  us ':'..      if
-000a7460: 2028 7069 6563 655f 696e 6465 7820 3d3d   (piece_index ==
-000a7470: 2030 2920 7b0a 2020 2020 2020 2020 2a70   0) {.        *p
-000a7480: 6f69 6e74 2b2b 203d 2027 3a27 3b0a 2020  oint++ = ':';.  
-000a7490: 2020 2020 7d0a 2020 2020 2020 7069 6563      }.      piec
-000a74a0: 655f 696e 6465 7820 2b3d 2063 6f6d 7072  e_index += compr
-000a74b0: 6573 735f 6c65 6e67 7468 3b0a 2020 2020  ess_length;.    
-000a74c0: 2020 6966 2028 7069 6563 655f 696e 6465    if (piece_inde
-000a74d0: 7820 3d3d 2038 2920 7b0a 2020 2020 2020  x == 8) {.      
-000a74e0: 2020 6272 6561 6b3b 0a20 2020 2020 207d    break;.      }
-000a74f0: 0a20 2020 207d 0a20 2020 2070 6f69 6e74  .    }.    point
-000a7500: 203d 2073 7464 3a3a 746f 5f63 6861 7273   = std::to_chars
-000a7510: 2870 6f69 6e74 2c20 706f 696e 745f 656e  (point, point_en
-000a7520: 642c 2061 6464 7265 7373 5b70 6965 6365  d, address[piece
-000a7530: 5f69 6e64 6578 5d2c 2031 3629 2e70 7472  _index], 16).ptr
-000a7540: 3b0a 2020 2020 7069 6563 655f 696e 6465  ;.    piece_inde
-000a7550: 782b 2b3b 0a20 2020 2069 6620 2870 6965  x++;.    if (pie
-000a7560: 6365 5f69 6e64 6578 203d 3d20 3829 207b  ce_index == 8) {
-000a7570: 0a20 2020 2020 2062 7265 616b 3b0a 2020  .      break;.  
-000a7580: 2020 7d0a 2020 2020 2a70 6f69 6e74 2b2b    }.    *point++
-000a7590: 203d 2027 3a27 3b0a 2020 7d0a 2020 2a70   = ':';.  }.  *p
-000a75a0: 6f69 6e74 2b2b 203d 2027 5d27 3b0a 2020  oint++ = ']';.  
-000a75b0: 6f75 7470 7574 2e72 6573 697a 6528 706f  output.resize(po
-000a75c0: 696e 7420 2d20 6f75 7470 7574 2e64 6174  int - output.dat
-000a75d0: 6128 2929 3b0a 2020 7265 7475 726e 206f  a());.  return o
-000a75e0: 7574 7075 743b 0a7d 0a0a 7374 643a 3a73  utput;.}..std::s
-000a75f0: 7472 696e 6720 6970 7634 2863 6f6e 7374  tring ipv4(const
-000a7600: 2075 696e 7436 345f 7420 6164 6472 6573   uint64_t addres
-000a7610: 7329 206e 6f65 7863 6570 7420 7b0a 2020  s) noexcept {.  
-000a7620: 7374 643a 3a73 7472 696e 6720 6f75 7470  std::string outp
-000a7630: 7574 2831 352c 2027 5c30 2729 3b0a 2020  ut(15, '\0');.  
-000a7640: 6368 6172 2a20 706f 696e 7420 3d20 6f75  char* point = ou
-000a7650: 7470 7574 2e64 6174 6128 293b 0a20 2063  tput.data();.  c
-000a7660: 6861 722a 2070 6f69 6e74 5f65 6e64 203d  har* point_end =
-000a7670: 206f 7574 7075 742e 6461 7461 2829 202b   output.data() +
-000a7680: 206f 7574 7075 742e 7369 7a65 2829 3b0a   output.size();.
-000a7690: 2020 706f 696e 7420 3d20 7374 643a 3a74    point = std::t
-000a76a0: 6f5f 6368 6172 7328 706f 696e 742c 2070  o_chars(point, p
-000a76b0: 6f69 6e74 5f65 6e64 2c20 7569 6e74 385f  oint_end, uint8_
-000a76c0: 7428 6164 6472 6573 7320 3e3e 2032 3429  t(address >> 24)
-000a76d0: 292e 7074 723b 0a20 2066 6f72 2028 696e  ).ptr;.  for (in
-000a76e0: 7420 6920 3d20 323b 2069 203e 3d20 303b  t i = 2; i >= 0;
-000a76f0: 2069 2d2d 2920 7b0a 2020 2020 2a70 6f69   i--) {.    *poi
-000a7700: 6e74 2b2b 203d 2027 2e27 3b0a 2020 2020  nt++ = '.';.    
-000a7710: 706f 696e 7420 3d20 7374 643a 3a74 6f5f  point = std::to_
-000a7720: 6368 6172 7328 706f 696e 742c 2070 6f69  chars(point, poi
-000a7730: 6e74 5f65 6e64 2c20 7569 6e74 385f 7428  nt_end, uint8_t(
-000a7740: 6164 6472 6573 7320 3e3e 2028 6920 2a20  address >> (i * 
-000a7750: 3829 2929 2e70 7472 3b0a 2020 7d0a 2020  8))).ptr;.  }.  
-000a7760: 6f75 7470 7574 2e72 6573 697a 6528 706f  output.resize(po
-000a7770: 696e 7420 2d20 6f75 7470 7574 2e64 6174  int - output.dat
-000a7780: 6128 2929 3b0a 2020 7265 7475 726e 206f  a());.  return o
-000a7790: 7574 7075 743b 0a7d 0a0a 7d20 202f 2f20  utput;.}..}  // 
-000a77a0: 6e61 6d65 7370 6163 6520 6164 613a 3a73  namespace ada::s
-000a77b0: 6572 6961 6c69 7a65 7273 0a2f 2a20 656e  erializers./* en
-000a77c0: 6420 6669 6c65 2073 7263 2f73 6572 6961  d file src/seria
-000a77d0: 6c69 7a65 7273 2e63 7070 202a 2f0a 2f2a  lizers.cpp */./*
-000a77e0: 2062 6567 696e 2066 696c 6520 7372 632f   begin file src/
-000a77f0: 696d 706c 656d 656e 7461 7469 6f6e 2e63  implementation.c
-000a7800: 7070 202a 2f0a 2369 6e63 6c75 6465 203c  pp */.#include <
-000a7810: 7374 7269 6e67 5f76 6965 773e 0a0a 0a6e  string_view>...n
-000a7820: 616d 6573 7061 6365 2061 6461 207b 0a0a  amespace ada {..
-000a7830: 7465 6d70 6c61 7465 203c 636c 6173 7320  template <class 
-000a7840: 7265 7375 6c74 5f74 7970 653e 0a61 6461  result_type>.ada
-000a7850: 5f77 6172 6e5f 756e 7573 6564 2074 6c3a  _warn_unused tl:
-000a7860: 3a65 7870 6563 7465 643c 7265 7375 6c74  :expected<result
-000a7870: 5f74 7970 652c 2061 6461 3a3a 6572 726f  _type, ada::erro
-000a7880: 7273 3e20 7061 7273 6528 0a20 2020 2073  rs> parse(.    s
-000a7890: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
-000a78a0: 696e 7075 742c 2063 6f6e 7374 2072 6573  input, const res
-000a78b0: 756c 745f 7479 7065 2a20 6261 7365 5f75  ult_type* base_u
-000a78c0: 726c 2920 7b0a 2020 7265 7375 6c74 5f74  rl) {.  result_t
-000a78d0: 7970 6520 7520 3d20 6164 613a 3a70 6172  ype u = ada::par
-000a78e0: 7365 723a 3a70 6172 7365 5f75 726c 3c72  ser::parse_url<r
-000a78f0: 6573 756c 745f 7479 7065 3e28 696e 7075  esult_type>(inpu
-000a7900: 742c 2062 6173 655f 7572 6c29 3b0a 2020  t, base_url);.  
-000a7910: 6966 2028 2175 2e69 735f 7661 6c69 6429  if (!u.is_valid)
-000a7920: 207b 0a20 2020 2072 6574 7572 6e20 746c   {.    return tl
-000a7930: 3a3a 756e 6578 7065 6374 6564 2865 7272  ::unexpected(err
-000a7940: 6f72 733a 3a67 656e 6572 6963 5f65 7272  ors::generic_err
-000a7950: 6f72 293b 0a20 207d 0a20 2072 6574 7572  or);.  }.  retur
-000a7960: 6e20 753b 0a7d 0a0a 7465 6d70 6c61 7465  n u;.}..template
-000a7970: 2061 6461 3a3a 7265 7375 6c74 3c75 726c   ada::result<url
-000a7980: 3e20 7061 7273 653c 7572 6c3e 2873 7464  > parse<url>(std
-000a7990: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
-000a79a0: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+000a6be0: 2020 2020 2020 2020 2020 2069 646e 615f             idna_
+000a6bf0: 6173 6369 692e 6461 7461 2829 2c20 6964  ascii.data(), id
+000a6c00: 6e61 5f61 7363 6969 2e73 697a 6528 2929  na_ascii.size())
+000a6c10: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
+000a6c20: 616c 7365 3b0a 2020 7d0a 2020 6f75 7420  alse;.  }.  out 
+000a6c30: 3d20 7374 643a 3a6d 6f76 6528 6964 6e61  = std::move(idna
+000a6c40: 5f61 7363 6969 293b 0a20 2072 6574 7572  _ascii);.  retur
+000a6c50: 6e20 7472 7565 3b0a 7d0a 0a73 7464 3a3a  n true;.}..std::
+000a6c60: 7374 7269 6e67 2070 6572 6365 6e74 5f65  string percent_e
+000a6c70: 6e63 6f64 6528 636f 6e73 7420 7374 643a  ncode(const std:
+000a6c80: 3a73 7472 696e 675f 7669 6577 2069 6e70  :string_view inp
+000a6c90: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+000a6ca0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000a6cb0: 6f6e 7374 2075 696e 7438 5f74 2063 6861  onst uint8_t cha
+000a6cc0: 7261 6374 6572 5f73 6574 5b5d 2c20 7369  racter_set[], si
+000a6cd0: 7a65 5f74 2069 6e64 6578 2920 7b0a 2020  ze_t index) {.  
+000a6ce0: 7374 643a 3a73 7472 696e 6720 6f75 743b  std::string out;
+000a6cf0: 0a20 206f 7574 2e61 7070 656e 6428 696e  .  out.append(in
+000a6d00: 7075 742e 6461 7461 2829 2c20 696e 6465  put.data(), inde
+000a6d10: 7829 3b0a 2020 6175 746f 2070 6f69 6e74  x);.  auto point
+000a6d20: 6572 203d 2069 6e70 7574 2e62 6567 696e  er = input.begin
+000a6d30: 2829 202b 2069 6e64 6578 3b0a 2020 666f  () + index;.  fo
+000a6d40: 7220 283b 2070 6f69 6e74 6572 2021 3d20  r (; pointer != 
+000a6d50: 696e 7075 742e 656e 6428 293b 2070 6f69  input.end(); poi
+000a6d60: 6e74 6572 2b2b 2920 7b0a 2020 2020 6966  nter++) {.    if
+000a6d70: 2028 6368 6172 6163 7465 725f 7365 7473   (character_sets
+000a6d80: 3a3a 6269 745f 6174 2863 6861 7261 6374  ::bit_at(charact
+000a6d90: 6572 5f73 6574 2c20 2a70 6f69 6e74 6572  er_set, *pointer
+000a6da0: 2929 207b 0a20 2020 2020 206f 7574 2e61  )) {.      out.a
+000a6db0: 7070 656e 6428 6368 6172 6163 7465 725f  ppend(character_
+000a6dc0: 7365 7473 3a3a 6865 7820 2b20 7569 6e74  sets::hex + uint
+000a6dd0: 385f 7428 2a70 6f69 6e74 6572 2920 2a20  8_t(*pointer) * 
+000a6de0: 342c 2033 293b 0a20 2020 207d 2065 6c73  4, 3);.    } els
+000a6df0: 6520 7b0a 2020 2020 2020 6f75 7420 2b3d  e {.      out +=
+000a6e00: 202a 706f 696e 7465 723b 0a20 2020 207d   *pointer;.    }
+000a6e10: 0a20 207d 0a20 2072 6574 7572 6e20 6f75  .  }.  return ou
+000a6e20: 743b 0a7d 0a0a 7374 643a 3a73 7472 696e  t;.}..std::strin
+000a6e30: 6720 746f 5f75 6e69 636f 6465 2873 7464  g to_unicode(std
+000a6e40: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
+000a6e50: 7075 7429 207b 0a20 2072 6574 7572 6e20  put) {.  return 
+000a6e60: 6164 613a 3a69 646e 613a 3a74 6f5f 756e  ada::idna::to_un
+000a6e70: 6963 6f64 6528 696e 7075 7429 3b0a 7d0a  icode(input);.}.
+000a6e80: 0a7d 2020 2f2f 206e 616d 6573 7061 6365  .}  // namespace
+000a6e90: 2061 6461 3a3a 756e 6963 6f64 650a 2f2a   ada::unicode./*
+000a6ea0: 2065 6e64 2066 696c 6520 7372 632f 756e   end file src/un
+000a6eb0: 6963 6f64 652e 6370 7020 2a2f 0a2f 2a20  icode.cpp */./* 
+000a6ec0: 6265 6769 6e20 6669 6c65 2073 7263 2f73  begin file src/s
+000a6ed0: 6572 6961 6c69 7a65 7273 2e63 7070 202a  erializers.cpp *
+000a6ee0: 2f0a 0a23 696e 636c 7564 6520 3c61 7272  /..#include <arr
+000a6ef0: 6179 3e0a 2369 6e63 6c75 6465 203c 7374  ay>.#include <st
+000a6f00: 7269 6e67 3e0a 0a6e 616d 6573 7061 6365  ring>..namespace
+000a6f10: 2061 6461 3a3a 7365 7269 616c 697a 6572   ada::serializer
+000a6f20: 7320 7b0a 0a76 6f69 6420 6669 6e64 5f6c  s {..void find_l
+000a6f30: 6f6e 6765 7374 5f73 6571 7565 6e63 655f  ongest_sequence_
+000a6f40: 6f66 5f69 7076 365f 7069 6563 6573 280a  of_ipv6_pieces(.
+000a6f50: 2020 2020 636f 6e73 7420 7374 643a 3a61      const std::a
+000a6f60: 7272 6179 3c75 696e 7431 365f 742c 2038  rray<uint16_t, 8
+000a6f70: 3e26 2061 6464 7265 7373 2c20 7369 7a65  >& address, size
+000a6f80: 5f74 2620 636f 6d70 7265 7373 2c0a 2020  _t& compress,.  
+000a6f90: 2020 7369 7a65 5f74 2620 636f 6d70 7265    size_t& compre
+000a6fa0: 7373 5f6c 656e 6774 6829 206e 6f65 7863  ss_length) noexc
+000a6fb0: 6570 7420 7b0a 2020 666f 7220 2873 697a  ept {.  for (siz
+000a6fc0: 655f 7420 6920 3d20 303b 2069 203c 2038  e_t i = 0; i < 8
+000a6fd0: 3b20 692b 2b29 207b 0a20 2020 2069 6620  ; i++) {.    if 
+000a6fe0: 2861 6464 7265 7373 5b69 5d20 3d3d 2030  (address[i] == 0
+000a6ff0: 2920 7b0a 2020 2020 2020 7369 7a65 5f74  ) {.      size_t
+000a7000: 206e 6578 7420 3d20 6920 2b20 313b 0a20   next = i + 1;. 
+000a7010: 2020 2020 2077 6869 6c65 2028 6e65 7874       while (next
+000a7020: 2021 3d20 3820 2626 2061 6464 7265 7373   != 8 && address
+000a7030: 5b6e 6578 745d 203d 3d20 3029 202b 2b6e  [next] == 0) ++n
+000a7040: 6578 743b 0a20 2020 2020 2063 6f6e 7374  ext;.      const
+000a7050: 2073 697a 655f 7420 636f 756e 7420 3d20   size_t count = 
+000a7060: 6e65 7874 202d 2069 3b0a 2020 2020 2020  next - i;.      
+000a7070: 6966 2028 636f 6d70 7265 7373 5f6c 656e  if (compress_len
+000a7080: 6774 6820 3c20 636f 756e 7429 207b 0a20  gth < count) {. 
+000a7090: 2020 2020 2020 2063 6f6d 7072 6573 735f         compress_
+000a70a0: 6c65 6e67 7468 203d 2063 6f75 6e74 3b0a  length = count;.
+000a70b0: 2020 2020 2020 2020 636f 6d70 7265 7373          compress
+000a70c0: 203d 2069 3b0a 2020 2020 2020 2020 6966   = i;.        if
+000a70d0: 2028 6e65 7874 203d 3d20 3829 2062 7265   (next == 8) bre
+000a70e0: 616b 3b0a 2020 2020 2020 2020 6920 3d20  ak;.        i = 
+000a70f0: 6e65 7874 3b0a 2020 2020 2020 7d0a 2020  next;.      }.  
+000a7100: 2020 7d0a 2020 7d0a 7d0a 0a73 7464 3a3a    }.  }.}..std::
+000a7110: 7374 7269 6e67 2069 7076 3628 636f 6e73  string ipv6(cons
+000a7120: 7420 7374 643a 3a61 7272 6179 3c75 696e  t std::array<uin
+000a7130: 7431 365f 742c 2038 3e26 2061 6464 7265  t16_t, 8>& addre
+000a7140: 7373 2920 6e6f 6578 6365 7074 207b 0a20  ss) noexcept {. 
+000a7150: 2073 697a 655f 7420 636f 6d70 7265 7373   size_t compress
+000a7160: 5f6c 656e 6774 6820 3d20 303b 2020 2f2f  _length = 0;  //
+000a7170: 2054 6865 206c 656e 6774 6820 6f66 2061   The length of a
+000a7180: 206c 6f6e 6720 7365 7175 656e 6365 206f   long sequence o
+000a7190: 6620 7a65 726f 732e 0a20 2073 697a 655f  f zeros..  size_
+000a71a0: 7420 636f 6d70 7265 7373 203d 2030 3b20  t compress = 0; 
+000a71b0: 2020 2020 2020 2020 2f2f 2054 6865 2073          // The s
+000a71c0: 7461 7274 206f 6620 6120 6c6f 6e67 2073  tart of a long s
+000a71d0: 6571 7565 6e63 6520 6f66 207a 6572 6f73  equence of zeros
+000a71e0: 2e0a 2020 6669 6e64 5f6c 6f6e 6765 7374  ..  find_longest
+000a71f0: 5f73 6571 7565 6e63 655f 6f66 5f69 7076  _sequence_of_ipv
+000a7200: 365f 7069 6563 6573 2861 6464 7265 7373  6_pieces(address
+000a7210: 2c20 636f 6d70 7265 7373 2c20 636f 6d70  , compress, comp
+000a7220: 7265 7373 5f6c 656e 6774 6829 3b0a 0a20  ress_length);.. 
+000a7230: 2069 6620 2863 6f6d 7072 6573 735f 6c65   if (compress_le
+000a7240: 6e67 7468 203c 3d20 3129 207b 0a20 2020  ngth <= 1) {.   
+000a7250: 202f 2f20 4f70 7469 6d69 7a61 7469 6f6e   // Optimization
+000a7260: 206f 7070 6f72 7475 6e69 7479 3a20 4669   opportunity: Fi
+000a7270: 6e64 2061 2066 6173 7465 7220 7761 7920  nd a faster way 
+000a7280: 7468 656e 2073 6e70 7269 6e74 6620 666f  then snprintf fo
+000a7290: 7220 696d 706c 6f64 696e 670a 2020 2020  r imploding.    
+000a72a0: 2f2f 2061 6e64 2072 6574 7572 6e20 6865  // and return he
+000a72b0: 7265 2e0a 2020 2020 636f 6d70 7265 7373  re..    compress
+000a72c0: 203d 2063 6f6d 7072 6573 735f 6c65 6e67   = compress_leng
+000a72d0: 7468 203d 2038 3b0a 2020 7d0a 0a20 2073  th = 8;.  }..  s
+000a72e0: 7464 3a3a 7374 7269 6e67 206f 7574 7075  td::string outpu
+000a72f0: 7428 3420 2a20 3820 2b20 3720 2b20 322c  t(4 * 8 + 7 + 2,
+000a7300: 2027 5c30 2729 3b0a 2020 7369 7a65 5f74   '\0');.  size_t
+000a7310: 2070 6965 6365 5f69 6e64 6578 203d 2030   piece_index = 0
+000a7320: 3b0a 2020 6368 6172 2a20 706f 696e 7420  ;.  char* point 
+000a7330: 3d20 6f75 7470 7574 2e64 6174 6128 293b  = output.data();
+000a7340: 0a20 2063 6861 722a 2070 6f69 6e74 5f65  .  char* point_e
+000a7350: 6e64 203d 206f 7574 7075 742e 6461 7461  nd = output.data
+000a7360: 2829 202b 206f 7574 7075 742e 7369 7a65  () + output.size
+000a7370: 2829 3b0a 2020 2a70 6f69 6e74 2b2b 203d  ();.  *point++ =
+000a7380: 2027 5b27 3b0a 2020 7768 696c 6520 2874   '[';.  while (t
+000a7390: 7275 6529 207b 0a20 2020 2069 6620 2870  rue) {.    if (p
+000a73a0: 6965 6365 5f69 6e64 6578 203d 3d20 636f  iece_index == co
+000a73b0: 6d70 7265 7373 2920 7b0a 2020 2020 2020  mpress) {.      
+000a73c0: 2a70 6f69 6e74 2b2b 203d 2027 3a27 3b0a  *point++ = ':';.
+000a73d0: 2020 2020 2020 2f2f 2049 6620 7765 2073        // If we s
+000a73e0: 6b69 7020 6120 7661 6c75 6520 696e 6974  kip a value init
+000a73f0: 6961 6c6c 792c 2077 6520 6e65 6564 2074  ially, we need t
+000a7400: 6f20 7772 6974 6520 273a 3a27 2c20 6f74  o write '::', ot
+000a7410: 6865 7277 6973 650a 2020 2020 2020 2f2f  herwise.      //
+000a7420: 2061 2073 696e 676c 6520 273a 2720 7769   a single ':' wi
+000a7430: 6c6c 2064 6f20 7369 6e63 6520 6974 2066  ll do since it f
+000a7440: 6f6c 6c6f 7773 2061 2070 7265 7669 6f75  ollows a previou
+000a7450: 7320 273a 272e 0a20 2020 2020 2069 6620  s ':'..      if 
+000a7460: 2870 6965 6365 5f69 6e64 6578 203d 3d20  (piece_index == 
+000a7470: 3029 207b 0a20 2020 2020 2020 202a 706f  0) {.        *po
+000a7480: 696e 742b 2b20 3d20 273a 273b 0a20 2020  int++ = ':';.   
+000a7490: 2020 207d 0a20 2020 2020 2070 6965 6365     }.      piece
+000a74a0: 5f69 6e64 6578 202b 3d20 636f 6d70 7265  _index += compre
+000a74b0: 7373 5f6c 656e 6774 683b 0a20 2020 2020  ss_length;.     
+000a74c0: 2069 6620 2870 6965 6365 5f69 6e64 6578   if (piece_index
+000a74d0: 203d 3d20 3829 207b 0a20 2020 2020 2020   == 8) {.       
+000a74e0: 2062 7265 616b 3b0a 2020 2020 2020 7d0a   break;.      }.
+000a74f0: 2020 2020 7d0a 2020 2020 706f 696e 7420      }.    point 
+000a7500: 3d20 7374 643a 3a74 6f5f 6368 6172 7328  = std::to_chars(
+000a7510: 706f 696e 742c 2070 6f69 6e74 5f65 6e64  point, point_end
+000a7520: 2c20 6164 6472 6573 735b 7069 6563 655f  , address[piece_
+000a7530: 696e 6465 785d 2c20 3136 292e 7074 723b  index], 16).ptr;
+000a7540: 0a20 2020 2070 6965 6365 5f69 6e64 6578  .    piece_index
+000a7550: 2b2b 3b0a 2020 2020 6966 2028 7069 6563  ++;.    if (piec
+000a7560: 655f 696e 6465 7820 3d3d 2038 2920 7b0a  e_index == 8) {.
+000a7570: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
+000a7580: 207d 0a20 2020 202a 706f 696e 742b 2b20   }.    *point++ 
+000a7590: 3d20 273a 273b 0a20 207d 0a20 202a 706f  = ':';.  }.  *po
+000a75a0: 696e 742b 2b20 3d20 275d 273b 0a20 206f  int++ = ']';.  o
+000a75b0: 7574 7075 742e 7265 7369 7a65 2870 6f69  utput.resize(poi
+000a75c0: 6e74 202d 206f 7574 7075 742e 6461 7461  nt - output.data
+000a75d0: 2829 293b 0a20 2072 6574 7572 6e20 6f75  ());.  return ou
+000a75e0: 7470 7574 3b0a 7d0a 0a73 7464 3a3a 7374  tput;.}..std::st
+000a75f0: 7269 6e67 2069 7076 3428 636f 6e73 7420  ring ipv4(const 
+000a7600: 7569 6e74 3634 5f74 2061 6464 7265 7373  uint64_t address
+000a7610: 2920 6e6f 6578 6365 7074 207b 0a20 2073  ) noexcept {.  s
+000a7620: 7464 3a3a 7374 7269 6e67 206f 7574 7075  td::string outpu
+000a7630: 7428 3135 2c20 275c 3027 293b 0a20 2063  t(15, '\0');.  c
+000a7640: 6861 722a 2070 6f69 6e74 203d 206f 7574  har* point = out
+000a7650: 7075 742e 6461 7461 2829 3b0a 2020 6368  put.data();.  ch
+000a7660: 6172 2a20 706f 696e 745f 656e 6420 3d20  ar* point_end = 
+000a7670: 6f75 7470 7574 2e64 6174 6128 2920 2b20  output.data() + 
+000a7680: 6f75 7470 7574 2e73 697a 6528 293b 0a20  output.size();. 
+000a7690: 2070 6f69 6e74 203d 2073 7464 3a3a 746f   point = std::to
+000a76a0: 5f63 6861 7273 2870 6f69 6e74 2c20 706f  _chars(point, po
+000a76b0: 696e 745f 656e 642c 2075 696e 7438 5f74  int_end, uint8_t
+000a76c0: 2861 6464 7265 7373 203e 3e20 3234 2929  (address >> 24))
+000a76d0: 2e70 7472 3b0a 2020 666f 7220 2869 6e74  .ptr;.  for (int
+000a76e0: 2069 203d 2032 3b20 6920 3e3d 2030 3b20   i = 2; i >= 0; 
+000a76f0: 692d 2d29 207b 0a20 2020 202a 706f 696e  i--) {.    *poin
+000a7700: 742b 2b20 3d20 272e 273b 0a20 2020 2070  t++ = '.';.    p
+000a7710: 6f69 6e74 203d 2073 7464 3a3a 746f 5f63  oint = std::to_c
+000a7720: 6861 7273 2870 6f69 6e74 2c20 706f 696e  hars(point, poin
+000a7730: 745f 656e 642c 2075 696e 7438 5f74 2861  t_end, uint8_t(a
+000a7740: 6464 7265 7373 203e 3e20 2869 202a 2038  ddress >> (i * 8
+000a7750: 2929 292e 7074 723b 0a20 207d 0a20 206f  ))).ptr;.  }.  o
+000a7760: 7574 7075 742e 7265 7369 7a65 2870 6f69  utput.resize(poi
+000a7770: 6e74 202d 206f 7574 7075 742e 6461 7461  nt - output.data
+000a7780: 2829 293b 0a20 2072 6574 7572 6e20 6f75  ());.  return ou
+000a7790: 7470 7574 3b0a 7d0a 0a7d 2020 2f2f 206e  tput;.}..}  // n
+000a77a0: 616d 6573 7061 6365 2061 6461 3a3a 7365  amespace ada::se
+000a77b0: 7269 616c 697a 6572 730a 2f2a 2065 6e64  rializers./* end
+000a77c0: 2066 696c 6520 7372 632f 7365 7269 616c   file src/serial
+000a77d0: 697a 6572 732e 6370 7020 2a2f 0a2f 2a20  izers.cpp */./* 
+000a77e0: 6265 6769 6e20 6669 6c65 2073 7263 2f69  begin file src/i
+000a77f0: 6d70 6c65 6d65 6e74 6174 696f 6e2e 6370  mplementation.cp
+000a7800: 7020 2a2f 0a23 696e 636c 7564 6520 3c73  p */.#include <s
+000a7810: 7472 696e 675f 7669 6577 3e0a 0a0a 6e61  tring_view>...na
+000a7820: 6d65 7370 6163 6520 6164 6120 7b0a 0a74  mespace ada {..t
+000a7830: 656d 706c 6174 6520 3c63 6c61 7373 2072  emplate <class r
+000a7840: 6573 756c 745f 7479 7065 3e0a 6164 615f  esult_type>.ada_
+000a7850: 7761 726e 5f75 6e75 7365 6420 746c 3a3a  warn_unused tl::
+000a7860: 6578 7065 6374 6564 3c72 6573 756c 745f  expected<result_
+000a7870: 7479 7065 2c20 6164 613a 3a65 7272 6f72  type, ada::error
+000a7880: 733e 2070 6172 7365 280a 2020 2020 7374  s> parse(.    st
+000a7890: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
+000a78a0: 6e70 7574 2c20 636f 6e73 7420 7265 7375  nput, const resu
+000a78b0: 6c74 5f74 7970 652a 2062 6173 655f 7572  lt_type* base_ur
+000a78c0: 6c29 207b 0a20 2072 6573 756c 745f 7479  l) {.  result_ty
+000a78d0: 7065 2075 203d 2061 6461 3a3a 7061 7273  pe u = ada::pars
+000a78e0: 6572 3a3a 7061 7273 655f 7572 6c3c 7265  er::parse_url<re
+000a78f0: 7375 6c74 5f74 7970 653e 2869 6e70 7574  sult_type>(input
+000a7900: 2c20 6261 7365 5f75 726c 293b 0a20 2069  , base_url);.  i
+000a7910: 6620 2821 752e 6973 5f76 616c 6964 2920  f (!u.is_valid) 
+000a7920: 7b0a 2020 2020 7265 7475 726e 2074 6c3a  {.    return tl:
+000a7930: 3a75 6e65 7870 6563 7465 6428 6572 726f  :unexpected(erro
+000a7940: 7273 3a3a 6765 6e65 7269 635f 6572 726f  rs::generic_erro
+000a7950: 7229 3b0a 2020 7d0a 2020 7265 7475 726e  r);.  }.  return
+000a7960: 2075 3b0a 7d0a 0a74 656d 706c 6174 6520   u;.}..template 
+000a7970: 6164 613a 3a72 6573 756c 743c 7572 6c3e  ada::result<url>
+000a7980: 2070 6172 7365 3c75 726c 3e28 7374 643a   parse<url>(std:
+000a7990: 3a73 7472 696e 675f 7669 6577 2069 6e70  :string_view inp
+000a79a0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
 000a79b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a79c0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-000a79d0: 7572 6c2a 2062 6173 655f 7572 6c20 3d20  url* base_url = 
-000a79e0: 6e75 6c6c 7074 7229 3b0a 7465 6d70 6c61  nullptr);.templa
-000a79f0: 7465 2061 6461 3a3a 7265 7375 6c74 3c75  te ada::result<u
-000a7a00: 726c 5f61 6767 7265 6761 746f 723e 2070  rl_aggregator> p
-000a7a10: 6172 7365 3c75 726c 5f61 6767 7265 6761  arse<url_aggrega
-000a7a20: 746f 723e 280a 2020 2020 7374 643a 3a73  tor>(.    std::s
-000a7a30: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
-000a7a40: 2c20 636f 6e73 7420 7572 6c5f 6167 6772  , const url_aggr
-000a7a50: 6567 6174 6f72 2a20 6261 7365 5f75 726c  egator* base_url
-000a7a60: 203d 206e 756c 6c70 7472 293b 0a0a 7374   = nullptr);..st
-000a7a70: 643a 3a73 7472 696e 6720 6872 6566 5f66  d::string href_f
-000a7a80: 726f 6d5f 6669 6c65 2873 7464 3a3a 7374  rom_file(std::st
-000a7a90: 7269 6e67 5f76 6965 7720 696e 7075 7429  ring_view input)
-000a7aa0: 207b 0a20 202f 2f20 5468 6973 2069 7320   {.  // This is 
-000a7ab0: 676f 696e 6720 746f 2062 6520 6d75 6368  going to be much
-000a7ac0: 2066 6173 7465 7220 7468 616e 2063 6f6e   faster than con
-000a7ad0: 7374 7275 6374 696e 6720 6120 5552 4c2e  structing a URL.
-000a7ae0: 0a20 2073 7464 3a3a 7374 7269 6e67 2074  .  std::string t
-000a7af0: 6d70 5f62 7566 6665 723b 0a20 2073 7464  mp_buffer;.  std
-000a7b00: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
-000a7b10: 7465 726e 616c 5f69 6e70 7574 3b0a 2020  ternal_input;.  
-000a7b20: 6966 2028 756e 6963 6f64 653a 3a68 6173  if (unicode::has
-000a7b30: 5f74 6162 735f 6f72 5f6e 6577 6c69 6e65  _tabs_or_newline
-000a7b40: 2869 6e70 7574 2929 207b 0a20 2020 2074  (input)) {.    t
-000a7b50: 6d70 5f62 7566 6665 7220 3d20 696e 7075  mp_buffer = inpu
-000a7b60: 743b 0a20 2020 2068 656c 7065 7273 3a3a  t;.    helpers::
-000a7b70: 7265 6d6f 7665 5f61 7363 6969 5f74 6162  remove_ascii_tab
-000a7b80: 5f6f 725f 6e65 776c 696e 6528 746d 705f  _or_newline(tmp_
-000a7b90: 6275 6666 6572 293b 0a20 2020 2069 6e74  buffer);.    int
-000a7ba0: 6572 6e61 6c5f 696e 7075 7420 3d20 746d  ernal_input = tm
-000a7bb0: 705f 6275 6666 6572 3b0a 2020 7d20 656c  p_buffer;.  } el
-000a7bc0: 7365 207b 0a20 2020 2069 6e74 6572 6e61  se {.    interna
-000a7bd0: 6c5f 696e 7075 7420 3d20 696e 7075 743b  l_input = input;
-000a7be0: 0a20 207d 0a20 2073 7464 3a3a 7374 7269  .  }.  std::stri
-000a7bf0: 6e67 2070 6174 683b 0a20 2069 6620 2869  ng path;.  if (i
-000a7c00: 6e74 6572 6e61 6c5f 696e 7075 742e 656d  nternal_input.em
-000a7c10: 7074 7928 2929 207b 0a20 2020 2070 6174  pty()) {.    pat
-000a7c20: 6820 3d20 222f 223b 0a20 207d 2065 6c73  h = "/";.  } els
-000a7c30: 6520 6966 2028 2869 6e74 6572 6e61 6c5f  e if ((internal_
-000a7c40: 696e 7075 745b 305d 203d 3d20 272f 2729  input[0] == '/')
-000a7c50: 207c 7c20 2869 6e74 6572 6e61 6c5f 696e   || (internal_in
-000a7c60: 7075 745b 305d 203d 3d20 275c 5c27 2929  put[0] == '\\'))
-000a7c70: 207b 0a20 2020 2068 656c 7065 7273 3a3a   {.    helpers::
-000a7c80: 7061 7273 655f 7072 6570 6172 6564 5f70  parse_prepared_p
-000a7c90: 6174 6828 696e 7465 726e 616c 5f69 6e70  ath(internal_inp
-000a7ca0: 7574 2e73 7562 7374 7228 3129 2c0a 2020  ut.substr(1),.  
+000a79c0: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+000a79d0: 726c 2a20 6261 7365 5f75 726c 203d 206e  rl* base_url = n
+000a79e0: 756c 6c70 7472 293b 0a74 656d 706c 6174  ullptr);.templat
+000a79f0: 6520 6164 613a 3a72 6573 756c 743c 7572  e ada::result<ur
+000a7a00: 6c5f 6167 6772 6567 6174 6f72 3e20 7061  l_aggregator> pa
+000a7a10: 7273 653c 7572 6c5f 6167 6772 6567 6174  rse<url_aggregat
+000a7a20: 6f72 3e28 0a20 2020 2073 7464 3a3a 7374  or>(.    std::st
+000a7a30: 7269 6e67 5f76 6965 7720 696e 7075 742c  ring_view input,
+000a7a40: 2063 6f6e 7374 2075 726c 5f61 6767 7265   const url_aggre
+000a7a50: 6761 746f 722a 2062 6173 655f 7572 6c20  gator* base_url 
+000a7a60: 3d20 6e75 6c6c 7074 7229 3b0a 0a73 7464  = nullptr);..std
+000a7a70: 3a3a 7374 7269 6e67 2068 7265 665f 6672  ::string href_fr
+000a7a80: 6f6d 5f66 696c 6528 7374 643a 3a73 7472  om_file(std::str
+000a7a90: 696e 675f 7669 6577 2069 6e70 7574 2920  ing_view input) 
+000a7aa0: 7b0a 2020 2f2f 2054 6869 7320 6973 2067  {.  // This is g
+000a7ab0: 6f69 6e67 2074 6f20 6265 206d 7563 6820  oing to be much 
+000a7ac0: 6661 7374 6572 2074 6861 6e20 636f 6e73  faster than cons
+000a7ad0: 7472 7563 7469 6e67 2061 2055 524c 2e0a  tructing a URL..
+000a7ae0: 2020 7374 643a 3a73 7472 696e 6720 746d    std::string tm
+000a7af0: 705f 6275 6666 6572 3b0a 2020 7374 643a  p_buffer;.  std:
+000a7b00: 3a73 7472 696e 675f 7669 6577 2069 6e74  :string_view int
+000a7b10: 6572 6e61 6c5f 696e 7075 743b 0a20 2069  ernal_input;.  i
+000a7b20: 6620 2875 6e69 636f 6465 3a3a 6861 735f  f (unicode::has_
+000a7b30: 7461 6273 5f6f 725f 6e65 776c 696e 6528  tabs_or_newline(
+000a7b40: 696e 7075 7429 2920 7b0a 2020 2020 746d  input)) {.    tm
+000a7b50: 705f 6275 6666 6572 203d 2069 6e70 7574  p_buffer = input
+000a7b60: 3b0a 2020 2020 6865 6c70 6572 733a 3a72  ;.    helpers::r
+000a7b70: 656d 6f76 655f 6173 6369 695f 7461 625f  emove_ascii_tab_
+000a7b80: 6f72 5f6e 6577 6c69 6e65 2874 6d70 5f62  or_newline(tmp_b
+000a7b90: 7566 6665 7229 3b0a 2020 2020 696e 7465  uffer);.    inte
+000a7ba0: 726e 616c 5f69 6e70 7574 203d 2074 6d70  rnal_input = tmp
+000a7bb0: 5f62 7566 6665 723b 0a20 207d 2065 6c73  _buffer;.  } els
+000a7bc0: 6520 7b0a 2020 2020 696e 7465 726e 616c  e {.    internal
+000a7bd0: 5f69 6e70 7574 203d 2069 6e70 7574 3b0a  _input = input;.
+000a7be0: 2020 7d0a 2020 7374 643a 3a73 7472 696e    }.  std::strin
+000a7bf0: 6720 7061 7468 3b0a 2020 6966 2028 696e  g path;.  if (in
+000a7c00: 7465 726e 616c 5f69 6e70 7574 2e65 6d70  ternal_input.emp
+000a7c10: 7479 2829 2920 7b0a 2020 2020 7061 7468  ty()) {.    path
+000a7c20: 203d 2022 2f22 3b0a 2020 7d20 656c 7365   = "/";.  } else
+000a7c30: 2069 6620 2828 696e 7465 726e 616c 5f69   if ((internal_i
+000a7c40: 6e70 7574 5b30 5d20 3d3d 2027 2f27 2920  nput[0] == '/') 
+000a7c50: 7c7c 2028 696e 7465 726e 616c 5f69 6e70  || (internal_inp
+000a7c60: 7574 5b30 5d20 3d3d 2027 5c5c 2729 2920  ut[0] == '\\')) 
+000a7c70: 7b0a 2020 2020 6865 6c70 6572 733a 3a70  {.    helpers::p
+000a7c80: 6172 7365 5f70 7265 7061 7265 645f 7061  arse_prepared_pa
+000a7c90: 7468 2869 6e74 6572 6e61 6c5f 696e 7075  th(internal_inpu
+000a7ca0: 742e 7375 6273 7472 2831 292c 0a20 2020  t.substr(1),.   
 000a7cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a7cc0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000a7cd0: 6461 3a3a 7363 6865 6d65 3a3a 7479 7065  da::scheme::type
-000a7ce0: 3a3a 4649 4c45 2c20 7061 7468 293b 0a20  ::FILE, path);. 
-000a7cf0: 207d 2065 6c73 6520 7b0a 2020 2020 6865   } else {.    he
-000a7d00: 6c70 6572 733a 3a70 6172 7365 5f70 7265  lpers::parse_pre
-000a7d10: 7061 7265 645f 7061 7468 2869 6e74 6572  pared_path(inter
-000a7d20: 6e61 6c5f 696e 7075 742c 2061 6461 3a3a  nal_input, ada::
-000a7d30: 7363 6865 6d65 3a3a 7479 7065 3a3a 4649  scheme::type::FI
-000a7d40: 4c45 2c20 7061 7468 293b 0a20 207d 0a20  LE, path);.  }. 
-000a7d50: 2072 6574 7572 6e20 2266 696c 653a 2f2f   return "file://
-000a7d60: 2220 2b20 7061 7468 3b0a 7d0a 0a62 6f6f  " + path;.}..boo
-000a7d70: 6c20 6361 6e5f 7061 7273 6528 7374 643a  l can_parse(std:
-000a7d80: 3a73 7472 696e 675f 7669 6577 2069 6e70  :string_view inp
-000a7d90: 7574 2c20 636f 6e73 7420 7374 643a 3a73  ut, const std::s
-000a7da0: 7472 696e 675f 7669 6577 2a20 6261 7365  tring_view* base
-000a7db0: 5f69 6e70 7574 2920 7b0a 2020 6164 613a  _input) {.  ada:
-000a7dc0: 3a72 6573 756c 743c 6164 613a 3a75 726c  :result<ada::url
-000a7dd0: 5f61 6767 7265 6761 746f 723e 2062 6173  _aggregator> bas
-000a7de0: 653b 0a20 2061 6461 3a3a 7572 6c5f 6167  e;.  ada::url_ag
-000a7df0: 6772 6567 6174 6f72 2a20 6261 7365 5f70  gregator* base_p
-000a7e00: 6f69 6e74 6572 203d 206e 756c 6c70 7472  ointer = nullptr
-000a7e10: 3b0a 2020 6966 2028 6261 7365 5f69 6e70  ;.  if (base_inp
-000a7e20: 7574 2021 3d20 6e75 6c6c 7074 7229 207b  ut != nullptr) {
-000a7e30: 0a20 2020 2062 6173 6520 3d20 6164 613a  .    base = ada:
-000a7e40: 3a70 6172 7365 3c75 726c 5f61 6767 7265  :parse<url_aggre
-000a7e50: 6761 746f 723e 282a 6261 7365 5f69 6e70  gator>(*base_inp
-000a7e60: 7574 293b 0a20 2020 2069 6620 2821 6261  ut);.    if (!ba
-000a7e70: 7365 2920 7b0a 2020 2020 2020 7265 7475  se) {.      retu
-000a7e80: 726e 2066 616c 7365 3b0a 2020 2020 7d0a  rn false;.    }.
-000a7e90: 2020 2020 6261 7365 5f70 6f69 6e74 6572      base_pointer
-000a7ea0: 203d 2026 6261 7365 2e76 616c 7565 2829   = &base.value()
-000a7eb0: 3b0a 2020 7d0a 2020 7265 7475 726e 2061  ;.  }.  return a
-000a7ec0: 6461 3a3a 7061 7273 653c 7572 6c5f 6167  da::parse<url_ag
-000a7ed0: 6772 6567 6174 6f72 3e28 696e 7075 742c  gregator>(input,
-000a7ee0: 2062 6173 655f 706f 696e 7465 7229 2e68   base_pointer).h
-000a7ef0: 6173 5f76 616c 7565 2829 3b0a 7d0a 0a61  as_value();.}..a
-000a7f00: 6461 5f77 6172 6e5f 756e 7573 6564 2073  da_warn_unused s
-000a7f10: 7464 3a3a 7374 7269 6e67 2074 6f5f 7374  td::string to_st
-000a7f20: 7269 6e67 2861 6461 3a3a 656e 636f 6469  ring(ada::encodi
-000a7f30: 6e67 5f74 7970 6520 7479 7065 2920 7b0a  ng_type type) {.
-000a7f40: 2020 7377 6974 6368 2028 7479 7065 2920    switch (type) 
-000a7f50: 7b0a 2020 2020 6361 7365 2061 6461 3a3a  {.    case ada::
-000a7f60: 656e 636f 6469 6e67 5f74 7970 653a 3a55  encoding_type::U
-000a7f70: 5446 383a 0a20 2020 2020 2072 6574 7572  TF8:.      retur
-000a7f80: 6e20 2255 5446 2d38 223b 0a20 2020 2063  n "UTF-8";.    c
-000a7f90: 6173 6520 6164 613a 3a65 6e63 6f64 696e  ase ada::encodin
-000a7fa0: 675f 7479 7065 3a3a 5554 465f 3136 4c45  g_type::UTF_16LE
-000a7fb0: 3a0a 2020 2020 2020 7265 7475 726e 2022  :.      return "
-000a7fc0: 5554 462d 3136 4c45 223b 0a20 2020 2063  UTF-16LE";.    c
-000a7fd0: 6173 6520 6164 613a 3a65 6e63 6f64 696e  ase ada::encodin
-000a7fe0: 675f 7479 7065 3a3a 5554 465f 3136 4245  g_type::UTF_16BE
-000a7ff0: 3a0a 2020 2020 2020 7265 7475 726e 2022  :.      return "
-000a8000: 5554 462d 3136 4245 223b 0a20 2020 2064  UTF-16BE";.    d
-000a8010: 6566 6175 6c74 3a0a 2020 2020 2020 756e  efault:.      un
-000a8020: 7265 6163 6861 626c 6528 293b 0a20 207d  reachable();.  }
-000a8030: 0a7d 0a0a 7d20 202f 2f20 6e61 6d65 7370  .}..}  // namesp
-000a8040: 6163 6520 6164 610a 2f2a 2065 6e64 2066  ace ada./* end f
-000a8050: 696c 6520 7372 632f 696d 706c 656d 656e  ile src/implemen
-000a8060: 7461 7469 6f6e 2e63 7070 202a 2f0a 2f2a  tation.cpp */./*
-000a8070: 2062 6567 696e 2066 696c 6520 7372 632f   begin file src/
-000a8080: 6865 6c70 6572 732e 6370 7020 2a2f 0a0a  helpers.cpp */..
-000a8090: 2369 6e63 6c75 6465 203c 616c 676f 7269  #include <algori
-000a80a0: 7468 6d3e 0a23 696e 636c 7564 6520 3c63  thm>.#include <c
-000a80b0: 6861 7263 6f6e 763e 0a23 696e 636c 7564  harconv>.#includ
-000a80c0: 6520 3c63 7374 7269 6e67 3e0a 2369 6e63  e <cstring>.#inc
-000a80d0: 6c75 6465 203c 7373 7472 6561 6d3e 0a0a  lude <sstream>..
-000a80e0: 6e61 6d65 7370 6163 6520 6164 613a 3a68  namespace ada::h
-000a80f0: 656c 7065 7273 207b 0a0a 7465 6d70 6c61  elpers {..templa
-000a8100: 7465 203c 7479 7065 6e61 6d65 206f 7574  te <typename out
-000a8110: 5f69 7465 723e 0a76 6f69 6420 656e 636f  _iter>.void enco
-000a8120: 6465 5f6a 736f 6e28 7374 643a 3a73 7472  de_json(std::str
-000a8130: 696e 675f 7669 6577 2076 6965 772c 206f  ing_view view, o
-000a8140: 7574 5f69 7465 7220 6f75 7429 207b 0a20  ut_iter out) {. 
-000a8150: 202f 2f20 7472 6976 6961 6c20 696d 706c   // trivial impl
-000a8160: 656d 656e 7461 7469 6f6e 2e20 636f 756c  ementation. coul
-000a8170: 6420 6265 2066 6173 7465 722e 0a20 2063  d be faster..  c
-000a8180: 6f6e 7374 2063 6861 722a 2068 6578 7661  onst char* hexva
-000a8190: 6c75 6573 203d 0a20 2020 2020 2022 3030  lues =.      "00
-000a81a0: 3031 3032 3033 3034 3035 3036 3037 3038  0102030405060708
-000a81b0: 3039 3061 3062 3063 3064 3065 3066 3130  090a0b0c0d0e0f10
-000a81c0: 3131 3132 3133 3134 3135 3136 3137 3138  1112131415161718
-000a81d0: 3139 3161 3162 3163 3164 3165 3166 223b  191a1b1c1d1e1f";
-000a81e0: 0a20 2066 6f72 2028 7569 6e74 385f 7420  .  for (uint8_t 
-000a81f0: 6320 3a20 7669 6577 2920 7b0a 2020 2020  c : view) {.    
-000a8200: 6966 2028 6320 3d3d 2027 5c5c 2729 207b  if (c == '\\') {
-000a8210: 0a20 2020 2020 202a 6f75 742b 2b20 3d20  .      *out++ = 
-000a8220: 275c 5c27 3b0a 2020 2020 2020 2a6f 7574  '\\';.      *out
-000a8230: 2b2b 203d 2027 5c5c 273b 0a20 2020 207d  ++ = '\\';.    }
-000a8240: 2065 6c73 6520 6966 2028 6320 3d3d 2027   else if (c == '
-000a8250: 2227 2920 7b0a 2020 2020 2020 2a6f 7574  "') {.      *out
-000a8260: 2b2b 203d 2027 5c5c 273b 0a20 2020 2020  ++ = '\\';.     
-000a8270: 202a 6f75 742b 2b20 3d20 2722 273b 0a20   *out++ = '"';. 
-000a8280: 2020 207d 2065 6c73 6520 6966 2028 6320     } else if (c 
-000a8290: 3c3d 2030 7831 6629 207b 0a20 2020 2020  <= 0x1f) {.     
-000a82a0: 202a 6f75 742b 2b20 3d20 275c 5c27 3b0a   *out++ = '\\';.
-000a82b0: 2020 2020 2020 2a6f 7574 2b2b 203d 2027        *out++ = '
-000a82c0: 7527 3b0a 2020 2020 2020 2a6f 7574 2b2b  u';.      *out++
-000a82d0: 203d 2027 3027 3b0a 2020 2020 2020 2a6f   = '0';.      *o
-000a82e0: 7574 2b2b 203d 2027 3027 3b0a 2020 2020  ut++ = '0';.    
-000a82f0: 2020 2a6f 7574 2b2b 203d 2068 6578 7661    *out++ = hexva
-000a8300: 6c75 6573 5b32 202a 2063 5d3b 0a20 2020  lues[2 * c];.   
-000a8310: 2020 202a 6f75 742b 2b20 3d20 6865 7876     *out++ = hexv
-000a8320: 616c 7565 735b 3220 2a20 6320 2b20 315d  alues[2 * c + 1]
-000a8330: 3b0a 2020 2020 7d20 656c 7365 207b 0a20  ;.    } else {. 
-000a8340: 2020 2020 202a 6f75 742b 2b20 3d20 633b       *out++ = c;
-000a8350: 0a20 2020 207d 0a20 207d 0a7d 0a0a 6164  .    }.  }.}..ad
-000a8360: 615f 756e 7573 6564 2073 7464 3a3a 7374  a_unused std::st
-000a8370: 7269 6e67 2067 6574 5f73 7461 7465 2861  ring get_state(a
-000a8380: 6461 3a3a 7374 6174 6520 7329 207b 0a20  da::state s) {. 
-000a8390: 2073 7769 7463 6820 2873 2920 7b0a 2020   switch (s) {.  
-000a83a0: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000a83b0: 653a 3a41 5554 484f 5249 5459 3a0a 2020  e::AUTHORITY:.  
-000a83c0: 2020 2020 7265 7475 726e 2022 4175 7468      return "Auth
-000a83d0: 6f72 6974 7922 3b0a 2020 2020 6361 7365  ority";.    case
-000a83e0: 2061 6461 3a3a 7374 6174 653a 3a53 4348   ada::state::SCH
-000a83f0: 454d 455f 5354 4152 543a 0a20 2020 2020  EME_START:.     
-000a8400: 2072 6574 7572 6e20 2253 6368 656d 6520   return "Scheme 
-000a8410: 5374 6172 7422 3b0a 2020 2020 6361 7365  Start";.    case
-000a8420: 2061 6461 3a3a 7374 6174 653a 3a53 4348   ada::state::SCH
-000a8430: 454d 453a 0a20 2020 2020 2072 6574 7572  EME:.      retur
-000a8440: 6e20 2253 6368 656d 6522 3b0a 2020 2020  n "Scheme";.    
-000a8450: 6361 7365 2061 6461 3a3a 7374 6174 653a  case ada::state:
-000a8460: 3a48 4f53 543a 0a20 2020 2020 2072 6574  :HOST:.      ret
-000a8470: 7572 6e20 2248 6f73 7422 3b0a 2020 2020  urn "Host";.    
-000a8480: 6361 7365 2061 6461 3a3a 7374 6174 653a  case ada::state:
-000a8490: 3a4e 4f5f 5343 4845 4d45 3a0a 2020 2020  :NO_SCHEME:.    
-000a84a0: 2020 7265 7475 726e 2022 4e6f 2053 6368    return "No Sch
-000a84b0: 656d 6522 3b0a 2020 2020 6361 7365 2061  eme";.    case a
-000a84c0: 6461 3a3a 7374 6174 653a 3a46 5241 474d  da::state::FRAGM
-000a84d0: 454e 543a 0a20 2020 2020 2072 6574 7572  ENT:.      retur
-000a84e0: 6e20 2246 7261 676d 656e 7422 3b0a 2020  n "Fragment";.  
-000a84f0: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000a8500: 653a 3a52 454c 4154 4956 455f 5343 4845  e::RELATIVE_SCHE
-000a8510: 4d45 3a0a 2020 2020 2020 7265 7475 726e  ME:.      return
-000a8520: 2022 5265 6c61 7469 7665 2053 6368 656d   "Relative Schem
-000a8530: 6522 3b0a 2020 2020 6361 7365 2061 6461  e";.    case ada
-000a8540: 3a3a 7374 6174 653a 3a52 454c 4154 4956  ::state::RELATIV
-000a8550: 455f 534c 4153 483a 0a20 2020 2020 2072  E_SLASH:.      r
-000a8560: 6574 7572 6e20 2252 656c 6174 6976 6520  eturn "Relative 
-000a8570: 536c 6173 6822 3b0a 2020 2020 6361 7365  Slash";.    case
-000a8580: 2061 6461 3a3a 7374 6174 653a 3a46 494c   ada::state::FIL
-000a8590: 453a 0a20 2020 2020 2072 6574 7572 6e20  E:.      return 
-000a85a0: 2246 696c 6522 3b0a 2020 2020 6361 7365  "File";.    case
-000a85b0: 2061 6461 3a3a 7374 6174 653a 3a46 494c   ada::state::FIL
-000a85c0: 455f 484f 5354 3a0a 2020 2020 2020 7265  E_HOST:.      re
-000a85d0: 7475 726e 2022 4669 6c65 2048 6f73 7422  turn "File Host"
-000a85e0: 3b0a 2020 2020 6361 7365 2061 6461 3a3a  ;.    case ada::
-000a85f0: 7374 6174 653a 3a46 494c 455f 534c 4153  state::FILE_SLAS
-000a8600: 483a 0a20 2020 2020 2072 6574 7572 6e20  H:.      return 
-000a8610: 2246 696c 6520 536c 6173 6822 3b0a 2020  "File Slash";.  
-000a8620: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000a8630: 653a 3a50 4154 485f 4f52 5f41 5554 484f  e::PATH_OR_AUTHO
-000a8640: 5249 5459 3a0a 2020 2020 2020 7265 7475  RITY:.      retu
-000a8650: 726e 2022 5061 7468 206f 7220 4175 7468  rn "Path or Auth
-000a8660: 6f72 6974 7922 3b0a 2020 2020 6361 7365  ority";.    case
-000a8670: 2061 6461 3a3a 7374 6174 653a 3a53 5045   ada::state::SPE
-000a8680: 4349 414c 5f41 5554 484f 5249 5459 5f49  CIAL_AUTHORITY_I
-000a8690: 474e 4f52 455f 534c 4153 4845 533a 0a20  GNORE_SLASHES:. 
-000a86a0: 2020 2020 2072 6574 7572 6e20 2253 7065       return "Spe
-000a86b0: 6369 616c 2041 7574 686f 7269 7479 2049  cial Authority I
-000a86c0: 676e 6f72 6520 536c 6173 6865 7322 3b0a  gnore Slashes";.
-000a86d0: 2020 2020 6361 7365 2061 6461 3a3a 7374      case ada::st
-000a86e0: 6174 653a 3a53 5045 4349 414c 5f41 5554  ate::SPECIAL_AUT
-000a86f0: 484f 5249 5459 5f53 4c41 5348 4553 3a0a  HORITY_SLASHES:.
-000a8700: 2020 2020 2020 7265 7475 726e 2022 5370        return "Sp
-000a8710: 6563 6961 6c20 4175 7468 6f72 6974 7920  ecial Authority 
-000a8720: 536c 6173 6865 7322 3b0a 2020 2020 6361  Slashes";.    ca
-000a8730: 7365 2061 6461 3a3a 7374 6174 653a 3a53  se ada::state::S
-000a8740: 5045 4349 414c 5f52 454c 4154 4956 455f  PECIAL_RELATIVE_
-000a8750: 4f52 5f41 5554 484f 5249 5459 3a0a 2020  OR_AUTHORITY:.  
-000a8760: 2020 2020 7265 7475 726e 2022 5370 6563      return "Spec
-000a8770: 6961 6c20 5265 6c61 7469 7665 206f 7220  ial Relative or 
-000a8780: 4175 7468 6f72 6974 7922 3b0a 2020 2020  Authority";.    
-000a8790: 6361 7365 2061 6461 3a3a 7374 6174 653a  case ada::state:
-000a87a0: 3a51 5545 5259 3a0a 2020 2020 2020 7265  :QUERY:.      re
-000a87b0: 7475 726e 2022 5175 6572 7922 3b0a 2020  turn "Query";.  
-000a87c0: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000a87d0: 653a 3a50 4154 483a 0a20 2020 2020 2072  e::PATH:.      r
-000a87e0: 6574 7572 6e20 2250 6174 6822 3b0a 2020  eturn "Path";.  
-000a87f0: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000a8800: 653a 3a50 4154 485f 5354 4152 543a 0a20  e::PATH_START:. 
-000a8810: 2020 2020 2072 6574 7572 6e20 2250 6174       return "Pat
-000a8820: 6820 5374 6172 7422 3b0a 2020 2020 6361  h Start";.    ca
-000a8830: 7365 2061 6461 3a3a 7374 6174 653a 3a4f  se ada::state::O
-000a8840: 5041 5155 455f 5041 5448 3a0a 2020 2020  PAQUE_PATH:.    
-000a8850: 2020 7265 7475 726e 2022 4f70 6171 7565    return "Opaque
-000a8860: 2050 6174 6822 3b0a 2020 2020 6361 7365   Path";.    case
-000a8870: 2061 6461 3a3a 7374 6174 653a 3a50 4f52   ada::state::POR
-000a8880: 543a 0a20 2020 2020 2072 6574 7572 6e20  T:.      return 
-000a8890: 2250 6f72 7422 3b0a 2020 2020 6465 6661  "Port";.    defa
-000a88a0: 756c 743a 0a20 2020 2020 2072 6574 7572  ult:.      retur
-000a88b0: 6e20 2275 6e6b 6e6f 776e 2073 7461 7465  n "unknown state
-000a88c0: 223b 0a20 207d 0a7d 0a0a 6164 615f 7265  ";.  }.}..ada_re
-000a88d0: 616c 6c79 5f69 6e6c 696e 6520 7374 643a  ally_inline std:
-000a88e0: 3a6f 7074 696f 6e61 6c3c 7374 643a 3a73  :optional<std::s
-000a88f0: 7472 696e 675f 7669 6577 3e20 7072 756e  tring_view> prun
-000a8900: 655f 6861 7368 280a 2020 2020 7374 643a  e_hash(.    std:
-000a8910: 3a73 7472 696e 675f 7669 6577 2620 696e  :string_view& in
-000a8920: 7075 7429 206e 6f65 7863 6570 7420 7b0a  put) noexcept {.
-000a8930: 2020 2f2f 2063 6f6d 7069 6c65 7320 646f    // compiles do
-000a8940: 776e 2074 6f20 3230 2d2d 3330 2069 6e73  wn to 20--30 ins
-000a8950: 7472 7563 7469 6f6e 7320 696e 636c 7564  tructions includ
-000a8960: 696e 6720 6120 636c 6173 7320 746f 206d  ing a class to m
-000a8970: 656d 6368 7220 2843 0a20 202f 2f20 6675  emchr (C.  // fu
-000a8980: 6e63 7469 6f6e 292e 2074 6869 7320 6675  nction). this fu
-000a8990: 6e63 7469 6f6e 2073 686f 756c 6420 6265  nction should be
-000a89a0: 2071 7569 7465 2066 6173 742e 0a20 2073   quite fast..  s
-000a89b0: 697a 655f 7420 6c6f 6361 7469 6f6e 5f6f  ize_t location_o
-000a89c0: 665f 6669 7273 7420 3d20 696e 7075 742e  f_first = input.
-000a89d0: 6669 6e64 2827 2327 293b 0a20 2069 6620  find('#');.  if 
-000a89e0: 286c 6f63 6174 696f 6e5f 6f66 5f66 6972  (location_of_fir
-000a89f0: 7374 203d 3d20 7374 643a 3a73 7472 696e  st == std::strin
-000a8a00: 675f 7669 6577 3a3a 6e70 6f73 2920 7b0a  g_view::npos) {.
-000a8a10: 2020 2020 7265 7475 726e 2073 7464 3a3a      return std::
-000a8a20: 6e75 6c6c 6f70 743b 0a20 207d 0a20 2073  nullopt;.  }.  s
-000a8a30: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
-000a8a40: 6861 7368 203d 2069 6e70 7574 3b0a 2020  hash = input;.  
-000a8a50: 6861 7368 2e72 656d 6f76 655f 7072 6566  hash.remove_pref
-000a8a60: 6978 286c 6f63 6174 696f 6e5f 6f66 5f66  ix(location_of_f
-000a8a70: 6972 7374 202b 2031 293b 0a20 2069 6e70  irst + 1);.  inp
-000a8a80: 7574 2e72 656d 6f76 655f 7375 6666 6978  ut.remove_suffix
-000a8a90: 2869 6e70 7574 2e73 697a 6528 2920 2d20  (input.size() - 
-000a8aa0: 6c6f 6361 7469 6f6e 5f6f 665f 6669 7273  location_of_firs
-000a8ab0: 7429 3b0a 2020 7265 7475 726e 2068 6173  t);.  return has
-000a8ac0: 683b 0a7d 0a0a 6164 615f 7265 616c 6c79  h;.}..ada_really
-000a8ad0: 5f69 6e6c 696e 6520 626f 6f6c 2073 686f  _inline bool sho
-000a8ae0: 7274 656e 5f70 6174 6828 7374 643a 3a73  rten_path(std::s
-000a8af0: 7472 696e 6726 2070 6174 682c 0a20 2020  tring& path,.   
+000a7cc0: 2020 2020 2020 2020 2020 2020 2020 6164                ad
+000a7cd0: 613a 3a73 6368 656d 653a 3a74 7970 653a  a::scheme::type:
+000a7ce0: 3a46 494c 452c 2070 6174 6829 3b0a 2020  :FILE, path);.  
+000a7cf0: 7d20 656c 7365 207b 0a20 2020 2068 656c  } else {.    hel
+000a7d00: 7065 7273 3a3a 7061 7273 655f 7072 6570  pers::parse_prep
+000a7d10: 6172 6564 5f70 6174 6828 696e 7465 726e  ared_path(intern
+000a7d20: 616c 5f69 6e70 7574 2c20 6164 613a 3a73  al_input, ada::s
+000a7d30: 6368 656d 653a 3a74 7970 653a 3a46 494c  cheme::type::FIL
+000a7d40: 452c 2070 6174 6829 3b0a 2020 7d0a 2020  E, path);.  }.  
+000a7d50: 7265 7475 726e 2022 6669 6c65 3a2f 2f22  return "file://"
+000a7d60: 202b 2070 6174 683b 0a7d 0a0a 626f 6f6c   + path;.}..bool
+000a7d70: 2063 616e 5f70 6172 7365 2873 7464 3a3a   can_parse(std::
+000a7d80: 7374 7269 6e67 5f76 6965 7720 696e 7075  string_view inpu
+000a7d90: 742c 2063 6f6e 7374 2073 7464 3a3a 7374  t, const std::st
+000a7da0: 7269 6e67 5f76 6965 772a 2062 6173 655f  ring_view* base_
+000a7db0: 696e 7075 7429 207b 0a20 2061 6461 3a3a  input) {.  ada::
+000a7dc0: 7265 7375 6c74 3c61 6461 3a3a 7572 6c5f  result<ada::url_
+000a7dd0: 6167 6772 6567 6174 6f72 3e20 6261 7365  aggregator> base
+000a7de0: 3b0a 2020 6164 613a 3a75 726c 5f61 6767  ;.  ada::url_agg
+000a7df0: 7265 6761 746f 722a 2062 6173 655f 706f  regator* base_po
+000a7e00: 696e 7465 7220 3d20 6e75 6c6c 7074 723b  inter = nullptr;
+000a7e10: 0a20 2069 6620 2862 6173 655f 696e 7075  .  if (base_inpu
+000a7e20: 7420 213d 206e 756c 6c70 7472 2920 7b0a  t != nullptr) {.
+000a7e30: 2020 2020 6261 7365 203d 2061 6461 3a3a      base = ada::
+000a7e40: 7061 7273 653c 7572 6c5f 6167 6772 6567  parse<url_aggreg
+000a7e50: 6174 6f72 3e28 2a62 6173 655f 696e 7075  ator>(*base_inpu
+000a7e60: 7429 3b0a 2020 2020 6966 2028 2162 6173  t);.    if (!bas
+000a7e70: 6529 207b 0a20 2020 2020 2072 6574 7572  e) {.      retur
+000a7e80: 6e20 6661 6c73 653b 0a20 2020 207d 0a20  n false;.    }. 
+000a7e90: 2020 2062 6173 655f 706f 696e 7465 7220     base_pointer 
+000a7ea0: 3d20 2662 6173 652e 7661 6c75 6528 293b  = &base.value();
+000a7eb0: 0a20 207d 0a20 2072 6574 7572 6e20 6164  .  }.  return ad
+000a7ec0: 613a 3a70 6172 7365 3c75 726c 5f61 6767  a::parse<url_agg
+000a7ed0: 7265 6761 746f 723e 2869 6e70 7574 2c20  regator>(input, 
+000a7ee0: 6261 7365 5f70 6f69 6e74 6572 292e 6861  base_pointer).ha
+000a7ef0: 735f 7661 6c75 6528 293b 0a7d 0a0a 6164  s_value();.}..ad
+000a7f00: 615f 7761 726e 5f75 6e75 7365 6420 7374  a_warn_unused st
+000a7f10: 643a 3a73 7472 696e 6720 746f 5f73 7472  d::string to_str
+000a7f20: 696e 6728 6164 613a 3a65 6e63 6f64 696e  ing(ada::encodin
+000a7f30: 675f 7479 7065 2074 7970 6529 207b 0a20  g_type type) {. 
+000a7f40: 2073 7769 7463 6820 2874 7970 6529 207b   switch (type) {
+000a7f50: 0a20 2020 2063 6173 6520 6164 613a 3a65  .    case ada::e
+000a7f60: 6e63 6f64 696e 675f 7479 7065 3a3a 5554  ncoding_type::UT
+000a7f70: 4638 3a0a 2020 2020 2020 7265 7475 726e  F8:.      return
+000a7f80: 2022 5554 462d 3822 3b0a 2020 2020 6361   "UTF-8";.    ca
+000a7f90: 7365 2061 6461 3a3a 656e 636f 6469 6e67  se ada::encoding
+000a7fa0: 5f74 7970 653a 3a55 5446 5f31 364c 453a  _type::UTF_16LE:
+000a7fb0: 0a20 2020 2020 2072 6574 7572 6e20 2255  .      return "U
+000a7fc0: 5446 2d31 364c 4522 3b0a 2020 2020 6361  TF-16LE";.    ca
+000a7fd0: 7365 2061 6461 3a3a 656e 636f 6469 6e67  se ada::encoding
+000a7fe0: 5f74 7970 653a 3a55 5446 5f31 3642 453a  _type::UTF_16BE:
+000a7ff0: 0a20 2020 2020 2072 6574 7572 6e20 2255  .      return "U
+000a8000: 5446 2d31 3642 4522 3b0a 2020 2020 6465  TF-16BE";.    de
+000a8010: 6661 756c 743a 0a20 2020 2020 2075 6e72  fault:.      unr
+000a8020: 6561 6368 6162 6c65 2829 3b0a 2020 7d0a  eachable();.  }.
+000a8030: 7d0a 0a7d 2020 2f2f 206e 616d 6573 7061  }..}  // namespa
+000a8040: 6365 2061 6461 0a2f 2a20 656e 6420 6669  ce ada./* end fi
+000a8050: 6c65 2073 7263 2f69 6d70 6c65 6d65 6e74  le src/implement
+000a8060: 6174 696f 6e2e 6370 7020 2a2f 0a2f 2a20  ation.cpp */./* 
+000a8070: 6265 6769 6e20 6669 6c65 2073 7263 2f68  begin file src/h
+000a8080: 656c 7065 7273 2e63 7070 202a 2f0a 0a23  elpers.cpp */..#
+000a8090: 696e 636c 7564 6520 3c61 6c67 6f72 6974  include <algorit
+000a80a0: 686d 3e0a 2369 6e63 6c75 6465 203c 6368  hm>.#include <ch
+000a80b0: 6172 636f 6e76 3e0a 2369 6e63 6c75 6465  arconv>.#include
+000a80c0: 203c 6373 7472 696e 673e 0a23 696e 636c   <cstring>.#incl
+000a80d0: 7564 6520 3c73 7374 7265 616d 3e0a 0a6e  ude <sstream>..n
+000a80e0: 616d 6573 7061 6365 2061 6461 3a3a 6865  amespace ada::he
+000a80f0: 6c70 6572 7320 7b0a 0a74 656d 706c 6174  lpers {..templat
+000a8100: 6520 3c74 7970 656e 616d 6520 6f75 745f  e <typename out_
+000a8110: 6974 6572 3e0a 766f 6964 2065 6e63 6f64  iter>.void encod
+000a8120: 655f 6a73 6f6e 2873 7464 3a3a 7374 7269  e_json(std::stri
+000a8130: 6e67 5f76 6965 7720 7669 6577 2c20 6f75  ng_view view, ou
+000a8140: 745f 6974 6572 206f 7574 2920 7b0a 2020  t_iter out) {.  
+000a8150: 2f2f 2074 7269 7669 616c 2069 6d70 6c65  // trivial imple
+000a8160: 6d65 6e74 6174 696f 6e2e 2063 6f75 6c64  mentation. could
+000a8170: 2062 6520 6661 7374 6572 2e0a 2020 636f   be faster..  co
+000a8180: 6e73 7420 6368 6172 2a20 6865 7876 616c  nst char* hexval
+000a8190: 7565 7320 3d0a 2020 2020 2020 2230 3030  ues =.      "000
+000a81a0: 3130 3230 3330 3430 3530 3630 3730 3830  1020304050607080
+000a81b0: 3930 6130 6230 6330 6430 6530 6631 3031  90a0b0c0d0e0f101
+000a81c0: 3131 3231 3331 3431 3531 3631 3731 3831  1121314151617181
+000a81d0: 3931 6131 6231 6331 6431 6531 6622 3b0a  91a1b1c1d1e1f";.
+000a81e0: 2020 666f 7220 2875 696e 7438 5f74 2063    for (uint8_t c
+000a81f0: 203a 2076 6965 7729 207b 0a20 2020 2069   : view) {.    i
+000a8200: 6620 2863 203d 3d20 275c 5c27 2920 7b0a  f (c == '\\') {.
+000a8210: 2020 2020 2020 2a6f 7574 2b2b 203d 2027        *out++ = '
+000a8220: 5c5c 273b 0a20 2020 2020 202a 6f75 742b  \\';.      *out+
+000a8230: 2b20 3d20 275c 5c27 3b0a 2020 2020 7d20  + = '\\';.    } 
+000a8240: 656c 7365 2069 6620 2863 203d 3d20 2722  else if (c == '"
+000a8250: 2729 207b 0a20 2020 2020 202a 6f75 742b  ') {.      *out+
+000a8260: 2b20 3d20 275c 5c27 3b0a 2020 2020 2020  + = '\\';.      
+000a8270: 2a6f 7574 2b2b 203d 2027 2227 3b0a 2020  *out++ = '"';.  
+000a8280: 2020 7d20 656c 7365 2069 6620 2863 203c    } else if (c <
+000a8290: 3d20 3078 3166 2920 7b0a 2020 2020 2020  = 0x1f) {.      
+000a82a0: 2a6f 7574 2b2b 203d 2027 5c5c 273b 0a20  *out++ = '\\';. 
+000a82b0: 2020 2020 202a 6f75 742b 2b20 3d20 2775       *out++ = 'u
+000a82c0: 273b 0a20 2020 2020 202a 6f75 742b 2b20  ';.      *out++ 
+000a82d0: 3d20 2730 273b 0a20 2020 2020 202a 6f75  = '0';.      *ou
+000a82e0: 742b 2b20 3d20 2730 273b 0a20 2020 2020  t++ = '0';.     
+000a82f0: 202a 6f75 742b 2b20 3d20 6865 7876 616c   *out++ = hexval
+000a8300: 7565 735b 3220 2a20 635d 3b0a 2020 2020  ues[2 * c];.    
+000a8310: 2020 2a6f 7574 2b2b 203d 2068 6578 7661    *out++ = hexva
+000a8320: 6c75 6573 5b32 202a 2063 202b 2031 5d3b  lues[2 * c + 1];
+000a8330: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
+000a8340: 2020 2020 2a6f 7574 2b2b 203d 2063 3b0a      *out++ = c;.
+000a8350: 2020 2020 7d0a 2020 7d0a 7d0a 0a61 6461      }.  }.}..ada
+000a8360: 5f75 6e75 7365 6420 7374 643a 3a73 7472  _unused std::str
+000a8370: 696e 6720 6765 745f 7374 6174 6528 6164  ing get_state(ad
+000a8380: 613a 3a73 7461 7465 2073 2920 7b0a 2020  a::state s) {.  
+000a8390: 7377 6974 6368 2028 7329 207b 0a20 2020  switch (s) {.   
+000a83a0: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
+000a83b0: 3a3a 4155 5448 4f52 4954 593a 0a20 2020  ::AUTHORITY:.   
+000a83c0: 2020 2072 6574 7572 6e20 2241 7574 686f     return "Autho
+000a83d0: 7269 7479 223b 0a20 2020 2063 6173 6520  rity";.    case 
+000a83e0: 6164 613a 3a73 7461 7465 3a3a 5343 4845  ada::state::SCHE
+000a83f0: 4d45 5f53 5441 5254 3a0a 2020 2020 2020  ME_START:.      
+000a8400: 7265 7475 726e 2022 5363 6865 6d65 2053  return "Scheme S
+000a8410: 7461 7274 223b 0a20 2020 2063 6173 6520  tart";.    case 
+000a8420: 6164 613a 3a73 7461 7465 3a3a 5343 4845  ada::state::SCHE
+000a8430: 4d45 3a0a 2020 2020 2020 7265 7475 726e  ME:.      return
+000a8440: 2022 5363 6865 6d65 223b 0a20 2020 2063   "Scheme";.    c
+000a8450: 6173 6520 6164 613a 3a73 7461 7465 3a3a  ase ada::state::
+000a8460: 484f 5354 3a0a 2020 2020 2020 7265 7475  HOST:.      retu
+000a8470: 726e 2022 486f 7374 223b 0a20 2020 2063  rn "Host";.    c
+000a8480: 6173 6520 6164 613a 3a73 7461 7465 3a3a  ase ada::state::
+000a8490: 4e4f 5f53 4348 454d 453a 0a20 2020 2020  NO_SCHEME:.     
+000a84a0: 2072 6574 7572 6e20 224e 6f20 5363 6865   return "No Sche
+000a84b0: 6d65 223b 0a20 2020 2063 6173 6520 6164  me";.    case ad
+000a84c0: 613a 3a73 7461 7465 3a3a 4652 4147 4d45  a::state::FRAGME
+000a84d0: 4e54 3a0a 2020 2020 2020 7265 7475 726e  NT:.      return
+000a84e0: 2022 4672 6167 6d65 6e74 223b 0a20 2020   "Fragment";.   
+000a84f0: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
+000a8500: 3a3a 5245 4c41 5449 5645 5f53 4348 454d  ::RELATIVE_SCHEM
+000a8510: 453a 0a20 2020 2020 2072 6574 7572 6e20  E:.      return 
+000a8520: 2252 656c 6174 6976 6520 5363 6865 6d65  "Relative Scheme
+000a8530: 223b 0a20 2020 2063 6173 6520 6164 613a  ";.    case ada:
+000a8540: 3a73 7461 7465 3a3a 5245 4c41 5449 5645  :state::RELATIVE
+000a8550: 5f53 4c41 5348 3a0a 2020 2020 2020 7265  _SLASH:.      re
+000a8560: 7475 726e 2022 5265 6c61 7469 7665 2053  turn "Relative S
+000a8570: 6c61 7368 223b 0a20 2020 2063 6173 6520  lash";.    case 
+000a8580: 6164 613a 3a73 7461 7465 3a3a 4649 4c45  ada::state::FILE
+000a8590: 3a0a 2020 2020 2020 7265 7475 726e 2022  :.      return "
+000a85a0: 4669 6c65 223b 0a20 2020 2063 6173 6520  File";.    case 
+000a85b0: 6164 613a 3a73 7461 7465 3a3a 4649 4c45  ada::state::FILE
+000a85c0: 5f48 4f53 543a 0a20 2020 2020 2072 6574  _HOST:.      ret
+000a85d0: 7572 6e20 2246 696c 6520 486f 7374 223b  urn "File Host";
+000a85e0: 0a20 2020 2063 6173 6520 6164 613a 3a73  .    case ada::s
+000a85f0: 7461 7465 3a3a 4649 4c45 5f53 4c41 5348  tate::FILE_SLASH
+000a8600: 3a0a 2020 2020 2020 7265 7475 726e 2022  :.      return "
+000a8610: 4669 6c65 2053 6c61 7368 223b 0a20 2020  File Slash";.   
+000a8620: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
+000a8630: 3a3a 5041 5448 5f4f 525f 4155 5448 4f52  ::PATH_OR_AUTHOR
+000a8640: 4954 593a 0a20 2020 2020 2072 6574 7572  ITY:.      retur
+000a8650: 6e20 2250 6174 6820 6f72 2041 7574 686f  n "Path or Autho
+000a8660: 7269 7479 223b 0a20 2020 2063 6173 6520  rity";.    case 
+000a8670: 6164 613a 3a73 7461 7465 3a3a 5350 4543  ada::state::SPEC
+000a8680: 4941 4c5f 4155 5448 4f52 4954 595f 4947  IAL_AUTHORITY_IG
+000a8690: 4e4f 5245 5f53 4c41 5348 4553 3a0a 2020  NORE_SLASHES:.  
+000a86a0: 2020 2020 7265 7475 726e 2022 5370 6563      return "Spec
+000a86b0: 6961 6c20 4175 7468 6f72 6974 7920 4967  ial Authority Ig
+000a86c0: 6e6f 7265 2053 6c61 7368 6573 223b 0a20  nore Slashes";. 
+000a86d0: 2020 2063 6173 6520 6164 613a 3a73 7461     case ada::sta
+000a86e0: 7465 3a3a 5350 4543 4941 4c5f 4155 5448  te::SPECIAL_AUTH
+000a86f0: 4f52 4954 595f 534c 4153 4845 533a 0a20  ORITY_SLASHES:. 
+000a8700: 2020 2020 2072 6574 7572 6e20 2253 7065       return "Spe
+000a8710: 6369 616c 2041 7574 686f 7269 7479 2053  cial Authority S
+000a8720: 6c61 7368 6573 223b 0a20 2020 2063 6173  lashes";.    cas
+000a8730: 6520 6164 613a 3a73 7461 7465 3a3a 5350  e ada::state::SP
+000a8740: 4543 4941 4c5f 5245 4c41 5449 5645 5f4f  ECIAL_RELATIVE_O
+000a8750: 525f 4155 5448 4f52 4954 593a 0a20 2020  R_AUTHORITY:.   
+000a8760: 2020 2072 6574 7572 6e20 2253 7065 6369     return "Speci
+000a8770: 616c 2052 656c 6174 6976 6520 6f72 2041  al Relative or A
+000a8780: 7574 686f 7269 7479 223b 0a20 2020 2063  uthority";.    c
+000a8790: 6173 6520 6164 613a 3a73 7461 7465 3a3a  ase ada::state::
+000a87a0: 5155 4552 593a 0a20 2020 2020 2072 6574  QUERY:.      ret
+000a87b0: 7572 6e20 2251 7565 7279 223b 0a20 2020  urn "Query";.   
+000a87c0: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
+000a87d0: 3a3a 5041 5448 3a0a 2020 2020 2020 7265  ::PATH:.      re
+000a87e0: 7475 726e 2022 5061 7468 223b 0a20 2020  turn "Path";.   
+000a87f0: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
+000a8800: 3a3a 5041 5448 5f53 5441 5254 3a0a 2020  ::PATH_START:.  
+000a8810: 2020 2020 7265 7475 726e 2022 5061 7468      return "Path
+000a8820: 2053 7461 7274 223b 0a20 2020 2063 6173   Start";.    cas
+000a8830: 6520 6164 613a 3a73 7461 7465 3a3a 4f50  e ada::state::OP
+000a8840: 4151 5545 5f50 4154 483a 0a20 2020 2020  AQUE_PATH:.     
+000a8850: 2072 6574 7572 6e20 224f 7061 7175 6520   return "Opaque 
+000a8860: 5061 7468 223b 0a20 2020 2063 6173 6520  Path";.    case 
+000a8870: 6164 613a 3a73 7461 7465 3a3a 504f 5254  ada::state::PORT
+000a8880: 3a0a 2020 2020 2020 7265 7475 726e 2022  :.      return "
+000a8890: 506f 7274 223b 0a20 2020 2064 6566 6175  Port";.    defau
+000a88a0: 6c74 3a0a 2020 2020 2020 7265 7475 726e  lt:.      return
+000a88b0: 2022 756e 6b6e 6f77 6e20 7374 6174 6522   "unknown state"
+000a88c0: 3b0a 2020 7d0a 7d0a 0a61 6461 5f72 6561  ;.  }.}..ada_rea
+000a88d0: 6c6c 795f 696e 6c69 6e65 2073 7464 3a3a  lly_inline std::
+000a88e0: 6f70 7469 6f6e 616c 3c73 7464 3a3a 7374  optional<std::st
+000a88f0: 7269 6e67 5f76 6965 773e 2070 7275 6e65  ring_view> prune
+000a8900: 5f68 6173 6828 0a20 2020 2073 7464 3a3a  _hash(.    std::
+000a8910: 7374 7269 6e67 5f76 6965 7726 2069 6e70  string_view& inp
+000a8920: 7574 2920 6e6f 6578 6365 7074 207b 0a20  ut) noexcept {. 
+000a8930: 202f 2f20 636f 6d70 696c 6573 2064 6f77   // compiles dow
+000a8940: 6e20 746f 2032 302d 2d33 3020 696e 7374  n to 20--30 inst
+000a8950: 7275 6374 696f 6e73 2069 6e63 6c75 6469  ructions includi
+000a8960: 6e67 2061 2063 6c61 7373 2074 6f20 6d65  ng a class to me
+000a8970: 6d63 6872 2028 430a 2020 2f2f 2066 756e  mchr (C.  // fun
+000a8980: 6374 696f 6e29 2e20 7468 6973 2066 756e  ction). this fun
+000a8990: 6374 696f 6e20 7368 6f75 6c64 2062 6520  ction should be 
+000a89a0: 7175 6974 6520 6661 7374 2e0a 2020 7369  quite fast..  si
+000a89b0: 7a65 5f74 206c 6f63 6174 696f 6e5f 6f66  ze_t location_of
+000a89c0: 5f66 6972 7374 203d 2069 6e70 7574 2e66  _first = input.f
+000a89d0: 696e 6428 2723 2729 3b0a 2020 6966 2028  ind('#');.  if (
+000a89e0: 6c6f 6361 7469 6f6e 5f6f 665f 6669 7273  location_of_firs
+000a89f0: 7420 3d3d 2073 7464 3a3a 7374 7269 6e67  t == std::string
+000a8a00: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
+000a8a10: 2020 2072 6574 7572 6e20 7374 643a 3a6e     return std::n
+000a8a20: 756c 6c6f 7074 3b0a 2020 7d0a 2020 7374  ullopt;.  }.  st
+000a8a30: 643a 3a73 7472 696e 675f 7669 6577 2068  d::string_view h
+000a8a40: 6173 6820 3d20 696e 7075 743b 0a20 2068  ash = input;.  h
+000a8a50: 6173 682e 7265 6d6f 7665 5f70 7265 6669  ash.remove_prefi
+000a8a60: 7828 6c6f 6361 7469 6f6e 5f6f 665f 6669  x(location_of_fi
+000a8a70: 7273 7420 2b20 3129 3b0a 2020 696e 7075  rst + 1);.  inpu
+000a8a80: 742e 7265 6d6f 7665 5f73 7566 6669 7828  t.remove_suffix(
+000a8a90: 696e 7075 742e 7369 7a65 2829 202d 206c  input.size() - l
+000a8aa0: 6f63 6174 696f 6e5f 6f66 5f66 6972 7374  ocation_of_first
+000a8ab0: 293b 0a20 2072 6574 7572 6e20 6861 7368  );.  return hash
+000a8ac0: 3b0a 7d0a 0a61 6461 5f72 6561 6c6c 795f  ;.}..ada_really_
+000a8ad0: 696e 6c69 6e65 2062 6f6f 6c20 7368 6f72  inline bool shor
+000a8ae0: 7465 6e5f 7061 7468 2873 7464 3a3a 7374  ten_path(std::st
+000a8af0: 7269 6e67 2620 7061 7468 2c0a 2020 2020  ring& path,.    
 000a8b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000a8b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a8b20: 2061 6461 3a3a 7363 6865 6d65 3a3a 7479   ada::scheme::ty
-000a8b30: 7065 2074 7970 6529 206e 6f65 7863 6570  pe type) noexcep
-000a8b40: 7420 7b0a 2020 7369 7a65 5f74 2066 6972  t {.  size_t fir
-000a8b50: 7374 5f64 656c 696d 6974 6572 203d 2070  st_delimiter = p
-000a8b60: 6174 682e 6669 6e64 5f66 6972 7374 5f6f  ath.find_first_o
-000a8b70: 6628 272f 272c 2031 293b 0a0a 2020 2f2f  f('/', 1);..  //
-000a8b80: 204c 6574 2070 6174 6820 6265 2075 726c   Let path be url
-000a8b90: e280 9973 2070 6174 682e 0a20 202f 2f20  ...s path..  // 
-000a8ba0: 4966 2075 726c e280 9973 2073 6368 656d  If url...s schem
-000a8bb0: 6520 6973 2022 6669 6c65 222c 2070 6174  e is "file", pat
-000a8bc0: 68e2 8099 7320 7369 7a65 2069 7320 312c  h...s size is 1,
-000a8bd0: 2061 6e64 2070 6174 685b 305d 2069 7320   and path[0] is 
-000a8be0: 6120 6e6f 726d 616c 697a 6564 0a20 202f  a normalized.  /
-000a8bf0: 2f20 5769 6e64 6f77 7320 6472 6976 6520  / Windows drive 
-000a8c00: 6c65 7474 6572 2c20 7468 656e 2072 6574  letter, then ret
-000a8c10: 7572 6e2e 0a20 2069 6620 2874 7970 6520  urn..  if (type 
-000a8c20: 3d3d 2061 6461 3a3a 7363 6865 6d65 3a3a  == ada::scheme::
-000a8c30: 7479 7065 3a3a 4649 4c45 2026 260a 2020  type::FILE &&.  
-000a8c40: 2020 2020 6669 7273 745f 6465 6c69 6d69      first_delimi
-000a8c50: 7465 7220 3d3d 2073 7464 3a3a 7374 7269  ter == std::stri
-000a8c60: 6e67 5f76 6965 773a 3a6e 706f 7320 2626  ng_view::npos &&
-000a8c70: 2021 7061 7468 2e65 6d70 7479 2829 2920   !path.empty()) 
-000a8c80: 7b0a 2020 2020 6966 2028 6368 6563 6b65  {.    if (checke
-000a8c90: 7273 3a3a 6973 5f6e 6f72 6d61 6c69 7a65  rs::is_normalize
-000a8ca0: 645f 7769 6e64 6f77 735f 6472 6976 655f  d_windows_drive_
-000a8cb0: 6c65 7474 6572 280a 2020 2020 2020 2020  letter(.        
-000a8cc0: 2020 2020 6865 6c70 6572 733a 3a73 7562      helpers::sub
-000a8cd0: 7374 7269 6e67 2870 6174 682c 2031 2929  string(path, 1))
-000a8ce0: 2920 7b0a 2020 2020 2020 7265 7475 726e  ) {.      return
-000a8cf0: 2066 616c 7365 3b0a 2020 2020 7d0a 2020   false;.    }.  
-000a8d00: 7d0a 0a20 202f 2f20 5265 6d6f 7665 2070  }..  // Remove p
-000a8d10: 6174 68e2 8099 7320 6c61 7374 2069 7465  ath...s last ite
-000a8d20: 6d2c 2069 6620 616e 792e 0a20 2073 697a  m, if any..  siz
-000a8d30: 655f 7420 6c61 7374 5f64 656c 696d 6974  e_t last_delimit
-000a8d40: 6572 203d 2070 6174 682e 7266 696e 6428  er = path.rfind(
-000a8d50: 272f 2729 3b0a 2020 6966 2028 6c61 7374  '/');.  if (last
-000a8d60: 5f64 656c 696d 6974 6572 2021 3d20 7374  _delimiter != st
-000a8d70: 643a 3a73 7472 696e 673a 3a6e 706f 7329  d::string::npos)
-000a8d80: 207b 0a20 2020 2070 6174 682e 6572 6173   {.    path.eras
-000a8d90: 6528 6c61 7374 5f64 656c 696d 6974 6572  e(last_delimiter
-000a8da0: 293b 0a20 2020 2072 6574 7572 6e20 7472  );.    return tr
-000a8db0: 7565 3b0a 2020 7d0a 0a20 2072 6574 7572  ue;.  }..  retur
-000a8dc0: 6e20 6661 6c73 653b 0a7d 0a0a 6164 615f  n false;.}..ada_
-000a8dd0: 7265 616c 6c79 5f69 6e6c 696e 6520 626f  really_inline bo
-000a8de0: 6f6c 2073 686f 7274 656e 5f70 6174 6828  ol shorten_path(
-000a8df0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000a8e00: 2620 7061 7468 2c0a 2020 2020 2020 2020  & path,.        
+000a8b20: 6164 613a 3a73 6368 656d 653a 3a74 7970  ada::scheme::typ
+000a8b30: 6520 7479 7065 2920 6e6f 6578 6365 7074  e type) noexcept
+000a8b40: 207b 0a20 2073 697a 655f 7420 6669 7273   {.  size_t firs
+000a8b50: 745f 6465 6c69 6d69 7465 7220 3d20 7061  t_delimiter = pa
+000a8b60: 7468 2e66 696e 645f 6669 7273 745f 6f66  th.find_first_of
+000a8b70: 2827 2f27 2c20 3129 3b0a 0a20 202f 2f20  ('/', 1);..  // 
+000a8b80: 4c65 7420 7061 7468 2062 6520 7572 6ce2  Let path be url.
+000a8b90: 8099 7320 7061 7468 2e0a 2020 2f2f 2049  ..s path..  // I
+000a8ba0: 6620 7572 6ce2 8099 7320 7363 6865 6d65  f url...s scheme
+000a8bb0: 2069 7320 2266 696c 6522 2c20 7061 7468   is "file", path
+000a8bc0: e280 9973 2073 697a 6520 6973 2031 2c20  ...s size is 1, 
+000a8bd0: 616e 6420 7061 7468 5b30 5d20 6973 2061  and path[0] is a
+000a8be0: 206e 6f72 6d61 6c69 7a65 640a 2020 2f2f   normalized.  //
+000a8bf0: 2057 696e 646f 7773 2064 7269 7665 206c   Windows drive l
+000a8c00: 6574 7465 722c 2074 6865 6e20 7265 7475  etter, then retu
+000a8c10: 726e 2e0a 2020 6966 2028 7479 7065 203d  rn..  if (type =
+000a8c20: 3d20 6164 613a 3a73 6368 656d 653a 3a74  = ada::scheme::t
+000a8c30: 7970 653a 3a46 494c 4520 2626 0a20 2020  ype::FILE &&.   
+000a8c40: 2020 2066 6972 7374 5f64 656c 696d 6974     first_delimit
+000a8c50: 6572 203d 3d20 7374 643a 3a73 7472 696e  er == std::strin
+000a8c60: 675f 7669 6577 3a3a 6e70 6f73 2026 2620  g_view::npos && 
+000a8c70: 2170 6174 682e 656d 7074 7928 2929 207b  !path.empty()) {
+000a8c80: 0a20 2020 2069 6620 2863 6865 636b 6572  .    if (checker
+000a8c90: 733a 3a69 735f 6e6f 726d 616c 697a 6564  s::is_normalized
+000a8ca0: 5f77 696e 646f 7773 5f64 7269 7665 5f6c  _windows_drive_l
+000a8cb0: 6574 7465 7228 0a20 2020 2020 2020 2020  etter(.         
+000a8cc0: 2020 2068 656c 7065 7273 3a3a 7375 6273     helpers::subs
+000a8cd0: 7472 696e 6728 7061 7468 2c20 3129 2929  tring(path, 1)))
+000a8ce0: 207b 0a20 2020 2020 2072 6574 7572 6e20   {.      return 
+000a8cf0: 6661 6c73 653b 0a20 2020 207d 0a20 207d  false;.    }.  }
+000a8d00: 0a0a 2020 2f2f 2052 656d 6f76 6520 7061  ..  // Remove pa
+000a8d10: 7468 e280 9973 206c 6173 7420 6974 656d  th...s last item
+000a8d20: 2c20 6966 2061 6e79 2e0a 2020 7369 7a65  , if any..  size
+000a8d30: 5f74 206c 6173 745f 6465 6c69 6d69 7465  _t last_delimite
+000a8d40: 7220 3d20 7061 7468 2e72 6669 6e64 2827  r = path.rfind('
+000a8d50: 2f27 293b 0a20 2069 6620 286c 6173 745f  /');.  if (last_
+000a8d60: 6465 6c69 6d69 7465 7220 213d 2073 7464  delimiter != std
+000a8d70: 3a3a 7374 7269 6e67 3a3a 6e70 6f73 2920  ::string::npos) 
+000a8d80: 7b0a 2020 2020 7061 7468 2e65 7261 7365  {.    path.erase
+000a8d90: 286c 6173 745f 6465 6c69 6d69 7465 7229  (last_delimiter)
+000a8da0: 3b0a 2020 2020 7265 7475 726e 2074 7275  ;.    return tru
+000a8db0: 653b 0a20 207d 0a0a 2020 7265 7475 726e  e;.  }..  return
+000a8dc0: 2066 616c 7365 3b0a 7d0a 0a61 6461 5f72   false;.}..ada_r
+000a8dd0: 6561 6c6c 795f 696e 6c69 6e65 2062 6f6f  eally_inline boo
+000a8de0: 6c20 7368 6f72 7465 6e5f 7061 7468 2873  l shorten_path(s
+000a8df0: 7464 3a3a 7374 7269 6e67 5f76 6965 7726  td::string_view&
+000a8e00: 2070 6174 682c 0a20 2020 2020 2020 2020   path,.         
 000a8e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a8e20: 2020 2020 2020 2020 2020 2020 6164 613a              ada:
-000a8e30: 3a73 6368 656d 653a 3a74 7970 6520 7479  :scheme::type ty
-000a8e40: 7065 2920 6e6f 6578 6365 7074 207b 0a20  pe) noexcept {. 
-000a8e50: 2073 697a 655f 7420 6669 7273 745f 6465   size_t first_de
-000a8e60: 6c69 6d69 7465 7220 3d20 7061 7468 2e66  limiter = path.f
-000a8e70: 696e 645f 6669 7273 745f 6f66 2827 2f27  ind_first_of('/'
-000a8e80: 2c20 3129 3b0a 0a20 202f 2f20 4c65 7420  , 1);..  // Let 
-000a8e90: 7061 7468 2062 6520 7572 6ce2 8099 7320  path be url...s 
-000a8ea0: 7061 7468 2e0a 2020 2f2f 2049 6620 7572  path..  // If ur
-000a8eb0: 6ce2 8099 7320 7363 6865 6d65 2069 7320  l...s scheme is 
-000a8ec0: 2266 696c 6522 2c20 7061 7468 e280 9973  "file", path...s
-000a8ed0: 2073 697a 6520 6973 2031 2c20 616e 6420   size is 1, and 
-000a8ee0: 7061 7468 5b30 5d20 6973 2061 206e 6f72  path[0] is a nor
-000a8ef0: 6d61 6c69 7a65 640a 2020 2f2f 2057 696e  malized.  // Win
-000a8f00: 646f 7773 2064 7269 7665 206c 6574 7465  dows drive lette
-000a8f10: 722c 2074 6865 6e20 7265 7475 726e 2e0a  r, then return..
-000a8f20: 2020 6966 2028 7479 7065 203d 3d20 6164    if (type == ad
-000a8f30: 613a 3a73 6368 656d 653a 3a74 7970 653a  a::scheme::type:
-000a8f40: 3a46 494c 4520 2626 0a20 2020 2020 2066  :FILE &&.      f
-000a8f50: 6972 7374 5f64 656c 696d 6974 6572 203d  irst_delimiter =
-000a8f60: 3d20 7374 643a 3a73 7472 696e 675f 7669  = std::string_vi
-000a8f70: 6577 3a3a 6e70 6f73 2026 2620 2170 6174  ew::npos && !pat
-000a8f80: 682e 656d 7074 7928 2929 207b 0a20 2020  h.empty()) {.   
-000a8f90: 2069 6620 2863 6865 636b 6572 733a 3a69   if (checkers::i
-000a8fa0: 735f 6e6f 726d 616c 697a 6564 5f77 696e  s_normalized_win
-000a8fb0: 646f 7773 5f64 7269 7665 5f6c 6574 7465  dows_drive_lette
-000a8fc0: 7228 0a20 2020 2020 2020 2020 2020 2068  r(.            h
-000a8fd0: 656c 7065 7273 3a3a 7375 6273 7472 696e  elpers::substrin
-000a8fe0: 6728 7061 7468 2c20 3129 2929 207b 0a20  g(path, 1))) {. 
-000a8ff0: 2020 2020 2072 6574 7572 6e20 6661 6c73       return fals
-000a9000: 653b 0a20 2020 207d 0a20 207d 0a0a 2020  e;.    }.  }..  
-000a9010: 2f2f 2052 656d 6f76 6520 7061 7468 e280  // Remove path..
-000a9020: 9973 206c 6173 7420 6974 656d 2c20 6966  .s last item, if
-000a9030: 2061 6e79 2e0a 2020 6966 2028 2170 6174   any..  if (!pat
-000a9040: 682e 656d 7074 7928 2929 207b 0a20 2020  h.empty()) {.   
-000a9050: 2073 697a 655f 7420 736c 6173 685f 6c6f   size_t slash_lo
-000a9060: 6320 3d20 7061 7468 2e72 6669 6e64 2827  c = path.rfind('
-000a9070: 2f27 293b 0a20 2020 2069 6620 2873 6c61  /');.    if (sla
-000a9080: 7368 5f6c 6f63 2021 3d20 7374 643a 3a73  sh_loc != std::s
-000a9090: 7472 696e 675f 7669 6577 3a3a 6e70 6f73  tring_view::npos
-000a90a0: 2920 7b0a 2020 2020 2020 7061 7468 2e72  ) {.      path.r
-000a90b0: 656d 6f76 655f 7375 6666 6978 2870 6174  emove_suffix(pat
-000a90c0: 682e 7369 7a65 2829 202d 2073 6c61 7368  h.size() - slash
-000a90d0: 5f6c 6f63 293b 0a20 2020 2020 2072 6574  _loc);.      ret
-000a90e0: 7572 6e20 7472 7565 3b0a 2020 2020 7d0a  urn true;.    }.
-000a90f0: 2020 7d0a 0a20 2072 6574 7572 6e20 6661    }..  return fa
-000a9100: 6c73 653b 0a7d 0a0a 6164 615f 7265 616c  lse;.}..ada_real
-000a9110: 6c79 5f69 6e6c 696e 6520 766f 6964 2072  ly_inline void r
-000a9120: 656d 6f76 655f 6173 6369 695f 7461 625f  emove_ascii_tab_
-000a9130: 6f72 5f6e 6577 6c69 6e65 280a 2020 2020  or_newline(.    
-000a9140: 7374 643a 3a73 7472 696e 6726 2069 6e70  std::string& inp
-000a9150: 7574 2920 6e6f 6578 6365 7074 207b 0a20  ut) noexcept {. 
-000a9160: 202f 2f20 6966 2074 6869 7320 6576 6572   // if this ever
-000a9170: 2062 6563 6f6d 6573 2061 2070 6572 666f   becomes a perfo
-000a9180: 726d 616e 6365 2069 7373 7565 2c20 7765  rmance issue, we
-000a9190: 2063 6f75 6c64 2075 7365 2061 6e20 6170   could use an ap
-000a91a0: 7072 6f61 6368 2073 696d 696c 6172 0a20  proach similar. 
-000a91b0: 202f 2f20 746f 2068 6173 5f74 6162 735f   // to has_tabs_
-000a91c0: 6f72 5f6e 6577 6c69 6e65 0a20 2069 6e70  or_newline.  inp
-000a91d0: 7574 2e65 7261 7365 2873 7464 3a3a 7265  ut.erase(std::re
-000a91e0: 6d6f 7665 5f69 6628 696e 7075 742e 6265  move_if(input.be
-000a91f0: 6769 6e28 292c 2069 6e70 7574 2e65 6e64  gin(), input.end
-000a9200: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+000a8e20: 2020 2020 2020 2020 2020 2061 6461 3a3a             ada::
+000a8e30: 7363 6865 6d65 3a3a 7479 7065 2074 7970  scheme::type typ
+000a8e40: 6529 206e 6f65 7863 6570 7420 7b0a 2020  e) noexcept {.  
+000a8e50: 7369 7a65 5f74 2066 6972 7374 5f64 656c  size_t first_del
+000a8e60: 696d 6974 6572 203d 2070 6174 682e 6669  imiter = path.fi
+000a8e70: 6e64 5f66 6972 7374 5f6f 6628 272f 272c  nd_first_of('/',
+000a8e80: 2031 293b 0a0a 2020 2f2f 204c 6574 2070   1);..  // Let p
+000a8e90: 6174 6820 6265 2075 726c e280 9973 2070  ath be url...s p
+000a8ea0: 6174 682e 0a20 202f 2f20 4966 2075 726c  ath..  // If url
+000a8eb0: e280 9973 2073 6368 656d 6520 6973 2022  ...s scheme is "
+000a8ec0: 6669 6c65 222c 2070 6174 68e2 8099 7320  file", path...s 
+000a8ed0: 7369 7a65 2069 7320 312c 2061 6e64 2070  size is 1, and p
+000a8ee0: 6174 685b 305d 2069 7320 6120 6e6f 726d  ath[0] is a norm
+000a8ef0: 616c 697a 6564 0a20 202f 2f20 5769 6e64  alized.  // Wind
+000a8f00: 6f77 7320 6472 6976 6520 6c65 7474 6572  ows drive letter
+000a8f10: 2c20 7468 656e 2072 6574 7572 6e2e 0a20  , then return.. 
+000a8f20: 2069 6620 2874 7970 6520 3d3d 2061 6461   if (type == ada
+000a8f30: 3a3a 7363 6865 6d65 3a3a 7479 7065 3a3a  ::scheme::type::
+000a8f40: 4649 4c45 2026 260a 2020 2020 2020 6669  FILE &&.      fi
+000a8f50: 7273 745f 6465 6c69 6d69 7465 7220 3d3d  rst_delimiter ==
+000a8f60: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000a8f70: 773a 3a6e 706f 7320 2626 2021 7061 7468  w::npos && !path
+000a8f80: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000a8f90: 6966 2028 6368 6563 6b65 7273 3a3a 6973  if (checkers::is
+000a8fa0: 5f6e 6f72 6d61 6c69 7a65 645f 7769 6e64  _normalized_wind
+000a8fb0: 6f77 735f 6472 6976 655f 6c65 7474 6572  ows_drive_letter
+000a8fc0: 280a 2020 2020 2020 2020 2020 2020 6865  (.            he
+000a8fd0: 6c70 6572 733a 3a73 7562 7374 7269 6e67  lpers::substring
+000a8fe0: 2870 6174 682c 2031 2929 2920 7b0a 2020  (path, 1))) {.  
+000a8ff0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000a9000: 3b0a 2020 2020 7d0a 2020 7d0a 0a20 202f  ;.    }.  }..  /
+000a9010: 2f20 5265 6d6f 7665 2070 6174 68e2 8099  / Remove path...
+000a9020: 7320 6c61 7374 2069 7465 6d2c 2069 6620  s last item, if 
+000a9030: 616e 792e 0a20 2069 6620 2821 7061 7468  any..  if (!path
+000a9040: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000a9050: 7369 7a65 5f74 2073 6c61 7368 5f6c 6f63  size_t slash_loc
+000a9060: 203d 2070 6174 682e 7266 696e 6428 272f   = path.rfind('/
+000a9070: 2729 3b0a 2020 2020 6966 2028 736c 6173  ');.    if (slas
+000a9080: 685f 6c6f 6320 213d 2073 7464 3a3a 7374  h_loc != std::st
+000a9090: 7269 6e67 5f76 6965 773a 3a6e 706f 7329  ring_view::npos)
+000a90a0: 207b 0a20 2020 2020 2070 6174 682e 7265   {.      path.re
+000a90b0: 6d6f 7665 5f73 7566 6669 7828 7061 7468  move_suffix(path
+000a90c0: 2e73 697a 6528 2920 2d20 736c 6173 685f  .size() - slash_
+000a90d0: 6c6f 6329 3b0a 2020 2020 2020 7265 7475  loc);.      retu
+000a90e0: 726e 2074 7275 653b 0a20 2020 207d 0a20  rn true;.    }. 
+000a90f0: 207d 0a0a 2020 7265 7475 726e 2066 616c   }..  return fal
+000a9100: 7365 3b0a 7d0a 0a61 6461 5f72 6561 6c6c  se;.}..ada_reall
+000a9110: 795f 696e 6c69 6e65 2076 6f69 6420 7265  y_inline void re
+000a9120: 6d6f 7665 5f61 7363 6969 5f74 6162 5f6f  move_ascii_tab_o
+000a9130: 725f 6e65 776c 696e 6528 0a20 2020 2073  r_newline(.    s
+000a9140: 7464 3a3a 7374 7269 6e67 2620 696e 7075  td::string& inpu
+000a9150: 7429 206e 6f65 7863 6570 7420 7b0a 2020  t) noexcept {.  
+000a9160: 2f2f 2069 6620 7468 6973 2065 7665 7220  // if this ever 
+000a9170: 6265 636f 6d65 7320 6120 7065 7266 6f72  becomes a perfor
+000a9180: 6d61 6e63 6520 6973 7375 652c 2077 6520  mance issue, we 
+000a9190: 636f 756c 6420 7573 6520 616e 2061 7070  could use an app
+000a91a0: 726f 6163 6820 7369 6d69 6c61 720a 2020  roach similar.  
+000a91b0: 2f2f 2074 6f20 6861 735f 7461 6273 5f6f  // to has_tabs_o
+000a91c0: 725f 6e65 776c 696e 650a 2020 696e 7075  r_newline.  inpu
+000a91d0: 742e 6572 6173 6528 7374 643a 3a72 656d  t.erase(std::rem
+000a91e0: 6f76 655f 6966 2869 6e70 7574 2e62 6567  ove_if(input.beg
+000a91f0: 696e 2829 2c20 696e 7075 742e 656e 6428  in(), input.end(
+000a9200: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
 000a9210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a9220: 205b 5d28 6368 6172 2063 2920 7b0a 2020   [](char c) {.  
+000a9220: 5b5d 2863 6861 7220 6329 207b 0a20 2020  [](char c) {.   
 000a9230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a9240: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000a9250: 7572 6e20 6164 613a 3a75 6e69 636f 6465  urn ada::unicode
-000a9260: 3a3a 6973 5f61 7363 6969 5f74 6162 5f6f  ::is_ascii_tab_o
-000a9270: 725f 6e65 776c 696e 6528 6329 3b0a 2020  r_newline(c);.  
+000a9240: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000a9250: 726e 2061 6461 3a3a 756e 6963 6f64 653a  rn ada::unicode:
+000a9260: 3a69 735f 6173 6369 695f 7461 625f 6f72  :is_ascii_tab_or
+000a9270: 5f6e 6577 6c69 6e65 2863 293b 0a20 2020  _newline(c);.   
 000a9280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a9290: 2020 2020 2020 2020 2020 207d 292c 0a20             }),. 
-000a92a0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000a92b0: 7574 2e65 6e64 2829 293b 0a7d 0a0a 6164  ut.end());.}..ad
-000a92c0: 615f 7265 616c 6c79 5f69 6e6c 696e 6520  a_really_inline 
-000a92d0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000a92e0: 2073 7562 7374 7269 6e67 2873 7464 3a3a   substring(std::
-000a92f0: 7374 7269 6e67 5f76 6965 7720 696e 7075  string_view inpu
-000a9300: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000a9290: 2020 2020 2020 2020 2020 7d29 2c0a 2020            }),.  
+000a92a0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+000a92b0: 742e 656e 6428 2929 3b0a 7d0a 0a61 6461  t.end());.}..ada
+000a92c0: 5f72 6561 6c6c 795f 696e 6c69 6e65 2073  _really_inline s
+000a92d0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000a92e0: 7375 6273 7472 696e 6728 7374 643a 3a73  substring(std::s
+000a92f0: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
+000a9300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 000a9310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a9320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000a9330: 7369 7a65 5f74 2070 6f73 2920 6e6f 6578  size_t pos) noex
-000a9340: 6365 7074 207b 0a20 2041 4441 5f41 5353  cept {.  ADA_ASS
-000a9350: 4552 545f 5452 5545 2870 6f73 203c 3d20  ERT_TRUE(pos <= 
-000a9360: 696e 7075 742e 7369 7a65 2829 293b 0a20  input.size());. 
-000a9370: 202f 2f20 5468 6520 666f 6c6c 6f77 696e   // The followin
-000a9380: 6720 6973 2073 6166 6572 2062 7574 2075  g is safer but u
+000a9320: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000a9330: 697a 655f 7420 706f 7329 206e 6f65 7863  ize_t pos) noexc
+000a9340: 6570 7420 7b0a 2020 4144 415f 4153 5345  ept {.  ADA_ASSE
+000a9350: 5254 5f54 5255 4528 706f 7320 3c3d 2069  RT_TRUE(pos <= i
+000a9360: 6e70 7574 2e73 697a 6528 2929 3b0a 2020  nput.size());.  
+000a9370: 2f2f 2054 6865 2066 6f6c 6c6f 7769 6e67  // The following
+000a9380: 2069 7320 7361 6665 7220 6275 7420 756e   is safer but un
 000a9390: 6e65 6564 6564 2069 6620 7765 2068 6176  needed if we hav
 000a93a0: 6520 7468 6520 6162 6f76 6520 6c69 6e65  e the above line
 000a93b0: 3a0a 2020 2f2f 2072 6574 7572 6e20 706f  :.  // return po
 000a93c0: 7320 3e20 696e 7075 742e 7369 7a65 2829  s > input.size()
 000a93d0: 203f 2073 7464 3a3a 7374 7269 6e67 5f76   ? std::string_v
 000a93e0: 6965 7728 2920 3a20 696e 7075 742e 7375  iew() : input.su
 000a93f0: 6273 7472 2870 6f73 293b 0a20 2072 6574  bstr(pos);.  ret
@@ -45819,7464 +45819,7484 @@
 000b2fa0: 6c5f 7363 6865 6d65 203d 3d20 2262 6c6f  l_scheme == "blo
 000b2fb0: 6222 2920 7b0a 2020 2020 6966 2028 2170  b") {.    if (!p
 000b2fc0: 6174 682e 656d 7074 7928 2929 207b 0a20  ath.empty()) {. 
 000b2fd0: 2020 2020 2061 7574 6f20 7265 7375 6c74       auto result
 000b2fe0: 203d 2061 6461 3a3a 7061 7273 653c 6164   = ada::parse<ad
 000b2ff0: 613a 3a75 726c 3e28 7061 7468 293b 0a20  a::url>(path);. 
 000b3000: 2020 2020 2069 6620 2872 6573 756c 7420       if (result 
-000b3010: 2626 2072 6573 756c 742d 3e69 735f 7370  && result->is_sp
-000b3020: 6563 6961 6c28 2929 207b 0a20 2020 2020  ecial()) {.     
-000b3030: 2020 2072 6574 7572 6e20 6164 613a 3a68     return ada::h
-000b3040: 656c 7065 7273 3a3a 636f 6e63 6174 2872  elpers::concat(r
-000b3050: 6573 756c 742d 3e67 6574 5f70 726f 746f  esult->get_proto
-000b3060: 636f 6c28 292c 2022 2f2f 222c 0a20 2020  col(), "//",.   
-000b3070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3090: 2072 6573 756c 742d 3e67 6574 5f68 6f73   result->get_hos
-000b30a0: 7428 2929 3b0a 2020 2020 2020 7d0a 2020  t());.      }.  
-000b30b0: 2020 7d0a 2020 7d0a 0a20 202f 2f20 5265    }.  }..  // Re
-000b30c0: 7475 726e 2061 206e 6577 206f 7061 7175  turn a new opaqu
-000b30d0: 6520 6f72 6967 696e 2e0a 2020 7265 7475  e origin..  retu
-000b30e0: 726e 2022 6e75 6c6c 223b 0a7d 0a0a 5b5b  rn "null";.}..[[
-000b30f0: 6e6f 6469 7363 6172 645d 5d20 7374 643a  nodiscard]] std:
-000b3100: 3a73 7472 696e 6720 7572 6c3a 3a67 6574  :string url::get
-000b3110: 5f70 726f 746f 636f 6c28 2920 636f 6e73  _protocol() cons
-000b3120: 7420 6e6f 6578 6365 7074 207b 0a20 2069  t noexcept {.  i
-000b3130: 6620 2869 735f 7370 6563 6961 6c28 2929  f (is_special())
-000b3140: 207b 0a20 2020 2072 6574 7572 6e20 6865   {.    return he
-000b3150: 6c70 6572 733a 3a63 6f6e 6361 7428 6164  lpers::concat(ad
-000b3160: 613a 3a73 6368 656d 653a 3a64 6574 6169  a::scheme::detai
-000b3170: 6c73 3a3a 6973 5f73 7065 6369 616c 5f6c  ls::is_special_l
-000b3180: 6973 745b 7479 7065 5d2c 2022 3a22 293b  ist[type], ":");
-000b3190: 0a20 207d 0a20 202f 2f20 5765 206f 6e6c  .  }.  // We onl
-000b31a0: 7920 6d6f 7665 2074 6865 2027 7363 6865  y move the 'sche
-000b31b0: 6d65 2720 6966 2069 7420 6973 206e 6f6e  me' if it is non
-000b31c0: 2d73 7065 6369 616c 2e0a 2020 7265 7475  -special..  retu
-000b31d0: 726e 2068 656c 7065 7273 3a3a 636f 6e63  rn helpers::conc
-000b31e0: 6174 286e 6f6e 5f73 7065 6369 616c 5f73  at(non_special_s
-000b31f0: 6368 656d 652c 2022 3a22 293b 0a7d 0a0a  cheme, ":");.}..
-000b3200: 5b5b 6e6f 6469 7363 6172 645d 5d20 7374  [[nodiscard]] st
-000b3210: 643a 3a73 7472 696e 6720 7572 6c3a 3a67  d::string url::g
-000b3220: 6574 5f68 6f73 7428 2920 636f 6e73 7420  et_host() const 
-000b3230: 6e6f 6578 6365 7074 207b 0a20 202f 2f20  noexcept {.  // 
-000b3240: 4966 2075 726c e280 9973 2068 6f73 7420  If url...s host 
-000b3250: 6973 206e 756c 6c2c 2074 6865 6e20 7265  is null, then re
-000b3260: 7475 726e 2074 6865 2065 6d70 7479 2073  turn the empty s
-000b3270: 7472 696e 672e 0a20 202f 2f20 4966 2075  tring..  // If u
-000b3280: 726c e280 9973 2070 6f72 7420 6973 206e  rl...s port is n
-000b3290: 756c 6c2c 2072 6574 7572 6e20 7572 6ce2  ull, return url.
-000b32a0: 8099 7320 686f 7374 2c20 7365 7269 616c  ..s host, serial
-000b32b0: 697a 6564 2e0a 2020 2f2f 2052 6574 7572  ized..  // Retur
-000b32c0: 6e20 7572 6ce2 8099 7320 686f 7374 2c20  n url...s host, 
-000b32d0: 7365 7269 616c 697a 6564 2c20 666f 6c6c  serialized, foll
-000b32e0: 6f77 6564 2062 7920 552b 3030 3341 2028  owed by U+003A (
-000b32f0: 3a29 2061 6e64 2075 726c e280 9973 2070  :) and url...s p
-000b3300: 6f72 742c 0a20 202f 2f20 7365 7269 616c  ort,.  // serial
-000b3310: 697a 6564 2e0a 2020 6966 2028 2168 6f73  ized..  if (!hos
-000b3320: 742e 6861 735f 7661 6c75 6528 2929 207b  t.has_value()) {
-000b3330: 0a20 2020 2072 6574 7572 6e20 2222 3b0a  .    return "";.
-000b3340: 2020 7d0a 2020 6966 2028 706f 7274 2e68    }.  if (port.h
-000b3350: 6173 5f76 616c 7565 2829 2920 7b0a 2020  as_value()) {.  
-000b3360: 2020 7265 7475 726e 2068 6f73 742e 7661    return host.va
-000b3370: 6c75 6528 2920 2b20 223a 2220 2b20 6765  lue() + ":" + ge
-000b3380: 745f 706f 7274 2829 3b0a 2020 7d0a 2020  t_port();.  }.  
-000b3390: 7265 7475 726e 2068 6f73 742e 7661 6c75  return host.valu
-000b33a0: 6528 293b 0a7d 0a0a 5b5b 6e6f 6469 7363  e();.}..[[nodisc
-000b33b0: 6172 645d 5d20 7374 643a 3a73 7472 696e  ard]] std::strin
-000b33c0: 6720 7572 6c3a 3a67 6574 5f68 6f73 746e  g url::get_hostn
-000b33d0: 616d 6528 2920 636f 6e73 7420 6e6f 6578  ame() const noex
-000b33e0: 6365 7074 207b 0a20 2072 6574 7572 6e20  cept {.  return 
-000b33f0: 686f 7374 2e76 616c 7565 5f6f 7228 2222  host.value_or(""
-000b3400: 293b 0a7d 0a0a 5b5b 6e6f 6469 7363 6172  );.}..[[nodiscar
-000b3410: 645d 5d20 636f 6e73 7420 7374 643a 3a73  d]] const std::s
-000b3420: 7472 696e 675f 7669 6577 2075 726c 3a3a  tring_view url::
-000b3430: 6765 745f 7061 7468 6e61 6d65 2829 2063  get_pathname() c
-000b3440: 6f6e 7374 206e 6f65 7863 6570 7420 7b0a  onst noexcept {.
-000b3450: 2020 7265 7475 726e 2070 6174 683b 0a7d    return path;.}
-000b3460: 0a0a 5b5b 6e6f 6469 7363 6172 645d 5d20  ..[[nodiscard]] 
-000b3470: 7374 643a 3a73 7472 696e 6720 7572 6c3a  std::string url:
-000b3480: 3a67 6574 5f73 6561 7263 6828 2920 636f  :get_search() co
-000b3490: 6e73 7420 6e6f 6578 6365 7074 207b 0a20  nst noexcept {. 
-000b34a0: 202f 2f20 4966 2074 6869 73e2 8099 7320   // If this...s 
-000b34b0: 5552 4ce2 8099 7320 7175 6572 7920 6973  URL...s query is
-000b34c0: 2065 6974 6865 7220 6e75 6c6c 206f 7220   either null or 
-000b34d0: 7468 6520 656d 7074 7920 7374 7269 6e67  the empty string
-000b34e0: 2c20 7468 656e 2072 6574 7572 6e20 7468  , then return th
-000b34f0: 650a 2020 2f2f 2065 6d70 7479 2073 7472  e.  // empty str
-000b3500: 696e 672e 2052 6574 7572 6e20 552b 3030  ing. Return U+00
-000b3510: 3346 2028 3f29 2c20 666f 6c6c 6f77 6564  3F (?), followed
-000b3520: 2062 7920 7468 6973 e280 9973 2055 524c   by this...s URL
-000b3530: e280 9973 2071 7565 7279 2e0a 2020 7265  ...s query..  re
-000b3540: 7475 726e 2028 2171 7565 7279 2e68 6173  turn (!query.has
-000b3550: 5f76 616c 7565 2829 207c 7c20 2871 7565  _value() || (que
-000b3560: 7279 2e76 616c 7565 2829 2e65 6d70 7479  ry.value().empty
-000b3570: 2829 2929 203f 2022 220a 2020 2020 2020  ())) ? "".      
-000b3580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b35a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b35b0: 2020 203a 2022 3f22 202b 2071 7565 7279     : "?" + query
-000b35c0: 2e76 616c 7565 2829 3b0a 7d0a 0a5b 5b6e  .value();.}..[[n
-000b35d0: 6f64 6973 6361 7264 5d5d 2063 6f6e 7374  odiscard]] const
-000b35e0: 2073 7464 3a3a 7374 7269 6e67 2620 7572   std::string& ur
-000b35f0: 6c3a 3a67 6574 5f75 7365 726e 616d 6528  l::get_username(
-000b3600: 2920 636f 6e73 7420 6e6f 6578 6365 7074  ) const noexcept
-000b3610: 207b 0a20 2072 6574 7572 6e20 7573 6572   {.  return user
-000b3620: 6e61 6d65 3b0a 7d0a 0a5b 5b6e 6f64 6973  name;.}..[[nodis
-000b3630: 6361 7264 5d5d 2063 6f6e 7374 2073 7464  card]] const std
-000b3640: 3a3a 7374 7269 6e67 2620 7572 6c3a 3a67  ::string& url::g
-000b3650: 6574 5f70 6173 7377 6f72 6428 2920 636f  et_password() co
-000b3660: 6e73 7420 6e6f 6578 6365 7074 207b 0a20  nst noexcept {. 
-000b3670: 2072 6574 7572 6e20 7061 7373 776f 7264   return password
-000b3680: 3b0a 7d0a 0a5b 5b6e 6f64 6973 6361 7264  ;.}..[[nodiscard
-000b3690: 5d5d 2073 7464 3a3a 7374 7269 6e67 2075  ]] std::string u
-000b36a0: 726c 3a3a 6765 745f 706f 7274 2829 2063  rl::get_port() c
-000b36b0: 6f6e 7374 206e 6f65 7863 6570 7420 7b0a  onst noexcept {.
-000b36c0: 2020 7265 7475 726e 2070 6f72 742e 6861    return port.ha
-000b36d0: 735f 7661 6c75 6528 2920 3f20 7374 643a  s_value() ? std:
-000b36e0: 3a74 6f5f 7374 7269 6e67 2870 6f72 742e  :to_string(port.
-000b36f0: 7661 6c75 6528 2929 203a 2022 223b 0a7d  value()) : "";.}
-000b3700: 0a0a 5b5b 6e6f 6469 7363 6172 645d 5d20  ..[[nodiscard]] 
-000b3710: 7374 643a 3a73 7472 696e 6720 7572 6c3a  std::string url:
-000b3720: 3a67 6574 5f68 6173 6828 2920 636f 6e73  :get_hash() cons
-000b3730: 7420 6e6f 6578 6365 7074 207b 0a20 202f  t noexcept {.  /
-000b3740: 2f20 4966 2074 6869 73e2 8099 7320 5552  / If this...s UR
-000b3750: 4ce2 8099 7320 6672 6167 6d65 6e74 2069  L...s fragment i
-000b3760: 7320 6569 7468 6572 206e 756c 6c20 6f72  s either null or
-000b3770: 2074 6865 2065 6d70 7479 2073 7472 696e   the empty strin
-000b3780: 672c 2074 6865 6e20 7265 7475 726e 0a20  g, then return. 
-000b3790: 202f 2f20 7468 6520 656d 7074 7920 7374   // the empty st
-000b37a0: 7269 6e67 2e20 5265 7475 726e 2055 2b30  ring. Return U+0
-000b37b0: 3032 3320 2823 292c 2066 6f6c 6c6f 7765  023 (#), followe
-000b37c0: 6420 6279 2074 6869 73e2 8099 7320 5552  d by this...s UR
-000b37d0: 4ce2 8099 7320 6672 6167 6d65 6e74 2e0a  L...s fragment..
-000b37e0: 2020 7265 7475 726e 2028 2168 6173 682e    return (!hash.
-000b37f0: 6861 735f 7661 6c75 6528 2920 7c7c 2028  has_value() || (
-000b3800: 6861 7368 2e76 616c 7565 2829 2e65 6d70  hash.value().emp
-000b3810: 7479 2829 2929 203f 2022 220a 2020 2020  ty())) ? "".    
-000b3820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3850: 2020 203a 2022 2322 202b 2068 6173 682e     : "#" + hash.
-000b3860: 7661 6c75 6528 293b 0a7d 0a0a 7d20 202f  value();.}..}  /
-000b3870: 2f20 6e61 6d65 7370 6163 6520 6164 610a  / namespace ada.
-000b3880: 2f2a 2065 6e64 2066 696c 6520 7372 632f  /* end file src/
-000b3890: 7572 6c2d 6765 7474 6572 732e 6370 7020  url-getters.cpp 
-000b38a0: 2a2f 0a2f 2a20 6265 6769 6e20 6669 6c65  */./* begin file
-000b38b0: 2073 7263 2f75 726c 2d73 6574 7465 7273   src/url-setters
-000b38c0: 2e63 7070 202a 2f0a 2f2a 2a0a 202a 2040  .cpp */./**. * @
-000b38d0: 6669 6c65 2075 726c 2d73 6574 7465 7273  file url-setters
-000b38e0: 2e63 7070 0a20 2a20 496e 636c 7564 6573  .cpp. * Includes
-000b38f0: 2061 6c6c 2074 6865 2073 6574 7465 7273   all the setters
-000b3900: 206f 6620 6061 6461 3a3a 7572 6c60 0a20   of `ada::url`. 
-000b3910: 2a2f 0a0a 2369 6e63 6c75 6465 203c 6f70  */..#include <op
-000b3920: 7469 6f6e 616c 3e0a 2369 6e63 6c75 6465  tional>.#include
-000b3930: 203c 7374 7269 6e67 3e0a 0a6e 616d 6573   <string>..names
-000b3940: 7061 6365 2061 6461 207b 0a0a 7465 6d70  pace ada {..temp
-000b3950: 6c61 7465 203c 626f 6f6c 206f 7665 7272  late <bool overr
-000b3960: 6964 655f 686f 7374 6e61 6d65 3e0a 626f  ide_hostname>.bo
-000b3970: 6f6c 2075 726c 3a3a 7365 745f 686f 7374  ol url::set_host
-000b3980: 5f6f 725f 686f 7374 6e61 6d65 2863 6f6e  _or_hostname(con
-000b3990: 7374 2073 7464 3a3a 7374 7269 6e67 5f76  st std::string_v
-000b39a0: 6965 7720 696e 7075 7429 207b 0a20 2069  iew input) {.  i
-000b39b0: 6620 2868 6173 5f6f 7061 7175 655f 7061  f (has_opaque_pa
-000b39c0: 7468 2920 7b0a 2020 2020 7265 7475 726e  th) {.    return
-000b39d0: 2066 616c 7365 3b0a 2020 7d0a 0a20 2073   false;.  }..  s
-000b39e0: 7464 3a3a 6f70 7469 6f6e 616c 3c73 7464  td::optional<std
-000b39f0: 3a3a 7374 7269 6e67 3e20 7072 6576 696f  ::string> previo
-000b3a00: 7573 5f68 6f73 7420 3d20 686f 7374 3b0a  us_host = host;.
-000b3a10: 2020 7374 643a 3a6f 7074 696f 6e61 6c3c    std::optional<
-000b3a20: 7569 6e74 3136 5f74 3e20 7072 6576 696f  uint16_t> previo
-000b3a30: 7573 5f70 6f72 7420 3d20 706f 7274 3b0a  us_port = port;.
-000b3a40: 0a20 2073 697a 655f 7420 686f 7374 5f65  .  size_t host_e
-000b3a50: 6e64 5f70 6f73 203d 2069 6e70 7574 2e66  nd_pos = input.f
-000b3a60: 696e 6428 2723 2729 3b0a 2020 7374 643a  ind('#');.  std:
-000b3a70: 3a73 7472 696e 6720 5f68 6f73 7428 696e  :string _host(in
-000b3a80: 7075 742e 6461 7461 2829 2c20 686f 7374  put.data(), host
-000b3a90: 5f65 6e64 5f70 6f73 2021 3d20 7374 643a  _end_pos != std:
-000b3aa0: 3a73 7472 696e 675f 7669 6577 3a3a 6e70  :string_view::np
-000b3ab0: 6f73 0a20 2020 2020 2020 2020 2020 2020  os.             
-000b3ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3ad0: 2020 2020 2020 2020 203f 2068 6f73 745f           ? host_
-000b3ae0: 656e 645f 706f 730a 2020 2020 2020 2020  end_pos.        
-000b3af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b3b00: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
-000b3b10: 696e 7075 742e 7369 7a65 2829 293b 0a20  input.size());. 
-000b3b20: 2068 656c 7065 7273 3a3a 7265 6d6f 7665   helpers::remove
-000b3b30: 5f61 7363 6969 5f74 6162 5f6f 725f 6e65  _ascii_tab_or_ne
-000b3b40: 776c 696e 6528 5f68 6f73 7429 3b0a 2020  wline(_host);.  
-000b3b50: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000b3b60: 206e 6577 5f68 6f73 7428 5f68 6f73 7429   new_host(_host)
-000b3b70: 3b0a 0a20 202f 2f20 4966 2075 726c 2773  ;..  // If url's
-000b3b80: 2073 6368 656d 6520 6973 2022 6669 6c65   scheme is "file
-000b3b90: 222c 2074 6865 6e20 7365 7420 7374 6174  ", then set stat
-000b3ba0: 6520 746f 2066 696c 6520 686f 7374 2073  e to file host s
-000b3bb0: 7461 7465 2c20 696e 7374 6561 6420 6f66  tate, instead of
-000b3bc0: 0a20 202f 2f20 686f 7374 2073 7461 7465  .  // host state
-000b3bd0: 2e0a 2020 6966 2028 7479 7065 2021 3d20  ..  if (type != 
-000b3be0: 6164 613a 3a73 6368 656d 653a 3a74 7970  ada::scheme::typ
-000b3bf0: 653a 3a46 494c 4529 207b 0a20 2020 2073  e::FILE) {.    s
-000b3c00: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
-000b3c10: 686f 7374 5f76 6965 7728 5f68 6f73 742e  host_view(_host.
-000b3c20: 6461 7461 2829 2c20 5f68 6f73 742e 6c65  data(), _host.le
-000b3c30: 6e67 7468 2829 293b 0a20 2020 2061 7574  ngth());.    aut
-000b3c40: 6f20 5b6c 6f63 6174 696f 6e2c 2066 6f75  o [location, fou
-000b3c50: 6e64 5f63 6f6c 6f6e 5d20 3d0a 2020 2020  nd_colon] =.    
-000b3c60: 2020 2020 6865 6c70 6572 733a 3a67 6574      helpers::get
-000b3c70: 5f68 6f73 745f 6465 6c69 6d69 7465 725f  _host_delimiter_
-000b3c80: 6c6f 6361 7469 6f6e 2869 735f 7370 6563  location(is_spec
-000b3c90: 6961 6c28 292c 2068 6f73 745f 7669 6577  ial(), host_view
-000b3ca0: 293b 0a0a 2020 2020 2f2f 204f 7468 6572  );..    // Other
-000b3cb0: 7769 7365 2c20 6966 2063 2069 7320 552b  wise, if c is U+
-000b3cc0: 3030 3341 2028 3a29 2061 6e64 2069 6e73  003A (:) and ins
-000b3cd0: 6964 6542 7261 636b 6574 7320 6973 2066  ideBrackets is f
-000b3ce0: 616c 7365 2c20 7468 656e 3a0a 2020 2020  alse, then:.    
-000b3cf0: 2f2f 204e 6f74 653a 2074 6865 2027 666f  // Note: the 'fo
-000b3d00: 756e 645f 636f 6c6f 6e27 2076 616c 7565  und_colon' value
-000b3d10: 2069 7320 7472 7565 2069 6620 616e 6420   is true if and 
-000b3d20: 6f6e 6c79 2069 6620 6120 636f 6c6f 6e20  only if a colon 
-000b3d30: 7761 730a 2020 2020 2f2f 2065 6e63 6f75  was.    // encou
-000b3d40: 6e74 6572 6564 2077 6869 6c65 206e 6f74  ntered while not
-000b3d50: 2069 6e73 6964 6520 6272 6163 6b65 7473   inside brackets
-000b3d60: 2e0a 2020 2020 6966 2028 666f 756e 645f  ..    if (found_
-000b3d70: 636f 6c6f 6e29 207b 0a20 2020 2020 2069  colon) {.      i
-000b3d80: 6620 286f 7665 7272 6964 655f 686f 7374  f (override_host
-000b3d90: 6e61 6d65 2920 7b0a 2020 2020 2020 2020  name) {.        
-000b3da0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
-000b3db0: 2020 2020 7d0a 2020 2020 2020 7374 643a      }.      std:
-000b3dc0: 3a73 7472 696e 675f 7669 6577 2062 7566  :string_view buf
-000b3dd0: 6665 7220 3d20 6e65 775f 686f 7374 2e73  fer = new_host.s
-000b3de0: 7562 7374 7228 6c6f 6361 7469 6f6e 202b  ubstr(location +
-000b3df0: 2031 293b 0a20 2020 2020 2069 6620 2821   1);.      if (!
-000b3e00: 6275 6666 6572 2e65 6d70 7479 2829 2920  buffer.empty()) 
-000b3e10: 7b0a 2020 2020 2020 2020 7365 745f 706f  {.        set_po
-000b3e20: 7274 2862 7566 6665 7229 3b0a 2020 2020  rt(buffer);.    
-000b3e30: 2020 7d0a 2020 2020 7d0a 2020 2020 2f2f    }.    }.    //
-000b3e40: 2049 6620 7572 6c20 6973 2073 7065 6369   If url is speci
-000b3e50: 616c 2061 6e64 2068 6f73 745f 7669 6577  al and host_view
-000b3e60: 2069 7320 7468 6520 656d 7074 7920 7374   is the empty st
-000b3e70: 7269 6e67 2c20 7661 6c69 6461 7469 6f6e  ring, validation
-000b3e80: 2065 7272 6f72 2c0a 2020 2020 2f2f 2072   error,.    // r
-000b3e90: 6574 7572 6e20 6661 696c 7572 652e 204f  eturn failure. O
-000b3ea0: 7468 6572 7769 7365 2c20 6966 2073 7461  therwise, if sta
-000b3eb0: 7465 206f 7665 7272 6964 6520 6973 2067  te override is g
-000b3ec0: 6976 656e 2c20 686f 7374 5f76 6965 7720  iven, host_view 
-000b3ed0: 6973 2074 6865 0a20 2020 202f 2f20 656d  is the.    // em
-000b3ee0: 7074 7920 7374 7269 6e67 2c20 616e 6420  pty string, and 
-000b3ef0: 6569 7468 6572 2075 726c 2069 6e63 6c75  either url inclu
-000b3f00: 6465 7320 6372 6564 656e 7469 616c 7320  des credentials 
-000b3f10: 6f72 2075 726c e280 9973 2070 6f72 7420  or url...s port 
-000b3f20: 6973 0a20 2020 202f 2f20 6e6f 6e2d 6e75  is.    // non-nu
-000b3f30: 6c6c 2c20 7265 7475 726e 2e0a 2020 2020  ll, return..    
-000b3f40: 656c 7365 2069 6620 2868 6f73 745f 7669  else if (host_vi
-000b3f50: 6577 2e65 6d70 7479 2829 2026 260a 2020  ew.empty() &&.  
-000b3f60: 2020 2020 2020 2020 2020 2028 6973 5f73             (is_s
-000b3f70: 7065 6369 616c 2829 207c 7c20 6861 735f  pecial() || has_
-000b3f80: 6372 6564 656e 7469 616c 7328 2920 7c7c  credentials() ||
-000b3f90: 2070 6f72 742e 6861 735f 7661 6c75 6528   port.has_value(
-000b3fa0: 2929 2920 7b0a 2020 2020 2020 7265 7475  ))) {.      retu
-000b3fb0: 726e 2066 616c 7365 3b0a 2020 2020 7d0a  rn false;.    }.
-000b3fc0: 0a20 2020 202f 2f20 4c65 7420 686f 7374  .    // Let host
-000b3fd0: 2062 6520 7468 6520 7265 7375 6c74 206f   be the result o
-000b3fe0: 6620 686f 7374 2070 6172 7369 6e67 2068  f host parsing h
-000b3ff0: 6f73 745f 7669 6577 2077 6974 6820 7572  ost_view with ur
-000b4000: 6c20 6973 206e 6f74 2073 7065 6369 616c  l is not special
-000b4010: 2e0a 2020 2020 6966 2028 686f 7374 5f76  ..    if (host_v
-000b4020: 6965 772e 656d 7074 7928 2929 207b 0a20  iew.empty()) {. 
-000b4030: 2020 2020 2068 6f73 7420 3d20 2222 3b0a       host = "";.
-000b4040: 2020 2020 2020 7265 7475 726e 2074 7275        return tru
-000b4050: 653b 0a20 2020 207d 0a0a 2020 2020 626f  e;.    }..    bo
-000b4060: 6f6c 2073 7563 6365 6564 6564 203d 2070  ol succeeded = p
-000b4070: 6172 7365 5f68 6f73 7428 686f 7374 5f76  arse_host(host_v
-000b4080: 6965 7729 3b0a 2020 2020 6966 2028 2173  iew);.    if (!s
-000b4090: 7563 6365 6564 6564 2920 7b0a 2020 2020  ucceeded) {.    
-000b40a0: 2020 686f 7374 203d 2070 7265 7669 6f75    host = previou
-000b40b0: 735f 686f 7374 3b0a 2020 2020 2020 7570  s_host;.      up
-000b40c0: 6461 7465 5f62 6173 655f 706f 7274 2870  date_base_port(p
-000b40d0: 7265 7669 6f75 735f 706f 7274 293b 0a20  revious_port);. 
-000b40e0: 2020 207d 0a20 2020 2072 6574 7572 6e20     }.    return 
-000b40f0: 7375 6363 6565 6465 643b 0a20 207d 0a0a  succeeded;.  }..
-000b4100: 2020 7369 7a65 5f74 206c 6f63 6174 696f    size_t locatio
-000b4110: 6e20 3d20 6e65 775f 686f 7374 2e66 696e  n = new_host.fin
-000b4120: 645f 6669 7273 745f 6f66 2822 2f5c 5c3f  d_first_of("/\\?
-000b4130: 2229 3b0a 2020 6966 2028 6c6f 6361 7469  ");.  if (locati
-000b4140: 6f6e 2021 3d20 7374 643a 3a73 7472 696e  on != std::strin
-000b4150: 675f 7669 6577 3a3a 6e70 6f73 2920 7b0a  g_view::npos) {.
-000b4160: 2020 2020 6e65 775f 686f 7374 2e72 656d      new_host.rem
-000b4170: 6f76 655f 7375 6666 6978 286e 6577 5f68  ove_suffix(new_h
-000b4180: 6f73 742e 6c65 6e67 7468 2829 202d 206c  ost.length() - l
-000b4190: 6f63 6174 696f 6e29 3b0a 2020 7d0a 0a20  ocation);.  }.. 
-000b41a0: 2069 6620 286e 6577 5f68 6f73 742e 656d   if (new_host.em
-000b41b0: 7074 7928 2929 207b 0a20 2020 202f 2f20  pty()) {.    // 
-000b41c0: 5365 7420 7572 6ce2 8099 7320 686f 7374  Set url...s host
-000b41d0: 2074 6f20 7468 6520 656d 7074 7920 7374   to the empty st
-000b41e0: 7269 6e67 2e0a 2020 2020 686f 7374 203d  ring..    host =
-000b41f0: 2022 223b 0a20 207d 2065 6c73 6520 7b0a   "";.  } else {.
-000b4200: 2020 2020 2f2f 204c 6574 2068 6f73 7420      // Let host 
-000b4210: 6265 2074 6865 2072 6573 756c 7420 6f66  be the result of
-000b4220: 2068 6f73 7420 7061 7273 696e 6720 6275   host parsing bu
-000b4230: 6666 6572 2077 6974 6820 7572 6c20 6973  ffer with url is
-000b4240: 206e 6f74 2073 7065 6369 616c 2e0a 2020   not special..  
-000b4250: 2020 6966 2028 2170 6172 7365 5f68 6f73    if (!parse_hos
-000b4260: 7428 6e65 775f 686f 7374 2929 207b 0a20  t(new_host)) {. 
-000b4270: 2020 2020 2068 6f73 7420 3d20 7072 6576       host = prev
-000b4280: 696f 7573 5f68 6f73 743b 0a20 2020 2020  ious_host;.     
-000b4290: 2075 7064 6174 655f 6261 7365 5f70 6f72   update_base_por
-000b42a0: 7428 7072 6576 696f 7573 5f70 6f72 7429  t(previous_port)
-000b42b0: 3b0a 2020 2020 2020 7265 7475 726e 2066  ;.      return f
-000b42c0: 616c 7365 3b0a 2020 2020 7d0a 0a20 2020  alse;.    }..   
-000b42d0: 202f 2f20 4966 2068 6f73 7420 6973 2022   // If host is "
-000b42e0: 6c6f 6361 6c68 6f73 7422 2c20 7468 656e  localhost", then
-000b42f0: 2073 6574 2068 6f73 7420 746f 2074 6865   set host to the
-000b4300: 2065 6d70 7479 2073 7472 696e 672e 0a20   empty string.. 
-000b4310: 2020 2069 6620 2868 6f73 742e 6861 735f     if (host.has_
-000b4320: 7661 6c75 6528 2920 2626 2068 6f73 742e  value() && host.
-000b4330: 7661 6c75 6528 2920 3d3d 2022 6c6f 6361  value() == "loca
-000b4340: 6c68 6f73 7422 2920 7b0a 2020 2020 2020  lhost") {.      
-000b4350: 686f 7374 203d 2022 223b 0a20 2020 207d  host = "";.    }
-000b4360: 0a20 207d 0a20 2072 6574 7572 6e20 7472  .  }.  return tr
-000b4370: 7565 3b0a 7d0a 0a62 6f6f 6c20 7572 6c3a  ue;.}..bool url:
-000b4380: 3a73 6574 5f68 6f73 7428 636f 6e73 7420  :set_host(const 
-000b4390: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000b43a0: 2069 6e70 7574 2920 7b0a 2020 7265 7475   input) {.  retu
-000b43b0: 726e 2073 6574 5f68 6f73 745f 6f72 5f68  rn set_host_or_h
-000b43c0: 6f73 746e 616d 653c 6661 6c73 653e 2869  ostname<false>(i
-000b43d0: 6e70 7574 293b 0a7d 0a0a 626f 6f6c 2075  nput);.}..bool u
-000b43e0: 726c 3a3a 7365 745f 686f 7374 6e61 6d65  rl::set_hostname
-000b43f0: 2863 6f6e 7374 2073 7464 3a3a 7374 7269  (const std::stri
-000b4400: 6e67 5f76 6965 7720 696e 7075 7429 207b  ng_view input) {
-000b4410: 0a20 2072 6574 7572 6e20 7365 745f 686f  .  return set_ho
-000b4420: 7374 5f6f 725f 686f 7374 6e61 6d65 3c74  st_or_hostname<t
-000b4430: 7275 653e 2869 6e70 7574 293b 0a7d 0a0a  rue>(input);.}..
-000b4440: 626f 6f6c 2075 726c 3a3a 7365 745f 7573  bool url::set_us
-000b4450: 6572 6e61 6d65 2863 6f6e 7374 2073 7464  ername(const std
-000b4460: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
-000b4470: 7075 7429 207b 0a20 2069 6620 2863 616e  put) {.  if (can
-000b4480: 6e6f 745f 6861 7665 5f63 7265 6465 6e74  not_have_credent
-000b4490: 6961 6c73 5f6f 725f 706f 7274 2829 2920  ials_or_port()) 
-000b44a0: 7b0a 2020 2020 7265 7475 726e 2066 616c  {.    return fal
-000b44b0: 7365 3b0a 2020 7d0a 2020 7573 6572 6e61  se;.  }.  userna
-000b44c0: 6d65 203d 2061 6461 3a3a 756e 6963 6f64  me = ada::unicod
-000b44d0: 653a 3a70 6572 6365 6e74 5f65 6e63 6f64  e::percent_encod
-000b44e0: 6528 0a20 2020 2020 2069 6e70 7574 2c20  e(.      input, 
-000b44f0: 6368 6172 6163 7465 725f 7365 7473 3a3a  character_sets::
-000b4500: 5553 4552 494e 464f 5f50 4552 4345 4e54  USERINFO_PERCENT
-000b4510: 5f45 4e43 4f44 4529 3b0a 2020 7265 7475  _ENCODE);.  retu
-000b4520: 726e 2074 7275 653b 0a7d 0a0a 626f 6f6c  rn true;.}..bool
-000b4530: 2075 726c 3a3a 7365 745f 7061 7373 776f   url::set_passwo
-000b4540: 7264 2863 6f6e 7374 2073 7464 3a3a 7374  rd(const std::st
-000b4550: 7269 6e67 5f76 6965 7720 696e 7075 7429  ring_view input)
-000b4560: 207b 0a20 2069 6620 2863 616e 6e6f 745f   {.  if (cannot_
-000b4570: 6861 7665 5f63 7265 6465 6e74 6961 6c73  have_credentials
-000b4580: 5f6f 725f 706f 7274 2829 2920 7b0a 2020  _or_port()) {.  
-000b4590: 2020 7265 7475 726e 2066 616c 7365 3b0a    return false;.
-000b45a0: 2020 7d0a 2020 7061 7373 776f 7264 203d    }.  password =
-000b45b0: 2061 6461 3a3a 756e 6963 6f64 653a 3a70   ada::unicode::p
-000b45c0: 6572 6365 6e74 5f65 6e63 6f64 6528 0a20  ercent_encode(. 
-000b45d0: 2020 2020 2069 6e70 7574 2c20 6368 6172       input, char
-000b45e0: 6163 7465 725f 7365 7473 3a3a 5553 4552  acter_sets::USER
-000b45f0: 494e 464f 5f50 4552 4345 4e54 5f45 4e43  INFO_PERCENT_ENC
-000b4600: 4f44 4529 3b0a 2020 7265 7475 726e 2074  ODE);.  return t
-000b4610: 7275 653b 0a7d 0a0a 626f 6f6c 2075 726c  rue;.}..bool url
-000b4620: 3a3a 7365 745f 706f 7274 2863 6f6e 7374  ::set_port(const
-000b4630: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000b4640: 7720 696e 7075 7429 207b 0a20 2069 6620  w input) {.  if 
-000b4650: 2863 616e 6e6f 745f 6861 7665 5f63 7265  (cannot_have_cre
-000b4660: 6465 6e74 6961 6c73 5f6f 725f 706f 7274  dentials_or_port
-000b4670: 2829 2920 7b0a 2020 2020 7265 7475 726e  ()) {.    return
-000b4680: 2066 616c 7365 3b0a 2020 7d0a 2020 7374   false;.  }.  st
-000b4690: 643a 3a73 7472 696e 6720 7472 696d 6d65  d::string trimme
-000b46a0: 6428 696e 7075 7429 3b0a 2020 6865 6c70  d(input);.  help
-000b46b0: 6572 733a 3a72 656d 6f76 655f 6173 6369  ers::remove_asci
-000b46c0: 695f 7461 625f 6f72 5f6e 6577 6c69 6e65  i_tab_or_newline
-000b46d0: 2874 7269 6d6d 6564 293b 0a20 2069 6620  (trimmed);.  if 
-000b46e0: 2874 7269 6d6d 6564 2e65 6d70 7479 2829  (trimmed.empty()
-000b46f0: 2920 7b0a 2020 2020 706f 7274 203d 2073  ) {.    port = s
-000b4700: 7464 3a3a 6e75 6c6c 6f70 743b 0a20 2020  td::nullopt;.   
-000b4710: 2072 6574 7572 6e20 7472 7565 3b0a 2020   return true;.  
-000b4720: 7d0a 2020 2f2f 2049 6e70 7574 2073 686f  }.  // Input sho
-000b4730: 756c 6420 6e6f 7420 7374 6172 7420 7769  uld not start wi
-000b4740: 7468 2063 6f6e 7472 6f6c 2063 6861 7261  th control chara
-000b4750: 6374 6572 732e 0a20 2069 6620 2861 6461  cters..  if (ada
-000b4760: 3a3a 756e 6963 6f64 653a 3a69 735f 6330  ::unicode::is_c0
-000b4770: 5f63 6f6e 7472 6f6c 5f6f 725f 7370 6163  _control_or_spac
-000b4780: 6528 7472 696d 6d65 642e 6672 6f6e 7428  e(trimmed.front(
-000b4790: 2929 2920 7b0a 2020 2020 7265 7475 726e  ))) {.    return
-000b47a0: 2066 616c 7365 3b0a 2020 7d0a 2020 2f2f   false;.  }.  //
-000b47b0: 2049 6e70 7574 2073 686f 756c 6420 636f   Input should co
-000b47c0: 6e74 6169 6e20 6174 206c 6561 7374 206f  ntain at least o
-000b47d0: 6e65 2061 7363 6969 2064 6967 6974 2e0a  ne ascii digit..
-000b47e0: 2020 6966 2028 696e 7075 742e 6669 6e64    if (input.find
-000b47f0: 5f66 6972 7374 5f6f 6628 2230 3132 3334  _first_of("01234
-000b4800: 3536 3738 3922 2920 3d3d 2073 7464 3a3a  56789") == std::
-000b4810: 7374 7269 6e67 5f76 6965 773a 3a6e 706f  string_view::npo
-000b4820: 7329 207b 0a20 2020 2072 6574 7572 6e20  s) {.    return 
-000b4830: 6661 6c73 653b 0a20 207d 0a0a 2020 2f2f  false;.  }..  //
-000b4840: 2052 6576 6572 7420 6368 616e 6765 7320   Revert changes 
-000b4850: 6966 2070 6172 7365 5f70 6f72 7420 6661  if parse_port fa
-000b4860: 696c 732e 0a20 2073 7464 3a3a 6f70 7469  ils..  std::opti
-000b4870: 6f6e 616c 3c75 696e 7431 365f 743e 2070  onal<uint16_t> p
-000b4880: 7265 7669 6f75 735f 706f 7274 203d 2070  revious_port = p
-000b4890: 6f72 743b 0a20 2070 6172 7365 5f70 6f72  ort;.  parse_por
-000b48a0: 7428 7472 696d 6d65 6429 3b0a 2020 6966  t(trimmed);.  if
-000b48b0: 2028 6973 5f76 616c 6964 2920 7b0a 2020   (is_valid) {.  
-000b48c0: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
-000b48d0: 207d 0a20 2070 6f72 7420 3d20 7072 6576   }.  port = prev
-000b48e0: 696f 7573 5f70 6f72 743b 0a20 2069 735f  ious_port;.  is_
-000b48f0: 7661 6c69 6420 3d20 7472 7565 3b0a 2020  valid = true;.  
-000b4900: 7265 7475 726e 2066 616c 7365 3b0a 7d0a  return false;.}.
-000b4910: 0a76 6f69 6420 7572 6c3a 3a73 6574 5f68  .void url::set_h
-000b4920: 6173 6828 636f 6e73 7420 7374 643a 3a73  ash(const std::s
-000b4930: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
-000b4940: 2920 7b0a 2020 6966 2028 696e 7075 742e  ) {.  if (input.
-000b4950: 656d 7074 7928 2929 207b 0a20 2020 2068  empty()) {.    h
-000b4960: 6173 6820 3d20 7374 643a 3a6e 756c 6c6f  ash = std::nullo
-000b4970: 7074 3b0a 2020 2020 6865 6c70 6572 733a  pt;.    helpers:
-000b4980: 3a73 7472 6970 5f74 7261 696c 696e 675f  :strip_trailing_
-000b4990: 7370 6163 6573 5f66 726f 6d5f 6f70 6171  spaces_from_opaq
-000b49a0: 7565 5f70 6174 6828 2a74 6869 7329 3b0a  ue_path(*this);.
-000b49b0: 2020 2020 7265 7475 726e 3b0a 2020 7d0a      return;.  }.
-000b49c0: 0a20 2073 7464 3a3a 7374 7269 6e67 206e  .  std::string n
-000b49d0: 6577 5f76 616c 7565 3b0a 2020 6e65 775f  ew_value;.  new_
-000b49e0: 7661 6c75 6520 3d20 696e 7075 745b 305d  value = input[0]
-000b49f0: 203d 3d20 2723 2720 3f20 696e 7075 742e   == '#' ? input.
-000b4a00: 7375 6273 7472 2831 2920 3a20 696e 7075  substr(1) : inpu
-000b4a10: 743b 0a20 2068 656c 7065 7273 3a3a 7265  t;.  helpers::re
-000b4a20: 6d6f 7665 5f61 7363 6969 5f74 6162 5f6f  move_ascii_tab_o
-000b4a30: 725f 6e65 776c 696e 6528 6e65 775f 7661  r_newline(new_va
-000b4a40: 6c75 6529 3b0a 2020 6861 7368 203d 2075  lue);.  hash = u
-000b4a50: 6e69 636f 6465 3a3a 7065 7263 656e 745f  nicode::percent_
-000b4a60: 656e 636f 6465 286e 6577 5f76 616c 7565  encode(new_value
-000b4a70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000b4a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b4a90: 2020 2061 6461 3a3a 6368 6172 6163 7465     ada::characte
-000b4aa0: 725f 7365 7473 3a3a 4652 4147 4d45 4e54  r_sets::FRAGMENT
-000b4ab0: 5f50 4552 4345 4e54 5f45 4e43 4f44 4529  _PERCENT_ENCODE)
-000b4ac0: 3b0a 2020 7265 7475 726e 3b0a 7d0a 0a76  ;.  return;.}..v
-000b4ad0: 6f69 6420 7572 6c3a 3a73 6574 5f73 6561  oid url::set_sea
-000b4ae0: 7263 6828 636f 6e73 7420 7374 643a 3a73  rch(const std::s
-000b4af0: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
-000b4b00: 2920 7b0a 2020 6966 2028 696e 7075 742e  ) {.  if (input.
-000b4b10: 656d 7074 7928 2929 207b 0a20 2020 2071  empty()) {.    q
-000b4b20: 7565 7279 203d 2073 7464 3a3a 6e75 6c6c  uery = std::null
-000b4b30: 6f70 743b 0a20 2020 2068 656c 7065 7273  opt;.    helpers
-000b4b40: 3a3a 7374 7269 705f 7472 6169 6c69 6e67  ::strip_trailing
-000b4b50: 5f73 7061 6365 735f 6672 6f6d 5f6f 7061  _spaces_from_opa
-000b4b60: 7175 655f 7061 7468 282a 7468 6973 293b  que_path(*this);
-000b4b70: 0a20 2020 2072 6574 7572 6e3b 0a20 207d  .    return;.  }
-000b4b80: 0a0a 2020 7374 643a 3a73 7472 696e 6720  ..  std::string 
-000b4b90: 6e65 775f 7661 6c75 653b 0a20 206e 6577  new_value;.  new
-000b4ba0: 5f76 616c 7565 203d 2069 6e70 7574 5b30  _value = input[0
-000b4bb0: 5d20 3d3d 2027 3f27 203f 2069 6e70 7574  ] == '?' ? input
-000b4bc0: 2e73 7562 7374 7228 3129 203a 2069 6e70  .substr(1) : inp
-000b4bd0: 7574 3b0a 2020 6865 6c70 6572 733a 3a72  ut;.  helpers::r
-000b4be0: 656d 6f76 655f 6173 6369 695f 7461 625f  emove_ascii_tab_
-000b4bf0: 6f72 5f6e 6577 6c69 6e65 286e 6577 5f76  or_newline(new_v
-000b4c00: 616c 7565 293b 0a0a 2020 6175 746f 2071  alue);..  auto q
-000b4c10: 7565 7279 5f70 6572 6365 6e74 5f65 6e63  uery_percent_enc
-000b4c20: 6f64 655f 7365 7420 3d0a 2020 2020 2020  ode_set =.      
-000b4c30: 6973 5f73 7065 6369 616c 2829 203f 2061  is_special() ? a
-000b4c40: 6461 3a3a 6368 6172 6163 7465 725f 7365  da::character_se
-000b4c50: 7473 3a3a 5350 4543 4941 4c5f 5155 4552  ts::SPECIAL_QUER
-000b4c60: 595f 5045 5243 454e 545f 454e 434f 4445  Y_PERCENT_ENCODE
-000b4c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b4c80: 2020 2020 3a20 6164 613a 3a63 6861 7261      : ada::chara
-000b4c90: 6374 6572 5f73 6574 733a 3a51 5545 5259  cter_sets::QUERY
-000b4ca0: 5f50 4552 4345 4e54 5f45 4e43 4f44 453b  _PERCENT_ENCODE;
-000b4cb0: 0a0a 2020 7175 6572 7920 3d20 6164 613a  ..  query = ada:
-000b4cc0: 3a75 6e69 636f 6465 3a3a 7065 7263 656e  :unicode::percen
-000b4cd0: 745f 656e 636f 6465 2873 7464 3a3a 7374  t_encode(std::st
-000b4ce0: 7269 6e67 5f76 6965 7728 6e65 775f 7661  ring_view(new_va
-000b4cf0: 6c75 6529 2c0a 2020 2020 2020 2020 2020  lue),.          
-000b4d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b4d10: 2020 2020 2020 2020 2020 2020 2071 7565               que
-000b4d20: 7279 5f70 6572 6365 6e74 5f65 6e63 6f64  ry_percent_encod
-000b4d30: 655f 7365 7429 3b0a 7d0a 0a62 6f6f 6c20  e_set);.}..bool 
-000b4d40: 7572 6c3a 3a73 6574 5f70 6174 686e 616d  url::set_pathnam
-000b4d50: 6528 636f 6e73 7420 7374 643a 3a73 7472  e(const std::str
-000b4d60: 696e 675f 7669 6577 2069 6e70 7574 2920  ing_view input) 
-000b4d70: 7b0a 2020 6966 2028 6861 735f 6f70 6171  {.  if (has_opaq
-000b4d80: 7565 5f70 6174 6829 207b 0a20 2020 2072  ue_path) {.    r
-000b4d90: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
-000b4da0: 0a20 2070 6174 6820 3d20 2222 3b0a 2020  .  path = "";.  
-000b4db0: 7061 7273 655f 7061 7468 2869 6e70 7574  parse_path(input
-000b4dc0: 293b 0a20 2072 6574 7572 6e20 7472 7565  );.  return true
-000b4dd0: 3b0a 7d0a 0a62 6f6f 6c20 7572 6c3a 3a73  ;.}..bool url::s
-000b4de0: 6574 5f70 726f 746f 636f 6c28 636f 6e73  et_protocol(cons
-000b4df0: 7420 7374 643a 3a73 7472 696e 675f 7669  t std::string_vi
-000b4e00: 6577 2069 6e70 7574 2920 7b0a 2020 7374  ew input) {.  st
-000b4e10: 643a 3a73 7472 696e 6720 7669 6577 2869  d::string view(i
-000b4e20: 6e70 7574 293b 0a20 2068 656c 7065 7273  nput);.  helpers
-000b4e30: 3a3a 7265 6d6f 7665 5f61 7363 6969 5f74  ::remove_ascii_t
-000b4e40: 6162 5f6f 725f 6e65 776c 696e 6528 7669  ab_or_newline(vi
-000b4e50: 6577 293b 0a20 2069 6620 2876 6965 772e  ew);.  if (view.
-000b4e60: 656d 7074 7928 2929 207b 0a20 2020 2072  empty()) {.    r
-000b4e70: 6574 7572 6e20 7472 7565 3b0a 2020 7d0a  eturn true;.  }.
-000b4e80: 0a20 202f 2f20 5363 6865 6d65 7320 7368  .  // Schemes sh
-000b4e90: 6f75 6c64 2073 7461 7274 2077 6974 6820  ould start with 
-000b4ea0: 616c 7068 6120 7661 6c75 6573 2e0a 2020  alpha values..  
-000b4eb0: 6966 2028 2163 6865 636b 6572 733a 3a69  if (!checkers::i
-000b4ec0: 735f 616c 7068 6128 7669 6577 5b30 5d29  s_alpha(view[0])
-000b4ed0: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
-000b4ee0: 616c 7365 3b0a 2020 7d0a 0a20 2076 6965  alse;.  }..  vie
-000b4ef0: 772e 6170 7065 6e64 2822 3a22 293b 0a0a  w.append(":");..
-000b4f00: 2020 7374 643a 3a73 7472 696e 673a 3a69    std::string::i
-000b4f10: 7465 7261 746f 7220 706f 696e 7465 7220  terator pointer 
-000b4f20: 3d0a 2020 2020 2020 7374 643a 3a66 696e  =.      std::fin
-000b4f30: 645f 6966 5f6e 6f74 2876 6965 772e 6265  d_if_not(view.be
-000b4f40: 6769 6e28 292c 2076 6965 772e 656e 6428  gin(), view.end(
-000b4f50: 292c 2075 6e69 636f 6465 3a3a 6973 5f61  ), unicode::is_a
-000b4f60: 6c6e 756d 5f70 6c75 7329 3b0a 0a20 2069  lnum_plus);..  i
-000b4f70: 6620 2870 6f69 6e74 6572 2021 3d20 7669  f (pointer != vi
-000b4f80: 6577 2e65 6e64 2829 2026 2620 2a70 6f69  ew.end() && *poi
-000b4f90: 6e74 6572 203d 3d20 273a 2729 207b 0a20  nter == ':') {. 
-000b4fa0: 2020 2072 6574 7572 6e20 7061 7273 655f     return parse_
-000b4fb0: 7363 6865 6d65 3c74 7275 653e 280a 2020  scheme<true>(.  
-000b4fc0: 2020 2020 2020 7374 643a 3a73 7472 696e        std::strin
-000b4fd0: 675f 7669 6577 2876 6965 772e 6461 7461  g_view(view.data
-000b4fe0: 2829 2c20 706f 696e 7465 7220 2d20 7669  (), pointer - vi
-000b4ff0: 6577 2e62 6567 696e 2829 2929 3b0a 2020  ew.begin()));.  
-000b5000: 7d0a 2020 7265 7475 726e 2066 616c 7365  }.  return false
-000b5010: 3b0a 7d0a 0a62 6f6f 6c20 7572 6c3a 3a73  ;.}..bool url::s
-000b5020: 6574 5f68 7265 6628 636f 6e73 7420 7374  et_href(const st
-000b5030: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
-000b5040: 6e70 7574 2920 7b0a 2020 6164 613a 3a72  nput) {.  ada::r
-000b5050: 6573 756c 743c 6164 613a 3a75 726c 3e20  esult<ada::url> 
-000b5060: 6f75 7420 3d20 6164 613a 3a70 6172 7365  out = ada::parse
-000b5070: 3c61 6461 3a3a 7572 6c3e 2869 6e70 7574  <ada::url>(input
-000b5080: 293b 0a0a 2020 6966 2028 6f75 7429 207b  );..  if (out) {
-000b5090: 0a20 2020 2075 7365 726e 616d 6520 3d20  .    username = 
-000b50a0: 6f75 742d 3e75 7365 726e 616d 653b 0a20  out->username;. 
-000b50b0: 2020 2070 6173 7377 6f72 6420 3d20 6f75     password = ou
-000b50c0: 742d 3e70 6173 7377 6f72 643b 0a20 2020  t->password;.   
-000b50d0: 2068 6f73 7420 3d20 6f75 742d 3e68 6f73   host = out->hos
-000b50e0: 743b 0a20 2020 2070 6f72 7420 3d20 6f75  t;.    port = ou
-000b50f0: 742d 3e70 6f72 743b 0a20 2020 2070 6174  t->port;.    pat
-000b5100: 6820 3d20 6f75 742d 3e70 6174 683b 0a20  h = out->path;. 
-000b5110: 2020 2071 7565 7279 203d 206f 7574 2d3e     query = out->
-000b5120: 7175 6572 793b 0a20 2020 2068 6173 6820  query;.    hash 
-000b5130: 3d20 6f75 742d 3e68 6173 683b 0a20 2020  = out->hash;.   
-000b5140: 2074 7970 6520 3d20 6f75 742d 3e74 7970   type = out->typ
-000b5150: 653b 0a20 2020 206e 6f6e 5f73 7065 6369  e;.    non_speci
-000b5160: 616c 5f73 6368 656d 6520 3d20 6f75 742d  al_scheme = out-
-000b5170: 3e6e 6f6e 5f73 7065 6369 616c 5f73 6368  >non_special_sch
-000b5180: 656d 653b 0a20 2020 2068 6173 5f6f 7061  eme;.    has_opa
-000b5190: 7175 655f 7061 7468 203d 206f 7574 2d3e  que_path = out->
-000b51a0: 6861 735f 6f70 6171 7565 5f70 6174 683b  has_opaque_path;
-000b51b0: 0a20 207d 0a0a 2020 7265 7475 726e 206f  .  }..  return o
-000b51c0: 7574 2e68 6173 5f76 616c 7565 2829 3b0a  ut.has_value();.
-000b51d0: 7d0a 0a7d 2020 2f2f 206e 616d 6573 7061  }..}  // namespa
-000b51e0: 6365 2061 6461 0a2f 2a20 656e 6420 6669  ce ada./* end fi
-000b51f0: 6c65 2073 7263 2f75 726c 2d73 6574 7465  le src/url-sette
-000b5200: 7273 2e63 7070 202a 2f0a 2f2a 2062 6567  rs.cpp */./* beg
-000b5210: 696e 2066 696c 6520 7372 632f 7061 7273  in file src/pars
-000b5220: 6572 2e63 7070 202a 2f0a 0a23 696e 636c  er.cpp */..#incl
-000b5230: 7564 6520 3c6e 756d 6572 6963 3e0a 2369  ude <numeric>.#i
-000b5240: 6e63 6c75 6465 203c 6c69 6d69 7473 3e0a  nclude <limits>.
-000b5250: 0a6e 616d 6573 7061 6365 2061 6461 3a3a  .namespace ada::
-000b5260: 7061 7273 6572 207b 0a0a 7465 6d70 6c61  parser {..templa
-000b5270: 7465 203c 636c 6173 7320 7265 7375 6c74  te <class result
-000b5280: 5f74 7970 653e 0a72 6573 756c 745f 7479  _type>.result_ty
-000b5290: 7065 2070 6172 7365 5f75 726c 2873 7464  pe parse_url(std
-000b52a0: 3a3a 7374 7269 6e67 5f76 6965 7720 7573  ::string_view us
-000b52b0: 6572 5f69 6e70 7574 2c0a 2020 2020 2020  er_input,.      
-000b52c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b52d0: 636f 6e73 7420 7265 7375 6c74 5f74 7970  const result_typ
-000b52e0: 652a 2062 6173 655f 7572 6c29 207b 0a20  e* base_url) {. 
-000b52f0: 202f 2f20 5765 2063 616e 2073 7065 6369   // We can speci
-000b5300: 616c 697a 6520 7468 6520 696d 706c 656d  alize the implem
-000b5310: 656e 7461 7469 6f6e 2070 6572 2074 7970  entation per typ
-000b5320: 652e 0a20 202f 2f20 496d 706f 7274 616e  e..  // Importan
-000b5330: 743a 2072 6573 756c 745f 7479 7065 5f69  t: result_type_i
-000b5340: 735f 6164 615f 7572 6c20 6973 2065 7661  s_ada_url is eva
-000b5350: 6c75 6174 6564 2061 7420 2a63 6f6d 7069  luated at *compi
-000b5360: 6c65 2074 696d 652a 2e20 5468 6973 0a20  le time*. This. 
-000b5370: 202f 2f20 6d65 616e 7320 7468 6174 2064   // means that d
-000b5380: 6f69 6e67 2069 6620 636f 6e73 7465 7870  oing if constexp
-000b5390: 7228 7265 7375 6c74 5f74 7970 655f 6973  r(result_type_is
-000b53a0: 5f61 6461 5f75 726c 2920 7b20 736f 6d65  _ada_url) { some
-000b53b0: 7468 696e 6720 7d20 656c 7365 207b 0a20  thing } else {. 
-000b53c0: 202f 2f20 736f 6d65 7468 696e 6720 656c   // something el
-000b53d0: 7365 207d 2069 7320 6672 6565 2028 6174  se } is free (at
-000b53e0: 2072 756e 7469 6d65 292e 2054 6869 7320   runtime). This 
-000b53f0: 6d65 616e 7320 7468 6174 2061 6461 3a3a  means that ada::
-000b5400: 7572 6c5f 6167 6772 6567 6174 6f72 0a20  url_aggregator. 
-000b5410: 202f 2f20 616e 6420 6164 613a 3a75 726c   // and ada::url
-000b5420: 202a 2a64 6f20 6e6f 7420 6861 7665 2074   **do not have t
-000b5430: 6f20 7375 7070 6f72 7420 7468 6520 6578  o support the ex
-000b5440: 6163 7420 7361 6d65 2041 5049 2a2a 2e0a  act same API**..
-000b5450: 2020 636f 6e73 7465 7870 7220 626f 6f6c    constexpr bool
-000b5460: 2072 6573 756c 745f 7479 7065 5f69 735f   result_type_is_
-000b5470: 6164 615f 7572 6c20 3d0a 2020 2020 2020  ada_url =.      
-000b5480: 7374 643a 3a69 735f 7361 6d65 3c61 6461  std::is_same<ada
-000b5490: 3a3a 7572 6c2c 2072 6573 756c 745f 7479  ::url, result_ty
-000b54a0: 7065 3e3a 3a76 616c 7565 3b0a 2020 636f  pe>::value;.  co
-000b54b0: 6e73 7465 7870 7220 626f 6f6c 2072 6573  nstexpr bool res
-000b54c0: 756c 745f 7479 7065 5f69 735f 6164 615f  ult_type_is_ada_
-000b54d0: 7572 6c5f 6167 6772 6567 6174 6f72 203d  url_aggregator =
-000b54e0: 0a20 2020 2020 2073 7464 3a3a 6973 5f73  .      std::is_s
-000b54f0: 616d 653c 6164 613a 3a75 726c 5f61 6767  ame<ada::url_agg
-000b5500: 7265 6761 746f 722c 2072 6573 756c 745f  regator, result_
-000b5510: 7479 7065 3e3a 3a76 616c 7565 3b0a 2020  type>::value;.  
-000b5520: 7374 6174 6963 5f61 7373 6572 7428 7265  static_assert(re
-000b5530: 7375 6c74 5f74 7970 655f 6973 5f61 6461  sult_type_is_ada
-000b5540: 5f75 726c 207c 7c0a 2020 2020 2020 2020  _url ||.        
-000b5550: 2020 2020 2020 2020 7265 7375 6c74 5f74          result_t
-000b5560: 7970 655f 6973 5f61 6461 5f75 726c 5f61  ype_is_ada_url_a
-000b5570: 6767 7265 6761 746f 7229 3b20 202f 2f20  ggregator);  // 
-000b5580: 5765 2064 6f6e 2774 2073 7570 706f 7274  We don't support
-000b5590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b55a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b55b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b55c0: 2020 2020 2020 2f2f 2061 6e79 7468 696e        // anythin
-000b55d0: 6720 656c 7365 2066 6f72 206e 6f77 2e0a  g else for now..
-000b55e0: 0a20 2061 6461 5f6c 6f67 2822 6164 613a  .  ada_log("ada:
-000b55f0: 3a70 6172 7365 723a 3a70 6172 7365 5f75  :parser::parse_u
-000b5600: 726c 2827 222c 2075 7365 725f 696e 7075  rl('", user_inpu
-000b5610: 742c 2022 2720 5b22 2c20 7573 6572 5f69  t, "' [", user_i
-000b5620: 6e70 7574 2e73 697a 6528 292c 0a20 2020  nput.size(),.   
-000b5630: 2020 2020 2020 2022 2062 7974 6573 5d2c         " bytes],
-000b5640: 222c 2028 6261 7365 5f75 726c 2021 3d20  ", (base_url != 
-000b5650: 6e75 6c6c 7074 7220 3f20 6261 7365 5f75  nullptr ? base_u
-000b5660: 726c 2d3e 746f 5f73 7472 696e 6728 2920  rl->to_string() 
-000b5670: 3a20 226e 756c 6c22 292c 0a20 2020 2020  : "null"),.     
-000b5680: 2020 2020 2022 2922 293b 0a0a 2020 6164       ")");..  ad
-000b5690: 613a 3a73 7461 7465 2073 7461 7465 203d  a::state state =
-000b56a0: 2061 6461 3a3a 7374 6174 653a 3a53 4348   ada::state::SCH
-000b56b0: 454d 455f 5354 4152 543b 0a20 2072 6573  EME_START;.  res
-000b56c0: 756c 745f 7479 7065 2075 726c 7b7d 3b0a  ult_type url{};.
-000b56d0: 0a20 202f 2f20 5765 2072 6566 7573 6520  .  // We refuse 
-000b56e0: 746f 2070 6172 7365 2055 524c 2073 7472  to parse URL str
-000b56f0: 696e 6773 2074 6861 7420 6578 6365 6564  ings that exceed
-000b5700: 2034 4742 2e20 5375 6368 2073 7472 696e   4GB. Such strin
-000b5710: 6773 2061 7265 2061 6c6d 6f73 740a 2020  gs are almost.  
-000b5720: 2f2f 2073 7572 656c 7920 7468 6520 7265  // surely the re
-000b5730: 7375 6c74 206f 6620 6120 6275 6720 6f72  sult of a bug or
-000b5740: 2061 7265 206f 7468 6572 7769 7365 2061   are otherwise a
-000b5750: 2073 6563 7572 6974 7920 636f 6e63 6572   security concer
-000b5760: 6e2e 0a20 2069 6620 2875 7365 725f 696e  n..  if (user_in
-000b5770: 7075 742e 7369 7a65 2829 203e 2073 7464  put.size() > std
-000b5780: 3a3a 6e75 6d65 7269 635f 6c69 6d69 7473  ::numeric_limits
-000b5790: 3c75 696e 7433 325f 743e 3a3a 6d61 7828  <uint32_t>::max(
-000b57a0: 2929 207b 0a20 2020 2075 726c 2e69 735f  )) {.    url.is_
-000b57b0: 7661 6c69 6420 3d20 6661 6c73 653b 0a20  valid = false;. 
-000b57c0: 207d 0a20 202f 2f20 476f 696e 6720 666f   }.  // Going fo
-000b57d0: 7277 6172 642c 2075 7365 725f 696e 7075  rward, user_inpu
-000b57e0: 742e 7369 7a65 2829 2069 7320 696e 205b  t.size() is in [
-000b57f0: 302c 0a20 202f 2f20 7374 643a 3a6e 756d  0,.  // std::num
-000b5800: 6572 6963 5f6c 696d 6974 733c 7569 6e74  eric_limits<uint
-000b5810: 3332 5f74 3e3a 3a6d 6178 292e 2049 6620  32_t>::max). If 
-000b5820: 7765 2061 7265 2070 726f 7669 6465 6420  we are provided 
-000b5830: 7769 7468 2061 6e20 696e 7661 6c69 640a  with an invalid.
-000b5840: 2020 2f2f 2062 6173 652c 206f 7220 7468    // base, or th
-000b5850: 6520 6f70 7469 6f6e 616c 5f75 726c 2077  e optional_url w
-000b5860: 6173 2069 6e76 616c 6964 2c20 7765 206d  as invalid, we m
-000b5870: 7573 7420 7265 7475 726e 2e0a 2020 6966  ust return..  if
-000b5880: 2028 6261 7365 5f75 726c 2021 3d20 6e75   (base_url != nu
-000b5890: 6c6c 7074 7229 207b 0a20 2020 2075 726c  llptr) {.    url
-000b58a0: 2e69 735f 7661 6c69 6420 263d 2062 6173  .is_valid &= bas
-000b58b0: 655f 7572 6c2d 3e69 735f 7661 6c69 643b  e_url->is_valid;
-000b58c0: 0a20 207d 0a20 2069 6620 2821 7572 6c2e  .  }.  if (!url.
-000b58d0: 6973 5f76 616c 6964 2920 7b0a 2020 2020  is_valid) {.    
-000b58e0: 7265 7475 726e 2075 726c 3b0a 2020 7d0a  return url;.  }.
-000b58f0: 2020 6966 2063 6f6e 7374 6578 7072 2028    if constexpr (
-000b5900: 7265 7375 6c74 5f74 7970 655f 6973 5f61  result_type_is_a
-000b5910: 6461 5f75 726c 5f61 6767 7265 6761 746f  da_url_aggregato
-000b5920: 7229 207b 0a20 2020 202f 2f20 4d6f 7374  r) {.    // Most
-000b5930: 206f 6620 7468 6520 7469 6d65 2c20 7765   of the time, we
-000b5940: 206a 7573 7420 6e65 6564 2075 7365 725f   just need user_
-000b5950: 696e 7075 742e 7369 7a65 2829 2e0a 2020  input.size()..  
-000b5960: 2020 2f2f 2049 6e20 736f 6d65 2069 6e73    // In some ins
-000b5970: 7461 6e63 6573 2c20 7765 206d 6179 206e  tances, we may n
-000b5980: 6565 6420 6120 6269 7420 6d6f 7265 2e0a  eed a bit more..
-000b5990: 2020 2020 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f      ////////////
-000b59a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
-000b59b0: 2020 2020 2f2f 2054 6869 7320 6973 202a      // This is *
-000b59c0: 7665 7279 2a20 696d 706f 7274 616e 742e  very* important.
-000b59d0: 2054 6869 7320 6c69 6e65 2073 686f 756c   This line shoul
-000b59e0: 6420 6265 2072 656d 6f76 6564 0a20 2020  d be removed.   
-000b59f0: 202f 2f20 6861 7374 696c 792e 2054 6865   // hastily. The
-000b5a00: 7265 2061 7265 2070 7269 6e63 6970 6c65  re are principle
-000b5a10: 6420 7265 6173 6f6e 7320 7768 7920 7265  d reasons why re
-000b5a20: 7365 7276 6520 6973 2069 6d70 6f72 7461  serve is importa
-000b5a30: 6e74 0a20 2020 202f 2f20 666f 7220 7065  nt.    // for pe
-000b5a40: 7266 6f72 6d61 6e63 652e 2049 6620 796f  rformance. If yo
-000b5a50: 7520 6861 7665 2061 2062 656e 6368 6d61  u have a benchma
-000b5a60: 726b 2077 6974 6820 736d 616c 6c20 696e  rk with small in
-000b5a70: 7075 7473 2c0a 2020 2020 2f2f 2069 7420  puts,.    // it 
-000b5a80: 6d61 7920 6e6f 7420 6d61 7474 6572 2c20  may not matter, 
-000b5a90: 6275 7420 696e 206f 7468 6572 2069 6e73  but in other ins
-000b5aa0: 7461 6e63 6573 2c20 6974 2063 6f75 6c64  tances, it could
-000b5ab0: 2e0a 2020 2020 2f2f 2f2f 0a20 2020 202f  ..    ////.    /
-000b5ac0: 2f20 5468 6973 2072 6f75 6e64 7320 7570  / This rounds up
-000b5ad0: 2074 6f20 7468 6520 6e65 7874 2070 6f77   to the next pow
-000b5ae0: 6572 206f 6620 7477 6f2e 0a20 2020 202f  er of two..    /
-000b5af0: 2f20 5765 206b 6e6f 7720 7468 6174 2075  / We know that u
-000b5b00: 7365 725f 696e 7075 742e 7369 7a65 2829  ser_input.size()
-000b5b10: 2069 7320 696e 205b 302c 0a20 2020 202f   is in [0,.    /
-000b5b20: 2f20 7374 643a 3a6e 756d 6572 6963 5f6c  / std::numeric_l
-000b5b30: 696d 6974 733c 7569 6e74 3332 5f74 3e3a  imits<uint32_t>:
-000b5b40: 3a6d 6178 292e 0a20 2020 2075 696e 7433  :max)..    uint3
-000b5b50: 325f 7420 7265 7365 7276 655f 6361 7061  2_t reserve_capa
-000b5b60: 6369 7479 203d 0a20 2020 2020 2020 2028  city =.        (
-000b5b70: 3078 4646 4646 4646 4646 203e 3e0a 2020  0xFFFFFFFF >>.  
-000b5b80: 2020 2020 2020 2068 656c 7065 7273 3a3a         helpers::
-000b5b90: 6c65 6164 696e 675f 7a65 726f 6573 2875  leading_zeroes(u
-000b5ba0: 696e 7433 325f 7428 3120 7c20 7573 6572  int32_t(1 | user
-000b5bb0: 5f69 6e70 7574 2e73 697a 6528 2929 2929  _input.size())))
-000b5bc0: 202b 0a20 2020 2020 2020 2031 3b0a 2020   +.        1;.  
-000b5bd0: 2020 7572 6c2e 7265 7365 7276 6528 7265    url.reserve(re
-000b5be0: 7365 7276 655f 6361 7061 6369 7479 293b  serve_capacity);
-000b5bf0: 0a20 2020 202f 2f0a 2020 2020 2f2f 0a20  .    //.    //. 
-000b5c00: 2020 202f 2f0a 2020 7d0a 2020 7374 643a     //.  }.  std:
-000b5c10: 3a73 7472 696e 6720 746d 705f 6275 6666  :string tmp_buff
-000b5c20: 6572 3b0a 2020 7374 643a 3a73 7472 696e  er;.  std::strin
-000b5c30: 675f 7669 6577 2069 6e74 6572 6e61 6c5f  g_view internal_
-000b5c40: 696e 7075 743b 0a20 2069 6620 2875 6e69  input;.  if (uni
-000b5c50: 636f 6465 3a3a 6861 735f 7461 6273 5f6f  code::has_tabs_o
-000b5c60: 725f 6e65 776c 696e 6528 7573 6572 5f69  r_newline(user_i
-000b5c70: 6e70 7574 2929 207b 0a20 2020 2074 6d70  nput)) {.    tmp
-000b5c80: 5f62 7566 6665 7220 3d20 7573 6572 5f69  _buffer = user_i
-000b5c90: 6e70 7574 3b0a 2020 2020 2f2f 204f 7074  nput;.    // Opt
-000b5ca0: 696d 697a 6174 696f 6e20 6f70 706f 7274  imization opport
-000b5cb0: 756e 6974 793a 2049 6e73 7465 6164 206f  unity: Instead o
-000b5cc0: 6620 636f 7079 696e 6720 616e 6420 7468  f copying and th
-000b5cd0: 656e 2070 7275 6e69 6e67 2c20 7765 2063  en pruning, we c
-000b5ce0: 6f75 6c64 0a20 2020 202f 2f20 6a75 7374  ould.    // just
-000b5cf0: 2064 6972 6563 746c 7920 6275 696c 6420   directly build 
-000b5d00: 7468 6520 7374 7269 6e67 2066 726f 6d20  the string from 
-000b5d10: 7573 6572 5f69 6e70 7574 2e0a 2020 2020  user_input..    
-000b5d20: 6865 6c70 6572 733a 3a72 656d 6f76 655f  helpers::remove_
-000b5d30: 6173 6369 695f 7461 625f 6f72 5f6e 6577  ascii_tab_or_new
-000b5d40: 6c69 6e65 2874 6d70 5f62 7566 6665 7229  line(tmp_buffer)
-000b5d50: 3b0a 2020 2020 696e 7465 726e 616c 5f69  ;.    internal_i
-000b5d60: 6e70 7574 203d 2074 6d70 5f62 7566 6665  nput = tmp_buffe
-000b5d70: 723b 0a20 207d 2065 6c73 6520 7b0a 2020  r;.  } else {.  
-000b5d80: 2020 696e 7465 726e 616c 5f69 6e70 7574    internal_input
-000b5d90: 203d 2075 7365 725f 696e 7075 743b 0a20   = user_input;. 
-000b5da0: 207d 0a0a 2020 2f2f 204c 6561 6469 6e67   }..  // Leading
-000b5db0: 2061 6e64 2074 7261 696c 696e 6720 636f   and trailing co
-000b5dc0: 6e74 726f 6c20 6368 6172 6163 7465 7273  ntrol characters
-000b5dd0: 2061 7265 2075 6e63 6f6d 6d6f 6e20 616e   are uncommon an
-000b5de0: 6420 6561 7379 2074 6f20 6465 616c 2077  d easy to deal w
-000b5df0: 6974 680a 2020 2f2f 2028 6e6f 2070 6572  ith.  // (no per
-000b5e00: 666f 726d 616e 6365 2063 6f6e 6365 726e  formance concern
-000b5e10: 292e 0a20 2073 7464 3a3a 7374 7269 6e67  )..  std::string
-000b5e20: 5f76 6965 7720 7572 6c5f 6461 7461 203d  _view url_data =
-000b5e30: 2069 6e74 6572 6e61 6c5f 696e 7075 743b   internal_input;
-000b5e40: 0a20 2068 656c 7065 7273 3a3a 7472 696d  .  helpers::trim
-000b5e50: 5f63 305f 7768 6974 6573 7061 6365 2875  _c0_whitespace(u
-000b5e60: 726c 5f64 6174 6129 3b0a 0a20 202f 2f20  rl_data);..  // 
-000b5e70: 4f70 7469 6d69 7a61 7469 6f6e 206f 7070  Optimization opp
-000b5e80: 6f72 7475 6e69 7479 2e20 4d6f 7374 2077  ortunity. Most w
-000b5e90: 6562 7369 7465 7320 646f 206e 6f74 2068  ebsites do not h
-000b5ea0: 6176 6520 6672 6167 6d65 6e74 2e0a 2020  ave fragment..  
-000b5eb0: 7374 643a 3a6f 7074 696f 6e61 6c3c 7374  std::optional<st
-000b5ec0: 643a 3a73 7472 696e 675f 7669 6577 3e20  d::string_view> 
-000b5ed0: 6672 6167 6d65 6e74 203d 2068 656c 7065  fragment = helpe
-000b5ee0: 7273 3a3a 7072 756e 655f 6861 7368 2875  rs::prune_hash(u
-000b5ef0: 726c 5f64 6174 6129 3b0a 2020 2f2f 2057  rl_data);.  // W
-000b5f00: 6520 6164 6420 6974 206c 6173 7420 736f  e add it last so
-000b5f10: 2074 6861 7420 616e 2069 6d70 6c65 6d65   that an impleme
-000b5f20: 6e74 6174 696f 6e20 6c69 6b65 2061 6461  ntation like ada
-000b5f30: 3a3a 7572 6c5f 6167 6772 6567 6174 6f72  ::url_aggregator
-000b5f40: 0a20 202f 2f20 6361 6e20 6170 7065 6e64  .  // can append
-000b5f50: 2069 7420 6c61 7374 2074 6f20 6974 7320   it last to its 
-000b5f60: 696e 7465 726e 616c 2062 7566 6665 722c  internal buffer,
-000b5f70: 2074 6875 7320 696d 7072 6f76 696e 6720   thus improving 
-000b5f80: 7065 7266 6f72 6d61 6e63 652e 0a0a 2020  performance...  
-000b5f90: 2f2f 2048 6572 6520 7572 6c5f 6461 7461  // Here url_data
-000b5fa0: 206e 6f20 6c6f 6e67 6572 2068 6173 2069   no longer has i
-000b5fb0: 7473 2066 7261 676d 656e 742e 0a20 202f  ts fragment..  /
-000b5fc0: 2f20 5765 2061 7265 2067 6f69 6e67 2074  / We are going t
-000b5fd0: 6f20 6163 6365 7373 2074 6865 2064 6174  o access the dat
-000b5fe0: 6120 6672 6f6d 2075 726c 5f64 6174 6120  a from url_data 
-000b5ff0: 2869 7420 6973 2069 6d6d 7574 6162 6c65  (it is immutable
-000b6000: 292e 0a20 202f 2f20 4174 2061 6e79 2067  )..  // At any g
-000b6010: 6976 656e 2074 696d 652c 2077 6520 6172  iven time, we ar
-000b6020: 6520 706f 696e 7469 6e67 2061 7420 6279  e pointing at by
-000b6030: 7465 2027 696e 7075 745f 706f 7369 7469  te 'input_positi
-000b6040: 6f6e 2720 696e 2075 726c 5f64 6174 612e  on' in url_data.
-000b6050: 0a20 202f 2f20 5468 6520 696e 7075 745f  .  // The input_
-000b6060: 706f 7369 7469 6f6e 2076 6172 6961 626c  position variabl
-000b6070: 6520 7368 6f75 6c64 2072 616e 6765 2066  e should range f
-000b6080: 726f 6d20 3020 746f 2069 6e70 7574 5f73  rom 0 to input_s
-000b6090: 697a 652e 0a20 202f 2f20 4974 2069 7320  ize..  // It is 
-000b60a0: 696c 6c65 6761 6c20 746f 2061 6363 6573  illegal to acces
-000b60b0: 7320 7572 6c5f 6461 7461 2061 7420 696e  s url_data at in
-000b60c0: 7075 745f 7369 7a65 2e0a 2020 7369 7a65  put_size..  size
-000b60d0: 5f74 2069 6e70 7574 5f70 6f73 6974 696f  _t input_positio
-000b60e0: 6e20 3d20 303b 0a20 2063 6f6e 7374 2073  n = 0;.  const s
-000b60f0: 697a 655f 7420 696e 7075 745f 7369 7a65  ize_t input_size
-000b6100: 203d 2075 726c 5f64 6174 612e 7369 7a65   = url_data.size
-000b6110: 2829 3b0a 2020 2f2f 204b 6565 7020 7275  ();.  // Keep ru
-000b6120: 6e6e 696e 6720 7468 6520 666f 6c6c 6f77  nning the follow
-000b6130: 696e 6720 7374 6174 6520 6d61 6368 696e  ing state machin
-000b6140: 6520 6279 2073 7769 7463 6869 6e67 206f  e by switching o
-000b6150: 6e20 7374 6174 652e 0a20 202f 2f20 4966  n state..  // If
-000b6160: 2061 6674 6572 2061 2072 756e 2070 6f69   after a run poi
-000b6170: 6e74 6572 2070 6f69 6e74 7320 746f 2074  nter points to t
-000b6180: 6865 2045 4f46 2063 6f64 6520 706f 696e  he EOF code poin
-000b6190: 742c 2067 6f20 746f 2074 6865 206e 6578  t, go to the nex
-000b61a0: 7420 7374 6570 2e0a 2020 2f2f 204f 7468  t step..  // Oth
-000b61b0: 6572 7769 7365 2c20 696e 6372 6561 7365  erwise, increase
-000b61c0: 2070 6f69 6e74 6572 2062 7920 3120 616e   pointer by 1 an
-000b61d0: 6420 636f 6e74 696e 7565 2077 6974 6820  d continue with 
-000b61e0: 7468 6520 7374 6174 6520 6d61 6368 696e  the state machin
-000b61f0: 652e 0a20 202f 2f20 5765 206e 6576 6572  e..  // We never
-000b6200: 2064 6563 7265 6d65 6e74 2069 6e70 7574   decrement input
-000b6210: 5f70 6f73 6974 696f 6e2e 0a20 2077 6869  _position..  whi
-000b6220: 6c65 2028 696e 7075 745f 706f 7369 7469  le (input_positi
-000b6230: 6f6e 203c 3d20 696e 7075 745f 7369 7a65  on <= input_size
-000b6240: 2920 7b0a 2020 2020 6164 615f 6c6f 6728  ) {.    ada_log(
-000b6250: 2249 6e20 7061 7273 696e 6720 6174 2022  "In parsing at "
-000b6260: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
-000b6270: 2c20 2220 6f75 7420 6f66 2022 2c20 696e  , " out of ", in
-000b6280: 7075 745f 7369 7a65 2c0a 2020 2020 2020  put_size,.      
-000b6290: 2020 2020 2020 2220 696e 2073 7461 7465        " in state
-000b62a0: 2022 2c20 6164 613a 3a74 6f5f 7374 7269   ", ada::to_stri
-000b62b0: 6e67 2873 7461 7465 2929 3b0a 2020 2020  ng(state));.    
-000b62c0: 7377 6974 6368 2028 7374 6174 6529 207b  switch (state) {
-000b62d0: 0a20 2020 2020 2063 6173 6520 6164 613a  .      case ada:
-000b62e0: 3a73 7461 7465 3a3a 5343 4845 4d45 5f53  :state::SCHEME_S
-000b62f0: 5441 5254 3a20 7b0a 2020 2020 2020 2020  TART: {.        
-000b6300: 6164 615f 6c6f 6728 2253 4348 454d 455f  ada_log("SCHEME_
-000b6310: 5354 4152 5420 222c 2068 656c 7065 7273  START ", helpers
-000b6320: 3a3a 7375 6273 7472 696e 6728 7572 6c5f  ::substring(url_
-000b6330: 6461 7461 2c20 696e 7075 745f 706f 7369  data, input_posi
-000b6340: 7469 6f6e 2929 3b0a 2020 2020 2020 2020  tion));.        
-000b6350: 2f2f 2049 6620 6320 6973 2061 6e20 4153  // If c is an AS
-000b6360: 4349 4920 616c 7068 612c 2061 7070 656e  CII alpha, appen
-000b6370: 6420 632c 206c 6f77 6572 6361 7365 642c  d c, lowercased,
-000b6380: 2074 6f20 6275 6666 6572 2c20 616e 6420   to buffer, and 
-000b6390: 7365 740a 2020 2020 2020 2020 2f2f 2073  set.        // s
-000b63a0: 7461 7465 2074 6f20 7363 6865 6d65 2073  tate to scheme s
-000b63b0: 7461 7465 2e0a 2020 2020 2020 2020 6966  tate..        if
-000b63c0: 2028 2869 6e70 7574 5f70 6f73 6974 696f   ((input_positio
-000b63d0: 6e20 213d 2069 6e70 7574 5f73 697a 6529  n != input_size)
-000b63e0: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
-000b63f0: 6368 6563 6b65 7273 3a3a 6973 5f61 6c70  checkers::is_alp
-000b6400: 6861 2875 726c 5f64 6174 615b 696e 7075  ha(url_data[inpu
-000b6410: 745f 706f 7369 7469 6f6e 5d29 2920 7b0a  t_position])) {.
-000b6420: 2020 2020 2020 2020 2020 7374 6174 6520            state 
-000b6430: 3d20 6164 613a 3a73 7461 7465 3a3a 5343  = ada::state::SC
-000b6440: 4845 4d45 3b0a 2020 2020 2020 2020 2020  HEME;.          
-000b6450: 696e 7075 745f 706f 7369 7469 6f6e 2b2b  input_position++
-000b6460: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
-000b6470: 207b 0a20 2020 2020 2020 2020 202f 2f20   {.          // 
-000b6480: 4f74 6865 7277 6973 652c 2069 6620 7374  Otherwise, if st
-000b6490: 6174 6520 6f76 6572 7269 6465 2069 7320  ate override is 
-000b64a0: 6e6f 7420 6769 7665 6e2c 2073 6574 2073  not given, set s
-000b64b0: 7461 7465 2074 6f20 6e6f 2073 6368 656d  tate to no schem
-000b64c0: 650a 2020 2020 2020 2020 2020 2f2f 2073  e.          // s
-000b64d0: 7461 7465 2061 6e64 2064 6563 7265 6173  tate and decreas
-000b64e0: 6520 706f 696e 7465 7220 6279 2031 2e0a  e pointer by 1..
-000b64f0: 2020 2020 2020 2020 2020 7374 6174 6520            state 
-000b6500: 3d20 6164 613a 3a73 7461 7465 3a3a 4e4f  = ada::state::NO
-000b6510: 5f53 4348 454d 453b 0a20 2020 2020 2020  _SCHEME;.       
-000b6520: 207d 0a20 2020 2020 2020 2062 7265 616b   }.        break
-000b6530: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
-000b6540: 6361 7365 2061 6461 3a3a 7374 6174 653a  case ada::state:
-000b6550: 3a53 4348 454d 453a 207b 0a20 2020 2020  :SCHEME: {.     
-000b6560: 2020 2061 6461 5f6c 6f67 2822 5343 4845     ada_log("SCHE
-000b6570: 4d45 2022 2c20 6865 6c70 6572 733a 3a73  ME ", helpers::s
-000b6580: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000b6590: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000b65a0: 6e29 293b 0a20 2020 2020 2020 202f 2f20  n));.        // 
-000b65b0: 4966 2063 2069 7320 616e 2041 5343 4949  If c is an ASCII
-000b65c0: 2061 6c70 6861 6e75 6d65 7269 632c 2055   alphanumeric, U
-000b65d0: 2b30 3032 4220 282b 292c 2055 2b30 3032  +002B (+), U+002
-000b65e0: 4420 282d 292c 206f 7220 552b 3030 3245  D (-), or U+002E
-000b65f0: 2028 2e29 2c0a 2020 2020 2020 2020 2f2f   (.),.        //
-000b6600: 2061 7070 656e 6420 632c 206c 6f77 6572   append c, lower
-000b6610: 6361 7365 642c 2074 6f20 6275 6666 6572  cased, to buffer
-000b6620: 2e0a 2020 2020 2020 2020 7768 696c 6520  ..        while 
-000b6630: 2828 696e 7075 745f 706f 7369 7469 6f6e  ((input_position
-000b6640: 2021 3d20 696e 7075 745f 7369 7a65 2920   != input_size) 
-000b6650: 2626 0a20 2020 2020 2020 2020 2020 2020  &&.             
-000b6660: 2020 2861 6461 3a3a 756e 6963 6f64 653a    (ada::unicode:
-000b6670: 3a69 735f 616c 6e75 6d5f 706c 7573 2875  :is_alnum_plus(u
-000b6680: 726c 5f64 6174 615b 696e 7075 745f 706f  rl_data[input_po
-000b6690: 7369 7469 6f6e 5d29 2929 207b 0a20 2020  sition]))) {.   
-000b66a0: 2020 2020 2020 2069 6e70 7574 5f70 6f73         input_pos
-000b66b0: 6974 696f 6e2b 2b3b 0a20 2020 2020 2020  ition++;.       
-000b66c0: 207d 0a20 2020 2020 2020 202f 2f20 4f74   }.        // Ot
-000b66d0: 6865 7277 6973 652c 2069 6620 6320 6973  herwise, if c is
-000b66e0: 2055 2b30 3033 4120 283a 292c 2074 6865   U+003A (:), the
-000b66f0: 6e3a 0a20 2020 2020 2020 2069 6620 2828  n:.        if ((
-000b6700: 696e 7075 745f 706f 7369 7469 6f6e 2021  input_position !
-000b6710: 3d20 696e 7075 745f 7369 7a65 2920 2626  = input_size) &&
-000b6720: 0a20 2020 2020 2020 2020 2020 2028 7572  .            (ur
-000b6730: 6c5f 6461 7461 5b69 6e70 7574 5f70 6f73  l_data[input_pos
-000b6740: 6974 696f 6e5d 203d 3d20 273a 2729 2920  ition] == ':')) 
-000b6750: 7b0a 2020 2020 2020 2020 2020 6164 615f  {.          ada_
-000b6760: 6c6f 6728 2253 4348 454d 4520 7468 6520  log("SCHEME the 
-000b6770: 7363 6865 6d65 2073 686f 756c 6420 6265  scheme should be
-000b6780: 2022 2c0a 2020 2020 2020 2020 2020 2020   ",.            
-000b6790: 2020 2020 2020 7572 6c5f 6461 7461 2e73        url_data.s
-000b67a0: 7562 7374 7228 302c 2069 6e70 7574 5f70  ubstr(0, input_p
-000b67b0: 6f73 6974 696f 6e29 293b 0a20 2020 2020  osition));.     
-000b67c0: 2020 2020 2069 6620 636f 6e73 7465 7870       if constexp
-000b67d0: 7220 2872 6573 756c 745f 7479 7065 5f69  r (result_type_i
-000b67e0: 735f 6164 615f 7572 6c29 207b 0a20 2020  s_ada_url) {.   
-000b67f0: 2020 2020 2020 2020 2069 6620 2821 7572           if (!ur
-000b6800: 6c2e 7061 7273 655f 7363 6865 6d65 2875  l.parse_scheme(u
-000b6810: 726c 5f64 6174 612e 7375 6273 7472 2830  rl_data.substr(0
-000b6820: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
-000b6830: 2929 2920 7b0a 2020 2020 2020 2020 2020  ))) {.          
-000b6840: 2020 2020 7265 7475 726e 2075 726c 3b0a      return url;.
-000b6850: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000b6860: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-000b6870: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-000b6880: 7765 2070 6173 7320 7468 6520 636f 6c6f  we pass the colo
-000b6890: 6e20 616c 6f6e 6720 696e 7374 6561 6420  n along instead 
-000b68a0: 6f66 2070 6169 6e66 756c 6c79 2061 6464  of painfully add
-000b68b0: 696e 6720 6974 2062 6163 6b2e 0a20 2020  ing it back..   
-000b68c0: 2020 2020 2020 2020 2069 6620 2821 7572           if (!ur
-000b68d0: 6c2e 7061 7273 655f 7363 6865 6d65 5f77  l.parse_scheme_w
-000b68e0: 6974 685f 636f 6c6f 6e28 0a20 2020 2020  ith_colon(.     
-000b68f0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000b6900: 726c 5f64 6174 612e 7375 6273 7472 2830  rl_data.substr(0
-000b6910: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
-000b6920: 202b 2031 2929 2920 7b0a 2020 2020 2020   + 1))) {.      
-000b6930: 2020 2020 2020 2020 7265 7475 726e 2075          return u
-000b6940: 726c 3b0a 2020 2020 2020 2020 2020 2020  rl;.            
-000b6950: 7d0a 2020 2020 2020 2020 2020 7d0a 2020  }.          }.  
-000b6960: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
-000b6970: 2253 4348 454d 4520 7468 6520 7363 6865  "SCHEME the sche
-000b6980: 6d65 2069 7320 222c 2075 726c 2e67 6574  me is ", url.get
-000b6990: 5f70 726f 746f 636f 6c28 2929 3b0a 0a20  _protocol());.. 
-000b69a0: 2020 2020 2020 2020 202f 2f20 4966 2075           // If u
-000b69b0: 726c e280 9973 2073 6368 656d 6520 6973  rl...s scheme is
-000b69c0: 2022 6669 6c65 222c 2074 6865 6e3a 0a20   "file", then:. 
-000b69d0: 2020 2020 2020 2020 2069 6620 2875 726c           if (url
-000b69e0: 2e74 7970 6520 3d3d 2061 6461 3a3a 7363  .type == ada::sc
-000b69f0: 6865 6d65 3a3a 7479 7065 3a3a 4649 4c45  heme::type::FILE
-000b6a00: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000b6a10: 2f2f 2053 6574 2073 7461 7465 2074 6f20  // Set state to 
-000b6a20: 6669 6c65 2073 7461 7465 2e0a 2020 2020  file state..    
-000b6a30: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-000b6a40: 6164 613a 3a73 7461 7465 3a3a 4649 4c45  ada::state::FILE
-000b6a50: 3b0a 2020 2020 2020 2020 2020 7d0a 2020  ;.          }.  
-000b6a60: 2020 2020 2020 2020 2f2f 204f 7468 6572          // Other
-000b6a70: 7769 7365 2c20 6966 2075 726c 2069 7320  wise, if url is 
-000b6a80: 7370 6563 6961 6c2c 2062 6173 6520 6973  special, base is
-000b6a90: 206e 6f6e 2d6e 756c 6c2c 2061 6e64 2062   non-null, and b
-000b6aa0: 6173 65e2 8099 7320 7363 6865 6d65 0a20  ase...s scheme. 
-000b6ab0: 2020 2020 2020 2020 202f 2f20 6973 2075           // is u
-000b6ac0: 726c e280 9973 2073 6368 656d 653a 204e  rl...s scheme: N
-000b6ad0: 6f74 653a 2044 6f69 6e67 2062 6173 655f  ote: Doing base_
-000b6ae0: 7572 6c2d 3e73 6368 656d 6520 6973 2075  url->scheme is u
-000b6af0: 6e73 6166 6520 6966 2062 6173 655f 7572  nsafe if base_ur
-000b6b00: 6c0a 2020 2020 2020 2020 2020 2f2f 2021  l.          // !
-000b6b10: 3d20 6e75 6c6c 7074 7220 6973 2066 616c  = nullptr is fal
-000b6b20: 7365 2e0a 2020 2020 2020 2020 2020 656c  se..          el
-000b6b30: 7365 2069 6620 2875 726c 2e69 735f 7370  se if (url.is_sp
-000b6b40: 6563 6961 6c28 2920 2626 2062 6173 655f  ecial() && base_
-000b6b50: 7572 6c20 213d 206e 756c 6c70 7472 2026  url != nullptr &
-000b6b60: 260a 2020 2020 2020 2020 2020 2020 2020  &.              
-000b6b70: 2020 2020 2062 6173 655f 7572 6c2d 3e74       base_url->t
-000b6b80: 7970 6520 3d3d 2075 726c 2e74 7970 6529  ype == url.type)
-000b6b90: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
-000b6ba0: 2f20 5365 7420 7374 6174 6520 746f 2073  / Set state to s
-000b6bb0: 7065 6369 616c 2072 656c 6174 6976 6520  pecial relative 
-000b6bc0: 6f72 2061 7574 686f 7269 7479 2073 7461  or authority sta
-000b6bd0: 7465 2e0a 2020 2020 2020 2020 2020 2020  te..            
-000b6be0: 7374 6174 6520 3d20 6164 613a 3a73 7461  state = ada::sta
-000b6bf0: 7465 3a3a 5350 4543 4941 4c5f 5245 4c41  te::SPECIAL_RELA
-000b6c00: 5449 5645 5f4f 525f 4155 5448 4f52 4954  TIVE_OR_AUTHORIT
-000b6c10: 593b 0a20 2020 2020 2020 2020 207d 0a20  Y;.          }. 
-000b6c20: 2020 2020 2020 2020 202f 2f20 4f74 6865           // Othe
-000b6c30: 7277 6973 652c 2069 6620 7572 6c20 6973  rwise, if url is
-000b6c40: 2073 7065 6369 616c 2c20 7365 7420 7374   special, set st
-000b6c50: 6174 6520 746f 2073 7065 6369 616c 2061  ate to special a
-000b6c60: 7574 686f 7269 7479 0a20 2020 2020 2020  uthority.       
-000b6c70: 2020 202f 2f20 736c 6173 6865 7320 7374     // slashes st
-000b6c80: 6174 652e 0a20 2020 2020 2020 2020 2065  ate..          e
-000b6c90: 6c73 6520 6966 2028 7572 6c2e 6973 5f73  lse if (url.is_s
-000b6ca0: 7065 6369 616c 2829 2920 7b0a 2020 2020  pecial()) {.    
-000b6cb0: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-000b6cc0: 6164 613a 3a73 7461 7465 3a3a 5350 4543  ada::state::SPEC
-000b6cd0: 4941 4c5f 4155 5448 4f52 4954 595f 534c  IAL_AUTHORITY_SL
-000b6ce0: 4153 4845 533b 0a20 2020 2020 2020 2020  ASHES;.         
-000b6cf0: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
-000b6d00: 4f74 6865 7277 6973 652c 2069 6620 7265  Otherwise, if re
-000b6d10: 6d61 696e 696e 6720 7374 6172 7473 2077  maining starts w
-000b6d20: 6974 6820 616e 2055 2b30 3032 4620 282f  ith an U+002F (/
-000b6d30: 292c 2073 6574 2073 7461 7465 2074 6f0a  ), set state to.
-000b6d40: 2020 2020 2020 2020 2020 2f2f 2070 6174            // pat
-000b6d50: 6820 6f72 2061 7574 686f 7269 7479 2073  h or authority s
-000b6d60: 7461 7465 2061 6e64 2069 6e63 7265 6173  tate and increas
-000b6d70: 6520 706f 696e 7465 7220 6279 2031 2e0a  e pointer by 1..
-000b6d80: 2020 2020 2020 2020 2020 656c 7365 2069            else i
-000b6d90: 6620 2869 6e70 7574 5f70 6f73 6974 696f  f (input_positio
-000b6da0: 6e20 2b20 3120 3c20 696e 7075 745f 7369  n + 1 < input_si
-000b6db0: 7a65 2026 260a 2020 2020 2020 2020 2020  ze &&.          
-000b6dc0: 2020 2020 2020 2020 2075 726c 5f64 6174           url_dat
-000b6dd0: 615b 696e 7075 745f 706f 7369 7469 6f6e  a[input_position
-000b6de0: 202b 2031 5d20 3d3d 2027 2f27 2920 7b0a   + 1] == '/') {.
-000b6df0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-000b6e00: 6520 3d20 6164 613a 3a73 7461 7465 3a3a  e = ada::state::
-000b6e10: 5041 5448 5f4f 525f 4155 5448 4f52 4954  PATH_OR_AUTHORIT
-000b6e20: 593b 0a20 2020 2020 2020 2020 2020 2069  Y;.            i
-000b6e30: 6e70 7574 5f70 6f73 6974 696f 6e2b 2b3b  nput_position++;
-000b6e40: 0a20 2020 2020 2020 2020 207d 0a20 2020  .          }.   
-000b6e50: 2020 2020 2020 202f 2f20 4f74 6865 7277         // Otherw
-000b6e60: 6973 652c 2073 6574 2075 726c e280 9973  ise, set url...s
-000b6e70: 2070 6174 6820 746f 2074 6865 2065 6d70   path to the emp
-000b6e80: 7479 2073 7472 696e 6720 616e 6420 7365  ty string and se
-000b6e90: 7420 7374 6174 6520 746f 0a20 2020 2020  t state to.     
-000b6ea0: 2020 2020 202f 2f20 6f70 6171 7565 2070       // opaque p
-000b6eb0: 6174 6820 7374 6174 652e 0a20 2020 2020  ath state..     
-000b6ec0: 2020 2020 2065 6c73 6520 7b0a 2020 2020       else {.    
-000b6ed0: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-000b6ee0: 6164 613a 3a73 7461 7465 3a3a 4f50 4151  ada::state::OPAQ
-000b6ef0: 5545 5f50 4154 483b 0a20 2020 2020 2020  UE_PATH;.       
-000b6f00: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-000b6f10: 2020 2020 2020 202f 2f20 4f74 6865 7277         // Otherw
-000b6f20: 6973 652c 2069 6620 7374 6174 6520 6f76  ise, if state ov
-000b6f30: 6572 7269 6465 2069 7320 6e6f 7420 6769  erride is not gi
-000b6f40: 7665 6e2c 2073 6574 2062 7566 6665 7220  ven, set buffer 
-000b6f50: 746f 2074 6865 2065 6d70 7479 0a20 2020  to the empty.   
-000b6f60: 2020 2020 202f 2f20 7374 7269 6e67 2c20       // string, 
-000b6f70: 7374 6174 6520 746f 206e 6f20 7363 6865  state to no sche
-000b6f80: 6d65 2073 7461 7465 2c20 616e 6420 7374  me state, and st
-000b6f90: 6172 7420 6f76 6572 2028 6672 6f6d 2074  art over (from t
-000b6fa0: 6865 2066 6972 7374 2063 6f64 650a 2020  he first code.  
-000b6fb0: 2020 2020 2020 2f2f 2070 6f69 6e74 2069        // point i
-000b6fc0: 6e20 696e 7075 7429 2e0a 2020 2020 2020  n input)..      
-000b6fd0: 2020 656c 7365 207b 0a20 2020 2020 2020    else {.       
-000b6fe0: 2020 2073 7461 7465 203d 2061 6461 3a3a     state = ada::
-000b6ff0: 7374 6174 653a 3a4e 4f5f 5343 4845 4d45  state::NO_SCHEME
-000b7000: 3b0a 2020 2020 2020 2020 2020 696e 7075  ;.          inpu
-000b7010: 745f 706f 7369 7469 6f6e 203d 2030 3b0a  t_position = 0;.
-000b7020: 2020 2020 2020 2020 2020 6272 6561 6b3b            break;
-000b7030: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-000b7040: 2020 2069 6e70 7574 5f70 6f73 6974 696f     input_positio
-000b7050: 6e2b 2b3b 0a20 2020 2020 2020 2062 7265  n++;.        bre
-000b7060: 616b 3b0a 2020 2020 2020 7d0a 2020 2020  ak;.      }.    
-000b7070: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000b7080: 653a 3a4e 4f5f 5343 4845 4d45 3a20 7b0a  e::NO_SCHEME: {.
-000b7090: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
-000b70a0: 224e 4f5f 5343 4845 4d45 2022 2c20 6865  "NO_SCHEME ", he
-000b70b0: 6c70 6572 733a 3a73 7562 7374 7269 6e67  lpers::substring
-000b70c0: 2875 726c 5f64 6174 612c 2069 6e70 7574  (url_data, input
-000b70d0: 5f70 6f73 6974 696f 6e29 293b 0a20 2020  _position));.   
-000b70e0: 2020 2020 202f 2f20 4966 2062 6173 6520       // If base 
-000b70f0: 6973 206e 756c 6c2c 206f 7220 6261 7365  is null, or base
-000b7100: 2068 6173 2061 6e20 6f70 6171 7565 2070   has an opaque p
-000b7110: 6174 6820 616e 6420 6320 6973 206e 6f74  ath and c is not
-000b7120: 2055 2b30 3032 3320 2823 292c 0a20 2020   U+0023 (#),.   
-000b7130: 2020 2020 202f 2f20 7661 6c69 6461 7469       // validati
-000b7140: 6f6e 2065 7272 6f72 2c20 7265 7475 726e  on error, return
-000b7150: 2066 6169 6c75 7265 2e0a 2020 2020 2020   failure..      
-000b7160: 2020 6966 2028 6261 7365 5f75 726c 203d    if (base_url =
-000b7170: 3d20 6e75 6c6c 7074 7220 7c7c 0a20 2020  = nullptr ||.   
-000b7180: 2020 2020 2020 2020 2028 6261 7365 5f75           (base_u
-000b7190: 726c 2d3e 6861 735f 6f70 6171 7565 5f70  rl->has_opaque_p
-000b71a0: 6174 6820 2626 2021 6672 6167 6d65 6e74  ath && !fragment
-000b71b0: 2e68 6173 5f76 616c 7565 2829 2929 207b  .has_value())) {
-000b71c0: 0a20 2020 2020 2020 2020 2061 6461 5f6c  .          ada_l
-000b71d0: 6f67 2822 4e4f 5f53 4348 454d 4520 7661  og("NO_SCHEME va
-000b71e0: 6c69 6461 7469 6f6e 2065 7272 6f72 2229  lidation error")
-000b71f0: 3b0a 2020 2020 2020 2020 2020 7572 6c2e  ;.          url.
-000b7200: 6973 5f76 616c 6964 203d 2066 616c 7365  is_valid = false
-000b7210: 3b0a 2020 2020 2020 2020 2020 7265 7475  ;.          retu
-000b7220: 726e 2075 726c 3b0a 2020 2020 2020 2020  rn url;.        
-000b7230: 7d0a 2020 2020 2020 2020 2f2f 204f 7468  }.        // Oth
-000b7240: 6572 7769 7365 2c20 6966 2062 6173 6520  erwise, if base 
-000b7250: 6861 7320 616e 206f 7061 7175 6520 7061  has an opaque pa
-000b7260: 7468 2061 6e64 2063 2069 7320 552b 3030  th and c is U+00
-000b7270: 3233 2028 2329 2c0a 2020 2020 2020 2020  23 (#),.        
-000b7280: 2f2f 2073 6574 2075 726c e280 9973 2073  // set url...s s
-000b7290: 6368 656d 6520 746f 2062 6173 65e2 8099  cheme to base...
-000b72a0: 7320 7363 6865 6d65 2c20 7572 6ce2 8099  s scheme, url...
-000b72b0: 7320 7061 7468 2074 6f20 6261 7365 e280  s path to base..
-000b72c0: 9973 2070 6174 682c 2075 726c e280 9973  .s path, url...s
-000b72d0: 0a20 2020 2020 2020 202f 2f20 7175 6572  .        // quer
-000b72e0: 7920 746f 2062 6173 65e2 8099 7320 7175  y to base...s qu
-000b72f0: 6572 792c 2061 6e64 2073 6574 2073 7461  ery, and set sta
-000b7300: 7465 2074 6f20 6672 6167 6d65 6e74 2073  te to fragment s
-000b7310: 7461 7465 2e0a 2020 2020 2020 2020 656c  tate..        el
-000b7320: 7365 2069 6620 2862 6173 655f 7572 6c2d  se if (base_url-
-000b7330: 3e68 6173 5f6f 7061 7175 655f 7061 7468  >has_opaque_path
-000b7340: 2026 2620 6672 6167 6d65 6e74 2e68 6173   && fragment.has
-000b7350: 5f76 616c 7565 2829 2026 260a 2020 2020  _value() &&.    
-000b7360: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000b7370: 7574 5f70 6f73 6974 696f 6e20 3d3d 2069  ut_position == i
-000b7380: 6e70 7574 5f73 697a 6529 207b 0a20 2020  nput_size) {.   
-000b7390: 2020 2020 2020 2061 6461 5f6c 6f67 2822         ada_log("
-000b73a0: 4e4f 5f53 4348 454d 4520 6f70 6171 7565  NO_SCHEME opaque
-000b73b0: 2062 6173 6520 7769 7468 2066 7261 676d   base with fragm
-000b73c0: 656e 7422 293b 0a20 2020 2020 2020 2020  ent");.         
-000b73d0: 2075 726c 2e63 6f70 795f 7363 6865 6d65   url.copy_scheme
-000b73e0: 282a 6261 7365 5f75 726c 293b 0a20 2020  (*base_url);.   
-000b73f0: 2020 2020 2020 2075 726c 2e68 6173 5f6f         url.has_o
-000b7400: 7061 7175 655f 7061 7468 203d 2062 6173  paque_path = bas
-000b7410: 655f 7572 6c2d 3e68 6173 5f6f 7061 7175  e_url->has_opaqu
-000b7420: 655f 7061 7468 3b0a 0a20 2020 2020 2020  e_path;..       
-000b7430: 2020 2069 6620 636f 6e73 7465 7870 7220     if constexpr 
-000b7440: 2872 6573 756c 745f 7479 7065 5f69 735f  (result_type_is_
-000b7450: 6164 615f 7572 6c29 207b 0a20 2020 2020  ada_url) {.     
-000b7460: 2020 2020 2020 2075 726c 2e70 6174 6820         url.path 
-000b7470: 3d20 6261 7365 5f75 726c 2d3e 7061 7468  = base_url->path
-000b7480: 3b0a 2020 2020 2020 2020 2020 2020 7572  ;.            ur
-000b7490: 6c2e 7175 6572 7920 3d20 6261 7365 5f75  l.query = base_u
-000b74a0: 726c 2d3e 7175 6572 793b 0a20 2020 2020  rl->query;.     
-000b74b0: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
-000b74c0: 2020 2020 2020 2020 2020 7572 6c2e 7570            url.up
-000b74d0: 6461 7465 5f62 6173 655f 7061 7468 6e61  date_base_pathna
-000b74e0: 6d65 2862 6173 655f 7572 6c2d 3e67 6574  me(base_url->get
-000b74f0: 5f70 6174 686e 616d 6528 2929 3b0a 2020  _pathname());.  
-000b7500: 2020 2020 2020 2020 2020 7572 6c2e 7570            url.up
-000b7510: 6461 7465 5f62 6173 655f 7365 6172 6368  date_base_search
-000b7520: 2862 6173 655f 7572 6c2d 3e67 6574 5f73  (base_url->get_s
-000b7530: 6561 7263 6828 2929 3b0a 2020 2020 2020  earch());.      
-000b7540: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000b7550: 7572 6c2e 7570 6461 7465 5f75 6e65 6e63  url.update_unenc
-000b7560: 6f64 6564 5f62 6173 655f 6861 7368 282a  oded_base_hash(*
-000b7570: 6672 6167 6d65 6e74 293b 0a20 2020 2020  fragment);.     
-000b7580: 2020 2020 2072 6574 7572 6e20 7572 6c3b       return url;
-000b7590: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-000b75a0: 2020 202f 2f20 4f74 6865 7277 6973 652c     // Otherwise,
-000b75b0: 2069 6620 6261 7365 e280 9973 2073 6368   if base...s sch
-000b75c0: 656d 6520 6973 206e 6f74 2022 6669 6c65  eme is not "file
-000b75d0: 222c 2073 6574 2073 7461 7465 2074 6f20  ", set state to 
-000b75e0: 7265 6c61 7469 7665 0a20 2020 2020 2020  relative.       
-000b75f0: 202f 2f20 7374 6174 6520 616e 6420 6465   // state and de
-000b7600: 6372 6561 7365 2070 6f69 6e74 6572 2062  crease pointer b
-000b7610: 7920 312e 0a20 2020 2020 2020 2065 6c73  y 1..        els
-000b7620: 6520 6966 2028 6261 7365 5f75 726c 2d3e  e if (base_url->
-000b7630: 7479 7065 2021 3d20 6164 613a 3a73 6368  type != ada::sch
-000b7640: 656d 653a 3a74 7970 653a 3a46 494c 4529  eme::type::FILE)
-000b7650: 207b 0a20 2020 2020 2020 2020 2061 6461   {.          ada
-000b7660: 5f6c 6f67 2822 4e4f 5f53 4348 454d 4520  _log("NO_SCHEME 
-000b7670: 6e6f 6e2d 6669 6c65 2072 656c 6174 6976  non-file relativ
-000b7680: 6520 7061 7468 2229 3b0a 2020 2020 2020  e path");.      
-000b7690: 2020 2020 7374 6174 6520 3d20 6164 613a      state = ada:
-000b76a0: 3a73 7461 7465 3a3a 5245 4c41 5449 5645  :state::RELATIVE
-000b76b0: 5f53 4348 454d 453b 0a20 2020 2020 2020  _SCHEME;.       
-000b76c0: 207d 0a20 2020 2020 2020 202f 2f20 4f74   }.        // Ot
-000b76d0: 6865 7277 6973 652c 2073 6574 2073 7461  herwise, set sta
-000b76e0: 7465 2074 6f20 6669 6c65 2073 7461 7465  te to file state
-000b76f0: 2061 6e64 2064 6563 7265 6173 6520 706f   and decrease po
-000b7700: 696e 7465 7220 6279 2031 2e0a 2020 2020  inter by 1..    
-000b7710: 2020 2020 656c 7365 207b 0a20 2020 2020      else {.     
-000b7720: 2020 2020 2061 6461 5f6c 6f67 2822 4e4f       ada_log("NO
-000b7730: 5f53 4348 454d 4520 6669 6c65 2062 6173  _SCHEME file bas
-000b7740: 6520 7479 7065 2229 3b0a 2020 2020 2020  e type");.      
-000b7750: 2020 2020 7374 6174 6520 3d20 6164 613a      state = ada:
-000b7760: 3a73 7461 7465 3a3a 4649 4c45 3b0a 2020  :state::FILE;.  
-000b7770: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000b7780: 6272 6561 6b3b 0a20 2020 2020 207d 0a20  break;.      }. 
-000b7790: 2020 2020 2063 6173 6520 6164 613a 3a73       case ada::s
-000b77a0: 7461 7465 3a3a 4155 5448 4f52 4954 593a  tate::AUTHORITY:
-000b77b0: 207b 0a20 2020 2020 2020 2061 6461 5f6c   {.        ada_l
-000b77c0: 6f67 2822 4155 5448 4f52 4954 5920 222c  og("AUTHORITY ",
-000b77d0: 2068 656c 7065 7273 3a3a 7375 6273 7472   helpers::substr
-000b77e0: 696e 6728 7572 6c5f 6461 7461 2c20 696e  ing(url_data, in
-000b77f0: 7075 745f 706f 7369 7469 6f6e 2929 3b0a  put_position));.
-000b7800: 2020 2020 2020 2020 2f2f 206d 6f73 7420          // most 
-000b7810: 5552 4c73 2068 6176 6520 6e6f 2040 2e20  URLs have no @. 
-000b7820: 4861 7669 6e67 206e 6f20 4020 7465 6c6c  Having no @ tell
-000b7830: 7320 7573 2074 6861 7420 7765 2064 6f6e  s us that we don
-000b7840: 2774 2068 6176 6520 746f 2077 6f72 7279  't have to worry
-000b7850: 0a20 2020 2020 2020 202f 2f20 6162 6f75  .        // abou
-000b7860: 7420 4155 5448 4f52 4954 592e 204f 6620  t AUTHORITY. Of 
-000b7870: 636f 7572 7365 2c20 7765 2063 6f75 6c64  course, we could
-000b7880: 2068 6176 6520 4020 616e 6420 7374 696c   have @ and stil
-000b7890: 6c20 6e6f 7420 6861 7665 2074 6f0a 2020  l not have to.  
-000b78a0: 2020 2020 2020 2f2f 2077 6f72 7279 2061        // worry a
-000b78b0: 626f 7574 2041 5554 484f 5249 5459 2e0a  bout AUTHORITY..
-000b78c0: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-000b78d0: 2049 6e73 7465 6164 206f 6620 6a75 7374   Instead of just
-000b78e0: 2063 6f6c 6c65 6374 696e 6720 6120 626f   collecting a bo
-000b78f0: 6f6c 2c20 636f 6c6c 6563 7420 7468 6520  ol, collect the 
-000b7900: 6c6f 6361 7469 6f6e 206f 6620 7468 650a  location of the.
-000b7910: 2020 2020 2020 2020 2f2f 2027 4027 2061          // '@' a
-000b7920: 6e64 2064 6f20 736f 6d65 7468 696e 6720  nd do something 
-000b7930: 7573 6566 756c 2077 6974 6820 6974 2e0a  useful with it..
-000b7940: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-000b7950: 2057 6520 636f 756c 6420 646f 2076 6172   We could do var
-000b7960: 696f 7573 2070 726f 6365 7373 696e 6720  ious processing 
-000b7970: 6561 726c 7920 6f6e 2c20 7573 696e 6720  early on, using 
-000b7980: 6120 7369 6e67 6c65 2070 6173 730a 2020  a single pass.  
-000b7990: 2020 2020 2020 2f2f 206f 7665 7220 7468        // over th
-000b79a0: 6520 7374 7269 6e67 2074 6f20 636f 6c6c  e string to coll
-000b79b0: 6563 7420 696e 666f 726d 6174 696f 6e20  ect information 
-000b79c0: 6162 6f75 7420 6974 2c20 652e 672e 2c20  about it, e.g., 
-000b79d0: 7465 6c6c 696e 6720 7573 0a20 2020 2020  telling us.     
-000b79e0: 2020 202f 2f20 7768 6574 6865 7220 7468     // whether th
-000b79f0: 6572 6520 6973 2061 2040 2061 6e64 2069  ere is a @ and i
-000b7a00: 6620 736f 2c20 7768 6572 6520 286f 7220  f so, where (or 
-000b7a10: 686f 7720 6d61 6e79 292e 0a20 2020 2020  how many)..     
-000b7a20: 2020 2063 6f6e 7374 2062 6f6f 6c20 636f     const bool co
-000b7a30: 6e74 6169 6e73 5f61 6d70 6572 7361 6e64  ntains_ampersand
-000b7a40: 203d 0a20 2020 2020 2020 2020 2020 2028   =.            (
-000b7a50: 7572 6c5f 6461 7461 2e66 696e 6428 2740  url_data.find('@
-000b7a60: 272c 2069 6e70 7574 5f70 6f73 6974 696f  ', input_positio
-000b7a70: 6e29 2021 3d20 7374 643a 3a73 7472 696e  n) != std::strin
-000b7a80: 675f 7669 6577 3a3a 6e70 6f73 293b 0a0a  g_view::npos);..
-000b7a90: 2020 2020 2020 2020 6966 2028 2163 6f6e          if (!con
-000b7aa0: 7461 696e 735f 616d 7065 7273 616e 6429  tains_ampersand)
-000b7ab0: 207b 0a20 2020 2020 2020 2020 2073 7461   {.          sta
-000b7ac0: 7465 203d 2061 6461 3a3a 7374 6174 653a  te = ada::state:
-000b7ad0: 3a48 4f53 543b 0a20 2020 2020 2020 2020  :HOST;.         
-000b7ae0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000b7af0: 7d0a 2020 2020 2020 2020 626f 6f6c 2061  }.        bool a
-000b7b00: 745f 7369 676e 5f73 6565 6e7b 6661 6c73  t_sign_seen{fals
-000b7b10: 657d 3b0a 2020 2020 2020 2020 626f 6f6c  e};.        bool
-000b7b20: 2070 6173 7377 6f72 645f 746f 6b65 6e5f   password_token_
-000b7b30: 7365 656e 7b66 616c 7365 7d3b 0a20 2020  seen{false};.   
-000b7b40: 2020 2020 202f 2a2a 0a20 2020 2020 2020       /**.       
-000b7b50: 2020 2a20 5765 2065 7870 6563 7420 736f    * We expect so
-000b7b60: 6d65 7468 696e 6720 6f66 2074 6865 2073  mething of the s
-000b7b70: 6f72 742e 2e2e 0a20 2020 2020 2020 2020  ort....         
-000b7b80: 2a20 6874 7470 733a 2f2f 7573 6572 3a70  * https://user:p
-000b7b90: 6173 7340 6578 616d 706c 652e 636f 6d3a  ass@example.com:
-000b7ba0: 3132 3334 2f66 6f6f 2f62 6172 3f62 617a  1234/foo/bar?baz
-000b7bb0: 2371 7575 780a 2020 2020 2020 2020 202a  #quux.         *
-000b7bc0: 202d 2d2d 2d2d 2d2d 2d5e 0a20 2020 2020   --------^.     
-000b7bd0: 2020 2020 2a2f 0a20 2020 2020 2020 2064      */.        d
-000b7be0: 6f20 7b0a 2020 2020 2020 2020 2020 7374  o {.          st
-000b7bf0: 643a 3a73 7472 696e 675f 7669 6577 2076  d::string_view v
-000b7c00: 6965 7720 3d20 6865 6c70 6572 733a 3a73  iew = helpers::s
-000b7c10: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000b7c20: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000b7c30: 6e29 3b0a 2020 2020 2020 2020 2020 2f2f  n);.          //
-000b7c40: 2054 6865 2064 656c 696d 6974 6572 7320   The delimiters 
-000b7c50: 6172 6520 402c 202f 2c20 3f20 5c5c 2e0a  are @, /, ? \\..
-000b7c60: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
-000b7c70: 206c 6f63 6174 696f 6e20 3d0a 2020 2020   location =.    
-000b7c80: 2020 2020 2020 2020 2020 7572 6c2e 6973            url.is
-000b7c90: 5f73 7065 6369 616c 2829 203f 2068 656c  _special() ? hel
-000b7ca0: 7065 7273 3a3a 6669 6e64 5f61 7574 686f  pers::find_autho
-000b7cb0: 7269 7479 5f64 656c 696d 6974 6572 5f73  rity_delimiter_s
-000b7cc0: 7065 6369 616c 2876 6965 7729 0a20 2020  pecial(view).   
-000b7cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b7ce0: 2020 2020 2020 2020 2020 2020 3a20 6865              : he
-000b7cf0: 6c70 6572 733a 3a66 696e 645f 6175 7468  lpers::find_auth
-000b7d00: 6f72 6974 795f 6465 6c69 6d69 7465 7228  ority_delimiter(
-000b7d10: 7669 6577 293b 0a20 2020 2020 2020 2020  view);.         
-000b7d20: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000b7d30: 7720 6175 7468 6f72 6974 795f 7669 6577  w authority_view
-000b7d40: 2876 6965 772e 6461 7461 2829 2c20 6c6f  (view.data(), lo
-000b7d50: 6361 7469 6f6e 293b 0a20 2020 2020 2020  cation);.       
-000b7d60: 2020 2073 697a 655f 7420 656e 645f 6f66     size_t end_of
-000b7d70: 5f61 7574 686f 7269 7479 203d 2069 6e70  _authority = inp
-000b7d80: 7574 5f70 6f73 6974 696f 6e20 2b20 6175  ut_position + au
-000b7d90: 7468 6f72 6974 795f 7669 6577 2e73 697a  thority_view.siz
-000b7da0: 6528 293b 0a20 2020 2020 2020 2020 202f  e();.          /
-000b7db0: 2f20 4966 2063 2069 7320 552b 3030 3430  / If c is U+0040
-000b7dc0: 2028 4029 2c20 7468 656e 3a0a 2020 2020   (@), then:.    
-000b7dd0: 2020 2020 2020 6966 2028 2865 6e64 5f6f        if ((end_o
-000b7de0: 665f 6175 7468 6f72 6974 7920 213d 2069  f_authority != i
-000b7df0: 6e70 7574 5f73 697a 6529 2026 260a 2020  nput_size) &&.  
-000b7e00: 2020 2020 2020 2020 2020 2020 2875 726c              (url
-000b7e10: 5f64 6174 615b 656e 645f 6f66 5f61 7574  _data[end_of_aut
-000b7e20: 686f 7269 7479 5d20 3d3d 2027 4027 2929  hority] == '@'))
-000b7e30: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
-000b7e40: 2f20 4966 2061 7453 6967 6e53 6565 6e20  / If atSignSeen 
-000b7e50: 6973 2074 7275 652c 2074 6865 6e20 7072  is true, then pr
-000b7e60: 6570 656e 6420 2225 3430 2220 746f 2062  epend "%40" to b
-000b7e70: 7566 6665 722e 0a20 2020 2020 2020 2020  uffer..         
-000b7e80: 2020 2069 6620 2861 745f 7369 676e 5f73     if (at_sign_s
-000b7e90: 6565 6e29 207b 0a20 2020 2020 2020 2020  een) {.         
-000b7ea0: 2020 2020 2069 6620 2870 6173 7377 6f72       if (passwor
-000b7eb0: 645f 746f 6b65 6e5f 7365 656e 2920 7b0a  d_token_seen) {.
-000b7ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b7ed0: 6966 2063 6f6e 7374 6578 7072 2028 7265  if constexpr (re
-000b7ee0: 7375 6c74 5f74 7970 655f 6973 5f61 6461  sult_type_is_ada
-000b7ef0: 5f75 726c 2920 7b0a 2020 2020 2020 2020  _url) {.        
-000b7f00: 2020 2020 2020 2020 2020 7572 6c2e 7061            url.pa
-000b7f10: 7373 776f 7264 202b 3d20 2225 3430 223b  ssword += "%40";
-000b7f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b7f30: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-000b7f40: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
-000b7f50: 6170 7065 6e64 5f62 6173 655f 7061 7373  append_base_pass
-000b7f60: 776f 7264 2822 2534 3022 293b 0a20 2020  word("%40");.   
-000b7f70: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-000b7f80: 2020 2020 2020 2020 2020 2020 207d 2065               } e
-000b7f90: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-000b7fa0: 2020 2020 2020 6966 2063 6f6e 7374 6578        if constex
-000b7fb0: 7072 2028 7265 7375 6c74 5f74 7970 655f  pr (result_type_
-000b7fc0: 6973 5f61 6461 5f75 726c 2920 7b0a 2020  is_ada_url) {.  
-000b7fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b7fe0: 7572 6c2e 7573 6572 6e61 6d65 202b 3d20  url.username += 
-000b7ff0: 2225 3430 223b 0a20 2020 2020 2020 2020  "%40";.         
-000b8000: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-000b8010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b8020: 2020 7572 6c2e 6170 7065 6e64 5f62 6173    url.append_bas
-000b8030: 655f 7573 6572 6e61 6d65 2822 2534 3022  e_username("%40"
-000b8040: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000b8050: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000b8060: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000b8070: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-000b8080: 6174 5f73 6967 6e5f 7365 656e 203d 2074  at_sign_seen = t
-000b8090: 7275 653b 0a0a 2020 2020 2020 2020 2020  rue;..          
-000b80a0: 2020 6966 2028 2170 6173 7377 6f72 645f    if (!password_
-000b80b0: 746f 6b65 6e5f 7365 656e 2920 7b0a 2020  token_seen) {.  
-000b80c0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-000b80d0: 5f74 2070 6173 7377 6f72 645f 746f 6b65  _t password_toke
-000b80e0: 6e5f 6c6f 6361 7469 6f6e 203d 2061 7574  n_location = aut
-000b80f0: 686f 7269 7479 5f76 6965 772e 6669 6e64  hority_view.find
-000b8100: 2827 3a27 293b 0a20 2020 2020 2020 2020  (':');.         
-000b8110: 2020 2020 2070 6173 7377 6f72 645f 746f       password_to
-000b8120: 6b65 6e5f 7365 656e 203d 0a20 2020 2020  ken_seen =.     
-000b8130: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-000b8140: 7377 6f72 645f 746f 6b65 6e5f 6c6f 6361  sword_token_loca
-000b8150: 7469 6f6e 2021 3d20 7374 643a 3a73 7472  tion != std::str
-000b8160: 696e 675f 7669 6577 3a3a 6e70 6f73 3b0a  ing_view::npos;.
-000b8170: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
-000b8180: 6620 2821 7061 7373 776f 7264 5f74 6f6b  f (!password_tok
-000b8190: 656e 5f73 6565 6e29 207b 0a20 2020 2020  en_seen) {.     
-000b81a0: 2020 2020 2020 2020 2020 2069 6620 636f             if co
-000b81b0: 6e73 7465 7870 7220 2872 6573 756c 745f  nstexpr (result_
-000b81c0: 7479 7065 5f69 735f 6164 615f 7572 6c29  type_is_ada_url)
-000b81d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000b81e0: 2020 2020 2075 726c 2e75 7365 726e 616d       url.usernam
-000b81f0: 6520 2b3d 2075 6e69 636f 6465 3a3a 7065  e += unicode::pe
-000b8200: 7263 656e 745f 656e 636f 6465 280a 2020  rcent_encode(.  
-000b8210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b8220: 2020 2020 6175 7468 6f72 6974 795f 7669      authority_vi
-000b8230: 6577 2c20 6368 6172 6163 7465 725f 7365  ew, character_se
-000b8240: 7473 3a3a 5553 4552 494e 464f 5f50 4552  ts::USERINFO_PER
-000b8250: 4345 4e54 5f45 4e43 4f44 4529 3b0a 2020  CENT_ENCODE);.  
-000b8260: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-000b8270: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-000b8280: 2020 2020 2020 2020 2075 726c 2e61 7070           url.app
-000b8290: 656e 645f 6261 7365 5f75 7365 726e 616d  end_base_usernam
-000b82a0: 6528 756e 6963 6f64 653a 3a70 6572 6365  e(unicode::perce
-000b82b0: 6e74 5f65 6e63 6f64 6528 0a20 2020 2020  nt_encode(.     
-000b82c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b82d0: 2061 7574 686f 7269 7479 5f76 6965 772c   authority_view,
-000b82e0: 2063 6861 7261 6374 6572 5f73 6574 733a   character_sets:
-000b82f0: 3a55 5345 5249 4e46 4f5f 5045 5243 454e  :USERINFO_PERCEN
-000b8300: 545f 454e 434f 4445 2929 3b0a 2020 2020  T_ENCODE));.    
-000b8310: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000b8320: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-000b8330: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-000b8340: 2020 2020 2069 6620 636f 6e73 7465 7870       if constexp
-000b8350: 7220 2872 6573 756c 745f 7479 7065 5f69  r (result_type_i
-000b8360: 735f 6164 615f 7572 6c29 207b 0a20 2020  s_ada_url) {.   
-000b8370: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000b8380: 726c 2e75 7365 726e 616d 6520 2b3d 2075  rl.username += u
-000b8390: 6e69 636f 6465 3a3a 7065 7263 656e 745f  nicode::percent_
-000b83a0: 656e 636f 6465 280a 2020 2020 2020 2020  encode(.        
-000b83b0: 2020 2020 2020 2020 2020 2020 2020 6175                au
-000b83c0: 7468 6f72 6974 795f 7669 6577 2e73 7562  thority_view.sub
-000b83d0: 7374 7228 302c 2070 6173 7377 6f72 645f  str(0, password_
-000b83e0: 746f 6b65 6e5f 6c6f 6361 7469 6f6e 292c  token_location),
-000b83f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b8400: 2020 2020 2020 2063 6861 7261 6374 6572         character
-000b8410: 5f73 6574 733a 3a55 5345 5249 4e46 4f5f  _sets::USERINFO_
-000b8420: 5045 5243 454e 545f 454e 434f 4445 293b  PERCENT_ENCODE);
-000b8430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b8440: 2020 2075 726c 2e70 6173 7377 6f72 6420     url.password 
-000b8450: 2b3d 2075 6e69 636f 6465 3a3a 7065 7263  += unicode::perc
-000b8460: 656e 745f 656e 636f 6465 280a 2020 2020  ent_encode(.    
-000b8470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b8480: 2020 6175 7468 6f72 6974 795f 7669 6577    authority_view
-000b8490: 2e73 7562 7374 7228 7061 7373 776f 7264  .substr(password
-000b84a0: 5f74 6f6b 656e 5f6c 6f63 6174 696f 6e20  _token_location 
-000b84b0: 2b20 3129 2c0a 2020 2020 2020 2020 2020  + 1),.          
-000b84c0: 2020 2020 2020 2020 2020 2020 6368 6172              char
-000b84d0: 6163 7465 725f 7365 7473 3a3a 5553 4552  acter_sets::USER
-000b84e0: 494e 464f 5f50 4552 4345 4e54 5f45 4e43  INFO_PERCENT_ENC
-000b84f0: 4f44 4529 3b0a 2020 2020 2020 2020 2020  ODE);.          
-000b8500: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+000b3010: 2626 0a20 2020 2020 2020 2020 2028 7265  &&.          (re
+000b3020: 7375 6c74 2d3e 7479 7065 203d 3d20 7363  sult->type == sc
+000b3030: 6865 6d65 3a3a 4854 5450 207c 7c20 7265  heme::HTTP || re
+000b3040: 7375 6c74 2d3e 7479 7065 203d 3d20 7363  sult->type == sc
+000b3050: 6865 6d65 3a3a 4854 5450 5329 2920 7b0a  heme::HTTPS)) {.
+000b3060: 2020 2020 2020 2020 2f2f 2049 6620 7061          // If pa
+000b3070: 7468 5552 4ce2 8099 7320 7363 6865 6d65  thURL...s scheme
+000b3080: 2069 7320 6e6f 7420 2268 7474 7022 2061   is not "http" a
+000b3090: 6e64 206e 6f74 2022 6874 7470 7322 2c20  nd not "https", 
+000b30a0: 7468 656e 2072 6574 7572 6e20 610a 2020  then return a.  
+000b30b0: 2020 2020 2020 2f2f 206e 6577 206f 7061        // new opa
+000b30c0: 7175 6520 6f72 6967 696e 2e0a 2020 2020  que origin..    
+000b30d0: 2020 2020 7265 7475 726e 2061 6461 3a3a      return ada::
+000b30e0: 6865 6c70 6572 733a 3a63 6f6e 6361 7428  helpers::concat(
+000b30f0: 7265 7375 6c74 2d3e 6765 745f 7072 6f74  result->get_prot
+000b3100: 6f63 6f6c 2829 2c20 222f 2f22 2c0a 2020  ocol(), "//",.  
+000b3110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3130: 2020 7265 7375 6c74 2d3e 6765 745f 686f    result->get_ho
+000b3140: 7374 2829 293b 0a20 2020 2020 207d 0a20  st());.      }. 
+000b3150: 2020 207d 0a20 207d 0a0a 2020 2f2f 2052     }.  }..  // R
+000b3160: 6574 7572 6e20 6120 6e65 7720 6f70 6171  eturn a new opaq
+000b3170: 7565 206f 7269 6769 6e2e 0a20 2072 6574  ue origin..  ret
+000b3180: 7572 6e20 226e 756c 6c22 3b0a 7d0a 0a5b  urn "null";.}..[
+000b3190: 5b6e 6f64 6973 6361 7264 5d5d 2073 7464  [nodiscard]] std
+000b31a0: 3a3a 7374 7269 6e67 2075 726c 3a3a 6765  ::string url::ge
+000b31b0: 745f 7072 6f74 6f63 6f6c 2829 2063 6f6e  t_protocol() con
+000b31c0: 7374 206e 6f65 7863 6570 7420 7b0a 2020  st noexcept {.  
+000b31d0: 6966 2028 6973 5f73 7065 6369 616c 2829  if (is_special()
+000b31e0: 2920 7b0a 2020 2020 7265 7475 726e 2068  ) {.    return h
+000b31f0: 656c 7065 7273 3a3a 636f 6e63 6174 2861  elpers::concat(a
+000b3200: 6461 3a3a 7363 6865 6d65 3a3a 6465 7461  da::scheme::deta
+000b3210: 696c 733a 3a69 735f 7370 6563 6961 6c5f  ils::is_special_
+000b3220: 6c69 7374 5b74 7970 655d 2c20 223a 2229  list[type], ":")
+000b3230: 3b0a 2020 7d0a 2020 2f2f 2057 6520 6f6e  ;.  }.  // We on
+000b3240: 6c79 206d 6f76 6520 7468 6520 2773 6368  ly move the 'sch
+000b3250: 656d 6527 2069 6620 6974 2069 7320 6e6f  eme' if it is no
+000b3260: 6e2d 7370 6563 6961 6c2e 0a20 2072 6574  n-special..  ret
+000b3270: 7572 6e20 6865 6c70 6572 733a 3a63 6f6e  urn helpers::con
+000b3280: 6361 7428 6e6f 6e5f 7370 6563 6961 6c5f  cat(non_special_
+000b3290: 7363 6865 6d65 2c20 223a 2229 3b0a 7d0a  scheme, ":");.}.
+000b32a0: 0a5b 5b6e 6f64 6973 6361 7264 5d5d 2073  .[[nodiscard]] s
+000b32b0: 7464 3a3a 7374 7269 6e67 2075 726c 3a3a  td::string url::
+000b32c0: 6765 745f 686f 7374 2829 2063 6f6e 7374  get_host() const
+000b32d0: 206e 6f65 7863 6570 7420 7b0a 2020 2f2f   noexcept {.  //
+000b32e0: 2049 6620 7572 6ce2 8099 7320 686f 7374   If url...s host
+000b32f0: 2069 7320 6e75 6c6c 2c20 7468 656e 2072   is null, then r
+000b3300: 6574 7572 6e20 7468 6520 656d 7074 7920  eturn the empty 
+000b3310: 7374 7269 6e67 2e0a 2020 2f2f 2049 6620  string..  // If 
+000b3320: 7572 6ce2 8099 7320 706f 7274 2069 7320  url...s port is 
+000b3330: 6e75 6c6c 2c20 7265 7475 726e 2075 726c  null, return url
+000b3340: e280 9973 2068 6f73 742c 2073 6572 6961  ...s host, seria
+000b3350: 6c69 7a65 642e 0a20 202f 2f20 5265 7475  lized..  // Retu
+000b3360: 726e 2075 726c e280 9973 2068 6f73 742c  rn url...s host,
+000b3370: 2073 6572 6961 6c69 7a65 642c 2066 6f6c   serialized, fol
+000b3380: 6c6f 7765 6420 6279 2055 2b30 3033 4120  lowed by U+003A 
+000b3390: 283a 2920 616e 6420 7572 6ce2 8099 7320  (:) and url...s 
+000b33a0: 706f 7274 2c0a 2020 2f2f 2073 6572 6961  port,.  // seria
+000b33b0: 6c69 7a65 642e 0a20 2069 6620 2821 686f  lized..  if (!ho
+000b33c0: 7374 2e68 6173 5f76 616c 7565 2829 2920  st.has_value()) 
+000b33d0: 7b0a 2020 2020 7265 7475 726e 2022 223b  {.    return "";
+000b33e0: 0a20 207d 0a20 2069 6620 2870 6f72 742e  .  }.  if (port.
+000b33f0: 6861 735f 7661 6c75 6528 2929 207b 0a20  has_value()) {. 
+000b3400: 2020 2072 6574 7572 6e20 686f 7374 2e76     return host.v
+000b3410: 616c 7565 2829 202b 2022 3a22 202b 2067  alue() + ":" + g
+000b3420: 6574 5f70 6f72 7428 293b 0a20 207d 0a20  et_port();.  }. 
+000b3430: 2072 6574 7572 6e20 686f 7374 2e76 616c   return host.val
+000b3440: 7565 2829 3b0a 7d0a 0a5b 5b6e 6f64 6973  ue();.}..[[nodis
+000b3450: 6361 7264 5d5d 2073 7464 3a3a 7374 7269  card]] std::stri
+000b3460: 6e67 2075 726c 3a3a 6765 745f 686f 7374  ng url::get_host
+000b3470: 6e61 6d65 2829 2063 6f6e 7374 206e 6f65  name() const noe
+000b3480: 7863 6570 7420 7b0a 2020 7265 7475 726e  xcept {.  return
+000b3490: 2068 6f73 742e 7661 6c75 655f 6f72 2822   host.value_or("
+000b34a0: 2229 3b0a 7d0a 0a5b 5b6e 6f64 6973 6361  ");.}..[[nodisca
+000b34b0: 7264 5d5d 2063 6f6e 7374 2073 7464 3a3a  rd]] const std::
+000b34c0: 7374 7269 6e67 5f76 6965 7720 7572 6c3a  string_view url:
+000b34d0: 3a67 6574 5f70 6174 686e 616d 6528 2920  :get_pathname() 
+000b34e0: 636f 6e73 7420 6e6f 6578 6365 7074 207b  const noexcept {
+000b34f0: 0a20 2072 6574 7572 6e20 7061 7468 3b0a  .  return path;.
+000b3500: 7d0a 0a5b 5b6e 6f64 6973 6361 7264 5d5d  }..[[nodiscard]]
+000b3510: 2073 7464 3a3a 7374 7269 6e67 2075 726c   std::string url
+000b3520: 3a3a 6765 745f 7365 6172 6368 2829 2063  ::get_search() c
+000b3530: 6f6e 7374 206e 6f65 7863 6570 7420 7b0a  onst noexcept {.
+000b3540: 2020 2f2f 2049 6620 7468 6973 e280 9973    // If this...s
+000b3550: 2055 524c e280 9973 2071 7565 7279 2069   URL...s query i
+000b3560: 7320 6569 7468 6572 206e 756c 6c20 6f72  s either null or
+000b3570: 2074 6865 2065 6d70 7479 2073 7472 696e   the empty strin
+000b3580: 672c 2074 6865 6e20 7265 7475 726e 2074  g, then return t
+000b3590: 6865 0a20 202f 2f20 656d 7074 7920 7374  he.  // empty st
+000b35a0: 7269 6e67 2e20 5265 7475 726e 2055 2b30  ring. Return U+0
+000b35b0: 3033 4620 283f 292c 2066 6f6c 6c6f 7765  03F (?), followe
+000b35c0: 6420 6279 2074 6869 73e2 8099 7320 5552  d by this...s UR
+000b35d0: 4ce2 8099 7320 7175 6572 792e 0a20 2072  L...s query..  r
+000b35e0: 6574 7572 6e20 2821 7175 6572 792e 6861  eturn (!query.ha
+000b35f0: 735f 7661 6c75 6528 2920 7c7c 2028 7175  s_value() || (qu
+000b3600: 6572 792e 7661 6c75 6528 292e 656d 7074  ery.value().empt
+000b3610: 7928 2929 2920 3f20 2222 0a20 2020 2020  y())) ? "".     
+000b3620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3650: 2020 2020 3a20 223f 2220 2b20 7175 6572      : "?" + quer
+000b3660: 792e 7661 6c75 6528 293b 0a7d 0a0a 5b5b  y.value();.}..[[
+000b3670: 6e6f 6469 7363 6172 645d 5d20 636f 6e73  nodiscard]] cons
+000b3680: 7420 7374 643a 3a73 7472 696e 6726 2075  t std::string& u
+000b3690: 726c 3a3a 6765 745f 7573 6572 6e61 6d65  rl::get_username
+000b36a0: 2829 2063 6f6e 7374 206e 6f65 7863 6570  () const noexcep
+000b36b0: 7420 7b0a 2020 7265 7475 726e 2075 7365  t {.  return use
+000b36c0: 726e 616d 653b 0a7d 0a0a 5b5b 6e6f 6469  rname;.}..[[nodi
+000b36d0: 7363 6172 645d 5d20 636f 6e73 7420 7374  scard]] const st
+000b36e0: 643a 3a73 7472 696e 6726 2075 726c 3a3a  d::string& url::
+000b36f0: 6765 745f 7061 7373 776f 7264 2829 2063  get_password() c
+000b3700: 6f6e 7374 206e 6f65 7863 6570 7420 7b0a  onst noexcept {.
+000b3710: 2020 7265 7475 726e 2070 6173 7377 6f72    return passwor
+000b3720: 643b 0a7d 0a0a 5b5b 6e6f 6469 7363 6172  d;.}..[[nodiscar
+000b3730: 645d 5d20 7374 643a 3a73 7472 696e 6720  d]] std::string 
+000b3740: 7572 6c3a 3a67 6574 5f70 6f72 7428 2920  url::get_port() 
+000b3750: 636f 6e73 7420 6e6f 6578 6365 7074 207b  const noexcept {
+000b3760: 0a20 2072 6574 7572 6e20 706f 7274 2e68  .  return port.h
+000b3770: 6173 5f76 616c 7565 2829 203f 2073 7464  as_value() ? std
+000b3780: 3a3a 746f 5f73 7472 696e 6728 706f 7274  ::to_string(port
+000b3790: 2e76 616c 7565 2829 2920 3a20 2222 3b0a  .value()) : "";.
+000b37a0: 7d0a 0a5b 5b6e 6f64 6973 6361 7264 5d5d  }..[[nodiscard]]
+000b37b0: 2073 7464 3a3a 7374 7269 6e67 2075 726c   std::string url
+000b37c0: 3a3a 6765 745f 6861 7368 2829 2063 6f6e  ::get_hash() con
+000b37d0: 7374 206e 6f65 7863 6570 7420 7b0a 2020  st noexcept {.  
+000b37e0: 2f2f 2049 6620 7468 6973 e280 9973 2055  // If this...s U
+000b37f0: 524c e280 9973 2066 7261 676d 656e 7420  RL...s fragment 
+000b3800: 6973 2065 6974 6865 7220 6e75 6c6c 206f  is either null o
+000b3810: 7220 7468 6520 656d 7074 7920 7374 7269  r the empty stri
+000b3820: 6e67 2c20 7468 656e 2072 6574 7572 6e0a  ng, then return.
+000b3830: 2020 2f2f 2074 6865 2065 6d70 7479 2073    // the empty s
+000b3840: 7472 696e 672e 2052 6574 7572 6e20 552b  tring. Return U+
+000b3850: 3030 3233 2028 2329 2c20 666f 6c6c 6f77  0023 (#), follow
+000b3860: 6564 2062 7920 7468 6973 e280 9973 2055  ed by this...s U
+000b3870: 524c e280 9973 2066 7261 676d 656e 742e  RL...s fragment.
+000b3880: 0a20 2072 6574 7572 6e20 2821 6861 7368  .  return (!hash
+000b3890: 2e68 6173 5f76 616c 7565 2829 207c 7c20  .has_value() || 
+000b38a0: 2868 6173 682e 7661 6c75 6528 292e 656d  (hash.value().em
+000b38b0: 7074 7928 2929 2920 3f20 2222 0a20 2020  pty())) ? "".   
+000b38c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b38d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b38e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b38f0: 2020 2020 3a20 2223 2220 2b20 6861 7368      : "#" + hash
+000b3900: 2e76 616c 7565 2829 3b0a 7d0a 0a7d 2020  .value();.}..}  
+000b3910: 2f2f 206e 616d 6573 7061 6365 2061 6461  // namespace ada
+000b3920: 0a2f 2a20 656e 6420 6669 6c65 2073 7263  ./* end file src
+000b3930: 2f75 726c 2d67 6574 7465 7273 2e63 7070  /url-getters.cpp
+000b3940: 202a 2f0a 2f2a 2062 6567 696e 2066 696c   */./* begin fil
+000b3950: 6520 7372 632f 7572 6c2d 7365 7474 6572  e src/url-setter
+000b3960: 732e 6370 7020 2a2f 0a2f 2a2a 0a20 2a20  s.cpp */./**. * 
+000b3970: 4066 696c 6520 7572 6c2d 7365 7474 6572  @file url-setter
+000b3980: 732e 6370 700a 202a 2049 6e63 6c75 6465  s.cpp. * Include
+000b3990: 7320 616c 6c20 7468 6520 7365 7474 6572  s all the setter
+000b39a0: 7320 6f66 2060 6164 613a 3a75 726c 600a  s of `ada::url`.
+000b39b0: 202a 2f0a 0a23 696e 636c 7564 6520 3c6f   */..#include <o
+000b39c0: 7074 696f 6e61 6c3e 0a23 696e 636c 7564  ptional>.#includ
+000b39d0: 6520 3c73 7472 696e 673e 0a0a 6e61 6d65  e <string>..name
+000b39e0: 7370 6163 6520 6164 6120 7b0a 0a74 656d  space ada {..tem
+000b39f0: 706c 6174 6520 3c62 6f6f 6c20 6f76 6572  plate <bool over
+000b3a00: 7269 6465 5f68 6f73 746e 616d 653e 0a62  ride_hostname>.b
+000b3a10: 6f6f 6c20 7572 6c3a 3a73 6574 5f68 6f73  ool url::set_hos
+000b3a20: 745f 6f72 5f68 6f73 746e 616d 6528 636f  t_or_hostname(co
+000b3a30: 6e73 7420 7374 643a 3a73 7472 696e 675f  nst std::string_
+000b3a40: 7669 6577 2069 6e70 7574 2920 7b0a 2020  view input) {.  
+000b3a50: 6966 2028 6861 735f 6f70 6171 7565 5f70  if (has_opaque_p
+000b3a60: 6174 6829 207b 0a20 2020 2072 6574 7572  ath) {.    retur
+000b3a70: 6e20 6661 6c73 653b 0a20 207d 0a0a 2020  n false;.  }..  
+000b3a80: 7374 643a 3a6f 7074 696f 6e61 6c3c 7374  std::optional<st
+000b3a90: 643a 3a73 7472 696e 673e 2070 7265 7669  d::string> previ
+000b3aa0: 6f75 735f 686f 7374 203d 2068 6f73 743b  ous_host = host;
+000b3ab0: 0a20 2073 7464 3a3a 6f70 7469 6f6e 616c  .  std::optional
+000b3ac0: 3c75 696e 7431 365f 743e 2070 7265 7669  <uint16_t> previ
+000b3ad0: 6f75 735f 706f 7274 203d 2070 6f72 743b  ous_port = port;
+000b3ae0: 0a0a 2020 7369 7a65 5f74 2068 6f73 745f  ..  size_t host_
+000b3af0: 656e 645f 706f 7320 3d20 696e 7075 742e  end_pos = input.
+000b3b00: 6669 6e64 2827 2327 293b 0a20 2073 7464  find('#');.  std
+000b3b10: 3a3a 7374 7269 6e67 205f 686f 7374 2869  ::string _host(i
+000b3b20: 6e70 7574 2e64 6174 6128 292c 2068 6f73  nput.data(), hos
+000b3b30: 745f 656e 645f 706f 7320 213d 2073 7464  t_end_pos != std
+000b3b40: 3a3a 7374 7269 6e67 5f76 6965 773a 3a6e  ::string_view::n
+000b3b50: 706f 730a 2020 2020 2020 2020 2020 2020  pos.            
+000b3b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3b70: 2020 2020 2020 2020 2020 3f20 686f 7374            ? host
+000b3b80: 5f65 6e64 5f70 6f73 0a20 2020 2020 2020  _end_pos.       
+000b3b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b3ba0: 2020 2020 2020 2020 2020 2020 2020 203a                 :
+000b3bb0: 2069 6e70 7574 2e73 697a 6528 2929 3b0a   input.size());.
+000b3bc0: 2020 6865 6c70 6572 733a 3a72 656d 6f76    helpers::remov
+000b3bd0: 655f 6173 6369 695f 7461 625f 6f72 5f6e  e_ascii_tab_or_n
+000b3be0: 6577 6c69 6e65 285f 686f 7374 293b 0a20  ewline(_host);. 
+000b3bf0: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000b3c00: 7720 6e65 775f 686f 7374 285f 686f 7374  w new_host(_host
+000b3c10: 293b 0a0a 2020 2f2f 2049 6620 7572 6c27  );..  // If url'
+000b3c20: 7320 7363 6865 6d65 2069 7320 2266 696c  s scheme is "fil
+000b3c30: 6522 2c20 7468 656e 2073 6574 2073 7461  e", then set sta
+000b3c40: 7465 2074 6f20 6669 6c65 2068 6f73 7420  te to file host 
+000b3c50: 7374 6174 652c 2069 6e73 7465 6164 206f  state, instead o
+000b3c60: 660a 2020 2f2f 2068 6f73 7420 7374 6174  f.  // host stat
+000b3c70: 652e 0a20 2069 6620 2874 7970 6520 213d  e..  if (type !=
+000b3c80: 2061 6461 3a3a 7363 6865 6d65 3a3a 7479   ada::scheme::ty
+000b3c90: 7065 3a3a 4649 4c45 2920 7b0a 2020 2020  pe::FILE) {.    
+000b3ca0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000b3cb0: 2068 6f73 745f 7669 6577 285f 686f 7374   host_view(_host
+000b3cc0: 2e64 6174 6128 292c 205f 686f 7374 2e6c  .data(), _host.l
+000b3cd0: 656e 6774 6828 2929 3b0a 2020 2020 6175  ength());.    au
+000b3ce0: 746f 205b 6c6f 6361 7469 6f6e 2c20 666f  to [location, fo
+000b3cf0: 756e 645f 636f 6c6f 6e5d 203d 0a20 2020  und_colon] =.   
+000b3d00: 2020 2020 2068 656c 7065 7273 3a3a 6765       helpers::ge
+000b3d10: 745f 686f 7374 5f64 656c 696d 6974 6572  t_host_delimiter
+000b3d20: 5f6c 6f63 6174 696f 6e28 6973 5f73 7065  _location(is_spe
+000b3d30: 6369 616c 2829 2c20 686f 7374 5f76 6965  cial(), host_vie
+000b3d40: 7729 3b0a 0a20 2020 202f 2f20 4f74 6865  w);..    // Othe
+000b3d50: 7277 6973 652c 2069 6620 6320 6973 2055  rwise, if c is U
+000b3d60: 2b30 3033 4120 283a 2920 616e 6420 696e  +003A (:) and in
+000b3d70: 7369 6465 4272 6163 6b65 7473 2069 7320  sideBrackets is 
+000b3d80: 6661 6c73 652c 2074 6865 6e3a 0a20 2020  false, then:.   
+000b3d90: 202f 2f20 4e6f 7465 3a20 7468 6520 2766   // Note: the 'f
+000b3da0: 6f75 6e64 5f63 6f6c 6f6e 2720 7661 6c75  ound_colon' valu
+000b3db0: 6520 6973 2074 7275 6520 6966 2061 6e64  e is true if and
+000b3dc0: 206f 6e6c 7920 6966 2061 2063 6f6c 6f6e   only if a colon
+000b3dd0: 2077 6173 0a20 2020 202f 2f20 656e 636f   was.    // enco
+000b3de0: 756e 7465 7265 6420 7768 696c 6520 6e6f  untered while no
+000b3df0: 7420 696e 7369 6465 2062 7261 636b 6574  t inside bracket
+000b3e00: 732e 0a20 2020 2069 6620 2866 6f75 6e64  s..    if (found
+000b3e10: 5f63 6f6c 6f6e 2920 7b0a 2020 2020 2020  _colon) {.      
+000b3e20: 6966 2028 6f76 6572 7269 6465 5f68 6f73  if (override_hos
+000b3e30: 746e 616d 6529 207b 0a20 2020 2020 2020  tname) {.       
+000b3e40: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
+000b3e50: 2020 2020 207d 0a20 2020 2020 2073 7464       }.      std
+000b3e60: 3a3a 7374 7269 6e67 5f76 6965 7720 6275  ::string_view bu
+000b3e70: 6666 6572 203d 206e 6577 5f68 6f73 742e  ffer = new_host.
+000b3e80: 7375 6273 7472 286c 6f63 6174 696f 6e20  substr(location 
+000b3e90: 2b20 3129 3b0a 2020 2020 2020 6966 2028  + 1);.      if (
+000b3ea0: 2162 7566 6665 722e 656d 7074 7928 2929  !buffer.empty())
+000b3eb0: 207b 0a20 2020 2020 2020 2073 6574 5f70   {.        set_p
+000b3ec0: 6f72 7428 6275 6666 6572 293b 0a20 2020  ort(buffer);.   
+000b3ed0: 2020 207d 0a20 2020 207d 0a20 2020 202f     }.    }.    /
+000b3ee0: 2f20 4966 2075 726c 2069 7320 7370 6563  / If url is spec
+000b3ef0: 6961 6c20 616e 6420 686f 7374 5f76 6965  ial and host_vie
+000b3f00: 7720 6973 2074 6865 2065 6d70 7479 2073  w is the empty s
+000b3f10: 7472 696e 672c 2076 616c 6964 6174 696f  tring, validatio
+000b3f20: 6e20 6572 726f 722c 0a20 2020 202f 2f20  n error,.    // 
+000b3f30: 7265 7475 726e 2066 6169 6c75 7265 2e20  return failure. 
+000b3f40: 4f74 6865 7277 6973 652c 2069 6620 7374  Otherwise, if st
+000b3f50: 6174 6520 6f76 6572 7269 6465 2069 7320  ate override is 
+000b3f60: 6769 7665 6e2c 2068 6f73 745f 7669 6577  given, host_view
+000b3f70: 2069 7320 7468 650a 2020 2020 2f2f 2065   is the.    // e
+000b3f80: 6d70 7479 2073 7472 696e 672c 2061 6e64  mpty string, and
+000b3f90: 2065 6974 6865 7220 7572 6c20 696e 636c   either url incl
+000b3fa0: 7564 6573 2063 7265 6465 6e74 6961 6c73  udes credentials
+000b3fb0: 206f 7220 7572 6ce2 8099 7320 706f 7274   or url...s port
+000b3fc0: 2069 730a 2020 2020 2f2f 206e 6f6e 2d6e   is.    // non-n
+000b3fd0: 756c 6c2c 2072 6574 7572 6e2e 0a20 2020  ull, return..   
+000b3fe0: 2065 6c73 6520 6966 2028 686f 7374 5f76   else if (host_v
+000b3ff0: 6965 772e 656d 7074 7928 2920 2626 0a20  iew.empty() &&. 
+000b4000: 2020 2020 2020 2020 2020 2020 2869 735f              (is_
+000b4010: 7370 6563 6961 6c28 2920 7c7c 2068 6173  special() || has
+000b4020: 5f63 7265 6465 6e74 6961 6c73 2829 207c  _credentials() |
+000b4030: 7c20 706f 7274 2e68 6173 5f76 616c 7565  | port.has_value
+000b4040: 2829 2929 207b 0a20 2020 2020 2072 6574  ())) {.      ret
+000b4050: 7572 6e20 6661 6c73 653b 0a20 2020 207d  urn false;.    }
+000b4060: 0a0a 2020 2020 2f2f 204c 6574 2068 6f73  ..    // Let hos
+000b4070: 7420 6265 2074 6865 2072 6573 756c 7420  t be the result 
+000b4080: 6f66 2068 6f73 7420 7061 7273 696e 6720  of host parsing 
+000b4090: 686f 7374 5f76 6965 7720 7769 7468 2075  host_view with u
+000b40a0: 726c 2069 7320 6e6f 7420 7370 6563 6961  rl is not specia
+000b40b0: 6c2e 0a20 2020 2069 6620 2868 6f73 745f  l..    if (host_
+000b40c0: 7669 6577 2e65 6d70 7479 2829 2920 7b0a  view.empty()) {.
+000b40d0: 2020 2020 2020 686f 7374 203d 2022 223b        host = "";
+000b40e0: 0a20 2020 2020 2072 6574 7572 6e20 7472  .      return tr
+000b40f0: 7565 3b0a 2020 2020 7d0a 0a20 2020 2062  ue;.    }..    b
+000b4100: 6f6f 6c20 7375 6363 6565 6465 6420 3d20  ool succeeded = 
+000b4110: 7061 7273 655f 686f 7374 2868 6f73 745f  parse_host(host_
+000b4120: 7669 6577 293b 0a20 2020 2069 6620 2821  view);.    if (!
+000b4130: 7375 6363 6565 6465 6429 207b 0a20 2020  succeeded) {.   
+000b4140: 2020 2068 6f73 7420 3d20 7072 6576 696f     host = previo
+000b4150: 7573 5f68 6f73 743b 0a20 2020 2020 2075  us_host;.      u
+000b4160: 7064 6174 655f 6261 7365 5f70 6f72 7428  pdate_base_port(
+000b4170: 7072 6576 696f 7573 5f70 6f72 7429 3b0a  previous_port);.
+000b4180: 2020 2020 7d0a 2020 2020 7265 7475 726e      }.    return
+000b4190: 2073 7563 6365 6564 6564 3b0a 2020 7d0a   succeeded;.  }.
+000b41a0: 0a20 2073 697a 655f 7420 6c6f 6361 7469  .  size_t locati
+000b41b0: 6f6e 203d 206e 6577 5f68 6f73 742e 6669  on = new_host.fi
+000b41c0: 6e64 5f66 6972 7374 5f6f 6628 222f 5c5c  nd_first_of("/\\
+000b41d0: 3f22 293b 0a20 2069 6620 286c 6f63 6174  ?");.  if (locat
+000b41e0: 696f 6e20 213d 2073 7464 3a3a 7374 7269  ion != std::stri
+000b41f0: 6e67 5f76 6965 773a 3a6e 706f 7329 207b  ng_view::npos) {
+000b4200: 0a20 2020 206e 6577 5f68 6f73 742e 7265  .    new_host.re
+000b4210: 6d6f 7665 5f73 7566 6669 7828 6e65 775f  move_suffix(new_
+000b4220: 686f 7374 2e6c 656e 6774 6828 2920 2d20  host.length() - 
+000b4230: 6c6f 6361 7469 6f6e 293b 0a20 207d 0a0a  location);.  }..
+000b4240: 2020 6966 2028 6e65 775f 686f 7374 2e65    if (new_host.e
+000b4250: 6d70 7479 2829 2920 7b0a 2020 2020 2f2f  mpty()) {.    //
+000b4260: 2053 6574 2075 726c e280 9973 2068 6f73   Set url...s hos
+000b4270: 7420 746f 2074 6865 2065 6d70 7479 2073  t to the empty s
+000b4280: 7472 696e 672e 0a20 2020 2068 6f73 7420  tring..    host 
+000b4290: 3d20 2222 3b0a 2020 7d20 656c 7365 207b  = "";.  } else {
+000b42a0: 0a20 2020 202f 2f20 4c65 7420 686f 7374  .    // Let host
+000b42b0: 2062 6520 7468 6520 7265 7375 6c74 206f   be the result o
+000b42c0: 6620 686f 7374 2070 6172 7369 6e67 2062  f host parsing b
+000b42d0: 7566 6665 7220 7769 7468 2075 726c 2069  uffer with url i
+000b42e0: 7320 6e6f 7420 7370 6563 6961 6c2e 0a20  s not special.. 
+000b42f0: 2020 2069 6620 2821 7061 7273 655f 686f     if (!parse_ho
+000b4300: 7374 286e 6577 5f68 6f73 7429 2920 7b0a  st(new_host)) {.
+000b4310: 2020 2020 2020 686f 7374 203d 2070 7265        host = pre
+000b4320: 7669 6f75 735f 686f 7374 3b0a 2020 2020  vious_host;.    
+000b4330: 2020 7570 6461 7465 5f62 6173 655f 706f    update_base_po
+000b4340: 7274 2870 7265 7669 6f75 735f 706f 7274  rt(previous_port
+000b4350: 293b 0a20 2020 2020 2072 6574 7572 6e20  );.      return 
+000b4360: 6661 6c73 653b 0a20 2020 207d 0a0a 2020  false;.    }..  
+000b4370: 2020 2f2f 2049 6620 686f 7374 2069 7320    // If host is 
+000b4380: 226c 6f63 616c 686f 7374 222c 2074 6865  "localhost", the
+000b4390: 6e20 7365 7420 686f 7374 2074 6f20 7468  n set host to th
+000b43a0: 6520 656d 7074 7920 7374 7269 6e67 2e0a  e empty string..
+000b43b0: 2020 2020 6966 2028 686f 7374 2e68 6173      if (host.has
+000b43c0: 5f76 616c 7565 2829 2026 2620 686f 7374  _value() && host
+000b43d0: 2e76 616c 7565 2829 203d 3d20 226c 6f63  .value() == "loc
+000b43e0: 616c 686f 7374 2229 207b 0a20 2020 2020  alhost") {.     
+000b43f0: 2068 6f73 7420 3d20 2222 3b0a 2020 2020   host = "";.    
+000b4400: 7d0a 2020 7d0a 2020 7265 7475 726e 2074  }.  }.  return t
+000b4410: 7275 653b 0a7d 0a0a 626f 6f6c 2075 726c  rue;.}..bool url
+000b4420: 3a3a 7365 745f 686f 7374 2863 6f6e 7374  ::set_host(const
+000b4430: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000b4440: 7720 696e 7075 7429 207b 0a20 2072 6574  w input) {.  ret
+000b4450: 7572 6e20 7365 745f 686f 7374 5f6f 725f  urn set_host_or_
+000b4460: 686f 7374 6e61 6d65 3c66 616c 7365 3e28  hostname<false>(
+000b4470: 696e 7075 7429 3b0a 7d0a 0a62 6f6f 6c20  input);.}..bool 
+000b4480: 7572 6c3a 3a73 6574 5f68 6f73 746e 616d  url::set_hostnam
+000b4490: 6528 636f 6e73 7420 7374 643a 3a73 7472  e(const std::str
+000b44a0: 696e 675f 7669 6577 2069 6e70 7574 2920  ing_view input) 
+000b44b0: 7b0a 2020 7265 7475 726e 2073 6574 5f68  {.  return set_h
+000b44c0: 6f73 745f 6f72 5f68 6f73 746e 616d 653c  ost_or_hostname<
+000b44d0: 7472 7565 3e28 696e 7075 7429 3b0a 7d0a  true>(input);.}.
+000b44e0: 0a62 6f6f 6c20 7572 6c3a 3a73 6574 5f75  .bool url::set_u
+000b44f0: 7365 726e 616d 6528 636f 6e73 7420 7374  sername(const st
+000b4500: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
+000b4510: 6e70 7574 2920 7b0a 2020 6966 2028 6361  nput) {.  if (ca
+000b4520: 6e6e 6f74 5f68 6176 655f 6372 6564 656e  nnot_have_creden
+000b4530: 7469 616c 735f 6f72 5f70 6f72 7428 2929  tials_or_port())
+000b4540: 207b 0a20 2020 2072 6574 7572 6e20 6661   {.    return fa
+000b4550: 6c73 653b 0a20 207d 0a20 2075 7365 726e  lse;.  }.  usern
+000b4560: 616d 6520 3d20 6164 613a 3a75 6e69 636f  ame = ada::unico
+000b4570: 6465 3a3a 7065 7263 656e 745f 656e 636f  de::percent_enco
+000b4580: 6465 280a 2020 2020 2020 696e 7075 742c  de(.      input,
+000b4590: 2063 6861 7261 6374 6572 5f73 6574 733a   character_sets:
+000b45a0: 3a55 5345 5249 4e46 4f5f 5045 5243 454e  :USERINFO_PERCEN
+000b45b0: 545f 454e 434f 4445 293b 0a20 2072 6574  T_ENCODE);.  ret
+000b45c0: 7572 6e20 7472 7565 3b0a 7d0a 0a62 6f6f  urn true;.}..boo
+000b45d0: 6c20 7572 6c3a 3a73 6574 5f70 6173 7377  l url::set_passw
+000b45e0: 6f72 6428 636f 6e73 7420 7374 643a 3a73  ord(const std::s
+000b45f0: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
+000b4600: 2920 7b0a 2020 6966 2028 6361 6e6e 6f74  ) {.  if (cannot
+000b4610: 5f68 6176 655f 6372 6564 656e 7469 616c  _have_credential
+000b4620: 735f 6f72 5f70 6f72 7428 2929 207b 0a20  s_or_port()) {. 
+000b4630: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
+000b4640: 0a20 207d 0a20 2070 6173 7377 6f72 6420  .  }.  password 
+000b4650: 3d20 6164 613a 3a75 6e69 636f 6465 3a3a  = ada::unicode::
+000b4660: 7065 7263 656e 745f 656e 636f 6465 280a  percent_encode(.
+000b4670: 2020 2020 2020 696e 7075 742c 2063 6861        input, cha
+000b4680: 7261 6374 6572 5f73 6574 733a 3a55 5345  racter_sets::USE
+000b4690: 5249 4e46 4f5f 5045 5243 454e 545f 454e  RINFO_PERCENT_EN
+000b46a0: 434f 4445 293b 0a20 2072 6574 7572 6e20  CODE);.  return 
+000b46b0: 7472 7565 3b0a 7d0a 0a62 6f6f 6c20 7572  true;.}..bool ur
+000b46c0: 6c3a 3a73 6574 5f70 6f72 7428 636f 6e73  l::set_port(cons
+000b46d0: 7420 7374 643a 3a73 7472 696e 675f 7669  t std::string_vi
+000b46e0: 6577 2069 6e70 7574 2920 7b0a 2020 6966  ew input) {.  if
+000b46f0: 2028 6361 6e6e 6f74 5f68 6176 655f 6372   (cannot_have_cr
+000b4700: 6564 656e 7469 616c 735f 6f72 5f70 6f72  edentials_or_por
+000b4710: 7428 2929 207b 0a20 2020 2072 6574 7572  t()) {.    retur
+000b4720: 6e20 6661 6c73 653b 0a20 207d 0a20 2073  n false;.  }.  s
+000b4730: 7464 3a3a 7374 7269 6e67 2074 7269 6d6d  td::string trimm
+000b4740: 6564 2869 6e70 7574 293b 0a20 2068 656c  ed(input);.  hel
+000b4750: 7065 7273 3a3a 7265 6d6f 7665 5f61 7363  pers::remove_asc
+000b4760: 6969 5f74 6162 5f6f 725f 6e65 776c 696e  ii_tab_or_newlin
+000b4770: 6528 7472 696d 6d65 6429 3b0a 2020 6966  e(trimmed);.  if
+000b4780: 2028 7472 696d 6d65 642e 656d 7074 7928   (trimmed.empty(
+000b4790: 2929 207b 0a20 2020 2070 6f72 7420 3d20  )) {.    port = 
+000b47a0: 7374 643a 3a6e 756c 6c6f 7074 3b0a 2020  std::nullopt;.  
+000b47b0: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
+000b47c0: 207d 0a20 202f 2f20 496e 7075 7420 7368   }.  // Input sh
+000b47d0: 6f75 6c64 206e 6f74 2073 7461 7274 2077  ould not start w
+000b47e0: 6974 6820 636f 6e74 726f 6c20 6368 6172  ith control char
+000b47f0: 6163 7465 7273 2e0a 2020 6966 2028 6164  acters..  if (ad
+000b4800: 613a 3a75 6e69 636f 6465 3a3a 6973 5f63  a::unicode::is_c
+000b4810: 305f 636f 6e74 726f 6c5f 6f72 5f73 7061  0_control_or_spa
+000b4820: 6365 2874 7269 6d6d 6564 2e66 726f 6e74  ce(trimmed.front
+000b4830: 2829 2929 207b 0a20 2020 2072 6574 7572  ())) {.    retur
+000b4840: 6e20 6661 6c73 653b 0a20 207d 0a20 202f  n false;.  }.  /
+000b4850: 2f20 496e 7075 7420 7368 6f75 6c64 2063  / Input should c
+000b4860: 6f6e 7461 696e 2061 7420 6c65 6173 7420  ontain at least 
+000b4870: 6f6e 6520 6173 6369 6920 6469 6769 742e  one ascii digit.
+000b4880: 0a20 2069 6620 2869 6e70 7574 2e66 696e  .  if (input.fin
+000b4890: 645f 6669 7273 745f 6f66 2822 3031 3233  d_first_of("0123
+000b48a0: 3435 3637 3839 2229 203d 3d20 7374 643a  456789") == std:
+000b48b0: 3a73 7472 696e 675f 7669 6577 3a3a 6e70  :string_view::np
+000b48c0: 6f73 2920 7b0a 2020 2020 7265 7475 726e  os) {.    return
+000b48d0: 2066 616c 7365 3b0a 2020 7d0a 0a20 202f   false;.  }..  /
+000b48e0: 2f20 5265 7665 7274 2063 6861 6e67 6573  / Revert changes
+000b48f0: 2069 6620 7061 7273 655f 706f 7274 2066   if parse_port f
+000b4900: 6169 6c73 2e0a 2020 7374 643a 3a6f 7074  ails..  std::opt
+000b4910: 696f 6e61 6c3c 7569 6e74 3136 5f74 3e20  ional<uint16_t> 
+000b4920: 7072 6576 696f 7573 5f70 6f72 7420 3d20  previous_port = 
+000b4930: 706f 7274 3b0a 2020 7061 7273 655f 706f  port;.  parse_po
+000b4940: 7274 2874 7269 6d6d 6564 293b 0a20 2069  rt(trimmed);.  i
+000b4950: 6620 2869 735f 7661 6c69 6429 207b 0a20  f (is_valid) {. 
+000b4960: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
+000b4970: 2020 7d0a 2020 706f 7274 203d 2070 7265    }.  port = pre
+000b4980: 7669 6f75 735f 706f 7274 3b0a 2020 6973  vious_port;.  is
+000b4990: 5f76 616c 6964 203d 2074 7275 653b 0a20  _valid = true;. 
+000b49a0: 2072 6574 7572 6e20 6661 6c73 653b 0a7d   return false;.}
+000b49b0: 0a0a 766f 6964 2075 726c 3a3a 7365 745f  ..void url::set_
+000b49c0: 6861 7368 2863 6f6e 7374 2073 7464 3a3a  hash(const std::
+000b49d0: 7374 7269 6e67 5f76 6965 7720 696e 7075  string_view inpu
+000b49e0: 7429 207b 0a20 2069 6620 2869 6e70 7574  t) {.  if (input
+000b49f0: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000b4a00: 6861 7368 203d 2073 7464 3a3a 6e75 6c6c  hash = std::null
+000b4a10: 6f70 743b 0a20 2020 2068 656c 7065 7273  opt;.    helpers
+000b4a20: 3a3a 7374 7269 705f 7472 6169 6c69 6e67  ::strip_trailing
+000b4a30: 5f73 7061 6365 735f 6672 6f6d 5f6f 7061  _spaces_from_opa
+000b4a40: 7175 655f 7061 7468 282a 7468 6973 293b  que_path(*this);
+000b4a50: 0a20 2020 2072 6574 7572 6e3b 0a20 207d  .    return;.  }
+000b4a60: 0a0a 2020 7374 643a 3a73 7472 696e 6720  ..  std::string 
+000b4a70: 6e65 775f 7661 6c75 653b 0a20 206e 6577  new_value;.  new
+000b4a80: 5f76 616c 7565 203d 2069 6e70 7574 5b30  _value = input[0
+000b4a90: 5d20 3d3d 2027 2327 203f 2069 6e70 7574  ] == '#' ? input
+000b4aa0: 2e73 7562 7374 7228 3129 203a 2069 6e70  .substr(1) : inp
+000b4ab0: 7574 3b0a 2020 6865 6c70 6572 733a 3a72  ut;.  helpers::r
+000b4ac0: 656d 6f76 655f 6173 6369 695f 7461 625f  emove_ascii_tab_
+000b4ad0: 6f72 5f6e 6577 6c69 6e65 286e 6577 5f76  or_newline(new_v
+000b4ae0: 616c 7565 293b 0a20 2068 6173 6820 3d20  alue);.  hash = 
+000b4af0: 756e 6963 6f64 653a 3a70 6572 6365 6e74  unicode::percent
+000b4b00: 5f65 6e63 6f64 6528 6e65 775f 7661 6c75  _encode(new_valu
+000b4b10: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000b4b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b4b30: 2020 2020 6164 613a 3a63 6861 7261 6374      ada::charact
+000b4b40: 6572 5f73 6574 733a 3a46 5241 474d 454e  er_sets::FRAGMEN
+000b4b50: 545f 5045 5243 454e 545f 454e 434f 4445  T_PERCENT_ENCODE
+000b4b60: 293b 0a20 2072 6574 7572 6e3b 0a7d 0a0a  );.  return;.}..
+000b4b70: 766f 6964 2075 726c 3a3a 7365 745f 7365  void url::set_se
+000b4b80: 6172 6368 2863 6f6e 7374 2073 7464 3a3a  arch(const std::
+000b4b90: 7374 7269 6e67 5f76 6965 7720 696e 7075  string_view inpu
+000b4ba0: 7429 207b 0a20 2069 6620 2869 6e70 7574  t) {.  if (input
+000b4bb0: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000b4bc0: 7175 6572 7920 3d20 7374 643a 3a6e 756c  query = std::nul
+000b4bd0: 6c6f 7074 3b0a 2020 2020 6865 6c70 6572  lopt;.    helper
+000b4be0: 733a 3a73 7472 6970 5f74 7261 696c 696e  s::strip_trailin
+000b4bf0: 675f 7370 6163 6573 5f66 726f 6d5f 6f70  g_spaces_from_op
+000b4c00: 6171 7565 5f70 6174 6828 2a74 6869 7329  aque_path(*this)
+000b4c10: 3b0a 2020 2020 7265 7475 726e 3b0a 2020  ;.    return;.  
+000b4c20: 7d0a 0a20 2073 7464 3a3a 7374 7269 6e67  }..  std::string
+000b4c30: 206e 6577 5f76 616c 7565 3b0a 2020 6e65   new_value;.  ne
+000b4c40: 775f 7661 6c75 6520 3d20 696e 7075 745b  w_value = input[
+000b4c50: 305d 203d 3d20 273f 2720 3f20 696e 7075  0] == '?' ? inpu
+000b4c60: 742e 7375 6273 7472 2831 2920 3a20 696e  t.substr(1) : in
+000b4c70: 7075 743b 0a20 2068 656c 7065 7273 3a3a  put;.  helpers::
+000b4c80: 7265 6d6f 7665 5f61 7363 6969 5f74 6162  remove_ascii_tab
+000b4c90: 5f6f 725f 6e65 776c 696e 6528 6e65 775f  _or_newline(new_
+000b4ca0: 7661 6c75 6529 3b0a 0a20 2061 7574 6f20  value);..  auto 
+000b4cb0: 7175 6572 795f 7065 7263 656e 745f 656e  query_percent_en
+000b4cc0: 636f 6465 5f73 6574 203d 0a20 2020 2020  code_set =.     
+000b4cd0: 2069 735f 7370 6563 6961 6c28 2920 3f20   is_special() ? 
+000b4ce0: 6164 613a 3a63 6861 7261 6374 6572 5f73  ada::character_s
+000b4cf0: 6574 733a 3a53 5045 4349 414c 5f51 5545  ets::SPECIAL_QUE
+000b4d00: 5259 5f50 4552 4345 4e54 5f45 4e43 4f44  RY_PERCENT_ENCOD
+000b4d10: 450a 2020 2020 2020 2020 2020 2020 2020  E.              
+000b4d20: 2020 2020 203a 2061 6461 3a3a 6368 6172       : ada::char
+000b4d30: 6163 7465 725f 7365 7473 3a3a 5155 4552  acter_sets::QUER
+000b4d40: 595f 5045 5243 454e 545f 454e 434f 4445  Y_PERCENT_ENCODE
+000b4d50: 3b0a 0a20 2071 7565 7279 203d 2061 6461  ;..  query = ada
+000b4d60: 3a3a 756e 6963 6f64 653a 3a70 6572 6365  ::unicode::perce
+000b4d70: 6e74 5f65 6e63 6f64 6528 7374 643a 3a73  nt_encode(std::s
+000b4d80: 7472 696e 675f 7669 6577 286e 6577 5f76  tring_view(new_v
+000b4d90: 616c 7565 292c 0a20 2020 2020 2020 2020  alue),.         
+000b4da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b4db0: 2020 2020 2020 2020 2020 2020 2020 7175                qu
+000b4dc0: 6572 795f 7065 7263 656e 745f 656e 636f  ery_percent_enco
+000b4dd0: 6465 5f73 6574 293b 0a7d 0a0a 626f 6f6c  de_set);.}..bool
+000b4de0: 2075 726c 3a3a 7365 745f 7061 7468 6e61   url::set_pathna
+000b4df0: 6d65 2863 6f6e 7374 2073 7464 3a3a 7374  me(const std::st
+000b4e00: 7269 6e67 5f76 6965 7720 696e 7075 7429  ring_view input)
+000b4e10: 207b 0a20 2069 6620 2868 6173 5f6f 7061   {.  if (has_opa
+000b4e20: 7175 655f 7061 7468 2920 7b0a 2020 2020  que_path) {.    
+000b4e30: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000b4e40: 7d0a 2020 7061 7468 203d 2022 223b 0a20  }.  path = "";. 
+000b4e50: 2070 6172 7365 5f70 6174 6828 696e 7075   parse_path(inpu
+000b4e60: 7429 3b0a 2020 7265 7475 726e 2074 7275  t);.  return tru
+000b4e70: 653b 0a7d 0a0a 626f 6f6c 2075 726c 3a3a  e;.}..bool url::
+000b4e80: 7365 745f 7072 6f74 6f63 6f6c 2863 6f6e  set_protocol(con
+000b4e90: 7374 2073 7464 3a3a 7374 7269 6e67 5f76  st std::string_v
+000b4ea0: 6965 7720 696e 7075 7429 207b 0a20 2073  iew input) {.  s
+000b4eb0: 7464 3a3a 7374 7269 6e67 2076 6965 7728  td::string view(
+000b4ec0: 696e 7075 7429 3b0a 2020 6865 6c70 6572  input);.  helper
+000b4ed0: 733a 3a72 656d 6f76 655f 6173 6369 695f  s::remove_ascii_
+000b4ee0: 7461 625f 6f72 5f6e 6577 6c69 6e65 2876  tab_or_newline(v
+000b4ef0: 6965 7729 3b0a 2020 6966 2028 7669 6577  iew);.  if (view
+000b4f00: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000b4f10: 7265 7475 726e 2074 7275 653b 0a20 207d  return true;.  }
+000b4f20: 0a0a 2020 2f2f 2053 6368 656d 6573 2073  ..  // Schemes s
+000b4f30: 686f 756c 6420 7374 6172 7420 7769 7468  hould start with
+000b4f40: 2061 6c70 6861 2076 616c 7565 732e 0a20   alpha values.. 
+000b4f50: 2069 6620 2821 6368 6563 6b65 7273 3a3a   if (!checkers::
+000b4f60: 6973 5f61 6c70 6861 2876 6965 775b 305d  is_alpha(view[0]
+000b4f70: 2929 207b 0a20 2020 2072 6574 7572 6e20  )) {.    return 
+000b4f80: 6661 6c73 653b 0a20 207d 0a0a 2020 7669  false;.  }..  vi
+000b4f90: 6577 2e61 7070 656e 6428 223a 2229 3b0a  ew.append(":");.
+000b4fa0: 0a20 2073 7464 3a3a 7374 7269 6e67 3a3a  .  std::string::
+000b4fb0: 6974 6572 6174 6f72 2070 6f69 6e74 6572  iterator pointer
+000b4fc0: 203d 0a20 2020 2020 2073 7464 3a3a 6669   =.      std::fi
+000b4fd0: 6e64 5f69 665f 6e6f 7428 7669 6577 2e62  nd_if_not(view.b
+000b4fe0: 6567 696e 2829 2c20 7669 6577 2e65 6e64  egin(), view.end
+000b4ff0: 2829 2c20 756e 6963 6f64 653a 3a69 735f  (), unicode::is_
+000b5000: 616c 6e75 6d5f 706c 7573 293b 0a0a 2020  alnum_plus);..  
+000b5010: 6966 2028 706f 696e 7465 7220 213d 2076  if (pointer != v
+000b5020: 6965 772e 656e 6428 2920 2626 202a 706f  iew.end() && *po
+000b5030: 696e 7465 7220 3d3d 2027 3a27 2920 7b0a  inter == ':') {.
+000b5040: 2020 2020 7265 7475 726e 2070 6172 7365      return parse
+000b5050: 5f73 6368 656d 653c 7472 7565 3e28 0a20  _scheme<true>(. 
+000b5060: 2020 2020 2020 2073 7464 3a3a 7374 7269         std::stri
+000b5070: 6e67 5f76 6965 7728 7669 6577 2e64 6174  ng_view(view.dat
+000b5080: 6128 292c 2070 6f69 6e74 6572 202d 2076  a(), pointer - v
+000b5090: 6965 772e 6265 6769 6e28 2929 293b 0a20  iew.begin()));. 
+000b50a0: 207d 0a20 2072 6574 7572 6e20 6661 6c73   }.  return fals
+000b50b0: 653b 0a7d 0a0a 626f 6f6c 2075 726c 3a3a  e;.}..bool url::
+000b50c0: 7365 745f 6872 6566 2863 6f6e 7374 2073  set_href(const s
+000b50d0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000b50e0: 696e 7075 7429 207b 0a20 2061 6461 3a3a  input) {.  ada::
+000b50f0: 7265 7375 6c74 3c61 6461 3a3a 7572 6c3e  result<ada::url>
+000b5100: 206f 7574 203d 2061 6461 3a3a 7061 7273   out = ada::pars
+000b5110: 653c 6164 613a 3a75 726c 3e28 696e 7075  e<ada::url>(inpu
+000b5120: 7429 3b0a 0a20 2069 6620 286f 7574 2920  t);..  if (out) 
+000b5130: 7b0a 2020 2020 7573 6572 6e61 6d65 203d  {.    username =
+000b5140: 206f 7574 2d3e 7573 6572 6e61 6d65 3b0a   out->username;.
+000b5150: 2020 2020 7061 7373 776f 7264 203d 206f      password = o
+000b5160: 7574 2d3e 7061 7373 776f 7264 3b0a 2020  ut->password;.  
+000b5170: 2020 686f 7374 203d 206f 7574 2d3e 686f    host = out->ho
+000b5180: 7374 3b0a 2020 2020 706f 7274 203d 206f  st;.    port = o
+000b5190: 7574 2d3e 706f 7274 3b0a 2020 2020 7061  ut->port;.    pa
+000b51a0: 7468 203d 206f 7574 2d3e 7061 7468 3b0a  th = out->path;.
+000b51b0: 2020 2020 7175 6572 7920 3d20 6f75 742d      query = out-
+000b51c0: 3e71 7565 7279 3b0a 2020 2020 6861 7368  >query;.    hash
+000b51d0: 203d 206f 7574 2d3e 6861 7368 3b0a 2020   = out->hash;.  
+000b51e0: 2020 7479 7065 203d 206f 7574 2d3e 7479    type = out->ty
+000b51f0: 7065 3b0a 2020 2020 6e6f 6e5f 7370 6563  pe;.    non_spec
+000b5200: 6961 6c5f 7363 6865 6d65 203d 206f 7574  ial_scheme = out
+000b5210: 2d3e 6e6f 6e5f 7370 6563 6961 6c5f 7363  ->non_special_sc
+000b5220: 6865 6d65 3b0a 2020 2020 6861 735f 6f70  heme;.    has_op
+000b5230: 6171 7565 5f70 6174 6820 3d20 6f75 742d  aque_path = out-
+000b5240: 3e68 6173 5f6f 7061 7175 655f 7061 7468  >has_opaque_path
+000b5250: 3b0a 2020 7d0a 0a20 2072 6574 7572 6e20  ;.  }..  return 
+000b5260: 6f75 742e 6861 735f 7661 6c75 6528 293b  out.has_value();
+000b5270: 0a7d 0a0a 7d20 202f 2f20 6e61 6d65 7370  .}..}  // namesp
+000b5280: 6163 6520 6164 610a 2f2a 2065 6e64 2066  ace ada./* end f
+000b5290: 696c 6520 7372 632f 7572 6c2d 7365 7474  ile src/url-sett
+000b52a0: 6572 732e 6370 7020 2a2f 0a2f 2a20 6265  ers.cpp */./* be
+000b52b0: 6769 6e20 6669 6c65 2073 7263 2f70 6172  gin file src/par
+000b52c0: 7365 722e 6370 7020 2a2f 0a0a 2369 6e63  ser.cpp */..#inc
+000b52d0: 6c75 6465 203c 6e75 6d65 7269 633e 0a23  lude <numeric>.#
+000b52e0: 696e 636c 7564 6520 3c6c 696d 6974 733e  include <limits>
+000b52f0: 0a0a 6e61 6d65 7370 6163 6520 6164 613a  ..namespace ada:
+000b5300: 3a70 6172 7365 7220 7b0a 0a74 656d 706c  :parser {..templ
+000b5310: 6174 6520 3c63 6c61 7373 2072 6573 756c  ate <class resul
+000b5320: 745f 7479 7065 3e0a 7265 7375 6c74 5f74  t_type>.result_t
+000b5330: 7970 6520 7061 7273 655f 7572 6c28 7374  ype parse_url(st
+000b5340: 643a 3a73 7472 696e 675f 7669 6577 2075  d::string_view u
+000b5350: 7365 725f 696e 7075 742c 0a20 2020 2020  ser_input,.     
+000b5360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b5370: 2063 6f6e 7374 2072 6573 756c 745f 7479   const result_ty
+000b5380: 7065 2a20 6261 7365 5f75 726c 2920 7b0a  pe* base_url) {.
+000b5390: 2020 2f2f 2057 6520 6361 6e20 7370 6563    // We can spec
+000b53a0: 6961 6c69 7a65 2074 6865 2069 6d70 6c65  ialize the imple
+000b53b0: 6d65 6e74 6174 696f 6e20 7065 7220 7479  mentation per ty
+000b53c0: 7065 2e0a 2020 2f2f 2049 6d70 6f72 7461  pe..  // Importa
+000b53d0: 6e74 3a20 7265 7375 6c74 5f74 7970 655f  nt: result_type_
+000b53e0: 6973 5f61 6461 5f75 726c 2069 7320 6576  is_ada_url is ev
+000b53f0: 616c 7561 7465 6420 6174 202a 636f 6d70  aluated at *comp
+000b5400: 696c 6520 7469 6d65 2a2e 2054 6869 730a  ile time*. This.
+000b5410: 2020 2f2f 206d 6561 6e73 2074 6861 7420    // means that 
+000b5420: 646f 696e 6720 6966 2063 6f6e 7374 6578  doing if constex
+000b5430: 7072 2872 6573 756c 745f 7479 7065 5f69  pr(result_type_i
+000b5440: 735f 6164 615f 7572 6c29 207b 2073 6f6d  s_ada_url) { som
+000b5450: 6574 6869 6e67 207d 2065 6c73 6520 7b0a  ething } else {.
+000b5460: 2020 2f2f 2073 6f6d 6574 6869 6e67 2065    // something e
+000b5470: 6c73 6520 7d20 6973 2066 7265 6520 2861  lse } is free (a
+000b5480: 7420 7275 6e74 696d 6529 2e20 5468 6973  t runtime). This
+000b5490: 206d 6561 6e73 2074 6861 7420 6164 613a   means that ada:
+000b54a0: 3a75 726c 5f61 6767 7265 6761 746f 720a  :url_aggregator.
+000b54b0: 2020 2f2f 2061 6e64 2061 6461 3a3a 7572    // and ada::ur
+000b54c0: 6c20 2a2a 646f 206e 6f74 2068 6176 6520  l **do not have 
+000b54d0: 746f 2073 7570 706f 7274 2074 6865 2065  to support the e
+000b54e0: 7861 6374 2073 616d 6520 4150 492a 2a2e  xact same API**.
+000b54f0: 0a20 2063 6f6e 7374 6578 7072 2062 6f6f  .  constexpr boo
+000b5500: 6c20 7265 7375 6c74 5f74 7970 655f 6973  l result_type_is
+000b5510: 5f61 6461 5f75 726c 203d 0a20 2020 2020  _ada_url =.     
+000b5520: 2073 7464 3a3a 6973 5f73 616d 653c 6164   std::is_same<ad
+000b5530: 613a 3a75 726c 2c20 7265 7375 6c74 5f74  a::url, result_t
+000b5540: 7970 653e 3a3a 7661 6c75 653b 0a20 2063  ype>::value;.  c
+000b5550: 6f6e 7374 6578 7072 2062 6f6f 6c20 7265  onstexpr bool re
+000b5560: 7375 6c74 5f74 7970 655f 6973 5f61 6461  sult_type_is_ada
+000b5570: 5f75 726c 5f61 6767 7265 6761 746f 7220  _url_aggregator 
+000b5580: 3d0a 2020 2020 2020 7374 643a 3a69 735f  =.      std::is_
+000b5590: 7361 6d65 3c61 6461 3a3a 7572 6c5f 6167  same<ada::url_ag
+000b55a0: 6772 6567 6174 6f72 2c20 7265 7375 6c74  gregator, result
+000b55b0: 5f74 7970 653e 3a3a 7661 6c75 653b 0a20  _type>::value;. 
+000b55c0: 2073 7461 7469 635f 6173 7365 7274 2872   static_assert(r
+000b55d0: 6573 756c 745f 7479 7065 5f69 735f 6164  esult_type_is_ad
+000b55e0: 615f 7572 6c20 7c7c 0a20 2020 2020 2020  a_url ||.       
+000b55f0: 2020 2020 2020 2020 2072 6573 756c 745f           result_
+000b5600: 7479 7065 5f69 735f 6164 615f 7572 6c5f  type_is_ada_url_
+000b5610: 6167 6772 6567 6174 6f72 293b 2020 2f2f  aggregator);  //
+000b5620: 2057 6520 646f 6e27 7420 7375 7070 6f72   We don't suppor
+000b5630: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+000b5640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b5650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b5660: 2020 2020 2020 202f 2f20 616e 7974 6869         // anythi
+000b5670: 6e67 2065 6c73 6520 666f 7220 6e6f 772e  ng else for now.
+000b5680: 0a0a 2020 6164 615f 6c6f 6728 2261 6461  ..  ada_log("ada
+000b5690: 3a3a 7061 7273 6572 3a3a 7061 7273 655f  ::parser::parse_
+000b56a0: 7572 6c28 2722 2c20 7573 6572 5f69 6e70  url('", user_inp
+000b56b0: 7574 2c20 2227 205b 222c 2075 7365 725f  ut, "' [", user_
+000b56c0: 696e 7075 742e 7369 7a65 2829 2c0a 2020  input.size(),.  
+000b56d0: 2020 2020 2020 2020 2220 6279 7465 735d          " bytes]
+000b56e0: 2c22 2c20 2862 6173 655f 7572 6c20 213d  ,", (base_url !=
+000b56f0: 206e 756c 6c70 7472 203f 2062 6173 655f   nullptr ? base_
+000b5700: 7572 6c2d 3e74 6f5f 7374 7269 6e67 2829  url->to_string()
+000b5710: 203a 2022 6e75 6c6c 2229 2c0a 2020 2020   : "null"),.    
+000b5720: 2020 2020 2020 2229 2229 3b0a 0a20 2061        ")");..  a
+000b5730: 6461 3a3a 7374 6174 6520 7374 6174 6520  da::state state 
+000b5740: 3d20 6164 613a 3a73 7461 7465 3a3a 5343  = ada::state::SC
+000b5750: 4845 4d45 5f53 5441 5254 3b0a 2020 7265  HEME_START;.  re
+000b5760: 7375 6c74 5f74 7970 6520 7572 6c7b 7d3b  sult_type url{};
+000b5770: 0a0a 2020 2f2f 2057 6520 7265 6675 7365  ..  // We refuse
+000b5780: 2074 6f20 7061 7273 6520 5552 4c20 7374   to parse URL st
+000b5790: 7269 6e67 7320 7468 6174 2065 7863 6565  rings that excee
+000b57a0: 6420 3447 422e 2053 7563 6820 7374 7269  d 4GB. Such stri
+000b57b0: 6e67 7320 6172 6520 616c 6d6f 7374 0a20  ngs are almost. 
+000b57c0: 202f 2f20 7375 7265 6c79 2074 6865 2072   // surely the r
+000b57d0: 6573 756c 7420 6f66 2061 2062 7567 206f  esult of a bug o
+000b57e0: 7220 6172 6520 6f74 6865 7277 6973 6520  r are otherwise 
+000b57f0: 6120 7365 6375 7269 7479 2063 6f6e 6365  a security conce
+000b5800: 726e 2e0a 2020 6966 2028 7573 6572 5f69  rn..  if (user_i
+000b5810: 6e70 7574 2e73 697a 6528 2920 3e20 7374  nput.size() > st
+000b5820: 643a 3a6e 756d 6572 6963 5f6c 696d 6974  d::numeric_limit
+000b5830: 733c 7569 6e74 3332 5f74 3e3a 3a6d 6178  s<uint32_t>::max
+000b5840: 2829 2920 7b0a 2020 2020 7572 6c2e 6973  ()) {.    url.is
+000b5850: 5f76 616c 6964 203d 2066 616c 7365 3b0a  _valid = false;.
+000b5860: 2020 7d0a 2020 2f2f 2047 6f69 6e67 2066    }.  // Going f
+000b5870: 6f72 7761 7264 2c20 7573 6572 5f69 6e70  orward, user_inp
+000b5880: 7574 2e73 697a 6528 2920 6973 2069 6e20  ut.size() is in 
+000b5890: 5b30 2c0a 2020 2f2f 2073 7464 3a3a 6e75  [0,.  // std::nu
+000b58a0: 6d65 7269 635f 6c69 6d69 7473 3c75 696e  meric_limits<uin
+000b58b0: 7433 325f 743e 3a3a 6d61 7829 2e20 4966  t32_t>::max). If
+000b58c0: 2077 6520 6172 6520 7072 6f76 6964 6564   we are provided
+000b58d0: 2077 6974 6820 616e 2069 6e76 616c 6964   with an invalid
+000b58e0: 0a20 202f 2f20 6261 7365 2c20 6f72 2074  .  // base, or t
+000b58f0: 6865 206f 7074 696f 6e61 6c5f 7572 6c20  he optional_url 
+000b5900: 7761 7320 696e 7661 6c69 642c 2077 6520  was invalid, we 
+000b5910: 6d75 7374 2072 6574 7572 6e2e 0a20 2069  must return..  i
+000b5920: 6620 2862 6173 655f 7572 6c20 213d 206e  f (base_url != n
+000b5930: 756c 6c70 7472 2920 7b0a 2020 2020 7572  ullptr) {.    ur
+000b5940: 6c2e 6973 5f76 616c 6964 2026 3d20 6261  l.is_valid &= ba
+000b5950: 7365 5f75 726c 2d3e 6973 5f76 616c 6964  se_url->is_valid
+000b5960: 3b0a 2020 7d0a 2020 6966 2028 2175 726c  ;.  }.  if (!url
+000b5970: 2e69 735f 7661 6c69 6429 207b 0a20 2020  .is_valid) {.   
+000b5980: 2072 6574 7572 6e20 7572 6c3b 0a20 207d   return url;.  }
+000b5990: 0a20 2069 6620 636f 6e73 7465 7870 7220  .  if constexpr 
+000b59a0: 2872 6573 756c 745f 7479 7065 5f69 735f  (result_type_is_
+000b59b0: 6164 615f 7572 6c5f 6167 6772 6567 6174  ada_url_aggregat
+000b59c0: 6f72 2920 7b0a 2020 2020 2f2f 204d 6f73  or) {.    // Mos
+000b59d0: 7420 6f66 2074 6865 2074 696d 652c 2077  t of the time, w
+000b59e0: 6520 6a75 7374 206e 6565 6420 7573 6572  e just need user
+000b59f0: 5f69 6e70 7574 2e73 697a 6528 292e 0a20  _input.size().. 
+000b5a00: 2020 202f 2f20 496e 2073 6f6d 6520 696e     // In some in
+000b5a10: 7374 616e 6365 732c 2077 6520 6d61 7920  stances, we may 
+000b5a20: 6e65 6564 2061 2062 6974 206d 6f72 652e  need a bit more.
+000b5a30: 0a20 2020 202f 2f2f 2f2f 2f2f 2f2f 2f2f  .    ///////////
+000b5a40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000b5a50: 0a20 2020 202f 2f20 5468 6973 2069 7320  .    // This is 
+000b5a60: 2a76 6572 792a 2069 6d70 6f72 7461 6e74  *very* important
+000b5a70: 2e20 5468 6973 206c 696e 6520 7368 6f75  . This line shou
+000b5a80: 6c64 2062 6520 7265 6d6f 7665 640a 2020  ld be removed.  
+000b5a90: 2020 2f2f 2068 6173 7469 6c79 2e20 5468    // hastily. Th
+000b5aa0: 6572 6520 6172 6520 7072 696e 6369 706c  ere are principl
+000b5ab0: 6564 2072 6561 736f 6e73 2077 6879 2072  ed reasons why r
+000b5ac0: 6573 6572 7665 2069 7320 696d 706f 7274  eserve is import
+000b5ad0: 616e 740a 2020 2020 2f2f 2066 6f72 2070  ant.    // for p
+000b5ae0: 6572 666f 726d 616e 6365 2e20 4966 2079  erformance. If y
+000b5af0: 6f75 2068 6176 6520 6120 6265 6e63 686d  ou have a benchm
+000b5b00: 6172 6b20 7769 7468 2073 6d61 6c6c 2069  ark with small i
+000b5b10: 6e70 7574 732c 0a20 2020 202f 2f20 6974  nputs,.    // it
+000b5b20: 206d 6179 206e 6f74 206d 6174 7465 722c   may not matter,
+000b5b30: 2062 7574 2069 6e20 6f74 6865 7220 696e   but in other in
+000b5b40: 7374 616e 6365 732c 2069 7420 636f 756c  stances, it coul
+000b5b50: 642e 0a20 2020 202f 2f2f 2f0a 2020 2020  d..    ////.    
+000b5b60: 2f2f 2054 6869 7320 726f 756e 6473 2075  // This rounds u
+000b5b70: 7020 746f 2074 6865 206e 6578 7420 706f  p to the next po
+000b5b80: 7765 7220 6f66 2074 776f 2e0a 2020 2020  wer of two..    
+000b5b90: 2f2f 2057 6520 6b6e 6f77 2074 6861 7420  // We know that 
+000b5ba0: 7573 6572 5f69 6e70 7574 2e73 697a 6528  user_input.size(
+000b5bb0: 2920 6973 2069 6e20 5b30 2c0a 2020 2020  ) is in [0,.    
+000b5bc0: 2f2f 2073 7464 3a3a 6e75 6d65 7269 635f  // std::numeric_
+000b5bd0: 6c69 6d69 7473 3c75 696e 7433 325f 743e  limits<uint32_t>
+000b5be0: 3a3a 6d61 7829 2e0a 2020 2020 7569 6e74  ::max)..    uint
+000b5bf0: 3332 5f74 2072 6573 6572 7665 5f63 6170  32_t reserve_cap
+000b5c00: 6163 6974 7920 3d0a 2020 2020 2020 2020  acity =.        
+000b5c10: 2830 7846 4646 4646 4646 4620 3e3e 0a20  (0xFFFFFFFF >>. 
+000b5c20: 2020 2020 2020 2020 6865 6c70 6572 733a          helpers:
+000b5c30: 3a6c 6561 6469 6e67 5f7a 6572 6f65 7328  :leading_zeroes(
+000b5c40: 7569 6e74 3332 5f74 2831 207c 2075 7365  uint32_t(1 | use
+000b5c50: 725f 696e 7075 742e 7369 7a65 2829 2929  r_input.size()))
+000b5c60: 2920 2b0a 2020 2020 2020 2020 313b 0a20  ) +.        1;. 
+000b5c70: 2020 2075 726c 2e72 6573 6572 7665 2872     url.reserve(r
+000b5c80: 6573 6572 7665 5f63 6170 6163 6974 7929  eserve_capacity)
+000b5c90: 3b0a 2020 2020 2f2f 0a20 2020 202f 2f0a  ;.    //.    //.
+000b5ca0: 2020 2020 2f2f 0a20 207d 0a20 2073 7464      //.  }.  std
+000b5cb0: 3a3a 7374 7269 6e67 2074 6d70 5f62 7566  ::string tmp_buf
+000b5cc0: 6665 723b 0a20 2073 7464 3a3a 7374 7269  fer;.  std::stri
+000b5cd0: 6e67 5f76 6965 7720 696e 7465 726e 616c  ng_view internal
+000b5ce0: 5f69 6e70 7574 3b0a 2020 6966 2028 756e  _input;.  if (un
+000b5cf0: 6963 6f64 653a 3a68 6173 5f74 6162 735f  icode::has_tabs_
+000b5d00: 6f72 5f6e 6577 6c69 6e65 2875 7365 725f  or_newline(user_
+000b5d10: 696e 7075 7429 2920 7b0a 2020 2020 746d  input)) {.    tm
+000b5d20: 705f 6275 6666 6572 203d 2075 7365 725f  p_buffer = user_
+000b5d30: 696e 7075 743b 0a20 2020 202f 2f20 4f70  input;.    // Op
+000b5d40: 7469 6d69 7a61 7469 6f6e 206f 7070 6f72  timization oppor
+000b5d50: 7475 6e69 7479 3a20 496e 7374 6561 6420  tunity: Instead 
+000b5d60: 6f66 2063 6f70 7969 6e67 2061 6e64 2074  of copying and t
+000b5d70: 6865 6e20 7072 756e 696e 672c 2077 6520  hen pruning, we 
+000b5d80: 636f 756c 640a 2020 2020 2f2f 206a 7573  could.    // jus
+000b5d90: 7420 6469 7265 6374 6c79 2062 7569 6c64  t directly build
+000b5da0: 2074 6865 2073 7472 696e 6720 6672 6f6d   the string from
+000b5db0: 2075 7365 725f 696e 7075 742e 0a20 2020   user_input..   
+000b5dc0: 2068 656c 7065 7273 3a3a 7265 6d6f 7665   helpers::remove
+000b5dd0: 5f61 7363 6969 5f74 6162 5f6f 725f 6e65  _ascii_tab_or_ne
+000b5de0: 776c 696e 6528 746d 705f 6275 6666 6572  wline(tmp_buffer
+000b5df0: 293b 0a20 2020 2069 6e74 6572 6e61 6c5f  );.    internal_
+000b5e00: 696e 7075 7420 3d20 746d 705f 6275 6666  input = tmp_buff
+000b5e10: 6572 3b0a 2020 7d20 656c 7365 207b 0a20  er;.  } else {. 
+000b5e20: 2020 2069 6e74 6572 6e61 6c5f 696e 7075     internal_inpu
+000b5e30: 7420 3d20 7573 6572 5f69 6e70 7574 3b0a  t = user_input;.
+000b5e40: 2020 7d0a 0a20 202f 2f20 4c65 6164 696e    }..  // Leadin
+000b5e50: 6720 616e 6420 7472 6169 6c69 6e67 2063  g and trailing c
+000b5e60: 6f6e 7472 6f6c 2063 6861 7261 6374 6572  ontrol character
+000b5e70: 7320 6172 6520 756e 636f 6d6d 6f6e 2061  s are uncommon a
+000b5e80: 6e64 2065 6173 7920 746f 2064 6561 6c20  nd easy to deal 
+000b5e90: 7769 7468 0a20 202f 2f20 286e 6f20 7065  with.  // (no pe
+000b5ea0: 7266 6f72 6d61 6e63 6520 636f 6e63 6572  rformance concer
+000b5eb0: 6e29 2e0a 2020 7374 643a 3a73 7472 696e  n)..  std::strin
+000b5ec0: 675f 7669 6577 2075 726c 5f64 6174 6120  g_view url_data 
+000b5ed0: 3d20 696e 7465 726e 616c 5f69 6e70 7574  = internal_input
+000b5ee0: 3b0a 2020 6865 6c70 6572 733a 3a74 7269  ;.  helpers::tri
+000b5ef0: 6d5f 6330 5f77 6869 7465 7370 6163 6528  m_c0_whitespace(
+000b5f00: 7572 6c5f 6461 7461 293b 0a0a 2020 2f2f  url_data);..  //
+000b5f10: 204f 7074 696d 697a 6174 696f 6e20 6f70   Optimization op
+000b5f20: 706f 7274 756e 6974 792e 204d 6f73 7420  portunity. Most 
+000b5f30: 7765 6273 6974 6573 2064 6f20 6e6f 7420  websites do not 
+000b5f40: 6861 7665 2066 7261 676d 656e 742e 0a20  have fragment.. 
+000b5f50: 2073 7464 3a3a 6f70 7469 6f6e 616c 3c73   std::optional<s
+000b5f60: 7464 3a3a 7374 7269 6e67 5f76 6965 773e  td::string_view>
+000b5f70: 2066 7261 676d 656e 7420 3d20 6865 6c70   fragment = help
+000b5f80: 6572 733a 3a70 7275 6e65 5f68 6173 6828  ers::prune_hash(
+000b5f90: 7572 6c5f 6461 7461 293b 0a20 202f 2f20  url_data);.  // 
+000b5fa0: 5765 2061 6464 2069 7420 6c61 7374 2073  We add it last s
+000b5fb0: 6f20 7468 6174 2061 6e20 696d 706c 656d  o that an implem
+000b5fc0: 656e 7461 7469 6f6e 206c 696b 6520 6164  entation like ad
+000b5fd0: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
+000b5fe0: 720a 2020 2f2f 2063 616e 2061 7070 656e  r.  // can appen
+000b5ff0: 6420 6974 206c 6173 7420 746f 2069 7473  d it last to its
+000b6000: 2069 6e74 6572 6e61 6c20 6275 6666 6572   internal buffer
+000b6010: 2c20 7468 7573 2069 6d70 726f 7669 6e67  , thus improving
+000b6020: 2070 6572 666f 726d 616e 6365 2e0a 0a20   performance... 
+000b6030: 202f 2f20 4865 7265 2075 726c 5f64 6174   // Here url_dat
+000b6040: 6120 6e6f 206c 6f6e 6765 7220 6861 7320  a no longer has 
+000b6050: 6974 7320 6672 6167 6d65 6e74 2e0a 2020  its fragment..  
+000b6060: 2f2f 2057 6520 6172 6520 676f 696e 6720  // We are going 
+000b6070: 746f 2061 6363 6573 7320 7468 6520 6461  to access the da
+000b6080: 7461 2066 726f 6d20 7572 6c5f 6461 7461  ta from url_data
+000b6090: 2028 6974 2069 7320 696d 6d75 7461 626c   (it is immutabl
+000b60a0: 6529 2e0a 2020 2f2f 2041 7420 616e 7920  e)..  // At any 
+000b60b0: 6769 7665 6e20 7469 6d65 2c20 7765 2061  given time, we a
+000b60c0: 7265 2070 6f69 6e74 696e 6720 6174 2062  re pointing at b
+000b60d0: 7974 6520 2769 6e70 7574 5f70 6f73 6974  yte 'input_posit
+000b60e0: 696f 6e27 2069 6e20 7572 6c5f 6461 7461  ion' in url_data
+000b60f0: 2e0a 2020 2f2f 2054 6865 2069 6e70 7574  ..  // The input
+000b6100: 5f70 6f73 6974 696f 6e20 7661 7269 6162  _position variab
+000b6110: 6c65 2073 686f 756c 6420 7261 6e67 6520  le should range 
+000b6120: 6672 6f6d 2030 2074 6f20 696e 7075 745f  from 0 to input_
+000b6130: 7369 7a65 2e0a 2020 2f2f 2049 7420 6973  size..  // It is
+000b6140: 2069 6c6c 6567 616c 2074 6f20 6163 6365   illegal to acce
+000b6150: 7373 2075 726c 5f64 6174 6120 6174 2069  ss url_data at i
+000b6160: 6e70 7574 5f73 697a 652e 0a20 2073 697a  nput_size..  siz
+000b6170: 655f 7420 696e 7075 745f 706f 7369 7469  e_t input_positi
+000b6180: 6f6e 203d 2030 3b0a 2020 636f 6e73 7420  on = 0;.  const 
+000b6190: 7369 7a65 5f74 2069 6e70 7574 5f73 697a  size_t input_siz
+000b61a0: 6520 3d20 7572 6c5f 6461 7461 2e73 697a  e = url_data.siz
+000b61b0: 6528 293b 0a20 202f 2f20 4b65 6570 2072  e();.  // Keep r
+000b61c0: 756e 6e69 6e67 2074 6865 2066 6f6c 6c6f  unning the follo
+000b61d0: 7769 6e67 2073 7461 7465 206d 6163 6869  wing state machi
+000b61e0: 6e65 2062 7920 7377 6974 6368 696e 6720  ne by switching 
+000b61f0: 6f6e 2073 7461 7465 2e0a 2020 2f2f 2049  on state..  // I
+000b6200: 6620 6166 7465 7220 6120 7275 6e20 706f  f after a run po
+000b6210: 696e 7465 7220 706f 696e 7473 2074 6f20  inter points to 
+000b6220: 7468 6520 454f 4620 636f 6465 2070 6f69  the EOF code poi
+000b6230: 6e74 2c20 676f 2074 6f20 7468 6520 6e65  nt, go to the ne
+000b6240: 7874 2073 7465 702e 0a20 202f 2f20 4f74  xt step..  // Ot
+000b6250: 6865 7277 6973 652c 2069 6e63 7265 6173  herwise, increas
+000b6260: 6520 706f 696e 7465 7220 6279 2031 2061  e pointer by 1 a
+000b6270: 6e64 2063 6f6e 7469 6e75 6520 7769 7468  nd continue with
+000b6280: 2074 6865 2073 7461 7465 206d 6163 6869   the state machi
+000b6290: 6e65 2e0a 2020 2f2f 2057 6520 6e65 7665  ne..  // We neve
+000b62a0: 7220 6465 6372 656d 656e 7420 696e 7075  r decrement inpu
+000b62b0: 745f 706f 7369 7469 6f6e 2e0a 2020 7768  t_position..  wh
+000b62c0: 696c 6520 2869 6e70 7574 5f70 6f73 6974  ile (input_posit
+000b62d0: 696f 6e20 3c3d 2069 6e70 7574 5f73 697a  ion <= input_siz
+000b62e0: 6529 207b 0a20 2020 2061 6461 5f6c 6f67  e) {.    ada_log
+000b62f0: 2822 496e 2070 6172 7369 6e67 2061 7420  ("In parsing at 
+000b6300: 222c 2069 6e70 7574 5f70 6f73 6974 696f  ", input_positio
+000b6310: 6e2c 2022 206f 7574 206f 6620 222c 2069  n, " out of ", i
+000b6320: 6e70 7574 5f73 697a 652c 0a20 2020 2020  nput_size,.     
+000b6330: 2020 2020 2020 2022 2069 6e20 7374 6174         " in stat
+000b6340: 6520 222c 2061 6461 3a3a 746f 5f73 7472  e ", ada::to_str
+000b6350: 696e 6728 7374 6174 6529 293b 0a20 2020  ing(state));.   
+000b6360: 2073 7769 7463 6820 2873 7461 7465 2920   switch (state) 
+000b6370: 7b0a 2020 2020 2020 6361 7365 2061 6461  {.      case ada
+000b6380: 3a3a 7374 6174 653a 3a53 4348 454d 455f  ::state::SCHEME_
+000b6390: 5354 4152 543a 207b 0a20 2020 2020 2020  START: {.       
+000b63a0: 2061 6461 5f6c 6f67 2822 5343 4845 4d45   ada_log("SCHEME
+000b63b0: 5f53 5441 5254 2022 2c20 6865 6c70 6572  _START ", helper
+000b63c0: 733a 3a73 7562 7374 7269 6e67 2875 726c  s::substring(url
+000b63d0: 5f64 6174 612c 2069 6e70 7574 5f70 6f73  _data, input_pos
+000b63e0: 6974 696f 6e29 293b 0a20 2020 2020 2020  ition));.       
+000b63f0: 202f 2f20 4966 2063 2069 7320 616e 2041   // If c is an A
+000b6400: 5343 4949 2061 6c70 6861 2c20 6170 7065  SCII alpha, appe
+000b6410: 6e64 2063 2c20 6c6f 7765 7263 6173 6564  nd c, lowercased
+000b6420: 2c20 746f 2062 7566 6665 722c 2061 6e64  , to buffer, and
+000b6430: 2073 6574 0a20 2020 2020 2020 202f 2f20   set.        // 
+000b6440: 7374 6174 6520 746f 2073 6368 656d 6520  state to scheme 
+000b6450: 7374 6174 652e 0a20 2020 2020 2020 2069  state..        i
+000b6460: 6620 2828 696e 7075 745f 706f 7369 7469  f ((input_positi
+000b6470: 6f6e 2021 3d20 696e 7075 745f 7369 7a65  on != input_size
+000b6480: 2920 2626 0a20 2020 2020 2020 2020 2020  ) &&.           
+000b6490: 2063 6865 636b 6572 733a 3a69 735f 616c   checkers::is_al
+000b64a0: 7068 6128 7572 6c5f 6461 7461 5b69 6e70  pha(url_data[inp
+000b64b0: 7574 5f70 6f73 6974 696f 6e5d 2929 207b  ut_position])) {
+000b64c0: 0a20 2020 2020 2020 2020 2073 7461 7465  .          state
+000b64d0: 203d 2061 6461 3a3a 7374 6174 653a 3a53   = ada::state::S
+000b64e0: 4348 454d 453b 0a20 2020 2020 2020 2020  CHEME;.         
+000b64f0: 2069 6e70 7574 5f70 6f73 6974 696f 6e2b   input_position+
+000b6500: 2b3b 0a20 2020 2020 2020 207d 2065 6c73  +;.        } els
+000b6510: 6520 7b0a 2020 2020 2020 2020 2020 2f2f  e {.          //
+000b6520: 204f 7468 6572 7769 7365 2c20 6966 2073   Otherwise, if s
+000b6530: 7461 7465 206f 7665 7272 6964 6520 6973  tate override is
+000b6540: 206e 6f74 2067 6976 656e 2c20 7365 7420   not given, set 
+000b6550: 7374 6174 6520 746f 206e 6f20 7363 6865  state to no sche
+000b6560: 6d65 0a20 2020 2020 2020 2020 202f 2f20  me.          // 
+000b6570: 7374 6174 6520 616e 6420 6465 6372 6561  state and decrea
+000b6580: 7365 2070 6f69 6e74 6572 2062 7920 312e  se pointer by 1.
+000b6590: 0a20 2020 2020 2020 2020 2073 7461 7465  .          state
+000b65a0: 203d 2061 6461 3a3a 7374 6174 653a 3a4e   = ada::state::N
+000b65b0: 4f5f 5343 4845 4d45 3b0a 2020 2020 2020  O_SCHEME;.      
+000b65c0: 2020 7d0a 2020 2020 2020 2020 6272 6561    }.        brea
+000b65d0: 6b3b 0a20 2020 2020 207d 0a20 2020 2020  k;.      }.     
+000b65e0: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
+000b65f0: 3a3a 5343 4845 4d45 3a20 7b0a 2020 2020  ::SCHEME: {.    
+000b6600: 2020 2020 6164 615f 6c6f 6728 2253 4348      ada_log("SCH
+000b6610: 454d 4520 222c 2068 656c 7065 7273 3a3a  EME ", helpers::
+000b6620: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000b6630: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000b6640: 6f6e 2929 3b0a 2020 2020 2020 2020 2f2f  on));.        //
+000b6650: 2049 6620 6320 6973 2061 6e20 4153 4349   If c is an ASCI
+000b6660: 4920 616c 7068 616e 756d 6572 6963 2c20  I alphanumeric, 
+000b6670: 552b 3030 3242 2028 2b29 2c20 552b 3030  U+002B (+), U+00
+000b6680: 3244 2028 2d29 2c20 6f72 2055 2b30 3032  2D (-), or U+002
+000b6690: 4520 282e 292c 0a20 2020 2020 2020 202f  E (.),.        /
+000b66a0: 2f20 6170 7065 6e64 2063 2c20 6c6f 7765  / append c, lowe
+000b66b0: 7263 6173 6564 2c20 746f 2062 7566 6665  rcased, to buffe
+000b66c0: 722e 0a20 2020 2020 2020 2077 6869 6c65  r..        while
+000b66d0: 2028 2869 6e70 7574 5f70 6f73 6974 696f   ((input_positio
+000b66e0: 6e20 213d 2069 6e70 7574 5f73 697a 6529  n != input_size)
+000b66f0: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
+000b6700: 2020 2028 6164 613a 3a75 6e69 636f 6465     (ada::unicode
+000b6710: 3a3a 6973 5f61 6c6e 756d 5f70 6c75 7328  ::is_alnum_plus(
+000b6720: 7572 6c5f 6461 7461 5b69 6e70 7574 5f70  url_data[input_p
+000b6730: 6f73 6974 696f 6e5d 2929 2920 7b0a 2020  osition]))) {.  
+000b6740: 2020 2020 2020 2020 696e 7075 745f 706f          input_po
+000b6750: 7369 7469 6f6e 2b2b 3b0a 2020 2020 2020  sition++;.      
+000b6760: 2020 7d0a 2020 2020 2020 2020 2f2f 204f    }.        // O
+000b6770: 7468 6572 7769 7365 2c20 6966 2063 2069  therwise, if c i
+000b6780: 7320 552b 3030 3341 2028 3a29 2c20 7468  s U+003A (:), th
+000b6790: 656e 3a0a 2020 2020 2020 2020 6966 2028  en:.        if (
+000b67a0: 2869 6e70 7574 5f70 6f73 6974 696f 6e20  (input_position 
+000b67b0: 213d 2069 6e70 7574 5f73 697a 6529 2026  != input_size) &
+000b67c0: 260a 2020 2020 2020 2020 2020 2020 2875  &.            (u
+000b67d0: 726c 5f64 6174 615b 696e 7075 745f 706f  rl_data[input_po
+000b67e0: 7369 7469 6f6e 5d20 3d3d 2027 3a27 2929  sition] == ':'))
+000b67f0: 207b 0a20 2020 2020 2020 2020 2061 6461   {.          ada
+000b6800: 5f6c 6f67 2822 5343 4845 4d45 2074 6865  _log("SCHEME the
+000b6810: 2073 6368 656d 6520 7368 6f75 6c64 2062   scheme should b
+000b6820: 6520 222c 0a20 2020 2020 2020 2020 2020  e ",.           
+000b6830: 2020 2020 2020 2075 726c 5f64 6174 612e         url_data.
+000b6840: 7375 6273 7472 2830 2c20 696e 7075 745f  substr(0, input_
+000b6850: 706f 7369 7469 6f6e 2929 3b0a 2020 2020  position));.    
+000b6860: 2020 2020 2020 6966 2063 6f6e 7374 6578        if constex
+000b6870: 7072 2028 7265 7375 6c74 5f74 7970 655f  pr (result_type_
+000b6880: 6973 5f61 6461 5f75 726c 2920 7b0a 2020  is_ada_url) {.  
+000b6890: 2020 2020 2020 2020 2020 6966 2028 2175            if (!u
+000b68a0: 726c 2e70 6172 7365 5f73 6368 656d 6528  rl.parse_scheme(
+000b68b0: 7572 6c5f 6461 7461 2e73 7562 7374 7228  url_data.substr(
+000b68c0: 302c 2069 6e70 7574 5f70 6f73 6974 696f  0, input_positio
+000b68d0: 6e29 2929 207b 0a20 2020 2020 2020 2020  n))) {.         
+000b68e0: 2020 2020 2072 6574 7572 6e20 7572 6c3b       return url;
+000b68f0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+000b6900: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+000b6910: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
+000b6920: 2077 6520 7061 7373 2074 6865 2063 6f6c   we pass the col
+000b6930: 6f6e 2061 6c6f 6e67 2069 6e73 7465 6164  on along instead
+000b6940: 206f 6620 7061 696e 6675 6c6c 7920 6164   of painfully ad
+000b6950: 6469 6e67 2069 7420 6261 636b 2e0a 2020  ding it back..  
+000b6960: 2020 2020 2020 2020 2020 6966 2028 2175            if (!u
+000b6970: 726c 2e70 6172 7365 5f73 6368 656d 655f  rl.parse_scheme_
+000b6980: 7769 7468 5f63 6f6c 6f6e 280a 2020 2020  with_colon(.    
+000b6990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b69a0: 7572 6c5f 6461 7461 2e73 7562 7374 7228  url_data.substr(
+000b69b0: 302c 2069 6e70 7574 5f70 6f73 6974 696f  0, input_positio
+000b69c0: 6e20 2b20 3129 2929 207b 0a20 2020 2020  n + 1))) {.     
+000b69d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000b69e0: 7572 6c3b 0a20 2020 2020 2020 2020 2020  url;.           
+000b69f0: 207d 0a20 2020 2020 2020 2020 207d 0a20   }.          }. 
+000b6a00: 2020 2020 2020 2020 2061 6461 5f6c 6f67           ada_log
+000b6a10: 2822 5343 4845 4d45 2074 6865 2073 6368  ("SCHEME the sch
+000b6a20: 656d 6520 6973 2022 2c20 7572 6c2e 6765  eme is ", url.ge
+000b6a30: 745f 7072 6f74 6f63 6f6c 2829 293b 0a0a  t_protocol());..
+000b6a40: 2020 2020 2020 2020 2020 2f2f 2049 6620            // If 
+000b6a50: 7572 6ce2 8099 7320 7363 6865 6d65 2069  url...s scheme i
+000b6a60: 7320 2266 696c 6522 2c20 7468 656e 3a0a  s "file", then:.
+000b6a70: 2020 2020 2020 2020 2020 6966 2028 7572            if (ur
+000b6a80: 6c2e 7479 7065 203d 3d20 6164 613a 3a73  l.type == ada::s
+000b6a90: 6368 656d 653a 3a74 7970 653a 3a46 494c  cheme::type::FIL
+000b6aa0: 4529 207b 0a20 2020 2020 2020 2020 2020  E) {.           
+000b6ab0: 202f 2f20 5365 7420 7374 6174 6520 746f   // Set state to
+000b6ac0: 2066 696c 6520 7374 6174 652e 0a20 2020   file state..   
+000b6ad0: 2020 2020 2020 2020 2073 7461 7465 203d           state =
+000b6ae0: 2061 6461 3a3a 7374 6174 653a 3a46 494c   ada::state::FIL
+000b6af0: 453b 0a20 2020 2020 2020 2020 207d 0a20  E;.          }. 
+000b6b00: 2020 2020 2020 2020 202f 2f20 4f74 6865           // Othe
+000b6b10: 7277 6973 652c 2069 6620 7572 6c20 6973  rwise, if url is
+000b6b20: 2073 7065 6369 616c 2c20 6261 7365 2069   special, base i
+000b6b30: 7320 6e6f 6e2d 6e75 6c6c 2c20 616e 6420  s non-null, and 
+000b6b40: 6261 7365 e280 9973 2073 6368 656d 650a  base...s scheme.
+000b6b50: 2020 2020 2020 2020 2020 2f2f 2069 7320            // is 
+000b6b60: 7572 6ce2 8099 7320 7363 6865 6d65 3a20  url...s scheme: 
+000b6b70: 4e6f 7465 3a20 446f 696e 6720 6261 7365  Note: Doing base
+000b6b80: 5f75 726c 2d3e 7363 6865 6d65 2069 7320  _url->scheme is 
+000b6b90: 756e 7361 6665 2069 6620 6261 7365 5f75  unsafe if base_u
+000b6ba0: 726c 0a20 2020 2020 2020 2020 202f 2f20  rl.          // 
+000b6bb0: 213d 206e 756c 6c70 7472 2069 7320 6661  != nullptr is fa
+000b6bc0: 6c73 652e 0a20 2020 2020 2020 2020 2065  lse..          e
+000b6bd0: 6c73 6520 6966 2028 7572 6c2e 6973 5f73  lse if (url.is_s
+000b6be0: 7065 6369 616c 2829 2026 2620 6261 7365  pecial() && base
+000b6bf0: 5f75 726c 2021 3d20 6e75 6c6c 7074 7220  _url != nullptr 
+000b6c00: 2626 0a20 2020 2020 2020 2020 2020 2020  &&.             
+000b6c10: 2020 2020 2020 6261 7365 5f75 726c 2d3e        base_url->
+000b6c20: 7479 7065 203d 3d20 7572 6c2e 7479 7065  type == url.type
+000b6c30: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000b6c40: 2f2f 2053 6574 2073 7461 7465 2074 6f20  // Set state to 
+000b6c50: 7370 6563 6961 6c20 7265 6c61 7469 7665  special relative
+000b6c60: 206f 7220 6175 7468 6f72 6974 7920 7374   or authority st
+000b6c70: 6174 652e 0a20 2020 2020 2020 2020 2020  ate..           
+000b6c80: 2073 7461 7465 203d 2061 6461 3a3a 7374   state = ada::st
+000b6c90: 6174 653a 3a53 5045 4349 414c 5f52 454c  ate::SPECIAL_REL
+000b6ca0: 4154 4956 455f 4f52 5f41 5554 484f 5249  ATIVE_OR_AUTHORI
+000b6cb0: 5459 3b0a 2020 2020 2020 2020 2020 7d0a  TY;.          }.
+000b6cc0: 2020 2020 2020 2020 2020 2f2f 204f 7468            // Oth
+000b6cd0: 6572 7769 7365 2c20 6966 2075 726c 2069  erwise, if url i
+000b6ce0: 7320 7370 6563 6961 6c2c 2073 6574 2073  s special, set s
+000b6cf0: 7461 7465 2074 6f20 7370 6563 6961 6c20  tate to special 
+000b6d00: 6175 7468 6f72 6974 790a 2020 2020 2020  authority.      
+000b6d10: 2020 2020 2f2f 2073 6c61 7368 6573 2073      // slashes s
+000b6d20: 7461 7465 2e0a 2020 2020 2020 2020 2020  tate..          
+000b6d30: 656c 7365 2069 6620 2875 726c 2e69 735f  else if (url.is_
+000b6d40: 7370 6563 6961 6c28 2929 207b 0a20 2020  special()) {.   
+000b6d50: 2020 2020 2020 2020 2073 7461 7465 203d           state =
+000b6d60: 2061 6461 3a3a 7374 6174 653a 3a53 5045   ada::state::SPE
+000b6d70: 4349 414c 5f41 5554 484f 5249 5459 5f53  CIAL_AUTHORITY_S
+000b6d80: 4c41 5348 4553 3b0a 2020 2020 2020 2020  LASHES;.        
+000b6d90: 2020 7d0a 2020 2020 2020 2020 2020 2f2f    }.          //
+000b6da0: 204f 7468 6572 7769 7365 2c20 6966 2072   Otherwise, if r
+000b6db0: 656d 6169 6e69 6e67 2073 7461 7274 7320  emaining starts 
+000b6dc0: 7769 7468 2061 6e20 552b 3030 3246 2028  with an U+002F (
+000b6dd0: 2f29 2c20 7365 7420 7374 6174 6520 746f  /), set state to
+000b6de0: 0a20 2020 2020 2020 2020 202f 2f20 7061  .          // pa
+000b6df0: 7468 206f 7220 6175 7468 6f72 6974 7920  th or authority 
+000b6e00: 7374 6174 6520 616e 6420 696e 6372 6561  state and increa
+000b6e10: 7365 2070 6f69 6e74 6572 2062 7920 312e  se pointer by 1.
+000b6e20: 0a20 2020 2020 2020 2020 2065 6c73 6520  .          else 
+000b6e30: 6966 2028 696e 7075 745f 706f 7369 7469  if (input_positi
+000b6e40: 6f6e 202b 2031 203c 2069 6e70 7574 5f73  on + 1 < input_s
+000b6e50: 697a 6520 2626 0a20 2020 2020 2020 2020  ize &&.         
+000b6e60: 2020 2020 2020 2020 2020 7572 6c5f 6461            url_da
+000b6e70: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
+000b6e80: 6e20 2b20 315d 203d 3d20 272f 2729 207b  n + 1] == '/') {
+000b6e90: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000b6ea0: 7465 203d 2061 6461 3a3a 7374 6174 653a  te = ada::state:
+000b6eb0: 3a50 4154 485f 4f52 5f41 5554 484f 5249  :PATH_OR_AUTHORI
+000b6ec0: 5459 3b0a 2020 2020 2020 2020 2020 2020  TY;.            
+000b6ed0: 696e 7075 745f 706f 7369 7469 6f6e 2b2b  input_position++
+000b6ee0: 3b0a 2020 2020 2020 2020 2020 7d0a 2020  ;.          }.  
+000b6ef0: 2020 2020 2020 2020 2f2f 204f 7468 6572          // Other
+000b6f00: 7769 7365 2c20 7365 7420 7572 6ce2 8099  wise, set url...
+000b6f10: 7320 7061 7468 2074 6f20 7468 6520 656d  s path to the em
+000b6f20: 7074 7920 7374 7269 6e67 2061 6e64 2073  pty string and s
+000b6f30: 6574 2073 7461 7465 2074 6f0a 2020 2020  et state to.    
+000b6f40: 2020 2020 2020 2f2f 206f 7061 7175 6520        // opaque 
+000b6f50: 7061 7468 2073 7461 7465 2e0a 2020 2020  path state..    
+000b6f60: 2020 2020 2020 656c 7365 207b 0a20 2020        else {.   
+000b6f70: 2020 2020 2020 2020 2073 7461 7465 203d           state =
+000b6f80: 2061 6461 3a3a 7374 6174 653a 3a4f 5041   ada::state::OPA
+000b6f90: 5155 455f 5041 5448 3b0a 2020 2020 2020  QUE_PATH;.      
+000b6fa0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+000b6fb0: 2020 2020 2020 2020 2f2f 204f 7468 6572          // Other
+000b6fc0: 7769 7365 2c20 6966 2073 7461 7465 206f  wise, if state o
+000b6fd0: 7665 7272 6964 6520 6973 206e 6f74 2067  verride is not g
+000b6fe0: 6976 656e 2c20 7365 7420 6275 6666 6572  iven, set buffer
+000b6ff0: 2074 6f20 7468 6520 656d 7074 790a 2020   to the empty.  
+000b7000: 2020 2020 2020 2f2f 2073 7472 696e 672c        // string,
+000b7010: 2073 7461 7465 2074 6f20 6e6f 2073 6368   state to no sch
+000b7020: 656d 6520 7374 6174 652c 2061 6e64 2073  eme state, and s
+000b7030: 7461 7274 206f 7665 7220 2866 726f 6d20  tart over (from 
+000b7040: 7468 6520 6669 7273 7420 636f 6465 0a20  the first code. 
+000b7050: 2020 2020 2020 202f 2f20 706f 696e 7420         // point 
+000b7060: 696e 2069 6e70 7574 292e 0a20 2020 2020  in input)..     
+000b7070: 2020 2065 6c73 6520 7b0a 2020 2020 2020     else {.      
+000b7080: 2020 2020 7374 6174 6520 3d20 6164 613a      state = ada:
+000b7090: 3a73 7461 7465 3a3a 4e4f 5f53 4348 454d  :state::NO_SCHEM
+000b70a0: 453b 0a20 2020 2020 2020 2020 2069 6e70  E;.          inp
+000b70b0: 7574 5f70 6f73 6974 696f 6e20 3d20 303b  ut_position = 0;
+000b70c0: 0a20 2020 2020 2020 2020 2062 7265 616b  .          break
+000b70d0: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+000b70e0: 2020 2020 696e 7075 745f 706f 7369 7469      input_positi
+000b70f0: 6f6e 2b2b 3b0a 2020 2020 2020 2020 6272  on++;.        br
+000b7100: 6561 6b3b 0a20 2020 2020 207d 0a20 2020  eak;.      }.   
+000b7110: 2020 2063 6173 6520 6164 613a 3a73 7461     case ada::sta
+000b7120: 7465 3a3a 4e4f 5f53 4348 454d 453a 207b  te::NO_SCHEME: {
+000b7130: 0a20 2020 2020 2020 2061 6461 5f6c 6f67  .        ada_log
+000b7140: 2822 4e4f 5f53 4348 454d 4520 222c 2068  ("NO_SCHEME ", h
+000b7150: 656c 7065 7273 3a3a 7375 6273 7472 696e  elpers::substrin
+000b7160: 6728 7572 6c5f 6461 7461 2c20 696e 7075  g(url_data, inpu
+000b7170: 745f 706f 7369 7469 6f6e 2929 3b0a 2020  t_position));.  
+000b7180: 2020 2020 2020 2f2f 2049 6620 6261 7365        // If base
+000b7190: 2069 7320 6e75 6c6c 2c20 6f72 2062 6173   is null, or bas
+000b71a0: 6520 6861 7320 616e 206f 7061 7175 6520  e has an opaque 
+000b71b0: 7061 7468 2061 6e64 2063 2069 7320 6e6f  path and c is no
+000b71c0: 7420 552b 3030 3233 2028 2329 2c0a 2020  t U+0023 (#),.  
+000b71d0: 2020 2020 2020 2f2f 2076 616c 6964 6174        // validat
+000b71e0: 696f 6e20 6572 726f 722c 2072 6574 7572  ion error, retur
+000b71f0: 6e20 6661 696c 7572 652e 0a20 2020 2020  n failure..     
+000b7200: 2020 2069 6620 2862 6173 655f 7572 6c20     if (base_url 
+000b7210: 3d3d 206e 756c 6c70 7472 207c 7c0a 2020  == nullptr ||.  
+000b7220: 2020 2020 2020 2020 2020 2862 6173 655f            (base_
+000b7230: 7572 6c2d 3e68 6173 5f6f 7061 7175 655f  url->has_opaque_
+000b7240: 7061 7468 2026 2620 2166 7261 676d 656e  path && !fragmen
+000b7250: 742e 6861 735f 7661 6c75 6528 2929 2920  t.has_value())) 
+000b7260: 7b0a 2020 2020 2020 2020 2020 6164 615f  {.          ada_
+000b7270: 6c6f 6728 224e 4f5f 5343 4845 4d45 2076  log("NO_SCHEME v
+000b7280: 616c 6964 6174 696f 6e20 6572 726f 7222  alidation error"
+000b7290: 293b 0a20 2020 2020 2020 2020 2075 726c  );.          url
+000b72a0: 2e69 735f 7661 6c69 6420 3d20 6661 6c73  .is_valid = fals
+000b72b0: 653b 0a20 2020 2020 2020 2020 2072 6574  e;.          ret
+000b72c0: 7572 6e20 7572 6c3b 0a20 2020 2020 2020  urn url;.       
+000b72d0: 207d 0a20 2020 2020 2020 202f 2f20 4f74   }.        // Ot
+000b72e0: 6865 7277 6973 652c 2069 6620 6261 7365  herwise, if base
+000b72f0: 2068 6173 2061 6e20 6f70 6171 7565 2070   has an opaque p
+000b7300: 6174 6820 616e 6420 6320 6973 2055 2b30  ath and c is U+0
+000b7310: 3032 3320 2823 292c 0a20 2020 2020 2020  023 (#),.       
+000b7320: 202f 2f20 7365 7420 7572 6ce2 8099 7320   // set url...s 
+000b7330: 7363 6865 6d65 2074 6f20 6261 7365 e280  scheme to base..
+000b7340: 9973 2073 6368 656d 652c 2075 726c e280  .s scheme, url..
+000b7350: 9973 2070 6174 6820 746f 2062 6173 65e2  .s path to base.
+000b7360: 8099 7320 7061 7468 2c20 7572 6ce2 8099  ..s path, url...
+000b7370: 730a 2020 2020 2020 2020 2f2f 2071 7565  s.        // que
+000b7380: 7279 2074 6f20 6261 7365 e280 9973 2071  ry to base...s q
+000b7390: 7565 7279 2c20 616e 6420 7365 7420 7374  uery, and set st
+000b73a0: 6174 6520 746f 2066 7261 676d 656e 7420  ate to fragment 
+000b73b0: 7374 6174 652e 0a20 2020 2020 2020 2065  state..        e
+000b73c0: 6c73 6520 6966 2028 6261 7365 5f75 726c  lse if (base_url
+000b73d0: 2d3e 6861 735f 6f70 6171 7565 5f70 6174  ->has_opaque_pat
+000b73e0: 6820 2626 2066 7261 676d 656e 742e 6861  h && fragment.ha
+000b73f0: 735f 7661 6c75 6528 2920 2626 0a20 2020  s_value() &&.   
+000b7400: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000b7410: 7075 745f 706f 7369 7469 6f6e 203d 3d20  put_position == 
+000b7420: 696e 7075 745f 7369 7a65 2920 7b0a 2020  input_size) {.  
+000b7430: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
+000b7440: 224e 4f5f 5343 4845 4d45 206f 7061 7175  "NO_SCHEME opaqu
+000b7450: 6520 6261 7365 2077 6974 6820 6672 6167  e base with frag
+000b7460: 6d65 6e74 2229 3b0a 2020 2020 2020 2020  ment");.        
+000b7470: 2020 7572 6c2e 636f 7079 5f73 6368 656d    url.copy_schem
+000b7480: 6528 2a62 6173 655f 7572 6c29 3b0a 2020  e(*base_url);.  
+000b7490: 2020 2020 2020 2020 7572 6c2e 6861 735f          url.has_
+000b74a0: 6f70 6171 7565 5f70 6174 6820 3d20 6261  opaque_path = ba
+000b74b0: 7365 5f75 726c 2d3e 6861 735f 6f70 6171  se_url->has_opaq
+000b74c0: 7565 5f70 6174 683b 0a0a 2020 2020 2020  ue_path;..      
+000b74d0: 2020 2020 6966 2063 6f6e 7374 6578 7072      if constexpr
+000b74e0: 2028 7265 7375 6c74 5f74 7970 655f 6973   (result_type_is
+000b74f0: 5f61 6461 5f75 726c 2920 7b0a 2020 2020  _ada_url) {.    
+000b7500: 2020 2020 2020 2020 7572 6c2e 7061 7468          url.path
+000b7510: 203d 2062 6173 655f 7572 6c2d 3e70 6174   = base_url->pat
+000b7520: 683b 0a20 2020 2020 2020 2020 2020 2075  h;.            u
+000b7530: 726c 2e71 7565 7279 203d 2062 6173 655f  rl.query = base_
+000b7540: 7572 6c2d 3e71 7565 7279 3b0a 2020 2020  url->query;.    
+000b7550: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+000b7560: 2020 2020 2020 2020 2020 2075 726c 2e75             url.u
+000b7570: 7064 6174 655f 6261 7365 5f70 6174 686e  pdate_base_pathn
+000b7580: 616d 6528 6261 7365 5f75 726c 2d3e 6765  ame(base_url->ge
+000b7590: 745f 7061 7468 6e61 6d65 2829 293b 0a20  t_pathname());. 
+000b75a0: 2020 2020 2020 2020 2020 2075 726c 2e75             url.u
+000b75b0: 7064 6174 655f 6261 7365 5f73 6561 7263  pdate_base_searc
+000b75c0: 6828 6261 7365 5f75 726c 2d3e 6765 745f  h(base_url->get_
+000b75d0: 7365 6172 6368 2829 293b 0a20 2020 2020  search());.     
+000b75e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000b75f0: 2075 726c 2e75 7064 6174 655f 756e 656e   url.update_unen
+000b7600: 636f 6465 645f 6261 7365 5f68 6173 6828  coded_base_hash(
+000b7610: 2a66 7261 676d 656e 7429 3b0a 2020 2020  *fragment);.    
+000b7620: 2020 2020 2020 7265 7475 726e 2075 726c        return url
+000b7630: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+000b7640: 2020 2020 2f2f 204f 7468 6572 7769 7365      // Otherwise
+000b7650: 2c20 6966 2062 6173 65e2 8099 7320 7363  , if base...s sc
+000b7660: 6865 6d65 2069 7320 6e6f 7420 2266 696c  heme is not "fil
+000b7670: 6522 2c20 7365 7420 7374 6174 6520 746f  e", set state to
+000b7680: 2072 656c 6174 6976 650a 2020 2020 2020   relative.      
+000b7690: 2020 2f2f 2073 7461 7465 2061 6e64 2064    // state and d
+000b76a0: 6563 7265 6173 6520 706f 696e 7465 7220  ecrease pointer 
+000b76b0: 6279 2031 2e0a 2020 2020 2020 2020 656c  by 1..        el
+000b76c0: 7365 2069 6620 2862 6173 655f 7572 6c2d  se if (base_url-
+000b76d0: 3e74 7970 6520 213d 2061 6461 3a3a 7363  >type != ada::sc
+000b76e0: 6865 6d65 3a3a 7479 7065 3a3a 4649 4c45  heme::type::FILE
+000b76f0: 2920 7b0a 2020 2020 2020 2020 2020 6164  ) {.          ad
+000b7700: 615f 6c6f 6728 224e 4f5f 5343 4845 4d45  a_log("NO_SCHEME
+000b7710: 206e 6f6e 2d66 696c 6520 7265 6c61 7469   non-file relati
+000b7720: 7665 2070 6174 6822 293b 0a20 2020 2020  ve path");.     
+000b7730: 2020 2020 2073 7461 7465 203d 2061 6461       state = ada
+000b7740: 3a3a 7374 6174 653a 3a52 454c 4154 4956  ::state::RELATIV
+000b7750: 455f 5343 4845 4d45 3b0a 2020 2020 2020  E_SCHEME;.      
+000b7760: 2020 7d0a 2020 2020 2020 2020 2f2f 204f    }.        // O
+000b7770: 7468 6572 7769 7365 2c20 7365 7420 7374  therwise, set st
+000b7780: 6174 6520 746f 2066 696c 6520 7374 6174  ate to file stat
+000b7790: 6520 616e 6420 6465 6372 6561 7365 2070  e and decrease p
+000b77a0: 6f69 6e74 6572 2062 7920 312e 0a20 2020  ointer by 1..   
+000b77b0: 2020 2020 2065 6c73 6520 7b0a 2020 2020       else {.    
+000b77c0: 2020 2020 2020 6164 615f 6c6f 6728 224e        ada_log("N
+000b77d0: 4f5f 5343 4845 4d45 2066 696c 6520 6261  O_SCHEME file ba
+000b77e0: 7365 2074 7970 6522 293b 0a20 2020 2020  se type");.     
+000b77f0: 2020 2020 2073 7461 7465 203d 2061 6461       state = ada
+000b7800: 3a3a 7374 6174 653a 3a46 494c 453b 0a20  ::state::FILE;. 
+000b7810: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000b7820: 2062 7265 616b 3b0a 2020 2020 2020 7d0a   break;.      }.
+000b7830: 2020 2020 2020 6361 7365 2061 6461 3a3a        case ada::
+000b7840: 7374 6174 653a 3a41 5554 484f 5249 5459  state::AUTHORITY
+000b7850: 3a20 7b0a 2020 2020 2020 2020 6164 615f  : {.        ada_
+000b7860: 6c6f 6728 2241 5554 484f 5249 5459 2022  log("AUTHORITY "
+000b7870: 2c20 6865 6c70 6572 733a 3a73 7562 7374  , helpers::subst
+000b7880: 7269 6e67 2875 726c 5f64 6174 612c 2069  ring(url_data, i
+000b7890: 6e70 7574 5f70 6f73 6974 696f 6e29 293b  nput_position));
+000b78a0: 0a20 2020 2020 2020 202f 2f20 6d6f 7374  .        // most
+000b78b0: 2055 524c 7320 6861 7665 206e 6f20 402e   URLs have no @.
+000b78c0: 2048 6176 696e 6720 6e6f 2040 2074 656c   Having no @ tel
+000b78d0: 6c73 2075 7320 7468 6174 2077 6520 646f  ls us that we do
+000b78e0: 6e27 7420 6861 7665 2074 6f20 776f 7272  n't have to worr
+000b78f0: 790a 2020 2020 2020 2020 2f2f 2061 626f  y.        // abo
+000b7900: 7574 2041 5554 484f 5249 5459 2e20 4f66  ut AUTHORITY. Of
+000b7910: 2063 6f75 7273 652c 2077 6520 636f 756c   course, we coul
+000b7920: 6420 6861 7665 2040 2061 6e64 2073 7469  d have @ and sti
+000b7930: 6c6c 206e 6f74 2068 6176 6520 746f 0a20  ll not have to. 
+000b7940: 2020 2020 2020 202f 2f20 776f 7272 7920         // worry 
+000b7950: 6162 6f75 7420 4155 5448 4f52 4954 592e  about AUTHORITY.
+000b7960: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+000b7970: 3a20 496e 7374 6561 6420 6f66 206a 7573  : Instead of jus
+000b7980: 7420 636f 6c6c 6563 7469 6e67 2061 2062  t collecting a b
+000b7990: 6f6f 6c2c 2063 6f6c 6c65 6374 2074 6865  ool, collect the
+000b79a0: 206c 6f63 6174 696f 6e20 6f66 2074 6865   location of the
+000b79b0: 0a20 2020 2020 2020 202f 2f20 2740 2720  .        // '@' 
+000b79c0: 616e 6420 646f 2073 6f6d 6574 6869 6e67  and do something
+000b79d0: 2075 7365 6675 6c20 7769 7468 2069 742e   useful with it.
+000b79e0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+000b79f0: 3a20 5765 2063 6f75 6c64 2064 6f20 7661  : We could do va
+000b7a00: 7269 6f75 7320 7072 6f63 6573 7369 6e67  rious processing
+000b7a10: 2065 6172 6c79 206f 6e2c 2075 7369 6e67   early on, using
+000b7a20: 2061 2073 696e 676c 6520 7061 7373 0a20   a single pass. 
+000b7a30: 2020 2020 2020 202f 2f20 6f76 6572 2074         // over t
+000b7a40: 6865 2073 7472 696e 6720 746f 2063 6f6c  he string to col
+000b7a50: 6c65 6374 2069 6e66 6f72 6d61 7469 6f6e  lect information
+000b7a60: 2061 626f 7574 2069 742c 2065 2e67 2e2c   about it, e.g.,
+000b7a70: 2074 656c 6c69 6e67 2075 730a 2020 2020   telling us.    
+000b7a80: 2020 2020 2f2f 2077 6865 7468 6572 2074      // whether t
+000b7a90: 6865 7265 2069 7320 6120 4020 616e 6420  here is a @ and 
+000b7aa0: 6966 2073 6f2c 2077 6865 7265 2028 6f72  if so, where (or
+000b7ab0: 2068 6f77 206d 616e 7929 2e0a 2020 2020   how many)..    
+000b7ac0: 2020 2020 636f 6e73 7420 626f 6f6c 2063      const bool c
+000b7ad0: 6f6e 7461 696e 735f 616d 7065 7273 616e  ontains_ampersan
+000b7ae0: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+000b7af0: 2875 726c 5f64 6174 612e 6669 6e64 2827  (url_data.find('
+000b7b00: 4027 2c20 696e 7075 745f 706f 7369 7469  @', input_positi
+000b7b10: 6f6e 2920 213d 2073 7464 3a3a 7374 7269  on) != std::stri
+000b7b20: 6e67 5f76 6965 773a 3a6e 706f 7329 3b0a  ng_view::npos);.
+000b7b30: 0a20 2020 2020 2020 2069 6620 2821 636f  .        if (!co
+000b7b40: 6e74 6169 6e73 5f61 6d70 6572 7361 6e64  ntains_ampersand
+000b7b50: 2920 7b0a 2020 2020 2020 2020 2020 7374  ) {.          st
+000b7b60: 6174 6520 3d20 6164 613a 3a73 7461 7465  ate = ada::state
+000b7b70: 3a3a 484f 5354 3b0a 2020 2020 2020 2020  ::HOST;.        
+000b7b80: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+000b7b90: 207d 0a20 2020 2020 2020 2062 6f6f 6c20   }.        bool 
+000b7ba0: 6174 5f73 6967 6e5f 7365 656e 7b66 616c  at_sign_seen{fal
+000b7bb0: 7365 7d3b 0a20 2020 2020 2020 2062 6f6f  se};.        boo
+000b7bc0: 6c20 7061 7373 776f 7264 5f74 6f6b 656e  l password_token
+000b7bd0: 5f73 6565 6e7b 6661 6c73 657d 3b0a 2020  _seen{false};.  
+000b7be0: 2020 2020 2020 2f2a 2a0a 2020 2020 2020        /**.      
+000b7bf0: 2020 202a 2057 6520 6578 7065 6374 2073     * We expect s
+000b7c00: 6f6d 6574 6869 6e67 206f 6620 7468 6520  omething of the 
+000b7c10: 736f 7274 2e2e 2e0a 2020 2020 2020 2020  sort....        
+000b7c20: 202a 2068 7474 7073 3a2f 2f75 7365 723a   * https://user:
+000b7c30: 7061 7373 4065 7861 6d70 6c65 2e63 6f6d  pass@example.com
+000b7c40: 3a31 3233 342f 666f 6f2f 6261 723f 6261  :1234/foo/bar?ba
+000b7c50: 7a23 7175 7578 0a20 2020 2020 2020 2020  z#quux.         
+000b7c60: 2a20 2d2d 2d2d 2d2d 2d2d 5e0a 2020 2020  * --------^.    
+000b7c70: 2020 2020 202a 2f0a 2020 2020 2020 2020       */.        
+000b7c80: 646f 207b 0a20 2020 2020 2020 2020 2073  do {.          s
+000b7c90: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000b7ca0: 7669 6577 203d 2068 656c 7065 7273 3a3a  view = helpers::
+000b7cb0: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000b7cc0: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000b7cd0: 6f6e 293b 0a20 2020 2020 2020 2020 202f  on);.          /
+000b7ce0: 2f20 5468 6520 6465 6c69 6d69 7465 7273  / The delimiters
+000b7cf0: 2061 7265 2040 2c20 2f2c 203f 205c 5c2e   are @, /, ? \\.
+000b7d00: 0a20 2020 2020 2020 2020 2073 697a 655f  .          size_
+000b7d10: 7420 6c6f 6361 7469 6f6e 203d 0a20 2020  t location =.   
+000b7d20: 2020 2020 2020 2020 2020 2075 726c 2e69             url.i
+000b7d30: 735f 7370 6563 6961 6c28 2920 3f20 6865  s_special() ? he
+000b7d40: 6c70 6572 733a 3a66 696e 645f 6175 7468  lpers::find_auth
+000b7d50: 6f72 6974 795f 6465 6c69 6d69 7465 725f  ority_delimiter_
+000b7d60: 7370 6563 6961 6c28 7669 6577 290a 2020  special(view).  
+000b7d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b7d80: 2020 2020 2020 2020 2020 2020 203a 2068               : h
+000b7d90: 656c 7065 7273 3a3a 6669 6e64 5f61 7574  elpers::find_aut
+000b7da0: 686f 7269 7479 5f64 656c 696d 6974 6572  hority_delimiter
+000b7db0: 2876 6965 7729 3b0a 2020 2020 2020 2020  (view);.        
+000b7dc0: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
+000b7dd0: 6577 2061 7574 686f 7269 7479 5f76 6965  ew authority_vie
+000b7de0: 7728 7669 6577 2e64 6174 6128 292c 206c  w(view.data(), l
+000b7df0: 6f63 6174 696f 6e29 3b0a 2020 2020 2020  ocation);.      
+000b7e00: 2020 2020 7369 7a65 5f74 2065 6e64 5f6f      size_t end_o
+000b7e10: 665f 6175 7468 6f72 6974 7920 3d20 696e  f_authority = in
+000b7e20: 7075 745f 706f 7369 7469 6f6e 202b 2061  put_position + a
+000b7e30: 7574 686f 7269 7479 5f76 6965 772e 7369  uthority_view.si
+000b7e40: 7a65 2829 3b0a 2020 2020 2020 2020 2020  ze();.          
+000b7e50: 2f2f 2049 6620 6320 6973 2055 2b30 3034  // If c is U+004
+000b7e60: 3020 2840 292c 2074 6865 6e3a 0a20 2020  0 (@), then:.   
+000b7e70: 2020 2020 2020 2069 6620 2828 656e 645f         if ((end_
+000b7e80: 6f66 5f61 7574 686f 7269 7479 2021 3d20  of_authority != 
+000b7e90: 696e 7075 745f 7369 7a65 2920 2626 0a20  input_size) &&. 
+000b7ea0: 2020 2020 2020 2020 2020 2020 2028 7572               (ur
+000b7eb0: 6c5f 6461 7461 5b65 6e64 5f6f 665f 6175  l_data[end_of_au
+000b7ec0: 7468 6f72 6974 795d 203d 3d20 2740 2729  thority] == '@')
+000b7ed0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000b7ee0: 2f2f 2049 6620 6174 5369 676e 5365 656e  // If atSignSeen
+000b7ef0: 2069 7320 7472 7565 2c20 7468 656e 2070   is true, then p
+000b7f00: 7265 7065 6e64 2022 2534 3022 2074 6f20  repend "%40" to 
+000b7f10: 6275 6666 6572 2e0a 2020 2020 2020 2020  buffer..        
+000b7f20: 2020 2020 6966 2028 6174 5f73 6967 6e5f      if (at_sign_
+000b7f30: 7365 656e 2920 7b0a 2020 2020 2020 2020  seen) {.        
+000b7f40: 2020 2020 2020 6966 2028 7061 7373 776f        if (passwo
+000b7f50: 7264 5f74 6f6b 656e 5f73 6565 6e29 207b  rd_token_seen) {
+000b7f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000b7f70: 2069 6620 636f 6e73 7465 7870 7220 2872   if constexpr (r
+000b7f80: 6573 756c 745f 7479 7065 5f69 735f 6164  esult_type_is_ad
+000b7f90: 615f 7572 6c29 207b 0a20 2020 2020 2020  a_url) {.       
+000b7fa0: 2020 2020 2020 2020 2020 2075 726c 2e70             url.p
+000b7fb0: 6173 7377 6f72 6420 2b3d 2022 2534 3022  assword += "%40"
+000b7fc0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000b7fd0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+000b7fe0: 2020 2020 2020 2020 2020 2020 2075 726c               url
+000b7ff0: 2e61 7070 656e 645f 6261 7365 5f70 6173  .append_base_pas
+000b8000: 7377 6f72 6428 2225 3430 2229 3b0a 2020  sword("%40");.  
+000b8010: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000b8020: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+000b8030: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+000b8040: 2020 2020 2020 2069 6620 636f 6e73 7465         if conste
+000b8050: 7870 7220 2872 6573 756c 745f 7479 7065  xpr (result_type
+000b8060: 5f69 735f 6164 615f 7572 6c29 207b 0a20  _is_ada_url) {. 
+000b8070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b8080: 2075 726c 2e75 7365 726e 616d 6520 2b3d   url.username +=
+000b8090: 2022 2534 3022 3b0a 2020 2020 2020 2020   "%40";.        
+000b80a0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+000b80b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000b80c0: 2020 2075 726c 2e61 7070 656e 645f 6261     url.append_ba
+000b80d0: 7365 5f75 7365 726e 616d 6528 2225 3430  se_username("%40
+000b80e0: 2229 3b0a 2020 2020 2020 2020 2020 2020  ");.            
+000b80f0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000b8100: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000b8110: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+000b8120: 2061 745f 7369 676e 5f73 6565 6e20 3d20   at_sign_seen = 
+000b8130: 7472 7565 3b0a 0a20 2020 2020 2020 2020  true;..         
+000b8140: 2020 2069 6620 2821 7061 7373 776f 7264     if (!password
+000b8150: 5f74 6f6b 656e 5f73 6565 6e29 207b 0a20  _token_seen) {. 
+000b8160: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+000b8170: 655f 7420 7061 7373 776f 7264 5f74 6f6b  e_t password_tok
+000b8180: 656e 5f6c 6f63 6174 696f 6e20 3d20 6175  en_location = au
+000b8190: 7468 6f72 6974 795f 7669 6577 2e66 696e  thority_view.fin
+000b81a0: 6428 273a 2729 3b0a 2020 2020 2020 2020  d(':');.        
+000b81b0: 2020 2020 2020 7061 7373 776f 7264 5f74        password_t
+000b81c0: 6f6b 656e 5f73 6565 6e20 3d0a 2020 2020  oken_seen =.    
+000b81d0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000b81e0: 7373 776f 7264 5f74 6f6b 656e 5f6c 6f63  ssword_token_loc
+000b81f0: 6174 696f 6e20 213d 2073 7464 3a3a 7374  ation != std::st
+000b8200: 7269 6e67 5f76 6965 773a 3a6e 706f 733b  ring_view::npos;
+000b8210: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000b8220: 6966 2028 2170 6173 7377 6f72 645f 746f  if (!password_to
+000b8230: 6b65 6e5f 7365 656e 2920 7b0a 2020 2020  ken_seen) {.    
+000b8240: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+000b8250: 6f6e 7374 6578 7072 2028 7265 7375 6c74  onstexpr (result
+000b8260: 5f74 7970 655f 6973 5f61 6461 5f75 726c  _type_is_ada_url
+000b8270: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000b8280: 2020 2020 2020 7572 6c2e 7573 6572 6e61        url.userna
+000b8290: 6d65 202b 3d20 756e 6963 6f64 653a 3a70  me += unicode::p
+000b82a0: 6572 6365 6e74 5f65 6e63 6f64 6528 0a20  ercent_encode(. 
+000b82b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b82c0: 2020 2020 2061 7574 686f 7269 7479 5f76       authority_v
+000b82d0: 6965 772c 2063 6861 7261 6374 6572 5f73  iew, character_s
+000b82e0: 6574 733a 3a55 5345 5249 4e46 4f5f 5045  ets::USERINFO_PE
+000b82f0: 5243 454e 545f 454e 434f 4445 293b 0a20  RCENT_ENCODE);. 
+000b8300: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000b8310: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+000b8320: 2020 2020 2020 2020 2020 7572 6c2e 6170            url.ap
+000b8330: 7065 6e64 5f62 6173 655f 7573 6572 6e61  pend_base_userna
+000b8340: 6d65 2875 6e69 636f 6465 3a3a 7065 7263  me(unicode::perc
+000b8350: 656e 745f 656e 636f 6465 280a 2020 2020  ent_encode(.    
+000b8360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b8370: 2020 6175 7468 6f72 6974 795f 7669 6577    authority_view
+000b8380: 2c20 6368 6172 6163 7465 725f 7365 7473  , character_sets
+000b8390: 3a3a 5553 4552 494e 464f 5f50 4552 4345  ::USERINFO_PERCE
+000b83a0: 4e54 5f45 4e43 4f44 4529 293b 0a20 2020  NT_ENCODE));.   
+000b83b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000b83c0: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+000b83d0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+000b83e0: 2020 2020 2020 6966 2063 6f6e 7374 6578        if constex
+000b83f0: 7072 2028 7265 7375 6c74 5f74 7970 655f  pr (result_type_
+000b8400: 6973 5f61 6461 5f75 726c 2920 7b0a 2020  is_ada_url) {.  
+000b8410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b8420: 7572 6c2e 7573 6572 6e61 6d65 202b 3d20  url.username += 
+000b8430: 756e 6963 6f64 653a 3a70 6572 6365 6e74  unicode::percent
+000b8440: 5f65 6e63 6f64 6528 0a20 2020 2020 2020  _encode(.       
+000b8450: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000b8460: 7574 686f 7269 7479 5f76 6965 772e 7375  uthority_view.su
+000b8470: 6273 7472 2830 2c20 7061 7373 776f 7264  bstr(0, password
+000b8480: 5f74 6f6b 656e 5f6c 6f63 6174 696f 6e29  _token_location)
+000b8490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000b84a0: 2020 2020 2020 2020 6368 6172 6163 7465          characte
+000b84b0: 725f 7365 7473 3a3a 5553 4552 494e 464f  r_sets::USERINFO
+000b84c0: 5f50 4552 4345 4e54 5f45 4e43 4f44 4529  _PERCENT_ENCODE)
+000b84d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000b84e0: 2020 2020 7572 6c2e 7061 7373 776f 7264      url.password
+000b84f0: 202b 3d20 756e 6963 6f64 653a 3a70 6572   += unicode::per
+000b8500: 6365 6e74 5f65 6e63 6f64 6528 0a20 2020  cent_encode(.   
 000b8510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b8520: 2075 726c 2e61 7070 656e 645f 6261 7365   url.append_base
-000b8530: 5f75 7365 726e 616d 6528 756e 6963 6f64  _username(unicod
-000b8540: 653a 3a70 6572 6365 6e74 5f65 6e63 6f64  e::percent_encod
-000b8550: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-000b8560: 2020 2020 2020 2020 2061 7574 686f 7269           authori
-000b8570: 7479 5f76 6965 772e 7375 6273 7472 2830  ty_view.substr(0
-000b8580: 2c20 7061 7373 776f 7264 5f74 6f6b 656e  , password_token
-000b8590: 5f6c 6f63 6174 696f 6e29 2c0a 2020 2020  _location),.    
-000b85a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b85b0: 2020 6368 6172 6163 7465 725f 7365 7473    character_sets
-000b85c0: 3a3a 5553 4552 494e 464f 5f50 4552 4345  ::USERINFO_PERCE
-000b85d0: 4e54 5f45 4e43 4f44 4529 293b 0a20 2020  NT_ENCODE));.   
-000b85e0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000b85f0: 726c 2e61 7070 656e 645f 6261 7365 5f70  rl.append_base_p
-000b8600: 6173 7377 6f72 6428 756e 6963 6f64 653a  assword(unicode:
-000b8610: 3a70 6572 6365 6e74 5f65 6e63 6f64 6528  :percent_encode(
-000b8620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b8630: 2020 2020 2020 2061 7574 686f 7269 7479         authority
-000b8640: 5f76 6965 772e 7375 6273 7472 2870 6173  _view.substr(pas
-000b8650: 7377 6f72 645f 746f 6b65 6e5f 6c6f 6361  sword_token_loca
-000b8660: 7469 6f6e 202b 2031 292c 0a20 2020 2020  tion + 1),.     
-000b8670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b8680: 2063 6861 7261 6374 6572 5f73 6574 733a   character_sets:
-000b8690: 3a55 5345 5249 4e46 4f5f 5045 5243 454e  :USERINFO_PERCEN
-000b86a0: 545f 454e 434f 4445 2929 3b0a 2020 2020  T_ENCODE));.    
-000b86b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000b86c0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000b86d0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-000b86e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000b86f0: 2069 6620 636f 6e73 7465 7870 7220 2872   if constexpr (r
-000b8700: 6573 756c 745f 7479 7065 5f69 735f 6164  esult_type_is_ad
-000b8710: 615f 7572 6c29 207b 0a20 2020 2020 2020  a_url) {.       
-000b8720: 2020 2020 2020 2020 2075 726c 2e70 6173           url.pas
-000b8730: 7377 6f72 6420 2b3d 2075 6e69 636f 6465  sword += unicode
-000b8740: 3a3a 7065 7263 656e 745f 656e 636f 6465  ::percent_encode
-000b8750: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000b8760: 2020 2020 2020 6175 7468 6f72 6974 795f        authority_
-000b8770: 7669 6577 2c20 6368 6172 6163 7465 725f  view, character_
-000b8780: 7365 7473 3a3a 5553 4552 494e 464f 5f50  sets::USERINFO_P
-000b8790: 4552 4345 4e54 5f45 4e43 4f44 4529 3b0a  ERCENT_ENCODE);.
-000b87a0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-000b87b0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-000b87c0: 2020 2020 2020 2075 726c 2e61 7070 656e         url.appen
-000b87d0: 645f 6261 7365 5f70 6173 7377 6f72 6428  d_base_password(
-000b87e0: 756e 6963 6f64 653a 3a70 6572 6365 6e74  unicode::percent
-000b87f0: 5f65 6e63 6f64 6528 0a20 2020 2020 2020  _encode(.       
-000b8800: 2020 2020 2020 2020 2020 2020 2061 7574               aut
-000b8810: 686f 7269 7479 5f76 6965 772c 2063 6861  hority_view, cha
-000b8820: 7261 6374 6572 5f73 6574 733a 3a55 5345  racter_sets::USE
-000b8830: 5249 4e46 4f5f 5045 5243 454e 545f 454e  RINFO_PERCENT_EN
-000b8840: 434f 4445 2929 3b0a 2020 2020 2020 2020  CODE));.        
-000b8850: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000b8860: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000b8870: 7d0a 2020 2020 2020 2020 2020 2f2f 204f  }.          // O
-000b8880: 7468 6572 7769 7365 2c20 6966 206f 6e65  therwise, if one
-000b8890: 206f 6620 7468 6520 666f 6c6c 6f77 696e   of the followin
-000b88a0: 6720 6973 2074 7275 653a 0a20 2020 2020  g is true:.     
-000b88b0: 2020 2020 202f 2f20 2d20 6320 6973 2074       // - c is t
-000b88c0: 6865 2045 4f46 2063 6f64 6520 706f 696e  he EOF code poin
-000b88d0: 742c 2055 2b30 3032 4620 282f 292c 2055  t, U+002F (/), U
-000b88e0: 2b30 3033 4620 283f 292c 206f 7220 552b  +003F (?), or U+
-000b88f0: 3030 3233 2028 2329 0a20 2020 2020 2020  0023 (#).       
-000b8900: 2020 202f 2f20 2d20 7572 6c20 6973 2073     // - url is s
-000b8910: 7065 6369 616c 2061 6e64 2063 2069 7320  pecial and c is 
-000b8920: 552b 3030 3543 2028 5c29 0a20 2020 2020  U+005C (\).     
-000b8930: 2020 2020 2065 6c73 6520 6966 2028 656e       else if (en
-000b8940: 645f 6f66 5f61 7574 686f 7269 7479 203d  d_of_authority =
-000b8950: 3d20 696e 7075 745f 7369 7a65 207c 7c0a  = input_size ||.
-000b8960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b8970: 2020 2075 726c 5f64 6174 615b 656e 645f     url_data[end_
-000b8980: 6f66 5f61 7574 686f 7269 7479 5d20 3d3d  of_authority] ==
-000b8990: 2027 2f27 207c 7c0a 2020 2020 2020 2020   '/' ||.        
-000b89a0: 2020 2020 2020 2020 2020 2075 726c 5f64             url_d
-000b89b0: 6174 615b 656e 645f 6f66 5f61 7574 686f  ata[end_of_autho
-000b89c0: 7269 7479 5d20 3d3d 2027 3f27 207c 7c0a  rity] == '?' ||.
-000b89d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b89e0: 2020 2028 7572 6c2e 6973 5f73 7065 6369     (url.is_speci
-000b89f0: 616c 2829 2026 2620 7572 6c5f 6461 7461  al() && url_data
-000b8a00: 5b65 6e64 5f6f 665f 6175 7468 6f72 6974  [end_of_authorit
-000b8a10: 795d 203d 3d20 275c 5c27 2929 207b 0a20  y] == '\\')) {. 
-000b8a20: 2020 2020 2020 2020 2020 202f 2f20 4966             // If
-000b8a30: 2061 7453 6967 6e53 6565 6e20 6973 2074   atSignSeen is t
-000b8a40: 7275 6520 616e 6420 6175 7468 6f72 6974  rue and authorit
-000b8a50: 795f 7669 6577 2069 7320 7468 6520 656d  y_view is the em
-000b8a60: 7074 7920 7374 7269 6e67 2c0a 2020 2020  pty string,.    
-000b8a70: 2020 2020 2020 2020 2f2f 2076 616c 6964          // valid
-000b8a80: 6174 696f 6e20 6572 726f 722c 2072 6574  ation error, ret
-000b8a90: 7572 6e20 6661 696c 7572 652e 0a20 2020  urn failure..   
-000b8aa0: 2020 2020 2020 2020 2069 6620 2861 745f           if (at_
-000b8ab0: 7369 676e 5f73 6565 6e20 2626 2061 7574  sign_seen && aut
-000b8ac0: 686f 7269 7479 5f76 6965 772e 656d 7074  hority_view.empt
-000b8ad0: 7928 2929 207b 0a20 2020 2020 2020 2020  y()) {.         
-000b8ae0: 2020 2020 2075 726c 2e69 735f 7661 6c69       url.is_vali
-000b8af0: 6420 3d20 6661 6c73 653b 0a20 2020 2020  d = false;.     
-000b8b00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000b8b10: 7572 6c3b 0a20 2020 2020 2020 2020 2020  url;.           
-000b8b20: 207d 0a20 2020 2020 2020 2020 2020 2073   }.            s
-000b8b30: 7461 7465 203d 2061 6461 3a3a 7374 6174  tate = ada::stat
-000b8b40: 653a 3a48 4f53 543b 0a20 2020 2020 2020  e::HOST;.       
-000b8b50: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
-000b8b60: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000b8b70: 2020 6966 2028 656e 645f 6f66 5f61 7574    if (end_of_aut
-000b8b80: 686f 7269 7479 203d 3d20 696e 7075 745f  hority == input_
-000b8b90: 7369 7a65 2920 7b0a 2020 2020 2020 2020  size) {.        
-000b8ba0: 2020 2020 6966 2028 6672 6167 6d65 6e74      if (fragment
-000b8bb0: 2e68 6173 5f76 616c 7565 2829 2920 7b0a  .has_value()) {.
-000b8bc0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-000b8bd0: 6c2e 7570 6461 7465 5f75 6e65 6e63 6f64  l.update_unencod
-000b8be0: 6564 5f62 6173 655f 6861 7368 282a 6672  ed_base_hash(*fr
-000b8bf0: 6167 6d65 6e74 293b 0a20 2020 2020 2020  agment);.       
-000b8c00: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000b8c10: 2020 2072 6574 7572 6e20 7572 6c3b 0a20     return url;. 
-000b8c20: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000b8c30: 2020 2020 2069 6e70 7574 5f70 6f73 6974       input_posit
-000b8c40: 696f 6e20 3d20 656e 645f 6f66 5f61 7574  ion = end_of_aut
-000b8c50: 686f 7269 7479 202b 2031 3b0a 2020 2020  hority + 1;.    
-000b8c60: 2020 2020 7d20 7768 696c 6520 2874 7275      } while (tru
-000b8c70: 6529 3b0a 0a20 2020 2020 2020 2062 7265  e);..        bre
-000b8c80: 616b 3b0a 2020 2020 2020 7d0a 2020 2020  ak;.      }.    
-000b8c90: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000b8ca0: 653a 3a53 5045 4349 414c 5f52 454c 4154  e::SPECIAL_RELAT
-000b8cb0: 4956 455f 4f52 5f41 5554 484f 5249 5459  IVE_OR_AUTHORITY
-000b8cc0: 3a20 7b0a 2020 2020 2020 2020 6164 615f  : {.        ada_
-000b8cd0: 6c6f 6728 2253 5045 4349 414c 5f52 454c  log("SPECIAL_REL
-000b8ce0: 4154 4956 455f 4f52 5f41 5554 484f 5249  ATIVE_OR_AUTHORI
-000b8cf0: 5459 2022 2c0a 2020 2020 2020 2020 2020  TY ",.          
-000b8d00: 2020 2020 2020 6865 6c70 6572 733a 3a73        helpers::s
-000b8d10: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000b8d20: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000b8d30: 6e29 293b 0a0a 2020 2020 2020 2020 2f2f  n));..        //
-000b8d40: 2049 6620 6320 6973 2055 2b30 3032 4620   If c is U+002F 
-000b8d50: 282f 2920 616e 6420 7265 6d61 696e 696e  (/) and remainin
-000b8d60: 6720 7374 6172 7473 2077 6974 6820 552b  g starts with U+
-000b8d70: 3030 3246 2028 2f29 2c0a 2020 2020 2020  002F (/),.      
-000b8d80: 2020 2f2f 2074 6865 6e20 7365 7420 7374    // then set st
-000b8d90: 6174 6520 746f 2073 7065 6369 616c 2061  ate to special a
-000b8da0: 7574 686f 7269 7479 2069 676e 6f72 6520  uthority ignore 
-000b8db0: 736c 6173 6865 7320 7374 6174 6520 616e  slashes state an
-000b8dc0: 6420 696e 6372 6561 7365 0a20 2020 2020  d increase.     
-000b8dd0: 2020 202f 2f20 706f 696e 7465 7220 6279     // pointer by
-000b8de0: 2031 2e0a 2020 2020 2020 2020 7374 643a   1..        std:
-000b8df0: 3a73 7472 696e 675f 7669 6577 2076 6965  :string_view vie
-000b8e00: 7720 3d20 6865 6c70 6572 733a 3a73 7562  w = helpers::sub
-000b8e10: 7374 7269 6e67 2875 726c 5f64 6174 612c  string(url_data,
-000b8e20: 2069 6e70 7574 5f70 6f73 6974 696f 6e29   input_position)
-000b8e30: 3b0a 2020 2020 2020 2020 6966 2028 6164  ;.        if (ad
-000b8e40: 613a 3a63 6865 636b 6572 733a 3a62 6567  a::checkers::beg
-000b8e50: 696e 735f 7769 7468 2876 6965 772c 2022  ins_with(view, "
-000b8e60: 2f2f 2229 2920 7b0a 2020 2020 2020 2020  //")) {.        
-000b8e70: 2020 7374 6174 6520 3d20 6164 613a 3a73    state = ada::s
-000b8e80: 7461 7465 3a3a 5350 4543 4941 4c5f 4155  tate::SPECIAL_AU
-000b8e90: 5448 4f52 4954 595f 4947 4e4f 5245 5f53  THORITY_IGNORE_S
-000b8ea0: 4c41 5348 4553 3b0a 2020 2020 2020 2020  LASHES;.        
-000b8eb0: 2020 696e 7075 745f 706f 7369 7469 6f6e    input_position
-000b8ec0: 202b 3d20 323b 0a20 2020 2020 2020 207d   += 2;.        }
-000b8ed0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-000b8ee0: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
-000b8ef0: 7661 6c69 6461 7469 6f6e 2065 7272 6f72  validation error
-000b8f00: 2c20 7365 7420 7374 6174 6520 746f 2072  , set state to r
-000b8f10: 656c 6174 6976 6520 7374 6174 6520 616e  elative state an
-000b8f20: 640a 2020 2020 2020 2020 2020 2f2f 2064  d.          // d
-000b8f30: 6563 7265 6173 6520 706f 696e 7465 7220  ecrease pointer 
-000b8f40: 6279 2031 2e0a 2020 2020 2020 2020 2020  by 1..          
-000b8f50: 7374 6174 6520 3d20 6164 613a 3a73 7461  state = ada::sta
-000b8f60: 7465 3a3a 5245 4c41 5449 5645 5f53 4348  te::RELATIVE_SCH
-000b8f70: 454d 453b 0a20 2020 2020 2020 207d 0a0a  EME;.        }..
-000b8f80: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-000b8f90: 2020 2020 207d 0a20 2020 2020 2063 6173       }.      cas
-000b8fa0: 6520 6164 613a 3a73 7461 7465 3a3a 5041  e ada::state::PA
-000b8fb0: 5448 5f4f 525f 4155 5448 4f52 4954 593a  TH_OR_AUTHORITY:
-000b8fc0: 207b 0a20 2020 2020 2020 2061 6461 5f6c   {.        ada_l
-000b8fd0: 6f67 2822 5041 5448 5f4f 525f 4155 5448  og("PATH_OR_AUTH
-000b8fe0: 4f52 4954 5920 222c 0a20 2020 2020 2020  ORITY ",.       
-000b8ff0: 2020 2020 2020 2020 2068 656c 7065 7273           helpers
-000b9000: 3a3a 7375 6273 7472 696e 6728 7572 6c5f  ::substring(url_
-000b9010: 6461 7461 2c20 696e 7075 745f 706f 7369  data, input_posi
-000b9020: 7469 6f6e 2929 3b0a 0a20 2020 2020 2020  tion));..       
-000b9030: 202f 2f20 4966 2063 2069 7320 552b 3030   // If c is U+00
-000b9040: 3246 2028 2f29 2c20 7468 656e 2073 6574  2F (/), then set
-000b9050: 2073 7461 7465 2074 6f20 6175 7468 6f72   state to author
-000b9060: 6974 7920 7374 6174 652e 0a20 2020 2020  ity state..     
-000b9070: 2020 2069 6620 2828 696e 7075 745f 706f     if ((input_po
-000b9080: 7369 7469 6f6e 2021 3d20 696e 7075 745f  sition != input_
-000b9090: 7369 7a65 2920 2626 0a20 2020 2020 2020  size) &&.       
-000b90a0: 2020 2020 2028 7572 6c5f 6461 7461 5b69       (url_data[i
-000b90b0: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
-000b90c0: 3d20 272f 2729 2920 7b0a 2020 2020 2020  = '/')) {.      
-000b90d0: 2020 2020 7374 6174 6520 3d20 6164 613a      state = ada:
-000b90e0: 3a73 7461 7465 3a3a 4155 5448 4f52 4954  :state::AUTHORIT
-000b90f0: 593b 0a20 2020 2020 2020 2020 2069 6e70  Y;.          inp
-000b9100: 7574 5f70 6f73 6974 696f 6e2b 2b3b 0a20  ut_position++;. 
-000b9110: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-000b9120: 2020 2020 2020 2020 2020 2f2f 204f 7468            // Oth
-000b9130: 6572 7769 7365 2c20 7365 7420 7374 6174  erwise, set stat
-000b9140: 6520 746f 2070 6174 6820 7374 6174 652c  e to path state,
-000b9150: 2061 6e64 2064 6563 7265 6173 6520 706f   and decrease po
-000b9160: 696e 7465 7220 6279 2031 2e0a 2020 2020  inter by 1..    
-000b9170: 2020 2020 2020 7374 6174 6520 3d20 6164        state = ad
-000b9180: 613a 3a73 7461 7465 3a3a 5041 5448 3b0a  a::state::PATH;.
-000b9190: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000b91a0: 2020 2062 7265 616b 3b0a 2020 2020 2020     break;.      
-000b91b0: 7d0a 2020 2020 2020 6361 7365 2061 6461  }.      case ada
-000b91c0: 3a3a 7374 6174 653a 3a52 454c 4154 4956  ::state::RELATIV
-000b91d0: 455f 5343 4845 4d45 3a20 7b0a 2020 2020  E_SCHEME: {.    
-000b91e0: 2020 2020 6164 615f 6c6f 6728 2252 454c      ada_log("REL
-000b91f0: 4154 4956 455f 5343 4845 4d45 2022 2c0a  ATIVE_SCHEME ",.
-000b9200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b9210: 6865 6c70 6572 733a 3a73 7562 7374 7269  helpers::substri
-000b9220: 6e67 2875 726c 5f64 6174 612c 2069 6e70  ng(url_data, inp
-000b9230: 7574 5f70 6f73 6974 696f 6e29 293b 0a0a  ut_position));..
-000b9240: 2020 2020 2020 2020 2f2f 2053 6574 2075          // Set u
-000b9250: 726c e280 9973 2073 6368 656d 6520 746f  rl...s scheme to
-000b9260: 2062 6173 65e2 8099 7320 7363 6865 6d65   base...s scheme
-000b9270: 2e0a 2020 2020 2020 2020 7572 6c2e 636f  ..        url.co
-000b9280: 7079 5f73 6368 656d 6528 2a62 6173 655f  py_scheme(*base_
-000b9290: 7572 6c29 3b0a 0a20 2020 2020 2020 202f  url);..        /
-000b92a0: 2f20 4966 2063 2069 7320 552b 3030 3246  / If c is U+002F
-000b92b0: 2028 2f29 2c20 7468 656e 2073 6574 2073   (/), then set s
-000b92c0: 7461 7465 2074 6f20 7265 6c61 7469 7665  tate to relative
-000b92d0: 2073 6c61 7368 2073 7461 7465 2e0a 2020   slash state..  
-000b92e0: 2020 2020 2020 6966 2028 2869 6e70 7574        if ((input
-000b92f0: 5f70 6f73 6974 696f 6e20 213d 2069 6e70  _position != inp
-000b9300: 7574 5f73 697a 6529 2026 260a 2020 2020  ut_size) &&.    
-000b9310: 2020 2020 2020 2020 2875 726c 5f64 6174          (url_dat
-000b9320: 615b 696e 7075 745f 706f 7369 7469 6f6e  a[input_position
-000b9330: 5d20 3d3d 2027 2f27 2929 207b 0a20 2020  ] == '/')) {.   
-000b9340: 2020 2020 2020 2061 6461 5f6c 6f67 280a         ada_log(.
-000b9350: 2020 2020 2020 2020 2020 2020 2020 2252                "R
-000b9360: 454c 4154 4956 455f 5343 4845 4d45 2069  ELATIVE_SCHEME i
-000b9370: 6620 6320 6973 2055 2b30 3032 4620 282f  f c is U+002F (/
-000b9380: 292c 2074 6865 6e20 7365 7420 7374 6174  ), then set stat
-000b9390: 6520 746f 2072 656c 6174 6976 6520 220a  e to relative ".
-000b93a0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-000b93b0: 6c61 7368 2073 7461 7465 2229 3b0a 2020  lash state");.  
-000b93c0: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-000b93d0: 6164 613a 3a73 7461 7465 3a3a 5245 4c41  ada::state::RELA
-000b93e0: 5449 5645 5f53 4c41 5348 3b0a 2020 2020  TIVE_SLASH;.    
-000b93f0: 2020 2020 7d20 656c 7365 2069 6620 2875      } else if (u
-000b9400: 726c 2e69 735f 7370 6563 6961 6c28 2920  rl.is_special() 
-000b9410: 2626 2028 696e 7075 745f 706f 7369 7469  && (input_positi
-000b9420: 6f6e 2021 3d20 696e 7075 745f 7369 7a65  on != input_size
-000b9430: 2920 2626 0a20 2020 2020 2020 2020 2020  ) &&.           
-000b9440: 2020 2020 2020 2020 2875 726c 5f64 6174          (url_dat
-000b9450: 615b 696e 7075 745f 706f 7369 7469 6f6e  a[input_position
-000b9460: 5d20 3d3d 2027 5c5c 2729 2920 7b0a 2020  ] == '\\')) {.  
-000b9470: 2020 2020 2020 2020 2f2f 204f 7468 6572          // Other
-000b9480: 7769 7365 2c20 6966 2075 726c 2069 7320  wise, if url is 
-000b9490: 7370 6563 6961 6c20 616e 6420 6320 6973  special and c is
-000b94a0: 2055 2b30 3035 4320 285c 292c 2076 616c   U+005C (\), val
-000b94b0: 6964 6174 696f 6e20 6572 726f 722c 0a20  idation error,. 
-000b94c0: 2020 2020 2020 2020 202f 2f20 7365 7420           // set 
-000b94d0: 7374 6174 6520 746f 2072 656c 6174 6976  state to relativ
-000b94e0: 6520 736c 6173 6820 7374 6174 652e 0a20  e slash state.. 
-000b94f0: 2020 2020 2020 2020 2061 6461 5f6c 6f67           ada_log
-000b9500: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000b9510: 2252 454c 4154 4956 455f 5343 4845 4d45  "RELATIVE_SCHEME
-000b9520: 2020 6966 2075 726c 2069 7320 7370 6563    if url is spec
-000b9530: 6961 6c20 616e 6420 6320 6973 2055 2b30  ial and c is U+0
-000b9540: 3035 432c 2076 616c 6964 6174 696f 6e20  05C, validation 
-000b9550: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000b9560: 2265 7272 6f72 2c20 7365 7420 7374 6174  "error, set stat
-000b9570: 6520 746f 2072 656c 6174 6976 6520 736c  e to relative sl
-000b9580: 6173 6820 7374 6174 6522 293b 0a20 2020  ash state");.   
-000b9590: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
-000b95a0: 6461 3a3a 7374 6174 653a 3a52 454c 4154  da::state::RELAT
-000b95b0: 4956 455f 534c 4153 483b 0a20 2020 2020  IVE_SLASH;.     
-000b95c0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-000b95d0: 2020 2020 2020 6164 615f 6c6f 6728 2252        ada_log("R
-000b95e0: 454c 4154 4956 455f 5343 4845 4d45 206f  ELATIVE_SCHEME o
-000b95f0: 7468 6572 7769 7365 2229 3b0a 2020 2020  therwise");.    
-000b9600: 2020 2020 2020 2f2f 2053 6574 2075 726c        // Set url
-000b9610: e280 9973 2075 7365 726e 616d 6520 746f  ...s username to
-000b9620: 2062 6173 65e2 8099 7320 7573 6572 6e61   base...s userna
-000b9630: 6d65 2c20 7572 6ce2 8099 7320 7061 7373  me, url...s pass
-000b9640: 776f 7264 2074 6f20 6261 7365 e280 9973  word to base...s
-000b9650: 0a20 2020 2020 2020 2020 202f 2f20 7061  .          // pa
-000b9660: 7373 776f 7264 2c20 7572 6ce2 8099 7320  ssword, url...s 
-000b9670: 686f 7374 2074 6f20 6261 7365 e280 9973  host to base...s
-000b9680: 2068 6f73 742c 2075 726c e280 9973 2070   host, url...s p
-000b9690: 6f72 7420 746f 2062 6173 65e2 8099 7320  ort to base...s 
-000b96a0: 706f 7274 2c0a 2020 2020 2020 2020 2020  port,.          
-000b96b0: 2f2f 2075 726c e280 9973 2070 6174 6820  // url...s path 
-000b96c0: 746f 2061 2063 6c6f 6e65 206f 6620 6261  to a clone of ba
-000b96d0: 7365 e280 9973 2070 6174 682c 2061 6e64  se...s path, and
-000b96e0: 2075 726c e280 9973 2071 7565 7279 2074   url...s query t
-000b96f0: 6f20 6261 7365 e280 9973 0a20 2020 2020  o base...s.     
-000b9700: 2020 2020 202f 2f20 7175 6572 792e 0a20       // query.. 
-000b9710: 2020 2020 2020 2020 2069 6620 636f 6e73           if cons
-000b9720: 7465 7870 7220 2872 6573 756c 745f 7479  texpr (result_ty
-000b9730: 7065 5f69 735f 6164 615f 7572 6c29 207b  pe_is_ada_url) {
-000b9740: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-000b9750: 2e75 7365 726e 616d 6520 3d20 6261 7365  .username = base
-000b9760: 5f75 726c 2d3e 7573 6572 6e61 6d65 3b0a  _url->username;.
-000b9770: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
-000b9780: 7061 7373 776f 7264 203d 2062 6173 655f  password = base_
-000b9790: 7572 6c2d 3e70 6173 7377 6f72 643b 0a20  url->password;. 
-000b97a0: 2020 2020 2020 2020 2020 2075 726c 2e68             url.h
-000b97b0: 6f73 7420 3d20 6261 7365 5f75 726c 2d3e  ost = base_url->
-000b97c0: 686f 7374 3b0a 2020 2020 2020 2020 2020  host;.          
-000b97d0: 2020 7572 6c2e 706f 7274 203d 2062 6173    url.port = bas
-000b97e0: 655f 7572 6c2d 3e70 6f72 743b 0a20 2020  e_url->port;.   
-000b97f0: 2020 2020 2020 2020 202f 2f20 636c 6f6e           // clon
-000b9800: 696e 6720 7468 6520 6261 7365 2070 6174  ing the base pat
-000b9810: 6820 696e 636c 7564 6573 2063 6c6f 6e69  h includes cloni
-000b9820: 6e67 2074 6865 2068 6173 5f6f 7061 7175  ng the has_opaqu
-000b9830: 655f 7061 7468 2066 6c61 670a 2020 2020  e_path flag.    
-000b9840: 2020 2020 2020 2020 7572 6c2e 6861 735f          url.has_
-000b9850: 6f70 6171 7565 5f70 6174 6820 3d20 6261  opaque_path = ba
-000b9860: 7365 5f75 726c 2d3e 6861 735f 6f70 6171  se_url->has_opaq
-000b9870: 7565 5f70 6174 683b 0a20 2020 2020 2020  ue_path;.       
-000b9880: 2020 2020 2075 726c 2e70 6174 6820 3d20       url.path = 
-000b9890: 6261 7365 5f75 726c 2d3e 7061 7468 3b0a  base_url->path;.
-000b98a0: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
-000b98b0: 7175 6572 7920 3d20 6261 7365 5f75 726c  query = base_url
-000b98c0: 2d3e 7175 6572 793b 0a20 2020 2020 2020  ->query;.       
-000b98d0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-000b98e0: 2020 2020 2020 2020 7572 6c2e 7570 6461          url.upda
-000b98f0: 7465 5f62 6173 655f 6175 7468 6f72 6974  te_base_authorit
-000b9900: 7928 6261 7365 5f75 726c 2d3e 6765 745f  y(base_url->get_
-000b9910: 6872 6566 2829 2c0a 2020 2020 2020 2020  href(),.        
-000b9920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000b9930: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-000b9940: 7365 5f75 726c 2d3e 6765 745f 636f 6d70  se_url->get_comp
-000b9950: 6f6e 656e 7473 2829 293b 0a20 2020 2020  onents());.     
-000b9960: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
-000b9970: 4765 7420 7269 6420 6f66 2073 6574 5f68  Get rid of set_h
-000b9980: 6f73 746e 616d 6520 616e 6420 7265 706c  ostname and repl
-000b9990: 6163 6520 6974 2077 6974 680a 2020 2020  ace it with.    
-000b99a0: 2020 2020 2020 2020 2f2f 2075 7064 6174          // updat
-000b99b0: 655f 6261 7365 5f68 6f73 746e 616d 650a  e_base_hostname.
-000b99c0: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
-000b99d0: 7365 745f 686f 7374 6e61 6d65 2862 6173  set_hostname(bas
-000b99e0: 655f 7572 6c2d 3e67 6574 5f68 6f73 746e  e_url->get_hostn
-000b99f0: 616d 6528 2929 3b0a 2020 2020 2020 2020  ame());.        
-000b9a00: 2020 2020 7572 6c2e 7570 6461 7465 5f62      url.update_b
-000b9a10: 6173 655f 706f 7274 2862 6173 655f 7572  ase_port(base_ur
-000b9a20: 6c2d 3e72 6574 7269 6576 655f 6261 7365  l->retrieve_base
-000b9a30: 5f70 6f72 7428 2929 3b0a 2020 2020 2020  _port());.      
-000b9a40: 2020 2020 2020 2f2f 2063 6c6f 6e69 6e67        // cloning
-000b9a50: 2074 6865 2062 6173 6520 7061 7468 2069   the base path i
-000b9a60: 6e63 6c75 6465 7320 636c 6f6e 696e 6720  ncludes cloning 
-000b9a70: 7468 6520 6861 735f 6f70 6171 7565 5f70  the has_opaque_p
-000b9a80: 6174 6820 666c 6167 0a20 2020 2020 2020  ath flag.       
-000b9a90: 2020 2020 2075 726c 2e68 6173 5f6f 7061       url.has_opa
-000b9aa0: 7175 655f 7061 7468 203d 2062 6173 655f  que_path = base_
-000b9ab0: 7572 6c2d 3e68 6173 5f6f 7061 7175 655f  url->has_opaque_
-000b9ac0: 7061 7468 3b0a 2020 2020 2020 2020 2020  path;.          
-000b9ad0: 2020 7572 6c2e 7570 6461 7465 5f62 6173    url.update_bas
-000b9ae0: 655f 7061 7468 6e61 6d65 2862 6173 655f  e_pathname(base_
-000b9af0: 7572 6c2d 3e67 6574 5f70 6174 686e 616d  url->get_pathnam
-000b9b00: 6528 2929 3b0a 2020 2020 2020 2020 2020  e());.          
-000b9b10: 2020 7572 6c2e 7570 6461 7465 5f62 6173    url.update_bas
-000b9b20: 655f 7365 6172 6368 2862 6173 655f 7572  e_search(base_ur
-000b9b30: 6c2d 3e67 6574 5f73 6561 7263 6828 2929  l->get_search())
-000b9b40: 3b0a 2020 2020 2020 2020 2020 7d0a 0a20  ;.          }.. 
-000b9b50: 2020 2020 2020 2020 2075 726c 2e68 6173           url.has
-000b9b60: 5f6f 7061 7175 655f 7061 7468 203d 2062  _opaque_path = b
-000b9b70: 6173 655f 7572 6c2d 3e68 6173 5f6f 7061  ase_url->has_opa
-000b9b80: 7175 655f 7061 7468 3b0a 0a20 2020 2020  que_path;..     
-000b9b90: 2020 2020 202f 2f20 4966 2063 2069 7320       // If c is 
-000b9ba0: 552b 3030 3346 2028 3f29 2c20 7468 656e  U+003F (?), then
-000b9bb0: 2073 6574 2075 726c e280 9973 2071 7565   set url...s que
-000b9bc0: 7279 2074 6f20 7468 6520 656d 7074 7920  ry to the empty 
-000b9bd0: 7374 7269 6e67 2c20 616e 640a 2020 2020  string, and.    
-000b9be0: 2020 2020 2020 2f2f 2073 7461 7465 2074        // state t
-000b9bf0: 6f20 7175 6572 7920 7374 6174 652e 0a20  o query state.. 
-000b9c00: 2020 2020 2020 2020 2069 6620 2828 696e           if ((in
-000b9c10: 7075 745f 706f 7369 7469 6f6e 2021 3d20  put_position != 
-000b9c20: 696e 7075 745f 7369 7a65 2920 2626 0a20  input_size) &&. 
-000b9c30: 2020 2020 2020 2020 2020 2020 2028 7572               (ur
-000b9c40: 6c5f 6461 7461 5b69 6e70 7574 5f70 6f73  l_data[input_pos
-000b9c50: 6974 696f 6e5d 203d 3d20 273f 2729 2920  ition] == '?')) 
-000b9c60: 7b0a 2020 2020 2020 2020 2020 2020 7374  {.            st
-000b9c70: 6174 6520 3d20 6164 613a 3a73 7461 7465  ate = ada::state
-000b9c80: 3a3a 5155 4552 593b 0a20 2020 2020 2020  ::QUERY;.       
-000b9c90: 2020 207d 0a20 2020 2020 2020 2020 202f     }.          /
-000b9ca0: 2f20 4f74 6865 7277 6973 652c 2069 6620  / Otherwise, if 
-000b9cb0: 6320 6973 206e 6f74 2074 6865 2045 4f46  c is not the EOF
-000b9cc0: 2063 6f64 6520 706f 696e 743a 0a20 2020   code point:.   
-000b9cd0: 2020 2020 2020 2065 6c73 6520 6966 2028         else if (
-000b9ce0: 696e 7075 745f 706f 7369 7469 6f6e 2021  input_position !
-000b9cf0: 3d20 696e 7075 745f 7369 7a65 2920 7b0a  = input_size) {.
-000b9d00: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
-000b9d10: 6574 2075 726c e280 9973 2071 7565 7279  et url...s query
-000b9d20: 2074 6f20 6e75 6c6c 2e0a 2020 2020 2020   to null..      
-000b9d30: 2020 2020 2020 7572 6c2e 636c 6561 725f        url.clear_
-000b9d40: 7365 6172 6368 2829 3b0a 2020 2020 2020  search();.      
-000b9d50: 2020 2020 2020 6966 2063 6f6e 7374 6578        if constex
-000b9d60: 7072 2028 7265 7375 6c74 5f74 7970 655f  pr (result_type_
-000b9d70: 6973 5f61 6461 5f75 726c 2920 7b0a 2020  is_ada_url) {.  
-000b9d80: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
-000b9d90: 686f 7274 656e 2075 726c e280 9973 2070  horten url...s p
-000b9da0: 6174 682e 0a20 2020 2020 2020 2020 2020  ath..           
-000b9db0: 2020 2068 656c 7065 7273 3a3a 7368 6f72     helpers::shor
-000b9dc0: 7465 6e5f 7061 7468 2875 726c 2e70 6174  ten_path(url.pat
-000b9dd0: 682c 2075 726c 2e74 7970 6529 3b0a 2020  h, url.type);.  
-000b9de0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-000b9df0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000b9e00: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000b9e10: 7720 7061 7468 203d 2075 726c 2e67 6574  w path = url.get
-000b9e20: 5f70 6174 686e 616d 6528 293b 0a20 2020  _pathname();.   
-000b9e30: 2020 2020 2020 2020 2020 2069 6620 2868             if (h
-000b9e40: 656c 7065 7273 3a3a 7368 6f72 7465 6e5f  elpers::shorten_
-000b9e50: 7061 7468 2870 6174 682c 2075 726c 2e74  path(path, url.t
-000b9e60: 7970 6529 2920 7b0a 2020 2020 2020 2020  ype)) {.        
-000b9e70: 2020 2020 2020 2020 7572 6c2e 7570 6461          url.upda
-000b9e80: 7465 5f62 6173 655f 7061 7468 6e61 6d65  te_base_pathname
-000b9e90: 2873 7464 3a3a 7374 7269 6e67 2870 6174  (std::string(pat
-000b9ea0: 6829 293b 0a20 2020 2020 2020 2020 2020  h));.           
-000b9eb0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000b9ec0: 207d 0a20 2020 2020 2020 2020 2020 202f   }.            /
-000b9ed0: 2f20 5365 7420 7374 6174 6520 746f 2070  / Set state to p
-000b9ee0: 6174 6820 7374 6174 6520 616e 6420 6465  ath state and de
-000b9ef0: 6372 6561 7365 2070 6f69 6e74 6572 2062  crease pointer b
-000b9f00: 7920 312e 0a20 2020 2020 2020 2020 2020  y 1..           
-000b9f10: 2073 7461 7465 203d 2061 6461 3a3a 7374   state = ada::st
-000b9f20: 6174 653a 3a50 4154 483b 0a20 2020 2020  ate::PATH;.     
-000b9f30: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
-000b9f40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000b9f50: 2020 7d0a 2020 2020 2020 2020 696e 7075    }.        inpu
-000b9f60: 745f 706f 7369 7469 6f6e 2b2b 3b0a 2020  t_position++;.  
-000b9f70: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
-000b9f80: 2020 207d 0a20 2020 2020 2063 6173 6520     }.      case 
-000b9f90: 6164 613a 3a73 7461 7465 3a3a 5245 4c41  ada::state::RELA
-000b9fa0: 5449 5645 5f53 4c41 5348 3a20 7b0a 2020  TIVE_SLASH: {.  
-000b9fb0: 2020 2020 2020 6164 615f 6c6f 6728 2252        ada_log("R
-000b9fc0: 454c 4154 4956 455f 534c 4153 4820 222c  ELATIVE_SLASH ",
-000b9fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000b9fe0: 2068 656c 7065 7273 3a3a 7375 6273 7472   helpers::substr
-000b9ff0: 696e 6728 7572 6c5f 6461 7461 2c20 696e  ing(url_data, in
-000ba000: 7075 745f 706f 7369 7469 6f6e 2929 3b0a  put_position));.
-000ba010: 0a20 2020 2020 2020 202f 2f20 4966 2075  .        // If u
-000ba020: 726c 2069 7320 7370 6563 6961 6c20 616e  rl is special an
-000ba030: 6420 6320 6973 2055 2b30 3032 4620 282f  d c is U+002F (/
-000ba040: 2920 6f72 2055 2b30 3035 4320 285c 292c  ) or U+005C (\),
-000ba050: 2074 6865 6e3a 0a20 2020 2020 2020 2069   then:.        i
-000ba060: 6620 2875 726c 2e69 735f 7370 6563 6961  f (url.is_specia
-000ba070: 6c28 2920 2626 2028 696e 7075 745f 706f  l() && (input_po
-000ba080: 7369 7469 6f6e 2021 3d20 696e 7075 745f  sition != input_
-000ba090: 7369 7a65 2920 2626 0a20 2020 2020 2020  size) &&.       
-000ba0a0: 2020 2020 2028 7572 6c5f 6461 7461 5b69       (url_data[i
-000ba0b0: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
-000ba0c0: 3d20 272f 2720 7c7c 0a20 2020 2020 2020  = '/' ||.       
-000ba0d0: 2020 2020 2020 7572 6c5f 6461 7461 5b69        url_data[i
-000ba0e0: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
-000ba0f0: 3d20 275c 5c27 2929 207b 0a20 2020 2020  = '\\')) {.     
-000ba100: 2020 2020 202f 2f20 5365 7420 7374 6174       // Set stat
-000ba110: 6520 746f 2073 7065 6369 616c 2061 7574  e to special aut
-000ba120: 686f 7269 7479 2069 676e 6f72 6520 736c  hority ignore sl
-000ba130: 6173 6865 7320 7374 6174 652e 0a20 2020  ashes state..   
-000ba140: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
-000ba150: 6461 3a3a 7374 6174 653a 3a53 5045 4349  da::state::SPECI
-000ba160: 414c 5f41 5554 484f 5249 5459 5f49 474e  AL_AUTHORITY_IGN
-000ba170: 4f52 455f 534c 4153 4845 533b 0a20 2020  ORE_SLASHES;.   
-000ba180: 2020 2020 207d 0a20 2020 2020 2020 202f       }.        /
-000ba190: 2f20 4f74 6865 7277 6973 652c 2069 6620  / Otherwise, if 
-000ba1a0: 6320 6973 2055 2b30 3032 4620 282f 292c  c is U+002F (/),
-000ba1b0: 2074 6865 6e20 7365 7420 7374 6174 6520   then set state 
-000ba1c0: 746f 2061 7574 686f 7269 7479 2073 7461  to authority sta
-000ba1d0: 7465 2e0a 2020 2020 2020 2020 656c 7365  te..        else
-000ba1e0: 2069 6620 2828 696e 7075 745f 706f 7369   if ((input_posi
-000ba1f0: 7469 6f6e 2021 3d20 696e 7075 745f 7369  tion != input_si
-000ba200: 7a65 2920 2626 0a20 2020 2020 2020 2020  ze) &&.         
-000ba210: 2020 2020 2020 2020 2875 726c 5f64 6174          (url_dat
-000ba220: 615b 696e 7075 745f 706f 7369 7469 6f6e  a[input_position
-000ba230: 5d20 3d3d 2027 2f27 2929 207b 0a20 2020  ] == '/')) {.   
-000ba240: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
-000ba250: 6461 3a3a 7374 6174 653a 3a41 5554 484f  da::state::AUTHO
-000ba260: 5249 5459 3b0a 2020 2020 2020 2020 7d0a  RITY;.        }.
-000ba270: 2020 2020 2020 2020 2f2f 204f 7468 6572          // Other
-000ba280: 7769 7365 2c20 7365 740a 2020 2020 2020  wise, set.      
-000ba290: 2020 2f2f 202d 2075 726c e280 9973 2075    // - url...s u
-000ba2a0: 7365 726e 616d 6520 746f 2062 6173 65e2  sername to base.
-000ba2b0: 8099 7320 7573 6572 6e61 6d65 2c0a 2020  ..s username,.  
-000ba2c0: 2020 2020 2020 2f2f 202d 2075 726c e280        // - url..
-000ba2d0: 9973 2070 6173 7377 6f72 6420 746f 2062  .s password to b
-000ba2e0: 6173 65e2 8099 7320 7061 7373 776f 7264  ase...s password
-000ba2f0: 2c0a 2020 2020 2020 2020 2f2f 202d 2075  ,.        // - u
-000ba300: 726c e280 9973 2068 6f73 7420 746f 2062  rl...s host to b
-000ba310: 6173 65e2 8099 7320 686f 7374 2c0a 2020  ase...s host,.  
-000ba320: 2020 2020 2020 2f2f 202d 2075 726c e280        // - url..
-000ba330: 9973 2070 6f72 7420 746f 2062 6173 65e2  .s port to base.
-000ba340: 8099 7320 706f 7274 2c0a 2020 2020 2020  ..s port,.      
-000ba350: 2020 2f2f 202d 2073 7461 7465 2074 6f20    // - state to 
-000ba360: 7061 7468 2073 7461 7465 2c20 616e 6420  path state, and 
-000ba370: 7468 656e 2c20 6465 6372 6561 7365 2070  then, decrease p
-000ba380: 6f69 6e74 6572 2062 7920 312e 0a20 2020  ointer by 1..   
-000ba390: 2020 2020 2065 6c73 6520 7b0a 2020 2020       else {.    
-000ba3a0: 2020 2020 2020 6966 2063 6f6e 7374 6578        if constex
-000ba3b0: 7072 2028 7265 7375 6c74 5f74 7970 655f  pr (result_type_
-000ba3c0: 6973 5f61 6461 5f75 726c 2920 7b0a 2020  is_ada_url) {.  
-000ba3d0: 2020 2020 2020 2020 2020 7572 6c2e 7573            url.us
-000ba3e0: 6572 6e61 6d65 203d 2062 6173 655f 7572  ername = base_ur
-000ba3f0: 6c2d 3e75 7365 726e 616d 653b 0a20 2020  l->username;.   
-000ba400: 2020 2020 2020 2020 2075 726c 2e70 6173           url.pas
-000ba410: 7377 6f72 6420 3d20 6261 7365 5f75 726c  sword = base_url
-000ba420: 2d3e 7061 7373 776f 7264 3b0a 2020 2020  ->password;.    
-000ba430: 2020 2020 2020 2020 7572 6c2e 686f 7374          url.host
-000ba440: 203d 2062 6173 655f 7572 6c2d 3e68 6f73   = base_url->hos
-000ba450: 743b 0a20 2020 2020 2020 2020 2020 2075  t;.            u
-000ba460: 726c 2e70 6f72 7420 3d20 6261 7365 5f75  rl.port = base_u
-000ba470: 726c 2d3e 706f 7274 3b0a 2020 2020 2020  rl->port;.      
-000ba480: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-000ba490: 2020 2020 2020 2020 2075 726c 2e75 7064           url.upd
-000ba4a0: 6174 655f 6261 7365 5f61 7574 686f 7269  ate_base_authori
-000ba4b0: 7479 2862 6173 655f 7572 6c2d 3e67 6574  ty(base_url->get
-000ba4c0: 5f68 7265 6628 292c 0a20 2020 2020 2020  _href(),.       
-000ba4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000ba4e0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000ba4f0: 6173 655f 7572 6c2d 3e67 6574 5f63 6f6d  ase_url->get_com
-000ba500: 706f 6e65 6e74 7328 2929 3b0a 2020 2020  ponents());.    
-000ba510: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-000ba520: 2047 6574 2072 6964 206f 6620 7365 745f   Get rid of set_
-000ba530: 686f 7374 6e61 6d65 2061 6e64 2072 6570  hostname and rep
-000ba540: 6c61 6365 2069 7420 7769 7468 0a20 2020  lace it with.   
-000ba550: 2020 2020 2020 2020 202f 2f20 7570 6461           // upda
-000ba560: 7465 5f62 6173 655f 686f 7374 6e61 6d65  te_base_hostname
-000ba570: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-000ba580: 2e73 6574 5f68 6f73 746e 616d 6528 6261  .set_hostname(ba
-000ba590: 7365 5f75 726c 2d3e 6765 745f 686f 7374  se_url->get_host
-000ba5a0: 6e61 6d65 2829 293b 0a20 2020 2020 2020  name());.       
-000ba5b0: 2020 2020 2075 726c 2e75 7064 6174 655f       url.update_
-000ba5c0: 6261 7365 5f70 6f72 7428 6261 7365 5f75  base_port(base_u
-000ba5d0: 726c 2d3e 7265 7472 6965 7665 5f62 6173  rl->retrieve_bas
-000ba5e0: 655f 706f 7274 2829 293b 0a20 2020 2020  e_port());.     
-000ba5f0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000ba600: 2073 7461 7465 203d 2061 6461 3a3a 7374   state = ada::st
-000ba610: 6174 653a 3a50 4154 483b 0a20 2020 2020  ate::PATH;.     
-000ba620: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
-000ba630: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
-000ba640: 6e70 7574 5f70 6f73 6974 696f 6e2b 2b3b  nput_position++;
-000ba650: 0a20 2020 2020 2020 2062 7265 616b 3b0a  .        break;.
-000ba660: 2020 2020 2020 7d0a 2020 2020 2020 6361        }.      ca
-000ba670: 7365 2061 6461 3a3a 7374 6174 653a 3a53  se ada::state::S
-000ba680: 5045 4349 414c 5f41 5554 484f 5249 5459  PECIAL_AUTHORITY
-000ba690: 5f53 4c41 5348 4553 3a20 7b0a 2020 2020  _SLASHES: {.    
-000ba6a0: 2020 2020 6164 615f 6c6f 6728 2253 5045      ada_log("SPE
-000ba6b0: 4349 414c 5f41 5554 484f 5249 5459 5f53  CIAL_AUTHORITY_S
-000ba6c0: 4c41 5348 4553 2022 2c0a 2020 2020 2020  LASHES ",.      
-000ba6d0: 2020 2020 2020 2020 2020 6865 6c70 6572            helper
-000ba6e0: 733a 3a73 7562 7374 7269 6e67 2875 726c  s::substring(url
-000ba6f0: 5f64 6174 612c 2069 6e70 7574 5f70 6f73  _data, input_pos
-000ba700: 6974 696f 6e29 293b 0a0a 2020 2020 2020  ition));..      
-000ba710: 2020 2f2f 2049 6620 6320 6973 2055 2b30    // If c is U+0
-000ba720: 3032 4620 282f 2920 616e 6420 7265 6d61  02F (/) and rema
-000ba730: 696e 696e 6720 7374 6172 7473 2077 6974  ining starts wit
-000ba740: 6820 552b 3030 3246 2028 2f29 2c0a 2020  h U+002F (/),.  
-000ba750: 2020 2020 2020 2f2f 2074 6865 6e20 7365        // then se
-000ba760: 7420 7374 6174 6520 746f 2073 7065 6369  t state to speci
-000ba770: 616c 2061 7574 686f 7269 7479 2069 676e  al authority ign
-000ba780: 6f72 6520 736c 6173 6865 7320 7374 6174  ore slashes stat
-000ba790: 6520 616e 6420 696e 6372 6561 7365 0a20  e and increase. 
-000ba7a0: 2020 2020 2020 202f 2f20 706f 696e 7465         // pointe
-000ba7b0: 7220 6279 2031 2e0a 2020 2020 2020 2020  r by 1..        
-000ba7c0: 7374 6174 6520 3d20 6164 613a 3a73 7461  state = ada::sta
-000ba7d0: 7465 3a3a 5350 4543 4941 4c5f 4155 5448  te::SPECIAL_AUTH
-000ba7e0: 4f52 4954 595f 4947 4e4f 5245 5f53 4c41  ORITY_IGNORE_SLA
-000ba7f0: 5348 4553 3b0a 2020 2020 2020 2020 7374  SHES;.        st
-000ba800: 643a 3a73 7472 696e 675f 7669 6577 2076  d::string_view v
-000ba810: 6965 7720 3d20 6865 6c70 6572 733a 3a73  iew = helpers::s
-000ba820: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000ba830: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000ba840: 6e29 3b0a 2020 2020 2020 2020 6966 2028  n);.        if (
-000ba850: 6164 613a 3a63 6865 636b 6572 733a 3a62  ada::checkers::b
-000ba860: 6567 696e 735f 7769 7468 2876 6965 772c  egins_with(view,
-000ba870: 2022 2f2f 2229 2920 7b0a 2020 2020 2020   "//")) {.      
-000ba880: 2020 2020 696e 7075 745f 706f 7369 7469      input_positi
-000ba890: 6f6e 202b 3d20 323b 0a20 2020 2020 2020  on += 2;.       
-000ba8a0: 207d 0a0a 2020 2020 2020 2020 5b5b 6661   }..        [[fa
-000ba8b0: 6c6c 7468 726f 7567 685d 5d3b 0a20 2020  llthrough]];.   
-000ba8c0: 2020 207d 0a20 2020 2020 2063 6173 6520     }.      case 
-000ba8d0: 6164 613a 3a73 7461 7465 3a3a 5350 4543  ada::state::SPEC
-000ba8e0: 4941 4c5f 4155 5448 4f52 4954 595f 4947  IAL_AUTHORITY_IG
-000ba8f0: 4e4f 5245 5f53 4c41 5348 4553 3a20 7b0a  NORE_SLASHES: {.
-000ba900: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
-000ba910: 2253 5045 4349 414c 5f41 5554 484f 5249  "SPECIAL_AUTHORI
-000ba920: 5459 5f49 474e 4f52 455f 534c 4153 4845  TY_IGNORE_SLASHE
-000ba930: 5320 222c 0a20 2020 2020 2020 2020 2020  S ",.           
-000ba940: 2020 2020 2068 656c 7065 7273 3a3a 7375       helpers::su
-000ba950: 6273 7472 696e 6728 7572 6c5f 6461 7461  bstring(url_data
-000ba960: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
-000ba970: 2929 3b0a 0a20 2020 2020 2020 202f 2f20  ));..        // 
-000ba980: 4966 2063 2069 7320 6e65 6974 6865 7220  If c is neither 
-000ba990: 552b 3030 3246 2028 2f29 206e 6f72 2055  U+002F (/) nor U
-000ba9a0: 2b30 3035 4320 285c 292c 2074 6865 6e20  +005C (\), then 
-000ba9b0: 7365 7420 7374 6174 6520 746f 0a20 2020  set state to.   
-000ba9c0: 2020 2020 202f 2f20 6175 7468 6f72 6974       // authorit
-000ba9d0: 7920 7374 6174 6520 616e 6420 6465 6372  y state and decr
-000ba9e0: 6561 7365 2070 6f69 6e74 6572 2062 7920  ease pointer by 
-000ba9f0: 312e 0a20 2020 2020 2020 2077 6869 6c65  1..        while
-000baa00: 2028 2869 6e70 7574 5f70 6f73 6974 696f   ((input_positio
-000baa10: 6e20 213d 2069 6e70 7574 5f73 697a 6529  n != input_size)
-000baa20: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
-000baa30: 2020 2028 2875 726c 5f64 6174 615b 696e     ((url_data[in
-000baa40: 7075 745f 706f 7369 7469 6f6e 5d20 3d3d  put_position] ==
-000baa50: 2027 2f27 2920 7c7c 0a20 2020 2020 2020   '/') ||.       
-000baa60: 2020 2020 2020 2020 2028 7572 6c5f 6461           (url_da
-000baa70: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
-000baa80: 6e5d 203d 3d20 275c 5c27 2929 2920 7b0a  n] == '\\'))) {.
-000baa90: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-000baaa0: 706f 7369 7469 6f6e 2b2b 3b0a 2020 2020  position++;.    
-000baab0: 2020 2020 7d0a 2020 2020 2020 2020 7374      }.        st
-000baac0: 6174 6520 3d20 6164 613a 3a73 7461 7465  ate = ada::state
-000baad0: 3a3a 4155 5448 4f52 4954 593b 0a0a 2020  ::AUTHORITY;..  
-000baae0: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
-000baaf0: 2020 207d 0a20 2020 2020 2063 6173 6520     }.      case 
-000bab00: 6164 613a 3a73 7461 7465 3a3a 5155 4552  ada::state::QUER
-000bab10: 593a 207b 0a20 2020 2020 2020 2061 6461  Y: {.        ada
-000bab20: 5f6c 6f67 2822 5155 4552 5920 222c 2068  _log("QUERY ", h
-000bab30: 656c 7065 7273 3a3a 7375 6273 7472 696e  elpers::substrin
-000bab40: 6728 7572 6c5f 6461 7461 2c20 696e 7075  g(url_data, inpu
-000bab50: 745f 706f 7369 7469 6f6e 2929 3b0a 2020  t_position));.  
-000bab60: 2020 2020 2020 2f2f 204c 6574 2071 7565        // Let que
-000bab70: 7279 5065 7263 656e 7445 6e63 6f64 6553  ryPercentEncodeS
-000bab80: 6574 2062 6520 7468 6520 7370 6563 6961  et be the specia
-000bab90: 6c2d 7175 6572 7920 7065 7263 656e 742d  l-query percent-
-000baba0: 656e 636f 6465 2073 6574 2069 660a 2020  encode set if.  
-000babb0: 2020 2020 2020 2f2f 2075 726c 2069 7320        // url is 
-000babc0: 7370 6563 6961 6c3b 206f 7468 6572 7769  special; otherwi
-000babd0: 7365 2074 6865 2071 7565 7279 2070 6572  se the query per
-000babe0: 6365 6e74 2d65 6e63 6f64 6520 7365 742e  cent-encode set.
-000babf0: 0a20 2020 2020 2020 2063 6f6e 7374 2075  .        const u
-000bac00: 696e 7438 5f74 2a20 7175 6572 795f 7065  int8_t* query_pe
-000bac10: 7263 656e 745f 656e 636f 6465 5f73 6574  rcent_encode_set
-000bac20: 203d 0a20 2020 2020 2020 2020 2020 2075   =.            u
-000bac30: 726c 2e69 735f 7370 6563 6961 6c28 2920  rl.is_special() 
-000bac40: 3f20 6164 613a 3a63 6861 7261 6374 6572  ? ada::character
-000bac50: 5f73 6574 733a 3a53 5045 4349 414c 5f51  _sets::SPECIAL_Q
-000bac60: 5545 5259 5f50 4552 4345 4e54 5f45 4e43  UERY_PERCENT_ENC
-000bac70: 4f44 450a 2020 2020 2020 2020 2020 2020  ODE.            
-000bac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bac90: 203a 2061 6461 3a3a 6368 6172 6163 7465   : ada::characte
-000baca0: 725f 7365 7473 3a3a 5155 4552 595f 5045  r_sets::QUERY_PE
-000bacb0: 5243 454e 545f 454e 434f 4445 3b0a 0a20  RCENT_ENCODE;.. 
-000bacc0: 2020 2020 2020 202f 2f20 5065 7263 656e         // Percen
-000bacd0: 742d 656e 636f 6465 2061 6674 6572 2065  t-encode after e
-000bace0: 6e63 6f64 696e 672c 2077 6974 6820 656e  ncoding, with en
-000bacf0: 636f 6469 6e67 2c20 6275 6666 6572 2c20  coding, buffer, 
-000bad00: 616e 640a 2020 2020 2020 2020 2f2f 2071  and.        // q
-000bad10: 7565 7279 5065 7263 656e 7445 6e63 6f64  ueryPercentEncod
-000bad20: 6553 6574 2c20 616e 6420 6170 7065 6e64  eSet, and append
-000bad30: 2074 6865 2072 6573 756c 7420 746f 2075   the result to u
-000bad40: 726c e280 9973 2071 7565 7279 2e0a 2020  rl...s query..  
-000bad50: 2020 2020 2020 7572 6c2e 7570 6461 7465        url.update
-000bad60: 5f62 6173 655f 7365 6172 6368 2868 656c  _base_search(hel
-000bad70: 7065 7273 3a3a 7375 6273 7472 696e 6728  pers::substring(
-000bad80: 7572 6c5f 6461 7461 2c20 696e 7075 745f  url_data, input_
-000bad90: 706f 7369 7469 6f6e 292c 0a20 2020 2020  position),.     
-000bada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000badb0: 2020 2020 2020 2020 2020 7175 6572 795f            query_
-000badc0: 7065 7263 656e 745f 656e 636f 6465 5f73  percent_encode_s
-000badd0: 6574 293b 0a20 2020 2020 2020 2061 6461  et);.        ada
-000bade0: 5f6c 6f67 2822 5155 4552 5920 7570 6461  _log("QUERY upda
-000badf0: 7465 5f62 6173 655f 7365 6172 6368 2063  te_base_search c
-000bae00: 6f6d 706c 6574 6564 2022 293b 0a20 2020  ompleted ");.   
-000bae10: 2020 2020 2069 6620 2866 7261 676d 656e       if (fragmen
-000bae20: 742e 6861 735f 7661 6c75 6528 2929 207b  t.has_value()) {
-000bae30: 0a20 2020 2020 2020 2020 2075 726c 2e75  .          url.u
-000bae40: 7064 6174 655f 756e 656e 636f 6465 645f  pdate_unencoded_
-000bae50: 6261 7365 5f68 6173 6828 2a66 7261 676d  base_hash(*fragm
-000bae60: 656e 7429 3b0a 2020 2020 2020 2020 7d0a  ent);.        }.
-000bae70: 2020 2020 2020 2020 7265 7475 726e 2075          return u
-000bae80: 726c 3b0a 2020 2020 2020 7d0a 2020 2020  rl;.      }.    
-000bae90: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
-000baea0: 653a 3a48 4f53 543a 207b 0a20 2020 2020  e::HOST: {.     
-000baeb0: 2020 2061 6461 5f6c 6f67 2822 484f 5354     ada_log("HOST
-000baec0: 2022 2c20 6865 6c70 6572 733a 3a73 7562   ", helpers::sub
-000baed0: 7374 7269 6e67 2875 726c 5f64 6174 612c  string(url_data,
-000baee0: 2069 6e70 7574 5f70 6f73 6974 696f 6e29   input_position)
-000baef0: 293b 0a0a 2020 2020 2020 2020 7374 643a  );..        std:
-000baf00: 3a73 7472 696e 675f 7669 6577 2068 6f73  :string_view hos
-000baf10: 745f 7669 6577 203d 0a20 2020 2020 2020  t_view =.       
-000baf20: 2020 2020 2068 656c 7065 7273 3a3a 7375       helpers::su
-000baf30: 6273 7472 696e 6728 7572 6c5f 6461 7461  bstring(url_data
-000baf40: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
-000baf50: 293b 0a20 2020 2020 2020 2061 7574 6f20  );.        auto 
-000baf60: 5b6c 6f63 6174 696f 6e2c 2066 6f75 6e64  [location, found
-000baf70: 5f63 6f6c 6f6e 5d20 3d0a 2020 2020 2020  _colon] =.      
-000baf80: 2020 2020 2020 6865 6c70 6572 733a 3a67        helpers::g
-000baf90: 6574 5f68 6f73 745f 6465 6c69 6d69 7465  et_host_delimite
-000bafa0: 725f 6c6f 6361 7469 6f6e 2875 726c 2e69  r_location(url.i
-000bafb0: 735f 7370 6563 6961 6c28 292c 2068 6f73  s_special(), hos
-000bafc0: 745f 7669 6577 293b 0a20 2020 2020 2020  t_view);.       
-000bafd0: 2069 6e70 7574 5f70 6f73 6974 696f 6e20   input_position 
-000bafe0: 3d20 286c 6f63 6174 696f 6e20 213d 2073  = (location != s
-000baff0: 7464 3a3a 7374 7269 6e67 5f76 6965 773a  td::string_view:
-000bb000: 3a6e 706f 7329 0a20 2020 2020 2020 2020  :npos).         
-000bb010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bb020: 2020 2020 3f20 696e 7075 745f 706f 7369      ? input_posi
-000bb030: 7469 6f6e 202b 206c 6f63 6174 696f 6e0a  tion + location.
-000bb040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bb050: 2020 2020 2020 2020 2020 2020 203a 2069               : i
-000bb060: 6e70 7574 5f73 697a 653b 0a20 2020 2020  nput_size;.     
-000bb070: 2020 202f 2f20 4f74 6865 7277 6973 652c     // Otherwise,
-000bb080: 2069 6620 6320 6973 2055 2b30 3033 4120   if c is U+003A 
-000bb090: 283a 2920 616e 6420 696e 7369 6465 4272  (:) and insideBr
-000bb0a0: 6163 6b65 7473 2069 7320 6661 6c73 652c  ackets is false,
-000bb0b0: 2074 6865 6e3a 0a20 2020 2020 2020 202f   then:.        /
-000bb0c0: 2f20 4e6f 7465 3a20 7468 6520 2766 6f75  / Note: the 'fou
-000bb0d0: 6e64 5f63 6f6c 6f6e 2720 7661 6c75 6520  nd_colon' value 
-000bb0e0: 6973 2074 7275 6520 6966 2061 6e64 206f  is true if and o
-000bb0f0: 6e6c 7920 6966 2061 2063 6f6c 6f6e 2077  nly if a colon w
-000bb100: 6173 0a20 2020 2020 2020 202f 2f20 656e  as.        // en
-000bb110: 636f 756e 7465 7265 6420 7768 696c 6520  countered while 
-000bb120: 6e6f 7420 696e 7369 6465 2062 7261 636b  not inside brack
-000bb130: 6574 732e 0a20 2020 2020 2020 2069 6620  ets..        if 
-000bb140: 2866 6f75 6e64 5f63 6f6c 6f6e 2920 7b0a  (found_colon) {.
-000bb150: 2020 2020 2020 2020 2020 2f2f 2049 6620            // If 
-000bb160: 6275 6666 6572 2069 7320 7468 6520 656d  buffer is the em
-000bb170: 7074 7920 7374 7269 6e67 2c20 7661 6c69  pty string, vali
-000bb180: 6461 7469 6f6e 2065 7272 6f72 2c20 7265  dation error, re
-000bb190: 7475 726e 2066 6169 6c75 7265 2e0a 2020  turn failure..  
-000bb1a0: 2020 2020 2020 2020 2f2f 204c 6574 2068          // Let h
-000bb1b0: 6f73 7420 6265 2074 6865 2072 6573 756c  ost be the resul
-000bb1c0: 7420 6f66 2068 6f73 7420 7061 7273 696e  t of host parsin
-000bb1d0: 6720 6275 6666 6572 2077 6974 6820 7572  g buffer with ur
-000bb1e0: 6c20 6973 206e 6f74 0a20 2020 2020 2020  l is not.       
-000bb1f0: 2020 202f 2f20 7370 6563 6961 6c2e 0a20     // special.. 
-000bb200: 2020 2020 2020 2020 2061 6461 5f6c 6f67           ada_log
-000bb210: 2822 484f 5354 2070 6172 7369 6e67 2022  ("HOST parsing "
-000bb220: 2c20 686f 7374 5f76 6965 7729 3b0a 2020  , host_view);.  
-000bb230: 2020 2020 2020 2020 6966 2028 2175 726c          if (!url
-000bb240: 2e70 6172 7365 5f68 6f73 7428 686f 7374  .parse_host(host
-000bb250: 5f76 6965 7729 2920 7b0a 2020 2020 2020  _view)) {.      
-000bb260: 2020 2020 2020 7265 7475 726e 2075 726c        return url
-000bb270: 3b0a 2020 2020 2020 2020 2020 7d0a 2020  ;.          }.  
-000bb280: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
-000bb290: 2248 4f53 5420 7061 7273 696e 6720 7265  "HOST parsing re
-000bb2a0: 7375 6c74 7320 696e 2022 2c20 7572 6c2e  sults in ", url.
-000bb2b0: 6765 745f 686f 7374 6e61 6d65 2829 293b  get_hostname());
-000bb2c0: 0a20 2020 2020 2020 2020 202f 2f20 5365  .          // Se
-000bb2d0: 7420 7572 6ce2 8099 7320 686f 7374 2074  t url...s host t
-000bb2e0: 6f20 686f 7374 2c20 6275 6666 6572 2074  o host, buffer t
-000bb2f0: 6f20 7468 6520 656d 7074 7920 7374 7269  o the empty stri
-000bb300: 6e67 2c20 616e 6420 7374 6174 6520 746f  ng, and state to
-000bb310: 0a20 2020 2020 2020 2020 202f 2f20 706f  .          // po
-000bb320: 7274 2073 7461 7465 2e0a 2020 2020 2020  rt state..      
-000bb330: 2020 2020 7374 6174 6520 3d20 6164 613a      state = ada:
-000bb340: 3a73 7461 7465 3a3a 504f 5254 3b0a 2020  :state::PORT;.  
-000bb350: 2020 2020 2020 2020 696e 7075 745f 706f          input_po
-000bb360: 7369 7469 6f6e 2b2b 3b0a 2020 2020 2020  sition++;.      
-000bb370: 2020 7d0a 2020 2020 2020 2020 2f2f 204f    }.        // O
-000bb380: 7468 6572 7769 7365 2c20 6966 206f 6e65  therwise, if one
-000bb390: 206f 6620 7468 6520 666f 6c6c 6f77 696e   of the followin
-000bb3a0: 6720 6973 2074 7275 653a 0a20 2020 2020  g is true:.     
-000bb3b0: 2020 202f 2f20 2d20 6320 6973 2074 6865     // - c is the
-000bb3c0: 2045 4f46 2063 6f64 6520 706f 696e 742c   EOF code point,
-000bb3d0: 2055 2b30 3032 4620 282f 292c 2055 2b30   U+002F (/), U+0
-000bb3e0: 3033 4620 283f 292c 206f 7220 552b 3030  03F (?), or U+00
-000bb3f0: 3233 2028 2329 0a20 2020 2020 2020 202f  23 (#).        /
-000bb400: 2f20 2d20 7572 6c20 6973 2073 7065 6369  / - url is speci
-000bb410: 616c 2061 6e64 2063 2069 7320 552b 3030  al and c is U+00
-000bb420: 3543 2028 5c29 0a20 2020 2020 2020 202f  5C (\).        /
-000bb430: 2f20 5468 6520 6765 745f 686f 7374 5f64  / The get_host_d
-000bb440: 656c 696d 6974 6572 5f6c 6f63 6174 696f  elimiter_locatio
-000bb450: 6e20 6675 6e63 7469 6f6e 2065 6974 6865  n function eithe
-000bb460: 7220 6272 696e 6773 2075 7320 746f 0a20  r brings us to. 
-000bb470: 2020 2020 2020 202f 2f20 7468 6520 636f         // the co
-000bb480: 6c6f 6e20 6f75 7473 6964 6520 6f66 2074  lon outside of t
-000bb490: 6865 2062 7261 636b 6574 2c20 6f72 2074  he bracket, or t
-000bb4a0: 6f20 6f6e 6520 6f66 2074 686f 7365 2063  o one of those c
-000bb4b0: 6861 7261 6374 6572 732e 0a20 2020 2020  haracters..     
-000bb4c0: 2020 2065 6c73 6520 7b0a 2020 2020 2020     else {.      
-000bb4d0: 2020 2020 2f2f 2049 6620 7572 6c20 6973      // If url is
-000bb4e0: 2073 7065 6369 616c 2061 6e64 2068 6f73   special and hos
-000bb4f0: 745f 7669 6577 2069 7320 7468 6520 656d  t_view is the em
-000bb500: 7074 7920 7374 7269 6e67 2c20 7661 6c69  pty string, vali
-000bb510: 6461 7469 6f6e 0a20 2020 2020 2020 2020  dation.         
-000bb520: 202f 2f20 6572 726f 722c 2072 6574 7572   // error, retur
-000bb530: 6e20 6661 696c 7572 652e 0a20 2020 2020  n failure..     
-000bb540: 2020 2020 2069 6620 2875 726c 2e69 735f       if (url.is_
-000bb550: 7370 6563 6961 6c28 2920 2626 2068 6f73  special() && hos
-000bb560: 745f 7669 6577 2e65 6d70 7479 2829 2920  t_view.empty()) 
-000bb570: 7b0a 2020 2020 2020 2020 2020 2020 7572  {.            ur
-000bb580: 6c2e 6973 5f76 616c 6964 203d 2066 616c  l.is_valid = fal
-000bb590: 7365 3b0a 2020 2020 2020 2020 2020 2020  se;.            
-000bb5a0: 7265 7475 726e 2075 726c 3b0a 2020 2020  return url;.    
-000bb5b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000bb5c0: 2020 6164 615f 6c6f 6728 2248 4f53 5420    ada_log("HOST 
-000bb5d0: 7061 7273 696e 6720 222c 2068 6f73 745f  parsing ", host_
-000bb5e0: 7669 6577 2c20 2220 6872 6566 3d22 2c20  view, " href=", 
-000bb5f0: 7572 6c2e 6765 745f 6872 6566 2829 293b  url.get_href());
-000bb600: 0a20 2020 2020 2020 2020 202f 2f20 4c65  .          // Le
-000bb610: 7420 686f 7374 2062 6520 7468 6520 7265  t host be the re
-000bb620: 7375 6c74 206f 6620 686f 7374 2070 6172  sult of host par
-000bb630: 7369 6e67 2068 6f73 745f 7669 6577 2077  sing host_view w
-000bb640: 6974 6820 7572 6c20 6973 206e 6f74 0a20  ith url is not. 
-000bb650: 2020 2020 2020 2020 202f 2f20 7370 6563           // spec
-000bb660: 6961 6c2e 0a20 2020 2020 2020 2020 2069  ial..          i
-000bb670: 6620 2868 6f73 745f 7669 6577 2e65 6d70  f (host_view.emp
-000bb680: 7479 2829 2920 7b0a 2020 2020 2020 2020  ty()) {.        
-000bb690: 2020 2020 7572 6c2e 7570 6461 7465 5f62      url.update_b
-000bb6a0: 6173 655f 686f 7374 6e61 6d65 2822 2229  ase_hostname("")
-000bb6b0: 3b0a 2020 2020 2020 2020 2020 7d20 656c  ;.          } el
-000bb6c0: 7365 2069 6620 2821 7572 6c2e 7061 7273  se if (!url.pars
-000bb6d0: 655f 686f 7374 2868 6f73 745f 7669 6577  e_host(host_view
-000bb6e0: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
-000bb6f0: 2072 6574 7572 6e20 7572 6c3b 0a20 2020   return url;.   
-000bb700: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000bb710: 2020 2061 6461 5f6c 6f67 2822 484f 5354     ada_log("HOST
-000bb720: 2070 6172 7369 6e67 2072 6573 756c 7473   parsing results
-000bb730: 2069 6e20 222c 2075 726c 2e67 6574 5f68   in ", url.get_h
-000bb740: 6f73 746e 616d 6528 292c 0a20 2020 2020  ostname(),.     
-000bb750: 2020 2020 2020 2020 2020 2020 2022 2068               " h
-000bb760: 7265 663d 222c 2075 726c 2e67 6574 5f68  ref=", url.get_h
-000bb770: 7265 6628 2929 3b0a 0a20 2020 2020 2020  ref());..       
-000bb780: 2020 202f 2f20 5365 7420 7572 6ce2 8099     // Set url...
-000bb790: 7320 686f 7374 2074 6f20 686f 7374 2c20  s host to host, 
-000bb7a0: 616e 6420 7374 6174 6520 746f 2070 6174  and state to pat
-000bb7b0: 6820 7374 6172 7420 7374 6174 652e 0a20  h start state.. 
-000bb7c0: 2020 2020 2020 2020 2073 7461 7465 203d           state =
-000bb7d0: 2061 6461 3a3a 7374 6174 653a 3a50 4154   ada::state::PAT
-000bb7e0: 485f 5354 4152 543b 0a20 2020 2020 2020  H_START;.       
-000bb7f0: 207d 0a0a 2020 2020 2020 2020 6272 6561   }..        brea
-000bb800: 6b3b 0a20 2020 2020 207d 0a20 2020 2020  k;.      }.     
-000bb810: 2063 6173 6520 6164 613a 3a73 7461 7465   case ada::state
-000bb820: 3a3a 4f50 4151 5545 5f50 4154 483a 207b  ::OPAQUE_PATH: {
-000bb830: 0a20 2020 2020 2020 2061 6461 5f6c 6f67  .        ada_log
-000bb840: 2822 4f50 4151 5545 5f50 4154 4820 222c  ("OPAQUE_PATH ",
-000bb850: 2068 656c 7065 7273 3a3a 7375 6273 7472   helpers::substr
-000bb860: 696e 6728 7572 6c5f 6461 7461 2c20 696e  ing(url_data, in
-000bb870: 7075 745f 706f 7369 7469 6f6e 2929 3b0a  put_position));.
-000bb880: 2020 2020 2020 2020 7374 643a 3a73 7472          std::str
-000bb890: 696e 675f 7669 6577 2076 6965 7720 3d20  ing_view view = 
-000bb8a0: 6865 6c70 6572 733a 3a73 7562 7374 7269  helpers::substri
-000bb8b0: 6e67 2875 726c 5f64 6174 612c 2069 6e70  ng(url_data, inp
-000bb8c0: 7574 5f70 6f73 6974 696f 6e29 3b0a 2020  ut_position);.  
-000bb8d0: 2020 2020 2020 2f2f 2049 6620 6320 6973        // If c is
-000bb8e0: 2055 2b30 3033 4620 283f 292c 2074 6865   U+003F (?), the
-000bb8f0: 6e20 7365 7420 7572 6ce2 8099 7320 7175  n set url...s qu
-000bb900: 6572 7920 746f 2074 6865 2065 6d70 7479  ery to the empty
-000bb910: 2073 7472 696e 6720 616e 640a 2020 2020   string and.    
-000bb920: 2020 2020 2f2f 2073 7461 7465 2074 6f20      // state to 
-000bb930: 7175 6572 7920 7374 6174 652e 0a20 2020  query state..   
-000bb940: 2020 2020 2073 697a 655f 7420 6c6f 6361       size_t loca
-000bb950: 7469 6f6e 203d 2076 6965 772e 6669 6e64  tion = view.find
-000bb960: 2827 3f27 293b 0a20 2020 2020 2020 2069  ('?');.        i
-000bb970: 6620 286c 6f63 6174 696f 6e20 213d 2073  f (location != s
-000bb980: 7464 3a3a 7374 7269 6e67 5f76 6965 773a  td::string_view:
-000bb990: 3a6e 706f 7329 207b 0a20 2020 2020 2020  :npos) {.       
-000bb9a0: 2020 2076 6965 772e 7265 6d6f 7665 5f73     view.remove_s
-000bb9b0: 7566 6669 7828 7669 6577 2e73 697a 6528  uffix(view.size(
-000bb9c0: 2920 2d20 6c6f 6361 7469 6f6e 293b 0a20  ) - location);. 
-000bb9d0: 2020 2020 2020 2020 2073 7461 7465 203d           state =
-000bb9e0: 2061 6461 3a3a 7374 6174 653a 3a51 5545   ada::state::QUE
-000bb9f0: 5259 3b0a 2020 2020 2020 2020 2020 696e  RY;.          in
-000bba00: 7075 745f 706f 7369 7469 6f6e 202b 3d20  put_position += 
-000bba10: 6c6f 6361 7469 6f6e 202b 2031 3b0a 2020  location + 1;.  
-000bba20: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-000bba30: 2020 2020 2020 2020 2069 6e70 7574 5f70           input_p
-000bba40: 6f73 6974 696f 6e20 3d20 696e 7075 745f  osition = input_
-000bba50: 7369 7a65 202b 2031 3b0a 2020 2020 2020  size + 1;.      
-000bba60: 2020 7d0a 2020 2020 2020 2020 7572 6c2e    }.        url.
-000bba70: 6861 735f 6f70 6171 7565 5f70 6174 6820  has_opaque_path 
-000bba80: 3d20 7472 7565 3b0a 2020 2020 2020 2020  = true;.        
-000bba90: 2f2f 2054 6869 7320 6973 2061 2072 6561  // This is a rea
-000bbaa0: 6c6c 7920 756e 6c69 6b65 6c79 2073 6365  lly unlikely sce
-000bbab0: 6e61 7269 6f20 696e 2072 6561 6c20 776f  nario in real wo
-000bbac0: 726c 642e 2057 6520 7368 6f75 6c64 206e  rld. We should n
-000bbad0: 6f74 2073 6565 6b0a 2020 2020 2020 2020  ot seek.        
-000bbae0: 2f2f 2074 6f20 6f70 7469 6d69 7a65 2069  // to optimize i
-000bbaf0: 742e 0a20 2020 2020 2020 2075 726c 2e75  t..        url.u
-000bbb00: 7064 6174 655f 6261 7365 5f70 6174 686e  pdate_base_pathn
-000bbb10: 616d 6528 756e 6963 6f64 653a 3a70 6572  ame(unicode::per
-000bbb20: 6365 6e74 5f65 6e63 6f64 6528 0a20 2020  cent_encode(.   
-000bbb30: 2020 2020 2020 2020 2076 6965 772c 2063           view, c
-000bbb40: 6861 7261 6374 6572 5f73 6574 733a 3a43  haracter_sets::C
-000bbb50: 305f 434f 4e54 524f 4c5f 5045 5243 454e  0_CONTROL_PERCEN
-000bbb60: 545f 454e 434f 4445 2929 3b0a 2020 2020  T_ENCODE));.    
-000bbb70: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
-000bbb80: 207d 0a20 2020 2020 2063 6173 6520 6164   }.      case ad
-000bbb90: 613a 3a73 7461 7465 3a3a 504f 5254 3a20  a::state::PORT: 
-000bbba0: 7b0a 2020 2020 2020 2020 6164 615f 6c6f  {.        ada_lo
-000bbbb0: 6728 2250 4f52 5420 222c 2068 656c 7065  g("PORT ", helpe
-000bbbc0: 7273 3a3a 7375 6273 7472 696e 6728 7572  rs::substring(ur
-000bbbd0: 6c5f 6461 7461 2c20 696e 7075 745f 706f  l_data, input_po
-000bbbe0: 7369 7469 6f6e 2929 3b0a 2020 2020 2020  sition));.      
-000bbbf0: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
-000bbc00: 6577 2070 6f72 745f 7669 6577 203d 0a20  ew port_view =. 
-000bbc10: 2020 2020 2020 2020 2020 2068 656c 7065             helpe
-000bbc20: 7273 3a3a 7375 6273 7472 696e 6728 7572  rs::substring(ur
-000bbc30: 6c5f 6461 7461 2c20 696e 7075 745f 706f  l_data, input_po
-000bbc40: 7369 7469 6f6e 293b 0a20 2020 2020 2020  sition);.       
-000bbc50: 2073 697a 655f 7420 636f 6e73 756d 6564   size_t consumed
-000bbc60: 5f62 7974 6573 203d 2075 726c 2e70 6172  _bytes = url.par
-000bbc70: 7365 5f70 6f72 7428 706f 7274 5f76 6965  se_port(port_vie
-000bbc80: 772c 2074 7275 6529 3b0a 2020 2020 2020  w, true);.      
-000bbc90: 2020 696e 7075 745f 706f 7369 7469 6f6e    input_position
-000bbca0: 202b 3d20 636f 6e73 756d 6564 5f62 7974   += consumed_byt
-000bbcb0: 6573 3b0a 2020 2020 2020 2020 6966 2028  es;.        if (
-000bbcc0: 2175 726c 2e69 735f 7661 6c69 6429 207b  !url.is_valid) {
-000bbcd0: 0a20 2020 2020 2020 2020 2072 6574 7572  .          retur
-000bbce0: 6e20 7572 6c3b 0a20 2020 2020 2020 207d  n url;.        }
-000bbcf0: 0a20 2020 2020 2020 2073 7461 7465 203d  .        state =
-000bbd00: 2073 7461 7465 3a3a 5041 5448 5f53 5441   state::PATH_STA
-000bbd10: 5254 3b0a 2020 2020 2020 2020 5b5b 6661  RT;.        [[fa
-000bbd20: 6c6c 7468 726f 7567 685d 5d3b 0a20 2020  llthrough]];.   
-000bbd30: 2020 207d 0a20 2020 2020 2063 6173 6520     }.      case 
-000bbd40: 6164 613a 3a73 7461 7465 3a3a 5041 5448  ada::state::PATH
-000bbd50: 5f53 5441 5254 3a20 7b0a 2020 2020 2020  _START: {.      
-000bbd60: 2020 6164 615f 6c6f 6728 2250 4154 485f    ada_log("PATH_
-000bbd70: 5354 4152 5420 222c 2068 656c 7065 7273  START ", helpers
-000bbd80: 3a3a 7375 6273 7472 696e 6728 7572 6c5f  ::substring(url_
-000bbd90: 6461 7461 2c20 696e 7075 745f 706f 7369  data, input_posi
-000bbda0: 7469 6f6e 2929 3b0a 0a20 2020 2020 2020  tion));..       
-000bbdb0: 202f 2f20 4966 2075 726c 2069 7320 7370   // If url is sp
-000bbdc0: 6563 6961 6c2c 2074 6865 6e3a 0a20 2020  ecial, then:.   
-000bbdd0: 2020 2020 2069 6620 2875 726c 2e69 735f       if (url.is_
-000bbde0: 7370 6563 6961 6c28 2929 207b 0a20 2020  special()) {.   
-000bbdf0: 2020 2020 2020 202f 2f20 5365 7420 7374         // Set st
-000bbe00: 6174 6520 746f 2070 6174 6820 7374 6174  ate to path stat
-000bbe10: 652e 0a20 2020 2020 2020 2020 2073 7461  e..          sta
-000bbe20: 7465 203d 2061 6461 3a3a 7374 6174 653a  te = ada::state:
-000bbe30: 3a50 4154 483b 0a0a 2020 2020 2020 2020  :PATH;..        
-000bbe40: 2020 2f2f 204f 7074 696d 697a 6174 696f    // Optimizatio
-000bbe50: 6e3a 2041 766f 6964 696e 6720 676f 696e  n: Avoiding goin
-000bbe60: 6720 696e 746f 2050 4154 4820 7374 6174  g into PATH stat
-000bbe70: 6520 696d 7072 6f76 6573 2074 6865 0a20  e improves the. 
-000bbe80: 2020 2020 2020 2020 202f 2f20 7065 7266           // perf
-000bbe90: 6f72 6d61 6e63 6520 6f66 2075 726c 7320  ormance of urls 
-000bbea0: 656e 6469 6e67 2077 6974 6820 2f2e 0a20  ending with /.. 
-000bbeb0: 2020 2020 2020 2020 2069 6620 2869 6e70           if (inp
-000bbec0: 7574 5f70 6f73 6974 696f 6e20 3d3d 2069  ut_position == i
-000bbed0: 6e70 7574 5f73 697a 6529 207b 0a20 2020  nput_size) {.   
-000bbee0: 2020 2020 2020 2020 2075 726c 2e75 7064           url.upd
-000bbef0: 6174 655f 6261 7365 5f70 6174 686e 616d  ate_base_pathnam
-000bbf00: 6528 222f 2229 3b0a 2020 2020 2020 2020  e("/");.        
-000bbf10: 2020 2020 6966 2028 6672 6167 6d65 6e74      if (fragment
-000bbf20: 2e68 6173 5f76 616c 7565 2829 2920 7b0a  .has_value()) {.
-000bbf30: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-000bbf40: 6c2e 7570 6461 7465 5f75 6e65 6e63 6f64  l.update_unencod
-000bbf50: 6564 5f62 6173 655f 6861 7368 282a 6672  ed_base_hash(*fr
-000bbf60: 6167 6d65 6e74 293b 0a20 2020 2020 2020  agment);.       
-000bbf70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000bbf80: 2020 2072 6574 7572 6e20 7572 6c3b 0a20     return url;. 
-000bbf90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000bbfa0: 2020 2020 202f 2f20 4966 2063 2069 7320       // If c is 
-000bbfb0: 6e65 6974 6865 7220 552b 3030 3246 2028  neither U+002F (
-000bbfc0: 2f29 206e 6f72 2055 2b30 3035 4320 285c  /) nor U+005C (\
-000bbfd0: 292c 2074 6865 6e20 6465 6372 6561 7365  ), then decrease
-000bbfe0: 2070 6f69 6e74 6572 0a20 2020 2020 2020   pointer.       
-000bbff0: 2020 202f 2f20 6279 2031 2e20 5765 206b     // by 1. We k
-000bc000: 6e6f 7720 7468 6174 2028 696e 7075 745f  now that (input_
-000bc010: 706f 7369 7469 6f6e 203d 3d20 696e 7075  position == inpu
-000bc020: 745f 7369 7a65 2920 6973 2069 6d70 6f73  t_size) is impos
-000bc030: 7369 626c 650a 2020 2020 2020 2020 2020  sible.          
-000bc040: 2f2f 2068 6572 652c 2062 6563 6175 7365  // here, because
-000bc050: 206f 6620 7468 6520 7072 6576 696f 7573   of the previous
-000bc060: 2069 662d 6368 6563 6b2e 0a20 2020 2020   if-check..     
-000bc070: 2020 2020 2069 6620 2828 7572 6c5f 6461       if ((url_da
-000bc080: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
-000bc090: 6e5d 2021 3d20 272f 2729 2026 260a 2020  n] != '/') &&.  
-000bc0a0: 2020 2020 2020 2020 2020 2020 2875 726c              (url
-000bc0b0: 5f64 6174 615b 696e 7075 745f 706f 7369  _data[input_posi
-000bc0c0: 7469 6f6e 5d20 213d 2027 5c5c 2729 2920  tion] != '\\')) 
-000bc0d0: 7b0a 2020 2020 2020 2020 2020 2020 6272  {.            br
-000bc0e0: 6561 6b3b 0a20 2020 2020 2020 2020 207d  eak;.          }
-000bc0f0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-000bc100: 2020 202f 2f20 4f74 6865 7277 6973 652c     // Otherwise,
-000bc110: 2069 6620 7374 6174 6520 6f76 6572 7269   if state overri
-000bc120: 6465 2069 7320 6e6f 7420 6769 7665 6e20  de is not given 
-000bc130: 616e 6420 6320 6973 2055 2b30 3033 4620  and c is U+003F 
-000bc140: 283f 292c 0a20 2020 2020 2020 202f 2f20  (?),.        // 
-000bc150: 7365 7420 7572 6ce2 8099 7320 7175 6572  set url...s quer
-000bc160: 7920 746f 2074 6865 2065 6d70 7479 2073  y to the empty s
-000bc170: 7472 696e 6720 616e 6420 7374 6174 6520  tring and state 
-000bc180: 746f 2071 7565 7279 2073 7461 7465 2e0a  to query state..
-000bc190: 2020 2020 2020 2020 656c 7365 2069 6620          else if 
-000bc1a0: 2828 696e 7075 745f 706f 7369 7469 6f6e  ((input_position
-000bc1b0: 2021 3d20 696e 7075 745f 7369 7a65 2920   != input_size) 
-000bc1c0: 2626 0a20 2020 2020 2020 2020 2020 2020  &&.             
-000bc1d0: 2020 2020 2875 726c 5f64 6174 615b 696e      (url_data[in
-000bc1e0: 7075 745f 706f 7369 7469 6f6e 5d20 3d3d  put_position] ==
-000bc1f0: 2027 3f27 2929 207b 0a20 2020 2020 2020   '?')) {.       
-000bc200: 2020 2073 7461 7465 203d 2061 6461 3a3a     state = ada::
-000bc210: 7374 6174 653a 3a51 5545 5259 3b0a 2020  state::QUERY;.  
-000bc220: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000bc230: 2f2f 204f 7468 6572 7769 7365 2c20 6966  // Otherwise, if
-000bc240: 2063 2069 7320 6e6f 7420 7468 6520 454f   c is not the EO
-000bc250: 4620 636f 6465 2070 6f69 6e74 3a0a 2020  F code point:.  
-000bc260: 2020 2020 2020 656c 7365 2069 6620 2869        else if (i
-000bc270: 6e70 7574 5f70 6f73 6974 696f 6e20 213d  nput_position !=
-000bc280: 2069 6e70 7574 5f73 697a 6529 207b 0a20   input_size) {. 
-000bc290: 2020 2020 2020 2020 202f 2f20 5365 7420           // Set 
-000bc2a0: 7374 6174 6520 746f 2070 6174 6820 7374  state to path st
-000bc2b0: 6174 652e 0a20 2020 2020 2020 2020 2073  ate..          s
-000bc2c0: 7461 7465 203d 2061 6461 3a3a 7374 6174  tate = ada::stat
-000bc2d0: 653a 3a50 4154 483b 0a0a 2020 2020 2020  e::PATH;..      
-000bc2e0: 2020 2020 2f2f 2049 6620 6320 6973 206e      // If c is n
-000bc2f0: 6f74 2055 2b30 3032 4620 282f 292c 2074  ot U+002F (/), t
-000bc300: 6865 6e20 6465 6372 6561 7365 2070 6f69  hen decrease poi
-000bc310: 6e74 6572 2062 7920 312e 0a20 2020 2020  nter by 1..     
-000bc320: 2020 2020 2069 6620 2875 726c 5f64 6174       if (url_dat
-000bc330: 615b 696e 7075 745f 706f 7369 7469 6f6e  a[input_position
-000bc340: 5d20 213d 2027 2f27 2920 7b0a 2020 2020  ] != '/') {.    
-000bc350: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-000bc360: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000bc370: 2020 207d 0a0a 2020 2020 2020 2020 696e     }..        in
-000bc380: 7075 745f 706f 7369 7469 6f6e 2b2b 3b0a  put_position++;.
-000bc390: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-000bc3a0: 2020 2020 207d 0a20 2020 2020 2063 6173       }.      cas
-000bc3b0: 6520 6164 613a 3a73 7461 7465 3a3a 5041  e ada::state::PA
-000bc3c0: 5448 3a20 7b0a 2020 2020 2020 2020 7374  TH: {.        st
-000bc3d0: 643a 3a73 7472 696e 675f 7669 6577 2076  d::string_view v
-000bc3e0: 6965 7720 3d20 6865 6c70 6572 733a 3a73  iew = helpers::s
-000bc3f0: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000bc400: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000bc410: 6e29 3b0a 2020 2020 2020 2020 6164 615f  n);.        ada_
-000bc420: 6c6f 6728 2250 4154 4820 222c 2068 656c  log("PATH ", hel
-000bc430: 7065 7273 3a3a 7375 6273 7472 696e 6728  pers::substring(
-000bc440: 7572 6c5f 6461 7461 2c20 696e 7075 745f  url_data, input_
-000bc450: 706f 7369 7469 6f6e 2929 3b0a 0a20 2020  position));..   
-000bc460: 2020 2020 202f 2f20 4d6f 7374 2074 696d       // Most tim
-000bc470: 652c 2077 6520 646f 206e 6f74 206e 6565  e, we do not nee
-000bc480: 6420 7065 7263 656e 7420 656e 636f 6469  d percent encodi
-000bc490: 6e67 2e0a 2020 2020 2020 2020 2f2f 2046  ng..        // F
-000bc4a0: 7572 7468 6572 6d6f 7265 2c20 7765 2063  urthermore, we c
-000bc4b0: 616e 2069 6d6d 6564 6961 7465 6c79 206c  an immediately l
-000bc4c0: 6f63 6174 6520 7468 6520 273f 272e 0a20  ocate the '?'.. 
-000bc4d0: 2020 2020 2020 2073 697a 655f 7420 6c6f         size_t lo
-000bc4e0: 636f 6671 7565 7374 696f 6e6d 6172 6b20  cofquestionmark 
-000bc4f0: 3d20 7669 6577 2e66 696e 6428 273f 2729  = view.find('?')
-000bc500: 3b0a 2020 2020 2020 2020 6966 2028 6c6f  ;.        if (lo
-000bc510: 636f 6671 7565 7374 696f 6e6d 6172 6b20  cofquestionmark 
-000bc520: 213d 2073 7464 3a3a 7374 7269 6e67 5f76  != std::string_v
-000bc530: 6965 773a 3a6e 706f 7329 207b 0a20 2020  iew::npos) {.   
-000bc540: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
-000bc550: 6461 3a3a 7374 6174 653a 3a51 5545 5259  da::state::QUERY
-000bc560: 3b0a 2020 2020 2020 2020 2020 7669 6577  ;.          view
-000bc570: 2e72 656d 6f76 655f 7375 6666 6978 2876  .remove_suffix(v
-000bc580: 6965 772e 7369 7a65 2829 202d 206c 6f63  iew.size() - loc
-000bc590: 6f66 7175 6573 7469 6f6e 6d61 726b 293b  ofquestionmark);
-000bc5a0: 0a20 2020 2020 2020 2020 2069 6e70 7574  .          input
-000bc5b0: 5f70 6f73 6974 696f 6e20 2b3d 206c 6f63  _position += loc
-000bc5c0: 6f66 7175 6573 7469 6f6e 6d61 726b 202b  ofquestionmark +
-000bc5d0: 2031 3b0a 2020 2020 2020 2020 7d20 656c   1;.        } el
-000bc5e0: 7365 207b 0a20 2020 2020 2020 2020 2069  se {.          i
-000bc5f0: 6e70 7574 5f70 6f73 6974 696f 6e20 3d20  nput_position = 
-000bc600: 696e 7075 745f 7369 7a65 202b 2031 3b0a  input_size + 1;.
-000bc610: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000bc620: 2020 6966 2063 6f6e 7374 6578 7072 2028    if constexpr (
-000bc630: 7265 7375 6c74 5f74 7970 655f 6973 5f61  result_type_is_a
-000bc640: 6461 5f75 726c 2920 7b0a 2020 2020 2020  da_url) {.      
-000bc650: 2020 2020 6865 6c70 6572 733a 3a70 6172      helpers::par
-000bc660: 7365 5f70 7265 7061 7265 645f 7061 7468  se_prepared_path
-000bc670: 2876 6965 772c 2075 726c 2e74 7970 652c  (view, url.type,
-000bc680: 2075 726c 2e70 6174 6829 3b0a 2020 2020   url.path);.    
-000bc690: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-000bc6a0: 2020 2020 2020 2075 726c 2e63 6f6e 7375         url.consu
-000bc6b0: 6d65 5f70 7265 7061 7265 645f 7061 7468  me_prepared_path
-000bc6c0: 2876 6965 7729 3b0a 2020 2020 2020 2020  (view);.        
-000bc6d0: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000bc6e0: 4528 7572 6c2e 7661 6c69 6461 7465 2829  E(url.validate()
-000bc6f0: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
-000bc700: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
-000bc710: 2020 7d0a 2020 2020 2020 6361 7365 2061    }.      case a
-000bc720: 6461 3a3a 7374 6174 653a 3a46 494c 455f  da::state::FILE_
-000bc730: 534c 4153 483a 207b 0a20 2020 2020 2020  SLASH: {.       
-000bc740: 2061 6461 5f6c 6f67 2822 4649 4c45 5f53   ada_log("FILE_S
-000bc750: 4c41 5348 2022 2c20 6865 6c70 6572 733a  LASH ", helpers:
-000bc760: 3a73 7562 7374 7269 6e67 2875 726c 5f64  :substring(url_d
-000bc770: 6174 612c 2069 6e70 7574 5f70 6f73 6974  ata, input_posit
-000bc780: 696f 6e29 293b 0a0a 2020 2020 2020 2020  ion));..        
-000bc790: 2f2f 2049 6620 6320 6973 2055 2b30 3032  // If c is U+002
-000bc7a0: 4620 282f 2920 6f72 2055 2b30 3035 4320  F (/) or U+005C 
-000bc7b0: 285c 292c 2074 6865 6e3a 0a20 2020 2020  (\), then:.     
-000bc7c0: 2020 2069 6620 2828 696e 7075 745f 706f     if ((input_po
-000bc7d0: 7369 7469 6f6e 2021 3d20 696e 7075 745f  sition != input_
-000bc7e0: 7369 7a65 2920 2626 0a20 2020 2020 2020  size) &&.       
-000bc7f0: 2020 2020 2028 7572 6c5f 6461 7461 5b69       (url_data[i
-000bc800: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
-000bc810: 3d20 272f 2720 7c7c 0a20 2020 2020 2020  = '/' ||.       
-000bc820: 2020 2020 2020 7572 6c5f 6461 7461 5b69        url_data[i
-000bc830: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
-000bc840: 3d20 275c 5c27 2929 207b 0a20 2020 2020  = '\\')) {.     
-000bc850: 2020 2020 2061 6461 5f6c 6f67 2822 4649       ada_log("FI
-000bc860: 4c45 5f53 4c41 5348 2063 2069 7320 552b  LE_SLASH c is U+
-000bc870: 3030 3246 206f 7220 552b 3030 3543 2229  002F or U+005C")
-000bc880: 3b0a 2020 2020 2020 2020 2020 2f2f 2053  ;.          // S
-000bc890: 6574 2073 7461 7465 2074 6f20 6669 6c65  et state to file
-000bc8a0: 2068 6f73 7420 7374 6174 652e 0a20 2020   host state..   
-000bc8b0: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
-000bc8c0: 6461 3a3a 7374 6174 653a 3a46 494c 455f  da::state::FILE_
-000bc8d0: 484f 5354 3b0a 2020 2020 2020 2020 2020  HOST;.          
-000bc8e0: 696e 7075 745f 706f 7369 7469 6f6e 2b2b  input_position++
-000bc8f0: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
-000bc900: 207b 0a20 2020 2020 2020 2020 2061 6461   {.          ada
-000bc910: 5f6c 6f67 2822 4649 4c45 5f53 4c41 5348  _log("FILE_SLASH
-000bc920: 206f 7468 6572 7769 7365 2229 3b0a 2020   otherwise");.  
-000bc930: 2020 2020 2020 2020 2f2f 2049 6620 6261          // If ba
-000bc940: 7365 2069 7320 6e6f 6e2d 6e75 6c6c 2061  se is non-null a
-000bc950: 6e64 2062 6173 65e2 8099 7320 7363 6865  nd base...s sche
-000bc960: 6d65 2069 7320 2266 696c 6522 2c20 7468  me is "file", th
-000bc970: 656e 3a0a 2020 2020 2020 2020 2020 2f2f  en:.          //
-000bc980: 204e 6f74 653a 2069 7420 6973 2075 6e73   Note: it is uns
-000bc990: 6166 6520 746f 2064 6f20 6261 7365 5f75  afe to do base_u
-000bc9a0: 726c 2d3e 7363 6865 6d65 2075 6e6c 6573  rl->scheme unles
-000bc9b0: 7320 796f 7520 6b6e 6f77 2074 6861 740a  s you know that.
-000bc9c0: 2020 2020 2020 2020 2020 2f2f 2062 6173            // bas
-000bc9d0: 655f 7572 6c5f 6861 735f 7661 6c75 6528  e_url_has_value(
-000bc9e0: 2920 6973 2074 7275 652e 0a20 2020 2020  ) is true..     
-000bc9f0: 2020 2020 2069 6620 2862 6173 655f 7572       if (base_ur
-000bca00: 6c20 213d 206e 756c 6c70 7472 2026 260a  l != nullptr &&.
-000bca10: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-000bca20: 7365 5f75 726c 2d3e 7479 7065 203d 3d20  se_url->type == 
-000bca30: 6164 613a 3a73 6368 656d 653a 3a74 7970  ada::scheme::typ
-000bca40: 653a 3a46 494c 4529 207b 0a20 2020 2020  e::FILE) {.     
-000bca50: 2020 2020 2020 202f 2f20 5365 7420 7572         // Set ur
-000bca60: 6ce2 8099 7320 686f 7374 2074 6f20 6261  l...s host to ba
-000bca70: 7365 e280 9973 2068 6f73 742e 0a20 2020  se...s host..   
-000bca80: 2020 2020 2020 2020 2069 6620 636f 6e73           if cons
-000bca90: 7465 7870 7220 2872 6573 756c 745f 7479  texpr (result_ty
-000bcaa0: 7065 5f69 735f 6164 615f 7572 6c29 207b  pe_is_ada_url) {
-000bcab0: 0a20 2020 2020 2020 2020 2020 2020 2075  .              u
-000bcac0: 726c 2e68 6f73 7420 3d20 6261 7365 5f75  rl.host = base_u
-000bcad0: 726c 2d3e 686f 7374 3b0a 2020 2020 2020  rl->host;.      
-000bcae0: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-000bcaf0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-000bcb00: 544f 444f 3a20 4f70 7469 6d69 7a61 7469  TODO: Optimizati
-000bcb10: 6f6e 206f 7070 6f72 7475 6e69 7479 2e0a  on opportunity..
-000bcb20: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-000bcb30: 6c2e 7365 745f 686f 7374 2862 6173 655f  l.set_host(base_
-000bcb40: 7572 6c2d 3e67 6574 5f68 6f73 7428 2929  url->get_host())
-000bcb50: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-000bcb60: 2020 2020 2020 2020 2020 2020 2f2f 2049              // I
-000bcb70: 6620 7468 6520 636f 6465 2070 6f69 6e74  f the code point
-000bcb80: 2073 7562 7374 7269 6e67 2066 726f 6d20   substring from 
-000bcb90: 706f 696e 7465 7220 746f 2074 6865 2065  pointer to the e
-000bcba0: 6e64 206f 6620 696e 7075 7420 646f 6573  nd of input does
-000bcbb0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-000bcbc0: 6e6f 7420 7374 6172 7420 7769 7468 2061  not start with a
-000bcbd0: 2057 696e 646f 7773 2064 7269 7665 206c   Windows drive l
-000bcbe0: 6574 7465 7220 616e 6420 6261 7365 e280  etter and base..
-000bcbf0: 9973 2070 6174 685b 305d 2069 7320 610a  .s path[0] is a.
-000bcc00: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
-000bcc10: 6f72 6d61 6c69 7a65 6420 5769 6e64 6f77  ormalized Window
-000bcc20: 7320 6472 6976 6520 6c65 7474 6572 2c20  s drive letter, 
-000bcc30: 7468 656e 2061 7070 656e 6420 6261 7365  then append base
-000bcc40: e280 9973 2070 6174 685b 305d 2074 6f0a  ...s path[0] to.
-000bcc50: 2020 2020 2020 2020 2020 2020 2f2f 2075              // u
-000bcc60: 726c e280 9973 2070 6174 682e 0a20 2020  rl...s path..   
-000bcc70: 2020 2020 2020 2020 2069 6620 2821 6261           if (!ba
-000bcc80: 7365 5f75 726c 2d3e 6765 745f 7061 7468  se_url->get_path
-000bcc90: 6e61 6d65 2829 2e65 6d70 7479 2829 2920  name().empty()) 
-000bcca0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000bccb0: 6966 2028 2163 6865 636b 6572 733a 3a69  if (!checkers::i
-000bccc0: 735f 7769 6e64 6f77 735f 6472 6976 655f  s_windows_drive_
-000bccd0: 6c65 7474 6572 280a 2020 2020 2020 2020  letter(.        
-000bcce0: 2020 2020 2020 2020 2020 2020 2020 6865                he
-000bccf0: 6c70 6572 733a 3a73 7562 7374 7269 6e67  lpers::substring
-000bcd00: 2875 726c 5f64 6174 612c 2069 6e70 7574  (url_data, input
-000bcd10: 5f70 6f73 6974 696f 6e29 2929 207b 0a20  _position))) {. 
-000bcd20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000bcd30: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
-000bcd40: 6669 7273 745f 6261 7365 5f75 726c 5f70  first_base_url_p
-000bcd50: 6174 6820 3d0a 2020 2020 2020 2020 2020  ath =.          
-000bcd60: 2020 2020 2020 2020 2020 6261 7365 5f75            base_u
-000bcd70: 726c 2d3e 6765 745f 7061 7468 6e61 6d65  rl->get_pathname
-000bcd80: 2829 2e73 7562 7374 7228 3129 3b0a 2020  ().substr(1);.  
-000bcd90: 2020 2020 2020 2020 2020 2020 2020 7369                si
-000bcda0: 7a65 5f74 206c 6f63 203d 2066 6972 7374  ze_t loc = first
-000bcdb0: 5f62 6173 655f 7572 6c5f 7061 7468 2e66  _base_url_path.f
-000bcdc0: 696e 6428 272f 2729 3b0a 2020 2020 2020  ind('/');.      
-000bcdd0: 2020 2020 2020 2020 2020 6966 2028 6c6f            if (lo
-000bcde0: 6320 213d 2073 7464 3a3a 7374 7269 6e67  c != std::string
-000bcdf0: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
-000bce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bce10: 2068 656c 7065 7273 3a3a 7265 7369 7a65   helpers::resize
-000bce20: 2866 6972 7374 5f62 6173 655f 7572 6c5f  (first_base_url_
-000bce30: 7061 7468 2c20 6c6f 6329 3b0a 2020 2020  path, loc);.    
-000bce40: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000bce50: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000bce60: 2028 6368 6563 6b65 7273 3a3a 6973 5f6e   (checkers::is_n
-000bce70: 6f72 6d61 6c69 7a65 645f 7769 6e64 6f77  ormalized_window
-000bce80: 735f 6472 6976 655f 6c65 7474 6572 280a  s_drive_letter(.
-000bce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bcea0: 2020 2020 2020 2020 6669 7273 745f 6261          first_ba
-000bceb0: 7365 5f75 726c 5f70 6174 6829 2920 7b0a  se_url_path)) {.
-000bcec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bced0: 2020 6966 2063 6f6e 7374 6578 7072 2028    if constexpr (
-000bcee0: 7265 7375 6c74 5f74 7970 655f 6973 5f61  result_type_is_a
-000bcef0: 6461 5f75 726c 2920 7b0a 2020 2020 2020  da_url) {.      
-000bcf00: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-000bcf10: 6c2e 7061 7468 202b 3d20 272f 273b 0a20  l.path += '/';. 
-000bcf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bcf30: 2020 2075 726c 2e70 6174 6820 2b3d 2066     url.path += f
-000bcf40: 6972 7374 5f62 6173 655f 7572 6c5f 7061  irst_base_url_pa
-000bcf50: 7468 3b0a 2020 2020 2020 2020 2020 2020  th;.            
-000bcf60: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-000bcf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bcf80: 2020 2075 726c 2e61 7070 656e 645f 6261     url.append_ba
-000bcf90: 7365 5f70 6174 686e 616d 6528 0a20 2020  se_pathname(.   
-000bcfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000bcfb0: 2020 2020 2068 656c 7065 7273 3a3a 636f       helpers::co
-000bcfc0: 6e63 6174 2822 2f22 2c20 6669 7273 745f  ncat("/", first_
-000bcfd0: 6261 7365 5f75 726c 5f70 6174 6829 293b  base_url_path));
-000bcfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000bcff0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000bd000: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000bd010: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000bd020: 2020 207d 0a20 2020 2020 2020 2020 207d     }.          }
-000bd030: 0a0a 2020 2020 2020 2020 2020 2f2f 2053  ..          // S
-000bd040: 6574 2073 7461 7465 2074 6f20 7061 7468  et state to path
-000bd050: 2073 7461 7465 2c20 616e 6420 6465 6372   state, and decr
-000bd060: 6561 7365 2070 6f69 6e74 6572 2062 7920  ease pointer by 
-000bd070: 312e 0a20 2020 2020 2020 2020 2073 7461  1..          sta
-000bd080: 7465 203d 2061 6461 3a3a 7374 6174 653a  te = ada::state:
-000bd090: 3a50 4154 483b 0a20 2020 2020 2020 207d  :PATH;.        }
-000bd0a0: 0a0a 2020 2020 2020 2020 6272 6561 6b3b  ..        break;
-000bd0b0: 0a20 2020 2020 207d 0a20 2020 2020 2063  .      }.      c
-000bd0c0: 6173 6520 6164 613a 3a73 7461 7465 3a3a  ase ada::state::
-000bd0d0: 4649 4c45 5f48 4f53 543a 207b 0a20 2020  FILE_HOST: {.   
-000bd0e0: 2020 2020 2073 7464 3a3a 7374 7269 6e67       std::string
-000bd0f0: 5f76 6965 7720 7669 6577 203d 2068 656c  _view view = hel
-000bd100: 7065 7273 3a3a 7375 6273 7472 696e 6728  pers::substring(
-000bd110: 7572 6c5f 6461 7461 2c20 696e 7075 745f  url_data, input_
-000bd120: 706f 7369 7469 6f6e 293b 0a20 2020 2020  position);.     
-000bd130: 2020 2061 6461 5f6c 6f67 2822 4649 4c45     ada_log("FILE
-000bd140: 5f48 4f53 5420 222c 2068 656c 7065 7273  _HOST ", helpers
-000bd150: 3a3a 7375 6273 7472 696e 6728 7572 6c5f  ::substring(url_
-000bd160: 6461 7461 2c20 696e 7075 745f 706f 7369  data, input_posi
-000bd170: 7469 6f6e 2929 3b0a 0a20 2020 2020 2020  tion));..       
-000bd180: 2073 697a 655f 7420 6c6f 6361 7469 6f6e   size_t location
-000bd190: 203d 2076 6965 772e 6669 6e64 5f66 6972   = view.find_fir
-000bd1a0: 7374 5f6f 6628 222f 5c5c 3f22 293b 0a20  st_of("/\\?");. 
-000bd1b0: 2020 2020 2020 2073 7464 3a3a 7374 7269         std::stri
-000bd1c0: 6e67 5f76 6965 7720 6669 6c65 5f68 6f73  ng_view file_hos
-000bd1d0: 745f 6275 6666 6572 280a 2020 2020 2020  t_buffer(.      
-000bd1e0: 2020 2020 2020 7669 6577 2e64 6174 6128        view.data(
-000bd1f0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-000bd200: 6c6f 6361 7469 6f6e 2021 3d20 7374 643a  location != std:
-000bd210: 3a73 7472 696e 675f 7669 6577 3a3a 6e70  :string_view::np
-000bd220: 6f73 2920 3f20 6c6f 6361 7469 6f6e 203a  os) ? location :
-000bd230: 2076 6965 772e 7369 7a65 2829 293b 0a0a   view.size());..
-000bd240: 2020 2020 2020 2020 6966 2028 6368 6563          if (chec
-000bd250: 6b65 7273 3a3a 6973 5f77 696e 646f 7773  kers::is_windows
-000bd260: 5f64 7269 7665 5f6c 6574 7465 7228 6669  _drive_letter(fi
-000bd270: 6c65 5f68 6f73 745f 6275 6666 6572 2929  le_host_buffer))
-000bd280: 207b 0a20 2020 2020 2020 2020 2073 7461   {.          sta
-000bd290: 7465 203d 2061 6461 3a3a 7374 6174 653a  te = ada::state:
-000bd2a0: 3a50 4154 483b 0a20 2020 2020 2020 207d  :PATH;.        }
-000bd2b0: 2065 6c73 6520 6966 2028 6669 6c65 5f68   else if (file_h
-000bd2c0: 6f73 745f 6275 6666 6572 2e65 6d70 7479  ost_buffer.empty
-000bd2d0: 2829 2920 7b0a 2020 2020 2020 2020 2020  ()) {.          
-000bd2e0: 2f2f 2053 6574 2075 726c e280 9973 2068  // Set url...s h
-000bd2f0: 6f73 7420 746f 2074 6865 2065 6d70 7479  ost to the empty
-000bd300: 2073 7472 696e 672e 0a20 2020 2020 2020   string..       
-000bd310: 2020 2069 6620 636f 6e73 7465 7870 7220     if constexpr 
-000bd320: 2872 6573 756c 745f 7479 7065 5f69 735f  (result_type_is_
-000bd330: 6164 615f 7572 6c29 207b 0a20 2020 2020  ada_url) {.     
-000bd340: 2020 2020 2020 2075 726c 2e68 6f73 7420         url.host 
-000bd350: 3d20 2222 3b0a 2020 2020 2020 2020 2020  = "";.          
-000bd360: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-000bd370: 2020 2020 2075 726c 2e75 7064 6174 655f       url.update_
-000bd380: 6261 7365 5f68 6f73 746e 616d 6528 2222  base_hostname(""
-000bd390: 293b 0a20 2020 2020 2020 2020 207d 0a20  );.          }. 
-000bd3a0: 2020 2020 2020 2020 202f 2f20 5365 7420           // Set 
-000bd3b0: 7374 6174 6520 746f 2070 6174 6820 7374  state to path st
-000bd3c0: 6172 7420 7374 6174 652e 0a20 2020 2020  art state..     
-000bd3d0: 2020 2020 2073 7461 7465 203d 2061 6461       state = ada
-000bd3e0: 3a3a 7374 6174 653a 3a50 4154 485f 5354  ::state::PATH_ST
-000bd3f0: 4152 543b 0a20 2020 2020 2020 207d 2065  ART;.        } e
-000bd400: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-000bd410: 7369 7a65 5f74 2063 6f6e 7375 6d65 645f  size_t consumed_
-000bd420: 6279 7465 7320 3d20 6669 6c65 5f68 6f73  bytes = file_hos
-000bd430: 745f 6275 6666 6572 2e73 697a 6528 293b  t_buffer.size();
-000bd440: 0a20 2020 2020 2020 2020 2069 6e70 7574  .          input
-000bd450: 5f70 6f73 6974 696f 6e20 2b3d 2063 6f6e  _position += con
-000bd460: 7375 6d65 645f 6279 7465 733b 0a20 2020  sumed_bytes;.   
-000bd470: 2020 2020 2020 202f 2f20 4c65 7420 686f         // Let ho
-000bd480: 7374 2062 6520 7468 6520 7265 7375 6c74  st be the result
-000bd490: 206f 6620 686f 7374 2070 6172 7369 6e67   of host parsing
-000bd4a0: 2062 7566 6665 7220 7769 7468 2075 726c   buffer with url
-000bd4b0: 2069 7320 6e6f 740a 2020 2020 2020 2020   is not.        
-000bd4c0: 2020 2f2f 2073 7065 6369 616c 2e0a 2020    // special..  
-000bd4d0: 2020 2020 2020 2020 6966 2028 2175 726c          if (!url
-000bd4e0: 2e70 6172 7365 5f68 6f73 7428 6669 6c65  .parse_host(file
-000bd4f0: 5f68 6f73 745f 6275 6666 6572 2929 207b  _host_buffer)) {
-000bd500: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000bd510: 7572 6e20 7572 6c3b 0a20 2020 2020 2020  urn url;.       
-000bd520: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-000bd530: 6966 2063 6f6e 7374 6578 7072 2028 7265  if constexpr (re
-000bd540: 7375 6c74 5f74 7970 655f 6973 5f61 6461  sult_type_is_ada
-000bd550: 5f75 726c 2920 7b0a 2020 2020 2020 2020  _url) {.        
-000bd560: 2020 2020 2f2f 2049 6620 686f 7374 2069      // If host i
-000bd570: 7320 226c 6f63 616c 686f 7374 222c 2074  s "localhost", t
-000bd580: 6865 6e20 7365 7420 686f 7374 2074 6f20  hen set host to 
-000bd590: 7468 6520 656d 7074 7920 7374 7269 6e67  the empty string
-000bd5a0: 2e0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-000bd5b0: 2028 7572 6c2e 686f 7374 2e68 6173 5f76   (url.host.has_v
-000bd5c0: 616c 7565 2829 2026 2620 7572 6c2e 686f  alue() && url.ho
-000bd5d0: 7374 2e76 616c 7565 2829 203d 3d20 226c  st.value() == "l
-000bd5e0: 6f63 616c 686f 7374 2229 207b 0a20 2020  ocalhost") {.   
-000bd5f0: 2020 2020 2020 2020 2020 2075 726c 2e68             url.h
-000bd600: 6f73 7420 3d20 2222 3b0a 2020 2020 2020  ost = "";.      
-000bd610: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000bd620: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-000bd630: 2020 2020 2020 2069 6620 2875 726c 2e67         if (url.g
-000bd640: 6574 5f68 6f73 746e 616d 6528 2920 3d3d  et_hostname() ==
-000bd650: 2022 6c6f 6361 6c68 6f73 7422 2920 7b0a   "localhost") {.
-000bd660: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-000bd670: 6c2e 7570 6461 7465 5f62 6173 655f 686f  l.update_base_ho
-000bd680: 7374 6e61 6d65 2822 2229 3b0a 2020 2020  stname("");.    
-000bd690: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000bd6a0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-000bd6b0: 202f 2f20 5365 7420 6275 6666 6572 2074   // Set buffer t
-000bd6c0: 6f20 7468 6520 656d 7074 7920 7374 7269  o the empty stri
-000bd6d0: 6e67 2061 6e64 2073 7461 7465 2074 6f20  ng and state to 
-000bd6e0: 7061 7468 2073 7461 7274 2073 7461 7465  path start state
-000bd6f0: 2e0a 2020 2020 2020 2020 2020 7374 6174  ..          stat
-000bd700: 6520 3d20 6164 613a 3a73 7461 7465 3a3a  e = ada::state::
-000bd710: 5041 5448 5f53 5441 5254 3b0a 2020 2020  PATH_START;.    
-000bd720: 2020 2020 7d0a 0a20 2020 2020 2020 2062      }..        b
-000bd730: 7265 616b 3b0a 2020 2020 2020 7d0a 2020  reak;.      }.  
-000bd740: 2020 2020 6361 7365 2061 6461 3a3a 7374      case ada::st
-000bd750: 6174 653a 3a46 494c 453a 207b 0a20 2020  ate::FILE: {.   
-000bd760: 2020 2020 2061 6461 5f6c 6f67 2822 4649       ada_log("FI
-000bd770: 4c45 2022 2c20 6865 6c70 6572 733a 3a73  LE ", helpers::s
-000bd780: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000bd790: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000bd7a0: 6e29 293b 0a20 2020 2020 2020 2073 7464  n));.        std
-000bd7b0: 3a3a 7374 7269 6e67 5f76 6965 7720 6669  ::string_view fi
-000bd7c0: 6c65 5f76 6965 7720 3d0a 2020 2020 2020  le_view =.      
-000bd7d0: 2020 2020 2020 6865 6c70 6572 733a 3a73        helpers::s
-000bd7e0: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
-000bd7f0: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
-000bd800: 6e29 3b0a 0a20 2020 2020 2020 2075 726c  n);..        url
-000bd810: 2e73 6574 5f70 726f 746f 636f 6c5f 6173  .set_protocol_as
-000bd820: 5f66 696c 6528 293b 0a20 2020 2020 2020  _file();.       
-000bd830: 2069 6620 636f 6e73 7465 7870 7220 2872   if constexpr (r
-000bd840: 6573 756c 745f 7479 7065 5f69 735f 6164  esult_type_is_ad
-000bd850: 615f 7572 6c29 207b 0a20 2020 2020 2020  a_url) {.       
-000bd860: 2020 202f 2f20 5365 7420 7572 6ce2 8099     // Set url...
-000bd870: 7320 686f 7374 2074 6f20 7468 6520 656d  s host to the em
-000bd880: 7074 7920 7374 7269 6e67 2e0a 2020 2020  pty string..    
-000bd890: 2020 2020 2020 7572 6c2e 686f 7374 203d        url.host =
-000bd8a0: 2022 223b 0a20 2020 2020 2020 207d 2065   "";.        } e
-000bd8b0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-000bd8c0: 7572 6c2e 7570 6461 7465 5f62 6173 655f  url.update_base_
-000bd8d0: 686f 7374 6e61 6d65 2822 2229 3b0a 2020  hostname("");.  
-000bd8e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000bd8f0: 2f2f 2049 6620 6320 6973 2055 2b30 3032  // If c is U+002
-000bd900: 4620 282f 2920 6f72 2055 2b30 3035 4320  F (/) or U+005C 
-000bd910: 285c 292c 2074 6865 6e3a 0a20 2020 2020  (\), then:.     
-000bd920: 2020 2069 6620 2869 6e70 7574 5f70 6f73     if (input_pos
-000bd930: 6974 696f 6e20 213d 2069 6e70 7574 5f73  ition != input_s
-000bd940: 697a 6520 2626 0a20 2020 2020 2020 2020  ize &&.         
-000bd950: 2020 2028 7572 6c5f 6461 7461 5b69 6e70     (url_data[inp
-000bd960: 7574 5f70 6f73 6974 696f 6e5d 203d 3d20  ut_position] == 
-000bd970: 272f 2720 7c7c 0a20 2020 2020 2020 2020  '/' ||.         
-000bd980: 2020 2020 7572 6c5f 6461 7461 5b69 6e70      url_data[inp
-000bd990: 7574 5f70 6f73 6974 696f 6e5d 203d 3d20  ut_position] == 
-000bd9a0: 275c 5c27 2929 207b 0a20 2020 2020 2020  '\\')) {.       
-000bd9b0: 2020 2061 6461 5f6c 6f67 2822 4649 4c45     ada_log("FILE
-000bd9c0: 2063 2069 7320 552b 3030 3246 206f 7220   c is U+002F or 
-000bd9d0: 552b 3030 3543 2229 3b0a 2020 2020 2020  U+005C");.      
-000bd9e0: 2020 2020 2f2f 2053 6574 2073 7461 7465      // Set state
-000bd9f0: 2074 6f20 6669 6c65 2073 6c61 7368 2073   to file slash s
-000bda00: 7461 7465 2e0a 2020 2020 2020 2020 2020  tate..          
-000bda10: 7374 6174 6520 3d20 6164 613a 3a73 7461  state = ada::sta
-000bda20: 7465 3a3a 4649 4c45 5f53 4c41 5348 3b0a  te::FILE_SLASH;.
-000bda30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000bda40: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
-000bda50: 6966 2062 6173 6520 6973 206e 6f6e 2d6e  if base is non-n
-000bda60: 756c 6c20 616e 6420 6261 7365 e280 9973  ull and base...s
-000bda70: 2073 6368 656d 6520 6973 2022 6669 6c65   scheme is "file
-000bda80: 223a 0a20 2020 2020 2020 2065 6c73 6520  ":.        else 
-000bda90: 6966 2028 6261 7365 5f75 726c 2021 3d20  if (base_url != 
-000bdaa0: 6e75 6c6c 7074 7220 2626 0a20 2020 2020  nullptr &&.     
-000bdab0: 2020 2020 2020 2020 2020 2020 6261 7365              base
-000bdac0: 5f75 726c 2d3e 7479 7065 203d 3d20 6164  _url->type == ad
-000bdad0: 613a 3a73 6368 656d 653a 3a74 7970 653a  a::scheme::type:
-000bdae0: 3a46 494c 4529 207b 0a20 2020 2020 2020  :FILE) {.       
-000bdaf0: 2020 202f 2f20 5365 7420 7572 6ce2 8099     // Set url...
-000bdb00: 7320 686f 7374 2074 6f20 6261 7365 e280  s host to base..
-000bdb10: 9973 2068 6f73 742c 2075 726c e280 9973  .s host, url...s
-000bdb20: 2070 6174 6820 746f 2061 2063 6c6f 6e65   path to a clone
-000bdb30: 206f 6620 6261 7365 e280 9973 0a20 2020   of base...s.   
-000bdb40: 2020 2020 2020 202f 2f20 7061 7468 2c20         // path, 
-000bdb50: 616e 6420 7572 6ce2 8099 7320 7175 6572  and url...s quer
-000bdb60: 7920 746f 2062 6173 65e2 8099 7320 7175  y to base...s qu
-000bdb70: 6572 792e 0a20 2020 2020 2020 2020 2061  ery..          a
-000bdb80: 6461 5f6c 6f67 2822 4649 4c45 2062 6173  da_log("FILE bas
-000bdb90: 6520 6e6f 6e2d 6e75 6c6c 2229 3b0a 2020  e non-null");.  
-000bdba0: 2020 2020 2020 2020 6966 2063 6f6e 7374          if const
-000bdbb0: 6578 7072 2028 7265 7375 6c74 5f74 7970  expr (result_typ
-000bdbc0: 655f 6973 5f61 6461 5f75 726c 2920 7b0a  e_is_ada_url) {.
-000bdbd0: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
-000bdbe0: 686f 7374 203d 2062 6173 655f 7572 6c2d  host = base_url-
-000bdbf0: 3e68 6f73 743b 0a20 2020 2020 2020 2020  >host;.         
-000bdc00: 2020 2075 726c 2e70 6174 6820 3d20 6261     url.path = ba
-000bdc10: 7365 5f75 726c 2d3e 7061 7468 3b0a 2020  se_url->path;.  
-000bdc20: 2020 2020 2020 2020 2020 7572 6c2e 7175            url.qu
-000bdc30: 6572 7920 3d20 6261 7365 5f75 726c 2d3e  ery = base_url->
-000bdc40: 7175 6572 793b 0a20 2020 2020 2020 2020  query;.         
-000bdc50: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-000bdc60: 2020 2020 2020 2f2f 2054 4f44 4f3a 2047        // TODO: G
-000bdc70: 6574 2072 6964 206f 6620 7365 745f 686f  et rid of set_ho
-000bdc80: 7374 6e61 6d65 2061 6e64 2072 6570 6c61  stname and repla
-000bdc90: 6365 2069 7420 7769 7468 0a20 2020 2020  ce it with.     
-000bdca0: 2020 2020 2020 202f 2f20 7570 6461 7465         // update
-000bdcb0: 5f62 6173 655f 686f 7374 6e61 6d65 0a20  _base_hostname. 
-000bdcc0: 2020 2020 2020 2020 2020 2075 726c 2e73             url.s
-000bdcd0: 6574 5f68 6f73 746e 616d 6528 6261 7365  et_hostname(base
-000bdce0: 5f75 726c 2d3e 6765 745f 686f 7374 6e61  _url->get_hostna
-000bdcf0: 6d65 2829 293b 0a20 2020 2020 2020 2020  me());.         
-000bdd00: 2020 2075 726c 2e75 7064 6174 655f 6261     url.update_ba
-000bdd10: 7365 5f70 6174 686e 616d 6528 6261 7365  se_pathname(base
-000bdd20: 5f75 726c 2d3e 6765 745f 7061 7468 6e61  _url->get_pathna
-000bdd30: 6d65 2829 293b 0a20 2020 2020 2020 2020  me());.         
-000bdd40: 2020 2075 726c 2e75 7064 6174 655f 6261     url.update_ba
-000bdd50: 7365 5f73 6561 7263 6828 6261 7365 5f75  se_search(base_u
-000bdd60: 726c 2d3e 6765 745f 7365 6172 6368 2829  rl->get_search()
-000bdd70: 293b 0a20 2020 2020 2020 2020 207d 0a20  );.          }. 
-000bdd80: 2020 2020 2020 2020 2075 726c 2e68 6173           url.has
-000bdd90: 5f6f 7061 7175 655f 7061 7468 203d 2062  _opaque_path = b
-000bdda0: 6173 655f 7572 6c2d 3e68 6173 5f6f 7061  ase_url->has_opa
-000bddb0: 7175 655f 7061 7468 3b0a 0a20 2020 2020  que_path;..     
-000bddc0: 2020 2020 202f 2f20 4966 2063 2069 7320       // If c is 
-000bddd0: 552b 3030 3346 2028 3f29 2c20 7468 656e  U+003F (?), then
-000bdde0: 2073 6574 2075 726c e280 9973 2071 7565   set url...s que
-000bddf0: 7279 2074 6f20 7468 6520 656d 7074 7920  ry to the empty 
-000bde00: 7374 7269 6e67 2061 6e64 0a20 2020 2020  string and.     
-000bde10: 2020 2020 202f 2f20 7374 6174 6520 746f       // state to
-000bde20: 2071 7565 7279 2073 7461 7465 2e0a 2020   query state..  
-000bde30: 2020 2020 2020 2020 6966 2028 696e 7075          if (inpu
-000bde40: 745f 706f 7369 7469 6f6e 2021 3d20 696e  t_position != in
-000bde50: 7075 745f 7369 7a65 2026 2620 7572 6c5f  put_size && url_
-000bde60: 6461 7461 5b69 6e70 7574 5f70 6f73 6974  data[input_posit
-000bde70: 696f 6e5d 203d 3d20 273f 2729 207b 0a20  ion] == '?') {. 
-000bde80: 2020 2020 2020 2020 2020 2073 7461 7465             state
-000bde90: 203d 2061 6461 3a3a 7374 6174 653a 3a51   = ada::state::Q
-000bdea0: 5545 5259 3b0a 2020 2020 2020 2020 2020  UERY;.          
-000bdeb0: 7d0a 2020 2020 2020 2020 2020 2f2f 204f  }.          // O
-000bdec0: 7468 6572 7769 7365 2c20 6966 2063 2069  therwise, if c i
-000bded0: 7320 6e6f 7420 7468 6520 454f 4620 636f  s not the EOF co
-000bdee0: 6465 2070 6f69 6e74 3a0a 2020 2020 2020  de point:.      
-000bdef0: 2020 2020 656c 7365 2069 6620 2869 6e70      else if (inp
-000bdf00: 7574 5f70 6f73 6974 696f 6e20 213d 2069  ut_position != i
-000bdf10: 6e70 7574 5f73 697a 6529 207b 0a20 2020  nput_size) {.   
-000bdf20: 2020 2020 2020 2020 202f 2f20 5365 7420           // Set 
-000bdf30: 7572 6ce2 8099 7320 7175 6572 7920 746f  url...s query to
-000bdf40: 206e 756c 6c2e 0a20 2020 2020 2020 2020   null..         
-000bdf50: 2020 2075 726c 2e63 6c65 6172 5f73 6561     url.clear_sea
-000bdf60: 7263 6828 293b 0a20 2020 2020 2020 2020  rch();.         
-000bdf70: 2020 202f 2f20 4966 2074 6865 2063 6f64     // If the cod
-000bdf80: 6520 706f 696e 7420 7375 6273 7472 696e  e point substrin
-000bdf90: 6720 6672 6f6d 2070 6f69 6e74 6572 2074  g from pointer t
-000bdfa0: 6f20 7468 6520 656e 6420 6f66 2069 6e70  o the end of inp
-000bdfb0: 7574 2064 6f65 730a 2020 2020 2020 2020  ut does.        
-000bdfc0: 2020 2020 2f2f 206e 6f74 2073 7461 7274      // not start
-000bdfd0: 2077 6974 6820 6120 5769 6e64 6f77 7320   with a Windows 
-000bdfe0: 6472 6976 6520 6c65 7474 6572 2c20 7468  drive letter, th
-000bdff0: 656e 2073 686f 7274 656e 2075 726c e280  en shorten url..
-000be000: 9973 2070 6174 682e 0a20 2020 2020 2020  .s path..       
-000be010: 2020 2020 2069 6620 2821 6368 6563 6b65       if (!checke
-000be020: 7273 3a3a 6973 5f77 696e 646f 7773 5f64  rs::is_windows_d
-000be030: 7269 7665 5f6c 6574 7465 7228 6669 6c65  rive_letter(file
-000be040: 5f76 6965 7729 2920 7b0a 2020 2020 2020  _view)) {.      
-000be050: 2020 2020 2020 2020 6966 2063 6f6e 7374          if const
-000be060: 6578 7072 2028 7265 7375 6c74 5f74 7970  expr (result_typ
-000be070: 655f 6973 5f61 6461 5f75 726c 2920 7b0a  e_is_ada_url) {.
-000be080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000be090: 6865 6c70 6572 733a 3a73 686f 7274 656e  helpers::shorten
-000be0a0: 5f70 6174 6828 7572 6c2e 7061 7468 2c20  _path(url.path, 
-000be0b0: 7572 6c2e 7479 7065 293b 0a20 2020 2020  url.type);.     
-000be0c0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-000be0d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000be0e0: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
-000be0f0: 6577 2070 6174 6820 3d20 7572 6c2e 6765  ew path = url.ge
-000be100: 745f 7061 7468 6e61 6d65 2829 3b0a 2020  t_pathname();.  
-000be110: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000be120: 2028 6865 6c70 6572 733a 3a73 686f 7274   (helpers::short
-000be130: 656e 5f70 6174 6828 7061 7468 2c20 7572  en_path(path, ur
-000be140: 6c2e 7479 7065 2929 207b 0a20 2020 2020  l.type)) {.     
-000be150: 2020 2020 2020 2020 2020 2020 2075 726c               url
-000be160: 2e75 7064 6174 655f 6261 7365 5f70 6174  .update_base_pat
-000be170: 686e 616d 6528 7374 643a 3a73 7472 696e  hname(std::strin
-000be180: 6728 7061 7468 2929 3b0a 2020 2020 2020  g(path));.      
-000be190: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000be1a0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000be1b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000be1c0: 2020 2020 2020 2f2f 204f 7468 6572 7769        // Otherwi
-000be1d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000be1e0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-000be1f0: 2020 2020 202f 2f20 5365 7420 7572 6ce2       // Set url.
-000be200: 8099 7320 7061 7468 2074 6f20 616e 2065  ..s path to an e
-000be210: 6d70 7479 206c 6973 742e 0a20 2020 2020  mpty list..     
-000be220: 2020 2020 2020 2020 2075 726c 2e63 6c65           url.cle
-000be230: 6172 5f70 6174 686e 616d 6528 293b 0a20  ar_pathname();. 
-000be240: 2020 2020 2020 2020 2020 2020 2075 726c               url
-000be250: 2e68 6173 5f6f 7061 7175 655f 7061 7468  .has_opaque_path
-000be260: 203d 2074 7275 653b 0a20 2020 2020 2020   = true;.       
-000be270: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000be280: 2020 2020 2f2f 2053 6574 2073 7461 7465      // Set state
-000be290: 2074 6f20 7061 7468 2073 7461 7465 2061   to path state a
-000be2a0: 6e64 2064 6563 7265 6173 6520 706f 696e  nd decrease poin
-000be2b0: 7465 7220 6279 2031 2e0a 2020 2020 2020  ter by 1..      
-000be2c0: 2020 2020 2020 7374 6174 6520 3d20 6164        state = ad
-000be2d0: 613a 3a73 7461 7465 3a3a 5041 5448 3b0a  a::state::PATH;.
-000be2e0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-000be2f0: 6b3b 0a20 2020 2020 2020 2020 207d 0a20  k;.          }. 
-000be300: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000be310: 202f 2f20 4f74 6865 7277 6973 652c 2073   // Otherwise, s
-000be320: 6574 2073 7461 7465 2074 6f20 7061 7468  et state to path
-000be330: 2073 7461 7465 2c20 616e 6420 6465 6372   state, and decr
-000be340: 6561 7365 2070 6f69 6e74 6572 2062 7920  ease pointer by 
-000be350: 312e 0a20 2020 2020 2020 2065 6c73 6520  1..        else 
-000be360: 7b0a 2020 2020 2020 2020 2020 6164 615f  {.          ada_
-000be370: 6c6f 6728 2246 494c 4520 676f 2074 6f20  log("FILE go to 
-000be380: 7061 7468 2229 3b0a 2020 2020 2020 2020  path");.        
-000be390: 2020 7374 6174 6520 3d20 6164 613a 3a73    state = ada::s
-000be3a0: 7461 7465 3a3a 5041 5448 3b0a 2020 2020  tate::PATH;.    
-000be3b0: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
-000be3c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000be3d0: 696e 7075 745f 706f 7369 7469 6f6e 2b2b  input_position++
-000be3e0: 3b0a 2020 2020 2020 2020 6272 6561 6b3b  ;.        break;
-000be3f0: 0a20 2020 2020 207d 0a20 2020 2020 2064  .      }.      d
-000be400: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-000be410: 6164 613a 3a75 6e72 6561 6368 6162 6c65  ada::unreachable
-000be420: 2829 3b0a 2020 2020 7d0a 2020 7d0a 2020  ();.    }.  }.  
-000be430: 6966 2028 6672 6167 6d65 6e74 2e68 6173  if (fragment.has
-000be440: 5f76 616c 7565 2829 2920 7b0a 2020 2020  _value()) {.    
-000be450: 7572 6c2e 7570 6461 7465 5f75 6e65 6e63  url.update_unenc
-000be460: 6f64 6564 5f62 6173 655f 6861 7368 282a  oded_base_hash(*
-000be470: 6672 6167 6d65 6e74 293b 0a20 207d 0a20  fragment);.  }. 
-000be480: 2072 6574 7572 6e20 7572 6c3b 0a7d 0a0a   return url;.}..
-000be490: 7465 6d70 6c61 7465 2075 726c 2070 6172  template url par
-000be4a0: 7365 5f75 726c 3c75 726c 3e28 7374 643a  se_url<url>(std:
-000be4b0: 3a73 7472 696e 675f 7669 6577 2075 7365  :string_view use
-000be4c0: 725f 696e 7075 742c 0a20 2020 2020 2020  r_input,.       
-000be4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000be4e0: 2020 2020 2063 6f6e 7374 2075 726c 2a20       const url* 
-000be4f0: 6261 7365 5f75 726c 203d 206e 756c 6c70  base_url = nullp
-000be500: 7472 293b 0a74 656d 706c 6174 6520 7572  tr);.template ur
-000be510: 6c5f 6167 6772 6567 6174 6f72 2070 6172  l_aggregator par
-000be520: 7365 5f75 726c 3c75 726c 5f61 6767 7265  se_url<url_aggre
-000be530: 6761 746f 723e 280a 2020 2020 7374 643a  gator>(.    std:
-000be540: 3a73 7472 696e 675f 7669 6577 2075 7365  :string_view use
-000be550: 725f 696e 7075 742c 2063 6f6e 7374 2075  r_input, const u
-000be560: 726c 5f61 6767 7265 6761 746f 722a 2062  rl_aggregator* b
-000be570: 6173 655f 7572 6c20 3d20 6e75 6c6c 7074  ase_url = nullpt
-000be580: 7229 3b0a 0a7d 2020 2f2f 206e 616d 6573  r);..}  // names
-000be590: 7061 6365 2061 6461 3a3a 7061 7273 6572  pace ada::parser
-000be5a0: 0a2f 2a20 656e 6420 6669 6c65 2073 7263  ./* end file src
-000be5b0: 2f70 6172 7365 722e 6370 7020 2a2f 0a2f  /parser.cpp */./
-000be5c0: 2a20 6265 6769 6e20 6669 6c65 2073 7263  * begin file src
-000be5d0: 2f75 726c 5f63 6f6d 706f 6e65 6e74 732e  /url_components.
-000be5e0: 6370 7020 2a2f 0a0a 2369 6e63 6c75 6465  cpp */..#include
-000be5f0: 203c 6e75 6d65 7269 633e 0a23 696e 636c   <numeric>.#incl
-000be600: 7564 6520 3c73 7472 696e 673e 0a0a 6e61  ude <string>..na
-000be610: 6d65 7370 6163 6520 6164 6120 7b0a 0a62  mespace ada {..b
-000be620: 6f6f 6c20 7572 6c5f 636f 6d70 6f6e 656e  ool url_componen
-000be630: 7473 3a3a 6368 6563 6b5f 6f66 6673 6574  ts::check_offset
-000be640: 5f63 6f6e 7369 7374 656e 6379 2829 2063  _consistency() c
-000be650: 6f6e 7374 206e 6f65 7863 6570 7420 7b0a  onst noexcept {.
-000be660: 2020 2f2a 2a0a 2020 202a 2068 7474 7073    /**.   * https
-000be670: 3a2f 2f75 7365 723a 7061 7373 4065 7861  ://user:pass@exa
-000be680: 6d70 6c65 2e63 6f6d 3a31 3233 342f 666f  mple.com:1234/fo
-000be690: 6f2f 6261 723f 6261 7a23 7175 7578 0a20  o/bar?baz#quux. 
-000be6a0: 2020 2a20 2020 2020 2020 7c20 2020 2020    *       |     
-000be6b0: 7c20 2020 207c 2020 2020 2020 2020 2020  |    |          
-000be6c0: 7c20 5e5e 5e5e 7c20 2020 2020 2020 7c20  | ^^^^|       | 
-000be6d0: 2020 7c0a 2020 202a 2020 2020 2020 207c    |.   *       |
-000be6e0: 2020 2020 207c 2020 2020 7c20 2020 2020       |    |     
-000be6f0: 2020 2020 207c 207c 2020 207c 2020 2020       | |   |    
-000be700: 2020 207c 2020 2060 2d2d 2d2d 2d20 6861     |   `----- ha
-000be710: 7368 5f73 7461 7274 0a20 2020 2a20 2020  sh_start.   *   
-000be720: 2020 2020 7c20 2020 2020 7c20 2020 207c      |     |    |
-000be730: 2020 2020 2020 2020 2020 7c20 7c20 2020            | |   
-000be740: 7c20 2020 2020 2020 602d 2d2d 2d2d 2d2d  |       `-------
-000be750: 2d2d 2073 6561 7263 685f 7374 6172 740a  -- search_start.
-000be760: 2020 202a 2020 2020 2020 207c 2020 2020     *       |    
-000be770: 207c 2020 2020 7c20 2020 2020 2020 2020   |    |         
-000be780: 207c 207c 2020 2060 2d2d 2d2d 2d2d 2d2d   | |   `--------
-000be790: 2d2d 2d2d 2d2d 2d2d 2d20 7061 7468 6e61  --------- pathna
-000be7a0: 6d65 5f73 7461 7274 0a20 2020 2a20 2020  me_start.   *   
-000be7b0: 2020 2020 7c20 2020 2020 7c20 2020 207c      |     |    |
-000be7c0: 2020 2020 2020 2020 2020 7c20 602d 2d2d            | `---
-000be7d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000be7e0: 2d2d 2070 6f72 740a 2020 202a 2020 2020  -- port.   *    
-000be7f0: 2020 207c 2020 2020 207c 2020 2020 7c20     |     |    | 
-000be800: 2020 2020 2020 2020 2060 2d2d 2d2d 2d2d           `------
-000be810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000be820: 2d20 686f 7374 5f65 6e64 0a20 2020 2a20  - host_end.   * 
-000be830: 2020 2020 2020 7c20 2020 2020 7c20 2020        |     |   
-000be840: 2060 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   `--------------
-000be850: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000be860: 2d2d 2d2d 2068 6f73 745f 7374 6172 740a  ---- host_start.
-000be870: 2020 202a 2020 2020 2020 207c 2020 2020     *       |    
-000be880: 2060 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   `--------------
-000be890: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000be8a0: 2d2d 2d2d 2d2d 2d2d 2d20 7573 6572 6e61  --------- userna
-000be8b0: 6d65 5f65 6e64 0a20 2020 2a20 2020 2020  me_end.   *     
-000be8c0: 2020 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    `-------------
-000be8d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000be8e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000be8f0: 2070 726f 746f 636f 6c5f 656e 640a 2020   protocol_end.  
-000be900: 202a 2f0a 2020 2f2f 2054 6865 7365 2063   */.  // These c
-000be910: 6f6e 6469 7469 6f6e 7320 6361 6e20 6265  onditions can be
-000be920: 206d 6164 6520 6d6f 7265 2073 7472 6963   made more stric
-000be930: 742e 0a20 2075 696e 7433 325f 7420 696e  t..  uint32_t in
-000be940: 6465 7820 3d20 303b 0a0a 2020 6966 2028  dex = 0;..  if (
-000be950: 7072 6f74 6f63 6f6c 5f65 6e64 203d 3d20  protocol_end == 
-000be960: 7572 6c5f 636f 6d70 6f6e 656e 7473 3a3a  url_components::
-000be970: 6f6d 6974 7465 6429 207b 0a20 2020 2072  omitted) {.    r
-000be980: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
-000be990: 0a20 2069 6620 2870 726f 746f 636f 6c5f  .  if (protocol_
-000be9a0: 656e 6420 3c20 696e 6465 7829 207b 0a20  end < index) {. 
-000be9b0: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-000be9c0: 0a20 207d 0a20 2069 6e64 6578 203d 2070  .  }.  index = p
-000be9d0: 726f 746f 636f 6c5f 656e 643b 0a0a 2020  rotocol_end;..  
-000be9e0: 6966 2028 7573 6572 6e61 6d65 5f65 6e64  if (username_end
-000be9f0: 203d 3d20 7572 6c5f 636f 6d70 6f6e 656e   == url_componen
-000bea00: 7473 3a3a 6f6d 6974 7465 6429 207b 0a20  ts::omitted) {. 
-000bea10: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-000bea20: 0a20 207d 0a20 2069 6620 2875 7365 726e  .  }.  if (usern
-000bea30: 616d 655f 656e 6420 3c20 696e 6465 7829  ame_end < index)
-000bea40: 207b 0a20 2020 2072 6574 7572 6e20 6661   {.    return fa
-000bea50: 6c73 653b 0a20 207d 0a20 2069 6e64 6578  lse;.  }.  index
-000bea60: 203d 2075 7365 726e 616d 655f 656e 643b   = username_end;
-000bea70: 0a0a 2020 6966 2028 686f 7374 5f73 7461  ..  if (host_sta
-000bea80: 7274 203d 3d20 7572 6c5f 636f 6d70 6f6e  rt == url_compon
-000bea90: 656e 7473 3a3a 6f6d 6974 7465 6429 207b  ents::omitted) {
-000beaa0: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
-000beab0: 653b 0a20 207d 0a20 2069 6620 2868 6f73  e;.  }.  if (hos
-000beac0: 745f 7374 6172 7420 3c20 696e 6465 7829  t_start < index)
-000bead0: 207b 0a20 2020 2072 6574 7572 6e20 6661   {.    return fa
-000beae0: 6c73 653b 0a20 207d 0a20 2069 6e64 6578  lse;.  }.  index
-000beaf0: 203d 2068 6f73 745f 7374 6172 743b 0a0a   = host_start;..
-000beb00: 2020 6966 2028 706f 7274 2021 3d20 7572    if (port != ur
-000beb10: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000beb20: 6974 7465 6429 207b 0a20 2020 2069 6620  itted) {.    if 
-000beb30: 2870 6f72 7420 3e20 3078 6666 6666 2920  (port > 0xffff) 
-000beb40: 7b0a 2020 2020 2020 7265 7475 726e 2066  {.      return f
-000beb50: 616c 7365 3b0a 2020 2020 7d0a 2020 2020  alse;.    }.    
-000beb60: 7569 6e74 3332 5f74 2070 6f72 745f 6c65  uint32_t port_le
-000beb70: 6e67 7468 203d 2068 656c 7065 7273 3a3a  ngth = helpers::
-000beb80: 6661 7374 5f64 6967 6974 5f63 6f75 6e74  fast_digit_count
-000beb90: 2870 6f72 7429 202b 2031 3b0a 2020 2020  (port) + 1;.    
-000beba0: 6966 2028 696e 6465 7820 2b20 706f 7274  if (index + port
-000bebb0: 5f6c 656e 6774 6820 3c20 696e 6465 7829  _length < index)
-000bebc0: 207b 0a20 2020 2020 2072 6574 7572 6e20   {.      return 
-000bebd0: 6661 6c73 653b 0a20 2020 207d 0a20 2020  false;.    }.   
-000bebe0: 2069 6e64 6578 202b 3d20 706f 7274 5f6c   index += port_l
-000bebf0: 656e 6774 683b 0a20 207d 0a0a 2020 6966  ength;.  }..  if
-000bec00: 2028 7061 7468 6e61 6d65 5f73 7461 7274   (pathname_start
-000bec10: 203d 3d20 7572 6c5f 636f 6d70 6f6e 656e   == url_componen
-000bec20: 7473 3a3a 6f6d 6974 7465 6429 207b 0a20  ts::omitted) {. 
-000bec30: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-000bec40: 0a20 207d 0a20 2069 6620 2870 6174 686e  .  }.  if (pathn
-000bec50: 616d 655f 7374 6172 7420 3c20 696e 6465  ame_start < inde
-000bec60: 7829 207b 0a20 2020 2072 6574 7572 6e20  x) {.    return 
-000bec70: 6661 6c73 653b 0a20 207d 0a20 2069 6e64  false;.  }.  ind
-000bec80: 6578 203d 2070 6174 686e 616d 655f 7374  ex = pathname_st
-000bec90: 6172 743b 0a0a 2020 6966 2028 7365 6172  art;..  if (sear
-000beca0: 6368 5f73 7461 7274 2021 3d20 7572 6c5f  ch_start != url_
-000becb0: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
-000becc0: 7465 6429 207b 0a20 2020 2069 6620 2873  ted) {.    if (s
-000becd0: 6561 7263 685f 7374 6172 7420 3c20 696e  earch_start < in
-000bece0: 6465 7829 207b 0a20 2020 2020 2072 6574  dex) {.      ret
-000becf0: 7572 6e20 6661 6c73 653b 0a20 2020 207d  urn false;.    }
-000bed00: 0a20 2020 2069 6e64 6578 203d 2073 6561  .    index = sea
-000bed10: 7263 685f 7374 6172 743b 0a20 207d 0a0a  rch_start;.  }..
-000bed20: 2020 6966 2028 6861 7368 5f73 7461 7274    if (hash_start
-000bed30: 2021 3d20 7572 6c5f 636f 6d70 6f6e 656e   != url_componen
-000bed40: 7473 3a3a 6f6d 6974 7465 6429 207b 0a20  ts::omitted) {. 
-000bed50: 2020 2069 6620 2868 6173 685f 7374 6172     if (hash_star
-000bed60: 7420 3c20 696e 6465 7829 207b 0a20 2020  t < index) {.   
-000bed70: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-000bed80: 0a20 2020 207d 0a20 2020 2069 6e64 6578  .    }.    index
-000bed90: 203d 2068 6173 685f 7374 6172 743b 0a20   = hash_start;. 
-000beda0: 207d 0a0a 2020 7265 7475 726e 2074 7275   }..  return tru
-000bedb0: 653b 0a7d 0a0a 7374 643a 3a73 7472 696e  e;.}..std::strin
-000bedc0: 6720 7572 6c5f 636f 6d70 6f6e 656e 7473  g url_components
-000bedd0: 3a3a 746f 5f73 7472 696e 6728 2920 636f  ::to_string() co
-000bede0: 6e73 7420 7b0a 2020 7374 643a 3a73 7472  nst {.  std::str
-000bedf0: 696e 6720 616e 7377 6572 3b0a 2020 6175  ing answer;.  au
-000bee00: 746f 2062 6163 6b20 3d20 7374 643a 3a62  to back = std::b
-000bee10: 6163 6b5f 696e 7365 7274 5f69 7465 7261  ack_insert_itera
-000bee20: 746f 7228 616e 7377 6572 293b 0a20 2061  tor(answer);.  a
-000bee30: 6e73 7765 722e 6170 7065 6e64 2822 7b5c  nswer.append("{\
-000bee40: 6e22 293b 0a0a 2020 616e 7377 6572 2e61  n");..  answer.a
-000bee50: 7070 656e 6428 225c 745c 2270 726f 746f  ppend("\t\"proto
-000bee60: 636f 6c5f 656e 645c 223a 5c22 2229 3b0a  col_end\":\"");.
-000bee70: 2020 6865 6c70 6572 733a 3a65 6e63 6f64    helpers::encod
-000bee80: 655f 6a73 6f6e 2873 7464 3a3a 746f 5f73  e_json(std::to_s
-000bee90: 7472 696e 6728 7072 6f74 6f63 6f6c 5f65  tring(protocol_e
-000beea0: 6e64 292c 2062 6163 6b29 3b0a 2020 616e  nd), back);.  an
-000beeb0: 7377 6572 2e61 7070 656e 6428 225c 222c  swer.append("\",
-000beec0: 5c6e 2229 3b0a 0a20 2061 6e73 7765 722e  \n");..  answer.
-000beed0: 6170 7065 6e64 2822 5c74 5c22 7573 6572  append("\t\"user
-000beee0: 6e61 6d65 5f65 6e64 5c22 3a5c 2222 293b  name_end\":\"");
-000beef0: 0a20 2068 656c 7065 7273 3a3a 656e 636f  .  helpers::enco
-000bef00: 6465 5f6a 736f 6e28 7374 643a 3a74 6f5f  de_json(std::to_
-000bef10: 7374 7269 6e67 2875 7365 726e 616d 655f  string(username_
-000bef20: 656e 6429 2c20 6261 636b 293b 0a20 2061  end), back);.  a
-000bef30: 6e73 7765 722e 6170 7065 6e64 2822 5c22  nswer.append("\"
-000bef40: 2c5c 6e22 293b 0a0a 2020 616e 7377 6572  ,\n");..  answer
-000bef50: 2e61 7070 656e 6428 225c 745c 2268 6f73  .append("\t\"hos
-000bef60: 745f 7374 6172 745c 223a 5c22 2229 3b0a  t_start\":\"");.
-000bef70: 2020 6865 6c70 6572 733a 3a65 6e63 6f64    helpers::encod
-000bef80: 655f 6a73 6f6e 2873 7464 3a3a 746f 5f73  e_json(std::to_s
-000bef90: 7472 696e 6728 686f 7374 5f73 7461 7274  tring(host_start
-000befa0: 292c 2062 6163 6b29 3b0a 2020 616e 7377  ), back);.  answ
-000befb0: 6572 2e61 7070 656e 6428 225c 222c 5c6e  er.append("\",\n
-000befc0: 2229 3b0a 0a20 2061 6e73 7765 722e 6170  ");..  answer.ap
-000befd0: 7065 6e64 2822 5c74 5c22 686f 7374 5f65  pend("\t\"host_e
-000befe0: 6e64 5c22 3a5c 2222 293b 0a20 2068 656c  nd\":\"");.  hel
-000beff0: 7065 7273 3a3a 656e 636f 6465 5f6a 736f  pers::encode_jso
-000bf000: 6e28 7374 643a 3a74 6f5f 7374 7269 6e67  n(std::to_string
-000bf010: 2868 6f73 745f 656e 6429 2c20 6261 636b  (host_end), back
-000bf020: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
-000bf030: 6e64 2822 5c22 2c5c 6e22 293b 0a0a 2020  nd("\",\n");..  
-000bf040: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
-000bf050: 745c 2270 6f72 745c 223a 5c22 2229 3b0a  t\"port\":\"");.
-000bf060: 2020 6865 6c70 6572 733a 3a65 6e63 6f64    helpers::encod
-000bf070: 655f 6a73 6f6e 2873 7464 3a3a 746f 5f73  e_json(std::to_s
-000bf080: 7472 696e 6728 706f 7274 292c 2062 6163  tring(port), bac
-000bf090: 6b29 3b0a 2020 616e 7377 6572 2e61 7070  k);.  answer.app
-000bf0a0: 656e 6428 225c 222c 5c6e 2229 3b0a 0a20  end("\",\n");.. 
-000bf0b0: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000bf0c0: 5c74 5c22 7061 7468 6e61 6d65 5f73 7461  \t\"pathname_sta
-000bf0d0: 7274 5c22 3a5c 2222 293b 0a20 2068 656c  rt\":\"");.  hel
-000bf0e0: 7065 7273 3a3a 656e 636f 6465 5f6a 736f  pers::encode_jso
-000bf0f0: 6e28 7374 643a 3a74 6f5f 7374 7269 6e67  n(std::to_string
-000bf100: 2870 6174 686e 616d 655f 7374 6172 7429  (pathname_start)
-000bf110: 2c20 6261 636b 293b 0a20 2061 6e73 7765  , back);.  answe
-000bf120: 722e 6170 7065 6e64 2822 5c22 2c5c 6e22  r.append("\",\n"
-000bf130: 293b 0a0a 2020 616e 7377 6572 2e61 7070  );..  answer.app
-000bf140: 656e 6428 225c 745c 2273 6561 7263 685f  end("\t\"search_
-000bf150: 7374 6172 745c 223a 5c22 2229 3b0a 2020  start\":\"");.  
-000bf160: 6865 6c70 6572 733a 3a65 6e63 6f64 655f  helpers::encode_
-000bf170: 6a73 6f6e 2873 7464 3a3a 746f 5f73 7472  json(std::to_str
-000bf180: 696e 6728 7365 6172 6368 5f73 7461 7274  ing(search_start
-000bf190: 292c 2062 6163 6b29 3b0a 2020 616e 7377  ), back);.  answ
-000bf1a0: 6572 2e61 7070 656e 6428 225c 222c 5c6e  er.append("\",\n
-000bf1b0: 2229 3b0a 0a20 2061 6e73 7765 722e 6170  ");..  answer.ap
-000bf1c0: 7065 6e64 2822 5c74 5c22 6861 7368 5f73  pend("\t\"hash_s
-000bf1d0: 7461 7274 5c22 3a5c 2222 293b 0a20 2068  tart\":\"");.  h
-000bf1e0: 656c 7065 7273 3a3a 656e 636f 6465 5f6a  elpers::encode_j
-000bf1f0: 736f 6e28 7374 643a 3a74 6f5f 7374 7269  son(std::to_stri
-000bf200: 6e67 2868 6173 685f 7374 6172 7429 2c20  ng(hash_start), 
-000bf210: 6261 636b 293b 0a20 2061 6e73 7765 722e  back);.  answer.
-000bf220: 6170 7065 6e64 2822 5c22 2c5c 6e22 293b  append("\",\n");
-000bf230: 0a0a 2020 616e 7377 6572 2e61 7070 656e  ..  answer.appen
-000bf240: 6428 225c 6e7d 2229 3b0a 2020 7265 7475  d("\n}");.  retu
-000bf250: 726e 2061 6e73 7765 723b 0a7d 0a0a 7d20  rn answer;.}..} 
-000bf260: 202f 2f20 6e61 6d65 7370 6163 6520 6164   // namespace ad
-000bf270: 610a 2f2a 2065 6e64 2066 696c 6520 7372  a./* end file sr
-000bf280: 632f 7572 6c5f 636f 6d70 6f6e 656e 7473  c/url_components
-000bf290: 2e63 7070 202a 2f0a 2f2a 2062 6567 696e  .cpp */./* begin
-000bf2a0: 2066 696c 6520 7372 632f 7572 6c5f 6167   file src/url_ag
-000bf2b0: 6772 6567 6174 6f72 2e63 7070 202a 2f0a  gregator.cpp */.
-000bf2c0: 0a23 696e 636c 7564 6520 3c73 7472 696e  .#include <strin
-000bf2d0: 673e 0a23 696e 636c 7564 6520 3c73 7472  g>.#include <str
-000bf2e0: 696e 675f 7669 6577 3e0a 0a6e 616d 6573  ing_view>..names
-000bf2f0: 7061 6365 2061 6461 207b 0a74 656d 706c  pace ada {.templ
-000bf300: 6174 6520 3c62 6f6f 6c20 6861 735f 7374  ate <bool has_st
-000bf310: 6174 655f 6f76 6572 7269 6465 3e0a 5b5b  ate_override>.[[
-000bf320: 6e6f 6469 7363 6172 645d 5d20 6164 615f  nodiscard]] ada_
-000bf330: 7265 616c 6c79 5f69 6e6c 696e 6520 626f  really_inline bo
-000bf340: 6f6c 2075 726c 5f61 6767 7265 6761 746f  ol url_aggregato
-000bf350: 723a 3a70 6172 7365 5f73 6368 656d 655f  r::parse_scheme_
-000bf360: 7769 7468 5f63 6f6c 6f6e 280a 2020 2020  with_colon(.    
-000bf370: 636f 6e73 7420 7374 643a 3a73 7472 696e  const std::strin
-000bf380: 675f 7669 6577 2069 6e70 7574 5f77 6974  g_view input_wit
-000bf390: 685f 636f 6c6f 6e29 207b 0a20 2061 6461  h_colon) {.  ada
-000bf3a0: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
-000bf3b0: 6174 6f72 3a3a 7061 7273 655f 7363 6865  ator::parse_sche
-000bf3c0: 6d65 5f77 6974 685f 636f 6c6f 6e20 222c  me_with_colon ",
-000bf3d0: 2069 6e70 7574 5f77 6974 685f 636f 6c6f   input_with_colo
-000bf3e0: 6e29 3b0a 2020 4144 415f 4153 5345 5254  n);.  ADA_ASSERT
-000bf3f0: 5f54 5255 4528 7661 6c69 6461 7465 2829  _TRUE(validate()
-000bf400: 293b 0a20 2041 4441 5f41 5353 4552 545f  );.  ADA_ASSERT_
-000bf410: 5452 5545 2821 6865 6c70 6572 733a 3a6f  TRUE(!helpers::o
-000bf420: 7665 726c 6170 7328 696e 7075 745f 7769  verlaps(input_wi
-000bf430: 7468 5f63 6f6c 6f6e 2c20 6275 6666 6572  th_colon, buffer
-000bf440: 2929 3b0a 2020 7374 643a 3a73 7472 696e  ));.  std::strin
-000bf450: 675f 7669 6577 2069 6e70 7574 7b69 6e70  g_view input{inp
-000bf460: 7574 5f77 6974 685f 636f 6c6f 6e7d 3b0a  ut_with_colon};.
-000bf470: 2020 696e 7075 742e 7265 6d6f 7665 5f73    input.remove_s
-000bf480: 7566 6669 7828 3129 3b0a 2020 6175 746f  uffix(1);.  auto
-000bf490: 2070 6172 7365 645f 7479 7065 203d 2061   parsed_type = a
-000bf4a0: 6461 3a3a 7363 6865 6d65 3a3a 6765 745f  da::scheme::get_
-000bf4b0: 7363 6865 6d65 5f74 7970 6528 696e 7075  scheme_type(inpu
-000bf4c0: 7429 3b0a 2020 626f 6f6c 2069 735f 696e  t);.  bool is_in
-000bf4d0: 7075 745f 7370 6563 6961 6c20 3d20 2870  put_special = (p
-000bf4e0: 6172 7365 645f 7479 7065 2021 3d20 6164  arsed_type != ad
-000bf4f0: 613a 3a73 6368 656d 653a 3a4e 4f54 5f53  a::scheme::NOT_S
-000bf500: 5045 4349 414c 293b 0a20 202f 2a2a 0a20  PECIAL);.  /**. 
-000bf510: 2020 2a20 496e 2074 6865 2063 6f6d 6d6f    * In the commo
-000bf520: 6e20 6361 7365 2c20 7765 2077 696c 6c20  n case, we will 
-000bf530: 696d 6d65 6469 6174 656c 7920 7265 636f  immediately reco
-000bf540: 676e 697a 6520 6120 7370 6563 6961 6c20  gnize a special 
-000bf550: 7363 6865 6d65 2028 652e 672e 2c0a 2020  scheme (e.g.,.  
-000bf560: 202a 6874 7470 2c20 6874 7470 7329 2c20   *http, https), 
-000bf570: 696e 2077 6869 6368 2063 6173 652c 2077  in which case, w
-000bf580: 6520 6361 6e20 676f 2072 6561 6c6c 7920  e can go really 
-000bf590: 6661 7374 2e0a 2020 202a 2a2f 0a20 2069  fast..   **/.  i
-000bf5a0: 6620 2869 735f 696e 7075 745f 7370 6563  f (is_input_spec
-000bf5b0: 6961 6c29 207b 2020 2f2f 2066 6173 7420  ial) {  // fast 
-000bf5c0: 7061 7468 2121 210a 2020 2020 6966 2028  path!!!.    if (
-000bf5d0: 6861 735f 7374 6174 655f 6f76 6572 7269  has_state_overri
-000bf5e0: 6465 2920 7b0a 2020 2020 2020 2f2f 2049  de) {.      // I
-000bf5f0: 6620 7572 6ce2 8099 7320 7363 6865 6d65  f url...s scheme
-000bf600: 2069 7320 6e6f 7420 6120 7370 6563 6961   is not a specia
-000bf610: 6c20 7363 6865 6d65 2061 6e64 2062 7566  l scheme and buf
-000bf620: 6665 7220 6973 2061 2073 7065 6369 616c  fer is a special
-000bf630: 2073 6368 656d 652c 0a20 2020 2020 202f   scheme,.      /
-000bf640: 2f20 7468 656e 2072 6574 7572 6e2e 0a20  / then return.. 
-000bf650: 2020 2020 2069 6620 2869 735f 7370 6563       if (is_spec
-000bf660: 6961 6c28 2920 213d 2069 735f 696e 7075  ial() != is_inpu
-000bf670: 745f 7370 6563 6961 6c29 207b 0a20 2020  t_special) {.   
-000bf680: 2020 2020 2072 6574 7572 6e20 7472 7565       return true
-000bf690: 3b0a 2020 2020 2020 7d0a 0a20 2020 2020  ;.      }..     
-000bf6a0: 202f 2f20 4966 2075 726c 2069 6e63 6c75   // If url inclu
-000bf6b0: 6465 7320 6372 6564 656e 7469 616c 7320  des credentials 
-000bf6c0: 6f72 2068 6173 2061 206e 6f6e 2d6e 756c  or has a non-nul
-000bf6d0: 6c20 706f 7274 2c20 616e 6420 6275 6666  l port, and buff
-000bf6e0: 6572 2069 730a 2020 2020 2020 2f2f 2022  er is.      // "
-000bf6f0: 6669 6c65 222c 2074 6865 6e20 7265 7475  file", then retu
-000bf700: 726e 2e0a 2020 2020 2020 6966 2028 2868  rn..      if ((h
-000bf710: 6173 5f63 7265 6465 6e74 6961 6c73 2829  as_credentials()
-000bf720: 207c 7c20 636f 6d70 6f6e 656e 7473 2e70   || components.p
-000bf730: 6f72 7420 213d 2075 726c 5f63 6f6d 706f  ort != url_compo
-000bf740: 6e65 6e74 733a 3a6f 6d69 7474 6564 2920  nents::omitted) 
-000bf750: 2626 0a20 2020 2020 2020 2020 2070 6172  &&.          par
-000bf760: 7365 645f 7479 7065 203d 3d20 6164 613a  sed_type == ada:
-000bf770: 3a73 6368 656d 653a 3a74 7970 653a 3a46  :scheme::type::F
-000bf780: 494c 4529 207b 0a20 2020 2020 2020 2072  ILE) {.        r
-000bf790: 6574 7572 6e20 7472 7565 3b0a 2020 2020  eturn true;.    
-000bf7a0: 2020 7d0a 0a20 2020 2020 202f 2f20 4966    }..      // If
-000bf7b0: 2075 726c e280 9973 2073 6368 656d 6520   url...s scheme 
-000bf7c0: 6973 2022 6669 6c65 2220 616e 6420 6974  is "file" and it
-000bf7d0: 7320 686f 7374 2069 7320 616e 2065 6d70  s host is an emp
-000bf7e0: 7479 2068 6f73 742c 2074 6865 6e20 7265  ty host, then re
-000bf7f0: 7475 726e 2e0a 2020 2020 2020 2f2f 2041  turn..      // A
-000bf800: 6e20 656d 7074 7920 686f 7374 2069 7320  n empty host is 
-000bf810: 7468 6520 656d 7074 7920 7374 7269 6e67  the empty string
-000bf820: 2e0a 2020 2020 2020 6966 2028 7479 7065  ..      if (type
-000bf830: 203d 3d20 6164 613a 3a73 6368 656d 653a   == ada::scheme:
-000bf840: 3a74 7970 653a 3a46 494c 4520 2626 0a20  :type::FILE &&. 
-000bf850: 2020 2020 2020 2020 2063 6f6d 706f 6e65           compone
-000bf860: 6e74 732e 686f 7374 5f73 7461 7274 203d  nts.host_start =
-000bf870: 3d20 636f 6d70 6f6e 656e 7473 2e68 6f73  = components.hos
-000bf880: 745f 656e 6429 207b 0a20 2020 2020 2020  t_end) {.       
-000bf890: 2072 6574 7572 6e20 7472 7565 3b0a 2020   return true;.  
-000bf8a0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-000bf8b0: 2074 7970 6520 3d20 7061 7273 6564 5f74   type = parsed_t
-000bf8c0: 7970 653b 0a20 2020 2073 6574 5f73 6368  ype;.    set_sch
-000bf8d0: 656d 655f 6672 6f6d 5f76 6965 775f 7769  eme_from_view_wi
-000bf8e0: 7468 5f63 6f6c 6f6e 2869 6e70 7574 5f77  th_colon(input_w
-000bf8f0: 6974 685f 636f 6c6f 6e29 3b0a 0a20 2020  ith_colon);..   
-000bf900: 2069 6620 2868 6173 5f73 7461 7465 5f6f   if (has_state_o
-000bf910: 7665 7272 6964 6529 207b 0a20 2020 2020  verride) {.     
-000bf920: 202f 2f20 5468 6973 2069 7320 756e 636f   // This is unco
-000bf930: 6d6d 6f6e 2e0a 2020 2020 2020 7569 6e74  mmon..      uint
-000bf940: 3136 5f74 2075 726c 735f 7363 6865 6d65  16_t urls_scheme
-000bf950: 5f70 6f72 7420 3d20 6765 745f 7370 6563  _port = get_spec
-000bf960: 6961 6c5f 706f 7274 2829 3b0a 0a20 2020  ial_port();..   
-000bf970: 2020 202f 2f20 4966 2075 726c e280 9973     // If url...s
-000bf980: 2070 6f72 7420 6973 2075 726c e280 9973   port is url...s
-000bf990: 2073 6368 656d 65e2 8099 7320 6465 6661   scheme...s defa
-000bf9a0: 756c 7420 706f 7274 2c20 7468 656e 2073  ult port, then s
-000bf9b0: 6574 2075 726c e280 9973 2070 6f72 7420  et url...s port 
-000bf9c0: 746f 0a20 2020 2020 202f 2f20 6e75 6c6c  to.      // null
-000bf9d0: 2e0a 2020 2020 2020 6966 2028 636f 6d70  ..      if (comp
-000bf9e0: 6f6e 656e 7473 2e70 6f72 7420 3d3d 2075  onents.port == u
-000bf9f0: 726c 735f 7363 6865 6d65 5f70 6f72 7429  rls_scheme_port)
-000bfa00: 207b 0a20 2020 2020 2020 2063 6c65 6172   {.        clear
-000bfa10: 5f70 6f72 7428 293b 0a20 2020 2020 207d  _port();.      }
-000bfa20: 0a20 2020 207d 0a20 207d 2065 6c73 6520  .    }.  } else 
-000bfa30: 7b20 202f 2f20 736c 6f77 2070 6174 680a  {  // slow path.
-000bfa40: 2020 2020 7374 643a 3a73 7472 696e 6720      std::string 
-000bfa50: 5f62 7566 6665 7220 3d20 7374 643a 3a73  _buffer = std::s
-000bfa60: 7472 696e 6728 696e 7075 7429 3b0a 2020  tring(input);.  
-000bfa70: 2020 2f2f 204e 6578 7420 6675 6e63 7469    // Next functi
-000bfa80: 6f6e 2069 7320 6f6e 6c79 2076 616c 6964  on is only valid
-000bfa90: 2069 6620 7468 6520 696e 7075 7420 6973   if the input is
-000bfaa0: 2041 5343 4949 2061 6e64 2072 6574 7572   ASCII and retur
-000bfab0: 6e73 2066 616c 7365 0a20 2020 202f 2f20  ns false.    // 
-000bfac0: 6f74 6865 7277 6973 652c 2062 7574 2069  otherwise, but i
-000bfad0: 7420 7365 656d 7320 7468 6174 2077 6520  t seems that we 
-000bfae0: 616c 7761 7973 2068 6176 6520 6173 6369  always have asci
-000bfaf0: 6920 636f 6e74 656e 7420 736f 2077 6520  i content so we 
-000bfb00: 646f 206e 6f74 0a20 2020 202f 2f20 6e65  do not.    // ne
-000bfb10: 6564 2074 6f20 6368 6563 6b20 7468 6520  ed to check the 
-000bfb20: 7265 7475 726e 2076 616c 7565 2e0a 2020  return value..  
-000bfb30: 2020 756e 6963 6f64 653a 3a74 6f5f 6c6f    unicode::to_lo
-000bfb40: 7765 725f 6173 6369 6928 5f62 7566 6665  wer_ascii(_buffe
-000bfb50: 722e 6461 7461 2829 2c20 5f62 7566 6665  r.data(), _buffe
-000bfb60: 722e 7369 7a65 2829 293b 0a0a 2020 2020  r.size());..    
-000bfb70: 6966 2028 6861 735f 7374 6174 655f 6f76  if (has_state_ov
-000bfb80: 6572 7269 6465 2920 7b0a 2020 2020 2020  erride) {.      
-000bfb90: 2f2f 2049 6620 7572 6ce2 8099 7320 7363  // If url...s sc
-000bfba0: 6865 6d65 2069 7320 6120 7370 6563 6961  heme is a specia
-000bfbb0: 6c20 7363 6865 6d65 2061 6e64 2062 7566  l scheme and buf
-000bfbc0: 6665 7220 6973 206e 6f74 2061 2073 7065  fer is not a spe
-000bfbd0: 6369 616c 2073 6368 656d 652c 0a20 2020  cial scheme,.   
-000bfbe0: 2020 202f 2f20 7468 656e 2072 6574 7572     // then retur
-000bfbf0: 6e2e 2049 6620 7572 6ce2 8099 7320 7363  n. If url...s sc
-000bfc00: 6865 6d65 2069 7320 6e6f 7420 6120 7370  heme is not a sp
-000bfc10: 6563 6961 6c20 7363 6865 6d65 2061 6e64  ecial scheme and
-000bfc20: 2062 7566 6665 7220 6973 2061 0a20 2020   buffer is a.   
-000bfc30: 2020 202f 2f20 7370 6563 6961 6c20 7363     // special sc
-000bfc40: 6865 6d65 2c20 7468 656e 2072 6574 7572  heme, then retur
-000bfc50: 6e2e 0a20 2020 2020 2069 6620 2869 735f  n..      if (is_
-000bfc60: 7370 6563 6961 6c28 2920 213d 2061 6461  special() != ada
-000bfc70: 3a3a 7363 6865 6d65 3a3a 6973 5f73 7065  ::scheme::is_spe
-000bfc80: 6369 616c 285f 6275 6666 6572 2929 207b  cial(_buffer)) {
-000bfc90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000bfca0: 7472 7565 3b0a 2020 2020 2020 7d0a 0a20  true;.      }.. 
-000bfcb0: 2020 2020 202f 2f20 4966 2075 726c 2069       // If url i
-000bfcc0: 6e63 6c75 6465 7320 6372 6564 656e 7469  ncludes credenti
-000bfcd0: 616c 7320 6f72 2068 6173 2061 206e 6f6e  als or has a non
-000bfce0: 2d6e 756c 6c20 706f 7274 2c20 616e 6420  -null port, and 
-000bfcf0: 6275 6666 6572 2069 730a 2020 2020 2020  buffer is.      
-000bfd00: 2f2f 2022 6669 6c65 222c 2074 6865 6e20  // "file", then 
-000bfd10: 7265 7475 726e 2e0a 2020 2020 2020 6966  return..      if
-000bfd20: 2028 2868 6173 5f63 7265 6465 6e74 6961   ((has_credentia
-000bfd30: 6c73 2829 207c 7c20 636f 6d70 6f6e 656e  ls() || componen
-000bfd40: 7473 2e70 6f72 7420 213d 2075 726c 5f63  ts.port != url_c
-000bfd50: 6f6d 706f 6e65 6e74 733a 3a6f 6d69 7474  omponents::omitt
-000bfd60: 6564 2920 2626 0a20 2020 2020 2020 2020  ed) &&.         
-000bfd70: 205f 6275 6666 6572 203d 3d20 2266 696c   _buffer == "fil
-000bfd80: 6522 2920 7b0a 2020 2020 2020 2020 7265  e") {.        re
-000bfd90: 7475 726e 2074 7275 653b 0a20 2020 2020  turn true;.     
-000bfda0: 207d 0a0a 2020 2020 2020 2f2f 2049 6620   }..      // If 
-000bfdb0: 7572 6ce2 8099 7320 7363 6865 6d65 2069  url...s scheme i
-000bfdc0: 7320 2266 696c 6522 2061 6e64 2069 7473  s "file" and its
-000bfdd0: 2068 6f73 7420 6973 2061 6e20 656d 7074   host is an empt
-000bfde0: 7920 686f 7374 2c20 7468 656e 2072 6574  y host, then ret
-000bfdf0: 7572 6e2e 0a20 2020 2020 202f 2f20 416e  urn..      // An
-000bfe00: 2065 6d70 7479 2068 6f73 7420 6973 2074   empty host is t
-000bfe10: 6865 2065 6d70 7479 2073 7472 696e 672e  he empty string.
-000bfe20: 0a20 2020 2020 2069 6620 2874 7970 6520  .      if (type 
-000bfe30: 3d3d 2061 6461 3a3a 7363 6865 6d65 3a3a  == ada::scheme::
-000bfe40: 7479 7065 3a3a 4649 4c45 2026 260a 2020  type::FILE &&.  
-000bfe50: 2020 2020 2020 2020 636f 6d70 6f6e 656e          componen
-000bfe60: 7473 2e68 6f73 745f 7374 6172 7420 3d3d  ts.host_start ==
-000bfe70: 2063 6f6d 706f 6e65 6e74 732e 686f 7374   components.host
-000bfe80: 5f65 6e64 2920 7b0a 2020 2020 2020 2020  _end) {.        
-000bfe90: 7265 7475 726e 2074 7275 653b 0a20 2020  return true;.   
-000bfea0: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
-000bfeb0: 7365 745f 7363 6865 6d65 285f 6275 6666  set_scheme(_buff
-000bfec0: 6572 293b 0a0a 2020 2020 6966 2028 6861  er);..    if (ha
-000bfed0: 735f 7374 6174 655f 6f76 6572 7269 6465  s_state_override
-000bfee0: 2920 7b0a 2020 2020 2020 2f2f 2054 6869  ) {.      // Thi
-000bfef0: 7320 6973 2075 6e63 6f6d 6d6f 6e2e 0a20  s is uncommon.. 
-000bff00: 2020 2020 2075 696e 7431 365f 7420 7572       uint16_t ur
-000bff10: 6c73 5f73 6368 656d 655f 706f 7274 203d  ls_scheme_port =
-000bff20: 2067 6574 5f73 7065 6369 616c 5f70 6f72   get_special_por
-000bff30: 7428 293b 0a0a 2020 2020 2020 2f2f 2049  t();..      // I
-000bff40: 6620 7572 6ce2 8099 7320 706f 7274 2069  f url...s port i
-000bff50: 7320 7572 6ce2 8099 7320 7363 6865 6d65  s url...s scheme
-000bff60: e280 9973 2064 6566 6175 6c74 2070 6f72  ...s default por
-000bff70: 742c 2074 6865 6e20 7365 7420 7572 6ce2  t, then set url.
-000bff80: 8099 7320 706f 7274 2074 6f0a 2020 2020  ..s port to.    
-000bff90: 2020 2f2f 206e 756c 6c2e 0a20 2020 2020    // null..     
-000bffa0: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000bffb0: 706f 7274 203d 3d20 7572 6c73 5f73 6368  port == urls_sch
-000bffc0: 656d 655f 706f 7274 2920 7b0a 2020 2020  eme_port) {.    
-000bffd0: 2020 2020 636c 6561 725f 706f 7274 2829      clear_port()
-000bffe0: 3b0a 2020 2020 2020 7d0a 2020 2020 7d0a  ;.      }.    }.
-000bfff0: 2020 7d0a 2020 4144 415f 4153 5345 5254    }.  ADA_ASSERT
-000c0000: 5f54 5255 4528 7661 6c69 6461 7465 2829  _TRUE(validate()
-000c0010: 293b 0a20 2072 6574 7572 6e20 7472 7565  );.  return true
-000c0020: 3b0a 7d0a 0a69 6e6c 696e 6520 766f 6964  ;.}..inline void
-000c0030: 2075 726c 5f61 6767 7265 6761 746f 723a   url_aggregator:
-000c0040: 3a63 6f70 795f 7363 6865 6d65 2863 6f6e  :copy_scheme(con
-000c0050: 7374 2075 726c 5f61 6767 7265 6761 746f  st url_aggregato
-000c0060: 7226 2075 2920 6e6f 6578 6365 7074 207b  r& u) noexcept {
-000c0070: 0a20 2061 6461 5f6c 6f67 2822 7572 6c5f  .  ada_log("url_
-000c0080: 6167 6772 6567 6174 6f72 3a3a 636f 7079  aggregator::copy
-000c0090: 5f73 6368 656d 6520 222c 2075 2e62 7566  _scheme ", u.buf
-000c00a0: 6665 7229 3b0a 2020 4144 415f 4153 5345  fer);.  ADA_ASSE
-000c00b0: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
-000c00c0: 2829 293b 0a20 202f 2f20 6e65 7874 206c  ());.  // next l
-000c00d0: 696e 6520 636f 756c 6420 6f76 6572 666c  ine could overfl
-000c00e0: 6f77 2062 7574 2075 6e73 6967 6e65 6420  ow but unsigned 
-000c00f0: 6172 6974 686d 6574 6963 2068 6173 2077  arithmetic has w
-000c0100: 656c 6c2d 6465 6669 6e65 640a 2020 2f2f  ell-defined.  //
-000c0110: 206f 7665 7266 6c6f 7773 2e0a 2020 7569   overflows..  ui
-000c0120: 6e74 3332 5f74 206e 6577 5f64 6966 6665  nt32_t new_diffe
-000c0130: 7265 6e63 6520 3d20 752e 636f 6d70 6f6e  rence = u.compon
-000c0140: 656e 7473 2e70 726f 746f 636f 6c5f 656e  ents.protocol_en
-000c0150: 6420 2d20 636f 6d70 6f6e 656e 7473 2e70  d - components.p
-000c0160: 726f 746f 636f 6c5f 656e 643b 0a20 2074  rotocol_end;.  t
-000c0170: 7970 6520 3d20 752e 7479 7065 3b0a 2020  ype = u.type;.  
-000c0180: 6275 6666 6572 2e65 7261 7365 2830 2c20  buffer.erase(0, 
-000c0190: 636f 6d70 6f6e 656e 7473 2e70 726f 746f  components.proto
-000c01a0: 636f 6c5f 656e 6429 3b0a 2020 6275 6666  col_end);.  buff
-000c01b0: 6572 2e69 6e73 6572 7428 302c 2075 2e67  er.insert(0, u.g
-000c01c0: 6574 5f70 726f 746f 636f 6c28 2929 3b0a  et_protocol());.
-000c01d0: 2020 636f 6d70 6f6e 656e 7473 2e70 726f    components.pro
-000c01e0: 746f 636f 6c5f 656e 6420 3d20 752e 636f  tocol_end = u.co
-000c01f0: 6d70 6f6e 656e 7473 2e70 726f 746f 636f  mponents.protoco
-000c0200: 6c5f 656e 643b 0a0a 2020 2f2f 204e 6f20  l_end;..  // No 
-000c0210: 6e65 6564 2074 6f20 7570 6461 7465 2074  need to update t
-000c0220: 6865 2063 6f6d 706f 6e65 6e74 730a 2020  he components.  
-000c0230: 6966 2028 6e65 775f 6469 6666 6572 656e  if (new_differen
-000c0240: 6365 203d 3d20 3029 207b 0a20 2020 2072  ce == 0) {.    r
-000c0250: 6574 7572 6e3b 0a20 207d 0a0a 2020 2f2f  eturn;.  }..  //
-000c0260: 2055 7064 6174 6520 7468 6520 7265 7374   Update the rest
-000c0270: 206f 6620 7468 6520 636f 6d70 6f6e 656e   of the componen
-000c0280: 7473 2e0a 2020 636f 6d70 6f6e 656e 7473  ts..  components
-000c0290: 2e75 7365 726e 616d 655f 656e 6420 2b3d  .username_end +=
-000c02a0: 206e 6577 5f64 6966 6665 7265 6e63 653b   new_difference;
-000c02b0: 0a20 2063 6f6d 706f 6e65 6e74 732e 686f  .  components.ho
-000c02c0: 7374 5f73 7461 7274 202b 3d20 6e65 775f  st_start += new_
-000c02d0: 6469 6666 6572 656e 6365 3b0a 2020 636f  difference;.  co
-000c02e0: 6d70 6f6e 656e 7473 2e68 6f73 745f 656e  mponents.host_en
-000c02f0: 6420 2b3d 206e 6577 5f64 6966 6665 7265  d += new_differe
-000c0300: 6e63 653b 0a20 2063 6f6d 706f 6e65 6e74  nce;.  component
-000c0310: 732e 7061 7468 6e61 6d65 5f73 7461 7274  s.pathname_start
-000c0320: 202b 3d20 6e65 775f 6469 6666 6572 656e   += new_differen
-000c0330: 6365 3b0a 2020 6966 2028 636f 6d70 6f6e  ce;.  if (compon
-000c0340: 656e 7473 2e73 6561 7263 685f 7374 6172  ents.search_star
-000c0350: 7420 213d 2075 726c 5f63 6f6d 706f 6e65  t != url_compone
-000c0360: 6e74 733a 3a6f 6d69 7474 6564 2920 7b0a  nts::omitted) {.
-000c0370: 2020 2020 636f 6d70 6f6e 656e 7473 2e73      components.s
-000c0380: 6561 7263 685f 7374 6172 7420 2b3d 206e  earch_start += n
-000c0390: 6577 5f64 6966 6665 7265 6e63 653b 0a20  ew_difference;. 
-000c03a0: 207d 0a20 2069 6620 2863 6f6d 706f 6e65   }.  if (compone
-000c03b0: 6e74 732e 6861 7368 5f73 7461 7274 2021  nts.hash_start !
-000c03c0: 3d20 7572 6c5f 636f 6d70 6f6e 656e 7473  = url_components
-000c03d0: 3a3a 6f6d 6974 7465 6429 207b 0a20 2020  ::omitted) {.   
-000c03e0: 2063 6f6d 706f 6e65 6e74 732e 6861 7368   components.hash
-000c03f0: 5f73 7461 7274 202b 3d20 6e65 775f 6469  _start += new_di
-000c0400: 6666 6572 656e 6365 3b0a 2020 7d0a 2020  fference;.  }.  
-000c0410: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
-000c0420: 7661 6c69 6461 7465 2829 293b 0a7d 0a0a  validate());.}..
-000c0430: 696e 6c69 6e65 2076 6f69 6420 7572 6c5f  inline void url_
-000c0440: 6167 6772 6567 6174 6f72 3a3a 7365 745f  aggregator::set_
-000c0450: 7363 6865 6d65 5f66 726f 6d5f 7669 6577  scheme_from_view
-000c0460: 5f77 6974 685f 636f 6c6f 6e28 0a20 2020  _with_colon(.   
-000c0470: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000c0480: 7720 6e65 775f 7363 6865 6d65 5f77 6974  w new_scheme_wit
-000c0490: 685f 636f 6c6f 6e29 206e 6f65 7863 6570  h_colon) noexcep
-000c04a0: 7420 7b0a 2020 6164 615f 6c6f 6728 2275  t {.  ada_log("u
-000c04b0: 726c 5f61 6767 7265 6761 746f 723a 3a73  rl_aggregator::s
-000c04c0: 6574 5f73 6368 656d 655f 6672 6f6d 5f76  et_scheme_from_v
-000c04d0: 6965 775f 7769 7468 5f63 6f6c 6f6e 2022  iew_with_colon "
-000c04e0: 2c0a 2020 2020 2020 2020 2020 6e65 775f  ,.          new_
-000c04f0: 7363 6865 6d65 5f77 6974 685f 636f 6c6f  scheme_with_colo
-000c0500: 6e29 3b0a 2020 4144 415f 4153 5345 5254  n);.  ADA_ASSERT
-000c0510: 5f54 5255 4528 7661 6c69 6461 7465 2829  _TRUE(validate()
-000c0520: 293b 0a20 2041 4441 5f41 5353 4552 545f  );.  ADA_ASSERT_
-000c0530: 5452 5545 2821 6e65 775f 7363 6865 6d65  TRUE(!new_scheme
-000c0540: 5f77 6974 685f 636f 6c6f 6e2e 656d 7074  _with_colon.empt
-000c0550: 7928 2920 2626 0a20 2020 2020 2020 2020  y() &&.         
-000c0560: 2020 2020 2020 2020 206e 6577 5f73 6368           new_sch
-000c0570: 656d 655f 7769 7468 5f63 6f6c 6f6e 2e62  eme_with_colon.b
-000c0580: 6163 6b28 2920 3d3d 2027 3a27 293b 0a20  ack() == ':');. 
-000c0590: 202f 2f20 6e65 7874 206c 696e 6520 636f   // next line co
-000c05a0: 756c 6420 6f76 6572 666c 6f77 2062 7574  uld overflow but
-000c05b0: 2075 6e73 6967 6e65 6420 6172 6974 686d   unsigned arithm
-000c05c0: 6574 6963 2068 6173 2077 656c 6c2d 6465  etic has well-de
-000c05d0: 6669 6e65 640a 2020 2f2f 206f 7665 7266  fined.  // overf
-000c05e0: 6c6f 7773 2e0a 2020 7569 6e74 3332 5f74  lows..  uint32_t
-000c05f0: 206e 6577 5f64 6966 6665 7265 6e63 6520   new_difference 
-000c0600: 3d0a 2020 2020 2020 7569 6e74 3332 5f74  =.      uint32_t
-000c0610: 286e 6577 5f73 6368 656d 655f 7769 7468  (new_scheme_with
-000c0620: 5f63 6f6c 6f6e 2e73 697a 6528 2929 202d  _colon.size()) -
-000c0630: 2063 6f6d 706f 6e65 6e74 732e 7072 6f74   components.prot
-000c0640: 6f63 6f6c 5f65 6e64 3b0a 0a20 2069 6620  ocol_end;..  if 
-000c0650: 2862 7566 6665 722e 656d 7074 7928 2929  (buffer.empty())
-000c0660: 207b 0a20 2020 2062 7566 6665 722e 6170   {.    buffer.ap
-000c0670: 7065 6e64 286e 6577 5f73 6368 656d 655f  pend(new_scheme_
-000c0680: 7769 7468 5f63 6f6c 6f6e 293b 0a20 207d  with_colon);.  }
-000c0690: 2065 6c73 6520 7b0a 2020 2020 6275 6666   else {.    buff
-000c06a0: 6572 2e65 7261 7365 2830 2c20 636f 6d70  er.erase(0, comp
-000c06b0: 6f6e 656e 7473 2e70 726f 746f 636f 6c5f  onents.protocol_
-000c06c0: 656e 6429 3b0a 2020 2020 6275 6666 6572  end);.    buffer
-000c06d0: 2e69 6e73 6572 7428 302c 206e 6577 5f73  .insert(0, new_s
-000c06e0: 6368 656d 655f 7769 7468 5f63 6f6c 6f6e  cheme_with_colon
-000c06f0: 293b 0a20 207d 0a20 2063 6f6d 706f 6e65  );.  }.  compone
-000c0700: 6e74 732e 7072 6f74 6f63 6f6c 5f65 6e64  nts.protocol_end
-000c0710: 202b 3d20 6e65 775f 6469 6666 6572 656e   += new_differen
-000c0720: 6365 3b0a 0a20 202f 2f20 5570 6461 7465  ce;..  // Update
-000c0730: 2074 6865 2072 6573 7420 6f66 2074 6865   the rest of the
-000c0740: 2063 6f6d 706f 6e65 6e74 732e 0a20 2063   components..  c
-000c0750: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
-000c0760: 6d65 5f65 6e64 202b 3d20 6e65 775f 6469  me_end += new_di
-000c0770: 6666 6572 656e 6365 3b0a 2020 636f 6d70  fference;.  comp
-000c0780: 6f6e 656e 7473 2e68 6f73 745f 7374 6172  onents.host_star
-000c0790: 7420 2b3d 206e 6577 5f64 6966 6665 7265  t += new_differe
-000c07a0: 6e63 653b 0a20 2063 6f6d 706f 6e65 6e74  nce;.  component
-000c07b0: 732e 686f 7374 5f65 6e64 202b 3d20 6e65  s.host_end += ne
-000c07c0: 775f 6469 6666 6572 656e 6365 3b0a 2020  w_difference;.  
-000c07d0: 636f 6d70 6f6e 656e 7473 2e70 6174 686e  components.pathn
-000c07e0: 616d 655f 7374 6172 7420 2b3d 206e 6577  ame_start += new
-000c07f0: 5f64 6966 6665 7265 6e63 653b 0a20 2069  _difference;.  i
-000c0800: 6620 2863 6f6d 706f 6e65 6e74 732e 7365  f (components.se
-000c0810: 6172 6368 5f73 7461 7274 2021 3d20 7572  arch_start != ur
-000c0820: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000c0830: 6974 7465 6429 207b 0a20 2020 2063 6f6d  itted) {.    com
-000c0840: 706f 6e65 6e74 732e 7365 6172 6368 5f73  ponents.search_s
-000c0850: 7461 7274 202b 3d20 6e65 775f 6469 6666  tart += new_diff
-000c0860: 6572 656e 6365 3b0a 2020 7d0a 2020 6966  erence;.  }.  if
-000c0870: 2028 636f 6d70 6f6e 656e 7473 2e68 6173   (components.has
-000c0880: 685f 7374 6172 7420 213d 2075 726c 5f63  h_start != url_c
-000c0890: 6f6d 706f 6e65 6e74 733a 3a6f 6d69 7474  omponents::omitt
-000c08a0: 6564 2920 7b0a 2020 2020 636f 6d70 6f6e  ed) {.    compon
-000c08b0: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
-000c08c0: 2b3d 206e 6577 5f64 6966 6665 7265 6e63  += new_differenc
-000c08d0: 653b 0a20 207d 0a20 2041 4441 5f41 5353  e;.  }.  ADA_ASS
-000c08e0: 4552 545f 5452 5545 2876 616c 6964 6174  ERT_TRUE(validat
-000c08f0: 6528 2929 3b0a 7d0a 0a69 6e6c 696e 6520  e());.}..inline 
-000c0900: 766f 6964 2075 726c 5f61 6767 7265 6761  void url_aggrega
-000c0910: 746f 723a 3a73 6574 5f73 6368 656d 6528  tor::set_scheme(
-000c0920: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000c0930: 206e 6577 5f73 6368 656d 6529 206e 6f65   new_scheme) noe
-000c0940: 7863 6570 7420 7b0a 2020 6164 615f 6c6f  xcept {.  ada_lo
-000c0950: 6728 2275 726c 5f61 6767 7265 6761 746f  g("url_aggregato
-000c0960: 723a 3a73 6574 5f73 6368 656d 6520 222c  r::set_scheme ",
-000c0970: 206e 6577 5f73 6368 656d 6529 3b0a 2020   new_scheme);.  
-000c0980: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
-000c0990: 7661 6c69 6461 7465 2829 293b 0a20 2041  validate());.  A
-000c09a0: 4441 5f41 5353 4552 545f 5452 5545 286e  DA_ASSERT_TRUE(n
-000c09b0: 6577 5f73 6368 656d 652e 656d 7074 7928  ew_scheme.empty(
-000c09c0: 2920 7c7c 206e 6577 5f73 6368 656d 652e  ) || new_scheme.
-000c09d0: 6261 636b 2829 2021 3d20 273a 2729 3b0a  back() != ':');.
-000c09e0: 2020 2f2f 206e 6578 7420 6c69 6e65 2063    // next line c
-000c09f0: 6f75 6c64 206f 7665 7266 6c6f 7720 6275  ould overflow bu
-000c0a00: 7420 756e 7369 676e 6564 2061 7269 7468  t unsigned arith
-000c0a10: 6d65 7469 6320 6861 7320 7765 6c6c 2d64  metic has well-d
-000c0a20: 6566 696e 6564 0a20 202f 2f20 6f76 6572  efined.  // over
-000c0a30: 666c 6f77 732e 0a20 2075 696e 7433 325f  flows..  uint32_
-000c0a40: 7420 6e65 775f 6469 6666 6572 656e 6365  t new_difference
-000c0a50: 203d 0a20 2020 2020 2075 696e 7433 325f   =.      uint32_
-000c0a60: 7428 6e65 775f 7363 6865 6d65 2e73 697a  t(new_scheme.siz
-000c0a70: 6528 2929 202d 2063 6f6d 706f 6e65 6e74  e()) - component
-000c0a80: 732e 7072 6f74 6f63 6f6c 5f65 6e64 202b  s.protocol_end +
-000c0a90: 2031 3b0a 0a20 2074 7970 6520 3d20 6164   1;..  type = ad
-000c0aa0: 613a 3a73 6368 656d 653a 3a67 6574 5f73  a::scheme::get_s
-000c0ab0: 6368 656d 655f 7479 7065 286e 6577 5f73  cheme_type(new_s
-000c0ac0: 6368 656d 6529 3b0a 2020 6966 2028 6275  cheme);.  if (bu
-000c0ad0: 6666 6572 2e65 6d70 7479 2829 2920 7b0a  ffer.empty()) {.
-000c0ae0: 2020 2020 6275 6666 6572 2e61 7070 656e      buffer.appen
-000c0af0: 6428 6865 6c70 6572 733a 3a63 6f6e 6361  d(helpers::conca
-000c0b00: 7428 6e65 775f 7363 6865 6d65 2c20 223a  t(new_scheme, ":
-000c0b10: 2229 293b 0a20 207d 2065 6c73 6520 7b0a  "));.  } else {.
-000c0b20: 2020 2020 6275 6666 6572 2e65 7261 7365      buffer.erase
-000c0b30: 2830 2c20 636f 6d70 6f6e 656e 7473 2e70  (0, components.p
-000c0b40: 726f 746f 636f 6c5f 656e 6429 3b0a 2020  rotocol_end);.  
-000c0b50: 2020 6275 6666 6572 2e69 6e73 6572 7428    buffer.insert(
-000c0b60: 302c 2068 656c 7065 7273 3a3a 636f 6e63  0, helpers::conc
-000c0b70: 6174 286e 6577 5f73 6368 656d 652c 2022  at(new_scheme, "
-000c0b80: 3a22 2929 3b0a 2020 7d0a 2020 636f 6d70  :"));.  }.  comp
-000c0b90: 6f6e 656e 7473 2e70 726f 746f 636f 6c5f  onents.protocol_
-000c0ba0: 656e 6420 3d20 7569 6e74 3332 5f74 286e  end = uint32_t(n
-000c0bb0: 6577 5f73 6368 656d 652e 7369 7a65 2829  ew_scheme.size()
-000c0bc0: 202b 2031 293b 0a0a 2020 2f2f 2055 7064   + 1);..  // Upd
-000c0bd0: 6174 6520 7468 6520 7265 7374 206f 6620  ate the rest of 
-000c0be0: 7468 6520 636f 6d70 6f6e 656e 7473 2e0a  the components..
-000c0bf0: 2020 636f 6d70 6f6e 656e 7473 2e75 7365    components.use
-000c0c00: 726e 616d 655f 656e 6420 2b3d 206e 6577  rname_end += new
-000c0c10: 5f64 6966 6665 7265 6e63 653b 0a20 2063  _difference;.  c
-000c0c20: 6f6d 706f 6e65 6e74 732e 686f 7374 5f73  omponents.host_s
-000c0c30: 7461 7274 202b 3d20 6e65 775f 6469 6666  tart += new_diff
-000c0c40: 6572 656e 6365 3b0a 2020 636f 6d70 6f6e  erence;.  compon
-000c0c50: 656e 7473 2e68 6f73 745f 656e 6420 2b3d  ents.host_end +=
-000c0c60: 206e 6577 5f64 6966 6665 7265 6e63 653b   new_difference;
-000c0c70: 0a20 2063 6f6d 706f 6e65 6e74 732e 7061  .  components.pa
-000c0c80: 7468 6e61 6d65 5f73 7461 7274 202b 3d20  thname_start += 
-000c0c90: 6e65 775f 6469 6666 6572 656e 6365 3b0a  new_difference;.
-000c0ca0: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
-000c0cb0: 2e73 6561 7263 685f 7374 6172 7420 213d  .search_start !=
-000c0cc0: 2075 726c 5f63 6f6d 706f 6e65 6e74 733a   url_components:
-000c0cd0: 3a6f 6d69 7474 6564 2920 7b0a 2020 2020  :omitted) {.    
-000c0ce0: 636f 6d70 6f6e 656e 7473 2e73 6561 7263  components.searc
-000c0cf0: 685f 7374 6172 7420 2b3d 206e 6577 5f64  h_start += new_d
-000c0d00: 6966 6665 7265 6e63 653b 0a20 207d 0a20  ifference;.  }. 
-000c0d10: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000c0d20: 6861 7368 5f73 7461 7274 2021 3d20 7572  hash_start != ur
-000c0d30: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000c0d40: 6974 7465 6429 207b 0a20 2020 2063 6f6d  itted) {.    com
-000c0d50: 706f 6e65 6e74 732e 6861 7368 5f73 7461  ponents.hash_sta
-000c0d60: 7274 202b 3d20 6e65 775f 6469 6666 6572  rt += new_differ
-000c0d70: 656e 6365 3b0a 2020 7d0a 2020 4144 415f  ence;.  }.  ADA_
-000c0d80: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
-000c0d90: 6461 7465 2829 293b 0a7d 0a0a 626f 6f6c  date());.}..bool
-000c0da0: 2075 726c 5f61 6767 7265 6761 746f 723a   url_aggregator:
-000c0db0: 3a73 6574 5f70 726f 746f 636f 6c28 636f  :set_protocol(co
-000c0dc0: 6e73 7420 7374 643a 3a73 7472 696e 675f  nst std::string_
-000c0dd0: 7669 6577 2069 6e70 7574 2920 7b0a 2020  view input) {.  
-000c0de0: 6164 615f 6c6f 6728 2275 726c 5f61 6767  ada_log("url_agg
-000c0df0: 7265 6761 746f 723a 3a73 6574 5f70 726f  regator::set_pro
-000c0e00: 746f 636f 6c20 222c 2069 6e70 7574 293b  tocol ", input);
-000c0e10: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
-000c0e20: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
-000c0e30: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000c0e40: 4528 2168 656c 7065 7273 3a3a 6f76 6572  E(!helpers::over
-000c0e50: 6c61 7073 2869 6e70 7574 2c20 6275 6666  laps(input, buff
-000c0e60: 6572 2929 3b0a 2020 7374 643a 3a73 7472  er));.  std::str
-000c0e70: 696e 6720 7669 6577 2869 6e70 7574 293b  ing view(input);
-000c0e80: 0a20 2068 656c 7065 7273 3a3a 7265 6d6f  .  helpers::remo
-000c0e90: 7665 5f61 7363 6969 5f74 6162 5f6f 725f  ve_ascii_tab_or_
-000c0ea0: 6e65 776c 696e 6528 7669 6577 293b 0a20  newline(view);. 
-000c0eb0: 2069 6620 2876 6965 772e 656d 7074 7928   if (view.empty(
-000c0ec0: 2929 207b 0a20 2020 2072 6574 7572 6e20  )) {.    return 
-000c0ed0: 7472 7565 3b0a 2020 7d0a 0a20 202f 2f20  true;.  }..  // 
-000c0ee0: 5363 6865 6d65 7320 7368 6f75 6c64 2073  Schemes should s
-000c0ef0: 7461 7274 2077 6974 6820 616c 7068 6120  tart with alpha 
-000c0f00: 7661 6c75 6573 2e0a 2020 6966 2028 2163  values..  if (!c
-000c0f10: 6865 636b 6572 733a 3a69 735f 616c 7068  heckers::is_alph
-000c0f20: 6128 7669 6577 5b30 5d29 2920 7b0a 2020  a(view[0])) {.  
-000c0f30: 2020 7265 7475 726e 2066 616c 7365 3b0a    return false;.
-000c0f40: 2020 7d0a 0a20 2076 6965 772e 6170 7065    }..  view.appe
-000c0f50: 6e64 2822 3a22 293b 0a0a 2020 7374 643a  nd(":");..  std:
-000c0f60: 3a73 7472 696e 673a 3a69 7465 7261 746f  :string::iterato
-000c0f70: 7220 706f 696e 7465 7220 3d0a 2020 2020  r pointer =.    
-000c0f80: 2020 7374 643a 3a66 696e 645f 6966 5f6e    std::find_if_n
-000c0f90: 6f74 2876 6965 772e 6265 6769 6e28 292c  ot(view.begin(),
-000c0fa0: 2076 6965 772e 656e 6428 292c 2075 6e69   view.end(), uni
-000c0fb0: 636f 6465 3a3a 6973 5f61 6c6e 756d 5f70  code::is_alnum_p
-000c0fc0: 6c75 7329 3b0a 0a20 2069 6620 2870 6f69  lus);..  if (poi
-000c0fd0: 6e74 6572 2021 3d20 7669 6577 2e65 6e64  nter != view.end
-000c0fe0: 2829 2026 2620 2a70 6f69 6e74 6572 203d  () && *pointer =
-000c0ff0: 3d20 273a 2729 207b 0a20 2020 2072 6574  = ':') {.    ret
-000c1000: 7572 6e20 7061 7273 655f 7363 6865 6d65  urn parse_scheme
-000c1010: 5f77 6974 685f 636f 6c6f 6e3c 7472 7565  _with_colon<true
-000c1020: 3e28 0a20 2020 2020 2020 2073 7464 3a3a  >(.        std::
-000c1030: 7374 7269 6e67 5f76 6965 7728 7669 6577  string_view(view
-000c1040: 2e64 6174 6128 292c 2070 6f69 6e74 6572  .data(), pointer
-000c1050: 202d 2076 6965 772e 6265 6769 6e28 2920   - view.begin() 
-000c1060: 2b20 3129 293b 0a20 207d 0a20 2072 6574  + 1));.  }.  ret
-000c1070: 7572 6e20 6661 6c73 653b 0a7d 0a0a 626f  urn false;.}..bo
-000c1080: 6f6c 2075 726c 5f61 6767 7265 6761 746f  ol url_aggregato
-000c1090: 723a 3a73 6574 5f75 7365 726e 616d 6528  r::set_username(
-000c10a0: 636f 6e73 7420 7374 643a 3a73 7472 696e  const std::strin
-000c10b0: 675f 7669 6577 2069 6e70 7574 2920 7b0a  g_view input) {.
-000c10c0: 2020 6164 615f 6c6f 6728 2275 726c 5f61    ada_log("url_a
-000c10d0: 6767 7265 6761 746f 723a 3a73 6574 5f75  ggregator::set_u
-000c10e0: 7365 726e 616d 6520 2722 2c20 696e 7075  sername '", inpu
-000c10f0: 742c 2022 2720 2229 3b0a 2020 4144 415f  t, "' ");.  ADA_
-000c1100: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
-000c1110: 6461 7465 2829 293b 0a20 2041 4441 5f41  date());.  ADA_A
-000c1120: 5353 4552 545f 5452 5545 2821 6865 6c70  SSERT_TRUE(!help
-000c1130: 6572 733a 3a6f 7665 726c 6170 7328 696e  ers::overlaps(in
-000c1140: 7075 742c 2062 7566 6665 7229 293b 0a20  put, buffer));. 
-000c1150: 2069 6620 2863 616e 6e6f 745f 6861 7665   if (cannot_have
-000c1160: 5f63 7265 6465 6e74 6961 6c73 5f6f 725f  _credentials_or_
-000c1170: 706f 7274 2829 2920 7b0a 2020 2020 7265  port()) {.    re
-000c1180: 7475 726e 2066 616c 7365 3b0a 2020 7d0a  turn false;.  }.
-000c1190: 2020 7369 7a65 5f74 2069 6478 203d 2061    size_t idx = a
-000c11a0: 6461 3a3a 756e 6963 6f64 653a 3a70 6572  da::unicode::per
-000c11b0: 6365 6e74 5f65 6e63 6f64 655f 696e 6465  cent_encode_inde
-000c11c0: 7828 0a20 2020 2020 2069 6e70 7574 2c20  x(.      input, 
-000c11d0: 6368 6172 6163 7465 725f 7365 7473 3a3a  character_sets::
-000c11e0: 5553 4552 494e 464f 5f50 4552 4345 4e54  USERINFO_PERCENT
-000c11f0: 5f45 4e43 4f44 4529 3b0a 2020 6966 2028  _ENCODE);.  if (
-000c1200: 6964 7820 3d3d 2069 6e70 7574 2e73 697a  idx == input.siz
-000c1210: 6528 2929 207b 0a20 2020 2075 7064 6174  e()) {.    updat
-000c1220: 655f 6261 7365 5f75 7365 726e 616d 6528  e_base_username(
-000c1230: 696e 7075 7429 3b0a 2020 7d20 656c 7365  input);.  } else
-000c1240: 207b 0a20 2020 202f 2f20 5765 206f 6e6c   {.    // We onl
-000c1250: 7920 6372 6561 7465 2061 2074 656d 706f  y create a tempo
-000c1260: 7261 7279 2073 7472 696e 6720 6966 2077  rary string if w
-000c1270: 6520 6861 7665 2074 6f21 0a20 2020 2075  e have to!.    u
-000c1280: 7064 6174 655f 6261 7365 5f75 7365 726e  pdate_base_usern
-000c1290: 616d 6528 6164 613a 3a75 6e69 636f 6465  ame(ada::unicode
-000c12a0: 3a3a 7065 7263 656e 745f 656e 636f 6465  ::percent_encode
-000c12b0: 280a 2020 2020 2020 2020 696e 7075 742c  (.        input,
-000c12c0: 2063 6861 7261 6374 6572 5f73 6574 733a   character_sets:
-000c12d0: 3a55 5345 5249 4e46 4f5f 5045 5243 454e  :USERINFO_PERCEN
-000c12e0: 545f 454e 434f 4445 2c20 6964 7829 293b  T_ENCODE, idx));
-000c12f0: 0a20 207d 0a20 2041 4441 5f41 5353 4552  .  }.  ADA_ASSER
-000c1300: 545f 5452 5545 2876 616c 6964 6174 6528  T_TRUE(validate(
-000c1310: 2929 3b0a 2020 7265 7475 726e 2074 7275  ));.  return tru
-000c1320: 653b 0a7d 0a0a 626f 6f6c 2075 726c 5f61  e;.}..bool url_a
-000c1330: 6767 7265 6761 746f 723a 3a73 6574 5f70  ggregator::set_p
-000c1340: 6173 7377 6f72 6428 636f 6e73 7420 7374  assword(const st
-000c1350: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
-000c1360: 6e70 7574 2920 7b0a 2020 6164 615f 6c6f  nput) {.  ada_lo
-000c1370: 6728 2275 726c 5f61 6767 7265 6761 746f  g("url_aggregato
-000c1380: 723a 3a73 6574 5f70 6173 7377 6f72 6420  r::set_password 
-000c1390: 2722 2c20 696e 7075 742c 2022 2722 293b  '", input, "'");
-000c13a0: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
-000c13b0: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
-000c13c0: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000c13d0: 4528 2168 656c 7065 7273 3a3a 6f76 6572  E(!helpers::over
-000c13e0: 6c61 7073 2869 6e70 7574 2c20 6275 6666  laps(input, buff
-000c13f0: 6572 2929 3b0a 2020 6966 2028 6361 6e6e  er));.  if (cann
-000c1400: 6f74 5f68 6176 655f 6372 6564 656e 7469  ot_have_credenti
-000c1410: 616c 735f 6f72 5f70 6f72 7428 2929 207b  als_or_port()) {
-000c1420: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
-000c1430: 653b 0a20 207d 0a20 2073 697a 655f 7420  e;.  }.  size_t 
-000c1440: 6964 7820 3d20 6164 613a 3a75 6e69 636f  idx = ada::unico
-000c1450: 6465 3a3a 7065 7263 656e 745f 656e 636f  de::percent_enco
-000c1460: 6465 5f69 6e64 6578 280a 2020 2020 2020  de_index(.      
-000c1470: 696e 7075 742c 2063 6861 7261 6374 6572  input, character
-000c1480: 5f73 6574 733a 3a55 5345 5249 4e46 4f5f  _sets::USERINFO_
-000c1490: 5045 5243 454e 545f 454e 434f 4445 293b  PERCENT_ENCODE);
-000c14a0: 0a20 2069 6620 2869 6478 203d 3d20 696e  .  if (idx == in
-000c14b0: 7075 742e 7369 7a65 2829 2920 7b0a 2020  put.size()) {.  
-000c14c0: 2020 7570 6461 7465 5f62 6173 655f 7061    update_base_pa
-000c14d0: 7373 776f 7264 2869 6e70 7574 293b 0a20  ssword(input);. 
-000c14e0: 207d 2065 6c73 6520 7b0a 2020 2020 2f2f   } else {.    //
-000c14f0: 2057 6520 6f6e 6c79 2063 7265 6174 6520   We only create 
-000c1500: 6120 7465 6d70 6f72 6172 7920 7374 7269  a temporary stri
-000c1510: 6e67 2069 6620 7765 2068 6176 6520 746f  ng if we have to
-000c1520: 210a 2020 2020 7570 6461 7465 5f62 6173  !.    update_bas
-000c1530: 655f 7061 7373 776f 7264 2861 6461 3a3a  e_password(ada::
-000c1540: 756e 6963 6f64 653a 3a70 6572 6365 6e74  unicode::percent
-000c1550: 5f65 6e63 6f64 6528 0a20 2020 2020 2020  _encode(.       
-000c1560: 2069 6e70 7574 2c20 6368 6172 6163 7465   input, characte
-000c1570: 725f 7365 7473 3a3a 5553 4552 494e 464f  r_sets::USERINFO
-000c1580: 5f50 4552 4345 4e54 5f45 4e43 4f44 452c  _PERCENT_ENCODE,
-000c1590: 2069 6478 2929 3b0a 2020 7d0a 2020 4144   idx));.  }.  AD
-000c15a0: 415f 4153 5345 5254 5f54 5255 4528 7661  A_ASSERT_TRUE(va
-000c15b0: 6c69 6461 7465 2829 293b 0a20 2072 6574  lidate());.  ret
-000c15c0: 7572 6e20 7472 7565 3b0a 7d0a 0a62 6f6f  urn true;.}..boo
-000c15d0: 6c20 7572 6c5f 6167 6772 6567 6174 6f72  l url_aggregator
-000c15e0: 3a3a 7365 745f 706f 7274 2863 6f6e 7374  ::set_port(const
-000c15f0: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000c1600: 7720 696e 7075 7429 207b 0a20 2061 6461  w input) {.  ada
-000c1610: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
-000c1620: 6174 6f72 3a3a 7365 745f 706f 7274 2022  ator::set_port "
-000c1630: 2c20 696e 7075 7429 3b0a 2020 4144 415f  , input);.  ADA_
-000c1640: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
-000c1650: 6461 7465 2829 293b 0a20 2041 4441 5f41  date());.  ADA_A
-000c1660: 5353 4552 545f 5452 5545 2821 6865 6c70  SSERT_TRUE(!help
-000c1670: 6572 733a 3a6f 7665 726c 6170 7328 696e  ers::overlaps(in
-000c1680: 7075 742c 2062 7566 6665 7229 293b 0a20  put, buffer));. 
-000c1690: 2069 6620 2863 616e 6e6f 745f 6861 7665   if (cannot_have
-000c16a0: 5f63 7265 6465 6e74 6961 6c73 5f6f 725f  _credentials_or_
-000c16b0: 706f 7274 2829 2920 7b0a 2020 2020 7265  port()) {.    re
-000c16c0: 7475 726e 2066 616c 7365 3b0a 2020 7d0a  turn false;.  }.
-000c16d0: 2020 7374 643a 3a73 7472 696e 6720 7472    std::string tr
-000c16e0: 696d 6d65 6428 696e 7075 7429 3b0a 2020  immed(input);.  
-000c16f0: 6865 6c70 6572 733a 3a72 656d 6f76 655f  helpers::remove_
-000c1700: 6173 6369 695f 7461 625f 6f72 5f6e 6577  ascii_tab_or_new
-000c1710: 6c69 6e65 2874 7269 6d6d 6564 293b 0a20  line(trimmed);. 
-000c1720: 2069 6620 2874 7269 6d6d 6564 2e65 6d70   if (trimmed.emp
-000c1730: 7479 2829 2920 7b0a 2020 2020 636c 6561  ty()) {.    clea
-000c1740: 725f 706f 7274 2829 3b0a 2020 2020 7265  r_port();.    re
-000c1750: 7475 726e 2074 7275 653b 0a20 207d 0a20  turn true;.  }. 
-000c1760: 202f 2f20 496e 7075 7420 7368 6f75 6c64   // Input should
-000c1770: 206e 6f74 2073 7461 7274 2077 6974 6820   not start with 
-000c1780: 636f 6e74 726f 6c20 6368 6172 6163 7465  control characte
-000c1790: 7273 2e0a 2020 6966 2028 6164 613a 3a75  rs..  if (ada::u
-000c17a0: 6e69 636f 6465 3a3a 6973 5f63 305f 636f  nicode::is_c0_co
-000c17b0: 6e74 726f 6c5f 6f72 5f73 7061 6365 2874  ntrol_or_space(t
-000c17c0: 7269 6d6d 6564 2e66 726f 6e74 2829 2929  rimmed.front()))
-000c17d0: 207b 0a20 2020 2072 6574 7572 6e20 6661   {.    return fa
-000c17e0: 6c73 653b 0a20 207d 0a20 202f 2f20 496e  lse;.  }.  // In
-000c17f0: 7075 7420 7368 6f75 6c64 2063 6f6e 7461  put should conta
-000c1800: 696e 2061 7420 6c65 6173 7420 6f6e 6520  in at least one 
-000c1810: 6173 6369 6920 6469 6769 742e 0a20 2069  ascii digit..  i
-000c1820: 6620 2869 6e70 7574 2e66 696e 645f 6669  f (input.find_fi
-000c1830: 7273 745f 6f66 2822 3031 3233 3435 3637  rst_of("01234567
-000c1840: 3839 2229 203d 3d20 7374 643a 3a73 7472  89") == std::str
-000c1850: 696e 675f 7669 6577 3a3a 6e70 6f73 2920  ing_view::npos) 
-000c1860: 7b0a 2020 2020 7265 7475 726e 2066 616c  {.    return fal
-000c1870: 7365 3b0a 2020 7d0a 0a20 202f 2f20 5265  se;.  }..  // Re
-000c1880: 7665 7274 2063 6861 6e67 6573 2069 6620  vert changes if 
-000c1890: 7061 7273 655f 706f 7274 2066 6169 6c73  parse_port fails
-000c18a0: 2e0a 2020 7569 6e74 3332 5f74 2070 7265  ..  uint32_t pre
-000c18b0: 7669 6f75 735f 706f 7274 203d 2063 6f6d  vious_port = com
-000c18c0: 706f 6e65 6e74 732e 706f 7274 3b0a 2020  ponents.port;.  
-000c18d0: 7061 7273 655f 706f 7274 2874 7269 6d6d  parse_port(trimm
-000c18e0: 6564 293b 0a20 2069 6620 2869 735f 7661  ed);.  if (is_va
-000c18f0: 6c69 6429 207b 0a20 2020 2072 6574 7572  lid) {.    retur
-000c1900: 6e20 7472 7565 3b0a 2020 7d0a 2020 7570  n true;.  }.  up
-000c1910: 6461 7465 5f62 6173 655f 706f 7274 2870  date_base_port(p
-000c1920: 7265 7669 6f75 735f 706f 7274 293b 0a20  revious_port);. 
-000c1930: 2069 735f 7661 6c69 6420 3d20 7472 7565   is_valid = true
-000c1940: 3b0a 2020 4144 415f 4153 5345 5254 5f54  ;.  ADA_ASSERT_T
-000c1950: 5255 4528 7661 6c69 6461 7465 2829 293b  RUE(validate());
-000c1960: 0a20 2072 6574 7572 6e20 6661 6c73 653b  .  return false;
-000c1970: 0a7d 0a0a 626f 6f6c 2075 726c 5f61 6767  .}..bool url_agg
-000c1980: 7265 6761 746f 723a 3a73 6574 5f70 6174  regator::set_pat
-000c1990: 686e 616d 6528 636f 6e73 7420 7374 643a  hname(const std:
-000c19a0: 3a73 7472 696e 675f 7669 6577 2069 6e70  :string_view inp
-000c19b0: 7574 2920 7b0a 2020 6164 615f 6c6f 6728  ut) {.  ada_log(
-000c19c0: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
-000c19d0: 3a73 6574 5f70 6174 686e 616d 6520 222c  :set_pathname ",
-000c19e0: 2069 6e70 7574 293b 0a20 2041 4441 5f41   input);.  ADA_A
-000c19f0: 5353 4552 545f 5452 5545 2876 616c 6964  SSERT_TRUE(valid
-000c1a00: 6174 6528 2929 3b0a 2020 4144 415f 4153  ate());.  ADA_AS
-000c1a10: 5345 5254 5f54 5255 4528 2168 656c 7065  SERT_TRUE(!helpe
-000c1a20: 7273 3a3a 6f76 6572 6c61 7073 2869 6e70  rs::overlaps(inp
-000c1a30: 7574 2c20 6275 6666 6572 2929 3b0a 2020  ut, buffer));.  
-000c1a40: 6966 2028 6861 735f 6f70 6171 7565 5f70  if (has_opaque_p
-000c1a50: 6174 6829 207b 0a20 2020 2072 6574 7572  ath) {.    retur
-000c1a60: 6e20 6661 6c73 653b 0a20 207d 0a20 2063  n false;.  }.  c
-000c1a70: 6c65 6172 5f70 6174 686e 616d 6528 293b  lear_pathname();
-000c1a80: 0a20 2070 6172 7365 5f70 6174 6828 696e  .  parse_path(in
-000c1a90: 7075 7429 3b0a 2020 6966 2028 6368 6563  put);.  if (chec
-000c1aa0: 6b65 7273 3a3a 6265 6769 6e73 5f77 6974  kers::begins_wit
-000c1ab0: 6828 696e 7075 742c 2022 2f2f 2229 2026  h(input, "//") &
-000c1ac0: 2620 2168 6173 5f61 7574 686f 7269 7479  & !has_authority
-000c1ad0: 2829 2026 260a 2020 2020 2020 2168 6173  () &&.      !has
-000c1ae0: 5f64 6173 685f 646f 7428 2929 207b 0a20  _dash_dot()) {. 
-000c1af0: 2020 2062 7566 6665 722e 696e 7365 7274     buffer.insert
-000c1b00: 2863 6f6d 706f 6e65 6e74 732e 7061 7468  (components.path
-000c1b10: 6e61 6d65 5f73 7461 7274 2c20 222f 2e22  name_start, "/."
-000c1b20: 293b 0a20 2020 2063 6f6d 706f 6e65 6e74  );.    component
-000c1b30: 732e 7061 7468 6e61 6d65 5f73 7461 7274  s.pathname_start
-000c1b40: 202b 3d20 323b 0a20 207d 0a20 2041 4441   += 2;.  }.  ADA
-000c1b50: 5f41 5353 4552 545f 5452 5545 2876 616c  _ASSERT_TRUE(val
-000c1b60: 6964 6174 6528 2929 3b0a 2020 7265 7475  idate());.  retu
-000c1b70: 726e 2074 7275 653b 0a7d 0a0a 6164 615f  rn true;.}..ada_
-000c1b80: 7265 616c 6c79 5f69 6e6c 696e 6520 766f  really_inline vo
-000c1b90: 6964 2075 726c 5f61 6767 7265 6761 746f  id url_aggregato
-000c1ba0: 723a 3a70 6172 7365 5f70 6174 6828 7374  r::parse_path(st
-000c1bb0: 643a 3a73 7472 696e 675f 7669 6577 2069  d::string_view i
-000c1bc0: 6e70 7574 2920 7b0a 2020 6164 615f 6c6f  nput) {.  ada_lo
-000c1bd0: 6728 2275 726c 5f61 6767 7265 6761 746f  g("url_aggregato
-000c1be0: 723a 3a70 6172 7365 5f70 6174 6820 222c  r::parse_path ",
-000c1bf0: 2069 6e70 7574 293b 0a20 2041 4441 5f41   input);.  ADA_A
-000c1c00: 5353 4552 545f 5452 5545 2876 616c 6964  SSERT_TRUE(valid
-000c1c10: 6174 6528 2929 3b0a 2020 4144 415f 4153  ate());.  ADA_AS
-000c1c20: 5345 5254 5f54 5255 4528 2168 656c 7065  SERT_TRUE(!helpe
-000c1c30: 7273 3a3a 6f76 6572 6c61 7073 2869 6e70  rs::overlaps(inp
-000c1c40: 7574 2c20 6275 6666 6572 2929 3b0a 2020  ut, buffer));.  
-000c1c50: 7374 643a 3a73 7472 696e 6720 746d 705f  std::string tmp_
-000c1c60: 6275 6666 6572 3b0a 2020 7374 643a 3a73  buffer;.  std::s
-000c1c70: 7472 696e 675f 7669 6577 2069 6e74 6572  tring_view inter
-000c1c80: 6e61 6c5f 696e 7075 743b 0a20 2069 6620  nal_input;.  if 
-000c1c90: 2875 6e69 636f 6465 3a3a 6861 735f 7461  (unicode::has_ta
-000c1ca0: 6273 5f6f 725f 6e65 776c 696e 6528 696e  bs_or_newline(in
-000c1cb0: 7075 7429 2920 7b0a 2020 2020 746d 705f  put)) {.    tmp_
-000c1cc0: 6275 6666 6572 203d 2069 6e70 7574 3b0a  buffer = input;.
-000c1cd0: 2020 2020 2f2f 204f 7074 696d 697a 6174      // Optimizat
-000c1ce0: 696f 6e20 6f70 706f 7274 756e 6974 793a  ion opportunity:
-000c1cf0: 2049 6e73 7465 6164 206f 6620 636f 7079   Instead of copy
-000c1d00: 696e 6720 616e 6420 7468 656e 2070 7275  ing and then pru
-000c1d10: 6e69 6e67 2c20 7765 2063 6f75 6c64 0a20  ning, we could. 
-000c1d20: 2020 202f 2f20 6a75 7374 2064 6972 6563     // just direc
-000c1d30: 746c 7920 6275 696c 6420 7468 6520 7374  tly build the st
-000c1d40: 7269 6e67 2066 726f 6d20 7573 6572 5f69  ring from user_i
-000c1d50: 6e70 7574 2e0a 2020 2020 6865 6c70 6572  nput..    helper
-000c1d60: 733a 3a72 656d 6f76 655f 6173 6369 695f  s::remove_ascii_
-000c1d70: 7461 625f 6f72 5f6e 6577 6c69 6e65 2874  tab_or_newline(t
-000c1d80: 6d70 5f62 7566 6665 7229 3b0a 2020 2020  mp_buffer);.    
-000c1d90: 696e 7465 726e 616c 5f69 6e70 7574 203d  internal_input =
-000c1da0: 2074 6d70 5f62 7566 6665 723b 0a20 207d   tmp_buffer;.  }
-000c1db0: 2065 6c73 6520 7b0a 2020 2020 696e 7465   else {.    inte
-000c1dc0: 726e 616c 5f69 6e70 7574 203d 2069 6e70  rnal_input = inp
-000c1dd0: 7574 3b0a 2020 7d0a 0a20 202f 2f20 4966  ut;.  }..  // If
-000c1de0: 2075 726c 2069 7320 7370 6563 6961 6c2c   url is special,
-000c1df0: 2074 6865 6e3a 0a20 2069 6620 2869 735f   then:.  if (is_
-000c1e00: 7370 6563 6961 6c28 2929 207b 0a20 2020  special()) {.   
-000c1e10: 2069 6620 2869 6e74 6572 6e61 6c5f 696e   if (internal_in
-000c1e20: 7075 742e 656d 7074 7928 2929 207b 0a20  put.empty()) {. 
-000c1e30: 2020 2020 2075 7064 6174 655f 6261 7365       update_base
-000c1e40: 5f70 6174 686e 616d 6528 222f 2229 3b0a  _pathname("/");.
-000c1e50: 2020 2020 7d20 656c 7365 2069 6620 2828      } else if ((
-000c1e60: 696e 7465 726e 616c 5f69 6e70 7574 5b30  internal_input[0
-000c1e70: 5d20 3d3d 2027 2f27 2920 7c7c 2028 696e  ] == '/') || (in
-000c1e80: 7465 726e 616c 5f69 6e70 7574 5b30 5d20  ternal_input[0] 
-000c1e90: 3d3d 2027 5c5c 2729 2920 7b0a 2020 2020  == '\\')) {.    
-000c1ea0: 2020 636f 6e73 756d 655f 7072 6570 6172    consume_prepar
-000c1eb0: 6564 5f70 6174 6828 696e 7465 726e 616c  ed_path(internal
-000c1ec0: 5f69 6e70 7574 2e73 7562 7374 7228 3129  _input.substr(1)
-000c1ed0: 293b 0a20 2020 207d 2065 6c73 6520 7b0a  );.    } else {.
-000c1ee0: 2020 2020 2020 636f 6e73 756d 655f 7072        consume_pr
-000c1ef0: 6570 6172 6564 5f70 6174 6828 696e 7465  epared_path(inte
-000c1f00: 726e 616c 5f69 6e70 7574 293b 0a20 2020  rnal_input);.   
-000c1f10: 207d 0a20 207d 2065 6c73 6520 6966 2028   }.  } else if (
-000c1f20: 2169 6e74 6572 6e61 6c5f 696e 7075 742e  !internal_input.
-000c1f30: 656d 7074 7928 2929 207b 0a20 2020 2069  empty()) {.    i
-000c1f40: 6620 2869 6e74 6572 6e61 6c5f 696e 7075  f (internal_inpu
-000c1f50: 745b 305d 203d 3d20 272f 2729 207b 0a20  t[0] == '/') {. 
-000c1f60: 2020 2020 2063 6f6e 7375 6d65 5f70 7265       consume_pre
-000c1f70: 7061 7265 645f 7061 7468 2869 6e74 6572  pared_path(inter
-000c1f80: 6e61 6c5f 696e 7075 742e 7375 6273 7472  nal_input.substr
-000c1f90: 2831 2929 3b0a 2020 2020 7d20 656c 7365  (1));.    } else
-000c1fa0: 207b 0a20 2020 2020 2063 6f6e 7375 6d65   {.      consume
-000c1fb0: 5f70 7265 7061 7265 645f 7061 7468 2869  _prepared_path(i
-000c1fc0: 6e74 6572 6e61 6c5f 696e 7075 7429 3b0a  nternal_input);.
-000c1fd0: 2020 2020 7d0a 2020 7d20 656c 7365 207b      }.  } else {
-000c1fe0: 0a20 2020 202f 2f20 4e6f 6e2d 7370 6563  .    // Non-spec
-000c1ff0: 6961 6c20 5552 4c73 2077 6974 6820 616e  ial URLs with an
-000c2000: 2065 6d70 7479 2068 6f73 7420 6361 6e20   empty host can 
-000c2010: 6861 7665 2074 6865 6972 2070 6174 6873  have their paths
-000c2020: 2065 7261 7365 640a 2020 2020 2f2f 2050   erased.    // P
-000c2030: 6174 682d 6f6e 6c79 2055 524c 7320 6361  ath-only URLs ca
-000c2040: 6e6e 6f74 2068 6176 6520 7468 6569 7220  nnot have their 
-000c2050: 7061 7468 7320 6572 6173 6564 0a20 2020  paths erased.   
-000c2060: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000c2070: 686f 7374 5f73 7461 7274 203d 3d20 636f  host_start == co
-000c2080: 6d70 6f6e 656e 7473 2e68 6f73 745f 656e  mponents.host_en
-000c2090: 6420 2626 2021 6861 735f 6175 7468 6f72  d && !has_author
-000c20a0: 6974 7928 2929 207b 0a20 2020 2020 2075  ity()) {.      u
-000c20b0: 7064 6174 655f 6261 7365 5f70 6174 686e  pdate_base_pathn
-000c20c0: 616d 6528 222f 2229 3b0a 2020 2020 7d0a  ame("/");.    }.
-000c20d0: 2020 7d0a 2020 4144 415f 4153 5345 5254    }.  ADA_ASSERT
-000c20e0: 5f54 5255 4528 7661 6c69 6461 7465 2829  _TRUE(validate()
-000c20f0: 293b 0a7d 0a0a 766f 6964 2075 726c 5f61  );.}..void url_a
-000c2100: 6767 7265 6761 746f 723a 3a73 6574 5f73  ggregator::set_s
-000c2110: 6561 7263 6828 636f 6e73 7420 7374 643a  earch(const std:
-000c2120: 3a73 7472 696e 675f 7669 6577 2069 6e70  :string_view inp
-000c2130: 7574 2920 7b0a 2020 6164 615f 6c6f 6728  ut) {.  ada_log(
-000c2140: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
-000c2150: 3a73 6574 5f73 6561 7263 6820 222c 2069  :set_search ", i
-000c2160: 6e70 7574 293b 0a20 2041 4441 5f41 5353  nput);.  ADA_ASS
-000c2170: 4552 545f 5452 5545 2876 616c 6964 6174  ERT_TRUE(validat
-000c2180: 6528 2929 3b0a 2020 4144 415f 4153 5345  e());.  ADA_ASSE
-000c2190: 5254 5f54 5255 4528 2168 656c 7065 7273  RT_TRUE(!helpers
-000c21a0: 3a3a 6f76 6572 6c61 7073 2869 6e70 7574  ::overlaps(input
-000c21b0: 2c20 6275 6666 6572 2929 3b0a 2020 6966  , buffer));.  if
-000c21c0: 2028 696e 7075 742e 656d 7074 7928 2929   (input.empty())
-000c21d0: 207b 0a20 2020 2063 6c65 6172 5f73 6561   {.    clear_sea
-000c21e0: 7263 6828 293b 0a20 2020 2068 656c 7065  rch();.    helpe
-000c21f0: 7273 3a3a 7374 7269 705f 7472 6169 6c69  rs::strip_traili
-000c2200: 6e67 5f73 7061 6365 735f 6672 6f6d 5f6f  ng_spaces_from_o
-000c2210: 7061 7175 655f 7061 7468 282a 7468 6973  paque_path(*this
-000c2220: 293b 0a20 2020 2072 6574 7572 6e3b 0a20  );.    return;. 
-000c2230: 207d 0a0a 2020 7374 643a 3a73 7472 696e   }..  std::strin
-000c2240: 6720 6e65 775f 7661 6c75 653b 0a20 206e  g new_value;.  n
-000c2250: 6577 5f76 616c 7565 203d 2069 6e70 7574  ew_value = input
-000c2260: 5b30 5d20 3d3d 2027 3f27 203f 2069 6e70  [0] == '?' ? inp
-000c2270: 7574 2e73 7562 7374 7228 3129 203a 2069  ut.substr(1) : i
-000c2280: 6e70 7574 3b0a 2020 6865 6c70 6572 733a  nput;.  helpers:
-000c2290: 3a72 656d 6f76 655f 6173 6369 695f 7461  :remove_ascii_ta
-000c22a0: 625f 6f72 5f6e 6577 6c69 6e65 286e 6577  b_or_newline(new
-000c22b0: 5f76 616c 7565 293b 0a0a 2020 6175 746f  _value);..  auto
-000c22c0: 2071 7565 7279 5f70 6572 6365 6e74 5f65   query_percent_e
-000c22d0: 6e63 6f64 655f 7365 7420 3d0a 2020 2020  ncode_set =.    
-000c22e0: 2020 6973 5f73 7065 6369 616c 2829 203f    is_special() ?
-000c22f0: 2061 6461 3a3a 6368 6172 6163 7465 725f   ada::character_
-000c2300: 7365 7473 3a3a 5350 4543 4941 4c5f 5155  sets::SPECIAL_QU
-000c2310: 4552 595f 5045 5243 454e 545f 454e 434f  ERY_PERCENT_ENCO
-000c2320: 4445 0a20 2020 2020 2020 2020 2020 2020  DE.             
-000c2330: 2020 2020 2020 3a20 6164 613a 3a63 6861        : ada::cha
-000c2340: 7261 6374 6572 5f73 6574 733a 3a51 5545  racter_sets::QUE
-000c2350: 5259 5f50 4552 4345 4e54 5f45 4e43 4f44  RY_PERCENT_ENCOD
-000c2360: 453b 0a0a 2020 7570 6461 7465 5f62 6173  E;..  update_bas
-000c2370: 655f 7365 6172 6368 286e 6577 5f76 616c  e_search(new_val
-000c2380: 7565 2c20 7175 6572 795f 7065 7263 656e  ue, query_percen
-000c2390: 745f 656e 636f 6465 5f73 6574 293b 0a20  t_encode_set);. 
-000c23a0: 2041 4441 5f41 5353 4552 545f 5452 5545   ADA_ASSERT_TRUE
-000c23b0: 2876 616c 6964 6174 6528 2929 3b0a 7d0a  (validate());.}.
-000c23c0: 0a76 6f69 6420 7572 6c5f 6167 6772 6567  .void url_aggreg
-000c23d0: 6174 6f72 3a3a 7365 745f 6861 7368 2863  ator::set_hash(c
-000c23e0: 6f6e 7374 2073 7464 3a3a 7374 7269 6e67  onst std::string
-000c23f0: 5f76 6965 7720 696e 7075 7429 207b 0a20  _view input) {. 
-000c2400: 2061 6461 5f6c 6f67 2822 7572 6c5f 6167   ada_log("url_ag
-000c2410: 6772 6567 6174 6f72 3a3a 7365 745f 6861  gregator::set_ha
-000c2420: 7368 2022 2c20 696e 7075 7429 3b0a 2020  sh ", input);.  
-000c2430: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
-000c2440: 7661 6c69 6461 7465 2829 293b 0a20 2041  validate());.  A
-000c2450: 4441 5f41 5353 4552 545f 5452 5545 2821  DA_ASSERT_TRUE(!
-000c2460: 6865 6c70 6572 733a 3a6f 7665 726c 6170  helpers::overlap
-000c2470: 7328 696e 7075 742c 2062 7566 6665 7229  s(input, buffer)
-000c2480: 293b 0a20 2069 6620 2869 6e70 7574 2e65  );.  if (input.e
-000c2490: 6d70 7479 2829 2920 7b0a 2020 2020 6966  mpty()) {.    if
-000c24a0: 2028 636f 6d70 6f6e 656e 7473 2e68 6173   (components.has
-000c24b0: 685f 7374 6172 7420 213d 2075 726c 5f63  h_start != url_c
-000c24c0: 6f6d 706f 6e65 6e74 733a 3a6f 6d69 7474  omponents::omitt
-000c24d0: 6564 2920 7b0a 2020 2020 2020 6275 6666  ed) {.      buff
-000c24e0: 6572 2e72 6573 697a 6528 636f 6d70 6f6e  er.resize(compon
-000c24f0: 656e 7473 2e68 6173 685f 7374 6172 7429  ents.hash_start)
-000c2500: 3b0a 2020 2020 2020 636f 6d70 6f6e 656e  ;.      componen
-000c2510: 7473 2e68 6173 685f 7374 6172 7420 3d20  ts.hash_start = 
-000c2520: 7572 6c5f 636f 6d70 6f6e 656e 7473 3a3a  url_components::
-000c2530: 6f6d 6974 7465 643b 0a20 2020 207d 0a20  omitted;.    }. 
-000c2540: 2020 2068 656c 7065 7273 3a3a 7374 7269     helpers::stri
-000c2550: 705f 7472 6169 6c69 6e67 5f73 7061 6365  p_trailing_space
-000c2560: 735f 6672 6f6d 5f6f 7061 7175 655f 7061  s_from_opaque_pa
-000c2570: 7468 282a 7468 6973 293b 0a20 2020 2072  th(*this);.    r
-000c2580: 6574 7572 6e3b 0a20 207d 0a0a 2020 7374  eturn;.  }..  st
-000c2590: 643a 3a73 7472 696e 6720 6e65 775f 7661  d::string new_va
-000c25a0: 6c75 653b 0a20 206e 6577 5f76 616c 7565  lue;.  new_value
-000c25b0: 203d 2069 6e70 7574 5b30 5d20 3d3d 2027   = input[0] == '
-000c25c0: 2327 203f 2069 6e70 7574 2e73 7562 7374  #' ? input.subst
-000c25d0: 7228 3129 203a 2069 6e70 7574 3b0a 2020  r(1) : input;.  
-000c25e0: 6865 6c70 6572 733a 3a72 656d 6f76 655f  helpers::remove_
-000c25f0: 6173 6369 695f 7461 625f 6f72 5f6e 6577  ascii_tab_or_new
-000c2600: 6c69 6e65 286e 6577 5f76 616c 7565 293b  line(new_value);
-000c2610: 0a20 2075 7064 6174 655f 756e 656e 636f  .  update_unenco
-000c2620: 6465 645f 6261 7365 5f68 6173 6828 6e65  ded_base_hash(ne
-000c2630: 775f 7661 6c75 6529 3b0a 2020 4144 415f  w_value);.  ADA_
-000c2640: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
-000c2650: 6461 7465 2829 293b 0a7d 0a0a 626f 6f6c  date());.}..bool
-000c2660: 2075 726c 5f61 6767 7265 6761 746f 723a   url_aggregator:
-000c2670: 3a73 6574 5f68 7265 6628 636f 6e73 7420  :set_href(const 
-000c2680: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000c2690: 2069 6e70 7574 2920 7b0a 2020 4144 415f   input) {.  ADA_
-000c26a0: 4153 5345 5254 5f54 5255 4528 2168 656c  ASSERT_TRUE(!hel
-000c26b0: 7065 7273 3a3a 6f76 6572 6c61 7073 2869  pers::overlaps(i
-000c26c0: 6e70 7574 2c20 6275 6666 6572 2929 3b0a  nput, buffer));.
-000c26d0: 2020 6164 615f 6c6f 6728 2275 726c 5f61    ada_log("url_a
-000c26e0: 6767 7265 6761 746f 723a 3a73 6574 5f68  ggregator::set_h
-000c26f0: 7265 6620 222c 2069 6e70 7574 2c20 225b  ref ", input, "[
-000c2700: 222c 2069 6e70 7574 2e73 697a 6528 292c  ", input.size(),
-000c2710: 2022 2062 7974 6573 5d22 293b 0a20 2061   " bytes]");.  a
-000c2720: 6461 3a3a 7265 7375 6c74 3c75 726c 5f61  da::result<url_a
-000c2730: 6767 7265 6761 746f 723e 206f 7574 203d  ggregator> out =
-000c2740: 2061 6461 3a3a 7061 7273 653c 7572 6c5f   ada::parse<url_
-000c2750: 6167 6772 6567 6174 6f72 3e28 696e 7075  aggregator>(inpu
-000c2760: 7429 3b0a 2020 6164 615f 6c6f 6728 2275  t);.  ada_log("u
-000c2770: 726c 5f61 6767 7265 6761 746f 723a 3a73  rl_aggregator::s
-000c2780: 6574 5f68 7265 662c 2073 7563 6365 7373  et_href, success
-000c2790: 203a 222c 206f 7574 2e68 6173 5f76 616c   :", out.has_val
-000c27a0: 7565 2829 293b 0a0a 2020 6966 2028 6f75  ue());..  if (ou
-000c27b0: 7429 207b 0a20 2020 2061 6461 5f6c 6f67  t) {.    ada_log
-000c27c0: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
-000c27d0: 3a3a 7365 745f 6872 6566 2c20 7061 7273  ::set_href, pars
-000c27e0: 6564 2022 2c20 6f75 742d 3e74 6f5f 7374  ed ", out->to_st
-000c27f0: 7269 6e67 2829 293b 0a20 2020 202f 2f20  ring());.    // 
-000c2800: 544f 444f 3a20 4669 6775 7265 206f 7574  TODO: Figure out
-000c2810: 2077 6879 2074 6865 2066 6f6c 6c6f 7769   why the followi
-000c2820: 6e67 206c 696e 6520 7075 7473 2074 6573  ng line puts tes
-000c2830: 7420 746f 206e 6576 6572 2066 696e 6973  t to never finis
-000c2840: 682e 0a20 2020 202a 7468 6973 203d 202a  h..    *this = *
-000c2850: 6f75 743b 0a20 207d 0a0a 2020 7265 7475  out;.  }..  retu
-000c2860: 726e 206f 7574 2e68 6173 5f76 616c 7565  rn out.has_value
-000c2870: 2829 3b0a 7d0a 0a61 6461 5f72 6561 6c6c  ();.}..ada_reall
-000c2880: 795f 696e 6c69 6e65 2062 6f6f 6c20 7572  y_inline bool ur
-000c2890: 6c5f 6167 6772 6567 6174 6f72 3a3a 7061  l_aggregator::pa
-000c28a0: 7273 655f 686f 7374 2873 7464 3a3a 7374  rse_host(std::st
-000c28b0: 7269 6e67 5f76 6965 7720 696e 7075 7429  ring_view input)
-000c28c0: 207b 0a20 2061 6461 5f6c 6f67 2822 7572   {.  ada_log("ur
-000c28d0: 6c5f 6167 6772 6567 6174 6f72 3a70 6172  l_aggregator:par
-000c28e0: 7365 5f68 6f73 7420 222c 2069 6e70 7574  se_host ", input
-000c28f0: 2c20 225b 222c 2069 6e70 7574 2e73 697a  , "[", input.siz
-000c2900: 6528 292c 2022 2062 7974 6573 5d22 293b  e(), " bytes]");
-000c2910: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
-000c2920: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
-000c2930: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000c2940: 4528 2168 656c 7065 7273 3a3a 6f76 6572  E(!helpers::over
-000c2950: 6c61 7073 2869 6e70 7574 2c20 6275 6666  laps(input, buff
-000c2960: 6572 2929 3b0a 2020 6966 2028 696e 7075  er));.  if (inpu
-000c2970: 742e 656d 7074 7928 2929 207b 0a20 2020  t.empty()) {.   
-000c2980: 2072 6574 7572 6e20 6973 5f76 616c 6964   return is_valid
-000c2990: 203d 2066 616c 7365 3b0a 2020 7d20 202f   = false;.  }  /
-000c29a0: 2f20 7465 6368 6e69 6361 6c6c 7920 756e  / technically un
-000c29b0: 6e65 6365 7373 6172 792e 0a20 202f 2f20  necessary..  // 
-000c29c0: 4966 2069 6e70 7574 2073 7461 7274 7320  If input starts 
-000c29d0: 7769 7468 2055 2b30 3035 4220 285b 292c  with U+005B ([),
-000c29e0: 2074 6865 6e3a 0a20 2069 6620 2869 6e70   then:.  if (inp
-000c29f0: 7574 5b30 5d20 3d3d 2027 5b27 2920 7b0a  ut[0] == '[') {.
-000c2a00: 2020 2020 2f2f 2049 6620 696e 7075 7420      // If input 
-000c2a10: 646f 6573 206e 6f74 2065 6e64 2077 6974  does not end wit
-000c2a20: 6820 552b 3030 3544 2028 5d29 2c20 7661  h U+005D (]), va
-000c2a30: 6c69 6461 7469 6f6e 2065 7272 6f72 2c20  lidation error, 
-000c2a40: 7265 7475 726e 2066 6169 6c75 7265 2e0a  return failure..
-000c2a50: 2020 2020 6966 2028 696e 7075 742e 6261      if (input.ba
-000c2a60: 636b 2829 2021 3d20 275d 2729 207b 0a20  ck() != ']') {. 
-000c2a70: 2020 2020 2072 6574 7572 6e20 6973 5f76       return is_v
-000c2a80: 616c 6964 203d 2066 616c 7365 3b0a 2020  alid = false;.  
-000c2a90: 2020 7d0a 2020 2020 6164 615f 6c6f 6728    }.    ada_log(
-000c2aa0: 2270 6172 7365 5f68 6f73 7420 6970 7636  "parse_host ipv6
-000c2ab0: 2229 3b0a 0a20 2020 202f 2f20 5265 7475  ");..    // Retu
-000c2ac0: 726e 2074 6865 2072 6573 756c 7420 6f66  rn the result of
-000c2ad0: 2049 5076 3620 7061 7273 696e 6720 696e   IPv6 parsing in
-000c2ae0: 7075 7420 7769 7468 2069 7473 206c 6561  put with its lea
-000c2af0: 6469 6e67 2055 2b30 3035 4220 285b 2920  ding U+005B ([) 
-000c2b00: 616e 640a 2020 2020 2f2f 2074 7261 696c  and.    // trail
-000c2b10: 696e 6720 552b 3030 3544 2028 5d29 2072  ing U+005D (]) r
-000c2b20: 656d 6f76 6564 2e0a 2020 2020 696e 7075  emoved..    inpu
-000c2b30: 742e 7265 6d6f 7665 5f70 7265 6669 7828  t.remove_prefix(
-000c2b40: 3129 3b0a 2020 2020 696e 7075 742e 7265  1);.    input.re
-000c2b50: 6d6f 7665 5f73 7566 6669 7828 3129 3b0a  move_suffix(1);.
-000c2b60: 2020 2020 7265 7475 726e 2070 6172 7365      return parse
-000c2b70: 5f69 7076 3628 696e 7075 7429 3b0a 2020  _ipv6(input);.  
-000c2b80: 7d0a 0a20 202f 2f20 4966 2069 734e 6f74  }..  // If isNot
-000c2b90: 5370 6563 6961 6c20 6973 2074 7275 652c  Special is true,
-000c2ba0: 2074 6865 6e20 7265 7475 726e 2074 6865   then return the
-000c2bb0: 2072 6573 756c 7420 6f66 206f 7061 7175   result of opaqu
-000c2bc0: 652d 686f 7374 2070 6172 7369 6e67 0a20  e-host parsing. 
-000c2bd0: 202f 2f20 696e 7075 742e 0a20 2069 6620   // input..  if 
-000c2be0: 2821 6973 5f73 7065 6369 616c 2829 2920  (!is_special()) 
-000c2bf0: 7b0a 2020 2020 7265 7475 726e 2070 6172  {.    return par
-000c2c00: 7365 5f6f 7061 7175 655f 686f 7374 2869  se_opaque_host(i
-000c2c10: 6e70 7574 293b 0a20 207d 0a20 202f 2f20  nput);.  }.  // 
-000c2c20: 4c65 7420 646f 6d61 696e 2062 6520 7468  Let domain be th
-000c2c30: 6520 7265 7375 6c74 206f 6620 7275 6e6e  e result of runn
-000c2c40: 696e 6720 5554 462d 3820 6465 636f 6465  ing UTF-8 decode
-000c2c50: 2077 6974 686f 7574 2042 4f4d 206f 6e20   without BOM on 
-000c2c60: 7468 650a 2020 2f2f 2070 6572 6365 6e74  the.  // percent
-000c2c70: 2d64 6563 6f64 696e 6720 6f66 2069 6e70  -decoding of inp
-000c2c80: 7574 2e20 4c65 7420 6173 6369 6944 6f6d  ut. Let asciiDom
-000c2c90: 6169 6e20 6265 2074 6865 2072 6573 756c  ain be the resul
-000c2ca0: 7420 6f66 2072 756e 6e69 6e67 2064 6f6d  t of running dom
-000c2cb0: 6169 6e0a 2020 2f2f 2074 6f20 4153 4349  ain.  // to ASCI
-000c2cc0: 4920 7769 7468 2064 6f6d 6169 6e20 616e  I with domain an
-000c2cd0: 6420 6661 6c73 652e 2054 6865 206d 6f73  d false. The mos
-000c2ce0: 7420 636f 6d6d 6f6e 2063 6173 6520 6973  t common case is
-000c2cf0: 2061 6e20 4153 4349 4920 696e 7075 742c   an ASCII input,
-000c2d00: 2069 6e0a 2020 2f2f 2077 6869 6368 2063   in.  // which c
-000c2d10: 6173 6520 7765 2064 6f20 6e6f 7420 6e65  ase we do not ne
-000c2d20: 6564 2074 6f20 6361 6c6c 2074 6865 2065  ed to call the e
-000c2d30: 7870 656e 7369 7665 2027 746f 5f61 7363  xpensive 'to_asc
-000c2d40: 6969 2720 6966 2061 2066 6577 0a20 202f  ii' if a few.  /
-000c2d50: 2f20 636f 6e64 6974 696f 6e73 2061 7265  / conditions are
-000c2d60: 206d 6574 3a20 6e6f 2027 2527 2061 6e64   met: no '%' and
-000c2d70: 206e 6f20 2778 6e2d 2720 7375 6273 6571   no 'xn-' subseq
-000c2d80: 7565 6e63 652e 0a0a 2020 2f2f 204f 6674  uence...  // Oft
-000c2d90: 656e 2c20 7468 6520 696e 7075 7420 646f  en, the input do
-000c2da0: 6573 206e 6f74 2063 6f6e 7461 696e 2061  es not contain a
-000c2db0: 6e79 2066 6f72 6269 6464 656e 2063 6f64  ny forbidden cod
-000c2dc0: 6520 706f 696e 7473 2c20 616e 6420 6e6f  e points, and no
-000c2dd0: 2075 7070 6572 0a20 202f 2f20 6361 7365   upper.  // case
-000c2de0: 2041 5343 4949 206c 6574 7465 722c 2074   ASCII letter, t
-000c2df0: 6865 6e20 7765 2063 616e 206a 7573 7420  hen we can just 
-000c2e00: 636f 7079 2069 7420 746f 2074 6865 2062  copy it to the b
-000c2e10: 7566 6665 722e 2057 6520 7761 6e74 2074  uffer. We want t
-000c2e20: 6f0a 2020 2f2f 206f 7074 696d 697a 6520  o.  // optimize 
-000c2e30: 666f 7220 7375 6368 2061 2063 6f6d 6d6f  for such a commo
-000c2e40: 6e20 6361 7365 2e0a 2020 7569 6e74 385f  n case..  uint8_
-000c2e50: 7420 6973 5f66 6f72 6269 6464 656e 5f6f  t is_forbidden_o
-000c2e60: 725f 7570 7065 7220 3d0a 2020 2020 2020  r_upper =.      
-000c2e70: 756e 6963 6f64 653a 3a63 6f6e 7461 696e  unicode::contain
-000c2e80: 735f 666f 7262 6964 6465 6e5f 646f 6d61  s_forbidden_doma
-000c2e90: 696e 5f63 6f64 655f 706f 696e 745f 6f72  in_code_point_or
-000c2ea0: 5f75 7070 6572 2869 6e70 7574 2e64 6174  _upper(input.dat
-000c2eb0: 6128 292c 0a20 2020 2020 2020 2020 2020  a(),.           
-000c2ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c2ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c2ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c2ef0: 2020 696e 7075 742e 7369 7a65 2829 293b    input.size());
-000c2f00: 0a20 202f 2f20 4d69 6e6f 7220 6f70 7469  .  // Minor opti
-000c2f10: 6d69 7a61 7469 6f6e 206f 7070 6f72 7475  mization opportu
-000c2f20: 6e69 7479 3a0a 2020 2f2f 2063 6f6e 7461  nity:.  // conta
-000c2f30: 696e 735f 666f 7262 6964 6465 6e5f 646f  ins_forbidden_do
-000c2f40: 6d61 696e 5f63 6f64 655f 706f 696e 745f  main_code_point_
-000c2f50: 6f72 5f75 7070 6572 2063 6f75 6c64 2062  or_upper could b
-000c2f60: 6520 6578 7465 6e64 2074 6f20 6368 6563  e extend to chec
-000c2f70: 6b20 666f 720a 2020 2f2f 2074 6865 2070  k for.  // the p
-000c2f80: 7265 7365 6e63 6520 6f66 2063 6861 7261  resence of chara
-000c2f90: 6374 6572 7320 7468 6174 2063 616e 6e6f  cters that canno
-000c2fa0: 7420 6170 7065 6172 2069 6e20 7468 6520  t appear in the 
-000c2fb0: 6970 7634 2061 6464 7265 7373 2061 6e64  ipv4 address and
-000c2fc0: 2077 650a 2020 2f2f 2063 6f75 6c64 2061   we.  // could a
-000c2fd0: 6c73 6f20 6368 6563 6b20 7768 6574 6865  lso check whethe
-000c2fe0: 7220 7820 616e 6420 6e20 616e 6420 2d20  r x and n and - 
-000c2ff0: 6172 6520 7072 6573 656e 742c 2061 6e64  are present, and
-000c3000: 2073 6f20 7765 2063 6f75 6c64 2073 6b69   so we could ski
-000c3010: 700a 2020 2f2f 2073 6f6d 6520 6f66 2074  p.  // some of t
-000c3020: 6865 2063 6865 636b 7320 6265 6c6f 772e  he checks below.
-000c3030: 2048 6f77 6576 6572 2c20 7468 6520 6761   However, the ga
-000c3040: 696e 7320 6172 6520 6c69 6b65 6c79 2074  ins are likely t
-000c3050: 6f20 6265 2073 6d61 6c6c 2c20 616e 640a  o be small, and.
-000c3060: 2020 2f2f 2074 6865 2063 6f64 6520 776f    // the code wo
-000c3070: 756c 6420 6265 206d 6f72 6520 636f 6d70  uld be more comp
-000c3080: 6c65 782e 0a20 2069 6620 2869 735f 666f  lex..  if (is_fo
-000c3090: 7262 6964 6465 6e5f 6f72 5f75 7070 6572  rbidden_or_upper
-000c30a0: 203d 3d20 3020 2626 0a20 2020 2020 2069   == 0 &&.      i
-000c30b0: 6e70 7574 2e66 696e 6428 2278 6e2d 2229  nput.find("xn-")
-000c30c0: 203d 3d20 7374 643a 3a73 7472 696e 675f   == std::string_
-000c30d0: 7669 6577 3a3a 6e70 6f73 2920 7b0a 2020  view::npos) {.  
-000c30e0: 2020 2f2f 2066 6173 7420 7061 7468 0a20    // fast path. 
-000c30f0: 2020 2075 7064 6174 655f 6261 7365 5f68     update_base_h
-000c3100: 6f73 746e 616d 6528 696e 7075 7429 3b0a  ostname(input);.
-000c3110: 2020 2020 6966 2028 6368 6563 6b65 7273      if (checkers
-000c3120: 3a3a 6973 5f69 7076 3428 6765 745f 686f  ::is_ipv4(get_ho
-000c3130: 7374 6e61 6d65 2829 2929 207b 0a20 2020  stname())) {.   
-000c3140: 2020 2061 6461 5f6c 6f67 2822 7061 7273     ada_log("pars
-000c3150: 655f 686f 7374 2066 6173 7420 7061 7468  e_host fast path
-000c3160: 2069 7076 3422 293b 0a20 2020 2020 2072   ipv4");.      r
-000c3170: 6574 7572 6e20 7061 7273 655f 6970 7634  eturn parse_ipv4
-000c3180: 2867 6574 5f68 6f73 746e 616d 6528 2929  (get_hostname())
-000c3190: 3b0a 2020 2020 7d0a 2020 2020 6164 615f  ;.    }.    ada_
-000c31a0: 6c6f 6728 2270 6172 7365 5f68 6f73 7420  log("parse_host 
-000c31b0: 6661 7374 2070 6174 6820 222c 2067 6574  fast path ", get
-000c31c0: 5f68 6f73 746e 616d 6528 2929 3b0a 2020  _hostname());.  
-000c31d0: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
-000c31e0: 207d 0a20 202f 2f20 5765 2068 6176 6520   }.  // We have 
-000c31f0: 656e 636f 756e 7465 7265 6420 6174 206c  encountered at l
-000c3200: 6561 7374 206f 6e65 2066 6f72 6269 6464  east one forbidd
-000c3210: 656e 2063 6f64 6520 706f 696e 7420 6f72  en code point or
-000c3220: 2074 6865 2069 6e70 7574 2063 6f6e 7461   the input conta
-000c3230: 696e 730a 2020 2f2f 2027 786e 2d27 2028  ins.  // 'xn-' (
-000c3240: 6361 7365 2069 6e73 656e 7369 7469 7665  case insensitive
-000c3250: 292c 2073 6f20 7765 206e 6565 6420 746f  ), so we need to
-000c3260: 2063 616c 6c20 2774 6f5f 6173 6369 6927   call 'to_ascii'
-000c3270: 2074 6f20 7065 7266 6f72 6d20 7468 6520   to perform the 
-000c3280: 6675 6c6c 0a20 202f 2f20 636f 6e76 6572  full.  // conver
-000c3290: 7369 6f6e 2e0a 0a20 2061 6461 5f6c 6f67  sion...  ada_log
-000c32a0: 2822 7061 7273 655f 686f 7374 2063 616c  ("parse_host cal
-000c32b0: 6c69 6e67 2074 6f5f 6173 6369 6922 293b  ling to_ascii");
-000c32c0: 0a20 2073 7464 3a3a 6f70 7469 6f6e 616c  .  std::optional
-000c32d0: 3c73 7464 3a3a 7374 7269 6e67 3e20 686f  <std::string> ho
-000c32e0: 7374 203d 2073 7464 3a3a 7374 7269 6e67  st = std::string
-000c32f0: 2867 6574 5f68 6f73 746e 616d 6528 2929  (get_hostname())
-000c3300: 3b0a 2020 6973 5f76 616c 6964 203d 2061  ;.  is_valid = a
-000c3310: 6461 3a3a 756e 6963 6f64 653a 3a74 6f5f  da::unicode::to_
-000c3320: 6173 6369 6928 686f 7374 2c20 696e 7075  ascii(host, inpu
-000c3330: 742c 2069 6e70 7574 2e66 696e 6428 2725  t, input.find('%
-000c3340: 2729 293b 0a20 2069 6620 2821 6973 5f76  '));.  if (!is_v
-000c3350: 616c 6964 2920 7b0a 2020 2020 6164 615f  alid) {.    ada_
-000c3360: 6c6f 6728 2270 6172 7365 5f68 6f73 7420  log("parse_host 
-000c3370: 746f 5f61 7363 6969 2072 6574 7572 6e73  to_ascii returns
-000c3380: 2066 616c 7365 2229 3b0a 2020 2020 7265   false");.    re
-000c3390: 7475 726e 2069 735f 7661 6c69 6420 3d20  turn is_valid = 
-000c33a0: 6661 6c73 653b 0a20 207d 0a0a 2020 6966  false;.  }..  if
-000c33b0: 2028 7374 643a 3a61 6e79 5f6f 6628 686f   (std::any_of(ho
-000c33c0: 7374 2e76 616c 7565 2829 2e62 6567 696e  st.value().begin
-000c33d0: 2829 2c20 686f 7374 2e76 616c 7565 2829  (), host.value()
-000c33e0: 2e65 6e64 2829 2c0a 2020 2020 2020 2020  .end(),.        
-000c33f0: 2020 2020 2020 2020 2020 6164 613a 3a75            ada::u
-000c3400: 6e69 636f 6465 3a3a 6973 5f66 6f72 6269  nicode::is_forbi
-000c3410: 6464 656e 5f64 6f6d 6169 6e5f 636f 6465  dden_domain_code
-000c3420: 5f70 6f69 6e74 2929 207b 0a20 2020 2072  _point)) {.    r
+000b8520: 2020 2061 7574 686f 7269 7479 5f76 6965     authority_vie
+000b8530: 772e 7375 6273 7472 2870 6173 7377 6f72  w.substr(passwor
+000b8540: 645f 746f 6b65 6e5f 6c6f 6361 7469 6f6e  d_token_location
+000b8550: 202b 2031 292c 0a20 2020 2020 2020 2020   + 1),.         
+000b8560: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+000b8570: 7261 6374 6572 5f73 6574 733a 3a55 5345  racter_sets::USE
+000b8580: 5249 4e46 4f5f 5045 5243 454e 545f 454e  RINFO_PERCENT_EN
+000b8590: 434f 4445 293b 0a20 2020 2020 2020 2020  CODE);.         
+000b85a0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+000b85b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b85c0: 2020 7572 6c2e 6170 7065 6e64 5f62 6173    url.append_bas
+000b85d0: 655f 7573 6572 6e61 6d65 2875 6e69 636f  e_username(unico
+000b85e0: 6465 3a3a 7065 7263 656e 745f 656e 636f  de::percent_enco
+000b85f0: 6465 280a 2020 2020 2020 2020 2020 2020  de(.            
+000b8600: 2020 2020 2020 2020 2020 6175 7468 6f72            author
+000b8610: 6974 795f 7669 6577 2e73 7562 7374 7228  ity_view.substr(
+000b8620: 302c 2070 6173 7377 6f72 645f 746f 6b65  0, password_toke
+000b8630: 6e5f 6c6f 6361 7469 6f6e 292c 0a20 2020  n_location),.   
+000b8640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b8650: 2020 2063 6861 7261 6374 6572 5f73 6574     character_set
+000b8660: 733a 3a55 5345 5249 4e46 4f5f 5045 5243  s::USERINFO_PERC
+000b8670: 454e 545f 454e 434f 4445 2929 3b0a 2020  ENT_ENCODE));.  
+000b8680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b8690: 7572 6c2e 6170 7065 6e64 5f62 6173 655f  url.append_base_
+000b86a0: 7061 7373 776f 7264 2875 6e69 636f 6465  password(unicode
+000b86b0: 3a3a 7065 7263 656e 745f 656e 636f 6465  ::percent_encode
+000b86c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000b86d0: 2020 2020 2020 2020 6175 7468 6f72 6974          authorit
+000b86e0: 795f 7669 6577 2e73 7562 7374 7228 7061  y_view.substr(pa
+000b86f0: 7373 776f 7264 5f74 6f6b 656e 5f6c 6f63  ssword_token_loc
+000b8700: 6174 696f 6e20 2b20 3129 2c0a 2020 2020  ation + 1),.    
+000b8710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b8720: 2020 6368 6172 6163 7465 725f 7365 7473    character_sets
+000b8730: 3a3a 5553 4552 494e 464f 5f50 4552 4345  ::USERINFO_PERCE
+000b8740: 4e54 5f45 4e43 4f44 4529 293b 0a20 2020  NT_ENCODE));.   
+000b8750: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000b8760: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000b8770: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
+000b8780: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+000b8790: 2020 6966 2063 6f6e 7374 6578 7072 2028    if constexpr (
+000b87a0: 7265 7375 6c74 5f74 7970 655f 6973 5f61  result_type_is_a
+000b87b0: 6461 5f75 726c 2920 7b0a 2020 2020 2020  da_url) {.      
+000b87c0: 2020 2020 2020 2020 2020 7572 6c2e 7061            url.pa
+000b87d0: 7373 776f 7264 202b 3d20 756e 6963 6f64  ssword += unicod
+000b87e0: 653a 3a70 6572 6365 6e74 5f65 6e63 6f64  e::percent_encod
+000b87f0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000b8800: 2020 2020 2020 2061 7574 686f 7269 7479         authority
+000b8810: 5f76 6965 772c 2063 6861 7261 6374 6572  _view, character
+000b8820: 5f73 6574 733a 3a55 5345 5249 4e46 4f5f  _sets::USERINFO_
+000b8830: 5045 5243 454e 545f 454e 434f 4445 293b  PERCENT_ENCODE);
+000b8840: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
+000b8850: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+000b8860: 2020 2020 2020 2020 7572 6c2e 6170 7065          url.appe
+000b8870: 6e64 5f62 6173 655f 7061 7373 776f 7264  nd_base_password
+000b8880: 2875 6e69 636f 6465 3a3a 7065 7263 656e  (unicode::percen
+000b8890: 745f 656e 636f 6465 280a 2020 2020 2020  t_encode(.      
+000b88a0: 2020 2020 2020 2020 2020 2020 2020 6175                au
+000b88b0: 7468 6f72 6974 795f 7669 6577 2c20 6368  thority_view, ch
+000b88c0: 6172 6163 7465 725f 7365 7473 3a3a 5553  aracter_sets::US
+000b88d0: 4552 494e 464f 5f50 4552 4345 4e54 5f45  ERINFO_PERCENT_E
+000b88e0: 4e43 4f44 4529 293b 0a20 2020 2020 2020  NCODE));.       
+000b88f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000b8900: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000b8910: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
+000b8920: 4f74 6865 7277 6973 652c 2069 6620 6f6e  Otherwise, if on
+000b8930: 6520 6f66 2074 6865 2066 6f6c 6c6f 7769  e of the followi
+000b8940: 6e67 2069 7320 7472 7565 3a0a 2020 2020  ng is true:.    
+000b8950: 2020 2020 2020 2f2f 202d 2063 2069 7320        // - c is 
+000b8960: 7468 6520 454f 4620 636f 6465 2070 6f69  the EOF code poi
+000b8970: 6e74 2c20 552b 3030 3246 2028 2f29 2c20  nt, U+002F (/), 
+000b8980: 552b 3030 3346 2028 3f29 2c20 6f72 2055  U+003F (?), or U
+000b8990: 2b30 3032 3320 2823 290a 2020 2020 2020  +0023 (#).      
+000b89a0: 2020 2020 2f2f 202d 2075 726c 2069 7320      // - url is 
+000b89b0: 7370 6563 6961 6c20 616e 6420 6320 6973  special and c is
+000b89c0: 2055 2b30 3035 4320 285c 290a 2020 2020   U+005C (\).    
+000b89d0: 2020 2020 2020 656c 7365 2069 6620 2865        else if (e
+000b89e0: 6e64 5f6f 665f 6175 7468 6f72 6974 7920  nd_of_authority 
+000b89f0: 3d3d 2069 6e70 7574 5f73 697a 6520 7c7c  == input_size ||
+000b8a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000b8a10: 2020 2020 7572 6c5f 6461 7461 5b65 6e64      url_data[end
+000b8a20: 5f6f 665f 6175 7468 6f72 6974 795d 203d  _of_authority] =
+000b8a30: 3d20 272f 2720 7c7c 0a20 2020 2020 2020  = '/' ||.       
+000b8a40: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
+000b8a50: 6461 7461 5b65 6e64 5f6f 665f 6175 7468  data[end_of_auth
+000b8a60: 6f72 6974 795d 203d 3d20 273f 2720 7c7c  ority] == '?' ||
+000b8a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000b8a80: 2020 2020 2875 726c 2e69 735f 7370 6563      (url.is_spec
+000b8a90: 6961 6c28 2920 2626 2075 726c 5f64 6174  ial() && url_dat
+000b8aa0: 615b 656e 645f 6f66 5f61 7574 686f 7269  a[end_of_authori
+000b8ab0: 7479 5d20 3d3d 2027 5c5c 2729 2920 7b0a  ty] == '\\')) {.
+000b8ac0: 2020 2020 2020 2020 2020 2020 2f2f 2049              // I
+000b8ad0: 6620 6174 5369 676e 5365 656e 2069 7320  f atSignSeen is 
+000b8ae0: 7472 7565 2061 6e64 2061 7574 686f 7269  true and authori
+000b8af0: 7479 5f76 6965 7720 6973 2074 6865 2065  ty_view is the e
+000b8b00: 6d70 7479 2073 7472 696e 672c 0a20 2020  mpty string,.   
+000b8b10: 2020 2020 2020 2020 202f 2f20 7661 6c69           // vali
+000b8b20: 6461 7469 6f6e 2065 7272 6f72 2c20 7265  dation error, re
+000b8b30: 7475 726e 2066 6169 6c75 7265 2e0a 2020  turn failure..  
+000b8b40: 2020 2020 2020 2020 2020 6966 2028 6174            if (at
+000b8b50: 5f73 6967 6e5f 7365 656e 2026 2620 6175  _sign_seen && au
+000b8b60: 7468 6f72 6974 795f 7669 6577 2e65 6d70  thority_view.emp
+000b8b70: 7479 2829 2920 7b0a 2020 2020 2020 2020  ty()) {.        
+000b8b80: 2020 2020 2020 7572 6c2e 6973 5f76 616c        url.is_val
+000b8b90: 6964 203d 2066 616c 7365 3b0a 2020 2020  id = false;.    
+000b8ba0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000b8bb0: 2075 726c 3b0a 2020 2020 2020 2020 2020   url;.          
+000b8bc0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000b8bd0: 7374 6174 6520 3d20 6164 613a 3a73 7461  state = ada::sta
+000b8be0: 7465 3a3a 484f 5354 3b0a 2020 2020 2020  te::HOST;.      
+000b8bf0: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
+000b8c00: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000b8c10: 2020 2069 6620 2865 6e64 5f6f 665f 6175     if (end_of_au
+000b8c20: 7468 6f72 6974 7920 3d3d 2069 6e70 7574  thority == input
+000b8c30: 5f73 697a 6529 207b 0a20 2020 2020 2020  _size) {.       
+000b8c40: 2020 2020 2069 6620 2866 7261 676d 656e       if (fragmen
+000b8c50: 742e 6861 735f 7661 6c75 6528 2929 207b  t.has_value()) {
+000b8c60: 0a20 2020 2020 2020 2020 2020 2020 2075  .              u
+000b8c70: 726c 2e75 7064 6174 655f 756e 656e 636f  rl.update_unenco
+000b8c80: 6465 645f 6261 7365 5f68 6173 6828 2a66  ded_base_hash(*f
+000b8c90: 7261 676d 656e 7429 3b0a 2020 2020 2020  ragment);.      
+000b8ca0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000b8cb0: 2020 2020 7265 7475 726e 2075 726c 3b0a      return url;.
+000b8cc0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000b8cd0: 2020 2020 2020 696e 7075 745f 706f 7369        input_posi
+000b8ce0: 7469 6f6e 203d 2065 6e64 5f6f 665f 6175  tion = end_of_au
+000b8cf0: 7468 6f72 6974 7920 2b20 313b 0a20 2020  thority + 1;.   
+000b8d00: 2020 2020 207d 2077 6869 6c65 2028 7472       } while (tr
+000b8d10: 7565 293b 0a0a 2020 2020 2020 2020 6272  ue);..        br
+000b8d20: 6561 6b3b 0a20 2020 2020 207d 0a20 2020  eak;.      }.   
+000b8d30: 2020 2063 6173 6520 6164 613a 3a73 7461     case ada::sta
+000b8d40: 7465 3a3a 5350 4543 4941 4c5f 5245 4c41  te::SPECIAL_RELA
+000b8d50: 5449 5645 5f4f 525f 4155 5448 4f52 4954  TIVE_OR_AUTHORIT
+000b8d60: 593a 207b 0a20 2020 2020 2020 2061 6461  Y: {.        ada
+000b8d70: 5f6c 6f67 2822 5350 4543 4941 4c5f 5245  _log("SPECIAL_RE
+000b8d80: 4c41 5449 5645 5f4f 525f 4155 5448 4f52  LATIVE_OR_AUTHOR
+000b8d90: 4954 5920 222c 0a20 2020 2020 2020 2020  ITY ",.         
+000b8da0: 2020 2020 2020 2068 656c 7065 7273 3a3a         helpers::
+000b8db0: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000b8dc0: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000b8dd0: 6f6e 2929 3b0a 0a20 2020 2020 2020 202f  on));..        /
+000b8de0: 2f20 4966 2063 2069 7320 552b 3030 3246  / If c is U+002F
+000b8df0: 2028 2f29 2061 6e64 2072 656d 6169 6e69   (/) and remaini
+000b8e00: 6e67 2073 7461 7274 7320 7769 7468 2055  ng starts with U
+000b8e10: 2b30 3032 4620 282f 292c 0a20 2020 2020  +002F (/),.     
+000b8e20: 2020 202f 2f20 7468 656e 2073 6574 2073     // then set s
+000b8e30: 7461 7465 2074 6f20 7370 6563 6961 6c20  tate to special 
+000b8e40: 6175 7468 6f72 6974 7920 6967 6e6f 7265  authority ignore
+000b8e50: 2073 6c61 7368 6573 2073 7461 7465 2061   slashes state a
+000b8e60: 6e64 2069 6e63 7265 6173 650a 2020 2020  nd increase.    
+000b8e70: 2020 2020 2f2f 2070 6f69 6e74 6572 2062      // pointer b
+000b8e80: 7920 312e 0a20 2020 2020 2020 2073 7464  y 1..        std
+000b8e90: 3a3a 7374 7269 6e67 5f76 6965 7720 7669  ::string_view vi
+000b8ea0: 6577 203d 2068 656c 7065 7273 3a3a 7375  ew = helpers::su
+000b8eb0: 6273 7472 696e 6728 7572 6c5f 6461 7461  bstring(url_data
+000b8ec0: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
+000b8ed0: 293b 0a20 2020 2020 2020 2069 6620 2861  );.        if (a
+000b8ee0: 6461 3a3a 6368 6563 6b65 7273 3a3a 6265  da::checkers::be
+000b8ef0: 6769 6e73 5f77 6974 6828 7669 6577 2c20  gins_with(view, 
+000b8f00: 222f 2f22 2929 207b 0a20 2020 2020 2020  "//")) {.       
+000b8f10: 2020 2073 7461 7465 203d 2061 6461 3a3a     state = ada::
+000b8f20: 7374 6174 653a 3a53 5045 4349 414c 5f41  state::SPECIAL_A
+000b8f30: 5554 484f 5249 5459 5f49 474e 4f52 455f  UTHORITY_IGNORE_
+000b8f40: 534c 4153 4845 533b 0a20 2020 2020 2020  SLASHES;.       
+000b8f50: 2020 2069 6e70 7574 5f70 6f73 6974 696f     input_positio
+000b8f60: 6e20 2b3d 2032 3b0a 2020 2020 2020 2020  n += 2;.        
+000b8f70: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+000b8f80: 2020 202f 2f20 4f74 6865 7277 6973 652c     // Otherwise,
+000b8f90: 2076 616c 6964 6174 696f 6e20 6572 726f   validation erro
+000b8fa0: 722c 2073 6574 2073 7461 7465 2074 6f20  r, set state to 
+000b8fb0: 7265 6c61 7469 7665 2073 7461 7465 2061  relative state a
+000b8fc0: 6e64 0a20 2020 2020 2020 2020 202f 2f20  nd.          // 
+000b8fd0: 6465 6372 6561 7365 2070 6f69 6e74 6572  decrease pointer
+000b8fe0: 2062 7920 312e 0a20 2020 2020 2020 2020   by 1..         
+000b8ff0: 2073 7461 7465 203d 2061 6461 3a3a 7374   state = ada::st
+000b9000: 6174 653a 3a52 454c 4154 4956 455f 5343  ate::RELATIVE_SC
+000b9010: 4845 4d45 3b0a 2020 2020 2020 2020 7d0a  HEME;.        }.
+000b9020: 0a20 2020 2020 2020 2062 7265 616b 3b0a  .        break;.
+000b9030: 2020 2020 2020 7d0a 2020 2020 2020 6361        }.      ca
+000b9040: 7365 2061 6461 3a3a 7374 6174 653a 3a50  se ada::state::P
+000b9050: 4154 485f 4f52 5f41 5554 484f 5249 5459  ATH_OR_AUTHORITY
+000b9060: 3a20 7b0a 2020 2020 2020 2020 6164 615f  : {.        ada_
+000b9070: 6c6f 6728 2250 4154 485f 4f52 5f41 5554  log("PATH_OR_AUT
+000b9080: 484f 5249 5459 2022 2c0a 2020 2020 2020  HORITY ",.      
+000b9090: 2020 2020 2020 2020 2020 6865 6c70 6572            helper
+000b90a0: 733a 3a73 7562 7374 7269 6e67 2875 726c  s::substring(url
+000b90b0: 5f64 6174 612c 2069 6e70 7574 5f70 6f73  _data, input_pos
+000b90c0: 6974 696f 6e29 293b 0a0a 2020 2020 2020  ition));..      
+000b90d0: 2020 2f2f 2049 6620 6320 6973 2055 2b30    // If c is U+0
+000b90e0: 3032 4620 282f 292c 2074 6865 6e20 7365  02F (/), then se
+000b90f0: 7420 7374 6174 6520 746f 2061 7574 686f  t state to autho
+000b9100: 7269 7479 2073 7461 7465 2e0a 2020 2020  rity state..    
+000b9110: 2020 2020 6966 2028 2869 6e70 7574 5f70      if ((input_p
+000b9120: 6f73 6974 696f 6e20 213d 2069 6e70 7574  osition != input
+000b9130: 5f73 697a 6529 2026 260a 2020 2020 2020  _size) &&.      
+000b9140: 2020 2020 2020 2875 726c 5f64 6174 615b        (url_data[
+000b9150: 696e 7075 745f 706f 7369 7469 6f6e 5d20  input_position] 
+000b9160: 3d3d 2027 2f27 2929 207b 0a20 2020 2020  == '/')) {.     
+000b9170: 2020 2020 2073 7461 7465 203d 2061 6461       state = ada
+000b9180: 3a3a 7374 6174 653a 3a41 5554 484f 5249  ::state::AUTHORI
+000b9190: 5459 3b0a 2020 2020 2020 2020 2020 696e  TY;.          in
+000b91a0: 7075 745f 706f 7369 7469 6f6e 2b2b 3b0a  put_position++;.
+000b91b0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+000b91c0: 0a20 2020 2020 2020 2020 202f 2f20 4f74  .          // Ot
+000b91d0: 6865 7277 6973 652c 2073 6574 2073 7461  herwise, set sta
+000b91e0: 7465 2074 6f20 7061 7468 2073 7461 7465  te to path state
+000b91f0: 2c20 616e 6420 6465 6372 6561 7365 2070  , and decrease p
+000b9200: 6f69 6e74 6572 2062 7920 312e 0a20 2020  ointer by 1..   
+000b9210: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
+000b9220: 6461 3a3a 7374 6174 653a 3a50 4154 483b  da::state::PATH;
+000b9230: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+000b9240: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
+000b9250: 207d 0a20 2020 2020 2063 6173 6520 6164   }.      case ad
+000b9260: 613a 3a73 7461 7465 3a3a 5245 4c41 5449  a::state::RELATI
+000b9270: 5645 5f53 4348 454d 453a 207b 0a20 2020  VE_SCHEME: {.   
+000b9280: 2020 2020 2061 6461 5f6c 6f67 2822 5245       ada_log("RE
+000b9290: 4c41 5449 5645 5f53 4348 454d 4520 222c  LATIVE_SCHEME ",
+000b92a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000b92b0: 2068 656c 7065 7273 3a3a 7375 6273 7472   helpers::substr
+000b92c0: 696e 6728 7572 6c5f 6461 7461 2c20 696e  ing(url_data, in
+000b92d0: 7075 745f 706f 7369 7469 6f6e 2929 3b0a  put_position));.
+000b92e0: 0a20 2020 2020 2020 202f 2f20 5365 7420  .        // Set 
+000b92f0: 7572 6ce2 8099 7320 7363 6865 6d65 2074  url...s scheme t
+000b9300: 6f20 6261 7365 e280 9973 2073 6368 656d  o base...s schem
+000b9310: 652e 0a20 2020 2020 2020 2075 726c 2e63  e..        url.c
+000b9320: 6f70 795f 7363 6865 6d65 282a 6261 7365  opy_scheme(*base
+000b9330: 5f75 726c 293b 0a0a 2020 2020 2020 2020  _url);..        
+000b9340: 2f2f 2049 6620 6320 6973 2055 2b30 3032  // If c is U+002
+000b9350: 4620 282f 292c 2074 6865 6e20 7365 7420  F (/), then set 
+000b9360: 7374 6174 6520 746f 2072 656c 6174 6976  state to relativ
+000b9370: 6520 736c 6173 6820 7374 6174 652e 0a20  e slash state.. 
+000b9380: 2020 2020 2020 2069 6620 2828 696e 7075         if ((inpu
+000b9390: 745f 706f 7369 7469 6f6e 2021 3d20 696e  t_position != in
+000b93a0: 7075 745f 7369 7a65 2920 2626 0a20 2020  put_size) &&.   
+000b93b0: 2020 2020 2020 2020 2028 7572 6c5f 6461           (url_da
+000b93c0: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
+000b93d0: 6e5d 203d 3d20 272f 2729 2920 7b0a 2020  n] == '/')) {.  
+000b93e0: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
+000b93f0: 0a20 2020 2020 2020 2020 2020 2020 2022  .              "
+000b9400: 5245 4c41 5449 5645 5f53 4348 454d 4520  RELATIVE_SCHEME 
+000b9410: 6966 2063 2069 7320 552b 3030 3246 2028  if c is U+002F (
+000b9420: 2f29 2c20 7468 656e 2073 6574 2073 7461  /), then set sta
+000b9430: 7465 2074 6f20 7265 6c61 7469 7665 2022  te to relative "
+000b9440: 0a20 2020 2020 2020 2020 2020 2020 2022  .              "
+000b9450: 736c 6173 6820 7374 6174 6522 293b 0a20  slash state");. 
+000b9460: 2020 2020 2020 2020 2073 7461 7465 203d           state =
+000b9470: 2061 6461 3a3a 7374 6174 653a 3a52 454c   ada::state::REL
+000b9480: 4154 4956 455f 534c 4153 483b 0a20 2020  ATIVE_SLASH;.   
+000b9490: 2020 2020 207d 2065 6c73 6520 6966 2028       } else if (
+000b94a0: 7572 6c2e 6973 5f73 7065 6369 616c 2829  url.is_special()
+000b94b0: 2026 2620 2869 6e70 7574 5f70 6f73 6974   && (input_posit
+000b94c0: 696f 6e20 213d 2069 6e70 7574 5f73 697a  ion != input_siz
+000b94d0: 6529 2026 260a 2020 2020 2020 2020 2020  e) &&.          
+000b94e0: 2020 2020 2020 2020 2028 7572 6c5f 6461           (url_da
+000b94f0: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
+000b9500: 6e5d 203d 3d20 275c 5c27 2929 207b 0a20  n] == '\\')) {. 
+000b9510: 2020 2020 2020 2020 202f 2f20 4f74 6865           // Othe
+000b9520: 7277 6973 652c 2069 6620 7572 6c20 6973  rwise, if url is
+000b9530: 2073 7065 6369 616c 2061 6e64 2063 2069   special and c i
+000b9540: 7320 552b 3030 3543 2028 5c29 2c20 7661  s U+005C (\), va
+000b9550: 6c69 6461 7469 6f6e 2065 7272 6f72 2c0a  lidation error,.
+000b9560: 2020 2020 2020 2020 2020 2f2f 2073 6574            // set
+000b9570: 2073 7461 7465 2074 6f20 7265 6c61 7469   state to relati
+000b9580: 7665 2073 6c61 7368 2073 7461 7465 2e0a  ve slash state..
+000b9590: 2020 2020 2020 2020 2020 6164 615f 6c6f            ada_lo
+000b95a0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+000b95b0: 2022 5245 4c41 5449 5645 5f53 4348 454d   "RELATIVE_SCHEM
+000b95c0: 4520 2069 6620 7572 6c20 6973 2073 7065  E  if url is spe
+000b95d0: 6369 616c 2061 6e64 2063 2069 7320 552b  cial and c is U+
+000b95e0: 3030 3543 2c20 7661 6c69 6461 7469 6f6e  005C, validation
+000b95f0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+000b9600: 2022 6572 726f 722c 2073 6574 2073 7461   "error, set sta
+000b9610: 7465 2074 6f20 7265 6c61 7469 7665 2073  te to relative s
+000b9620: 6c61 7368 2073 7461 7465 2229 3b0a 2020  lash state");.  
+000b9630: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+000b9640: 6164 613a 3a73 7461 7465 3a3a 5245 4c41  ada::state::RELA
+000b9650: 5449 5645 5f53 4c41 5348 3b0a 2020 2020  TIVE_SLASH;.    
+000b9660: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+000b9670: 2020 2020 2020 2061 6461 5f6c 6f67 2822         ada_log("
+000b9680: 5245 4c41 5449 5645 5f53 4348 454d 4520  RELATIVE_SCHEME 
+000b9690: 6f74 6865 7277 6973 6522 293b 0a20 2020  otherwise");.   
+000b96a0: 2020 2020 2020 202f 2f20 5365 7420 7572         // Set ur
+000b96b0: 6ce2 8099 7320 7573 6572 6e61 6d65 2074  l...s username t
+000b96c0: 6f20 6261 7365 e280 9973 2075 7365 726e  o base...s usern
+000b96d0: 616d 652c 2075 726c e280 9973 2070 6173  ame, url...s pas
+000b96e0: 7377 6f72 6420 746f 2062 6173 65e2 8099  sword to base...
+000b96f0: 730a 2020 2020 2020 2020 2020 2f2f 2070  s.          // p
+000b9700: 6173 7377 6f72 642c 2075 726c e280 9973  assword, url...s
+000b9710: 2068 6f73 7420 746f 2062 6173 65e2 8099   host to base...
+000b9720: 7320 686f 7374 2c20 7572 6ce2 8099 7320  s host, url...s 
+000b9730: 706f 7274 2074 6f20 6261 7365 e280 9973  port to base...s
+000b9740: 2070 6f72 742c 0a20 2020 2020 2020 2020   port,.         
+000b9750: 202f 2f20 7572 6ce2 8099 7320 7061 7468   // url...s path
+000b9760: 2074 6f20 6120 636c 6f6e 6520 6f66 2062   to a clone of b
+000b9770: 6173 65e2 8099 7320 7061 7468 2c20 616e  ase...s path, an
+000b9780: 6420 7572 6ce2 8099 7320 7175 6572 7920  d url...s query 
+000b9790: 746f 2062 6173 65e2 8099 730a 2020 2020  to base...s.    
+000b97a0: 2020 2020 2020 2f2f 2071 7565 7279 2e0a        // query..
+000b97b0: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
+000b97c0: 7374 6578 7072 2028 7265 7375 6c74 5f74  stexpr (result_t
+000b97d0: 7970 655f 6973 5f61 6461 5f75 726c 2920  ype_is_ada_url) 
+000b97e0: 7b0a 2020 2020 2020 2020 2020 2020 7572  {.            ur
+000b97f0: 6c2e 7573 6572 6e61 6d65 203d 2062 6173  l.username = bas
+000b9800: 655f 7572 6c2d 3e75 7365 726e 616d 653b  e_url->username;
+000b9810: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
+000b9820: 2e70 6173 7377 6f72 6420 3d20 6261 7365  .password = base
+000b9830: 5f75 726c 2d3e 7061 7373 776f 7264 3b0a  _url->password;.
+000b9840: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
+000b9850: 686f 7374 203d 2062 6173 655f 7572 6c2d  host = base_url-
+000b9860: 3e68 6f73 743b 0a20 2020 2020 2020 2020  >host;.         
+000b9870: 2020 2075 726c 2e70 6f72 7420 3d20 6261     url.port = ba
+000b9880: 7365 5f75 726c 2d3e 706f 7274 3b0a 2020  se_url->port;.  
+000b9890: 2020 2020 2020 2020 2020 2f2f 2063 6c6f            // clo
+000b98a0: 6e69 6e67 2074 6865 2062 6173 6520 7061  ning the base pa
+000b98b0: 7468 2069 6e63 6c75 6465 7320 636c 6f6e  th includes clon
+000b98c0: 696e 6720 7468 6520 6861 735f 6f70 6171  ing the has_opaq
+000b98d0: 7565 5f70 6174 6820 666c 6167 0a20 2020  ue_path flag.   
+000b98e0: 2020 2020 2020 2020 2075 726c 2e68 6173           url.has
+000b98f0: 5f6f 7061 7175 655f 7061 7468 203d 2062  _opaque_path = b
+000b9900: 6173 655f 7572 6c2d 3e68 6173 5f6f 7061  ase_url->has_opa
+000b9910: 7175 655f 7061 7468 3b0a 2020 2020 2020  que_path;.      
+000b9920: 2020 2020 2020 7572 6c2e 7061 7468 203d        url.path =
+000b9930: 2062 6173 655f 7572 6c2d 3e70 6174 683b   base_url->path;
+000b9940: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
+000b9950: 2e71 7565 7279 203d 2062 6173 655f 7572  .query = base_ur
+000b9960: 6c2d 3e71 7565 7279 3b0a 2020 2020 2020  l->query;.      
+000b9970: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+000b9980: 2020 2020 2020 2020 2075 726c 2e75 7064           url.upd
+000b9990: 6174 655f 6261 7365 5f61 7574 686f 7269  ate_base_authori
+000b99a0: 7479 2862 6173 655f 7572 6c2d 3e67 6574  ty(base_url->get
+000b99b0: 5f68 7265 6628 292c 0a20 2020 2020 2020  _href(),.       
+000b99c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000b99d0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000b99e0: 6173 655f 7572 6c2d 3e67 6574 5f63 6f6d  ase_url->get_com
+000b99f0: 706f 6e65 6e74 7328 2929 3b0a 2020 2020  ponents());.    
+000b9a00: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
+000b9a10: 2047 6574 2072 6964 206f 6620 7365 745f   Get rid of set_
+000b9a20: 686f 7374 6e61 6d65 2061 6e64 2072 6570  hostname and rep
+000b9a30: 6c61 6365 2069 7420 7769 7468 0a20 2020  lace it with.   
+000b9a40: 2020 2020 2020 2020 202f 2f20 7570 6461           // upda
+000b9a50: 7465 5f62 6173 655f 686f 7374 6e61 6d65  te_base_hostname
+000b9a60: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
+000b9a70: 2e73 6574 5f68 6f73 746e 616d 6528 6261  .set_hostname(ba
+000b9a80: 7365 5f75 726c 2d3e 6765 745f 686f 7374  se_url->get_host
+000b9a90: 6e61 6d65 2829 293b 0a20 2020 2020 2020  name());.       
+000b9aa0: 2020 2020 2075 726c 2e75 7064 6174 655f       url.update_
+000b9ab0: 6261 7365 5f70 6f72 7428 6261 7365 5f75  base_port(base_u
+000b9ac0: 726c 2d3e 7265 7472 6965 7665 5f62 6173  rl->retrieve_bas
+000b9ad0: 655f 706f 7274 2829 293b 0a20 2020 2020  e_port());.     
+000b9ae0: 2020 2020 2020 202f 2f20 636c 6f6e 696e         // clonin
+000b9af0: 6720 7468 6520 6261 7365 2070 6174 6820  g the base path 
+000b9b00: 696e 636c 7564 6573 2063 6c6f 6e69 6e67  includes cloning
+000b9b10: 2074 6865 2068 6173 5f6f 7061 7175 655f   the has_opaque_
+000b9b20: 7061 7468 2066 6c61 670a 2020 2020 2020  path flag.      
+000b9b30: 2020 2020 2020 7572 6c2e 6861 735f 6f70        url.has_op
+000b9b40: 6171 7565 5f70 6174 6820 3d20 6261 7365  aque_path = base
+000b9b50: 5f75 726c 2d3e 6861 735f 6f70 6171 7565  _url->has_opaque
+000b9b60: 5f70 6174 683b 0a20 2020 2020 2020 2020  _path;.         
+000b9b70: 2020 2075 726c 2e75 7064 6174 655f 6261     url.update_ba
+000b9b80: 7365 5f70 6174 686e 616d 6528 6261 7365  se_pathname(base
+000b9b90: 5f75 726c 2d3e 6765 745f 7061 7468 6e61  _url->get_pathna
+000b9ba0: 6d65 2829 293b 0a20 2020 2020 2020 2020  me());.         
+000b9bb0: 2020 2075 726c 2e75 7064 6174 655f 6261     url.update_ba
+000b9bc0: 7365 5f73 6561 7263 6828 6261 7365 5f75  se_search(base_u
+000b9bd0: 726c 2d3e 6765 745f 7365 6172 6368 2829  rl->get_search()
+000b9be0: 293b 0a20 2020 2020 2020 2020 207d 0a0a  );.          }..
+000b9bf0: 2020 2020 2020 2020 2020 7572 6c2e 6861            url.ha
+000b9c00: 735f 6f70 6171 7565 5f70 6174 6820 3d20  s_opaque_path = 
+000b9c10: 6261 7365 5f75 726c 2d3e 6861 735f 6f70  base_url->has_op
+000b9c20: 6171 7565 5f70 6174 683b 0a0a 2020 2020  aque_path;..    
+000b9c30: 2020 2020 2020 2f2f 2049 6620 6320 6973        // If c is
+000b9c40: 2055 2b30 3033 4620 283f 292c 2074 6865   U+003F (?), the
+000b9c50: 6e20 7365 7420 7572 6ce2 8099 7320 7175  n set url...s qu
+000b9c60: 6572 7920 746f 2074 6865 2065 6d70 7479  ery to the empty
+000b9c70: 2073 7472 696e 672c 2061 6e64 0a20 2020   string, and.   
+000b9c80: 2020 2020 2020 202f 2f20 7374 6174 6520         // state 
+000b9c90: 746f 2071 7565 7279 2073 7461 7465 2e0a  to query state..
+000b9ca0: 2020 2020 2020 2020 2020 6966 2028 2869            if ((i
+000b9cb0: 6e70 7574 5f70 6f73 6974 696f 6e20 213d  nput_position !=
+000b9cc0: 2069 6e70 7574 5f73 697a 6529 2026 260a   input_size) &&.
+000b9cd0: 2020 2020 2020 2020 2020 2020 2020 2875                (u
+000b9ce0: 726c 5f64 6174 615b 696e 7075 745f 706f  rl_data[input_po
+000b9cf0: 7369 7469 6f6e 5d20 3d3d 2027 3f27 2929  sition] == '?'))
+000b9d00: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
+000b9d10: 7461 7465 203d 2061 6461 3a3a 7374 6174  tate = ada::stat
+000b9d20: 653a 3a51 5545 5259 3b0a 2020 2020 2020  e::QUERY;.      
+000b9d30: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000b9d40: 2f2f 204f 7468 6572 7769 7365 2c20 6966  // Otherwise, if
+000b9d50: 2063 2069 7320 6e6f 7420 7468 6520 454f   c is not the EO
+000b9d60: 4620 636f 6465 2070 6f69 6e74 3a0a 2020  F code point:.  
+000b9d70: 2020 2020 2020 2020 656c 7365 2069 6620          else if 
+000b9d80: 2869 6e70 7574 5f70 6f73 6974 696f 6e20  (input_position 
+000b9d90: 213d 2069 6e70 7574 5f73 697a 6529 207b  != input_size) {
+000b9da0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000b9db0: 5365 7420 7572 6ce2 8099 7320 7175 6572  Set url...s quer
+000b9dc0: 7920 746f 206e 756c 6c2e 0a20 2020 2020  y to null..     
+000b9dd0: 2020 2020 2020 2075 726c 2e63 6c65 6172         url.clear
+000b9de0: 5f73 6561 7263 6828 293b 0a20 2020 2020  _search();.     
+000b9df0: 2020 2020 2020 2069 6620 636f 6e73 7465         if conste
+000b9e00: 7870 7220 2872 6573 756c 745f 7479 7065  xpr (result_type
+000b9e10: 5f69 735f 6164 615f 7572 6c29 207b 0a20  _is_ada_url) {. 
+000b9e20: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+000b9e30: 5368 6f72 7465 6e20 7572 6ce2 8099 7320  Shorten url...s 
+000b9e40: 7061 7468 2e0a 2020 2020 2020 2020 2020  path..          
+000b9e50: 2020 2020 6865 6c70 6572 733a 3a73 686f      helpers::sho
+000b9e60: 7274 656e 5f70 6174 6828 7572 6c2e 7061  rten_path(url.pa
+000b9e70: 7468 2c20 7572 6c2e 7479 7065 293b 0a20  th, url.type);. 
+000b9e80: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
+000b9e90: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+000b9ea0: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
+000b9eb0: 6577 2070 6174 6820 3d20 7572 6c2e 6765  ew path = url.ge
+000b9ec0: 745f 7061 7468 6e61 6d65 2829 3b0a 2020  t_pathname();.  
+000b9ed0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000b9ee0: 6865 6c70 6572 733a 3a73 686f 7274 656e  helpers::shorten
+000b9ef0: 5f70 6174 6828 7061 7468 2c20 7572 6c2e  _path(path, url.
+000b9f00: 7479 7065 2929 207b 0a20 2020 2020 2020  type)) {.       
+000b9f10: 2020 2020 2020 2020 2075 726c 2e75 7064           url.upd
+000b9f20: 6174 655f 6261 7365 5f70 6174 686e 616d  ate_base_pathnam
+000b9f30: 6528 7374 643a 3a73 7472 696e 6728 7061  e(std::string(pa
+000b9f40: 7468 2929 3b0a 2020 2020 2020 2020 2020  th));.          
+000b9f50: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000b9f60: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000b9f70: 2f2f 2053 6574 2073 7461 7465 2074 6f20  // Set state to 
+000b9f80: 7061 7468 2073 7461 7465 2061 6e64 2064  path state and d
+000b9f90: 6563 7265 6173 6520 706f 696e 7465 7220  ecrease pointer 
+000b9fa0: 6279 2031 2e0a 2020 2020 2020 2020 2020  by 1..          
+000b9fb0: 2020 7374 6174 6520 3d20 6164 613a 3a73    state = ada::s
+000b9fc0: 7461 7465 3a3a 5041 5448 3b0a 2020 2020  tate::PATH;.    
+000b9fd0: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
+000b9fe0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000b9ff0: 2020 207d 0a20 2020 2020 2020 2069 6e70     }.        inp
+000ba000: 7574 5f70 6f73 6974 696f 6e2b 2b3b 0a20  ut_position++;. 
+000ba010: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
+000ba020: 2020 2020 7d0a 2020 2020 2020 6361 7365      }.      case
+000ba030: 2061 6461 3a3a 7374 6174 653a 3a52 454c   ada::state::REL
+000ba040: 4154 4956 455f 534c 4153 483a 207b 0a20  ATIVE_SLASH: {. 
+000ba050: 2020 2020 2020 2061 6461 5f6c 6f67 2822         ada_log("
+000ba060: 5245 4c41 5449 5645 5f53 4c41 5348 2022  RELATIVE_SLASH "
+000ba070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000ba080: 2020 6865 6c70 6572 733a 3a73 7562 7374    helpers::subst
+000ba090: 7269 6e67 2875 726c 5f64 6174 612c 2069  ring(url_data, i
+000ba0a0: 6e70 7574 5f70 6f73 6974 696f 6e29 293b  nput_position));
+000ba0b0: 0a0a 2020 2020 2020 2020 2f2f 2049 6620  ..        // If 
+000ba0c0: 7572 6c20 6973 2073 7065 6369 616c 2061  url is special a
+000ba0d0: 6e64 2063 2069 7320 552b 3030 3246 2028  nd c is U+002F (
+000ba0e0: 2f29 206f 7220 552b 3030 3543 2028 5c29  /) or U+005C (\)
+000ba0f0: 2c20 7468 656e 3a0a 2020 2020 2020 2020  , then:.        
+000ba100: 6966 2028 7572 6c2e 6973 5f73 7065 6369  if (url.is_speci
+000ba110: 616c 2829 2026 2620 2869 6e70 7574 5f70  al() && (input_p
+000ba120: 6f73 6974 696f 6e20 213d 2069 6e70 7574  osition != input
+000ba130: 5f73 697a 6529 2026 260a 2020 2020 2020  _size) &&.      
+000ba140: 2020 2020 2020 2875 726c 5f64 6174 615b        (url_data[
+000ba150: 696e 7075 745f 706f 7369 7469 6f6e 5d20  input_position] 
+000ba160: 3d3d 2027 2f27 207c 7c0a 2020 2020 2020  == '/' ||.      
+000ba170: 2020 2020 2020 2075 726c 5f64 6174 615b         url_data[
+000ba180: 696e 7075 745f 706f 7369 7469 6f6e 5d20  input_position] 
+000ba190: 3d3d 2027 5c5c 2729 2920 7b0a 2020 2020  == '\\')) {.    
+000ba1a0: 2020 2020 2020 2f2f 2053 6574 2073 7461        // Set sta
+000ba1b0: 7465 2074 6f20 7370 6563 6961 6c20 6175  te to special au
+000ba1c0: 7468 6f72 6974 7920 6967 6e6f 7265 2073  thority ignore s
+000ba1d0: 6c61 7368 6573 2073 7461 7465 2e0a 2020  lashes state..  
+000ba1e0: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+000ba1f0: 6164 613a 3a73 7461 7465 3a3a 5350 4543  ada::state::SPEC
+000ba200: 4941 4c5f 4155 5448 4f52 4954 595f 4947  IAL_AUTHORITY_IG
+000ba210: 4e4f 5245 5f53 4c41 5348 4553 3b0a 2020  NORE_SLASHES;.  
+000ba220: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000ba230: 2f2f 204f 7468 6572 7769 7365 2c20 6966  // Otherwise, if
+000ba240: 2063 2069 7320 552b 3030 3246 2028 2f29   c is U+002F (/)
+000ba250: 2c20 7468 656e 2073 6574 2073 7461 7465  , then set state
+000ba260: 2074 6f20 6175 7468 6f72 6974 7920 7374   to authority st
+000ba270: 6174 652e 0a20 2020 2020 2020 2065 6c73  ate..        els
+000ba280: 6520 6966 2028 2869 6e70 7574 5f70 6f73  e if ((input_pos
+000ba290: 6974 696f 6e20 213d 2069 6e70 7574 5f73  ition != input_s
+000ba2a0: 697a 6529 2026 260a 2020 2020 2020 2020  ize) &&.        
+000ba2b0: 2020 2020 2020 2020 2028 7572 6c5f 6461           (url_da
+000ba2c0: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
+000ba2d0: 6e5d 203d 3d20 272f 2729 2920 7b0a 2020  n] == '/')) {.  
+000ba2e0: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+000ba2f0: 6164 613a 3a73 7461 7465 3a3a 4155 5448  ada::state::AUTH
+000ba300: 4f52 4954 593b 0a20 2020 2020 2020 207d  ORITY;.        }
+000ba310: 0a20 2020 2020 2020 202f 2f20 4f74 6865  .        // Othe
+000ba320: 7277 6973 652c 2073 6574 0a20 2020 2020  rwise, set.     
+000ba330: 2020 202f 2f20 2d20 7572 6ce2 8099 7320     // - url...s 
+000ba340: 7573 6572 6e61 6d65 2074 6f20 6261 7365  username to base
+000ba350: e280 9973 2075 7365 726e 616d 652c 0a20  ...s username,. 
+000ba360: 2020 2020 2020 202f 2f20 2d20 7572 6ce2         // - url.
+000ba370: 8099 7320 7061 7373 776f 7264 2074 6f20  ..s password to 
+000ba380: 6261 7365 e280 9973 2070 6173 7377 6f72  base...s passwor
+000ba390: 642c 0a20 2020 2020 2020 202f 2f20 2d20  d,.        // - 
+000ba3a0: 7572 6ce2 8099 7320 686f 7374 2074 6f20  url...s host to 
+000ba3b0: 6261 7365 e280 9973 2068 6f73 742c 0a20  base...s host,. 
+000ba3c0: 2020 2020 2020 202f 2f20 2d20 7572 6ce2         // - url.
+000ba3d0: 8099 7320 706f 7274 2074 6f20 6261 7365  ..s port to base
+000ba3e0: e280 9973 2070 6f72 742c 0a20 2020 2020  ...s port,.     
+000ba3f0: 2020 202f 2f20 2d20 7374 6174 6520 746f     // - state to
+000ba400: 2070 6174 6820 7374 6174 652c 2061 6e64   path state, and
+000ba410: 2074 6865 6e2c 2064 6563 7265 6173 6520   then, decrease 
+000ba420: 706f 696e 7465 7220 6279 2031 2e0a 2020  pointer by 1..  
+000ba430: 2020 2020 2020 656c 7365 207b 0a20 2020        else {.   
+000ba440: 2020 2020 2020 2069 6620 636f 6e73 7465         if conste
+000ba450: 7870 7220 2872 6573 756c 745f 7479 7065  xpr (result_type
+000ba460: 5f69 735f 6164 615f 7572 6c29 207b 0a20  _is_ada_url) {. 
+000ba470: 2020 2020 2020 2020 2020 2075 726c 2e75             url.u
+000ba480: 7365 726e 616d 6520 3d20 6261 7365 5f75  sername = base_u
+000ba490: 726c 2d3e 7573 6572 6e61 6d65 3b0a 2020  rl->username;.  
+000ba4a0: 2020 2020 2020 2020 2020 7572 6c2e 7061            url.pa
+000ba4b0: 7373 776f 7264 203d 2062 6173 655f 7572  ssword = base_ur
+000ba4c0: 6c2d 3e70 6173 7377 6f72 643b 0a20 2020  l->password;.   
+000ba4d0: 2020 2020 2020 2020 2075 726c 2e68 6f73           url.hos
+000ba4e0: 7420 3d20 6261 7365 5f75 726c 2d3e 686f  t = base_url->ho
+000ba4f0: 7374 3b0a 2020 2020 2020 2020 2020 2020  st;.            
+000ba500: 7572 6c2e 706f 7274 203d 2062 6173 655f  url.port = base_
+000ba510: 7572 6c2d 3e70 6f72 743b 0a20 2020 2020  url->port;.     
+000ba520: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+000ba530: 2020 2020 2020 2020 2020 7572 6c2e 7570            url.up
+000ba540: 6461 7465 5f62 6173 655f 6175 7468 6f72  date_base_author
+000ba550: 6974 7928 6261 7365 5f75 726c 2d3e 6765  ity(base_url->ge
+000ba560: 745f 6872 6566 2829 2c0a 2020 2020 2020  t_href(),.      
+000ba570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000ba580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000ba590: 6261 7365 5f75 726c 2d3e 6765 745f 636f  base_url->get_co
+000ba5a0: 6d70 6f6e 656e 7473 2829 293b 0a20 2020  mponents());.   
+000ba5b0: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
+000ba5c0: 3a20 4765 7420 7269 6420 6f66 2073 6574  : Get rid of set
+000ba5d0: 5f68 6f73 746e 616d 6520 616e 6420 7265  _hostname and re
+000ba5e0: 706c 6163 6520 6974 2077 6974 680a 2020  place it with.  
+000ba5f0: 2020 2020 2020 2020 2020 2f2f 2075 7064            // upd
+000ba600: 6174 655f 6261 7365 5f68 6f73 746e 616d  ate_base_hostnam
+000ba610: 650a 2020 2020 2020 2020 2020 2020 7572  e.            ur
+000ba620: 6c2e 7365 745f 686f 7374 6e61 6d65 2862  l.set_hostname(b
+000ba630: 6173 655f 7572 6c2d 3e67 6574 5f68 6f73  ase_url->get_hos
+000ba640: 746e 616d 6528 2929 3b0a 2020 2020 2020  tname());.      
+000ba650: 2020 2020 2020 7572 6c2e 7570 6461 7465        url.update
+000ba660: 5f62 6173 655f 706f 7274 2862 6173 655f  _base_port(base_
+000ba670: 7572 6c2d 3e72 6574 7269 6576 655f 6261  url->retrieve_ba
+000ba680: 7365 5f70 6f72 7428 2929 3b0a 2020 2020  se_port());.    
+000ba690: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000ba6a0: 2020 7374 6174 6520 3d20 6164 613a 3a73    state = ada::s
+000ba6b0: 7461 7465 3a3a 5041 5448 3b0a 2020 2020  tate::PATH;.    
+000ba6c0: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
+000ba6d0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000ba6e0: 696e 7075 745f 706f 7369 7469 6f6e 2b2b  input_position++
+000ba6f0: 3b0a 2020 2020 2020 2020 6272 6561 6b3b  ;.        break;
+000ba700: 0a20 2020 2020 207d 0a20 2020 2020 2063  .      }.      c
+000ba710: 6173 6520 6164 613a 3a73 7461 7465 3a3a  ase ada::state::
+000ba720: 5350 4543 4941 4c5f 4155 5448 4f52 4954  SPECIAL_AUTHORIT
+000ba730: 595f 534c 4153 4845 533a 207b 0a20 2020  Y_SLASHES: {.   
+000ba740: 2020 2020 2061 6461 5f6c 6f67 2822 5350       ada_log("SP
+000ba750: 4543 4941 4c5f 4155 5448 4f52 4954 595f  ECIAL_AUTHORITY_
+000ba760: 534c 4153 4845 5320 222c 0a20 2020 2020  SLASHES ",.     
+000ba770: 2020 2020 2020 2020 2020 2068 656c 7065             helpe
+000ba780: 7273 3a3a 7375 6273 7472 696e 6728 7572  rs::substring(ur
+000ba790: 6c5f 6461 7461 2c20 696e 7075 745f 706f  l_data, input_po
+000ba7a0: 7369 7469 6f6e 2929 3b0a 0a20 2020 2020  sition));..     
+000ba7b0: 2020 202f 2f20 4966 2063 2069 7320 552b     // If c is U+
+000ba7c0: 3030 3246 2028 2f29 2061 6e64 2072 656d  002F (/) and rem
+000ba7d0: 6169 6e69 6e67 2073 7461 7274 7320 7769  aining starts wi
+000ba7e0: 7468 2055 2b30 3032 4620 282f 292c 0a20  th U+002F (/),. 
+000ba7f0: 2020 2020 2020 202f 2f20 7468 656e 2073         // then s
+000ba800: 6574 2073 7461 7465 2074 6f20 7370 6563  et state to spec
+000ba810: 6961 6c20 6175 7468 6f72 6974 7920 6967  ial authority ig
+000ba820: 6e6f 7265 2073 6c61 7368 6573 2073 7461  nore slashes sta
+000ba830: 7465 2061 6e64 2069 6e63 7265 6173 650a  te and increase.
+000ba840: 2020 2020 2020 2020 2f2f 2070 6f69 6e74          // point
+000ba850: 6572 2062 7920 312e 0a20 2020 2020 2020  er by 1..       
+000ba860: 2073 7461 7465 203d 2061 6461 3a3a 7374   state = ada::st
+000ba870: 6174 653a 3a53 5045 4349 414c 5f41 5554  ate::SPECIAL_AUT
+000ba880: 484f 5249 5459 5f49 474e 4f52 455f 534c  HORITY_IGNORE_SL
+000ba890: 4153 4845 533b 0a20 2020 2020 2020 2073  ASHES;.        s
+000ba8a0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000ba8b0: 7669 6577 203d 2068 656c 7065 7273 3a3a  view = helpers::
+000ba8c0: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000ba8d0: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000ba8e0: 6f6e 293b 0a20 2020 2020 2020 2069 6620  on);.        if 
+000ba8f0: 2861 6461 3a3a 6368 6563 6b65 7273 3a3a  (ada::checkers::
+000ba900: 6265 6769 6e73 5f77 6974 6828 7669 6577  begins_with(view
+000ba910: 2c20 222f 2f22 2929 207b 0a20 2020 2020  , "//")) {.     
+000ba920: 2020 2020 2069 6e70 7574 5f70 6f73 6974       input_posit
+000ba930: 696f 6e20 2b3d 2032 3b0a 2020 2020 2020  ion += 2;.      
+000ba940: 2020 7d0a 0a20 2020 2020 2020 205b 5b66    }..        [[f
+000ba950: 616c 6c74 6872 6f75 6768 5d5d 3b0a 2020  allthrough]];.  
+000ba960: 2020 2020 7d0a 2020 2020 2020 6361 7365      }.      case
+000ba970: 2061 6461 3a3a 7374 6174 653a 3a53 5045   ada::state::SPE
+000ba980: 4349 414c 5f41 5554 484f 5249 5459 5f49  CIAL_AUTHORITY_I
+000ba990: 474e 4f52 455f 534c 4153 4845 533a 207b  GNORE_SLASHES: {
+000ba9a0: 0a20 2020 2020 2020 2061 6461 5f6c 6f67  .        ada_log
+000ba9b0: 2822 5350 4543 4941 4c5f 4155 5448 4f52  ("SPECIAL_AUTHOR
+000ba9c0: 4954 595f 4947 4e4f 5245 5f53 4c41 5348  ITY_IGNORE_SLASH
+000ba9d0: 4553 2022 2c0a 2020 2020 2020 2020 2020  ES ",.          
+000ba9e0: 2020 2020 2020 6865 6c70 6572 733a 3a73        helpers::s
+000ba9f0: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
+000baa00: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
+000baa10: 6e29 293b 0a0a 2020 2020 2020 2020 2f2f  n));..        //
+000baa20: 2049 6620 6320 6973 206e 6569 7468 6572   If c is neither
+000baa30: 2055 2b30 3032 4620 282f 2920 6e6f 7220   U+002F (/) nor 
+000baa40: 552b 3030 3543 2028 5c29 2c20 7468 656e  U+005C (\), then
+000baa50: 2073 6574 2073 7461 7465 2074 6f0a 2020   set state to.  
+000baa60: 2020 2020 2020 2f2f 2061 7574 686f 7269        // authori
+000baa70: 7479 2073 7461 7465 2061 6e64 2064 6563  ty state and dec
+000baa80: 7265 6173 6520 706f 696e 7465 7220 6279  rease pointer by
+000baa90: 2031 2e0a 2020 2020 2020 2020 7768 696c   1..        whil
+000baaa0: 6520 2828 696e 7075 745f 706f 7369 7469  e ((input_positi
+000baab0: 6f6e 2021 3d20 696e 7075 745f 7369 7a65  on != input_size
+000baac0: 2920 2626 0a20 2020 2020 2020 2020 2020  ) &&.           
+000baad0: 2020 2020 2828 7572 6c5f 6461 7461 5b69      ((url_data[i
+000baae0: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
+000baaf0: 3d20 272f 2729 207c 7c0a 2020 2020 2020  = '/') ||.      
+000bab00: 2020 2020 2020 2020 2020 2875 726c 5f64            (url_d
+000bab10: 6174 615b 696e 7075 745f 706f 7369 7469  ata[input_positi
+000bab20: 6f6e 5d20 3d3d 2027 5c5c 2729 2929 207b  on] == '\\'))) {
+000bab30: 0a20 2020 2020 2020 2020 2069 6e70 7574  .          input
+000bab40: 5f70 6f73 6974 696f 6e2b 2b3b 0a20 2020  _position++;.   
+000bab50: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
+000bab60: 7461 7465 203d 2061 6461 3a3a 7374 6174  tate = ada::stat
+000bab70: 653a 3a41 5554 484f 5249 5459 3b0a 0a20  e::AUTHORITY;.. 
+000bab80: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
+000bab90: 2020 2020 7d0a 2020 2020 2020 6361 7365      }.      case
+000baba0: 2061 6461 3a3a 7374 6174 653a 3a51 5545   ada::state::QUE
+000babb0: 5259 3a20 7b0a 2020 2020 2020 2020 6164  RY: {.        ad
+000babc0: 615f 6c6f 6728 2251 5545 5259 2022 2c20  a_log("QUERY ", 
+000babd0: 6865 6c70 6572 733a 3a73 7562 7374 7269  helpers::substri
+000babe0: 6e67 2875 726c 5f64 6174 612c 2069 6e70  ng(url_data, inp
+000babf0: 7574 5f70 6f73 6974 696f 6e29 293b 0a20  ut_position));. 
+000bac00: 2020 2020 2020 202f 2f20 4c65 7420 7175         // Let qu
+000bac10: 6572 7950 6572 6365 6e74 456e 636f 6465  eryPercentEncode
+000bac20: 5365 7420 6265 2074 6865 2073 7065 6369  Set be the speci
+000bac30: 616c 2d71 7565 7279 2070 6572 6365 6e74  al-query percent
+000bac40: 2d65 6e63 6f64 6520 7365 7420 6966 0a20  -encode set if. 
+000bac50: 2020 2020 2020 202f 2f20 7572 6c20 6973         // url is
+000bac60: 2073 7065 6369 616c 3b20 6f74 6865 7277   special; otherw
+000bac70: 6973 6520 7468 6520 7175 6572 7920 7065  ise the query pe
+000bac80: 7263 656e 742d 656e 636f 6465 2073 6574  rcent-encode set
+000bac90: 2e0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+000baca0: 7569 6e74 385f 742a 2071 7565 7279 5f70  uint8_t* query_p
+000bacb0: 6572 6365 6e74 5f65 6e63 6f64 655f 7365  ercent_encode_se
+000bacc0: 7420 3d0a 2020 2020 2020 2020 2020 2020  t =.            
+000bacd0: 7572 6c2e 6973 5f73 7065 6369 616c 2829  url.is_special()
+000bace0: 203f 2061 6461 3a3a 6368 6172 6163 7465   ? ada::characte
+000bacf0: 725f 7365 7473 3a3a 5350 4543 4941 4c5f  r_sets::SPECIAL_
+000bad00: 5155 4552 595f 5045 5243 454e 545f 454e  QUERY_PERCENT_EN
+000bad10: 434f 4445 0a20 2020 2020 2020 2020 2020  CODE.           
+000bad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bad30: 2020 3a20 6164 613a 3a63 6861 7261 6374    : ada::charact
+000bad40: 6572 5f73 6574 733a 3a51 5545 5259 5f50  er_sets::QUERY_P
+000bad50: 4552 4345 4e54 5f45 4e43 4f44 453b 0a0a  ERCENT_ENCODE;..
+000bad60: 2020 2020 2020 2020 2f2f 2050 6572 6365          // Perce
+000bad70: 6e74 2d65 6e63 6f64 6520 6166 7465 7220  nt-encode after 
+000bad80: 656e 636f 6469 6e67 2c20 7769 7468 2065  encoding, with e
+000bad90: 6e63 6f64 696e 672c 2062 7566 6665 722c  ncoding, buffer,
+000bada0: 2061 6e64 0a20 2020 2020 2020 202f 2f20   and.        // 
+000badb0: 7175 6572 7950 6572 6365 6e74 456e 636f  queryPercentEnco
+000badc0: 6465 5365 742c 2061 6e64 2061 7070 656e  deSet, and appen
+000badd0: 6420 7468 6520 7265 7375 6c74 2074 6f20  d the result to 
+000bade0: 7572 6ce2 8099 7320 7175 6572 792e 0a20  url...s query.. 
+000badf0: 2020 2020 2020 2075 726c 2e75 7064 6174         url.updat
+000bae00: 655f 6261 7365 5f73 6561 7263 6828 6865  e_base_search(he
+000bae10: 6c70 6572 733a 3a73 7562 7374 7269 6e67  lpers::substring
+000bae20: 2875 726c 5f64 6174 612c 2069 6e70 7574  (url_data, input
+000bae30: 5f70 6f73 6974 696f 6e29 2c0a 2020 2020  _position),.    
+000bae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bae50: 2020 2020 2020 2020 2020 2071 7565 7279             query
+000bae60: 5f70 6572 6365 6e74 5f65 6e63 6f64 655f  _percent_encode_
+000bae70: 7365 7429 3b0a 2020 2020 2020 2020 6164  set);.        ad
+000bae80: 615f 6c6f 6728 2251 5545 5259 2075 7064  a_log("QUERY upd
+000bae90: 6174 655f 6261 7365 5f73 6561 7263 6820  ate_base_search 
+000baea0: 636f 6d70 6c65 7465 6420 2229 3b0a 2020  completed ");.  
+000baeb0: 2020 2020 2020 6966 2028 6672 6167 6d65        if (fragme
+000baec0: 6e74 2e68 6173 5f76 616c 7565 2829 2920  nt.has_value()) 
+000baed0: 7b0a 2020 2020 2020 2020 2020 7572 6c2e  {.          url.
+000baee0: 7570 6461 7465 5f75 6e65 6e63 6f64 6564  update_unencoded
+000baef0: 5f62 6173 655f 6861 7368 282a 6672 6167  _base_hash(*frag
+000baf00: 6d65 6e74 293b 0a20 2020 2020 2020 207d  ment);.        }
+000baf10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000baf20: 7572 6c3b 0a20 2020 2020 207d 0a20 2020  url;.      }.   
+000baf30: 2020 2063 6173 6520 6164 613a 3a73 7461     case ada::sta
+000baf40: 7465 3a3a 484f 5354 3a20 7b0a 2020 2020  te::HOST: {.    
+000baf50: 2020 2020 6164 615f 6c6f 6728 2248 4f53      ada_log("HOS
+000baf60: 5420 222c 2068 656c 7065 7273 3a3a 7375  T ", helpers::su
+000baf70: 6273 7472 696e 6728 7572 6c5f 6461 7461  bstring(url_data
+000baf80: 2c20 696e 7075 745f 706f 7369 7469 6f6e  , input_position
+000baf90: 2929 3b0a 0a20 2020 2020 2020 2073 7464  ));..        std
+000bafa0: 3a3a 7374 7269 6e67 5f76 6965 7720 686f  ::string_view ho
+000bafb0: 7374 5f76 6965 7720 3d0a 2020 2020 2020  st_view =.      
+000bafc0: 2020 2020 2020 6865 6c70 6572 733a 3a73        helpers::s
+000bafd0: 7562 7374 7269 6e67 2875 726c 5f64 6174  ubstring(url_dat
+000bafe0: 612c 2069 6e70 7574 5f70 6f73 6974 696f  a, input_positio
+000baff0: 6e29 3b0a 2020 2020 2020 2020 6175 746f  n);.        auto
+000bb000: 205b 6c6f 6361 7469 6f6e 2c20 666f 756e   [location, foun
+000bb010: 645f 636f 6c6f 6e5d 203d 0a20 2020 2020  d_colon] =.     
+000bb020: 2020 2020 2020 2068 656c 7065 7273 3a3a         helpers::
+000bb030: 6765 745f 686f 7374 5f64 656c 696d 6974  get_host_delimit
+000bb040: 6572 5f6c 6f63 6174 696f 6e28 7572 6c2e  er_location(url.
+000bb050: 6973 5f73 7065 6369 616c 2829 2c20 686f  is_special(), ho
+000bb060: 7374 5f76 6965 7729 3b0a 2020 2020 2020  st_view);.      
+000bb070: 2020 696e 7075 745f 706f 7369 7469 6f6e    input_position
+000bb080: 203d 2028 6c6f 6361 7469 6f6e 2021 3d20   = (location != 
+000bb090: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000bb0a0: 3a3a 6e70 6f73 290a 2020 2020 2020 2020  ::npos).        
+000bb0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bb0c0: 2020 2020 203f 2069 6e70 7574 5f70 6f73       ? input_pos
+000bb0d0: 6974 696f 6e20 2b20 6c6f 6361 7469 6f6e  ition + location
+000bb0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000bb0f0: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
+000bb100: 696e 7075 745f 7369 7a65 3b0a 2020 2020  input_size;.    
+000bb110: 2020 2020 2f2f 204f 7468 6572 7769 7365      // Otherwise
+000bb120: 2c20 6966 2063 2069 7320 552b 3030 3341  , if c is U+003A
+000bb130: 2028 3a29 2061 6e64 2069 6e73 6964 6542   (:) and insideB
+000bb140: 7261 636b 6574 7320 6973 2066 616c 7365  rackets is false
+000bb150: 2c20 7468 656e 3a0a 2020 2020 2020 2020  , then:.        
+000bb160: 2f2f 204e 6f74 653a 2074 6865 2027 666f  // Note: the 'fo
+000bb170: 756e 645f 636f 6c6f 6e27 2076 616c 7565  und_colon' value
+000bb180: 2069 7320 7472 7565 2069 6620 616e 6420   is true if and 
+000bb190: 6f6e 6c79 2069 6620 6120 636f 6c6f 6e20  only if a colon 
+000bb1a0: 7761 730a 2020 2020 2020 2020 2f2f 2065  was.        // e
+000bb1b0: 6e63 6f75 6e74 6572 6564 2077 6869 6c65  ncountered while
+000bb1c0: 206e 6f74 2069 6e73 6964 6520 6272 6163   not inside brac
+000bb1d0: 6b65 7473 2e0a 2020 2020 2020 2020 6966  kets..        if
+000bb1e0: 2028 666f 756e 645f 636f 6c6f 6e29 207b   (found_colon) {
+000bb1f0: 0a20 2020 2020 2020 2020 202f 2f20 4966  .          // If
+000bb200: 2062 7566 6665 7220 6973 2074 6865 2065   buffer is the e
+000bb210: 6d70 7479 2073 7472 696e 672c 2076 616c  mpty string, val
+000bb220: 6964 6174 696f 6e20 6572 726f 722c 2072  idation error, r
+000bb230: 6574 7572 6e20 6661 696c 7572 652e 0a20  eturn failure.. 
+000bb240: 2020 2020 2020 2020 202f 2f20 4c65 7420           // Let 
+000bb250: 686f 7374 2062 6520 7468 6520 7265 7375  host be the resu
+000bb260: 6c74 206f 6620 686f 7374 2070 6172 7369  lt of host parsi
+000bb270: 6e67 2062 7566 6665 7220 7769 7468 2075  ng buffer with u
+000bb280: 726c 2069 7320 6e6f 740a 2020 2020 2020  rl is not.      
+000bb290: 2020 2020 2f2f 2073 7065 6369 616c 2e0a      // special..
+000bb2a0: 2020 2020 2020 2020 2020 6164 615f 6c6f            ada_lo
+000bb2b0: 6728 2248 4f53 5420 7061 7273 696e 6720  g("HOST parsing 
+000bb2c0: 222c 2068 6f73 745f 7669 6577 293b 0a20  ", host_view);. 
+000bb2d0: 2020 2020 2020 2020 2069 6620 2821 7572           if (!ur
+000bb2e0: 6c2e 7061 7273 655f 686f 7374 2868 6f73  l.parse_host(hos
+000bb2f0: 745f 7669 6577 2929 207b 0a20 2020 2020  t_view)) {.     
+000bb300: 2020 2020 2020 2072 6574 7572 6e20 7572         return ur
+000bb310: 6c3b 0a20 2020 2020 2020 2020 207d 0a20  l;.          }. 
+000bb320: 2020 2020 2020 2020 2061 6461 5f6c 6f67           ada_log
+000bb330: 2822 484f 5354 2070 6172 7369 6e67 2072  ("HOST parsing r
+000bb340: 6573 756c 7473 2069 6e20 222c 2075 726c  esults in ", url
+000bb350: 2e67 6574 5f68 6f73 746e 616d 6528 2929  .get_hostname())
+000bb360: 3b0a 2020 2020 2020 2020 2020 2f2f 2053  ;.          // S
+000bb370: 6574 2075 726c e280 9973 2068 6f73 7420  et url...s host 
+000bb380: 746f 2068 6f73 742c 2062 7566 6665 7220  to host, buffer 
+000bb390: 746f 2074 6865 2065 6d70 7479 2073 7472  to the empty str
+000bb3a0: 696e 672c 2061 6e64 2073 7461 7465 2074  ing, and state t
+000bb3b0: 6f0a 2020 2020 2020 2020 2020 2f2f 2070  o.          // p
+000bb3c0: 6f72 7420 7374 6174 652e 0a20 2020 2020  ort state..     
+000bb3d0: 2020 2020 2073 7461 7465 203d 2061 6461       state = ada
+000bb3e0: 3a3a 7374 6174 653a 3a50 4f52 543b 0a20  ::state::PORT;. 
+000bb3f0: 2020 2020 2020 2020 2069 6e70 7574 5f70           input_p
+000bb400: 6f73 6974 696f 6e2b 2b3b 0a20 2020 2020  osition++;.     
+000bb410: 2020 207d 0a20 2020 2020 2020 202f 2f20     }.        // 
+000bb420: 4f74 6865 7277 6973 652c 2069 6620 6f6e  Otherwise, if on
+000bb430: 6520 6f66 2074 6865 2066 6f6c 6c6f 7769  e of the followi
+000bb440: 6e67 2069 7320 7472 7565 3a0a 2020 2020  ng is true:.    
+000bb450: 2020 2020 2f2f 202d 2063 2069 7320 7468      // - c is th
+000bb460: 6520 454f 4620 636f 6465 2070 6f69 6e74  e EOF code point
+000bb470: 2c20 552b 3030 3246 2028 2f29 2c20 552b  , U+002F (/), U+
+000bb480: 3030 3346 2028 3f29 2c20 6f72 2055 2b30  003F (?), or U+0
+000bb490: 3032 3320 2823 290a 2020 2020 2020 2020  023 (#).        
+000bb4a0: 2f2f 202d 2075 726c 2069 7320 7370 6563  // - url is spec
+000bb4b0: 6961 6c20 616e 6420 6320 6973 2055 2b30  ial and c is U+0
+000bb4c0: 3035 4320 285c 290a 2020 2020 2020 2020  05C (\).        
+000bb4d0: 2f2f 2054 6865 2067 6574 5f68 6f73 745f  // The get_host_
+000bb4e0: 6465 6c69 6d69 7465 725f 6c6f 6361 7469  delimiter_locati
+000bb4f0: 6f6e 2066 756e 6374 696f 6e20 6569 7468  on function eith
+000bb500: 6572 2062 7269 6e67 7320 7573 2074 6f0a  er brings us to.
+000bb510: 2020 2020 2020 2020 2f2f 2074 6865 2063          // the c
+000bb520: 6f6c 6f6e 206f 7574 7369 6465 206f 6620  olon outside of 
+000bb530: 7468 6520 6272 6163 6b65 742c 206f 7220  the bracket, or 
+000bb540: 746f 206f 6e65 206f 6620 7468 6f73 6520  to one of those 
+000bb550: 6368 6172 6163 7465 7273 2e0a 2020 2020  characters..    
+000bb560: 2020 2020 656c 7365 207b 0a20 2020 2020      else {.     
+000bb570: 2020 2020 202f 2f20 4966 2075 726c 2069       // If url i
+000bb580: 7320 7370 6563 6961 6c20 616e 6420 686f  s special and ho
+000bb590: 7374 5f76 6965 7720 6973 2074 6865 2065  st_view is the e
+000bb5a0: 6d70 7479 2073 7472 696e 672c 2076 616c  mpty string, val
+000bb5b0: 6964 6174 696f 6e0a 2020 2020 2020 2020  idation.        
+000bb5c0: 2020 2f2f 2065 7272 6f72 2c20 7265 7475    // error, retu
+000bb5d0: 726e 2066 6169 6c75 7265 2e0a 2020 2020  rn failure..    
+000bb5e0: 2020 2020 2020 6966 2028 7572 6c2e 6973        if (url.is
+000bb5f0: 5f73 7065 6369 616c 2829 2026 2620 686f  _special() && ho
+000bb600: 7374 5f76 6965 772e 656d 7074 7928 2929  st_view.empty())
+000bb610: 207b 0a20 2020 2020 2020 2020 2020 2075   {.            u
+000bb620: 726c 2e69 735f 7661 6c69 6420 3d20 6661  rl.is_valid = fa
+000bb630: 6c73 653b 0a20 2020 2020 2020 2020 2020  lse;.           
+000bb640: 2072 6574 7572 6e20 7572 6c3b 0a20 2020   return url;.   
+000bb650: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000bb660: 2020 2061 6461 5f6c 6f67 2822 484f 5354     ada_log("HOST
+000bb670: 2070 6172 7369 6e67 2022 2c20 686f 7374   parsing ", host
+000bb680: 5f76 6965 772c 2022 2068 7265 663d 222c  _view, " href=",
+000bb690: 2075 726c 2e67 6574 5f68 7265 6628 2929   url.get_href())
+000bb6a0: 3b0a 2020 2020 2020 2020 2020 2f2f 204c  ;.          // L
+000bb6b0: 6574 2068 6f73 7420 6265 2074 6865 2072  et host be the r
+000bb6c0: 6573 756c 7420 6f66 2068 6f73 7420 7061  esult of host pa
+000bb6d0: 7273 696e 6720 686f 7374 5f76 6965 7720  rsing host_view 
+000bb6e0: 7769 7468 2075 726c 2069 7320 6e6f 740a  with url is not.
+000bb6f0: 2020 2020 2020 2020 2020 2f2f 2073 7065            // spe
+000bb700: 6369 616c 2e0a 2020 2020 2020 2020 2020  cial..          
+000bb710: 6966 2028 686f 7374 5f76 6965 772e 656d  if (host_view.em
+000bb720: 7074 7928 2929 207b 0a20 2020 2020 2020  pty()) {.       
+000bb730: 2020 2020 2075 726c 2e75 7064 6174 655f       url.update_
+000bb740: 6261 7365 5f68 6f73 746e 616d 6528 2222  base_hostname(""
+000bb750: 293b 0a20 2020 2020 2020 2020 207d 2065  );.          } e
+000bb760: 6c73 6520 6966 2028 2175 726c 2e70 6172  lse if (!url.par
+000bb770: 7365 5f68 6f73 7428 686f 7374 5f76 6965  se_host(host_vie
+000bb780: 7729 2920 7b0a 2020 2020 2020 2020 2020  w)) {.          
+000bb790: 2020 7265 7475 726e 2075 726c 3b0a 2020    return url;.  
+000bb7a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000bb7b0: 2020 2020 6164 615f 6c6f 6728 2248 4f53      ada_log("HOS
+000bb7c0: 5420 7061 7273 696e 6720 7265 7375 6c74  T parsing result
+000bb7d0: 7320 696e 2022 2c20 7572 6c2e 6765 745f  s in ", url.get_
+000bb7e0: 686f 7374 6e61 6d65 2829 2c0a 2020 2020  hostname(),.    
+000bb7f0: 2020 2020 2020 2020 2020 2020 2020 2220                " 
+000bb800: 6872 6566 3d22 2c20 7572 6c2e 6765 745f  href=", url.get_
+000bb810: 6872 6566 2829 293b 0a0a 2020 2020 2020  href());..      
+000bb820: 2020 2020 2f2f 2053 6574 2075 726c e280      // Set url..
+000bb830: 9973 2068 6f73 7420 746f 2068 6f73 742c  .s host to host,
+000bb840: 2061 6e64 2073 7461 7465 2074 6f20 7061   and state to pa
+000bb850: 7468 2073 7461 7274 2073 7461 7465 2e0a  th start state..
+000bb860: 2020 2020 2020 2020 2020 7374 6174 6520            state 
+000bb870: 3d20 6164 613a 3a73 7461 7465 3a3a 5041  = ada::state::PA
+000bb880: 5448 5f53 5441 5254 3b0a 2020 2020 2020  TH_START;.      
+000bb890: 2020 7d0a 0a20 2020 2020 2020 2062 7265    }..        bre
+000bb8a0: 616b 3b0a 2020 2020 2020 7d0a 2020 2020  ak;.      }.    
+000bb8b0: 2020 6361 7365 2061 6461 3a3a 7374 6174    case ada::stat
+000bb8c0: 653a 3a4f 5041 5155 455f 5041 5448 3a20  e::OPAQUE_PATH: 
+000bb8d0: 7b0a 2020 2020 2020 2020 6164 615f 6c6f  {.        ada_lo
+000bb8e0: 6728 224f 5041 5155 455f 5041 5448 2022  g("OPAQUE_PATH "
+000bb8f0: 2c20 6865 6c70 6572 733a 3a73 7562 7374  , helpers::subst
+000bb900: 7269 6e67 2875 726c 5f64 6174 612c 2069  ring(url_data, i
+000bb910: 6e70 7574 5f70 6f73 6974 696f 6e29 293b  nput_position));
+000bb920: 0a20 2020 2020 2020 2073 7464 3a3a 7374  .        std::st
+000bb930: 7269 6e67 5f76 6965 7720 7669 6577 203d  ring_view view =
+000bb940: 2068 656c 7065 7273 3a3a 7375 6273 7472   helpers::substr
+000bb950: 696e 6728 7572 6c5f 6461 7461 2c20 696e  ing(url_data, in
+000bb960: 7075 745f 706f 7369 7469 6f6e 293b 0a20  put_position);. 
+000bb970: 2020 2020 2020 202f 2f20 4966 2063 2069         // If c i
+000bb980: 7320 552b 3030 3346 2028 3f29 2c20 7468  s U+003F (?), th
+000bb990: 656e 2073 6574 2075 726c e280 9973 2071  en set url...s q
+000bb9a0: 7565 7279 2074 6f20 7468 6520 656d 7074  uery to the empt
+000bb9b0: 7920 7374 7269 6e67 2061 6e64 0a20 2020  y string and.   
+000bb9c0: 2020 2020 202f 2f20 7374 6174 6520 746f       // state to
+000bb9d0: 2071 7565 7279 2073 7461 7465 2e0a 2020   query state..  
+000bb9e0: 2020 2020 2020 7369 7a65 5f74 206c 6f63        size_t loc
+000bb9f0: 6174 696f 6e20 3d20 7669 6577 2e66 696e  ation = view.fin
+000bba00: 6428 273f 2729 3b0a 2020 2020 2020 2020  d('?');.        
+000bba10: 6966 2028 6c6f 6361 7469 6f6e 2021 3d20  if (location != 
+000bba20: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000bba30: 3a3a 6e70 6f73 2920 7b0a 2020 2020 2020  ::npos) {.      
+000bba40: 2020 2020 7669 6577 2e72 656d 6f76 655f      view.remove_
+000bba50: 7375 6666 6978 2876 6965 772e 7369 7a65  suffix(view.size
+000bba60: 2829 202d 206c 6f63 6174 696f 6e29 3b0a  () - location);.
+000bba70: 2020 2020 2020 2020 2020 7374 6174 6520            state 
+000bba80: 3d20 6164 613a 3a73 7461 7465 3a3a 5155  = ada::state::QU
+000bba90: 4552 593b 0a20 2020 2020 2020 2020 2069  ERY;.          i
+000bbaa0: 6e70 7574 5f70 6f73 6974 696f 6e20 2b3d  nput_position +=
+000bbab0: 206c 6f63 6174 696f 6e20 2b20 313b 0a20   location + 1;. 
+000bbac0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+000bbad0: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+000bbae0: 706f 7369 7469 6f6e 203d 2069 6e70 7574  position = input
+000bbaf0: 5f73 697a 6520 2b20 313b 0a20 2020 2020  _size + 1;.     
+000bbb00: 2020 207d 0a20 2020 2020 2020 2075 726c     }.        url
+000bbb10: 2e68 6173 5f6f 7061 7175 655f 7061 7468  .has_opaque_path
+000bbb20: 203d 2074 7275 653b 0a20 2020 2020 2020   = true;.       
+000bbb30: 202f 2f20 5468 6973 2069 7320 6120 7265   // This is a re
+000bbb40: 616c 6c79 2075 6e6c 696b 656c 7920 7363  ally unlikely sc
+000bbb50: 656e 6172 696f 2069 6e20 7265 616c 2077  enario in real w
+000bbb60: 6f72 6c64 2e20 5765 2073 686f 756c 6420  orld. We should 
+000bbb70: 6e6f 7420 7365 656b 0a20 2020 2020 2020  not seek.       
+000bbb80: 202f 2f20 746f 206f 7074 696d 697a 6520   // to optimize 
+000bbb90: 6974 2e0a 2020 2020 2020 2020 7572 6c2e  it..        url.
+000bbba0: 7570 6461 7465 5f62 6173 655f 7061 7468  update_base_path
+000bbbb0: 6e61 6d65 2875 6e69 636f 6465 3a3a 7065  name(unicode::pe
+000bbbc0: 7263 656e 745f 656e 636f 6465 280a 2020  rcent_encode(.  
+000bbbd0: 2020 2020 2020 2020 2020 7669 6577 2c20            view, 
+000bbbe0: 6368 6172 6163 7465 725f 7365 7473 3a3a  character_sets::
+000bbbf0: 4330 5f43 4f4e 5452 4f4c 5f50 4552 4345  C0_CONTROL_PERCE
+000bbc00: 4e54 5f45 4e43 4f44 4529 293b 0a20 2020  NT_ENCODE));.   
+000bbc10: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
+000bbc20: 2020 7d0a 2020 2020 2020 6361 7365 2061    }.      case a
+000bbc30: 6461 3a3a 7374 6174 653a 3a50 4f52 543a  da::state::PORT:
+000bbc40: 207b 0a20 2020 2020 2020 2061 6461 5f6c   {.        ada_l
+000bbc50: 6f67 2822 504f 5254 2022 2c20 6865 6c70  og("PORT ", help
+000bbc60: 6572 733a 3a73 7562 7374 7269 6e67 2875  ers::substring(u
+000bbc70: 726c 5f64 6174 612c 2069 6e70 7574 5f70  rl_data, input_p
+000bbc80: 6f73 6974 696f 6e29 293b 0a20 2020 2020  osition));.     
+000bbc90: 2020 2073 7464 3a3a 7374 7269 6e67 5f76     std::string_v
+000bbca0: 6965 7720 706f 7274 5f76 6965 7720 3d0a  iew port_view =.
+000bbcb0: 2020 2020 2020 2020 2020 2020 6865 6c70              help
+000bbcc0: 6572 733a 3a73 7562 7374 7269 6e67 2875  ers::substring(u
+000bbcd0: 726c 5f64 6174 612c 2069 6e70 7574 5f70  rl_data, input_p
+000bbce0: 6f73 6974 696f 6e29 3b0a 2020 2020 2020  osition);.      
+000bbcf0: 2020 7369 7a65 5f74 2063 6f6e 7375 6d65    size_t consume
+000bbd00: 645f 6279 7465 7320 3d20 7572 6c2e 7061  d_bytes = url.pa
+000bbd10: 7273 655f 706f 7274 2870 6f72 745f 7669  rse_port(port_vi
+000bbd20: 6577 2c20 7472 7565 293b 0a20 2020 2020  ew, true);.     
+000bbd30: 2020 2069 6e70 7574 5f70 6f73 6974 696f     input_positio
+000bbd40: 6e20 2b3d 2063 6f6e 7375 6d65 645f 6279  n += consumed_by
+000bbd50: 7465 733b 0a20 2020 2020 2020 2069 6620  tes;.        if 
+000bbd60: 2821 7572 6c2e 6973 5f76 616c 6964 2920  (!url.is_valid) 
+000bbd70: 7b0a 2020 2020 2020 2020 2020 7265 7475  {.          retu
+000bbd80: 726e 2075 726c 3b0a 2020 2020 2020 2020  rn url;.        
+000bbd90: 7d0a 2020 2020 2020 2020 7374 6174 6520  }.        state 
+000bbda0: 3d20 7374 6174 653a 3a50 4154 485f 5354  = state::PATH_ST
+000bbdb0: 4152 543b 0a20 2020 2020 2020 205b 5b66  ART;.        [[f
+000bbdc0: 616c 6c74 6872 6f75 6768 5d5d 3b0a 2020  allthrough]];.  
+000bbdd0: 2020 2020 7d0a 2020 2020 2020 6361 7365      }.      case
+000bbde0: 2061 6461 3a3a 7374 6174 653a 3a50 4154   ada::state::PAT
+000bbdf0: 485f 5354 4152 543a 207b 0a20 2020 2020  H_START: {.     
+000bbe00: 2020 2061 6461 5f6c 6f67 2822 5041 5448     ada_log("PATH
+000bbe10: 5f53 5441 5254 2022 2c20 6865 6c70 6572  _START ", helper
+000bbe20: 733a 3a73 7562 7374 7269 6e67 2875 726c  s::substring(url
+000bbe30: 5f64 6174 612c 2069 6e70 7574 5f70 6f73  _data, input_pos
+000bbe40: 6974 696f 6e29 293b 0a0a 2020 2020 2020  ition));..      
+000bbe50: 2020 2f2f 2049 6620 7572 6c20 6973 2073    // If url is s
+000bbe60: 7065 6369 616c 2c20 7468 656e 3a0a 2020  pecial, then:.  
+000bbe70: 2020 2020 2020 6966 2028 7572 6c2e 6973        if (url.is
+000bbe80: 5f73 7065 6369 616c 2829 2920 7b0a 2020  _special()) {.  
+000bbe90: 2020 2020 2020 2020 2f2f 2053 6574 2073          // Set s
+000bbea0: 7461 7465 2074 6f20 7061 7468 2073 7461  tate to path sta
+000bbeb0: 7465 2e0a 2020 2020 2020 2020 2020 7374  te..          st
+000bbec0: 6174 6520 3d20 6164 613a 3a73 7461 7465  ate = ada::state
+000bbed0: 3a3a 5041 5448 3b0a 0a20 2020 2020 2020  ::PATH;..       
+000bbee0: 2020 202f 2f20 4f70 7469 6d69 7a61 7469     // Optimizati
+000bbef0: 6f6e 3a20 4176 6f69 6469 6e67 2067 6f69  on: Avoiding goi
+000bbf00: 6e67 2069 6e74 6f20 5041 5448 2073 7461  ng into PATH sta
+000bbf10: 7465 2069 6d70 726f 7665 7320 7468 650a  te improves the.
+000bbf20: 2020 2020 2020 2020 2020 2f2f 2070 6572            // per
+000bbf30: 666f 726d 616e 6365 206f 6620 7572 6c73  formance of urls
+000bbf40: 2065 6e64 696e 6720 7769 7468 202f 2e0a   ending with /..
+000bbf50: 2020 2020 2020 2020 2020 6966 2028 696e            if (in
+000bbf60: 7075 745f 706f 7369 7469 6f6e 203d 3d20  put_position == 
+000bbf70: 696e 7075 745f 7369 7a65 2920 7b0a 2020  input_size) {.  
+000bbf80: 2020 2020 2020 2020 2020 7572 6c2e 7570            url.up
+000bbf90: 6461 7465 5f62 6173 655f 7061 7468 6e61  date_base_pathna
+000bbfa0: 6d65 2822 2f22 293b 0a20 2020 2020 2020  me("/");.       
+000bbfb0: 2020 2020 2069 6620 2866 7261 676d 656e       if (fragmen
+000bbfc0: 742e 6861 735f 7661 6c75 6528 2929 207b  t.has_value()) {
+000bbfd0: 0a20 2020 2020 2020 2020 2020 2020 2075  .              u
+000bbfe0: 726c 2e75 7064 6174 655f 756e 656e 636f  rl.update_unenco
+000bbff0: 6465 645f 6261 7365 5f68 6173 6828 2a66  ded_base_hash(*f
+000bc000: 7261 676d 656e 7429 3b0a 2020 2020 2020  ragment);.      
+000bc010: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000bc020: 2020 2020 7265 7475 726e 2075 726c 3b0a      return url;.
+000bc030: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000bc040: 2020 2020 2020 2f2f 2049 6620 6320 6973        // If c is
+000bc050: 206e 6569 7468 6572 2055 2b30 3032 4620   neither U+002F 
+000bc060: 282f 2920 6e6f 7220 552b 3030 3543 2028  (/) nor U+005C (
+000bc070: 5c29 2c20 7468 656e 2064 6563 7265 6173  \), then decreas
+000bc080: 6520 706f 696e 7465 720a 2020 2020 2020  e pointer.      
+000bc090: 2020 2020 2f2f 2062 7920 312e 2057 6520      // by 1. We 
+000bc0a0: 6b6e 6f77 2074 6861 7420 2869 6e70 7574  know that (input
+000bc0b0: 5f70 6f73 6974 696f 6e20 3d3d 2069 6e70  _position == inp
+000bc0c0: 7574 5f73 697a 6529 2069 7320 696d 706f  ut_size) is impo
+000bc0d0: 7373 6962 6c65 0a20 2020 2020 2020 2020  ssible.         
+000bc0e0: 202f 2f20 6865 7265 2c20 6265 6361 7573   // here, becaus
+000bc0f0: 6520 6f66 2074 6865 2070 7265 7669 6f75  e of the previou
+000bc100: 7320 6966 2d63 6865 636b 2e0a 2020 2020  s if-check..    
+000bc110: 2020 2020 2020 6966 2028 2875 726c 5f64        if ((url_d
+000bc120: 6174 615b 696e 7075 745f 706f 7369 7469  ata[input_positi
+000bc130: 6f6e 5d20 213d 2027 2f27 2920 2626 0a20  on] != '/') &&. 
+000bc140: 2020 2020 2020 2020 2020 2020 2028 7572               (ur
+000bc150: 6c5f 6461 7461 5b69 6e70 7574 5f70 6f73  l_data[input_pos
+000bc160: 6974 696f 6e5d 2021 3d20 275c 5c27 2929  ition] != '\\'))
+000bc170: 207b 0a20 2020 2020 2020 2020 2020 2062   {.            b
+000bc180: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+000bc190: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+000bc1a0: 2020 2020 2f2f 204f 7468 6572 7769 7365      // Otherwise
+000bc1b0: 2c20 6966 2073 7461 7465 206f 7665 7272  , if state overr
+000bc1c0: 6964 6520 6973 206e 6f74 2067 6976 656e  ide is not given
+000bc1d0: 2061 6e64 2063 2069 7320 552b 3030 3346   and c is U+003F
+000bc1e0: 2028 3f29 2c0a 2020 2020 2020 2020 2f2f   (?),.        //
+000bc1f0: 2073 6574 2075 726c e280 9973 2071 7565   set url...s que
+000bc200: 7279 2074 6f20 7468 6520 656d 7074 7920  ry to the empty 
+000bc210: 7374 7269 6e67 2061 6e64 2073 7461 7465  string and state
+000bc220: 2074 6f20 7175 6572 7920 7374 6174 652e   to query state.
+000bc230: 0a20 2020 2020 2020 2065 6c73 6520 6966  .        else if
+000bc240: 2028 2869 6e70 7574 5f70 6f73 6974 696f   ((input_positio
+000bc250: 6e20 213d 2069 6e70 7574 5f73 697a 6529  n != input_size)
+000bc260: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
+000bc270: 2020 2020 2028 7572 6c5f 6461 7461 5b69       (url_data[i
+000bc280: 6e70 7574 5f70 6f73 6974 696f 6e5d 203d  nput_position] =
+000bc290: 3d20 273f 2729 2920 7b0a 2020 2020 2020  = '?')) {.      
+000bc2a0: 2020 2020 7374 6174 6520 3d20 6164 613a      state = ada:
+000bc2b0: 3a73 7461 7465 3a3a 5155 4552 593b 0a20  :state::QUERY;. 
+000bc2c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000bc2d0: 202f 2f20 4f74 6865 7277 6973 652c 2069   // Otherwise, i
+000bc2e0: 6620 6320 6973 206e 6f74 2074 6865 2045  f c is not the E
+000bc2f0: 4f46 2063 6f64 6520 706f 696e 743a 0a20  OF code point:. 
+000bc300: 2020 2020 2020 2065 6c73 6520 6966 2028         else if (
+000bc310: 696e 7075 745f 706f 7369 7469 6f6e 2021  input_position !
+000bc320: 3d20 696e 7075 745f 7369 7a65 2920 7b0a  = input_size) {.
+000bc330: 2020 2020 2020 2020 2020 2f2f 2053 6574            // Set
+000bc340: 2073 7461 7465 2074 6f20 7061 7468 2073   state to path s
+000bc350: 7461 7465 2e0a 2020 2020 2020 2020 2020  tate..          
+000bc360: 7374 6174 6520 3d20 6164 613a 3a73 7461  state = ada::sta
+000bc370: 7465 3a3a 5041 5448 3b0a 0a20 2020 2020  te::PATH;..     
+000bc380: 2020 2020 202f 2f20 4966 2063 2069 7320       // If c is 
+000bc390: 6e6f 7420 552b 3030 3246 2028 2f29 2c20  not U+002F (/), 
+000bc3a0: 7468 656e 2064 6563 7265 6173 6520 706f  then decrease po
+000bc3b0: 696e 7465 7220 6279 2031 2e0a 2020 2020  inter by 1..    
+000bc3c0: 2020 2020 2020 6966 2028 7572 6c5f 6461        if (url_da
+000bc3d0: 7461 5b69 6e70 7574 5f70 6f73 6974 696f  ta[input_positio
+000bc3e0: 6e5d 2021 3d20 272f 2729 207b 0a20 2020  n] != '/') {.   
+000bc3f0: 2020 2020 2020 2020 2062 7265 616b 3b0a           break;.
+000bc400: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000bc410: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+000bc420: 6e70 7574 5f70 6f73 6974 696f 6e2b 2b3b  nput_position++;
+000bc430: 0a20 2020 2020 2020 2062 7265 616b 3b0a  .        break;.
+000bc440: 2020 2020 2020 7d0a 2020 2020 2020 6361        }.      ca
+000bc450: 7365 2061 6461 3a3a 7374 6174 653a 3a50  se ada::state::P
+000bc460: 4154 483a 207b 0a20 2020 2020 2020 2073  ATH: {.        s
+000bc470: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000bc480: 7669 6577 203d 2068 656c 7065 7273 3a3a  view = helpers::
+000bc490: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000bc4a0: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000bc4b0: 6f6e 293b 0a20 2020 2020 2020 2061 6461  on);.        ada
+000bc4c0: 5f6c 6f67 2822 5041 5448 2022 2c20 6865  _log("PATH ", he
+000bc4d0: 6c70 6572 733a 3a73 7562 7374 7269 6e67  lpers::substring
+000bc4e0: 2875 726c 5f64 6174 612c 2069 6e70 7574  (url_data, input
+000bc4f0: 5f70 6f73 6974 696f 6e29 293b 0a0a 2020  _position));..  
+000bc500: 2020 2020 2020 2f2f 204d 6f73 7420 7469        // Most ti
+000bc510: 6d65 2c20 7765 2064 6f20 6e6f 7420 6e65  me, we do not ne
+000bc520: 6564 2070 6572 6365 6e74 2065 6e63 6f64  ed percent encod
+000bc530: 696e 672e 0a20 2020 2020 2020 202f 2f20  ing..        // 
+000bc540: 4675 7274 6865 726d 6f72 652c 2077 6520  Furthermore, we 
+000bc550: 6361 6e20 696d 6d65 6469 6174 656c 7920  can immediately 
+000bc560: 6c6f 6361 7465 2074 6865 2027 3f27 2e0a  locate the '?'..
+000bc570: 2020 2020 2020 2020 7369 7a65 5f74 206c          size_t l
+000bc580: 6f63 6f66 7175 6573 7469 6f6e 6d61 726b  ocofquestionmark
+000bc590: 203d 2076 6965 772e 6669 6e64 2827 3f27   = view.find('?'
+000bc5a0: 293b 0a20 2020 2020 2020 2069 6620 286c  );.        if (l
+000bc5b0: 6f63 6f66 7175 6573 7469 6f6e 6d61 726b  ocofquestionmark
+000bc5c0: 2021 3d20 7374 643a 3a73 7472 696e 675f   != std::string_
+000bc5d0: 7669 6577 3a3a 6e70 6f73 2920 7b0a 2020  view::npos) {.  
+000bc5e0: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+000bc5f0: 6164 613a 3a73 7461 7465 3a3a 5155 4552  ada::state::QUER
+000bc600: 593b 0a20 2020 2020 2020 2020 2076 6965  Y;.          vie
+000bc610: 772e 7265 6d6f 7665 5f73 7566 6669 7828  w.remove_suffix(
+000bc620: 7669 6577 2e73 697a 6528 2920 2d20 6c6f  view.size() - lo
+000bc630: 636f 6671 7565 7374 696f 6e6d 6172 6b29  cofquestionmark)
+000bc640: 3b0a 2020 2020 2020 2020 2020 696e 7075  ;.          inpu
+000bc650: 745f 706f 7369 7469 6f6e 202b 3d20 6c6f  t_position += lo
+000bc660: 636f 6671 7565 7374 696f 6e6d 6172 6b20  cofquestionmark 
+000bc670: 2b20 313b 0a20 2020 2020 2020 207d 2065  + 1;.        } e
+000bc680: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+000bc690: 696e 7075 745f 706f 7369 7469 6f6e 203d  input_position =
+000bc6a0: 2069 6e70 7574 5f73 697a 6520 2b20 313b   input_size + 1;
+000bc6b0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000bc6c0: 2020 2069 6620 636f 6e73 7465 7870 7220     if constexpr 
+000bc6d0: 2872 6573 756c 745f 7479 7065 5f69 735f  (result_type_is_
+000bc6e0: 6164 615f 7572 6c29 207b 0a20 2020 2020  ada_url) {.     
+000bc6f0: 2020 2020 2068 656c 7065 7273 3a3a 7061       helpers::pa
+000bc700: 7273 655f 7072 6570 6172 6564 5f70 6174  rse_prepared_pat
+000bc710: 6828 7669 6577 2c20 7572 6c2e 7479 7065  h(view, url.type
+000bc720: 2c20 7572 6c2e 7061 7468 293b 0a20 2020  , url.path);.   
+000bc730: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+000bc740: 2020 2020 2020 2020 7572 6c2e 636f 6e73          url.cons
+000bc750: 756d 655f 7072 6570 6172 6564 5f70 6174  ume_prepared_pat
+000bc760: 6828 7669 6577 293b 0a20 2020 2020 2020  h(view);.       
+000bc770: 2020 2041 4441 5f41 5353 4552 545f 5452     ADA_ASSERT_TR
+000bc780: 5545 2875 726c 2e76 616c 6964 6174 6528  UE(url.validate(
+000bc790: 2929 3b0a 2020 2020 2020 2020 7d0a 2020  ));.        }.  
+000bc7a0: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
+000bc7b0: 2020 207d 0a20 2020 2020 2063 6173 6520     }.      case 
+000bc7c0: 6164 613a 3a73 7461 7465 3a3a 4649 4c45  ada::state::FILE
+000bc7d0: 5f53 4c41 5348 3a20 7b0a 2020 2020 2020  _SLASH: {.      
+000bc7e0: 2020 6164 615f 6c6f 6728 2246 494c 455f    ada_log("FILE_
+000bc7f0: 534c 4153 4820 222c 2068 656c 7065 7273  SLASH ", helpers
+000bc800: 3a3a 7375 6273 7472 696e 6728 7572 6c5f  ::substring(url_
+000bc810: 6461 7461 2c20 696e 7075 745f 706f 7369  data, input_posi
+000bc820: 7469 6f6e 2929 3b0a 0a20 2020 2020 2020  tion));..       
+000bc830: 202f 2f20 4966 2063 2069 7320 552b 3030   // If c is U+00
+000bc840: 3246 2028 2f29 206f 7220 552b 3030 3543  2F (/) or U+005C
+000bc850: 2028 5c29 2c20 7468 656e 3a0a 2020 2020   (\), then:.    
+000bc860: 2020 2020 6966 2028 2869 6e70 7574 5f70      if ((input_p
+000bc870: 6f73 6974 696f 6e20 213d 2069 6e70 7574  osition != input
+000bc880: 5f73 697a 6529 2026 260a 2020 2020 2020  _size) &&.      
+000bc890: 2020 2020 2020 2875 726c 5f64 6174 615b        (url_data[
+000bc8a0: 696e 7075 745f 706f 7369 7469 6f6e 5d20  input_position] 
+000bc8b0: 3d3d 2027 2f27 207c 7c0a 2020 2020 2020  == '/' ||.      
+000bc8c0: 2020 2020 2020 2075 726c 5f64 6174 615b         url_data[
+000bc8d0: 696e 7075 745f 706f 7369 7469 6f6e 5d20  input_position] 
+000bc8e0: 3d3d 2027 5c5c 2729 2920 7b0a 2020 2020  == '\\')) {.    
+000bc8f0: 2020 2020 2020 6164 615f 6c6f 6728 2246        ada_log("F
+000bc900: 494c 455f 534c 4153 4820 6320 6973 2055  ILE_SLASH c is U
+000bc910: 2b30 3032 4620 6f72 2055 2b30 3035 4322  +002F or U+005C"
+000bc920: 293b 0a20 2020 2020 2020 2020 202f 2f20  );.          // 
+000bc930: 5365 7420 7374 6174 6520 746f 2066 696c  Set state to fil
+000bc940: 6520 686f 7374 2073 7461 7465 2e0a 2020  e host state..  
+000bc950: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+000bc960: 6164 613a 3a73 7461 7465 3a3a 4649 4c45  ada::state::FILE
+000bc970: 5f48 4f53 543b 0a20 2020 2020 2020 2020  _HOST;.         
+000bc980: 2069 6e70 7574 5f70 6f73 6974 696f 6e2b   input_position+
+000bc990: 2b3b 0a20 2020 2020 2020 207d 2065 6c73  +;.        } els
+000bc9a0: 6520 7b0a 2020 2020 2020 2020 2020 6164  e {.          ad
+000bc9b0: 615f 6c6f 6728 2246 494c 455f 534c 4153  a_log("FILE_SLAS
+000bc9c0: 4820 6f74 6865 7277 6973 6522 293b 0a20  H otherwise");. 
+000bc9d0: 2020 2020 2020 2020 202f 2f20 4966 2062           // If b
+000bc9e0: 6173 6520 6973 206e 6f6e 2d6e 756c 6c20  ase is non-null 
+000bc9f0: 616e 6420 6261 7365 e280 9973 2073 6368  and base...s sch
+000bca00: 656d 6520 6973 2022 6669 6c65 222c 2074  eme is "file", t
+000bca10: 6865 6e3a 0a20 2020 2020 2020 2020 202f  hen:.          /
+000bca20: 2f20 4e6f 7465 3a20 6974 2069 7320 756e  / Note: it is un
+000bca30: 7361 6665 2074 6f20 646f 2062 6173 655f  safe to do base_
+000bca40: 7572 6c2d 3e73 6368 656d 6520 756e 6c65  url->scheme unle
+000bca50: 7373 2079 6f75 206b 6e6f 7720 7468 6174  ss you know that
+000bca60: 0a20 2020 2020 2020 2020 202f 2f20 6261  .          // ba
+000bca70: 7365 5f75 726c 5f68 6173 5f76 616c 7565  se_url_has_value
+000bca80: 2829 2069 7320 7472 7565 2e0a 2020 2020  () is true..    
+000bca90: 2020 2020 2020 6966 2028 6261 7365 5f75        if (base_u
+000bcaa0: 726c 2021 3d20 6e75 6c6c 7074 7220 2626  rl != nullptr &&
+000bcab0: 0a20 2020 2020 2020 2020 2020 2020 2062  .              b
+000bcac0: 6173 655f 7572 6c2d 3e74 7970 6520 3d3d  ase_url->type ==
+000bcad0: 2061 6461 3a3a 7363 6865 6d65 3a3a 7479   ada::scheme::ty
+000bcae0: 7065 3a3a 4649 4c45 2920 7b0a 2020 2020  pe::FILE) {.    
+000bcaf0: 2020 2020 2020 2020 2f2f 2053 6574 2075          // Set u
+000bcb00: 726c e280 9973 2068 6f73 7420 746f 2062  rl...s host to b
+000bcb10: 6173 65e2 8099 7320 686f 7374 2e0a 2020  ase...s host..  
+000bcb20: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
+000bcb30: 7374 6578 7072 2028 7265 7375 6c74 5f74  stexpr (result_t
+000bcb40: 7970 655f 6973 5f61 6461 5f75 726c 2920  ype_is_ada_url) 
+000bcb50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000bcb60: 7572 6c2e 686f 7374 203d 2062 6173 655f  url.host = base_
+000bcb70: 7572 6c2d 3e68 6f73 743b 0a20 2020 2020  url->host;.     
+000bcb80: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+000bcb90: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+000bcba0: 2054 4f44 4f3a 204f 7074 696d 697a 6174   TODO: Optimizat
+000bcbb0: 696f 6e20 6f70 706f 7274 756e 6974 792e  ion opportunity.
+000bcbc0: 0a20 2020 2020 2020 2020 2020 2020 2075  .              u
+000bcbd0: 726c 2e73 6574 5f68 6f73 7428 6261 7365  rl.set_host(base
+000bcbe0: 5f75 726c 2d3e 6765 745f 686f 7374 2829  _url->get_host()
+000bcbf0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000bcc00: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000bcc10: 4966 2074 6865 2063 6f64 6520 706f 696e  If the code poin
+000bcc20: 7420 7375 6273 7472 696e 6720 6672 6f6d  t substring from
+000bcc30: 2070 6f69 6e74 6572 2074 6f20 7468 6520   pointer to the 
+000bcc40: 656e 6420 6f66 2069 6e70 7574 2064 6f65  end of input doe
+000bcc50: 730a 2020 2020 2020 2020 2020 2020 2f2f  s.            //
+000bcc60: 206e 6f74 2073 7461 7274 2077 6974 6820   not start with 
+000bcc70: 6120 5769 6e64 6f77 7320 6472 6976 6520  a Windows drive 
+000bcc80: 6c65 7474 6572 2061 6e64 2062 6173 65e2  letter and base.
+000bcc90: 8099 7320 7061 7468 5b30 5d20 6973 2061  ..s path[0] is a
+000bcca0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000bccb0: 6e6f 726d 616c 697a 6564 2057 696e 646f  normalized Windo
+000bccc0: 7773 2064 7269 7665 206c 6574 7465 722c  ws drive letter,
+000bccd0: 2074 6865 6e20 6170 7065 6e64 2062 6173   then append bas
+000bcce0: 65e2 8099 7320 7061 7468 5b30 5d20 746f  e...s path[0] to
+000bccf0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000bcd00: 7572 6ce2 8099 7320 7061 7468 2e0a 2020  url...s path..  
+000bcd10: 2020 2020 2020 2020 2020 6966 2028 2162            if (!b
+000bcd20: 6173 655f 7572 6c2d 3e67 6574 5f70 6174  ase_url->get_pat
+000bcd30: 686e 616d 6528 292e 656d 7074 7928 2929  hname().empty())
+000bcd40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000bcd50: 2069 6620 2821 6368 6563 6b65 7273 3a3a   if (!checkers::
+000bcd60: 6973 5f77 696e 646f 7773 5f64 7269 7665  is_windows_drive
+000bcd70: 5f6c 6574 7465 7228 0a20 2020 2020 2020  _letter(.       
+000bcd80: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000bcd90: 656c 7065 7273 3a3a 7375 6273 7472 696e  elpers::substrin
+000bcda0: 6728 7572 6c5f 6461 7461 2c20 696e 7075  g(url_data, inpu
+000bcdb0: 745f 706f 7369 7469 6f6e 2929 2920 7b0a  t_position))) {.
+000bcdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bcdd0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000bcde0: 2066 6972 7374 5f62 6173 655f 7572 6c5f   first_base_url_
+000bcdf0: 7061 7468 203d 0a20 2020 2020 2020 2020  path =.         
+000bce00: 2020 2020 2020 2020 2020 2062 6173 655f             base_
+000bce10: 7572 6c2d 3e67 6574 5f70 6174 686e 616d  url->get_pathnam
+000bce20: 6528 292e 7375 6273 7472 2831 293b 0a20  e().substr(1);. 
+000bce30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000bce40: 697a 655f 7420 6c6f 6320 3d20 6669 7273  ize_t loc = firs
+000bce50: 745f 6261 7365 5f75 726c 5f70 6174 682e  t_base_url_path.
+000bce60: 6669 6e64 2827 2f27 293b 0a20 2020 2020  find('/');.     
+000bce70: 2020 2020 2020 2020 2020 2069 6620 286c             if (l
+000bce80: 6f63 2021 3d20 7374 643a 3a73 7472 696e  oc != std::strin
+000bce90: 675f 7669 6577 3a3a 6e70 6f73 2920 7b0a  g_view::npos) {.
+000bcea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bceb0: 2020 6865 6c70 6572 733a 3a72 6573 697a    helpers::resiz
+000bcec0: 6528 6669 7273 745f 6261 7365 5f75 726c  e(first_base_url
+000bced0: 5f70 6174 682c 206c 6f63 293b 0a20 2020  _path, loc);.   
+000bcee0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000bcef0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000bcf00: 6620 2863 6865 636b 6572 733a 3a69 735f  f (checkers::is_
+000bcf10: 6e6f 726d 616c 697a 6564 5f77 696e 646f  normalized_windo
+000bcf20: 7773 5f64 7269 7665 5f6c 6574 7465 7228  ws_drive_letter(
+000bcf30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000bcf40: 2020 2020 2020 2020 2066 6972 7374 5f62           first_b
+000bcf50: 6173 655f 7572 6c5f 7061 7468 2929 207b  ase_url_path)) {
+000bcf60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000bcf70: 2020 2069 6620 636f 6e73 7465 7870 7220     if constexpr 
+000bcf80: 2872 6573 756c 745f 7479 7065 5f69 735f  (result_type_is_
+000bcf90: 6164 615f 7572 6c29 207b 0a20 2020 2020  ada_url) {.     
+000bcfa0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+000bcfb0: 726c 2e70 6174 6820 2b3d 2027 2f27 3b0a  rl.path += '/';.
+000bcfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bcfd0: 2020 2020 7572 6c2e 7061 7468 202b 3d20      url.path += 
+000bcfe0: 6669 7273 745f 6261 7365 5f75 726c 5f70  first_base_url_p
+000bcff0: 6174 683b 0a20 2020 2020 2020 2020 2020  ath;.           
+000bd000: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+000bd010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bd020: 2020 2020 7572 6c2e 6170 7065 6e64 5f62      url.append_b
+000bd030: 6173 655f 7061 7468 6e61 6d65 280a 2020  ase_pathname(.  
+000bd040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000bd050: 2020 2020 2020 6865 6c70 6572 733a 3a63        helpers::c
+000bd060: 6f6e 6361 7428 222f 222c 2066 6972 7374  oncat("/", first
+000bd070: 5f62 6173 655f 7572 6c5f 7061 7468 2929  _base_url_path))
+000bd080: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000bd090: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000bd0a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000bd0b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000bd0c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000bd0d0: 7d0a 0a20 2020 2020 2020 2020 202f 2f20  }..          // 
+000bd0e0: 5365 7420 7374 6174 6520 746f 2070 6174  Set state to pat
+000bd0f0: 6820 7374 6174 652c 2061 6e64 2064 6563  h state, and dec
+000bd100: 7265 6173 6520 706f 696e 7465 7220 6279  rease pointer by
+000bd110: 2031 2e0a 2020 2020 2020 2020 2020 7374   1..          st
+000bd120: 6174 6520 3d20 6164 613a 3a73 7461 7465  ate = ada::state
+000bd130: 3a3a 5041 5448 3b0a 2020 2020 2020 2020  ::PATH;.        
+000bd140: 7d0a 0a20 2020 2020 2020 2062 7265 616b  }..        break
+000bd150: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
+000bd160: 6361 7365 2061 6461 3a3a 7374 6174 653a  case ada::state:
+000bd170: 3a46 494c 455f 484f 5354 3a20 7b0a 2020  :FILE_HOST: {.  
+000bd180: 2020 2020 2020 7374 643a 3a73 7472 696e        std::strin
+000bd190: 675f 7669 6577 2076 6965 7720 3d20 6865  g_view view = he
+000bd1a0: 6c70 6572 733a 3a73 7562 7374 7269 6e67  lpers::substring
+000bd1b0: 2875 726c 5f64 6174 612c 2069 6e70 7574  (url_data, input
+000bd1c0: 5f70 6f73 6974 696f 6e29 3b0a 2020 2020  _position);.    
+000bd1d0: 2020 2020 6164 615f 6c6f 6728 2246 494c      ada_log("FIL
+000bd1e0: 455f 484f 5354 2022 2c20 6865 6c70 6572  E_HOST ", helper
+000bd1f0: 733a 3a73 7562 7374 7269 6e67 2875 726c  s::substring(url
+000bd200: 5f64 6174 612c 2069 6e70 7574 5f70 6f73  _data, input_pos
+000bd210: 6974 696f 6e29 293b 0a0a 2020 2020 2020  ition));..      
+000bd220: 2020 7369 7a65 5f74 206c 6f63 6174 696f    size_t locatio
+000bd230: 6e20 3d20 7669 6577 2e66 696e 645f 6669  n = view.find_fi
+000bd240: 7273 745f 6f66 2822 2f5c 5c3f 2229 3b0a  rst_of("/\\?");.
+000bd250: 2020 2020 2020 2020 7374 643a 3a73 7472          std::str
+000bd260: 696e 675f 7669 6577 2066 696c 655f 686f  ing_view file_ho
+000bd270: 7374 5f62 7566 6665 7228 0a20 2020 2020  st_buffer(.     
+000bd280: 2020 2020 2020 2076 6965 772e 6461 7461         view.data
+000bd290: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+000bd2a0: 286c 6f63 6174 696f 6e20 213d 2073 7464  (location != std
+000bd2b0: 3a3a 7374 7269 6e67 5f76 6965 773a 3a6e  ::string_view::n
+000bd2c0: 706f 7329 203f 206c 6f63 6174 696f 6e20  pos) ? location 
+000bd2d0: 3a20 7669 6577 2e73 697a 6528 2929 3b0a  : view.size());.
+000bd2e0: 0a20 2020 2020 2020 2069 6620 2863 6865  .        if (che
+000bd2f0: 636b 6572 733a 3a69 735f 7769 6e64 6f77  ckers::is_window
+000bd300: 735f 6472 6976 655f 6c65 7474 6572 2866  s_drive_letter(f
+000bd310: 696c 655f 686f 7374 5f62 7566 6665 7229  ile_host_buffer)
+000bd320: 2920 7b0a 2020 2020 2020 2020 2020 7374  ) {.          st
+000bd330: 6174 6520 3d20 6164 613a 3a73 7461 7465  ate = ada::state
+000bd340: 3a3a 5041 5448 3b0a 2020 2020 2020 2020  ::PATH;.        
+000bd350: 7d20 656c 7365 2069 6620 2866 696c 655f  } else if (file_
+000bd360: 686f 7374 5f62 7566 6665 722e 656d 7074  host_buffer.empt
+000bd370: 7928 2929 207b 0a20 2020 2020 2020 2020  y()) {.         
+000bd380: 202f 2f20 5365 7420 7572 6ce2 8099 7320   // Set url...s 
+000bd390: 686f 7374 2074 6f20 7468 6520 656d 7074  host to the empt
+000bd3a0: 7920 7374 7269 6e67 2e0a 2020 2020 2020  y string..      
+000bd3b0: 2020 2020 6966 2063 6f6e 7374 6578 7072      if constexpr
+000bd3c0: 2028 7265 7375 6c74 5f74 7970 655f 6973   (result_type_is
+000bd3d0: 5f61 6461 5f75 726c 2920 7b0a 2020 2020  _ada_url) {.    
+000bd3e0: 2020 2020 2020 2020 7572 6c2e 686f 7374          url.host
+000bd3f0: 203d 2022 223b 0a20 2020 2020 2020 2020   = "";.         
+000bd400: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+000bd410: 2020 2020 2020 7572 6c2e 7570 6461 7465        url.update
+000bd420: 5f62 6173 655f 686f 7374 6e61 6d65 2822  _base_hostname("
+000bd430: 2229 3b0a 2020 2020 2020 2020 2020 7d0a  ");.          }.
+000bd440: 2020 2020 2020 2020 2020 2f2f 2053 6574            // Set
+000bd450: 2073 7461 7465 2074 6f20 7061 7468 2073   state to path s
+000bd460: 7461 7274 2073 7461 7465 2e0a 2020 2020  tart state..    
+000bd470: 2020 2020 2020 7374 6174 6520 3d20 6164        state = ad
+000bd480: 613a 3a73 7461 7465 3a3a 5041 5448 5f53  a::state::PATH_S
+000bd490: 5441 5254 3b0a 2020 2020 2020 2020 7d20  TART;.        } 
+000bd4a0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+000bd4b0: 2073 697a 655f 7420 636f 6e73 756d 6564   size_t consumed
+000bd4c0: 5f62 7974 6573 203d 2066 696c 655f 686f  _bytes = file_ho
+000bd4d0: 7374 5f62 7566 6665 722e 7369 7a65 2829  st_buffer.size()
+000bd4e0: 3b0a 2020 2020 2020 2020 2020 696e 7075  ;.          inpu
+000bd4f0: 745f 706f 7369 7469 6f6e 202b 3d20 636f  t_position += co
+000bd500: 6e73 756d 6564 5f62 7974 6573 3b0a 2020  nsumed_bytes;.  
+000bd510: 2020 2020 2020 2020 2f2f 204c 6574 2068          // Let h
+000bd520: 6f73 7420 6265 2074 6865 2072 6573 756c  ost be the resul
+000bd530: 7420 6f66 2068 6f73 7420 7061 7273 696e  t of host parsin
+000bd540: 6720 6275 6666 6572 2077 6974 6820 7572  g buffer with ur
+000bd550: 6c20 6973 206e 6f74 0a20 2020 2020 2020  l is not.       
+000bd560: 2020 202f 2f20 7370 6563 6961 6c2e 0a20     // special.. 
+000bd570: 2020 2020 2020 2020 2069 6620 2821 7572           if (!ur
+000bd580: 6c2e 7061 7273 655f 686f 7374 2866 696c  l.parse_host(fil
+000bd590: 655f 686f 7374 5f62 7566 6665 7229 2920  e_host_buffer)) 
+000bd5a0: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+000bd5b0: 7475 726e 2075 726c 3b0a 2020 2020 2020  turn url;.      
+000bd5c0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+000bd5d0: 2069 6620 636f 6e73 7465 7870 7220 2872   if constexpr (r
+000bd5e0: 6573 756c 745f 7479 7065 5f69 735f 6164  esult_type_is_ad
+000bd5f0: 615f 7572 6c29 207b 0a20 2020 2020 2020  a_url) {.       
+000bd600: 2020 2020 202f 2f20 4966 2068 6f73 7420       // If host 
+000bd610: 6973 2022 6c6f 6361 6c68 6f73 7422 2c20  is "localhost", 
+000bd620: 7468 656e 2073 6574 2068 6f73 7420 746f  then set host to
+000bd630: 2074 6865 2065 6d70 7479 2073 7472 696e   the empty strin
+000bd640: 672e 0a20 2020 2020 2020 2020 2020 2069  g..            i
+000bd650: 6620 2875 726c 2e68 6f73 742e 6861 735f  f (url.host.has_
+000bd660: 7661 6c75 6528 2920 2626 2075 726c 2e68  value() && url.h
+000bd670: 6f73 742e 7661 6c75 6528 2920 3d3d 2022  ost.value() == "
+000bd680: 6c6f 6361 6c68 6f73 7422 2920 7b0a 2020  localhost") {.  
+000bd690: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
+000bd6a0: 686f 7374 203d 2022 223b 0a20 2020 2020  host = "";.     
+000bd6b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000bd6c0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+000bd6d0: 2020 2020 2020 2020 6966 2028 7572 6c2e          if (url.
+000bd6e0: 6765 745f 686f 7374 6e61 6d65 2829 203d  get_hostname() =
+000bd6f0: 3d20 226c 6f63 616c 686f 7374 2229 207b  = "localhost") {
+000bd700: 0a20 2020 2020 2020 2020 2020 2020 2075  .              u
+000bd710: 726c 2e75 7064 6174 655f 6261 7365 5f68  rl.update_base_h
+000bd720: 6f73 746e 616d 6528 2222 293b 0a20 2020  ostname("");.   
+000bd730: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000bd740: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000bd750: 2020 2f2f 2053 6574 2062 7566 6665 7220    // Set buffer 
+000bd760: 746f 2074 6865 2065 6d70 7479 2073 7472  to the empty str
+000bd770: 696e 6720 616e 6420 7374 6174 6520 746f  ing and state to
+000bd780: 2070 6174 6820 7374 6172 7420 7374 6174   path start stat
+000bd790: 652e 0a20 2020 2020 2020 2020 2073 7461  e..          sta
+000bd7a0: 7465 203d 2061 6461 3a3a 7374 6174 653a  te = ada::state:
+000bd7b0: 3a50 4154 485f 5354 4152 543b 0a20 2020  :PATH_START;.   
+000bd7c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000bd7d0: 6272 6561 6b3b 0a20 2020 2020 207d 0a20  break;.      }. 
+000bd7e0: 2020 2020 2063 6173 6520 6164 613a 3a73       case ada::s
+000bd7f0: 7461 7465 3a3a 4649 4c45 3a20 7b0a 2020  tate::FILE: {.  
+000bd800: 2020 2020 2020 6164 615f 6c6f 6728 2246        ada_log("F
+000bd810: 494c 4520 222c 2068 656c 7065 7273 3a3a  ILE ", helpers::
+000bd820: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000bd830: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000bd840: 6f6e 2929 3b0a 2020 2020 2020 2020 7374  on));.        st
+000bd850: 643a 3a73 7472 696e 675f 7669 6577 2066  d::string_view f
+000bd860: 696c 655f 7669 6577 203d 0a20 2020 2020  ile_view =.     
+000bd870: 2020 2020 2020 2068 656c 7065 7273 3a3a         helpers::
+000bd880: 7375 6273 7472 696e 6728 7572 6c5f 6461  substring(url_da
+000bd890: 7461 2c20 696e 7075 745f 706f 7369 7469  ta, input_positi
+000bd8a0: 6f6e 293b 0a0a 2020 2020 2020 2020 7572  on);..        ur
+000bd8b0: 6c2e 7365 745f 7072 6f74 6f63 6f6c 5f61  l.set_protocol_a
+000bd8c0: 735f 6669 6c65 2829 3b0a 2020 2020 2020  s_file();.      
+000bd8d0: 2020 6966 2063 6f6e 7374 6578 7072 2028    if constexpr (
+000bd8e0: 7265 7375 6c74 5f74 7970 655f 6973 5f61  result_type_is_a
+000bd8f0: 6461 5f75 726c 2920 7b0a 2020 2020 2020  da_url) {.      
+000bd900: 2020 2020 2f2f 2053 6574 2075 726c e280      // Set url..
+000bd910: 9973 2068 6f73 7420 746f 2074 6865 2065  .s host to the e
+000bd920: 6d70 7479 2073 7472 696e 672e 0a20 2020  mpty string..   
+000bd930: 2020 2020 2020 2075 726c 2e68 6f73 7420         url.host 
+000bd940: 3d20 2222 3b0a 2020 2020 2020 2020 7d20  = "";.        } 
+000bd950: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+000bd960: 2075 726c 2e75 7064 6174 655f 6261 7365   url.update_base
+000bd970: 5f68 6f73 746e 616d 6528 2222 293b 0a20  _hostname("");. 
+000bd980: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000bd990: 202f 2f20 4966 2063 2069 7320 552b 3030   // If c is U+00
+000bd9a0: 3246 2028 2f29 206f 7220 552b 3030 3543  2F (/) or U+005C
+000bd9b0: 2028 5c29 2c20 7468 656e 3a0a 2020 2020   (\), then:.    
+000bd9c0: 2020 2020 6966 2028 696e 7075 745f 706f      if (input_po
+000bd9d0: 7369 7469 6f6e 2021 3d20 696e 7075 745f  sition != input_
+000bd9e0: 7369 7a65 2026 260a 2020 2020 2020 2020  size &&.        
+000bd9f0: 2020 2020 2875 726c 5f64 6174 615b 696e      (url_data[in
+000bda00: 7075 745f 706f 7369 7469 6f6e 5d20 3d3d  put_position] ==
+000bda10: 2027 2f27 207c 7c0a 2020 2020 2020 2020   '/' ||.        
+000bda20: 2020 2020 2075 726c 5f64 6174 615b 696e       url_data[in
+000bda30: 7075 745f 706f 7369 7469 6f6e 5d20 3d3d  put_position] ==
+000bda40: 2027 5c5c 2729 2920 7b0a 2020 2020 2020   '\\')) {.      
+000bda50: 2020 2020 6164 615f 6c6f 6728 2246 494c      ada_log("FIL
+000bda60: 4520 6320 6973 2055 2b30 3032 4620 6f72  E c is U+002F or
+000bda70: 2055 2b30 3035 4322 293b 0a20 2020 2020   U+005C");.     
+000bda80: 2020 2020 202f 2f20 5365 7420 7374 6174       // Set stat
+000bda90: 6520 746f 2066 696c 6520 736c 6173 6820  e to file slash 
+000bdaa0: 7374 6174 652e 0a20 2020 2020 2020 2020  state..         
+000bdab0: 2073 7461 7465 203d 2061 6461 3a3a 7374   state = ada::st
+000bdac0: 6174 653a 3a46 494c 455f 534c 4153 483b  ate::FILE_SLASH;
+000bdad0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000bdae0: 2020 202f 2f20 4f74 6865 7277 6973 652c     // Otherwise,
+000bdaf0: 2069 6620 6261 7365 2069 7320 6e6f 6e2d   if base is non-
+000bdb00: 6e75 6c6c 2061 6e64 2062 6173 65e2 8099  null and base...
+000bdb10: 7320 7363 6865 6d65 2069 7320 2266 696c  s scheme is "fil
+000bdb20: 6522 3a0a 2020 2020 2020 2020 656c 7365  e":.        else
+000bdb30: 2069 6620 2862 6173 655f 7572 6c20 213d   if (base_url !=
+000bdb40: 206e 756c 6c70 7472 2026 260a 2020 2020   nullptr &&.    
+000bdb50: 2020 2020 2020 2020 2020 2020 2062 6173               bas
+000bdb60: 655f 7572 6c2d 3e74 7970 6520 3d3d 2061  e_url->type == a
+000bdb70: 6461 3a3a 7363 6865 6d65 3a3a 7479 7065  da::scheme::type
+000bdb80: 3a3a 4649 4c45 2920 7b0a 2020 2020 2020  ::FILE) {.      
+000bdb90: 2020 2020 2f2f 2053 6574 2075 726c e280      // Set url..
+000bdba0: 9973 2068 6f73 7420 746f 2062 6173 65e2  .s host to base.
+000bdbb0: 8099 7320 686f 7374 2c20 7572 6ce2 8099  ..s host, url...
+000bdbc0: 7320 7061 7468 2074 6f20 6120 636c 6f6e  s path to a clon
+000bdbd0: 6520 6f66 2062 6173 65e2 8099 730a 2020  e of base...s.  
+000bdbe0: 2020 2020 2020 2020 2f2f 2070 6174 682c          // path,
+000bdbf0: 2061 6e64 2075 726c e280 9973 2071 7565   and url...s que
+000bdc00: 7279 2074 6f20 6261 7365 e280 9973 2071  ry to base...s q
+000bdc10: 7565 7279 2e0a 2020 2020 2020 2020 2020  uery..          
+000bdc20: 6164 615f 6c6f 6728 2246 494c 4520 6261  ada_log("FILE ba
+000bdc30: 7365 206e 6f6e 2d6e 756c 6c22 293b 0a20  se non-null");. 
+000bdc40: 2020 2020 2020 2020 2069 6620 636f 6e73           if cons
+000bdc50: 7465 7870 7220 2872 6573 756c 745f 7479  texpr (result_ty
+000bdc60: 7065 5f69 735f 6164 615f 7572 6c29 207b  pe_is_ada_url) {
+000bdc70: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
+000bdc80: 2e68 6f73 7420 3d20 6261 7365 5f75 726c  .host = base_url
+000bdc90: 2d3e 686f 7374 3b0a 2020 2020 2020 2020  ->host;.        
+000bdca0: 2020 2020 7572 6c2e 7061 7468 203d 2062      url.path = b
+000bdcb0: 6173 655f 7572 6c2d 3e70 6174 683b 0a20  ase_url->path;. 
+000bdcc0: 2020 2020 2020 2020 2020 2075 726c 2e71             url.q
+000bdcd0: 7565 7279 203d 2062 6173 655f 7572 6c2d  uery = base_url-
+000bdce0: 3e71 7565 7279 3b0a 2020 2020 2020 2020  >query;.        
+000bdcf0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+000bdd00: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
+000bdd10: 4765 7420 7269 6420 6f66 2073 6574 5f68  Get rid of set_h
+000bdd20: 6f73 746e 616d 6520 616e 6420 7265 706c  ostname and repl
+000bdd30: 6163 6520 6974 2077 6974 680a 2020 2020  ace it with.    
+000bdd40: 2020 2020 2020 2020 2f2f 2075 7064 6174          // updat
+000bdd50: 655f 6261 7365 5f68 6f73 746e 616d 650a  e_base_hostname.
+000bdd60: 2020 2020 2020 2020 2020 2020 7572 6c2e              url.
+000bdd70: 7365 745f 686f 7374 6e61 6d65 2862 6173  set_hostname(bas
+000bdd80: 655f 7572 6c2d 3e67 6574 5f68 6f73 746e  e_url->get_hostn
+000bdd90: 616d 6528 2929 3b0a 2020 2020 2020 2020  ame());.        
+000bdda0: 2020 2020 7572 6c2e 7570 6461 7465 5f62      url.update_b
+000bddb0: 6173 655f 7061 7468 6e61 6d65 2862 6173  ase_pathname(bas
+000bddc0: 655f 7572 6c2d 3e67 6574 5f70 6174 686e  e_url->get_pathn
+000bddd0: 616d 6528 2929 3b0a 2020 2020 2020 2020  ame());.        
+000bdde0: 2020 2020 7572 6c2e 7570 6461 7465 5f62      url.update_b
+000bddf0: 6173 655f 7365 6172 6368 2862 6173 655f  ase_search(base_
+000bde00: 7572 6c2d 3e67 6574 5f73 6561 7263 6828  url->get_search(
+000bde10: 2929 3b0a 2020 2020 2020 2020 2020 7d0a  ));.          }.
+000bde20: 2020 2020 2020 2020 2020 7572 6c2e 6861            url.ha
+000bde30: 735f 6f70 6171 7565 5f70 6174 6820 3d20  s_opaque_path = 
+000bde40: 6261 7365 5f75 726c 2d3e 6861 735f 6f70  base_url->has_op
+000bde50: 6171 7565 5f70 6174 683b 0a0a 2020 2020  aque_path;..    
+000bde60: 2020 2020 2020 2f2f 2049 6620 6320 6973        // If c is
+000bde70: 2055 2b30 3033 4620 283f 292c 2074 6865   U+003F (?), the
+000bde80: 6e20 7365 7420 7572 6ce2 8099 7320 7175  n set url...s qu
+000bde90: 6572 7920 746f 2074 6865 2065 6d70 7479  ery to the empty
+000bdea0: 2073 7472 696e 6720 616e 640a 2020 2020   string and.    
+000bdeb0: 2020 2020 2020 2f2f 2073 7461 7465 2074        // state t
+000bdec0: 6f20 7175 6572 7920 7374 6174 652e 0a20  o query state.. 
+000bded0: 2020 2020 2020 2020 2069 6620 2869 6e70           if (inp
+000bdee0: 7574 5f70 6f73 6974 696f 6e20 213d 2069  ut_position != i
+000bdef0: 6e70 7574 5f73 697a 6520 2626 2075 726c  nput_size && url
+000bdf00: 5f64 6174 615b 696e 7075 745f 706f 7369  _data[input_posi
+000bdf10: 7469 6f6e 5d20 3d3d 2027 3f27 2920 7b0a  tion] == '?') {.
+000bdf20: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+000bdf30: 6520 3d20 6164 613a 3a73 7461 7465 3a3a  e = ada::state::
+000bdf40: 5155 4552 593b 0a20 2020 2020 2020 2020  QUERY;.         
+000bdf50: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
+000bdf60: 4f74 6865 7277 6973 652c 2069 6620 6320  Otherwise, if c 
+000bdf70: 6973 206e 6f74 2074 6865 2045 4f46 2063  is not the EOF c
+000bdf80: 6f64 6520 706f 696e 743a 0a20 2020 2020  ode point:.     
+000bdf90: 2020 2020 2065 6c73 6520 6966 2028 696e       else if (in
+000bdfa0: 7075 745f 706f 7369 7469 6f6e 2021 3d20  put_position != 
+000bdfb0: 696e 7075 745f 7369 7a65 2920 7b0a 2020  input_size) {.  
+000bdfc0: 2020 2020 2020 2020 2020 2f2f 2053 6574            // Set
+000bdfd0: 2075 726c e280 9973 2071 7565 7279 2074   url...s query t
+000bdfe0: 6f20 6e75 6c6c 2e0a 2020 2020 2020 2020  o null..        
+000bdff0: 2020 2020 7572 6c2e 636c 6561 725f 7365      url.clear_se
+000be000: 6172 6368 2829 3b0a 2020 2020 2020 2020  arch();.        
+000be010: 2020 2020 2f2f 2049 6620 7468 6520 636f      // If the co
+000be020: 6465 2070 6f69 6e74 2073 7562 7374 7269  de point substri
+000be030: 6e67 2066 726f 6d20 706f 696e 7465 7220  ng from pointer 
+000be040: 746f 2074 6865 2065 6e64 206f 6620 696e  to the end of in
+000be050: 7075 7420 646f 6573 0a20 2020 2020 2020  put does.       
+000be060: 2020 2020 202f 2f20 6e6f 7420 7374 6172       // not star
+000be070: 7420 7769 7468 2061 2057 696e 646f 7773  t with a Windows
+000be080: 2064 7269 7665 206c 6574 7465 722c 2074   drive letter, t
+000be090: 6865 6e20 7368 6f72 7465 6e20 7572 6ce2  hen shorten url.
+000be0a0: 8099 7320 7061 7468 2e0a 2020 2020 2020  ..s path..      
+000be0b0: 2020 2020 2020 6966 2028 2163 6865 636b        if (!check
+000be0c0: 6572 733a 3a69 735f 7769 6e64 6f77 735f  ers::is_windows_
+000be0d0: 6472 6976 655f 6c65 7474 6572 2866 696c  drive_letter(fil
+000be0e0: 655f 7669 6577 2929 207b 0a20 2020 2020  e_view)) {.     
+000be0f0: 2020 2020 2020 2020 2069 6620 636f 6e73           if cons
+000be100: 7465 7870 7220 2872 6573 756c 745f 7479  texpr (result_ty
+000be110: 7065 5f69 735f 6164 615f 7572 6c29 207b  pe_is_ada_url) {
+000be120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000be130: 2068 656c 7065 7273 3a3a 7368 6f72 7465   helpers::shorte
+000be140: 6e5f 7061 7468 2875 726c 2e70 6174 682c  n_path(url.path,
+000be150: 2075 726c 2e74 7970 6529 3b0a 2020 2020   url.type);.    
+000be160: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+000be170: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000be180: 2020 2073 7464 3a3a 7374 7269 6e67 5f76     std::string_v
+000be190: 6965 7720 7061 7468 203d 2075 726c 2e67  iew path = url.g
+000be1a0: 6574 5f70 6174 686e 616d 6528 293b 0a20  et_pathname();. 
+000be1b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000be1c0: 6620 2868 656c 7065 7273 3a3a 7368 6f72  f (helpers::shor
+000be1d0: 7465 6e5f 7061 7468 2870 6174 682c 2075  ten_path(path, u
+000be1e0: 726c 2e74 7970 6529 2920 7b0a 2020 2020  rl.type)) {.    
+000be1f0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+000be200: 6c2e 7570 6461 7465 5f62 6173 655f 7061  l.update_base_pa
+000be210: 7468 6e61 6d65 2873 7464 3a3a 7374 7269  thname(std::stri
+000be220: 6e67 2870 6174 6829 293b 0a20 2020 2020  ng(path));.     
+000be230: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000be240: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000be250: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000be260: 2020 2020 2020 202f 2f20 4f74 6865 7277         // Otherw
+000be270: 6973 653a 0a20 2020 2020 2020 2020 2020  ise:.           
+000be280: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+000be290: 2020 2020 2020 2f2f 2053 6574 2075 726c        // Set url
+000be2a0: e280 9973 2070 6174 6820 746f 2061 6e20  ...s path to an 
+000be2b0: 656d 7074 7920 6c69 7374 2e0a 2020 2020  empty list..    
+000be2c0: 2020 2020 2020 2020 2020 7572 6c2e 636c            url.cl
+000be2d0: 6561 725f 7061 7468 6e61 6d65 2829 3b0a  ear_pathname();.
+000be2e0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+000be2f0: 6c2e 6861 735f 6f70 6171 7565 5f70 6174  l.has_opaque_pat
+000be300: 6820 3d20 7472 7565 3b0a 2020 2020 2020  h = true;.      
+000be310: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000be320: 2020 2020 202f 2f20 5365 7420 7374 6174       // Set stat
+000be330: 6520 746f 2070 6174 6820 7374 6174 6520  e to path state 
+000be340: 616e 6420 6465 6372 6561 7365 2070 6f69  and decrease poi
+000be350: 6e74 6572 2062 7920 312e 0a20 2020 2020  nter by 1..     
+000be360: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
+000be370: 6461 3a3a 7374 6174 653a 3a50 4154 483b  da::state::PATH;
+000be380: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
+000be390: 616b 3b0a 2020 2020 2020 2020 2020 7d0a  ak;.          }.
+000be3a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000be3b0: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
+000be3c0: 7365 7420 7374 6174 6520 746f 2070 6174  set state to pat
+000be3d0: 6820 7374 6174 652c 2061 6e64 2064 6563  h state, and dec
+000be3e0: 7265 6173 6520 706f 696e 7465 7220 6279  rease pointer by
+000be3f0: 2031 2e0a 2020 2020 2020 2020 656c 7365   1..        else
+000be400: 207b 0a20 2020 2020 2020 2020 2061 6461   {.          ada
+000be410: 5f6c 6f67 2822 4649 4c45 2067 6f20 746f  _log("FILE go to
+000be420: 2070 6174 6822 293b 0a20 2020 2020 2020   path");.       
+000be430: 2020 2073 7461 7465 203d 2061 6461 3a3a     state = ada::
+000be440: 7374 6174 653a 3a50 4154 483b 0a20 2020  state::PATH;.   
+000be450: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
+000be460: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000be470: 2069 6e70 7574 5f70 6f73 6974 696f 6e2b   input_position+
+000be480: 2b3b 0a20 2020 2020 2020 2062 7265 616b  +;.        break
+000be490: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
+000be4a0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+000be4b0: 2061 6461 3a3a 756e 7265 6163 6861 626c   ada::unreachabl
+000be4c0: 6528 293b 0a20 2020 207d 0a20 207d 0a20  e();.    }.  }. 
+000be4d0: 2069 6620 2866 7261 676d 656e 742e 6861   if (fragment.ha
+000be4e0: 735f 7661 6c75 6528 2929 207b 0a20 2020  s_value()) {.   
+000be4f0: 2075 726c 2e75 7064 6174 655f 756e 656e   url.update_unen
+000be500: 636f 6465 645f 6261 7365 5f68 6173 6828  coded_base_hash(
+000be510: 2a66 7261 676d 656e 7429 3b0a 2020 7d0a  *fragment);.  }.
+000be520: 2020 7265 7475 726e 2075 726c 3b0a 7d0a    return url;.}.
+000be530: 0a74 656d 706c 6174 6520 7572 6c20 7061  .template url pa
+000be540: 7273 655f 7572 6c3c 7572 6c3e 2873 7464  rse_url<url>(std
+000be550: 3a3a 7374 7269 6e67 5f76 6965 7720 7573  ::string_view us
+000be560: 6572 5f69 6e70 7574 2c0a 2020 2020 2020  er_input,.      
+000be570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000be580: 2020 2020 2020 636f 6e73 7420 7572 6c2a        const url*
+000be590: 2062 6173 655f 7572 6c20 3d20 6e75 6c6c   base_url = null
+000be5a0: 7074 7229 3b0a 7465 6d70 6c61 7465 2075  ptr);.template u
+000be5b0: 726c 5f61 6767 7265 6761 746f 7220 7061  rl_aggregator pa
+000be5c0: 7273 655f 7572 6c3c 7572 6c5f 6167 6772  rse_url<url_aggr
+000be5d0: 6567 6174 6f72 3e28 0a20 2020 2073 7464  egator>(.    std
+000be5e0: 3a3a 7374 7269 6e67 5f76 6965 7720 7573  ::string_view us
+000be5f0: 6572 5f69 6e70 7574 2c20 636f 6e73 7420  er_input, const 
+000be600: 7572 6c5f 6167 6772 6567 6174 6f72 2a20  url_aggregator* 
+000be610: 6261 7365 5f75 726c 203d 206e 756c 6c70  base_url = nullp
+000be620: 7472 293b 0a0a 7d20 202f 2f20 6e61 6d65  tr);..}  // name
+000be630: 7370 6163 6520 6164 613a 3a70 6172 7365  space ada::parse
+000be640: 720a 2f2a 2065 6e64 2066 696c 6520 7372  r./* end file sr
+000be650: 632f 7061 7273 6572 2e63 7070 202a 2f0a  c/parser.cpp */.
+000be660: 2f2a 2062 6567 696e 2066 696c 6520 7372  /* begin file sr
+000be670: 632f 7572 6c5f 636f 6d70 6f6e 656e 7473  c/url_components
+000be680: 2e63 7070 202a 2f0a 0a23 696e 636c 7564  .cpp */..#includ
+000be690: 6520 3c6e 756d 6572 6963 3e0a 2369 6e63  e <numeric>.#inc
+000be6a0: 6c75 6465 203c 7374 7269 6e67 3e0a 0a6e  lude <string>..n
+000be6b0: 616d 6573 7061 6365 2061 6461 207b 0a0a  amespace ada {..
+000be6c0: 626f 6f6c 2075 726c 5f63 6f6d 706f 6e65  bool url_compone
+000be6d0: 6e74 733a 3a63 6865 636b 5f6f 6666 7365  nts::check_offse
+000be6e0: 745f 636f 6e73 6973 7465 6e63 7928 2920  t_consistency() 
+000be6f0: 636f 6e73 7420 6e6f 6578 6365 7074 207b  const noexcept {
+000be700: 0a20 202f 2a2a 0a20 2020 2a20 6874 7470  .  /**.   * http
+000be710: 733a 2f2f 7573 6572 3a70 6173 7340 6578  s://user:pass@ex
+000be720: 616d 706c 652e 636f 6d3a 3132 3334 2f66  ample.com:1234/f
+000be730: 6f6f 2f62 6172 3f62 617a 2371 7575 780a  oo/bar?baz#quux.
+000be740: 2020 202a 2020 2020 2020 207c 2020 2020     *       |    
+000be750: 207c 2020 2020 7c20 2020 2020 2020 2020   |    |         
+000be760: 207c 205e 5e5e 5e7c 2020 2020 2020 207c   | ^^^^|       |
+000be770: 2020 207c 0a20 2020 2a20 2020 2020 2020     |.   *       
+000be780: 7c20 2020 2020 7c20 2020 207c 2020 2020  |     |    |    
+000be790: 2020 2020 2020 7c20 7c20 2020 7c20 2020        | |   |   
+000be7a0: 2020 2020 7c20 2020 602d 2d2d 2d2d 2068      |   `----- h
+000be7b0: 6173 685f 7374 6172 740a 2020 202a 2020  ash_start.   *  
+000be7c0: 2020 2020 207c 2020 2020 207c 2020 2020       |     |    
+000be7d0: 7c20 2020 2020 2020 2020 207c 207c 2020  |          | |  
+000be7e0: 207c 2020 2020 2020 2060 2d2d 2d2d 2d2d   |       `------
+000be7f0: 2d2d 2d20 7365 6172 6368 5f73 7461 7274  --- search_start
+000be800: 0a20 2020 2a20 2020 2020 2020 7c20 2020  .   *       |   
+000be810: 2020 7c20 2020 207c 2020 2020 2020 2020    |    |        
+000be820: 2020 7c20 7c20 2020 602d 2d2d 2d2d 2d2d    | |   `-------
+000be830: 2d2d 2d2d 2d2d 2d2d 2d2d 2070 6174 686e  ---------- pathn
+000be840: 616d 655f 7374 6172 740a 2020 202a 2020  ame_start.   *  
+000be850: 2020 2020 207c 2020 2020 207c 2020 2020       |     |    
+000be860: 7c20 2020 2020 2020 2020 207c 2060 2d2d  |          | `--
+000be870: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000be880: 2d2d 2d20 706f 7274 0a20 2020 2a20 2020  --- port.   *   
+000be890: 2020 2020 7c20 2020 2020 7c20 2020 207c      |     |    |
+000be8a0: 2020 2020 2020 2020 2020 602d 2d2d 2d2d            `-----
+000be8b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000be8c0: 2d2d 2068 6f73 745f 656e 640a 2020 202a  -- host_end.   *
+000be8d0: 2020 2020 2020 207c 2020 2020 207c 2020         |     |  
+000be8e0: 2020 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    `-------------
+000be8f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000be900: 2d2d 2d2d 2d20 686f 7374 5f73 7461 7274  ----- host_start
+000be910: 0a20 2020 2a20 2020 2020 2020 7c20 2020  .   *       |   
+000be920: 2020 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    `-------------
+000be930: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000be940: 2d2d 2d2d 2d2d 2d2d 2d2d 2075 7365 726e  ---------- usern
+000be950: 616d 655f 656e 640a 2020 202a 2020 2020  ame_end.   *    
+000be960: 2020 2060 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     `------------
+000be970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000be980: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000be990: 2d20 7072 6f74 6f63 6f6c 5f65 6e64 0a20  - protocol_end. 
+000be9a0: 2020 2a2f 0a20 202f 2f20 5468 6573 6520    */.  // These 
+000be9b0: 636f 6e64 6974 696f 6e73 2063 616e 2062  conditions can b
+000be9c0: 6520 6d61 6465 206d 6f72 6520 7374 7269  e made more stri
+000be9d0: 6374 2e0a 2020 7569 6e74 3332 5f74 2069  ct..  uint32_t i
+000be9e0: 6e64 6578 203d 2030 3b0a 0a20 2069 6620  ndex = 0;..  if 
+000be9f0: 2870 726f 746f 636f 6c5f 656e 6420 3d3d  (protocol_end ==
+000bea00: 2075 726c 5f63 6f6d 706f 6e65 6e74 733a   url_components:
+000bea10: 3a6f 6d69 7474 6564 2920 7b0a 2020 2020  :omitted) {.    
+000bea20: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000bea30: 7d0a 2020 6966 2028 7072 6f74 6f63 6f6c  }.  if (protocol
+000bea40: 5f65 6e64 203c 2069 6e64 6578 2920 7b0a  _end < index) {.
+000bea50: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000bea60: 3b0a 2020 7d0a 2020 696e 6465 7820 3d20  ;.  }.  index = 
+000bea70: 7072 6f74 6f63 6f6c 5f65 6e64 3b0a 0a20  protocol_end;.. 
+000bea80: 2069 6620 2875 7365 726e 616d 655f 656e   if (username_en
+000bea90: 6420 3d3d 2075 726c 5f63 6f6d 706f 6e65  d == url_compone
+000beaa0: 6e74 733a 3a6f 6d69 7474 6564 2920 7b0a  nts::omitted) {.
+000beab0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000beac0: 3b0a 2020 7d0a 2020 6966 2028 7573 6572  ;.  }.  if (user
+000bead0: 6e61 6d65 5f65 6e64 203c 2069 6e64 6578  name_end < index
+000beae0: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
+000beaf0: 616c 7365 3b0a 2020 7d0a 2020 696e 6465  alse;.  }.  inde
+000beb00: 7820 3d20 7573 6572 6e61 6d65 5f65 6e64  x = username_end
+000beb10: 3b0a 0a20 2069 6620 2868 6f73 745f 7374  ;..  if (host_st
+000beb20: 6172 7420 3d3d 2075 726c 5f63 6f6d 706f  art == url_compo
+000beb30: 6e65 6e74 733a 3a6f 6d69 7474 6564 2920  nents::omitted) 
+000beb40: 7b0a 2020 2020 7265 7475 726e 2066 616c  {.    return fal
+000beb50: 7365 3b0a 2020 7d0a 2020 6966 2028 686f  se;.  }.  if (ho
+000beb60: 7374 5f73 7461 7274 203c 2069 6e64 6578  st_start < index
+000beb70: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
+000beb80: 616c 7365 3b0a 2020 7d0a 2020 696e 6465  alse;.  }.  inde
+000beb90: 7820 3d20 686f 7374 5f73 7461 7274 3b0a  x = host_start;.
+000beba0: 0a20 2069 6620 2870 6f72 7420 213d 2075  .  if (port != u
+000bebb0: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
+000bebc0: 6d69 7474 6564 2920 7b0a 2020 2020 6966  mitted) {.    if
+000bebd0: 2028 706f 7274 203e 2030 7866 6666 6629   (port > 0xffff)
+000bebe0: 207b 0a20 2020 2020 2072 6574 7572 6e20   {.      return 
+000bebf0: 6661 6c73 653b 0a20 2020 207d 0a20 2020  false;.    }.   
+000bec00: 2075 696e 7433 325f 7420 706f 7274 5f6c   uint32_t port_l
+000bec10: 656e 6774 6820 3d20 6865 6c70 6572 733a  ength = helpers:
+000bec20: 3a66 6173 745f 6469 6769 745f 636f 756e  :fast_digit_coun
+000bec30: 7428 706f 7274 2920 2b20 313b 0a20 2020  t(port) + 1;.   
+000bec40: 2069 6620 2869 6e64 6578 202b 2070 6f72   if (index + por
+000bec50: 745f 6c65 6e67 7468 203c 2069 6e64 6578  t_length < index
+000bec60: 2920 7b0a 2020 2020 2020 7265 7475 726e  ) {.      return
+000bec70: 2066 616c 7365 3b0a 2020 2020 7d0a 2020   false;.    }.  
+000bec80: 2020 696e 6465 7820 2b3d 2070 6f72 745f    index += port_
+000bec90: 6c65 6e67 7468 3b0a 2020 7d0a 0a20 2069  length;.  }..  i
+000beca0: 6620 2870 6174 686e 616d 655f 7374 6172  f (pathname_star
+000becb0: 7420 3d3d 2075 726c 5f63 6f6d 706f 6e65  t == url_compone
+000becc0: 6e74 733a 3a6f 6d69 7474 6564 2920 7b0a  nts::omitted) {.
+000becd0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000bece0: 3b0a 2020 7d0a 2020 6966 2028 7061 7468  ;.  }.  if (path
+000becf0: 6e61 6d65 5f73 7461 7274 203c 2069 6e64  name_start < ind
+000bed00: 6578 2920 7b0a 2020 2020 7265 7475 726e  ex) {.    return
+000bed10: 2066 616c 7365 3b0a 2020 7d0a 2020 696e   false;.  }.  in
+000bed20: 6465 7820 3d20 7061 7468 6e61 6d65 5f73  dex = pathname_s
+000bed30: 7461 7274 3b0a 0a20 2069 6620 2873 6561  tart;..  if (sea
+000bed40: 7263 685f 7374 6172 7420 213d 2075 726c  rch_start != url
+000bed50: 5f63 6f6d 706f 6e65 6e74 733a 3a6f 6d69  _components::omi
+000bed60: 7474 6564 2920 7b0a 2020 2020 6966 2028  tted) {.    if (
+000bed70: 7365 6172 6368 5f73 7461 7274 203c 2069  search_start < i
+000bed80: 6e64 6578 2920 7b0a 2020 2020 2020 7265  ndex) {.      re
+000bed90: 7475 726e 2066 616c 7365 3b0a 2020 2020  turn false;.    
+000beda0: 7d0a 2020 2020 696e 6465 7820 3d20 7365  }.    index = se
+000bedb0: 6172 6368 5f73 7461 7274 3b0a 2020 7d0a  arch_start;.  }.
+000bedc0: 0a20 2069 6620 2868 6173 685f 7374 6172  .  if (hash_star
+000bedd0: 7420 213d 2075 726c 5f63 6f6d 706f 6e65  t != url_compone
+000bede0: 6e74 733a 3a6f 6d69 7474 6564 2920 7b0a  nts::omitted) {.
+000bedf0: 2020 2020 6966 2028 6861 7368 5f73 7461      if (hash_sta
+000bee00: 7274 203c 2069 6e64 6578 2920 7b0a 2020  rt < index) {.  
+000bee10: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000bee20: 3b0a 2020 2020 7d0a 2020 2020 696e 6465  ;.    }.    inde
+000bee30: 7820 3d20 6861 7368 5f73 7461 7274 3b0a  x = hash_start;.
+000bee40: 2020 7d0a 0a20 2072 6574 7572 6e20 7472    }..  return tr
+000bee50: 7565 3b0a 7d0a 0a73 7464 3a3a 7374 7269  ue;.}..std::stri
+000bee60: 6e67 2075 726c 5f63 6f6d 706f 6e65 6e74  ng url_component
+000bee70: 733a 3a74 6f5f 7374 7269 6e67 2829 2063  s::to_string() c
+000bee80: 6f6e 7374 207b 0a20 2073 7464 3a3a 7374  onst {.  std::st
+000bee90: 7269 6e67 2061 6e73 7765 723b 0a20 2061  ring answer;.  a
+000beea0: 7574 6f20 6261 636b 203d 2073 7464 3a3a  uto back = std::
+000beeb0: 6261 636b 5f69 6e73 6572 745f 6974 6572  back_insert_iter
+000beec0: 6174 6f72 2861 6e73 7765 7229 3b0a 2020  ator(answer);.  
+000beed0: 616e 7377 6572 2e61 7070 656e 6428 227b  answer.append("{
+000beee0: 5c6e 2229 3b0a 0a20 2061 6e73 7765 722e  \n");..  answer.
+000beef0: 6170 7065 6e64 2822 5c74 5c22 7072 6f74  append("\t\"prot
+000bef00: 6f63 6f6c 5f65 6e64 5c22 3a5c 2222 293b  ocol_end\":\"");
+000bef10: 0a20 2068 656c 7065 7273 3a3a 656e 636f  .  helpers::enco
+000bef20: 6465 5f6a 736f 6e28 7374 643a 3a74 6f5f  de_json(std::to_
+000bef30: 7374 7269 6e67 2870 726f 746f 636f 6c5f  string(protocol_
+000bef40: 656e 6429 2c20 6261 636b 293b 0a20 2061  end), back);.  a
+000bef50: 6e73 7765 722e 6170 7065 6e64 2822 5c22  nswer.append("\"
+000bef60: 2c5c 6e22 293b 0a0a 2020 616e 7377 6572  ,\n");..  answer
+000bef70: 2e61 7070 656e 6428 225c 745c 2275 7365  .append("\t\"use
+000bef80: 726e 616d 655f 656e 645c 223a 5c22 2229  rname_end\":\"")
+000bef90: 3b0a 2020 6865 6c70 6572 733a 3a65 6e63  ;.  helpers::enc
+000befa0: 6f64 655f 6a73 6f6e 2873 7464 3a3a 746f  ode_json(std::to
+000befb0: 5f73 7472 696e 6728 7573 6572 6e61 6d65  _string(username
+000befc0: 5f65 6e64 292c 2062 6163 6b29 3b0a 2020  _end), back);.  
+000befd0: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
+000befe0: 222c 5c6e 2229 3b0a 0a20 2061 6e73 7765  ",\n");..  answe
+000beff0: 722e 6170 7065 6e64 2822 5c74 5c22 686f  r.append("\t\"ho
+000bf000: 7374 5f73 7461 7274 5c22 3a5c 2222 293b  st_start\":\"");
+000bf010: 0a20 2068 656c 7065 7273 3a3a 656e 636f  .  helpers::enco
+000bf020: 6465 5f6a 736f 6e28 7374 643a 3a74 6f5f  de_json(std::to_
+000bf030: 7374 7269 6e67 2868 6f73 745f 7374 6172  string(host_star
+000bf040: 7429 2c20 6261 636b 293b 0a20 2061 6e73  t), back);.  ans
+000bf050: 7765 722e 6170 7065 6e64 2822 5c22 2c5c  wer.append("\",\
+000bf060: 6e22 293b 0a0a 2020 616e 7377 6572 2e61  n");..  answer.a
+000bf070: 7070 656e 6428 225c 745c 2268 6f73 745f  ppend("\t\"host_
+000bf080: 656e 645c 223a 5c22 2229 3b0a 2020 6865  end\":\"");.  he
+000bf090: 6c70 6572 733a 3a65 6e63 6f64 655f 6a73  lpers::encode_js
+000bf0a0: 6f6e 2873 7464 3a3a 746f 5f73 7472 696e  on(std::to_strin
+000bf0b0: 6728 686f 7374 5f65 6e64 292c 2062 6163  g(host_end), bac
+000bf0c0: 6b29 3b0a 2020 616e 7377 6572 2e61 7070  k);.  answer.app
+000bf0d0: 656e 6428 225c 222c 5c6e 2229 3b0a 0a20  end("\",\n");.. 
+000bf0e0: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
+000bf0f0: 5c74 5c22 706f 7274 5c22 3a5c 2222 293b  \t\"port\":\"");
+000bf100: 0a20 2068 656c 7065 7273 3a3a 656e 636f  .  helpers::enco
+000bf110: 6465 5f6a 736f 6e28 7374 643a 3a74 6f5f  de_json(std::to_
+000bf120: 7374 7269 6e67 2870 6f72 7429 2c20 6261  string(port), ba
+000bf130: 636b 293b 0a20 2061 6e73 7765 722e 6170  ck);.  answer.ap
+000bf140: 7065 6e64 2822 5c22 2c5c 6e22 293b 0a0a  pend("\",\n");..
+000bf150: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000bf160: 225c 745c 2270 6174 686e 616d 655f 7374  "\t\"pathname_st
+000bf170: 6172 745c 223a 5c22 2229 3b0a 2020 6865  art\":\"");.  he
+000bf180: 6c70 6572 733a 3a65 6e63 6f64 655f 6a73  lpers::encode_js
+000bf190: 6f6e 2873 7464 3a3a 746f 5f73 7472 696e  on(std::to_strin
+000bf1a0: 6728 7061 7468 6e61 6d65 5f73 7461 7274  g(pathname_start
+000bf1b0: 292c 2062 6163 6b29 3b0a 2020 616e 7377  ), back);.  answ
+000bf1c0: 6572 2e61 7070 656e 6428 225c 222c 5c6e  er.append("\",\n
+000bf1d0: 2229 3b0a 0a20 2061 6e73 7765 722e 6170  ");..  answer.ap
+000bf1e0: 7065 6e64 2822 5c74 5c22 7365 6172 6368  pend("\t\"search
+000bf1f0: 5f73 7461 7274 5c22 3a5c 2222 293b 0a20  _start\":\"");. 
+000bf200: 2068 656c 7065 7273 3a3a 656e 636f 6465   helpers::encode
+000bf210: 5f6a 736f 6e28 7374 643a 3a74 6f5f 7374  _json(std::to_st
+000bf220: 7269 6e67 2873 6561 7263 685f 7374 6172  ring(search_star
+000bf230: 7429 2c20 6261 636b 293b 0a20 2061 6e73  t), back);.  ans
+000bf240: 7765 722e 6170 7065 6e64 2822 5c22 2c5c  wer.append("\",\
+000bf250: 6e22 293b 0a0a 2020 616e 7377 6572 2e61  n");..  answer.a
+000bf260: 7070 656e 6428 225c 745c 2268 6173 685f  ppend("\t\"hash_
+000bf270: 7374 6172 745c 223a 5c22 2229 3b0a 2020  start\":\"");.  
+000bf280: 6865 6c70 6572 733a 3a65 6e63 6f64 655f  helpers::encode_
+000bf290: 6a73 6f6e 2873 7464 3a3a 746f 5f73 7472  json(std::to_str
+000bf2a0: 696e 6728 6861 7368 5f73 7461 7274 292c  ing(hash_start),
+000bf2b0: 2062 6163 6b29 3b0a 2020 616e 7377 6572   back);.  answer
+000bf2c0: 2e61 7070 656e 6428 225c 222c 5c6e 2229  .append("\",\n")
+000bf2d0: 3b0a 0a20 2061 6e73 7765 722e 6170 7065  ;..  answer.appe
+000bf2e0: 6e64 2822 5c6e 7d22 293b 0a20 2072 6574  nd("\n}");.  ret
+000bf2f0: 7572 6e20 616e 7377 6572 3b0a 7d0a 0a7d  urn answer;.}..}
+000bf300: 2020 2f2f 206e 616d 6573 7061 6365 2061    // namespace a
+000bf310: 6461 0a2f 2a20 656e 6420 6669 6c65 2073  da./* end file s
+000bf320: 7263 2f75 726c 5f63 6f6d 706f 6e65 6e74  rc/url_component
+000bf330: 732e 6370 7020 2a2f 0a2f 2a20 6265 6769  s.cpp */./* begi
+000bf340: 6e20 6669 6c65 2073 7263 2f75 726c 5f61  n file src/url_a
+000bf350: 6767 7265 6761 746f 722e 6370 7020 2a2f  ggregator.cpp */
+000bf360: 0a0a 2369 6e63 6c75 6465 203c 7374 7269  ..#include <stri
+000bf370: 6e67 3e0a 2369 6e63 6c75 6465 203c 7374  ng>.#include <st
+000bf380: 7269 6e67 5f76 6965 773e 0a0a 6e61 6d65  ring_view>..name
+000bf390: 7370 6163 6520 6164 6120 7b0a 7465 6d70  space ada {.temp
+000bf3a0: 6c61 7465 203c 626f 6f6c 2068 6173 5f73  late <bool has_s
+000bf3b0: 7461 7465 5f6f 7665 7272 6964 653e 0a5b  tate_override>.[
+000bf3c0: 5b6e 6f64 6973 6361 7264 5d5d 2061 6461  [nodiscard]] ada
+000bf3d0: 5f72 6561 6c6c 795f 696e 6c69 6e65 2062  _really_inline b
+000bf3e0: 6f6f 6c20 7572 6c5f 6167 6772 6567 6174  ool url_aggregat
+000bf3f0: 6f72 3a3a 7061 7273 655f 7363 6865 6d65  or::parse_scheme
+000bf400: 5f77 6974 685f 636f 6c6f 6e28 0a20 2020  _with_colon(.   
+000bf410: 2063 6f6e 7374 2073 7464 3a3a 7374 7269   const std::stri
+000bf420: 6e67 5f76 6965 7720 696e 7075 745f 7769  ng_view input_wi
+000bf430: 7468 5f63 6f6c 6f6e 2920 7b0a 2020 6164  th_colon) {.  ad
+000bf440: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
+000bf450: 6761 746f 723a 3a70 6172 7365 5f73 6368  gator::parse_sch
+000bf460: 656d 655f 7769 7468 5f63 6f6c 6f6e 2022  eme_with_colon "
+000bf470: 2c20 696e 7075 745f 7769 7468 5f63 6f6c  , input_with_col
+000bf480: 6f6e 293b 0a20 2041 4441 5f41 5353 4552  on);.  ADA_ASSER
+000bf490: 545f 5452 5545 2876 616c 6964 6174 6528  T_TRUE(validate(
+000bf4a0: 2929 3b0a 2020 4144 415f 4153 5345 5254  ));.  ADA_ASSERT
+000bf4b0: 5f54 5255 4528 2168 656c 7065 7273 3a3a  _TRUE(!helpers::
+000bf4c0: 6f76 6572 6c61 7073 2869 6e70 7574 5f77  overlaps(input_w
+000bf4d0: 6974 685f 636f 6c6f 6e2c 2062 7566 6665  ith_colon, buffe
+000bf4e0: 7229 293b 0a20 2073 7464 3a3a 7374 7269  r));.  std::stri
+000bf4f0: 6e67 5f76 6965 7720 696e 7075 747b 696e  ng_view input{in
+000bf500: 7075 745f 7769 7468 5f63 6f6c 6f6e 7d3b  put_with_colon};
+000bf510: 0a20 2069 6e70 7574 2e72 656d 6f76 655f  .  input.remove_
+000bf520: 7375 6666 6978 2831 293b 0a20 2061 7574  suffix(1);.  aut
+000bf530: 6f20 7061 7273 6564 5f74 7970 6520 3d20  o parsed_type = 
+000bf540: 6164 613a 3a73 6368 656d 653a 3a67 6574  ada::scheme::get
+000bf550: 5f73 6368 656d 655f 7479 7065 2869 6e70  _scheme_type(inp
+000bf560: 7574 293b 0a20 2062 6f6f 6c20 6973 5f69  ut);.  bool is_i
+000bf570: 6e70 7574 5f73 7065 6369 616c 203d 2028  nput_special = (
+000bf580: 7061 7273 6564 5f74 7970 6520 213d 2061  parsed_type != a
+000bf590: 6461 3a3a 7363 6865 6d65 3a3a 4e4f 545f  da::scheme::NOT_
+000bf5a0: 5350 4543 4941 4c29 3b0a 2020 2f2a 2a0a  SPECIAL);.  /**.
+000bf5b0: 2020 202a 2049 6e20 7468 6520 636f 6d6d     * In the comm
+000bf5c0: 6f6e 2063 6173 652c 2077 6520 7769 6c6c  on case, we will
+000bf5d0: 2069 6d6d 6564 6961 7465 6c79 2072 6563   immediately rec
+000bf5e0: 6f67 6e69 7a65 2061 2073 7065 6369 616c  ognize a special
+000bf5f0: 2073 6368 656d 6520 2865 2e67 2e2c 0a20   scheme (e.g.,. 
+000bf600: 2020 2a68 7474 702c 2068 7474 7073 292c    *http, https),
+000bf610: 2069 6e20 7768 6963 6820 6361 7365 2c20   in which case, 
+000bf620: 7765 2063 616e 2067 6f20 7265 616c 6c79  we can go really
+000bf630: 2066 6173 742e 0a20 2020 2a2a 2f0a 2020   fast..   **/.  
+000bf640: 6966 2028 6973 5f69 6e70 7574 5f73 7065  if (is_input_spe
+000bf650: 6369 616c 2920 7b20 202f 2f20 6661 7374  cial) {  // fast
+000bf660: 2070 6174 6821 2121 0a20 2020 2069 6620   path!!!.    if 
+000bf670: 2868 6173 5f73 7461 7465 5f6f 7665 7272  (has_state_overr
+000bf680: 6964 6529 207b 0a20 2020 2020 202f 2f20  ide) {.      // 
+000bf690: 4966 2075 726c e280 9973 2073 6368 656d  If url...s schem
+000bf6a0: 6520 6973 206e 6f74 2061 2073 7065 6369  e is not a speci
+000bf6b0: 616c 2073 6368 656d 6520 616e 6420 6275  al scheme and bu
+000bf6c0: 6666 6572 2069 7320 6120 7370 6563 6961  ffer is a specia
+000bf6d0: 6c20 7363 6865 6d65 2c0a 2020 2020 2020  l scheme,.      
+000bf6e0: 2f2f 2074 6865 6e20 7265 7475 726e 2e0a  // then return..
+000bf6f0: 2020 2020 2020 6966 2028 6973 5f73 7065        if (is_spe
+000bf700: 6369 616c 2829 2021 3d20 6973 5f69 6e70  cial() != is_inp
+000bf710: 7574 5f73 7065 6369 616c 2920 7b0a 2020  ut_special) {.  
+000bf720: 2020 2020 2020 7265 7475 726e 2074 7275        return tru
+000bf730: 653b 0a20 2020 2020 207d 0a0a 2020 2020  e;.      }..    
+000bf740: 2020 2f2f 2049 6620 7572 6c20 696e 636c    // If url incl
+000bf750: 7564 6573 2063 7265 6465 6e74 6961 6c73  udes credentials
+000bf760: 206f 7220 6861 7320 6120 6e6f 6e2d 6e75   or has a non-nu
+000bf770: 6c6c 2070 6f72 742c 2061 6e64 2062 7566  ll port, and buf
+000bf780: 6665 7220 6973 0a20 2020 2020 202f 2f20  fer is.      // 
+000bf790: 2266 696c 6522 2c20 7468 656e 2072 6574  "file", then ret
+000bf7a0: 7572 6e2e 0a20 2020 2020 2069 6620 2828  urn..      if ((
+000bf7b0: 6861 735f 6372 6564 656e 7469 616c 7328  has_credentials(
+000bf7c0: 2920 7c7c 2063 6f6d 706f 6e65 6e74 732e  ) || components.
+000bf7d0: 706f 7274 2021 3d20 7572 6c5f 636f 6d70  port != url_comp
+000bf7e0: 6f6e 656e 7473 3a3a 6f6d 6974 7465 6429  onents::omitted)
+000bf7f0: 2026 260a 2020 2020 2020 2020 2020 7061   &&.          pa
+000bf800: 7273 6564 5f74 7970 6520 3d3d 2061 6461  rsed_type == ada
+000bf810: 3a3a 7363 6865 6d65 3a3a 7479 7065 3a3a  ::scheme::type::
+000bf820: 4649 4c45 2920 7b0a 2020 2020 2020 2020  FILE) {.        
+000bf830: 7265 7475 726e 2074 7275 653b 0a20 2020  return true;.   
+000bf840: 2020 207d 0a0a 2020 2020 2020 2f2f 2049     }..      // I
+000bf850: 6620 7572 6ce2 8099 7320 7363 6865 6d65  f url...s scheme
+000bf860: 2069 7320 2266 696c 6522 2061 6e64 2069   is "file" and i
+000bf870: 7473 2068 6f73 7420 6973 2061 6e20 656d  ts host is an em
+000bf880: 7074 7920 686f 7374 2c20 7468 656e 2072  pty host, then r
+000bf890: 6574 7572 6e2e 0a20 2020 2020 202f 2f20  eturn..      // 
+000bf8a0: 416e 2065 6d70 7479 2068 6f73 7420 6973  An empty host is
+000bf8b0: 2074 6865 2065 6d70 7479 2073 7472 696e   the empty strin
+000bf8c0: 672e 0a20 2020 2020 2069 6620 2874 7970  g..      if (typ
+000bf8d0: 6520 3d3d 2061 6461 3a3a 7363 6865 6d65  e == ada::scheme
+000bf8e0: 3a3a 7479 7065 3a3a 4649 4c45 2026 260a  ::type::FILE &&.
+000bf8f0: 2020 2020 2020 2020 2020 636f 6d70 6f6e            compon
+000bf900: 656e 7473 2e68 6f73 745f 7374 6172 7420  ents.host_start 
+000bf910: 3d3d 2063 6f6d 706f 6e65 6e74 732e 686f  == components.ho
+000bf920: 7374 5f65 6e64 2920 7b0a 2020 2020 2020  st_end) {.      
+000bf930: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
+000bf940: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
+000bf950: 2020 7479 7065 203d 2070 6172 7365 645f    type = parsed_
+000bf960: 7479 7065 3b0a 2020 2020 7365 745f 7363  type;.    set_sc
+000bf970: 6865 6d65 5f66 726f 6d5f 7669 6577 5f77  heme_from_view_w
+000bf980: 6974 685f 636f 6c6f 6e28 696e 7075 745f  ith_colon(input_
+000bf990: 7769 7468 5f63 6f6c 6f6e 293b 0a0a 2020  with_colon);..  
+000bf9a0: 2020 6966 2028 6861 735f 7374 6174 655f    if (has_state_
+000bf9b0: 6f76 6572 7269 6465 2920 7b0a 2020 2020  override) {.    
+000bf9c0: 2020 2f2f 2054 6869 7320 6973 2075 6e63    // This is unc
+000bf9d0: 6f6d 6d6f 6e2e 0a20 2020 2020 2075 696e  ommon..      uin
+000bf9e0: 7431 365f 7420 7572 6c73 5f73 6368 656d  t16_t urls_schem
+000bf9f0: 655f 706f 7274 203d 2067 6574 5f73 7065  e_port = get_spe
+000bfa00: 6369 616c 5f70 6f72 7428 293b 0a0a 2020  cial_port();..  
+000bfa10: 2020 2020 2f2f 2049 6620 7572 6ce2 8099      // If url...
+000bfa20: 7320 706f 7274 2069 7320 7572 6ce2 8099  s port is url...
+000bfa30: 7320 7363 6865 6d65 e280 9973 2064 6566  s scheme...s def
+000bfa40: 6175 6c74 2070 6f72 742c 2074 6865 6e20  ault port, then 
+000bfa50: 7365 7420 7572 6ce2 8099 7320 706f 7274  set url...s port
+000bfa60: 2074 6f0a 2020 2020 2020 2f2f 206e 756c   to.      // nul
+000bfa70: 6c2e 0a20 2020 2020 2069 6620 2863 6f6d  l..      if (com
+000bfa80: 706f 6e65 6e74 732e 706f 7274 203d 3d20  ponents.port == 
+000bfa90: 7572 6c73 5f73 6368 656d 655f 706f 7274  urls_scheme_port
+000bfaa0: 2920 7b0a 2020 2020 2020 2020 636c 6561  ) {.        clea
+000bfab0: 725f 706f 7274 2829 3b0a 2020 2020 2020  r_port();.      
+000bfac0: 7d0a 2020 2020 7d0a 2020 7d20 656c 7365  }.    }.  } else
+000bfad0: 207b 2020 2f2f 2073 6c6f 7720 7061 7468   {  // slow path
+000bfae0: 0a20 2020 2073 7464 3a3a 7374 7269 6e67  .    std::string
+000bfaf0: 205f 6275 6666 6572 203d 2073 7464 3a3a   _buffer = std::
+000bfb00: 7374 7269 6e67 2869 6e70 7574 293b 0a20  string(input);. 
+000bfb10: 2020 202f 2f20 4e65 7874 2066 756e 6374     // Next funct
+000bfb20: 696f 6e20 6973 206f 6e6c 7920 7661 6c69  ion is only vali
+000bfb30: 6420 6966 2074 6865 2069 6e70 7574 2069  d if the input i
+000bfb40: 7320 4153 4349 4920 616e 6420 7265 7475  s ASCII and retu
+000bfb50: 726e 7320 6661 6c73 650a 2020 2020 2f2f  rns false.    //
+000bfb60: 206f 7468 6572 7769 7365 2c20 6275 7420   otherwise, but 
+000bfb70: 6974 2073 6565 6d73 2074 6861 7420 7765  it seems that we
+000bfb80: 2061 6c77 6179 7320 6861 7665 2061 7363   always have asc
+000bfb90: 6969 2063 6f6e 7465 6e74 2073 6f20 7765  ii content so we
+000bfba0: 2064 6f20 6e6f 740a 2020 2020 2f2f 206e   do not.    // n
+000bfbb0: 6565 6420 746f 2063 6865 636b 2074 6865  eed to check the
+000bfbc0: 2072 6574 7572 6e20 7661 6c75 652e 0a20   return value.. 
+000bfbd0: 2020 2075 6e69 636f 6465 3a3a 746f 5f6c     unicode::to_l
+000bfbe0: 6f77 6572 5f61 7363 6969 285f 6275 6666  ower_ascii(_buff
+000bfbf0: 6572 2e64 6174 6128 292c 205f 6275 6666  er.data(), _buff
+000bfc00: 6572 2e73 697a 6528 2929 3b0a 0a20 2020  er.size());..   
+000bfc10: 2069 6620 2868 6173 5f73 7461 7465 5f6f   if (has_state_o
+000bfc20: 7665 7272 6964 6529 207b 0a20 2020 2020  verride) {.     
+000bfc30: 202f 2f20 4966 2075 726c e280 9973 2073   // If url...s s
+000bfc40: 6368 656d 6520 6973 2061 2073 7065 6369  cheme is a speci
+000bfc50: 616c 2073 6368 656d 6520 616e 6420 6275  al scheme and bu
+000bfc60: 6666 6572 2069 7320 6e6f 7420 6120 7370  ffer is not a sp
+000bfc70: 6563 6961 6c20 7363 6865 6d65 2c0a 2020  ecial scheme,.  
+000bfc80: 2020 2020 2f2f 2074 6865 6e20 7265 7475      // then retu
+000bfc90: 726e 2e20 4966 2075 726c e280 9973 2073  rn. If url...s s
+000bfca0: 6368 656d 6520 6973 206e 6f74 2061 2073  cheme is not a s
+000bfcb0: 7065 6369 616c 2073 6368 656d 6520 616e  pecial scheme an
+000bfcc0: 6420 6275 6666 6572 2069 7320 610a 2020  d buffer is a.  
+000bfcd0: 2020 2020 2f2f 2073 7065 6369 616c 2073      // special s
+000bfce0: 6368 656d 652c 2074 6865 6e20 7265 7475  cheme, then retu
+000bfcf0: 726e 2e0a 2020 2020 2020 6966 2028 6973  rn..      if (is
+000bfd00: 5f73 7065 6369 616c 2829 2021 3d20 6164  _special() != ad
+000bfd10: 613a 3a73 6368 656d 653a 3a69 735f 7370  a::scheme::is_sp
+000bfd20: 6563 6961 6c28 5f62 7566 6665 7229 2920  ecial(_buffer)) 
+000bfd30: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+000bfd40: 2074 7275 653b 0a20 2020 2020 207d 0a0a   true;.      }..
+000bfd50: 2020 2020 2020 2f2f 2049 6620 7572 6c20        // If url 
+000bfd60: 696e 636c 7564 6573 2063 7265 6465 6e74  includes credent
+000bfd70: 6961 6c73 206f 7220 6861 7320 6120 6e6f  ials or has a no
+000bfd80: 6e2d 6e75 6c6c 2070 6f72 742c 2061 6e64  n-null port, and
+000bfd90: 2062 7566 6665 7220 6973 0a20 2020 2020   buffer is.     
+000bfda0: 202f 2f20 2266 696c 6522 2c20 7468 656e   // "file", then
+000bfdb0: 2072 6574 7572 6e2e 0a20 2020 2020 2069   return..      i
+000bfdc0: 6620 2828 6861 735f 6372 6564 656e 7469  f ((has_credenti
+000bfdd0: 616c 7328 2920 7c7c 2063 6f6d 706f 6e65  als() || compone
+000bfde0: 6e74 732e 706f 7274 2021 3d20 7572 6c5f  nts.port != url_
+000bfdf0: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
+000bfe00: 7465 6429 2026 260a 2020 2020 2020 2020  ted) &&.        
+000bfe10: 2020 5f62 7566 6665 7220 3d3d 2022 6669    _buffer == "fi
+000bfe20: 6c65 2229 207b 0a20 2020 2020 2020 2072  le") {.        r
+000bfe30: 6574 7572 6e20 7472 7565 3b0a 2020 2020  eturn true;.    
+000bfe40: 2020 7d0a 0a20 2020 2020 202f 2f20 4966    }..      // If
+000bfe50: 2075 726c e280 9973 2073 6368 656d 6520   url...s scheme 
+000bfe60: 6973 2022 6669 6c65 2220 616e 6420 6974  is "file" and it
+000bfe70: 7320 686f 7374 2069 7320 616e 2065 6d70  s host is an emp
+000bfe80: 7479 2068 6f73 742c 2074 6865 6e20 7265  ty host, then re
+000bfe90: 7475 726e 2e0a 2020 2020 2020 2f2f 2041  turn..      // A
+000bfea0: 6e20 656d 7074 7920 686f 7374 2069 7320  n empty host is 
+000bfeb0: 7468 6520 656d 7074 7920 7374 7269 6e67  the empty string
+000bfec0: 2e0a 2020 2020 2020 6966 2028 7479 7065  ..      if (type
+000bfed0: 203d 3d20 6164 613a 3a73 6368 656d 653a   == ada::scheme:
+000bfee0: 3a74 7970 653a 3a46 494c 4520 2626 0a20  :type::FILE &&. 
+000bfef0: 2020 2020 2020 2020 2063 6f6d 706f 6e65           compone
+000bff00: 6e74 732e 686f 7374 5f73 7461 7274 203d  nts.host_start =
+000bff10: 3d20 636f 6d70 6f6e 656e 7473 2e68 6f73  = components.hos
+000bff20: 745f 656e 6429 207b 0a20 2020 2020 2020  t_end) {.       
+000bff30: 2072 6574 7572 6e20 7472 7565 3b0a 2020   return true;.  
+000bff40: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+000bff50: 2073 6574 5f73 6368 656d 6528 5f62 7566   set_scheme(_buf
+000bff60: 6665 7229 3b0a 0a20 2020 2069 6620 2868  fer);..    if (h
+000bff70: 6173 5f73 7461 7465 5f6f 7665 7272 6964  as_state_overrid
+000bff80: 6529 207b 0a20 2020 2020 202f 2f20 5468  e) {.      // Th
+000bff90: 6973 2069 7320 756e 636f 6d6d 6f6e 2e0a  is is uncommon..
+000bffa0: 2020 2020 2020 7569 6e74 3136 5f74 2075        uint16_t u
+000bffb0: 726c 735f 7363 6865 6d65 5f70 6f72 7420  rls_scheme_port 
+000bffc0: 3d20 6765 745f 7370 6563 6961 6c5f 706f  = get_special_po
+000bffd0: 7274 2829 3b0a 0a20 2020 2020 202f 2f20  rt();..      // 
+000bffe0: 4966 2075 726c e280 9973 2070 6f72 7420  If url...s port 
+000bfff0: 6973 2075 726c e280 9973 2073 6368 656d  is url...s schem
+000c0000: 65e2 8099 7320 6465 6661 756c 7420 706f  e...s default po
+000c0010: 7274 2c20 7468 656e 2073 6574 2075 726c  rt, then set url
+000c0020: e280 9973 2070 6f72 7420 746f 0a20 2020  ...s port to.   
+000c0030: 2020 202f 2f20 6e75 6c6c 2e0a 2020 2020     // null..    
+000c0040: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
+000c0050: 2e70 6f72 7420 3d3d 2075 726c 735f 7363  .port == urls_sc
+000c0060: 6865 6d65 5f70 6f72 7429 207b 0a20 2020  heme_port) {.   
+000c0070: 2020 2020 2063 6c65 6172 5f70 6f72 7428       clear_port(
+000c0080: 293b 0a20 2020 2020 207d 0a20 2020 207d  );.      }.    }
+000c0090: 0a20 207d 0a20 2041 4441 5f41 5353 4552  .  }.  ADA_ASSER
+000c00a0: 545f 5452 5545 2876 616c 6964 6174 6528  T_TRUE(validate(
+000c00b0: 2929 3b0a 2020 7265 7475 726e 2074 7275  ));.  return tru
+000c00c0: 653b 0a7d 0a0a 696e 6c69 6e65 2076 6f69  e;.}..inline voi
+000c00d0: 6420 7572 6c5f 6167 6772 6567 6174 6f72  d url_aggregator
+000c00e0: 3a3a 636f 7079 5f73 6368 656d 6528 636f  ::copy_scheme(co
+000c00f0: 6e73 7420 7572 6c5f 6167 6772 6567 6174  nst url_aggregat
+000c0100: 6f72 2620 7529 206e 6f65 7863 6570 7420  or& u) noexcept 
+000c0110: 7b0a 2020 6164 615f 6c6f 6728 2275 726c  {.  ada_log("url
+000c0120: 5f61 6767 7265 6761 746f 723a 3a63 6f70  _aggregator::cop
+000c0130: 795f 7363 6865 6d65 2022 2c20 752e 6275  y_scheme ", u.bu
+000c0140: 6666 6572 293b 0a20 2041 4441 5f41 5353  ffer);.  ADA_ASS
+000c0150: 4552 545f 5452 5545 2876 616c 6964 6174  ERT_TRUE(validat
+000c0160: 6528 2929 3b0a 2020 2f2f 206e 6578 7420  e());.  // next 
+000c0170: 6c69 6e65 2063 6f75 6c64 206f 7665 7266  line could overf
+000c0180: 6c6f 7720 6275 7420 756e 7369 676e 6564  low but unsigned
+000c0190: 2061 7269 7468 6d65 7469 6320 6861 7320   arithmetic has 
+000c01a0: 7765 6c6c 2d64 6566 696e 6564 0a20 202f  well-defined.  /
+000c01b0: 2f20 6f76 6572 666c 6f77 732e 0a20 2075  / overflows..  u
+000c01c0: 696e 7433 325f 7420 6e65 775f 6469 6666  int32_t new_diff
+000c01d0: 6572 656e 6365 203d 2075 2e63 6f6d 706f  erence = u.compo
+000c01e0: 6e65 6e74 732e 7072 6f74 6f63 6f6c 5f65  nents.protocol_e
+000c01f0: 6e64 202d 2063 6f6d 706f 6e65 6e74 732e  nd - components.
+000c0200: 7072 6f74 6f63 6f6c 5f65 6e64 3b0a 2020  protocol_end;.  
+000c0210: 7479 7065 203d 2075 2e74 7970 653b 0a20  type = u.type;. 
+000c0220: 2062 7566 6665 722e 6572 6173 6528 302c   buffer.erase(0,
+000c0230: 2063 6f6d 706f 6e65 6e74 732e 7072 6f74   components.prot
+000c0240: 6f63 6f6c 5f65 6e64 293b 0a20 2062 7566  ocol_end);.  buf
+000c0250: 6665 722e 696e 7365 7274 2830 2c20 752e  fer.insert(0, u.
+000c0260: 6765 745f 7072 6f74 6f63 6f6c 2829 293b  get_protocol());
+000c0270: 0a20 2063 6f6d 706f 6e65 6e74 732e 7072  .  components.pr
+000c0280: 6f74 6f63 6f6c 5f65 6e64 203d 2075 2e63  otocol_end = u.c
+000c0290: 6f6d 706f 6e65 6e74 732e 7072 6f74 6f63  omponents.protoc
+000c02a0: 6f6c 5f65 6e64 3b0a 0a20 202f 2f20 4e6f  ol_end;..  // No
+000c02b0: 206e 6565 6420 746f 2075 7064 6174 6520   need to update 
+000c02c0: 7468 6520 636f 6d70 6f6e 656e 7473 0a20  the components. 
+000c02d0: 2069 6620 286e 6577 5f64 6966 6665 7265   if (new_differe
+000c02e0: 6e63 6520 3d3d 2030 2920 7b0a 2020 2020  nce == 0) {.    
+000c02f0: 7265 7475 726e 3b0a 2020 7d0a 0a20 202f  return;.  }..  /
+000c0300: 2f20 5570 6461 7465 2074 6865 2072 6573  / Update the res
+000c0310: 7420 6f66 2074 6865 2063 6f6d 706f 6e65  t of the compone
+000c0320: 6e74 732e 0a20 2063 6f6d 706f 6e65 6e74  nts..  component
+000c0330: 732e 7573 6572 6e61 6d65 5f65 6e64 202b  s.username_end +
+000c0340: 3d20 6e65 775f 6469 6666 6572 656e 6365  = new_difference
+000c0350: 3b0a 2020 636f 6d70 6f6e 656e 7473 2e68  ;.  components.h
+000c0360: 6f73 745f 7374 6172 7420 2b3d 206e 6577  ost_start += new
+000c0370: 5f64 6966 6665 7265 6e63 653b 0a20 2063  _difference;.  c
+000c0380: 6f6d 706f 6e65 6e74 732e 686f 7374 5f65  omponents.host_e
+000c0390: 6e64 202b 3d20 6e65 775f 6469 6666 6572  nd += new_differ
+000c03a0: 656e 6365 3b0a 2020 636f 6d70 6f6e 656e  ence;.  componen
+000c03b0: 7473 2e70 6174 686e 616d 655f 7374 6172  ts.pathname_star
+000c03c0: 7420 2b3d 206e 6577 5f64 6966 6665 7265  t += new_differe
+000c03d0: 6e63 653b 0a20 2069 6620 2863 6f6d 706f  nce;.  if (compo
+000c03e0: 6e65 6e74 732e 7365 6172 6368 5f73 7461  nents.search_sta
+000c03f0: 7274 2021 3d20 7572 6c5f 636f 6d70 6f6e  rt != url_compon
+000c0400: 656e 7473 3a3a 6f6d 6974 7465 6429 207b  ents::omitted) {
+000c0410: 0a20 2020 2063 6f6d 706f 6e65 6e74 732e  .    components.
+000c0420: 7365 6172 6368 5f73 7461 7274 202b 3d20  search_start += 
+000c0430: 6e65 775f 6469 6666 6572 656e 6365 3b0a  new_difference;.
+000c0440: 2020 7d0a 2020 6966 2028 636f 6d70 6f6e    }.  if (compon
+000c0450: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
+000c0460: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
+000c0470: 733a 3a6f 6d69 7474 6564 2920 7b0a 2020  s::omitted) {.  
+000c0480: 2020 636f 6d70 6f6e 656e 7473 2e68 6173    components.has
+000c0490: 685f 7374 6172 7420 2b3d 206e 6577 5f64  h_start += new_d
+000c04a0: 6966 6665 7265 6e63 653b 0a20 207d 0a20  ifference;.  }. 
+000c04b0: 2041 4441 5f41 5353 4552 545f 5452 5545   ADA_ASSERT_TRUE
+000c04c0: 2876 616c 6964 6174 6528 2929 3b0a 7d0a  (validate());.}.
+000c04d0: 0a69 6e6c 696e 6520 766f 6964 2075 726c  .inline void url
+000c04e0: 5f61 6767 7265 6761 746f 723a 3a73 6574  _aggregator::set
+000c04f0: 5f73 6368 656d 655f 6672 6f6d 5f76 6965  _scheme_from_vie
+000c0500: 775f 7769 7468 5f63 6f6c 6f6e 280a 2020  w_with_colon(.  
+000c0510: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
+000c0520: 6577 206e 6577 5f73 6368 656d 655f 7769  ew new_scheme_wi
+000c0530: 7468 5f63 6f6c 6f6e 2920 6e6f 6578 6365  th_colon) noexce
+000c0540: 7074 207b 0a20 2061 6461 5f6c 6f67 2822  pt {.  ada_log("
+000c0550: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
+000c0560: 7365 745f 7363 6865 6d65 5f66 726f 6d5f  set_scheme_from_
+000c0570: 7669 6577 5f77 6974 685f 636f 6c6f 6e20  view_with_colon 
+000c0580: 222c 0a20 2020 2020 2020 2020 206e 6577  ",.          new
+000c0590: 5f73 6368 656d 655f 7769 7468 5f63 6f6c  _scheme_with_col
+000c05a0: 6f6e 293b 0a20 2041 4441 5f41 5353 4552  on);.  ADA_ASSER
+000c05b0: 545f 5452 5545 2876 616c 6964 6174 6528  T_TRUE(validate(
+000c05c0: 2929 3b0a 2020 4144 415f 4153 5345 5254  ));.  ADA_ASSERT
+000c05d0: 5f54 5255 4528 216e 6577 5f73 6368 656d  _TRUE(!new_schem
+000c05e0: 655f 7769 7468 5f63 6f6c 6f6e 2e65 6d70  e_with_colon.emp
+000c05f0: 7479 2829 2026 260a 2020 2020 2020 2020  ty() &&.        
+000c0600: 2020 2020 2020 2020 2020 6e65 775f 7363            new_sc
+000c0610: 6865 6d65 5f77 6974 685f 636f 6c6f 6e2e  heme_with_colon.
+000c0620: 6261 636b 2829 203d 3d20 273a 2729 3b0a  back() == ':');.
+000c0630: 2020 2f2f 206e 6578 7420 6c69 6e65 2063    // next line c
+000c0640: 6f75 6c64 206f 7665 7266 6c6f 7720 6275  ould overflow bu
+000c0650: 7420 756e 7369 676e 6564 2061 7269 7468  t unsigned arith
+000c0660: 6d65 7469 6320 6861 7320 7765 6c6c 2d64  metic has well-d
+000c0670: 6566 696e 6564 0a20 202f 2f20 6f76 6572  efined.  // over
+000c0680: 666c 6f77 732e 0a20 2075 696e 7433 325f  flows..  uint32_
+000c0690: 7420 6e65 775f 6469 6666 6572 656e 6365  t new_difference
+000c06a0: 203d 0a20 2020 2020 2075 696e 7433 325f   =.      uint32_
+000c06b0: 7428 6e65 775f 7363 6865 6d65 5f77 6974  t(new_scheme_wit
+000c06c0: 685f 636f 6c6f 6e2e 7369 7a65 2829 2920  h_colon.size()) 
+000c06d0: 2d20 636f 6d70 6f6e 656e 7473 2e70 726f  - components.pro
+000c06e0: 746f 636f 6c5f 656e 643b 0a0a 2020 6966  tocol_end;..  if
+000c06f0: 2028 6275 6666 6572 2e65 6d70 7479 2829   (buffer.empty()
+000c0700: 2920 7b0a 2020 2020 6275 6666 6572 2e61  ) {.    buffer.a
+000c0710: 7070 656e 6428 6e65 775f 7363 6865 6d65  ppend(new_scheme
+000c0720: 5f77 6974 685f 636f 6c6f 6e29 3b0a 2020  _with_colon);.  
+000c0730: 7d20 656c 7365 207b 0a20 2020 2062 7566  } else {.    buf
+000c0740: 6665 722e 6572 6173 6528 302c 2063 6f6d  fer.erase(0, com
+000c0750: 706f 6e65 6e74 732e 7072 6f74 6f63 6f6c  ponents.protocol
+000c0760: 5f65 6e64 293b 0a20 2020 2062 7566 6665  _end);.    buffe
+000c0770: 722e 696e 7365 7274 2830 2c20 6e65 775f  r.insert(0, new_
+000c0780: 7363 6865 6d65 5f77 6974 685f 636f 6c6f  scheme_with_colo
+000c0790: 6e29 3b0a 2020 7d0a 2020 636f 6d70 6f6e  n);.  }.  compon
+000c07a0: 656e 7473 2e70 726f 746f 636f 6c5f 656e  ents.protocol_en
+000c07b0: 6420 2b3d 206e 6577 5f64 6966 6665 7265  d += new_differe
+000c07c0: 6e63 653b 0a0a 2020 2f2f 2055 7064 6174  nce;..  // Updat
+000c07d0: 6520 7468 6520 7265 7374 206f 6620 7468  e the rest of th
+000c07e0: 6520 636f 6d70 6f6e 656e 7473 2e0a 2020  e components..  
+000c07f0: 636f 6d70 6f6e 656e 7473 2e75 7365 726e  components.usern
+000c0800: 616d 655f 656e 6420 2b3d 206e 6577 5f64  ame_end += new_d
+000c0810: 6966 6665 7265 6e63 653b 0a20 2063 6f6d  ifference;.  com
+000c0820: 706f 6e65 6e74 732e 686f 7374 5f73 7461  ponents.host_sta
+000c0830: 7274 202b 3d20 6e65 775f 6469 6666 6572  rt += new_differ
+000c0840: 656e 6365 3b0a 2020 636f 6d70 6f6e 656e  ence;.  componen
+000c0850: 7473 2e68 6f73 745f 656e 6420 2b3d 206e  ts.host_end += n
+000c0860: 6577 5f64 6966 6665 7265 6e63 653b 0a20  ew_difference;. 
+000c0870: 2063 6f6d 706f 6e65 6e74 732e 7061 7468   components.path
+000c0880: 6e61 6d65 5f73 7461 7274 202b 3d20 6e65  name_start += ne
+000c0890: 775f 6469 6666 6572 656e 6365 3b0a 2020  w_difference;.  
+000c08a0: 6966 2028 636f 6d70 6f6e 656e 7473 2e73  if (components.s
+000c08b0: 6561 7263 685f 7374 6172 7420 213d 2075  earch_start != u
+000c08c0: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
+000c08d0: 6d69 7474 6564 2920 7b0a 2020 2020 636f  mitted) {.    co
+000c08e0: 6d70 6f6e 656e 7473 2e73 6561 7263 685f  mponents.search_
+000c08f0: 7374 6172 7420 2b3d 206e 6577 5f64 6966  start += new_dif
+000c0900: 6665 7265 6e63 653b 0a20 207d 0a20 2069  ference;.  }.  i
+000c0910: 6620 2863 6f6d 706f 6e65 6e74 732e 6861  f (components.ha
+000c0920: 7368 5f73 7461 7274 2021 3d20 7572 6c5f  sh_start != url_
+000c0930: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
+000c0940: 7465 6429 207b 0a20 2020 2063 6f6d 706f  ted) {.    compo
+000c0950: 6e65 6e74 732e 6861 7368 5f73 7461 7274  nents.hash_start
+000c0960: 202b 3d20 6e65 775f 6469 6666 6572 656e   += new_differen
+000c0970: 6365 3b0a 2020 7d0a 2020 4144 415f 4153  ce;.  }.  ADA_AS
+000c0980: 5345 5254 5f54 5255 4528 7661 6c69 6461  SERT_TRUE(valida
+000c0990: 7465 2829 293b 0a7d 0a0a 696e 6c69 6e65  te());.}..inline
+000c09a0: 2076 6f69 6420 7572 6c5f 6167 6772 6567   void url_aggreg
+000c09b0: 6174 6f72 3a3a 7365 745f 7363 6865 6d65  ator::set_scheme
+000c09c0: 2873 7464 3a3a 7374 7269 6e67 5f76 6965  (std::string_vie
+000c09d0: 7720 6e65 775f 7363 6865 6d65 2920 6e6f  w new_scheme) no
+000c09e0: 6578 6365 7074 207b 0a20 2061 6461 5f6c  except {.  ada_l
+000c09f0: 6f67 2822 7572 6c5f 6167 6772 6567 6174  og("url_aggregat
+000c0a00: 6f72 3a3a 7365 745f 7363 6865 6d65 2022  or::set_scheme "
+000c0a10: 2c20 6e65 775f 7363 6865 6d65 293b 0a20  , new_scheme);. 
+000c0a20: 2041 4441 5f41 5353 4552 545f 5452 5545   ADA_ASSERT_TRUE
+000c0a30: 2876 616c 6964 6174 6528 2929 3b0a 2020  (validate());.  
+000c0a40: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
+000c0a50: 6e65 775f 7363 6865 6d65 2e65 6d70 7479  new_scheme.empty
+000c0a60: 2829 207c 7c20 6e65 775f 7363 6865 6d65  () || new_scheme
+000c0a70: 2e62 6163 6b28 2920 213d 2027 3a27 293b  .back() != ':');
+000c0a80: 0a20 202f 2f20 6e65 7874 206c 696e 6520  .  // next line 
+000c0a90: 636f 756c 6420 6f76 6572 666c 6f77 2062  could overflow b
+000c0aa0: 7574 2075 6e73 6967 6e65 6420 6172 6974  ut unsigned arit
+000c0ab0: 686d 6574 6963 2068 6173 2077 656c 6c2d  hmetic has well-
+000c0ac0: 6465 6669 6e65 640a 2020 2f2f 206f 7665  defined.  // ove
+000c0ad0: 7266 6c6f 7773 2e0a 2020 7569 6e74 3332  rflows..  uint32
+000c0ae0: 5f74 206e 6577 5f64 6966 6665 7265 6e63  _t new_differenc
+000c0af0: 6520 3d0a 2020 2020 2020 7569 6e74 3332  e =.      uint32
+000c0b00: 5f74 286e 6577 5f73 6368 656d 652e 7369  _t(new_scheme.si
+000c0b10: 7a65 2829 2920 2d20 636f 6d70 6f6e 656e  ze()) - componen
+000c0b20: 7473 2e70 726f 746f 636f 6c5f 656e 6420  ts.protocol_end 
+000c0b30: 2b20 313b 0a0a 2020 7479 7065 203d 2061  + 1;..  type = a
+000c0b40: 6461 3a3a 7363 6865 6d65 3a3a 6765 745f  da::scheme::get_
+000c0b50: 7363 6865 6d65 5f74 7970 6528 6e65 775f  scheme_type(new_
+000c0b60: 7363 6865 6d65 293b 0a20 2069 6620 2862  scheme);.  if (b
+000c0b70: 7566 6665 722e 656d 7074 7928 2929 207b  uffer.empty()) {
+000c0b80: 0a20 2020 2062 7566 6665 722e 6170 7065  .    buffer.appe
+000c0b90: 6e64 2868 656c 7065 7273 3a3a 636f 6e63  nd(helpers::conc
+000c0ba0: 6174 286e 6577 5f73 6368 656d 652c 2022  at(new_scheme, "
+000c0bb0: 3a22 2929 3b0a 2020 7d20 656c 7365 207b  :"));.  } else {
+000c0bc0: 0a20 2020 2062 7566 6665 722e 6572 6173  .    buffer.eras
+000c0bd0: 6528 302c 2063 6f6d 706f 6e65 6e74 732e  e(0, components.
+000c0be0: 7072 6f74 6f63 6f6c 5f65 6e64 293b 0a20  protocol_end);. 
+000c0bf0: 2020 2062 7566 6665 722e 696e 7365 7274     buffer.insert
+000c0c00: 2830 2c20 6865 6c70 6572 733a 3a63 6f6e  (0, helpers::con
+000c0c10: 6361 7428 6e65 775f 7363 6865 6d65 2c20  cat(new_scheme, 
+000c0c20: 223a 2229 293b 0a20 207d 0a20 2063 6f6d  ":"));.  }.  com
+000c0c30: 706f 6e65 6e74 732e 7072 6f74 6f63 6f6c  ponents.protocol
+000c0c40: 5f65 6e64 203d 2075 696e 7433 325f 7428  _end = uint32_t(
+000c0c50: 6e65 775f 7363 6865 6d65 2e73 697a 6528  new_scheme.size(
+000c0c60: 2920 2b20 3129 3b0a 0a20 202f 2f20 5570  ) + 1);..  // Up
+000c0c70: 6461 7465 2074 6865 2072 6573 7420 6f66  date the rest of
+000c0c80: 2074 6865 2063 6f6d 706f 6e65 6e74 732e   the components.
+000c0c90: 0a20 2063 6f6d 706f 6e65 6e74 732e 7573  .  components.us
+000c0ca0: 6572 6e61 6d65 5f65 6e64 202b 3d20 6e65  ername_end += ne
+000c0cb0: 775f 6469 6666 6572 656e 6365 3b0a 2020  w_difference;.  
+000c0cc0: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
+000c0cd0: 7374 6172 7420 2b3d 206e 6577 5f64 6966  start += new_dif
+000c0ce0: 6665 7265 6e63 653b 0a20 2063 6f6d 706f  ference;.  compo
+000c0cf0: 6e65 6e74 732e 686f 7374 5f65 6e64 202b  nents.host_end +
+000c0d00: 3d20 6e65 775f 6469 6666 6572 656e 6365  = new_difference
+000c0d10: 3b0a 2020 636f 6d70 6f6e 656e 7473 2e70  ;.  components.p
+000c0d20: 6174 686e 616d 655f 7374 6172 7420 2b3d  athname_start +=
+000c0d30: 206e 6577 5f64 6966 6665 7265 6e63 653b   new_difference;
+000c0d40: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
+000c0d50: 732e 7365 6172 6368 5f73 7461 7274 2021  s.search_start !
+000c0d60: 3d20 7572 6c5f 636f 6d70 6f6e 656e 7473  = url_components
+000c0d70: 3a3a 6f6d 6974 7465 6429 207b 0a20 2020  ::omitted) {.   
+000c0d80: 2063 6f6d 706f 6e65 6e74 732e 7365 6172   components.sear
+000c0d90: 6368 5f73 7461 7274 202b 3d20 6e65 775f  ch_start += new_
+000c0da0: 6469 6666 6572 656e 6365 3b0a 2020 7d0a  difference;.  }.
+000c0db0: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
+000c0dc0: 2e68 6173 685f 7374 6172 7420 213d 2075  .hash_start != u
+000c0dd0: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
+000c0de0: 6d69 7474 6564 2920 7b0a 2020 2020 636f  mitted) {.    co
+000c0df0: 6d70 6f6e 656e 7473 2e68 6173 685f 7374  mponents.hash_st
+000c0e00: 6172 7420 2b3d 206e 6577 5f64 6966 6665  art += new_diffe
+000c0e10: 7265 6e63 653b 0a20 207d 0a20 2041 4441  rence;.  }.  ADA
+000c0e20: 5f41 5353 4552 545f 5452 5545 2876 616c  _ASSERT_TRUE(val
+000c0e30: 6964 6174 6528 2929 3b0a 7d0a 0a62 6f6f  idate());.}..boo
+000c0e40: 6c20 7572 6c5f 6167 6772 6567 6174 6f72  l url_aggregator
+000c0e50: 3a3a 7365 745f 7072 6f74 6f63 6f6c 2863  ::set_protocol(c
+000c0e60: 6f6e 7374 2073 7464 3a3a 7374 7269 6e67  onst std::string
+000c0e70: 5f76 6965 7720 696e 7075 7429 207b 0a20  _view input) {. 
+000c0e80: 2061 6461 5f6c 6f67 2822 7572 6c5f 6167   ada_log("url_ag
+000c0e90: 6772 6567 6174 6f72 3a3a 7365 745f 7072  gregator::set_pr
+000c0ea0: 6f74 6f63 6f6c 2022 2c20 696e 7075 7429  otocol ", input)
+000c0eb0: 3b0a 2020 4144 415f 4153 5345 5254 5f54  ;.  ADA_ASSERT_T
+000c0ec0: 5255 4528 7661 6c69 6461 7465 2829 293b  RUE(validate());
+000c0ed0: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
+000c0ee0: 5545 2821 6865 6c70 6572 733a 3a6f 7665  UE(!helpers::ove
+000c0ef0: 726c 6170 7328 696e 7075 742c 2062 7566  rlaps(input, buf
+000c0f00: 6665 7229 293b 0a20 2073 7464 3a3a 7374  fer));.  std::st
+000c0f10: 7269 6e67 2076 6965 7728 696e 7075 7429  ring view(input)
+000c0f20: 3b0a 2020 6865 6c70 6572 733a 3a72 656d  ;.  helpers::rem
+000c0f30: 6f76 655f 6173 6369 695f 7461 625f 6f72  ove_ascii_tab_or
+000c0f40: 5f6e 6577 6c69 6e65 2876 6965 7729 3b0a  _newline(view);.
+000c0f50: 2020 6966 2028 7669 6577 2e65 6d70 7479    if (view.empty
+000c0f60: 2829 2920 7b0a 2020 2020 7265 7475 726e  ()) {.    return
+000c0f70: 2074 7275 653b 0a20 207d 0a0a 2020 2f2f   true;.  }..  //
+000c0f80: 2053 6368 656d 6573 2073 686f 756c 6420   Schemes should 
+000c0f90: 7374 6172 7420 7769 7468 2061 6c70 6861  start with alpha
+000c0fa0: 2076 616c 7565 732e 0a20 2069 6620 2821   values..  if (!
+000c0fb0: 6368 6563 6b65 7273 3a3a 6973 5f61 6c70  checkers::is_alp
+000c0fc0: 6861 2876 6965 775b 305d 2929 207b 0a20  ha(view[0])) {. 
+000c0fd0: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
+000c0fe0: 0a20 207d 0a0a 2020 7669 6577 2e61 7070  .  }..  view.app
+000c0ff0: 656e 6428 223a 2229 3b0a 0a20 2073 7464  end(":");..  std
+000c1000: 3a3a 7374 7269 6e67 3a3a 6974 6572 6174  ::string::iterat
+000c1010: 6f72 2070 6f69 6e74 6572 203d 0a20 2020  or pointer =.   
+000c1020: 2020 2073 7464 3a3a 6669 6e64 5f69 665f     std::find_if_
+000c1030: 6e6f 7428 7669 6577 2e62 6567 696e 2829  not(view.begin()
+000c1040: 2c20 7669 6577 2e65 6e64 2829 2c20 756e  , view.end(), un
+000c1050: 6963 6f64 653a 3a69 735f 616c 6e75 6d5f  icode::is_alnum_
+000c1060: 706c 7573 293b 0a0a 2020 6966 2028 706f  plus);..  if (po
+000c1070: 696e 7465 7220 213d 2076 6965 772e 656e  inter != view.en
+000c1080: 6428 2920 2626 202a 706f 696e 7465 7220  d() && *pointer 
+000c1090: 3d3d 2027 3a27 2920 7b0a 2020 2020 7265  == ':') {.    re
+000c10a0: 7475 726e 2070 6172 7365 5f73 6368 656d  turn parse_schem
+000c10b0: 655f 7769 7468 5f63 6f6c 6f6e 3c74 7275  e_with_colon<tru
+000c10c0: 653e 280a 2020 2020 2020 2020 7374 643a  e>(.        std:
+000c10d0: 3a73 7472 696e 675f 7669 6577 2876 6965  :string_view(vie
+000c10e0: 772e 6461 7461 2829 2c20 706f 696e 7465  w.data(), pointe
+000c10f0: 7220 2d20 7669 6577 2e62 6567 696e 2829  r - view.begin()
+000c1100: 202b 2031 2929 3b0a 2020 7d0a 2020 7265   + 1));.  }.  re
+000c1110: 7475 726e 2066 616c 7365 3b0a 7d0a 0a62  turn false;.}..b
+000c1120: 6f6f 6c20 7572 6c5f 6167 6772 6567 6174  ool url_aggregat
+000c1130: 6f72 3a3a 7365 745f 7573 6572 6e61 6d65  or::set_username
+000c1140: 2863 6f6e 7374 2073 7464 3a3a 7374 7269  (const std::stri
+000c1150: 6e67 5f76 6965 7720 696e 7075 7429 207b  ng_view input) {
+000c1160: 0a20 2061 6461 5f6c 6f67 2822 7572 6c5f  .  ada_log("url_
+000c1170: 6167 6772 6567 6174 6f72 3a3a 7365 745f  aggregator::set_
+000c1180: 7573 6572 6e61 6d65 2027 222c 2069 6e70  username '", inp
+000c1190: 7574 2c20 2227 2022 293b 0a20 2041 4441  ut, "' ");.  ADA
+000c11a0: 5f41 5353 4552 545f 5452 5545 2876 616c  _ASSERT_TRUE(val
+000c11b0: 6964 6174 6528 2929 3b0a 2020 4144 415f  idate());.  ADA_
+000c11c0: 4153 5345 5254 5f54 5255 4528 2168 656c  ASSERT_TRUE(!hel
+000c11d0: 7065 7273 3a3a 6f76 6572 6c61 7073 2869  pers::overlaps(i
+000c11e0: 6e70 7574 2c20 6275 6666 6572 2929 3b0a  nput, buffer));.
+000c11f0: 2020 6966 2028 6361 6e6e 6f74 5f68 6176    if (cannot_hav
+000c1200: 655f 6372 6564 656e 7469 616c 735f 6f72  e_credentials_or
+000c1210: 5f70 6f72 7428 2929 207b 0a20 2020 2072  _port()) {.    r
+000c1220: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
+000c1230: 0a20 2073 697a 655f 7420 6964 7820 3d20  .  size_t idx = 
+000c1240: 6164 613a 3a75 6e69 636f 6465 3a3a 7065  ada::unicode::pe
+000c1250: 7263 656e 745f 656e 636f 6465 5f69 6e64  rcent_encode_ind
+000c1260: 6578 280a 2020 2020 2020 696e 7075 742c  ex(.      input,
+000c1270: 2063 6861 7261 6374 6572 5f73 6574 733a   character_sets:
+000c1280: 3a55 5345 5249 4e46 4f5f 5045 5243 454e  :USERINFO_PERCEN
+000c1290: 545f 454e 434f 4445 293b 0a20 2069 6620  T_ENCODE);.  if 
+000c12a0: 2869 6478 203d 3d20 696e 7075 742e 7369  (idx == input.si
+000c12b0: 7a65 2829 2920 7b0a 2020 2020 7570 6461  ze()) {.    upda
+000c12c0: 7465 5f62 6173 655f 7573 6572 6e61 6d65  te_base_username
+000c12d0: 2869 6e70 7574 293b 0a20 207d 2065 6c73  (input);.  } els
+000c12e0: 6520 7b0a 2020 2020 2f2f 2057 6520 6f6e  e {.    // We on
+000c12f0: 6c79 2063 7265 6174 6520 6120 7465 6d70  ly create a temp
+000c1300: 6f72 6172 7920 7374 7269 6e67 2069 6620  orary string if 
+000c1310: 7765 2068 6176 6520 746f 210a 2020 2020  we have to!.    
+000c1320: 7570 6461 7465 5f62 6173 655f 7573 6572  update_base_user
+000c1330: 6e61 6d65 2861 6461 3a3a 756e 6963 6f64  name(ada::unicod
+000c1340: 653a 3a70 6572 6365 6e74 5f65 6e63 6f64  e::percent_encod
+000c1350: 6528 0a20 2020 2020 2020 2069 6e70 7574  e(.        input
+000c1360: 2c20 6368 6172 6163 7465 725f 7365 7473  , character_sets
+000c1370: 3a3a 5553 4552 494e 464f 5f50 4552 4345  ::USERINFO_PERCE
+000c1380: 4e54 5f45 4e43 4f44 452c 2069 6478 2929  NT_ENCODE, idx))
+000c1390: 3b0a 2020 7d0a 2020 4144 415f 4153 5345  ;.  }.  ADA_ASSE
+000c13a0: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
+000c13b0: 2829 293b 0a20 2072 6574 7572 6e20 7472  ());.  return tr
+000c13c0: 7565 3b0a 7d0a 0a62 6f6f 6c20 7572 6c5f  ue;.}..bool url_
+000c13d0: 6167 6772 6567 6174 6f72 3a3a 7365 745f  aggregator::set_
+000c13e0: 7061 7373 776f 7264 2863 6f6e 7374 2073  password(const s
+000c13f0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000c1400: 696e 7075 7429 207b 0a20 2061 6461 5f6c  input) {.  ada_l
+000c1410: 6f67 2822 7572 6c5f 6167 6772 6567 6174  og("url_aggregat
+000c1420: 6f72 3a3a 7365 745f 7061 7373 776f 7264  or::set_password
+000c1430: 2027 222c 2069 6e70 7574 2c20 2227 2229   '", input, "'")
+000c1440: 3b0a 2020 4144 415f 4153 5345 5254 5f54  ;.  ADA_ASSERT_T
+000c1450: 5255 4528 7661 6c69 6461 7465 2829 293b  RUE(validate());
+000c1460: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
+000c1470: 5545 2821 6865 6c70 6572 733a 3a6f 7665  UE(!helpers::ove
+000c1480: 726c 6170 7328 696e 7075 742c 2062 7566  rlaps(input, buf
+000c1490: 6665 7229 293b 0a20 2069 6620 2863 616e  fer));.  if (can
+000c14a0: 6e6f 745f 6861 7665 5f63 7265 6465 6e74  not_have_credent
+000c14b0: 6961 6c73 5f6f 725f 706f 7274 2829 2920  ials_or_port()) 
+000c14c0: 7b0a 2020 2020 7265 7475 726e 2066 616c  {.    return fal
+000c14d0: 7365 3b0a 2020 7d0a 2020 7369 7a65 5f74  se;.  }.  size_t
+000c14e0: 2069 6478 203d 2061 6461 3a3a 756e 6963   idx = ada::unic
+000c14f0: 6f64 653a 3a70 6572 6365 6e74 5f65 6e63  ode::percent_enc
+000c1500: 6f64 655f 696e 6465 7828 0a20 2020 2020  ode_index(.     
+000c1510: 2069 6e70 7574 2c20 6368 6172 6163 7465   input, characte
+000c1520: 725f 7365 7473 3a3a 5553 4552 494e 464f  r_sets::USERINFO
+000c1530: 5f50 4552 4345 4e54 5f45 4e43 4f44 4529  _PERCENT_ENCODE)
+000c1540: 3b0a 2020 6966 2028 6964 7820 3d3d 2069  ;.  if (idx == i
+000c1550: 6e70 7574 2e73 697a 6528 2929 207b 0a20  nput.size()) {. 
+000c1560: 2020 2075 7064 6174 655f 6261 7365 5f70     update_base_p
+000c1570: 6173 7377 6f72 6428 696e 7075 7429 3b0a  assword(input);.
+000c1580: 2020 7d20 656c 7365 207b 0a20 2020 202f    } else {.    /
+000c1590: 2f20 5765 206f 6e6c 7920 6372 6561 7465  / We only create
+000c15a0: 2061 2074 656d 706f 7261 7279 2073 7472   a temporary str
+000c15b0: 696e 6720 6966 2077 6520 6861 7665 2074  ing if we have t
+000c15c0: 6f21 0a20 2020 2075 7064 6174 655f 6261  o!.    update_ba
+000c15d0: 7365 5f70 6173 7377 6f72 6428 6164 613a  se_password(ada:
+000c15e0: 3a75 6e69 636f 6465 3a3a 7065 7263 656e  :unicode::percen
+000c15f0: 745f 656e 636f 6465 280a 2020 2020 2020  t_encode(.      
+000c1600: 2020 696e 7075 742c 2063 6861 7261 6374    input, charact
+000c1610: 6572 5f73 6574 733a 3a55 5345 5249 4e46  er_sets::USERINF
+000c1620: 4f5f 5045 5243 454e 545f 454e 434f 4445  O_PERCENT_ENCODE
+000c1630: 2c20 6964 7829 293b 0a20 207d 0a20 2041  , idx));.  }.  A
+000c1640: 4441 5f41 5353 4552 545f 5452 5545 2876  DA_ASSERT_TRUE(v
+000c1650: 616c 6964 6174 6528 2929 3b0a 2020 7265  alidate());.  re
+000c1660: 7475 726e 2074 7275 653b 0a7d 0a0a 626f  turn true;.}..bo
+000c1670: 6f6c 2075 726c 5f61 6767 7265 6761 746f  ol url_aggregato
+000c1680: 723a 3a73 6574 5f70 6f72 7428 636f 6e73  r::set_port(cons
+000c1690: 7420 7374 643a 3a73 7472 696e 675f 7669  t std::string_vi
+000c16a0: 6577 2069 6e70 7574 2920 7b0a 2020 6164  ew input) {.  ad
+000c16b0: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
+000c16c0: 6761 746f 723a 3a73 6574 5f70 6f72 7420  gator::set_port 
+000c16d0: 222c 2069 6e70 7574 293b 0a20 2041 4441  ", input);.  ADA
+000c16e0: 5f41 5353 4552 545f 5452 5545 2876 616c  _ASSERT_TRUE(val
+000c16f0: 6964 6174 6528 2929 3b0a 2020 4144 415f  idate());.  ADA_
+000c1700: 4153 5345 5254 5f54 5255 4528 2168 656c  ASSERT_TRUE(!hel
+000c1710: 7065 7273 3a3a 6f76 6572 6c61 7073 2869  pers::overlaps(i
+000c1720: 6e70 7574 2c20 6275 6666 6572 2929 3b0a  nput, buffer));.
+000c1730: 2020 6966 2028 6361 6e6e 6f74 5f68 6176    if (cannot_hav
+000c1740: 655f 6372 6564 656e 7469 616c 735f 6f72  e_credentials_or
+000c1750: 5f70 6f72 7428 2929 207b 0a20 2020 2072  _port()) {.    r
+000c1760: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
+000c1770: 0a20 2073 7464 3a3a 7374 7269 6e67 2074  .  std::string t
+000c1780: 7269 6d6d 6564 2869 6e70 7574 293b 0a20  rimmed(input);. 
+000c1790: 2068 656c 7065 7273 3a3a 7265 6d6f 7665   helpers::remove
+000c17a0: 5f61 7363 6969 5f74 6162 5f6f 725f 6e65  _ascii_tab_or_ne
+000c17b0: 776c 696e 6528 7472 696d 6d65 6429 3b0a  wline(trimmed);.
+000c17c0: 2020 6966 2028 7472 696d 6d65 642e 656d    if (trimmed.em
+000c17d0: 7074 7928 2929 207b 0a20 2020 2063 6c65  pty()) {.    cle
+000c17e0: 6172 5f70 6f72 7428 293b 0a20 2020 2072  ar_port();.    r
+000c17f0: 6574 7572 6e20 7472 7565 3b0a 2020 7d0a  eturn true;.  }.
+000c1800: 2020 2f2f 2049 6e70 7574 2073 686f 756c    // Input shoul
+000c1810: 6420 6e6f 7420 7374 6172 7420 7769 7468  d not start with
+000c1820: 2063 6f6e 7472 6f6c 2063 6861 7261 6374   control charact
+000c1830: 6572 732e 0a20 2069 6620 2861 6461 3a3a  ers..  if (ada::
+000c1840: 756e 6963 6f64 653a 3a69 735f 6330 5f63  unicode::is_c0_c
+000c1850: 6f6e 7472 6f6c 5f6f 725f 7370 6163 6528  ontrol_or_space(
+000c1860: 7472 696d 6d65 642e 6672 6f6e 7428 2929  trimmed.front())
+000c1870: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
+000c1880: 616c 7365 3b0a 2020 7d0a 2020 2f2f 2049  alse;.  }.  // I
+000c1890: 6e70 7574 2073 686f 756c 6420 636f 6e74  nput should cont
+000c18a0: 6169 6e20 6174 206c 6561 7374 206f 6e65  ain at least one
+000c18b0: 2061 7363 6969 2064 6967 6974 2e0a 2020   ascii digit..  
+000c18c0: 6966 2028 696e 7075 742e 6669 6e64 5f66  if (input.find_f
+000c18d0: 6972 7374 5f6f 6628 2230 3132 3334 3536  irst_of("0123456
+000c18e0: 3738 3922 2920 3d3d 2073 7464 3a3a 7374  789") == std::st
+000c18f0: 7269 6e67 5f76 6965 773a 3a6e 706f 7329  ring_view::npos)
+000c1900: 207b 0a20 2020 2072 6574 7572 6e20 6661   {.    return fa
+000c1910: 6c73 653b 0a20 207d 0a0a 2020 2f2f 2052  lse;.  }..  // R
+000c1920: 6576 6572 7420 6368 616e 6765 7320 6966  evert changes if
+000c1930: 2070 6172 7365 5f70 6f72 7420 6661 696c   parse_port fail
+000c1940: 732e 0a20 2075 696e 7433 325f 7420 7072  s..  uint32_t pr
+000c1950: 6576 696f 7573 5f70 6f72 7420 3d20 636f  evious_port = co
+000c1960: 6d70 6f6e 656e 7473 2e70 6f72 743b 0a20  mponents.port;. 
+000c1970: 2070 6172 7365 5f70 6f72 7428 7472 696d   parse_port(trim
+000c1980: 6d65 6429 3b0a 2020 6966 2028 6973 5f76  med);.  if (is_v
+000c1990: 616c 6964 2920 7b0a 2020 2020 7265 7475  alid) {.    retu
+000c19a0: 726e 2074 7275 653b 0a20 207d 0a20 2075  rn true;.  }.  u
+000c19b0: 7064 6174 655f 6261 7365 5f70 6f72 7428  pdate_base_port(
+000c19c0: 7072 6576 696f 7573 5f70 6f72 7429 3b0a  previous_port);.
+000c19d0: 2020 6973 5f76 616c 6964 203d 2074 7275    is_valid = tru
+000c19e0: 653b 0a20 2041 4441 5f41 5353 4552 545f  e;.  ADA_ASSERT_
+000c19f0: 5452 5545 2876 616c 6964 6174 6528 2929  TRUE(validate())
+000c1a00: 3b0a 2020 7265 7475 726e 2066 616c 7365  ;.  return false
+000c1a10: 3b0a 7d0a 0a62 6f6f 6c20 7572 6c5f 6167  ;.}..bool url_ag
+000c1a20: 6772 6567 6174 6f72 3a3a 7365 745f 7061  gregator::set_pa
+000c1a30: 7468 6e61 6d65 2863 6f6e 7374 2073 7464  thname(const std
+000c1a40: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
+000c1a50: 7075 7429 207b 0a20 2061 6461 5f6c 6f67  put) {.  ada_log
+000c1a60: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
+000c1a70: 3a3a 7365 745f 7061 7468 6e61 6d65 2022  ::set_pathname "
+000c1a80: 2c20 696e 7075 7429 3b0a 2020 4144 415f  , input);.  ADA_
+000c1a90: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
+000c1aa0: 6461 7465 2829 293b 0a20 2041 4441 5f41  date());.  ADA_A
+000c1ab0: 5353 4552 545f 5452 5545 2821 6865 6c70  SSERT_TRUE(!help
+000c1ac0: 6572 733a 3a6f 7665 726c 6170 7328 696e  ers::overlaps(in
+000c1ad0: 7075 742c 2062 7566 6665 7229 293b 0a20  put, buffer));. 
+000c1ae0: 2069 6620 2868 6173 5f6f 7061 7175 655f   if (has_opaque_
+000c1af0: 7061 7468 2920 7b0a 2020 2020 7265 7475  path) {.    retu
+000c1b00: 726e 2066 616c 7365 3b0a 2020 7d0a 2020  rn false;.  }.  
+000c1b10: 636c 6561 725f 7061 7468 6e61 6d65 2829  clear_pathname()
+000c1b20: 3b0a 2020 7061 7273 655f 7061 7468 2869  ;.  parse_path(i
+000c1b30: 6e70 7574 293b 0a20 2069 6620 2863 6865  nput);.  if (che
+000c1b40: 636b 6572 733a 3a62 6567 696e 735f 7769  ckers::begins_wi
+000c1b50: 7468 2869 6e70 7574 2c20 222f 2f22 2920  th(input, "//") 
+000c1b60: 2626 2021 6861 735f 6175 7468 6f72 6974  && !has_authorit
+000c1b70: 7928 2920 2626 0a20 2020 2020 2021 6861  y() &&.      !ha
+000c1b80: 735f 6461 7368 5f64 6f74 2829 2920 7b0a  s_dash_dot()) {.
+000c1b90: 2020 2020 6275 6666 6572 2e69 6e73 6572      buffer.inser
+000c1ba0: 7428 636f 6d70 6f6e 656e 7473 2e70 6174  t(components.pat
+000c1bb0: 686e 616d 655f 7374 6172 742c 2022 2f2e  hname_start, "/.
+000c1bc0: 2229 3b0a 2020 2020 636f 6d70 6f6e 656e  ");.    componen
+000c1bd0: 7473 2e70 6174 686e 616d 655f 7374 6172  ts.pathname_star
+000c1be0: 7420 2b3d 2032 3b0a 2020 7d0a 2020 4144  t += 2;.  }.  AD
+000c1bf0: 415f 4153 5345 5254 5f54 5255 4528 7661  A_ASSERT_TRUE(va
+000c1c00: 6c69 6461 7465 2829 293b 0a20 2072 6574  lidate());.  ret
+000c1c10: 7572 6e20 7472 7565 3b0a 7d0a 0a61 6461  urn true;.}..ada
+000c1c20: 5f72 6561 6c6c 795f 696e 6c69 6e65 2076  _really_inline v
+000c1c30: 6f69 6420 7572 6c5f 6167 6772 6567 6174  oid url_aggregat
+000c1c40: 6f72 3a3a 7061 7273 655f 7061 7468 2873  or::parse_path(s
+000c1c50: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
+000c1c60: 696e 7075 7429 207b 0a20 2061 6461 5f6c  input) {.  ada_l
+000c1c70: 6f67 2822 7572 6c5f 6167 6772 6567 6174  og("url_aggregat
+000c1c80: 6f72 3a3a 7061 7273 655f 7061 7468 2022  or::parse_path "
+000c1c90: 2c20 696e 7075 7429 3b0a 2020 4144 415f  , input);.  ADA_
+000c1ca0: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
+000c1cb0: 6461 7465 2829 293b 0a20 2041 4441 5f41  date());.  ADA_A
+000c1cc0: 5353 4552 545f 5452 5545 2821 6865 6c70  SSERT_TRUE(!help
+000c1cd0: 6572 733a 3a6f 7665 726c 6170 7328 696e  ers::overlaps(in
+000c1ce0: 7075 742c 2062 7566 6665 7229 293b 0a20  put, buffer));. 
+000c1cf0: 2073 7464 3a3a 7374 7269 6e67 2074 6d70   std::string tmp
+000c1d00: 5f62 7566 6665 723b 0a20 2073 7464 3a3a  _buffer;.  std::
+000c1d10: 7374 7269 6e67 5f76 6965 7720 696e 7465  string_view inte
+000c1d20: 726e 616c 5f69 6e70 7574 3b0a 2020 6966  rnal_input;.  if
+000c1d30: 2028 756e 6963 6f64 653a 3a68 6173 5f74   (unicode::has_t
+000c1d40: 6162 735f 6f72 5f6e 6577 6c69 6e65 2869  abs_or_newline(i
+000c1d50: 6e70 7574 2929 207b 0a20 2020 2074 6d70  nput)) {.    tmp
+000c1d60: 5f62 7566 6665 7220 3d20 696e 7075 743b  _buffer = input;
+000c1d70: 0a20 2020 202f 2f20 4f70 7469 6d69 7a61  .    // Optimiza
+000c1d80: 7469 6f6e 206f 7070 6f72 7475 6e69 7479  tion opportunity
+000c1d90: 3a20 496e 7374 6561 6420 6f66 2063 6f70  : Instead of cop
+000c1da0: 7969 6e67 2061 6e64 2074 6865 6e20 7072  ying and then pr
+000c1db0: 756e 696e 672c 2077 6520 636f 756c 640a  uning, we could.
+000c1dc0: 2020 2020 2f2f 206a 7573 7420 6469 7265      // just dire
+000c1dd0: 6374 6c79 2062 7569 6c64 2074 6865 2073  ctly build the s
+000c1de0: 7472 696e 6720 6672 6f6d 2075 7365 725f  tring from user_
+000c1df0: 696e 7075 742e 0a20 2020 2068 656c 7065  input..    helpe
+000c1e00: 7273 3a3a 7265 6d6f 7665 5f61 7363 6969  rs::remove_ascii
+000c1e10: 5f74 6162 5f6f 725f 6e65 776c 696e 6528  _tab_or_newline(
+000c1e20: 746d 705f 6275 6666 6572 293b 0a20 2020  tmp_buffer);.   
+000c1e30: 2069 6e74 6572 6e61 6c5f 696e 7075 7420   internal_input 
+000c1e40: 3d20 746d 705f 6275 6666 6572 3b0a 2020  = tmp_buffer;.  
+000c1e50: 7d20 656c 7365 207b 0a20 2020 2069 6e74  } else {.    int
+000c1e60: 6572 6e61 6c5f 696e 7075 7420 3d20 696e  ernal_input = in
+000c1e70: 7075 743b 0a20 207d 0a0a 2020 2f2f 2049  put;.  }..  // I
+000c1e80: 6620 7572 6c20 6973 2073 7065 6369 616c  f url is special
+000c1e90: 2c20 7468 656e 3a0a 2020 6966 2028 6973  , then:.  if (is
+000c1ea0: 5f73 7065 6369 616c 2829 2920 7b0a 2020  _special()) {.  
+000c1eb0: 2020 6966 2028 696e 7465 726e 616c 5f69    if (internal_i
+000c1ec0: 6e70 7574 2e65 6d70 7479 2829 2920 7b0a  nput.empty()) {.
+000c1ed0: 2020 2020 2020 7570 6461 7465 5f62 6173        update_bas
+000c1ee0: 655f 7061 7468 6e61 6d65 2822 2f22 293b  e_pathname("/");
+000c1ef0: 0a20 2020 207d 2065 6c73 6520 6966 2028  .    } else if (
+000c1f00: 2869 6e74 6572 6e61 6c5f 696e 7075 745b  (internal_input[
+000c1f10: 305d 203d 3d20 272f 2729 207c 7c20 2869  0] == '/') || (i
+000c1f20: 6e74 6572 6e61 6c5f 696e 7075 745b 305d  nternal_input[0]
+000c1f30: 203d 3d20 275c 5c27 2929 207b 0a20 2020   == '\\')) {.   
+000c1f40: 2020 2063 6f6e 7375 6d65 5f70 7265 7061     consume_prepa
+000c1f50: 7265 645f 7061 7468 2869 6e74 6572 6e61  red_path(interna
+000c1f60: 6c5f 696e 7075 742e 7375 6273 7472 2831  l_input.substr(1
+000c1f70: 2929 3b0a 2020 2020 7d20 656c 7365 207b  ));.    } else {
+000c1f80: 0a20 2020 2020 2063 6f6e 7375 6d65 5f70  .      consume_p
+000c1f90: 7265 7061 7265 645f 7061 7468 2869 6e74  repared_path(int
+000c1fa0: 6572 6e61 6c5f 696e 7075 7429 3b0a 2020  ernal_input);.  
+000c1fb0: 2020 7d0a 2020 7d20 656c 7365 2069 6620    }.  } else if 
+000c1fc0: 2821 696e 7465 726e 616c 5f69 6e70 7574  (!internal_input
+000c1fd0: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000c1fe0: 6966 2028 696e 7465 726e 616c 5f69 6e70  if (internal_inp
+000c1ff0: 7574 5b30 5d20 3d3d 2027 2f27 2920 7b0a  ut[0] == '/') {.
+000c2000: 2020 2020 2020 636f 6e73 756d 655f 7072        consume_pr
+000c2010: 6570 6172 6564 5f70 6174 6828 696e 7465  epared_path(inte
+000c2020: 726e 616c 5f69 6e70 7574 2e73 7562 7374  rnal_input.subst
+000c2030: 7228 3129 293b 0a20 2020 207d 2065 6c73  r(1));.    } els
+000c2040: 6520 7b0a 2020 2020 2020 636f 6e73 756d  e {.      consum
+000c2050: 655f 7072 6570 6172 6564 5f70 6174 6828  e_prepared_path(
+000c2060: 696e 7465 726e 616c 5f69 6e70 7574 293b  internal_input);
+000c2070: 0a20 2020 207d 0a20 207d 2065 6c73 6520  .    }.  } else 
+000c2080: 7b0a 2020 2020 2f2f 204e 6f6e 2d73 7065  {.    // Non-spe
+000c2090: 6369 616c 2055 524c 7320 7769 7468 2061  cial URLs with a
+000c20a0: 6e20 656d 7074 7920 686f 7374 2063 616e  n empty host can
+000c20b0: 2068 6176 6520 7468 6569 7220 7061 7468   have their path
+000c20c0: 7320 6572 6173 6564 0a20 2020 202f 2f20  s erased.    // 
+000c20d0: 5061 7468 2d6f 6e6c 7920 5552 4c73 2063  Path-only URLs c
+000c20e0: 616e 6e6f 7420 6861 7665 2074 6865 6972  annot have their
+000c20f0: 2070 6174 6873 2065 7261 7365 640a 2020   paths erased.  
+000c2100: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
+000c2110: 2e68 6f73 745f 7374 6172 7420 3d3d 2063  .host_start == c
+000c2120: 6f6d 706f 6e65 6e74 732e 686f 7374 5f65  omponents.host_e
+000c2130: 6e64 2026 2620 2168 6173 5f61 7574 686f  nd && !has_autho
+000c2140: 7269 7479 2829 2920 7b0a 2020 2020 2020  rity()) {.      
+000c2150: 7570 6461 7465 5f62 6173 655f 7061 7468  update_base_path
+000c2160: 6e61 6d65 2822 2f22 293b 0a20 2020 207d  name("/");.    }
+000c2170: 0a20 207d 0a20 2041 4441 5f41 5353 4552  .  }.  ADA_ASSER
+000c2180: 545f 5452 5545 2876 616c 6964 6174 6528  T_TRUE(validate(
+000c2190: 2929 3b0a 7d0a 0a76 6f69 6420 7572 6c5f  ));.}..void url_
+000c21a0: 6167 6772 6567 6174 6f72 3a3a 7365 745f  aggregator::set_
+000c21b0: 7365 6172 6368 2863 6f6e 7374 2073 7464  search(const std
+000c21c0: 3a3a 7374 7269 6e67 5f76 6965 7720 696e  ::string_view in
+000c21d0: 7075 7429 207b 0a20 2061 6461 5f6c 6f67  put) {.  ada_log
+000c21e0: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
+000c21f0: 3a3a 7365 745f 7365 6172 6368 2022 2c20  ::set_search ", 
+000c2200: 696e 7075 7429 3b0a 2020 4144 415f 4153  input);.  ADA_AS
+000c2210: 5345 5254 5f54 5255 4528 7661 6c69 6461  SERT_TRUE(valida
+000c2220: 7465 2829 293b 0a20 2041 4441 5f41 5353  te());.  ADA_ASS
+000c2230: 4552 545f 5452 5545 2821 6865 6c70 6572  ERT_TRUE(!helper
+000c2240: 733a 3a6f 7665 726c 6170 7328 696e 7075  s::overlaps(inpu
+000c2250: 742c 2062 7566 6665 7229 293b 0a20 2069  t, buffer));.  i
+000c2260: 6620 2869 6e70 7574 2e65 6d70 7479 2829  f (input.empty()
+000c2270: 2920 7b0a 2020 2020 636c 6561 725f 7365  ) {.    clear_se
+000c2280: 6172 6368 2829 3b0a 2020 2020 6865 6c70  arch();.    help
+000c2290: 6572 733a 3a73 7472 6970 5f74 7261 696c  ers::strip_trail
+000c22a0: 696e 675f 7370 6163 6573 5f66 726f 6d5f  ing_spaces_from_
+000c22b0: 6f70 6171 7565 5f70 6174 6828 2a74 6869  opaque_path(*thi
+000c22c0: 7329 3b0a 2020 2020 7265 7475 726e 3b0a  s);.    return;.
+000c22d0: 2020 7d0a 0a20 2073 7464 3a3a 7374 7269    }..  std::stri
+000c22e0: 6e67 206e 6577 5f76 616c 7565 3b0a 2020  ng new_value;.  
+000c22f0: 6e65 775f 7661 6c75 6520 3d20 696e 7075  new_value = inpu
+000c2300: 745b 305d 203d 3d20 273f 2720 3f20 696e  t[0] == '?' ? in
+000c2310: 7075 742e 7375 6273 7472 2831 2920 3a20  put.substr(1) : 
+000c2320: 696e 7075 743b 0a20 2068 656c 7065 7273  input;.  helpers
+000c2330: 3a3a 7265 6d6f 7665 5f61 7363 6969 5f74  ::remove_ascii_t
+000c2340: 6162 5f6f 725f 6e65 776c 696e 6528 6e65  ab_or_newline(ne
+000c2350: 775f 7661 6c75 6529 3b0a 0a20 2061 7574  w_value);..  aut
+000c2360: 6f20 7175 6572 795f 7065 7263 656e 745f  o query_percent_
+000c2370: 656e 636f 6465 5f73 6574 203d 0a20 2020  encode_set =.   
+000c2380: 2020 2069 735f 7370 6563 6961 6c28 2920     is_special() 
+000c2390: 3f20 6164 613a 3a63 6861 7261 6374 6572  ? ada::character
+000c23a0: 5f73 6574 733a 3a53 5045 4349 414c 5f51  _sets::SPECIAL_Q
+000c23b0: 5545 5259 5f50 4552 4345 4e54 5f45 4e43  UERY_PERCENT_ENC
+000c23c0: 4f44 450a 2020 2020 2020 2020 2020 2020  ODE.            
+000c23d0: 2020 2020 2020 203a 2061 6461 3a3a 6368         : ada::ch
+000c23e0: 6172 6163 7465 725f 7365 7473 3a3a 5155  aracter_sets::QU
+000c23f0: 4552 595f 5045 5243 454e 545f 454e 434f  ERY_PERCENT_ENCO
+000c2400: 4445 3b0a 0a20 2075 7064 6174 655f 6261  DE;..  update_ba
+000c2410: 7365 5f73 6561 7263 6828 6e65 775f 7661  se_search(new_va
+000c2420: 6c75 652c 2071 7565 7279 5f70 6572 6365  lue, query_perce
+000c2430: 6e74 5f65 6e63 6f64 655f 7365 7429 3b0a  nt_encode_set);.
+000c2440: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
+000c2450: 4528 7661 6c69 6461 7465 2829 293b 0a7d  E(validate());.}
+000c2460: 0a0a 766f 6964 2075 726c 5f61 6767 7265  ..void url_aggre
+000c2470: 6761 746f 723a 3a73 6574 5f68 6173 6828  gator::set_hash(
+000c2480: 636f 6e73 7420 7374 643a 3a73 7472 696e  const std::strin
+000c2490: 675f 7669 6577 2069 6e70 7574 2920 7b0a  g_view input) {.
+000c24a0: 2020 6164 615f 6c6f 6728 2275 726c 5f61    ada_log("url_a
+000c24b0: 6767 7265 6761 746f 723a 3a73 6574 5f68  ggregator::set_h
+000c24c0: 6173 6820 222c 2069 6e70 7574 293b 0a20  ash ", input);. 
+000c24d0: 2041 4441 5f41 5353 4552 545f 5452 5545   ADA_ASSERT_TRUE
+000c24e0: 2876 616c 6964 6174 6528 2929 3b0a 2020  (validate());.  
+000c24f0: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
+000c2500: 2168 656c 7065 7273 3a3a 6f76 6572 6c61  !helpers::overla
+000c2510: 7073 2869 6e70 7574 2c20 6275 6666 6572  ps(input, buffer
+000c2520: 2929 3b0a 2020 6966 2028 696e 7075 742e  ));.  if (input.
+000c2530: 656d 7074 7928 2929 207b 0a20 2020 2069  empty()) {.    i
+000c2540: 6620 2863 6f6d 706f 6e65 6e74 732e 6861  f (components.ha
+000c2550: 7368 5f73 7461 7274 2021 3d20 7572 6c5f  sh_start != url_
+000c2560: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
+000c2570: 7465 6429 207b 0a20 2020 2020 2062 7566  ted) {.      buf
+000c2580: 6665 722e 7265 7369 7a65 2863 6f6d 706f  fer.resize(compo
+000c2590: 6e65 6e74 732e 6861 7368 5f73 7461 7274  nents.hash_start
+000c25a0: 293b 0a20 2020 2020 2063 6f6d 706f 6e65  );.      compone
+000c25b0: 6e74 732e 6861 7368 5f73 7461 7274 203d  nts.hash_start =
+000c25c0: 2075 726c 5f63 6f6d 706f 6e65 6e74 733a   url_components:
+000c25d0: 3a6f 6d69 7474 6564 3b0a 2020 2020 7d0a  :omitted;.    }.
+000c25e0: 2020 2020 6865 6c70 6572 733a 3a73 7472      helpers::str
+000c25f0: 6970 5f74 7261 696c 696e 675f 7370 6163  ip_trailing_spac
+000c2600: 6573 5f66 726f 6d5f 6f70 6171 7565 5f70  es_from_opaque_p
+000c2610: 6174 6828 2a74 6869 7329 3b0a 2020 2020  ath(*this);.    
+000c2620: 7265 7475 726e 3b0a 2020 7d0a 0a20 2073  return;.  }..  s
+000c2630: 7464 3a3a 7374 7269 6e67 206e 6577 5f76  td::string new_v
+000c2640: 616c 7565 3b0a 2020 6e65 775f 7661 6c75  alue;.  new_valu
+000c2650: 6520 3d20 696e 7075 745b 305d 203d 3d20  e = input[0] == 
+000c2660: 2723 2720 3f20 696e 7075 742e 7375 6273  '#' ? input.subs
+000c2670: 7472 2831 2920 3a20 696e 7075 743b 0a20  tr(1) : input;. 
+000c2680: 2068 656c 7065 7273 3a3a 7265 6d6f 7665   helpers::remove
+000c2690: 5f61 7363 6969 5f74 6162 5f6f 725f 6e65  _ascii_tab_or_ne
+000c26a0: 776c 696e 6528 6e65 775f 7661 6c75 6529  wline(new_value)
+000c26b0: 3b0a 2020 7570 6461 7465 5f75 6e65 6e63  ;.  update_unenc
+000c26c0: 6f64 6564 5f62 6173 655f 6861 7368 286e  oded_base_hash(n
+000c26d0: 6577 5f76 616c 7565 293b 0a20 2041 4441  ew_value);.  ADA
+000c26e0: 5f41 5353 4552 545f 5452 5545 2876 616c  _ASSERT_TRUE(val
+000c26f0: 6964 6174 6528 2929 3b0a 7d0a 0a62 6f6f  idate());.}..boo
+000c2700: 6c20 7572 6c5f 6167 6772 6567 6174 6f72  l url_aggregator
+000c2710: 3a3a 7365 745f 6872 6566 2863 6f6e 7374  ::set_href(const
+000c2720: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000c2730: 7720 696e 7075 7429 207b 0a20 2041 4441  w input) {.  ADA
+000c2740: 5f41 5353 4552 545f 5452 5545 2821 6865  _ASSERT_TRUE(!he
+000c2750: 6c70 6572 733a 3a6f 7665 726c 6170 7328  lpers::overlaps(
+000c2760: 696e 7075 742c 2062 7566 6665 7229 293b  input, buffer));
+000c2770: 0a20 2061 6461 5f6c 6f67 2822 7572 6c5f  .  ada_log("url_
+000c2780: 6167 6772 6567 6174 6f72 3a3a 7365 745f  aggregator::set_
+000c2790: 6872 6566 2022 2c20 696e 7075 742c 2022  href ", input, "
+000c27a0: 5b22 2c20 696e 7075 742e 7369 7a65 2829  [", input.size()
+000c27b0: 2c20 2220 6279 7465 735d 2229 3b0a 2020  , " bytes]");.  
+000c27c0: 6164 613a 3a72 6573 756c 743c 7572 6c5f  ada::result<url_
+000c27d0: 6167 6772 6567 6174 6f72 3e20 6f75 7420  aggregator> out 
+000c27e0: 3d20 6164 613a 3a70 6172 7365 3c75 726c  = ada::parse<url
+000c27f0: 5f61 6767 7265 6761 746f 723e 2869 6e70  _aggregator>(inp
+000c2800: 7574 293b 0a20 2061 6461 5f6c 6f67 2822  ut);.  ada_log("
+000c2810: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
+000c2820: 7365 745f 6872 6566 2c20 7375 6363 6573  set_href, succes
+000c2830: 7320 3a22 2c20 6f75 742e 6861 735f 7661  s :", out.has_va
+000c2840: 6c75 6528 2929 3b0a 0a20 2069 6620 286f  lue());..  if (o
+000c2850: 7574 2920 7b0a 2020 2020 6164 615f 6c6f  ut) {.    ada_lo
+000c2860: 6728 2275 726c 5f61 6767 7265 6761 746f  g("url_aggregato
+000c2870: 723a 3a73 6574 5f68 7265 662c 2070 6172  r::set_href, par
+000c2880: 7365 6420 222c 206f 7574 2d3e 746f 5f73  sed ", out->to_s
+000c2890: 7472 696e 6728 2929 3b0a 2020 2020 2f2f  tring());.    //
+000c28a0: 2054 4f44 4f3a 2046 6967 7572 6520 6f75   TODO: Figure ou
+000c28b0: 7420 7768 7920 7468 6520 666f 6c6c 6f77  t why the follow
+000c28c0: 696e 6720 6c69 6e65 2070 7574 7320 7465  ing line puts te
+000c28d0: 7374 2074 6f20 6e65 7665 7220 6669 6e69  st to never fini
+000c28e0: 7368 2e0a 2020 2020 2a74 6869 7320 3d20  sh..    *this = 
+000c28f0: 2a6f 7574 3b0a 2020 7d0a 0a20 2072 6574  *out;.  }..  ret
+000c2900: 7572 6e20 6f75 742e 6861 735f 7661 6c75  urn out.has_valu
+000c2910: 6528 293b 0a7d 0a0a 6164 615f 7265 616c  e();.}..ada_real
+000c2920: 6c79 5f69 6e6c 696e 6520 626f 6f6c 2075  ly_inline bool u
+000c2930: 726c 5f61 6767 7265 6761 746f 723a 3a70  rl_aggregator::p
+000c2940: 6172 7365 5f68 6f73 7428 7374 643a 3a73  arse_host(std::s
+000c2950: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
+000c2960: 2920 7b0a 2020 6164 615f 6c6f 6728 2275  ) {.  ada_log("u
+000c2970: 726c 5f61 6767 7265 6761 746f 723a 7061  rl_aggregator:pa
+000c2980: 7273 655f 686f 7374 2022 2c20 696e 7075  rse_host ", inpu
+000c2990: 742c 2022 5b22 2c20 696e 7075 742e 7369  t, "[", input.si
+000c29a0: 7a65 2829 2c20 2220 6279 7465 735d 2229  ze(), " bytes]")
+000c29b0: 3b0a 2020 4144 415f 4153 5345 5254 5f54  ;.  ADA_ASSERT_T
+000c29c0: 5255 4528 7661 6c69 6461 7465 2829 293b  RUE(validate());
+000c29d0: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
+000c29e0: 5545 2821 6865 6c70 6572 733a 3a6f 7665  UE(!helpers::ove
+000c29f0: 726c 6170 7328 696e 7075 742c 2062 7566  rlaps(input, buf
+000c2a00: 6665 7229 293b 0a20 2069 6620 2869 6e70  fer));.  if (inp
+000c2a10: 7574 2e65 6d70 7479 2829 2920 7b0a 2020  ut.empty()) {.  
+000c2a20: 2020 7265 7475 726e 2069 735f 7661 6c69    return is_vali
+000c2a30: 6420 3d20 6661 6c73 653b 0a20 207d 2020  d = false;.  }  
+000c2a40: 2f2f 2074 6563 686e 6963 616c 6c79 2075  // technically u
+000c2a50: 6e6e 6563 6573 7361 7279 2e0a 2020 2f2f  nnecessary..  //
+000c2a60: 2049 6620 696e 7075 7420 7374 6172 7473   If input starts
+000c2a70: 2077 6974 6820 552b 3030 3542 2028 5b29   with U+005B ([)
+000c2a80: 2c20 7468 656e 3a0a 2020 6966 2028 696e  , then:.  if (in
+000c2a90: 7075 745b 305d 203d 3d20 275b 2729 207b  put[0] == '[') {
+000c2aa0: 0a20 2020 202f 2f20 4966 2069 6e70 7574  .    // If input
+000c2ab0: 2064 6f65 7320 6e6f 7420 656e 6420 7769   does not end wi
+000c2ac0: 7468 2055 2b30 3035 4420 285d 292c 2076  th U+005D (]), v
+000c2ad0: 616c 6964 6174 696f 6e20 6572 726f 722c  alidation error,
+000c2ae0: 2072 6574 7572 6e20 6661 696c 7572 652e   return failure.
+000c2af0: 0a20 2020 2069 6620 2869 6e70 7574 2e62  .    if (input.b
+000c2b00: 6163 6b28 2920 213d 2027 5d27 2920 7b0a  ack() != ']') {.
+000c2b10: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
+000c2b20: 7661 6c69 6420 3d20 6661 6c73 653b 0a20  valid = false;. 
+000c2b30: 2020 207d 0a20 2020 2061 6461 5f6c 6f67     }.    ada_log
+000c2b40: 2822 7061 7273 655f 686f 7374 2069 7076  ("parse_host ipv
+000c2b50: 3622 293b 0a0a 2020 2020 2f2f 2052 6574  6");..    // Ret
+000c2b60: 7572 6e20 7468 6520 7265 7375 6c74 206f  urn the result o
+000c2b70: 6620 4950 7636 2070 6172 7369 6e67 2069  f IPv6 parsing i
+000c2b80: 6e70 7574 2077 6974 6820 6974 7320 6c65  nput with its le
+000c2b90: 6164 696e 6720 552b 3030 3542 2028 5b29  ading U+005B ([)
+000c2ba0: 2061 6e64 0a20 2020 202f 2f20 7472 6169   and.    // trai
+000c2bb0: 6c69 6e67 2055 2b30 3035 4420 285d 2920  ling U+005D (]) 
+000c2bc0: 7265 6d6f 7665 642e 0a20 2020 2069 6e70  removed..    inp
+000c2bd0: 7574 2e72 656d 6f76 655f 7072 6566 6978  ut.remove_prefix
+000c2be0: 2831 293b 0a20 2020 2069 6e70 7574 2e72  (1);.    input.r
+000c2bf0: 656d 6f76 655f 7375 6666 6978 2831 293b  emove_suffix(1);
+000c2c00: 0a20 2020 2072 6574 7572 6e20 7061 7273  .    return pars
+000c2c10: 655f 6970 7636 2869 6e70 7574 293b 0a20  e_ipv6(input);. 
+000c2c20: 207d 0a0a 2020 2f2f 2049 6620 6973 4e6f   }..  // If isNo
+000c2c30: 7453 7065 6369 616c 2069 7320 7472 7565  tSpecial is true
+000c2c40: 2c20 7468 656e 2072 6574 7572 6e20 7468  , then return th
+000c2c50: 6520 7265 7375 6c74 206f 6620 6f70 6171  e result of opaq
+000c2c60: 7565 2d68 6f73 7420 7061 7273 696e 670a  ue-host parsing.
+000c2c70: 2020 2f2f 2069 6e70 7574 2e0a 2020 6966    // input..  if
+000c2c80: 2028 2169 735f 7370 6563 6961 6c28 2929   (!is_special())
+000c2c90: 207b 0a20 2020 2072 6574 7572 6e20 7061   {.    return pa
+000c2ca0: 7273 655f 6f70 6171 7565 5f68 6f73 7428  rse_opaque_host(
+000c2cb0: 696e 7075 7429 3b0a 2020 7d0a 2020 2f2f  input);.  }.  //
+000c2cc0: 204c 6574 2064 6f6d 6169 6e20 6265 2074   Let domain be t
+000c2cd0: 6865 2072 6573 756c 7420 6f66 2072 756e  he result of run
+000c2ce0: 6e69 6e67 2055 5446 2d38 2064 6563 6f64  ning UTF-8 decod
+000c2cf0: 6520 7769 7468 6f75 7420 424f 4d20 6f6e  e without BOM on
+000c2d00: 2074 6865 0a20 202f 2f20 7065 7263 656e   the.  // percen
+000c2d10: 742d 6465 636f 6469 6e67 206f 6620 696e  t-decoding of in
+000c2d20: 7075 742e 204c 6574 2061 7363 6969 446f  put. Let asciiDo
+000c2d30: 6d61 696e 2062 6520 7468 6520 7265 7375  main be the resu
+000c2d40: 6c74 206f 6620 7275 6e6e 696e 6720 646f  lt of running do
+000c2d50: 6d61 696e 0a20 202f 2f20 746f 2041 5343  main.  // to ASC
+000c2d60: 4949 2077 6974 6820 646f 6d61 696e 2061  II with domain a
+000c2d70: 6e64 2066 616c 7365 2e20 5468 6520 6d6f  nd false. The mo
+000c2d80: 7374 2063 6f6d 6d6f 6e20 6361 7365 2069  st common case i
+000c2d90: 7320 616e 2041 5343 4949 2069 6e70 7574  s an ASCII input
+000c2da0: 2c20 696e 0a20 202f 2f20 7768 6963 6820  , in.  // which 
+000c2db0: 6361 7365 2077 6520 646f 206e 6f74 206e  case we do not n
+000c2dc0: 6565 6420 746f 2063 616c 6c20 7468 6520  eed to call the 
+000c2dd0: 6578 7065 6e73 6976 6520 2774 6f5f 6173  expensive 'to_as
+000c2de0: 6369 6927 2069 6620 6120 6665 770a 2020  cii' if a few.  
+000c2df0: 2f2f 2063 6f6e 6469 7469 6f6e 7320 6172  // conditions ar
+000c2e00: 6520 6d65 743a 206e 6f20 2725 2720 616e  e met: no '%' an
+000c2e10: 6420 6e6f 2027 786e 2d27 2073 7562 7365  d no 'xn-' subse
+000c2e20: 7175 656e 6365 2e0a 0a20 202f 2f20 4f66  quence...  // Of
+000c2e30: 7465 6e2c 2074 6865 2069 6e70 7574 2064  ten, the input d
+000c2e40: 6f65 7320 6e6f 7420 636f 6e74 6169 6e20  oes not contain 
+000c2e50: 616e 7920 666f 7262 6964 6465 6e20 636f  any forbidden co
+000c2e60: 6465 2070 6f69 6e74 732c 2061 6e64 206e  de points, and n
+000c2e70: 6f20 7570 7065 720a 2020 2f2f 2063 6173  o upper.  // cas
+000c2e80: 6520 4153 4349 4920 6c65 7474 6572 2c20  e ASCII letter, 
+000c2e90: 7468 656e 2077 6520 6361 6e20 6a75 7374  then we can just
+000c2ea0: 2063 6f70 7920 6974 2074 6f20 7468 6520   copy it to the 
+000c2eb0: 6275 6666 6572 2e20 5765 2077 616e 7420  buffer. We want 
+000c2ec0: 746f 0a20 202f 2f20 6f70 7469 6d69 7a65  to.  // optimize
+000c2ed0: 2066 6f72 2073 7563 6820 6120 636f 6d6d   for such a comm
+000c2ee0: 6f6e 2063 6173 652e 0a20 2075 696e 7438  on case..  uint8
+000c2ef0: 5f74 2069 735f 666f 7262 6964 6465 6e5f  _t is_forbidden_
+000c2f00: 6f72 5f75 7070 6572 203d 0a20 2020 2020  or_upper =.     
+000c2f10: 2075 6e69 636f 6465 3a3a 636f 6e74 6169   unicode::contai
+000c2f20: 6e73 5f66 6f72 6269 6464 656e 5f64 6f6d  ns_forbidden_dom
+000c2f30: 6169 6e5f 636f 6465 5f70 6f69 6e74 5f6f  ain_code_point_o
+000c2f40: 725f 7570 7065 7228 696e 7075 742e 6461  r_upper(input.da
+000c2f50: 7461 2829 2c0a 2020 2020 2020 2020 2020  ta(),.          
+000c2f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c2f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c2f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c2f90: 2020 2069 6e70 7574 2e73 697a 6528 2929     input.size())
+000c2fa0: 3b0a 2020 2f2f 204d 696e 6f72 206f 7074  ;.  // Minor opt
+000c2fb0: 696d 697a 6174 696f 6e20 6f70 706f 7274  imization opport
+000c2fc0: 756e 6974 793a 0a20 202f 2f20 636f 6e74  unity:.  // cont
+000c2fd0: 6169 6e73 5f66 6f72 6269 6464 656e 5f64  ains_forbidden_d
+000c2fe0: 6f6d 6169 6e5f 636f 6465 5f70 6f69 6e74  omain_code_point
+000c2ff0: 5f6f 725f 7570 7065 7220 636f 756c 6420  _or_upper could 
+000c3000: 6265 2065 7874 656e 6420 746f 2063 6865  be extend to che
+000c3010: 636b 2066 6f72 0a20 202f 2f20 7468 6520  ck for.  // the 
+000c3020: 7072 6573 656e 6365 206f 6620 6368 6172  presence of char
+000c3030: 6163 7465 7273 2074 6861 7420 6361 6e6e  acters that cann
+000c3040: 6f74 2061 7070 6561 7220 696e 2074 6865  ot appear in the
+000c3050: 2069 7076 3420 6164 6472 6573 7320 616e   ipv4 address an
+000c3060: 6420 7765 0a20 202f 2f20 636f 756c 6420  d we.  // could 
+000c3070: 616c 736f 2063 6865 636b 2077 6865 7468  also check wheth
+000c3080: 6572 2078 2061 6e64 206e 2061 6e64 202d  er x and n and -
+000c3090: 2061 7265 2070 7265 7365 6e74 2c20 616e   are present, an
+000c30a0: 6420 736f 2077 6520 636f 756c 6420 736b  d so we could sk
+000c30b0: 6970 0a20 202f 2f20 736f 6d65 206f 6620  ip.  // some of 
+000c30c0: 7468 6520 6368 6563 6b73 2062 656c 6f77  the checks below
+000c30d0: 2e20 486f 7765 7665 722c 2074 6865 2067  . However, the g
+000c30e0: 6169 6e73 2061 7265 206c 696b 656c 7920  ains are likely 
+000c30f0: 746f 2062 6520 736d 616c 6c2c 2061 6e64  to be small, and
+000c3100: 0a20 202f 2f20 7468 6520 636f 6465 2077  .  // the code w
+000c3110: 6f75 6c64 2062 6520 6d6f 7265 2063 6f6d  ould be more com
+000c3120: 706c 6578 2e0a 2020 6966 2028 6973 5f66  plex..  if (is_f
+000c3130: 6f72 6269 6464 656e 5f6f 725f 7570 7065  orbidden_or_uppe
+000c3140: 7220 3d3d 2030 2026 260a 2020 2020 2020  r == 0 &&.      
+000c3150: 696e 7075 742e 6669 6e64 2822 786e 2d22  input.find("xn-"
+000c3160: 2920 3d3d 2073 7464 3a3a 7374 7269 6e67  ) == std::string
+000c3170: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
+000c3180: 2020 202f 2f20 6661 7374 2070 6174 680a     // fast path.
+000c3190: 2020 2020 7570 6461 7465 5f62 6173 655f      update_base_
+000c31a0: 686f 7374 6e61 6d65 2869 6e70 7574 293b  hostname(input);
+000c31b0: 0a20 2020 2069 6620 2863 6865 636b 6572  .    if (checker
+000c31c0: 733a 3a69 735f 6970 7634 2867 6574 5f68  s::is_ipv4(get_h
+000c31d0: 6f73 746e 616d 6528 2929 2920 7b0a 2020  ostname())) {.  
+000c31e0: 2020 2020 6164 615f 6c6f 6728 2270 6172      ada_log("par
+000c31f0: 7365 5f68 6f73 7420 6661 7374 2070 6174  se_host fast pat
+000c3200: 6820 6970 7634 2229 3b0a 2020 2020 2020  h ipv4");.      
+000c3210: 7265 7475 726e 2070 6172 7365 5f69 7076  return parse_ipv
+000c3220: 3428 6765 745f 686f 7374 6e61 6d65 2829  4(get_hostname()
+000c3230: 293b 0a20 2020 207d 0a20 2020 2061 6461  );.    }.    ada
+000c3240: 5f6c 6f67 2822 7061 7273 655f 686f 7374  _log("parse_host
+000c3250: 2066 6173 7420 7061 7468 2022 2c20 6765   fast path ", ge
+000c3260: 745f 686f 7374 6e61 6d65 2829 293b 0a20  t_hostname());. 
+000c3270: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
+000c3280: 2020 7d0a 2020 2f2f 2057 6520 6861 7665    }.  // We have
+000c3290: 2065 6e63 6f75 6e74 6572 6564 2061 7420   encountered at 
+000c32a0: 6c65 6173 7420 6f6e 6520 666f 7262 6964  least one forbid
+000c32b0: 6465 6e20 636f 6465 2070 6f69 6e74 206f  den code point o
+000c32c0: 7220 7468 6520 696e 7075 7420 636f 6e74  r the input cont
+000c32d0: 6169 6e73 0a20 202f 2f20 2778 6e2d 2720  ains.  // 'xn-' 
+000c32e0: 2863 6173 6520 696e 7365 6e73 6974 6976  (case insensitiv
+000c32f0: 6529 2c20 736f 2077 6520 6e65 6564 2074  e), so we need t
+000c3300: 6f20 6361 6c6c 2027 746f 5f61 7363 6969  o call 'to_ascii
+000c3310: 2720 746f 2070 6572 666f 726d 2074 6865  ' to perform the
+000c3320: 2066 756c 6c0a 2020 2f2f 2063 6f6e 7665   full.  // conve
+000c3330: 7273 696f 6e2e 0a0a 2020 6164 615f 6c6f  rsion...  ada_lo
+000c3340: 6728 2270 6172 7365 5f68 6f73 7420 6361  g("parse_host ca
+000c3350: 6c6c 696e 6720 746f 5f61 7363 6969 2229  lling to_ascii")
+000c3360: 3b0a 2020 7374 643a 3a6f 7074 696f 6e61  ;.  std::optiona
+000c3370: 6c3c 7374 643a 3a73 7472 696e 673e 2068  l<std::string> h
+000c3380: 6f73 7420 3d20 7374 643a 3a73 7472 696e  ost = std::strin
+000c3390: 6728 6765 745f 686f 7374 6e61 6d65 2829  g(get_hostname()
+000c33a0: 293b 0a20 2069 735f 7661 6c69 6420 3d20  );.  is_valid = 
+000c33b0: 6164 613a 3a75 6e69 636f 6465 3a3a 746f  ada::unicode::to
+000c33c0: 5f61 7363 6969 2868 6f73 742c 2069 6e70  _ascii(host, inp
+000c33d0: 7574 2c20 696e 7075 742e 6669 6e64 2827  ut, input.find('
+000c33e0: 2527 2929 3b0a 2020 6966 2028 2169 735f  %'));.  if (!is_
+000c33f0: 7661 6c69 6429 207b 0a20 2020 2061 6461  valid) {.    ada
+000c3400: 5f6c 6f67 2822 7061 7273 655f 686f 7374  _log("parse_host
+000c3410: 2074 6f5f 6173 6369 6920 7265 7475 726e   to_ascii return
+000c3420: 7320 6661 6c73 6522 293b 0a20 2020 2072  s false");.    r
 000c3430: 6574 7572 6e20 6973 5f76 616c 6964 203d  eturn is_valid =
-000c3440: 2066 616c 7365 3b0a 2020 7d0a 0a20 202f   false;.  }..  /
-000c3450: 2f20 4966 2061 7363 6969 446f 6d61 696e  / If asciiDomain
-000c3460: 2065 6e64 7320 696e 2061 206e 756d 6265   ends in a numbe
-000c3470: 722c 2074 6865 6e20 7265 7475 726e 2074  r, then return t
-000c3480: 6865 2072 6573 756c 7420 6f66 2049 5076  he result of IPv
-000c3490: 3420 7061 7273 696e 670a 2020 2f2f 2061  4 parsing.  // a
-000c34a0: 7363 6969 446f 6d61 696e 2e0a 2020 6966  sciiDomain..  if
-000c34b0: 2028 6368 6563 6b65 7273 3a3a 6973 5f69   (checkers::is_i
-000c34c0: 7076 3428 686f 7374 2e76 616c 7565 2829  pv4(host.value()
-000c34d0: 2929 207b 0a20 2020 2061 6461 5f6c 6f67  )) {.    ada_log
-000c34e0: 2822 7061 7273 655f 686f 7374 2067 6f74  ("parse_host got
-000c34f0: 2069 7076 3422 2c20 2a68 6f73 7429 3b0a   ipv4", *host);.
-000c3500: 2020 2020 7265 7475 726e 2070 6172 7365      return parse
-000c3510: 5f69 7076 3428 686f 7374 2e76 616c 7565  _ipv4(host.value
-000c3520: 2829 293b 0a20 207d 0a0a 2020 7570 6461  ());.  }..  upda
-000c3530: 7465 5f62 6173 655f 686f 7374 6e61 6d65  te_base_hostname
-000c3540: 2868 6f73 742e 7661 6c75 6528 2929 3b0a  (host.value());.
-000c3550: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000c3560: 4528 7661 6c69 6461 7465 2829 293b 0a20  E(validate());. 
-000c3570: 2072 6574 7572 6e20 7472 7565 3b0a 7d0a   return true;.}.
-000c3580: 0a74 656d 706c 6174 6520 3c62 6f6f 6c20  .template <bool 
-000c3590: 6f76 6572 7269 6465 5f68 6f73 746e 616d  override_hostnam
-000c35a0: 653e 0a62 6f6f 6c20 7572 6c5f 6167 6772  e>.bool url_aggr
-000c35b0: 6567 6174 6f72 3a3a 7365 745f 686f 7374  egator::set_host
-000c35c0: 5f6f 725f 686f 7374 6e61 6d65 2863 6f6e  _or_hostname(con
-000c35d0: 7374 2073 7464 3a3a 7374 7269 6e67 5f76  st std::string_v
-000c35e0: 6965 7720 696e 7075 7429 207b 0a20 2061  iew input) {.  a
-000c35f0: 6461 5f6c 6f67 2822 7572 6c5f 6167 6772  da_log("url_aggr
-000c3600: 6567 6174 6f72 3a3a 7365 745f 686f 7374  egator::set_host
-000c3610: 5f6f 725f 686f 7374 6e61 6d65 2022 2c20  _or_hostname ", 
-000c3620: 696e 7075 7429 3b0a 2020 4144 415f 4153  input);.  ADA_AS
-000c3630: 5345 5254 5f54 5255 4528 7661 6c69 6461  SERT_TRUE(valida
-000c3640: 7465 2829 293b 0a20 2041 4441 5f41 5353  te());.  ADA_ASS
-000c3650: 4552 545f 5452 5545 2821 6865 6c70 6572  ERT_TRUE(!helper
-000c3660: 733a 3a6f 7665 726c 6170 7328 696e 7075  s::overlaps(inpu
-000c3670: 742c 2062 7566 6665 7229 293b 0a20 2069  t, buffer));.  i
-000c3680: 6620 2868 6173 5f6f 7061 7175 655f 7061  f (has_opaque_pa
-000c3690: 7468 2920 7b0a 2020 2020 7265 7475 726e  th) {.    return
-000c36a0: 2066 616c 7365 3b0a 2020 7d0a 0a20 2073   false;.  }..  s
-000c36b0: 7464 3a3a 7374 7269 6e67 2070 7265 7669  td::string previ
-000c36c0: 6f75 735f 686f 7374 203d 2073 7464 3a3a  ous_host = std::
-000c36d0: 7374 7269 6e67 2867 6574 5f68 6f73 746e  string(get_hostn
-000c36e0: 616d 6528 2929 3b0a 2020 7569 6e74 3332  ame());.  uint32
-000c36f0: 5f74 2070 7265 7669 6f75 735f 706f 7274  _t previous_port
-000c3700: 203d 2063 6f6d 706f 6e65 6e74 732e 706f   = components.po
-000c3710: 7274 3b0a 0a20 2073 697a 655f 7420 686f  rt;..  size_t ho
-000c3720: 7374 5f65 6e64 5f70 6f73 203d 2069 6e70  st_end_pos = inp
-000c3730: 7574 2e66 696e 6428 2723 2729 3b0a 2020  ut.find('#');.  
-000c3740: 7374 643a 3a73 7472 696e 6720 5f68 6f73  std::string _hos
-000c3750: 7428 696e 7075 742e 6461 7461 2829 2c20  t(input.data(), 
-000c3760: 686f 7374 5f65 6e64 5f70 6f73 2021 3d20  host_end_pos != 
-000c3770: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000c3780: 3a3a 6e70 6f73 0a20 2020 2020 2020 2020  ::npos.         
-000c3790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c37a0: 2020 2020 2020 2020 2020 2020 203f 2068               ? h
-000c37b0: 6f73 745f 656e 645f 706f 730a 2020 2020  ost_end_pos.    
-000c37c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c37d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c37e0: 2020 3a20 696e 7075 742e 7369 7a65 2829    : input.size()
-000c37f0: 293b 0a20 2068 656c 7065 7273 3a3a 7265  );.  helpers::re
-000c3800: 6d6f 7665 5f61 7363 6969 5f74 6162 5f6f  move_ascii_tab_o
-000c3810: 725f 6e65 776c 696e 6528 5f68 6f73 7429  r_newline(_host)
-000c3820: 3b0a 2020 7374 643a 3a73 7472 696e 675f  ;.  std::string_
-000c3830: 7669 6577 206e 6577 5f68 6f73 7428 5f68  view new_host(_h
-000c3840: 6f73 7429 3b0a 0a20 202f 2f20 4966 2075  ost);..  // If u
-000c3850: 726c 2773 2073 6368 656d 6520 6973 2022  rl's scheme is "
-000c3860: 6669 6c65 222c 2074 6865 6e20 7365 7420  file", then set 
-000c3870: 7374 6174 6520 746f 2066 696c 6520 686f  state to file ho
-000c3880: 7374 2073 7461 7465 2c20 696e 7374 6561  st state, instea
-000c3890: 6420 6f66 0a20 202f 2f20 686f 7374 2073  d of.  // host s
-000c38a0: 7461 7465 2e0a 2020 6966 2028 7479 7065  tate..  if (type
-000c38b0: 2021 3d20 6164 613a 3a73 6368 656d 653a   != ada::scheme:
-000c38c0: 3a74 7970 653a 3a46 494c 4529 207b 0a20  :type::FILE) {. 
-000c38d0: 2020 2073 7464 3a3a 7374 7269 6e67 5f76     std::string_v
-000c38e0: 6965 7720 686f 7374 5f76 6965 7728 5f68  iew host_view(_h
-000c38f0: 6f73 742e 6461 7461 2829 2c20 5f68 6f73  ost.data(), _hos
-000c3900: 742e 6c65 6e67 7468 2829 293b 0a20 2020  t.length());.   
-000c3910: 2061 7574 6f20 5b6c 6f63 6174 696f 6e2c   auto [location,
-000c3920: 2066 6f75 6e64 5f63 6f6c 6f6e 5d20 3d0a   found_colon] =.
-000c3930: 2020 2020 2020 2020 6865 6c70 6572 733a          helpers:
-000c3940: 3a67 6574 5f68 6f73 745f 6465 6c69 6d69  :get_host_delimi
-000c3950: 7465 725f 6c6f 6361 7469 6f6e 2869 735f  ter_location(is_
-000c3960: 7370 6563 6961 6c28 292c 2068 6f73 745f  special(), host_
-000c3970: 7669 6577 293b 0a0a 2020 2020 2f2f 204f  view);..    // O
-000c3980: 7468 6572 7769 7365 2c20 6966 2063 2069  therwise, if c i
-000c3990: 7320 552b 3030 3341 2028 3a29 2061 6e64  s U+003A (:) and
-000c39a0: 2069 6e73 6964 6542 7261 636b 6574 7320   insideBrackets 
-000c39b0: 6973 2066 616c 7365 2c20 7468 656e 3a0a  is false, then:.
-000c39c0: 2020 2020 2f2f 204e 6f74 653a 2074 6865      // Note: the
-000c39d0: 2027 666f 756e 645f 636f 6c6f 6e27 2076   'found_colon' v
-000c39e0: 616c 7565 2069 7320 7472 7565 2069 6620  alue is true if 
-000c39f0: 616e 6420 6f6e 6c79 2069 6620 6120 636f  and only if a co
-000c3a00: 6c6f 6e20 7761 730a 2020 2020 2f2f 2065  lon was.    // e
-000c3a10: 6e63 6f75 6e74 6572 6564 2077 6869 6c65  ncountered while
-000c3a20: 206e 6f74 2069 6e73 6964 6520 6272 6163   not inside brac
-000c3a30: 6b65 7473 2e0a 2020 2020 6966 2028 666f  kets..    if (fo
-000c3a40: 756e 645f 636f 6c6f 6e29 207b 0a20 2020  und_colon) {.   
-000c3a50: 2020 2069 6620 286f 7665 7272 6964 655f     if (override_
-000c3a60: 686f 7374 6e61 6d65 2920 7b0a 2020 2020  hostname) {.    
-000c3a70: 2020 2020 7265 7475 726e 2066 616c 7365      return false
-000c3a80: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
-000c3a90: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000c3aa0: 2073 7562 5f62 7566 6665 7220 3d20 6e65   sub_buffer = ne
-000c3ab0: 775f 686f 7374 2e73 7562 7374 7228 6c6f  w_host.substr(lo
-000c3ac0: 6361 7469 6f6e 202b 2031 293b 0a20 2020  cation + 1);.   
-000c3ad0: 2020 2069 6620 2821 7375 625f 6275 6666     if (!sub_buff
-000c3ae0: 6572 2e65 6d70 7479 2829 2920 7b0a 2020  er.empty()) {.  
-000c3af0: 2020 2020 2020 7365 745f 706f 7274 2873        set_port(s
-000c3b00: 7562 5f62 7566 6665 7229 3b0a 2020 2020  ub_buffer);.    
-000c3b10: 2020 7d0a 2020 2020 7d0a 2020 2020 2f2f    }.    }.    //
-000c3b20: 2049 6620 7572 6c20 6973 2073 7065 6369   If url is speci
-000c3b30: 616c 2061 6e64 2068 6f73 745f 7669 6577  al and host_view
-000c3b40: 2069 7320 7468 6520 656d 7074 7920 7374   is the empty st
-000c3b50: 7269 6e67 2c20 7661 6c69 6461 7469 6f6e  ring, validation
-000c3b60: 2065 7272 6f72 2c0a 2020 2020 2f2f 2072   error,.    // r
-000c3b70: 6574 7572 6e20 6661 696c 7572 652e 204f  eturn failure. O
-000c3b80: 7468 6572 7769 7365 2c20 6966 2073 7461  therwise, if sta
-000c3b90: 7465 206f 7665 7272 6964 6520 6973 2067  te override is g
-000c3ba0: 6976 656e 2c20 686f 7374 5f76 6965 7720  iven, host_view 
-000c3bb0: 6973 2074 6865 0a20 2020 202f 2f20 656d  is the.    // em
-000c3bc0: 7074 7920 7374 7269 6e67 2c20 616e 6420  pty string, and 
-000c3bd0: 6569 7468 6572 2075 726c 2069 6e63 6c75  either url inclu
-000c3be0: 6465 7320 6372 6564 656e 7469 616c 7320  des credentials 
-000c3bf0: 6f72 2075 726c e280 9973 2070 6f72 7420  or url...s port 
-000c3c00: 6973 0a20 2020 202f 2f20 6e6f 6e2d 6e75  is.    // non-nu
-000c3c10: 6c6c 2c20 7265 7475 726e 2e0a 2020 2020  ll, return..    
-000c3c20: 656c 7365 2069 6620 2868 6f73 745f 7669  else if (host_vi
-000c3c30: 6577 2e65 6d70 7479 2829 2026 260a 2020  ew.empty() &&.  
-000c3c40: 2020 2020 2020 2020 2020 2028 6973 5f73             (is_s
-000c3c50: 7065 6369 616c 2829 207c 7c20 6861 735f  pecial() || has_
-000c3c60: 6372 6564 656e 7469 616c 7328 2920 7c7c  credentials() ||
-000c3c70: 0a20 2020 2020 2020 2020 2020 2020 2063  .              c
-000c3c80: 6f6d 706f 6e65 6e74 732e 706f 7274 2021  omponents.port !
-000c3c90: 3d20 7572 6c5f 636f 6d70 6f6e 656e 7473  = url_components
-000c3ca0: 3a3a 6f6d 6974 7465 6429 2920 7b0a 2020  ::omitted)) {.  
-000c3cb0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
-000c3cc0: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-000c3cd0: 4c65 7420 686f 7374 2062 6520 7468 6520  Let host be the 
-000c3ce0: 7265 7375 6c74 206f 6620 686f 7374 2070  result of host p
-000c3cf0: 6172 7369 6e67 2068 6f73 745f 7669 6577  arsing host_view
-000c3d00: 2077 6974 6820 7572 6c20 6973 206e 6f74   with url is not
-000c3d10: 2073 7065 6369 616c 2e0a 2020 2020 6966   special..    if
-000c3d20: 2028 686f 7374 5f76 6965 772e 656d 7074   (host_view.empt
-000c3d30: 7928 2929 207b 0a20 2020 2020 2069 6620  y()) {.      if 
-000c3d40: 2868 6173 5f68 6f73 746e 616d 6528 2929  (has_hostname())
-000c3d50: 207b 0a20 2020 2020 2020 2063 6c65 6172   {.        clear
-000c3d60: 5f68 6f73 746e 616d 6528 293b 2020 2f2f  _hostname();  //
-000c3d70: 2065 6173 7921 0a20 2020 2020 207d 2065   easy!.      } e
-000c3d80: 6c73 6520 6966 2028 6861 735f 6461 7368  lse if (has_dash
-000c3d90: 5f64 6f74 2829 2920 7b0a 2020 2020 2020  _dot()) {.      
-000c3da0: 2020 6164 645f 6175 7468 6f72 6974 795f    add_authority_
-000c3db0: 736c 6173 6865 735f 6966 5f6e 6565 6465  slashes_if_neede
-000c3dc0: 6428 293b 0a20 2020 2020 2020 2064 656c  d();.        del
-000c3dd0: 6574 655f 6461 7368 5f64 6f74 2829 3b0a  ete_dash_dot();.
-000c3de0: 2020 2020 2020 7d0a 2020 2020 2020 7265        }.      re
-000c3df0: 7475 726e 2074 7275 653b 0a20 2020 207d  turn true;.    }
-000c3e00: 0a0a 2020 2020 626f 6f6c 2073 7563 6365  ..    bool succe
-000c3e10: 6564 6564 203d 2070 6172 7365 5f68 6f73  eded = parse_hos
-000c3e20: 7428 686f 7374 5f76 6965 7729 3b0a 2020  t(host_view);.  
-000c3e30: 2020 6966 2028 2173 7563 6365 6564 6564    if (!succeeded
-000c3e40: 2920 7b0a 2020 2020 2020 7570 6461 7465  ) {.      update
-000c3e50: 5f62 6173 655f 686f 7374 6e61 6d65 2870  _base_hostname(p
-000c3e60: 7265 7669 6f75 735f 686f 7374 293b 0a20  revious_host);. 
-000c3e70: 2020 2020 2075 7064 6174 655f 6261 7365       update_base
-000c3e80: 5f70 6f72 7428 7072 6576 696f 7573 5f70  _port(previous_p
-000c3e90: 6f72 7429 3b0a 2020 2020 7d20 656c 7365  ort);.    } else
-000c3ea0: 2069 6620 2868 6173 5f64 6173 685f 646f   if (has_dash_do
-000c3eb0: 7428 2929 207b 0a20 2020 2020 202f 2f20  t()) {.      // 
-000c3ec0: 5368 6f75 6c64 2072 656d 6f76 6520 6461  Should remove da
-000c3ed0: 7368 5f64 6f74 2066 726f 6d20 7061 7468  sh_dot from path
-000c3ee0: 6e61 6d65 0a20 2020 2020 2064 656c 6574  name.      delet
-000c3ef0: 655f 6461 7368 5f64 6f74 2829 3b0a 2020  e_dash_dot();.  
-000c3f00: 2020 7d0a 2020 2020 7265 7475 726e 2073    }.    return s
-000c3f10: 7563 6365 6564 6564 3b0a 2020 7d0a 0a20  ucceeded;.  }.. 
-000c3f20: 2073 697a 655f 7420 6c6f 6361 7469 6f6e   size_t location
-000c3f30: 203d 206e 6577 5f68 6f73 742e 6669 6e64   = new_host.find
-000c3f40: 5f66 6972 7374 5f6f 6628 222f 5c5c 3f22  _first_of("/\\?"
-000c3f50: 293b 0a20 2069 6620 286c 6f63 6174 696f  );.  if (locatio
-000c3f60: 6e20 213d 2073 7464 3a3a 7374 7269 6e67  n != std::string
-000c3f70: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
-000c3f80: 2020 206e 6577 5f68 6f73 742e 7265 6d6f     new_host.remo
-000c3f90: 7665 5f73 7566 6669 7828 6e65 775f 686f  ve_suffix(new_ho
-000c3fa0: 7374 2e6c 656e 6774 6828 2920 2d20 6c6f  st.length() - lo
-000c3fb0: 6361 7469 6f6e 293b 0a20 207d 0a0a 2020  cation);.  }..  
-000c3fc0: 6966 2028 6e65 775f 686f 7374 2e65 6d70  if (new_host.emp
-000c3fd0: 7479 2829 2920 7b0a 2020 2020 2f2f 2053  ty()) {.    // S
-000c3fe0: 6574 2075 726c e280 9973 2068 6f73 7420  et url...s host 
-000c3ff0: 746f 2074 6865 2065 6d70 7479 2073 7472  to the empty str
-000c4000: 696e 672e 0a20 2020 2063 6c65 6172 5f68  ing..    clear_h
-000c4010: 6f73 746e 616d 6528 293b 0a20 207d 2065  ostname();.  } e
-000c4020: 6c73 6520 7b0a 2020 2020 2f2f 204c 6574  lse {.    // Let
-000c4030: 2068 6f73 7420 6265 2074 6865 2072 6573   host be the res
-000c4040: 756c 7420 6f66 2068 6f73 7420 7061 7273  ult of host pars
-000c4050: 696e 6720 6275 6666 6572 2077 6974 6820  ing buffer with 
-000c4060: 7572 6c20 6973 206e 6f74 2073 7065 6369  url is not speci
-000c4070: 616c 2e0a 2020 2020 6966 2028 2170 6172  al..    if (!par
-000c4080: 7365 5f68 6f73 7428 6e65 775f 686f 7374  se_host(new_host
-000c4090: 2929 207b 0a20 2020 2020 2075 7064 6174  )) {.      updat
-000c40a0: 655f 6261 7365 5f68 6f73 746e 616d 6528  e_base_hostname(
-000c40b0: 7072 6576 696f 7573 5f68 6f73 7429 3b0a  previous_host);.
-000c40c0: 2020 2020 2020 7570 6461 7465 5f62 6173        update_bas
-000c40d0: 655f 706f 7274 2870 7265 7669 6f75 735f  e_port(previous_
-000c40e0: 706f 7274 293b 0a20 2020 2020 2072 6574  port);.      ret
-000c40f0: 7572 6e20 6661 6c73 653b 0a20 2020 207d  urn false;.    }
-000c4100: 0a0a 2020 2020 2f2f 2049 6620 686f 7374  ..    // If host
-000c4110: 2069 7320 226c 6f63 616c 686f 7374 222c   is "localhost",
-000c4120: 2074 6865 6e20 7365 7420 686f 7374 2074   then set host t
-000c4130: 6f20 7468 6520 656d 7074 7920 7374 7269  o the empty stri
-000c4140: 6e67 2e0a 2020 2020 6966 2028 6865 6c70  ng..    if (help
-000c4150: 6572 733a 3a73 7562 7374 7269 6e67 2862  ers::substring(b
-000c4160: 7566 6665 722c 2063 6f6d 706f 6e65 6e74  uffer, component
-000c4170: 732e 686f 7374 5f73 7461 7274 2c0a 2020  s.host_start,.  
-000c4180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c4190: 2020 2020 2020 2020 2063 6f6d 706f 6e65           compone
-000c41a0: 6e74 732e 686f 7374 5f65 6e64 2920 3d3d  nts.host_end) ==
-000c41b0: 2022 6c6f 6361 6c68 6f73 7422 2920 7b0a   "localhost") {.
-000c41c0: 2020 2020 2020 636c 6561 725f 686f 7374        clear_host
-000c41d0: 6e61 6d65 2829 3b0a 2020 2020 7d0a 2020  name();.    }.  
-000c41e0: 7d0a 2020 4144 415f 4153 5345 5254 5f54  }.  ADA_ASSERT_T
-000c41f0: 5255 4528 7661 6c69 6461 7465 2829 293b  RUE(validate());
-000c4200: 0a20 2072 6574 7572 6e20 7472 7565 3b0a  .  return true;.
-000c4210: 7d0a 0a62 6f6f 6c20 7572 6c5f 6167 6772  }..bool url_aggr
-000c4220: 6567 6174 6f72 3a3a 7365 745f 686f 7374  egator::set_host
-000c4230: 2863 6f6e 7374 2073 7464 3a3a 7374 7269  (const std::stri
-000c4240: 6e67 5f76 6965 7720 696e 7075 7429 207b  ng_view input) {
-000c4250: 0a20 2061 6461 5f6c 6f67 2822 7572 6c5f  .  ada_log("url_
-000c4260: 6167 6772 6567 6174 6f72 3a3a 7365 745f  aggregator::set_
-000c4270: 686f 7374 2027 222c 2069 6e70 7574 2c20  host '", input, 
-000c4280: 2227 2229 3b0a 2020 4144 415f 4153 5345  "'");.  ADA_ASSE
-000c4290: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
-000c42a0: 2829 293b 0a20 2041 4441 5f41 5353 4552  ());.  ADA_ASSER
-000c42b0: 545f 5452 5545 2821 6865 6c70 6572 733a  T_TRUE(!helpers:
-000c42c0: 3a6f 7665 726c 6170 7328 696e 7075 742c  :overlaps(input,
-000c42d0: 2062 7566 6665 7229 293b 0a20 2072 6574   buffer));.  ret
-000c42e0: 7572 6e20 7365 745f 686f 7374 5f6f 725f  urn set_host_or_
-000c42f0: 686f 7374 6e61 6d65 3c66 616c 7365 3e28  hostname<false>(
-000c4300: 696e 7075 7429 3b0a 7d0a 0a62 6f6f 6c20  input);.}..bool 
-000c4310: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
-000c4320: 7365 745f 686f 7374 6e61 6d65 2863 6f6e  set_hostname(con
-000c4330: 7374 2073 7464 3a3a 7374 7269 6e67 5f76  st std::string_v
-000c4340: 6965 7720 696e 7075 7429 207b 0a20 2061  iew input) {.  a
-000c4350: 6461 5f6c 6f67 2822 7572 6c5f 6167 6772  da_log("url_aggr
-000c4360: 6567 6174 6f72 3a3a 7365 745f 686f 7374  egator::set_host
-000c4370: 6e61 6d65 2027 222c 2069 6e70 7574 2c20  name '", input, 
-000c4380: 2227 2229 3b0a 2020 4144 415f 4153 5345  "'");.  ADA_ASSE
-000c4390: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
-000c43a0: 2829 293b 0a20 2041 4441 5f41 5353 4552  ());.  ADA_ASSER
-000c43b0: 545f 5452 5545 2821 6865 6c70 6572 733a  T_TRUE(!helpers:
-000c43c0: 3a6f 7665 726c 6170 7328 696e 7075 742c  :overlaps(input,
-000c43d0: 2062 7566 6665 7229 293b 0a20 2072 6574   buffer));.  ret
-000c43e0: 7572 6e20 7365 745f 686f 7374 5f6f 725f  urn set_host_or_
-000c43f0: 686f 7374 6e61 6d65 3c74 7275 653e 2869  hostname<true>(i
-000c4400: 6e70 7574 293b 0a7d 0a0a 5b5b 6e6f 6469  nput);.}..[[nodi
-000c4410: 7363 6172 645d 5d20 7374 643a 3a73 7472  scard]] std::str
-000c4420: 696e 6720 7572 6c5f 6167 6772 6567 6174  ing url_aggregat
-000c4430: 6f72 3a3a 6765 745f 6f72 6967 696e 2829  or::get_origin()
-000c4440: 2063 6f6e 7374 206e 6f65 7863 6570 7420   const noexcept 
-000c4450: 7b0a 2020 6164 615f 6c6f 6728 2275 726c  {.  ada_log("url
-000c4460: 5f61 6767 7265 6761 746f 723a 3a67 6574  _aggregator::get
-000c4470: 5f6f 7269 6769 6e22 293b 0a20 2069 6620  _origin");.  if 
-000c4480: 2869 735f 7370 6563 6961 6c28 2929 207b  (is_special()) {
-000c4490: 0a20 2020 202f 2f20 5265 7475 726e 2061  .    // Return a
-000c44a0: 206e 6577 206f 7061 7175 6520 6f72 6967   new opaque orig
-000c44b0: 696e 2e0a 2020 2020 6966 2028 7479 7065  in..    if (type
-000c44c0: 203d 3d20 7363 6865 6d65 3a3a 4649 4c45   == scheme::FILE
-000c44d0: 2920 7b0a 2020 2020 2020 7265 7475 726e  ) {.      return
-000c44e0: 2022 6e75 6c6c 223b 0a20 2020 207d 0a0a   "null";.    }..
-000c44f0: 2020 2020 7265 7475 726e 2068 656c 7065      return helpe
-000c4500: 7273 3a3a 636f 6e63 6174 2867 6574 5f70  rs::concat(get_p
-000c4510: 726f 746f 636f 6c28 292c 2022 2f2f 222c  rotocol(), "//",
-000c4520: 2067 6574 5f68 6f73 7428 2929 3b0a 2020   get_host());.  
-000c4530: 7d0a 0a20 2069 6620 2867 6574 5f70 726f  }..  if (get_pro
-000c4540: 746f 636f 6c28 2920 3d3d 2022 626c 6f62  tocol() == "blob
-000c4550: 3a22 2920 7b0a 2020 2020 7374 643a 3a73  :") {.    std::s
-000c4560: 7472 696e 675f 7669 6577 2070 6174 6820  tring_view path 
-000c4570: 3d20 6765 745f 7061 7468 6e61 6d65 2829  = get_pathname()
-000c4580: 3b0a 2020 2020 6966 2028 2170 6174 682e  ;.    if (!path.
-000c4590: 656d 7074 7928 2929 207b 0a20 2020 2020  empty()) {.     
-000c45a0: 2061 7574 6f20 6f75 7420 3d20 6164 613a   auto out = ada:
-000c45b0: 3a70 6172 7365 3c61 6461 3a3a 7572 6c5f  :parse<ada::url_
-000c45c0: 6167 6772 6567 6174 6f72 3e28 7061 7468  aggregator>(path
-000c45d0: 293b 0a20 2020 2020 2069 6620 286f 7574  );.      if (out
-000c45e0: 2026 2620 6f75 742d 3e69 735f 7370 6563   && out->is_spec
-000c45f0: 6961 6c28 2929 207b 0a20 2020 2020 2020  ial()) {.       
-000c4600: 2072 6574 7572 6e20 6865 6c70 6572 733a   return helpers:
-000c4610: 3a63 6f6e 6361 7428 6f75 742d 3e67 6574  :concat(out->get
-000c4620: 5f70 726f 746f 636f 6c28 292c 2022 2f2f  _protocol(), "//
-000c4630: 222c 206f 7574 2d3e 6765 745f 686f 7374  ", out->get_host
-000c4640: 2829 293b 0a20 2020 2020 207d 0a20 2020  ());.      }.   
-000c4650: 207d 0a20 207d 0a0a 2020 2f2f 2052 6574   }.  }..  // Ret
-000c4660: 7572 6e20 6120 6e65 7720 6f70 6171 7565  urn a new opaque
-000c4670: 206f 7269 6769 6e2e 0a20 2072 6574 7572   origin..  retur
-000c4680: 6e20 226e 756c 6c22 3b0a 7d0a 0a5b 5b6e  n "null";.}..[[n
-000c4690: 6f64 6973 6361 7264 5d5d 2073 7464 3a3a  odiscard]] std::
-000c46a0: 7374 7269 6e67 5f76 6965 7720 7572 6c5f  string_view url_
-000c46b0: 6167 6772 6567 6174 6f72 3a3a 6765 745f  aggregator::get_
-000c46c0: 7573 6572 6e61 6d65 2829 2063 6f6e 7374  username() const
-000c46d0: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
-000c46e0: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
-000c46f0: 6761 746f 723a 3a67 6574 5f75 7365 726e  gator::get_usern
-000c4700: 616d 6522 293b 0a20 2069 6620 2868 6173  ame");.  if (has
-000c4710: 5f6e 6f6e 5f65 6d70 7479 5f75 7365 726e  _non_empty_usern
-000c4720: 616d 6528 2929 207b 0a20 2020 2072 6574  ame()) {.    ret
-000c4730: 7572 6e20 6865 6c70 6572 733a 3a73 7562  urn helpers::sub
-000c4740: 7374 7269 6e67 2862 7566 6665 722c 2063  string(buffer, c
-000c4750: 6f6d 706f 6e65 6e74 732e 7072 6f74 6f63  omponents.protoc
-000c4760: 6f6c 5f65 6e64 202b 2032 2c0a 2020 2020  ol_end + 2,.    
-000c4770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c4780: 2020 2020 2020 2020 2020 636f 6d70 6f6e            compon
-000c4790: 656e 7473 2e75 7365 726e 616d 655f 656e  ents.username_en
-000c47a0: 6429 3b0a 2020 7d0a 2020 7265 7475 726e  d);.  }.  return
-000c47b0: 2022 223b 0a7d 0a0a 5b5b 6e6f 6469 7363   "";.}..[[nodisc
-000c47c0: 6172 645d 5d20 7374 643a 3a73 7472 696e  ard]] std::strin
-000c47d0: 675f 7669 6577 2075 726c 5f61 6767 7265  g_view url_aggre
-000c47e0: 6761 746f 723a 3a67 6574 5f70 6173 7377  gator::get_passw
-000c47f0: 6f72 6428 2920 636f 6e73 7420 6e6f 6578  ord() const noex
-000c4800: 6365 7074 207b 0a20 2061 6461 5f6c 6f67  cept {.  ada_log
-000c4810: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
-000c4820: 3a3a 6765 745f 7061 7373 776f 7264 2229  ::get_password")
-000c4830: 3b0a 2020 6966 2028 6861 735f 6e6f 6e5f  ;.  if (has_non_
-000c4840: 656d 7074 795f 7061 7373 776f 7264 2829  empty_password()
-000c4850: 2920 7b0a 2020 2020 7265 7475 726e 2068  ) {.    return h
-000c4860: 656c 7065 7273 3a3a 7375 6273 7472 696e  elpers::substrin
-000c4870: 6728 6275 6666 6572 2c20 636f 6d70 6f6e  g(buffer, compon
-000c4880: 656e 7473 2e75 7365 726e 616d 655f 656e  ents.username_en
-000c4890: 6420 2b20 312c 0a20 2020 2020 2020 2020  d + 1,.         
-000c48a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c48b0: 2020 2020 2063 6f6d 706f 6e65 6e74 732e       components.
-000c48c0: 686f 7374 5f73 7461 7274 293b 0a20 207d  host_start);.  }
-000c48d0: 0a20 2072 6574 7572 6e20 2222 3b0a 7d0a  .  return "";.}.
-000c48e0: 0a5b 5b6e 6f64 6973 6361 7264 5d5d 2073  .[[nodiscard]] s
-000c48f0: 7464 3a3a 7374 7269 6e67 5f76 6965 7720  td::string_view 
-000c4900: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
-000c4910: 6765 745f 706f 7274 2829 2063 6f6e 7374  get_port() const
-000c4920: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
-000c4930: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
-000c4940: 6761 746f 723a 3a67 6574 5f70 6f72 7422  gator::get_port"
-000c4950: 293b 0a20 2069 6620 2863 6f6d 706f 6e65  );.  if (compone
-000c4960: 6e74 732e 706f 7274 203d 3d20 7572 6c5f  nts.port == url_
-000c4970: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
-000c4980: 7465 6429 207b 0a20 2020 2072 6574 7572  ted) {.    retur
-000c4990: 6e20 2222 3b0a 2020 7d0a 2020 7265 7475  n "";.  }.  retu
-000c49a0: 726e 2068 656c 7065 7273 3a3a 7375 6273  rn helpers::subs
-000c49b0: 7472 696e 6728 6275 6666 6572 2c20 636f  tring(buffer, co
-000c49c0: 6d70 6f6e 656e 7473 2e68 6f73 745f 656e  mponents.host_en
-000c49d0: 6420 2b20 312c 0a20 2020 2020 2020 2020  d + 1,.         
-000c49e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c49f0: 2020 2063 6f6d 706f 6e65 6e74 732e 7061     components.pa
-000c4a00: 7468 6e61 6d65 5f73 7461 7274 293b 0a7d  thname_start);.}
-000c4a10: 0a0a 5b5b 6e6f 6469 7363 6172 645d 5d20  ..[[nodiscard]] 
-000c4a20: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000c4a30: 2075 726c 5f61 6767 7265 6761 746f 723a   url_aggregator:
-000c4a40: 3a67 6574 5f68 6173 6828 2920 636f 6e73  :get_hash() cons
-000c4a50: 7420 6e6f 6578 6365 7074 207b 0a20 2061  t noexcept {.  a
-000c4a60: 6461 5f6c 6f67 2822 7572 6c5f 6167 6772  da_log("url_aggr
-000c4a70: 6567 6174 6f72 3a3a 6765 745f 6861 7368  egator::get_hash
-000c4a80: 2229 3b0a 2020 2f2f 2049 6620 7468 6973  ");.  // If this
-000c4a90: e280 9973 2055 524c e280 9973 2066 7261  ...s URL...s fra
-000c4aa0: 676d 656e 7420 6973 2065 6974 6865 7220  gment is either 
-000c4ab0: 6e75 6c6c 206f 7220 7468 6520 656d 7074  null or the empt
-000c4ac0: 7920 7374 7269 6e67 2c20 7468 656e 2072  y string, then r
-000c4ad0: 6574 7572 6e0a 2020 2f2f 2074 6865 2065  eturn.  // the e
-000c4ae0: 6d70 7479 2073 7472 696e 672e 2052 6574  mpty string. Ret
-000c4af0: 7572 6e20 552b 3030 3233 2028 2329 2c20  urn U+0023 (#), 
-000c4b00: 666f 6c6c 6f77 6564 2062 7920 7468 6973  followed by this
-000c4b10: e280 9973 2055 524c e280 9973 2066 7261  ...s URL...s fra
-000c4b20: 676d 656e 742e 0a20 2069 6620 2863 6f6d  gment..  if (com
-000c4b30: 706f 6e65 6e74 732e 6861 7368 5f73 7461  ponents.hash_sta
-000c4b40: 7274 203d 3d20 7572 6c5f 636f 6d70 6f6e  rt == url_compon
-000c4b50: 656e 7473 3a3a 6f6d 6974 7465 6429 207b  ents::omitted) {
-000c4b60: 0a20 2020 2072 6574 7572 6e20 2222 3b0a  .    return "";.
-000c4b70: 2020 7d0a 2020 6966 2028 6275 6666 6572    }.  if (buffer
-000c4b80: 2e73 697a 6528 2920 2d20 636f 6d70 6f6e  .size() - compon
-000c4b90: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
-000c4ba0: 3c3d 2031 2920 7b0a 2020 2020 7265 7475  <= 1) {.    retu
-000c4bb0: 726e 2022 223b 0a20 207d 0a20 2072 6574  rn "";.  }.  ret
-000c4bc0: 7572 6e20 6865 6c70 6572 733a 3a73 7562  urn helpers::sub
-000c4bd0: 7374 7269 6e67 2862 7566 6665 722c 2063  string(buffer, c
-000c4be0: 6f6d 706f 6e65 6e74 732e 6861 7368 5f73  omponents.hash_s
-000c4bf0: 7461 7274 293b 0a7d 0a0a 5b5b 6e6f 6469  tart);.}..[[nodi
-000c4c00: 7363 6172 645d 5d20 7374 643a 3a73 7472  scard]] std::str
-000c4c10: 696e 675f 7669 6577 2075 726c 5f61 6767  ing_view url_agg
-000c4c20: 7265 6761 746f 723a 3a67 6574 5f68 6f73  regator::get_hos
-000c4c30: 7428 2920 636f 6e73 7420 6e6f 6578 6365  t() const noexce
-000c4c40: 7074 207b 0a20 2061 6461 5f6c 6f67 2822  pt {.  ada_log("
-000c4c50: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
-000c4c60: 6765 745f 686f 7374 2229 3b0a 2020 2f2f  get_host");.  //
-000c4c70: 2054 6563 686e 6963 616c 6c79 2c20 7765   Technically, we
-000c4c80: 2073 686f 756c 6420 6368 6563 6b20 6966   should check if
-000c4c90: 2074 6865 7265 2069 7320 6120 686f 7374   there is a host
-000c4ca0: 6e61 6d65 2c20 6275 740a 2020 2f2f 2074  name, but.  // t
-000c4cb0: 6865 2063 6f64 6520 6265 6c6f 7720 776f  he code below wo
-000c4cc0: 726b 7320 6576 656e 2069 6620 7468 6572  rks even if ther
-000c4cd0: 6520 6973 6e27 742e 0a20 202f 2f20 6966  e isn't..  // if
-000c4ce0: 2821 6861 735f 686f 7374 6e61 6d65 2829  (!has_hostname()
-000c4cf0: 2920 7b20 7265 7475 726e 2022 223b 207d  ) { return ""; }
-000c4d00: 0a20 2073 697a 655f 7420 7374 6172 7420  .  size_t start 
-000c4d10: 3d20 636f 6d70 6f6e 656e 7473 2e68 6f73  = components.hos
-000c4d20: 745f 7374 6172 743b 0a20 2069 6620 2863  t_start;.  if (c
-000c4d30: 6f6d 706f 6e65 6e74 732e 686f 7374 5f65  omponents.host_e
-000c4d40: 6e64 203e 2063 6f6d 706f 6e65 6e74 732e  nd > components.
-000c4d50: 686f 7374 5f73 7461 7274 2026 260a 2020  host_start &&.  
-000c4d60: 2020 2020 6275 6666 6572 5b63 6f6d 706f      buffer[compo
-000c4d70: 6e65 6e74 732e 686f 7374 5f73 7461 7274  nents.host_start
-000c4d80: 5d20 3d3d 2027 4027 2920 7b0a 2020 2020  ] == '@') {.    
-000c4d90: 7374 6172 742b 2b3b 0a20 207d 0a20 202f  start++;.  }.  /
-000c4da0: 2f20 6966 2077 6520 6861 7665 2061 6e20  / if we have an 
-000c4db0: 656d 7074 7920 686f 7374 2c20 7468 656e  empty host, then
-000c4dc0: 2074 6865 2073 7061 6365 2062 6574 7765   the space betwe
-000c4dd0: 656e 2063 6f6d 706f 6e65 6e74 732e 686f  en components.ho
-000c4de0: 7374 5f65 6e64 2061 6e64 0a20 202f 2f20  st_end and.  // 
-000c4df0: 636f 6d70 6f6e 656e 7473 2e70 6174 686e  components.pathn
-000c4e00: 616d 655f 7374 6172 7420 6d61 7920 6265  ame_start may be
-000c4e10: 206f 6363 7570 6965 6420 6279 202f 2e0a   occupied by /..
-000c4e20: 2020 6966 2028 7374 6172 7420 3d3d 2063    if (start == c
-000c4e30: 6f6d 706f 6e65 6e74 732e 686f 7374 5f65  omponents.host_e
-000c4e40: 6e64 2920 7b0a 2020 2020 7265 7475 726e  nd) {.    return
-000c4e50: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000c4e60: 7728 293b 0a20 207d 0a20 2072 6574 7572  w();.  }.  retur
-000c4e70: 6e20 6865 6c70 6572 733a 3a73 7562 7374  n helpers::subst
-000c4e80: 7269 6e67 2862 7566 6665 722c 2073 7461  ring(buffer, sta
-000c4e90: 7274 2c20 636f 6d70 6f6e 656e 7473 2e70  rt, components.p
-000c4ea0: 6174 686e 616d 655f 7374 6172 7429 3b0a  athname_start);.
-000c4eb0: 7d0a 0a5b 5b6e 6f64 6973 6361 7264 5d5d  }..[[nodiscard]]
-000c4ec0: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000c4ed0: 7720 7572 6c5f 6167 6772 6567 6174 6f72  w url_aggregator
-000c4ee0: 3a3a 6765 745f 686f 7374 6e61 6d65 2829  ::get_hostname()
-000c4ef0: 2063 6f6e 7374 206e 6f65 7863 6570 7420   const noexcept 
-000c4f00: 7b0a 2020 6164 615f 6c6f 6728 2275 726c  {.  ada_log("url
-000c4f10: 5f61 6767 7265 6761 746f 723a 3a67 6574  _aggregator::get
-000c4f20: 5f68 6f73 746e 616d 6522 293b 0a20 202f  _hostname");.  /
-000c4f30: 2f20 5465 6368 6e69 6361 6c6c 792c 2077  / Technically, w
-000c4f40: 6520 7368 6f75 6c64 2063 6865 636b 2069  e should check i
-000c4f50: 6620 7468 6572 6520 6973 2061 2068 6f73  f there is a hos
-000c4f60: 746e 616d 652c 2062 7574 0a20 202f 2f20  tname, but.  // 
-000c4f70: 7468 6520 636f 6465 2062 656c 6f77 2077  the code below w
-000c4f80: 6f72 6b73 2065 7665 6e20 6966 2074 6865  orks even if the
-000c4f90: 7265 2069 736e 2774 2e0a 2020 2f2f 2069  re isn't..  // i
-000c4fa0: 6628 2168 6173 5f68 6f73 746e 616d 6528  f(!has_hostname(
-000c4fb0: 2929 207b 2072 6574 7572 6e20 2222 3b20  )) { return ""; 
-000c4fc0: 7d0a 2020 7369 7a65 5f74 2073 7461 7274  }.  size_t start
-000c4fd0: 203d 2063 6f6d 706f 6e65 6e74 732e 686f   = components.ho
-000c4fe0: 7374 5f73 7461 7274 3b0a 2020 2f2f 2053  st_start;.  // S
-000c4ff0: 6f20 686f 7374 5f73 7461 7274 2069 7320  o host_start is 
-000c5000: 6e6f 7420 7768 6572 6520 7468 6520 686f  not where the ho
-000c5010: 7374 2062 6567 696e 732e 0a20 2069 6620  st begins..  if 
-000c5020: 2863 6f6d 706f 6e65 6e74 732e 686f 7374  (components.host
-000c5030: 5f65 6e64 203e 2063 6f6d 706f 6e65 6e74  _end > component
-000c5040: 732e 686f 7374 5f73 7461 7274 2026 260a  s.host_start &&.
-000c5050: 2020 2020 2020 6275 6666 6572 5b63 6f6d        buffer[com
-000c5060: 706f 6e65 6e74 732e 686f 7374 5f73 7461  ponents.host_sta
-000c5070: 7274 5d20 3d3d 2027 4027 2920 7b0a 2020  rt] == '@') {.  
-000c5080: 2020 7374 6172 742b 2b3b 0a20 207d 0a20    start++;.  }. 
-000c5090: 2072 6574 7572 6e20 6865 6c70 6572 733a   return helpers:
-000c50a0: 3a73 7562 7374 7269 6e67 2862 7566 6665  :substring(buffe
-000c50b0: 722c 2073 7461 7274 2c20 636f 6d70 6f6e  r, start, compon
-000c50c0: 656e 7473 2e68 6f73 745f 656e 6429 3b0a  ents.host_end);.
-000c50d0: 7d0a 0a5b 5b6e 6f64 6973 6361 7264 5d5d  }..[[nodiscard]]
-000c50e0: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000c50f0: 7720 7572 6c5f 6167 6772 6567 6174 6f72  w url_aggregator
-000c5100: 3a3a 6765 745f 7061 7468 6e61 6d65 2829  ::get_pathname()
-000c5110: 2063 6f6e 7374 206e 6f65 7863 6570 7420   const noexcept 
-000c5120: 7b0a 2020 6164 615f 6c6f 6728 2275 726c  {.  ada_log("url
-000c5130: 5f61 6767 7265 6761 746f 723a 3a67 6574  _aggregator::get
-000c5140: 5f70 6174 686e 616d 6520 7061 7468 6e61  _pathname pathna
-000c5150: 6d65 5f73 7461 7274 203d 2022 2c0a 2020  me_start = ",.  
-000c5160: 2020 2020 2020 2020 636f 6d70 6f6e 656e          componen
-000c5170: 7473 2e70 6174 686e 616d 655f 7374 6172  ts.pathname_star
-000c5180: 742c 2022 2062 7566 6665 722e 7369 7a65  t, " buffer.size
-000c5190: 2829 203d 2022 2c20 6275 6666 6572 2e73  () = ", buffer.s
-000c51a0: 697a 6528 292c 0a20 2020 2020 2020 2020  ize(),.         
-000c51b0: 2022 2063 6f6d 706f 6e65 6e74 732e 7365   " components.se
-000c51c0: 6172 6368 5f73 7461 7274 203d 2022 2c20  arch_start = ", 
-000c51d0: 636f 6d70 6f6e 656e 7473 2e73 6561 7263  components.searc
-000c51e0: 685f 7374 6172 742c 0a20 2020 2020 2020  h_start,.       
-000c51f0: 2020 2022 2063 6f6d 706f 6e65 6e74 732e     " components.
-000c5200: 6861 7368 5f73 7461 7274 203d 2022 2c20  hash_start = ", 
-000c5210: 636f 6d70 6f6e 656e 7473 2e68 6173 685f  components.hash_
-000c5220: 7374 6172 7429 3b0a 2020 7569 6e74 3332  start);.  uint32
-000c5230: 5f74 2065 6e64 696e 675f 696e 6465 7820  _t ending_index 
-000c5240: 3d20 7569 6e74 3332 5f74 2862 7566 6665  = uint32_t(buffe
-000c5250: 722e 7369 7a65 2829 293b 0a20 2069 6620  r.size());.  if 
-000c5260: 2863 6f6d 706f 6e65 6e74 732e 7365 6172  (components.sear
-000c5270: 6368 5f73 7461 7274 2021 3d20 7572 6c5f  ch_start != url_
-000c5280: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
-000c5290: 7465 6429 207b 0a20 2020 2065 6e64 696e  ted) {.    endin
-000c52a0: 675f 696e 6465 7820 3d20 636f 6d70 6f6e  g_index = compon
-000c52b0: 656e 7473 2e73 6561 7263 685f 7374 6172  ents.search_star
-000c52c0: 743b 0a20 207d 2065 6c73 6520 6966 2028  t;.  } else if (
-000c52d0: 636f 6d70 6f6e 656e 7473 2e68 6173 685f  components.hash_
-000c52e0: 7374 6172 7420 213d 2075 726c 5f63 6f6d  start != url_com
-000c52f0: 706f 6e65 6e74 733a 3a6f 6d69 7474 6564  ponents::omitted
-000c5300: 2920 7b0a 2020 2020 656e 6469 6e67 5f69  ) {.    ending_i
-000c5310: 6e64 6578 203d 2063 6f6d 706f 6e65 6e74  ndex = component
-000c5320: 732e 6861 7368 5f73 7461 7274 3b0a 2020  s.hash_start;.  
-000c5330: 7d0a 2020 7265 7475 726e 2068 656c 7065  }.  return helpe
-000c5340: 7273 3a3a 7375 6273 7472 696e 6728 6275  rs::substring(bu
-000c5350: 6666 6572 2c20 636f 6d70 6f6e 656e 7473  ffer, components
-000c5360: 2e70 6174 686e 616d 655f 7374 6172 742c  .pathname_start,
-000c5370: 2065 6e64 696e 675f 696e 6465 7829 3b0a   ending_index);.
-000c5380: 7d0a 0a5b 5b6e 6f64 6973 6361 7264 5d5d  }..[[nodiscard]]
-000c5390: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000c53a0: 7720 7572 6c5f 6167 6772 6567 6174 6f72  w url_aggregator
-000c53b0: 3a3a 6765 745f 7365 6172 6368 2829 2063  ::get_search() c
-000c53c0: 6f6e 7374 206e 6f65 7863 6570 7420 7b0a  onst noexcept {.
-000c53d0: 2020 6164 615f 6c6f 6728 2275 726c 5f61    ada_log("url_a
-000c53e0: 6767 7265 6761 746f 723a 3a67 6574 5f73  ggregator::get_s
-000c53f0: 6561 7263 6822 293b 0a20 202f 2f20 4966  earch");.  // If
-000c5400: 2074 6869 73e2 8099 7320 5552 4ce2 8099   this...s URL...
-000c5410: 7320 7175 6572 7920 6973 2065 6974 6865  s query is eithe
-000c5420: 7220 6e75 6c6c 206f 7220 7468 6520 656d  r null or the em
-000c5430: 7074 7920 7374 7269 6e67 2c20 7468 656e  pty string, then
-000c5440: 2072 6574 7572 6e20 7468 650a 2020 2f2f   return the.  //
-000c5450: 2065 6d70 7479 2073 7472 696e 672e 2052   empty string. R
-000c5460: 6574 7572 6e20 552b 3030 3346 2028 3f29  eturn U+003F (?)
-000c5470: 2c20 666f 6c6c 6f77 6564 2062 7920 7468  , followed by th
-000c5480: 6973 e280 9973 2055 524c e280 9973 2071  is...s URL...s q
-000c5490: 7565 7279 2e0a 2020 6966 2028 636f 6d70  uery..  if (comp
-000c54a0: 6f6e 656e 7473 2e73 6561 7263 685f 7374  onents.search_st
-000c54b0: 6172 7420 3d3d 2075 726c 5f63 6f6d 706f  art == url_compo
-000c54c0: 6e65 6e74 733a 3a6f 6d69 7474 6564 2920  nents::omitted) 
-000c54d0: 7b0a 2020 2020 7265 7475 726e 2022 223b  {.    return "";
-000c54e0: 0a20 207d 0a20 2075 696e 7433 325f 7420  .  }.  uint32_t 
-000c54f0: 656e 6469 6e67 5f69 6e64 6578 203d 2075  ending_index = u
-000c5500: 696e 7433 325f 7428 6275 6666 6572 2e73  int32_t(buffer.s
-000c5510: 697a 6528 2929 3b0a 2020 6966 2028 636f  ize());.  if (co
-000c5520: 6d70 6f6e 656e 7473 2e68 6173 685f 7374  mponents.hash_st
-000c5530: 6172 7420 213d 2075 726c 5f63 6f6d 706f  art != url_compo
-000c5540: 6e65 6e74 733a 3a6f 6d69 7474 6564 2920  nents::omitted) 
-000c5550: 7b0a 2020 2020 656e 6469 6e67 5f69 6e64  {.    ending_ind
-000c5560: 6578 203d 2063 6f6d 706f 6e65 6e74 732e  ex = components.
-000c5570: 6861 7368 5f73 7461 7274 3b0a 2020 7d0a  hash_start;.  }.
-000c5580: 2020 6966 2028 656e 6469 6e67 5f69 6e64    if (ending_ind
-000c5590: 6578 202d 2063 6f6d 706f 6e65 6e74 732e  ex - components.
-000c55a0: 7365 6172 6368 5f73 7461 7274 203c 3d20  search_start <= 
-000c55b0: 3129 207b 0a20 2020 2072 6574 7572 6e20  1) {.    return 
-000c55c0: 2222 3b0a 2020 7d0a 2020 7265 7475 726e  "";.  }.  return
-000c55d0: 2068 656c 7065 7273 3a3a 7375 6273 7472   helpers::substr
-000c55e0: 696e 6728 6275 6666 6572 2c20 636f 6d70  ing(buffer, comp
-000c55f0: 6f6e 656e 7473 2e73 6561 7263 685f 7374  onents.search_st
-000c5600: 6172 742c 2065 6e64 696e 675f 696e 6465  art, ending_inde
-000c5610: 7829 3b0a 7d0a 0a5b 5b6e 6f64 6973 6361  x);.}..[[nodisca
-000c5620: 7264 5d5d 2073 7464 3a3a 7374 7269 6e67  rd]] std::string
-000c5630: 5f76 6965 7720 7572 6c5f 6167 6772 6567  _view url_aggreg
-000c5640: 6174 6f72 3a3a 6765 745f 7072 6f74 6f63  ator::get_protoc
-000c5650: 6f6c 2829 2063 6f6e 7374 206e 6f65 7863  ol() const noexc
-000c5660: 6570 7420 7b0a 2020 6164 615f 6c6f 6728  ept {.  ada_log(
-000c5670: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
-000c5680: 3a67 6574 5f70 726f 746f 636f 6c22 293b  :get_protocol");
-000c5690: 0a20 2072 6574 7572 6e20 6865 6c70 6572  .  return helper
-000c56a0: 733a 3a73 7562 7374 7269 6e67 2862 7566  s::substring(buf
-000c56b0: 6665 722c 2030 2c20 636f 6d70 6f6e 656e  fer, 0, componen
-000c56c0: 7473 2e70 726f 746f 636f 6c5f 656e 6429  ts.protocol_end)
-000c56d0: 3b0a 7d0a 0a73 7464 3a3a 7374 7269 6e67  ;.}..std::string
-000c56e0: 2061 6461 3a3a 7572 6c5f 6167 6772 6567   ada::url_aggreg
-000c56f0: 6174 6f72 3a3a 746f 5f73 7472 696e 6728  ator::to_string(
-000c5700: 2920 636f 6e73 7420 7b0a 2020 6164 615f  ) const {.  ada_
-000c5710: 6c6f 6728 2275 726c 5f61 6767 7265 6761  log("url_aggrega
-000c5720: 746f 723a 3a74 6f5f 7374 7269 6e67 2062  tor::to_string b
-000c5730: 7566 6665 723a 222c 2062 7566 6665 722c  uffer:", buffer,
-000c5740: 2022 5b22 2c20 6275 6666 6572 2e73 697a   "[", buffer.siz
-000c5750: 6528 292c 0a20 2020 2020 2020 2020 2022  e(),.          "
-000c5760: 2062 7974 6573 5d22 293b 0a20 2069 6620   bytes]");.  if 
-000c5770: 2821 6973 5f76 616c 6964 2920 7b0a 2020  (!is_valid) {.  
-000c5780: 2020 7265 7475 726e 2022 6e75 6c6c 223b    return "null";
-000c5790: 0a20 207d 0a0a 2020 7374 643a 3a73 7472  .  }..  std::str
-000c57a0: 696e 6720 616e 7377 6572 3b0a 2020 6175  ing answer;.  au
-000c57b0: 746f 2062 6163 6b20 3d20 7374 643a 3a62  to back = std::b
-000c57c0: 6163 6b5f 696e 7365 7274 5f69 7465 7261  ack_insert_itera
-000c57d0: 746f 7228 616e 7377 6572 293b 0a20 2061  tor(answer);.  a
-000c57e0: 6e73 7765 722e 6170 7065 6e64 2822 7b5c  nswer.append("{\
-000c57f0: 6e22 293b 0a0a 2020 616e 7377 6572 2e61  n");..  answer.a
-000c5800: 7070 656e 6428 225c 745c 2262 7566 6665  ppend("\t\"buffe
-000c5810: 725c 223a 5c22 2229 3b0a 2020 6865 6c70  r\":\"");.  help
-000c5820: 6572 733a 3a65 6e63 6f64 655f 6a73 6f6e  ers::encode_json
-000c5830: 2862 7566 6665 722c 2062 6163 6b29 3b0a  (buffer, back);.
-000c5840: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
-000c5850: 225c 222c 5c6e 2229 3b0a 0a20 2061 6e73  "\",\n");..  ans
-000c5860: 7765 722e 6170 7065 6e64 2822 5c74 5c22  wer.append("\t\"
-000c5870: 7072 6f74 6f63 6f6c 5c22 3a5c 2222 293b  protocol\":\"");
-000c5880: 0a20 2068 656c 7065 7273 3a3a 656e 636f  .  helpers::enco
-000c5890: 6465 5f6a 736f 6e28 6765 745f 7072 6f74  de_json(get_prot
-000c58a0: 6f63 6f6c 2829 2c20 6261 636b 293b 0a20  ocol(), back);. 
-000c58b0: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000c58c0: 5c22 2c5c 6e22 293b 0a0a 2020 6966 2028  \",\n");..  if (
-000c58d0: 6861 735f 6372 6564 656e 7469 616c 7328  has_credentials(
-000c58e0: 2929 207b 0a20 2020 2061 6e73 7765 722e  )) {.    answer.
-000c58f0: 6170 7065 6e64 2822 5c74 5c22 7573 6572  append("\t\"user
-000c5900: 6e61 6d65 5c22 3a5c 2222 293b 0a20 2020  name\":\"");.   
-000c5910: 2068 656c 7065 7273 3a3a 656e 636f 6465   helpers::encode
-000c5920: 5f6a 736f 6e28 6765 745f 7573 6572 6e61  _json(get_userna
-000c5930: 6d65 2829 2c20 6261 636b 293b 0a20 2020  me(), back);.   
-000c5940: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000c5950: 5c22 2c5c 6e22 293b 0a20 2020 2061 6e73  \",\n");.    ans
-000c5960: 7765 722e 6170 7065 6e64 2822 5c74 5c22  wer.append("\t\"
-000c5970: 7061 7373 776f 7264 5c22 3a5c 2222 293b  password\":\"");
-000c5980: 0a20 2020 2068 656c 7065 7273 3a3a 656e  .    helpers::en
-000c5990: 636f 6465 5f6a 736f 6e28 6765 745f 7061  code_json(get_pa
-000c59a0: 7373 776f 7264 2829 2c20 6261 636b 293b  ssword(), back);
-000c59b0: 0a20 2020 2061 6e73 7765 722e 6170 7065  .    answer.appe
-000c59c0: 6e64 2822 5c22 2c5c 6e22 293b 0a20 207d  nd("\",\n");.  }
-000c59d0: 0a0a 2020 616e 7377 6572 2e61 7070 656e  ..  answer.appen
-000c59e0: 6428 225c 745c 2268 6f73 745c 223a 5c22  d("\t\"host\":\"
-000c59f0: 2229 3b0a 2020 6865 6c70 6572 733a 3a65  ");.  helpers::e
-000c5a00: 6e63 6f64 655f 6a73 6f6e 2867 6574 5f68  ncode_json(get_h
-000c5a10: 6f73 7428 292c 2062 6163 6b29 3b0a 2020  ost(), back);.  
-000c5a20: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
-000c5a30: 222c 5c6e 2229 3b0a 0a20 2061 6e73 7765  ",\n");..  answe
-000c5a40: 722e 6170 7065 6e64 2822 5c74 5c22 7061  r.append("\t\"pa
-000c5a50: 7468 5c22 3a5c 2222 293b 0a20 2068 656c  th\":\"");.  hel
-000c5a60: 7065 7273 3a3a 656e 636f 6465 5f6a 736f  pers::encode_jso
-000c5a70: 6e28 6765 745f 7061 7468 6e61 6d65 2829  n(get_pathname()
-000c5a80: 2c20 6261 636b 293b 0a20 2061 6e73 7765  , back);.  answe
-000c5a90: 722e 6170 7065 6e64 2822 5c22 2c5c 6e22  r.append("\",\n"
-000c5aa0: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
-000c5ab0: 6e64 2822 5c74 5c22 6f70 6171 7565 2070  nd("\t\"opaque p
-000c5ac0: 6174 685c 223a 2229 3b0a 2020 616e 7377  ath\":");.  answ
-000c5ad0: 6572 2e61 7070 656e 6428 2868 6173 5f6f  er.append((has_o
-000c5ae0: 7061 7175 655f 7061 7468 203f 2022 7472  paque_path ? "tr
-000c5af0: 7565 2220 3a20 2266 616c 7365 2229 293b  ue" : "false"));
-000c5b00: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
-000c5b10: 2822 2c5c 6e22 293b 0a0a 2020 6966 2028  (",\n");..  if (
-000c5b20: 636f 6d70 6f6e 656e 7473 2e73 6561 7263  components.searc
-000c5b30: 685f 7374 6172 7420 213d 2075 726c 5f63  h_start != url_c
-000c5b40: 6f6d 706f 6e65 6e74 733a 3a6f 6d69 7474  omponents::omitt
-000c5b50: 6564 2920 7b0a 2020 2020 616e 7377 6572  ed) {.    answer
-000c5b60: 2e61 7070 656e 6428 225c 745c 2271 7565  .append("\t\"que
-000c5b70: 7279 5c22 3a5c 2222 293b 0a20 2020 2068  ry\":\"");.    h
-000c5b80: 656c 7065 7273 3a3a 656e 636f 6465 5f6a  elpers::encode_j
-000c5b90: 736f 6e28 6765 745f 7365 6172 6368 2829  son(get_search()
-000c5ba0: 2c20 6261 636b 293b 0a20 2020 2061 6e73  , back);.    ans
-000c5bb0: 7765 722e 6170 7065 6e64 2822 5c22 2c5c  wer.append("\",\
-000c5bc0: 6e22 293b 0a20 207d 0a20 2069 6620 2863  n");.  }.  if (c
-000c5bd0: 6f6d 706f 6e65 6e74 732e 6861 7368 5f73  omponents.hash_s
-000c5be0: 7461 7274 2021 3d20 7572 6c5f 636f 6d70  tart != url_comp
-000c5bf0: 6f6e 656e 7473 3a3a 6f6d 6974 7465 6429  onents::omitted)
-000c5c00: 207b 0a20 2020 2061 6e73 7765 722e 6170   {.    answer.ap
-000c5c10: 7065 6e64 2822 5c74 5c22 6672 6167 6d65  pend("\t\"fragme
-000c5c20: 6e74 5c22 3a5c 2222 293b 0a20 2020 2068  nt\":\"");.    h
-000c5c30: 656c 7065 7273 3a3a 656e 636f 6465 5f6a  elpers::encode_j
-000c5c40: 736f 6e28 6765 745f 6861 7368 2829 2c20  son(get_hash(), 
-000c5c50: 6261 636b 293b 0a20 2020 2061 6e73 7765  back);.    answe
-000c5c60: 722e 6170 7065 6e64 2822 5c22 2c5c 6e22  r.append("\",\n"
-000c5c70: 293b 0a20 207d 0a0a 2020 6175 746f 2063  );.  }..  auto c
-000c5c80: 6f6e 7665 7274 5f6f 6666 7365 745f 746f  onvert_offset_to
-000c5c90: 5f73 7472 696e 6720 3d20 5b5d 2875 696e  _string = [](uin
-000c5ca0: 7433 325f 7420 6f66 6673 6574 2920 2d3e  t32_t offset) ->
-000c5cb0: 2073 7464 3a3a 7374 7269 6e67 207b 0a20   std::string {. 
-000c5cc0: 2020 2069 6620 286f 6666 7365 7420 3d3d     if (offset ==
-000c5cd0: 2075 726c 5f63 6f6d 706f 6e65 6e74 733a   url_components:
-000c5ce0: 3a6f 6d69 7474 6564 2920 7b0a 2020 2020  :omitted) {.    
-000c5cf0: 2020 7265 7475 726e 2022 6e75 6c6c 223b    return "null";
-000c5d00: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
-000c5d10: 2020 2020 7265 7475 726e 2073 7464 3a3a      return std::
-000c5d20: 746f 5f73 7472 696e 6728 6f66 6673 6574  to_string(offset
-000c5d30: 293b 0a20 2020 207d 0a20 207d 3b0a 0a20  );.    }.  };.. 
-000c5d40: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000c5d50: 5c74 5c22 7072 6f74 6f63 6f6c 5f65 6e64  \t\"protocol_end
-000c5d60: 5c22 3a22 293b 0a20 2061 6e73 7765 722e  \":");.  answer.
-000c5d70: 6170 7065 6e64 2863 6f6e 7665 7274 5f6f  append(convert_o
-000c5d80: 6666 7365 745f 746f 5f73 7472 696e 6728  ffset_to_string(
-000c5d90: 636f 6d70 6f6e 656e 7473 2e70 726f 746f  components.proto
-000c5da0: 636f 6c5f 656e 6429 293b 0a20 2061 6e73  col_end));.  ans
-000c5db0: 7765 722e 6170 7065 6e64 2822 2c5c 6e22  wer.append(",\n"
-000c5dc0: 293b 0a0a 2020 616e 7377 6572 2e61 7070  );..  answer.app
-000c5dd0: 656e 6428 225c 745c 2275 7365 726e 616d  end("\t\"usernam
-000c5de0: 655f 656e 645c 223a 2229 3b0a 2020 616e  e_end\":");.  an
-000c5df0: 7377 6572 2e61 7070 656e 6428 636f 6e76  swer.append(conv
-000c5e00: 6572 745f 6f66 6673 6574 5f74 6f5f 7374  ert_offset_to_st
-000c5e10: 7269 6e67 2863 6f6d 706f 6e65 6e74 732e  ring(components.
-000c5e20: 7573 6572 6e61 6d65 5f65 6e64 2929 3b0a  username_end));.
-000c5e30: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
-000c5e40: 222c 5c6e 2229 3b0a 0a20 2061 6e73 7765  ",\n");..  answe
-000c5e50: 722e 6170 7065 6e64 2822 5c74 5c22 686f  r.append("\t\"ho
-000c5e60: 7374 5f73 7461 7274 5c22 3a22 293b 0a20  st_start\":");. 
-000c5e70: 2061 6e73 7765 722e 6170 7065 6e64 2863   answer.append(c
-000c5e80: 6f6e 7665 7274 5f6f 6666 7365 745f 746f  onvert_offset_to
-000c5e90: 5f73 7472 696e 6728 636f 6d70 6f6e 656e  _string(componen
-000c5ea0: 7473 2e68 6f73 745f 7374 6172 7429 293b  ts.host_start));
-000c5eb0: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
-000c5ec0: 2822 2c5c 6e22 293b 0a0a 2020 616e 7377  (",\n");..  answ
-000c5ed0: 6572 2e61 7070 656e 6428 225c 745c 2268  er.append("\t\"h
-000c5ee0: 6f73 745f 656e 645c 223a 2229 3b0a 2020  ost_end\":");.  
-000c5ef0: 616e 7377 6572 2e61 7070 656e 6428 636f  answer.append(co
-000c5f00: 6e76 6572 745f 6f66 6673 6574 5f74 6f5f  nvert_offset_to_
-000c5f10: 7374 7269 6e67 2863 6f6d 706f 6e65 6e74  string(component
-000c5f20: 732e 686f 7374 5f65 6e64 2929 3b0a 2020  s.host_end));.  
-000c5f30: 616e 7377 6572 2e61 7070 656e 6428 222c  answer.append(",
-000c5f40: 5c6e 2229 3b0a 0a20 2061 6e73 7765 722e  \n");..  answer.
-000c5f50: 6170 7065 6e64 2822 5c74 5c22 706f 7274  append("\t\"port
-000c5f60: 5c22 3a22 293b 0a20 2061 6e73 7765 722e  \":");.  answer.
-000c5f70: 6170 7065 6e64 2863 6f6e 7665 7274 5f6f  append(convert_o
-000c5f80: 6666 7365 745f 746f 5f73 7472 696e 6728  ffset_to_string(
-000c5f90: 636f 6d70 6f6e 656e 7473 2e70 6f72 7429  components.port)
-000c5fa0: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
-000c5fb0: 6e64 2822 2c5c 6e22 293b 0a0a 2020 616e  nd(",\n");..  an
-000c5fc0: 7377 6572 2e61 7070 656e 6428 225c 745c  swer.append("\t\
-000c5fd0: 2270 6174 686e 616d 655f 7374 6172 745c  "pathname_start\
-000c5fe0: 223a 2229 3b0a 2020 616e 7377 6572 2e61  ":");.  answer.a
-000c5ff0: 7070 656e 6428 636f 6e76 6572 745f 6f66  ppend(convert_of
-000c6000: 6673 6574 5f74 6f5f 7374 7269 6e67 2863  fset_to_string(c
-000c6010: 6f6d 706f 6e65 6e74 732e 7061 7468 6e61  omponents.pathna
-000c6020: 6d65 5f73 7461 7274 2929 3b0a 2020 616e  me_start));.  an
-000c6030: 7377 6572 2e61 7070 656e 6428 222c 5c6e  swer.append(",\n
-000c6040: 2229 3b0a 0a20 2061 6e73 7765 722e 6170  ");..  answer.ap
-000c6050: 7065 6e64 2822 5c74 5c22 7365 6172 6368  pend("\t\"search
-000c6060: 5f73 7461 7274 5c22 3a22 293b 0a20 2061  _start\":");.  a
-000c6070: 6e73 7765 722e 6170 7065 6e64 2863 6f6e  nswer.append(con
-000c6080: 7665 7274 5f6f 6666 7365 745f 746f 5f73  vert_offset_to_s
-000c6090: 7472 696e 6728 636f 6d70 6f6e 656e 7473  tring(components
-000c60a0: 2e73 6561 7263 685f 7374 6172 7429 293b  .search_start));
-000c60b0: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
-000c60c0: 2822 2c5c 6e22 293b 0a0a 2020 616e 7377  (",\n");..  answ
-000c60d0: 6572 2e61 7070 656e 6428 225c 745c 2268  er.append("\t\"h
-000c60e0: 6173 685f 7374 6172 745c 223a 2229 3b0a  ash_start\":");.
-000c60f0: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
-000c6100: 636f 6e76 6572 745f 6f66 6673 6574 5f74  convert_offset_t
-000c6110: 6f5f 7374 7269 6e67 2863 6f6d 706f 6e65  o_string(compone
-000c6120: 6e74 732e 6861 7368 5f73 7461 7274 2929  nts.hash_start))
-000c6130: 3b0a 2020 616e 7377 6572 2e61 7070 656e  ;.  answer.appen
-000c6140: 6428 225c 6e7d 2229 3b0a 0a20 2072 6574  d("\n}");..  ret
-000c6150: 7572 6e20 616e 7377 6572 3b0a 7d0a 0a5b  urn answer;.}..[
-000c6160: 5b6e 6f64 6973 6361 7264 5d5d 2062 6f6f  [nodiscard]] boo
-000c6170: 6c20 7572 6c5f 6167 6772 6567 6174 6f72  l url_aggregator
-000c6180: 3a3a 6861 735f 7661 6c69 645f 646f 6d61  ::has_valid_doma
-000c6190: 696e 2829 2063 6f6e 7374 206e 6f65 7863  in() const noexc
-000c61a0: 6570 7420 7b0a 2020 6966 2028 636f 6d70  ept {.  if (comp
-000c61b0: 6f6e 656e 7473 2e68 6f73 745f 7374 6172  onents.host_star
-000c61c0: 7420 3d3d 2063 6f6d 706f 6e65 6e74 732e  t == components.
-000c61d0: 686f 7374 5f65 6e64 2920 7b0a 2020 2020  host_end) {.    
-000c61e0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
-000c61f0: 7d0a 2020 7265 7475 726e 2063 6865 636b  }.  return check
-000c6200: 6572 733a 3a76 6572 6966 795f 646e 735f  ers::verify_dns_
-000c6210: 6c65 6e67 7468 2867 6574 5f68 6f73 746e  length(get_hostn
-000c6220: 616d 6528 2929 3b0a 7d0a 0a62 6f6f 6c20  ame());.}..bool 
-000c6230: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
-000c6240: 7061 7273 655f 6970 7634 2873 7464 3a3a  parse_ipv4(std::
-000c6250: 7374 7269 6e67 5f76 6965 7720 696e 7075  string_view inpu
-000c6260: 7429 207b 0a20 2061 6461 5f6c 6f67 2822  t) {.  ada_log("
-000c6270: 7061 7273 655f 6970 7634 2022 2c20 696e  parse_ipv4 ", in
-000c6280: 7075 742c 2022 5b22 2c20 696e 7075 742e  put, "[", input.
-000c6290: 7369 7a65 2829 2c0a 2020 2020 2020 2020  size(),.        
-000c62a0: 2020 2220 6279 7465 735d 2c20 6f76 6572    " bytes], over
-000c62b0: 6c61 7073 2077 6974 6820 6275 6666 6572  laps with buffer
-000c62c0: 3a20 222c 0a20 2020 2020 2020 2020 2068  : ",.          h
-000c62d0: 656c 7065 7273 3a3a 6f76 6572 6c61 7073  elpers::overlaps
-000c62e0: 2869 6e70 7574 2c20 6275 6666 6572 2920  (input, buffer) 
-000c62f0: 3f20 2279 6573 2220 3a20 226e 6f22 293b  ? "yes" : "no");
-000c6300: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
-000c6310: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
-000c6320: 2020 636f 6e73 7420 626f 6f6c 2074 7261    const bool tra
-000c6330: 696c 696e 675f 646f 7420 3d20 2869 6e70  iling_dot = (inp
-000c6340: 7574 2e62 6163 6b28 2920 3d3d 2027 2e27  ut.back() == '.'
-000c6350: 293b 0a20 2069 6620 2874 7261 696c 696e  );.  if (trailin
-000c6360: 675f 646f 7429 207b 0a20 2020 2069 6e70  g_dot) {.    inp
-000c6370: 7574 2e72 656d 6f76 655f 7375 6666 6978  ut.remove_suffix
-000c6380: 2831 293b 0a20 207d 0a20 2073 697a 655f  (1);.  }.  size_
-000c6390: 7420 6469 6769 745f 636f 756e 747b 307d  t digit_count{0}
-000c63a0: 3b0a 2020 696e 7420 7075 7265 5f64 6563  ;.  int pure_dec
-000c63b0: 696d 616c 5f63 6f75 6e74 203d 2030 3b20  imal_count = 0; 
-000c63c0: 202f 2f20 656e 7472 6965 7320 7468 6174   // entries that
-000c63d0: 2061 7265 2064 6563 696d 616c 0a20 2075   are decimal.  u
-000c63e0: 696e 7436 345f 7420 6970 7634 7b30 7d3b  int64_t ipv4{0};
-000c63f0: 0a20 202f 2f20 7765 2063 6f75 6c64 2075  .  // we could u
-000c6400: 6e72 6f6c 6c20 666f 7220 6265 7474 6572  nroll for better
-000c6410: 2070 6572 666f 726d 616e 6365 3f0a 2020   performance?.  
-000c6420: 666f 7220 283b 2028 6469 6769 745f 636f  for (; (digit_co
-000c6430: 756e 7420 3c20 3429 2026 2620 2128 696e  unt < 4) && !(in
-000c6440: 7075 742e 656d 7074 7928 2929 3b20 6469  put.empty()); di
-000c6450: 6769 745f 636f 756e 742b 2b29 207b 0a20  git_count++) {. 
-000c6460: 2020 2075 696e 7433 325f 740a 2020 2020     uint32_t.    
-000c6470: 2020 2020 7365 676d 656e 745f 7265 7375      segment_resu
-000c6480: 6c74 7b7d 3b20 202f 2f20 4966 2061 6e79  lt{};  // If any
-000c6490: 206e 756d 6265 7220 6578 6365 6564 7320   number exceeds 
-000c64a0: 3332 2062 6974 732c 2077 6520 6861 7665  32 bits, we have
-000c64b0: 2061 6e20 6572 726f 722e 0a20 2020 2062   an error..    b
-000c64c0: 6f6f 6c20 6973 5f68 6578 203d 2063 6865  ool is_hex = che
-000c64d0: 636b 6572 733a 3a68 6173 5f68 6578 5f70  ckers::has_hex_p
-000c64e0: 7265 6669 7828 696e 7075 7429 3b0a 2020  refix(input);.  
-000c64f0: 2020 6966 2028 6973 5f68 6578 2026 2620    if (is_hex && 
-000c6500: 2828 696e 7075 742e 6c65 6e67 7468 2829  ((input.length()
-000c6510: 203d 3d20 3229 207c 7c0a 2020 2020 2020   == 2) ||.      
-000c6520: 2020 2020 2020 2020 2020 2020 2028 2869               ((i
-000c6530: 6e70 7574 2e6c 656e 6774 6828 2920 3e20  nput.length() > 
-000c6540: 3229 2026 2620 2869 6e70 7574 5b32 5d20  2) && (input[2] 
-000c6550: 3d3d 2027 2e27 2929 2929 207b 0a20 2020  == '.')))) {.   
-000c6560: 2020 202f 2f20 7370 6563 6961 6c20 6361     // special ca
-000c6570: 7365 0a20 2020 2020 2073 6567 6d65 6e74  se.      segment
-000c6580: 5f72 6573 756c 7420 3d20 303b 0a20 2020  _result = 0;.   
-000c6590: 2020 2069 6e70 7574 2e72 656d 6f76 655f     input.remove_
-000c65a0: 7072 6566 6978 2832 293b 0a20 2020 207d  prefix(2);.    }
-000c65b0: 2065 6c73 6520 7b0a 2020 2020 2020 7374   else {.      st
-000c65c0: 643a 3a66 726f 6d5f 6368 6172 735f 7265  d::from_chars_re
-000c65d0: 7375 6c74 2072 3b0a 2020 2020 2020 6966  sult r;.      if
-000c65e0: 2028 6973 5f68 6578 2920 7b0a 2020 2020   (is_hex) {.    
-000c65f0: 2020 2020 7220 3d20 7374 643a 3a66 726f      r = std::fro
-000c6600: 6d5f 6368 6172 7328 696e 7075 742e 6461  m_chars(input.da
-000c6610: 7461 2829 202b 2032 2c20 696e 7075 742e  ta() + 2, input.
-000c6620: 6461 7461 2829 202b 2069 6e70 7574 2e73  data() + input.s
-000c6630: 697a 6528 292c 0a20 2020 2020 2020 2020  ize(),.         
-000c6640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c6650: 2020 2073 6567 6d65 6e74 5f72 6573 756c     segment_resul
-000c6660: 742c 2031 3629 3b0a 2020 2020 2020 7d20  t, 16);.      } 
-000c6670: 656c 7365 2069 6620 2828 696e 7075 742e  else if ((input.
-000c6680: 6c65 6e67 7468 2829 203e 3d20 3229 2026  length() >= 2) &
-000c6690: 2620 696e 7075 745b 305d 203d 3d20 2730  & input[0] == '0
-000c66a0: 2720 2626 0a20 2020 2020 2020 2020 2020  ' &&.           
-000c66b0: 2020 2020 2020 6368 6563 6b65 7273 3a3a        checkers::
-000c66c0: 6973 5f64 6967 6974 2869 6e70 7574 5b31  is_digit(input[1
-000c66d0: 5d29 2920 7b0a 2020 2020 2020 2020 7220  ])) {.        r 
-000c66e0: 3d20 7374 643a 3a66 726f 6d5f 6368 6172  = std::from_char
-000c66f0: 7328 696e 7075 742e 6461 7461 2829 202b  s(input.data() +
-000c6700: 2031 2c20 696e 7075 742e 6461 7461 2829   1, input.data()
-000c6710: 202b 2069 6e70 7574 2e73 697a 6528 292c   + input.size(),
-000c6720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000c6730: 2020 2020 2020 2020 2020 2020 2073 6567               seg
-000c6740: 6d65 6e74 5f72 6573 756c 742c 2038 293b  ment_result, 8);
-000c6750: 0a20 2020 2020 207d 2065 6c73 6520 7b0a  .      } else {.
-000c6760: 2020 2020 2020 2020 7075 7265 5f64 6563          pure_dec
-000c6770: 696d 616c 5f63 6f75 6e74 2b2b 3b0a 2020  imal_count++;.  
-000c6780: 2020 2020 2020 7220 3d20 7374 643a 3a66        r = std::f
-000c6790: 726f 6d5f 6368 6172 7328 696e 7075 742e  rom_chars(input.
-000c67a0: 6461 7461 2829 2c20 696e 7075 742e 6461  data(), input.da
-000c67b0: 7461 2829 202b 2069 6e70 7574 2e73 697a  ta() + input.siz
-000c67c0: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
-000c67d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000c67e0: 2073 6567 6d65 6e74 5f72 6573 756c 742c   segment_result,
-000c67f0: 2031 3029 3b0a 2020 2020 2020 7d0a 2020   10);.      }.  
-000c6800: 2020 2020 6966 2028 722e 6563 2021 3d20      if (r.ec != 
-000c6810: 7374 643a 3a65 7272 6328 2929 207b 0a20  std::errc()) {. 
-000c6820: 2020 2020 2020 2072 6574 7572 6e20 6973         return is
-000c6830: 5f76 616c 6964 203d 2066 616c 7365 3b0a  _valid = false;.
-000c6840: 2020 2020 2020 7d0a 2020 2020 2020 696e        }.      in
-000c6850: 7075 742e 7265 6d6f 7665 5f70 7265 6669  put.remove_prefi
-000c6860: 7828 722e 7074 7220 2d20 696e 7075 742e  x(r.ptr - input.
-000c6870: 6461 7461 2829 293b 0a20 2020 207d 0a20  data());.    }. 
-000c6880: 2020 2069 6620 2869 6e70 7574 2e65 6d70     if (input.emp
-000c6890: 7479 2829 2920 7b0a 2020 2020 2020 2f2f  ty()) {.      //
-000c68a0: 2057 6520 6861 7665 2074 6865 206c 6173   We have the las
-000c68b0: 7420 7661 6c75 652e 0a20 2020 2020 202f  t value..      /
-000c68c0: 2f20 4174 2074 6869 7320 7374 6167 652c  / At this stage,
-000c68d0: 2069 7076 3420 636f 6e74 6169 6e73 2064   ipv4 contains d
-000c68e0: 6967 6974 5f63 6f75 6e74 2a38 2062 6974  igit_count*8 bit
-000c68f0: 732e 0a20 2020 2020 202f 2f20 536f 2077  s..      // So w
-000c6900: 6520 6861 7665 2033 322d 6469 6769 745f  e have 32-digit_
-000c6910: 636f 756e 742a 3820 6269 7473 206c 6566  count*8 bits lef
-000c6920: 742e 0a20 2020 2020 2069 6620 2873 6567  t..      if (seg
-000c6930: 6d65 6e74 5f72 6573 756c 7420 3e20 2875  ment_result > (u
-000c6940: 696e 7436 345f 7428 3129 203c 3c20 2833  int64_t(1) << (3
-000c6950: 3220 2d20 6469 6769 745f 636f 756e 7420  2 - digit_count 
-000c6960: 2a20 3829 2929 207b 0a20 2020 2020 2020  * 8))) {.       
-000c6970: 2072 6574 7572 6e20 6973 5f76 616c 6964   return is_valid
-000c6980: 203d 2066 616c 7365 3b0a 2020 2020 2020   = false;.      
-000c6990: 7d0a 2020 2020 2020 6970 7634 203c 3c3d  }.      ipv4 <<=
-000c69a0: 2028 3332 202d 2064 6967 6974 5f63 6f75   (32 - digit_cou
-000c69b0: 6e74 202a 2038 293b 0a20 2020 2020 2069  nt * 8);.      i
-000c69c0: 7076 3420 7c3d 2073 6567 6d65 6e74 5f72  pv4 |= segment_r
-000c69d0: 6573 756c 743b 0a20 2020 2020 2067 6f74  esult;.      got
-000c69e0: 6f20 6669 6e61 6c3b 0a20 2020 207d 2065  o final;.    } e
-000c69f0: 6c73 6520 7b0a 2020 2020 2020 2f2f 2054  lse {.      // T
-000c6a00: 6865 7265 2069 7320 6d6f 7265 2c20 736f  here is more, so
-000c6a10: 2074 6861 7420 7468 6520 7661 6c75 6520   that the value 
-000c6a20: 6d75 7374 206e 6f20 6265 206c 6172 6765  must no be large
-000c6a30: 7220 7468 616e 2032 3535 0a20 2020 2020  r than 255.     
-000c6a40: 202f 2f20 616e 6420 7765 206d 7573 7420   // and we must 
-000c6a50: 6861 7665 2061 2027 2e27 2e0a 2020 2020  have a '.'..    
-000c6a60: 2020 6966 2028 2873 6567 6d65 6e74 5f72    if ((segment_r
-000c6a70: 6573 756c 7420 3e20 3235 3529 207c 7c20  esult > 255) || 
-000c6a80: 2869 6e70 7574 5b30 5d20 213d 2027 2e27  (input[0] != '.'
-000c6a90: 2929 207b 0a20 2020 2020 2020 2072 6574  )) {.        ret
-000c6aa0: 7572 6e20 6973 5f76 616c 6964 203d 2066  urn is_valid = f
-000c6ab0: 616c 7365 3b0a 2020 2020 2020 7d0a 2020  alse;.      }.  
-000c6ac0: 2020 2020 6970 7634 203c 3c3d 2038 3b0a      ipv4 <<= 8;.
-000c6ad0: 2020 2020 2020 6970 7634 207c 3d20 7365        ipv4 |= se
-000c6ae0: 676d 656e 745f 7265 7375 6c74 3b0a 2020  gment_result;.  
-000c6af0: 2020 2020 696e 7075 742e 7265 6d6f 7665      input.remove
-000c6b00: 5f70 7265 6669 7828 3129 3b20 202f 2f20  _prefix(1);  // 
-000c6b10: 7265 6d6f 7665 2027 2e27 0a20 2020 207d  remove '.'.    }
-000c6b20: 0a20 207d 0a20 2069 6620 2828 6469 6769  .  }.  if ((digi
-000c6b30: 745f 636f 756e 7420 213d 2034 2920 7c7c  t_count != 4) ||
-000c6b40: 2028 2169 6e70 7574 2e65 6d70 7479 2829   (!input.empty()
-000c6b50: 2929 207b 0a20 2020 2072 6574 7572 6e20  )) {.    return 
-000c6b60: 6973 5f76 616c 6964 203d 2066 616c 7365  is_valid = false
-000c6b70: 3b0a 2020 7d0a 6669 6e61 6c3a 0a20 2061  ;.  }.final:.  a
-000c6b80: 6461 5f6c 6f67 2822 7572 6c5f 6167 6772  da_log("url_aggr
-000c6b90: 6567 6174 6f72 3a3a 7061 7273 655f 6970  egator::parse_ip
-000c6ba0: 7634 2063 6f6d 706c 6574 6564 2022 2c20  v4 completed ", 
-000c6bb0: 6765 745f 6872 6566 2829 2c0a 2020 2020  get_href(),.    
-000c6bc0: 2020 2020 2020 2220 686f 7374 3a20 222c        " host: ",
-000c6bd0: 2067 6574 5f68 6f73 7428 2929 3b0a 0a20   get_host());.. 
-000c6be0: 202f 2f20 5765 2063 6f75 6c64 2061 6c73   // We could als
-000c6bf0: 6f20 6368 6563 6b20 722e 7074 7220 746f  o check r.ptr to
-000c6c00: 2073 6565 2077 6865 7265 2074 6865 2070   see where the p
-000c6c10: 6172 7369 6e67 2065 6e64 6564 2e0a 2020  arsing ended..  
-000c6c20: 6966 2028 7075 7265 5f64 6563 696d 616c  if (pure_decimal
-000c6c30: 5f63 6f75 6e74 203d 3d20 3420 2626 2021  _count == 4 && !
-000c6c40: 7472 6169 6c69 6e67 5f64 6f74 2920 7b0a  trailing_dot) {.
-000c6c50: 2020 2020 2f2f 2054 6865 206f 7269 6769      // The origi
-000c6c60: 6e61 6c20 696e 7075 7420 7761 7320 616c  nal input was al
-000c6c70: 7265 6164 7920 616c 6c20 6465 6369 6d61  ready all decima
-000c6c80: 6c20 616e 6420 7765 2076 616c 6964 6174  l and we validat
-000c6c90: 6564 2069 742e 2053 6f20 7765 0a20 2020  ed it. So we.   
-000c6ca0: 202f 2f20 646f 6e27 7420 6e65 6564 2074   // don't need t
-000c6cb0: 6f20 646f 2061 6e79 7468 696e 672e 0a20  o do anything.. 
-000c6cc0: 207d 2065 6c73 6520 7b0a 2020 2020 2f2f   } else {.    //
-000c6cd0: 204f 7074 696d 697a 6174 696f 6e20 6f70   Optimization op
-000c6ce0: 706f 7274 756e 6974 793a 2047 6574 2072  portunity: Get r
-000c6cf0: 6964 206f 6620 756e 6e65 6365 7373 6172  id of unnecessar
-000c6d00: 7920 7374 7269 6e67 2072 6574 7572 6e20  y string return 
-000c6d10: 696e 2069 7076 340a 2020 2020 2f2f 2073  in ipv4.    // s
-000c6d20: 6572 6961 6c69 7a65 722e 0a20 2020 202f  erializer..    /
-000c6d30: 2f20 544f 444f 3a20 5468 6973 2069 7320  / TODO: This is 
-000c6d40: 6c69 6b65 6c79 2061 2062 7567 2062 6563  likely a bug bec
-000c6d50: 6175 7365 2069 7420 676f 6573 2062 6163  ause it goes bac
-000c6d60: 6b20 7570 6461 7465 5f62 6173 655f 686f  k update_base_ho
-000c6d70: 7374 6e61 6d65 2c20 6e6f 740a 2020 2020  stname, not.    
-000c6d80: 2f2f 2077 6861 7420 7765 2077 616e 7420  // what we want 
-000c6d90: 746f 2064 6f2e 0a20 2020 2075 7064 6174  to do..    updat
-000c6da0: 655f 6261 7365 5f68 6f73 746e 616d 6528  e_base_hostname(
-000c6db0: 0a20 2020 2020 2020 2061 6461 3a3a 7365  .        ada::se
-000c6dc0: 7269 616c 697a 6572 733a 3a69 7076 3428  rializers::ipv4(
-000c6dd0: 6970 7634 2929 3b20 202f 2f20 5765 2068  ipv4));  // We h
-000c6de0: 6176 6520 746f 2072 6573 6572 6961 6c69  ave to reseriali
-000c6df0: 7a65 2074 6865 2061 6464 7265 7373 2e0a  ze the address..
-000c6e00: 2020 7d0a 2020 4144 415f 4153 5345 5254    }.  ADA_ASSERT
-000c6e10: 5f54 5255 4528 7661 6c69 6461 7465 2829  _TRUE(validate()
-000c6e20: 293b 0a20 2072 6574 7572 6e20 7472 7565  );.  return true
-000c6e30: 3b0a 7d0a 0a62 6f6f 6c20 7572 6c5f 6167  ;.}..bool url_ag
-000c6e40: 6772 6567 6174 6f72 3a3a 7061 7273 655f  gregator::parse_
-000c6e50: 6970 7636 2873 7464 3a3a 7374 7269 6e67  ipv6(std::string
-000c6e60: 5f76 6965 7720 696e 7075 7429 207b 0a20  _view input) {. 
-000c6e70: 202f 2f20 544f 444f 3a20 4669 6e64 2061   // TODO: Find a
-000c6e80: 2077 6179 2074 6f20 6d65 7267 6520 7061   way to merge pa
-000c6e90: 7273 655f 6970 7636 2077 6974 6820 7572  rse_ipv6 with ur
-000c6ea0: 6c2e 6370 7020 696d 706c 656d 656e 7461  l.cpp implementa
-000c6eb0: 7469 6f6e 2e0a 2020 6164 615f 6c6f 6728  tion..  ada_log(
-000c6ec0: 2270 6172 7365 5f69 7076 3620 222c 2069  "parse_ipv6 ", i
-000c6ed0: 6e70 7574 2c20 225b 222c 2069 6e70 7574  nput, "[", input
-000c6ee0: 2e73 697a 6528 292c 2022 2062 7974 6573  .size(), " bytes
-000c6ef0: 5d22 293b 0a20 2041 4441 5f41 5353 4552  ]");.  ADA_ASSER
-000c6f00: 545f 5452 5545 2876 616c 6964 6174 6528  T_TRUE(validate(
-000c6f10: 2929 3b0a 2020 4144 415f 4153 5345 5254  ));.  ADA_ASSERT
-000c6f20: 5f54 5255 4528 2168 656c 7065 7273 3a3a  _TRUE(!helpers::
-000c6f30: 6f76 6572 6c61 7073 2869 6e70 7574 2c20  overlaps(input, 
-000c6f40: 6275 6666 6572 2929 3b0a 2020 6966 2028  buffer));.  if (
-000c6f50: 696e 7075 742e 656d 7074 7928 2929 207b  input.empty()) {
-000c6f60: 0a20 2020 2072 6574 7572 6e20 6973 5f76  .    return is_v
-000c6f70: 616c 6964 203d 2066 616c 7365 3b0a 2020  alid = false;.  
-000c6f80: 7d0a 2020 2f2f 204c 6574 2061 6464 7265  }.  // Let addre
-000c6f90: 7373 2062 6520 6120 6e65 7720 4950 7636  ss be a new IPv6
-000c6fa0: 2061 6464 7265 7373 2077 686f 7365 2049   address whose I
-000c6fb0: 5076 3620 7069 6563 6573 2061 7265 2061  Pv6 pieces are a
-000c6fc0: 6c6c 2030 2e0a 2020 7374 643a 3a61 7272  ll 0..  std::arr
-000c6fd0: 6179 3c75 696e 7431 365f 742c 2038 3e20  ay<uint16_t, 8> 
-000c6fe0: 6164 6472 6573 737b 7d3b 0a0a 2020 2f2f  address{};..  //
-000c6ff0: 204c 6574 2070 6965 6365 496e 6465 7820   Let pieceIndex 
-000c7000: 6265 2030 2e0a 2020 696e 7420 7069 6563  be 0..  int piec
-000c7010: 655f 696e 6465 7820 3d20 303b 0a0a 2020  e_index = 0;..  
-000c7020: 2f2f 204c 6574 2063 6f6d 7072 6573 7320  // Let compress 
-000c7030: 6265 206e 756c 6c2e 0a20 2073 7464 3a3a  be null..  std::
-000c7040: 6f70 7469 6f6e 616c 3c69 6e74 3e20 636f  optional<int> co
-000c7050: 6d70 7265 7373 7b7d 3b0a 0a20 202f 2f20  mpress{};..  // 
-000c7060: 4c65 7420 706f 696e 7465 7220 6265 2061  Let pointer be a
-000c7070: 2070 6f69 6e74 6572 2066 6f72 2069 6e70   pointer for inp
-000c7080: 7574 2e0a 2020 7374 643a 3a73 7472 696e  ut..  std::strin
-000c7090: 675f 7669 6577 3a3a 6974 6572 6174 6f72  g_view::iterator
-000c70a0: 2070 6f69 6e74 6572 203d 2069 6e70 7574   pointer = input
-000c70b0: 2e62 6567 696e 2829 3b0a 0a20 202f 2f20  .begin();..  // 
-000c70c0: 4966 2063 2069 7320 552b 3030 3341 2028  If c is U+003A (
-000c70d0: 3a29 2c20 7468 656e 3a0a 2020 6966 2028  :), then:.  if (
-000c70e0: 696e 7075 745b 305d 203d 3d20 273a 2729  input[0] == ':')
-000c70f0: 207b 0a20 2020 202f 2f20 4966 2072 656d   {.    // If rem
-000c7100: 6169 6e69 6e67 2064 6f65 7320 6e6f 7420  aining does not 
-000c7110: 7374 6172 7420 7769 7468 2055 2b30 3033  start with U+003
-000c7120: 4120 283a 292c 2076 616c 6964 6174 696f  A (:), validatio
-000c7130: 6e20 6572 726f 722c 2072 6574 7572 6e0a  n error, return.
-000c7140: 2020 2020 2f2f 2066 6169 6c75 7265 2e0a      // failure..
-000c7150: 2020 2020 6966 2028 696e 7075 742e 7369      if (input.si
-000c7160: 7a65 2829 203d 3d20 3120 7c7c 2069 6e70  ze() == 1 || inp
-000c7170: 7574 5b31 5d20 213d 2027 3a27 2920 7b0a  ut[1] != ':') {.
-000c7180: 2020 2020 2020 6164 615f 6c6f 6728 2270        ada_log("p
-000c7190: 6172 7365 5f69 7076 3620 7374 6172 7473  arse_ipv6 starts
-000c71a0: 2077 6974 6820 3a20 6275 7420 7468 6520   with : but the 
-000c71b0: 7265 7374 2064 6f65 7320 6e6f 7420 7374  rest does not st
-000c71c0: 6172 7420 7769 7468 203a 2229 3b0a 2020  art with :");.  
-000c71d0: 2020 2020 7265 7475 726e 2069 735f 7661      return is_va
-000c71e0: 6c69 6420 3d20 6661 6c73 653b 0a20 2020  lid = false;.   
-000c71f0: 207d 0a0a 2020 2020 2f2f 2049 6e63 7265   }..    // Incre
-000c7200: 6173 6520 706f 696e 7465 7220 6279 2032  ase pointer by 2
-000c7210: 2e0a 2020 2020 706f 696e 7465 7220 2b3d  ..    pointer +=
-000c7220: 2032 3b0a 0a20 2020 202f 2f20 496e 6372   2;..    // Incr
-000c7230: 6561 7365 2070 6965 6365 496e 6465 7820  ease pieceIndex 
-000c7240: 6279 2031 2061 6e64 2074 6865 6e20 7365  by 1 and then se
-000c7250: 7420 636f 6d70 7265 7373 2074 6f20 7069  t compress to pi
-000c7260: 6563 6549 6e64 6578 2e0a 2020 2020 636f  eceIndex..    co
-000c7270: 6d70 7265 7373 203d 202b 2b70 6965 6365  mpress = ++piece
-000c7280: 5f69 6e64 6578 3b0a 2020 7d0a 0a20 202f  _index;.  }..  /
-000c7290: 2f20 5768 696c 6520 6320 6973 206e 6f74  / While c is not
-000c72a0: 2074 6865 2045 4f46 2063 6f64 6520 706f   the EOF code po
-000c72b0: 696e 743a 0a20 2077 6869 6c65 2028 706f  int:.  while (po
-000c72c0: 696e 7465 7220 213d 2069 6e70 7574 2e65  inter != input.e
-000c72d0: 6e64 2829 2920 7b0a 2020 2020 2f2f 2049  nd()) {.    // I
-000c72e0: 6620 7069 6563 6549 6e64 6578 2069 7320  f pieceIndex is 
-000c72f0: 382c 2076 616c 6964 6174 696f 6e20 6572  8, validation er
-000c7300: 726f 722c 2072 6574 7572 6e20 6661 696c  ror, return fail
-000c7310: 7572 652e 0a20 2020 2069 6620 2870 6965  ure..    if (pie
-000c7320: 6365 5f69 6e64 6578 203d 3d20 3829 207b  ce_index == 8) {
-000c7330: 0a20 2020 2020 2061 6461 5f6c 6f67 2822  .      ada_log("
-000c7340: 7061 7273 655f 6970 7636 2070 6965 6365  parse_ipv6 piece
-000c7350: 5f69 6e64 6578 203d 3d20 3822 293b 0a20  _index == 8");. 
-000c7360: 2020 2020 2072 6574 7572 6e20 6973 5f76       return is_v
-000c7370: 616c 6964 203d 2066 616c 7365 3b0a 2020  alid = false;.  
-000c7380: 2020 7d0a 0a20 2020 202f 2f20 4966 2063    }..    // If c
-000c7390: 2069 7320 552b 3030 3341 2028 3a29 2c20   is U+003A (:), 
-000c73a0: 7468 656e 3a0a 2020 2020 6966 2028 2a70  then:.    if (*p
-000c73b0: 6f69 6e74 6572 203d 3d20 273a 2729 207b  ointer == ':') {
-000c73c0: 0a20 2020 2020 202f 2f20 4966 2063 6f6d  .      // If com
-000c73d0: 7072 6573 7320 6973 206e 6f6e 2d6e 756c  press is non-nul
-000c73e0: 6c2c 2076 616c 6964 6174 696f 6e20 6572  l, validation er
-000c73f0: 726f 722c 2072 6574 7572 6e20 6661 696c  ror, return fail
-000c7400: 7572 652e 0a20 2020 2020 2069 6620 2863  ure..      if (c
-000c7410: 6f6d 7072 6573 732e 6861 735f 7661 6c75  ompress.has_valu
-000c7420: 6528 2929 207b 0a20 2020 2020 2020 2061  e()) {.        a
-000c7430: 6461 5f6c 6f67 2822 7061 7273 655f 6970  da_log("parse_ip
-000c7440: 7636 2063 6f6d 7072 6573 7320 6973 206e  v6 compress is n
-000c7450: 6f6e 2d6e 756c 6c22 293b 0a20 2020 2020  on-null");.     
-000c7460: 2020 2072 6574 7572 6e20 6973 5f76 616c     return is_val
-000c7470: 6964 203d 2066 616c 7365 3b0a 2020 2020  id = false;.    
-000c7480: 2020 7d0a 0a20 2020 2020 202f 2f20 496e    }..      // In
-000c7490: 6372 6561 7365 2070 6f69 6e74 6572 2061  crease pointer a
-000c74a0: 6e64 2070 6965 6365 496e 6465 7820 6279  nd pieceIndex by
-000c74b0: 2031 2c20 7365 7420 636f 6d70 7265 7373   1, set compress
-000c74c0: 2074 6f20 7069 6563 6549 6e64 6578 2c20   to pieceIndex, 
-000c74d0: 616e 640a 2020 2020 2020 2f2f 2074 6865  and.      // the
-000c74e0: 6e20 636f 6e74 696e 7565 2e0a 2020 2020  n continue..    
-000c74f0: 2020 706f 696e 7465 722b 2b3b 0a20 2020    pointer++;.   
-000c7500: 2020 2063 6f6d 7072 6573 7320 3d20 2b2b     compress = ++
-000c7510: 7069 6563 655f 696e 6465 783b 0a20 2020  piece_index;.   
-000c7520: 2020 2063 6f6e 7469 6e75 653b 0a20 2020     continue;.   
-000c7530: 207d 0a0a 2020 2020 2f2f 204c 6574 2076   }..    // Let v
-000c7540: 616c 7565 2061 6e64 206c 656e 6774 6820  alue and length 
-000c7550: 6265 2030 2e0a 2020 2020 7569 6e74 3136  be 0..    uint16
-000c7560: 5f74 2076 616c 7565 203d 2030 2c20 6c65  _t value = 0, le
-000c7570: 6e67 7468 203d 2030 3b0a 0a20 2020 202f  ngth = 0;..    /
-000c7580: 2f20 5768 696c 6520 6c65 6e67 7468 2069  / While length i
-000c7590: 7320 6c65 7373 2074 6861 6e20 3420 616e  s less than 4 an
-000c75a0: 6420 6320 6973 2061 6e20 4153 4349 4920  d c is an ASCII 
-000c75b0: 6865 7820 6469 6769 742c 0a20 2020 202f  hex digit,.    /
-000c75c0: 2f20 7365 7420 7661 6c75 6520 746f 2076  / set value to v
-000c75d0: 616c 7565 20c3 9720 3078 3130 202b 2063  alue .. 0x10 + c
-000c75e0: 2069 6e74 6572 7072 6574 6564 2061 7320   interpreted as 
-000c75f0: 6865 7861 6465 6369 6d61 6c20 6e75 6d62  hexadecimal numb
-000c7600: 6572 2c20 616e 640a 2020 2020 2f2f 2069  er, and.    // i
-000c7610: 6e63 7265 6173 6520 706f 696e 7465 7220  ncrease pointer 
-000c7620: 616e 6420 6c65 6e67 7468 2062 7920 312e  and length by 1.
-000c7630: 0a20 2020 2077 6869 6c65 2028 6c65 6e67  .    while (leng
-000c7640: 7468 203c 2034 2026 2620 706f 696e 7465  th < 4 && pointe
-000c7650: 7220 213d 2069 6e70 7574 2e65 6e64 2829  r != input.end()
-000c7660: 2026 260a 2020 2020 2020 2020 2020 2075   &&.           u
-000c7670: 6e69 636f 6465 3a3a 6973 5f61 7363 6969  nicode::is_ascii
-000c7680: 5f68 6578 5f64 6967 6974 282a 706f 696e  _hex_digit(*poin
-000c7690: 7465 7229 2920 7b0a 2020 2020 2020 2f2f  ter)) {.      //
-000c76a0: 2068 7474 7073 3a2f 2f73 7461 636b 6f76   https://stackov
-000c76b0: 6572 666c 6f77 2e63 6f6d 2f71 7565 7374  erflow.com/quest
-000c76c0: 696f 6e73 2f33 3930 3630 3835 322f 7768  ions/39060852/wh
-000c76d0: 792d 646f 6573 2d74 6865 2d61 6464 6974  y-does-the-addit
-000c76e0: 696f 6e2d 6f66 2d74 776f 2d73 686f 7274  ion-of-two-short
-000c76f0: 732d 7265 7475 726e 2d61 6e2d 696e 740a  s-return-an-int.
-000c7700: 2020 2020 2020 7661 6c75 6520 3d20 7569        value = ui
-000c7710: 6e74 3136 5f74 2876 616c 7565 202a 2030  nt16_t(value * 0
-000c7720: 7831 3020 2b20 756e 6963 6f64 653a 3a63  x10 + unicode::c
-000c7730: 6f6e 7665 7274 5f68 6578 5f74 6f5f 6269  onvert_hex_to_bi
-000c7740: 6e61 7279 282a 706f 696e 7465 7229 293b  nary(*pointer));
-000c7750: 0a20 2020 2020 2070 6f69 6e74 6572 2b2b  .      pointer++
-000c7760: 3b0a 2020 2020 2020 6c65 6e67 7468 2b2b  ;.      length++
-000c7770: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-000c7780: 4966 2063 2069 7320 552b 3030 3245 2028  If c is U+002E (
-000c7790: 2e29 2c20 7468 656e 3a0a 2020 2020 6966  .), then:.    if
-000c77a0: 2028 706f 696e 7465 7220 213d 2069 6e70   (pointer != inp
-000c77b0: 7574 2e65 6e64 2829 2026 2620 2a70 6f69  ut.end() && *poi
-000c77c0: 6e74 6572 203d 3d20 272e 2729 207b 0a20  nter == '.') {. 
-000c77d0: 2020 2020 202f 2f20 4966 206c 656e 6774       // If lengt
-000c77e0: 6820 6973 2030 2c20 7661 6c69 6461 7469  h is 0, validati
-000c77f0: 6f6e 2065 7272 6f72 2c20 7265 7475 726e  on error, return
-000c7800: 2066 6169 6c75 7265 2e0a 2020 2020 2020   failure..      
-000c7810: 6966 2028 6c65 6e67 7468 203d 3d20 3029  if (length == 0)
-000c7820: 207b 0a20 2020 2020 2020 2061 6461 5f6c   {.        ada_l
-000c7830: 6f67 2822 7061 7273 655f 6970 7636 206c  og("parse_ipv6 l
-000c7840: 656e 6774 6820 6973 2030 2229 3b0a 2020  ength is 0");.  
-000c7850: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
-000c7860: 7661 6c69 6420 3d20 6661 6c73 653b 0a20  valid = false;. 
-000c7870: 2020 2020 207d 0a0a 2020 2020 2020 2f2f       }..      //
-000c7880: 2044 6563 7265 6173 6520 706f 696e 7465   Decrease pointe
-000c7890: 7220 6279 206c 656e 6774 682e 0a20 2020  r by length..   
-000c78a0: 2020 2070 6f69 6e74 6572 202d 3d20 6c65     pointer -= le
-000c78b0: 6e67 7468 3b0a 0a20 2020 2020 202f 2f20  ngth;..      // 
-000c78c0: 4966 2070 6965 6365 496e 6465 7820 6973  If pieceIndex is
-000c78d0: 2067 7265 6174 6572 2074 6861 6e20 362c   greater than 6,
-000c78e0: 2076 616c 6964 6174 696f 6e20 6572 726f   validation erro
-000c78f0: 722c 2072 6574 7572 6e20 6661 696c 7572  r, return failur
-000c7900: 652e 0a20 2020 2020 2069 6620 2870 6965  e..      if (pie
-000c7910: 6365 5f69 6e64 6578 203e 2036 2920 7b0a  ce_index > 6) {.
-000c7920: 2020 2020 2020 2020 6164 615f 6c6f 6728          ada_log(
-000c7930: 2270 6172 7365 5f69 7076 3620 7069 6563  "parse_ipv6 piec
-000c7940: 655f 696e 6465 7820 3e20 3622 293b 0a20  e_index > 6");. 
-000c7950: 2020 2020 2020 2072 6574 7572 6e20 6973         return is
-000c7960: 5f76 616c 6964 203d 2066 616c 7365 3b0a  _valid = false;.
-000c7970: 2020 2020 2020 7d0a 0a20 2020 2020 202f        }..      /
-000c7980: 2f20 4c65 7420 6e75 6d62 6572 7353 6565  / Let numbersSee
-000c7990: 6e20 6265 2030 2e0a 2020 2020 2020 696e  n be 0..      in
-000c79a0: 7420 6e75 6d62 6572 735f 7365 656e 203d  t numbers_seen =
-000c79b0: 2030 3b0a 0a20 2020 2020 202f 2f20 5768   0;..      // Wh
-000c79c0: 696c 6520 6320 6973 206e 6f74 2074 6865  ile c is not the
-000c79d0: 2045 4f46 2063 6f64 6520 706f 696e 743a   EOF code point:
-000c79e0: 0a20 2020 2020 2077 6869 6c65 2028 706f  .      while (po
-000c79f0: 696e 7465 7220 213d 2069 6e70 7574 2e65  inter != input.e
-000c7a00: 6e64 2829 2920 7b0a 2020 2020 2020 2020  nd()) {.        
-000c7a10: 2f2f 204c 6574 2069 7076 3450 6965 6365  // Let ipv4Piece
-000c7a20: 2062 6520 6e75 6c6c 2e0a 2020 2020 2020   be null..      
-000c7a30: 2020 7374 643a 3a6f 7074 696f 6e61 6c3c    std::optional<
-000c7a40: 7569 6e74 3136 5f74 3e20 6970 7634 5f70  uint16_t> ipv4_p
-000c7a50: 6965 6365 7b7d 3b0a 0a20 2020 2020 2020  iece{};..       
-000c7a60: 202f 2f20 4966 206e 756d 6265 7273 5365   // If numbersSe
-000c7a70: 656e 2069 7320 6772 6561 7465 7220 7468  en is greater th
-000c7a80: 616e 2030 2c20 7468 656e 3a0a 2020 2020  an 0, then:.    
-000c7a90: 2020 2020 6966 2028 6e75 6d62 6572 735f      if (numbers_
-000c7aa0: 7365 656e 203e 2030 2920 7b0a 2020 2020  seen > 0) {.    
-000c7ab0: 2020 2020 2020 2f2f 2049 6620 6320 6973        // If c is
-000c7ac0: 2061 2055 2b30 3032 4520 282e 2920 616e   a U+002E (.) an
-000c7ad0: 6420 6e75 6d62 6572 7353 6565 6e20 6973  d numbersSeen is
-000c7ae0: 206c 6573 7320 7468 616e 2034 2c20 7468   less than 4, th
-000c7af0: 656e 2069 6e63 7265 6173 650a 2020 2020  en increase.    
-000c7b00: 2020 2020 2020 2f2f 2070 6f69 6e74 6572        // pointer
-000c7b10: 2062 7920 312e 0a20 2020 2020 2020 2020   by 1..         
-000c7b20: 2069 6620 282a 706f 696e 7465 7220 3d3d   if (*pointer ==
-000c7b30: 2027 2e27 2026 2620 6e75 6d62 6572 735f   '.' && numbers_
-000c7b40: 7365 656e 203c 2034 2920 7b0a 2020 2020  seen < 4) {.    
-000c7b50: 2020 2020 2020 2020 706f 696e 7465 722b          pointer+
-000c7b60: 2b3b 0a20 2020 2020 2020 2020 207d 2065  +;.          } e
-000c7b70: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-000c7b80: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
-000c7b90: 7661 6c69 6461 7469 6f6e 2065 7272 6f72  validation error
-000c7ba0: 2c20 7265 7475 726e 2066 6169 6c75 7265  , return failure
-000c7bb0: 2e0a 2020 2020 2020 2020 2020 2020 6164  ..            ad
-000c7bc0: 615f 6c6f 6728 2270 6172 7365 5f69 7076  a_log("parse_ipv
-000c7bd0: 3620 4f74 6865 7277 6973 652c 2076 616c  6 Otherwise, val
-000c7be0: 6964 6174 696f 6e20 6572 726f 722c 2072  idation error, r
-000c7bf0: 6574 7572 6e20 6661 696c 7572 6522 293b  eturn failure");
-000c7c00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000c7c10: 7572 6e20 6973 5f76 616c 6964 203d 2066  urn is_valid = f
-000c7c20: 616c 7365 3b0a 2020 2020 2020 2020 2020  alse;.          
-000c7c30: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-000c7c40: 2020 2020 202f 2f20 4966 2063 2069 7320       // If c is 
-000c7c50: 6e6f 7420 616e 2041 5343 4949 2064 6967  not an ASCII dig
-000c7c60: 6974 2c20 7661 6c69 6461 7469 6f6e 2065  it, validation e
-000c7c70: 7272 6f72 2c20 7265 7475 726e 2066 6169  rror, return fai
-000c7c80: 6c75 7265 2e0a 2020 2020 2020 2020 6966  lure..        if
-000c7c90: 2028 706f 696e 7465 7220 3d3d 2069 6e70   (pointer == inp
-000c7ca0: 7574 2e65 6e64 2829 207c 7c20 2163 6865  ut.end() || !che
-000c7cb0: 636b 6572 733a 3a69 735f 6469 6769 7428  ckers::is_digit(
-000c7cc0: 2a70 6f69 6e74 6572 2929 207b 0a20 2020  *pointer)) {.   
-000c7cd0: 2020 2020 2020 2061 6461 5f6c 6f67 280a         ada_log(.
-000c7ce0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-000c7cf0: 6172 7365 5f69 7076 3620 4966 2063 2069  arse_ipv6 If c i
-000c7d00: 7320 6e6f 7420 616e 2041 5343 4949 2064  s not an ASCII d
-000c7d10: 6967 6974 2c20 7661 6c69 6461 7469 6f6e  igit, validation
-000c7d20: 2065 7272 6f72 2c20 7265 7475 726e 2022   error, return "
-000c7d30: 0a20 2020 2020 2020 2020 2020 2020 2022  .              "
-000c7d40: 6661 696c 7572 6522 293b 0a20 2020 2020  failure");.     
-000c7d50: 2020 2020 2072 6574 7572 6e20 6973 5f76       return is_v
-000c7d60: 616c 6964 203d 2066 616c 7365 3b0a 2020  alid = false;.  
-000c7d70: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000c7d80: 202f 2f20 5768 696c 6520 6320 6973 2061   // While c is a
-000c7d90: 6e20 4153 4349 4920 6469 6769 743a 0a20  n ASCII digit:. 
-000c7da0: 2020 2020 2020 2077 6869 6c65 2028 706f         while (po
-000c7db0: 696e 7465 7220 213d 2069 6e70 7574 2e65  inter != input.e
-000c7dc0: 6e64 2829 2026 2620 6368 6563 6b65 7273  nd() && checkers
-000c7dd0: 3a3a 6973 5f64 6967 6974 282a 706f 696e  ::is_digit(*poin
-000c7de0: 7465 7229 2920 7b0a 2020 2020 2020 2020  ter)) {.        
-000c7df0: 2020 2f2f 204c 6574 206e 756d 6265 7220    // Let number 
-000c7e00: 6265 2063 2069 6e74 6572 7072 6574 6564  be c interpreted
-000c7e10: 2061 7320 6465 6369 6d61 6c20 6e75 6d62   as decimal numb
-000c7e20: 6572 2e0a 2020 2020 2020 2020 2020 696e  er..          in
-000c7e30: 7420 6e75 6d62 6572 203d 202a 706f 696e  t number = *poin
-000c7e40: 7465 7220 2d20 2730 273b 0a0a 2020 2020  ter - '0';..    
-000c7e50: 2020 2020 2020 2f2f 2049 6620 6970 7634        // If ipv4
-000c7e60: 5069 6563 6520 6973 206e 756c 6c2c 2074  Piece is null, t
-000c7e70: 6865 6e20 7365 7420 6970 7634 5069 6563  hen set ipv4Piec
-000c7e80: 6520 746f 206e 756d 6265 722e 0a20 2020  e to number..   
-000c7e90: 2020 2020 2020 2069 6620 2821 6970 7634         if (!ipv4
-000c7ea0: 5f70 6965 6365 2e68 6173 5f76 616c 7565  _piece.has_value
-000c7eb0: 2829 2920 7b0a 2020 2020 2020 2020 2020  ()) {.          
-000c7ec0: 2020 6970 7634 5f70 6965 6365 203d 206e    ipv4_piece = n
-000c7ed0: 756d 6265 723b 0a20 2020 2020 2020 2020  umber;.         
-000c7ee0: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
-000c7ef0: 4f74 6865 7277 6973 652c 2069 6620 6970  Otherwise, if ip
-000c7f00: 7634 5069 6563 6520 6973 2030 2c20 7661  v4Piece is 0, va
-000c7f10: 6c69 6461 7469 6f6e 2065 7272 6f72 2c20  lidation error, 
-000c7f20: 7265 7475 726e 2066 6169 6c75 7265 2e0a  return failure..
-000c7f30: 2020 2020 2020 2020 2020 656c 7365 2069            else i
-000c7f40: 6620 2869 7076 345f 7069 6563 6520 3d3d  f (ipv4_piece ==
-000c7f50: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-000c7f60: 2020 6164 615f 6c6f 6728 2270 6172 7365    ada_log("parse
-000c7f70: 5f69 7076 3620 6966 2069 7076 3450 6965  _ipv6 if ipv4Pie
-000c7f80: 6365 2069 7320 302c 2076 616c 6964 6174  ce is 0, validat
-000c7f90: 696f 6e20 6572 726f 7222 293b 0a20 2020  ion error");.   
-000c7fa0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000c7fb0: 6973 5f76 616c 6964 203d 2066 616c 7365  is_valid = false
-000c7fc0: 3b0a 2020 2020 2020 2020 2020 7d0a 2020  ;.          }.  
-000c7fd0: 2020 2020 2020 2020 2f2f 204f 7468 6572          // Other
-000c7fe0: 7769 7365 2c20 7365 7420 6970 7634 5069  wise, set ipv4Pi
-000c7ff0: 6563 6520 746f 2069 7076 3450 6965 6365  ece to ipv4Piece
-000c8000: 20c3 9720 3130 202b 206e 756d 6265 722e   .. 10 + number.
-000c8010: 0a20 2020 2020 2020 2020 2065 6c73 6520  .          else 
-000c8020: 7b0a 2020 2020 2020 2020 2020 2020 6970  {.            ip
-000c8030: 7634 5f70 6965 6365 203d 202a 6970 7634  v4_piece = *ipv4
-000c8040: 5f70 6965 6365 202a 2031 3020 2b20 6e75  _piece * 10 + nu
-000c8050: 6d62 6572 3b0a 2020 2020 2020 2020 2020  mber;.          
-000c8060: 7d0a 0a20 2020 2020 2020 2020 202f 2f20  }..          // 
-000c8070: 4966 2069 7076 3450 6965 6365 2069 7320  If ipv4Piece is 
-000c8080: 6772 6561 7465 7220 7468 616e 2032 3535  greater than 255
-000c8090: 2c20 7661 6c69 6461 7469 6f6e 2065 7272  , validation err
-000c80a0: 6f72 2c20 7265 7475 726e 2066 6169 6c75  or, return failu
-000c80b0: 7265 2e0a 2020 2020 2020 2020 2020 6966  re..          if
-000c80c0: 2028 6970 7634 5f70 6965 6365 203e 2032   (ipv4_piece > 2
-000c80d0: 3535 2920 7b0a 2020 2020 2020 2020 2020  55) {.          
-000c80e0: 2020 6164 615f 6c6f 6728 2270 6172 7365    ada_log("parse
-000c80f0: 5f69 7076 3620 6970 7634 5f70 6965 6365  _ipv6 ipv4_piece
-000c8100: 203e 2032 3535 2229 3b0a 2020 2020 2020   > 255");.      
-000c8110: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
-000c8120: 7661 6c69 6420 3d20 6661 6c73 653b 0a20  valid = false;. 
-000c8130: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-000c8140: 2020 2020 2020 2f2f 2049 6e63 7265 6173        // Increas
-000c8150: 6520 706f 696e 7465 7220 6279 2031 2e0a  e pointer by 1..
-000c8160: 2020 2020 2020 2020 2020 706f 696e 7465            pointe
-000c8170: 722b 2b3b 0a20 2020 2020 2020 207d 0a0a  r++;.        }..
-000c8180: 2020 2020 2020 2020 2f2f 2053 6574 2061          // Set a
-000c8190: 6464 7265 7373 5b70 6965 6365 496e 6465  ddress[pieceInde
-000c81a0: 785d 2074 6f20 6164 6472 6573 735b 7069  x] to address[pi
-000c81b0: 6563 6549 6e64 6578 5d20 c397 2030 7831  eceIndex] .. 0x1
-000c81c0: 3030 202b 2069 7076 3450 6965 6365 2e0a  00 + ipv4Piece..
-000c81d0: 2020 2020 2020 2020 2f2f 2068 7474 7073          // https
-000c81e0: 3a2f 2f73 7461 636b 6f76 6572 666c 6f77  ://stackoverflow
-000c81f0: 2e63 6f6d 2f71 7565 7374 696f 6e73 2f33  .com/questions/3
-000c8200: 3930 3630 3835 322f 7768 792d 646f 6573  9060852/why-does
-000c8210: 2d74 6865 2d61 6464 6974 696f 6e2d 6f66  -the-addition-of
-000c8220: 2d74 776f 2d73 686f 7274 732d 7265 7475  -two-shorts-retu
-000c8230: 726e 2d61 6e2d 696e 740a 2020 2020 2020  rn-an-int.      
-000c8240: 2020 6164 6472 6573 735b 7069 6563 655f    address[piece_
-000c8250: 696e 6465 785d 203d 0a20 2020 2020 2020  index] =.       
-000c8260: 2020 2020 2075 696e 7431 365f 7428 6164       uint16_t(ad
-000c8270: 6472 6573 735b 7069 6563 655f 696e 6465  dress[piece_inde
-000c8280: 785d 202a 2030 7831 3030 202b 202a 6970  x] * 0x100 + *ip
-000c8290: 7634 5f70 6965 6365 293b 0a0a 2020 2020  v4_piece);..    
-000c82a0: 2020 2020 2f2f 2049 6e63 7265 6173 6520      // Increase 
-000c82b0: 6e75 6d62 6572 7353 6565 6e20 6279 2031  numbersSeen by 1
-000c82c0: 2e0a 2020 2020 2020 2020 6e75 6d62 6572  ..        number
-000c82d0: 735f 7365 656e 2b2b 3b0a 0a20 2020 2020  s_seen++;..     
-000c82e0: 2020 202f 2f20 4966 206e 756d 6265 7273     // If numbers
-000c82f0: 5365 656e 2069 7320 3220 6f72 2034 2c20  Seen is 2 or 4, 
-000c8300: 7468 656e 2069 6e63 7265 6173 6520 7069  then increase pi
-000c8310: 6563 6549 6e64 6578 2062 7920 312e 0a20  eceIndex by 1.. 
-000c8320: 2020 2020 2020 2069 6620 286e 756d 6265         if (numbe
-000c8330: 7273 5f73 6565 6e20 3d3d 2032 207c 7c20  rs_seen == 2 || 
-000c8340: 6e75 6d62 6572 735f 7365 656e 203d 3d20  numbers_seen == 
-000c8350: 3429 207b 0a20 2020 2020 2020 2020 2070  4) {.          p
-000c8360: 6965 6365 5f69 6e64 6578 2b2b 3b0a 2020  iece_index++;.  
-000c8370: 2020 2020 2020 7d0a 2020 2020 2020 7d0a        }.      }.
-000c8380: 0a20 2020 2020 202f 2f20 4966 206e 756d  .      // If num
-000c8390: 6265 7273 5365 656e 2069 7320 6e6f 7420  bersSeen is not 
-000c83a0: 342c 2076 616c 6964 6174 696f 6e20 6572  4, validation er
-000c83b0: 726f 722c 2072 6574 7572 6e20 6661 696c  ror, return fail
-000c83c0: 7572 652e 0a20 2020 2020 2069 6620 286e  ure..      if (n
-000c83d0: 756d 6265 7273 5f73 6565 6e20 213d 2034  umbers_seen != 4
-000c83e0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-000c83f0: 726e 2069 735f 7661 6c69 6420 3d20 6661  rn is_valid = fa
-000c8400: 6c73 653b 0a20 2020 2020 207d 0a0a 2020  lse;.      }..  
-000c8410: 2020 2020 2f2f 2042 7265 616b 2e0a 2020      // Break..  
-000c8420: 2020 2020 6272 6561 6b3b 0a20 2020 207d      break;.    }
-000c8430: 0a20 2020 202f 2f20 4f74 6865 7277 6973  .    // Otherwis
-000c8440: 652c 2069 6620 6320 6973 2055 2b30 3033  e, if c is U+003
-000c8450: 4120 283a 293a 0a20 2020 2065 6c73 6520  A (:):.    else 
-000c8460: 6966 2028 2870 6f69 6e74 6572 2021 3d20  if ((pointer != 
-000c8470: 696e 7075 742e 656e 6428 2929 2026 2620  input.end()) && 
-000c8480: 282a 706f 696e 7465 7220 3d3d 2027 3a27  (*pointer == ':'
-000c8490: 2929 207b 0a20 2020 2020 202f 2f20 496e  )) {.      // In
-000c84a0: 6372 6561 7365 2070 6f69 6e74 6572 2062  crease pointer b
-000c84b0: 7920 312e 0a20 2020 2020 2070 6f69 6e74  y 1..      point
-000c84c0: 6572 2b2b 3b0a 0a20 2020 2020 202f 2f20  er++;..      // 
-000c84d0: 4966 2063 2069 7320 7468 6520 454f 4620  If c is the EOF 
-000c84e0: 636f 6465 2070 6f69 6e74 2c20 7661 6c69  code point, vali
-000c84f0: 6461 7469 6f6e 2065 7272 6f72 2c20 7265  dation error, re
-000c8500: 7475 726e 2066 6169 6c75 7265 2e0a 2020  turn failure..  
-000c8510: 2020 2020 6966 2028 706f 696e 7465 7220      if (pointer 
-000c8520: 3d3d 2069 6e70 7574 2e65 6e64 2829 2920  == input.end()) 
-000c8530: 7b0a 2020 2020 2020 2020 6164 615f 6c6f  {.        ada_lo
-000c8540: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
-000c8550: 7061 7273 655f 6970 7636 2049 6620 6320  parse_ipv6 If c 
-000c8560: 6973 2074 6865 2045 4f46 2063 6f64 6520  is the EOF code 
-000c8570: 706f 696e 742c 2076 616c 6964 6174 696f  point, validatio
-000c8580: 6e20 6572 726f 722c 2072 6574 7572 6e20  n error, return 
-000c8590: 220a 2020 2020 2020 2020 2020 2020 2266  ".            "f
-000c85a0: 6169 6c75 7265 2229 3b0a 2020 2020 2020  ailure");.      
-000c85b0: 2020 7265 7475 726e 2069 735f 7661 6c69    return is_vali
-000c85c0: 6420 3d20 6661 6c73 653b 0a20 2020 2020  d = false;.     
-000c85d0: 207d 0a20 2020 207d 0a20 2020 202f 2f20   }.    }.    // 
-000c85e0: 4f74 6865 7277 6973 652c 2069 6620 6320  Otherwise, if c 
-000c85f0: 6973 206e 6f74 2074 6865 2045 4f46 2063  is not the EOF c
-000c8600: 6f64 6520 706f 696e 742c 2076 616c 6964  ode point, valid
-000c8610: 6174 696f 6e20 6572 726f 722c 2072 6574  ation error, ret
-000c8620: 7572 6e0a 2020 2020 2f2f 2066 6169 6c75  urn.    // failu
-000c8630: 7265 2e0a 2020 2020 656c 7365 2069 6620  re..    else if 
-000c8640: 2870 6f69 6e74 6572 2021 3d20 696e 7075  (pointer != inpu
-000c8650: 742e 656e 6428 2929 207b 0a20 2020 2020  t.end()) {.     
-000c8660: 2061 6461 5f6c 6f67 280a 2020 2020 2020   ada_log(.      
-000c8670: 2020 2020 2270 6172 7365 5f69 7076 3620      "parse_ipv6 
-000c8680: 4f74 6865 7277 6973 652c 2069 6620 6320  Otherwise, if c 
-000c8690: 6973 206e 6f74 2074 6865 2045 4f46 2063  is not the EOF c
-000c86a0: 6f64 6520 706f 696e 742c 2076 616c 6964  ode point, valid
-000c86b0: 6174 696f 6e20 220a 2020 2020 2020 2020  ation ".        
-000c86c0: 2020 2265 7272 6f72 2c20 7265 7475 726e    "error, return
-000c86d0: 2066 6169 6c75 7265 2229 3b0a 2020 2020   failure");.    
-000c86e0: 2020 7265 7475 726e 2069 735f 7661 6c69    return is_vali
-000c86f0: 6420 3d20 6661 6c73 653b 0a20 2020 207d  d = false;.    }
-000c8700: 0a0a 2020 2020 2f2f 2053 6574 2061 6464  ..    // Set add
-000c8710: 7265 7373 5b70 6965 6365 496e 6465 785d  ress[pieceIndex]
-000c8720: 2074 6f20 7661 6c75 652e 0a20 2020 2061   to value..    a
-000c8730: 6464 7265 7373 5b70 6965 6365 5f69 6e64  ddress[piece_ind
-000c8740: 6578 5d20 3d20 7661 6c75 653b 0a0a 2020  ex] = value;..  
-000c8750: 2020 2f2f 2049 6e63 7265 6173 6520 7069    // Increase pi
-000c8760: 6563 6549 6e64 6578 2062 7920 312e 0a20  eceIndex by 1.. 
-000c8770: 2020 2070 6965 6365 5f69 6e64 6578 2b2b     piece_index++
-000c8780: 3b0a 2020 7d0a 0a20 202f 2f20 4966 2063  ;.  }..  // If c
-000c8790: 6f6d 7072 6573 7320 6973 206e 6f6e 2d6e  ompress is non-n
-000c87a0: 756c 6c2c 2074 6865 6e3a 0a20 2069 6620  ull, then:.  if 
-000c87b0: 2863 6f6d 7072 6573 732e 6861 735f 7661  (compress.has_va
-000c87c0: 6c75 6528 2929 207b 0a20 2020 202f 2f20  lue()) {.    // 
-000c87d0: 4c65 7420 7377 6170 7320 6265 2070 6965  Let swaps be pie
-000c87e0: 6365 496e 6465 7820 e288 9220 636f 6d70  ceIndex ... comp
-000c87f0: 7265 7373 2e0a 2020 2020 696e 7420 7377  ress..    int sw
-000c8800: 6170 7320 3d20 7069 6563 655f 696e 6465  aps = piece_inde
-000c8810: 7820 2d20 2a63 6f6d 7072 6573 733b 0a0a  x - *compress;..
-000c8820: 2020 2020 2f2f 2053 6574 2070 6965 6365      // Set piece
-000c8830: 496e 6465 7820 746f 2037 2e0a 2020 2020  Index to 7..    
-000c8840: 7069 6563 655f 696e 6465 7820 3d20 373b  piece_index = 7;
-000c8850: 0a0a 2020 2020 2f2f 2057 6869 6c65 2070  ..    // While p
-000c8860: 6965 6365 496e 6465 7820 6973 206e 6f74  ieceIndex is not
-000c8870: 2030 2061 6e64 2073 7761 7073 2069 7320   0 and swaps is 
-000c8880: 6772 6561 7465 7220 7468 616e 2030 2c0a  greater than 0,.
-000c8890: 2020 2020 2f2f 2073 7761 7020 6164 6472      // swap addr
-000c88a0: 6573 735b 7069 6563 6549 6e64 6578 5d20  ess[pieceIndex] 
-000c88b0: 7769 7468 2061 6464 7265 7373 5b63 6f6d  with address[com
-000c88c0: 7072 6573 7320 2b20 7377 6170 7320 e288  press + swaps ..
-000c88d0: 9220 315d 2c20 616e 6420 7468 656e 0a20  . 1], and then. 
-000c88e0: 2020 202f 2f20 6465 6372 6561 7365 2062     // decrease b
-000c88f0: 6f74 6820 7069 6563 6549 6e64 6578 2061  oth pieceIndex a
-000c8900: 6e64 2073 7761 7073 2062 7920 312e 0a20  nd swaps by 1.. 
-000c8910: 2020 2077 6869 6c65 2028 7069 6563 655f     while (piece_
-000c8920: 696e 6465 7820 213d 2030 2026 2620 7377  index != 0 && sw
-000c8930: 6170 7320 3e20 3029 207b 0a20 2020 2020  aps > 0) {.     
-000c8940: 2073 7464 3a3a 7377 6170 2861 6464 7265   std::swap(addre
-000c8950: 7373 5b70 6965 6365 5f69 6e64 6578 5d2c  ss[piece_index],
-000c8960: 2061 6464 7265 7373 5b2a 636f 6d70 7265   address[*compre
-000c8970: 7373 202b 2073 7761 7073 202d 2031 5d29  ss + swaps - 1])
-000c8980: 3b0a 2020 2020 2020 7069 6563 655f 696e  ;.      piece_in
-000c8990: 6465 782d 2d3b 0a20 2020 2020 2073 7761  dex--;.      swa
-000c89a0: 7073 2d2d 3b0a 2020 2020 7d0a 2020 7d0a  ps--;.    }.  }.
-000c89b0: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
-000c89c0: 6966 2063 6f6d 7072 6573 7320 6973 206e  if compress is n
-000c89d0: 756c 6c20 616e 6420 7069 6563 6549 6e64  ull and pieceInd
-000c89e0: 6578 2069 7320 6e6f 7420 382c 2076 616c  ex is not 8, val
-000c89f0: 6964 6174 696f 6e20 6572 726f 722c 0a20  idation error,. 
-000c8a00: 202f 2f20 7265 7475 726e 2066 6169 6c75   // return failu
-000c8a10: 7265 2e0a 2020 656c 7365 2069 6620 2870  re..  else if (p
-000c8a20: 6965 6365 5f69 6e64 6578 2021 3d20 3829  iece_index != 8)
-000c8a30: 207b 0a20 2020 2061 6461 5f6c 6f67 280a   {.    ada_log(.
-000c8a40: 2020 2020 2020 2020 2270 6172 7365 5f69          "parse_i
-000c8a50: 7076 3620 6966 2063 6f6d 7072 6573 7320  pv6 if compress 
-000c8a60: 6973 206e 756c 6c20 616e 6420 7069 6563  is null and piec
-000c8a70: 6549 6e64 6578 2069 7320 6e6f 7420 382c  eIndex is not 8,
-000c8a80: 2076 616c 6964 6174 696f 6e20 220a 2020   validation ".  
-000c8a90: 2020 2020 2020 2265 7272 6f72 2c20 7265        "error, re
-000c8aa0: 7475 726e 2066 6169 6c75 7265 2229 3b0a  turn failure");.
-000c8ab0: 2020 2020 7265 7475 726e 2069 735f 7661      return is_va
-000c8ac0: 6c69 6420 3d20 6661 6c73 653b 0a20 207d  lid = false;.  }
-000c8ad0: 0a20 202f 2f20 544f 444f 3a20 4f70 7469  .  // TODO: Opti
-000c8ae0: 6d69 7a61 7469 6f6e 206f 7070 6f72 7475  mization opportu
-000c8af0: 6e69 7479 3a20 4765 7420 7269 6420 6f66  nity: Get rid of
-000c8b00: 2075 6e6e 6563 6573 7361 7279 2073 7472   unnecessary str
-000c8b10: 696e 6720 6372 6561 7469 6f6e 2e0a 2020  ing creation..  
-000c8b20: 2f2f 2054 4f44 4f3a 2054 6869 7320 6973  // TODO: This is
-000c8b30: 206c 696b 656c 7920 6120 6275 6720 6265   likely a bug be
-000c8b40: 6361 7573 6520 6974 2067 6f65 7320 6261  cause it goes ba
-000c8b50: 636b 2075 7064 6174 655f 6261 7365 5f68  ck update_base_h
-000c8b60: 6f73 746e 616d 652c 206e 6f74 0a20 202f  ostname, not.  /
-000c8b70: 2f20 7768 6174 2077 6520 7761 6e74 2074  / what we want t
-000c8b80: 6f20 646f 2e0a 2020 7570 6461 7465 5f62  o do..  update_b
-000c8b90: 6173 655f 686f 7374 6e61 6d65 2861 6461  ase_hostname(ada
-000c8ba0: 3a3a 7365 7269 616c 697a 6572 733a 3a69  ::serializers::i
-000c8bb0: 7076 3628 6164 6472 6573 7329 293b 0a20  pv6(address));. 
-000c8bc0: 2061 6461 5f6c 6f67 2822 7061 7273 655f   ada_log("parse_
-000c8bd0: 6970 7636 2022 2c20 6765 745f 686f 7374  ipv6 ", get_host
-000c8be0: 6e61 6d65 2829 293b 0a20 2041 4441 5f41  name());.  ADA_A
-000c8bf0: 5353 4552 545f 5452 5545 2876 616c 6964  SSERT_TRUE(valid
-000c8c00: 6174 6528 2929 3b0a 2020 7265 7475 726e  ate());.  return
-000c8c10: 2074 7275 653b 0a7d 0a0a 626f 6f6c 2075   true;.}..bool u
-000c8c20: 726c 5f61 6767 7265 6761 746f 723a 3a70  rl_aggregator::p
-000c8c30: 6172 7365 5f6f 7061 7175 655f 686f 7374  arse_opaque_host
-000c8c40: 2873 7464 3a3a 7374 7269 6e67 5f76 6965  (std::string_vie
-000c8c50: 7720 696e 7075 7429 207b 0a20 2061 6461  w input) {.  ada
-000c8c60: 5f6c 6f67 2822 7061 7273 655f 6f70 6171  _log("parse_opaq
-000c8c70: 7565 5f68 6f73 7420 222c 2069 6e70 7574  ue_host ", input
-000c8c80: 2c20 225b 222c 2069 6e70 7574 2e73 697a  , "[", input.siz
-000c8c90: 6528 292c 2022 2062 7974 6573 5d22 293b  e(), " bytes]");
-000c8ca0: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
-000c8cb0: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
-000c8cc0: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000c8cd0: 4528 2168 656c 7065 7273 3a3a 6f76 6572  E(!helpers::over
-000c8ce0: 6c61 7073 2869 6e70 7574 2c20 6275 6666  laps(input, buff
-000c8cf0: 6572 2929 3b0a 2020 6966 2028 7374 643a  er));.  if (std:
-000c8d00: 3a61 6e79 5f6f 6628 696e 7075 742e 6265  :any_of(input.be
-000c8d10: 6769 6e28 292c 2069 6e70 7574 2e65 6e64  gin(), input.end
-000c8d20: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-000c8d30: 2020 2020 2020 6164 613a 3a75 6e69 636f        ada::unico
-000c8d40: 6465 3a3a 6973 5f66 6f72 6269 6464 656e  de::is_forbidden
-000c8d50: 5f68 6f73 745f 636f 6465 5f70 6f69 6e74  _host_code_point
-000c8d60: 2929 207b 0a20 2020 2072 6574 7572 6e20  )) {.    return 
-000c8d70: 6973 5f76 616c 6964 203d 2066 616c 7365  is_valid = false
-000c8d80: 3b0a 2020 7d0a 0a20 202f 2f20 5265 7475  ;.  }..  // Retu
-000c8d90: 726e 2074 6865 2072 6573 756c 7420 6f66  rn the result of
-000c8da0: 2072 756e 6e69 6e67 2055 5446 2d38 2070   running UTF-8 p
-000c8db0: 6572 6365 6e74 2d65 6e63 6f64 6520 6f6e  ercent-encode on
-000c8dc0: 2069 6e70 7574 2075 7369 6e67 2074 6865   input using the
-000c8dd0: 2043 300a 2020 2f2f 2063 6f6e 7472 6f6c   C0.  // control
-000c8de0: 2070 6572 6365 6e74 2d65 6e63 6f64 6520   percent-encode 
-000c8df0: 7365 742e 0a20 2073 697a 655f 7420 6964  set..  size_t id
-000c8e00: 7820 3d20 6164 613a 3a75 6e69 636f 6465  x = ada::unicode
-000c8e10: 3a3a 7065 7263 656e 745f 656e 636f 6465  ::percent_encode
-000c8e20: 5f69 6e64 6578 280a 2020 2020 2020 696e  _index(.      in
-000c8e30: 7075 742c 2063 6861 7261 6374 6572 5f73  put, character_s
-000c8e40: 6574 733a 3a43 305f 434f 4e54 524f 4c5f  ets::C0_CONTROL_
-000c8e50: 5045 5243 454e 545f 454e 434f 4445 293b  PERCENT_ENCODE);
-000c8e60: 0a20 2069 6620 2869 6478 203d 3d20 696e  .  if (idx == in
-000c8e70: 7075 742e 7369 7a65 2829 2920 7b0a 2020  put.size()) {.  
-000c8e80: 2020 7570 6461 7465 5f62 6173 655f 686f    update_base_ho
-000c8e90: 7374 6e61 6d65 2869 6e70 7574 293b 0a20  stname(input);. 
-000c8ea0: 207d 2065 6c73 6520 7b0a 2020 2020 2f2f   } else {.    //
-000c8eb0: 2057 6520 6f6e 6c79 2063 7265 6174 6520   We only create 
-000c8ec0: 6120 7465 6d70 6f72 6172 7920 7374 7269  a temporary stri
-000c8ed0: 6e67 2069 6620 7765 206e 6565 6420 746f  ng if we need to
-000c8ee0: 2e0a 2020 2020 7570 6461 7465 5f62 6173  ..    update_bas
-000c8ef0: 655f 686f 7374 6e61 6d65 2861 6461 3a3a  e_hostname(ada::
-000c8f00: 756e 6963 6f64 653a 3a70 6572 6365 6e74  unicode::percent
-000c8f10: 5f65 6e63 6f64 6528 0a20 2020 2020 2020  _encode(.       
-000c8f20: 2069 6e70 7574 2c20 6368 6172 6163 7465   input, characte
-000c8f30: 725f 7365 7473 3a3a 4330 5f43 4f4e 5452  r_sets::C0_CONTR
-000c8f40: 4f4c 5f50 4552 4345 4e54 5f45 4e43 4f44  OL_PERCENT_ENCOD
-000c8f50: 452c 2069 6478 2929 3b0a 2020 7d0a 2020  E, idx));.  }.  
-000c8f60: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
-000c8f70: 7661 6c69 6461 7465 2829 293b 0a20 2072  validate());.  r
-000c8f80: 6574 7572 6e20 7472 7565 3b0a 7d0a 0a73  eturn true;.}..s
-000c8f90: 7464 3a3a 7374 7269 6e67 2075 726c 5f61  td::string url_a
-000c8fa0: 6767 7265 6761 746f 723a 3a74 6f5f 6469  ggregator::to_di
-000c8fb0: 6167 7261 6d28 2920 636f 6e73 7420 7b0a  agram() const {.
-000c8fc0: 2020 6966 2028 2169 735f 7661 6c69 6429    if (!is_valid)
-000c8fd0: 207b 0a20 2020 2072 6574 7572 6e20 2269   {.    return "i
-000c8fe0: 6e76 616c 6964 223b 0a20 207d 0a20 2073  nvalid";.  }.  s
-000c8ff0: 7464 3a3a 7374 7269 6e67 2061 6e73 7765  td::string answe
-000c9000: 723b 0a20 2061 6e73 7765 722e 6170 7065  r;.  answer.appe
-000c9010: 6e64 2862 7566 6665 7229 3b0a 2020 616e  nd(buffer);.  an
-000c9020: 7377 6572 2e61 7070 656e 6428 2220 5b22  swer.append(" ["
-000c9030: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
-000c9040: 6e64 2873 7464 3a3a 746f 5f73 7472 696e  nd(std::to_strin
-000c9050: 6728 6275 6666 6572 2e73 697a 6528 2929  g(buffer.size())
-000c9060: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
-000c9070: 6e64 2822 2062 7974 6573 5d22 293b 0a20  nd(" bytes]");. 
-000c9080: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000c9090: 5c6e 2229 3b0a 2020 2f2f 2066 6972 7374  \n");.  // first
-000c90a0: 206c 696e 650a 2020 7374 643a 3a73 7472   line.  std::str
-000c90b0: 696e 6720 6c69 6e65 313b 0a20 206c 696e  ing line1;.  lin
-000c90c0: 6531 2e72 6573 697a 6528 6275 6666 6572  e1.resize(buffer
-000c90d0: 2e73 697a 6528 292c 2027 2027 293b 0a20  .size(), ' ');. 
-000c90e0: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000c90f0: 6861 7368 5f73 7461 7274 2021 3d20 7572  hash_start != ur
-000c9100: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000c9110: 6974 7465 6429 207b 0a20 2020 206c 696e  itted) {.    lin
-000c9120: 6531 5b63 6f6d 706f 6e65 6e74 732e 6861  e1[components.ha
-000c9130: 7368 5f73 7461 7274 5d20 3d20 277c 273b  sh_start] = '|';
-000c9140: 0a20 207d 0a20 2069 6620 2863 6f6d 706f  .  }.  if (compo
-000c9150: 6e65 6e74 732e 7365 6172 6368 5f73 7461  nents.search_sta
-000c9160: 7274 2021 3d20 7572 6c5f 636f 6d70 6f6e  rt != url_compon
-000c9170: 656e 7473 3a3a 6f6d 6974 7465 6429 207b  ents::omitted) {
-000c9180: 0a20 2020 206c 696e 6531 5b63 6f6d 706f  .    line1[compo
-000c9190: 6e65 6e74 732e 7365 6172 6368 5f73 7461  nents.search_sta
-000c91a0: 7274 5d20 3d20 277c 273b 0a20 207d 0a20  rt] = '|';.  }. 
-000c91b0: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000c91c0: 7061 7468 6e61 6d65 5f73 7461 7274 2021  pathname_start !
-000c91d0: 3d20 6275 6666 6572 2e73 697a 6528 2929  = buffer.size())
-000c91e0: 207b 0a20 2020 206c 696e 6531 5b63 6f6d   {.    line1[com
-000c91f0: 706f 6e65 6e74 732e 7061 7468 6e61 6d65  ponents.pathname
-000c9200: 5f73 7461 7274 5d20 3d20 277c 273b 0a20  _start] = '|';. 
-000c9210: 207d 0a20 2069 6620 2863 6f6d 706f 6e65   }.  if (compone
-000c9220: 6e74 732e 686f 7374 5f65 6e64 2021 3d20  nts.host_end != 
-000c9230: 6275 6666 6572 2e73 697a 6528 2929 207b  buffer.size()) {
-000c9240: 0a20 2020 206c 696e 6531 5b63 6f6d 706f  .    line1[compo
-000c9250: 6e65 6e74 732e 686f 7374 5f65 6e64 5d20  nents.host_end] 
-000c9260: 3d20 277c 273b 0a20 207d 0a20 2069 6620  = '|';.  }.  if 
-000c9270: 2863 6f6d 706f 6e65 6e74 732e 686f 7374  (components.host
-000c9280: 5f73 7461 7274 2021 3d20 6275 6666 6572  _start != buffer
-000c9290: 2e73 697a 6528 2929 207b 0a20 2020 206c  .size()) {.    l
-000c92a0: 696e 6531 5b63 6f6d 706f 6e65 6e74 732e  ine1[components.
-000c92b0: 686f 7374 5f73 7461 7274 5d20 3d20 277c  host_start] = '|
-000c92c0: 273b 0a20 207d 0a20 2069 6620 2863 6f6d  ';.  }.  if (com
-000c92d0: 706f 6e65 6e74 732e 7573 6572 6e61 6d65  ponents.username
-000c92e0: 5f65 6e64 2021 3d20 6275 6666 6572 2e73  _end != buffer.s
-000c92f0: 697a 6528 2929 207b 0a20 2020 206c 696e  ize()) {.    lin
-000c9300: 6531 5b63 6f6d 706f 6e65 6e74 732e 7573  e1[components.us
-000c9310: 6572 6e61 6d65 5f65 6e64 5d20 3d20 277c  ername_end] = '|
-000c9320: 273b 0a20 207d 0a20 2069 6620 2863 6f6d  ';.  }.  if (com
-000c9330: 706f 6e65 6e74 732e 7072 6f74 6f63 6f6c  ponents.protocol
-000c9340: 5f65 6e64 2021 3d20 6275 6666 6572 2e73  _end != buffer.s
-000c9350: 697a 6528 2929 207b 0a20 2020 206c 696e  ize()) {.    lin
-000c9360: 6531 5b63 6f6d 706f 6e65 6e74 732e 7072  e1[components.pr
-000c9370: 6f74 6f63 6f6c 5f65 6e64 5d20 3d20 277c  otocol_end] = '|
-000c9380: 273b 0a20 207d 0a20 2061 6e73 7765 722e  ';.  }.  answer.
-000c9390: 6170 7065 6e64 286c 696e 6531 293b 0a20  append(line1);. 
-000c93a0: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000c93b0: 5c6e 2229 3b0a 0a20 2073 7464 3a3a 7374  \n");..  std::st
-000c93c0: 7269 6e67 206c 696e 6532 203d 206c 696e  ring line2 = lin
-000c93d0: 6531 3b0a 2020 6966 2028 636f 6d70 6f6e  e1;.  if (compon
-000c93e0: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
-000c93f0: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
-000c9400: 733a 3a6f 6d69 7474 6564 2920 7b0a 2020  s::omitted) {.  
-000c9410: 2020 6c69 6e65 325b 636f 6d70 6f6e 656e    line2[componen
-000c9420: 7473 2e68 6173 685f 7374 6172 745d 203d  ts.hash_start] =
-000c9430: 2027 6027 3b0a 2020 2020 6c69 6e65 315b   '`';.    line1[
-000c9440: 636f 6d70 6f6e 656e 7473 2e68 6173 685f  components.hash_
-000c9450: 7374 6172 745d 203d 2027 2027 3b0a 0a20  start] = ' ';.. 
-000c9460: 2020 2066 6f72 2028 7369 7a65 5f74 2069     for (size_t i
-000c9470: 203d 2063 6f6d 706f 6e65 6e74 732e 6861   = components.ha
-000c9480: 7368 5f73 7461 7274 202b 2031 3b20 6920  sh_start + 1; i 
-000c9490: 3c20 6c69 6e65 322e 7369 7a65 2829 3b20  < line2.size(); 
-000c94a0: 692b 2b29 207b 0a20 2020 2020 206c 696e  i++) {.      lin
-000c94b0: 6532 5b69 5d20 3d20 272d 273b 0a20 2020  e2[i] = '-';.   
-000c94c0: 207d 0a20 2020 206c 696e 6532 2e61 7070   }.    line2.app
-000c94d0: 656e 6428 2220 6861 7368 5f73 7461 7274  end(" hash_start
-000c94e0: 2229 3b0a 2020 2020 616e 7377 6572 2e61  ");.    answer.a
-000c94f0: 7070 656e 6428 6c69 6e65 3229 3b0a 2020  ppend(line2);.  
-000c9500: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
-000c9510: 225c 6e22 293b 0a20 207d 0a0a 2020 7374  "\n");.  }..  st
-000c9520: 643a 3a73 7472 696e 6720 6c69 6e65 3320  d::string line3 
-000c9530: 3d20 6c69 6e65 313b 0a20 2069 6620 2863  = line1;.  if (c
-000c9540: 6f6d 706f 6e65 6e74 732e 7365 6172 6368  omponents.search
-000c9550: 5f73 7461 7274 2021 3d20 7572 6c5f 636f  _start != url_co
-000c9560: 6d70 6f6e 656e 7473 3a3a 6f6d 6974 7465  mponents::omitte
-000c9570: 6429 207b 0a20 2020 206c 696e 6533 5b63  d) {.    line3[c
-000c9580: 6f6d 706f 6e65 6e74 732e 7365 6172 6368  omponents.search
-000c9590: 5f73 7461 7274 5d20 3d20 2760 273b 0a20  _start] = '`';. 
-000c95a0: 2020 206c 696e 6531 5b63 6f6d 706f 6e65     line1[compone
-000c95b0: 6e74 732e 7365 6172 6368 5f73 7461 7274  nts.search_start
-000c95c0: 5d20 3d20 2720 273b 0a0a 2020 2020 666f  ] = ' ';..    fo
-000c95d0: 7220 2873 697a 655f 7420 6920 3d20 636f  r (size_t i = co
-000c95e0: 6d70 6f6e 656e 7473 2e73 6561 7263 685f  mponents.search_
-000c95f0: 7374 6172 7420 2b20 313b 2069 203c 206c  start + 1; i < l
-000c9600: 696e 6533 2e73 697a 6528 293b 2069 2b2b  ine3.size(); i++
-000c9610: 2920 7b0a 2020 2020 2020 6c69 6e65 335b  ) {.      line3[
-000c9620: 695d 203d 2027 2d27 3b0a 2020 2020 7d0a  i] = '-';.    }.
-000c9630: 2020 2020 6c69 6e65 332e 6170 7065 6e64      line3.append
-000c9640: 2822 2073 6561 7263 685f 7374 6172 7420  (" search_start 
-000c9650: 2229 3b0a 2020 2020 6c69 6e65 332e 6170  ");.    line3.ap
-000c9660: 7065 6e64 2873 7464 3a3a 746f 5f73 7472  pend(std::to_str
-000c9670: 696e 6728 636f 6d70 6f6e 656e 7473 2e73  ing(components.s
-000c9680: 6561 7263 685f 7374 6172 7429 293b 0a20  earch_start));. 
-000c9690: 2020 2061 6e73 7765 722e 6170 7065 6e64     answer.append
-000c96a0: 286c 696e 6533 293b 0a20 2020 2061 6e73  (line3);.    ans
-000c96b0: 7765 722e 6170 7065 6e64 2822 5c6e 2229  wer.append("\n")
-000c96c0: 3b0a 2020 7d0a 0a20 2073 7464 3a3a 7374  ;.  }..  std::st
-000c96d0: 7269 6e67 206c 696e 6534 203d 206c 696e  ring line4 = lin
-000c96e0: 6531 3b0a 2020 6966 2028 636f 6d70 6f6e  e1;.  if (compon
-000c96f0: 656e 7473 2e70 6174 686e 616d 655f 7374  ents.pathname_st
-000c9700: 6172 7420 213d 2062 7566 6665 722e 7369  art != buffer.si
-000c9710: 7a65 2829 2920 7b0a 2020 2020 6c69 6e65  ze()) {.    line
-000c9720: 345b 636f 6d70 6f6e 656e 7473 2e70 6174  4[components.pat
-000c9730: 686e 616d 655f 7374 6172 745d 203d 2027  hname_start] = '
-000c9740: 6027 3b0a 2020 2020 6c69 6e65 315b 636f  `';.    line1[co
-000c9750: 6d70 6f6e 656e 7473 2e70 6174 686e 616d  mponents.pathnam
-000c9760: 655f 7374 6172 745d 203d 2027 2027 3b0a  e_start] = ' ';.
-000c9770: 2020 2020 666f 7220 2873 697a 655f 7420      for (size_t 
-000c9780: 6920 3d20 636f 6d70 6f6e 656e 7473 2e70  i = components.p
-000c9790: 6174 686e 616d 655f 7374 6172 7420 2b20  athname_start + 
-000c97a0: 313b 2069 203c 206c 696e 6534 2e73 697a  1; i < line4.siz
-000c97b0: 6528 293b 2069 2b2b 2920 7b0a 2020 2020  e(); i++) {.    
-000c97c0: 2020 6c69 6e65 345b 695d 203d 2027 2d27    line4[i] = '-'
-000c97d0: 3b0a 2020 2020 7d0a 2020 2020 6c69 6e65  ;.    }.    line
-000c97e0: 342e 6170 7065 6e64 2822 2070 6174 686e  4.append(" pathn
-000c97f0: 616d 655f 7374 6172 7420 2229 3b0a 2020  ame_start ");.  
-000c9800: 2020 6c69 6e65 342e 6170 7065 6e64 2873    line4.append(s
-000c9810: 7464 3a3a 746f 5f73 7472 696e 6728 636f  td::to_string(co
-000c9820: 6d70 6f6e 656e 7473 2e70 6174 686e 616d  mponents.pathnam
-000c9830: 655f 7374 6172 7429 293b 0a20 2020 2061  e_start));.    a
-000c9840: 6e73 7765 722e 6170 7065 6e64 286c 696e  nswer.append(lin
-000c9850: 6534 293b 0a20 2020 2061 6e73 7765 722e  e4);.    answer.
-000c9860: 6170 7065 6e64 2822 5c6e 2229 3b0a 2020  append("\n");.  
-000c9870: 7d0a 0a20 2073 7464 3a3a 7374 7269 6e67  }..  std::string
-000c9880: 206c 696e 6535 203d 206c 696e 6531 3b0a   line5 = line1;.
-000c9890: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
-000c98a0: 2e68 6f73 745f 656e 6420 213d 2062 7566  .host_end != buf
-000c98b0: 6665 722e 7369 7a65 2829 2920 7b0a 2020  fer.size()) {.  
-000c98c0: 2020 6c69 6e65 355b 636f 6d70 6f6e 656e    line5[componen
-000c98d0: 7473 2e68 6f73 745f 656e 645d 203d 2027  ts.host_end] = '
-000c98e0: 6027 3b0a 2020 2020 6c69 6e65 315b 636f  `';.    line1[co
-000c98f0: 6d70 6f6e 656e 7473 2e68 6f73 745f 656e  mponents.host_en
-000c9900: 645d 203d 2027 2027 3b0a 0a20 2020 2066  d] = ' ';..    f
-000c9910: 6f72 2028 7369 7a65 5f74 2069 203d 2063  or (size_t i = c
-000c9920: 6f6d 706f 6e65 6e74 732e 686f 7374 5f65  omponents.host_e
-000c9930: 6e64 202b 2031 3b20 6920 3c20 6c69 6e65  nd + 1; i < line
-000c9940: 352e 7369 7a65 2829 3b20 692b 2b29 207b  5.size(); i++) {
-000c9950: 0a20 2020 2020 206c 696e 6535 5b69 5d20  .      line5[i] 
-000c9960: 3d20 272d 273b 0a20 2020 207d 0a20 2020  = '-';.    }.   
-000c9970: 206c 696e 6535 2e61 7070 656e 6428 2220   line5.append(" 
-000c9980: 686f 7374 5f65 6e64 2022 293b 0a20 2020  host_end ");.   
-000c9990: 206c 696e 6535 2e61 7070 656e 6428 7374   line5.append(st
-000c99a0: 643a 3a74 6f5f 7374 7269 6e67 2863 6f6d  d::to_string(com
-000c99b0: 706f 6e65 6e74 732e 686f 7374 5f65 6e64  ponents.host_end
-000c99c0: 2929 3b0a 2020 2020 616e 7377 6572 2e61  ));.    answer.a
-000c99d0: 7070 656e 6428 6c69 6e65 3529 3b0a 2020  ppend(line5);.  
-000c99e0: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
-000c99f0: 225c 6e22 293b 0a20 207d 0a0a 2020 7374  "\n");.  }..  st
-000c9a00: 643a 3a73 7472 696e 6720 6c69 6e65 3620  d::string line6 
-000c9a10: 3d20 6c69 6e65 313b 0a20 2069 6620 2863  = line1;.  if (c
-000c9a20: 6f6d 706f 6e65 6e74 732e 686f 7374 5f73  omponents.host_s
-000c9a30: 7461 7274 2021 3d20 6275 6666 6572 2e73  tart != buffer.s
-000c9a40: 697a 6528 2929 207b 0a20 2020 206c 696e  ize()) {.    lin
-000c9a50: 6536 5b63 6f6d 706f 6e65 6e74 732e 686f  e6[components.ho
-000c9a60: 7374 5f73 7461 7274 5d20 3d20 2760 273b  st_start] = '`';
-000c9a70: 0a20 2020 206c 696e 6531 5b63 6f6d 706f  .    line1[compo
-000c9a80: 6e65 6e74 732e 686f 7374 5f73 7461 7274  nents.host_start
-000c9a90: 5d20 3d20 2720 273b 0a0a 2020 2020 666f  ] = ' ';..    fo
-000c9aa0: 7220 2873 697a 655f 7420 6920 3d20 636f  r (size_t i = co
-000c9ab0: 6d70 6f6e 656e 7473 2e68 6f73 745f 7374  mponents.host_st
-000c9ac0: 6172 7420 2b20 313b 2069 203c 206c 696e  art + 1; i < lin
-000c9ad0: 6536 2e73 697a 6528 293b 2069 2b2b 2920  e6.size(); i++) 
-000c9ae0: 7b0a 2020 2020 2020 6c69 6e65 365b 695d  {.      line6[i]
-000c9af0: 203d 2027 2d27 3b0a 2020 2020 7d0a 2020   = '-';.    }.  
-000c9b00: 2020 6c69 6e65 362e 6170 7065 6e64 2822    line6.append("
-000c9b10: 2068 6f73 745f 7374 6172 7420 2229 3b0a   host_start ");.
-000c9b20: 2020 2020 6c69 6e65 362e 6170 7065 6e64      line6.append
-000c9b30: 2873 7464 3a3a 746f 5f73 7472 696e 6728  (std::to_string(
-000c9b40: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
-000c9b50: 7374 6172 7429 293b 0a20 2020 2061 6e73  start));.    ans
-000c9b60: 7765 722e 6170 7065 6e64 286c 696e 6536  wer.append(line6
-000c9b70: 293b 0a20 2020 2061 6e73 7765 722e 6170  );.    answer.ap
-000c9b80: 7065 6e64 2822 5c6e 2229 3b0a 2020 7d0a  pend("\n");.  }.
-000c9b90: 0a20 2073 7464 3a3a 7374 7269 6e67 206c  .  std::string l
-000c9ba0: 696e 6537 203d 206c 696e 6531 3b0a 2020  ine7 = line1;.  
-000c9bb0: 6966 2028 636f 6d70 6f6e 656e 7473 2e75  if (components.u
-000c9bc0: 7365 726e 616d 655f 656e 6420 213d 2062  sername_end != b
-000c9bd0: 7566 6665 722e 7369 7a65 2829 2920 7b0a  uffer.size()) {.
-000c9be0: 2020 2020 6c69 6e65 375b 636f 6d70 6f6e      line7[compon
-000c9bf0: 656e 7473 2e75 7365 726e 616d 655f 656e  ents.username_en
-000c9c00: 645d 203d 2027 6027 3b0a 2020 2020 6c69  d] = '`';.    li
-000c9c10: 6e65 315b 636f 6d70 6f6e 656e 7473 2e75  ne1[components.u
-000c9c20: 7365 726e 616d 655f 656e 645d 203d 2027  sername_end] = '
-000c9c30: 2027 3b0a 0a20 2020 2066 6f72 2028 7369   ';..    for (si
-000c9c40: 7a65 5f74 2069 203d 2063 6f6d 706f 6e65  ze_t i = compone
-000c9c50: 6e74 732e 7573 6572 6e61 6d65 5f65 6e64  nts.username_end
-000c9c60: 202b 2031 3b20 6920 3c20 6c69 6e65 372e   + 1; i < line7.
-000c9c70: 7369 7a65 2829 3b20 692b 2b29 207b 0a20  size(); i++) {. 
-000c9c80: 2020 2020 206c 696e 6537 5b69 5d20 3d20       line7[i] = 
-000c9c90: 272d 273b 0a20 2020 207d 0a20 2020 206c  '-';.    }.    l
-000c9ca0: 696e 6537 2e61 7070 656e 6428 2220 7573  ine7.append(" us
-000c9cb0: 6572 6e61 6d65 5f65 6e64 2022 293b 0a20  ername_end ");. 
-000c9cc0: 2020 206c 696e 6537 2e61 7070 656e 6428     line7.append(
-000c9cd0: 7374 643a 3a74 6f5f 7374 7269 6e67 2863  std::to_string(c
-000c9ce0: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
-000c9cf0: 6d65 5f65 6e64 2929 3b0a 2020 2020 616e  me_end));.    an
-000c9d00: 7377 6572 2e61 7070 656e 6428 6c69 6e65  swer.append(line
-000c9d10: 3729 3b0a 2020 2020 616e 7377 6572 2e61  7);.    answer.a
-000c9d20: 7070 656e 6428 225c 6e22 293b 0a20 207d  ppend("\n");.  }
-000c9d30: 0a0a 2020 7374 643a 3a73 7472 696e 6720  ..  std::string 
-000c9d40: 6c69 6e65 3820 3d20 6c69 6e65 313b 0a20  line8 = line1;. 
-000c9d50: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000c9d60: 7072 6f74 6f63 6f6c 5f65 6e64 2021 3d20  protocol_end != 
-000c9d70: 6275 6666 6572 2e73 697a 6528 2929 207b  buffer.size()) {
-000c9d80: 0a20 2020 206c 696e 6538 5b63 6f6d 706f  .    line8[compo
-000c9d90: 6e65 6e74 732e 7072 6f74 6f63 6f6c 5f65  nents.protocol_e
-000c9da0: 6e64 5d20 3d20 2760 273b 0a20 2020 206c  nd] = '`';.    l
-000c9db0: 696e 6531 5b63 6f6d 706f 6e65 6e74 732e  ine1[components.
-000c9dc0: 7072 6f74 6f63 6f6c 5f65 6e64 5d20 3d20  protocol_end] = 
-000c9dd0: 2720 273b 0a0a 2020 2020 666f 7220 2873  ' ';..    for (s
-000c9de0: 697a 655f 7420 6920 3d20 636f 6d70 6f6e  ize_t i = compon
-000c9df0: 656e 7473 2e70 726f 746f 636f 6c5f 656e  ents.protocol_en
-000c9e00: 6420 2b20 313b 2069 203c 206c 696e 6538  d + 1; i < line8
-000c9e10: 2e73 697a 6528 293b 2069 2b2b 2920 7b0a  .size(); i++) {.
-000c9e20: 2020 2020 2020 6c69 6e65 385b 695d 203d        line8[i] =
-000c9e30: 2027 2d27 3b0a 2020 2020 7d0a 2020 2020   '-';.    }.    
-000c9e40: 6c69 6e65 382e 6170 7065 6e64 2822 2070  line8.append(" p
-000c9e50: 726f 746f 636f 6c5f 656e 6420 2229 3b0a  rotocol_end ");.
-000c9e60: 2020 2020 6c69 6e65 382e 6170 7065 6e64      line8.append
-000c9e70: 2873 7464 3a3a 746f 5f73 7472 696e 6728  (std::to_string(
-000c9e80: 636f 6d70 6f6e 656e 7473 2e70 726f 746f  components.proto
-000c9e90: 636f 6c5f 656e 6429 293b 0a20 2020 2061  col_end));.    a
-000c9ea0: 6e73 7765 722e 6170 7065 6e64 286c 696e  nswer.append(lin
-000c9eb0: 6538 293b 0a20 2020 2061 6e73 7765 722e  e8);.    answer.
-000c9ec0: 6170 7065 6e64 2822 5c6e 2229 3b0a 2020  append("\n");.  
-000c9ed0: 7d0a 0a20 2069 6620 2863 6f6d 706f 6e65  }..  if (compone
-000c9ee0: 6e74 732e 6861 7368 5f73 7461 7274 203d  nts.hash_start =
-000c9ef0: 3d20 7572 6c5f 636f 6d70 6f6e 656e 7473  = url_components
-000c9f00: 3a3a 6f6d 6974 7465 6429 207b 0a20 2020  ::omitted) {.   
-000c9f10: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
-000c9f20: 6e6f 7465 3a20 6861 7368 206f 6d69 7474  note: hash omitt
-000c9f30: 6564 5c6e 2229 3b0a 2020 7d0a 2020 6966  ed\n");.  }.  if
-000c9f40: 2028 636f 6d70 6f6e 656e 7473 2e73 6561   (components.sea
-000c9f50: 7263 685f 7374 6172 7420 3d3d 2075 726c  rch_start == url
-000c9f60: 5f63 6f6d 706f 6e65 6e74 733a 3a6f 6d69  _components::omi
-000c9f70: 7474 6564 2920 7b0a 2020 2020 616e 7377  tted) {.    answ
-000c9f80: 6572 2e61 7070 656e 6428 226e 6f74 653a  er.append("note:
-000c9f90: 2073 6561 7263 6820 6f6d 6974 7465 645c   search omitted\
-000c9fa0: 6e22 293b 0a20 207d 0a20 2069 6620 2863  n");.  }.  if (c
-000c9fb0: 6f6d 706f 6e65 6e74 732e 7072 6f74 6f63  omponents.protoc
-000c9fc0: 6f6c 5f65 6e64 203e 2062 7566 6665 722e  ol_end > buffer.
-000c9fd0: 7369 7a65 2829 2920 7b0a 2020 2020 616e  size()) {.    an
-000c9fe0: 7377 6572 2e61 7070 656e 6428 2277 6172  swer.append("war
-000c9ff0: 6e69 6e67 3a20 7072 6f74 6f63 6f6c 5f65  ning: protocol_e
-000ca000: 6e64 206f 7665 7266 6c6f 7773 5c6e 2229  nd overflows\n")
-000ca010: 3b0a 2020 7d0a 2020 6966 2028 636f 6d70  ;.  }.  if (comp
-000ca020: 6f6e 656e 7473 2e75 7365 726e 616d 655f  onents.username_
-000ca030: 656e 6420 3e20 6275 6666 6572 2e73 697a  end > buffer.siz
-000ca040: 6528 2929 207b 0a20 2020 2061 6e73 7765  e()) {.    answe
-000ca050: 722e 6170 7065 6e64 2822 7761 726e 696e  r.append("warnin
-000ca060: 673a 2075 7365 726e 616d 655f 656e 6420  g: username_end 
-000ca070: 6f76 6572 666c 6f77 735c 6e22 293b 0a20  overflows\n");. 
-000ca080: 207d 0a20 2069 6620 2863 6f6d 706f 6e65   }.  if (compone
-000ca090: 6e74 732e 686f 7374 5f73 7461 7274 203e  nts.host_start >
-000ca0a0: 2062 7566 6665 722e 7369 7a65 2829 2920   buffer.size()) 
-000ca0b0: 7b0a 2020 2020 616e 7377 6572 2e61 7070  {.    answer.app
-000ca0c0: 656e 6428 2277 6172 6e69 6e67 3a20 686f  end("warning: ho
-000ca0d0: 7374 5f73 7461 7274 206f 7665 7266 6c6f  st_start overflo
-000ca0e0: 7773 5c6e 2229 3b0a 2020 7d0a 2020 6966  ws\n");.  }.  if
-000ca0f0: 2028 636f 6d70 6f6e 656e 7473 2e68 6f73   (components.hos
-000ca100: 745f 656e 6420 3e20 6275 6666 6572 2e73  t_end > buffer.s
-000ca110: 697a 6528 2929 207b 0a20 2020 2061 6e73  ize()) {.    ans
-000ca120: 7765 722e 6170 7065 6e64 2822 7761 726e  wer.append("warn
-000ca130: 696e 673a 2068 6f73 745f 656e 6420 6f76  ing: host_end ov
-000ca140: 6572 666c 6f77 735c 6e22 293b 0a20 207d  erflows\n");.  }
-000ca150: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
-000ca160: 732e 7061 7468 6e61 6d65 5f73 7461 7274  s.pathname_start
-000ca170: 203e 2062 7566 6665 722e 7369 7a65 2829   > buffer.size()
-000ca180: 2920 7b0a 2020 2020 616e 7377 6572 2e61  ) {.    answer.a
-000ca190: 7070 656e 6428 2277 6172 6e69 6e67 3a20  ppend("warning: 
-000ca1a0: 7061 7468 6e61 6d65 5f73 7461 7274 206f  pathname_start o
-000ca1b0: 7665 7266 6c6f 7773 5c6e 2229 3b0a 2020  verflows\n");.  
-000ca1c0: 7d0a 2020 7265 7475 726e 2061 6e73 7765  }.  return answe
-000ca1d0: 723b 0a7d 0a0a 626f 6f6c 2075 726c 5f61  r;.}..bool url_a
-000ca1e0: 6767 7265 6761 746f 723a 3a76 616c 6964  ggregator::valid
-000ca1f0: 6174 6528 2920 636f 6e73 7420 6e6f 6578  ate() const noex
-000ca200: 6365 7074 207b 0a20 2069 6620 2821 6973  cept {.  if (!is
-000ca210: 5f76 616c 6964 2920 7b0a 2020 2020 7265  _valid) {.    re
-000ca220: 7475 726e 2074 7275 653b 0a20 207d 0a20  turn true;.  }. 
-000ca230: 2069 6620 2821 636f 6d70 6f6e 656e 7473   if (!components
-000ca240: 2e63 6865 636b 5f6f 6666 7365 745f 636f  .check_offset_co
-000ca250: 6e73 6973 7465 6e63 7928 2929 207b 0a20  nsistency()) {. 
-000ca260: 2020 2061 6461 5f6c 6f67 2822 7572 6c5f     ada_log("url_
-000ca270: 6167 6772 6567 6174 6f72 3a3a 7661 6c69  aggregator::vali
-000ca280: 6461 7465 2069 6e63 6f6e 7369 7374 656e  date inconsisten
-000ca290: 7420 636f 6d70 6f6e 656e 7473 205c 6e22  t components \n"
-000ca2a0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-000ca2b0: 5f64 6961 6772 616d 2829 293b 0a20 2020  _diagram());.   
-000ca2c0: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
-000ca2d0: 207d 0a20 202f 2f20 5765 2068 6176 6520   }.  // We have 
-000ca2e0: 6120 6372 6564 6962 6c65 2063 6f6d 706f  a credible compo
-000ca2f0: 6e65 6e74 7320 7374 7275 6374 2c20 6275  nents struct, bu
-000ca300: 7420 6c65 7420 7573 2069 6e76 6573 7469  t let us investi
-000ca310: 7661 7465 206d 6f72 650a 2020 2f2f 2063  vate more.  // c
-000ca320: 6172 6566 756c 6c79 3a0a 2020 2f2a 2a0a  arefully:.  /**.
-000ca330: 2020 202a 2068 7474 7073 3a2f 2f75 7365     * https://use
-000ca340: 723a 7061 7373 4065 7861 6d70 6c65 2e63  r:pass@example.c
-000ca350: 6f6d 3a31 3233 342f 666f 6f2f 6261 723f  om:1234/foo/bar?
-000ca360: 6261 7a23 7175 7578 0a20 2020 2a20 2020  baz#quux.   *   
-000ca370: 2020 2020 7c20 2020 2020 7c20 2020 207c      |     |    |
-000ca380: 2020 2020 2020 2020 2020 7c20 5e5e 5e5e            | ^^^^
-000ca390: 7c20 2020 2020 2020 7c20 2020 7c0a 2020  |       |   |.  
-000ca3a0: 202a 2020 2020 2020 207c 2020 2020 207c   *       |     |
-000ca3b0: 2020 2020 7c20 2020 2020 2020 2020 207c      |          |
-000ca3c0: 207c 2020 207c 2020 2020 2020 207c 2020   |   |       |  
-000ca3d0: 2060 2d2d 2d2d 2d20 6861 7368 5f73 7461   `----- hash_sta
-000ca3e0: 7274 0a20 2020 2a20 2020 2020 2020 7c20  rt.   *       | 
-000ca3f0: 2020 2020 7c20 2020 207c 2020 2020 2020      |    |      
-000ca400: 2020 2020 7c20 7c20 2020 7c20 2020 2020      | |   |     
-000ca410: 2020 602d 2d2d 2d2d 2d2d 2d2d 2073 6561    `--------- sea
-000ca420: 7263 685f 7374 6172 740a 2020 202a 2020  rch_start.   *  
-000ca430: 2020 2020 207c 2020 2020 207c 2020 2020       |     |    
-000ca440: 7c20 2020 2020 2020 2020 207c 207c 2020  |          | |  
-000ca450: 2060 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   `--------------
-000ca460: 2d2d 2d20 7061 7468 6e61 6d65 5f73 7461  --- pathname_sta
-000ca470: 7274 0a20 2020 2a20 2020 2020 2020 7c20  rt.   *       | 
-000ca480: 2020 2020 7c20 2020 207c 2020 2020 2020      |    |      
-000ca490: 2020 2020 7c20 602d 2d2d 2d2d 2d2d 2d2d      | `---------
-000ca4a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2070 6f72  ------------ por
-000ca4b0: 740a 2020 202a 2020 2020 2020 207c 2020  t.   *       |  
-000ca4c0: 2020 207c 2020 2020 7c20 2020 2020 2020     |    |       
-000ca4d0: 2020 2060 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     `------------
-000ca4e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 686f 7374  ----------- host
-000ca4f0: 5f65 6e64 0a20 2020 2a20 2020 2020 2020  _end.   *       
-000ca500: 7c20 2020 2020 7c20 2020 2060 2d2d 2d2d  |     |    `----
-000ca510: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000ca520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2068  -------------- h
-000ca530: 6f73 745f 7374 6172 740a 2020 202a 2020  ost_start.   *  
-000ca540: 2020 2020 207c 2020 2020 2060 2d2d 2d2d       |     `----
-000ca550: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000ca560: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000ca570: 2d2d 2d20 7573 6572 6e61 6d65 5f65 6e64  --- username_end
-000ca580: 0a20 2020 2a20 2020 2020 2020 602d 2d2d  .   *       `---
-000ca590: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000ca5a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000ca5b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2070 726f 746f  ---------- proto
-000ca5c0: 636f 6c5f 656e 640a 2020 202a 2f0a 2020  col_end.   */.  
-000ca5d0: 6966 2028 636f 6d70 6f6e 656e 7473 2e70  if (components.p
-000ca5e0: 726f 746f 636f 6c5f 656e 6420 3d3d 2075  rotocol_end == u
-000ca5f0: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
-000ca600: 6d69 7474 6564 2920 7b0a 2020 2020 6164  mitted) {.    ad
-000ca610: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
-000ca620: 6761 746f 723a 3a76 616c 6964 6174 6520  gator::validate 
-000ca630: 6f6d 6974 7465 6420 7072 6f74 6f63 6f6c  omitted protocol
-000ca640: 5f65 6e64 205c 6e22 2c20 746f 5f64 6961  _end \n", to_dia
-000ca650: 6772 616d 2829 293b 0a20 2020 2072 6574  gram());.    ret
-000ca660: 7572 6e20 6661 6c73 653b 0a20 207d 0a20  urn false;.  }. 
-000ca670: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000ca680: 7573 6572 6e61 6d65 5f65 6e64 203d 3d20  username_end == 
-000ca690: 7572 6c5f 636f 6d70 6f6e 656e 7473 3a3a  url_components::
-000ca6a0: 6f6d 6974 7465 6429 207b 0a20 2020 2061  omitted) {.    a
-000ca6b0: 6461 5f6c 6f67 2822 7572 6c5f 6167 6772  da_log("url_aggr
-000ca6c0: 6567 6174 6f72 3a3a 7661 6c69 6461 7465  egator::validate
-000ca6d0: 206f 6d69 7474 6564 2075 7365 726e 616d   omitted usernam
-000ca6e0: 655f 656e 6420 5c6e 222c 2074 6f5f 6469  e_end \n", to_di
-000ca6f0: 6167 7261 6d28 2929 3b0a 2020 2020 7265  agram());.    re
-000ca700: 7475 726e 2066 616c 7365 3b0a 2020 7d0a  turn false;.  }.
-000ca710: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
-000ca720: 2e68 6f73 745f 7374 6172 7420 3d3d 2075  .host_start == u
-000ca730: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
-000ca740: 6d69 7474 6564 2920 7b0a 2020 2020 6164  mitted) {.    ad
-000ca750: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
-000ca760: 6761 746f 723a 3a76 616c 6964 6174 6520  gator::validate 
-000ca770: 6f6d 6974 7465 6420 686f 7374 5f73 7461  omitted host_sta
-000ca780: 7274 205c 6e22 2c20 746f 5f64 6961 6772  rt \n", to_diagr
-000ca790: 616d 2829 293b 0a20 2020 2072 6574 7572  am());.    retur
-000ca7a0: 6e20 6661 6c73 653b 0a20 207d 0a20 2069  n false;.  }.  i
-000ca7b0: 6620 2863 6f6d 706f 6e65 6e74 732e 686f  f (components.ho
-000ca7c0: 7374 5f65 6e64 203d 3d20 7572 6c5f 636f  st_end == url_co
-000ca7d0: 6d70 6f6e 656e 7473 3a3a 6f6d 6974 7465  mponents::omitte
-000ca7e0: 6429 207b 0a20 2020 2061 6461 5f6c 6f67  d) {.    ada_log
-000ca7f0: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
-000ca800: 3a3a 7661 6c69 6461 7465 206f 6d69 7474  ::validate omitt
-000ca810: 6564 2068 6f73 745f 656e 6420 5c6e 222c  ed host_end \n",
-000ca820: 2074 6f5f 6469 6167 7261 6d28 2929 3b0a   to_diagram());.
-000ca830: 2020 2020 7265 7475 726e 2066 616c 7365      return false
-000ca840: 3b0a 2020 7d0a 2020 6966 2028 636f 6d70  ;.  }.  if (comp
-000ca850: 6f6e 656e 7473 2e70 6174 686e 616d 655f  onents.pathname_
-000ca860: 7374 6172 7420 3d3d 2075 726c 5f63 6f6d  start == url_com
-000ca870: 706f 6e65 6e74 733a 3a6f 6d69 7474 6564  ponents::omitted
-000ca880: 2920 7b0a 2020 2020 6164 615f 6c6f 6728  ) {.    ada_log(
-000ca890: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
-000ca8a0: 3a76 616c 6964 6174 6520 6f6d 6974 7465  :validate omitte
-000ca8b0: 6420 7061 7468 6e61 6d65 5f73 7461 7274  d pathname_start
-000ca8c0: 205c 6e22 2c20 746f 5f64 6961 6772 616d   \n", to_diagram
-000ca8d0: 2829 293b 0a20 2020 2072 6574 7572 6e20  ());.    return 
-000ca8e0: 6661 6c73 653b 0a20 207d 0a0a 2020 6966  false;.  }..  if
-000ca8f0: 2028 636f 6d70 6f6e 656e 7473 2e70 726f   (components.pro
-000ca900: 746f 636f 6c5f 656e 6420 3e20 6275 6666  tocol_end > buff
-000ca910: 6572 2e73 697a 6528 2929 207b 0a20 2020  er.size()) {.   
-000ca920: 2061 6461 5f6c 6f67 2822 7572 6c5f 6167   ada_log("url_ag
-000ca930: 6772 6567 6174 6f72 3a3a 7661 6c69 6461  gregator::valida
-000ca940: 7465 2070 726f 746f 636f 6c5f 656e 6420  te protocol_end 
-000ca950: 6f76 6572 666c 6f77 205c 6e22 2c20 746f  overflow \n", to
-000ca960: 5f64 6961 6772 616d 2829 293b 0a20 2020  _diagram());.   
-000ca970: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
-000ca980: 207d 0a20 2069 6620 2863 6f6d 706f 6e65   }.  if (compone
-000ca990: 6e74 732e 7573 6572 6e61 6d65 5f65 6e64  nts.username_end
-000ca9a0: 203e 2062 7566 6665 722e 7369 7a65 2829   > buffer.size()
-000ca9b0: 2920 7b0a 2020 2020 6164 615f 6c6f 6728  ) {.    ada_log(
-000ca9c0: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
-000ca9d0: 3a76 616c 6964 6174 6520 7573 6572 6e61  :validate userna
-000ca9e0: 6d65 5f65 6e64 206f 7665 7266 6c6f 7720  me_end overflow 
-000ca9f0: 5c6e 222c 2074 6f5f 6469 6167 7261 6d28  \n", to_diagram(
-000caa00: 2929 3b0a 2020 2020 7265 7475 726e 2066  ));.    return f
-000caa10: 616c 7365 3b0a 2020 7d0a 2020 6966 2028  alse;.  }.  if (
-000caa20: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
-000caa30: 7374 6172 7420 3e20 6275 6666 6572 2e73  start > buffer.s
-000caa40: 697a 6528 2929 207b 0a20 2020 2061 6461  ize()) {.    ada
-000caa50: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
-000caa60: 6174 6f72 3a3a 7661 6c69 6461 7465 2068  ator::validate h
-000caa70: 6f73 745f 7374 6172 7420 6f76 6572 666c  ost_start overfl
-000caa80: 6f77 205c 6e22 2c20 746f 5f64 6961 6772  ow \n", to_diagr
-000caa90: 616d 2829 293b 0a20 2020 2072 6574 7572  am());.    retur
-000caaa0: 6e20 6661 6c73 653b 0a20 207d 0a20 2069  n false;.  }.  i
-000caab0: 6620 2863 6f6d 706f 6e65 6e74 732e 686f  f (components.ho
-000caac0: 7374 5f65 6e64 203e 2062 7566 6665 722e  st_end > buffer.
-000caad0: 7369 7a65 2829 2920 7b0a 2020 2020 6164  size()) {.    ad
-000caae0: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
-000caaf0: 6761 746f 723a 3a76 616c 6964 6174 6520  gator::validate 
-000cab00: 686f 7374 5f65 6e64 206f 7665 7266 6c6f  host_end overflo
-000cab10: 7720 5c6e 222c 2074 6f5f 6469 6167 7261  w \n", to_diagra
-000cab20: 6d28 2929 3b0a 2020 2020 7265 7475 726e  m());.    return
-000cab30: 2066 616c 7365 3b0a 2020 7d0a 2020 6966   false;.  }.  if
-000cab40: 2028 636f 6d70 6f6e 656e 7473 2e70 6174   (components.pat
-000cab50: 686e 616d 655f 7374 6172 7420 3e20 6275  hname_start > bu
-000cab60: 6666 6572 2e73 697a 6528 2929 207b 0a20  ffer.size()) {. 
-000cab70: 2020 2061 6461 5f6c 6f67 2822 7572 6c5f     ada_log("url_
-000cab80: 6167 6772 6567 6174 6f72 3a3a 7661 6c69  aggregator::vali
-000cab90: 6461 7465 2070 6174 686e 616d 655f 7374  date pathname_st
-000caba0: 6172 7420 6f76 6572 666c 6f77 205c 6e22  art overflow \n"
-000cabb0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-000cabc0: 5f64 6961 6772 616d 2829 293b 0a20 2020  _diagram());.   
-000cabd0: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
-000cabe0: 207d 0a0a 2020 6966 2028 636f 6d70 6f6e   }..  if (compon
-000cabf0: 656e 7473 2e70 726f 746f 636f 6c5f 656e  ents.protocol_en
-000cac00: 6420 3e20 3029 207b 0a20 2020 2069 6620  d > 0) {.    if 
-000cac10: 2862 7566 6665 725b 636f 6d70 6f6e 656e  (buffer[componen
-000cac20: 7473 2e70 726f 746f 636f 6c5f 656e 6420  ts.protocol_end 
-000cac30: 2d20 315d 2021 3d20 273a 2729 207b 0a20  - 1] != ':') {. 
-000cac40: 2020 2020 2061 6461 5f6c 6f67 280a 2020       ada_log(.  
-000cac50: 2020 2020 2020 2020 2275 726c 5f61 6767          "url_agg
-000cac60: 7265 6761 746f 723a 3a76 616c 6964 6174  regator::validat
-000cac70: 6520 6d69 7373 696e 6720 3a20 6174 2074  e missing : at t
-000cac80: 6865 2065 6e64 206f 6620 7468 6520 7072  he end of the pr
-000cac90: 6f74 6f63 6f6c 205c 6e22 2c0a 2020 2020  otocol \n",.    
-000caca0: 2020 2020 2020 746f 5f64 6961 6772 616d        to_diagram
-000cacb0: 2829 293b 0a20 2020 2020 2072 6574 7572  ());.      retur
-000cacc0: 6e20 6661 6c73 653b 0a20 2020 207d 0a20  n false;.    }. 
-000cacd0: 207d 0a0a 2020 6966 2028 636f 6d70 6f6e   }..  if (compon
-000cace0: 656e 7473 2e75 7365 726e 616d 655f 656e  ents.username_en
-000cacf0: 6420 213d 2062 7566 6665 722e 7369 7a65  d != buffer.size
-000cad00: 2829 2026 260a 2020 2020 2020 636f 6d70  () &&.      comp
-000cad10: 6f6e 656e 7473 2e75 7365 726e 616d 655f  onents.username_
-000cad20: 656e 6420 3e20 636f 6d70 6f6e 656e 7473  end > components
-000cad30: 2e70 726f 746f 636f 6c5f 656e 6420 2b20  .protocol_end + 
-000cad40: 3229 207b 0a20 2020 2069 6620 2862 7566  2) {.    if (buf
-000cad50: 6665 725b 636f 6d70 6f6e 656e 7473 2e75  fer[components.u
-000cad60: 7365 726e 616d 655f 656e 645d 2021 3d20  sername_end] != 
-000cad70: 273a 2720 2626 0a20 2020 2020 2020 2062  ':' &&.        b
-000cad80: 7566 6665 725b 636f 6d70 6f6e 656e 7473  uffer[components
-000cad90: 2e75 7365 726e 616d 655f 656e 645d 2021  .username_end] !
-000cada0: 3d20 2740 2729 207b 0a20 2020 2020 2061  = '@') {.      a
-000cadb0: 6461 5f6c 6f67 280a 2020 2020 2020 2020  da_log(.        
-000cadc0: 2020 2275 726c 5f61 6767 7265 6761 746f    "url_aggregato
-000cadd0: 723a 3a76 616c 6964 6174 6520 6d69 7373  r::validate miss
-000cade0: 696e 6720 3a20 6f72 2040 2061 7420 7468  ing : or @ at th
-000cadf0: 6520 656e 6420 6f66 2074 6865 2075 7365  e end of the use
-000cae00: 726e 616d 6520 220a 2020 2020 2020 2020  rname ".        
-000cae10: 2020 225c 6e22 2c0a 2020 2020 2020 2020    "\n",.        
-000cae20: 2020 746f 5f64 6961 6772 616d 2829 293b    to_diagram());
-000cae30: 0a20 2020 2020 2072 6574 7572 6e20 6661  .      return fa
-000cae40: 6c73 653b 0a20 2020 207d 0a20 207d 0a0a  lse;.    }.  }..
-000cae50: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
-000cae60: 2e68 6f73 745f 7374 6172 7420 213d 2062  .host_start != b
-000cae70: 7566 6665 722e 7369 7a65 2829 2920 7b0a  uffer.size()) {.
-000cae80: 2020 2020 6966 2028 636f 6d70 6f6e 656e      if (componen
-000cae90: 7473 2e68 6f73 745f 7374 6172 7420 3e20  ts.host_start > 
-000caea0: 636f 6d70 6f6e 656e 7473 2e75 7365 726e  components.usern
-000caeb0: 616d 655f 656e 6429 207b 0a20 2020 2020  ame_end) {.     
-000caec0: 2069 6620 2862 7566 6665 725b 636f 6d70   if (buffer[comp
-000caed0: 6f6e 656e 7473 2e68 6f73 745f 7374 6172  onents.host_star
-000caee0: 745d 2021 3d20 2740 2729 207b 0a20 2020  t] != '@') {.   
-000caef0: 2020 2020 2061 6461 5f6c 6f67 280a 2020       ada_log(.  
-000caf00: 2020 2020 2020 2020 2020 2275 726c 5f61            "url_a
-000caf10: 6767 7265 6761 746f 723a 3a76 616c 6964  ggregator::valid
-000caf20: 6174 6520 6d69 7373 696e 6720 4020 6174  ate missing @ at
-000caf30: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
-000caf40: 7061 7373 776f 7264 205c 6e22 2c0a 2020  password \n",.  
-000caf50: 2020 2020 2020 2020 2020 746f 5f64 6961            to_dia
-000caf60: 6772 616d 2829 293b 0a20 2020 2020 2020  gram());.       
-000caf70: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
-000caf80: 2020 2020 207d 0a20 2020 207d 2065 6c73       }.    } els
-000caf90: 6520 6966 2028 636f 6d70 6f6e 656e 7473  e if (components
-000cafa0: 2e68 6f73 745f 7374 6172 7420 3d3d 2063  .host_start == c
-000cafb0: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
-000cafc0: 6d65 5f65 6e64 2026 260a 2020 2020 2020  me_end &&.      
-000cafd0: 2020 2020 2020 2020 2063 6f6d 706f 6e65           compone
-000cafe0: 6e74 732e 686f 7374 5f65 6e64 203e 2063  nts.host_end > c
-000caff0: 6f6d 706f 6e65 6e74 732e 686f 7374 5f73  omponents.host_s
-000cb000: 7461 7274 2920 7b0a 2020 2020 2020 6966  tart) {.      if
-000cb010: 2028 636f 6d70 6f6e 656e 7473 2e68 6f73   (components.hos
-000cb020: 745f 7374 6172 7420 3d3d 2063 6f6d 706f  t_start == compo
-000cb030: 6e65 6e74 732e 7072 6f74 6f63 6f6c 5f65  nents.protocol_e
-000cb040: 6e64 202b 2032 2920 7b0a 2020 2020 2020  nd + 2) {.      
-000cb050: 2020 6966 2028 6275 6666 6572 5b63 6f6d    if (buffer[com
-000cb060: 706f 6e65 6e74 732e 7072 6f74 6f63 6f6c  ponents.protocol
-000cb070: 5f65 6e64 5d20 213d 2027 2f27 207c 7c0a  _end] != '/' ||.
-000cb080: 2020 2020 2020 2020 2020 2020 6275 6666              buff
-000cb090: 6572 5b63 6f6d 706f 6e65 6e74 732e 7072  er[components.pr
-000cb0a0: 6f74 6f63 6f6c 5f65 6e64 202b 2031 5d20  otocol_end + 1] 
-000cb0b0: 213d 2027 2f27 2920 7b0a 2020 2020 2020  != '/') {.      
-000cb0c0: 2020 2020 6164 615f 6c6f 6728 0a20 2020      ada_log(.   
-000cb0d0: 2020 2020 2020 2020 2020 2022 7572 6c5f             "url_
-000cb0e0: 6167 6772 6567 6174 6f72 3a3a 7661 6c69  aggregator::vali
-000cb0f0: 6461 7465 206d 6973 7369 6e67 202f 2f20  date missing // 
-000cb100: 6265 7477 6565 6e20 7072 6f74 6f63 6f6c  between protocol
-000cb110: 2061 6e64 2068 6f73 7420 220a 2020 2020   and host ".    
-000cb120: 2020 2020 2020 2020 2020 225c 6e22 2c0a            "\n",.
-000cb130: 2020 2020 2020 2020 2020 2020 2020 746f                to
-000cb140: 5f64 6961 6772 616d 2829 293b 0a20 2020  _diagram());.   
-000cb150: 2020 2020 2020 2072 6574 7572 6e20 6661         return fa
-000cb160: 6c73 653b 0a20 2020 2020 2020 207d 0a20  lse;.        }. 
-000cb170: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
-000cb180: 2020 2020 2020 6966 2028 636f 6d70 6f6e        if (compon
-000cb190: 656e 7473 2e68 6f73 745f 7374 6172 7420  ents.host_start 
-000cb1a0: 3e20 636f 6d70 6f6e 656e 7473 2e70 726f  > components.pro
-000cb1b0: 746f 636f 6c5f 656e 6420 2626 0a20 2020  tocol_end &&.   
-000cb1c0: 2020 2020 2020 2020 2062 7566 6665 725b           buffer[
-000cb1d0: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
-000cb1e0: 7374 6172 745d 2021 3d20 2740 2729 207b  start] != '@') {
-000cb1f0: 0a20 2020 2020 2020 2020 2061 6461 5f6c  .          ada_l
-000cb200: 6f67 280a 2020 2020 2020 2020 2020 2020  og(.            
-000cb210: 2020 2275 726c 5f61 6767 7265 6761 746f    "url_aggregato
-000cb220: 723a 3a76 616c 6964 6174 6520 6d69 7373  r::validate miss
-000cb230: 696e 6720 4020 6174 2074 6865 2065 6e64  ing @ at the end
-000cb240: 206f 6620 7468 6520 7573 6572 6e61 6d65   of the username
-000cb250: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000cb260: 2022 5c6e 222c 0a20 2020 2020 2020 2020   "\n",.         
-000cb270: 2020 2020 2074 6f5f 6469 6167 7261 6d28       to_diagram(
-000cb280: 2929 3b0a 2020 2020 2020 2020 2020 7265  ));.          re
-000cb290: 7475 726e 2066 616c 7365 3b0a 2020 2020  turn false;.    
-000cb2a0: 2020 2020 7d0a 2020 2020 2020 7d0a 2020      }.      }.  
-000cb2b0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-000cb2c0: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000cb2d0: 686f 7374 5f65 6e64 2021 3d20 636f 6d70  host_end != comp
-000cb2e0: 6f6e 656e 7473 2e68 6f73 745f 7374 6172  onents.host_star
-000cb2f0: 7429 207b 0a20 2020 2020 2020 2061 6461  t) {.        ada
-000cb300: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
-000cb310: 6174 6f72 3a3a 7661 6c69 6461 7465 2065  ator::validate e
-000cb320: 7870 6563 7465 6420 6f6d 6974 7465 6420  xpected omitted 
-000cb330: 686f 7374 205c 6e22 2c0a 2020 2020 2020  host \n",.      
-000cb340: 2020 2020 2020 2020 2020 746f 5f64 6961            to_dia
-000cb350: 6772 616d 2829 293b 0a20 2020 2020 2020  gram());.       
-000cb360: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
-000cb370: 2020 2020 207d 0a20 2020 207d 0a20 207d       }.    }.  }
-000cb380: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
-000cb390: 732e 686f 7374 5f65 6e64 2021 3d20 6275  s.host_end != bu
-000cb3a0: 6666 6572 2e73 697a 6528 2920 2626 0a20  ffer.size() &&. 
-000cb3b0: 2020 2020 2063 6f6d 706f 6e65 6e74 732e       components.
-000cb3c0: 7061 7468 6e61 6d65 5f73 7461 7274 203e  pathname_start >
-000cb3d0: 2063 6f6d 706f 6e65 6e74 732e 686f 7374   components.host
-000cb3e0: 5f65 6e64 2920 7b0a 2020 2020 6966 2028  _end) {.    if (
-000cb3f0: 636f 6d70 6f6e 656e 7473 2e70 6174 686e  components.pathn
-000cb400: 616d 655f 7374 6172 7420 3d3d 2063 6f6d  ame_start == com
-000cb410: 706f 6e65 6e74 732e 686f 7374 5f65 6e64  ponents.host_end
-000cb420: 202b 2032 2026 260a 2020 2020 2020 2020   + 2 &&.        
-000cb430: 6275 6666 6572 5b63 6f6d 706f 6e65 6e74  buffer[component
-000cb440: 732e 686f 7374 5f65 6e64 5d20 3d3d 2027  s.host_end] == '
-000cb450: 2f27 2026 260a 2020 2020 2020 2020 6275  /' &&.        bu
-000cb460: 6666 6572 5b63 6f6d 706f 6e65 6e74 732e  ffer[components.
-000cb470: 686f 7374 5f65 6e64 202b 2031 5d20 3d3d  host_end + 1] ==
-000cb480: 2027 2e27 2920 7b0a 2020 2020 2020 6966   '.') {.      if
-000cb490: 2028 636f 6d70 6f6e 656e 7473 2e70 6174   (components.pat
-000cb4a0: 686e 616d 655f 7374 6172 7420 2b20 3120  hname_start + 1 
-000cb4b0: 3e3d 2062 7566 6665 722e 7369 7a65 2829  >= buffer.size()
-000cb4c0: 207c 7c0a 2020 2020 2020 2020 2020 6275   ||.          bu
-000cb4d0: 6666 6572 5b63 6f6d 706f 6e65 6e74 732e  ffer[components.
-000cb4e0: 7061 7468 6e61 6d65 5f73 7461 7274 5d20  pathname_start] 
-000cb4f0: 213d 2027 2f27 207c 7c0a 2020 2020 2020  != '/' ||.      
-000cb500: 2020 2020 6275 6666 6572 5b63 6f6d 706f      buffer[compo
-000cb510: 6e65 6e74 732e 7061 7468 6e61 6d65 5f73  nents.pathname_s
-000cb520: 7461 7274 202b 2031 5d20 213d 2027 2f27  tart + 1] != '/'
-000cb530: 2920 7b0a 2020 2020 2020 2020 6164 615f  ) {.        ada_
-000cb540: 6c6f 6728 0a20 2020 2020 2020 2020 2020  log(.           
-000cb550: 2022 7572 6c5f 6167 6772 6567 6174 6f72   "url_aggregator
-000cb560: 3a3a 7661 6c69 6461 7465 2065 7870 6563  ::validate expec
-000cb570: 7465 6420 7468 6520 7061 7468 2074 6f20  ted the path to 
-000cb580: 6265 6769 6e20 7769 7468 202f 2f20 5c6e  begin with // \n
-000cb590: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-000cb5a0: 6f5f 6469 6167 7261 6d28 2929 3b0a 2020  o_diagram());.  
-000cb5b0: 2020 2020 2020 7265 7475 726e 2066 616c        return fal
-000cb5c0: 7365 3b0a 2020 2020 2020 7d0a 2020 2020  se;.      }.    
-000cb5d0: 7d20 656c 7365 2069 6620 2862 7566 6665  } else if (buffe
-000cb5e0: 725b 636f 6d70 6f6e 656e 7473 2e68 6f73  r[components.hos
-000cb5f0: 745f 656e 645d 2021 3d20 273a 2729 207b  t_end] != ':') {
-000cb600: 0a20 2020 2020 2061 6461 5f6c 6f67 2822  .      ada_log("
-000cb610: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
-000cb620: 7661 6c69 6461 7465 206d 6973 7369 6e67  validate missing
-000cb630: 203a 2061 7420 7468 6520 706f 7274 205c   : at the port \
-000cb640: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-000cb650: 2020 746f 5f64 6961 6772 616d 2829 293b    to_diagram());
-000cb660: 0a20 2020 2020 2072 6574 7572 6e20 6661  .      return fa
-000cb670: 6c73 653b 0a20 2020 207d 0a20 207d 0a20  lse;.    }.  }. 
-000cb680: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000cb690: 7061 7468 6e61 6d65 5f73 7461 7274 2021  pathname_start !
-000cb6a0: 3d20 6275 6666 6572 2e73 697a 6528 2920  = buffer.size() 
-000cb6b0: 2626 0a20 2020 2020 2063 6f6d 706f 6e65  &&.      compone
-000cb6c0: 6e74 732e 7061 7468 6e61 6d65 5f73 7461  nts.pathname_sta
-000cb6d0: 7274 203c 2063 6f6d 706f 6e65 6e74 732e  rt < components.
-000cb6e0: 7365 6172 6368 5f73 7461 7274 2026 260a  search_start &&.
-000cb6f0: 2020 2020 2020 636f 6d70 6f6e 656e 7473        components
-000cb700: 2e70 6174 686e 616d 655f 7374 6172 7420  .pathname_start 
-000cb710: 3c20 636f 6d70 6f6e 656e 7473 2e68 6173  < components.has
-000cb720: 685f 7374 6172 7420 2626 2021 6861 735f  h_start && !has_
-000cb730: 6f70 6171 7565 5f70 6174 6829 207b 0a20  opaque_path) {. 
-000cb740: 2020 2069 6620 2862 7566 6665 725b 636f     if (buffer[co
-000cb750: 6d70 6f6e 656e 7473 2e70 6174 686e 616d  mponents.pathnam
-000cb760: 655f 7374 6172 745d 2021 3d20 272f 2729  e_start] != '/')
-000cb770: 207b 0a20 2020 2020 2061 6461 5f6c 6f67   {.      ada_log
-000cb780: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
-000cb790: 3a3a 7661 6c69 6461 7465 206d 6973 7369  ::validate missi
-000cb7a0: 6e67 202f 2061 7420 7468 6520 7061 7468  ng / at the path
-000cb7b0: 205c 6e22 2c0a 2020 2020 2020 2020 2020   \n",.          
-000cb7c0: 2020 2020 746f 5f64 6961 6772 616d 2829      to_diagram()
-000cb7d0: 293b 0a20 2020 2020 2072 6574 7572 6e20  );.      return 
-000cb7e0: 6661 6c73 653b 0a20 2020 207d 0a20 207d  false;.    }.  }
-000cb7f0: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
-000cb800: 732e 7365 6172 6368 5f73 7461 7274 2021  s.search_start !
-000cb810: 3d20 7572 6c5f 636f 6d70 6f6e 656e 7473  = url_components
-000cb820: 3a3a 6f6d 6974 7465 6429 207b 0a20 2020  ::omitted) {.   
-000cb830: 2069 6620 2862 7566 6665 725b 636f 6d70   if (buffer[comp
-000cb840: 6f6e 656e 7473 2e73 6561 7263 685f 7374  onents.search_st
-000cb850: 6172 745d 2021 3d20 273f 2729 207b 0a20  art] != '?') {. 
-000cb860: 2020 2020 2061 6461 5f6c 6f67 2822 7572       ada_log("ur
-000cb870: 6c5f 6167 6772 6567 6174 6f72 3a3a 7661  l_aggregator::va
-000cb880: 6c69 6461 7465 206d 6973 7369 6e67 203f  lidate missing ?
-000cb890: 2061 7420 7468 6520 7365 6172 6368 205c   at the search \
-000cb8a0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-000cb8b0: 2020 746f 5f64 6961 6772 616d 2829 293b    to_diagram());
-000cb8c0: 0a20 2020 2020 2072 6574 7572 6e20 6661  .      return fa
-000cb8d0: 6c73 653b 0a20 2020 207d 0a20 207d 0a20  lse;.    }.  }. 
-000cb8e0: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000cb8f0: 6861 7368 5f73 7461 7274 2021 3d20 7572  hash_start != ur
-000cb900: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000cb910: 6974 7465 6429 207b 0a20 2020 2069 6620  itted) {.    if 
-000cb920: 2862 7566 6665 725b 636f 6d70 6f6e 656e  (buffer[componen
-000cb930: 7473 2e68 6173 685f 7374 6172 745d 2021  ts.hash_start] !
-000cb940: 3d20 2723 2729 207b 0a20 2020 2020 2061  = '#') {.      a
-000cb950: 6461 5f6c 6f67 2822 7572 6c5f 6167 6772  da_log("url_aggr
-000cb960: 6567 6174 6f72 3a3a 7661 6c69 6461 7465  egator::validate
-000cb970: 206d 6973 7369 6e67 2023 2061 7420 7468   missing # at th
-000cb980: 6520 6861 7368 205c 6e22 2c0a 2020 2020  e hash \n",.    
-000cb990: 2020 2020 2020 2020 2020 746f 5f64 6961            to_dia
-000cb9a0: 6772 616d 2829 293b 0a20 2020 2020 2072  gram());.      r
-000cb9b0: 6574 7572 6e20 6661 6c73 653b 0a20 2020  eturn false;.   
-000cb9c0: 207d 0a20 207d 0a0a 2020 7265 7475 726e   }.  }..  return
-000cb9d0: 2074 7275 653b 0a7d 0a0a 766f 6964 2075   true;.}..void u
-000cb9e0: 726c 5f61 6767 7265 6761 746f 723a 3a64  rl_aggregator::d
-000cb9f0: 656c 6574 655f 6461 7368 5f64 6f74 2829  elete_dash_dot()
-000cba00: 207b 0a20 2061 6461 5f6c 6f67 2822 7572   {.  ada_log("ur
-000cba10: 6c5f 6167 6772 6567 6174 6f72 3a3a 6465  l_aggregator::de
-000cba20: 6c65 7465 5f64 6173 685f 646f 7422 293b  lete_dash_dot");
-000cba30: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
-000cba40: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
-000cba50: 2020 4144 415f 4153 5345 5254 5f54 5255    ADA_ASSERT_TRU
-000cba60: 4528 6861 735f 6461 7368 5f64 6f74 2829  E(has_dash_dot()
-000cba70: 293b 0a20 2062 7566 6665 722e 6572 6173  );.  buffer.eras
-000cba80: 6528 636f 6d70 6f6e 656e 7473 2e68 6f73  e(components.hos
-000cba90: 745f 656e 642c 2032 293b 0a20 2063 6f6d  t_end, 2);.  com
-000cbaa0: 706f 6e65 6e74 732e 7061 7468 6e61 6d65  ponents.pathname
-000cbab0: 5f73 7461 7274 202d 3d20 323b 0a20 2069  _start -= 2;.  i
-000cbac0: 6620 2863 6f6d 706f 6e65 6e74 732e 7365  f (components.se
-000cbad0: 6172 6368 5f73 7461 7274 2021 3d20 7572  arch_start != ur
-000cbae0: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000cbaf0: 6974 7465 6429 207b 0a20 2020 2063 6f6d  itted) {.    com
-000cbb00: 706f 6e65 6e74 732e 7365 6172 6368 5f73  ponents.search_s
-000cbb10: 7461 7274 202d 3d20 323b 0a20 207d 0a20  tart -= 2;.  }. 
-000cbb20: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
-000cbb30: 6861 7368 5f73 7461 7274 2021 3d20 7572  hash_start != ur
-000cbb40: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
-000cbb50: 6974 7465 6429 207b 0a20 2020 2063 6f6d  itted) {.    com
-000cbb60: 706f 6e65 6e74 732e 6861 7368 5f73 7461  ponents.hash_sta
-000cbb70: 7274 202d 3d20 323b 0a20 207d 0a20 2041  rt -= 2;.  }.  A
-000cbb80: 4441 5f41 5353 4552 545f 5452 5545 2876  DA_ASSERT_TRUE(v
-000cbb90: 616c 6964 6174 6528 2929 3b0a 2020 4144  alidate());.  AD
-000cbba0: 415f 4153 5345 5254 5f54 5255 4528 2168  A_ASSERT_TRUE(!h
-000cbbb0: 6173 5f64 6173 685f 646f 7428 2929 3b0a  as_dash_dot());.
-000cbbc0: 7d0a 0a69 6e6c 696e 6520 766f 6964 2075  }..inline void u
-000cbbd0: 726c 5f61 6767 7265 6761 746f 723a 3a63  rl_aggregator::c
-000cbbe0: 6f6e 7375 6d65 5f70 7265 7061 7265 645f  onsume_prepared_
-000cbbf0: 7061 7468 2873 7464 3a3a 7374 7269 6e67  path(std::string
-000cbc00: 5f76 6965 7720 696e 7075 7429 207b 0a20  _view input) {. 
-000cbc10: 2061 6461 5f6c 6f67 2822 7572 6c5f 6167   ada_log("url_ag
-000cbc20: 6772 6567 6174 6f72 3a3a 636f 6e73 756d  gregator::consum
-000cbc30: 655f 7072 6570 6172 6564 5f70 6174 6820  e_prepared_path 
-000cbc40: 222c 2069 6e70 7574 293b 0a20 202f 2a2a  ", input);.  /**
-000cbc50: 2a0a 2020 202a 2054 6869 7320 6973 206c  *.   * This is l
-000cbc60: 6172 6765 6c79 2064 7570 6c69 6361 7465  argely duplicate
-000cbc70: 6420 636f 6465 2066 726f 6d20 6865 6c70  d code from help
-000cbc80: 6572 733a 3a70 6172 7365 5f70 7265 7061  ers::parse_prepa
-000cbc90: 7265 645f 7061 7468 2c20 7768 6963 6820  red_path, which 
-000cbca0: 6973 0a20 2020 2a20 756e 666f 7274 756e  is.   * unfortun
-000cbcb0: 6174 652e 2054 6869 7320 7061 7274 6963  ate. This partic
-000cbcc0: 756c 6172 2066 756e 6374 696f 6e20 6973  ular function is
-000cbcd0: 206e 6561 726c 7920 6964 656e 7469 6361   nearly identica
-000cbce0: 6c2c 2065 7863 6570 7420 7468 6174 2069  l, except that i
-000cbcf0: 740a 2020 202a 2069 7320 6120 6d65 7468  t.   * is a meth
-000cbd00: 6f64 206f 6e20 7572 6c5f 6167 6772 6567  od on url_aggreg
-000cbd10: 6174 6f72 2e20 5468 6520 6964 6561 2069  ator. The idea i
-000cbd20: 7320 7468 6174 2074 6865 2074 7269 7669  s that the trivi
-000cbd30: 616c 2070 6174 6820 2877 6869 6368 2069  al path (which i
-000cbd40: 730a 2020 202a 2076 6572 7920 636f 6d6d  s.   * very comm
-000cbd50: 6f6e 2920 6d65 7265 6c79 2061 7070 656e  on) merely appen
-000cbd60: 6473 2074 6f20 7468 6520 6275 6666 6572  ds to the buffer
-000cbd70: 2e20 5468 6973 2069 7320 7468 6520 7361  . This is the sa
-000cbd80: 6d65 2074 7269 7669 616c 2070 6174 6820  me trivial path 
-000cbd90: 6173 0a20 2020 2a20 7769 7468 2068 656c  as.   * with hel
-000cbda0: 7065 7273 3a3a 7061 7273 655f 7072 6570  pers::parse_prep
-000cbdb0: 6172 6564 5f70 6174 682c 2065 7863 6570  ared_path, excep
-000cbdc0: 7420 7468 6174 2077 6520 6861 7665 2074  t that we have t
-000cbdd0: 6865 2061 6464 6974 696f 6e61 6c20 6368  he additional ch
-000cbde0: 6563 6b0a 2020 202a 2066 6f72 2069 735f  eck.   * for is_
-000cbdf0: 6174 5f70 6174 6828 292e 204f 7468 6572  at_path(). Other
-000cbe00: 7769 7365 2c20 7765 2067 7261 6220 6120  wise, we grab a 
-000cbe10: 636f 7079 206f 6620 7468 6520 6375 7272  copy of the curr
-000cbe20: 656e 7420 7061 7468 2061 6e64 2077 650a  ent path and we.
-000cbe30: 2020 202a 206d 6f64 6966 7920 6974 2c20     * modify it, 
-000cbe40: 616e 6420 7468 656e 2069 6e73 6572 7420  and then insert 
-000cbe50: 6974 2062 6163 6b20 696e 746f 2074 6865  it back into the
-000cbe60: 2062 7566 6665 722e 0a20 2020 2a2f 0a20   buffer..   */. 
-000cbe70: 2075 696e 7438 5f74 2061 6363 756d 756c   uint8_t accumul
-000cbe80: 6174 6f72 203d 2063 6865 636b 6572 733a  ator = checkers:
-000cbe90: 3a70 6174 685f 7369 676e 6174 7572 6528  :path_signature(
-000cbea0: 696e 7075 7429 3b0a 2020 2f2f 204c 6574  input);.  // Let
-000cbeb0: 2075 7320 6669 7273 7420 6465 7465 6374   us first detect
-000cbec0: 2061 2074 7269 7669 616c 2063 6173 652e   a trivial case.
-000cbed0: 0a20 202f 2f20 4966 2069 7420 6973 2073  .  // If it is s
-000cbee0: 7065 6369 616c 2c20 7765 2063 6865 636b  pecial, we check
-000cbef0: 2074 6861 7420 7765 2068 6176 6520 6e6f   that we have no
-000cbf00: 2064 6f74 2c20 6e6f 2025 2c20 206e 6f20   dot, no %,  no 
-000cbf10: 5c20 616e 6420 6e6f 0a20 202f 2f20 6368  \ and no.  // ch
-000cbf20: 6172 6163 7465 7220 6e65 6564 696e 6720  aracter needing 
-000cbf30: 7065 7263 656e 7420 656e 636f 6469 6e67  percent encoding
-000cbf40: 2e20 4f74 6865 7277 6973 652c 2077 6520  . Otherwise, we 
-000cbf50: 6368 6563 6b20 7468 6174 2077 6520 6861  check that we ha
-000cbf60: 7665 206e 6f20 252c 0a20 202f 2f20 6e6f  ve no %,.  // no
-000cbf70: 2064 6f74 2c20 616e 6420 6e6f 2063 6861   dot, and no cha
-000cbf80: 7261 6374 6572 206e 6565 6469 6e67 2070  racter needing p
-000cbf90: 6572 6365 6e74 2065 6e63 6f64 696e 672e  ercent encoding.
-000cbfa0: 0a20 2063 6f6e 7374 6578 7072 2075 696e  .  constexpr uin
-000cbfb0: 7438 5f74 206e 6565 645f 656e 636f 6469  t8_t need_encodi
-000cbfc0: 6e67 203d 2031 3b0a 2020 636f 6e73 7465  ng = 1;.  conste
-000cbfd0: 7870 7220 7569 6e74 385f 7420 6261 636b  xpr uint8_t back
-000cbfe0: 736c 6173 685f 6368 6172 203d 2032 3b0a  slash_char = 2;.
-000cbff0: 2020 636f 6e73 7465 7870 7220 7569 6e74    constexpr uint
-000cc000: 385f 7420 646f 745f 6368 6172 203d 2034  8_t dot_char = 4
-000cc010: 3b0a 2020 636f 6e73 7465 7870 7220 7569  ;.  constexpr ui
-000cc020: 6e74 385f 7420 7065 7263 656e 745f 6368  nt8_t percent_ch
-000cc030: 6172 203d 2038 3b0a 2020 626f 6f6c 2073  ar = 8;.  bool s
-000cc040: 7065 6369 616c 203d 2074 7970 6520 213d  pecial = type !=
-000cc050: 2061 6461 3a3a 7363 6865 6d65 3a3a 4e4f   ada::scheme::NO
-000cc060: 545f 5350 4543 4941 4c3b 0a20 2062 6f6f  T_SPECIAL;.  boo
-000cc070: 6c20 6d61 795f 6e65 6564 5f73 6c6f 775f  l may_need_slow_
-000cc080: 6669 6c65 5f68 616e 646c 696e 6720 3d20  file_handling = 
-000cc090: 2874 7970 6520 3d3d 2061 6461 3a3a 7363  (type == ada::sc
-000cc0a0: 6865 6d65 3a3a 7479 7065 3a3a 4649 4c45  heme::type::FILE
-000cc0b0: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
-000cc0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cc0d0: 2020 2020 2020 2020 2020 6368 6563 6b65            checke
-000cc0e0: 7273 3a3a 6973 5f77 696e 646f 7773 5f64  rs::is_windows_d
-000cc0f0: 7269 7665 5f6c 6574 7465 7228 696e 7075  rive_letter(inpu
-000cc100: 7429 293b 0a20 2062 6f6f 6c20 7472 6976  t));.  bool triv
-000cc110: 6961 6c5f 7061 7468 203d 0a20 2020 2020  ial_path =.     
-000cc120: 2028 7370 6563 6961 6c20 3f20 2861 6363   (special ? (acc
-000cc130: 756d 756c 6174 6f72 203d 3d20 3029 0a20  umulator == 0). 
-000cc140: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
-000cc150: 2828 6163 6375 6d75 6c61 746f 7220 2620  ((accumulator & 
-000cc160: 286e 6565 645f 656e 636f 6469 6e67 207c  (need_encoding |
-000cc170: 2064 6f74 5f63 6861 7220 7c20 7065 7263   dot_char | perc
-000cc180: 656e 745f 6368 6172 2929 203d 3d0a 2020  ent_char)) ==.  
-000cc190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cc1a0: 3029 2920 2626 0a20 2020 2020 2028 216d  0)) &&.      (!m
-000cc1b0: 6179 5f6e 6565 645f 736c 6f77 5f66 696c  ay_need_slow_fil
-000cc1c0: 655f 6861 6e64 6c69 6e67 293b 0a20 2069  e_handling);.  i
-000cc1d0: 6620 2861 6363 756d 756c 6174 6f72 203d  f (accumulator =
-000cc1e0: 3d20 646f 745f 6368 6172 2026 2620 216d  = dot_char && !m
-000cc1f0: 6179 5f6e 6565 645f 736c 6f77 5f66 696c  ay_need_slow_fil
-000cc200: 655f 6861 6e64 6c69 6e67 2920 7b0a 2020  e_handling) {.  
-000cc210: 2020 2f2f 2027 3427 206d 6561 6e73 2074    // '4' means t
-000cc220: 6861 7420 7765 2068 6176 6520 6174 206c  hat we have at l
-000cc230: 6561 7374 206f 6e65 2064 6f74 2c20 6275  east one dot, bu
-000cc240: 7420 6e6f 7468 696e 6720 7468 6174 2072  t nothing that r
-000cc250: 6571 7569 7265 730a 2020 2020 2f2f 2070  equires.    // p
-000cc260: 6572 6365 6e74 2065 6e63 6f64 696e 6720  ercent encoding 
-000cc270: 6f72 2064 6563 6f64 696e 672e 2054 6865  or decoding. The
-000cc280: 206f 6e6c 7920 7061 7274 2074 6861 7420   only part that 
-000cc290: 6973 206e 6f74 2074 7269 7669 616c 2069  is not trivial i
-000cc2a0: 730a 2020 2020 2f2f 2074 6861 7420 7765  s.    // that we
-000cc2b0: 206d 6179 2068 6176 6520 7369 6e67 6c65   may have single
-000cc2c0: 2064 6f74 7320 616e 6420 646f 7562 6c65   dots and double
-000cc2d0: 2064 6f74 7320 7061 7468 2073 6567 6d65   dots path segme
-000cc2e0: 6e74 732e 0a20 2020 202f 2f20 4966 2077  nts..    // If w
-000cc2f0: 6520 6861 7665 2073 7563 6820 7365 676d  e have such segm
-000cc300: 656e 7473 2c20 7468 656e 2077 6520 6569  ents, then we ei
-000cc310: 7468 6572 2068 6176 6520 6120 7061 7468  ther have a path
-000cc320: 2074 6861 7420 6265 6769 6e73 0a20 2020   that begins.   
-000cc330: 202f 2f20 7769 7468 2027 2e27 2028 6561   // with '.' (ea
-000cc340: 7379 2074 6f20 6368 6563 6b29 2c20 6f72  sy to check), or
-000cc350: 2077 6520 6861 7665 2074 6865 2073 6571   we have the seq
-000cc360: 7565 6e63 6520 272e 2f27 2e0a 2020 2020  uence './'..    
-000cc370: 2f2f 204e 6f74 653a 2069 6e70 7574 2063  // Note: input c
-000cc380: 616e 6e6f 7420 6265 2065 6d70 7479 2c20  annot be empty, 
-000cc390: 6974 206d 7573 7420 6174 206c 6561 7374  it must at least
-000cc3a0: 2063 6f6e 7461 696e 206f 6e65 2063 6861   contain one cha
-000cc3b0: 7261 6374 6572 2028 272e 2729 0a20 2020  racter ('.').   
-000cc3c0: 202f 2f20 4e6f 7465 3a20 7765 206b 6e6f   // Note: we kno
-000cc3d0: 7720 7468 6174 2027 5c27 2069 7320 6e6f  w that '\' is no
-000cc3e0: 7420 7072 6573 656e 742e 0a20 2020 2069  t present..    i
-000cc3f0: 6620 2869 6e70 7574 5b30 5d20 213d 2027  f (input[0] != '
-000cc400: 2e27 2920 7b0a 2020 2020 2020 7369 7a65  .') {.      size
-000cc410: 5f74 2073 6c61 7368 646f 7420 3d20 696e  _t slashdot = in
-000cc420: 7075 742e 6669 6e64 2822 2f2e 2229 3b0a  put.find("/.");.
-000cc430: 2020 2020 2020 6966 2028 736c 6173 6864        if (slashd
-000cc440: 6f74 203d 3d20 7374 643a 3a73 7472 696e  ot == std::strin
-000cc450: 675f 7669 6577 3a3a 6e70 6f73 2920 7b20  g_view::npos) { 
-000cc460: 202f 2f20 636f 6d6d 6f6e 2063 6173 650a   // common case.
-000cc470: 2020 2020 2020 2020 7472 6976 6961 6c5f          trivial_
-000cc480: 7061 7468 203d 2074 7275 653b 0a20 2020  path = true;.   
-000cc490: 2020 207d 2065 6c73 6520 7b20 202f 2f20     } else {  // 
-000cc4a0: 756e 636f 6d6d 6f6e 0a20 2020 2020 2020  uncommon.       
-000cc4b0: 202f 2f20 6f6e 6c79 2074 6872 6565 2063   // only three c
-000cc4c0: 6173 6573 206d 6174 7465 723a 202f 2e2f  ases matter: /./
-000cc4d0: 2c20 2f2e 2e20 6f72 2061 2066 696e 616c  , /.. or a final
-000cc4e0: 202f 0a20 2020 2020 2020 2074 7269 7669   /.        trivi
-000cc4f0: 616c 5f70 6174 6820 3d0a 2020 2020 2020  al_path =.      
-000cc500: 2020 2020 2020 2128 736c 6173 6864 6f74        !(slashdot
-000cc510: 202b 2032 203d 3d20 696e 7075 742e 7369   + 2 == input.si
-000cc520: 7a65 2829 207c 7c20 696e 7075 745b 736c  ze() || input[sl
-000cc530: 6173 6864 6f74 202b 2032 5d20 3d3d 2027  ashdot + 2] == '
-000cc540: 2e27 207c 7c0a 2020 2020 2020 2020 2020  .' ||.          
-000cc550: 2020 2020 696e 7075 745b 736c 6173 6864      input[slashd
-000cc560: 6f74 202b 2032 5d20 3d3d 2027 2f27 293b  ot + 2] == '/');
-000cc570: 0a20 2020 2020 207d 0a20 2020 207d 0a20  .      }.    }. 
-000cc580: 207d 0a20 2069 6620 2874 7269 7669 616c   }.  if (trivial
-000cc590: 5f70 6174 6820 2626 2069 735f 6174 5f70  _path && is_at_p
-000cc5a0: 6174 6828 2929 207b 0a20 2020 2061 6461  ath()) {.    ada
-000cc5b0: 5f6c 6f67 2822 7061 7273 655f 7061 7468  _log("parse_path
-000cc5c0: 2074 7269 7669 616c 2229 3b0a 2020 2020   trivial");.    
-000cc5d0: 6275 6666 6572 202b 3d20 272f 273b 0a20  buffer += '/';. 
-000cc5e0: 2020 2062 7566 6665 7220 2b3d 2069 6e70     buffer += inp
-000cc5f0: 7574 3b0a 2020 2020 7265 7475 726e 3b0a  ut;.    return;.
-000cc600: 2020 7d0a 2020 7374 643a 3a73 7472 696e    }.  std::strin
-000cc610: 6720 7061 7468 203d 2073 7464 3a3a 7374  g path = std::st
-000cc620: 7269 6e67 2867 6574 5f70 6174 686e 616d  ring(get_pathnam
-000cc630: 6528 2929 3b0a 2020 2f2f 2057 6520 6172  e());.  // We ar
-000cc640: 6520 676f 696e 6720 746f 206e 6565 6420  e going to need 
-000cc650: 746f 206c 6f6f 6b20 6120 6269 7420 6174  to look a bit at
-000cc660: 2074 6865 2070 6174 682c 2062 7574 206c   the path, but l
-000cc670: 6574 2075 7320 7365 6520 6966 2077 6520  et us see if we 
-000cc680: 6361 6e0a 2020 2f2f 2069 676e 6f72 6520  can.  // ignore 
-000cc690: 7065 7263 656e 7420 656e 636f 6469 6e67  percent encoding
-000cc6a0: 202a 616e 642a 2062 6163 6b73 6c61 7368   *and* backslash
-000cc6b0: 6573 202a 616e 642a 2070 6572 6365 6e74  es *and* percent
-000cc6c0: 2063 6861 7261 6374 6572 732e 0a20 202f   characters..  /
-000cc6d0: 2f20 4578 6365 7074 2066 6f72 2074 6865  / Except for the
-000cc6e0: 2074 7269 7669 616c 2063 6173 652c 2074   trivial case, t
-000cc6f0: 6869 7320 6973 206c 696b 656c 7920 746f  his is likely to
-000cc700: 2063 6170 7475 7265 2039 3925 206f 6620   capture 99% of 
-000cc710: 7061 7468 7320 6f75 740a 2020 2f2f 2074  paths out.  // t
-000cc720: 6865 7265 2e0a 2020 626f 6f6c 2066 6173  here..  bool fas
-000cc730: 745f 7061 7468 203d 0a20 2020 2020 2028  t_path =.      (
-000cc740: 7370 6563 6961 6c20 2626 0a20 2020 2020  special &&.     
-000cc750: 2020 2861 6363 756d 756c 6174 6f72 2026    (accumulator &
-000cc760: 2028 6e65 6564 5f65 6e63 6f64 696e 6720   (need_encoding 
-000cc770: 7c20 6261 636b 736c 6173 685f 6368 6172  | backslash_char
-000cc780: 207c 2070 6572 6365 6e74 5f63 6861 7229   | percent_char)
-000cc790: 2920 3d3d 2030 2920 2626 0a20 2020 2020  ) == 0) &&.     
-000cc7a0: 2028 7479 7065 2021 3d20 6164 613a 3a73   (type != ada::s
-000cc7b0: 6368 656d 653a 3a74 7970 653a 3a46 494c  cheme::type::FIL
-000cc7c0: 4529 3b0a 2020 6966 2028 6661 7374 5f70  E);.  if (fast_p
-000cc7d0: 6174 6829 207b 0a20 2020 2061 6461 5f6c  ath) {.    ada_l
-000cc7e0: 6f67 2822 7061 7273 655f 7072 6570 6172  og("parse_prepar
-000cc7f0: 6564 5f70 6174 6820 6661 7374 2229 3b0a  ed_path fast");.
-000cc800: 2020 2020 2f2f 2048 6572 6520 7765 2064      // Here we d
-000cc810: 6f6e 2774 206e 6565 6420 746f 2077 6f72  on't need to wor
-000cc820: 7279 2061 626f 7574 205c 206f 7220 7065  ry about \ or pe
-000cc830: 7263 656e 7420 656e 636f 6469 6e67 2e0a  rcent encoding..
-000cc840: 2020 2020 2f2f 2057 6520 616c 736f 2064      // We also d
-000cc850: 6f20 6e6f 7420 6861 7665 2061 2066 696c  o not have a fil
-000cc860: 6520 7072 6f74 6f63 6f6c 2e20 5765 206d  e protocol. We m
-000cc870: 6967 6874 2068 6176 6520 646f 7473 2c20  ight have dots, 
-000cc880: 686f 7765 7665 722c 0a20 2020 202f 2f20  however,.    // 
-000cc890: 6275 7420 646f 7473 206d 7573 7420 6173  but dots must as
-000cc8a0: 2061 7070 6561 7220 6173 2027 2e27 2c20   appear as '.', 
-000cc8b0: 616e 6420 7468 6579 2063 616e 6e6f 7420  and they cannot 
-000cc8c0: 6265 2065 6e63 6f64 6564 2062 6563 6175  be encoded becau
-000cc8d0: 7365 0a20 2020 202f 2f20 7468 6520 7379  se.    // the sy
-000cc8e0: 6d62 6f6c 2027 2527 2069 7320 6e6f 7420  mbol '%' is not 
-000cc8f0: 7072 6573 656e 742e 0a20 2020 2073 697a  present..    siz
-000cc900: 655f 7420 7072 6576 696f 7573 5f6c 6f63  e_t previous_loc
-000cc910: 6174 696f 6e20 3d20 303b 2020 2f2f 2057  ation = 0;  // W
-000cc920: 6520 7374 6172 7420 6174 2030 2e0a 2020  e start at 0..  
-000cc930: 2020 646f 207b 0a20 2020 2020 2073 697a    do {.      siz
-000cc940: 655f 7420 6e65 775f 6c6f 6361 7469 6f6e  e_t new_location
-000cc950: 203d 2069 6e70 7574 2e66 696e 6428 272f   = input.find('/
-000cc960: 272c 2070 7265 7669 6f75 735f 6c6f 6361  ', previous_loca
-000cc970: 7469 6f6e 293b 0a20 2020 2020 202f 2f20  tion);.      // 
-000cc980: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000cc990: 2070 6174 685f 7669 6577 203d 2069 6e70   path_view = inp
-000cc9a0: 7574 3b0a 2020 2020 2020 2f2f 2020 5765  ut;.      //  We
-000cc9b0: 2070 726f 6365 7373 2074 6865 206c 6173   process the las
-000cc9c0: 7420 7365 676d 656e 7420 7365 7061 7261  t segment separa
-000cc9d0: 7465 6c79 3a0a 2020 2020 2020 6966 2028  tely:.      if (
-000cc9e0: 6e65 775f 6c6f 6361 7469 6f6e 203d 3d20  new_location == 
-000cc9f0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000cca00: 3a3a 6e70 6f73 2920 7b0a 2020 2020 2020  ::npos) {.      
-000cca10: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
-000cca20: 6577 2070 6174 685f 7669 6577 203d 2069  ew path_view = i
-000cca30: 6e70 7574 2e73 7562 7374 7228 7072 6576  nput.substr(prev
-000cca40: 696f 7573 5f6c 6f63 6174 696f 6e29 3b0a  ious_location);.
-000cca50: 2020 2020 2020 2020 6966 2028 7061 7468          if (path
-000cca60: 5f76 6965 7720 3d3d 2022 2e2e 2229 207b  _view == "..") {
-000cca70: 2020 2f2f 2054 6865 2070 6174 6820 656e    // The path en
-000cca80: 6473 2077 6974 6820 2e2e 0a20 2020 2020  ds with ...     
-000cca90: 2020 2020 202f 2f20 652e 672e 2c20 6966       // e.g., if
-000ccaa0: 2079 6f75 2072 6563 6569 7665 2022 2e2e   you receive "..
-000ccab0: 2220 7769 7468 2061 6e20 656d 7074 7920  " with an empty 
-000ccac0: 7061 7468 2c20 796f 7520 676f 2074 6f20  path, you go to 
-000ccad0: 222f 222e 0a20 2020 2020 2020 2020 2069  "/"..          i
-000ccae0: 6620 2870 6174 682e 656d 7074 7928 2929  f (path.empty())
-000ccaf0: 207b 0a20 2020 2020 2020 2020 2020 2070   {.            p
-000ccb00: 6174 6820 3d20 272f 273b 0a20 2020 2020  ath = '/';.     
-000ccb10: 2020 2020 2020 2075 7064 6174 655f 6261         update_ba
-000ccb20: 7365 5f70 6174 686e 616d 6528 7061 7468  se_pathname(path
-000ccb30: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
-000ccb40: 6574 7572 6e3b 0a20 2020 2020 2020 2020  eturn;.         
-000ccb50: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
-000ccb60: 4661 7374 2063 6173 6520 7768 6572 6520  Fast case where 
-000ccb70: 7765 2068 6176 6520 6e6f 7468 696e 6720  we have nothing 
-000ccb80: 746f 2064 6f3a 0a20 2020 2020 2020 2020  to do:.         
-000ccb90: 2069 6620 2870 6174 682e 6261 636b 2829   if (path.back()
-000ccba0: 203d 3d20 272f 2729 207b 0a20 2020 2020   == '/') {.     
-000ccbb0: 2020 2020 2020 2075 7064 6174 655f 6261         update_ba
-000ccbc0: 7365 5f70 6174 686e 616d 6528 7061 7468  se_pathname(path
-000ccbd0: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
-000ccbe0: 6574 7572 6e3b 0a20 2020 2020 2020 2020  eturn;.         
-000ccbf0: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
-000ccc00: 4966 2079 6f75 2068 6176 6520 7468 6520  If you have the 
-000ccc10: 7061 7468 2022 2f6a 6f65 2f6d 7966 7269  path "/joe/myfri
-000ccc20: 656e 6422 2c0a 2020 2020 2020 2020 2020  end",.          
-000ccc30: 2f2f 2074 6865 6e20 796f 7520 6465 6c65  // then you dele
-000ccc40: 7465 2027 6d79 6672 6965 6e64 272e 0a20  te 'myfriend'.. 
-000ccc50: 2020 2020 2020 2020 2070 6174 682e 7265           path.re
-000ccc60: 7369 7a65 2870 6174 682e 7266 696e 6428  size(path.rfind(
-000ccc70: 272f 2729 202b 2031 293b 0a20 2020 2020  '/') + 1);.     
-000ccc80: 2020 2020 2075 7064 6174 655f 6261 7365       update_base
-000ccc90: 5f70 6174 686e 616d 6528 7061 7468 293b  _pathname(path);
-000ccca0: 0a20 2020 2020 2020 2020 2072 6574 7572  .          retur
-000cccb0: 6e3b 0a20 2020 2020 2020 207d 0a20 2020  n;.        }.   
-000cccc0: 2020 2020 2070 6174 6820 2b3d 2027 2f27       path += '/'
-000cccd0: 3b0a 2020 2020 2020 2020 6966 2028 7061  ;.        if (pa
-000ccce0: 7468 5f76 6965 7720 213d 2022 2e22 2920  th_view != ".") 
-000cccf0: 7b0a 2020 2020 2020 2020 2020 7061 7468  {.          path
-000ccd00: 2e61 7070 656e 6428 7061 7468 5f76 6965  .append(path_vie
-000ccd10: 7729 3b0a 2020 2020 2020 2020 7d0a 2020  w);.        }.  
-000ccd20: 2020 2020 2020 7570 6461 7465 5f62 6173        update_bas
-000ccd30: 655f 7061 7468 6e61 6d65 2870 6174 6829  e_pathname(path)
-000ccd40: 3b0a 2020 2020 2020 2020 7265 7475 726e  ;.        return
-000ccd50: 3b0a 2020 2020 2020 7d20 656c 7365 207b  ;.      } else {
-000ccd60: 0a20 2020 2020 2020 202f 2f20 5468 6973  .        // This
-000ccd70: 2069 7320 6120 6e6f 6e2d 6669 6e61 6c20   is a non-final 
-000ccd80: 7365 676d 656e 742e 0a20 2020 2020 2020  segment..       
-000ccd90: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
-000ccda0: 7720 7061 7468 5f76 6965 7720 3d0a 2020  w path_view =.  
-000ccdb0: 2020 2020 2020 2020 2020 696e 7075 742e            input.
-000ccdc0: 7375 6273 7472 2870 7265 7669 6f75 735f  substr(previous_
-000ccdd0: 6c6f 6361 7469 6f6e 2c20 6e65 775f 6c6f  location, new_lo
-000ccde0: 6361 7469 6f6e 202d 2070 7265 7669 6f75  cation - previou
-000ccdf0: 735f 6c6f 6361 7469 6f6e 293b 0a20 2020  s_location);.   
-000cce00: 2020 2020 2070 7265 7669 6f75 735f 6c6f       previous_lo
-000cce10: 6361 7469 6f6e 203d 206e 6577 5f6c 6f63  cation = new_loc
-000cce20: 6174 696f 6e20 2b20 313b 0a20 2020 2020  ation + 1;.     
-000cce30: 2020 2069 6620 2870 6174 685f 7669 6577     if (path_view
-000cce40: 203d 3d20 222e 2e22 2920 7b0a 2020 2020   == "..") {.    
-000cce50: 2020 2020 2020 7369 7a65 5f74 206c 6173        size_t las
-000cce60: 745f 6465 6c69 6d69 7465 7220 3d20 7061  t_delimiter = pa
-000cce70: 7468 2e72 6669 6e64 2827 2f27 293b 0a20  th.rfind('/');. 
-000cce80: 2020 2020 2020 2020 2069 6620 286c 6173           if (las
-000cce90: 745f 6465 6c69 6d69 7465 7220 213d 2073  t_delimiter != s
-000ccea0: 7464 3a3a 7374 7269 6e67 3a3a 6e70 6f73  td::string::npos
-000cceb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000ccec0: 7061 7468 2e65 7261 7365 286c 6173 745f  path.erase(last_
-000cced0: 6465 6c69 6d69 7465 7229 3b0a 2020 2020  delimiter);.    
-000ccee0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000ccef0: 7d20 656c 7365 2069 6620 2870 6174 685f  } else if (path_
-000ccf00: 7669 6577 2021 3d20 222e 2229 207b 0a20  view != ".") {. 
-000ccf10: 2020 2020 2020 2020 2070 6174 6820 2b3d           path +=
-000ccf20: 2027 2f27 3b0a 2020 2020 2020 2020 2020   '/';.          
-000ccf30: 7061 7468 2e61 7070 656e 6428 7061 7468  path.append(path
-000ccf40: 5f76 6965 7729 3b0a 2020 2020 2020 2020  _view);.        
-000ccf50: 7d0a 2020 2020 2020 7d0a 2020 2020 7d20  }.      }.    } 
-000ccf60: 7768 696c 6520 2874 7275 6529 3b0a 2020  while (true);.  
-000ccf70: 7d20 656c 7365 207b 0a20 2020 2061 6461  } else {.    ada
-000ccf80: 5f6c 6f67 2822 7061 7273 655f 7061 7468  _log("parse_path
-000ccf90: 2073 6c6f 7722 293b 0a20 2020 202f 2f20   slow");.    // 
-000ccfa0: 7765 2068 6176 6520 7265 6163 6865 6420  we have reached 
-000ccfb0: 7468 6520 6765 6e65 7261 6c20 6361 7365  the general case
-000ccfc0: 0a20 2020 2062 6f6f 6c20 6e65 6564 735f  .    bool needs_
-000ccfd0: 7065 7263 656e 745f 656e 636f 6469 6e67  percent_encoding
-000ccfe0: 203d 2028 6163 6375 6d75 6c61 746f 7220   = (accumulator 
-000ccff0: 2620 3129 3b0a 2020 2020 7374 643a 3a73  & 1);.    std::s
-000cd000: 7472 696e 6720 7061 7468 5f62 7566 6665  tring path_buffe
-000cd010: 725f 746d 703b 0a20 2020 2064 6f20 7b0a  r_tmp;.    do {.
-000cd020: 2020 2020 2020 7369 7a65 5f74 206c 6f63        size_t loc
-000cd030: 6174 696f 6e20 3d20 2873 7065 6369 616c  ation = (special
-000cd040: 2026 2620 2861 6363 756d 756c 6174 6f72   && (accumulator
-000cd050: 2026 2032 2929 0a20 2020 2020 2020 2020   & 2)).         
-000cd060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cd070: 2020 203f 2069 6e70 7574 2e66 696e 645f     ? input.find_
-000cd080: 6669 7273 745f 6f66 2822 2f5c 5c22 290a  first_of("/\\").
-000cd090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cd0a0: 2020 2020 2020 2020 2020 2020 3a20 696e              : in
-000cd0b0: 7075 742e 6669 6e64 2827 2f27 293b 0a20  put.find('/');. 
-000cd0c0: 2020 2020 2073 7464 3a3a 7374 7269 6e67       std::string
-000cd0d0: 5f76 6965 7720 7061 7468 5f76 6965 7720  _view path_view 
-000cd0e0: 3d20 696e 7075 743b 0a20 2020 2020 2069  = input;.      i
-000cd0f0: 6620 286c 6f63 6174 696f 6e20 213d 2073  f (location != s
-000cd100: 7464 3a3a 7374 7269 6e67 5f76 6965 773a  td::string_view:
-000cd110: 3a6e 706f 7329 207b 0a20 2020 2020 2020  :npos) {.       
-000cd120: 2070 6174 685f 7669 6577 2e72 656d 6f76   path_view.remov
-000cd130: 655f 7375 6666 6978 2870 6174 685f 7669  e_suffix(path_vi
-000cd140: 6577 2e73 697a 6528 2920 2d20 6c6f 6361  ew.size() - loca
-000cd150: 7469 6f6e 293b 0a20 2020 2020 2020 2069  tion);.        i
-000cd160: 6e70 7574 2e72 656d 6f76 655f 7072 6566  nput.remove_pref
-000cd170: 6978 286c 6f63 6174 696f 6e20 2b20 3129  ix(location + 1)
-000cd180: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
-000cd190: 2f2f 2070 6174 685f 6275 6666 6572 2069  // path_buffer i
-000cd1a0: 7320 6569 7468 6572 2070 6174 685f 7669  s either path_vi
-000cd1b0: 6577 206f 7220 6974 206d 6967 6874 2070  ew or it might p
-000cd1c0: 6f69 6e74 2061 7420 6120 7065 7263 656e  oint at a percen
-000cd1d0: 7420 656e 636f 6465 640a 2020 2020 2020  t encoded.      
-000cd1e0: 2f2f 2074 656d 706f 7261 7279 2073 7472  // temporary str
-000cd1f0: 696e 672e 0a20 2020 2020 2073 7464 3a3a  ing..      std::
-000cd200: 7374 7269 6e67 5f76 6965 7720 7061 7468  string_view path
-000cd210: 5f62 7566 6665 7220 3d0a 2020 2020 2020  _buffer =.      
-000cd220: 2020 2020 286e 6565 6473 5f70 6572 6365      (needs_perce
-000cd230: 6e74 5f65 6e63 6f64 696e 6720 2626 0a20  nt_encoding &&. 
-000cd240: 2020 2020 2020 2020 2020 6164 613a 3a75            ada::u
-000cd250: 6e69 636f 6465 3a3a 7065 7263 656e 745f  nicode::percent_
-000cd260: 656e 636f 6465 3c66 616c 7365 3e28 0a20  encode<false>(. 
-000cd270: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-000cd280: 7468 5f76 6965 772c 2063 6861 7261 6374  th_view, charact
-000cd290: 6572 5f73 6574 733a 3a50 4154 485f 5045  er_sets::PATH_PE
-000cd2a0: 5243 454e 545f 454e 434f 4445 2c20 7061  RCENT_ENCODE, pa
-000cd2b0: 7468 5f62 7566 6665 725f 746d 7029 290a  th_buffer_tmp)).
-000cd2c0: 2020 2020 2020 2020 2020 2020 2020 3f20                ? 
-000cd2d0: 7061 7468 5f62 7566 6665 725f 746d 700a  path_buffer_tmp.
-000cd2e0: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
-000cd2f0: 7061 7468 5f76 6965 773b 0a20 2020 2020  path_view;.     
-000cd300: 2069 6620 2875 6e69 636f 6465 3a3a 6973   if (unicode::is
-000cd310: 5f64 6f75 626c 655f 646f 745f 7061 7468  _double_dot_path
-000cd320: 5f73 6567 6d65 6e74 2870 6174 685f 6275  _segment(path_bu
-000cd330: 6666 6572 2929 207b 0a20 2020 2020 2020  ffer)) {.       
-000cd340: 2069 6620 2828 6865 6c70 6572 733a 3a73   if ((helpers::s
-000cd350: 686f 7274 656e 5f70 6174 6828 7061 7468  horten_path(path
-000cd360: 2c20 7479 7065 2920 7c7c 2073 7065 6369  , type) || speci
-000cd370: 616c 2920 2626 0a20 2020 2020 2020 2020  al) &&.         
-000cd380: 2020 206c 6f63 6174 696f 6e20 3d3d 2073     location == s
-000cd390: 7464 3a3a 7374 7269 6e67 5f76 6965 773a  td::string_view:
-000cd3a0: 3a6e 706f 7329 207b 0a20 2020 2020 2020  :npos) {.       
-000cd3b0: 2020 2070 6174 6820 2b3d 2027 2f27 3b0a     path += '/';.
-000cd3c0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000cd3d0: 7d20 656c 7365 2069 6620 2875 6e69 636f  } else if (unico
-000cd3e0: 6465 3a3a 6973 5f73 696e 676c 655f 646f  de::is_single_do
-000cd3f0: 745f 7061 7468 5f73 6567 6d65 6e74 2870  t_path_segment(p
-000cd400: 6174 685f 6275 6666 6572 2920 2626 0a20  ath_buffer) &&. 
-000cd410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cd420: 286c 6f63 6174 696f 6e20 3d3d 2073 7464  (location == std
-000cd430: 3a3a 7374 7269 6e67 5f76 6965 773a 3a6e  ::string_view::n
-000cd440: 706f 7329 2920 7b0a 2020 2020 2020 2020  pos)) {.        
-000cd450: 7061 7468 202b 3d20 272f 273b 0a20 2020  path += '/';.   
-000cd460: 2020 207d 0a20 2020 2020 202f 2f20 4f74     }.      // Ot
-000cd470: 6865 7277 6973 652c 2069 6620 7061 7468  herwise, if path
-000cd480: 5f62 7566 6665 7220 6973 206e 6f74 2061  _buffer is not a
-000cd490: 2073 696e 676c 652d 646f 7420 7061 7468   single-dot path
-000cd4a0: 2073 6567 6d65 6e74 2c20 7468 656e 3a0a   segment, then:.
-000cd4b0: 2020 2020 2020 656c 7365 2069 6620 2821        else if (!
-000cd4c0: 756e 6963 6f64 653a 3a69 735f 7369 6e67  unicode::is_sing
-000cd4d0: 6c65 5f64 6f74 5f70 6174 685f 7365 676d  le_dot_path_segm
-000cd4e0: 656e 7428 7061 7468 5f62 7566 6665 7229  ent(path_buffer)
-000cd4f0: 2920 7b0a 2020 2020 2020 2020 2f2f 2049  ) {.        // I
-000cd500: 6620 7572 6ce2 8099 7320 7363 6865 6d65  f url...s scheme
-000cd510: 2069 7320 2266 696c 6522 2c20 7572 6ce2   is "file", url.
-000cd520: 8099 7320 7061 7468 2069 7320 656d 7074  ..s path is empt
-000cd530: 792c 2061 6e64 2070 6174 685f 6275 6666  y, and path_buff
-000cd540: 6572 2069 7320 610a 2020 2020 2020 2020  er is a.        
-000cd550: 2f2f 2057 696e 646f 7773 2064 7269 7665  // Windows drive
-000cd560: 206c 6574 7465 722c 2074 6865 6e20 7265   letter, then re
-000cd570: 706c 6163 6520 7468 6520 7365 636f 6e64  place the second
-000cd580: 2063 6f64 6520 706f 696e 7420 696e 0a20   code point in. 
-000cd590: 2020 2020 2020 202f 2f20 7061 7468 5f62         // path_b
-000cd5a0: 7566 6665 7220 7769 7468 2055 2b30 3033  uffer with U+003
-000cd5b0: 4120 283a 292e 0a20 2020 2020 2020 2069  A (:)..        i
-000cd5c0: 6620 2874 7970 6520 3d3d 2061 6461 3a3a  f (type == ada::
-000cd5d0: 7363 6865 6d65 3a3a 7479 7065 3a3a 4649  scheme::type::FI
-000cd5e0: 4c45 2026 2620 7061 7468 2e65 6d70 7479  LE && path.empty
-000cd5f0: 2829 2026 260a 2020 2020 2020 2020 2020  () &&.          
-000cd600: 2020 6368 6563 6b65 7273 3a3a 6973 5f77    checkers::is_w
-000cd610: 696e 646f 7773 5f64 7269 7665 5f6c 6574  indows_drive_let
-000cd620: 7465 7228 7061 7468 5f62 7566 6665 7229  ter(path_buffer)
-000cd630: 2920 7b0a 2020 2020 2020 2020 2020 7061  ) {.          pa
-000cd640: 7468 202b 3d20 272f 273b 0a20 2020 2020  th += '/';.     
-000cd650: 2020 2020 2070 6174 6820 2b3d 2070 6174       path += pat
-000cd660: 685f 6275 6666 6572 5b30 5d3b 0a20 2020  h_buffer[0];.   
-000cd670: 2020 2020 2020 2070 6174 6820 2b3d 2027         path += '
-000cd680: 3a27 3b0a 2020 2020 2020 2020 2020 7061  :';.          pa
-000cd690: 7468 5f62 7566 6665 722e 7265 6d6f 7665  th_buffer.remove
-000cd6a0: 5f70 7265 6669 7828 3229 3b0a 2020 2020  _prefix(2);.    
-000cd6b0: 2020 2020 2020 7061 7468 2e61 7070 656e        path.appen
-000cd6c0: 6428 7061 7468 5f62 7566 6665 7229 3b0a  d(path_buffer);.
-000cd6d0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-000cd6e0: 0a20 2020 2020 2020 2020 202f 2f20 4170  .          // Ap
-000cd6f0: 7065 6e64 2070 6174 685f 6275 6666 6572  pend path_buffer
-000cd700: 2074 6f20 7572 6ce2 8099 7320 7061 7468   to url...s path
-000cd710: 2e0a 2020 2020 2020 2020 2020 7061 7468  ..          path
-000cd720: 202b 3d20 272f 273b 0a20 2020 2020 2020   += '/';.       
-000cd730: 2020 2070 6174 682e 6170 7065 6e64 2870     path.append(p
-000cd740: 6174 685f 6275 6666 6572 293b 0a20 2020  ath_buffer);.   
-000cd750: 2020 2020 207d 0a20 2020 2020 207d 0a20       }.      }. 
-000cd760: 2020 2020 2069 6620 286c 6f63 6174 696f       if (locatio
-000cd770: 6e20 3d3d 2073 7464 3a3a 7374 7269 6e67  n == std::string
-000cd780: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
-000cd790: 2020 2020 2020 2075 7064 6174 655f 6261         update_ba
-000cd7a0: 7365 5f70 6174 686e 616d 6528 7061 7468  se_pathname(path
-000cd7b0: 293b 0a20 2020 2020 2020 2072 6574 7572  );.        retur
-000cd7c0: 6e3b 0a20 2020 2020 207d 0a20 2020 207d  n;.      }.    }
-000cd7d0: 2077 6869 6c65 2028 7472 7565 293b 0a20   while (true);. 
-000cd7e0: 207d 0a7d 0a7d 2020 2f2f 206e 616d 6573   }.}.}  // names
-000cd7f0: 7061 6365 2061 6461 0a2f 2a20 656e 6420  pace ada./* end 
-000cd800: 6669 6c65 2073 7263 2f75 726c 5f61 6767  file src/url_agg
-000cd810: 7265 6761 746f 722e 6370 7020 2a2f 0a2f  regator.cpp */./
-000cd820: 2a20 6265 6769 6e20 6669 6c65 2073 7263  * begin file src
-000cd830: 2f61 6461 5f63 2e63 7070 202a 2f0a 0a61  /ada_c.cpp */..a
-000cd840: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
-000cd850: 7572 6c5f 6167 6772 6567 6174 6f72 3e26  url_aggregator>&
-000cd860: 2067 6574 5f69 6e73 7461 6e63 6528 766f   get_instance(vo
-000cd870: 6964 2a20 7265 7375 6c74 2920 6e6f 6578  id* result) noex
-000cd880: 6365 7074 207b 0a20 2072 6574 7572 6e20  cept {.  return 
-000cd890: 2a28 6164 613a 3a72 6573 756c 743c 6164  *(ada::result<ad
-000cd8a0: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
-000cd8b0: 723e 2a29 7265 7375 6c74 3b0a 7d0a 0a65  r>*)result;.}..e
-000cd8c0: 7874 6572 6e20 2243 2220 7b0a 7479 7065  xtern "C" {.type
-000cd8d0: 6465 6620 766f 6964 2a20 6164 615f 7572  def void* ada_ur
-000cd8e0: 6c3b 0a0a 7374 7275 6374 2061 6461 5f73  l;..struct ada_s
-000cd8f0: 7472 696e 6720 7b0a 2020 636f 6e73 7420  tring {.  const 
-000cd900: 6368 6172 2a20 6461 7461 3b0a 2020 7369  char* data;.  si
-000cd910: 7a65 5f74 206c 656e 6774 683b 0a7d 3b0a  ze_t length;.};.
-000cd920: 0a73 7472 7563 7420 6164 615f 6f77 6e65  .struct ada_owne
-000cd930: 645f 7374 7269 6e67 207b 0a20 2063 6f6e  d_string {.  con
-000cd940: 7374 2063 6861 722a 2064 6174 613b 0a20  st char* data;. 
-000cd950: 2073 697a 655f 7420 6c65 6e67 7468 3b0a   size_t length;.
-000cd960: 7d3b 0a0a 6164 615f 7374 7269 6e67 2061  };..ada_string a
-000cd970: 6461 5f73 7472 696e 675f 6372 6561 7465  da_string_create
-000cd980: 2863 6f6e 7374 2063 6861 722a 2064 6174  (const char* dat
-000cd990: 612c 2073 697a 655f 7420 6c65 6e67 7468  a, size_t length
-000cd9a0: 2920 7b0a 2020 6164 615f 7374 7269 6e67  ) {.  ada_string
-000cd9b0: 206f 7574 7b7d 3b0a 2020 6f75 742e 6461   out{};.  out.da
-000cd9c0: 7461 203d 2064 6174 613b 0a20 206f 7574  ta = data;.  out
-000cd9d0: 2e6c 656e 6774 6820 3d20 6c65 6e67 7468  .length = length
-000cd9e0: 3b0a 2020 7265 7475 726e 206f 7574 3b0a  ;.  return out;.
-000cd9f0: 7d0a 0a73 7472 7563 7420 6164 615f 7572  }..struct ada_ur
-000cda00: 6c5f 636f 6d70 6f6e 656e 7473 207b 0a20  l_components {. 
-000cda10: 202f 2a0a 2020 202a 2042 7920 7573 696e   /*.   * By usin
-000cda20: 6720 3332 2d62 6974 2069 6e74 6567 6572  g 32-bit integer
-000cda30: 732c 2077 6520 696d 706c 6963 6974 6c79  s, we implicitly
-000cda40: 2061 7373 756d 6520 7468 6174 2074 6865   assume that the
-000cda50: 2055 524c 2073 7472 696e 670a 2020 202a   URL string.   *
-000cda60: 2063 616e 6e6f 7420 6578 6365 6564 2034   cannot exceed 4
-000cda70: 2047 422e 0a20 2020 2a0a 2020 202a 2068   GB..   *.   * h
-000cda80: 7474 7073 3a2f 2f75 7365 723a 7061 7373  ttps://user:pass
-000cda90: 4065 7861 6d70 6c65 2e63 6f6d 3a31 3233  @example.com:123
-000cdaa0: 342f 666f 6f2f 6261 723f 6261 7a23 7175  4/foo/bar?baz#qu
-000cdab0: 7578 0a20 2020 2a20 2020 2020 2020 7c20  ux.   *       | 
-000cdac0: 2020 2020 7c20 2020 207c 2020 2020 2020      |    |      
-000cdad0: 2020 2020 7c20 5e5e 5e5e 7c20 2020 2020      | ^^^^|     
-000cdae0: 2020 7c20 2020 7c0a 2020 202a 2020 2020    |   |.   *    
-000cdaf0: 2020 207c 2020 2020 207c 2020 2020 7c20     |     |    | 
-000cdb00: 2020 2020 2020 2020 207c 207c 2020 207c           | |   |
-000cdb10: 2020 2020 2020 207c 2020 2060 2d2d 2d2d         |   `----
-000cdb20: 2d20 6861 7368 5f73 7461 7274 0a20 2020  - hash_start.   
-000cdb30: 2a20 2020 2020 2020 7c20 2020 2020 7c20  *       |     | 
-000cdb40: 2020 207c 2020 2020 2020 2020 2020 7c20     |          | 
-000cdb50: 7c20 2020 7c20 2020 2020 2020 602d 2d2d  |   |       `---
-000cdb60: 2d2d 2d2d 2d2d 2073 6561 7263 685f 7374  ------ search_st
-000cdb70: 6172 740a 2020 202a 2020 2020 2020 207c  art.   *       |
-000cdb80: 2020 2020 207c 2020 2020 7c20 2020 2020       |    |     
-000cdb90: 2020 2020 207c 207c 2020 2060 2d2d 2d2d       | |   `----
-000cdba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 7061  ------------- pa
-000cdbb0: 7468 6e61 6d65 5f73 7461 7274 0a20 2020  thname_start.   
-000cdbc0: 2a20 2020 2020 2020 7c20 2020 2020 7c20  *       |     | 
-000cdbd0: 2020 207c 2020 2020 2020 2020 2020 7c20     |          | 
-000cdbe0: 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  `---------------
-000cdbf0: 2d2d 2d2d 2d2d 2070 6f72 740a 2020 202a  ------ port.   *
-000cdc00: 2020 2020 2020 207c 2020 2020 207c 2020         |     |  
-000cdc10: 2020 7c20 2020 2020 2020 2020 2060 2d2d    |          `--
-000cdc20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000cdc30: 2d2d 2d2d 2d20 686f 7374 5f65 6e64 0a20  ----- host_end. 
-000cdc40: 2020 2a20 2020 2020 2020 7c20 2020 2020    *       |     
-000cdc50: 7c20 2020 2060 2d2d 2d2d 2d2d 2d2d 2d2d  |    `----------
-000cdc60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000cdc70: 2d2d 2d2d 2d2d 2d2d 2068 6f73 745f 7374  -------- host_st
-000cdc80: 6172 740a 2020 202a 2020 2020 2020 207c  art.   *       |
-000cdc90: 2020 2020 2060 2d2d 2d2d 2d2d 2d2d 2d2d       `----------
-000cdca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000cdcb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 7573  ------------- us
-000cdcc0: 6572 6e61 6d65 5f65 6e64 0a20 2020 2a20  ername_end.   * 
-000cdcd0: 2020 2020 2020 602d 2d2d 2d2d 2d2d 2d2d        `---------
-000cdce0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000cdcf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000cdd00: 2d2d 2d2d 2070 726f 746f 636f 6c5f 656e  ---- protocol_en
-000cdd10: 640a 2020 202a 2f0a 2020 7569 6e74 3332  d.   */.  uint32
-000cdd20: 5f74 2070 726f 746f 636f 6c5f 656e 643b  _t protocol_end;
-000cdd30: 0a20 202f 2a2a 0a20 2020 2a20 5573 6572  .  /**.   * User
-000cdd40: 6e61 6d65 2065 6e64 2069 7320 6e6f 7420  name end is not 
-000cdd50: 606f 6d69 7474 6564 6020 6279 2064 6566  `omitted` by def
-000cdd60: 6175 6c74 2028 2d31 2920 746f 206d 616b  ault (-1) to mak
-000cdd70: 6520 7573 6572 6e61 6d65 2061 6e64 2070  e username and p
-000cdd80: 6173 7377 6f72 640a 2020 202a 2067 6574  assword.   * get
-000cdd90: 7465 7273 206c 6573 7320 636f 7374 6c79  ters less costly
-000cdda0: 2074 6f20 696d 706c 656d 656e 742e 0a20   to implement.. 
-000cddb0: 2020 2a2f 0a20 2075 696e 7433 325f 7420    */.  uint32_t 
-000cddc0: 7573 6572 6e61 6d65 5f65 6e64 3b0a 2020  username_end;.  
-000cddd0: 7569 6e74 3332 5f74 2068 6f73 745f 7374  uint32_t host_st
-000cdde0: 6172 743b 0a20 2075 696e 7433 325f 7420  art;.  uint32_t 
-000cddf0: 686f 7374 5f65 6e64 3b0a 2020 7569 6e74  host_end;.  uint
-000cde00: 3332 5f74 2070 6f72 743b 0a20 2075 696e  32_t port;.  uin
-000cde10: 7433 325f 7420 7061 7468 6e61 6d65 5f73  t32_t pathname_s
-000cde20: 7461 7274 3b0a 2020 7569 6e74 3332 5f74  tart;.  uint32_t
-000cde30: 2073 6561 7263 685f 7374 6172 743b 0a20   search_start;. 
-000cde40: 2075 696e 7433 325f 7420 6861 7368 5f73   uint32_t hash_s
-000cde50: 7461 7274 3b0a 7d3b 0a0a 6164 615f 7572  tart;.};..ada_ur
-000cde60: 6c20 6164 615f 7061 7273 6528 636f 6e73  l ada_parse(cons
-000cde70: 7420 6368 6172 2a20 696e 7075 742c 2073  t char* input, s
-000cde80: 697a 655f 7420 6c65 6e67 7468 2920 6e6f  ize_t length) no
-000cde90: 6578 6365 7074 207b 0a20 2072 6574 7572  except {.  retur
-000cdea0: 6e20 6e65 7720 6164 613a 3a72 6573 756c  n new ada::resul
-000cdeb0: 743c 6164 613a 3a75 726c 5f61 6767 7265  t<ada::url_aggre
-000cdec0: 6761 746f 723e 280a 2020 2020 2020 6164  gator>(.      ad
-000cded0: 613a 3a70 6172 7365 3c61 6461 3a3a 7572  a::parse<ada::ur
-000cdee0: 6c5f 6167 6772 6567 6174 6f72 3e28 7374  l_aggregator>(st
-000cdef0: 643a 3a73 7472 696e 675f 7669 6577 2869  d::string_view(i
-000cdf00: 6e70 7574 2c20 6c65 6e67 7468 2929 293b  nput, length)));
-000cdf10: 0a7d 0a0a 6164 615f 7572 6c20 6164 615f  .}..ada_url ada_
-000cdf20: 7061 7273 655f 7769 7468 5f62 6173 6528  parse_with_base(
-000cdf30: 636f 6e73 7420 6368 6172 2a20 696e 7075  const char* inpu
-000cdf40: 742c 2073 697a 655f 7420 696e 7075 745f  t, size_t input_
-000cdf50: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
-000cdf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cdf70: 2020 2020 636f 6e73 7420 6368 6172 2a20      const char* 
-000cdf80: 6261 7365 2c20 7369 7a65 5f74 2062 6173  base, size_t bas
-000cdf90: 655f 6c65 6e67 7468 2920 6e6f 6578 6365  e_length) noexce
-000cdfa0: 7074 207b 0a20 2061 7574 6f20 6261 7365  pt {.  auto base
-000cdfb0: 5f6f 7574 203d 0a20 2020 2020 2061 6461  _out =.      ada
-000cdfc0: 3a3a 7061 7273 653c 6164 613a 3a75 726c  ::parse<ada::url
-000cdfd0: 5f61 6767 7265 6761 746f 723e 2873 7464  _aggregator>(std
-000cdfe0: 3a3a 7374 7269 6e67 5f76 6965 7728 6261  ::string_view(ba
-000cdff0: 7365 2c20 6261 7365 5f6c 656e 6774 6829  se, base_length)
-000ce000: 293b 0a0a 2020 6966 2028 2162 6173 655f  );..  if (!base_
-000ce010: 6f75 7429 207b 0a20 2020 2072 6574 7572  out) {.    retur
-000ce020: 6e20 6e65 7720 6164 613a 3a72 6573 756c  n new ada::resul
-000ce030: 743c 6164 613a 3a75 726c 5f61 6767 7265  t<ada::url_aggre
-000ce040: 6761 746f 723e 2862 6173 655f 6f75 7429  gator>(base_out)
-000ce050: 3b0a 2020 7d0a 0a20 2072 6574 7572 6e20  ;.  }..  return 
-000ce060: 6e65 7720 6164 613a 3a72 6573 756c 743c  new ada::result<
-000ce070: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
-000ce080: 746f 723e 2861 6461 3a3a 7061 7273 653c  tor>(ada::parse<
-000ce090: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
-000ce0a0: 746f 723e 280a 2020 2020 2020 7374 643a  tor>(.      std:
-000ce0b0: 3a73 7472 696e 675f 7669 6577 2869 6e70  :string_view(inp
-000ce0c0: 7574 2c20 696e 7075 745f 6c65 6e67 7468  ut, input_length
-000ce0d0: 292c 2026 6261 7365 5f6f 7574 2e76 616c  ), &base_out.val
-000ce0e0: 7565 2829 2929 3b0a 7d0a 0a62 6f6f 6c20  ue()));.}..bool 
-000ce0f0: 6164 615f 6361 6e5f 7061 7273 6528 636f  ada_can_parse(co
-000ce100: 6e73 7420 6368 6172 2a20 696e 7075 742c  nst char* input,
-000ce110: 2073 697a 655f 7420 6c65 6e67 7468 2920   size_t length) 
-000ce120: 6e6f 6578 6365 7074 207b 0a20 2072 6574  noexcept {.  ret
-000ce130: 7572 6e20 6164 613a 3a63 616e 5f70 6172  urn ada::can_par
-000ce140: 7365 2873 7464 3a3a 7374 7269 6e67 5f76  se(std::string_v
-000ce150: 6965 7728 696e 7075 742c 206c 656e 6774  iew(input, lengt
-000ce160: 6829 293b 0a7d 0a0a 626f 6f6c 2061 6461  h));.}..bool ada
-000ce170: 5f63 616e 5f70 6172 7365 5f77 6974 685f  _can_parse_with_
-000ce180: 6261 7365 2863 6f6e 7374 2063 6861 722a  base(const char*
-000ce190: 2069 6e70 7574 2c20 7369 7a65 5f74 2069   input, size_t i
-000ce1a0: 6e70 7574 5f6c 656e 6774 682c 0a20 2020  nput_length,.   
-000ce1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000ce1c0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-000ce1d0: 6368 6172 2a20 6261 7365 2c20 7369 7a65  char* base, size
-000ce1e0: 5f74 2062 6173 655f 6c65 6e67 7468 2920  _t base_length) 
-000ce1f0: 6e6f 6578 6365 7074 207b 0a20 2061 7574  noexcept {.  aut
-000ce200: 6f20 6261 7365 5f76 6965 7720 3d20 7374  o base_view = st
-000ce210: 643a 3a73 7472 696e 675f 7669 6577 2862  d::string_view(b
-000ce220: 6173 652c 2062 6173 655f 6c65 6e67 7468  ase, base_length
-000ce230: 293b 0a20 2072 6574 7572 6e20 6164 613a  );.  return ada:
-000ce240: 3a63 616e 5f70 6172 7365 2873 7464 3a3a  :can_parse(std::
-000ce250: 7374 7269 6e67 5f76 6965 7728 696e 7075  string_view(inpu
-000ce260: 742c 2069 6e70 7574 5f6c 656e 6774 6829  t, input_length)
-000ce270: 2c20 2662 6173 655f 7669 6577 293b 0a7d  , &base_view);.}
-000ce280: 0a0a 766f 6964 2061 6461 5f66 7265 6528  ..void ada_free(
-000ce290: 6164 615f 7572 6c20 7265 7375 6c74 2920  ada_url result) 
-000ce2a0: 6e6f 6578 6365 7074 207b 0a20 2061 6461  noexcept {.  ada
-000ce2b0: 3a3a 7265 7375 6c74 3c61 6461 3a3a 7572  ::result<ada::ur
-000ce2c0: 6c5f 6167 6772 6567 6174 6f72 3e2a 2072  l_aggregator>* r
-000ce2d0: 203d 0a20 2020 2020 2028 6164 613a 3a72   =.      (ada::r
-000ce2e0: 6573 756c 743c 6164 613a 3a75 726c 5f61  esult<ada::url_a
-000ce2f0: 6767 7265 6761 746f 723e 2a29 7265 7375  ggregator>*)resu
-000ce300: 6c74 3b0a 2020 6465 6c65 7465 2072 3b0a  lt;.  delete r;.
-000ce310: 7d0a 0a62 6f6f 6c20 6164 615f 6973 5f76  }..bool ada_is_v
-000ce320: 616c 6964 2861 6461 5f75 726c 2072 6573  alid(ada_url res
-000ce330: 756c 7429 206e 6f65 7863 6570 7420 7b0a  ult) noexcept {.
-000ce340: 2020 6164 613a 3a72 6573 756c 743c 6164    ada::result<ad
-000ce350: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
-000ce360: 723e 2620 7220 3d20 6765 745f 696e 7374  r>& r = get_inst
-000ce370: 616e 6365 2872 6573 756c 7429 3b0a 2020  ance(result);.  
-000ce380: 7265 7475 726e 2072 2e68 6173 5f76 616c  return r.has_val
-000ce390: 7565 2829 3b0a 7d0a 0a2f 2f20 6361 6c6c  ue();.}..// call
-000ce3a0: 6572 206d 7573 7420 6672 6565 2074 6865  er must free the
-000ce3b0: 2072 6573 756c 7420 7769 7468 2061 6461   result with ada
-000ce3c0: 5f66 7265 655f 6f77 6e65 645f 7374 7269  _free_owned_stri
-000ce3d0: 6e67 0a61 6461 5f6f 776e 6564 5f73 7472  ng.ada_owned_str
-000ce3e0: 696e 6720 6164 615f 6765 745f 6f72 6967  ing ada_get_orig
-000ce3f0: 696e 2861 6461 5f75 726c 2072 6573 756c  in(ada_url resul
-000ce400: 7429 206e 6f65 7863 6570 7420 7b0a 2020  t) noexcept {.  
-000ce410: 6164 613a 3a72 6573 756c 743c 6164 613a  ada::result<ada:
-000ce420: 3a75 726c 5f61 6767 7265 6761 746f 723e  :url_aggregator>
-000ce430: 2620 7220 3d20 6765 745f 696e 7374 616e  & r = get_instan
-000ce440: 6365 2872 6573 756c 7429 3b0a 2020 6164  ce(result);.  ad
-000ce450: 615f 6f77 6e65 645f 7374 7269 6e67 206f  a_owned_string o
-000ce460: 776e 6564 3b0a 2020 6966 2028 2172 2920  wned;.  if (!r) 
-000ce470: 7b0a 2020 2020 6f77 6e65 642e 6461 7461  {.    owned.data
-000ce480: 203d 206e 756c 6c70 7472 3b0a 2020 2020   = nullptr;.    
-000ce490: 6f77 6e65 642e 6c65 6e67 7468 203d 2030  owned.length = 0
-000ce4a0: 3b0a 2020 2020 7265 7475 726e 206f 776e  ;.    return own
-000ce4b0: 6564 3b0a 2020 7d0a 2020 7374 643a 3a73  ed;.  }.  std::s
-000ce4c0: 7472 696e 6720 6f75 7420 3d20 722d 3e67  tring out = r->g
-000ce4d0: 6574 5f6f 7269 6769 6e28 293b 0a20 206f  et_origin();.  o
-000ce4e0: 776e 6564 2e6c 656e 6774 6820 3d20 6f75  wned.length = ou
-000ce4f0: 742e 7369 7a65 2829 3b0a 2020 6f77 6e65  t.size();.  owne
-000ce500: 642e 6461 7461 203d 206e 6577 2063 6861  d.data = new cha
-000ce510: 725b 6f77 6e65 642e 6c65 6e67 7468 5d3b  r[owned.length];
-000ce520: 0a20 206d 656d 6370 7928 2876 6f69 642a  .  memcpy((void*
-000ce530: 296f 776e 6564 2e64 6174 612c 206f 7574  )owned.data, out
-000ce540: 2e64 6174 6128 292c 206f 776e 6564 2e6c  .data(), owned.l
-000ce550: 656e 6774 6829 3b0a 2020 7265 7475 726e  ength);.  return
-000ce560: 206f 776e 6564 3b0a 7d0a 0a76 6f69 6420   owned;.}..void 
-000ce570: 6164 615f 6672 6565 5f6f 776e 6564 5f73  ada_free_owned_s
-000ce580: 7472 696e 6728 6164 615f 6f77 6e65 645f  tring(ada_owned_
-000ce590: 7374 7269 6e67 206f 776e 6564 2920 6e6f  string owned) no
-000ce5a0: 6578 6365 7074 207b 0a20 2064 656c 6574  except {.  delet
-000ce5b0: 655b 5d20 6f77 6e65 642e 6461 7461 3b0a  e[] owned.data;.
-000ce5c0: 2020 6f77 6e65 642e 6461 7461 203d 206e    owned.data = n
-000ce5d0: 756c 6c70 7472 3b0a 2020 6f77 6e65 642e  ullptr;.  owned.
-000ce5e0: 6c65 6e67 7468 203d 2030 3b0a 7d0a 0a61  length = 0;.}..a
-000ce5f0: 6461 5f73 7472 696e 6720 6164 615f 6765  da_string ada_ge
-000ce600: 745f 6872 6566 2861 6461 5f75 726c 2072  t_href(ada_url r
-000ce610: 6573 756c 7429 206e 6f65 7863 6570 7420  esult) noexcept 
-000ce620: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
-000ce630: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
-000ce640: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
-000ce650: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
-000ce660: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
-000ce670: 7265 7475 726e 2061 6461 5f73 7472 696e  return ada_strin
-000ce680: 675f 6372 6561 7465 284e 554c 4c2c 2030  g_create(NULL, 0
-000ce690: 293b 0a20 207d 0a20 2073 7464 3a3a 7374  );.  }.  std::st
-000ce6a0: 7269 6e67 5f76 6965 7720 6f75 7420 3d20  ring_view out = 
-000ce6b0: 722d 3e67 6574 5f68 7265 6628 293b 0a20  r->get_href();. 
-000ce6c0: 2072 6574 7572 6e20 6164 615f 7374 7269   return ada_stri
-000ce6d0: 6e67 5f63 7265 6174 6528 6f75 742e 6461  ng_create(out.da
-000ce6e0: 7461 2829 2c20 6f75 742e 6c65 6e67 7468  ta(), out.length
-000ce6f0: 2829 293b 0a7d 0a0a 6164 615f 7374 7269  ());.}..ada_stri
-000ce700: 6e67 2061 6461 5f67 6574 5f75 7365 726e  ng ada_get_usern
-000ce710: 616d 6528 6164 615f 7572 6c20 7265 7375  ame(ada_url resu
-000ce720: 6c74 2920 6e6f 6578 6365 7074 207b 0a20  lt) noexcept {. 
-000ce730: 2061 6461 3a3a 7265 7375 6c74 3c61 6461   ada::result<ada
-000ce740: 3a3a 7572 6c5f 6167 6772 6567 6174 6f72  ::url_aggregator
-000ce750: 3e26 2072 203d 2067 6574 5f69 6e73 7461  >& r = get_insta
-000ce760: 6e63 6528 7265 7375 6c74 293b 0a20 2069  nce(result);.  i
-000ce770: 6620 2821 7229 207b 0a20 2020 2072 6574  f (!r) {.    ret
-000ce780: 7572 6e20 6164 615f 7374 7269 6e67 5f63  urn ada_string_c
-000ce790: 7265 6174 6528 4e55 4c4c 2c20 3029 3b0a  reate(NULL, 0);.
-000ce7a0: 2020 7d0a 2020 7374 643a 3a73 7472 696e    }.  std::strin
-000ce7b0: 675f 7669 6577 206f 7574 203d 2072 2d3e  g_view out = r->
-000ce7c0: 6765 745f 7573 6572 6e61 6d65 2829 3b0a  get_username();.
-000ce7d0: 2020 7265 7475 726e 2061 6461 5f73 7472    return ada_str
-000ce7e0: 696e 675f 6372 6561 7465 286f 7574 2e64  ing_create(out.d
-000ce7f0: 6174 6128 292c 206f 7574 2e6c 656e 6774  ata(), out.lengt
-000ce800: 6828 2929 3b0a 7d0a 0a61 6461 5f73 7472  h());.}..ada_str
-000ce810: 696e 6720 6164 615f 6765 745f 7061 7373  ing ada_get_pass
-000ce820: 776f 7264 2861 6461 5f75 726c 2072 6573  word(ada_url res
-000ce830: 756c 7429 206e 6f65 7863 6570 7420 7b0a  ult) noexcept {.
-000ce840: 2020 6164 613a 3a72 6573 756c 743c 6164    ada::result<ad
-000ce850: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
-000ce860: 723e 2620 7220 3d20 6765 745f 696e 7374  r>& r = get_inst
-000ce870: 616e 6365 2872 6573 756c 7429 3b0a 2020  ance(result);.  
-000ce880: 6966 2028 2172 2920 7b0a 2020 2020 7265  if (!r) {.    re
-000ce890: 7475 726e 2061 6461 5f73 7472 696e 675f  turn ada_string_
-000ce8a0: 6372 6561 7465 284e 554c 4c2c 2030 293b  create(NULL, 0);
-000ce8b0: 0a20 207d 0a20 2073 7464 3a3a 7374 7269  .  }.  std::stri
-000ce8c0: 6e67 5f76 6965 7720 6f75 7420 3d20 722d  ng_view out = r-
-000ce8d0: 3e67 6574 5f70 6173 7377 6f72 6428 293b  >get_password();
-000ce8e0: 0a20 2072 6574 7572 6e20 6164 615f 7374  .  return ada_st
-000ce8f0: 7269 6e67 5f63 7265 6174 6528 6f75 742e  ring_create(out.
-000ce900: 6461 7461 2829 2c20 6f75 742e 6c65 6e67  data(), out.leng
-000ce910: 7468 2829 293b 0a7d 0a0a 6164 615f 7374  th());.}..ada_st
-000ce920: 7269 6e67 2061 6461 5f67 6574 5f70 6f72  ring ada_get_por
-000ce930: 7428 6164 615f 7572 6c20 7265 7375 6c74  t(ada_url result
-000ce940: 2920 6e6f 6578 6365 7074 207b 0a20 2061  ) noexcept {.  a
-000ce950: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
-000ce960: 7572 6c5f 6167 6772 6567 6174 6f72 3e26  url_aggregator>&
-000ce970: 2072 203d 2067 6574 5f69 6e73 7461 6e63   r = get_instanc
-000ce980: 6528 7265 7375 6c74 293b 0a20 2069 6620  e(result);.  if 
-000ce990: 2821 7229 207b 0a20 2020 2072 6574 7572  (!r) {.    retur
-000ce9a0: 6e20 6164 615f 7374 7269 6e67 5f63 7265  n ada_string_cre
-000ce9b0: 6174 6528 4e55 4c4c 2c20 3029 3b0a 2020  ate(NULL, 0);.  
-000ce9c0: 7d0a 2020 7374 643a 3a73 7472 696e 675f  }.  std::string_
-000ce9d0: 7669 6577 206f 7574 203d 2072 2d3e 6765  view out = r->ge
-000ce9e0: 745f 706f 7274 2829 3b0a 2020 7265 7475  t_port();.  retu
-000ce9f0: 726e 2061 6461 5f73 7472 696e 675f 6372  rn ada_string_cr
-000cea00: 6561 7465 286f 7574 2e64 6174 6128 292c  eate(out.data(),
-000cea10: 206f 7574 2e6c 656e 6774 6828 2929 3b0a   out.length());.
-000cea20: 7d0a 0a61 6461 5f73 7472 696e 6720 6164  }..ada_string ad
-000cea30: 615f 6765 745f 6861 7368 2861 6461 5f75  a_get_hash(ada_u
-000cea40: 726c 2072 6573 756c 7429 206e 6f65 7863  rl result) noexc
-000cea50: 6570 7420 7b0a 2020 6164 613a 3a72 6573  ept {.  ada::res
-000cea60: 756c 743c 6164 613a 3a75 726c 5f61 6767  ult<ada::url_agg
-000cea70: 7265 6761 746f 723e 2620 7220 3d20 6765  regator>& r = ge
-000cea80: 745f 696e 7374 616e 6365 2872 6573 756c  t_instance(resul
-000cea90: 7429 3b0a 2020 6966 2028 2172 2920 7b0a  t);.  if (!r) {.
-000ceaa0: 2020 2020 7265 7475 726e 2061 6461 5f73      return ada_s
-000ceab0: 7472 696e 675f 6372 6561 7465 284e 554c  tring_create(NUL
-000ceac0: 4c2c 2030 293b 0a20 207d 0a20 2073 7464  L, 0);.  }.  std
-000cead0: 3a3a 7374 7269 6e67 5f76 6965 7720 6f75  ::string_view ou
-000ceae0: 7420 3d20 722d 3e67 6574 5f68 6173 6828  t = r->get_hash(
-000ceaf0: 293b 0a20 2072 6574 7572 6e20 6164 615f  );.  return ada_
-000ceb00: 7374 7269 6e67 5f63 7265 6174 6528 6f75  string_create(ou
-000ceb10: 742e 6461 7461 2829 2c20 6f75 742e 6c65  t.data(), out.le
-000ceb20: 6e67 7468 2829 293b 0a7d 0a0a 6164 615f  ngth());.}..ada_
-000ceb30: 7374 7269 6e67 2061 6461 5f67 6574 5f68  string ada_get_h
-000ceb40: 6f73 7428 6164 615f 7572 6c20 7265 7375  ost(ada_url resu
-000ceb50: 6c74 2920 6e6f 6578 6365 7074 207b 0a20  lt) noexcept {. 
-000ceb60: 2061 6461 3a3a 7265 7375 6c74 3c61 6461   ada::result<ada
-000ceb70: 3a3a 7572 6c5f 6167 6772 6567 6174 6f72  ::url_aggregator
-000ceb80: 3e26 2072 203d 2067 6574 5f69 6e73 7461  >& r = get_insta
-000ceb90: 6e63 6528 7265 7375 6c74 293b 0a20 2069  nce(result);.  i
-000ceba0: 6620 2821 7229 207b 0a20 2020 2072 6574  f (!r) {.    ret
-000cebb0: 7572 6e20 6164 615f 7374 7269 6e67 5f63  urn ada_string_c
-000cebc0: 7265 6174 6528 4e55 4c4c 2c20 3029 3b0a  reate(NULL, 0);.
-000cebd0: 2020 7d0a 2020 7374 643a 3a73 7472 696e    }.  std::strin
-000cebe0: 675f 7669 6577 206f 7574 203d 2072 2d3e  g_view out = r->
-000cebf0: 6765 745f 686f 7374 2829 3b0a 2020 7265  get_host();.  re
-000cec00: 7475 726e 2061 6461 5f73 7472 696e 675f  turn ada_string_
-000cec10: 6372 6561 7465 286f 7574 2e64 6174 6128  create(out.data(
-000cec20: 292c 206f 7574 2e6c 656e 6774 6828 2929  ), out.length())
-000cec30: 3b0a 7d0a 0a61 6461 5f73 7472 696e 6720  ;.}..ada_string 
-000cec40: 6164 615f 6765 745f 686f 7374 6e61 6d65  ada_get_hostname
-000cec50: 2861 6461 5f75 726c 2072 6573 756c 7429  (ada_url result)
-000cec60: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
-000cec70: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
-000cec80: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
-000cec90: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
-000ceca0: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
-000cecb0: 2172 2920 7b0a 2020 2020 7265 7475 726e  !r) {.    return
-000cecc0: 2061 6461 5f73 7472 696e 675f 6372 6561   ada_string_crea
-000cecd0: 7465 284e 554c 4c2c 2030 293b 0a20 207d  te(NULL, 0);.  }
-000cece0: 0a20 2073 7464 3a3a 7374 7269 6e67 5f76  .  std::string_v
-000cecf0: 6965 7720 6f75 7420 3d20 722d 3e67 6574  iew out = r->get
-000ced00: 5f68 6f73 746e 616d 6528 293b 0a20 2072  _hostname();.  r
-000ced10: 6574 7572 6e20 6164 615f 7374 7269 6e67  eturn ada_string
-000ced20: 5f63 7265 6174 6528 6f75 742e 6461 7461  _create(out.data
-000ced30: 2829 2c20 6f75 742e 6c65 6e67 7468 2829  (), out.length()
-000ced40: 293b 0a7d 0a0a 6164 615f 7374 7269 6e67  );.}..ada_string
-000ced50: 2061 6461 5f67 6574 5f70 6174 686e 616d   ada_get_pathnam
-000ced60: 6528 6164 615f 7572 6c20 7265 7375 6c74  e(ada_url result
-000ced70: 2920 6e6f 6578 6365 7074 207b 0a20 2061  ) noexcept {.  a
-000ced80: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
-000ced90: 7572 6c5f 6167 6772 6567 6174 6f72 3e26  url_aggregator>&
-000ceda0: 2072 203d 2067 6574 5f69 6e73 7461 6e63   r = get_instanc
-000cedb0: 6528 7265 7375 6c74 293b 0a20 2069 6620  e(result);.  if 
-000cedc0: 2821 7229 207b 0a20 2020 2072 6574 7572  (!r) {.    retur
-000cedd0: 6e20 6164 615f 7374 7269 6e67 5f63 7265  n ada_string_cre
-000cede0: 6174 6528 4e55 4c4c 2c20 3029 3b0a 2020  ate(NULL, 0);.  
-000cedf0: 7d0a 2020 7374 643a 3a73 7472 696e 675f  }.  std::string_
-000cee00: 7669 6577 206f 7574 203d 2072 2d3e 6765  view out = r->ge
-000cee10: 745f 7061 7468 6e61 6d65 2829 3b0a 2020  t_pathname();.  
-000cee20: 7265 7475 726e 2061 6461 5f73 7472 696e  return ada_strin
-000cee30: 675f 6372 6561 7465 286f 7574 2e64 6174  g_create(out.dat
-000cee40: 6128 292c 206f 7574 2e6c 656e 6774 6828  a(), out.length(
-000cee50: 2929 3b0a 7d0a 0a61 6461 5f73 7472 696e  ));.}..ada_strin
-000cee60: 6720 6164 615f 6765 745f 7365 6172 6368  g ada_get_search
-000cee70: 2861 6461 5f75 726c 2072 6573 756c 7429  (ada_url result)
-000cee80: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
-000cee90: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
-000ceea0: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
-000ceeb0: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
-000ceec0: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
-000ceed0: 2172 2920 7b0a 2020 2020 7265 7475 726e  !r) {.    return
-000ceee0: 2061 6461 5f73 7472 696e 675f 6372 6561   ada_string_crea
-000ceef0: 7465 284e 554c 4c2c 2030 293b 0a20 207d  te(NULL, 0);.  }
-000cef00: 0a20 2073 7464 3a3a 7374 7269 6e67 5f76  .  std::string_v
-000cef10: 6965 7720 6f75 7420 3d20 722d 3e67 6574  iew out = r->get
-000cef20: 5f73 6561 7263 6828 293b 0a20 2072 6574  _search();.  ret
-000cef30: 7572 6e20 6164 615f 7374 7269 6e67 5f63  urn ada_string_c
-000cef40: 7265 6174 6528 6f75 742e 6461 7461 2829  reate(out.data()
-000cef50: 2c20 6f75 742e 6c65 6e67 7468 2829 293b  , out.length());
-000cef60: 0a7d 0a0a 6164 615f 7374 7269 6e67 2061  .}..ada_string a
-000cef70: 6461 5f67 6574 5f70 726f 746f 636f 6c28  da_get_protocol(
-000cef80: 6164 615f 7572 6c20 7265 7375 6c74 2920  ada_url result) 
-000cef90: 6e6f 6578 6365 7074 207b 0a20 2061 6461  noexcept {.  ada
-000cefa0: 3a3a 7265 7375 6c74 3c61 6461 3a3a 7572  ::result<ada::ur
-000cefb0: 6c5f 6167 6772 6567 6174 6f72 3e26 2072  l_aggregator>& r
-000cefc0: 203d 2067 6574 5f69 6e73 7461 6e63 6528   = get_instance(
-000cefd0: 7265 7375 6c74 293b 0a20 2069 6620 2821  result);.  if (!
-000cefe0: 7229 207b 0a20 2020 2072 6574 7572 6e20  r) {.    return 
-000ceff0: 6164 615f 7374 7269 6e67 5f63 7265 6174  ada_string_creat
-000cf000: 6528 4e55 4c4c 2c20 3029 3b0a 2020 7d0a  e(NULL, 0);.  }.
-000cf010: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
-000cf020: 6577 206f 7574 203d 2072 2d3e 6765 745f  ew out = r->get_
-000cf030: 7072 6f74 6f63 6f6c 2829 3b0a 2020 7265  protocol();.  re
-000cf040: 7475 726e 2061 6461 5f73 7472 696e 675f  turn ada_string_
-000cf050: 6372 6561 7465 286f 7574 2e64 6174 6128  create(out.data(
-000cf060: 292c 206f 7574 2e6c 656e 6774 6828 2929  ), out.length())
-000cf070: 3b0a 7d0a 0a62 6f6f 6c20 6164 615f 7365  ;.}..bool ada_se
-000cf080: 745f 6872 6566 2861 6461 5f75 726c 2072  t_href(ada_url r
-000cf090: 6573 756c 742c 2063 6f6e 7374 2063 6861  esult, const cha
-000cf0a0: 722a 2069 6e70 7574 2c20 7369 7a65 5f74  r* input, size_t
-000cf0b0: 206c 656e 6774 6829 206e 6f65 7863 6570   length) noexcep
-000cf0c0: 7420 7b0a 2020 6164 613a 3a72 6573 756c  t {.  ada::resul
-000cf0d0: 743c 6164 613a 3a75 726c 5f61 6767 7265  t<ada::url_aggre
-000cf0e0: 6761 746f 723e 2620 7220 3d20 6765 745f  gator>& r = get_
-000cf0f0: 696e 7374 616e 6365 2872 6573 756c 7429  instance(result)
-000cf100: 3b0a 2020 6966 2028 2172 2920 7b0a 2020  ;.  if (!r) {.  
-000cf110: 2020 7265 7475 726e 2066 616c 7365 3b0a    return false;.
-000cf120: 2020 7d0a 2020 7265 7475 726e 2072 2d3e    }.  return r->
-000cf130: 7365 745f 6872 6566 2873 7464 3a3a 7374  set_href(std::st
-000cf140: 7269 6e67 5f76 6965 7728 696e 7075 742c  ring_view(input,
-000cf150: 206c 656e 6774 6829 293b 0a7d 0a0a 626f   length));.}..bo
-000cf160: 6f6c 2061 6461 5f73 6574 5f68 6f73 7428  ol ada_set_host(
-000cf170: 6164 615f 7572 6c20 7265 7375 6c74 2c20  ada_url result, 
-000cf180: 636f 6e73 7420 6368 6172 2a20 696e 7075  const char* inpu
-000cf190: 742c 2073 697a 655f 7420 6c65 6e67 7468  t, size_t length
-000cf1a0: 2920 6e6f 6578 6365 7074 207b 0a20 2061  ) noexcept {.  a
-000cf1b0: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
-000cf1c0: 7572 6c5f 6167 6772 6567 6174 6f72 3e26  url_aggregator>&
-000cf1d0: 2072 203d 2067 6574 5f69 6e73 7461 6e63   r = get_instanc
-000cf1e0: 6528 7265 7375 6c74 293b 0a20 2069 6620  e(result);.  if 
-000cf1f0: 2821 7229 207b 0a20 2020 2072 6574 7572  (!r) {.    retur
-000cf200: 6e20 6661 6c73 653b 0a20 207d 0a20 2072  n false;.  }.  r
-000cf210: 6574 7572 6e20 722d 3e73 6574 5f68 6f73  eturn r->set_hos
-000cf220: 7428 7374 643a 3a73 7472 696e 675f 7669  t(std::string_vi
-000cf230: 6577 2869 6e70 7574 2c20 6c65 6e67 7468  ew(input, length
-000cf240: 2929 3b0a 7d0a 0a62 6f6f 6c20 6164 615f  ));.}..bool ada_
-000cf250: 7365 745f 686f 7374 6e61 6d65 2861 6461  set_hostname(ada
-000cf260: 5f75 726c 2072 6573 756c 742c 2063 6f6e  _url result, con
-000cf270: 7374 2063 6861 722a 2069 6e70 7574 2c0a  st char* input,.
-000cf280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cf290: 2020 2020 2020 7369 7a65 5f74 206c 656e        size_t len
-000cf2a0: 6774 6829 206e 6f65 7863 6570 7420 7b0a  gth) noexcept {.
-000cf2b0: 2020 6164 613a 3a72 6573 756c 743c 6164    ada::result<ad
-000cf2c0: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
-000cf2d0: 723e 2620 7220 3d20 6765 745f 696e 7374  r>& r = get_inst
-000cf2e0: 616e 6365 2872 6573 756c 7429 3b0a 2020  ance(result);.  
-000cf2f0: 6966 2028 2172 2920 7b0a 2020 2020 7265  if (!r) {.    re
-000cf300: 7475 726e 2066 616c 7365 3b0a 2020 7d0a  turn false;.  }.
-000cf310: 2020 7265 7475 726e 2072 2d3e 7365 745f    return r->set_
-000cf320: 686f 7374 6e61 6d65 2873 7464 3a3a 7374  hostname(std::st
-000cf330: 7269 6e67 5f76 6965 7728 696e 7075 742c  ring_view(input,
-000cf340: 206c 656e 6774 6829 293b 0a7d 0a0a 626f   length));.}..bo
-000cf350: 6f6c 2061 6461 5f73 6574 5f70 726f 746f  ol ada_set_proto
-000cf360: 636f 6c28 6164 615f 7572 6c20 7265 7375  col(ada_url resu
-000cf370: 6c74 2c20 636f 6e73 7420 6368 6172 2a20  lt, const char* 
-000cf380: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-000cf390: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-000cf3a0: 655f 7420 6c65 6e67 7468 2920 6e6f 6578  e_t length) noex
-000cf3b0: 6365 7074 207b 0a20 2061 6461 3a3a 7265  cept {.  ada::re
-000cf3c0: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
-000cf3d0: 6772 6567 6174 6f72 3e26 2072 203d 2067  gregator>& r = g
-000cf3e0: 6574 5f69 6e73 7461 6e63 6528 7265 7375  et_instance(resu
-000cf3f0: 6c74 293b 0a20 2069 6620 2821 7229 207b  lt);.  if (!r) {
-000cf400: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
-000cf410: 653b 0a20 207d 0a20 2072 6574 7572 6e20  e;.  }.  return 
-000cf420: 722d 3e73 6574 5f70 726f 746f 636f 6c28  r->set_protocol(
-000cf430: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000cf440: 2869 6e70 7574 2c20 6c65 6e67 7468 2929  (input, length))
-000cf450: 3b0a 7d0a 0a62 6f6f 6c20 6164 615f 7365  ;.}..bool ada_se
-000cf460: 745f 7573 6572 6e61 6d65 2861 6461 5f75  t_username(ada_u
-000cf470: 726c 2072 6573 756c 742c 2063 6f6e 7374  rl result, const
-000cf480: 2063 6861 722a 2069 6e70 7574 2c0a 2020   char* input,.  
-000cf490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000cf4a0: 2020 2020 7369 7a65 5f74 206c 656e 6774      size_t lengt
-000cf4b0: 6829 206e 6f65 7863 6570 7420 7b0a 2020  h) noexcept {.  
-000cf4c0: 6164 613a 3a72 6573 756c 743c 6164 613a  ada::result<ada:
-000cf4d0: 3a75 726c 5f61 6767 7265 6761 746f 723e  :url_aggregator>
-000cf4e0: 2620 7220 3d20 6765 745f 696e 7374 616e  & r = get_instan
-000cf4f0: 6365 2872 6573 756c 7429 3b0a 2020 6966  ce(result);.  if
-000cf500: 2028 2172 2920 7b0a 2020 2020 7265 7475   (!r) {.    retu
-000cf510: 726e 2066 616c 7365 3b0a 2020 7d0a 2020  rn false;.  }.  
-000cf520: 7265 7475 726e 2072 2d3e 7365 745f 7573  return r->set_us
-000cf530: 6572 6e61 6d65 2873 7464 3a3a 7374 7269  ername(std::stri
-000cf540: 6e67 5f76 6965 7728 696e 7075 742c 206c  ng_view(input, l
-000cf550: 656e 6774 6829 293b 0a7d 0a0a 626f 6f6c  ength));.}..bool
-000cf560: 2061 6461 5f73 6574 5f70 6173 7377 6f72   ada_set_passwor
-000cf570: 6428 6164 615f 7572 6c20 7265 7375 6c74  d(ada_url result
-000cf580: 2c20 636f 6e73 7420 6368 6172 2a20 696e  , const char* in
-000cf590: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
-000cf5a0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-000cf5b0: 7420 6c65 6e67 7468 2920 6e6f 6578 6365  t length) noexce
-000cf5c0: 7074 207b 0a20 2061 6461 3a3a 7265 7375  pt {.  ada::resu
-000cf5d0: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
-000cf5e0: 6567 6174 6f72 3e26 2072 203d 2067 6574  egator>& r = get
-000cf5f0: 5f69 6e73 7461 6e63 6528 7265 7375 6c74  _instance(result
-000cf600: 293b 0a20 2069 6620 2821 7229 207b 0a20  );.  if (!r) {. 
-000cf610: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-000cf620: 0a20 207d 0a20 2072 6574 7572 6e20 722d  .  }.  return r-
-000cf630: 3e73 6574 5f70 6173 7377 6f72 6428 7374  >set_password(st
-000cf640: 643a 3a73 7472 696e 675f 7669 6577 2869  d::string_view(i
-000cf650: 6e70 7574 2c20 6c65 6e67 7468 2929 3b0a  nput, length));.
-000cf660: 7d0a 0a62 6f6f 6c20 6164 615f 7365 745f  }..bool ada_set_
-000cf670: 706f 7274 2861 6461 5f75 726c 2072 6573  port(ada_url res
-000cf680: 756c 742c 2063 6f6e 7374 2063 6861 722a  ult, const char*
-000cf690: 2069 6e70 7574 2c20 7369 7a65 5f74 206c   input, size_t l
-000cf6a0: 656e 6774 6829 206e 6f65 7863 6570 7420  ength) noexcept 
-000cf6b0: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
-000cf6c0: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
-000cf6d0: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
-000cf6e0: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
-000cf6f0: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
-000cf700: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
-000cf710: 7d0a 2020 7265 7475 726e 2072 2d3e 7365  }.  return r->se
-000cf720: 745f 706f 7274 2873 7464 3a3a 7374 7269  t_port(std::stri
-000cf730: 6e67 5f76 6965 7728 696e 7075 742c 206c  ng_view(input, l
-000cf740: 656e 6774 6829 293b 0a7d 0a0a 626f 6f6c  ength));.}..bool
-000cf750: 2061 6461 5f73 6574 5f70 6174 686e 616d   ada_set_pathnam
-000cf760: 6528 6164 615f 7572 6c20 7265 7375 6c74  e(ada_url result
-000cf770: 2c20 636f 6e73 7420 6368 6172 2a20 696e  , const char* in
-000cf780: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
-000cf790: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-000cf7a0: 7420 6c65 6e67 7468 2920 6e6f 6578 6365  t length) noexce
-000cf7b0: 7074 207b 0a20 2061 6461 3a3a 7265 7375  pt {.  ada::resu
-000cf7c0: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
-000cf7d0: 6567 6174 6f72 3e26 2072 203d 2067 6574  egator>& r = get
-000cf7e0: 5f69 6e73 7461 6e63 6528 7265 7375 6c74  _instance(result
-000cf7f0: 293b 0a20 2069 6620 2821 7229 207b 0a20  );.  if (!r) {. 
-000cf800: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-000cf810: 0a20 207d 0a20 2072 6574 7572 6e20 722d  .  }.  return r-
-000cf820: 3e73 6574 5f70 6174 686e 616d 6528 7374  >set_pathname(st
-000cf830: 643a 3a73 7472 696e 675f 7669 6577 2869  d::string_view(i
-000cf840: 6e70 7574 2c20 6c65 6e67 7468 2929 3b0a  nput, length));.
-000cf850: 7d0a 0a76 6f69 6420 6164 615f 7365 745f  }..void ada_set_
-000cf860: 7365 6172 6368 2861 6461 5f75 726c 2072  search(ada_url r
-000cf870: 6573 756c 742c 2063 6f6e 7374 2063 6861  esult, const cha
-000cf880: 722a 2069 6e70 7574 2c20 7369 7a65 5f74  r* input, size_t
-000cf890: 206c 656e 6774 6829 206e 6f65 7863 6570   length) noexcep
-000cf8a0: 7420 7b0a 2020 6164 613a 3a72 6573 756c  t {.  ada::resul
-000cf8b0: 743c 6164 613a 3a75 726c 5f61 6767 7265  t<ada::url_aggre
-000cf8c0: 6761 746f 723e 2620 7220 3d20 6765 745f  gator>& r = get_
-000cf8d0: 696e 7374 616e 6365 2872 6573 756c 7429  instance(result)
-000cf8e0: 3b0a 2020 6966 2028 7229 207b 0a20 2020  ;.  if (r) {.   
-000cf8f0: 2072 2d3e 7365 745f 7365 6172 6368 2873   r->set_search(s
-000cf900: 7464 3a3a 7374 7269 6e67 5f76 6965 7728  td::string_view(
-000cf910: 696e 7075 742c 206c 656e 6774 6829 293b  input, length));
-000cf920: 0a20 207d 0a7d 0a0a 766f 6964 2061 6461  .  }.}..void ada
-000cf930: 5f73 6574 5f68 6173 6828 6164 615f 7572  _set_hash(ada_ur
-000cf940: 6c20 7265 7375 6c74 2c20 636f 6e73 7420  l result, const 
-000cf950: 6368 6172 2a20 696e 7075 742c 2073 697a  char* input, siz
-000cf960: 655f 7420 6c65 6e67 7468 2920 6e6f 6578  e_t length) noex
-000cf970: 6365 7074 207b 0a20 2061 6461 3a3a 7265  cept {.  ada::re
-000cf980: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
-000cf990: 6772 6567 6174 6f72 3e26 2072 203d 2067  gregator>& r = g
-000cf9a0: 6574 5f69 6e73 7461 6e63 6528 7265 7375  et_instance(resu
-000cf9b0: 6c74 293b 0a20 2069 6620 2872 2920 7b0a  lt);.  if (r) {.
-000cf9c0: 2020 2020 722d 3e73 6574 5f68 6173 6828      r->set_hash(
-000cf9d0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
-000cf9e0: 2869 6e70 7574 2c20 6c65 6e67 7468 2929  (input, length))
-000cf9f0: 3b0a 2020 7d0a 7d0a 0a62 6f6f 6c20 6164  ;.  }.}..bool ad
-000cfa00: 615f 6861 735f 6372 6564 656e 7469 616c  a_has_credential
-000cfa10: 7328 6164 615f 7572 6c20 7265 7375 6c74  s(ada_url result
-000cfa20: 2920 6e6f 6578 6365 7074 207b 0a20 2061  ) noexcept {.  a
-000cfa30: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
-000cfa40: 7572 6c5f 6167 6772 6567 6174 6f72 3e26  url_aggregator>&
-000cfa50: 2072 203d 2067 6574 5f69 6e73 7461 6e63   r = get_instanc
-000cfa60: 6528 7265 7375 6c74 293b 0a20 2069 6620  e(result);.  if 
-000cfa70: 2821 7229 207b 0a20 2020 2072 6574 7572  (!r) {.    retur
-000cfa80: 6e20 6661 6c73 653b 0a20 207d 0a20 2072  n false;.  }.  r
-000cfa90: 6574 7572 6e20 722d 3e68 6173 5f63 7265  eturn r->has_cre
-000cfaa0: 6465 6e74 6961 6c73 2829 3b0a 7d0a 0a62  dentials();.}..b
-000cfab0: 6f6f 6c20 6164 615f 6861 735f 656d 7074  ool ada_has_empt
-000cfac0: 795f 686f 7374 6e61 6d65 2861 6461 5f75  y_hostname(ada_u
-000cfad0: 726c 2072 6573 756c 7429 206e 6f65 7863  rl result) noexc
-000cfae0: 6570 7420 7b0a 2020 6164 613a 3a72 6573  ept {.  ada::res
-000cfaf0: 756c 743c 6164 613a 3a75 726c 5f61 6767  ult<ada::url_agg
-000cfb00: 7265 6761 746f 723e 2620 7220 3d20 6765  regator>& r = ge
-000cfb10: 745f 696e 7374 616e 6365 2872 6573 756c  t_instance(resul
-000cfb20: 7429 3b0a 2020 6966 2028 2172 2920 7b0a  t);.  if (!r) {.
-000cfb30: 2020 2020 7265 7475 726e 2066 616c 7365      return false
-000cfb40: 3b0a 2020 7d0a 2020 7265 7475 726e 2072  ;.  }.  return r
-000cfb50: 2d3e 6861 735f 656d 7074 795f 686f 7374  ->has_empty_host
-000cfb60: 6e61 6d65 2829 3b0a 7d0a 0a62 6f6f 6c20  name();.}..bool 
-000cfb70: 6164 615f 6861 735f 686f 7374 6e61 6d65  ada_has_hostname
-000cfb80: 2861 6461 5f75 726c 2072 6573 756c 7429  (ada_url result)
-000cfb90: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
-000cfba0: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
-000cfbb0: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
-000cfbc0: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
-000cfbd0: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
-000cfbe0: 2172 2920 7b0a 2020 2020 7265 7475 726e  !r) {.    return
-000cfbf0: 2066 616c 7365 3b0a 2020 7d0a 2020 7265   false;.  }.  re
-000cfc00: 7475 726e 2072 2d3e 6861 735f 686f 7374  turn r->has_host
-000cfc10: 6e61 6d65 2829 3b0a 7d0a 0a62 6f6f 6c20  name();.}..bool 
-000cfc20: 6164 615f 6861 735f 6e6f 6e5f 656d 7074  ada_has_non_empt
-000cfc30: 795f 7573 6572 6e61 6d65 2861 6461 5f75  y_username(ada_u
-000cfc40: 726c 2072 6573 756c 7429 206e 6f65 7863  rl result) noexc
-000cfc50: 6570 7420 7b0a 2020 6164 613a 3a72 6573  ept {.  ada::res
-000cfc60: 756c 743c 6164 613a 3a75 726c 5f61 6767  ult<ada::url_agg
-000cfc70: 7265 6761 746f 723e 2620 7220 3d20 6765  regator>& r = ge
-000cfc80: 745f 696e 7374 616e 6365 2872 6573 756c  t_instance(resul
-000cfc90: 7429 3b0a 2020 6966 2028 2172 2920 7b0a  t);.  if (!r) {.
-000cfca0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
-000cfcb0: 3b0a 2020 7d0a 2020 7265 7475 726e 2072  ;.  }.  return r
-000cfcc0: 2d3e 6861 735f 6e6f 6e5f 656d 7074 795f  ->has_non_empty_
-000cfcd0: 7573 6572 6e61 6d65 2829 3b0a 7d0a 0a62  username();.}..b
-000cfce0: 6f6f 6c20 6164 615f 6861 735f 6e6f 6e5f  ool ada_has_non_
-000cfcf0: 656d 7074 795f 7061 7373 776f 7264 2861  empty_password(a
-000cfd00: 6461 5f75 726c 2072 6573 756c 7429 206e  da_url result) n
-000cfd10: 6f65 7863 6570 7420 7b0a 2020 6164 613a  oexcept {.  ada:
-000cfd20: 3a72 6573 756c 743c 6164 613a 3a75 726c  :result<ada::url
-000cfd30: 5f61 6767 7265 6761 746f 723e 2620 7220  _aggregator>& r 
-000cfd40: 3d20 6765 745f 696e 7374 616e 6365 2872  = get_instance(r
-000cfd50: 6573 756c 7429 3b0a 2020 6966 2028 2172  esult);.  if (!r
-000cfd60: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
-000cfd70: 616c 7365 3b0a 2020 7d0a 2020 7265 7475  alse;.  }.  retu
-000cfd80: 726e 2072 2d3e 6861 735f 6e6f 6e5f 656d  rn r->has_non_em
-000cfd90: 7074 795f 7061 7373 776f 7264 2829 3b0a  pty_password();.
-000cfda0: 7d0a 0a62 6f6f 6c20 6164 615f 6861 735f  }..bool ada_has_
-000cfdb0: 706f 7274 2861 6461 5f75 726c 2072 6573  port(ada_url res
-000cfdc0: 756c 7429 206e 6f65 7863 6570 7420 7b0a  ult) noexcept {.
-000cfdd0: 2020 6164 613a 3a72 6573 756c 743c 6164    ada::result<ad
-000cfde0: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
-000cfdf0: 723e 2620 7220 3d20 6765 745f 696e 7374  r>& r = get_inst
-000cfe00: 616e 6365 2872 6573 756c 7429 3b0a 2020  ance(result);.  
-000cfe10: 6966 2028 2172 2920 7b0a 2020 2020 7265  if (!r) {.    re
-000cfe20: 7475 726e 2066 616c 7365 3b0a 2020 7d0a  turn false;.  }.
-000cfe30: 2020 7265 7475 726e 2072 2d3e 6861 735f    return r->has_
-000cfe40: 706f 7274 2829 3b0a 7d0a 0a62 6f6f 6c20  port();.}..bool 
-000cfe50: 6164 615f 6861 735f 7061 7373 776f 7264  ada_has_password
-000cfe60: 2861 6461 5f75 726c 2072 6573 756c 7429  (ada_url result)
-000cfe70: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
-000cfe80: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
-000cfe90: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
-000cfea0: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
-000cfeb0: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
-000cfec0: 2172 2920 7b0a 2020 2020 7265 7475 726e  !r) {.    return
-000cfed0: 2066 616c 7365 3b0a 2020 7d0a 2020 7265   false;.  }.  re
-000cfee0: 7475 726e 2072 2d3e 6861 735f 7061 7373  turn r->has_pass
-000cfef0: 776f 7264 2829 3b0a 7d0a 0a62 6f6f 6c20  word();.}..bool 
-000cff00: 6164 615f 6861 735f 6861 7368 2861 6461  ada_has_hash(ada
-000cff10: 5f75 726c 2072 6573 756c 7429 206e 6f65  _url result) noe
-000cff20: 7863 6570 7420 7b0a 2020 6164 613a 3a72  xcept {.  ada::r
-000cff30: 6573 756c 743c 6164 613a 3a75 726c 5f61  esult<ada::url_a
-000cff40: 6767 7265 6761 746f 723e 2620 7220 3d20  ggregator>& r = 
-000cff50: 6765 745f 696e 7374 616e 6365 2872 6573  get_instance(res
-000cff60: 756c 7429 3b0a 2020 6966 2028 2172 2920  ult);.  if (!r) 
-000cff70: 7b0a 2020 2020 7265 7475 726e 2066 616c  {.    return fal
-000cff80: 7365 3b0a 2020 7d0a 2020 7265 7475 726e  se;.  }.  return
-000cff90: 2072 2d3e 6861 735f 6861 7368 2829 3b0a   r->has_hash();.
-000cffa0: 7d0a 0a62 6f6f 6c20 6164 615f 6861 735f  }..bool ada_has_
-000cffb0: 7365 6172 6368 2861 6461 5f75 726c 2072  search(ada_url r
-000cffc0: 6573 756c 7429 206e 6f65 7863 6570 7420  esult) noexcept 
-000cffd0: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
-000cffe0: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
-000cfff0: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
-000d0000: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
-000d0010: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
-000d0020: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
-000d0030: 7d0a 2020 7265 7475 726e 2072 2d3e 6861  }.  return r->ha
-000d0040: 735f 7365 6172 6368 2829 3b0a 7d0a 0a2f  s_search();.}../
-000d0050: 2f20 7265 7475 726e 7320 6120 706f 696e  / returns a poin
-000d0060: 7465 7220 746f 2074 6865 2069 6e74 6572  ter to the inter
-000d0070: 6e61 6c20 7572 6c5f 6167 6772 6567 6174  nal url_aggregat
-000d0080: 6f72 3a3a 7572 6c5f 636f 6d70 6f6e 656e  or::url_componen
-000d0090: 7473 0a63 6f6e 7374 2061 6461 5f75 726c  ts.const ada_url
-000d00a0: 5f63 6f6d 706f 6e65 6e74 732a 2061 6461  _components* ada
-000d00b0: 5f67 6574 5f63 6f6d 706f 6e65 6e74 7328  _get_components(
-000d00c0: 6164 615f 7572 6c20 7265 7375 6c74 2920  ada_url result) 
-000d00d0: 6e6f 6578 6365 7074 207b 0a20 2073 7461  noexcept {.  sta
-000d00e0: 7469 635f 6173 7365 7274 2873 697a 656f  tic_assert(sizeo
-000d00f0: 6628 6164 615f 7572 6c5f 636f 6d70 6f6e  f(ada_url_compon
-000d0100: 656e 7473 2920 3d3d 2073 697a 656f 6628  ents) == sizeof(
-000d0110: 6164 613a 3a75 726c 5f63 6f6d 706f 6e65  ada::url_compone
-000d0120: 6e74 7329 293b 0a20 2061 6461 3a3a 7265  nts));.  ada::re
-000d0130: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
-000d0140: 6772 6567 6174 6f72 3e26 2072 203d 2067  gregator>& r = g
-000d0150: 6574 5f69 6e73 7461 6e63 6528 7265 7375  et_instance(resu
-000d0160: 6c74 293b 0a20 2069 6620 2821 7229 207b  lt);.  if (!r) {
-000d0170: 0a20 2020 2072 6574 7572 6e20 6e75 6c6c  .    return null
-000d0180: 7074 723b 0a20 207d 0a20 2072 6574 7572  ptr;.  }.  retur
-000d0190: 6e20 7265 696e 7465 7270 7265 745f 6361  n reinterpret_ca
-000d01a0: 7374 3c63 6f6e 7374 2061 6461 5f75 726c  st<const ada_url
-000d01b0: 5f63 6f6d 706f 6e65 6e74 732a 3e28 2672  _components*>(&r
-000d01c0: 2d3e 6765 745f 636f 6d70 6f6e 656e 7473  ->get_components
-000d01d0: 2829 293b 0a7d 0a7d 2020 2f2f 2065 7874  ());.}.}  // ext
-000d01e0: 6572 6e20 2243 220a 2f2a 2065 6e64 2066  ern "C"./* end f
-000d01f0: 696c 6520 7372 632f 6164 615f 632e 6370  ile src/ada_c.cp
-000d0200: 7020 2a2f 0a2f 2a20 656e 6420 6669 6c65  p */./* end file
-000d0210: 2073 7263 2f61 6461 2e63 7070 202a 2f0a   src/ada.cpp */.
+000c3440: 2066 616c 7365 3b0a 2020 7d0a 0a20 2069   false;.  }..  i
+000c3450: 6620 2873 7464 3a3a 616e 795f 6f66 2868  f (std::any_of(h
+000c3460: 6f73 742e 7661 6c75 6528 292e 6265 6769  ost.value().begi
+000c3470: 6e28 292c 2068 6f73 742e 7661 6c75 6528  n(), host.value(
+000c3480: 292e 656e 6428 292c 0a20 2020 2020 2020  ).end(),.       
+000c3490: 2020 2020 2020 2020 2020 2061 6461 3a3a             ada::
+000c34a0: 756e 6963 6f64 653a 3a69 735f 666f 7262  unicode::is_forb
+000c34b0: 6964 6465 6e5f 646f 6d61 696e 5f63 6f64  idden_domain_cod
+000c34c0: 655f 706f 696e 7429 2920 7b0a 2020 2020  e_point)) {.    
+000c34d0: 7265 7475 726e 2069 735f 7661 6c69 6420  return is_valid 
+000c34e0: 3d20 6661 6c73 653b 0a20 207d 0a0a 2020  = false;.  }..  
+000c34f0: 2f2f 2049 6620 6173 6369 6944 6f6d 6169  // If asciiDomai
+000c3500: 6e20 656e 6473 2069 6e20 6120 6e75 6d62  n ends in a numb
+000c3510: 6572 2c20 7468 656e 2072 6574 7572 6e20  er, then return 
+000c3520: 7468 6520 7265 7375 6c74 206f 6620 4950  the result of IP
+000c3530: 7634 2070 6172 7369 6e67 0a20 202f 2f20  v4 parsing.  // 
+000c3540: 6173 6369 6944 6f6d 6169 6e2e 0a20 2069  asciiDomain..  i
+000c3550: 6620 2863 6865 636b 6572 733a 3a69 735f  f (checkers::is_
+000c3560: 6970 7634 2868 6f73 742e 7661 6c75 6528  ipv4(host.value(
+000c3570: 2929 2920 7b0a 2020 2020 6164 615f 6c6f  ))) {.    ada_lo
+000c3580: 6728 2270 6172 7365 5f68 6f73 7420 676f  g("parse_host go
+000c3590: 7420 6970 7634 222c 202a 686f 7374 293b  t ipv4", *host);
+000c35a0: 0a20 2020 2072 6574 7572 6e20 7061 7273  .    return pars
+000c35b0: 655f 6970 7634 2868 6f73 742e 7661 6c75  e_ipv4(host.valu
+000c35c0: 6528 2929 3b0a 2020 7d0a 0a20 2075 7064  e());.  }..  upd
+000c35d0: 6174 655f 6261 7365 5f68 6f73 746e 616d  ate_base_hostnam
+000c35e0: 6528 686f 7374 2e76 616c 7565 2829 293b  e(host.value());
+000c35f0: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
+000c3600: 5545 2876 616c 6964 6174 6528 2929 3b0a  UE(validate());.
+000c3610: 2020 7265 7475 726e 2074 7275 653b 0a7d    return true;.}
+000c3620: 0a0a 7465 6d70 6c61 7465 203c 626f 6f6c  ..template <bool
+000c3630: 206f 7665 7272 6964 655f 686f 7374 6e61   override_hostna
+000c3640: 6d65 3e0a 626f 6f6c 2075 726c 5f61 6767  me>.bool url_agg
+000c3650: 7265 6761 746f 723a 3a73 6574 5f68 6f73  regator::set_hos
+000c3660: 745f 6f72 5f68 6f73 746e 616d 6528 636f  t_or_hostname(co
+000c3670: 6e73 7420 7374 643a 3a73 7472 696e 675f  nst std::string_
+000c3680: 7669 6577 2069 6e70 7574 2920 7b0a 2020  view input) {.  
+000c3690: 6164 615f 6c6f 6728 2275 726c 5f61 6767  ada_log("url_agg
+000c36a0: 7265 6761 746f 723a 3a73 6574 5f68 6f73  regator::set_hos
+000c36b0: 745f 6f72 5f68 6f73 746e 616d 6520 222c  t_or_hostname ",
+000c36c0: 2069 6e70 7574 293b 0a20 2041 4441 5f41   input);.  ADA_A
+000c36d0: 5353 4552 545f 5452 5545 2876 616c 6964  SSERT_TRUE(valid
+000c36e0: 6174 6528 2929 3b0a 2020 4144 415f 4153  ate());.  ADA_AS
+000c36f0: 5345 5254 5f54 5255 4528 2168 656c 7065  SERT_TRUE(!helpe
+000c3700: 7273 3a3a 6f76 6572 6c61 7073 2869 6e70  rs::overlaps(inp
+000c3710: 7574 2c20 6275 6666 6572 2929 3b0a 2020  ut, buffer));.  
+000c3720: 6966 2028 6861 735f 6f70 6171 7565 5f70  if (has_opaque_p
+000c3730: 6174 6829 207b 0a20 2020 2072 6574 7572  ath) {.    retur
+000c3740: 6e20 6661 6c73 653b 0a20 207d 0a0a 2020  n false;.  }..  
+000c3750: 7374 643a 3a73 7472 696e 6720 7072 6576  std::string prev
+000c3760: 696f 7573 5f68 6f73 7420 3d20 7374 643a  ious_host = std:
+000c3770: 3a73 7472 696e 6728 6765 745f 686f 7374  :string(get_host
+000c3780: 6e61 6d65 2829 293b 0a20 2075 696e 7433  name());.  uint3
+000c3790: 325f 7420 7072 6576 696f 7573 5f70 6f72  2_t previous_por
+000c37a0: 7420 3d20 636f 6d70 6f6e 656e 7473 2e70  t = components.p
+000c37b0: 6f72 743b 0a0a 2020 7369 7a65 5f74 2068  ort;..  size_t h
+000c37c0: 6f73 745f 656e 645f 706f 7320 3d20 696e  ost_end_pos = in
+000c37d0: 7075 742e 6669 6e64 2827 2327 293b 0a20  put.find('#');. 
+000c37e0: 2073 7464 3a3a 7374 7269 6e67 205f 686f   std::string _ho
+000c37f0: 7374 2869 6e70 7574 2e64 6174 6128 292c  st(input.data(),
+000c3800: 2068 6f73 745f 656e 645f 706f 7320 213d   host_end_pos !=
+000c3810: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000c3820: 773a 3a6e 706f 730a 2020 2020 2020 2020  w::npos.        
+000c3830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c3840: 2020 2020 2020 2020 2020 2020 2020 3f20                ? 
+000c3850: 686f 7374 5f65 6e64 5f70 6f73 0a20 2020  host_end_pos.   
+000c3860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c3870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c3880: 2020 203a 2069 6e70 7574 2e73 697a 6528     : input.size(
+000c3890: 2929 3b0a 2020 6865 6c70 6572 733a 3a72  ));.  helpers::r
+000c38a0: 656d 6f76 655f 6173 6369 695f 7461 625f  emove_ascii_tab_
+000c38b0: 6f72 5f6e 6577 6c69 6e65 285f 686f 7374  or_newline(_host
+000c38c0: 293b 0a20 2073 7464 3a3a 7374 7269 6e67  );.  std::string
+000c38d0: 5f76 6965 7720 6e65 775f 686f 7374 285f  _view new_host(_
+000c38e0: 686f 7374 293b 0a0a 2020 2f2f 2049 6620  host);..  // If 
+000c38f0: 7572 6c27 7320 7363 6865 6d65 2069 7320  url's scheme is 
+000c3900: 2266 696c 6522 2c20 7468 656e 2073 6574  "file", then set
+000c3910: 2073 7461 7465 2074 6f20 6669 6c65 2068   state to file h
+000c3920: 6f73 7420 7374 6174 652c 2069 6e73 7465  ost state, inste
+000c3930: 6164 206f 660a 2020 2f2f 2068 6f73 7420  ad of.  // host 
+000c3940: 7374 6174 652e 0a20 2069 6620 2874 7970  state..  if (typ
+000c3950: 6520 213d 2061 6461 3a3a 7363 6865 6d65  e != ada::scheme
+000c3960: 3a3a 7479 7065 3a3a 4649 4c45 2920 7b0a  ::type::FILE) {.
+000c3970: 2020 2020 7374 643a 3a73 7472 696e 675f      std::string_
+000c3980: 7669 6577 2068 6f73 745f 7669 6577 285f  view host_view(_
+000c3990: 686f 7374 2e64 6174 6128 292c 205f 686f  host.data(), _ho
+000c39a0: 7374 2e6c 656e 6774 6828 2929 3b0a 2020  st.length());.  
+000c39b0: 2020 6175 746f 205b 6c6f 6361 7469 6f6e    auto [location
+000c39c0: 2c20 666f 756e 645f 636f 6c6f 6e5d 203d  , found_colon] =
+000c39d0: 0a20 2020 2020 2020 2068 656c 7065 7273  .        helpers
+000c39e0: 3a3a 6765 745f 686f 7374 5f64 656c 696d  ::get_host_delim
+000c39f0: 6974 6572 5f6c 6f63 6174 696f 6e28 6973  iter_location(is
+000c3a00: 5f73 7065 6369 616c 2829 2c20 686f 7374  _special(), host
+000c3a10: 5f76 6965 7729 3b0a 0a20 2020 202f 2f20  _view);..    // 
+000c3a20: 4f74 6865 7277 6973 652c 2069 6620 6320  Otherwise, if c 
+000c3a30: 6973 2055 2b30 3033 4120 283a 2920 616e  is U+003A (:) an
+000c3a40: 6420 696e 7369 6465 4272 6163 6b65 7473  d insideBrackets
+000c3a50: 2069 7320 6661 6c73 652c 2074 6865 6e3a   is false, then:
+000c3a60: 0a20 2020 202f 2f20 4e6f 7465 3a20 7468  .    // Note: th
+000c3a70: 6520 2766 6f75 6e64 5f63 6f6c 6f6e 2720  e 'found_colon' 
+000c3a80: 7661 6c75 6520 6973 2074 7275 6520 6966  value is true if
+000c3a90: 2061 6e64 206f 6e6c 7920 6966 2061 2063   and only if a c
+000c3aa0: 6f6c 6f6e 2077 6173 0a20 2020 202f 2f20  olon was.    // 
+000c3ab0: 656e 636f 756e 7465 7265 6420 7768 696c  encountered whil
+000c3ac0: 6520 6e6f 7420 696e 7369 6465 2062 7261  e not inside bra
+000c3ad0: 636b 6574 732e 0a20 2020 2069 6620 2866  ckets..    if (f
+000c3ae0: 6f75 6e64 5f63 6f6c 6f6e 2920 7b0a 2020  ound_colon) {.  
+000c3af0: 2020 2020 6966 2028 6f76 6572 7269 6465      if (override
+000c3b00: 5f68 6f73 746e 616d 6529 207b 0a20 2020  _hostname) {.   
+000c3b10: 2020 2020 2072 6574 7572 6e20 6661 6c73       return fals
+000c3b20: 653b 0a20 2020 2020 207d 0a20 2020 2020  e;.      }.     
+000c3b30: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000c3b40: 7720 7375 625f 6275 6666 6572 203d 206e  w sub_buffer = n
+000c3b50: 6577 5f68 6f73 742e 7375 6273 7472 286c  ew_host.substr(l
+000c3b60: 6f63 6174 696f 6e20 2b20 3129 3b0a 2020  ocation + 1);.  
+000c3b70: 2020 2020 6966 2028 2173 7562 5f62 7566      if (!sub_buf
+000c3b80: 6665 722e 656d 7074 7928 2929 207b 0a20  fer.empty()) {. 
+000c3b90: 2020 2020 2020 2073 6574 5f70 6f72 7428         set_port(
+000c3ba0: 7375 625f 6275 6666 6572 293b 0a20 2020  sub_buffer);.   
+000c3bb0: 2020 207d 0a20 2020 207d 0a20 2020 202f     }.    }.    /
+000c3bc0: 2f20 4966 2075 726c 2069 7320 7370 6563  / If url is spec
+000c3bd0: 6961 6c20 616e 6420 686f 7374 5f76 6965  ial and host_vie
+000c3be0: 7720 6973 2074 6865 2065 6d70 7479 2073  w is the empty s
+000c3bf0: 7472 696e 672c 2076 616c 6964 6174 696f  tring, validatio
+000c3c00: 6e20 6572 726f 722c 0a20 2020 202f 2f20  n error,.    // 
+000c3c10: 7265 7475 726e 2066 6169 6c75 7265 2e20  return failure. 
+000c3c20: 4f74 6865 7277 6973 652c 2069 6620 7374  Otherwise, if st
+000c3c30: 6174 6520 6f76 6572 7269 6465 2069 7320  ate override is 
+000c3c40: 6769 7665 6e2c 2068 6f73 745f 7669 6577  given, host_view
+000c3c50: 2069 7320 7468 650a 2020 2020 2f2f 2065   is the.    // e
+000c3c60: 6d70 7479 2073 7472 696e 672c 2061 6e64  mpty string, and
+000c3c70: 2065 6974 6865 7220 7572 6c20 696e 636c   either url incl
+000c3c80: 7564 6573 2063 7265 6465 6e74 6961 6c73  udes credentials
+000c3c90: 206f 7220 7572 6ce2 8099 7320 706f 7274   or url...s port
+000c3ca0: 2069 730a 2020 2020 2f2f 206e 6f6e 2d6e   is.    // non-n
+000c3cb0: 756c 6c2c 2072 6574 7572 6e2e 0a20 2020  ull, return..   
+000c3cc0: 2065 6c73 6520 6966 2028 686f 7374 5f76   else if (host_v
+000c3cd0: 6965 772e 656d 7074 7928 2920 2626 0a20  iew.empty() &&. 
+000c3ce0: 2020 2020 2020 2020 2020 2020 2869 735f              (is_
+000c3cf0: 7370 6563 6961 6c28 2920 7c7c 2068 6173  special() || has
+000c3d00: 5f63 7265 6465 6e74 6961 6c73 2829 207c  _credentials() |
+000c3d10: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
+000c3d20: 636f 6d70 6f6e 656e 7473 2e70 6f72 7420  components.port 
+000c3d30: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
+000c3d40: 733a 3a6f 6d69 7474 6564 2929 207b 0a20  s::omitted)) {. 
+000c3d50: 2020 2020 2072 6574 7572 6e20 6661 6c73       return fals
+000c3d60: 653b 0a20 2020 207d 0a0a 2020 2020 2f2f  e;.    }..    //
+000c3d70: 204c 6574 2068 6f73 7420 6265 2074 6865   Let host be the
+000c3d80: 2072 6573 756c 7420 6f66 2068 6f73 7420   result of host 
+000c3d90: 7061 7273 696e 6720 686f 7374 5f76 6965  parsing host_vie
+000c3da0: 7720 7769 7468 2075 726c 2069 7320 6e6f  w with url is no
+000c3db0: 7420 7370 6563 6961 6c2e 0a20 2020 2069  t special..    i
+000c3dc0: 6620 2868 6f73 745f 7669 6577 2e65 6d70  f (host_view.emp
+000c3dd0: 7479 2829 2920 7b0a 2020 2020 2020 6966  ty()) {.      if
+000c3de0: 2028 6861 735f 686f 7374 6e61 6d65 2829   (has_hostname()
+000c3df0: 2920 7b0a 2020 2020 2020 2020 636c 6561  ) {.        clea
+000c3e00: 725f 686f 7374 6e61 6d65 2829 3b20 202f  r_hostname();  /
+000c3e10: 2f20 6561 7379 210a 2020 2020 2020 7d20  / easy!.      } 
+000c3e20: 656c 7365 2069 6620 2868 6173 5f64 6173  else if (has_das
+000c3e30: 685f 646f 7428 2929 207b 0a20 2020 2020  h_dot()) {.     
+000c3e40: 2020 2061 6464 5f61 7574 686f 7269 7479     add_authority
+000c3e50: 5f73 6c61 7368 6573 5f69 665f 6e65 6564  _slashes_if_need
+000c3e60: 6564 2829 3b0a 2020 2020 2020 2020 6465  ed();.        de
+000c3e70: 6c65 7465 5f64 6173 685f 646f 7428 293b  lete_dash_dot();
+000c3e80: 0a20 2020 2020 207d 0a20 2020 2020 2072  .      }.      r
+000c3e90: 6574 7572 6e20 7472 7565 3b0a 2020 2020  eturn true;.    
+000c3ea0: 7d0a 0a20 2020 2062 6f6f 6c20 7375 6363  }..    bool succ
+000c3eb0: 6565 6465 6420 3d20 7061 7273 655f 686f  eeded = parse_ho
+000c3ec0: 7374 2868 6f73 745f 7669 6577 293b 0a20  st(host_view);. 
+000c3ed0: 2020 2069 6620 2821 7375 6363 6565 6465     if (!succeede
+000c3ee0: 6429 207b 0a20 2020 2020 2075 7064 6174  d) {.      updat
+000c3ef0: 655f 6261 7365 5f68 6f73 746e 616d 6528  e_base_hostname(
+000c3f00: 7072 6576 696f 7573 5f68 6f73 7429 3b0a  previous_host);.
+000c3f10: 2020 2020 2020 7570 6461 7465 5f62 6173        update_bas
+000c3f20: 655f 706f 7274 2870 7265 7669 6f75 735f  e_port(previous_
+000c3f30: 706f 7274 293b 0a20 2020 207d 2065 6c73  port);.    } els
+000c3f40: 6520 6966 2028 6861 735f 6461 7368 5f64  e if (has_dash_d
+000c3f50: 6f74 2829 2920 7b0a 2020 2020 2020 2f2f  ot()) {.      //
+000c3f60: 2053 686f 756c 6420 7265 6d6f 7665 2064   Should remove d
+000c3f70: 6173 685f 646f 7420 6672 6f6d 2070 6174  ash_dot from pat
+000c3f80: 686e 616d 650a 2020 2020 2020 6465 6c65  hname.      dele
+000c3f90: 7465 5f64 6173 685f 646f 7428 293b 0a20  te_dash_dot();. 
+000c3fa0: 2020 207d 0a20 2020 2072 6574 7572 6e20     }.    return 
+000c3fb0: 7375 6363 6565 6465 643b 0a20 207d 0a0a  succeeded;.  }..
+000c3fc0: 2020 7369 7a65 5f74 206c 6f63 6174 696f    size_t locatio
+000c3fd0: 6e20 3d20 6e65 775f 686f 7374 2e66 696e  n = new_host.fin
+000c3fe0: 645f 6669 7273 745f 6f66 2822 2f5c 5c3f  d_first_of("/\\?
+000c3ff0: 2229 3b0a 2020 6966 2028 6c6f 6361 7469  ");.  if (locati
+000c4000: 6f6e 2021 3d20 7374 643a 3a73 7472 696e  on != std::strin
+000c4010: 675f 7669 6577 3a3a 6e70 6f73 2920 7b0a  g_view::npos) {.
+000c4020: 2020 2020 6e65 775f 686f 7374 2e72 656d      new_host.rem
+000c4030: 6f76 655f 7375 6666 6978 286e 6577 5f68  ove_suffix(new_h
+000c4040: 6f73 742e 6c65 6e67 7468 2829 202d 206c  ost.length() - l
+000c4050: 6f63 6174 696f 6e29 3b0a 2020 7d0a 0a20  ocation);.  }.. 
+000c4060: 2069 6620 286e 6577 5f68 6f73 742e 656d   if (new_host.em
+000c4070: 7074 7928 2929 207b 0a20 2020 202f 2f20  pty()) {.    // 
+000c4080: 5365 7420 7572 6ce2 8099 7320 686f 7374  Set url...s host
+000c4090: 2074 6f20 7468 6520 656d 7074 7920 7374   to the empty st
+000c40a0: 7269 6e67 2e0a 2020 2020 636c 6561 725f  ring..    clear_
+000c40b0: 686f 7374 6e61 6d65 2829 3b0a 2020 7d20  hostname();.  } 
+000c40c0: 656c 7365 207b 0a20 2020 202f 2f20 4c65  else {.    // Le
+000c40d0: 7420 686f 7374 2062 6520 7468 6520 7265  t host be the re
+000c40e0: 7375 6c74 206f 6620 686f 7374 2070 6172  sult of host par
+000c40f0: 7369 6e67 2062 7566 6665 7220 7769 7468  sing buffer with
+000c4100: 2075 726c 2069 7320 6e6f 7420 7370 6563   url is not spec
+000c4110: 6961 6c2e 0a20 2020 2069 6620 2821 7061  ial..    if (!pa
+000c4120: 7273 655f 686f 7374 286e 6577 5f68 6f73  rse_host(new_hos
+000c4130: 7429 2920 7b0a 2020 2020 2020 7570 6461  t)) {.      upda
+000c4140: 7465 5f62 6173 655f 686f 7374 6e61 6d65  te_base_hostname
+000c4150: 2870 7265 7669 6f75 735f 686f 7374 293b  (previous_host);
+000c4160: 0a20 2020 2020 2075 7064 6174 655f 6261  .      update_ba
+000c4170: 7365 5f70 6f72 7428 7072 6576 696f 7573  se_port(previous
+000c4180: 5f70 6f72 7429 3b0a 2020 2020 2020 7265  _port);.      re
+000c4190: 7475 726e 2066 616c 7365 3b0a 2020 2020  turn false;.    
+000c41a0: 7d0a 0a20 2020 202f 2f20 4966 2068 6f73  }..    // If hos
+000c41b0: 7420 6973 2022 6c6f 6361 6c68 6f73 7422  t is "localhost"
+000c41c0: 2c20 7468 656e 2073 6574 2068 6f73 7420  , then set host 
+000c41d0: 746f 2074 6865 2065 6d70 7479 2073 7472  to the empty str
+000c41e0: 696e 672e 0a20 2020 2069 6620 2868 656c  ing..    if (hel
+000c41f0: 7065 7273 3a3a 7375 6273 7472 696e 6728  pers::substring(
+000c4200: 6275 6666 6572 2c20 636f 6d70 6f6e 656e  buffer, componen
+000c4210: 7473 2e68 6f73 745f 7374 6172 742c 0a20  ts.host_start,. 
+000c4220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c4230: 2020 2020 2020 2020 2020 636f 6d70 6f6e            compon
+000c4240: 656e 7473 2e68 6f73 745f 656e 6429 203d  ents.host_end) =
+000c4250: 3d20 226c 6f63 616c 686f 7374 2229 207b  = "localhost") {
+000c4260: 0a20 2020 2020 2063 6c65 6172 5f68 6f73  .      clear_hos
+000c4270: 746e 616d 6528 293b 0a20 2020 207d 0a20  tname();.    }. 
+000c4280: 207d 0a20 2041 4441 5f41 5353 4552 545f   }.  ADA_ASSERT_
+000c4290: 5452 5545 2876 616c 6964 6174 6528 2929  TRUE(validate())
+000c42a0: 3b0a 2020 7265 7475 726e 2074 7275 653b  ;.  return true;
+000c42b0: 0a7d 0a0a 626f 6f6c 2075 726c 5f61 6767  .}..bool url_agg
+000c42c0: 7265 6761 746f 723a 3a73 6574 5f68 6f73  regator::set_hos
+000c42d0: 7428 636f 6e73 7420 7374 643a 3a73 7472  t(const std::str
+000c42e0: 696e 675f 7669 6577 2069 6e70 7574 2920  ing_view input) 
+000c42f0: 7b0a 2020 6164 615f 6c6f 6728 2275 726c  {.  ada_log("url
+000c4300: 5f61 6767 7265 6761 746f 723a 3a73 6574  _aggregator::set
+000c4310: 5f68 6f73 7420 2722 2c20 696e 7075 742c  _host '", input,
+000c4320: 2022 2722 293b 0a20 2041 4441 5f41 5353   "'");.  ADA_ASS
+000c4330: 4552 545f 5452 5545 2876 616c 6964 6174  ERT_TRUE(validat
+000c4340: 6528 2929 3b0a 2020 4144 415f 4153 5345  e());.  ADA_ASSE
+000c4350: 5254 5f54 5255 4528 2168 656c 7065 7273  RT_TRUE(!helpers
+000c4360: 3a3a 6f76 6572 6c61 7073 2869 6e70 7574  ::overlaps(input
+000c4370: 2c20 6275 6666 6572 2929 3b0a 2020 7265  , buffer));.  re
+000c4380: 7475 726e 2073 6574 5f68 6f73 745f 6f72  turn set_host_or
+000c4390: 5f68 6f73 746e 616d 653c 6661 6c73 653e  _hostname<false>
+000c43a0: 2869 6e70 7574 293b 0a7d 0a0a 626f 6f6c  (input);.}..bool
+000c43b0: 2075 726c 5f61 6767 7265 6761 746f 723a   url_aggregator:
+000c43c0: 3a73 6574 5f68 6f73 746e 616d 6528 636f  :set_hostname(co
+000c43d0: 6e73 7420 7374 643a 3a73 7472 696e 675f  nst std::string_
+000c43e0: 7669 6577 2069 6e70 7574 2920 7b0a 2020  view input) {.  
+000c43f0: 6164 615f 6c6f 6728 2275 726c 5f61 6767  ada_log("url_agg
+000c4400: 7265 6761 746f 723a 3a73 6574 5f68 6f73  regator::set_hos
+000c4410: 746e 616d 6520 2722 2c20 696e 7075 742c  tname '", input,
+000c4420: 2022 2722 293b 0a20 2041 4441 5f41 5353   "'");.  ADA_ASS
+000c4430: 4552 545f 5452 5545 2876 616c 6964 6174  ERT_TRUE(validat
+000c4440: 6528 2929 3b0a 2020 4144 415f 4153 5345  e());.  ADA_ASSE
+000c4450: 5254 5f54 5255 4528 2168 656c 7065 7273  RT_TRUE(!helpers
+000c4460: 3a3a 6f76 6572 6c61 7073 2869 6e70 7574  ::overlaps(input
+000c4470: 2c20 6275 6666 6572 2929 3b0a 2020 7265  , buffer));.  re
+000c4480: 7475 726e 2073 6574 5f68 6f73 745f 6f72  turn set_host_or
+000c4490: 5f68 6f73 746e 616d 653c 7472 7565 3e28  _hostname<true>(
+000c44a0: 696e 7075 7429 3b0a 7d0a 0a5b 5b6e 6f64  input);.}..[[nod
+000c44b0: 6973 6361 7264 5d5d 2073 7464 3a3a 7374  iscard]] std::st
+000c44c0: 7269 6e67 2075 726c 5f61 6767 7265 6761  ring url_aggrega
+000c44d0: 746f 723a 3a67 6574 5f6f 7269 6769 6e28  tor::get_origin(
+000c44e0: 2920 636f 6e73 7420 6e6f 6578 6365 7074  ) const noexcept
+000c44f0: 207b 0a20 2061 6461 5f6c 6f67 2822 7572   {.  ada_log("ur
+000c4500: 6c5f 6167 6772 6567 6174 6f72 3a3a 6765  l_aggregator::ge
+000c4510: 745f 6f72 6967 696e 2229 3b0a 2020 6966  t_origin");.  if
+000c4520: 2028 6973 5f73 7065 6369 616c 2829 2920   (is_special()) 
+000c4530: 7b0a 2020 2020 2f2f 2052 6574 7572 6e20  {.    // Return 
+000c4540: 6120 6e65 7720 6f70 6171 7565 206f 7269  a new opaque ori
+000c4550: 6769 6e2e 0a20 2020 2069 6620 2874 7970  gin..    if (typ
+000c4560: 6520 3d3d 2073 6368 656d 653a 3a46 494c  e == scheme::FIL
+000c4570: 4529 207b 0a20 2020 2020 2072 6574 7572  E) {.      retur
+000c4580: 6e20 226e 756c 6c22 3b0a 2020 2020 7d0a  n "null";.    }.
+000c4590: 0a20 2020 2072 6574 7572 6e20 6865 6c70  .    return help
+000c45a0: 6572 733a 3a63 6f6e 6361 7428 6765 745f  ers::concat(get_
+000c45b0: 7072 6f74 6f63 6f6c 2829 2c20 222f 2f22  protocol(), "//"
+000c45c0: 2c20 6765 745f 686f 7374 2829 293b 0a20  , get_host());. 
+000c45d0: 207d 0a0a 2020 6966 2028 6765 745f 7072   }..  if (get_pr
+000c45e0: 6f74 6f63 6f6c 2829 203d 3d20 2262 6c6f  otocol() == "blo
+000c45f0: 623a 2229 207b 0a20 2020 2073 7464 3a3a  b:") {.    std::
+000c4600: 7374 7269 6e67 5f76 6965 7720 7061 7468  string_view path
+000c4610: 203d 2067 6574 5f70 6174 686e 616d 6528   = get_pathname(
+000c4620: 293b 0a20 2020 2069 6620 2821 7061 7468  );.    if (!path
+000c4630: 2e65 6d70 7479 2829 2920 7b0a 2020 2020  .empty()) {.    
+000c4640: 2020 6175 746f 206f 7574 203d 2061 6461    auto out = ada
+000c4650: 3a3a 7061 7273 653c 6164 613a 3a75 726c  ::parse<ada::url
+000c4660: 5f61 6767 7265 6761 746f 723e 2870 6174  _aggregator>(pat
+000c4670: 6829 3b0a 2020 2020 2020 6966 2028 6f75  h);.      if (ou
+000c4680: 7420 2626 2028 6f75 742d 3e74 7970 6520  t && (out->type 
+000c4690: 3d3d 2073 6368 656d 653a 3a48 5454 5020  == scheme::HTTP 
+000c46a0: 7c7c 206f 7574 2d3e 7479 7065 203d 3d20  || out->type == 
+000c46b0: 7363 6865 6d65 3a3a 4854 5450 5329 2920  scheme::HTTPS)) 
+000c46c0: 7b0a 2020 2020 2020 2020 2f2f 2049 6620  {.        // If 
+000c46d0: 7061 7468 5552 4ce2 8099 7320 7363 6865  pathURL...s sche
+000c46e0: 6d65 2069 7320 6e6f 7420 2268 7474 7022  me is not "http"
+000c46f0: 2061 6e64 206e 6f74 2022 6874 7470 7322   and not "https"
+000c4700: 2c20 7468 656e 2072 6574 7572 6e20 610a  , then return a.
+000c4710: 2020 2020 2020 2020 2f2f 206e 6577 206f          // new o
+000c4720: 7061 7175 6520 6f72 6967 696e 2e0a 2020  paque origin..  
+000c4730: 2020 2020 2020 7265 7475 726e 2068 656c        return hel
+000c4740: 7065 7273 3a3a 636f 6e63 6174 286f 7574  pers::concat(out
+000c4750: 2d3e 6765 745f 7072 6f74 6f63 6f6c 2829  ->get_protocol()
+000c4760: 2c20 222f 2f22 2c20 6f75 742d 3e67 6574  , "//", out->get
+000c4770: 5f68 6f73 7428 2929 3b0a 2020 2020 2020  _host());.      
+000c4780: 7d0a 2020 2020 7d0a 2020 7d0a 0a20 202f  }.    }.  }..  /
+000c4790: 2f20 5265 7475 726e 2061 206e 6577 206f  / Return a new o
+000c47a0: 7061 7175 6520 6f72 6967 696e 2e0a 2020  paque origin..  
+000c47b0: 7265 7475 726e 2022 6e75 6c6c 223b 0a7d  return "null";.}
+000c47c0: 0a0a 5b5b 6e6f 6469 7363 6172 645d 5d20  ..[[nodiscard]] 
+000c47d0: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000c47e0: 2075 726c 5f61 6767 7265 6761 746f 723a   url_aggregator:
+000c47f0: 3a67 6574 5f75 7365 726e 616d 6528 2920  :get_username() 
+000c4800: 636f 6e73 7420 6e6f 6578 6365 7074 207b  const noexcept {
+000c4810: 0a20 2061 6461 5f6c 6f67 2822 7572 6c5f  .  ada_log("url_
+000c4820: 6167 6772 6567 6174 6f72 3a3a 6765 745f  aggregator::get_
+000c4830: 7573 6572 6e61 6d65 2229 3b0a 2020 6966  username");.  if
+000c4840: 2028 6861 735f 6e6f 6e5f 656d 7074 795f   (has_non_empty_
+000c4850: 7573 6572 6e61 6d65 2829 2920 7b0a 2020  username()) {.  
+000c4860: 2020 7265 7475 726e 2068 656c 7065 7273    return helpers
+000c4870: 3a3a 7375 6273 7472 696e 6728 6275 6666  ::substring(buff
+000c4880: 6572 2c20 636f 6d70 6f6e 656e 7473 2e70  er, components.p
+000c4890: 726f 746f 636f 6c5f 656e 6420 2b20 322c  rotocol_end + 2,
+000c48a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000c48b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000c48c0: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
+000c48d0: 6d65 5f65 6e64 293b 0a20 207d 0a20 2072  me_end);.  }.  r
+000c48e0: 6574 7572 6e20 2222 3b0a 7d0a 0a5b 5b6e  eturn "";.}..[[n
+000c48f0: 6f64 6973 6361 7264 5d5d 2073 7464 3a3a  odiscard]] std::
+000c4900: 7374 7269 6e67 5f76 6965 7720 7572 6c5f  string_view url_
+000c4910: 6167 6772 6567 6174 6f72 3a3a 6765 745f  aggregator::get_
+000c4920: 7061 7373 776f 7264 2829 2063 6f6e 7374  password() const
+000c4930: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
+000c4940: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
+000c4950: 6761 746f 723a 3a67 6574 5f70 6173 7377  gator::get_passw
+000c4960: 6f72 6422 293b 0a20 2069 6620 2868 6173  ord");.  if (has
+000c4970: 5f6e 6f6e 5f65 6d70 7479 5f70 6173 7377  _non_empty_passw
+000c4980: 6f72 6428 2929 207b 0a20 2020 2072 6574  ord()) {.    ret
+000c4990: 7572 6e20 6865 6c70 6572 733a 3a73 7562  urn helpers::sub
+000c49a0: 7374 7269 6e67 2862 7566 6665 722c 2063  string(buffer, c
+000c49b0: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
+000c49c0: 6d65 5f65 6e64 202b 2031 2c0a 2020 2020  me_end + 1,.    
+000c49d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c49e0: 2020 2020 2020 2020 2020 636f 6d70 6f6e            compon
+000c49f0: 656e 7473 2e68 6f73 745f 7374 6172 7429  ents.host_start)
+000c4a00: 3b0a 2020 7d0a 2020 7265 7475 726e 2022  ;.  }.  return "
+000c4a10: 223b 0a7d 0a0a 5b5b 6e6f 6469 7363 6172  ";.}..[[nodiscar
+000c4a20: 645d 5d20 7374 643a 3a73 7472 696e 675f  d]] std::string_
+000c4a30: 7669 6577 2075 726c 5f61 6767 7265 6761  view url_aggrega
+000c4a40: 746f 723a 3a67 6574 5f70 6f72 7428 2920  tor::get_port() 
+000c4a50: 636f 6e73 7420 6e6f 6578 6365 7074 207b  const noexcept {
+000c4a60: 0a20 2061 6461 5f6c 6f67 2822 7572 6c5f  .  ada_log("url_
+000c4a70: 6167 6772 6567 6174 6f72 3a3a 6765 745f  aggregator::get_
+000c4a80: 706f 7274 2229 3b0a 2020 6966 2028 636f  port");.  if (co
+000c4a90: 6d70 6f6e 656e 7473 2e70 6f72 7420 3d3d  mponents.port ==
+000c4aa0: 2075 726c 5f63 6f6d 706f 6e65 6e74 733a   url_components:
+000c4ab0: 3a6f 6d69 7474 6564 2920 7b0a 2020 2020  :omitted) {.    
+000c4ac0: 7265 7475 726e 2022 223b 0a20 207d 0a20  return "";.  }. 
+000c4ad0: 2072 6574 7572 6e20 6865 6c70 6572 733a   return helpers:
+000c4ae0: 3a73 7562 7374 7269 6e67 2862 7566 6665  :substring(buffe
+000c4af0: 722c 2063 6f6d 706f 6e65 6e74 732e 686f  r, components.ho
+000c4b00: 7374 5f65 6e64 202b 2031 2c0a 2020 2020  st_end + 1,.    
+000c4b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c4b20: 2020 2020 2020 2020 636f 6d70 6f6e 656e          componen
+000c4b30: 7473 2e70 6174 686e 616d 655f 7374 6172  ts.pathname_star
+000c4b40: 7429 3b0a 7d0a 0a5b 5b6e 6f64 6973 6361  t);.}..[[nodisca
+000c4b50: 7264 5d5d 2073 7464 3a3a 7374 7269 6e67  rd]] std::string
+000c4b60: 5f76 6965 7720 7572 6c5f 6167 6772 6567  _view url_aggreg
+000c4b70: 6174 6f72 3a3a 6765 745f 6861 7368 2829  ator::get_hash()
+000c4b80: 2063 6f6e 7374 206e 6f65 7863 6570 7420   const noexcept 
+000c4b90: 7b0a 2020 6164 615f 6c6f 6728 2275 726c  {.  ada_log("url
+000c4ba0: 5f61 6767 7265 6761 746f 723a 3a67 6574  _aggregator::get
+000c4bb0: 5f68 6173 6822 293b 0a20 202f 2f20 4966  _hash");.  // If
+000c4bc0: 2074 6869 73e2 8099 7320 5552 4ce2 8099   this...s URL...
+000c4bd0: 7320 6672 6167 6d65 6e74 2069 7320 6569  s fragment is ei
+000c4be0: 7468 6572 206e 756c 6c20 6f72 2074 6865  ther null or the
+000c4bf0: 2065 6d70 7479 2073 7472 696e 672c 2074   empty string, t
+000c4c00: 6865 6e20 7265 7475 726e 0a20 202f 2f20  hen return.  // 
+000c4c10: 7468 6520 656d 7074 7920 7374 7269 6e67  the empty string
+000c4c20: 2e20 5265 7475 726e 2055 2b30 3032 3320  . Return U+0023 
+000c4c30: 2823 292c 2066 6f6c 6c6f 7765 6420 6279  (#), followed by
+000c4c40: 2074 6869 73e2 8099 7320 5552 4ce2 8099   this...s URL...
+000c4c50: 7320 6672 6167 6d65 6e74 2e0a 2020 6966  s fragment..  if
+000c4c60: 2028 636f 6d70 6f6e 656e 7473 2e68 6173   (components.has
+000c4c70: 685f 7374 6172 7420 3d3d 2075 726c 5f63  h_start == url_c
+000c4c80: 6f6d 706f 6e65 6e74 733a 3a6f 6d69 7474  omponents::omitt
+000c4c90: 6564 2920 7b0a 2020 2020 7265 7475 726e  ed) {.    return
+000c4ca0: 2022 223b 0a20 207d 0a20 2069 6620 2862   "";.  }.  if (b
+000c4cb0: 7566 6665 722e 7369 7a65 2829 202d 2063  uffer.size() - c
+000c4cc0: 6f6d 706f 6e65 6e74 732e 6861 7368 5f73  omponents.hash_s
+000c4cd0: 7461 7274 203c 3d20 3129 207b 0a20 2020  tart <= 1) {.   
+000c4ce0: 2072 6574 7572 6e20 2222 3b0a 2020 7d0a   return "";.  }.
+000c4cf0: 2020 7265 7475 726e 2068 656c 7065 7273    return helpers
+000c4d00: 3a3a 7375 6273 7472 696e 6728 6275 6666  ::substring(buff
+000c4d10: 6572 2c20 636f 6d70 6f6e 656e 7473 2e68  er, components.h
+000c4d20: 6173 685f 7374 6172 7429 3b0a 7d0a 0a5b  ash_start);.}..[
+000c4d30: 5b6e 6f64 6973 6361 7264 5d5d 2073 7464  [nodiscard]] std
+000c4d40: 3a3a 7374 7269 6e67 5f76 6965 7720 7572  ::string_view ur
+000c4d50: 6c5f 6167 6772 6567 6174 6f72 3a3a 6765  l_aggregator::ge
+000c4d60: 745f 686f 7374 2829 2063 6f6e 7374 206e  t_host() const n
+000c4d70: 6f65 7863 6570 7420 7b0a 2020 6164 615f  oexcept {.  ada_
+000c4d80: 6c6f 6728 2275 726c 5f61 6767 7265 6761  log("url_aggrega
+000c4d90: 746f 723a 3a67 6574 5f68 6f73 7422 293b  tor::get_host");
+000c4da0: 0a20 202f 2f20 5465 6368 6e69 6361 6c6c  .  // Technicall
+000c4db0: 792c 2077 6520 7368 6f75 6c64 2063 6865  y, we should che
+000c4dc0: 636b 2069 6620 7468 6572 6520 6973 2061  ck if there is a
+000c4dd0: 2068 6f73 746e 616d 652c 2062 7574 0a20   hostname, but. 
+000c4de0: 202f 2f20 7468 6520 636f 6465 2062 656c   // the code bel
+000c4df0: 6f77 2077 6f72 6b73 2065 7665 6e20 6966  ow works even if
+000c4e00: 2074 6865 7265 2069 736e 2774 2e0a 2020   there isn't..  
+000c4e10: 2f2f 2069 6628 2168 6173 5f68 6f73 746e  // if(!has_hostn
+000c4e20: 616d 6528 2929 207b 2072 6574 7572 6e20  ame()) { return 
+000c4e30: 2222 3b20 7d0a 2020 7369 7a65 5f74 2073  ""; }.  size_t s
+000c4e40: 7461 7274 203d 2063 6f6d 706f 6e65 6e74  tart = component
+000c4e50: 732e 686f 7374 5f73 7461 7274 3b0a 2020  s.host_start;.  
+000c4e60: 6966 2028 636f 6d70 6f6e 656e 7473 2e68  if (components.h
+000c4e70: 6f73 745f 656e 6420 3e20 636f 6d70 6f6e  ost_end > compon
+000c4e80: 656e 7473 2e68 6f73 745f 7374 6172 7420  ents.host_start 
+000c4e90: 2626 0a20 2020 2020 2062 7566 6665 725b  &&.      buffer[
+000c4ea0: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
+000c4eb0: 7374 6172 745d 203d 3d20 2740 2729 207b  start] == '@') {
+000c4ec0: 0a20 2020 2073 7461 7274 2b2b 3b0a 2020  .    start++;.  
+000c4ed0: 7d0a 2020 2f2f 2069 6620 7765 2068 6176  }.  // if we hav
+000c4ee0: 6520 616e 2065 6d70 7479 2068 6f73 742c  e an empty host,
+000c4ef0: 2074 6865 6e20 7468 6520 7370 6163 6520   then the space 
+000c4f00: 6265 7477 6565 6e20 636f 6d70 6f6e 656e  between componen
+000c4f10: 7473 2e68 6f73 745f 656e 6420 616e 640a  ts.host_end and.
+000c4f20: 2020 2f2f 2063 6f6d 706f 6e65 6e74 732e    // components.
+000c4f30: 7061 7468 6e61 6d65 5f73 7461 7274 206d  pathname_start m
+000c4f40: 6179 2062 6520 6f63 6375 7069 6564 2062  ay be occupied b
+000c4f50: 7920 2f2e 0a20 2069 6620 2873 7461 7274  y /..  if (start
+000c4f60: 203d 3d20 636f 6d70 6f6e 656e 7473 2e68   == components.h
+000c4f70: 6f73 745f 656e 6429 207b 0a20 2020 2072  ost_end) {.    r
+000c4f80: 6574 7572 6e20 7374 643a 3a73 7472 696e  eturn std::strin
+000c4f90: 675f 7669 6577 2829 3b0a 2020 7d0a 2020  g_view();.  }.  
+000c4fa0: 7265 7475 726e 2068 656c 7065 7273 3a3a  return helpers::
+000c4fb0: 7375 6273 7472 696e 6728 6275 6666 6572  substring(buffer
+000c4fc0: 2c20 7374 6172 742c 2063 6f6d 706f 6e65  , start, compone
+000c4fd0: 6e74 732e 7061 7468 6e61 6d65 5f73 7461  nts.pathname_sta
+000c4fe0: 7274 293b 0a7d 0a0a 5b5b 6e6f 6469 7363  rt);.}..[[nodisc
+000c4ff0: 6172 645d 5d20 7374 643a 3a73 7472 696e  ard]] std::strin
+000c5000: 675f 7669 6577 2075 726c 5f61 6767 7265  g_view url_aggre
+000c5010: 6761 746f 723a 3a67 6574 5f68 6f73 746e  gator::get_hostn
+000c5020: 616d 6528 2920 636f 6e73 7420 6e6f 6578  ame() const noex
+000c5030: 6365 7074 207b 0a20 2061 6461 5f6c 6f67  cept {.  ada_log
+000c5040: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
+000c5050: 3a3a 6765 745f 686f 7374 6e61 6d65 2229  ::get_hostname")
+000c5060: 3b0a 2020 2f2f 2054 6563 686e 6963 616c  ;.  // Technical
+000c5070: 6c79 2c20 7765 2073 686f 756c 6420 6368  ly, we should ch
+000c5080: 6563 6b20 6966 2074 6865 7265 2069 7320  eck if there is 
+000c5090: 6120 686f 7374 6e61 6d65 2c20 6275 740a  a hostname, but.
+000c50a0: 2020 2f2f 2074 6865 2063 6f64 6520 6265    // the code be
+000c50b0: 6c6f 7720 776f 726b 7320 6576 656e 2069  low works even i
+000c50c0: 6620 7468 6572 6520 6973 6e27 742e 0a20  f there isn't.. 
+000c50d0: 202f 2f20 6966 2821 6861 735f 686f 7374   // if(!has_host
+000c50e0: 6e61 6d65 2829 2920 7b20 7265 7475 726e  name()) { return
+000c50f0: 2022 223b 207d 0a20 2073 697a 655f 7420   ""; }.  size_t 
+000c5100: 7374 6172 7420 3d20 636f 6d70 6f6e 656e  start = componen
+000c5110: 7473 2e68 6f73 745f 7374 6172 743b 0a20  ts.host_start;. 
+000c5120: 202f 2f20 536f 2068 6f73 745f 7374 6172   // So host_star
+000c5130: 7420 6973 206e 6f74 2077 6865 7265 2074  t is not where t
+000c5140: 6865 2068 6f73 7420 6265 6769 6e73 2e0a  he host begins..
+000c5150: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
+000c5160: 2e68 6f73 745f 656e 6420 3e20 636f 6d70  .host_end > comp
+000c5170: 6f6e 656e 7473 2e68 6f73 745f 7374 6172  onents.host_star
+000c5180: 7420 2626 0a20 2020 2020 2062 7566 6665  t &&.      buffe
+000c5190: 725b 636f 6d70 6f6e 656e 7473 2e68 6f73  r[components.hos
+000c51a0: 745f 7374 6172 745d 203d 3d20 2740 2729  t_start] == '@')
+000c51b0: 207b 0a20 2020 2073 7461 7274 2b2b 3b0a   {.    start++;.
+000c51c0: 2020 7d0a 2020 7265 7475 726e 2068 656c    }.  return hel
+000c51d0: 7065 7273 3a3a 7375 6273 7472 696e 6728  pers::substring(
+000c51e0: 6275 6666 6572 2c20 7374 6172 742c 2063  buffer, start, c
+000c51f0: 6f6d 706f 6e65 6e74 732e 686f 7374 5f65  omponents.host_e
+000c5200: 6e64 293b 0a7d 0a0a 5b5b 6e6f 6469 7363  nd);.}..[[nodisc
+000c5210: 6172 645d 5d20 7374 643a 3a73 7472 696e  ard]] std::strin
+000c5220: 675f 7669 6577 2075 726c 5f61 6767 7265  g_view url_aggre
+000c5230: 6761 746f 723a 3a67 6574 5f70 6174 686e  gator::get_pathn
+000c5240: 616d 6528 2920 636f 6e73 7420 6e6f 6578  ame() const noex
+000c5250: 6365 7074 207b 0a20 2061 6461 5f6c 6f67  cept {.  ada_log
+000c5260: 2822 7572 6c5f 6167 6772 6567 6174 6f72  ("url_aggregator
+000c5270: 3a3a 6765 745f 7061 7468 6e61 6d65 2070  ::get_pathname p
+000c5280: 6174 686e 616d 655f 7374 6172 7420 3d20  athname_start = 
+000c5290: 222c 0a20 2020 2020 2020 2020 2063 6f6d  ",.          com
+000c52a0: 706f 6e65 6e74 732e 7061 7468 6e61 6d65  ponents.pathname
+000c52b0: 5f73 7461 7274 2c20 2220 6275 6666 6572  _start, " buffer
+000c52c0: 2e73 697a 6528 2920 3d20 222c 2062 7566  .size() = ", buf
+000c52d0: 6665 722e 7369 7a65 2829 2c0a 2020 2020  fer.size(),.    
+000c52e0: 2020 2020 2020 2220 636f 6d70 6f6e 656e        " componen
+000c52f0: 7473 2e73 6561 7263 685f 7374 6172 7420  ts.search_start 
+000c5300: 3d20 222c 2063 6f6d 706f 6e65 6e74 732e  = ", components.
+000c5310: 7365 6172 6368 5f73 7461 7274 2c0a 2020  search_start,.  
+000c5320: 2020 2020 2020 2020 2220 636f 6d70 6f6e          " compon
+000c5330: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
+000c5340: 3d20 222c 2063 6f6d 706f 6e65 6e74 732e  = ", components.
+000c5350: 6861 7368 5f73 7461 7274 293b 0a20 2075  hash_start);.  u
+000c5360: 696e 7433 325f 7420 656e 6469 6e67 5f69  int32_t ending_i
+000c5370: 6e64 6578 203d 2075 696e 7433 325f 7428  ndex = uint32_t(
+000c5380: 6275 6666 6572 2e73 697a 6528 2929 3b0a  buffer.size());.
+000c5390: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
+000c53a0: 2e73 6561 7263 685f 7374 6172 7420 213d  .search_start !=
+000c53b0: 2075 726c 5f63 6f6d 706f 6e65 6e74 733a   url_components:
+000c53c0: 3a6f 6d69 7474 6564 2920 7b0a 2020 2020  :omitted) {.    
+000c53d0: 656e 6469 6e67 5f69 6e64 6578 203d 2063  ending_index = c
+000c53e0: 6f6d 706f 6e65 6e74 732e 7365 6172 6368  omponents.search
+000c53f0: 5f73 7461 7274 3b0a 2020 7d20 656c 7365  _start;.  } else
+000c5400: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
+000c5410: 6861 7368 5f73 7461 7274 2021 3d20 7572  hash_start != ur
+000c5420: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
+000c5430: 6974 7465 6429 207b 0a20 2020 2065 6e64  itted) {.    end
+000c5440: 696e 675f 696e 6465 7820 3d20 636f 6d70  ing_index = comp
+000c5450: 6f6e 656e 7473 2e68 6173 685f 7374 6172  onents.hash_star
+000c5460: 743b 0a20 207d 0a20 2072 6574 7572 6e20  t;.  }.  return 
+000c5470: 6865 6c70 6572 733a 3a73 7562 7374 7269  helpers::substri
+000c5480: 6e67 2862 7566 6665 722c 2063 6f6d 706f  ng(buffer, compo
+000c5490: 6e65 6e74 732e 7061 7468 6e61 6d65 5f73  nents.pathname_s
+000c54a0: 7461 7274 2c20 656e 6469 6e67 5f69 6e64  tart, ending_ind
+000c54b0: 6578 293b 0a7d 0a0a 5b5b 6e6f 6469 7363  ex);.}..[[nodisc
+000c54c0: 6172 645d 5d20 7374 643a 3a73 7472 696e  ard]] std::strin
+000c54d0: 675f 7669 6577 2075 726c 5f61 6767 7265  g_view url_aggre
+000c54e0: 6761 746f 723a 3a67 6574 5f73 6561 7263  gator::get_searc
+000c54f0: 6828 2920 636f 6e73 7420 6e6f 6578 6365  h() const noexce
+000c5500: 7074 207b 0a20 2061 6461 5f6c 6f67 2822  pt {.  ada_log("
+000c5510: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
+000c5520: 6765 745f 7365 6172 6368 2229 3b0a 2020  get_search");.  
+000c5530: 2f2f 2049 6620 7468 6973 e280 9973 2055  // If this...s U
+000c5540: 524c e280 9973 2071 7565 7279 2069 7320  RL...s query is 
+000c5550: 6569 7468 6572 206e 756c 6c20 6f72 2074  either null or t
+000c5560: 6865 2065 6d70 7479 2073 7472 696e 672c  he empty string,
+000c5570: 2074 6865 6e20 7265 7475 726e 2074 6865   then return the
+000c5580: 0a20 202f 2f20 656d 7074 7920 7374 7269  .  // empty stri
+000c5590: 6e67 2e20 5265 7475 726e 2055 2b30 3033  ng. Return U+003
+000c55a0: 4620 283f 292c 2066 6f6c 6c6f 7765 6420  F (?), followed 
+000c55b0: 6279 2074 6869 73e2 8099 7320 5552 4ce2  by this...s URL.
+000c55c0: 8099 7320 7175 6572 792e 0a20 2069 6620  ..s query..  if 
+000c55d0: 2863 6f6d 706f 6e65 6e74 732e 7365 6172  (components.sear
+000c55e0: 6368 5f73 7461 7274 203d 3d20 7572 6c5f  ch_start == url_
+000c55f0: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
+000c5600: 7465 6429 207b 0a20 2020 2072 6574 7572  ted) {.    retur
+000c5610: 6e20 2222 3b0a 2020 7d0a 2020 7569 6e74  n "";.  }.  uint
+000c5620: 3332 5f74 2065 6e64 696e 675f 696e 6465  32_t ending_inde
+000c5630: 7820 3d20 7569 6e74 3332 5f74 2862 7566  x = uint32_t(buf
+000c5640: 6665 722e 7369 7a65 2829 293b 0a20 2069  fer.size());.  i
+000c5650: 6620 2863 6f6d 706f 6e65 6e74 732e 6861  f (components.ha
+000c5660: 7368 5f73 7461 7274 2021 3d20 7572 6c5f  sh_start != url_
+000c5670: 636f 6d70 6f6e 656e 7473 3a3a 6f6d 6974  components::omit
+000c5680: 7465 6429 207b 0a20 2020 2065 6e64 696e  ted) {.    endin
+000c5690: 675f 696e 6465 7820 3d20 636f 6d70 6f6e  g_index = compon
+000c56a0: 656e 7473 2e68 6173 685f 7374 6172 743b  ents.hash_start;
+000c56b0: 0a20 207d 0a20 2069 6620 2865 6e64 696e  .  }.  if (endin
+000c56c0: 675f 696e 6465 7820 2d20 636f 6d70 6f6e  g_index - compon
+000c56d0: 656e 7473 2e73 6561 7263 685f 7374 6172  ents.search_star
+000c56e0: 7420 3c3d 2031 2920 7b0a 2020 2020 7265  t <= 1) {.    re
+000c56f0: 7475 726e 2022 223b 0a20 207d 0a20 2072  turn "";.  }.  r
+000c5700: 6574 7572 6e20 6865 6c70 6572 733a 3a73  eturn helpers::s
+000c5710: 7562 7374 7269 6e67 2862 7566 6665 722c  ubstring(buffer,
+000c5720: 2063 6f6d 706f 6e65 6e74 732e 7365 6172   components.sear
+000c5730: 6368 5f73 7461 7274 2c20 656e 6469 6e67  ch_start, ending
+000c5740: 5f69 6e64 6578 293b 0a7d 0a0a 5b5b 6e6f  _index);.}..[[no
+000c5750: 6469 7363 6172 645d 5d20 7374 643a 3a73  discard]] std::s
+000c5760: 7472 696e 675f 7669 6577 2075 726c 5f61  tring_view url_a
+000c5770: 6767 7265 6761 746f 723a 3a67 6574 5f70  ggregator::get_p
+000c5780: 726f 746f 636f 6c28 2920 636f 6e73 7420  rotocol() const 
+000c5790: 6e6f 6578 6365 7074 207b 0a20 2061 6461  noexcept {.  ada
+000c57a0: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
+000c57b0: 6174 6f72 3a3a 6765 745f 7072 6f74 6f63  ator::get_protoc
+000c57c0: 6f6c 2229 3b0a 2020 7265 7475 726e 2068  ol");.  return h
+000c57d0: 656c 7065 7273 3a3a 7375 6273 7472 696e  elpers::substrin
+000c57e0: 6728 6275 6666 6572 2c20 302c 2063 6f6d  g(buffer, 0, com
+000c57f0: 706f 6e65 6e74 732e 7072 6f74 6f63 6f6c  ponents.protocol
+000c5800: 5f65 6e64 293b 0a7d 0a0a 7374 643a 3a73  _end);.}..std::s
+000c5810: 7472 696e 6720 6164 613a 3a75 726c 5f61  tring ada::url_a
+000c5820: 6767 7265 6761 746f 723a 3a74 6f5f 7374  ggregator::to_st
+000c5830: 7269 6e67 2829 2063 6f6e 7374 207b 0a20  ring() const {. 
+000c5840: 2061 6461 5f6c 6f67 2822 7572 6c5f 6167   ada_log("url_ag
+000c5850: 6772 6567 6174 6f72 3a3a 746f 5f73 7472  gregator::to_str
+000c5860: 696e 6720 6275 6666 6572 3a22 2c20 6275  ing buffer:", bu
+000c5870: 6666 6572 2c20 225b 222c 2062 7566 6665  ffer, "[", buffe
+000c5880: 722e 7369 7a65 2829 2c0a 2020 2020 2020  r.size(),.      
+000c5890: 2020 2020 2220 6279 7465 735d 2229 3b0a      " bytes]");.
+000c58a0: 2020 6966 2028 2169 735f 7661 6c69 6429    if (!is_valid)
+000c58b0: 207b 0a20 2020 2072 6574 7572 6e20 226e   {.    return "n
+000c58c0: 756c 6c22 3b0a 2020 7d0a 0a20 2073 7464  ull";.  }..  std
+000c58d0: 3a3a 7374 7269 6e67 2061 6e73 7765 723b  ::string answer;
+000c58e0: 0a20 2061 7574 6f20 6261 636b 203d 2073  .  auto back = s
+000c58f0: 7464 3a3a 6261 636b 5f69 6e73 6572 745f  td::back_insert_
+000c5900: 6974 6572 6174 6f72 2861 6e73 7765 7229  iterator(answer)
+000c5910: 3b0a 2020 616e 7377 6572 2e61 7070 656e  ;.  answer.appen
+000c5920: 6428 227b 5c6e 2229 3b0a 0a20 2061 6e73  d("{\n");..  ans
+000c5930: 7765 722e 6170 7065 6e64 2822 5c74 5c22  wer.append("\t\"
+000c5940: 6275 6666 6572 5c22 3a5c 2222 293b 0a20  buffer\":\"");. 
+000c5950: 2068 656c 7065 7273 3a3a 656e 636f 6465   helpers::encode
+000c5960: 5f6a 736f 6e28 6275 6666 6572 2c20 6261  _json(buffer, ba
+000c5970: 636b 293b 0a20 2061 6e73 7765 722e 6170  ck);.  answer.ap
+000c5980: 7065 6e64 2822 5c22 2c5c 6e22 293b 0a0a  pend("\",\n");..
+000c5990: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000c59a0: 225c 745c 2270 726f 746f 636f 6c5c 223a  "\t\"protocol\":
+000c59b0: 5c22 2229 3b0a 2020 6865 6c70 6572 733a  \"");.  helpers:
+000c59c0: 3a65 6e63 6f64 655f 6a73 6f6e 2867 6574  :encode_json(get
+000c59d0: 5f70 726f 746f 636f 6c28 292c 2062 6163  _protocol(), bac
+000c59e0: 6b29 3b0a 2020 616e 7377 6572 2e61 7070  k);.  answer.app
+000c59f0: 656e 6428 225c 222c 5c6e 2229 3b0a 0a20  end("\",\n");.. 
+000c5a00: 2069 6620 2868 6173 5f63 7265 6465 6e74   if (has_credent
+000c5a10: 6961 6c73 2829 2920 7b0a 2020 2020 616e  ials()) {.    an
+000c5a20: 7377 6572 2e61 7070 656e 6428 225c 745c  swer.append("\t\
+000c5a30: 2275 7365 726e 616d 655c 223a 5c22 2229  "username\":\"")
+000c5a40: 3b0a 2020 2020 6865 6c70 6572 733a 3a65  ;.    helpers::e
+000c5a50: 6e63 6f64 655f 6a73 6f6e 2867 6574 5f75  ncode_json(get_u
+000c5a60: 7365 726e 616d 6528 292c 2062 6163 6b29  sername(), back)
+000c5a70: 3b0a 2020 2020 616e 7377 6572 2e61 7070  ;.    answer.app
+000c5a80: 656e 6428 225c 222c 5c6e 2229 3b0a 2020  end("\",\n");.  
+000c5a90: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000c5aa0: 225c 745c 2270 6173 7377 6f72 645c 223a  "\t\"password\":
+000c5ab0: 5c22 2229 3b0a 2020 2020 6865 6c70 6572  \"");.    helper
+000c5ac0: 733a 3a65 6e63 6f64 655f 6a73 6f6e 2867  s::encode_json(g
+000c5ad0: 6574 5f70 6173 7377 6f72 6428 292c 2062  et_password(), b
+000c5ae0: 6163 6b29 3b0a 2020 2020 616e 7377 6572  ack);.    answer
+000c5af0: 2e61 7070 656e 6428 225c 222c 5c6e 2229  .append("\",\n")
+000c5b00: 3b0a 2020 7d0a 0a20 2061 6e73 7765 722e  ;.  }..  answer.
+000c5b10: 6170 7065 6e64 2822 5c74 5c22 686f 7374  append("\t\"host
+000c5b20: 5c22 3a5c 2222 293b 0a20 2068 656c 7065  \":\"");.  helpe
+000c5b30: 7273 3a3a 656e 636f 6465 5f6a 736f 6e28  rs::encode_json(
+000c5b40: 6765 745f 686f 7374 2829 2c20 6261 636b  get_host(), back
+000c5b50: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
+000c5b60: 6e64 2822 5c22 2c5c 6e22 293b 0a0a 2020  nd("\",\n");..  
+000c5b70: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
+000c5b80: 745c 2270 6174 685c 223a 5c22 2229 3b0a  t\"path\":\"");.
+000c5b90: 2020 6865 6c70 6572 733a 3a65 6e63 6f64    helpers::encod
+000c5ba0: 655f 6a73 6f6e 2867 6574 5f70 6174 686e  e_json(get_pathn
+000c5bb0: 616d 6528 292c 2062 6163 6b29 3b0a 2020  ame(), back);.  
+000c5bc0: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
+000c5bd0: 222c 5c6e 2229 3b0a 2020 616e 7377 6572  ",\n");.  answer
+000c5be0: 2e61 7070 656e 6428 225c 745c 226f 7061  .append("\t\"opa
+000c5bf0: 7175 6520 7061 7468 5c22 3a22 293b 0a20  que path\":");. 
+000c5c00: 2061 6e73 7765 722e 6170 7065 6e64 2828   answer.append((
+000c5c10: 6861 735f 6f70 6171 7565 5f70 6174 6820  has_opaque_path 
+000c5c20: 3f20 2274 7275 6522 203a 2022 6661 6c73  ? "true" : "fals
+000c5c30: 6522 2929 3b0a 2020 616e 7377 6572 2e61  e"));.  answer.a
+000c5c40: 7070 656e 6428 222c 5c6e 2229 3b0a 0a20  ppend(",\n");.. 
+000c5c50: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
+000c5c60: 7365 6172 6368 5f73 7461 7274 2021 3d20  search_start != 
+000c5c70: 7572 6c5f 636f 6d70 6f6e 656e 7473 3a3a  url_components::
+000c5c80: 6f6d 6974 7465 6429 207b 0a20 2020 2061  omitted) {.    a
+000c5c90: 6e73 7765 722e 6170 7065 6e64 2822 5c74  nswer.append("\t
+000c5ca0: 5c22 7175 6572 795c 223a 5c22 2229 3b0a  \"query\":\"");.
+000c5cb0: 2020 2020 6865 6c70 6572 733a 3a65 6e63      helpers::enc
+000c5cc0: 6f64 655f 6a73 6f6e 2867 6574 5f73 6561  ode_json(get_sea
+000c5cd0: 7263 6828 292c 2062 6163 6b29 3b0a 2020  rch(), back);.  
+000c5ce0: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000c5cf0: 225c 222c 5c6e 2229 3b0a 2020 7d0a 2020  "\",\n");.  }.  
+000c5d00: 6966 2028 636f 6d70 6f6e 656e 7473 2e68  if (components.h
+000c5d10: 6173 685f 7374 6172 7420 213d 2075 726c  ash_start != url
+000c5d20: 5f63 6f6d 706f 6e65 6e74 733a 3a6f 6d69  _components::omi
+000c5d30: 7474 6564 2920 7b0a 2020 2020 616e 7377  tted) {.    answ
+000c5d40: 6572 2e61 7070 656e 6428 225c 745c 2266  er.append("\t\"f
+000c5d50: 7261 676d 656e 745c 223a 5c22 2229 3b0a  ragment\":\"");.
+000c5d60: 2020 2020 6865 6c70 6572 733a 3a65 6e63      helpers::enc
+000c5d70: 6f64 655f 6a73 6f6e 2867 6574 5f68 6173  ode_json(get_has
+000c5d80: 6828 292c 2062 6163 6b29 3b0a 2020 2020  h(), back);.    
+000c5d90: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
+000c5da0: 222c 5c6e 2229 3b0a 2020 7d0a 0a20 2061  ",\n");.  }..  a
+000c5db0: 7574 6f20 636f 6e76 6572 745f 6f66 6673  uto convert_offs
+000c5dc0: 6574 5f74 6f5f 7374 7269 6e67 203d 205b  et_to_string = [
+000c5dd0: 5d28 7569 6e74 3332 5f74 206f 6666 7365  ](uint32_t offse
+000c5de0: 7429 202d 3e20 7374 643a 3a73 7472 696e  t) -> std::strin
+000c5df0: 6720 7b0a 2020 2020 6966 2028 6f66 6673  g {.    if (offs
+000c5e00: 6574 203d 3d20 7572 6c5f 636f 6d70 6f6e  et == url_compon
+000c5e10: 656e 7473 3a3a 6f6d 6974 7465 6429 207b  ents::omitted) {
+000c5e20: 0a20 2020 2020 2072 6574 7572 6e20 226e  .      return "n
+000c5e30: 756c 6c22 3b0a 2020 2020 7d20 656c 7365  ull";.    } else
+000c5e40: 207b 0a20 2020 2020 2072 6574 7572 6e20   {.      return 
+000c5e50: 7374 643a 3a74 6f5f 7374 7269 6e67 286f  std::to_string(o
+000c5e60: 6666 7365 7429 3b0a 2020 2020 7d0a 2020  ffset);.    }.  
+000c5e70: 7d3b 0a0a 2020 616e 7377 6572 2e61 7070  };..  answer.app
+000c5e80: 656e 6428 225c 745c 2270 726f 746f 636f  end("\t\"protoco
+000c5e90: 6c5f 656e 645c 223a 2229 3b0a 2020 616e  l_end\":");.  an
+000c5ea0: 7377 6572 2e61 7070 656e 6428 636f 6e76  swer.append(conv
+000c5eb0: 6572 745f 6f66 6673 6574 5f74 6f5f 7374  ert_offset_to_st
+000c5ec0: 7269 6e67 2863 6f6d 706f 6e65 6e74 732e  ring(components.
+000c5ed0: 7072 6f74 6f63 6f6c 5f65 6e64 2929 3b0a  protocol_end));.
+000c5ee0: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000c5ef0: 222c 5c6e 2229 3b0a 0a20 2061 6e73 7765  ",\n");..  answe
+000c5f00: 722e 6170 7065 6e64 2822 5c74 5c22 7573  r.append("\t\"us
+000c5f10: 6572 6e61 6d65 5f65 6e64 5c22 3a22 293b  ername_end\":");
+000c5f20: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
+000c5f30: 2863 6f6e 7665 7274 5f6f 6666 7365 745f  (convert_offset_
+000c5f40: 746f 5f73 7472 696e 6728 636f 6d70 6f6e  to_string(compon
+000c5f50: 656e 7473 2e75 7365 726e 616d 655f 656e  ents.username_en
+000c5f60: 6429 293b 0a20 2061 6e73 7765 722e 6170  d));.  answer.ap
+000c5f70: 7065 6e64 2822 2c5c 6e22 293b 0a0a 2020  pend(",\n");..  
+000c5f80: 616e 7377 6572 2e61 7070 656e 6428 225c  answer.append("\
+000c5f90: 745c 2268 6f73 745f 7374 6172 745c 223a  t\"host_start\":
+000c5fa0: 2229 3b0a 2020 616e 7377 6572 2e61 7070  ");.  answer.app
+000c5fb0: 656e 6428 636f 6e76 6572 745f 6f66 6673  end(convert_offs
+000c5fc0: 6574 5f74 6f5f 7374 7269 6e67 2863 6f6d  et_to_string(com
+000c5fd0: 706f 6e65 6e74 732e 686f 7374 5f73 7461  ponents.host_sta
+000c5fe0: 7274 2929 3b0a 2020 616e 7377 6572 2e61  rt));.  answer.a
+000c5ff0: 7070 656e 6428 222c 5c6e 2229 3b0a 0a20  ppend(",\n");.. 
+000c6000: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
+000c6010: 5c74 5c22 686f 7374 5f65 6e64 5c22 3a22  \t\"host_end\":"
+000c6020: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
+000c6030: 6e64 2863 6f6e 7665 7274 5f6f 6666 7365  nd(convert_offse
+000c6040: 745f 746f 5f73 7472 696e 6728 636f 6d70  t_to_string(comp
+000c6050: 6f6e 656e 7473 2e68 6f73 745f 656e 6429  onents.host_end)
+000c6060: 293b 0a20 2061 6e73 7765 722e 6170 7065  );.  answer.appe
+000c6070: 6e64 2822 2c5c 6e22 293b 0a0a 2020 616e  nd(",\n");..  an
+000c6080: 7377 6572 2e61 7070 656e 6428 225c 745c  swer.append("\t\
+000c6090: 2270 6f72 745c 223a 2229 3b0a 2020 616e  "port\":");.  an
+000c60a0: 7377 6572 2e61 7070 656e 6428 636f 6e76  swer.append(conv
+000c60b0: 6572 745f 6f66 6673 6574 5f74 6f5f 7374  ert_offset_to_st
+000c60c0: 7269 6e67 2863 6f6d 706f 6e65 6e74 732e  ring(components.
+000c60d0: 706f 7274 2929 3b0a 2020 616e 7377 6572  port));.  answer
+000c60e0: 2e61 7070 656e 6428 222c 5c6e 2229 3b0a  .append(",\n");.
+000c60f0: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
+000c6100: 2822 5c74 5c22 7061 7468 6e61 6d65 5f73  ("\t\"pathname_s
+000c6110: 7461 7274 5c22 3a22 293b 0a20 2061 6e73  tart\":");.  ans
+000c6120: 7765 722e 6170 7065 6e64 2863 6f6e 7665  wer.append(conve
+000c6130: 7274 5f6f 6666 7365 745f 746f 5f73 7472  rt_offset_to_str
+000c6140: 696e 6728 636f 6d70 6f6e 656e 7473 2e70  ing(components.p
+000c6150: 6174 686e 616d 655f 7374 6172 7429 293b  athname_start));
+000c6160: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
+000c6170: 2822 2c5c 6e22 293b 0a0a 2020 616e 7377  (",\n");..  answ
+000c6180: 6572 2e61 7070 656e 6428 225c 745c 2273  er.append("\t\"s
+000c6190: 6561 7263 685f 7374 6172 745c 223a 2229  earch_start\":")
+000c61a0: 3b0a 2020 616e 7377 6572 2e61 7070 656e  ;.  answer.appen
+000c61b0: 6428 636f 6e76 6572 745f 6f66 6673 6574  d(convert_offset
+000c61c0: 5f74 6f5f 7374 7269 6e67 2863 6f6d 706f  _to_string(compo
+000c61d0: 6e65 6e74 732e 7365 6172 6368 5f73 7461  nents.search_sta
+000c61e0: 7274 2929 3b0a 2020 616e 7377 6572 2e61  rt));.  answer.a
+000c61f0: 7070 656e 6428 222c 5c6e 2229 3b0a 0a20  ppend(",\n");.. 
+000c6200: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
+000c6210: 5c74 5c22 6861 7368 5f73 7461 7274 5c22  \t\"hash_start\"
+000c6220: 3a22 293b 0a20 2061 6e73 7765 722e 6170  :");.  answer.ap
+000c6230: 7065 6e64 2863 6f6e 7665 7274 5f6f 6666  pend(convert_off
+000c6240: 7365 745f 746f 5f73 7472 696e 6728 636f  set_to_string(co
+000c6250: 6d70 6f6e 656e 7473 2e68 6173 685f 7374  mponents.hash_st
+000c6260: 6172 7429 293b 0a20 2061 6e73 7765 722e  art));.  answer.
+000c6270: 6170 7065 6e64 2822 5c6e 7d22 293b 0a0a  append("\n}");..
+000c6280: 2020 7265 7475 726e 2061 6e73 7765 723b    return answer;
+000c6290: 0a7d 0a0a 5b5b 6e6f 6469 7363 6172 645d  .}..[[nodiscard]
+000c62a0: 5d20 626f 6f6c 2075 726c 5f61 6767 7265  ] bool url_aggre
+000c62b0: 6761 746f 723a 3a68 6173 5f76 616c 6964  gator::has_valid
+000c62c0: 5f64 6f6d 6169 6e28 2920 636f 6e73 7420  _domain() const 
+000c62d0: 6e6f 6578 6365 7074 207b 0a20 2069 6620  noexcept {.  if 
+000c62e0: 2863 6f6d 706f 6e65 6e74 732e 686f 7374  (components.host
+000c62f0: 5f73 7461 7274 203d 3d20 636f 6d70 6f6e  _start == compon
+000c6300: 656e 7473 2e68 6f73 745f 656e 6429 207b  ents.host_end) {
+000c6310: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
+000c6320: 653b 0a20 207d 0a20 2072 6574 7572 6e20  e;.  }.  return 
+000c6330: 6368 6563 6b65 7273 3a3a 7665 7269 6679  checkers::verify
+000c6340: 5f64 6e73 5f6c 656e 6774 6828 6765 745f  _dns_length(get_
+000c6350: 686f 7374 6e61 6d65 2829 293b 0a7d 0a0a  hostname());.}..
+000c6360: 626f 6f6c 2075 726c 5f61 6767 7265 6761  bool url_aggrega
+000c6370: 746f 723a 3a70 6172 7365 5f69 7076 3428  tor::parse_ipv4(
+000c6380: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000c6390: 2069 6e70 7574 2920 7b0a 2020 6164 615f   input) {.  ada_
+000c63a0: 6c6f 6728 2270 6172 7365 5f69 7076 3420  log("parse_ipv4 
+000c63b0: 222c 2069 6e70 7574 2c20 225b 222c 2069  ", input, "[", i
+000c63c0: 6e70 7574 2e73 697a 6528 292c 0a20 2020  nput.size(),.   
+000c63d0: 2020 2020 2020 2022 2062 7974 6573 5d2c         " bytes],
+000c63e0: 206f 7665 726c 6170 7320 7769 7468 2062   overlaps with b
+000c63f0: 7566 6665 723a 2022 2c0a 2020 2020 2020  uffer: ",.      
+000c6400: 2020 2020 6865 6c70 6572 733a 3a6f 7665      helpers::ove
+000c6410: 726c 6170 7328 696e 7075 742c 2062 7566  rlaps(input, buf
+000c6420: 6665 7229 203f 2022 7965 7322 203a 2022  fer) ? "yes" : "
+000c6430: 6e6f 2229 3b0a 2020 4144 415f 4153 5345  no");.  ADA_ASSE
+000c6440: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
+000c6450: 2829 293b 0a20 2063 6f6e 7374 2062 6f6f  ());.  const boo
+000c6460: 6c20 7472 6169 6c69 6e67 5f64 6f74 203d  l trailing_dot =
+000c6470: 2028 696e 7075 742e 6261 636b 2829 203d   (input.back() =
+000c6480: 3d20 272e 2729 3b0a 2020 6966 2028 7472  = '.');.  if (tr
+000c6490: 6169 6c69 6e67 5f64 6f74 2920 7b0a 2020  ailing_dot) {.  
+000c64a0: 2020 696e 7075 742e 7265 6d6f 7665 5f73    input.remove_s
+000c64b0: 7566 6669 7828 3129 3b0a 2020 7d0a 2020  uffix(1);.  }.  
+000c64c0: 7369 7a65 5f74 2064 6967 6974 5f63 6f75  size_t digit_cou
+000c64d0: 6e74 7b30 7d3b 0a20 2069 6e74 2070 7572  nt{0};.  int pur
+000c64e0: 655f 6465 6369 6d61 6c5f 636f 756e 7420  e_decimal_count 
+000c64f0: 3d20 303b 2020 2f2f 2065 6e74 7269 6573  = 0;  // entries
+000c6500: 2074 6861 7420 6172 6520 6465 6369 6d61   that are decima
+000c6510: 6c0a 2020 7569 6e74 3634 5f74 2069 7076  l.  uint64_t ipv
+000c6520: 347b 307d 3b0a 2020 2f2f 2077 6520 636f  4{0};.  // we co
+000c6530: 756c 6420 756e 726f 6c6c 2066 6f72 2062  uld unroll for b
+000c6540: 6574 7465 7220 7065 7266 6f72 6d61 6e63  etter performanc
+000c6550: 653f 0a20 2066 6f72 2028 3b20 2864 6967  e?.  for (; (dig
+000c6560: 6974 5f63 6f75 6e74 203c 2034 2920 2626  it_count < 4) &&
+000c6570: 2021 2869 6e70 7574 2e65 6d70 7479 2829   !(input.empty()
+000c6580: 293b 2064 6967 6974 5f63 6f75 6e74 2b2b  ); digit_count++
+000c6590: 2920 7b0a 2020 2020 7569 6e74 3332 5f74  ) {.    uint32_t
+000c65a0: 0a20 2020 2020 2020 2073 6567 6d65 6e74  .        segment
+000c65b0: 5f72 6573 756c 747b 7d3b 2020 2f2f 2049  _result{};  // I
+000c65c0: 6620 616e 7920 6e75 6d62 6572 2065 7863  f any number exc
+000c65d0: 6565 6473 2033 3220 6269 7473 2c20 7765  eeds 32 bits, we
+000c65e0: 2068 6176 6520 616e 2065 7272 6f72 2e0a   have an error..
+000c65f0: 2020 2020 626f 6f6c 2069 735f 6865 7820      bool is_hex 
+000c6600: 3d20 6368 6563 6b65 7273 3a3a 6861 735f  = checkers::has_
+000c6610: 6865 785f 7072 6566 6978 2869 6e70 7574  hex_prefix(input
+000c6620: 293b 0a20 2020 2069 6620 2869 735f 6865  );.    if (is_he
+000c6630: 7820 2626 2028 2869 6e70 7574 2e6c 656e  x && ((input.len
+000c6640: 6774 6828 2920 3d3d 2032 2920 7c7c 0a20  gth() == 2) ||. 
+000c6650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c6660: 2020 2828 696e 7075 742e 6c65 6e67 7468    ((input.length
+000c6670: 2829 203e 2032 2920 2626 2028 696e 7075  () > 2) && (inpu
+000c6680: 745b 325d 203d 3d20 272e 2729 2929 2920  t[2] == '.')))) 
+000c6690: 7b0a 2020 2020 2020 2f2f 2073 7065 6369  {.      // speci
+000c66a0: 616c 2063 6173 650a 2020 2020 2020 7365  al case.      se
+000c66b0: 676d 656e 745f 7265 7375 6c74 203d 2030  gment_result = 0
+000c66c0: 3b0a 2020 2020 2020 696e 7075 742e 7265  ;.      input.re
+000c66d0: 6d6f 7665 5f70 7265 6669 7828 3229 3b0a  move_prefix(2);.
+000c66e0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+000c66f0: 2020 2073 7464 3a3a 6672 6f6d 5f63 6861     std::from_cha
+000c6700: 7273 5f72 6573 756c 7420 723b 0a20 2020  rs_result r;.   
+000c6710: 2020 2069 6620 2869 735f 6865 7829 207b     if (is_hex) {
+000c6720: 0a20 2020 2020 2020 2072 203d 2073 7464  .        r = std
+000c6730: 3a3a 6672 6f6d 5f63 6861 7273 2869 6e70  ::from_chars(inp
+000c6740: 7574 2e64 6174 6128 2920 2b20 322c 2069  ut.data() + 2, i
+000c6750: 6e70 7574 2e64 6174 6128 2920 2b20 696e  nput.data() + in
+000c6760: 7075 742e 7369 7a65 2829 2c0a 2020 2020  put.size(),.    
+000c6770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c6780: 2020 2020 2020 2020 7365 676d 656e 745f          segment_
+000c6790: 7265 7375 6c74 2c20 3136 293b 0a20 2020  result, 16);.   
+000c67a0: 2020 207d 2065 6c73 6520 6966 2028 2869     } else if ((i
+000c67b0: 6e70 7574 2e6c 656e 6774 6828 2920 3e3d  nput.length() >=
+000c67c0: 2032 2920 2626 2069 6e70 7574 5b30 5d20   2) && input[0] 
+000c67d0: 3d3d 2027 3027 2026 260a 2020 2020 2020  == '0' &&.      
+000c67e0: 2020 2020 2020 2020 2020 2063 6865 636b             check
+000c67f0: 6572 733a 3a69 735f 6469 6769 7428 696e  ers::is_digit(in
+000c6800: 7075 745b 315d 2929 207b 0a20 2020 2020  put[1])) {.     
+000c6810: 2020 2072 203d 2073 7464 3a3a 6672 6f6d     r = std::from
+000c6820: 5f63 6861 7273 2869 6e70 7574 2e64 6174  _chars(input.dat
+000c6830: 6128 2920 2b20 312c 2069 6e70 7574 2e64  a() + 1, input.d
+000c6840: 6174 6128 2920 2b20 696e 7075 742e 7369  ata() + input.si
+000c6850: 7a65 2829 2c0a 2020 2020 2020 2020 2020  ze(),.          
+000c6860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c6870: 2020 7365 676d 656e 745f 7265 7375 6c74    segment_result
+000c6880: 2c20 3829 3b0a 2020 2020 2020 7d20 656c  , 8);.      } el
+000c6890: 7365 207b 0a20 2020 2020 2020 2070 7572  se {.        pur
+000c68a0: 655f 6465 6369 6d61 6c5f 636f 756e 742b  e_decimal_count+
+000c68b0: 2b3b 0a20 2020 2020 2020 2072 203d 2073  +;.        r = s
+000c68c0: 7464 3a3a 6672 6f6d 5f63 6861 7273 2869  td::from_chars(i
+000c68d0: 6e70 7574 2e64 6174 6128 292c 2069 6e70  nput.data(), inp
+000c68e0: 7574 2e64 6174 6128 2920 2b20 696e 7075  ut.data() + inpu
+000c68f0: 742e 7369 7a65 2829 2c0a 2020 2020 2020  t.size(),.      
+000c6900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000c6910: 2020 2020 2020 7365 676d 656e 745f 7265        segment_re
+000c6920: 7375 6c74 2c20 3130 293b 0a20 2020 2020  sult, 10);.     
+000c6930: 207d 0a20 2020 2020 2069 6620 2872 2e65   }.      if (r.e
+000c6940: 6320 213d 2073 7464 3a3a 6572 7263 2829  c != std::errc()
+000c6950: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+000c6960: 726e 2069 735f 7661 6c69 6420 3d20 6661  rn is_valid = fa
+000c6970: 6c73 653b 0a20 2020 2020 207d 0a20 2020  lse;.      }.   
+000c6980: 2020 2069 6e70 7574 2e72 656d 6f76 655f     input.remove_
+000c6990: 7072 6566 6978 2872 2e70 7472 202d 2069  prefix(r.ptr - i
+000c69a0: 6e70 7574 2e64 6174 6128 2929 3b0a 2020  nput.data());.  
+000c69b0: 2020 7d0a 2020 2020 6966 2028 696e 7075    }.    if (inpu
+000c69c0: 742e 656d 7074 7928 2929 207b 0a20 2020  t.empty()) {.   
+000c69d0: 2020 202f 2f20 5765 2068 6176 6520 7468     // We have th
+000c69e0: 6520 6c61 7374 2076 616c 7565 2e0a 2020  e last value..  
+000c69f0: 2020 2020 2f2f 2041 7420 7468 6973 2073      // At this s
+000c6a00: 7461 6765 2c20 6970 7634 2063 6f6e 7461  tage, ipv4 conta
+000c6a10: 696e 7320 6469 6769 745f 636f 756e 742a  ins digit_count*
+000c6a20: 3820 6269 7473 2e0a 2020 2020 2020 2f2f  8 bits..      //
+000c6a30: 2053 6f20 7765 2068 6176 6520 3332 2d64   So we have 32-d
+000c6a40: 6967 6974 5f63 6f75 6e74 2a38 2062 6974  igit_count*8 bit
+000c6a50: 7320 6c65 6674 2e0a 2020 2020 2020 6966  s left..      if
+000c6a60: 2028 7365 676d 656e 745f 7265 7375 6c74   (segment_result
+000c6a70: 203e 2028 7569 6e74 3634 5f74 2831 2920   > (uint64_t(1) 
+000c6a80: 3c3c 2028 3332 202d 2064 6967 6974 5f63  << (32 - digit_c
+000c6a90: 6f75 6e74 202a 2038 2929 2920 7b0a 2020  ount * 8))) {.  
+000c6aa0: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
+000c6ab0: 7661 6c69 6420 3d20 6661 6c73 653b 0a20  valid = false;. 
+000c6ac0: 2020 2020 207d 0a20 2020 2020 2069 7076       }.      ipv
+000c6ad0: 3420 3c3c 3d20 2833 3220 2d20 6469 6769  4 <<= (32 - digi
+000c6ae0: 745f 636f 756e 7420 2a20 3829 3b0a 2020  t_count * 8);.  
+000c6af0: 2020 2020 6970 7634 207c 3d20 7365 676d      ipv4 |= segm
+000c6b00: 656e 745f 7265 7375 6c74 3b0a 2020 2020  ent_result;.    
+000c6b10: 2020 676f 746f 2066 696e 616c 3b0a 2020    goto final;.  
+000c6b20: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+000c6b30: 202f 2f20 5468 6572 6520 6973 206d 6f72   // There is mor
+000c6b40: 652c 2073 6f20 7468 6174 2074 6865 2076  e, so that the v
+000c6b50: 616c 7565 206d 7573 7420 6e6f 2062 6520  alue must no be 
+000c6b60: 6c61 7267 6572 2074 6861 6e20 3235 350a  larger than 255.
+000c6b70: 2020 2020 2020 2f2f 2061 6e64 2077 6520        // and we 
+000c6b80: 6d75 7374 2068 6176 6520 6120 272e 272e  must have a '.'.
+000c6b90: 0a20 2020 2020 2069 6620 2828 7365 676d  .      if ((segm
+000c6ba0: 656e 745f 7265 7375 6c74 203e 2032 3535  ent_result > 255
+000c6bb0: 2920 7c7c 2028 696e 7075 745b 305d 2021  ) || (input[0] !
+000c6bc0: 3d20 272e 2729 2920 7b0a 2020 2020 2020  = '.')) {.      
+000c6bd0: 2020 7265 7475 726e 2069 735f 7661 6c69    return is_vali
+000c6be0: 6420 3d20 6661 6c73 653b 0a20 2020 2020  d = false;.     
+000c6bf0: 207d 0a20 2020 2020 2069 7076 3420 3c3c   }.      ipv4 <<
+000c6c00: 3d20 383b 0a20 2020 2020 2069 7076 3420  = 8;.      ipv4 
+000c6c10: 7c3d 2073 6567 6d65 6e74 5f72 6573 756c  |= segment_resul
+000c6c20: 743b 0a20 2020 2020 2069 6e70 7574 2e72  t;.      input.r
+000c6c30: 656d 6f76 655f 7072 6566 6978 2831 293b  emove_prefix(1);
+000c6c40: 2020 2f2f 2072 656d 6f76 6520 272e 270a    // remove '.'.
+000c6c50: 2020 2020 7d0a 2020 7d0a 2020 6966 2028      }.  }.  if (
+000c6c60: 2864 6967 6974 5f63 6f75 6e74 2021 3d20  (digit_count != 
+000c6c70: 3429 207c 7c20 2821 696e 7075 742e 656d  4) || (!input.em
+000c6c80: 7074 7928 2929 2920 7b0a 2020 2020 7265  pty())) {.    re
+000c6c90: 7475 726e 2069 735f 7661 6c69 6420 3d20  turn is_valid = 
+000c6ca0: 6661 6c73 653b 0a20 207d 0a66 696e 616c  false;.  }.final
+000c6cb0: 3a0a 2020 6164 615f 6c6f 6728 2275 726c  :.  ada_log("url
+000c6cc0: 5f61 6767 7265 6761 746f 723a 3a70 6172  _aggregator::par
+000c6cd0: 7365 5f69 7076 3420 636f 6d70 6c65 7465  se_ipv4 complete
+000c6ce0: 6420 222c 2067 6574 5f68 7265 6628 292c  d ", get_href(),
+000c6cf0: 0a20 2020 2020 2020 2020 2022 2068 6f73  .          " hos
+000c6d00: 743a 2022 2c20 6765 745f 686f 7374 2829  t: ", get_host()
+000c6d10: 293b 0a0a 2020 2f2f 2057 6520 636f 756c  );..  // We coul
+000c6d20: 6420 616c 736f 2063 6865 636b 2072 2e70  d also check r.p
+000c6d30: 7472 2074 6f20 7365 6520 7768 6572 6520  tr to see where 
+000c6d40: 7468 6520 7061 7273 696e 6720 656e 6465  the parsing ende
+000c6d50: 642e 0a20 2069 6620 2870 7572 655f 6465  d..  if (pure_de
+000c6d60: 6369 6d61 6c5f 636f 756e 7420 3d3d 2034  cimal_count == 4
+000c6d70: 2026 2620 2174 7261 696c 696e 675f 646f   && !trailing_do
+000c6d80: 7429 207b 0a20 2020 202f 2f20 5468 6520  t) {.    // The 
+000c6d90: 6f72 6967 696e 616c 2069 6e70 7574 2077  original input w
+000c6da0: 6173 2061 6c72 6561 6479 2061 6c6c 2064  as already all d
+000c6db0: 6563 696d 616c 2061 6e64 2077 6520 7661  ecimal and we va
+000c6dc0: 6c69 6461 7465 6420 6974 2e20 536f 2077  lidated it. So w
+000c6dd0: 650a 2020 2020 2f2f 2064 6f6e 2774 206e  e.    // don't n
+000c6de0: 6565 6420 746f 2064 6f20 616e 7974 6869  eed to do anythi
+000c6df0: 6e67 2e0a 2020 7d20 656c 7365 207b 0a20  ng..  } else {. 
+000c6e00: 2020 202f 2f20 4f70 7469 6d69 7a61 7469     // Optimizati
+000c6e10: 6f6e 206f 7070 6f72 7475 6e69 7479 3a20  on opportunity: 
+000c6e20: 4765 7420 7269 6420 6f66 2075 6e6e 6563  Get rid of unnec
+000c6e30: 6573 7361 7279 2073 7472 696e 6720 7265  essary string re
+000c6e40: 7475 726e 2069 6e20 6970 7634 0a20 2020  turn in ipv4.   
+000c6e50: 202f 2f20 7365 7269 616c 697a 6572 2e0a   // serializer..
+000c6e60: 2020 2020 2f2f 2054 4f44 4f3a 2054 6869      // TODO: Thi
+000c6e70: 7320 6973 206c 696b 656c 7920 6120 6275  s is likely a bu
+000c6e80: 6720 6265 6361 7573 6520 6974 2067 6f65  g because it goe
+000c6e90: 7320 6261 636b 2075 7064 6174 655f 6261  s back update_ba
+000c6ea0: 7365 5f68 6f73 746e 616d 652c 206e 6f74  se_hostname, not
+000c6eb0: 0a20 2020 202f 2f20 7768 6174 2077 6520  .    // what we 
+000c6ec0: 7761 6e74 2074 6f20 646f 2e0a 2020 2020  want to do..    
+000c6ed0: 7570 6461 7465 5f62 6173 655f 686f 7374  update_base_host
+000c6ee0: 6e61 6d65 280a 2020 2020 2020 2020 6164  name(.        ad
+000c6ef0: 613a 3a73 6572 6961 6c69 7a65 7273 3a3a  a::serializers::
+000c6f00: 6970 7634 2869 7076 3429 293b 2020 2f2f  ipv4(ipv4));  //
+000c6f10: 2057 6520 6861 7665 2074 6f20 7265 7365   We have to rese
+000c6f20: 7269 616c 697a 6520 7468 6520 6164 6472  rialize the addr
+000c6f30: 6573 732e 0a20 207d 0a20 2041 4441 5f41  ess..  }.  ADA_A
+000c6f40: 5353 4552 545f 5452 5545 2876 616c 6964  SSERT_TRUE(valid
+000c6f50: 6174 6528 2929 3b0a 2020 7265 7475 726e  ate());.  return
+000c6f60: 2074 7275 653b 0a7d 0a0a 626f 6f6c 2075   true;.}..bool u
+000c6f70: 726c 5f61 6767 7265 6761 746f 723a 3a70  rl_aggregator::p
+000c6f80: 6172 7365 5f69 7076 3628 7374 643a 3a73  arse_ipv6(std::s
+000c6f90: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
+000c6fa0: 2920 7b0a 2020 2f2f 2054 4f44 4f3a 2046  ) {.  // TODO: F
+000c6fb0: 696e 6420 6120 7761 7920 746f 206d 6572  ind a way to mer
+000c6fc0: 6765 2070 6172 7365 5f69 7076 3620 7769  ge parse_ipv6 wi
+000c6fd0: 7468 2075 726c 2e63 7070 2069 6d70 6c65  th url.cpp imple
+000c6fe0: 6d65 6e74 6174 696f 6e2e 0a20 2061 6461  mentation..  ada
+000c6ff0: 5f6c 6f67 2822 7061 7273 655f 6970 7636  _log("parse_ipv6
+000c7000: 2022 2c20 696e 7075 742c 2022 5b22 2c20   ", input, "[", 
+000c7010: 696e 7075 742e 7369 7a65 2829 2c20 2220  input.size(), " 
+000c7020: 6279 7465 735d 2229 3b0a 2020 4144 415f  bytes]");.  ADA_
+000c7030: 4153 5345 5254 5f54 5255 4528 7661 6c69  ASSERT_TRUE(vali
+000c7040: 6461 7465 2829 293b 0a20 2041 4441 5f41  date());.  ADA_A
+000c7050: 5353 4552 545f 5452 5545 2821 6865 6c70  SSERT_TRUE(!help
+000c7060: 6572 733a 3a6f 7665 726c 6170 7328 696e  ers::overlaps(in
+000c7070: 7075 742c 2062 7566 6665 7229 293b 0a20  put, buffer));. 
+000c7080: 2069 6620 2869 6e70 7574 2e65 6d70 7479   if (input.empty
+000c7090: 2829 2920 7b0a 2020 2020 7265 7475 726e  ()) {.    return
+000c70a0: 2069 735f 7661 6c69 6420 3d20 6661 6c73   is_valid = fals
+000c70b0: 653b 0a20 207d 0a20 202f 2f20 4c65 7420  e;.  }.  // Let 
+000c70c0: 6164 6472 6573 7320 6265 2061 206e 6577  address be a new
+000c70d0: 2049 5076 3620 6164 6472 6573 7320 7768   IPv6 address wh
+000c70e0: 6f73 6520 4950 7636 2070 6965 6365 7320  ose IPv6 pieces 
+000c70f0: 6172 6520 616c 6c20 302e 0a20 2073 7464  are all 0..  std
+000c7100: 3a3a 6172 7261 793c 7569 6e74 3136 5f74  ::array<uint16_t
+000c7110: 2c20 383e 2061 6464 7265 7373 7b7d 3b0a  , 8> address{};.
+000c7120: 0a20 202f 2f20 4c65 7420 7069 6563 6549  .  // Let pieceI
+000c7130: 6e64 6578 2062 6520 302e 0a20 2069 6e74  ndex be 0..  int
+000c7140: 2070 6965 6365 5f69 6e64 6578 203d 2030   piece_index = 0
+000c7150: 3b0a 0a20 202f 2f20 4c65 7420 636f 6d70  ;..  // Let comp
+000c7160: 7265 7373 2062 6520 6e75 6c6c 2e0a 2020  ress be null..  
+000c7170: 7374 643a 3a6f 7074 696f 6e61 6c3c 696e  std::optional<in
+000c7180: 743e 2063 6f6d 7072 6573 737b 7d3b 0a0a  t> compress{};..
+000c7190: 2020 2f2f 204c 6574 2070 6f69 6e74 6572    // Let pointer
+000c71a0: 2062 6520 6120 706f 696e 7465 7220 666f   be a pointer fo
+000c71b0: 7220 696e 7075 742e 0a20 2073 7464 3a3a  r input..  std::
+000c71c0: 7374 7269 6e67 5f76 6965 773a 3a69 7465  string_view::ite
+000c71d0: 7261 746f 7220 706f 696e 7465 7220 3d20  rator pointer = 
+000c71e0: 696e 7075 742e 6265 6769 6e28 293b 0a0a  input.begin();..
+000c71f0: 2020 2f2f 2049 6620 6320 6973 2055 2b30    // If c is U+0
+000c7200: 3033 4120 283a 292c 2074 6865 6e3a 0a20  03A (:), then:. 
+000c7210: 2069 6620 2869 6e70 7574 5b30 5d20 3d3d   if (input[0] ==
+000c7220: 2027 3a27 2920 7b0a 2020 2020 2f2f 2049   ':') {.    // I
+000c7230: 6620 7265 6d61 696e 696e 6720 646f 6573  f remaining does
+000c7240: 206e 6f74 2073 7461 7274 2077 6974 6820   not start with 
+000c7250: 552b 3030 3341 2028 3a29 2c20 7661 6c69  U+003A (:), vali
+000c7260: 6461 7469 6f6e 2065 7272 6f72 2c20 7265  dation error, re
+000c7270: 7475 726e 0a20 2020 202f 2f20 6661 696c  turn.    // fail
+000c7280: 7572 652e 0a20 2020 2069 6620 2869 6e70  ure..    if (inp
+000c7290: 7574 2e73 697a 6528 2920 3d3d 2031 207c  ut.size() == 1 |
+000c72a0: 7c20 696e 7075 745b 315d 2021 3d20 273a  | input[1] != ':
+000c72b0: 2729 207b 0a20 2020 2020 2061 6461 5f6c  ') {.      ada_l
+000c72c0: 6f67 2822 7061 7273 655f 6970 7636 2073  og("parse_ipv6 s
+000c72d0: 7461 7274 7320 7769 7468 203a 2062 7574  tarts with : but
+000c72e0: 2074 6865 2072 6573 7420 646f 6573 206e   the rest does n
+000c72f0: 6f74 2073 7461 7274 2077 6974 6820 3a22  ot start with :"
+000c7300: 293b 0a20 2020 2020 2072 6574 7572 6e20  );.      return 
+000c7310: 6973 5f76 616c 6964 203d 2066 616c 7365  is_valid = false
+000c7320: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+000c7330: 496e 6372 6561 7365 2070 6f69 6e74 6572  Increase pointer
+000c7340: 2062 7920 322e 0a20 2020 2070 6f69 6e74   by 2..    point
+000c7350: 6572 202b 3d20 323b 0a0a 2020 2020 2f2f  er += 2;..    //
+000c7360: 2049 6e63 7265 6173 6520 7069 6563 6549   Increase pieceI
+000c7370: 6e64 6578 2062 7920 3120 616e 6420 7468  ndex by 1 and th
+000c7380: 656e 2073 6574 2063 6f6d 7072 6573 7320  en set compress 
+000c7390: 746f 2070 6965 6365 496e 6465 782e 0a20  to pieceIndex.. 
+000c73a0: 2020 2063 6f6d 7072 6573 7320 3d20 2b2b     compress = ++
+000c73b0: 7069 6563 655f 696e 6465 783b 0a20 207d  piece_index;.  }
+000c73c0: 0a0a 2020 2f2f 2057 6869 6c65 2063 2069  ..  // While c i
+000c73d0: 7320 6e6f 7420 7468 6520 454f 4620 636f  s not the EOF co
+000c73e0: 6465 2070 6f69 6e74 3a0a 2020 7768 696c  de point:.  whil
+000c73f0: 6520 2870 6f69 6e74 6572 2021 3d20 696e  e (pointer != in
+000c7400: 7075 742e 656e 6428 2929 207b 0a20 2020  put.end()) {.   
+000c7410: 202f 2f20 4966 2070 6965 6365 496e 6465   // If pieceInde
+000c7420: 7820 6973 2038 2c20 7661 6c69 6461 7469  x is 8, validati
+000c7430: 6f6e 2065 7272 6f72 2c20 7265 7475 726e  on error, return
+000c7440: 2066 6169 6c75 7265 2e0a 2020 2020 6966   failure..    if
+000c7450: 2028 7069 6563 655f 696e 6465 7820 3d3d   (piece_index ==
+000c7460: 2038 2920 7b0a 2020 2020 2020 6164 615f   8) {.      ada_
+000c7470: 6c6f 6728 2270 6172 7365 5f69 7076 3620  log("parse_ipv6 
+000c7480: 7069 6563 655f 696e 6465 7820 3d3d 2038  piece_index == 8
+000c7490: 2229 3b0a 2020 2020 2020 7265 7475 726e  ");.      return
+000c74a0: 2069 735f 7661 6c69 6420 3d20 6661 6c73   is_valid = fals
+000c74b0: 653b 0a20 2020 207d 0a0a 2020 2020 2f2f  e;.    }..    //
+000c74c0: 2049 6620 6320 6973 2055 2b30 3033 4120   If c is U+003A 
+000c74d0: 283a 292c 2074 6865 6e3a 0a20 2020 2069  (:), then:.    i
+000c74e0: 6620 282a 706f 696e 7465 7220 3d3d 2027  f (*pointer == '
+000c74f0: 3a27 2920 7b0a 2020 2020 2020 2f2f 2049  :') {.      // I
+000c7500: 6620 636f 6d70 7265 7373 2069 7320 6e6f  f compress is no
+000c7510: 6e2d 6e75 6c6c 2c20 7661 6c69 6461 7469  n-null, validati
+000c7520: 6f6e 2065 7272 6f72 2c20 7265 7475 726e  on error, return
+000c7530: 2066 6169 6c75 7265 2e0a 2020 2020 2020   failure..      
+000c7540: 6966 2028 636f 6d70 7265 7373 2e68 6173  if (compress.has
+000c7550: 5f76 616c 7565 2829 2920 7b0a 2020 2020  _value()) {.    
+000c7560: 2020 2020 6164 615f 6c6f 6728 2270 6172      ada_log("par
+000c7570: 7365 5f69 7076 3620 636f 6d70 7265 7373  se_ipv6 compress
+000c7580: 2069 7320 6e6f 6e2d 6e75 6c6c 2229 3b0a   is non-null");.
+000c7590: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+000c75a0: 735f 7661 6c69 6420 3d20 6661 6c73 653b  s_valid = false;
+000c75b0: 0a20 2020 2020 207d 0a0a 2020 2020 2020  .      }..      
+000c75c0: 2f2f 2049 6e63 7265 6173 6520 706f 696e  // Increase poin
+000c75d0: 7465 7220 616e 6420 7069 6563 6549 6e64  ter and pieceInd
+000c75e0: 6578 2062 7920 312c 2073 6574 2063 6f6d  ex by 1, set com
+000c75f0: 7072 6573 7320 746f 2070 6965 6365 496e  press to pieceIn
+000c7600: 6465 782c 2061 6e64 0a20 2020 2020 202f  dex, and.      /
+000c7610: 2f20 7468 656e 2063 6f6e 7469 6e75 652e  / then continue.
+000c7620: 0a20 2020 2020 2070 6f69 6e74 6572 2b2b  .      pointer++
+000c7630: 3b0a 2020 2020 2020 636f 6d70 7265 7373  ;.      compress
+000c7640: 203d 202b 2b70 6965 6365 5f69 6e64 6578   = ++piece_index
+000c7650: 3b0a 2020 2020 2020 636f 6e74 696e 7565  ;.      continue
+000c7660: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+000c7670: 4c65 7420 7661 6c75 6520 616e 6420 6c65  Let value and le
+000c7680: 6e67 7468 2062 6520 302e 0a20 2020 2075  ngth be 0..    u
+000c7690: 696e 7431 365f 7420 7661 6c75 6520 3d20  int16_t value = 
+000c76a0: 302c 206c 656e 6774 6820 3d20 303b 0a0a  0, length = 0;..
+000c76b0: 2020 2020 2f2f 2057 6869 6c65 206c 656e      // While len
+000c76c0: 6774 6820 6973 206c 6573 7320 7468 616e  gth is less than
+000c76d0: 2034 2061 6e64 2063 2069 7320 616e 2041   4 and c is an A
+000c76e0: 5343 4949 2068 6578 2064 6967 6974 2c0a  SCII hex digit,.
+000c76f0: 2020 2020 2f2f 2073 6574 2076 616c 7565      // set value
+000c7700: 2074 6f20 7661 6c75 6520 c397 2030 7831   to value .. 0x1
+000c7710: 3020 2b20 6320 696e 7465 7270 7265 7465  0 + c interprete
+000c7720: 6420 6173 2068 6578 6164 6563 696d 616c  d as hexadecimal
+000c7730: 206e 756d 6265 722c 2061 6e64 0a20 2020   number, and.   
+000c7740: 202f 2f20 696e 6372 6561 7365 2070 6f69   // increase poi
+000c7750: 6e74 6572 2061 6e64 206c 656e 6774 6820  nter and length 
+000c7760: 6279 2031 2e0a 2020 2020 7768 696c 6520  by 1..    while 
+000c7770: 286c 656e 6774 6820 3c20 3420 2626 2070  (length < 4 && p
+000c7780: 6f69 6e74 6572 2021 3d20 696e 7075 742e  ointer != input.
+000c7790: 656e 6428 2920 2626 0a20 2020 2020 2020  end() &&.       
+000c77a0: 2020 2020 756e 6963 6f64 653a 3a69 735f      unicode::is_
+000c77b0: 6173 6369 695f 6865 785f 6469 6769 7428  ascii_hex_digit(
+000c77c0: 2a70 6f69 6e74 6572 2929 207b 0a20 2020  *pointer)) {.   
+000c77d0: 2020 202f 2f20 6874 7470 733a 2f2f 7374     // https://st
+000c77e0: 6163 6b6f 7665 7266 6c6f 772e 636f 6d2f  ackoverflow.com/
+000c77f0: 7175 6573 7469 6f6e 732f 3339 3036 3038  questions/390608
+000c7800: 3532 2f77 6879 2d64 6f65 732d 7468 652d  52/why-does-the-
+000c7810: 6164 6469 7469 6f6e 2d6f 662d 7477 6f2d  addition-of-two-
+000c7820: 7368 6f72 7473 2d72 6574 7572 6e2d 616e  shorts-return-an
+000c7830: 2d69 6e74 0a20 2020 2020 2076 616c 7565  -int.      value
+000c7840: 203d 2075 696e 7431 365f 7428 7661 6c75   = uint16_t(valu
+000c7850: 6520 2a20 3078 3130 202b 2075 6e69 636f  e * 0x10 + unico
+000c7860: 6465 3a3a 636f 6e76 6572 745f 6865 785f  de::convert_hex_
+000c7870: 746f 5f62 696e 6172 7928 2a70 6f69 6e74  to_binary(*point
+000c7880: 6572 2929 3b0a 2020 2020 2020 706f 696e  er));.      poin
+000c7890: 7465 722b 2b3b 0a20 2020 2020 206c 656e  ter++;.      len
+000c78a0: 6774 682b 2b3b 0a20 2020 207d 0a0a 2020  gth++;.    }..  
+000c78b0: 2020 2f2f 2049 6620 6320 6973 2055 2b30    // If c is U+0
+000c78c0: 3032 4520 282e 292c 2074 6865 6e3a 0a20  02E (.), then:. 
+000c78d0: 2020 2069 6620 2870 6f69 6e74 6572 2021     if (pointer !
+000c78e0: 3d20 696e 7075 742e 656e 6428 2920 2626  = input.end() &&
+000c78f0: 202a 706f 696e 7465 7220 3d3d 2027 2e27   *pointer == '.'
+000c7900: 2920 7b0a 2020 2020 2020 2f2f 2049 6620  ) {.      // If 
+000c7910: 6c65 6e67 7468 2069 7320 302c 2076 616c  length is 0, val
+000c7920: 6964 6174 696f 6e20 6572 726f 722c 2072  idation error, r
+000c7930: 6574 7572 6e20 6661 696c 7572 652e 0a20  eturn failure.. 
+000c7940: 2020 2020 2069 6620 286c 656e 6774 6820       if (length 
+000c7950: 3d3d 2030 2920 7b0a 2020 2020 2020 2020  == 0) {.        
+000c7960: 6164 615f 6c6f 6728 2270 6172 7365 5f69  ada_log("parse_i
+000c7970: 7076 3620 6c65 6e67 7468 2069 7320 3022  pv6 length is 0"
+000c7980: 293b 0a20 2020 2020 2020 2072 6574 7572  );.        retur
+000c7990: 6e20 6973 5f76 616c 6964 203d 2066 616c  n is_valid = fal
+000c79a0: 7365 3b0a 2020 2020 2020 7d0a 0a20 2020  se;.      }..   
+000c79b0: 2020 202f 2f20 4465 6372 6561 7365 2070     // Decrease p
+000c79c0: 6f69 6e74 6572 2062 7920 6c65 6e67 7468  ointer by length
+000c79d0: 2e0a 2020 2020 2020 706f 696e 7465 7220  ..      pointer 
+000c79e0: 2d3d 206c 656e 6774 683b 0a0a 2020 2020  -= length;..    
+000c79f0: 2020 2f2f 2049 6620 7069 6563 6549 6e64    // If pieceInd
+000c7a00: 6578 2069 7320 6772 6561 7465 7220 7468  ex is greater th
+000c7a10: 616e 2036 2c20 7661 6c69 6461 7469 6f6e  an 6, validation
+000c7a20: 2065 7272 6f72 2c20 7265 7475 726e 2066   error, return f
+000c7a30: 6169 6c75 7265 2e0a 2020 2020 2020 6966  ailure..      if
+000c7a40: 2028 7069 6563 655f 696e 6465 7820 3e20   (piece_index > 
+000c7a50: 3629 207b 0a20 2020 2020 2020 2061 6461  6) {.        ada
+000c7a60: 5f6c 6f67 2822 7061 7273 655f 6970 7636  _log("parse_ipv6
+000c7a70: 2070 6965 6365 5f69 6e64 6578 203e 2036   piece_index > 6
+000c7a80: 2229 3b0a 2020 2020 2020 2020 7265 7475  ");.        retu
+000c7a90: 726e 2069 735f 7661 6c69 6420 3d20 6661  rn is_valid = fa
+000c7aa0: 6c73 653b 0a20 2020 2020 207d 0a0a 2020  lse;.      }..  
+000c7ab0: 2020 2020 2f2f 204c 6574 206e 756d 6265      // Let numbe
+000c7ac0: 7273 5365 656e 2062 6520 302e 0a20 2020  rsSeen be 0..   
+000c7ad0: 2020 2069 6e74 206e 756d 6265 7273 5f73     int numbers_s
+000c7ae0: 6565 6e20 3d20 303b 0a0a 2020 2020 2020  een = 0;..      
+000c7af0: 2f2f 2057 6869 6c65 2063 2069 7320 6e6f  // While c is no
+000c7b00: 7420 7468 6520 454f 4620 636f 6465 2070  t the EOF code p
+000c7b10: 6f69 6e74 3a0a 2020 2020 2020 7768 696c  oint:.      whil
+000c7b20: 6520 2870 6f69 6e74 6572 2021 3d20 696e  e (pointer != in
+000c7b30: 7075 742e 656e 6428 2929 207b 0a20 2020  put.end()) {.   
+000c7b40: 2020 2020 202f 2f20 4c65 7420 6970 7634       // Let ipv4
+000c7b50: 5069 6563 6520 6265 206e 756c 6c2e 0a20  Piece be null.. 
+000c7b60: 2020 2020 2020 2073 7464 3a3a 6f70 7469         std::opti
+000c7b70: 6f6e 616c 3c75 696e 7431 365f 743e 2069  onal<uint16_t> i
+000c7b80: 7076 345f 7069 6563 657b 7d3b 0a0a 2020  pv4_piece{};..  
+000c7b90: 2020 2020 2020 2f2f 2049 6620 6e75 6d62        // If numb
+000c7ba0: 6572 7353 6565 6e20 6973 2067 7265 6174  ersSeen is great
+000c7bb0: 6572 2074 6861 6e20 302c 2074 6865 6e3a  er than 0, then:
+000c7bc0: 0a20 2020 2020 2020 2069 6620 286e 756d  .        if (num
+000c7bd0: 6265 7273 5f73 6565 6e20 3e20 3029 207b  bers_seen > 0) {
+000c7be0: 0a20 2020 2020 2020 2020 202f 2f20 4966  .          // If
+000c7bf0: 2063 2069 7320 6120 552b 3030 3245 2028   c is a U+002E (
+000c7c00: 2e29 2061 6e64 206e 756d 6265 7273 5365  .) and numbersSe
+000c7c10: 656e 2069 7320 6c65 7373 2074 6861 6e20  en is less than 
+000c7c20: 342c 2074 6865 6e20 696e 6372 6561 7365  4, then increase
+000c7c30: 0a20 2020 2020 2020 2020 202f 2f20 706f  .          // po
+000c7c40: 696e 7465 7220 6279 2031 2e0a 2020 2020  inter by 1..    
+000c7c50: 2020 2020 2020 6966 2028 2a70 6f69 6e74        if (*point
+000c7c60: 6572 203d 3d20 272e 2720 2626 206e 756d  er == '.' && num
+000c7c70: 6265 7273 5f73 6565 6e20 3c20 3429 207b  bers_seen < 4) {
+000c7c80: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
+000c7c90: 6e74 6572 2b2b 3b0a 2020 2020 2020 2020  nter++;.        
+000c7ca0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+000c7cb0: 2020 2020 2020 202f 2f20 4f74 6865 7277         // Otherw
+000c7cc0: 6973 652c 2076 616c 6964 6174 696f 6e20  ise, validation 
+000c7cd0: 6572 726f 722c 2072 6574 7572 6e20 6661  error, return fa
+000c7ce0: 696c 7572 652e 0a20 2020 2020 2020 2020  ilure..         
+000c7cf0: 2020 2061 6461 5f6c 6f67 2822 7061 7273     ada_log("pars
+000c7d00: 655f 6970 7636 204f 7468 6572 7769 7365  e_ipv6 Otherwise
+000c7d10: 2c20 7661 6c69 6461 7469 6f6e 2065 7272  , validation err
+000c7d20: 6f72 2c20 7265 7475 726e 2066 6169 6c75  or, return failu
+000c7d30: 7265 2229 3b0a 2020 2020 2020 2020 2020  re");.          
+000c7d40: 2020 7265 7475 726e 2069 735f 7661 6c69    return is_vali
+000c7d50: 6420 3d20 6661 6c73 653b 0a20 2020 2020  d = false;.     
+000c7d60: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+000c7d70: 0a0a 2020 2020 2020 2020 2f2f 2049 6620  ..        // If 
+000c7d80: 6320 6973 206e 6f74 2061 6e20 4153 4349  c is not an ASCI
+000c7d90: 4920 6469 6769 742c 2076 616c 6964 6174  I digit, validat
+000c7da0: 696f 6e20 6572 726f 722c 2072 6574 7572  ion error, retur
+000c7db0: 6e20 6661 696c 7572 652e 0a20 2020 2020  n failure..     
+000c7dc0: 2020 2069 6620 2870 6f69 6e74 6572 203d     if (pointer =
+000c7dd0: 3d20 696e 7075 742e 656e 6428 2920 7c7c  = input.end() ||
+000c7de0: 2021 6368 6563 6b65 7273 3a3a 6973 5f64   !checkers::is_d
+000c7df0: 6967 6974 282a 706f 696e 7465 7229 2920  igit(*pointer)) 
+000c7e00: 7b0a 2020 2020 2020 2020 2020 6164 615f  {.          ada_
+000c7e10: 6c6f 6728 0a20 2020 2020 2020 2020 2020  log(.           
+000c7e20: 2020 2022 7061 7273 655f 6970 7636 2049     "parse_ipv6 I
+000c7e30: 6620 6320 6973 206e 6f74 2061 6e20 4153  f c is not an AS
+000c7e40: 4349 4920 6469 6769 742c 2076 616c 6964  CII digit, valid
+000c7e50: 6174 696f 6e20 6572 726f 722c 2072 6574  ation error, ret
+000c7e60: 7572 6e20 220a 2020 2020 2020 2020 2020  urn ".          
+000c7e70: 2020 2020 2266 6169 6c75 7265 2229 3b0a      "failure");.
+000c7e80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000c7e90: 2069 735f 7661 6c69 6420 3d20 6661 6c73   is_valid = fals
+000c7ea0: 653b 0a20 2020 2020 2020 207d 0a0a 2020  e;.        }..  
+000c7eb0: 2020 2020 2020 2f2f 2057 6869 6c65 2063        // While c
+000c7ec0: 2069 7320 616e 2041 5343 4949 2064 6967   is an ASCII dig
+000c7ed0: 6974 3a0a 2020 2020 2020 2020 7768 696c  it:.        whil
+000c7ee0: 6520 2870 6f69 6e74 6572 2021 3d20 696e  e (pointer != in
+000c7ef0: 7075 742e 656e 6428 2920 2626 2063 6865  put.end() && che
+000c7f00: 636b 6572 733a 3a69 735f 6469 6769 7428  ckers::is_digit(
+000c7f10: 2a70 6f69 6e74 6572 2929 207b 0a20 2020  *pointer)) {.   
+000c7f20: 2020 2020 2020 202f 2f20 4c65 7420 6e75         // Let nu
+000c7f30: 6d62 6572 2062 6520 6320 696e 7465 7270  mber be c interp
+000c7f40: 7265 7465 6420 6173 2064 6563 696d 616c  reted as decimal
+000c7f50: 206e 756d 6265 722e 0a20 2020 2020 2020   number..       
+000c7f60: 2020 2069 6e74 206e 756d 6265 7220 3d20     int number = 
+000c7f70: 2a70 6f69 6e74 6572 202d 2027 3027 3b0a  *pointer - '0';.
+000c7f80: 0a20 2020 2020 2020 2020 202f 2f20 4966  .          // If
+000c7f90: 2069 7076 3450 6965 6365 2069 7320 6e75   ipv4Piece is nu
+000c7fa0: 6c6c 2c20 7468 656e 2073 6574 2069 7076  ll, then set ipv
+000c7fb0: 3450 6965 6365 2074 6f20 6e75 6d62 6572  4Piece to number
+000c7fc0: 2e0a 2020 2020 2020 2020 2020 6966 2028  ..          if (
+000c7fd0: 2169 7076 345f 7069 6563 652e 6861 735f  !ipv4_piece.has_
+000c7fe0: 7661 6c75 6528 2929 207b 0a20 2020 2020  value()) {.     
+000c7ff0: 2020 2020 2020 2069 7076 345f 7069 6563         ipv4_piec
+000c8000: 6520 3d20 6e75 6d62 6572 3b0a 2020 2020  e = number;.    
+000c8010: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000c8020: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
+000c8030: 6966 2069 7076 3450 6965 6365 2069 7320  if ipv4Piece is 
+000c8040: 302c 2076 616c 6964 6174 696f 6e20 6572  0, validation er
+000c8050: 726f 722c 2072 6574 7572 6e20 6661 696c  ror, return fail
+000c8060: 7572 652e 0a20 2020 2020 2020 2020 2065  ure..          e
+000c8070: 6c73 6520 6966 2028 6970 7634 5f70 6965  lse if (ipv4_pie
+000c8080: 6365 203d 3d20 3029 207b 0a20 2020 2020  ce == 0) {.     
+000c8090: 2020 2020 2020 2061 6461 5f6c 6f67 2822         ada_log("
+000c80a0: 7061 7273 655f 6970 7636 2069 6620 6970  parse_ipv6 if ip
+000c80b0: 7634 5069 6563 6520 6973 2030 2c20 7661  v4Piece is 0, va
+000c80c0: 6c69 6461 7469 6f6e 2065 7272 6f72 2229  lidation error")
+000c80d0: 3b0a 2020 2020 2020 2020 2020 2020 7265  ;.            re
+000c80e0: 7475 726e 2069 735f 7661 6c69 6420 3d20  turn is_valid = 
+000c80f0: 6661 6c73 653b 0a20 2020 2020 2020 2020  false;.         
+000c8100: 207d 0a20 2020 2020 2020 2020 202f 2f20   }.          // 
+000c8110: 4f74 6865 7277 6973 652c 2073 6574 2069  Otherwise, set i
+000c8120: 7076 3450 6965 6365 2074 6f20 6970 7634  pv4Piece to ipv4
+000c8130: 5069 6563 6520 c397 2031 3020 2b20 6e75  Piece .. 10 + nu
+000c8140: 6d62 6572 2e0a 2020 2020 2020 2020 2020  mber..          
+000c8150: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+000c8160: 2020 2069 7076 345f 7069 6563 6520 3d20     ipv4_piece = 
+000c8170: 2a69 7076 345f 7069 6563 6520 2a20 3130  *ipv4_piece * 10
+000c8180: 202b 206e 756d 6265 723b 0a20 2020 2020   + number;.     
+000c8190: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000c81a0: 2020 2f2f 2049 6620 6970 7634 5069 6563    // If ipv4Piec
+000c81b0: 6520 6973 2067 7265 6174 6572 2074 6861  e is greater tha
+000c81c0: 6e20 3235 352c 2076 616c 6964 6174 696f  n 255, validatio
+000c81d0: 6e20 6572 726f 722c 2072 6574 7572 6e20  n error, return 
+000c81e0: 6661 696c 7572 652e 0a20 2020 2020 2020  failure..       
+000c81f0: 2020 2069 6620 2869 7076 345f 7069 6563     if (ipv4_piec
+000c8200: 6520 3e20 3235 3529 207b 0a20 2020 2020  e > 255) {.     
+000c8210: 2020 2020 2020 2061 6461 5f6c 6f67 2822         ada_log("
+000c8220: 7061 7273 655f 6970 7636 2069 7076 345f  parse_ipv6 ipv4_
+000c8230: 7069 6563 6520 3e20 3235 3522 293b 0a20  piece > 255");. 
+000c8240: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000c8250: 6e20 6973 5f76 616c 6964 203d 2066 616c  n is_valid = fal
+000c8260: 7365 3b0a 2020 2020 2020 2020 2020 7d0a  se;.          }.
+000c8270: 0a20 2020 2020 2020 2020 202f 2f20 496e  .          // In
+000c8280: 6372 6561 7365 2070 6f69 6e74 6572 2062  crease pointer b
+000c8290: 7920 312e 0a20 2020 2020 2020 2020 2070  y 1..          p
+000c82a0: 6f69 6e74 6572 2b2b 3b0a 2020 2020 2020  ointer++;.      
+000c82b0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+000c82c0: 5365 7420 6164 6472 6573 735b 7069 6563  Set address[piec
+000c82d0: 6549 6e64 6578 5d20 746f 2061 6464 7265  eIndex] to addre
+000c82e0: 7373 5b70 6965 6365 496e 6465 785d 20c3  ss[pieceIndex] .
+000c82f0: 9720 3078 3130 3020 2b20 6970 7634 5069  . 0x100 + ipv4Pi
+000c8300: 6563 652e 0a20 2020 2020 2020 202f 2f20  ece..        // 
+000c8310: 6874 7470 733a 2f2f 7374 6163 6b6f 7665  https://stackove
+000c8320: 7266 6c6f 772e 636f 6d2f 7175 6573 7469  rflow.com/questi
+000c8330: 6f6e 732f 3339 3036 3038 3532 2f77 6879  ons/39060852/why
+000c8340: 2d64 6f65 732d 7468 652d 6164 6469 7469  -does-the-additi
+000c8350: 6f6e 2d6f 662d 7477 6f2d 7368 6f72 7473  on-of-two-shorts
+000c8360: 2d72 6574 7572 6e2d 616e 2d69 6e74 0a20  -return-an-int. 
+000c8370: 2020 2020 2020 2061 6464 7265 7373 5b70         address[p
+000c8380: 6965 6365 5f69 6e64 6578 5d20 3d0a 2020  iece_index] =.  
+000c8390: 2020 2020 2020 2020 2020 7569 6e74 3136            uint16
+000c83a0: 5f74 2861 6464 7265 7373 5b70 6965 6365  _t(address[piece
+000c83b0: 5f69 6e64 6578 5d20 2a20 3078 3130 3020  _index] * 0x100 
+000c83c0: 2b20 2a69 7076 345f 7069 6563 6529 3b0a  + *ipv4_piece);.
+000c83d0: 0a20 2020 2020 2020 202f 2f20 496e 6372  .        // Incr
+000c83e0: 6561 7365 206e 756d 6265 7273 5365 656e  ease numbersSeen
+000c83f0: 2062 7920 312e 0a20 2020 2020 2020 206e   by 1..        n
+000c8400: 756d 6265 7273 5f73 6565 6e2b 2b3b 0a0a  umbers_seen++;..
+000c8410: 2020 2020 2020 2020 2f2f 2049 6620 6e75          // If nu
+000c8420: 6d62 6572 7353 6565 6e20 6973 2032 206f  mbersSeen is 2 o
+000c8430: 7220 342c 2074 6865 6e20 696e 6372 6561  r 4, then increa
+000c8440: 7365 2070 6965 6365 496e 6465 7820 6279  se pieceIndex by
+000c8450: 2031 2e0a 2020 2020 2020 2020 6966 2028   1..        if (
+000c8460: 6e75 6d62 6572 735f 7365 656e 203d 3d20  numbers_seen == 
+000c8470: 3220 7c7c 206e 756d 6265 7273 5f73 6565  2 || numbers_see
+000c8480: 6e20 3d3d 2034 2920 7b0a 2020 2020 2020  n == 4) {.      
+000c8490: 2020 2020 7069 6563 655f 696e 6465 782b      piece_index+
+000c84a0: 2b3b 0a20 2020 2020 2020 207d 0a20 2020  +;.        }.   
+000c84b0: 2020 207d 0a0a 2020 2020 2020 2f2f 2049     }..      // I
+000c84c0: 6620 6e75 6d62 6572 7353 6565 6e20 6973  f numbersSeen is
+000c84d0: 206e 6f74 2034 2c20 7661 6c69 6461 7469   not 4, validati
+000c84e0: 6f6e 2065 7272 6f72 2c20 7265 7475 726e  on error, return
+000c84f0: 2066 6169 6c75 7265 2e0a 2020 2020 2020   failure..      
+000c8500: 6966 2028 6e75 6d62 6572 735f 7365 656e  if (numbers_seen
+000c8510: 2021 3d20 3429 207b 0a20 2020 2020 2020   != 4) {.       
+000c8520: 2072 6574 7572 6e20 6973 5f76 616c 6964   return is_valid
+000c8530: 203d 2066 616c 7365 3b0a 2020 2020 2020   = false;.      
+000c8540: 7d0a 0a20 2020 2020 202f 2f20 4272 6561  }..      // Brea
+000c8550: 6b2e 0a20 2020 2020 2062 7265 616b 3b0a  k..      break;.
+000c8560: 2020 2020 7d0a 2020 2020 2f2f 204f 7468      }.    // Oth
+000c8570: 6572 7769 7365 2c20 6966 2063 2069 7320  erwise, if c is 
+000c8580: 552b 3030 3341 2028 3a29 3a0a 2020 2020  U+003A (:):.    
+000c8590: 656c 7365 2069 6620 2828 706f 696e 7465  else if ((pointe
+000c85a0: 7220 213d 2069 6e70 7574 2e65 6e64 2829  r != input.end()
+000c85b0: 2920 2626 2028 2a70 6f69 6e74 6572 203d  ) && (*pointer =
+000c85c0: 3d20 273a 2729 2920 7b0a 2020 2020 2020  = ':')) {.      
+000c85d0: 2f2f 2049 6e63 7265 6173 6520 706f 696e  // Increase poin
+000c85e0: 7465 7220 6279 2031 2e0a 2020 2020 2020  ter by 1..      
+000c85f0: 706f 696e 7465 722b 2b3b 0a0a 2020 2020  pointer++;..    
+000c8600: 2020 2f2f 2049 6620 6320 6973 2074 6865    // If c is the
+000c8610: 2045 4f46 2063 6f64 6520 706f 696e 742c   EOF code point,
+000c8620: 2076 616c 6964 6174 696f 6e20 6572 726f   validation erro
+000c8630: 722c 2072 6574 7572 6e20 6661 696c 7572  r, return failur
+000c8640: 652e 0a20 2020 2020 2069 6620 2870 6f69  e..      if (poi
+000c8650: 6e74 6572 203d 3d20 696e 7075 742e 656e  nter == input.en
+000c8660: 6428 2929 207b 0a20 2020 2020 2020 2061  d()) {.        a
+000c8670: 6461 5f6c 6f67 280a 2020 2020 2020 2020  da_log(.        
+000c8680: 2020 2020 2270 6172 7365 5f69 7076 3620      "parse_ipv6 
+000c8690: 4966 2063 2069 7320 7468 6520 454f 4620  If c is the EOF 
+000c86a0: 636f 6465 2070 6f69 6e74 2c20 7661 6c69  code point, vali
+000c86b0: 6461 7469 6f6e 2065 7272 6f72 2c20 7265  dation error, re
+000c86c0: 7475 726e 2022 0a20 2020 2020 2020 2020  turn ".         
+000c86d0: 2020 2022 6661 696c 7572 6522 293b 0a20     "failure");. 
+000c86e0: 2020 2020 2020 2072 6574 7572 6e20 6973         return is
+000c86f0: 5f76 616c 6964 203d 2066 616c 7365 3b0a  _valid = false;.
+000c8700: 2020 2020 2020 7d0a 2020 2020 7d0a 2020        }.    }.  
+000c8710: 2020 2f2f 204f 7468 6572 7769 7365 2c20    // Otherwise, 
+000c8720: 6966 2063 2069 7320 6e6f 7420 7468 6520  if c is not the 
+000c8730: 454f 4620 636f 6465 2070 6f69 6e74 2c20  EOF code point, 
+000c8740: 7661 6c69 6461 7469 6f6e 2065 7272 6f72  validation error
+000c8750: 2c20 7265 7475 726e 0a20 2020 202f 2f20  , return.    // 
+000c8760: 6661 696c 7572 652e 0a20 2020 2065 6c73  failure..    els
+000c8770: 6520 6966 2028 706f 696e 7465 7220 213d  e if (pointer !=
+000c8780: 2069 6e70 7574 2e65 6e64 2829 2920 7b0a   input.end()) {.
+000c8790: 2020 2020 2020 6164 615f 6c6f 6728 0a20        ada_log(. 
+000c87a0: 2020 2020 2020 2020 2022 7061 7273 655f           "parse_
+000c87b0: 6970 7636 204f 7468 6572 7769 7365 2c20  ipv6 Otherwise, 
+000c87c0: 6966 2063 2069 7320 6e6f 7420 7468 6520  if c is not the 
+000c87d0: 454f 4620 636f 6465 2070 6f69 6e74 2c20  EOF code point, 
+000c87e0: 7661 6c69 6461 7469 6f6e 2022 0a20 2020  validation ".   
+000c87f0: 2020 2020 2020 2022 6572 726f 722c 2072         "error, r
+000c8800: 6574 7572 6e20 6661 696c 7572 6522 293b  eturn failure");
+000c8810: 0a20 2020 2020 2072 6574 7572 6e20 6973  .      return is
+000c8820: 5f76 616c 6964 203d 2066 616c 7365 3b0a  _valid = false;.
+000c8830: 2020 2020 7d0a 0a20 2020 202f 2f20 5365      }..    // Se
+000c8840: 7420 6164 6472 6573 735b 7069 6563 6549  t address[pieceI
+000c8850: 6e64 6578 5d20 746f 2076 616c 7565 2e0a  ndex] to value..
+000c8860: 2020 2020 6164 6472 6573 735b 7069 6563      address[piec
+000c8870: 655f 696e 6465 785d 203d 2076 616c 7565  e_index] = value
+000c8880: 3b0a 0a20 2020 202f 2f20 496e 6372 6561  ;..    // Increa
+000c8890: 7365 2070 6965 6365 496e 6465 7820 6279  se pieceIndex by
+000c88a0: 2031 2e0a 2020 2020 7069 6563 655f 696e   1..    piece_in
+000c88b0: 6465 782b 2b3b 0a20 207d 0a0a 2020 2f2f  dex++;.  }..  //
+000c88c0: 2049 6620 636f 6d70 7265 7373 2069 7320   If compress is 
+000c88d0: 6e6f 6e2d 6e75 6c6c 2c20 7468 656e 3a0a  non-null, then:.
+000c88e0: 2020 6966 2028 636f 6d70 7265 7373 2e68    if (compress.h
+000c88f0: 6173 5f76 616c 7565 2829 2920 7b0a 2020  as_value()) {.  
+000c8900: 2020 2f2f 204c 6574 2073 7761 7073 2062    // Let swaps b
+000c8910: 6520 7069 6563 6549 6e64 6578 20e2 8892  e pieceIndex ...
+000c8920: 2063 6f6d 7072 6573 732e 0a20 2020 2069   compress..    i
+000c8930: 6e74 2073 7761 7073 203d 2070 6965 6365  nt swaps = piece
+000c8940: 5f69 6e64 6578 202d 202a 636f 6d70 7265  _index - *compre
+000c8950: 7373 3b0a 0a20 2020 202f 2f20 5365 7420  ss;..    // Set 
+000c8960: 7069 6563 6549 6e64 6578 2074 6f20 372e  pieceIndex to 7.
+000c8970: 0a20 2020 2070 6965 6365 5f69 6e64 6578  .    piece_index
+000c8980: 203d 2037 3b0a 0a20 2020 202f 2f20 5768   = 7;..    // Wh
+000c8990: 696c 6520 7069 6563 6549 6e64 6578 2069  ile pieceIndex i
+000c89a0: 7320 6e6f 7420 3020 616e 6420 7377 6170  s not 0 and swap
+000c89b0: 7320 6973 2067 7265 6174 6572 2074 6861  s is greater tha
+000c89c0: 6e20 302c 0a20 2020 202f 2f20 7377 6170  n 0,.    // swap
+000c89d0: 2061 6464 7265 7373 5b70 6965 6365 496e   address[pieceIn
+000c89e0: 6465 785d 2077 6974 6820 6164 6472 6573  dex] with addres
+000c89f0: 735b 636f 6d70 7265 7373 202b 2073 7761  s[compress + swa
+000c8a00: 7073 20e2 8892 2031 5d2c 2061 6e64 2074  ps ... 1], and t
+000c8a10: 6865 6e0a 2020 2020 2f2f 2064 6563 7265  hen.    // decre
+000c8a20: 6173 6520 626f 7468 2070 6965 6365 496e  ase both pieceIn
+000c8a30: 6465 7820 616e 6420 7377 6170 7320 6279  dex and swaps by
+000c8a40: 2031 2e0a 2020 2020 7768 696c 6520 2870   1..    while (p
+000c8a50: 6965 6365 5f69 6e64 6578 2021 3d20 3020  iece_index != 0 
+000c8a60: 2626 2073 7761 7073 203e 2030 2920 7b0a  && swaps > 0) {.
+000c8a70: 2020 2020 2020 7374 643a 3a73 7761 7028        std::swap(
+000c8a80: 6164 6472 6573 735b 7069 6563 655f 696e  address[piece_in
+000c8a90: 6465 785d 2c20 6164 6472 6573 735b 2a63  dex], address[*c
+000c8aa0: 6f6d 7072 6573 7320 2b20 7377 6170 7320  ompress + swaps 
+000c8ab0: 2d20 315d 293b 0a20 2020 2020 2070 6965  - 1]);.      pie
+000c8ac0: 6365 5f69 6e64 6578 2d2d 3b0a 2020 2020  ce_index--;.    
+000c8ad0: 2020 7377 6170 732d 2d3b 0a20 2020 207d    swaps--;.    }
+000c8ae0: 0a20 207d 0a20 202f 2f20 4f74 6865 7277  .  }.  // Otherw
+000c8af0: 6973 652c 2069 6620 636f 6d70 7265 7373  ise, if compress
+000c8b00: 2069 7320 6e75 6c6c 2061 6e64 2070 6965   is null and pie
+000c8b10: 6365 496e 6465 7820 6973 206e 6f74 2038  ceIndex is not 8
+000c8b20: 2c20 7661 6c69 6461 7469 6f6e 2065 7272  , validation err
+000c8b30: 6f72 2c0a 2020 2f2f 2072 6574 7572 6e20  or,.  // return 
+000c8b40: 6661 696c 7572 652e 0a20 2065 6c73 6520  failure..  else 
+000c8b50: 6966 2028 7069 6563 655f 696e 6465 7820  if (piece_index 
+000c8b60: 213d 2038 2920 7b0a 2020 2020 6164 615f  != 8) {.    ada_
+000c8b70: 6c6f 6728 0a20 2020 2020 2020 2022 7061  log(.        "pa
+000c8b80: 7273 655f 6970 7636 2069 6620 636f 6d70  rse_ipv6 if comp
+000c8b90: 7265 7373 2069 7320 6e75 6c6c 2061 6e64  ress is null and
+000c8ba0: 2070 6965 6365 496e 6465 7820 6973 206e   pieceIndex is n
+000c8bb0: 6f74 2038 2c20 7661 6c69 6461 7469 6f6e  ot 8, validation
+000c8bc0: 2022 0a20 2020 2020 2020 2022 6572 726f   ".        "erro
+000c8bd0: 722c 2072 6574 7572 6e20 6661 696c 7572  r, return failur
+000c8be0: 6522 293b 0a20 2020 2072 6574 7572 6e20  e");.    return 
+000c8bf0: 6973 5f76 616c 6964 203d 2066 616c 7365  is_valid = false
+000c8c00: 3b0a 2020 7d0a 2020 2f2f 2054 4f44 4f3a  ;.  }.  // TODO:
+000c8c10: 204f 7074 696d 697a 6174 696f 6e20 6f70   Optimization op
+000c8c20: 706f 7274 756e 6974 793a 2047 6574 2072  portunity: Get r
+000c8c30: 6964 206f 6620 756e 6e65 6365 7373 6172  id of unnecessar
+000c8c40: 7920 7374 7269 6e67 2063 7265 6174 696f  y string creatio
+000c8c50: 6e2e 0a20 202f 2f20 544f 444f 3a20 5468  n..  // TODO: Th
+000c8c60: 6973 2069 7320 6c69 6b65 6c79 2061 2062  is is likely a b
+000c8c70: 7567 2062 6563 6175 7365 2069 7420 676f  ug because it go
+000c8c80: 6573 2062 6163 6b20 7570 6461 7465 5f62  es back update_b
+000c8c90: 6173 655f 686f 7374 6e61 6d65 2c20 6e6f  ase_hostname, no
+000c8ca0: 740a 2020 2f2f 2077 6861 7420 7765 2077  t.  // what we w
+000c8cb0: 616e 7420 746f 2064 6f2e 0a20 2075 7064  ant to do..  upd
+000c8cc0: 6174 655f 6261 7365 5f68 6f73 746e 616d  ate_base_hostnam
+000c8cd0: 6528 6164 613a 3a73 6572 6961 6c69 7a65  e(ada::serialize
+000c8ce0: 7273 3a3a 6970 7636 2861 6464 7265 7373  rs::ipv6(address
+000c8cf0: 2929 3b0a 2020 6164 615f 6c6f 6728 2270  ));.  ada_log("p
+000c8d00: 6172 7365 5f69 7076 3620 222c 2067 6574  arse_ipv6 ", get
+000c8d10: 5f68 6f73 746e 616d 6528 2929 3b0a 2020  _hostname());.  
+000c8d20: 4144 415f 4153 5345 5254 5f54 5255 4528  ADA_ASSERT_TRUE(
+000c8d30: 7661 6c69 6461 7465 2829 293b 0a20 2072  validate());.  r
+000c8d40: 6574 7572 6e20 7472 7565 3b0a 7d0a 0a62  eturn true;.}..b
+000c8d50: 6f6f 6c20 7572 6c5f 6167 6772 6567 6174  ool url_aggregat
+000c8d60: 6f72 3a3a 7061 7273 655f 6f70 6171 7565  or::parse_opaque
+000c8d70: 5f68 6f73 7428 7374 643a 3a73 7472 696e  _host(std::strin
+000c8d80: 675f 7669 6577 2069 6e70 7574 2920 7b0a  g_view input) {.
+000c8d90: 2020 6164 615f 6c6f 6728 2270 6172 7365    ada_log("parse
+000c8da0: 5f6f 7061 7175 655f 686f 7374 2022 2c20  _opaque_host ", 
+000c8db0: 696e 7075 742c 2022 5b22 2c20 696e 7075  input, "[", inpu
+000c8dc0: 742e 7369 7a65 2829 2c20 2220 6279 7465  t.size(), " byte
+000c8dd0: 735d 2229 3b0a 2020 4144 415f 4153 5345  s]");.  ADA_ASSE
+000c8de0: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
+000c8df0: 2829 293b 0a20 2041 4441 5f41 5353 4552  ());.  ADA_ASSER
+000c8e00: 545f 5452 5545 2821 6865 6c70 6572 733a  T_TRUE(!helpers:
+000c8e10: 3a6f 7665 726c 6170 7328 696e 7075 742c  :overlaps(input,
+000c8e20: 2062 7566 6665 7229 293b 0a20 2069 6620   buffer));.  if 
+000c8e30: 2873 7464 3a3a 616e 795f 6f66 2869 6e70  (std::any_of(inp
+000c8e40: 7574 2e62 6567 696e 2829 2c20 696e 7075  ut.begin(), inpu
+000c8e50: 742e 656e 6428 292c 0a20 2020 2020 2020  t.end(),.       
+000c8e60: 2020 2020 2020 2020 2020 2061 6461 3a3a             ada::
+000c8e70: 756e 6963 6f64 653a 3a69 735f 666f 7262  unicode::is_forb
+000c8e80: 6964 6465 6e5f 686f 7374 5f63 6f64 655f  idden_host_code_
+000c8e90: 706f 696e 7429 2920 7b0a 2020 2020 7265  point)) {.    re
+000c8ea0: 7475 726e 2069 735f 7661 6c69 6420 3d20  turn is_valid = 
+000c8eb0: 6661 6c73 653b 0a20 207d 0a0a 2020 2f2f  false;.  }..  //
+000c8ec0: 2052 6574 7572 6e20 7468 6520 7265 7375   Return the resu
+000c8ed0: 6c74 206f 6620 7275 6e6e 696e 6720 5554  lt of running UT
+000c8ee0: 462d 3820 7065 7263 656e 742d 656e 636f  F-8 percent-enco
+000c8ef0: 6465 206f 6e20 696e 7075 7420 7573 696e  de on input usin
+000c8f00: 6720 7468 6520 4330 0a20 202f 2f20 636f  g the C0.  // co
+000c8f10: 6e74 726f 6c20 7065 7263 656e 742d 656e  ntrol percent-en
+000c8f20: 636f 6465 2073 6574 2e0a 2020 7369 7a65  code set..  size
+000c8f30: 5f74 2069 6478 203d 2061 6461 3a3a 756e  _t idx = ada::un
+000c8f40: 6963 6f64 653a 3a70 6572 6365 6e74 5f65  icode::percent_e
+000c8f50: 6e63 6f64 655f 696e 6465 7828 0a20 2020  ncode_index(.   
+000c8f60: 2020 2069 6e70 7574 2c20 6368 6172 6163     input, charac
+000c8f70: 7465 725f 7365 7473 3a3a 4330 5f43 4f4e  ter_sets::C0_CON
+000c8f80: 5452 4f4c 5f50 4552 4345 4e54 5f45 4e43  TROL_PERCENT_ENC
+000c8f90: 4f44 4529 3b0a 2020 6966 2028 6964 7820  ODE);.  if (idx 
+000c8fa0: 3d3d 2069 6e70 7574 2e73 697a 6528 2929  == input.size())
+000c8fb0: 207b 0a20 2020 2075 7064 6174 655f 6261   {.    update_ba
+000c8fc0: 7365 5f68 6f73 746e 616d 6528 696e 7075  se_hostname(inpu
+000c8fd0: 7429 3b0a 2020 7d20 656c 7365 207b 0a20  t);.  } else {. 
+000c8fe0: 2020 202f 2f20 5765 206f 6e6c 7920 6372     // We only cr
+000c8ff0: 6561 7465 2061 2074 656d 706f 7261 7279  eate a temporary
+000c9000: 2073 7472 696e 6720 6966 2077 6520 6e65   string if we ne
+000c9010: 6564 2074 6f2e 0a20 2020 2075 7064 6174  ed to..    updat
+000c9020: 655f 6261 7365 5f68 6f73 746e 616d 6528  e_base_hostname(
+000c9030: 6164 613a 3a75 6e69 636f 6465 3a3a 7065  ada::unicode::pe
+000c9040: 7263 656e 745f 656e 636f 6465 280a 2020  rcent_encode(.  
+000c9050: 2020 2020 2020 696e 7075 742c 2063 6861        input, cha
+000c9060: 7261 6374 6572 5f73 6574 733a 3a43 305f  racter_sets::C0_
+000c9070: 434f 4e54 524f 4c5f 5045 5243 454e 545f  CONTROL_PERCENT_
+000c9080: 454e 434f 4445 2c20 6964 7829 293b 0a20  ENCODE, idx));. 
+000c9090: 207d 0a20 2041 4441 5f41 5353 4552 545f   }.  ADA_ASSERT_
+000c90a0: 5452 5545 2876 616c 6964 6174 6528 2929  TRUE(validate())
+000c90b0: 3b0a 2020 7265 7475 726e 2074 7275 653b  ;.  return true;
+000c90c0: 0a7d 0a0a 7374 643a 3a73 7472 696e 6720  .}..std::string 
+000c90d0: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
+000c90e0: 746f 5f64 6961 6772 616d 2829 2063 6f6e  to_diagram() con
+000c90f0: 7374 207b 0a20 2069 6620 2821 6973 5f76  st {.  if (!is_v
+000c9100: 616c 6964 2920 7b0a 2020 2020 7265 7475  alid) {.    retu
+000c9110: 726e 2022 696e 7661 6c69 6422 3b0a 2020  rn "invalid";.  
+000c9120: 7d0a 2020 7374 643a 3a73 7472 696e 6720  }.  std::string 
+000c9130: 616e 7377 6572 3b0a 2020 616e 7377 6572  answer;.  answer
+000c9140: 2e61 7070 656e 6428 6275 6666 6572 293b  .append(buffer);
+000c9150: 0a20 2061 6e73 7765 722e 6170 7065 6e64  .  answer.append
+000c9160: 2822 205b 2229 3b0a 2020 616e 7377 6572  (" [");.  answer
+000c9170: 2e61 7070 656e 6428 7374 643a 3a74 6f5f  .append(std::to_
+000c9180: 7374 7269 6e67 2862 7566 6665 722e 7369  string(buffer.si
+000c9190: 7a65 2829 2929 3b0a 2020 616e 7377 6572  ze()));.  answer
+000c91a0: 2e61 7070 656e 6428 2220 6279 7465 735d  .append(" bytes]
+000c91b0: 2229 3b0a 2020 616e 7377 6572 2e61 7070  ");.  answer.app
+000c91c0: 656e 6428 225c 6e22 293b 0a20 202f 2f20  end("\n");.  // 
+000c91d0: 6669 7273 7420 6c69 6e65 0a20 2073 7464  first line.  std
+000c91e0: 3a3a 7374 7269 6e67 206c 696e 6531 3b0a  ::string line1;.
+000c91f0: 2020 6c69 6e65 312e 7265 7369 7a65 2862    line1.resize(b
+000c9200: 7566 6665 722e 7369 7a65 2829 2c20 2720  uffer.size(), ' 
+000c9210: 2729 3b0a 2020 6966 2028 636f 6d70 6f6e  ');.  if (compon
+000c9220: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
+000c9230: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
+000c9240: 733a 3a6f 6d69 7474 6564 2920 7b0a 2020  s::omitted) {.  
+000c9250: 2020 6c69 6e65 315b 636f 6d70 6f6e 656e    line1[componen
+000c9260: 7473 2e68 6173 685f 7374 6172 745d 203d  ts.hash_start] =
+000c9270: 2027 7c27 3b0a 2020 7d0a 2020 6966 2028   '|';.  }.  if (
+000c9280: 636f 6d70 6f6e 656e 7473 2e73 6561 7263  components.searc
+000c9290: 685f 7374 6172 7420 213d 2075 726c 5f63  h_start != url_c
+000c92a0: 6f6d 706f 6e65 6e74 733a 3a6f 6d69 7474  omponents::omitt
+000c92b0: 6564 2920 7b0a 2020 2020 6c69 6e65 315b  ed) {.    line1[
+000c92c0: 636f 6d70 6f6e 656e 7473 2e73 6561 7263  components.searc
+000c92d0: 685f 7374 6172 745d 203d 2027 7c27 3b0a  h_start] = '|';.
+000c92e0: 2020 7d0a 2020 6966 2028 636f 6d70 6f6e    }.  if (compon
+000c92f0: 656e 7473 2e70 6174 686e 616d 655f 7374  ents.pathname_st
+000c9300: 6172 7420 213d 2062 7566 6665 722e 7369  art != buffer.si
+000c9310: 7a65 2829 2920 7b0a 2020 2020 6c69 6e65  ze()) {.    line
+000c9320: 315b 636f 6d70 6f6e 656e 7473 2e70 6174  1[components.pat
+000c9330: 686e 616d 655f 7374 6172 745d 203d 2027  hname_start] = '
+000c9340: 7c27 3b0a 2020 7d0a 2020 6966 2028 636f  |';.  }.  if (co
+000c9350: 6d70 6f6e 656e 7473 2e68 6f73 745f 656e  mponents.host_en
+000c9360: 6420 213d 2062 7566 6665 722e 7369 7a65  d != buffer.size
+000c9370: 2829 2920 7b0a 2020 2020 6c69 6e65 315b  ()) {.    line1[
+000c9380: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
+000c9390: 656e 645d 203d 2027 7c27 3b0a 2020 7d0a  end] = '|';.  }.
+000c93a0: 2020 6966 2028 636f 6d70 6f6e 656e 7473    if (components
+000c93b0: 2e68 6f73 745f 7374 6172 7420 213d 2062  .host_start != b
+000c93c0: 7566 6665 722e 7369 7a65 2829 2920 7b0a  uffer.size()) {.
+000c93d0: 2020 2020 6c69 6e65 315b 636f 6d70 6f6e      line1[compon
+000c93e0: 656e 7473 2e68 6f73 745f 7374 6172 745d  ents.host_start]
+000c93f0: 203d 2027 7c27 3b0a 2020 7d0a 2020 6966   = '|';.  }.  if
+000c9400: 2028 636f 6d70 6f6e 656e 7473 2e75 7365   (components.use
+000c9410: 726e 616d 655f 656e 6420 213d 2062 7566  rname_end != buf
+000c9420: 6665 722e 7369 7a65 2829 2920 7b0a 2020  fer.size()) {.  
+000c9430: 2020 6c69 6e65 315b 636f 6d70 6f6e 656e    line1[componen
+000c9440: 7473 2e75 7365 726e 616d 655f 656e 645d  ts.username_end]
+000c9450: 203d 2027 7c27 3b0a 2020 7d0a 2020 6966   = '|';.  }.  if
+000c9460: 2028 636f 6d70 6f6e 656e 7473 2e70 726f   (components.pro
+000c9470: 746f 636f 6c5f 656e 6420 213d 2062 7566  tocol_end != buf
+000c9480: 6665 722e 7369 7a65 2829 2920 7b0a 2020  fer.size()) {.  
+000c9490: 2020 6c69 6e65 315b 636f 6d70 6f6e 656e    line1[componen
+000c94a0: 7473 2e70 726f 746f 636f 6c5f 656e 645d  ts.protocol_end]
+000c94b0: 203d 2027 7c27 3b0a 2020 7d0a 2020 616e   = '|';.  }.  an
+000c94c0: 7377 6572 2e61 7070 656e 6428 6c69 6e65  swer.append(line
+000c94d0: 3129 3b0a 2020 616e 7377 6572 2e61 7070  1);.  answer.app
+000c94e0: 656e 6428 225c 6e22 293b 0a0a 2020 7374  end("\n");..  st
+000c94f0: 643a 3a73 7472 696e 6720 6c69 6e65 3220  d::string line2 
+000c9500: 3d20 6c69 6e65 313b 0a20 2069 6620 2863  = line1;.  if (c
+000c9510: 6f6d 706f 6e65 6e74 732e 6861 7368 5f73  omponents.hash_s
+000c9520: 7461 7274 2021 3d20 7572 6c5f 636f 6d70  tart != url_comp
+000c9530: 6f6e 656e 7473 3a3a 6f6d 6974 7465 6429  onents::omitted)
+000c9540: 207b 0a20 2020 206c 696e 6532 5b63 6f6d   {.    line2[com
+000c9550: 706f 6e65 6e74 732e 6861 7368 5f73 7461  ponents.hash_sta
+000c9560: 7274 5d20 3d20 2760 273b 0a20 2020 206c  rt] = '`';.    l
+000c9570: 696e 6531 5b63 6f6d 706f 6e65 6e74 732e  ine1[components.
+000c9580: 6861 7368 5f73 7461 7274 5d20 3d20 2720  hash_start] = ' 
+000c9590: 273b 0a0a 2020 2020 666f 7220 2873 697a  ';..    for (siz
+000c95a0: 655f 7420 6920 3d20 636f 6d70 6f6e 656e  e_t i = componen
+000c95b0: 7473 2e68 6173 685f 7374 6172 7420 2b20  ts.hash_start + 
+000c95c0: 313b 2069 203c 206c 696e 6532 2e73 697a  1; i < line2.siz
+000c95d0: 6528 293b 2069 2b2b 2920 7b0a 2020 2020  e(); i++) {.    
+000c95e0: 2020 6c69 6e65 325b 695d 203d 2027 2d27    line2[i] = '-'
+000c95f0: 3b0a 2020 2020 7d0a 2020 2020 6c69 6e65  ;.    }.    line
+000c9600: 322e 6170 7065 6e64 2822 2068 6173 685f  2.append(" hash_
+000c9610: 7374 6172 7422 293b 0a20 2020 2061 6e73  start");.    ans
+000c9620: 7765 722e 6170 7065 6e64 286c 696e 6532  wer.append(line2
+000c9630: 293b 0a20 2020 2061 6e73 7765 722e 6170  );.    answer.ap
+000c9640: 7065 6e64 2822 5c6e 2229 3b0a 2020 7d0a  pend("\n");.  }.
+000c9650: 0a20 2073 7464 3a3a 7374 7269 6e67 206c  .  std::string l
+000c9660: 696e 6533 203d 206c 696e 6531 3b0a 2020  ine3 = line1;.  
+000c9670: 6966 2028 636f 6d70 6f6e 656e 7473 2e73  if (components.s
+000c9680: 6561 7263 685f 7374 6172 7420 213d 2075  earch_start != u
+000c9690: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
+000c96a0: 6d69 7474 6564 2920 7b0a 2020 2020 6c69  mitted) {.    li
+000c96b0: 6e65 335b 636f 6d70 6f6e 656e 7473 2e73  ne3[components.s
+000c96c0: 6561 7263 685f 7374 6172 745d 203d 2027  earch_start] = '
+000c96d0: 6027 3b0a 2020 2020 6c69 6e65 315b 636f  `';.    line1[co
+000c96e0: 6d70 6f6e 656e 7473 2e73 6561 7263 685f  mponents.search_
+000c96f0: 7374 6172 745d 203d 2027 2027 3b0a 0a20  start] = ' ';.. 
+000c9700: 2020 2066 6f72 2028 7369 7a65 5f74 2069     for (size_t i
+000c9710: 203d 2063 6f6d 706f 6e65 6e74 732e 7365   = components.se
+000c9720: 6172 6368 5f73 7461 7274 202b 2031 3b20  arch_start + 1; 
+000c9730: 6920 3c20 6c69 6e65 332e 7369 7a65 2829  i < line3.size()
+000c9740: 3b20 692b 2b29 207b 0a20 2020 2020 206c  ; i++) {.      l
+000c9750: 696e 6533 5b69 5d20 3d20 272d 273b 0a20  ine3[i] = '-';. 
+000c9760: 2020 207d 0a20 2020 206c 696e 6533 2e61     }.    line3.a
+000c9770: 7070 656e 6428 2220 7365 6172 6368 5f73  ppend(" search_s
+000c9780: 7461 7274 2022 293b 0a20 2020 206c 696e  tart ");.    lin
+000c9790: 6533 2e61 7070 656e 6428 7374 643a 3a74  e3.append(std::t
+000c97a0: 6f5f 7374 7269 6e67 2863 6f6d 706f 6e65  o_string(compone
+000c97b0: 6e74 732e 7365 6172 6368 5f73 7461 7274  nts.search_start
+000c97c0: 2929 3b0a 2020 2020 616e 7377 6572 2e61  ));.    answer.a
+000c97d0: 7070 656e 6428 6c69 6e65 3329 3b0a 2020  ppend(line3);.  
+000c97e0: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000c97f0: 225c 6e22 293b 0a20 207d 0a0a 2020 7374  "\n");.  }..  st
+000c9800: 643a 3a73 7472 696e 6720 6c69 6e65 3420  d::string line4 
+000c9810: 3d20 6c69 6e65 313b 0a20 2069 6620 2863  = line1;.  if (c
+000c9820: 6f6d 706f 6e65 6e74 732e 7061 7468 6e61  omponents.pathna
+000c9830: 6d65 5f73 7461 7274 2021 3d20 6275 6666  me_start != buff
+000c9840: 6572 2e73 697a 6528 2929 207b 0a20 2020  er.size()) {.   
+000c9850: 206c 696e 6534 5b63 6f6d 706f 6e65 6e74   line4[component
+000c9860: 732e 7061 7468 6e61 6d65 5f73 7461 7274  s.pathname_start
+000c9870: 5d20 3d20 2760 273b 0a20 2020 206c 696e  ] = '`';.    lin
+000c9880: 6531 5b63 6f6d 706f 6e65 6e74 732e 7061  e1[components.pa
+000c9890: 7468 6e61 6d65 5f73 7461 7274 5d20 3d20  thname_start] = 
+000c98a0: 2720 273b 0a20 2020 2066 6f72 2028 7369  ' ';.    for (si
+000c98b0: 7a65 5f74 2069 203d 2063 6f6d 706f 6e65  ze_t i = compone
+000c98c0: 6e74 732e 7061 7468 6e61 6d65 5f73 7461  nts.pathname_sta
+000c98d0: 7274 202b 2031 3b20 6920 3c20 6c69 6e65  rt + 1; i < line
+000c98e0: 342e 7369 7a65 2829 3b20 692b 2b29 207b  4.size(); i++) {
+000c98f0: 0a20 2020 2020 206c 696e 6534 5b69 5d20  .      line4[i] 
+000c9900: 3d20 272d 273b 0a20 2020 207d 0a20 2020  = '-';.    }.   
+000c9910: 206c 696e 6534 2e61 7070 656e 6428 2220   line4.append(" 
+000c9920: 7061 7468 6e61 6d65 5f73 7461 7274 2022  pathname_start "
+000c9930: 293b 0a20 2020 206c 696e 6534 2e61 7070  );.    line4.app
+000c9940: 656e 6428 7374 643a 3a74 6f5f 7374 7269  end(std::to_stri
+000c9950: 6e67 2863 6f6d 706f 6e65 6e74 732e 7061  ng(components.pa
+000c9960: 7468 6e61 6d65 5f73 7461 7274 2929 3b0a  thname_start));.
+000c9970: 2020 2020 616e 7377 6572 2e61 7070 656e      answer.appen
+000c9980: 6428 6c69 6e65 3429 3b0a 2020 2020 616e  d(line4);.    an
+000c9990: 7377 6572 2e61 7070 656e 6428 225c 6e22  swer.append("\n"
+000c99a0: 293b 0a20 207d 0a0a 2020 7374 643a 3a73  );.  }..  std::s
+000c99b0: 7472 696e 6720 6c69 6e65 3520 3d20 6c69  tring line5 = li
+000c99c0: 6e65 313b 0a20 2069 6620 2863 6f6d 706f  ne1;.  if (compo
+000c99d0: 6e65 6e74 732e 686f 7374 5f65 6e64 2021  nents.host_end !
+000c99e0: 3d20 6275 6666 6572 2e73 697a 6528 2929  = buffer.size())
+000c99f0: 207b 0a20 2020 206c 696e 6535 5b63 6f6d   {.    line5[com
+000c9a00: 706f 6e65 6e74 732e 686f 7374 5f65 6e64  ponents.host_end
+000c9a10: 5d20 3d20 2760 273b 0a20 2020 206c 696e  ] = '`';.    lin
+000c9a20: 6531 5b63 6f6d 706f 6e65 6e74 732e 686f  e1[components.ho
+000c9a30: 7374 5f65 6e64 5d20 3d20 2720 273b 0a0a  st_end] = ' ';..
+000c9a40: 2020 2020 666f 7220 2873 697a 655f 7420      for (size_t 
+000c9a50: 6920 3d20 636f 6d70 6f6e 656e 7473 2e68  i = components.h
+000c9a60: 6f73 745f 656e 6420 2b20 313b 2069 203c  ost_end + 1; i <
+000c9a70: 206c 696e 6535 2e73 697a 6528 293b 2069   line5.size(); i
+000c9a80: 2b2b 2920 7b0a 2020 2020 2020 6c69 6e65  ++) {.      line
+000c9a90: 355b 695d 203d 2027 2d27 3b0a 2020 2020  5[i] = '-';.    
+000c9aa0: 7d0a 2020 2020 6c69 6e65 352e 6170 7065  }.    line5.appe
+000c9ab0: 6e64 2822 2068 6f73 745f 656e 6420 2229  nd(" host_end ")
+000c9ac0: 3b0a 2020 2020 6c69 6e65 352e 6170 7065  ;.    line5.appe
+000c9ad0: 6e64 2873 7464 3a3a 746f 5f73 7472 696e  nd(std::to_strin
+000c9ae0: 6728 636f 6d70 6f6e 656e 7473 2e68 6f73  g(components.hos
+000c9af0: 745f 656e 6429 293b 0a20 2020 2061 6e73  t_end));.    ans
+000c9b00: 7765 722e 6170 7065 6e64 286c 696e 6535  wer.append(line5
+000c9b10: 293b 0a20 2020 2061 6e73 7765 722e 6170  );.    answer.ap
+000c9b20: 7065 6e64 2822 5c6e 2229 3b0a 2020 7d0a  pend("\n");.  }.
+000c9b30: 0a20 2073 7464 3a3a 7374 7269 6e67 206c  .  std::string l
+000c9b40: 696e 6536 203d 206c 696e 6531 3b0a 2020  ine6 = line1;.  
+000c9b50: 6966 2028 636f 6d70 6f6e 656e 7473 2e68  if (components.h
+000c9b60: 6f73 745f 7374 6172 7420 213d 2062 7566  ost_start != buf
+000c9b70: 6665 722e 7369 7a65 2829 2920 7b0a 2020  fer.size()) {.  
+000c9b80: 2020 6c69 6e65 365b 636f 6d70 6f6e 656e    line6[componen
+000c9b90: 7473 2e68 6f73 745f 7374 6172 745d 203d  ts.host_start] =
+000c9ba0: 2027 6027 3b0a 2020 2020 6c69 6e65 315b   '`';.    line1[
+000c9bb0: 636f 6d70 6f6e 656e 7473 2e68 6f73 745f  components.host_
+000c9bc0: 7374 6172 745d 203d 2027 2027 3b0a 0a20  start] = ' ';.. 
+000c9bd0: 2020 2066 6f72 2028 7369 7a65 5f74 2069     for (size_t i
+000c9be0: 203d 2063 6f6d 706f 6e65 6e74 732e 686f   = components.ho
+000c9bf0: 7374 5f73 7461 7274 202b 2031 3b20 6920  st_start + 1; i 
+000c9c00: 3c20 6c69 6e65 362e 7369 7a65 2829 3b20  < line6.size(); 
+000c9c10: 692b 2b29 207b 0a20 2020 2020 206c 696e  i++) {.      lin
+000c9c20: 6536 5b69 5d20 3d20 272d 273b 0a20 2020  e6[i] = '-';.   
+000c9c30: 207d 0a20 2020 206c 696e 6536 2e61 7070   }.    line6.app
+000c9c40: 656e 6428 2220 686f 7374 5f73 7461 7274  end(" host_start
+000c9c50: 2022 293b 0a20 2020 206c 696e 6536 2e61   ");.    line6.a
+000c9c60: 7070 656e 6428 7374 643a 3a74 6f5f 7374  ppend(std::to_st
+000c9c70: 7269 6e67 2863 6f6d 706f 6e65 6e74 732e  ring(components.
+000c9c80: 686f 7374 5f73 7461 7274 2929 3b0a 2020  host_start));.  
+000c9c90: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000c9ca0: 6c69 6e65 3629 3b0a 2020 2020 616e 7377  line6);.    answ
+000c9cb0: 6572 2e61 7070 656e 6428 225c 6e22 293b  er.append("\n");
+000c9cc0: 0a20 207d 0a0a 2020 7374 643a 3a73 7472  .  }..  std::str
+000c9cd0: 696e 6720 6c69 6e65 3720 3d20 6c69 6e65  ing line7 = line
+000c9ce0: 313b 0a20 2069 6620 2863 6f6d 706f 6e65  1;.  if (compone
+000c9cf0: 6e74 732e 7573 6572 6e61 6d65 5f65 6e64  nts.username_end
+000c9d00: 2021 3d20 6275 6666 6572 2e73 697a 6528   != buffer.size(
+000c9d10: 2929 207b 0a20 2020 206c 696e 6537 5b63  )) {.    line7[c
+000c9d20: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
+000c9d30: 6d65 5f65 6e64 5d20 3d20 2760 273b 0a20  me_end] = '`';. 
+000c9d40: 2020 206c 696e 6531 5b63 6f6d 706f 6e65     line1[compone
+000c9d50: 6e74 732e 7573 6572 6e61 6d65 5f65 6e64  nts.username_end
+000c9d60: 5d20 3d20 2720 273b 0a0a 2020 2020 666f  ] = ' ';..    fo
+000c9d70: 7220 2873 697a 655f 7420 6920 3d20 636f  r (size_t i = co
+000c9d80: 6d70 6f6e 656e 7473 2e75 7365 726e 616d  mponents.usernam
+000c9d90: 655f 656e 6420 2b20 313b 2069 203c 206c  e_end + 1; i < l
+000c9da0: 696e 6537 2e73 697a 6528 293b 2069 2b2b  ine7.size(); i++
+000c9db0: 2920 7b0a 2020 2020 2020 6c69 6e65 375b  ) {.      line7[
+000c9dc0: 695d 203d 2027 2d27 3b0a 2020 2020 7d0a  i] = '-';.    }.
+000c9dd0: 2020 2020 6c69 6e65 372e 6170 7065 6e64      line7.append
+000c9de0: 2822 2075 7365 726e 616d 655f 656e 6420  (" username_end 
+000c9df0: 2229 3b0a 2020 2020 6c69 6e65 372e 6170  ");.    line7.ap
+000c9e00: 7065 6e64 2873 7464 3a3a 746f 5f73 7472  pend(std::to_str
+000c9e10: 696e 6728 636f 6d70 6f6e 656e 7473 2e75  ing(components.u
+000c9e20: 7365 726e 616d 655f 656e 6429 293b 0a20  sername_end));. 
+000c9e30: 2020 2061 6e73 7765 722e 6170 7065 6e64     answer.append
+000c9e40: 286c 696e 6537 293b 0a20 2020 2061 6e73  (line7);.    ans
+000c9e50: 7765 722e 6170 7065 6e64 2822 5c6e 2229  wer.append("\n")
+000c9e60: 3b0a 2020 7d0a 0a20 2073 7464 3a3a 7374  ;.  }..  std::st
+000c9e70: 7269 6e67 206c 696e 6538 203d 206c 696e  ring line8 = lin
+000c9e80: 6531 3b0a 2020 6966 2028 636f 6d70 6f6e  e1;.  if (compon
+000c9e90: 656e 7473 2e70 726f 746f 636f 6c5f 656e  ents.protocol_en
+000c9ea0: 6420 213d 2062 7566 6665 722e 7369 7a65  d != buffer.size
+000c9eb0: 2829 2920 7b0a 2020 2020 6c69 6e65 385b  ()) {.    line8[
+000c9ec0: 636f 6d70 6f6e 656e 7473 2e70 726f 746f  components.proto
+000c9ed0: 636f 6c5f 656e 645d 203d 2027 6027 3b0a  col_end] = '`';.
+000c9ee0: 2020 2020 6c69 6e65 315b 636f 6d70 6f6e      line1[compon
+000c9ef0: 656e 7473 2e70 726f 746f 636f 6c5f 656e  ents.protocol_en
+000c9f00: 645d 203d 2027 2027 3b0a 0a20 2020 2066  d] = ' ';..    f
+000c9f10: 6f72 2028 7369 7a65 5f74 2069 203d 2063  or (size_t i = c
+000c9f20: 6f6d 706f 6e65 6e74 732e 7072 6f74 6f63  omponents.protoc
+000c9f30: 6f6c 5f65 6e64 202b 2031 3b20 6920 3c20  ol_end + 1; i < 
+000c9f40: 6c69 6e65 382e 7369 7a65 2829 3b20 692b  line8.size(); i+
+000c9f50: 2b29 207b 0a20 2020 2020 206c 696e 6538  +) {.      line8
+000c9f60: 5b69 5d20 3d20 272d 273b 0a20 2020 207d  [i] = '-';.    }
+000c9f70: 0a20 2020 206c 696e 6538 2e61 7070 656e  .    line8.appen
+000c9f80: 6428 2220 7072 6f74 6f63 6f6c 5f65 6e64  d(" protocol_end
+000c9f90: 2022 293b 0a20 2020 206c 696e 6538 2e61   ");.    line8.a
+000c9fa0: 7070 656e 6428 7374 643a 3a74 6f5f 7374  ppend(std::to_st
+000c9fb0: 7269 6e67 2863 6f6d 706f 6e65 6e74 732e  ring(components.
+000c9fc0: 7072 6f74 6f63 6f6c 5f65 6e64 2929 3b0a  protocol_end));.
+000c9fd0: 2020 2020 616e 7377 6572 2e61 7070 656e      answer.appen
+000c9fe0: 6428 6c69 6e65 3829 3b0a 2020 2020 616e  d(line8);.    an
+000c9ff0: 7377 6572 2e61 7070 656e 6428 225c 6e22  swer.append("\n"
+000ca000: 293b 0a20 207d 0a0a 2020 6966 2028 636f  );.  }..  if (co
+000ca010: 6d70 6f6e 656e 7473 2e68 6173 685f 7374  mponents.hash_st
+000ca020: 6172 7420 3d3d 2075 726c 5f63 6f6d 706f  art == url_compo
+000ca030: 6e65 6e74 733a 3a6f 6d69 7474 6564 2920  nents::omitted) 
+000ca040: 7b0a 2020 2020 616e 7377 6572 2e61 7070  {.    answer.app
+000ca050: 656e 6428 226e 6f74 653a 2068 6173 6820  end("note: hash 
+000ca060: 6f6d 6974 7465 645c 6e22 293b 0a20 207d  omitted\n");.  }
+000ca070: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
+000ca080: 732e 7365 6172 6368 5f73 7461 7274 203d  s.search_start =
+000ca090: 3d20 7572 6c5f 636f 6d70 6f6e 656e 7473  = url_components
+000ca0a0: 3a3a 6f6d 6974 7465 6429 207b 0a20 2020  ::omitted) {.   
+000ca0b0: 2061 6e73 7765 722e 6170 7065 6e64 2822   answer.append("
+000ca0c0: 6e6f 7465 3a20 7365 6172 6368 206f 6d69  note: search omi
+000ca0d0: 7474 6564 5c6e 2229 3b0a 2020 7d0a 2020  tted\n");.  }.  
+000ca0e0: 6966 2028 636f 6d70 6f6e 656e 7473 2e70  if (components.p
+000ca0f0: 726f 746f 636f 6c5f 656e 6420 3e20 6275  rotocol_end > bu
+000ca100: 6666 6572 2e73 697a 6528 2929 207b 0a20  ffer.size()) {. 
+000ca110: 2020 2061 6e73 7765 722e 6170 7065 6e64     answer.append
+000ca120: 2822 7761 726e 696e 673a 2070 726f 746f  ("warning: proto
+000ca130: 636f 6c5f 656e 6420 6f76 6572 666c 6f77  col_end overflow
+000ca140: 735c 6e22 293b 0a20 207d 0a20 2069 6620  s\n");.  }.  if 
+000ca150: 2863 6f6d 706f 6e65 6e74 732e 7573 6572  (components.user
+000ca160: 6e61 6d65 5f65 6e64 203e 2062 7566 6665  name_end > buffe
+000ca170: 722e 7369 7a65 2829 2920 7b0a 2020 2020  r.size()) {.    
+000ca180: 616e 7377 6572 2e61 7070 656e 6428 2277  answer.append("w
+000ca190: 6172 6e69 6e67 3a20 7573 6572 6e61 6d65  arning: username
+000ca1a0: 5f65 6e64 206f 7665 7266 6c6f 7773 5c6e  _end overflows\n
+000ca1b0: 2229 3b0a 2020 7d0a 2020 6966 2028 636f  ");.  }.  if (co
+000ca1c0: 6d70 6f6e 656e 7473 2e68 6f73 745f 7374  mponents.host_st
+000ca1d0: 6172 7420 3e20 6275 6666 6572 2e73 697a  art > buffer.siz
+000ca1e0: 6528 2929 207b 0a20 2020 2061 6e73 7765  e()) {.    answe
+000ca1f0: 722e 6170 7065 6e64 2822 7761 726e 696e  r.append("warnin
+000ca200: 673a 2068 6f73 745f 7374 6172 7420 6f76  g: host_start ov
+000ca210: 6572 666c 6f77 735c 6e22 293b 0a20 207d  erflows\n");.  }
+000ca220: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
+000ca230: 732e 686f 7374 5f65 6e64 203e 2062 7566  s.host_end > buf
+000ca240: 6665 722e 7369 7a65 2829 2920 7b0a 2020  fer.size()) {.  
+000ca250: 2020 616e 7377 6572 2e61 7070 656e 6428    answer.append(
+000ca260: 2277 6172 6e69 6e67 3a20 686f 7374 5f65  "warning: host_e
+000ca270: 6e64 206f 7665 7266 6c6f 7773 5c6e 2229  nd overflows\n")
+000ca280: 3b0a 2020 7d0a 2020 6966 2028 636f 6d70  ;.  }.  if (comp
+000ca290: 6f6e 656e 7473 2e70 6174 686e 616d 655f  onents.pathname_
+000ca2a0: 7374 6172 7420 3e20 6275 6666 6572 2e73  start > buffer.s
+000ca2b0: 697a 6528 2929 207b 0a20 2020 2061 6e73  ize()) {.    ans
+000ca2c0: 7765 722e 6170 7065 6e64 2822 7761 726e  wer.append("warn
+000ca2d0: 696e 673a 2070 6174 686e 616d 655f 7374  ing: pathname_st
+000ca2e0: 6172 7420 6f76 6572 666c 6f77 735c 6e22  art overflows\n"
+000ca2f0: 293b 0a20 207d 0a20 2072 6574 7572 6e20  );.  }.  return 
+000ca300: 616e 7377 6572 3b0a 7d0a 0a62 6f6f 6c20  answer;.}..bool 
+000ca310: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
+000ca320: 7661 6c69 6461 7465 2829 2063 6f6e 7374  validate() const
+000ca330: 206e 6f65 7863 6570 7420 7b0a 2020 6966   noexcept {.  if
+000ca340: 2028 2169 735f 7661 6c69 6429 207b 0a20   (!is_valid) {. 
+000ca350: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
+000ca360: 2020 7d0a 2020 6966 2028 2163 6f6d 706f    }.  if (!compo
+000ca370: 6e65 6e74 732e 6368 6563 6b5f 6f66 6673  nents.check_offs
+000ca380: 6574 5f63 6f6e 7369 7374 656e 6379 2829  et_consistency()
+000ca390: 2920 7b0a 2020 2020 6164 615f 6c6f 6728  ) {.    ada_log(
+000ca3a0: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
+000ca3b0: 3a76 616c 6964 6174 6520 696e 636f 6e73  :validate incons
+000ca3c0: 6973 7465 6e74 2063 6f6d 706f 6e65 6e74  istent component
+000ca3d0: 7320 5c6e 222c 0a20 2020 2020 2020 2020  s \n",.         
+000ca3e0: 2020 2074 6f5f 6469 6167 7261 6d28 2929     to_diagram())
+000ca3f0: 3b0a 2020 2020 7265 7475 726e 2066 616c  ;.    return fal
+000ca400: 7365 3b0a 2020 7d0a 2020 2f2f 2057 6520  se;.  }.  // We 
+000ca410: 6861 7665 2061 2063 7265 6469 626c 6520  have a credible 
+000ca420: 636f 6d70 6f6e 656e 7473 2073 7472 7563  components struc
+000ca430: 742c 2062 7574 206c 6574 2075 7320 696e  t, but let us in
+000ca440: 7665 7374 6976 6174 6520 6d6f 7265 0a20  vestivate more. 
+000ca450: 202f 2f20 6361 7265 6675 6c6c 793a 0a20   // carefully:. 
+000ca460: 202f 2a2a 0a20 2020 2a20 6874 7470 733a   /**.   * https:
+000ca470: 2f2f 7573 6572 3a70 6173 7340 6578 616d  //user:pass@exam
+000ca480: 706c 652e 636f 6d3a 3132 3334 2f66 6f6f  ple.com:1234/foo
+000ca490: 2f62 6172 3f62 617a 2371 7575 780a 2020  /bar?baz#quux.  
+000ca4a0: 202a 2020 2020 2020 207c 2020 2020 207c   *       |     |
+000ca4b0: 2020 2020 7c20 2020 2020 2020 2020 207c      |          |
+000ca4c0: 205e 5e5e 5e7c 2020 2020 2020 207c 2020   ^^^^|       |  
+000ca4d0: 207c 0a20 2020 2a20 2020 2020 2020 7c20   |.   *       | 
+000ca4e0: 2020 2020 7c20 2020 207c 2020 2020 2020      |    |      
+000ca4f0: 2020 2020 7c20 7c20 2020 7c20 2020 2020      | |   |     
+000ca500: 2020 7c20 2020 602d 2d2d 2d2d 2068 6173    |   `----- has
+000ca510: 685f 7374 6172 740a 2020 202a 2020 2020  h_start.   *    
+000ca520: 2020 207c 2020 2020 207c 2020 2020 7c20     |     |    | 
+000ca530: 2020 2020 2020 2020 207c 207c 2020 207c           | |   |
+000ca540: 2020 2020 2020 2060 2d2d 2d2d 2d2d 2d2d         `--------
+000ca550: 2d20 7365 6172 6368 5f73 7461 7274 0a20  - search_start. 
+000ca560: 2020 2a20 2020 2020 2020 7c20 2020 2020    *       |     
+000ca570: 7c20 2020 207c 2020 2020 2020 2020 2020  |    |          
+000ca580: 7c20 7c20 2020 602d 2d2d 2d2d 2d2d 2d2d  | |   `---------
+000ca590: 2d2d 2d2d 2d2d 2d2d 2070 6174 686e 616d  -------- pathnam
+000ca5a0: 655f 7374 6172 740a 2020 202a 2020 2020  e_start.   *    
+000ca5b0: 2020 207c 2020 2020 207c 2020 2020 7c20     |     |    | 
+000ca5c0: 2020 2020 2020 2020 207c 2060 2d2d 2d2d           | `----
+000ca5d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000ca5e0: 2d20 706f 7274 0a20 2020 2a20 2020 2020  - port.   *     
+000ca5f0: 2020 7c20 2020 2020 7c20 2020 207c 2020    |     |    |  
+000ca600: 2020 2020 2020 2020 602d 2d2d 2d2d 2d2d          `-------
+000ca610: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000ca620: 2068 6f73 745f 656e 640a 2020 202a 2020   host_end.   *  
+000ca630: 2020 2020 207c 2020 2020 207c 2020 2020       |     |    
+000ca640: 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  `---------------
+000ca650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000ca660: 2d2d 2d20 686f 7374 5f73 7461 7274 0a20  --- host_start. 
+000ca670: 2020 2a20 2020 2020 2020 7c20 2020 2020    *       |     
+000ca680: 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  `---------------
+000ca690: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000ca6a0: 2d2d 2d2d 2d2d 2d2d 2075 7365 726e 616d  -------- usernam
+000ca6b0: 655f 656e 640a 2020 202a 2020 2020 2020  e_end.   *      
+000ca6c0: 2060 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   `--------------
+000ca6d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000ca6e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20  --------------- 
+000ca6f0: 7072 6f74 6f63 6f6c 5f65 6e64 0a20 2020  protocol_end.   
+000ca700: 2a2f 0a20 2069 6620 2863 6f6d 706f 6e65  */.  if (compone
+000ca710: 6e74 732e 7072 6f74 6f63 6f6c 5f65 6e64  nts.protocol_end
+000ca720: 203d 3d20 7572 6c5f 636f 6d70 6f6e 656e   == url_componen
+000ca730: 7473 3a3a 6f6d 6974 7465 6429 207b 0a20  ts::omitted) {. 
+000ca740: 2020 2061 6461 5f6c 6f67 2822 7572 6c5f     ada_log("url_
+000ca750: 6167 6772 6567 6174 6f72 3a3a 7661 6c69  aggregator::vali
+000ca760: 6461 7465 206f 6d69 7474 6564 2070 726f  date omitted pro
+000ca770: 746f 636f 6c5f 656e 6420 5c6e 222c 2074  tocol_end \n", t
+000ca780: 6f5f 6469 6167 7261 6d28 2929 3b0a 2020  o_diagram());.  
+000ca790: 2020 7265 7475 726e 2066 616c 7365 3b0a    return false;.
+000ca7a0: 2020 7d0a 2020 6966 2028 636f 6d70 6f6e    }.  if (compon
+000ca7b0: 656e 7473 2e75 7365 726e 616d 655f 656e  ents.username_en
+000ca7c0: 6420 3d3d 2075 726c 5f63 6f6d 706f 6e65  d == url_compone
+000ca7d0: 6e74 733a 3a6f 6d69 7474 6564 2920 7b0a  nts::omitted) {.
+000ca7e0: 2020 2020 6164 615f 6c6f 6728 2275 726c      ada_log("url
+000ca7f0: 5f61 6767 7265 6761 746f 723a 3a76 616c  _aggregator::val
+000ca800: 6964 6174 6520 6f6d 6974 7465 6420 7573  idate omitted us
+000ca810: 6572 6e61 6d65 5f65 6e64 205c 6e22 2c20  ername_end \n", 
+000ca820: 746f 5f64 6961 6772 616d 2829 293b 0a20  to_diagram());. 
+000ca830: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
+000ca840: 0a20 207d 0a20 2069 6620 2863 6f6d 706f  .  }.  if (compo
+000ca850: 6e65 6e74 732e 686f 7374 5f73 7461 7274  nents.host_start
+000ca860: 203d 3d20 7572 6c5f 636f 6d70 6f6e 656e   == url_componen
+000ca870: 7473 3a3a 6f6d 6974 7465 6429 207b 0a20  ts::omitted) {. 
+000ca880: 2020 2061 6461 5f6c 6f67 2822 7572 6c5f     ada_log("url_
+000ca890: 6167 6772 6567 6174 6f72 3a3a 7661 6c69  aggregator::vali
+000ca8a0: 6461 7465 206f 6d69 7474 6564 2068 6f73  date omitted hos
+000ca8b0: 745f 7374 6172 7420 5c6e 222c 2074 6f5f  t_start \n", to_
+000ca8c0: 6469 6167 7261 6d28 2929 3b0a 2020 2020  diagram());.    
+000ca8d0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000ca8e0: 7d0a 2020 6966 2028 636f 6d70 6f6e 656e  }.  if (componen
+000ca8f0: 7473 2e68 6f73 745f 656e 6420 3d3d 2075  ts.host_end == u
+000ca900: 726c 5f63 6f6d 706f 6e65 6e74 733a 3a6f  rl_components::o
+000ca910: 6d69 7474 6564 2920 7b0a 2020 2020 6164  mitted) {.    ad
+000ca920: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
+000ca930: 6761 746f 723a 3a76 616c 6964 6174 6520  gator::validate 
+000ca940: 6f6d 6974 7465 6420 686f 7374 5f65 6e64  omitted host_end
+000ca950: 205c 6e22 2c20 746f 5f64 6961 6772 616d   \n", to_diagram
+000ca960: 2829 293b 0a20 2020 2072 6574 7572 6e20  ());.    return 
+000ca970: 6661 6c73 653b 0a20 207d 0a20 2069 6620  false;.  }.  if 
+000ca980: 2863 6f6d 706f 6e65 6e74 732e 7061 7468  (components.path
+000ca990: 6e61 6d65 5f73 7461 7274 203d 3d20 7572  name_start == ur
+000ca9a0: 6c5f 636f 6d70 6f6e 656e 7473 3a3a 6f6d  l_components::om
+000ca9b0: 6974 7465 6429 207b 0a20 2020 2061 6461  itted) {.    ada
+000ca9c0: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
+000ca9d0: 6174 6f72 3a3a 7661 6c69 6461 7465 206f  ator::validate o
+000ca9e0: 6d69 7474 6564 2070 6174 686e 616d 655f  mitted pathname_
+000ca9f0: 7374 6172 7420 5c6e 222c 2074 6f5f 6469  start \n", to_di
+000caa00: 6167 7261 6d28 2929 3b0a 2020 2020 7265  agram());.    re
+000caa10: 7475 726e 2066 616c 7365 3b0a 2020 7d0a  turn false;.  }.
+000caa20: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
+000caa30: 732e 7072 6f74 6f63 6f6c 5f65 6e64 203e  s.protocol_end >
+000caa40: 2062 7566 6665 722e 7369 7a65 2829 2920   buffer.size()) 
+000caa50: 7b0a 2020 2020 6164 615f 6c6f 6728 2275  {.    ada_log("u
+000caa60: 726c 5f61 6767 7265 6761 746f 723a 3a76  rl_aggregator::v
+000caa70: 616c 6964 6174 6520 7072 6f74 6f63 6f6c  alidate protocol
+000caa80: 5f65 6e64 206f 7665 7266 6c6f 7720 5c6e  _end overflow \n
+000caa90: 222c 2074 6f5f 6469 6167 7261 6d28 2929  ", to_diagram())
+000caaa0: 3b0a 2020 2020 7265 7475 726e 2066 616c  ;.    return fal
+000caab0: 7365 3b0a 2020 7d0a 2020 6966 2028 636f  se;.  }.  if (co
+000caac0: 6d70 6f6e 656e 7473 2e75 7365 726e 616d  mponents.usernam
+000caad0: 655f 656e 6420 3e20 6275 6666 6572 2e73  e_end > buffer.s
+000caae0: 697a 6528 2929 207b 0a20 2020 2061 6461  ize()) {.    ada
+000caaf0: 5f6c 6f67 2822 7572 6c5f 6167 6772 6567  _log("url_aggreg
+000cab00: 6174 6f72 3a3a 7661 6c69 6461 7465 2075  ator::validate u
+000cab10: 7365 726e 616d 655f 656e 6420 6f76 6572  sername_end over
+000cab20: 666c 6f77 205c 6e22 2c20 746f 5f64 6961  flow \n", to_dia
+000cab30: 6772 616d 2829 293b 0a20 2020 2072 6574  gram());.    ret
+000cab40: 7572 6e20 6661 6c73 653b 0a20 207d 0a20  urn false;.  }. 
+000cab50: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
+000cab60: 686f 7374 5f73 7461 7274 203e 2062 7566  host_start > buf
+000cab70: 6665 722e 7369 7a65 2829 2920 7b0a 2020  fer.size()) {.  
+000cab80: 2020 6164 615f 6c6f 6728 2275 726c 5f61    ada_log("url_a
+000cab90: 6767 7265 6761 746f 723a 3a76 616c 6964  ggregator::valid
+000caba0: 6174 6520 686f 7374 5f73 7461 7274 206f  ate host_start o
+000cabb0: 7665 7266 6c6f 7720 5c6e 222c 2074 6f5f  verflow \n", to_
+000cabc0: 6469 6167 7261 6d28 2929 3b0a 2020 2020  diagram());.    
+000cabd0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000cabe0: 7d0a 2020 6966 2028 636f 6d70 6f6e 656e  }.  if (componen
+000cabf0: 7473 2e68 6f73 745f 656e 6420 3e20 6275  ts.host_end > bu
+000cac00: 6666 6572 2e73 697a 6528 2929 207b 0a20  ffer.size()) {. 
+000cac10: 2020 2061 6461 5f6c 6f67 2822 7572 6c5f     ada_log("url_
+000cac20: 6167 6772 6567 6174 6f72 3a3a 7661 6c69  aggregator::vali
+000cac30: 6461 7465 2068 6f73 745f 656e 6420 6f76  date host_end ov
+000cac40: 6572 666c 6f77 205c 6e22 2c20 746f 5f64  erflow \n", to_d
+000cac50: 6961 6772 616d 2829 293b 0a20 2020 2072  iagram());.    r
+000cac60: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
+000cac70: 0a20 2069 6620 2863 6f6d 706f 6e65 6e74  .  if (component
+000cac80: 732e 7061 7468 6e61 6d65 5f73 7461 7274  s.pathname_start
+000cac90: 203e 2062 7566 6665 722e 7369 7a65 2829   > buffer.size()
+000caca0: 2920 7b0a 2020 2020 6164 615f 6c6f 6728  ) {.    ada_log(
+000cacb0: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
+000cacc0: 3a76 616c 6964 6174 6520 7061 7468 6e61  :validate pathna
+000cacd0: 6d65 5f73 7461 7274 206f 7665 7266 6c6f  me_start overflo
+000cace0: 7720 5c6e 222c 0a20 2020 2020 2020 2020  w \n",.         
+000cacf0: 2020 2074 6f5f 6469 6167 7261 6d28 2929     to_diagram())
+000cad00: 3b0a 2020 2020 7265 7475 726e 2066 616c  ;.    return fal
+000cad10: 7365 3b0a 2020 7d0a 0a20 2069 6620 2863  se;.  }..  if (c
+000cad20: 6f6d 706f 6e65 6e74 732e 7072 6f74 6f63  omponents.protoc
+000cad30: 6f6c 5f65 6e64 203e 2030 2920 7b0a 2020  ol_end > 0) {.  
+000cad40: 2020 6966 2028 6275 6666 6572 5b63 6f6d    if (buffer[com
+000cad50: 706f 6e65 6e74 732e 7072 6f74 6f63 6f6c  ponents.protocol
+000cad60: 5f65 6e64 202d 2031 5d20 213d 2027 3a27  _end - 1] != ':'
+000cad70: 2920 7b0a 2020 2020 2020 6164 615f 6c6f  ) {.      ada_lo
+000cad80: 6728 0a20 2020 2020 2020 2020 2022 7572  g(.          "ur
+000cad90: 6c5f 6167 6772 6567 6174 6f72 3a3a 7661  l_aggregator::va
+000cada0: 6c69 6461 7465 206d 6973 7369 6e67 203a  lidate missing :
+000cadb0: 2061 7420 7468 6520 656e 6420 6f66 2074   at the end of t
+000cadc0: 6865 2070 726f 746f 636f 6c20 5c6e 222c  he protocol \n",
+000cadd0: 0a20 2020 2020 2020 2020 2074 6f5f 6469  .          to_di
+000cade0: 6167 7261 6d28 2929 3b0a 2020 2020 2020  agram());.      
+000cadf0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000cae00: 2020 7d0a 2020 7d0a 0a20 2069 6620 2863    }.  }..  if (c
+000cae10: 6f6d 706f 6e65 6e74 732e 7573 6572 6e61  omponents.userna
+000cae20: 6d65 5f65 6e64 2021 3d20 6275 6666 6572  me_end != buffer
+000cae30: 2e73 697a 6528 2920 2626 0a20 2020 2020  .size() &&.     
+000cae40: 2063 6f6d 706f 6e65 6e74 732e 7573 6572   components.user
+000cae50: 6e61 6d65 5f65 6e64 203e 2063 6f6d 706f  name_end > compo
+000cae60: 6e65 6e74 732e 7072 6f74 6f63 6f6c 5f65  nents.protocol_e
+000cae70: 6e64 202b 2032 2920 7b0a 2020 2020 6966  nd + 2) {.    if
+000cae80: 2028 6275 6666 6572 5b63 6f6d 706f 6e65   (buffer[compone
+000cae90: 6e74 732e 7573 6572 6e61 6d65 5f65 6e64  nts.username_end
+000caea0: 5d20 213d 2027 3a27 2026 260a 2020 2020  ] != ':' &&.    
+000caeb0: 2020 2020 6275 6666 6572 5b63 6f6d 706f      buffer[compo
+000caec0: 6e65 6e74 732e 7573 6572 6e61 6d65 5f65  nents.username_e
+000caed0: 6e64 5d20 213d 2027 4027 2920 7b0a 2020  nd] != '@') {.  
+000caee0: 2020 2020 6164 615f 6c6f 6728 0a20 2020      ada_log(.   
+000caef0: 2020 2020 2020 2022 7572 6c5f 6167 6772         "url_aggr
+000caf00: 6567 6174 6f72 3a3a 7661 6c69 6461 7465  egator::validate
+000caf10: 206d 6973 7369 6e67 203a 206f 7220 4020   missing : or @ 
+000caf20: 6174 2074 6865 2065 6e64 206f 6620 7468  at the end of th
+000caf30: 6520 7573 6572 6e61 6d65 2022 0a20 2020  e username ".   
+000caf40: 2020 2020 2020 2022 5c6e 222c 0a20 2020         "\n",.   
+000caf50: 2020 2020 2020 2074 6f5f 6469 6167 7261         to_diagra
+000caf60: 6d28 2929 3b0a 2020 2020 2020 7265 7475  m());.      retu
+000caf70: 726e 2066 616c 7365 3b0a 2020 2020 7d0a  rn false;.    }.
+000caf80: 2020 7d0a 0a20 2069 6620 2863 6f6d 706f    }..  if (compo
+000caf90: 6e65 6e74 732e 686f 7374 5f73 7461 7274  nents.host_start
+000cafa0: 2021 3d20 6275 6666 6572 2e73 697a 6528   != buffer.size(
+000cafb0: 2929 207b 0a20 2020 2069 6620 2863 6f6d  )) {.    if (com
+000cafc0: 706f 6e65 6e74 732e 686f 7374 5f73 7461  ponents.host_sta
+000cafd0: 7274 203e 2063 6f6d 706f 6e65 6e74 732e  rt > components.
+000cafe0: 7573 6572 6e61 6d65 5f65 6e64 2920 7b0a  username_end) {.
+000caff0: 2020 2020 2020 6966 2028 6275 6666 6572        if (buffer
+000cb000: 5b63 6f6d 706f 6e65 6e74 732e 686f 7374  [components.host
+000cb010: 5f73 7461 7274 5d20 213d 2027 4027 2920  _start] != '@') 
+000cb020: 7b0a 2020 2020 2020 2020 6164 615f 6c6f  {.        ada_lo
+000cb030: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
+000cb040: 7572 6c5f 6167 6772 6567 6174 6f72 3a3a  url_aggregator::
+000cb050: 7661 6c69 6461 7465 206d 6973 7369 6e67  validate missing
+000cb060: 2040 2061 7420 7468 6520 656e 6420 6f66   @ at the end of
+000cb070: 2074 6865 2070 6173 7377 6f72 6420 5c6e   the password \n
+000cb080: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+000cb090: 6f5f 6469 6167 7261 6d28 2929 3b0a 2020  o_diagram());.  
+000cb0a0: 2020 2020 2020 7265 7475 726e 2066 616c        return fal
+000cb0b0: 7365 3b0a 2020 2020 2020 7d0a 2020 2020  se;.      }.    
+000cb0c0: 7d20 656c 7365 2069 6620 2863 6f6d 706f  } else if (compo
+000cb0d0: 6e65 6e74 732e 686f 7374 5f73 7461 7274  nents.host_start
+000cb0e0: 203d 3d20 636f 6d70 6f6e 656e 7473 2e75   == components.u
+000cb0f0: 7365 726e 616d 655f 656e 6420 2626 0a20  sername_end &&. 
+000cb100: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000cb110: 6d70 6f6e 656e 7473 2e68 6f73 745f 656e  mponents.host_en
+000cb120: 6420 3e20 636f 6d70 6f6e 656e 7473 2e68  d > components.h
+000cb130: 6f73 745f 7374 6172 7429 207b 0a20 2020  ost_start) {.   
+000cb140: 2020 2069 6620 2863 6f6d 706f 6e65 6e74     if (component
+000cb150: 732e 686f 7374 5f73 7461 7274 203d 3d20  s.host_start == 
+000cb160: 636f 6d70 6f6e 656e 7473 2e70 726f 746f  components.proto
+000cb170: 636f 6c5f 656e 6420 2b20 3229 207b 0a20  col_end + 2) {. 
+000cb180: 2020 2020 2020 2069 6620 2862 7566 6665         if (buffe
+000cb190: 725b 636f 6d70 6f6e 656e 7473 2e70 726f  r[components.pro
+000cb1a0: 746f 636f 6c5f 656e 645d 2021 3d20 272f  tocol_end] != '/
+000cb1b0: 2720 7c7c 0a20 2020 2020 2020 2020 2020  ' ||.           
+000cb1c0: 2062 7566 6665 725b 636f 6d70 6f6e 656e   buffer[componen
+000cb1d0: 7473 2e70 726f 746f 636f 6c5f 656e 6420  ts.protocol_end 
+000cb1e0: 2b20 315d 2021 3d20 272f 2729 207b 0a20  + 1] != '/') {. 
+000cb1f0: 2020 2020 2020 2020 2061 6461 5f6c 6f67           ada_log
+000cb200: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000cb210: 2275 726c 5f61 6767 7265 6761 746f 723a  "url_aggregator:
+000cb220: 3a76 616c 6964 6174 6520 6d69 7373 696e  :validate missin
+000cb230: 6720 2f2f 2062 6574 7765 656e 2070 726f  g // between pro
+000cb240: 746f 636f 6c20 616e 6420 686f 7374 2022  tocol and host "
+000cb250: 0a20 2020 2020 2020 2020 2020 2020 2022  .              "
+000cb260: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+000cb270: 2020 2074 6f5f 6469 6167 7261 6d28 2929     to_diagram())
+000cb280: 3b0a 2020 2020 2020 2020 2020 7265 7475  ;.          retu
+000cb290: 726e 2066 616c 7365 3b0a 2020 2020 2020  rn false;.      
+000cb2a0: 2020 7d0a 2020 2020 2020 7d20 656c 7365    }.      } else
+000cb2b0: 207b 0a20 2020 2020 2020 2069 6620 2863   {.        if (c
+000cb2c0: 6f6d 706f 6e65 6e74 732e 686f 7374 5f73  omponents.host_s
+000cb2d0: 7461 7274 203e 2063 6f6d 706f 6e65 6e74  tart > component
+000cb2e0: 732e 7072 6f74 6f63 6f6c 5f65 6e64 2026  s.protocol_end &
+000cb2f0: 260a 2020 2020 2020 2020 2020 2020 6275  &.            bu
+000cb300: 6666 6572 5b63 6f6d 706f 6e65 6e74 732e  ffer[components.
+000cb310: 686f 7374 5f73 7461 7274 5d20 213d 2027  host_start] != '
+000cb320: 4027 2920 7b0a 2020 2020 2020 2020 2020  @') {.          
+000cb330: 6164 615f 6c6f 6728 0a20 2020 2020 2020  ada_log(.       
+000cb340: 2020 2020 2020 2022 7572 6c5f 6167 6772         "url_aggr
+000cb350: 6567 6174 6f72 3a3a 7661 6c69 6461 7465  egator::validate
+000cb360: 206d 6973 7369 6e67 2040 2061 7420 7468   missing @ at th
+000cb370: 6520 656e 6420 6f66 2074 6865 2075 7365  e end of the use
+000cb380: 726e 616d 6520 220a 2020 2020 2020 2020  rname ".        
+000cb390: 2020 2020 2020 225c 6e22 2c0a 2020 2020        "\n",.    
+000cb3a0: 2020 2020 2020 2020 2020 746f 5f64 6961            to_dia
+000cb3b0: 6772 616d 2829 293b 0a20 2020 2020 2020  gram());.       
+000cb3c0: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
+000cb3d0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000cb3e0: 207d 0a20 2020 207d 2065 6c73 6520 7b0a   }.    } else {.
+000cb3f0: 2020 2020 2020 6966 2028 636f 6d70 6f6e        if (compon
+000cb400: 656e 7473 2e68 6f73 745f 656e 6420 213d  ents.host_end !=
+000cb410: 2063 6f6d 706f 6e65 6e74 732e 686f 7374   components.host
+000cb420: 5f73 7461 7274 2920 7b0a 2020 2020 2020  _start) {.      
+000cb430: 2020 6164 615f 6c6f 6728 2275 726c 5f61    ada_log("url_a
+000cb440: 6767 7265 6761 746f 723a 3a76 616c 6964  ggregator::valid
+000cb450: 6174 6520 6578 7065 6374 6564 206f 6d69  ate expected omi
+000cb460: 7474 6564 2068 6f73 7420 5c6e 222c 0a20  tted host \n",. 
+000cb470: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000cb480: 6f5f 6469 6167 7261 6d28 2929 3b0a 2020  o_diagram());.  
+000cb490: 2020 2020 2020 7265 7475 726e 2066 616c        return fal
+000cb4a0: 7365 3b0a 2020 2020 2020 7d0a 2020 2020  se;.      }.    
+000cb4b0: 7d0a 2020 7d0a 2020 6966 2028 636f 6d70  }.  }.  if (comp
+000cb4c0: 6f6e 656e 7473 2e68 6f73 745f 656e 6420  onents.host_end 
+000cb4d0: 213d 2062 7566 6665 722e 7369 7a65 2829  != buffer.size()
+000cb4e0: 2026 260a 2020 2020 2020 636f 6d70 6f6e   &&.      compon
+000cb4f0: 656e 7473 2e70 6174 686e 616d 655f 7374  ents.pathname_st
+000cb500: 6172 7420 3e20 636f 6d70 6f6e 656e 7473  art > components
+000cb510: 2e68 6f73 745f 656e 6429 207b 0a20 2020  .host_end) {.   
+000cb520: 2069 6620 2863 6f6d 706f 6e65 6e74 732e   if (components.
+000cb530: 7061 7468 6e61 6d65 5f73 7461 7274 203d  pathname_start =
+000cb540: 3d20 636f 6d70 6f6e 656e 7473 2e68 6f73  = components.hos
+000cb550: 745f 656e 6420 2b20 3220 2626 0a20 2020  t_end + 2 &&.   
+000cb560: 2020 2020 2062 7566 6665 725b 636f 6d70       buffer[comp
+000cb570: 6f6e 656e 7473 2e68 6f73 745f 656e 645d  onents.host_end]
+000cb580: 203d 3d20 272f 2720 2626 0a20 2020 2020   == '/' &&.     
+000cb590: 2020 2062 7566 6665 725b 636f 6d70 6f6e     buffer[compon
+000cb5a0: 656e 7473 2e68 6f73 745f 656e 6420 2b20  ents.host_end + 
+000cb5b0: 315d 203d 3d20 272e 2729 207b 0a20 2020  1] == '.') {.   
+000cb5c0: 2020 2069 6620 2863 6f6d 706f 6e65 6e74     if (component
+000cb5d0: 732e 7061 7468 6e61 6d65 5f73 7461 7274  s.pathname_start
+000cb5e0: 202b 2031 203e 3d20 6275 6666 6572 2e73   + 1 >= buffer.s
+000cb5f0: 697a 6528 2920 7c7c 0a20 2020 2020 2020  ize() ||.       
+000cb600: 2020 2062 7566 6665 725b 636f 6d70 6f6e     buffer[compon
+000cb610: 656e 7473 2e70 6174 686e 616d 655f 7374  ents.pathname_st
+000cb620: 6172 745d 2021 3d20 272f 2720 7c7c 0a20  art] != '/' ||. 
+000cb630: 2020 2020 2020 2020 2062 7566 6665 725b           buffer[
+000cb640: 636f 6d70 6f6e 656e 7473 2e70 6174 686e  components.pathn
+000cb650: 616d 655f 7374 6172 7420 2b20 315d 2021  ame_start + 1] !
+000cb660: 3d20 272f 2729 207b 0a20 2020 2020 2020  = '/') {.       
+000cb670: 2061 6461 5f6c 6f67 280a 2020 2020 2020   ada_log(.      
+000cb680: 2020 2020 2020 2275 726c 5f61 6767 7265        "url_aggre
+000cb690: 6761 746f 723a 3a76 616c 6964 6174 6520  gator::validate 
+000cb6a0: 6578 7065 6374 6564 2074 6865 2070 6174  expected the pat
+000cb6b0: 6820 746f 2062 6567 696e 2077 6974 6820  h to begin with 
+000cb6c0: 2f2f 205c 6e22 2c0a 2020 2020 2020 2020  // \n",.        
+000cb6d0: 2020 2020 746f 5f64 6961 6772 616d 2829      to_diagram()
+000cb6e0: 293b 0a20 2020 2020 2020 2072 6574 7572  );.        retur
+000cb6f0: 6e20 6661 6c73 653b 0a20 2020 2020 207d  n false;.      }
+000cb700: 0a20 2020 207d 2065 6c73 6520 6966 2028  .    } else if (
+000cb710: 6275 6666 6572 5b63 6f6d 706f 6e65 6e74  buffer[component
+000cb720: 732e 686f 7374 5f65 6e64 5d20 213d 2027  s.host_end] != '
+000cb730: 3a27 2920 7b0a 2020 2020 2020 6164 615f  :') {.      ada_
+000cb740: 6c6f 6728 2275 726c 5f61 6767 7265 6761  log("url_aggrega
+000cb750: 746f 723a 3a76 616c 6964 6174 6520 6d69  tor::validate mi
+000cb760: 7373 696e 6720 3a20 6174 2074 6865 2070  ssing : at the p
+000cb770: 6f72 7420 5c6e 222c 0a20 2020 2020 2020  ort \n",.       
+000cb780: 2020 2020 2020 2074 6f5f 6469 6167 7261         to_diagra
+000cb790: 6d28 2929 3b0a 2020 2020 2020 7265 7475  m());.      retu
+000cb7a0: 726e 2066 616c 7365 3b0a 2020 2020 7d0a  rn false;.    }.
+000cb7b0: 2020 7d0a 2020 6966 2028 636f 6d70 6f6e    }.  if (compon
+000cb7c0: 656e 7473 2e70 6174 686e 616d 655f 7374  ents.pathname_st
+000cb7d0: 6172 7420 213d 2062 7566 6665 722e 7369  art != buffer.si
+000cb7e0: 7a65 2829 2026 260a 2020 2020 2020 636f  ze() &&.      co
+000cb7f0: 6d70 6f6e 656e 7473 2e70 6174 686e 616d  mponents.pathnam
+000cb800: 655f 7374 6172 7420 3c20 636f 6d70 6f6e  e_start < compon
+000cb810: 656e 7473 2e73 6561 7263 685f 7374 6172  ents.search_star
+000cb820: 7420 2626 0a20 2020 2020 2063 6f6d 706f  t &&.      compo
+000cb830: 6e65 6e74 732e 7061 7468 6e61 6d65 5f73  nents.pathname_s
+000cb840: 7461 7274 203c 2063 6f6d 706f 6e65 6e74  tart < component
+000cb850: 732e 6861 7368 5f73 7461 7274 2026 2620  s.hash_start && 
+000cb860: 2168 6173 5f6f 7061 7175 655f 7061 7468  !has_opaque_path
+000cb870: 2920 7b0a 2020 2020 6966 2028 6275 6666  ) {.    if (buff
+000cb880: 6572 5b63 6f6d 706f 6e65 6e74 732e 7061  er[components.pa
+000cb890: 7468 6e61 6d65 5f73 7461 7274 5d20 213d  thname_start] !=
+000cb8a0: 2027 2f27 2920 7b0a 2020 2020 2020 6164   '/') {.      ad
+000cb8b0: 615f 6c6f 6728 2275 726c 5f61 6767 7265  a_log("url_aggre
+000cb8c0: 6761 746f 723a 3a76 616c 6964 6174 6520  gator::validate 
+000cb8d0: 6d69 7373 696e 6720 2f20 6174 2074 6865  missing / at the
+000cb8e0: 2070 6174 6820 5c6e 222c 0a20 2020 2020   path \n",.     
+000cb8f0: 2020 2020 2020 2020 2074 6f5f 6469 6167           to_diag
+000cb900: 7261 6d28 2929 3b0a 2020 2020 2020 7265  ram());.      re
+000cb910: 7475 726e 2066 616c 7365 3b0a 2020 2020  turn false;.    
+000cb920: 7d0a 2020 7d0a 2020 6966 2028 636f 6d70  }.  }.  if (comp
+000cb930: 6f6e 656e 7473 2e73 6561 7263 685f 7374  onents.search_st
+000cb940: 6172 7420 213d 2075 726c 5f63 6f6d 706f  art != url_compo
+000cb950: 6e65 6e74 733a 3a6f 6d69 7474 6564 2920  nents::omitted) 
+000cb960: 7b0a 2020 2020 6966 2028 6275 6666 6572  {.    if (buffer
+000cb970: 5b63 6f6d 706f 6e65 6e74 732e 7365 6172  [components.sear
+000cb980: 6368 5f73 7461 7274 5d20 213d 2027 3f27  ch_start] != '?'
+000cb990: 2920 7b0a 2020 2020 2020 6164 615f 6c6f  ) {.      ada_lo
+000cb9a0: 6728 2275 726c 5f61 6767 7265 6761 746f  g("url_aggregato
+000cb9b0: 723a 3a76 616c 6964 6174 6520 6d69 7373  r::validate miss
+000cb9c0: 696e 6720 3f20 6174 2074 6865 2073 6561  ing ? at the sea
+000cb9d0: 7263 6820 5c6e 222c 0a20 2020 2020 2020  rch \n",.       
+000cb9e0: 2020 2020 2020 2074 6f5f 6469 6167 7261         to_diagra
+000cb9f0: 6d28 2929 3b0a 2020 2020 2020 7265 7475  m());.      retu
+000cba00: 726e 2066 616c 7365 3b0a 2020 2020 7d0a  rn false;.    }.
+000cba10: 2020 7d0a 2020 6966 2028 636f 6d70 6f6e    }.  if (compon
+000cba20: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
+000cba30: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
+000cba40: 733a 3a6f 6d69 7474 6564 2920 7b0a 2020  s::omitted) {.  
+000cba50: 2020 6966 2028 6275 6666 6572 5b63 6f6d    if (buffer[com
+000cba60: 706f 6e65 6e74 732e 6861 7368 5f73 7461  ponents.hash_sta
+000cba70: 7274 5d20 213d 2027 2327 2920 7b0a 2020  rt] != '#') {.  
+000cba80: 2020 2020 6164 615f 6c6f 6728 2275 726c      ada_log("url
+000cba90: 5f61 6767 7265 6761 746f 723a 3a76 616c  _aggregator::val
+000cbaa0: 6964 6174 6520 6d69 7373 696e 6720 2320  idate missing # 
+000cbab0: 6174 2074 6865 2068 6173 6820 5c6e 222c  at the hash \n",
+000cbac0: 0a20 2020 2020 2020 2020 2020 2020 2074  .              t
+000cbad0: 6f5f 6469 6167 7261 6d28 2929 3b0a 2020  o_diagram());.  
+000cbae0: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+000cbaf0: 3b0a 2020 2020 7d0a 2020 7d0a 0a20 2072  ;.    }.  }..  r
+000cbb00: 6574 7572 6e20 7472 7565 3b0a 7d0a 0a76  eturn true;.}..v
+000cbb10: 6f69 6420 7572 6c5f 6167 6772 6567 6174  oid url_aggregat
+000cbb20: 6f72 3a3a 6465 6c65 7465 5f64 6173 685f  or::delete_dash_
+000cbb30: 646f 7428 2920 7b0a 2020 6164 615f 6c6f  dot() {.  ada_lo
+000cbb40: 6728 2275 726c 5f61 6767 7265 6761 746f  g("url_aggregato
+000cbb50: 723a 3a64 656c 6574 655f 6461 7368 5f64  r::delete_dash_d
+000cbb60: 6f74 2229 3b0a 2020 4144 415f 4153 5345  ot");.  ADA_ASSE
+000cbb70: 5254 5f54 5255 4528 7661 6c69 6461 7465  RT_TRUE(validate
+000cbb80: 2829 293b 0a20 2041 4441 5f41 5353 4552  ());.  ADA_ASSER
+000cbb90: 545f 5452 5545 2868 6173 5f64 6173 685f  T_TRUE(has_dash_
+000cbba0: 646f 7428 2929 3b0a 2020 6275 6666 6572  dot());.  buffer
+000cbbb0: 2e65 7261 7365 2863 6f6d 706f 6e65 6e74  .erase(component
+000cbbc0: 732e 686f 7374 5f65 6e64 2c20 3229 3b0a  s.host_end, 2);.
+000cbbd0: 2020 636f 6d70 6f6e 656e 7473 2e70 6174    components.pat
+000cbbe0: 686e 616d 655f 7374 6172 7420 2d3d 2032  hname_start -= 2
+000cbbf0: 3b0a 2020 6966 2028 636f 6d70 6f6e 656e  ;.  if (componen
+000cbc00: 7473 2e73 6561 7263 685f 7374 6172 7420  ts.search_start 
+000cbc10: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
+000cbc20: 733a 3a6f 6d69 7474 6564 2920 7b0a 2020  s::omitted) {.  
+000cbc30: 2020 636f 6d70 6f6e 656e 7473 2e73 6561    components.sea
+000cbc40: 7263 685f 7374 6172 7420 2d3d 2032 3b0a  rch_start -= 2;.
+000cbc50: 2020 7d0a 2020 6966 2028 636f 6d70 6f6e    }.  if (compon
+000cbc60: 656e 7473 2e68 6173 685f 7374 6172 7420  ents.hash_start 
+000cbc70: 213d 2075 726c 5f63 6f6d 706f 6e65 6e74  != url_component
+000cbc80: 733a 3a6f 6d69 7474 6564 2920 7b0a 2020  s::omitted) {.  
+000cbc90: 2020 636f 6d70 6f6e 656e 7473 2e68 6173    components.has
+000cbca0: 685f 7374 6172 7420 2d3d 2032 3b0a 2020  h_start -= 2;.  
+000cbcb0: 7d0a 2020 4144 415f 4153 5345 5254 5f54  }.  ADA_ASSERT_T
+000cbcc0: 5255 4528 7661 6c69 6461 7465 2829 293b  RUE(validate());
+000cbcd0: 0a20 2041 4441 5f41 5353 4552 545f 5452  .  ADA_ASSERT_TR
+000cbce0: 5545 2821 6861 735f 6461 7368 5f64 6f74  UE(!has_dash_dot
+000cbcf0: 2829 293b 0a7d 0a0a 696e 6c69 6e65 2076  ());.}..inline v
+000cbd00: 6f69 6420 7572 6c5f 6167 6772 6567 6174  oid url_aggregat
+000cbd10: 6f72 3a3a 636f 6e73 756d 655f 7072 6570  or::consume_prep
+000cbd20: 6172 6564 5f70 6174 6828 7374 643a 3a73  ared_path(std::s
+000cbd30: 7472 696e 675f 7669 6577 2069 6e70 7574  tring_view input
+000cbd40: 2920 7b0a 2020 6164 615f 6c6f 6728 2275  ) {.  ada_log("u
+000cbd50: 726c 5f61 6767 7265 6761 746f 723a 3a63  rl_aggregator::c
+000cbd60: 6f6e 7375 6d65 5f70 7265 7061 7265 645f  onsume_prepared_
+000cbd70: 7061 7468 2022 2c20 696e 7075 7429 3b0a  path ", input);.
+000cbd80: 2020 2f2a 2a2a 0a20 2020 2a20 5468 6973    /***.   * This
+000cbd90: 2069 7320 6c61 7267 656c 7920 6475 706c   is largely dupl
+000cbda0: 6963 6174 6564 2063 6f64 6520 6672 6f6d  icated code from
+000cbdb0: 2068 656c 7065 7273 3a3a 7061 7273 655f   helpers::parse_
+000cbdc0: 7072 6570 6172 6564 5f70 6174 682c 2077  prepared_path, w
+000cbdd0: 6869 6368 2069 730a 2020 202a 2075 6e66  hich is.   * unf
+000cbde0: 6f72 7475 6e61 7465 2e20 5468 6973 2070  ortunate. This p
+000cbdf0: 6172 7469 6375 6c61 7220 6675 6e63 7469  articular functi
+000cbe00: 6f6e 2069 7320 6e65 6172 6c79 2069 6465  on is nearly ide
+000cbe10: 6e74 6963 616c 2c20 6578 6365 7074 2074  ntical, except t
+000cbe20: 6861 7420 6974 0a20 2020 2a20 6973 2061  hat it.   * is a
+000cbe30: 206d 6574 686f 6420 6f6e 2075 726c 5f61   method on url_a
+000cbe40: 6767 7265 6761 746f 722e 2054 6865 2069  ggregator. The i
+000cbe50: 6465 6120 6973 2074 6861 7420 7468 6520  dea is that the 
+000cbe60: 7472 6976 6961 6c20 7061 7468 2028 7768  trivial path (wh
+000cbe70: 6963 6820 6973 0a20 2020 2a20 7665 7279  ich is.   * very
+000cbe80: 2063 6f6d 6d6f 6e29 206d 6572 656c 7920   common) merely 
+000cbe90: 6170 7065 6e64 7320 746f 2074 6865 2062  appends to the b
+000cbea0: 7566 6665 722e 2054 6869 7320 6973 2074  uffer. This is t
+000cbeb0: 6865 2073 616d 6520 7472 6976 6961 6c20  he same trivial 
+000cbec0: 7061 7468 2061 730a 2020 202a 2077 6974  path as.   * wit
+000cbed0: 6820 6865 6c70 6572 733a 3a70 6172 7365  h helpers::parse
+000cbee0: 5f70 7265 7061 7265 645f 7061 7468 2c20  _prepared_path, 
+000cbef0: 6578 6365 7074 2074 6861 7420 7765 2068  except that we h
+000cbf00: 6176 6520 7468 6520 6164 6469 7469 6f6e  ave the addition
+000cbf10: 616c 2063 6865 636b 0a20 2020 2a20 666f  al check.   * fo
+000cbf20: 7220 6973 5f61 745f 7061 7468 2829 2e20  r is_at_path(). 
+000cbf30: 4f74 6865 7277 6973 652c 2077 6520 6772  Otherwise, we gr
+000cbf40: 6162 2061 2063 6f70 7920 6f66 2074 6865  ab a copy of the
+000cbf50: 2063 7572 7265 6e74 2070 6174 6820 616e   current path an
+000cbf60: 6420 7765 0a20 2020 2a20 6d6f 6469 6679  d we.   * modify
+000cbf70: 2069 742c 2061 6e64 2074 6865 6e20 696e   it, and then in
+000cbf80: 7365 7274 2069 7420 6261 636b 2069 6e74  sert it back int
+000cbf90: 6f20 7468 6520 6275 6666 6572 2e0a 2020  o the buffer..  
+000cbfa0: 202a 2f0a 2020 7569 6e74 385f 7420 6163   */.  uint8_t ac
+000cbfb0: 6375 6d75 6c61 746f 7220 3d20 6368 6563  cumulator = chec
+000cbfc0: 6b65 7273 3a3a 7061 7468 5f73 6967 6e61  kers::path_signa
+000cbfd0: 7475 7265 2869 6e70 7574 293b 0a20 202f  ture(input);.  /
+000cbfe0: 2f20 4c65 7420 7573 2066 6972 7374 2064  / Let us first d
+000cbff0: 6574 6563 7420 6120 7472 6976 6961 6c20  etect a trivial 
+000cc000: 6361 7365 2e0a 2020 2f2f 2049 6620 6974  case..  // If it
+000cc010: 2069 7320 7370 6563 6961 6c2c 2077 6520   is special, we 
+000cc020: 6368 6563 6b20 7468 6174 2077 6520 6861  check that we ha
+000cc030: 7665 206e 6f20 646f 742c 206e 6f20 252c  ve no dot, no %,
+000cc040: 2020 6e6f 205c 2061 6e64 206e 6f0a 2020    no \ and no.  
+000cc050: 2f2f 2063 6861 7261 6374 6572 206e 6565  // character nee
+000cc060: 6469 6e67 2070 6572 6365 6e74 2065 6e63  ding percent enc
+000cc070: 6f64 696e 672e 204f 7468 6572 7769 7365  oding. Otherwise
+000cc080: 2c20 7765 2063 6865 636b 2074 6861 7420  , we check that 
+000cc090: 7765 2068 6176 6520 6e6f 2025 2c0a 2020  we have no %,.  
+000cc0a0: 2f2f 206e 6f20 646f 742c 2061 6e64 206e  // no dot, and n
+000cc0b0: 6f20 6368 6172 6163 7465 7220 6e65 6564  o character need
+000cc0c0: 696e 6720 7065 7263 656e 7420 656e 636f  ing percent enco
+000cc0d0: 6469 6e67 2e0a 2020 636f 6e73 7465 7870  ding..  constexp
+000cc0e0: 7220 7569 6e74 385f 7420 6e65 6564 5f65  r uint8_t need_e
+000cc0f0: 6e63 6f64 696e 6720 3d20 313b 0a20 2063  ncoding = 1;.  c
+000cc100: 6f6e 7374 6578 7072 2075 696e 7438 5f74  onstexpr uint8_t
+000cc110: 2062 6163 6b73 6c61 7368 5f63 6861 7220   backslash_char 
+000cc120: 3d20 323b 0a20 2063 6f6e 7374 6578 7072  = 2;.  constexpr
+000cc130: 2075 696e 7438 5f74 2064 6f74 5f63 6861   uint8_t dot_cha
+000cc140: 7220 3d20 343b 0a20 2063 6f6e 7374 6578  r = 4;.  constex
+000cc150: 7072 2075 696e 7438 5f74 2070 6572 6365  pr uint8_t perce
+000cc160: 6e74 5f63 6861 7220 3d20 383b 0a20 2062  nt_char = 8;.  b
+000cc170: 6f6f 6c20 7370 6563 6961 6c20 3d20 7479  ool special = ty
+000cc180: 7065 2021 3d20 6164 613a 3a73 6368 656d  pe != ada::schem
+000cc190: 653a 3a4e 4f54 5f53 5045 4349 414c 3b0a  e::NOT_SPECIAL;.
+000cc1a0: 2020 626f 6f6c 206d 6179 5f6e 6565 645f    bool may_need_
+000cc1b0: 736c 6f77 5f66 696c 655f 6861 6e64 6c69  slow_file_handli
+000cc1c0: 6e67 203d 2028 7479 7065 203d 3d20 6164  ng = (type == ad
+000cc1d0: 613a 3a73 6368 656d 653a 3a74 7970 653a  a::scheme::type:
+000cc1e0: 3a46 494c 4520 2626 0a20 2020 2020 2020  :FILE &&.       
+000cc1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000cc200: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000cc210: 6865 636b 6572 733a 3a69 735f 7769 6e64  heckers::is_wind
+000cc220: 6f77 735f 6472 6976 655f 6c65 7474 6572  ows_drive_letter
+000cc230: 2869 6e70 7574 2929 3b0a 2020 626f 6f6c  (input));.  bool
+000cc240: 2074 7269 7669 616c 5f70 6174 6820 3d0a   trivial_path =.
+000cc250: 2020 2020 2020 2873 7065 6369 616c 203f        (special ?
+000cc260: 2028 6163 6375 6d75 6c61 746f 7220 3d3d   (accumulator ==
+000cc270: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
+000cc280: 2020 203a 2028 2861 6363 756d 756c 6174     : ((accumulat
+000cc290: 6f72 2026 2028 6e65 6564 5f65 6e63 6f64  or & (need_encod
+000cc2a0: 696e 6720 7c20 646f 745f 6368 6172 207c  ing | dot_char |
+000cc2b0: 2070 6572 6365 6e74 5f63 6861 7229 2920   percent_char)) 
+000cc2c0: 3d3d 0a20 2020 2020 2020 2020 2020 2020  ==.             
+000cc2d0: 2020 2020 2030 2929 2026 260a 2020 2020       0)) &&.    
+000cc2e0: 2020 2821 6d61 795f 6e65 6564 5f73 6c6f    (!may_need_slo
+000cc2f0: 775f 6669 6c65 5f68 616e 646c 696e 6729  w_file_handling)
+000cc300: 3b0a 2020 6966 2028 6163 6375 6d75 6c61  ;.  if (accumula
+000cc310: 746f 7220 3d3d 2064 6f74 5f63 6861 7220  tor == dot_char 
+000cc320: 2626 2021 6d61 795f 6e65 6564 5f73 6c6f  && !may_need_slo
+000cc330: 775f 6669 6c65 5f68 616e 646c 696e 6729  w_file_handling)
+000cc340: 207b 0a20 2020 202f 2f20 2734 2720 6d65   {.    // '4' me
+000cc350: 616e 7320 7468 6174 2077 6520 6861 7665  ans that we have
+000cc360: 2061 7420 6c65 6173 7420 6f6e 6520 646f   at least one do
+000cc370: 742c 2062 7574 206e 6f74 6869 6e67 2074  t, but nothing t
+000cc380: 6861 7420 7265 7175 6972 6573 0a20 2020  hat requires.   
+000cc390: 202f 2f20 7065 7263 656e 7420 656e 636f   // percent enco
+000cc3a0: 6469 6e67 206f 7220 6465 636f 6469 6e67  ding or decoding
+000cc3b0: 2e20 5468 6520 6f6e 6c79 2070 6172 7420  . The only part 
+000cc3c0: 7468 6174 2069 7320 6e6f 7420 7472 6976  that is not triv
+000cc3d0: 6961 6c20 6973 0a20 2020 202f 2f20 7468  ial is.    // th
+000cc3e0: 6174 2077 6520 6d61 7920 6861 7665 2073  at we may have s
+000cc3f0: 696e 676c 6520 646f 7473 2061 6e64 2064  ingle dots and d
+000cc400: 6f75 626c 6520 646f 7473 2070 6174 6820  ouble dots path 
+000cc410: 7365 676d 656e 7473 2e0a 2020 2020 2f2f  segments..    //
+000cc420: 2049 6620 7765 2068 6176 6520 7375 6368   If we have such
+000cc430: 2073 6567 6d65 6e74 732c 2074 6865 6e20   segments, then 
+000cc440: 7765 2065 6974 6865 7220 6861 7665 2061  we either have a
+000cc450: 2070 6174 6820 7468 6174 2062 6567 696e   path that begin
+000cc460: 730a 2020 2020 2f2f 2077 6974 6820 272e  s.    // with '.
+000cc470: 2720 2865 6173 7920 746f 2063 6865 636b  ' (easy to check
+000cc480: 292c 206f 7220 7765 2068 6176 6520 7468  ), or we have th
+000cc490: 6520 7365 7175 656e 6365 2027 2e2f 272e  e sequence './'.
+000cc4a0: 0a20 2020 202f 2f20 4e6f 7465 3a20 696e  .    // Note: in
+000cc4b0: 7075 7420 6361 6e6e 6f74 2062 6520 656d  put cannot be em
+000cc4c0: 7074 792c 2069 7420 6d75 7374 2061 7420  pty, it must at 
+000cc4d0: 6c65 6173 7420 636f 6e74 6169 6e20 6f6e  least contain on
+000cc4e0: 6520 6368 6172 6163 7465 7220 2827 2e27  e character ('.'
+000cc4f0: 290a 2020 2020 2f2f 204e 6f74 653a 2077  ).    // Note: w
+000cc500: 6520 6b6e 6f77 2074 6861 7420 275c 2720  e know that '\' 
+000cc510: 6973 206e 6f74 2070 7265 7365 6e74 2e0a  is not present..
+000cc520: 2020 2020 6966 2028 696e 7075 745b 305d      if (input[0]
+000cc530: 2021 3d20 272e 2729 207b 0a20 2020 2020   != '.') {.     
+000cc540: 2073 697a 655f 7420 736c 6173 6864 6f74   size_t slashdot
+000cc550: 203d 2069 6e70 7574 2e66 696e 6428 222f   = input.find("/
+000cc560: 2e22 293b 0a20 2020 2020 2069 6620 2873  .");.      if (s
+000cc570: 6c61 7368 646f 7420 3d3d 2073 7464 3a3a  lashdot == std::
+000cc580: 7374 7269 6e67 5f76 6965 773a 3a6e 706f  string_view::npo
+000cc590: 7329 207b 2020 2f2f 2063 6f6d 6d6f 6e20  s) {  // common 
+000cc5a0: 6361 7365 0a20 2020 2020 2020 2074 7269  case.        tri
+000cc5b0: 7669 616c 5f70 6174 6820 3d20 7472 7565  vial_path = true
+000cc5c0: 3b0a 2020 2020 2020 7d20 656c 7365 207b  ;.      } else {
+000cc5d0: 2020 2f2f 2075 6e63 6f6d 6d6f 6e0a 2020    // uncommon.  
+000cc5e0: 2020 2020 2020 2f2f 206f 6e6c 7920 7468        // only th
+000cc5f0: 7265 6520 6361 7365 7320 6d61 7474 6572  ree cases matter
+000cc600: 3a20 2f2e 2f2c 202f 2e2e 206f 7220 6120  : /./, /.. or a 
+000cc610: 6669 6e61 6c20 2f0a 2020 2020 2020 2020  final /.        
+000cc620: 7472 6976 6961 6c5f 7061 7468 203d 0a20  trivial_path =. 
+000cc630: 2020 2020 2020 2020 2020 2021 2873 6c61             !(sla
+000cc640: 7368 646f 7420 2b20 3220 3d3d 2069 6e70  shdot + 2 == inp
+000cc650: 7574 2e73 697a 6528 2920 7c7c 2069 6e70  ut.size() || inp
+000cc660: 7574 5b73 6c61 7368 646f 7420 2b20 325d  ut[slashdot + 2]
+000cc670: 203d 3d20 272e 2720 7c7c 0a20 2020 2020   == '.' ||.     
+000cc680: 2020 2020 2020 2020 2069 6e70 7574 5b73           input[s
+000cc690: 6c61 7368 646f 7420 2b20 325d 203d 3d20  lashdot + 2] == 
+000cc6a0: 272f 2729 3b0a 2020 2020 2020 7d0a 2020  '/');.      }.  
+000cc6b0: 2020 7d0a 2020 7d0a 2020 6966 2028 7472    }.  }.  if (tr
+000cc6c0: 6976 6961 6c5f 7061 7468 2026 2620 6973  ivial_path && is
+000cc6d0: 5f61 745f 7061 7468 2829 2920 7b0a 2020  _at_path()) {.  
+000cc6e0: 2020 6164 615f 6c6f 6728 2270 6172 7365    ada_log("parse
+000cc6f0: 5f70 6174 6820 7472 6976 6961 6c22 293b  _path trivial");
+000cc700: 0a20 2020 2062 7566 6665 7220 2b3d 2027  .    buffer += '
+000cc710: 2f27 3b0a 2020 2020 6275 6666 6572 202b  /';.    buffer +
+000cc720: 3d20 696e 7075 743b 0a20 2020 2072 6574  = input;.    ret
+000cc730: 7572 6e3b 0a20 207d 0a20 2073 7464 3a3a  urn;.  }.  std::
+000cc740: 7374 7269 6e67 2070 6174 6820 3d20 7374  string path = st
+000cc750: 643a 3a73 7472 696e 6728 6765 745f 7061  d::string(get_pa
+000cc760: 7468 6e61 6d65 2829 293b 0a20 202f 2f20  thname());.  // 
+000cc770: 5765 2061 7265 2067 6f69 6e67 2074 6f20  We are going to 
+000cc780: 6e65 6564 2074 6f20 6c6f 6f6b 2061 2062  need to look a b
+000cc790: 6974 2061 7420 7468 6520 7061 7468 2c20  it at the path, 
+000cc7a0: 6275 7420 6c65 7420 7573 2073 6565 2069  but let us see i
+000cc7b0: 6620 7765 2063 616e 0a20 202f 2f20 6967  f we can.  // ig
+000cc7c0: 6e6f 7265 2070 6572 6365 6e74 2065 6e63  nore percent enc
+000cc7d0: 6f64 696e 6720 2a61 6e64 2a20 6261 636b  oding *and* back
+000cc7e0: 736c 6173 6865 7320 2a61 6e64 2a20 7065  slashes *and* pe
+000cc7f0: 7263 656e 7420 6368 6172 6163 7465 7273  rcent characters
+000cc800: 2e0a 2020 2f2f 2045 7863 6570 7420 666f  ..  // Except fo
+000cc810: 7220 7468 6520 7472 6976 6961 6c20 6361  r the trivial ca
+000cc820: 7365 2c20 7468 6973 2069 7320 6c69 6b65  se, this is like
+000cc830: 6c79 2074 6f20 6361 7074 7572 6520 3939  ly to capture 99
+000cc840: 2520 6f66 2070 6174 6873 206f 7574 0a20  % of paths out. 
+000cc850: 202f 2f20 7468 6572 652e 0a20 2062 6f6f   // there..  boo
+000cc860: 6c20 6661 7374 5f70 6174 6820 3d0a 2020  l fast_path =.  
+000cc870: 2020 2020 2873 7065 6369 616c 2026 260a      (special &&.
+000cc880: 2020 2020 2020 2028 6163 6375 6d75 6c61         (accumula
+000cc890: 746f 7220 2620 286e 6565 645f 656e 636f  tor & (need_enco
+000cc8a0: 6469 6e67 207c 2062 6163 6b73 6c61 7368  ding | backslash
+000cc8b0: 5f63 6861 7220 7c20 7065 7263 656e 745f  _char | percent_
+000cc8c0: 6368 6172 2929 203d 3d20 3029 2026 260a  char)) == 0) &&.
+000cc8d0: 2020 2020 2020 2874 7970 6520 213d 2061        (type != a
+000cc8e0: 6461 3a3a 7363 6865 6d65 3a3a 7479 7065  da::scheme::type
+000cc8f0: 3a3a 4649 4c45 293b 0a20 2069 6620 2866  ::FILE);.  if (f
+000cc900: 6173 745f 7061 7468 2920 7b0a 2020 2020  ast_path) {.    
+000cc910: 6164 615f 6c6f 6728 2270 6172 7365 5f70  ada_log("parse_p
+000cc920: 7265 7061 7265 645f 7061 7468 2066 6173  repared_path fas
+000cc930: 7422 293b 0a20 2020 202f 2f20 4865 7265  t");.    // Here
+000cc940: 2077 6520 646f 6e27 7420 6e65 6564 2074   we don't need t
+000cc950: 6f20 776f 7272 7920 6162 6f75 7420 5c20  o worry about \ 
+000cc960: 6f72 2070 6572 6365 6e74 2065 6e63 6f64  or percent encod
+000cc970: 696e 672e 0a20 2020 202f 2f20 5765 2061  ing..    // We a
+000cc980: 6c73 6f20 646f 206e 6f74 2068 6176 6520  lso do not have 
+000cc990: 6120 6669 6c65 2070 726f 746f 636f 6c2e  a file protocol.
+000cc9a0: 2057 6520 6d69 6768 7420 6861 7665 2064   We might have d
+000cc9b0: 6f74 732c 2068 6f77 6576 6572 2c0a 2020  ots, however,.  
+000cc9c0: 2020 2f2f 2062 7574 2064 6f74 7320 6d75    // but dots mu
+000cc9d0: 7374 2061 7320 6170 7065 6172 2061 7320  st as appear as 
+000cc9e0: 272e 272c 2061 6e64 2074 6865 7920 6361  '.', and they ca
+000cc9f0: 6e6e 6f74 2062 6520 656e 636f 6465 6420  nnot be encoded 
+000cca00: 6265 6361 7573 650a 2020 2020 2f2f 2074  because.    // t
+000cca10: 6865 2073 796d 626f 6c20 2725 2720 6973  he symbol '%' is
+000cca20: 206e 6f74 2070 7265 7365 6e74 2e0a 2020   not present..  
+000cca30: 2020 7369 7a65 5f74 2070 7265 7669 6f75    size_t previou
+000cca40: 735f 6c6f 6361 7469 6f6e 203d 2030 3b20  s_location = 0; 
+000cca50: 202f 2f20 5765 2073 7461 7274 2061 7420   // We start at 
+000cca60: 302e 0a20 2020 2064 6f20 7b0a 2020 2020  0..    do {.    
+000cca70: 2020 7369 7a65 5f74 206e 6577 5f6c 6f63    size_t new_loc
+000cca80: 6174 696f 6e20 3d20 696e 7075 742e 6669  ation = input.fi
+000cca90: 6e64 2827 2f27 2c20 7072 6576 696f 7573  nd('/', previous
+000ccaa0: 5f6c 6f63 6174 696f 6e29 3b0a 2020 2020  _location);.    
+000ccab0: 2020 2f2f 2073 7464 3a3a 7374 7269 6e67    // std::string
+000ccac0: 5f76 6965 7720 7061 7468 5f76 6965 7720  _view path_view 
+000ccad0: 3d20 696e 7075 743b 0a20 2020 2020 202f  = input;.      /
+000ccae0: 2f20 2057 6520 7072 6f63 6573 7320 7468  /  We process th
+000ccaf0: 6520 6c61 7374 2073 6567 6d65 6e74 2073  e last segment s
+000ccb00: 6570 6172 6174 656c 793a 0a20 2020 2020  eparately:.     
+000ccb10: 2069 6620 286e 6577 5f6c 6f63 6174 696f   if (new_locatio
+000ccb20: 6e20 3d3d 2073 7464 3a3a 7374 7269 6e67  n == std::string
+000ccb30: 5f76 6965 773a 3a6e 706f 7329 207b 0a20  _view::npos) {. 
+000ccb40: 2020 2020 2020 2073 7464 3a3a 7374 7269         std::stri
+000ccb50: 6e67 5f76 6965 7720 7061 7468 5f76 6965  ng_view path_vie
+000ccb60: 7720 3d20 696e 7075 742e 7375 6273 7472  w = input.substr
+000ccb70: 2870 7265 7669 6f75 735f 6c6f 6361 7469  (previous_locati
+000ccb80: 6f6e 293b 0a20 2020 2020 2020 2069 6620  on);.        if 
+000ccb90: 2870 6174 685f 7669 6577 203d 3d20 222e  (path_view == ".
+000ccba0: 2e22 2920 7b20 202f 2f20 5468 6520 7061  .") {  // The pa
+000ccbb0: 7468 2065 6e64 7320 7769 7468 202e 2e0a  th ends with ...
+000ccbc0: 2020 2020 2020 2020 2020 2f2f 2065 2e67            // e.g
+000ccbd0: 2e2c 2069 6620 796f 7520 7265 6365 6976  ., if you receiv
+000ccbe0: 6520 222e 2e22 2077 6974 6820 616e 2065  e ".." with an e
+000ccbf0: 6d70 7479 2070 6174 682c 2079 6f75 2067  mpty path, you g
+000ccc00: 6f20 746f 2022 2f22 2e0a 2020 2020 2020  o to "/"..      
+000ccc10: 2020 2020 6966 2028 7061 7468 2e65 6d70      if (path.emp
+000ccc20: 7479 2829 2920 7b0a 2020 2020 2020 2020  ty()) {.        
+000ccc30: 2020 2020 7061 7468 203d 2027 2f27 3b0a      path = '/';.
+000ccc40: 2020 2020 2020 2020 2020 2020 7570 6461              upda
+000ccc50: 7465 5f62 6173 655f 7061 7468 6e61 6d65  te_base_pathname
+000ccc60: 2870 6174 6829 3b0a 2020 2020 2020 2020  (path);.        
+000ccc70: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000ccc80: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000ccc90: 2020 2f2f 2046 6173 7420 6361 7365 2077    // Fast case w
+000ccca0: 6865 7265 2077 6520 6861 7665 206e 6f74  here we have not
+000cccb0: 6869 6e67 2074 6f20 646f 3a0a 2020 2020  hing to do:.    
+000cccc0: 2020 2020 2020 6966 2028 7061 7468 2e62        if (path.b
+000cccd0: 6163 6b28 2920 3d3d 2027 2f27 2920 7b0a  ack() == '/') {.
+000ccce0: 2020 2020 2020 2020 2020 2020 7570 6461              upda
+000cccf0: 7465 5f62 6173 655f 7061 7468 6e61 6d65  te_base_pathname
+000ccd00: 2870 6174 6829 3b0a 2020 2020 2020 2020  (path);.        
+000ccd10: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000ccd20: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000ccd30: 2020 2f2f 2049 6620 796f 7520 6861 7665    // If you have
+000ccd40: 2074 6865 2070 6174 6820 222f 6a6f 652f   the path "/joe/
+000ccd50: 6d79 6672 6965 6e64 222c 0a20 2020 2020  myfriend",.     
+000ccd60: 2020 2020 202f 2f20 7468 656e 2079 6f75       // then you
+000ccd70: 2064 656c 6574 6520 276d 7966 7269 656e   delete 'myfrien
+000ccd80: 6427 2e0a 2020 2020 2020 2020 2020 7061  d'..          pa
+000ccd90: 7468 2e72 6573 697a 6528 7061 7468 2e72  th.resize(path.r
+000ccda0: 6669 6e64 2827 2f27 2920 2b20 3129 3b0a  find('/') + 1);.
+000ccdb0: 2020 2020 2020 2020 2020 7570 6461 7465            update
+000ccdc0: 5f62 6173 655f 7061 7468 6e61 6d65 2870  _base_pathname(p
+000ccdd0: 6174 6829 3b0a 2020 2020 2020 2020 2020  ath);.          
+000ccde0: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
+000ccdf0: 7d0a 2020 2020 2020 2020 7061 7468 202b  }.        path +
+000cce00: 3d20 272f 273b 0a20 2020 2020 2020 2069  = '/';.        i
+000cce10: 6620 2870 6174 685f 7669 6577 2021 3d20  f (path_view != 
+000cce20: 222e 2229 207b 0a20 2020 2020 2020 2020  ".") {.         
+000cce30: 2070 6174 682e 6170 7065 6e64 2870 6174   path.append(pat
+000cce40: 685f 7669 6577 293b 0a20 2020 2020 2020  h_view);.       
+000cce50: 207d 0a20 2020 2020 2020 2075 7064 6174   }.        updat
+000cce60: 655f 6261 7365 5f70 6174 686e 616d 6528  e_base_pathname(
+000cce70: 7061 7468 293b 0a20 2020 2020 2020 2072  path);.        r
+000cce80: 6574 7572 6e3b 0a20 2020 2020 207d 2065  eturn;.      } e
+000cce90: 6c73 6520 7b0a 2020 2020 2020 2020 2f2f  lse {.        //
+000ccea0: 2054 6869 7320 6973 2061 206e 6f6e 2d66   This is a non-f
+000cceb0: 696e 616c 2073 6567 6d65 6e74 2e0a 2020  inal segment..  
+000ccec0: 2020 2020 2020 7374 643a 3a73 7472 696e        std::strin
+000cced0: 675f 7669 6577 2070 6174 685f 7669 6577  g_view path_view
+000ccee0: 203d 0a20 2020 2020 2020 2020 2020 2069   =.            i
+000ccef0: 6e70 7574 2e73 7562 7374 7228 7072 6576  nput.substr(prev
+000ccf00: 696f 7573 5f6c 6f63 6174 696f 6e2c 206e  ious_location, n
+000ccf10: 6577 5f6c 6f63 6174 696f 6e20 2d20 7072  ew_location - pr
+000ccf20: 6576 696f 7573 5f6c 6f63 6174 696f 6e29  evious_location)
+000ccf30: 3b0a 2020 2020 2020 2020 7072 6576 696f  ;.        previo
+000ccf40: 7573 5f6c 6f63 6174 696f 6e20 3d20 6e65  us_location = ne
+000ccf50: 775f 6c6f 6361 7469 6f6e 202b 2031 3b0a  w_location + 1;.
+000ccf60: 2020 2020 2020 2020 6966 2028 7061 7468          if (path
+000ccf70: 5f76 6965 7720 3d3d 2022 2e2e 2229 207b  _view == "..") {
+000ccf80: 0a20 2020 2020 2020 2020 2073 697a 655f  .          size_
+000ccf90: 7420 6c61 7374 5f64 656c 696d 6974 6572  t last_delimiter
+000ccfa0: 203d 2070 6174 682e 7266 696e 6428 272f   = path.rfind('/
+000ccfb0: 2729 3b0a 2020 2020 2020 2020 2020 6966  ');.          if
+000ccfc0: 2028 6c61 7374 5f64 656c 696d 6974 6572   (last_delimiter
+000ccfd0: 2021 3d20 7374 643a 3a73 7472 696e 673a   != std::string:
+000ccfe0: 3a6e 706f 7329 207b 0a20 2020 2020 2020  :npos) {.       
+000ccff0: 2020 2020 2070 6174 682e 6572 6173 6528       path.erase(
+000cd000: 6c61 7374 5f64 656c 696d 6974 6572 293b  last_delimiter);
+000cd010: 0a20 2020 2020 2020 2020 207d 0a20 2020  .          }.   
+000cd020: 2020 2020 207d 2065 6c73 6520 6966 2028       } else if (
+000cd030: 7061 7468 5f76 6965 7720 213d 2022 2e22  path_view != "."
+000cd040: 2920 7b0a 2020 2020 2020 2020 2020 7061  ) {.          pa
+000cd050: 7468 202b 3d20 272f 273b 0a20 2020 2020  th += '/';.     
+000cd060: 2020 2020 2070 6174 682e 6170 7065 6e64       path.append
+000cd070: 2870 6174 685f 7669 6577 293b 0a20 2020  (path_view);.   
+000cd080: 2020 2020 207d 0a20 2020 2020 207d 0a20       }.      }. 
+000cd090: 2020 207d 2077 6869 6c65 2028 7472 7565     } while (true
+000cd0a0: 293b 0a20 207d 2065 6c73 6520 7b0a 2020  );.  } else {.  
+000cd0b0: 2020 6164 615f 6c6f 6728 2270 6172 7365    ada_log("parse
+000cd0c0: 5f70 6174 6820 736c 6f77 2229 3b0a 2020  _path slow");.  
+000cd0d0: 2020 2f2f 2077 6520 6861 7665 2072 6561    // we have rea
+000cd0e0: 6368 6564 2074 6865 2067 656e 6572 616c  ched the general
+000cd0f0: 2063 6173 650a 2020 2020 626f 6f6c 206e   case.    bool n
+000cd100: 6565 6473 5f70 6572 6365 6e74 5f65 6e63  eeds_percent_enc
+000cd110: 6f64 696e 6720 3d20 2861 6363 756d 756c  oding = (accumul
+000cd120: 6174 6f72 2026 2031 293b 0a20 2020 2073  ator & 1);.    s
+000cd130: 7464 3a3a 7374 7269 6e67 2070 6174 685f  td::string path_
+000cd140: 6275 6666 6572 5f74 6d70 3b0a 2020 2020  buffer_tmp;.    
+000cd150: 646f 207b 0a20 2020 2020 2073 697a 655f  do {.      size_
+000cd160: 7420 6c6f 6361 7469 6f6e 203d 2028 7370  t location = (sp
+000cd170: 6563 6961 6c20 2626 2028 6163 6375 6d75  ecial && (accumu
+000cd180: 6c61 746f 7220 2620 3229 290a 2020 2020  lator & 2)).    
+000cd190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000cd1a0: 2020 2020 2020 2020 3f20 696e 7075 742e          ? input.
+000cd1b0: 6669 6e64 5f66 6972 7374 5f6f 6628 222f  find_first_of("/
+000cd1c0: 5c5c 2229 0a20 2020 2020 2020 2020 2020  \\").           
+000cd1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000cd1e0: 203a 2069 6e70 7574 2e66 696e 6428 272f   : input.find('/
+000cd1f0: 2729 3b0a 2020 2020 2020 7374 643a 3a73  ');.      std::s
+000cd200: 7472 696e 675f 7669 6577 2070 6174 685f  tring_view path_
+000cd210: 7669 6577 203d 2069 6e70 7574 3b0a 2020  view = input;.  
+000cd220: 2020 2020 6966 2028 6c6f 6361 7469 6f6e      if (location
+000cd230: 2021 3d20 7374 643a 3a73 7472 696e 675f   != std::string_
+000cd240: 7669 6577 3a3a 6e70 6f73 2920 7b0a 2020  view::npos) {.  
+000cd250: 2020 2020 2020 7061 7468 5f76 6965 772e        path_view.
+000cd260: 7265 6d6f 7665 5f73 7566 6669 7828 7061  remove_suffix(pa
+000cd270: 7468 5f76 6965 772e 7369 7a65 2829 202d  th_view.size() -
+000cd280: 206c 6f63 6174 696f 6e29 3b0a 2020 2020   location);.    
+000cd290: 2020 2020 696e 7075 742e 7265 6d6f 7665      input.remove
+000cd2a0: 5f70 7265 6669 7828 6c6f 6361 7469 6f6e  _prefix(location
+000cd2b0: 202b 2031 293b 0a20 2020 2020 207d 0a20   + 1);.      }. 
+000cd2c0: 2020 2020 202f 2f20 7061 7468 5f62 7566       // path_buf
+000cd2d0: 6665 7220 6973 2065 6974 6865 7220 7061  fer is either pa
+000cd2e0: 7468 5f76 6965 7720 6f72 2069 7420 6d69  th_view or it mi
+000cd2f0: 6768 7420 706f 696e 7420 6174 2061 2070  ght point at a p
+000cd300: 6572 6365 6e74 2065 6e63 6f64 6564 0a20  ercent encoded. 
+000cd310: 2020 2020 202f 2f20 7465 6d70 6f72 6172       // temporar
+000cd320: 7920 7374 7269 6e67 2e0a 2020 2020 2020  y string..      
+000cd330: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000cd340: 2070 6174 685f 6275 6666 6572 203d 0a20   path_buffer =. 
+000cd350: 2020 2020 2020 2020 2028 6e65 6564 735f           (needs_
+000cd360: 7065 7263 656e 745f 656e 636f 6469 6e67  percent_encoding
+000cd370: 2026 260a 2020 2020 2020 2020 2020 2061   &&.           a
+000cd380: 6461 3a3a 756e 6963 6f64 653a 3a70 6572  da::unicode::per
+000cd390: 6365 6e74 5f65 6e63 6f64 653c 6661 6c73  cent_encode<fals
+000cd3a0: 653e 280a 2020 2020 2020 2020 2020 2020  e>(.            
+000cd3b0: 2020 2070 6174 685f 7669 6577 2c20 6368     path_view, ch
+000cd3c0: 6172 6163 7465 725f 7365 7473 3a3a 5041  aracter_sets::PA
+000cd3d0: 5448 5f50 4552 4345 4e54 5f45 4e43 4f44  TH_PERCENT_ENCOD
+000cd3e0: 452c 2070 6174 685f 6275 6666 6572 5f74  E, path_buffer_t
+000cd3f0: 6d70 2929 0a20 2020 2020 2020 2020 2020  mp)).           
+000cd400: 2020 203f 2070 6174 685f 6275 6666 6572     ? path_buffer
+000cd410: 5f74 6d70 0a20 2020 2020 2020 2020 2020  _tmp.           
+000cd420: 2020 203a 2070 6174 685f 7669 6577 3b0a     : path_view;.
+000cd430: 2020 2020 2020 6966 2028 756e 6963 6f64        if (unicod
+000cd440: 653a 3a69 735f 646f 7562 6c65 5f64 6f74  e::is_double_dot
+000cd450: 5f70 6174 685f 7365 676d 656e 7428 7061  _path_segment(pa
+000cd460: 7468 5f62 7566 6665 7229 2920 7b0a 2020  th_buffer)) {.  
+000cd470: 2020 2020 2020 6966 2028 2868 656c 7065        if ((helpe
+000cd480: 7273 3a3a 7368 6f72 7465 6e5f 7061 7468  rs::shorten_path
+000cd490: 2870 6174 682c 2074 7970 6529 207c 7c20  (path, type) || 
+000cd4a0: 7370 6563 6961 6c29 2026 260a 2020 2020  special) &&.    
+000cd4b0: 2020 2020 2020 2020 6c6f 6361 7469 6f6e          location
+000cd4c0: 203d 3d20 7374 643a 3a73 7472 696e 675f   == std::string_
+000cd4d0: 7669 6577 3a3a 6e70 6f73 2920 7b0a 2020  view::npos) {.  
+000cd4e0: 2020 2020 2020 2020 7061 7468 202b 3d20          path += 
+000cd4f0: 272f 273b 0a20 2020 2020 2020 207d 0a20  '/';.        }. 
+000cd500: 2020 2020 207d 2065 6c73 6520 6966 2028       } else if (
+000cd510: 756e 6963 6f64 653a 3a69 735f 7369 6e67  unicode::is_sing
+000cd520: 6c65 5f64 6f74 5f70 6174 685f 7365 676d  le_dot_path_segm
+000cd530: 656e 7428 7061 7468 5f62 7566 6665 7229  ent(path_buffer)
+000cd540: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
+000cd550: 2020 2020 2028 6c6f 6361 7469 6f6e 203d       (location =
+000cd560: 3d20 7374 643a 3a73 7472 696e 675f 7669  = std::string_vi
+000cd570: 6577 3a3a 6e70 6f73 2929 207b 0a20 2020  ew::npos)) {.   
+000cd580: 2020 2020 2070 6174 6820 2b3d 2027 2f27       path += '/'
+000cd590: 3b0a 2020 2020 2020 7d0a 2020 2020 2020  ;.      }.      
+000cd5a0: 2f2f 204f 7468 6572 7769 7365 2c20 6966  // Otherwise, if
+000cd5b0: 2070 6174 685f 6275 6666 6572 2069 7320   path_buffer is 
+000cd5c0: 6e6f 7420 6120 7369 6e67 6c65 2d64 6f74  not a single-dot
+000cd5d0: 2070 6174 6820 7365 676d 656e 742c 2074   path segment, t
+000cd5e0: 6865 6e3a 0a20 2020 2020 2065 6c73 6520  hen:.      else 
+000cd5f0: 6966 2028 2175 6e69 636f 6465 3a3a 6973  if (!unicode::is
+000cd600: 5f73 696e 676c 655f 646f 745f 7061 7468  _single_dot_path
+000cd610: 5f73 6567 6d65 6e74 2870 6174 685f 6275  _segment(path_bu
+000cd620: 6666 6572 2929 207b 0a20 2020 2020 2020  ffer)) {.       
+000cd630: 202f 2f20 4966 2075 726c e280 9973 2073   // If url...s s
+000cd640: 6368 656d 6520 6973 2022 6669 6c65 222c  cheme is "file",
+000cd650: 2075 726c e280 9973 2070 6174 6820 6973   url...s path is
+000cd660: 2065 6d70 7479 2c20 616e 6420 7061 7468   empty, and path
+000cd670: 5f62 7566 6665 7220 6973 2061 0a20 2020  _buffer is a.   
+000cd680: 2020 2020 202f 2f20 5769 6e64 6f77 7320       // Windows 
+000cd690: 6472 6976 6520 6c65 7474 6572 2c20 7468  drive letter, th
+000cd6a0: 656e 2072 6570 6c61 6365 2074 6865 2073  en replace the s
+000cd6b0: 6563 6f6e 6420 636f 6465 2070 6f69 6e74  econd code point
+000cd6c0: 2069 6e0a 2020 2020 2020 2020 2f2f 2070   in.        // p
+000cd6d0: 6174 685f 6275 6666 6572 2077 6974 6820  ath_buffer with 
+000cd6e0: 552b 3030 3341 2028 3a29 2e0a 2020 2020  U+003A (:)..    
+000cd6f0: 2020 2020 6966 2028 7479 7065 203d 3d20      if (type == 
+000cd700: 6164 613a 3a73 6368 656d 653a 3a74 7970  ada::scheme::typ
+000cd710: 653a 3a46 494c 4520 2626 2070 6174 682e  e::FILE && path.
+000cd720: 656d 7074 7928 2920 2626 0a20 2020 2020  empty() &&.     
+000cd730: 2020 2020 2020 2063 6865 636b 6572 733a         checkers:
+000cd740: 3a69 735f 7769 6e64 6f77 735f 6472 6976  :is_windows_driv
+000cd750: 655f 6c65 7474 6572 2870 6174 685f 6275  e_letter(path_bu
+000cd760: 6666 6572 2929 207b 0a20 2020 2020 2020  ffer)) {.       
+000cd770: 2020 2070 6174 6820 2b3d 2027 2f27 3b0a     path += '/';.
+000cd780: 2020 2020 2020 2020 2020 7061 7468 202b            path +
+000cd790: 3d20 7061 7468 5f62 7566 6665 725b 305d  = path_buffer[0]
+000cd7a0: 3b0a 2020 2020 2020 2020 2020 7061 7468  ;.          path
+000cd7b0: 202b 3d20 273a 273b 0a20 2020 2020 2020   += ':';.       
+000cd7c0: 2020 2070 6174 685f 6275 6666 6572 2e72     path_buffer.r
+000cd7d0: 656d 6f76 655f 7072 6566 6978 2832 293b  emove_prefix(2);
+000cd7e0: 0a20 2020 2020 2020 2020 2070 6174 682e  .          path.
+000cd7f0: 6170 7065 6e64 2870 6174 685f 6275 6666  append(path_buff
+000cd800: 6572 293b 0a20 2020 2020 2020 207d 2065  er);.        } e
+000cd810: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+000cd820: 2f2f 2041 7070 656e 6420 7061 7468 5f62  // Append path_b
+000cd830: 7566 6665 7220 746f 2075 726c e280 9973  uffer to url...s
+000cd840: 2070 6174 682e 0a20 2020 2020 2020 2020   path..         
+000cd850: 2070 6174 6820 2b3d 2027 2f27 3b0a 2020   path += '/';.  
+000cd860: 2020 2020 2020 2020 7061 7468 2e61 7070          path.app
+000cd870: 656e 6428 7061 7468 5f62 7566 6665 7229  end(path_buffer)
+000cd880: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+000cd890: 2020 7d0a 2020 2020 2020 6966 2028 6c6f    }.      if (lo
+000cd8a0: 6361 7469 6f6e 203d 3d20 7374 643a 3a73  cation == std::s
+000cd8b0: 7472 696e 675f 7669 6577 3a3a 6e70 6f73  tring_view::npos
+000cd8c0: 2920 7b0a 2020 2020 2020 2020 7570 6461  ) {.        upda
+000cd8d0: 7465 5f62 6173 655f 7061 7468 6e61 6d65  te_base_pathname
+000cd8e0: 2870 6174 6829 3b0a 2020 2020 2020 2020  (path);.        
+000cd8f0: 7265 7475 726e 3b0a 2020 2020 2020 7d0a  return;.      }.
+000cd900: 2020 2020 7d20 7768 696c 6520 2874 7275      } while (tru
+000cd910: 6529 3b0a 2020 7d0a 7d0a 7d20 202f 2f20  e);.  }.}.}  // 
+000cd920: 6e61 6d65 7370 6163 6520 6164 610a 2f2a  namespace ada./*
+000cd930: 2065 6e64 2066 696c 6520 7372 632f 7572   end file src/ur
+000cd940: 6c5f 6167 6772 6567 6174 6f72 2e63 7070  l_aggregator.cpp
+000cd950: 202a 2f0a 2f2a 2062 6567 696e 2066 696c   */./* begin fil
+000cd960: 6520 7372 632f 6164 615f 632e 6370 7020  e src/ada_c.cpp 
+000cd970: 2a2f 0a0a 6164 613a 3a72 6573 756c 743c  */..ada::result<
+000cd980: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
+000cd990: 746f 723e 2620 6765 745f 696e 7374 616e  tor>& get_instan
+000cd9a0: 6365 2876 6f69 642a 2072 6573 756c 7429  ce(void* result)
+000cd9b0: 206e 6f65 7863 6570 7420 7b0a 2020 7265   noexcept {.  re
+000cd9c0: 7475 726e 202a 2861 6461 3a3a 7265 7375  turn *(ada::resu
+000cd9d0: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
+000cd9e0: 6567 6174 6f72 3e2a 2972 6573 756c 743b  egator>*)result;
+000cd9f0: 0a7d 0a0a 6578 7465 726e 2022 4322 207b  .}..extern "C" {
+000cda00: 0a74 7970 6564 6566 2076 6f69 642a 2061  .typedef void* a
+000cda10: 6461 5f75 726c 3b0a 0a73 7472 7563 7420  da_url;..struct 
+000cda20: 6164 615f 7374 7269 6e67 207b 0a20 2063  ada_string {.  c
+000cda30: 6f6e 7374 2063 6861 722a 2064 6174 613b  onst char* data;
+000cda40: 0a20 2073 697a 655f 7420 6c65 6e67 7468  .  size_t length
+000cda50: 3b0a 7d3b 0a0a 7374 7275 6374 2061 6461  ;.};..struct ada
+000cda60: 5f6f 776e 6564 5f73 7472 696e 6720 7b0a  _owned_string {.
+000cda70: 2020 636f 6e73 7420 6368 6172 2a20 6461    const char* da
+000cda80: 7461 3b0a 2020 7369 7a65 5f74 206c 656e  ta;.  size_t len
+000cda90: 6774 683b 0a7d 3b0a 0a61 6461 5f73 7472  gth;.};..ada_str
+000cdaa0: 696e 6720 6164 615f 7374 7269 6e67 5f63  ing ada_string_c
+000cdab0: 7265 6174 6528 636f 6e73 7420 6368 6172  reate(const char
+000cdac0: 2a20 6461 7461 2c20 7369 7a65 5f74 206c  * data, size_t l
+000cdad0: 656e 6774 6829 207b 0a20 2061 6461 5f73  ength) {.  ada_s
+000cdae0: 7472 696e 6720 6f75 747b 7d3b 0a20 206f  tring out{};.  o
+000cdaf0: 7574 2e64 6174 6120 3d20 6461 7461 3b0a  ut.data = data;.
+000cdb00: 2020 6f75 742e 6c65 6e67 7468 203d 206c    out.length = l
+000cdb10: 656e 6774 683b 0a20 2072 6574 7572 6e20  ength;.  return 
+000cdb20: 6f75 743b 0a7d 0a0a 7374 7275 6374 2061  out;.}..struct a
+000cdb30: 6461 5f75 726c 5f63 6f6d 706f 6e65 6e74  da_url_component
+000cdb40: 7320 7b0a 2020 2f2a 0a20 2020 2a20 4279  s {.  /*.   * By
+000cdb50: 2075 7369 6e67 2033 322d 6269 7420 696e   using 32-bit in
+000cdb60: 7465 6765 7273 2c20 7765 2069 6d70 6c69  tegers, we impli
+000cdb70: 6369 746c 7920 6173 7375 6d65 2074 6861  citly assume tha
+000cdb80: 7420 7468 6520 5552 4c20 7374 7269 6e67  t the URL string
+000cdb90: 0a20 2020 2a20 6361 6e6e 6f74 2065 7863  .   * cannot exc
+000cdba0: 6565 6420 3420 4742 2e0a 2020 202a 0a20  eed 4 GB..   *. 
+000cdbb0: 2020 2a20 6874 7470 733a 2f2f 7573 6572    * https://user
+000cdbc0: 3a70 6173 7340 6578 616d 706c 652e 636f  :pass@example.co
+000cdbd0: 6d3a 3132 3334 2f66 6f6f 2f62 6172 3f62  m:1234/foo/bar?b
+000cdbe0: 617a 2371 7575 780a 2020 202a 2020 2020  az#quux.   *    
+000cdbf0: 2020 207c 2020 2020 207c 2020 2020 7c20     |     |    | 
+000cdc00: 2020 2020 2020 2020 207c 205e 5e5e 5e7c           | ^^^^|
+000cdc10: 2020 2020 2020 207c 2020 207c 0a20 2020         |   |.   
+000cdc20: 2a20 2020 2020 2020 7c20 2020 2020 7c20  *       |     | 
+000cdc30: 2020 207c 2020 2020 2020 2020 2020 7c20     |          | 
+000cdc40: 7c20 2020 7c20 2020 2020 2020 7c20 2020  |   |       |   
+000cdc50: 602d 2d2d 2d2d 2068 6173 685f 7374 6172  `----- hash_star
+000cdc60: 740a 2020 202a 2020 2020 2020 207c 2020  t.   *       |  
+000cdc70: 2020 207c 2020 2020 7c20 2020 2020 2020     |    |       
+000cdc80: 2020 207c 207c 2020 207c 2020 2020 2020     | |   |      
+000cdc90: 2060 2d2d 2d2d 2d2d 2d2d 2d20 7365 6172   `--------- sear
+000cdca0: 6368 5f73 7461 7274 0a20 2020 2a20 2020  ch_start.   *   
+000cdcb0: 2020 2020 7c20 2020 2020 7c20 2020 207c      |     |    |
+000cdcc0: 2020 2020 2020 2020 2020 7c20 7c20 2020            | |   
+000cdcd0: 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  `---------------
+000cdce0: 2d2d 2070 6174 686e 616d 655f 7374 6172  -- pathname_star
+000cdcf0: 740a 2020 202a 2020 2020 2020 207c 2020  t.   *       |  
+000cdd00: 2020 207c 2020 2020 7c20 2020 2020 2020     |    |       
+000cdd10: 2020 207c 2060 2d2d 2d2d 2d2d 2d2d 2d2d     | `----------
+000cdd20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 706f 7274  ----------- port
+000cdd30: 0a20 2020 2a20 2020 2020 2020 7c20 2020  .   *       |   
+000cdd40: 2020 7c20 2020 207c 2020 2020 2020 2020    |    |        
+000cdd50: 2020 602d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    `-------------
+000cdd60: 2d2d 2d2d 2d2d 2d2d 2d2d 2068 6f73 745f  ---------- host_
+000cdd70: 656e 640a 2020 202a 2020 2020 2020 207c  end.   *       |
+000cdd80: 2020 2020 207c 2020 2020 602d 2d2d 2d2d       |    `-----
+000cdd90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000cdda0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 686f  ------------- ho
+000cddb0: 7374 5f73 7461 7274 0a20 2020 2a20 2020  st_start.   *   
+000cddc0: 2020 2020 7c20 2020 2020 602d 2d2d 2d2d      |     `-----
+000cddd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000cdde0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000cddf0: 2d2d 2075 7365 726e 616d 655f 656e 640a  -- username_end.
+000cde00: 2020 202a 2020 2020 2020 2060 2d2d 2d2d     *       `----
+000cde10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000cde20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000cde30: 2d2d 2d2d 2d2d 2d2d 2d20 7072 6f74 6f63  --------- protoc
+000cde40: 6f6c 5f65 6e64 0a20 2020 2a2f 0a20 2075  ol_end.   */.  u
+000cde50: 696e 7433 325f 7420 7072 6f74 6f63 6f6c  int32_t protocol
+000cde60: 5f65 6e64 3b0a 2020 2f2a 2a0a 2020 202a  _end;.  /**.   *
+000cde70: 2055 7365 726e 616d 6520 656e 6420 6973   Username end is
+000cde80: 206e 6f74 2060 6f6d 6974 7465 6460 2062   not `omitted` b
+000cde90: 7920 6465 6661 756c 7420 282d 3129 2074  y default (-1) t
+000cdea0: 6f20 6d61 6b65 2075 7365 726e 616d 6520  o make username 
+000cdeb0: 616e 6420 7061 7373 776f 7264 0a20 2020  and password.   
+000cdec0: 2a20 6765 7474 6572 7320 6c65 7373 2063  * getters less c
+000cded0: 6f73 746c 7920 746f 2069 6d70 6c65 6d65  ostly to impleme
+000cdee0: 6e74 2e0a 2020 202a 2f0a 2020 7569 6e74  nt..   */.  uint
+000cdef0: 3332 5f74 2075 7365 726e 616d 655f 656e  32_t username_en
+000cdf00: 643b 0a20 2075 696e 7433 325f 7420 686f  d;.  uint32_t ho
+000cdf10: 7374 5f73 7461 7274 3b0a 2020 7569 6e74  st_start;.  uint
+000cdf20: 3332 5f74 2068 6f73 745f 656e 643b 0a20  32_t host_end;. 
+000cdf30: 2075 696e 7433 325f 7420 706f 7274 3b0a   uint32_t port;.
+000cdf40: 2020 7569 6e74 3332 5f74 2070 6174 686e    uint32_t pathn
+000cdf50: 616d 655f 7374 6172 743b 0a20 2075 696e  ame_start;.  uin
+000cdf60: 7433 325f 7420 7365 6172 6368 5f73 7461  t32_t search_sta
+000cdf70: 7274 3b0a 2020 7569 6e74 3332 5f74 2068  rt;.  uint32_t h
+000cdf80: 6173 685f 7374 6172 743b 0a7d 3b0a 0a61  ash_start;.};..a
+000cdf90: 6461 5f75 726c 2061 6461 5f70 6172 7365  da_url ada_parse
+000cdfa0: 2863 6f6e 7374 2063 6861 722a 2069 6e70  (const char* inp
+000cdfb0: 7574 2c20 7369 7a65 5f74 206c 656e 6774  ut, size_t lengt
+000cdfc0: 6829 206e 6f65 7863 6570 7420 7b0a 2020  h) noexcept {.  
+000cdfd0: 7265 7475 726e 206e 6577 2061 6461 3a3a  return new ada::
+000cdfe0: 7265 7375 6c74 3c61 6461 3a3a 7572 6c5f  result<ada::url_
+000cdff0: 6167 6772 6567 6174 6f72 3e28 0a20 2020  aggregator>(.   
+000ce000: 2020 2061 6461 3a3a 7061 7273 653c 6164     ada::parse<ad
+000ce010: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
+000ce020: 723e 2873 7464 3a3a 7374 7269 6e67 5f76  r>(std::string_v
+000ce030: 6965 7728 696e 7075 742c 206c 656e 6774  iew(input, lengt
+000ce040: 6829 2929 3b0a 7d0a 0a61 6461 5f75 726c  h)));.}..ada_url
+000ce050: 2061 6461 5f70 6172 7365 5f77 6974 685f   ada_parse_with_
+000ce060: 6261 7365 2863 6f6e 7374 2063 6861 722a  base(const char*
+000ce070: 2069 6e70 7574 2c20 7369 7a65 5f74 2069   input, size_t i
+000ce080: 6e70 7574 5f6c 656e 6774 682c 0a20 2020  nput_length,.   
+000ce090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000ce0a0: 2020 2020 2020 2020 2063 6f6e 7374 2063           const c
+000ce0b0: 6861 722a 2062 6173 652c 2073 697a 655f  har* base, size_
+000ce0c0: 7420 6261 7365 5f6c 656e 6774 6829 206e  t base_length) n
+000ce0d0: 6f65 7863 6570 7420 7b0a 2020 6175 746f  oexcept {.  auto
+000ce0e0: 2062 6173 655f 6f75 7420 3d0a 2020 2020   base_out =.    
+000ce0f0: 2020 6164 613a 3a70 6172 7365 3c61 6461    ada::parse<ada
+000ce100: 3a3a 7572 6c5f 6167 6772 6567 6174 6f72  ::url_aggregator
+000ce110: 3e28 7374 643a 3a73 7472 696e 675f 7669  >(std::string_vi
+000ce120: 6577 2862 6173 652c 2062 6173 655f 6c65  ew(base, base_le
+000ce130: 6e67 7468 2929 3b0a 0a20 2069 6620 2821  ngth));..  if (!
+000ce140: 6261 7365 5f6f 7574 2920 7b0a 2020 2020  base_out) {.    
+000ce150: 7265 7475 726e 206e 6577 2061 6461 3a3a  return new ada::
+000ce160: 7265 7375 6c74 3c61 6461 3a3a 7572 6c5f  result<ada::url_
+000ce170: 6167 6772 6567 6174 6f72 3e28 6261 7365  aggregator>(base
+000ce180: 5f6f 7574 293b 0a20 207d 0a0a 2020 7265  _out);.  }..  re
+000ce190: 7475 726e 206e 6577 2061 6461 3a3a 7265  turn new ada::re
+000ce1a0: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
+000ce1b0: 6772 6567 6174 6f72 3e28 6164 613a 3a70  gregator>(ada::p
+000ce1c0: 6172 7365 3c61 6461 3a3a 7572 6c5f 6167  arse<ada::url_ag
+000ce1d0: 6772 6567 6174 6f72 3e28 0a20 2020 2020  gregator>(.     
+000ce1e0: 2073 7464 3a3a 7374 7269 6e67 5f76 6965   std::string_vie
+000ce1f0: 7728 696e 7075 742c 2069 6e70 7574 5f6c  w(input, input_l
+000ce200: 656e 6774 6829 2c20 2662 6173 655f 6f75  ength), &base_ou
+000ce210: 742e 7661 6c75 6528 2929 293b 0a7d 0a0a  t.value()));.}..
+000ce220: 626f 6f6c 2061 6461 5f63 616e 5f70 6172  bool ada_can_par
+000ce230: 7365 2863 6f6e 7374 2063 6861 722a 2069  se(const char* i
+000ce240: 6e70 7574 2c20 7369 7a65 5f74 206c 656e  nput, size_t len
+000ce250: 6774 6829 206e 6f65 7863 6570 7420 7b0a  gth) noexcept {.
+000ce260: 2020 7265 7475 726e 2061 6461 3a3a 6361    return ada::ca
+000ce270: 6e5f 7061 7273 6528 7374 643a 3a73 7472  n_parse(std::str
+000ce280: 696e 675f 7669 6577 2869 6e70 7574 2c20  ing_view(input, 
+000ce290: 6c65 6e67 7468 2929 3b0a 7d0a 0a62 6f6f  length));.}..boo
+000ce2a0: 6c20 6164 615f 6361 6e5f 7061 7273 655f  l ada_can_parse_
+000ce2b0: 7769 7468 5f62 6173 6528 636f 6e73 7420  with_base(const 
+000ce2c0: 6368 6172 2a20 696e 7075 742c 2073 697a  char* input, siz
+000ce2d0: 655f 7420 696e 7075 745f 6c65 6e67 7468  e_t input_length
+000ce2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000ce2f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000ce300: 6f6e 7374 2063 6861 722a 2062 6173 652c  onst char* base,
+000ce310: 2073 697a 655f 7420 6261 7365 5f6c 656e   size_t base_len
+000ce320: 6774 6829 206e 6f65 7863 6570 7420 7b0a  gth) noexcept {.
+000ce330: 2020 6175 746f 2062 6173 655f 7669 6577    auto base_view
+000ce340: 203d 2073 7464 3a3a 7374 7269 6e67 5f76   = std::string_v
+000ce350: 6965 7728 6261 7365 2c20 6261 7365 5f6c  iew(base, base_l
+000ce360: 656e 6774 6829 3b0a 2020 7265 7475 726e  ength);.  return
+000ce370: 2061 6461 3a3a 6361 6e5f 7061 7273 6528   ada::can_parse(
+000ce380: 7374 643a 3a73 7472 696e 675f 7669 6577  std::string_view
+000ce390: 2869 6e70 7574 2c20 696e 7075 745f 6c65  (input, input_le
+000ce3a0: 6e67 7468 292c 2026 6261 7365 5f76 6965  ngth), &base_vie
+000ce3b0: 7729 3b0a 7d0a 0a76 6f69 6420 6164 615f  w);.}..void ada_
+000ce3c0: 6672 6565 2861 6461 5f75 726c 2072 6573  free(ada_url res
+000ce3d0: 756c 7429 206e 6f65 7863 6570 7420 7b0a  ult) noexcept {.
+000ce3e0: 2020 6164 613a 3a72 6573 756c 743c 6164    ada::result<ad
+000ce3f0: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
+000ce400: 723e 2a20 7220 3d0a 2020 2020 2020 2861  r>* r =.      (a
+000ce410: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
+000ce420: 7572 6c5f 6167 6772 6567 6174 6f72 3e2a  url_aggregator>*
+000ce430: 2972 6573 756c 743b 0a20 2064 656c 6574  )result;.  delet
+000ce440: 6520 723b 0a7d 0a0a 626f 6f6c 2061 6461  e r;.}..bool ada
+000ce450: 5f69 735f 7661 6c69 6428 6164 615f 7572  _is_valid(ada_ur
+000ce460: 6c20 7265 7375 6c74 2920 6e6f 6578 6365  l result) noexce
+000ce470: 7074 207b 0a20 2061 6461 3a3a 7265 7375  pt {.  ada::resu
+000ce480: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
+000ce490: 6567 6174 6f72 3e26 2072 203d 2067 6574  egator>& r = get
+000ce4a0: 5f69 6e73 7461 6e63 6528 7265 7375 6c74  _instance(result
+000ce4b0: 293b 0a20 2072 6574 7572 6e20 722e 6861  );.  return r.ha
+000ce4c0: 735f 7661 6c75 6528 293b 0a7d 0a0a 2f2f  s_value();.}..//
+000ce4d0: 2063 616c 6c65 7220 6d75 7374 2066 7265   caller must fre
+000ce4e0: 6520 7468 6520 7265 7375 6c74 2077 6974  e the result wit
+000ce4f0: 6820 6164 615f 6672 6565 5f6f 776e 6564  h ada_free_owned
+000ce500: 5f73 7472 696e 670a 6164 615f 6f77 6e65  _string.ada_owne
+000ce510: 645f 7374 7269 6e67 2061 6461 5f67 6574  d_string ada_get
+000ce520: 5f6f 7269 6769 6e28 6164 615f 7572 6c20  _origin(ada_url 
+000ce530: 7265 7375 6c74 2920 6e6f 6578 6365 7074  result) noexcept
+000ce540: 207b 0a20 2061 6461 3a3a 7265 7375 6c74   {.  ada::result
+000ce550: 3c61 6461 3a3a 7572 6c5f 6167 6772 6567  <ada::url_aggreg
+000ce560: 6174 6f72 3e26 2072 203d 2067 6574 5f69  ator>& r = get_i
+000ce570: 6e73 7461 6e63 6528 7265 7375 6c74 293b  nstance(result);
+000ce580: 0a20 2061 6461 5f6f 776e 6564 5f73 7472  .  ada_owned_str
+000ce590: 696e 6720 6f77 6e65 643b 0a20 2069 6620  ing owned;.  if 
+000ce5a0: 2821 7229 207b 0a20 2020 206f 776e 6564  (!r) {.    owned
+000ce5b0: 2e64 6174 6120 3d20 6e75 6c6c 7074 723b  .data = nullptr;
+000ce5c0: 0a20 2020 206f 776e 6564 2e6c 656e 6774  .    owned.lengt
+000ce5d0: 6820 3d20 303b 0a20 2020 2072 6574 7572  h = 0;.    retur
+000ce5e0: 6e20 6f77 6e65 643b 0a20 207d 0a20 2073  n owned;.  }.  s
+000ce5f0: 7464 3a3a 7374 7269 6e67 206f 7574 203d  td::string out =
+000ce600: 2072 2d3e 6765 745f 6f72 6967 696e 2829   r->get_origin()
+000ce610: 3b0a 2020 6f77 6e65 642e 6c65 6e67 7468  ;.  owned.length
+000ce620: 203d 206f 7574 2e73 697a 6528 293b 0a20   = out.size();. 
+000ce630: 206f 776e 6564 2e64 6174 6120 3d20 6e65   owned.data = ne
+000ce640: 7720 6368 6172 5b6f 776e 6564 2e6c 656e  w char[owned.len
+000ce650: 6774 685d 3b0a 2020 6d65 6d63 7079 2828  gth];.  memcpy((
+000ce660: 766f 6964 2a29 6f77 6e65 642e 6461 7461  void*)owned.data
+000ce670: 2c20 6f75 742e 6461 7461 2829 2c20 6f77  , out.data(), ow
+000ce680: 6e65 642e 6c65 6e67 7468 293b 0a20 2072  ned.length);.  r
+000ce690: 6574 7572 6e20 6f77 6e65 643b 0a7d 0a0a  eturn owned;.}..
+000ce6a0: 766f 6964 2061 6461 5f66 7265 655f 6f77  void ada_free_ow
+000ce6b0: 6e65 645f 7374 7269 6e67 2861 6461 5f6f  ned_string(ada_o
+000ce6c0: 776e 6564 5f73 7472 696e 6720 6f77 6e65  wned_string owne
+000ce6d0: 6429 206e 6f65 7863 6570 7420 7b0a 2020  d) noexcept {.  
+000ce6e0: 6465 6c65 7465 5b5d 206f 776e 6564 2e64  delete[] owned.d
+000ce6f0: 6174 613b 0a20 206f 776e 6564 2e64 6174  ata;.  owned.dat
+000ce700: 6120 3d20 6e75 6c6c 7074 723b 0a20 206f  a = nullptr;.  o
+000ce710: 776e 6564 2e6c 656e 6774 6820 3d20 303b  wned.length = 0;
+000ce720: 0a7d 0a0a 6164 615f 7374 7269 6e67 2061  .}..ada_string a
+000ce730: 6461 5f67 6574 5f68 7265 6628 6164 615f  da_get_href(ada_
+000ce740: 7572 6c20 7265 7375 6c74 2920 6e6f 6578  url result) noex
+000ce750: 6365 7074 207b 0a20 2061 6461 3a3a 7265  cept {.  ada::re
+000ce760: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
+000ce770: 6772 6567 6174 6f72 3e26 2072 203d 2067  gregator>& r = g
+000ce780: 6574 5f69 6e73 7461 6e63 6528 7265 7375  et_instance(resu
+000ce790: 6c74 293b 0a20 2069 6620 2821 7229 207b  lt);.  if (!r) {
+000ce7a0: 0a20 2020 2072 6574 7572 6e20 6164 615f  .    return ada_
+000ce7b0: 7374 7269 6e67 5f63 7265 6174 6528 4e55  string_create(NU
+000ce7c0: 4c4c 2c20 3029 3b0a 2020 7d0a 2020 7374  LL, 0);.  }.  st
+000ce7d0: 643a 3a73 7472 696e 675f 7669 6577 206f  d::string_view o
+000ce7e0: 7574 203d 2072 2d3e 6765 745f 6872 6566  ut = r->get_href
+000ce7f0: 2829 3b0a 2020 7265 7475 726e 2061 6461  ();.  return ada
+000ce800: 5f73 7472 696e 675f 6372 6561 7465 286f  _string_create(o
+000ce810: 7574 2e64 6174 6128 292c 206f 7574 2e6c  ut.data(), out.l
+000ce820: 656e 6774 6828 2929 3b0a 7d0a 0a61 6461  ength());.}..ada
+000ce830: 5f73 7472 696e 6720 6164 615f 6765 745f  _string ada_get_
+000ce840: 7573 6572 6e61 6d65 2861 6461 5f75 726c  username(ada_url
+000ce850: 2072 6573 756c 7429 206e 6f65 7863 6570   result) noexcep
+000ce860: 7420 7b0a 2020 6164 613a 3a72 6573 756c  t {.  ada::resul
+000ce870: 743c 6164 613a 3a75 726c 5f61 6767 7265  t<ada::url_aggre
+000ce880: 6761 746f 723e 2620 7220 3d20 6765 745f  gator>& r = get_
+000ce890: 696e 7374 616e 6365 2872 6573 756c 7429  instance(result)
+000ce8a0: 3b0a 2020 6966 2028 2172 2920 7b0a 2020  ;.  if (!r) {.  
+000ce8b0: 2020 7265 7475 726e 2061 6461 5f73 7472    return ada_str
+000ce8c0: 696e 675f 6372 6561 7465 284e 554c 4c2c  ing_create(NULL,
+000ce8d0: 2030 293b 0a20 207d 0a20 2073 7464 3a3a   0);.  }.  std::
+000ce8e0: 7374 7269 6e67 5f76 6965 7720 6f75 7420  string_view out 
+000ce8f0: 3d20 722d 3e67 6574 5f75 7365 726e 616d  = r->get_usernam
+000ce900: 6528 293b 0a20 2072 6574 7572 6e20 6164  e();.  return ad
+000ce910: 615f 7374 7269 6e67 5f63 7265 6174 6528  a_string_create(
+000ce920: 6f75 742e 6461 7461 2829 2c20 6f75 742e  out.data(), out.
+000ce930: 6c65 6e67 7468 2829 293b 0a7d 0a0a 6164  length());.}..ad
+000ce940: 615f 7374 7269 6e67 2061 6461 5f67 6574  a_string ada_get
+000ce950: 5f70 6173 7377 6f72 6428 6164 615f 7572  _password(ada_ur
+000ce960: 6c20 7265 7375 6c74 2920 6e6f 6578 6365  l result) noexce
+000ce970: 7074 207b 0a20 2061 6461 3a3a 7265 7375  pt {.  ada::resu
+000ce980: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
+000ce990: 6567 6174 6f72 3e26 2072 203d 2067 6574  egator>& r = get
+000ce9a0: 5f69 6e73 7461 6e63 6528 7265 7375 6c74  _instance(result
+000ce9b0: 293b 0a20 2069 6620 2821 7229 207b 0a20  );.  if (!r) {. 
+000ce9c0: 2020 2072 6574 7572 6e20 6164 615f 7374     return ada_st
+000ce9d0: 7269 6e67 5f63 7265 6174 6528 4e55 4c4c  ring_create(NULL
+000ce9e0: 2c20 3029 3b0a 2020 7d0a 2020 7374 643a  , 0);.  }.  std:
+000ce9f0: 3a73 7472 696e 675f 7669 6577 206f 7574  :string_view out
+000cea00: 203d 2072 2d3e 6765 745f 7061 7373 776f   = r->get_passwo
+000cea10: 7264 2829 3b0a 2020 7265 7475 726e 2061  rd();.  return a
+000cea20: 6461 5f73 7472 696e 675f 6372 6561 7465  da_string_create
+000cea30: 286f 7574 2e64 6174 6128 292c 206f 7574  (out.data(), out
+000cea40: 2e6c 656e 6774 6828 2929 3b0a 7d0a 0a61  .length());.}..a
+000cea50: 6461 5f73 7472 696e 6720 6164 615f 6765  da_string ada_ge
+000cea60: 745f 706f 7274 2861 6461 5f75 726c 2072  t_port(ada_url r
+000cea70: 6573 756c 7429 206e 6f65 7863 6570 7420  esult) noexcept 
+000cea80: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
+000cea90: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
+000ceaa0: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
+000ceab0: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
+000ceac0: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
+000cead0: 7265 7475 726e 2061 6461 5f73 7472 696e  return ada_strin
+000ceae0: 675f 6372 6561 7465 284e 554c 4c2c 2030  g_create(NULL, 0
+000ceaf0: 293b 0a20 207d 0a20 2073 7464 3a3a 7374  );.  }.  std::st
+000ceb00: 7269 6e67 5f76 6965 7720 6f75 7420 3d20  ring_view out = 
+000ceb10: 722d 3e67 6574 5f70 6f72 7428 293b 0a20  r->get_port();. 
+000ceb20: 2072 6574 7572 6e20 6164 615f 7374 7269   return ada_stri
+000ceb30: 6e67 5f63 7265 6174 6528 6f75 742e 6461  ng_create(out.da
+000ceb40: 7461 2829 2c20 6f75 742e 6c65 6e67 7468  ta(), out.length
+000ceb50: 2829 293b 0a7d 0a0a 6164 615f 7374 7269  ());.}..ada_stri
+000ceb60: 6e67 2061 6461 5f67 6574 5f68 6173 6828  ng ada_get_hash(
+000ceb70: 6164 615f 7572 6c20 7265 7375 6c74 2920  ada_url result) 
+000ceb80: 6e6f 6578 6365 7074 207b 0a20 2061 6461  noexcept {.  ada
+000ceb90: 3a3a 7265 7375 6c74 3c61 6461 3a3a 7572  ::result<ada::ur
+000ceba0: 6c5f 6167 6772 6567 6174 6f72 3e26 2072  l_aggregator>& r
+000cebb0: 203d 2067 6574 5f69 6e73 7461 6e63 6528   = get_instance(
+000cebc0: 7265 7375 6c74 293b 0a20 2069 6620 2821  result);.  if (!
+000cebd0: 7229 207b 0a20 2020 2072 6574 7572 6e20  r) {.    return 
+000cebe0: 6164 615f 7374 7269 6e67 5f63 7265 6174  ada_string_creat
+000cebf0: 6528 4e55 4c4c 2c20 3029 3b0a 2020 7d0a  e(NULL, 0);.  }.
+000cec00: 2020 7374 643a 3a73 7472 696e 675f 7669    std::string_vi
+000cec10: 6577 206f 7574 203d 2072 2d3e 6765 745f  ew out = r->get_
+000cec20: 6861 7368 2829 3b0a 2020 7265 7475 726e  hash();.  return
+000cec30: 2061 6461 5f73 7472 696e 675f 6372 6561   ada_string_crea
+000cec40: 7465 286f 7574 2e64 6174 6128 292c 206f  te(out.data(), o
+000cec50: 7574 2e6c 656e 6774 6828 2929 3b0a 7d0a  ut.length());.}.
+000cec60: 0a61 6461 5f73 7472 696e 6720 6164 615f  .ada_string ada_
+000cec70: 6765 745f 686f 7374 2861 6461 5f75 726c  get_host(ada_url
+000cec80: 2072 6573 756c 7429 206e 6f65 7863 6570   result) noexcep
+000cec90: 7420 7b0a 2020 6164 613a 3a72 6573 756c  t {.  ada::resul
+000ceca0: 743c 6164 613a 3a75 726c 5f61 6767 7265  t<ada::url_aggre
+000cecb0: 6761 746f 723e 2620 7220 3d20 6765 745f  gator>& r = get_
+000cecc0: 696e 7374 616e 6365 2872 6573 756c 7429  instance(result)
+000cecd0: 3b0a 2020 6966 2028 2172 2920 7b0a 2020  ;.  if (!r) {.  
+000cece0: 2020 7265 7475 726e 2061 6461 5f73 7472    return ada_str
+000cecf0: 696e 675f 6372 6561 7465 284e 554c 4c2c  ing_create(NULL,
+000ced00: 2030 293b 0a20 207d 0a20 2073 7464 3a3a   0);.  }.  std::
+000ced10: 7374 7269 6e67 5f76 6965 7720 6f75 7420  string_view out 
+000ced20: 3d20 722d 3e67 6574 5f68 6f73 7428 293b  = r->get_host();
+000ced30: 0a20 2072 6574 7572 6e20 6164 615f 7374  .  return ada_st
+000ced40: 7269 6e67 5f63 7265 6174 6528 6f75 742e  ring_create(out.
+000ced50: 6461 7461 2829 2c20 6f75 742e 6c65 6e67  data(), out.leng
+000ced60: 7468 2829 293b 0a7d 0a0a 6164 615f 7374  th());.}..ada_st
+000ced70: 7269 6e67 2061 6461 5f67 6574 5f68 6f73  ring ada_get_hos
+000ced80: 746e 616d 6528 6164 615f 7572 6c20 7265  tname(ada_url re
+000ced90: 7375 6c74 2920 6e6f 6578 6365 7074 207b  sult) noexcept {
+000ceda0: 0a20 2061 6461 3a3a 7265 7375 6c74 3c61  .  ada::result<a
+000cedb0: 6461 3a3a 7572 6c5f 6167 6772 6567 6174  da::url_aggregat
+000cedc0: 6f72 3e26 2072 203d 2067 6574 5f69 6e73  or>& r = get_ins
+000cedd0: 7461 6e63 6528 7265 7375 6c74 293b 0a20  tance(result);. 
+000cede0: 2069 6620 2821 7229 207b 0a20 2020 2072   if (!r) {.    r
+000cedf0: 6574 7572 6e20 6164 615f 7374 7269 6e67  eturn ada_string
+000cee00: 5f63 7265 6174 6528 4e55 4c4c 2c20 3029  _create(NULL, 0)
+000cee10: 3b0a 2020 7d0a 2020 7374 643a 3a73 7472  ;.  }.  std::str
+000cee20: 696e 675f 7669 6577 206f 7574 203d 2072  ing_view out = r
+000cee30: 2d3e 6765 745f 686f 7374 6e61 6d65 2829  ->get_hostname()
+000cee40: 3b0a 2020 7265 7475 726e 2061 6461 5f73  ;.  return ada_s
+000cee50: 7472 696e 675f 6372 6561 7465 286f 7574  tring_create(out
+000cee60: 2e64 6174 6128 292c 206f 7574 2e6c 656e  .data(), out.len
+000cee70: 6774 6828 2929 3b0a 7d0a 0a61 6461 5f73  gth());.}..ada_s
+000cee80: 7472 696e 6720 6164 615f 6765 745f 7061  tring ada_get_pa
+000cee90: 7468 6e61 6d65 2861 6461 5f75 726c 2072  thname(ada_url r
+000ceea0: 6573 756c 7429 206e 6f65 7863 6570 7420  esult) noexcept 
+000ceeb0: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
+000ceec0: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
+000ceed0: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
+000ceee0: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
+000ceef0: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
+000cef00: 7265 7475 726e 2061 6461 5f73 7472 696e  return ada_strin
+000cef10: 675f 6372 6561 7465 284e 554c 4c2c 2030  g_create(NULL, 0
+000cef20: 293b 0a20 207d 0a20 2073 7464 3a3a 7374  );.  }.  std::st
+000cef30: 7269 6e67 5f76 6965 7720 6f75 7420 3d20  ring_view out = 
+000cef40: 722d 3e67 6574 5f70 6174 686e 616d 6528  r->get_pathname(
+000cef50: 293b 0a20 2072 6574 7572 6e20 6164 615f  );.  return ada_
+000cef60: 7374 7269 6e67 5f63 7265 6174 6528 6f75  string_create(ou
+000cef70: 742e 6461 7461 2829 2c20 6f75 742e 6c65  t.data(), out.le
+000cef80: 6e67 7468 2829 293b 0a7d 0a0a 6164 615f  ngth());.}..ada_
+000cef90: 7374 7269 6e67 2061 6461 5f67 6574 5f73  string ada_get_s
+000cefa0: 6561 7263 6828 6164 615f 7572 6c20 7265  earch(ada_url re
+000cefb0: 7375 6c74 2920 6e6f 6578 6365 7074 207b  sult) noexcept {
+000cefc0: 0a20 2061 6461 3a3a 7265 7375 6c74 3c61  .  ada::result<a
+000cefd0: 6461 3a3a 7572 6c5f 6167 6772 6567 6174  da::url_aggregat
+000cefe0: 6f72 3e26 2072 203d 2067 6574 5f69 6e73  or>& r = get_ins
+000ceff0: 7461 6e63 6528 7265 7375 6c74 293b 0a20  tance(result);. 
+000cf000: 2069 6620 2821 7229 207b 0a20 2020 2072   if (!r) {.    r
+000cf010: 6574 7572 6e20 6164 615f 7374 7269 6e67  eturn ada_string
+000cf020: 5f63 7265 6174 6528 4e55 4c4c 2c20 3029  _create(NULL, 0)
+000cf030: 3b0a 2020 7d0a 2020 7374 643a 3a73 7472  ;.  }.  std::str
+000cf040: 696e 675f 7669 6577 206f 7574 203d 2072  ing_view out = r
+000cf050: 2d3e 6765 745f 7365 6172 6368 2829 3b0a  ->get_search();.
+000cf060: 2020 7265 7475 726e 2061 6461 5f73 7472    return ada_str
+000cf070: 696e 675f 6372 6561 7465 286f 7574 2e64  ing_create(out.d
+000cf080: 6174 6128 292c 206f 7574 2e6c 656e 6774  ata(), out.lengt
+000cf090: 6828 2929 3b0a 7d0a 0a61 6461 5f73 7472  h());.}..ada_str
+000cf0a0: 696e 6720 6164 615f 6765 745f 7072 6f74  ing ada_get_prot
+000cf0b0: 6f63 6f6c 2861 6461 5f75 726c 2072 6573  ocol(ada_url res
+000cf0c0: 756c 7429 206e 6f65 7863 6570 7420 7b0a  ult) noexcept {.
+000cf0d0: 2020 6164 613a 3a72 6573 756c 743c 6164    ada::result<ad
+000cf0e0: 613a 3a75 726c 5f61 6767 7265 6761 746f  a::url_aggregato
+000cf0f0: 723e 2620 7220 3d20 6765 745f 696e 7374  r>& r = get_inst
+000cf100: 616e 6365 2872 6573 756c 7429 3b0a 2020  ance(result);.  
+000cf110: 6966 2028 2172 2920 7b0a 2020 2020 7265  if (!r) {.    re
+000cf120: 7475 726e 2061 6461 5f73 7472 696e 675f  turn ada_string_
+000cf130: 6372 6561 7465 284e 554c 4c2c 2030 293b  create(NULL, 0);
+000cf140: 0a20 207d 0a20 2073 7464 3a3a 7374 7269  .  }.  std::stri
+000cf150: 6e67 5f76 6965 7720 6f75 7420 3d20 722d  ng_view out = r-
+000cf160: 3e67 6574 5f70 726f 746f 636f 6c28 293b  >get_protocol();
+000cf170: 0a20 2072 6574 7572 6e20 6164 615f 7374  .  return ada_st
+000cf180: 7269 6e67 5f63 7265 6174 6528 6f75 742e  ring_create(out.
+000cf190: 6461 7461 2829 2c20 6f75 742e 6c65 6e67  data(), out.leng
+000cf1a0: 7468 2829 293b 0a7d 0a0a 626f 6f6c 2061  th());.}..bool a
+000cf1b0: 6461 5f73 6574 5f68 7265 6628 6164 615f  da_set_href(ada_
+000cf1c0: 7572 6c20 7265 7375 6c74 2c20 636f 6e73  url result, cons
+000cf1d0: 7420 6368 6172 2a20 696e 7075 742c 2073  t char* input, s
+000cf1e0: 697a 655f 7420 6c65 6e67 7468 2920 6e6f  ize_t length) no
+000cf1f0: 6578 6365 7074 207b 0a20 2061 6461 3a3a  except {.  ada::
+000cf200: 7265 7375 6c74 3c61 6461 3a3a 7572 6c5f  result<ada::url_
+000cf210: 6167 6772 6567 6174 6f72 3e26 2072 203d  aggregator>& r =
+000cf220: 2067 6574 5f69 6e73 7461 6e63 6528 7265   get_instance(re
+000cf230: 7375 6c74 293b 0a20 2069 6620 2821 7229  sult);.  if (!r)
+000cf240: 207b 0a20 2020 2072 6574 7572 6e20 6661   {.    return fa
+000cf250: 6c73 653b 0a20 207d 0a20 2072 6574 7572  lse;.  }.  retur
+000cf260: 6e20 722d 3e73 6574 5f68 7265 6628 7374  n r->set_href(st
+000cf270: 643a 3a73 7472 696e 675f 7669 6577 2869  d::string_view(i
+000cf280: 6e70 7574 2c20 6c65 6e67 7468 2929 3b0a  nput, length));.
+000cf290: 7d0a 0a62 6f6f 6c20 6164 615f 7365 745f  }..bool ada_set_
+000cf2a0: 686f 7374 2861 6461 5f75 726c 2072 6573  host(ada_url res
+000cf2b0: 756c 742c 2063 6f6e 7374 2063 6861 722a  ult, const char*
+000cf2c0: 2069 6e70 7574 2c20 7369 7a65 5f74 206c   input, size_t l
+000cf2d0: 656e 6774 6829 206e 6f65 7863 6570 7420  ength) noexcept 
+000cf2e0: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
+000cf2f0: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
+000cf300: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
+000cf310: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
+000cf320: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
+000cf330: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000cf340: 7d0a 2020 7265 7475 726e 2072 2d3e 7365  }.  return r->se
+000cf350: 745f 686f 7374 2873 7464 3a3a 7374 7269  t_host(std::stri
+000cf360: 6e67 5f76 6965 7728 696e 7075 742c 206c  ng_view(input, l
+000cf370: 656e 6774 6829 293b 0a7d 0a0a 626f 6f6c  ength));.}..bool
+000cf380: 2061 6461 5f73 6574 5f68 6f73 746e 616d   ada_set_hostnam
+000cf390: 6528 6164 615f 7572 6c20 7265 7375 6c74  e(ada_url result
+000cf3a0: 2c20 636f 6e73 7420 6368 6172 2a20 696e  , const char* in
+000cf3b0: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+000cf3c0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+000cf3d0: 7420 6c65 6e67 7468 2920 6e6f 6578 6365  t length) noexce
+000cf3e0: 7074 207b 0a20 2061 6461 3a3a 7265 7375  pt {.  ada::resu
+000cf3f0: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
+000cf400: 6567 6174 6f72 3e26 2072 203d 2067 6574  egator>& r = get
+000cf410: 5f69 6e73 7461 6e63 6528 7265 7375 6c74  _instance(result
+000cf420: 293b 0a20 2069 6620 2821 7229 207b 0a20  );.  if (!r) {. 
+000cf430: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
+000cf440: 0a20 207d 0a20 2072 6574 7572 6e20 722d  .  }.  return r-
+000cf450: 3e73 6574 5f68 6f73 746e 616d 6528 7374  >set_hostname(st
+000cf460: 643a 3a73 7472 696e 675f 7669 6577 2869  d::string_view(i
+000cf470: 6e70 7574 2c20 6c65 6e67 7468 2929 3b0a  nput, length));.
+000cf480: 7d0a 0a62 6f6f 6c20 6164 615f 7365 745f  }..bool ada_set_
+000cf490: 7072 6f74 6f63 6f6c 2861 6461 5f75 726c  protocol(ada_url
+000cf4a0: 2072 6573 756c 742c 2063 6f6e 7374 2063   result, const c
+000cf4b0: 6861 722a 2069 6e70 7574 2c0a 2020 2020  har* input,.    
+000cf4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000cf4d0: 2020 7369 7a65 5f74 206c 656e 6774 6829    size_t length)
+000cf4e0: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
+000cf4f0: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
+000cf500: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
+000cf510: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
+000cf520: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
+000cf530: 2172 2920 7b0a 2020 2020 7265 7475 726e  !r) {.    return
+000cf540: 2066 616c 7365 3b0a 2020 7d0a 2020 7265   false;.  }.  re
+000cf550: 7475 726e 2072 2d3e 7365 745f 7072 6f74  turn r->set_prot
+000cf560: 6f63 6f6c 2873 7464 3a3a 7374 7269 6e67  ocol(std::string
+000cf570: 5f76 6965 7728 696e 7075 742c 206c 656e  _view(input, len
+000cf580: 6774 6829 293b 0a7d 0a0a 626f 6f6c 2061  gth));.}..bool a
+000cf590: 6461 5f73 6574 5f75 7365 726e 616d 6528  da_set_username(
+000cf5a0: 6164 615f 7572 6c20 7265 7375 6c74 2c20  ada_url result, 
+000cf5b0: 636f 6e73 7420 6368 6172 2a20 696e 7075  const char* inpu
+000cf5c0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000cf5d0: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+000cf5e0: 6c65 6e67 7468 2920 6e6f 6578 6365 7074  length) noexcept
+000cf5f0: 207b 0a20 2061 6461 3a3a 7265 7375 6c74   {.  ada::result
+000cf600: 3c61 6461 3a3a 7572 6c5f 6167 6772 6567  <ada::url_aggreg
+000cf610: 6174 6f72 3e26 2072 203d 2067 6574 5f69  ator>& r = get_i
+000cf620: 6e73 7461 6e63 6528 7265 7375 6c74 293b  nstance(result);
+000cf630: 0a20 2069 6620 2821 7229 207b 0a20 2020  .  if (!r) {.   
+000cf640: 2072 6574 7572 6e20 6661 6c73 653b 0a20   return false;. 
+000cf650: 207d 0a20 2072 6574 7572 6e20 722d 3e73   }.  return r->s
+000cf660: 6574 5f75 7365 726e 616d 6528 7374 643a  et_username(std:
+000cf670: 3a73 7472 696e 675f 7669 6577 2869 6e70  :string_view(inp
+000cf680: 7574 2c20 6c65 6e67 7468 2929 3b0a 7d0a  ut, length));.}.
+000cf690: 0a62 6f6f 6c20 6164 615f 7365 745f 7061  .bool ada_set_pa
+000cf6a0: 7373 776f 7264 2861 6461 5f75 726c 2072  ssword(ada_url r
+000cf6b0: 6573 756c 742c 2063 6f6e 7374 2063 6861  esult, const cha
+000cf6c0: 722a 2069 6e70 7574 2c0a 2020 2020 2020  r* input,.      
+000cf6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000cf6e0: 7369 7a65 5f74 206c 656e 6774 6829 206e  size_t length) n
+000cf6f0: 6f65 7863 6570 7420 7b0a 2020 6164 613a  oexcept {.  ada:
+000cf700: 3a72 6573 756c 743c 6164 613a 3a75 726c  :result<ada::url
+000cf710: 5f61 6767 7265 6761 746f 723e 2620 7220  _aggregator>& r 
+000cf720: 3d20 6765 745f 696e 7374 616e 6365 2872  = get_instance(r
+000cf730: 6573 756c 7429 3b0a 2020 6966 2028 2172  esult);.  if (!r
+000cf740: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
+000cf750: 616c 7365 3b0a 2020 7d0a 2020 7265 7475  alse;.  }.  retu
+000cf760: 726e 2072 2d3e 7365 745f 7061 7373 776f  rn r->set_passwo
+000cf770: 7264 2873 7464 3a3a 7374 7269 6e67 5f76  rd(std::string_v
+000cf780: 6965 7728 696e 7075 742c 206c 656e 6774  iew(input, lengt
+000cf790: 6829 293b 0a7d 0a0a 626f 6f6c 2061 6461  h));.}..bool ada
+000cf7a0: 5f73 6574 5f70 6f72 7428 6164 615f 7572  _set_port(ada_ur
+000cf7b0: 6c20 7265 7375 6c74 2c20 636f 6e73 7420  l result, const 
+000cf7c0: 6368 6172 2a20 696e 7075 742c 2073 697a  char* input, siz
+000cf7d0: 655f 7420 6c65 6e67 7468 2920 6e6f 6578  e_t length) noex
+000cf7e0: 6365 7074 207b 0a20 2061 6461 3a3a 7265  cept {.  ada::re
+000cf7f0: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
+000cf800: 6772 6567 6174 6f72 3e26 2072 203d 2067  gregator>& r = g
+000cf810: 6574 5f69 6e73 7461 6e63 6528 7265 7375  et_instance(resu
+000cf820: 6c74 293b 0a20 2069 6620 2821 7229 207b  lt);.  if (!r) {
+000cf830: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
+000cf840: 653b 0a20 207d 0a20 2072 6574 7572 6e20  e;.  }.  return 
+000cf850: 722d 3e73 6574 5f70 6f72 7428 7374 643a  r->set_port(std:
+000cf860: 3a73 7472 696e 675f 7669 6577 2869 6e70  :string_view(inp
+000cf870: 7574 2c20 6c65 6e67 7468 2929 3b0a 7d0a  ut, length));.}.
+000cf880: 0a62 6f6f 6c20 6164 615f 7365 745f 7061  .bool ada_set_pa
+000cf890: 7468 6e61 6d65 2861 6461 5f75 726c 2072  thname(ada_url r
+000cf8a0: 6573 756c 742c 2063 6f6e 7374 2063 6861  esult, const cha
+000cf8b0: 722a 2069 6e70 7574 2c0a 2020 2020 2020  r* input,.      
+000cf8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000cf8d0: 7369 7a65 5f74 206c 656e 6774 6829 206e  size_t length) n
+000cf8e0: 6f65 7863 6570 7420 7b0a 2020 6164 613a  oexcept {.  ada:
+000cf8f0: 3a72 6573 756c 743c 6164 613a 3a75 726c  :result<ada::url
+000cf900: 5f61 6767 7265 6761 746f 723e 2620 7220  _aggregator>& r 
+000cf910: 3d20 6765 745f 696e 7374 616e 6365 2872  = get_instance(r
+000cf920: 6573 756c 7429 3b0a 2020 6966 2028 2172  esult);.  if (!r
+000cf930: 2920 7b0a 2020 2020 7265 7475 726e 2066  ) {.    return f
+000cf940: 616c 7365 3b0a 2020 7d0a 2020 7265 7475  alse;.  }.  retu
+000cf950: 726e 2072 2d3e 7365 745f 7061 7468 6e61  rn r->set_pathna
+000cf960: 6d65 2873 7464 3a3a 7374 7269 6e67 5f76  me(std::string_v
+000cf970: 6965 7728 696e 7075 742c 206c 656e 6774  iew(input, lengt
+000cf980: 6829 293b 0a7d 0a0a 766f 6964 2061 6461  h));.}..void ada
+000cf990: 5f73 6574 5f73 6561 7263 6828 6164 615f  _set_search(ada_
+000cf9a0: 7572 6c20 7265 7375 6c74 2c20 636f 6e73  url result, cons
+000cf9b0: 7420 6368 6172 2a20 696e 7075 742c 2073  t char* input, s
+000cf9c0: 697a 655f 7420 6c65 6e67 7468 2920 6e6f  ize_t length) no
+000cf9d0: 6578 6365 7074 207b 0a20 2061 6461 3a3a  except {.  ada::
+000cf9e0: 7265 7375 6c74 3c61 6461 3a3a 7572 6c5f  result<ada::url_
+000cf9f0: 6167 6772 6567 6174 6f72 3e26 2072 203d  aggregator>& r =
+000cfa00: 2067 6574 5f69 6e73 7461 6e63 6528 7265   get_instance(re
+000cfa10: 7375 6c74 293b 0a20 2069 6620 2872 2920  sult);.  if (r) 
+000cfa20: 7b0a 2020 2020 722d 3e73 6574 5f73 6561  {.    r->set_sea
+000cfa30: 7263 6828 7374 643a 3a73 7472 696e 675f  rch(std::string_
+000cfa40: 7669 6577 2869 6e70 7574 2c20 6c65 6e67  view(input, leng
+000cfa50: 7468 2929 3b0a 2020 7d0a 7d0a 0a76 6f69  th));.  }.}..voi
+000cfa60: 6420 6164 615f 7365 745f 6861 7368 2861  d ada_set_hash(a
+000cfa70: 6461 5f75 726c 2072 6573 756c 742c 2063  da_url result, c
+000cfa80: 6f6e 7374 2063 6861 722a 2069 6e70 7574  onst char* input
+000cfa90: 2c20 7369 7a65 5f74 206c 656e 6774 6829  , size_t length)
+000cfaa0: 206e 6f65 7863 6570 7420 7b0a 2020 6164   noexcept {.  ad
+000cfab0: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
+000cfac0: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
+000cfad0: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
+000cfae0: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
+000cfaf0: 7229 207b 0a20 2020 2072 2d3e 7365 745f  r) {.    r->set_
+000cfb00: 6861 7368 2873 7464 3a3a 7374 7269 6e67  hash(std::string
+000cfb10: 5f76 6965 7728 696e 7075 742c 206c 656e  _view(input, len
+000cfb20: 6774 6829 293b 0a20 207d 0a7d 0a0a 626f  gth));.  }.}..bo
+000cfb30: 6f6c 2061 6461 5f68 6173 5f63 7265 6465  ol ada_has_crede
+000cfb40: 6e74 6961 6c73 2861 6461 5f75 726c 2072  ntials(ada_url r
+000cfb50: 6573 756c 7429 206e 6f65 7863 6570 7420  esult) noexcept 
+000cfb60: 7b0a 2020 6164 613a 3a72 6573 756c 743c  {.  ada::result<
+000cfb70: 6164 613a 3a75 726c 5f61 6767 7265 6761  ada::url_aggrega
+000cfb80: 746f 723e 2620 7220 3d20 6765 745f 696e  tor>& r = get_in
+000cfb90: 7374 616e 6365 2872 6573 756c 7429 3b0a  stance(result);.
+000cfba0: 2020 6966 2028 2172 2920 7b0a 2020 2020    if (!r) {.    
+000cfbb0: 7265 7475 726e 2066 616c 7365 3b0a 2020  return false;.  
+000cfbc0: 7d0a 2020 7265 7475 726e 2072 2d3e 6861  }.  return r->ha
+000cfbd0: 735f 6372 6564 656e 7469 616c 7328 293b  s_credentials();
+000cfbe0: 0a7d 0a0a 626f 6f6c 2061 6461 5f68 6173  .}..bool ada_has
+000cfbf0: 5f65 6d70 7479 5f68 6f73 746e 616d 6528  _empty_hostname(
+000cfc00: 6164 615f 7572 6c20 7265 7375 6c74 2920  ada_url result) 
+000cfc10: 6e6f 6578 6365 7074 207b 0a20 2061 6461  noexcept {.  ada
+000cfc20: 3a3a 7265 7375 6c74 3c61 6461 3a3a 7572  ::result<ada::ur
+000cfc30: 6c5f 6167 6772 6567 6174 6f72 3e26 2072  l_aggregator>& r
+000cfc40: 203d 2067 6574 5f69 6e73 7461 6e63 6528   = get_instance(
+000cfc50: 7265 7375 6c74 293b 0a20 2069 6620 2821  result);.  if (!
+000cfc60: 7229 207b 0a20 2020 2072 6574 7572 6e20  r) {.    return 
+000cfc70: 6661 6c73 653b 0a20 207d 0a20 2072 6574  false;.  }.  ret
+000cfc80: 7572 6e20 722d 3e68 6173 5f65 6d70 7479  urn r->has_empty
+000cfc90: 5f68 6f73 746e 616d 6528 293b 0a7d 0a0a  _hostname();.}..
+000cfca0: 626f 6f6c 2061 6461 5f68 6173 5f68 6f73  bool ada_has_hos
+000cfcb0: 746e 616d 6528 6164 615f 7572 6c20 7265  tname(ada_url re
+000cfcc0: 7375 6c74 2920 6e6f 6578 6365 7074 207b  sult) noexcept {
+000cfcd0: 0a20 2061 6461 3a3a 7265 7375 6c74 3c61  .  ada::result<a
+000cfce0: 6461 3a3a 7572 6c5f 6167 6772 6567 6174  da::url_aggregat
+000cfcf0: 6f72 3e26 2072 203d 2067 6574 5f69 6e73  or>& r = get_ins
+000cfd00: 7461 6e63 6528 7265 7375 6c74 293b 0a20  tance(result);. 
+000cfd10: 2069 6620 2821 7229 207b 0a20 2020 2072   if (!r) {.    r
+000cfd20: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
+000cfd30: 0a20 2072 6574 7572 6e20 722d 3e68 6173  .  return r->has
+000cfd40: 5f68 6f73 746e 616d 6528 293b 0a7d 0a0a  _hostname();.}..
+000cfd50: 626f 6f6c 2061 6461 5f68 6173 5f6e 6f6e  bool ada_has_non
+000cfd60: 5f65 6d70 7479 5f75 7365 726e 616d 6528  _empty_username(
+000cfd70: 6164 615f 7572 6c20 7265 7375 6c74 2920  ada_url result) 
+000cfd80: 6e6f 6578 6365 7074 207b 0a20 2061 6461  noexcept {.  ada
+000cfd90: 3a3a 7265 7375 6c74 3c61 6461 3a3a 7572  ::result<ada::ur
+000cfda0: 6c5f 6167 6772 6567 6174 6f72 3e26 2072  l_aggregator>& r
+000cfdb0: 203d 2067 6574 5f69 6e73 7461 6e63 6528   = get_instance(
+000cfdc0: 7265 7375 6c74 293b 0a20 2069 6620 2821  result);.  if (!
+000cfdd0: 7229 207b 0a20 2020 2072 6574 7572 6e20  r) {.    return 
+000cfde0: 6661 6c73 653b 0a20 207d 0a20 2072 6574  false;.  }.  ret
+000cfdf0: 7572 6e20 722d 3e68 6173 5f6e 6f6e 5f65  urn r->has_non_e
+000cfe00: 6d70 7479 5f75 7365 726e 616d 6528 293b  mpty_username();
+000cfe10: 0a7d 0a0a 626f 6f6c 2061 6461 5f68 6173  .}..bool ada_has
+000cfe20: 5f6e 6f6e 5f65 6d70 7479 5f70 6173 7377  _non_empty_passw
+000cfe30: 6f72 6428 6164 615f 7572 6c20 7265 7375  ord(ada_url resu
+000cfe40: 6c74 2920 6e6f 6578 6365 7074 207b 0a20  lt) noexcept {. 
+000cfe50: 2061 6461 3a3a 7265 7375 6c74 3c61 6461   ada::result<ada
+000cfe60: 3a3a 7572 6c5f 6167 6772 6567 6174 6f72  ::url_aggregator
+000cfe70: 3e26 2072 203d 2067 6574 5f69 6e73 7461  >& r = get_insta
+000cfe80: 6e63 6528 7265 7375 6c74 293b 0a20 2069  nce(result);.  i
+000cfe90: 6620 2821 7229 207b 0a20 2020 2072 6574  f (!r) {.    ret
+000cfea0: 7572 6e20 6661 6c73 653b 0a20 207d 0a20  urn false;.  }. 
+000cfeb0: 2072 6574 7572 6e20 722d 3e68 6173 5f6e   return r->has_n
+000cfec0: 6f6e 5f65 6d70 7479 5f70 6173 7377 6f72  on_empty_passwor
+000cfed0: 6428 293b 0a7d 0a0a 626f 6f6c 2061 6461  d();.}..bool ada
+000cfee0: 5f68 6173 5f70 6f72 7428 6164 615f 7572  _has_port(ada_ur
+000cfef0: 6c20 7265 7375 6c74 2920 6e6f 6578 6365  l result) noexce
+000cff00: 7074 207b 0a20 2061 6461 3a3a 7265 7375  pt {.  ada::resu
+000cff10: 6c74 3c61 6461 3a3a 7572 6c5f 6167 6772  lt<ada::url_aggr
+000cff20: 6567 6174 6f72 3e26 2072 203d 2067 6574  egator>& r = get
+000cff30: 5f69 6e73 7461 6e63 6528 7265 7375 6c74  _instance(result
+000cff40: 293b 0a20 2069 6620 2821 7229 207b 0a20  );.  if (!r) {. 
+000cff50: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
+000cff60: 0a20 207d 0a20 2072 6574 7572 6e20 722d  .  }.  return r-
+000cff70: 3e68 6173 5f70 6f72 7428 293b 0a7d 0a0a  >has_port();.}..
+000cff80: 626f 6f6c 2061 6461 5f68 6173 5f70 6173  bool ada_has_pas
+000cff90: 7377 6f72 6428 6164 615f 7572 6c20 7265  sword(ada_url re
+000cffa0: 7375 6c74 2920 6e6f 6578 6365 7074 207b  sult) noexcept {
+000cffb0: 0a20 2061 6461 3a3a 7265 7375 6c74 3c61  .  ada::result<a
+000cffc0: 6461 3a3a 7572 6c5f 6167 6772 6567 6174  da::url_aggregat
+000cffd0: 6f72 3e26 2072 203d 2067 6574 5f69 6e73  or>& r = get_ins
+000cffe0: 7461 6e63 6528 7265 7375 6c74 293b 0a20  tance(result);. 
+000cfff0: 2069 6620 2821 7229 207b 0a20 2020 2072   if (!r) {.    r
+000d0000: 6574 7572 6e20 6661 6c73 653b 0a20 207d  eturn false;.  }
+000d0010: 0a20 2072 6574 7572 6e20 722d 3e68 6173  .  return r->has
+000d0020: 5f70 6173 7377 6f72 6428 293b 0a7d 0a0a  _password();.}..
+000d0030: 626f 6f6c 2061 6461 5f68 6173 5f68 6173  bool ada_has_has
+000d0040: 6828 6164 615f 7572 6c20 7265 7375 6c74  h(ada_url result
+000d0050: 2920 6e6f 6578 6365 7074 207b 0a20 2061  ) noexcept {.  a
+000d0060: 6461 3a3a 7265 7375 6c74 3c61 6461 3a3a  da::result<ada::
+000d0070: 7572 6c5f 6167 6772 6567 6174 6f72 3e26  url_aggregator>&
+000d0080: 2072 203d 2067 6574 5f69 6e73 7461 6e63   r = get_instanc
+000d0090: 6528 7265 7375 6c74 293b 0a20 2069 6620  e(result);.  if 
+000d00a0: 2821 7229 207b 0a20 2020 2072 6574 7572  (!r) {.    retur
+000d00b0: 6e20 6661 6c73 653b 0a20 207d 0a20 2072  n false;.  }.  r
+000d00c0: 6574 7572 6e20 722d 3e68 6173 5f68 6173  eturn r->has_has
+000d00d0: 6828 293b 0a7d 0a0a 626f 6f6c 2061 6461  h();.}..bool ada
+000d00e0: 5f68 6173 5f73 6561 7263 6828 6164 615f  _has_search(ada_
+000d00f0: 7572 6c20 7265 7375 6c74 2920 6e6f 6578  url result) noex
+000d0100: 6365 7074 207b 0a20 2061 6461 3a3a 7265  cept {.  ada::re
+000d0110: 7375 6c74 3c61 6461 3a3a 7572 6c5f 6167  sult<ada::url_ag
+000d0120: 6772 6567 6174 6f72 3e26 2072 203d 2067  gregator>& r = g
+000d0130: 6574 5f69 6e73 7461 6e63 6528 7265 7375  et_instance(resu
+000d0140: 6c74 293b 0a20 2069 6620 2821 7229 207b  lt);.  if (!r) {
+000d0150: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
+000d0160: 653b 0a20 207d 0a20 2072 6574 7572 6e20  e;.  }.  return 
+000d0170: 722d 3e68 6173 5f73 6561 7263 6828 293b  r->has_search();
+000d0180: 0a7d 0a0a 2f2f 2072 6574 7572 6e73 2061  .}..// returns a
+000d0190: 2070 6f69 6e74 6572 2074 6f20 7468 6520   pointer to the 
+000d01a0: 696e 7465 726e 616c 2075 726c 5f61 6767  internal url_agg
+000d01b0: 7265 6761 746f 723a 3a75 726c 5f63 6f6d  regator::url_com
+000d01c0: 706f 6e65 6e74 730a 636f 6e73 7420 6164  ponents.const ad
+000d01d0: 615f 7572 6c5f 636f 6d70 6f6e 656e 7473  a_url_components
+000d01e0: 2a20 6164 615f 6765 745f 636f 6d70 6f6e  * ada_get_compon
+000d01f0: 656e 7473 2861 6461 5f75 726c 2072 6573  ents(ada_url res
+000d0200: 756c 7429 206e 6f65 7863 6570 7420 7b0a  ult) noexcept {.
+000d0210: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
+000d0220: 7369 7a65 6f66 2861 6461 5f75 726c 5f63  sizeof(ada_url_c
+000d0230: 6f6d 706f 6e65 6e74 7329 203d 3d20 7369  omponents) == si
+000d0240: 7a65 6f66 2861 6461 3a3a 7572 6c5f 636f  zeof(ada::url_co
+000d0250: 6d70 6f6e 656e 7473 2929 3b0a 2020 6164  mponents));.  ad
+000d0260: 613a 3a72 6573 756c 743c 6164 613a 3a75  a::result<ada::u
+000d0270: 726c 5f61 6767 7265 6761 746f 723e 2620  rl_aggregator>& 
+000d0280: 7220 3d20 6765 745f 696e 7374 616e 6365  r = get_instance
+000d0290: 2872 6573 756c 7429 3b0a 2020 6966 2028  (result);.  if (
+000d02a0: 2172 2920 7b0a 2020 2020 7265 7475 726e  !r) {.    return
+000d02b0: 206e 756c 6c70 7472 3b0a 2020 7d0a 2020   nullptr;.  }.  
+000d02c0: 7265 7475 726e 2072 6569 6e74 6572 7072  return reinterpr
+000d02d0: 6574 5f63 6173 743c 636f 6e73 7420 6164  et_cast<const ad
+000d02e0: 615f 7572 6c5f 636f 6d70 6f6e 656e 7473  a_url_components
+000d02f0: 2a3e 2826 722d 3e67 6574 5f63 6f6d 706f  *>(&r->get_compo
+000d0300: 6e65 6e74 7328 2929 3b0a 7d0a 7d20 202f  nents());.}.}  /
+000d0310: 2f20 6578 7465 726e 2022 4322 0a2f 2a20  / extern "C"./* 
+000d0320: 656e 6420 6669 6c65 2073 7263 2f61 6461  end file src/ada
+000d0330: 5f63 2e63 7070 202a 2f0a 2f2a 2065 6e64  _c.cpp */./* end
+000d0340: 2066 696c 6520 7372 632f 6164 612e 6370   file src/ada.cp
+000d0350: 7020 2a2f 0a                             p */.
```

### Comparing `ada-url-0.1.0/ada_url/ada.h` & `ada-url-1.0.0/ada_url/ada.h`

 * *Files 0% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-/* auto-generated on 2023-05-19 00:02:33 -0400. Do not edit! */
+/* auto-generated on 2023-05-25 16:09:25 -0400. Do not edit! */
 /* begin file include/ada.h */
 /**
  * @file ada.h
  * @brief Includes all definitions for Ada.
  */
 #ifndef ADA_H
 #define ADA_H
@@ -421,15 +421,15 @@
 #else   // _MSC_VER
 // All other compilers appear to set __OPTIMIZE__ to a positive integer
 // when the compiler is optimizing.
 #ifndef __OPTIMIZE__
 #define ADA_DEVELOPMENT_CHECKS 1
 #endif  // __OPTIMIZE__
 #endif  // _MSC_VER
-#endif  // SIMDJSON_DEVELOPMENT_CHECKS
+#endif  // ADA_DEVELOPMENT_CHECKS
 
 #define ADA_STR(x) #x
 
 #if ADA_DEVELOPMENT_CHECKS
 #define ADA_REQUIRE(EXPR) \
   {                       \
     if (!(EXPR) { abort(); }) }
@@ -945,15 +945,15 @@
 
 #include <string_view>
 #include <cstring>
 
 namespace ada::checkers {
 
 inline bool has_hex_prefix_unsafe(std::string_view input) {
-  // This is actualy efficient code, see has_hex_prefix for the assembly.
+  // This is actually efficient code, see has_hex_prefix for the assembly.
   uint32_t value_one = 1;
   bool is_little_endian = (reinterpret_cast<char*>(&value_one)[0] == 1);
   uint16_t word0x{};
   std::memcpy(&word0x, "0x", 2);  // we would use bit_cast in C++20 and the
                                   // function could be constexpr.
   uint16_t two_first_bytes{};
   std::memcpy(&two_first_bytes, input.data(), 2);
@@ -2891,15 +2891,15 @@
 // This is needed to be able to construct the expected_default_ctor_base which
 // follows, while still conditionally deleting the default constructor.
 struct default_constructor_tag {
   explicit constexpr default_constructor_tag() = default;
 };
 
 // expected_default_ctor_base will ensure that expected has a deleted default
-// consturctor if T is not default constructible.
+// constructor if T is not default constructible.
 // This specialization is for when T is default constructible
 template <class T, class E,
           bool Enable =
               std::is_default_constructible<T>::value || std::is_void<T>::value>
 struct expected_default_ctor_base {
   constexpr expected_default_ctor_base() noexcept = default;
   constexpr expected_default_ctor_base(
@@ -4355,15 +4355,15 @@
  * @see https://url.spec.whatwg.org/#forbidden-domain-code-point
  */
 ada_really_inline constexpr uint8_t
 contains_forbidden_domain_code_point_or_upper(const char* input,
                                               size_t length) noexcept;
 
 /**
- * Checks if the input is a forbidden doamin code point.
+ * Checks if the input is a forbidden domain code point.
  * @see https://url.spec.whatwg.org/#forbidden-domain-code-point
  */
 ada_really_inline constexpr bool is_forbidden_domain_code_point(
     const char c) noexcept;
 
 /**
  * Checks if the input is alphanumeric, '+', '-' or '.'
@@ -4582,15 +4582,15 @@
    * this’s URL.
    * This function does not allocate memory.
    * @return a lightweight std::string_view.
    * @see https://url.spec.whatwg.org/#dom-url-pathname
    */
   [[nodiscard]] std::string_view get_pathname() const noexcept;
   /**
-   * Compute the pathname length in bytes witout instantiating a view or a
+   * Compute the pathname length in bytes without instantiating a view or a
    * string.
    * @return size of the pathname in bytes
    * @see https://url.spec.whatwg.org/#dom-url-pathname
    */
   ada_really_inline uint32_t get_pathname_length() const noexcept;
   /**
    * Return U+003F (?), followed by this’s URL’s query.
@@ -5027,15 +5027,15 @@
    * this’s URL.
    * @return a newly allocated string.
    * @see https://url.spec.whatwg.org/#dom-url-pathname
    */
   [[nodiscard]] const std::string_view get_pathname() const noexcept;
 
   /**
-   * Compute the pathname length in bytes witout instantiating a view or a
+   * Compute the pathname length in bytes without instantiating a view or a
    * string.
    * @return size of the pathname in bytes
    * @see https://url.spec.whatwg.org/#dom-url-pathname
    */
   ada_really_inline size_t get_pathname_length() const noexcept;
 
   /**
@@ -6314,15 +6314,15 @@
 }
 
 inline void ada::url_aggregator::add_authority_slashes_if_needed() noexcept {
   ada_log("url_aggregator::add_authority_slashes_if_needed");
   ADA_ASSERT_TRUE(validate());
   // Protocol setter will insert `http:` to the URL. It is up to hostname setter
   // to insert
-  // `//` initially to the buffer, since it depends on the hostname existance.
+  // `//` initially to the buffer, since it depends on the hostname existence.
   if (has_authority()) {
     return;
   }
   // Performance: the common case is components.protocol_end == buffer.size()
   // Optimization opportunity: in many cases, the "//" is part of the input and
   // the insert could be fused with another insert.
   buffer.insert(components.protocol_end, "//");
@@ -6481,22 +6481,22 @@
 /**
  * @file ada_version.h
  * @brief Definitions for Ada's version number.
  */
 #ifndef ADA_ADA_VERSION_H
 #define ADA_ADA_VERSION_H
 
-#define ADA_VERSION "2.4.2"
+#define ADA_VERSION "2.5.0"
 
 namespace ada {
 
 enum {
   ADA_VERSION_MAJOR = 2,
-  ADA_VERSION_MINOR = 4,
-  ADA_VERSION_REVISION = 2,
+  ADA_VERSION_MINOR = 5,
+  ADA_VERSION_REVISION = 0,
 };
 
 }  // namespace ada
 
 #endif  // ADA_ADA_VERSION_H
 /* end file include/ada/ada_version.h */
 /* begin file include/ada/implementation.h */
```

### Comparing `ada-url-0.1.0/ada_url/ada.o` & `ada-url-1.0.0/ada_url/ada.o`

 * *Files 1% similar despite different names*

#### strings -a -n 8 {}

```diff
@@ -152,16 +152,16 @@
 Opaque PH
 AWAVAUATSH
 [A\A]A^A_]
 AWAVAUATSH
 8[A\A]A^A_]
 AWAVAUATSPH
 [A\A]A^A_]
-AWAVAUATSH
-[A\A]A^A_]
+AWAVATSH
+[A\A^A_]
 AWAVAUATSH
 H[A\A]A^A_]
 AWAVAUATSH
 [A\A]A^A_]
 [[[[[[[[I
 [[[[[[[[H1
 ????????I
```

#### llvm-readobj --relocations {}

```diff
@@ -440,24 +440,24 @@
     0x1EF20 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
     0x1EF16 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__120__throw_out_of_rangeB6v15006EPKc
     0x1EF11 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x1EEBF 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x1EE94 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x1EE41 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x1EE15 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
-    0x1EDC2 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
-    0x1EDBA 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
-    0x1EDB1 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
-    0x1ED94 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x1EDBE 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
+    0x1EDB6 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x1EDAD 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
+    0x1ED90 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
     0x1ED73 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
     0x1ED65 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKc
     0x1ED5D 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x1ED56 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
-    0x1ECD7 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
-    0x1ECC2 1 2 1 X86_64_RELOC_SIGNED 0 __ZTVN3ada14url_aggregatorE
+    0x1ECE9 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x1ECC8 1 2 1 X86_64_RELOC_SIGNED 0 __ZTVN3ada14url_aggregatorE
     0x1EC72 1 2 1 X86_64_RELOC_SIGNED 0 __ZTVN3ada14url_aggregatorE
     0x1EC4E 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada6parser9parse_urlINS_14url_aggregatorEEET_NSt3__117basic_string_viewIcNS4_11char_traitsIcEEEEPKS3_
     0x1EBE1 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
     0x1EBD3 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKc
     0x1EBCB 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x1EBC4 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
     0x1EB26 1 2 1 X86_64_RELOC_BRANCH 0 __Unwind_Resume
@@ -1551,32 +1551,32 @@
     0x10B3A 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
     0x10B31 1 2 1 X86_64_RELOC_BRANCH 0 __Unwind_Resume
     0x10B06 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
     0x10AF7 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
     0x10AE8 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada7helpers12inner_concatINSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEJPKcS8_EEEvRS8_T_DpT0_
     0x10AD5 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEC1ERKS5_
     0x10AC9 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEC1ERKS5_
-    0x10A9B 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
-    0x10A6D 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada3urlD2Ev
-    0x10A5A 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada3urlD2Ev
-    0x10A45 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
-    0x10A30 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
-    0x10A1B 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_
-    0x10A0D 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
-    0x10A06 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url8get_hostEv
-    0x109F4 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url12get_protocolEv
-    0x109D0 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada3urlD2Ev
-    0x1082C 1 2 1 X86_64_RELOC_SIGNED 0 __ZTVN3ada3urlE
-    0x107FE 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada6parser9parse_urlINS_3urlEEET_NSt3__117basic_string_viewIcNS4_11char_traitsIcEEEEPKS3_
-    0x1076C 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
-    0x10753 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
-    0x1073E 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_
-    0x10730 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
-    0x10729 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url8get_hostEv
-    0x10717 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url12get_protocolEv
+    0x10A94 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
+    0x10A64 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada3urlD2Ev
+    0x10A4B 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada3urlD2Ev
+    0x10A3B 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x10A26 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x10A11 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_
+    0x10A03 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
+    0x109FC 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url8get_hostEv
+    0x109EA 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url12get_protocolEv
+    0x109C8 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada3urlD2Ev
+    0x1082A 1 2 1 X86_64_RELOC_SIGNED 0 __ZTVN3ada3urlE
+    0x107FC 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada6parser9parse_urlINS_3urlEEET_NSt3__117basic_string_viewIcNS4_11char_traitsIcEEEEPKS3_
+    0x1076A 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x10751 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
+    0x1073C 1 2 1 X86_64_RELOC_BRANCH 0 __ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_
+    0x1072E 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
+    0x10727 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url8get_hostEv
+    0x10715 1 2 1 X86_64_RELOC_BRANCH 0 __ZNK3ada3url12get_protocolEv
     0x10695 1 2 1 X86_64_RELOC_BRANCH 0 _memchr
     0x10611 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
     0x10606 1 2 1 X86_64_RELOC_BRANCH 0 ___clang_call_terminate
     0x105FE 1 2 1 X86_64_RELOC_BRANCH 0 __ZdlPv
     0x105E1 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKc
     0x105D9 1 2 0 X86_64_RELOC_SIGNED 0 __cstring
     0x105D2 1 2 1 X86_64_RELOC_BRANCH 0 __ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
```

#### x86_64

##### llvm-objdump --arch=x86_64 --section=__TEXT,__text --macho --demangle --no-leading-addr --no-show-raw-insn {}

```diff
@@ -17015,207 +17015,207 @@
 	retq
 	nopw	%cs:__ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax,%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 __ZNK3ada3url10get_originEv:
 	pushq	%rbp
 	movq	%rsp, %rbp
 	pushq	%r15
 	pushq	%r14
-	pushq	%r13
 	pushq	%r12
 	pushq	%rbx
-	subq	$536, %rsp
+	subq	$544, %rsp
 	movq	%rsi, %rbx
 	movq	%rdi, %r14
 	movb	10(%rsi), %al
 	cmpb	$1, %al
-	je	0x10775
+	je	0x10773
 	cmpb	$6, %al
-	je	0x10a71
-	leaq	-576(%rbp), %r15
+	je	0x10a6c
+	leaq	-568(%rbp), %r15
 	movq	%r15, %rdi
 	movq	%rbx, %rsi
 	callq	__ZNK3ada3url12get_protocolEv
-	leaq	-552(%rbp), %r12
+	leaq	-544(%rbp), %r12
 	movq	%r12, %rdi
 	movq	%rbx, %rsi
 	callq	__ZNK3ada3url8get_hostEv
-	leaq	345883(%rip), %rdx ## literal pool for: "//"
+	leaq	345885(%rip), %rdx ## literal pool for: "//"
 	movq	%r14, %rdi
 	movq	%r15, %rsi
 	movq	%r12, %rcx
 	callq	__ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_
-	testb	$1, -552(%rbp)
-	je	0x10757
-	movq	-536(%rbp), %rdi
-	callq	__ZdlPv
-	testb	$1, -576(%rbp)
-	je	0x10a82
-	movq	-560(%rbp), %rdi
+	testb	$1, -544(%rbp)
+	je	0x10755
+	movq	-528(%rbp), %rdi
+	callq	__ZdlPv
+	testb	$1, -568(%rbp)
+	je	0x10a7d
+	movq	-552(%rbp), %rdi
 	callq	__ZdlPv
-	jmp	0x10a82
+	jmp	0x10a7d
 	movb	192(%rbx), %al
 	testb	$1, %al
-	jne	0x107a1
+	jne	0x1079f
 	andb	$-2, %al
 	cmpb	$8, %al
-	jne	0x10a71
+	jne	0x10a6c
 	leaq	192(%rbx), %rax
 	incq	%rax
 	cmpl	$1651469410, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	jne	0x10a71
-	jmp	0x107c2
+	jne	0x10a6c
+	jmp	0x107c0
 	cmpq	$4, 200(%rbx)
-	jne	0x10a71
+	jne	0x10a6c
 	movq	208(%rbx), %rax
 	cmpl	$1651469410, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	jne	0x10a71
+	jne	0x10a6c
 	movzbl	104(%rbx), %edx
 	testb	$1, %dl
-	jne	0x107e0
+	jne	0x107de
 	cmpb	$2, %dl
-	jb	0x10a71
+	jb	0x10a6c
 	addq	$104, %rbx
 	incq	%rbx
 	shrq	%rdx
-	jmp	0x107f1
+	jmp	0x107ef
 	movq	112(%rbx), %rdx
 	testq	%rdx, %rdx
-	je	0x10a71
+	je	0x10a6c
 	movq	120(%rbx), %rbx
-	leaq	-256(%rbp), %rdi
+	leaq	-248(%rbp), %rdi
 	movq	%rbx, %rsi
 	xorl	%ecx, %ecx
 	callq	__ZN3ada6parser9parse_urlINS_3urlEEET_NSt3__117basic_string_viewIcNS4_11char_traitsIcEEEEPKS3_
-	cmpb	$0, -248(%rbp)
-	je	0x10a65
-	leaq	-248(%rbp), %rax
+	cmpb	$0, -240(%rbp)
+	je	0x10a43
+	leaq	-240(%rbp), %rax
 	movb	2(%rax), %cl
-	movb	%cl, -470(%rbp)
+	movb	%cl, -462(%rbp)
 	movzwl	__ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax), %eax ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movw	%ax, -472(%rbp)
+	movw	%ax, -464(%rbp)
 	leaq	__ZTVN3ada3urlE+16(%rip), %rax
-	movq	%rax, -480(%rbp)
-	movups	-240(%rbp), %xmm0
-	movups	%xmm0, -464(%rbp)
-	movq	-224(%rbp), %rax
-	movq	%rax, -448(%rbp)
+	movq	%rax, -472(%rbp)
+	movups	-232(%rbp), %xmm0
+	movups	%xmm0, -456(%rbp)
+	movq	-216(%rbp), %rax
+	movq	%rax, -440(%rbp)
 	xorps	%xmm0, %xmm0
-	movups	%xmm0, -240(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -224(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movups	-216(%rbp), %xmm1
-	movups	%xmm1, -440(%rbp)
-	movq	-200(%rbp), %rax
-	movq	%rax, -424(%rbp)
-	movups	%xmm0, -216(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -200(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movb	$0, -416(%rbp)
-	movb	$0, -392(%rbp)
-	cmpb	$0, -168(%rbp)
-	je	0x108e2
-	leaq	-416(%rbp), %rax
-	movq	-176(%rbp), %rcx
+	movups	%xmm0, -232(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -216(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movups	-208(%rbp), %xmm1
+	movups	%xmm1, -432(%rbp)
+	movq	-192(%rbp), %rax
+	movq	%rax, -416(%rbp)
+	movups	%xmm0, -208(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -192(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movb	$0, -408(%rbp)
+	movb	$0, -384(%rbp)
+	cmpb	$0, -160(%rbp)
+	je	0x108e0
+	leaq	-408(%rbp), %rax
+	movq	-168(%rbp), %rcx
 	movq	%rcx, 16(%rax)
-	movups	-192(%rbp), %xmm1
+	movups	-184(%rbp), %xmm1
 	movups	%xmm1, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movups	%xmm0, -192(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -176(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movb	$1, -392(%rbp)
-	movl	-160(%rbp), %eax
-	movl	%eax, -384(%rbp)
-	movups	-152(%rbp), %xmm1
-	movups	%xmm1, -376(%rbp)
-	movq	-136(%rbp), %rax
-	movq	%rax, -360(%rbp)
-	movups	%xmm0, -152(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -136(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movb	$0, -352(%rbp)
-	movb	$0, -328(%rbp)
-	cmpb	$0, -104(%rbp)
-	je	0x1095c
-	leaq	-352(%rbp), %rax
-	movq	-112(%rbp), %rcx
+	movups	%xmm0, -184(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -168(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movb	$1, -384(%rbp)
+	movl	-152(%rbp), %eax
+	movl	%eax, -376(%rbp)
+	movups	-144(%rbp), %xmm1
+	movups	%xmm1, -368(%rbp)
+	movq	-128(%rbp), %rax
+	movq	%rax, -352(%rbp)
+	movups	%xmm0, -144(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -128(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movb	$0, -344(%rbp)
+	movb	$0, -320(%rbp)
+	cmpb	$0, -96(%rbp)
+	je	0x10954
+	leaq	-344(%rbp), %rax
+	movq	-104(%rbp), %rcx
 	movq	%rcx, 16(%rax)
-	movups	-128(%rbp), %xmm0
+	movups	-120(%rbp), %xmm0
 	movups	%xmm0, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 	xorps	%xmm0, %xmm0
-	movups	%xmm0, -128(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -112(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movb	$1, -328(%rbp)
-	movb	$0, -320(%rbp)
-	movb	$0, -296(%rbp)
-	cmpb	$0, -72(%rbp)
-	je	0x1099c
-	leaq	-320(%rbp), %rax
-	movq	-80(%rbp), %rcx
+	movups	%xmm0, -120(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -104(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movb	$1, -320(%rbp)
+	movb	$0, -312(%rbp)
+	movb	$0, -288(%rbp)
+	cmpb	$0, -64(%rbp)
+	je	0x10994
+	leaq	-312(%rbp), %rax
+	movq	-72(%rbp), %rcx
 	movq	%rcx, 16(%rax)
-	movups	-96(%rbp), %xmm0
+	movups	-88(%rbp), %xmm0
 	movups	%xmm0, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 	xorps	%xmm0, %xmm0
-	movups	%xmm0, -96(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -80(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movb	$1, -296(%rbp)
-	movq	-48(%rbp), %rax
-	movq	%rax, -272(%rbp)
-	movups	-64(%rbp), %xmm0
-	movups	%xmm0, -288(%rbp)
+	movups	%xmm0, -88(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -72(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movb	$1, -288(%rbp)
+	movq	-40(%rbp), %rax
+	movq	%rax, -264(%rbp)
+	movups	-56(%rbp), %xmm0
+	movups	%xmm0, -280(%rbp)
 	xorps	%xmm0, %xmm0
-	movups	%xmm0, -64(%rbp)
-	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -48(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	movb	$1, -264(%rbp)
-	leaq	-256(%rbp), %rdi
+	movups	%xmm0, -56(%rbp)
+	movq	$__ZN3ada4idna13utf8_to_utf32EPKcmPDi, -40(%rbp) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
+	movb	$1, -256(%rbp)
+	leaq	-248(%rbp), %rdi
 	callq	__ZN3ada3urlD2Ev
-	movb	-470(%rbp), %bl
-	cmpb	$1, %bl
-	je	0x10a49
-	leaq	-528(%rbp), %r15
-	leaq	-480(%rbp), %r13
+	testb	$-3, -462(%rbp)
+	jne	0x10a51
+	leaq	-520(%rbp), %r15
+	leaq	-472(%rbp), %rbx
 	movq	%r15, %rdi
-	movq	%r13, %rsi
+	movq	%rbx, %rsi
 	callq	__ZNK3ada3url12get_protocolEv
-	leaq	-504(%rbp), %r12
+	leaq	-496(%rbp), %r12
 	movq	%r12, %rdi
-	movq	%r13, %rsi
+	movq	%rbx, %rsi
 	callq	__ZNK3ada3url8get_hostEv
-	leaq	345150(%rip), %rdx ## literal pool for: "//"
+	leaq	345160(%rip), %rdx ## literal pool for: "//"
 	movq	%r14, %rdi
 	movq	%r15, %rsi
 	movq	%r12, %rcx
 	callq	__ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_
-	testb	$1, -504(%rbp)
-	je	0x10a34
-	movq	-488(%rbp), %rdi
-	callq	__ZdlPv
-	testb	$1, -528(%rbp)
-	je	0x10a49
-	movq	-512(%rbp), %rdi
-	callq	__ZdlPv
-	cmpb	$0, -264(%rbp)
-	je	0x10a5e
-	leaq	-480(%rbp), %rdi
+	testb	$1, -496(%rbp)
+	je	0x10a2a
+	movq	-480(%rbp), %rdi
+	callq	__ZdlPv
+	testb	$1, -520(%rbp)
+	je	0x10a3f
+	movq	-504(%rbp), %rdi
+	callq	__ZdlPv
+	xorl	%ebx, %ebx
+	jmp	0x10a53
+	leaq	-248(%rbp), %rdi
 	callq	__ZN3ada3urlD2Ev
-	cmpb	$1, %bl
-	je	0x10a71
-	jmp	0x10a82
-	leaq	-256(%rbp), %rdi
+	jmp	0x10a6c
+	movb	$1, %bl
+	cmpb	$0, -256(%rbp)
+	je	0x10a68
+	leaq	-472(%rbp), %rdi
 	callq	__ZN3ada3urlD2Ev
+	testb	%bl, %bl
+	je	0x10a7d
 	movb	$8, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%r14) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 	movl	$1819047278, 1(%r14)
 	movb	$0, 5(%r14)
 	movq	%r14, %rax
-	addq	$536, %rsp
+	addq	$544, %rsp
 	popq	%rbx
 	popq	%r12
-	popq	%r13
 	popq	%r14
 	popq	%r15
 	popq	%rbp
 	retq
 	movq	%rax, %rdi
 	callq	___clang_call_terminate
-	nop
+	nopl	__ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax,%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 __ZN3ada7helpers6concatIJNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEPKcS8_EEES8_DpT_:
 	pushq	%rbp
 	movq	%rsp, %rbp
 	pushq	%r15
 	pushq	%r14
 	pushq	%rbx
 	subq	$56, %rsp
@@ -32633,28 +32633,28 @@
 	pushq	%rbx
 	subq	$160, %rsp
 	movq	%rdi, %r15
 	movb	10(%rsi), %al
 	cmpb	$1, %al
 	je	0x1eb63
 	cmpb	$6, %al
-	je	0x1ecdb
+	je	0x1eced
 	movl	48(%rsi), %ecx
 	testb	$1, 16(%rsi)
 	je	0x1eb7d
 	movq	32(%rsi), %rax
 	jmp	0x1eb81
 	movl	40(%rsi), %edx
 	movzbl	16(%rsi), %ecx
 	testb	$1, %cl
 	je	0x1ebea
 	movq	32(%rsi), %rax
 	cmpl	$5, %edx
 	je	0x1ebf7
-	jmp	0x1ecdb
+	jmp	0x1eced
 	leaq	17(%rsi), %rax
 	movl	40(%rsi), %edx
 	movl	52(%rsi), %edi
 	cmpl	%ecx, %edi
 	jbe	0x1eb97
 	xorl	%ebx, %ebx
 	cmpb	$64, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax,%rcx) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
@@ -32676,48 +32676,48 @@
 	leaq	287360(%rip), %rsi ## literal pool for: "//"
 	movq	%r15, %rdi
 	callq	__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKc
 	movq	%r15, %rdi
 	movq	%r14, %rsi
 	movq	%rbx, %rdx
 	callq	__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
-	jmp	0x1ecec
+	jmp	0x1ecfe
 	leaq	17(%rsi), %rax
 	cmpl	$5, %edx
-	jne	0x1ecdb
+	jne	0x1eced
 	movl	$1651469410, %edx
 	xorl	__ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax), %edx ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 	movzbl	4(%rax), %edi
 	xorl	$58, %edi
 	orl	%edx, %edi
-	jne	0x1ecdb
+	jne	0x1eced
 	testb	$1, %cl
 	jne	0x1ec17
 	shrq	%rcx
 	jmp	0x1ec1b
 	movq	24(%rsi), %rcx
 	movl	64(%rsi), %edx
 	cmpl	$-1, %edx
 	jne	0x1ec2e
 	movl	68(%rsi), %edx
 	cmpl	$-1, %edx
 	cmovnel	%edx, %ecx
 	movl	%ecx, %edx
 	movl	60(%rsi), %ecx
 	cmpl	%ecx, %edx
-	je	0x1ecdb
+	je	0x1eced
 	movl	%edx, %edx
 	subq	%rcx, %rdx
 	addq	%rcx, %rax
 	leaq	-184(%rbp), %rdi
 	movq	%rax, %rsi
 	xorl	%ecx, %ecx
 	callq	__ZN3ada6parser9parse_urlINS_14url_aggregatorEEET_NSt3__117basic_string_viewIcNS4_11char_traitsIcEEEEPKS3_
 	cmpb	$0, -176(%rbp)
-	je	0x1ecb8
+	je	0x1ecbe
 	leaq	-176(%rbp), %rax
 	movb	2(%rax), %cl
 	movb	%cl, -102(%rbp)
 	movzwl	__ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax), %eax ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 	movw	%ax, -104(%rbp)
 	leaq	__ZTVN3ada14url_aggregatorE+16(%rip), %r12
 	movq	%r12, -112(%rbp)
@@ -32726,43 +32726,43 @@
 	movq	-152(%rbp), %rax
 	movq	%rax, -80(%rbp)
 	movups	-144(%rbp), %xmm0
 	movups	%xmm0, -72(%rbp)
 	movups	-128(%rbp), %xmm0
 	movups	%xmm0, -56(%rbp)
 	movb	$1, -40(%rbp)
-	cmpb	$1, %cl
-	jne	0x1ecff
+	testb	$-3, %cl
+	jne	0x1ecde
+	movl	-72(%rbp), %edx
+	movl	-64(%rbp), %eax
 	testb	$1, -96(%rbp)
-	je	0x1ecdb
-	movq	-80(%rbp), %rdi
-	jmp	0x1ecd6
+	je	0x1ed11
+	movq	-80(%rbp), %rsi
+	jmp	0x1ed18
 	testb	$1, -168(%rbp)
 	leaq	__ZTVN3ada14url_aggregatorE+16(%rip), %rax
 	movq	%rax, -184(%rbp)
-	je	0x1ecdb
+	je	0x1eced
 	movq	-152(%rbp), %rdi
+	jmp	0x1ece8
+	testb	$1, -96(%rbp)
+	je	0x1eced
+	movq	-80(%rbp), %rdi
 	callq	__ZdlPv
 	movb	$8, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%r15) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
 	movl	$1819047278, 1(%r15)
 	movb	$0, 5(%r15)
 	movq	%r15, %rax
 	addq	$160, %rsp
 	popq	%rbx
 	popq	%r12
 	popq	%r14
 	popq	%r15
 	popq	%rbp
 	retq
-	movl	-72(%rbp), %edx
-	movl	-64(%rbp), %eax
-	testb	$1, -96(%rbp)
-	je	0x1ed11
-	movq	-80(%rbp), %rsi
-	jmp	0x1ed18
 	leaq	-96(%rbp), %rsi
 	incq	%rsi
 	movl	-60(%rbp), %ecx
 	cmpl	%eax, %ecx
 	jbe	0x1ed2c
 	xorl	%edi, %edi
 	cmpb	$64, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rsi,%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
@@ -32784,27 +32784,27 @@
 	movq	%r15, %rdi
 	callq	__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKc
 	movq	%r15, %rdi
 	movq	%r14, %rsi
 	movq	%rbx, %rdx
 	callq	__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm
 	cmpb	$0, -40(%rbp)
-	je	0x1ecec
+	je	0x1ecfe
 	movq	%r12, -112(%rbp)
 	testb	$1, -96(%rbp)
-	je	0x1ecec
+	je	0x1ecfe
 	movq	-80(%rbp), %rdi
 	callq	__ZdlPv
-	jmp	0x1ecec
-	jmp	0x1eda4
+	jmp	0x1ecfe
 	movq	%rax, %rbx
-	jmp	0x1edad
+	jmp	0x1eda9
+	jmp	0x1eda0
 	movq	%rax, %rbx
 	testb	$1, __ZN3ada4idna13utf8_to_utf32EPKcmPDi(%r15) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
-	jne	0x1edb5
+	jne	0x1edb1
 	movq	%rbx, %rdi
 	callq	___clang_call_terminate
 	movq	16(%r15), %rdi
 	callq	__ZdlPv
 	movq	%rbx, %rdi
 	callq	___clang_call_terminate
 	nopw	%cs:__ZN3ada4idna13utf8_to_utf32EPKcmPDi(%rax,%rax) ## ada::idna::utf8_to_utf32(char const*, unsigned long, char32_t*)
```

##### llvm-objdump --arch=x86_64 --section=__TEXT,__gcc_except_tab --macho --demangle --no-leading-addr --no-show-raw-insn {}

```diff
@@ -103,16 +103,16 @@
 0000000000024930	00 00 00 00 00 00 00 00 ff ff 01 11 00 cc 01 00 
 0000000000024940	00 cc 01 12 d9 02 00 de 01 9f 01 00 00 00 00 00 
 0000000000024950	ff ff 01 3c 26 20 8c 08 00 83 01 09 e2 07 00 9b 
 0000000000024960	01 c7 02 8c 08 00 f0 03 09 8a 08 00 93 04 09 e0 
 0000000000024970	07 00 ab 04 86 01 8c 08 00 b1 05 0d 00 00 be 05 
 0000000000024980	99 02 8c 08 00 d9 07 05 8a 08 00 de 07 48 00 00 
 0000000000024990	ff 9b 15 01 0a 1f 1c aa 01 01 6e 17 91 01 01 01 
-00000000000249a0	00 00 00 00 00 00 00 00 ff 9b 11 01 06 4d f2 05 
-00000000000249b0	b7 07 01 01 00 00 00 00 00 00 00 00 ff ff 01 13 
+00000000000249a0	00 00 00 00 00 00 00 00 ff 9b 11 01 06 4b ea 05 
+00000000000249b0	b0 07 01 01 00 00 00 00 00 00 00 00 ff ff 01 13 
 00000000000249c0	24 09 c0 01 00 2d 0c a6 01 00 39 13 78 00 4c 8e 
 00000000000249d0	01 00 00 00 ff 9b 21 01 16 40 67 f0 02 01 a7 01 
 00000000000249e0	39 00 00 e0 01 09 e8 02 01 83 02 63 f0 02 01 01 
 00000000000249f0	00 00 00 00 00 00 00 00 ff ff 01 0c 1f 09 70 00 
 0000000000024a00	42 13 7a 00 55 5a 00 00 ff 9b 0d 01 04 13 08 2c 
 0000000000024a10	01 01 00 00 00 00 00 00 ff 9b 0d 01 04 13 08 2c 
 0000000000024a20	01 01 00 00 00 00 00 00 ff 9b 0d 01 04 28 13 58 
@@ -241,16 +241,16 @@
 00000000000251d0	00 a2 28 5a a2 2f 00 e2 2a 16 bc 2f 00 9e 2b 5a 
 00000000000251e0	a0 2f 00 9f 2c 46 be 2f 00 bb 2d 08 fe 2e 00 d2 
 00000000000251f0	2d 08 bc 2f 00 da 2d 3a 00 00 94 2e 0c fa 2f 00 
 0000000000025200	a2 2e 09 bc 2f 00 ad 2e 09 be 2f 00 b8 2e 05 a2 
 0000000000025210	2f 00 bf 2e 05 a0 2f 00 c6 2e 0c 98 2f 01 d4 2e 
 0000000000025220	0c 90 2f 01 e2 2e 0c 88 2f 01 f0 2e 0c 80 2f 01 
 0000000000025230	fc 2e 9e 01 00 00 01 00 00 00 00 00 ff 9b 1d 01 
-0000000000025240	12 8d 01 28 f4 04 01 91 02 11 ef 04 01 a2 04 25 
-0000000000025250	ed 04 01 01 00 00 00 00 00 00 00 00 ff 9b 0d 01 
+0000000000025240	12 8d 01 28 f0 04 01 91 02 11 e9 04 01 a2 04 25 
+0000000000025250	ee 04 01 01 00 00 00 00 00 00 00 00 ff 9b 0d 01 
 0000000000025260	04 5e 0c 6c 01 01 00 00 00 00 00 00 ff 9b b0 01 
 0000000000025270	01 a7 01 2a 85 07 f3 0f 00 af 07 10 f1 0f 00 c7 
 0000000000025280	07 09 b9 0f 00 ff 07 09 c9 0f 00 97 08 20 f1 0f 
 0000000000025290	00 bf 08 09 b7 0f 00 f7 08 09 c7 0f 00 8f 09 20 
 00000000000252a0	f1 0f 00 b7 09 09 b5 0f 00 ef 09 09 c5 0f 00 87 
 00000000000252b0	0a 20 f1 0f 00 af 0a 09 b3 0f 00 e7 0a 09 c3 0f 
 00000000000252c0	00 ff 0a 20 f1 0f 00 a7 0b 09 b1 0f 00 df 0b 09
```

##### llvm-objdump --arch=x86_64 --section=__LD,__compact_unwind --macho --demangle --no-leading-addr --no-show-raw-insn {}

```diff
@@ -103,15 +103,15 @@
 0000000000065990	00 00 00 00 00 00 00 00 50 49 02 00 00 00 00 00 
 00000000000659a0	70 04 01 00 00 00 00 00 ef 00 00 00 d1 58 05 01 
 00000000000659b0	00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
 00000000000659c0	60 05 01 00 00 00 00 00 b5 00 00 00 21 00 02 41 
 00000000000659d0	00 00 00 00 00 00 00 00 90 49 02 00 00 00 00 00 
 00000000000659e0	20 06 01 00 00 00 00 00 b4 00 00 00 61 01 03 01 
 00000000000659f0	00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
-0000000000065a00	e0 06 01 00 00 00 00 00 bf 03 00 00 d1 58 05 41 
+0000000000065a00	e0 06 01 00 00 00 00 00 b8 03 00 00 11 0b 04 41 
 0000000000065a10	00 00 00 00 00 00 00 00 a8 49 02 00 00 00 00 00 
 0000000000065a20	a0 0a 01 00 00 00 00 00 da 00 00 00 61 01 03 41 
 0000000000065a30	00 00 00 00 00 00 00 00 bc 49 02 00 00 00 00 00 
 0000000000065a40	80 0b 01 00 00 00 00 00 78 01 00 00 d1 58 05 41 
 0000000000065a50	00 00 00 00 00 00 00 00 d4 49 02 00 00 00 00 00 
 0000000000065a60	00 0d 01 00 00 00 00 00 af 00 00 00 21 00 02 41 
 0000000000065a70	00 00 00 00 00 00 00 00 f8 49 02 00 00 00 00 00 
@@ -235,15 +235,15 @@
 00000000000661d0	00 00 00 00 00 00 00 00 3c 50 02 00 00 00 00 00 
 00000000000661e0	00 b9 01 00 00 00 00 00 13 01 00 00 21 00 02 41 
 00000000000661f0	00 00 00 00 00 00 00 00 7c 50 02 00 00 00 00 00 
 0000000000066200	20 ba 01 00 00 00 00 00 eb 18 00 00 d1 58 05 41 
 0000000000066210	00 00 00 00 00 00 00 00 94 50 02 00 00 00 00 00 
 0000000000066220	10 d3 01 00 00 00 00 00 1a 18 00 00 d1 58 05 41 
 0000000000066230	00 00 00 00 00 00 00 00 64 51 02 00 00 00 00 00 
-0000000000066240	30 eb 01 00 00 00 00 00 96 02 00 00 11 0b 04 41 
+0000000000066240	30 eb 01 00 00 00 00 00 92 02 00 00 11 0b 04 41 
 0000000000066250	00 00 00 00 00 00 00 00 3c 52 02 00 00 00 00 00 
 0000000000066260	d0 ed 01 00 00 00 00 00 1c 00 00 00 00 00 00 01 
 0000000000066270	00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
 0000000000066280	f0 ed 01 00 00 00 00 00 39 00 00 00 00 00 00 01 
 0000000000066290	00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
 00000000000662a0	30 ee 01 00 00 00 00 00 36 00 00 00 00 00 00 01 
 00000000000662b0	00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
```

##### llvm-objdump --arch=x86_64 --section=__TEXT,__eh_frame --macho --demangle --no-leading-addr --no-show-raw-insn {}

```diff
@@ -355,17 +355,17 @@
 0000000000068260	06 4c 83 05 8e 04 8f 03 2c 00 00 00 ec 02 00 00 
 0000000000068270	d0 7d fa ff ff ff ff ff 26 04 00 00 00 00 00 00 
 0000000000068280	08 cf c6 fb ff ff ff ff ff 41 0e 10 86 02 43 0d 
 0000000000068290	06 47 83 04 8e 03 00 00 2c 00 00 00 1c 03 00 00 
 00000000000682a0	c0 82 fa ff ff ff ff ff b5 00 00 00 00 00 00 00 
 00000000000682b0	08 df c6 fb ff ff ff ff ff 41 0e 10 86 02 43 0d 
 00000000000682c0	06 47 83 04 8e 03 00 00 34 00 00 00 4c 03 00 00 
-00000000000682d0	10 84 fa ff ff ff ff ff bf 03 00 00 00 00 00 00 
+00000000000682d0	10 84 fa ff ff ff ff ff b8 03 00 00 00 00 00 00 
 00000000000682e0	08 c7 c6 fb ff ff ff ff ff 41 0e 10 86 02 43 0d 
-00000000000682f0	06 50 83 07 8c 06 8d 05 8e 04 8f 03 00 00 00 00 
+00000000000682f0	06 4e 83 06 8c 05 8e 04 8f 03 00 00 00 00 00 00 
 0000000000068300	2c 00 00 00 84 03 00 00 98 87 fa ff ff ff ff ff 
 0000000000068310	da 00 00 00 00 00 00 00 08 a3 c6 fb ff ff ff ff 
 0000000000068320	ff 41 0e 10 86 02 43 0d 06 49 83 05 8e 04 8f 03 
 0000000000068330	34 00 00 00 b4 03 00 00 48 88 fa ff ff ff ff ff 
 0000000000068340	78 01 00 00 00 00 00 00 08 8b c6 fb ff ff ff ff 
 0000000000068350	ff 41 0e 10 86 02 43 0d 06 4d 83 07 8c 06 8d 05 
 0000000000068360	8e 04 8f 03 00 00 00 00 2c 00 00 00 ec 03 00 00 
@@ -487,15 +487,15 @@
 0000000000068aa0	eb 18 00 00 00 00 00 00 08 eb c5 fb ff ff ff ff 
 0000000000068ab0	ff 41 0e 10 86 02 43 0d 06 50 83 07 8c 06 8d 05 
 0000000000068ac0	8e 04 8f 03 00 00 00 00 34 00 00 00 4c 0b 00 00 
 0000000000068ad0	40 48 fb ff ff ff ff ff 1a 18 00 00 00 00 00 00 
 0000000000068ae0	08 83 c6 fb ff ff ff ff ff 41 0e 10 86 02 43 0d 
 0000000000068af0	06 50 83 07 8c 06 8d 05 8e 04 8f 03 00 00 00 00 
 0000000000068b00	34 00 00 00 84 0b 00 00 28 60 fb ff ff ff ff ff 
-0000000000068b10	96 02 00 00 00 00 00 00 08 23 c7 fb ff ff ff ff 
+0000000000068b10	92 02 00 00 00 00 00 00 08 23 c7 fb ff ff ff ff 
 0000000000068b20	ff 41 0e 10 86 02 43 0d 06 4e 83 06 8c 05 8e 04 
 0000000000068b30	8f 03 00 00 00 00 00 00 2c 00 00 00 bc 0b 00 00 
 0000000000068b40	70 63 fb ff ff ff ff ff 74 00 00 00 00 00 00 00 
 0000000000068b50	08 0b c7 fb ff ff ff ff ff 41 0e 10 86 02 43 0d 
 0000000000068b60	06 00 00 00 00 00 00 00 34 00 00 00 ec 0b 00 00 
 0000000000068b70	c0 63 fb ff ff ff ff ff 0d 08 00 00 00 00 00 00 
 0000000000068b80	08 eb c6 fb ff ff ff ff ff 41 0e 10 86 02 43 0d
```

### Comparing `ada-url-0.1.0/ada_url/ada_adapter.py` & `ada-url-1.0.0/ada_url/ada_adapter.py`

 * *Files identical despite different names*

### Comparing `ada-url-0.1.0/ada_url/ada_build.py` & `ada-url-1.0.0/ada_url/ada_build.py`

 * *Files identical despite different names*

### Comparing `ada-url-0.1.0/ada_url/ada_c.h` & `ada-url-1.0.0/ada_url/ada_c.h`

 * *Files identical despite different names*

### Comparing `ada-url-0.1.0/ada_url.egg-info/PKG-INFO` & `ada-url-1.0.0/ada_url.egg-info/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ada-url
-Version: 0.1.0
+Version: 1.0.0
 Summary: 'URL parser and manipulator based on the WHAT WG URL standard'
 Author: Bo Bayles
 Author-email: bo@bbayles.com
 License: Apache 2.0
 Project-URL: homepage, https://github.com/ada-url/ada-python
 Classifier: License :: OSI Approved :: Apache Software License
 Classifier: Programming Language :: Python :: 3
@@ -85,7 +85,9 @@
         'hostname': 'example.org',
         'pathname': '/api',
         'search': '?q=1',
         'hash': '#2'
     }
     >>> ada_url.replace_url('http://example.org:80', protocol='https:')
     'https://example.org/'
+
+You can find more documentation at `Read the Docs <https://ada-url.readthedocs.io>`__.
```

### Comparing `ada-url-0.1.0/pyproject.toml` & `ada-url-1.0.0/pyproject.toml`

 * *Files identical despite different names*

### Comparing `ada-url-0.1.0/setup.cfg` & `ada-url-1.0.0/setup.cfg`

 * *Files 11% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = ada-url
-version = 0.1.0
+version = 1.0.0
 description = 'URL parser and manipulator based on the WHAT WG URL standard'
 long_description = file: README.rst
 long_description_content_type = text/x-rst
 author = Bo Bayles
 author_email = bo@bbayles.com
 license = Apache 2.0
 license_files =
```

### Comparing `ada-url-0.1.0/tests/test_ada_url.py` & `ada-url-1.0.0/tests/test_ada_url.py`

 * *Files identical despite different names*

